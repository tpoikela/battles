!function(e){var t={};function n(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(s,r,function(t){return e[t]}.bind(null,r));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/build/",n(n.s=264)}([function(e,t,n){e.exports=n(269)()},function(e,t){e.exports=React},function(e,t,n){"use strict";t.__esModule=!0;var s,r=n(166),a=(s=r)&&s.__esModule?s:{default:s};t.default=a.default||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e}},function(e,t,n){var s;
/*!
  Copyright (c) 2016 Jed Watson.
  Licensed under the MIT License (MIT), see
  http://jedwatson.github.io/classnames
*/
/*!
  Copyright (c) 2016 Jed Watson.
  Licensed under the MIT License (MIT), see
  http://jedwatson.github.io/classnames
*/
!function(){"use strict";var n={}.hasOwnProperty;function r(){for(var e=[],t=0;t<arguments.length;t++){var s=arguments[t];if(s){var a=typeof s;if("string"===a||"number"===a)e.push(s);else if(Array.isArray(s))e.push(r.apply(null,s));else if("object"===a)for(var o in s)n.call(s,o)&&s[o]&&e.push(o)}}return e.join(" ")}e.exports?e.exports=r:void 0===(s=function(){return r}.apply(t,[]))||(e.exports=s)}()},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t,n){"use strict";t.__esModule=!0;var s,r=n(119),a=(s=r)&&s.__esModule?s:{default:s};t.default=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":(0,a.default)(t))&&"function"!=typeof t?e:t}},function(e,t,n){"use strict";t.__esModule=!0;var s=o(n(364)),r=o(n(368)),a=o(n(119));function o(e){return e&&e.__esModule?e:{default:e}}t.default=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":(0,a.default)(t)));e.prototype=(0,r.default)(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(s.default?(0,s.default)(e,t):e.__proto__=t)}},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s={gameTitle:"Battles in the North (BitN)",suppressErrorMessages:!1,suppressLogs:!1,suppressWarningMessages:!1,suppressDiagnosticMessages:!1,cellRenderVisible:["actors","items","elements"],cellRenderAlways:["items","elements"],getCssClassForCell:function(e,t){this.cellRenderArray=t?this.cellRenderVisible:this.cellRenderAlways;const n=this.getStyleClassForCell(e);return this.cellRenderArray=this.cellRenderVisible,n},getCssClassFullMap:function(e){if(this.cellRenderArray=this.cellRenderVisible,!e.hasProps()){const t=e.getBaseElem().getType();return this.cellStyles.elements[t]}for(let t=0;t<3;t++){const n=this.cellRenderVisible[t];if(e.hasProp(n)){const t=e.getProp(n),s=this.cellStyles[n];return this.getPropClassOrChar(s,t[0])}}return null},getCharForCell:function(e,t){this.cellRenderArray=t?this.cellRenderVisible:this.cellRenderAlways;const n=this.getCellChar(e);return this.cellRenderArray=this.cellRenderVisible,n},getCharFullMap:function(e){if(this.cellRenderArray=this.cellRenderVisible,!e.hasProps()){const t=e.getBaseElem().getType();return this.charStyles.elements[t]}for(let t=0;t<3;t++)if(e.hasProp(this.cellRenderVisible[t])){const n=e.getProp(this.cellRenderVisible[t]),s=this.charStyles[this.cellRenderVisible[t]];return this.getPropClassOrChar(s,n[0])}return null},getStyleClassForCell:function(e){if(!e.isExplored())return"cell-not-explored";for(let t=0;t<this.cellRenderArray.length;t++){const n=this.cellRenderArray[t];if(e.hasProp(n)){const t=e.getProp(n),s=this.cellStyles[n],r=t[0];return this.getPropClassOrChar(s,r)}}const t=e.getBaseElem().getType();return this.cellStyles.elements[t]},getPropClassOrChar:function(e,t){let n=null;if(t.getName?(n=t.getName(),e.hasOwnProperty(n)||(n=t.getType())):n=t.getType(),e.hasOwnProperty(n)){if("object"==typeof e[n]){for(const s in e[n])if("default"!==s){const r=t[s]();if(!0===r)return e[n][s];if(!1!==r)return r}return e[n].default}return e[n]}return e.default},getCellChar:function(e){if(!e.isExplored())return"X";for(let t=0;t<this.cellRenderArray.length;t++)if(e.hasProp(this.cellRenderArray[t])){const n=e.getProp(this.cellRenderArray[t]),s=this.charStyles[this.cellRenderArray[t]],r=n[0];return this.getPropClassOrChar(s,r)}const t=e.getBaseElem().getType();return this.charStyles.elements[t]},addCellStyle:function(e,t,n){this.cellStyles.hasOwnProperty(e)?this.cellStyles[e][t]=n:this.err("RG","addCellStyle","Unknown prop type: "+e)},removeCellStyle:function(e,t){this.cellStyles.hasOwnProperty(e)&&delete this.cellStyles[e][t]},addCharStyle:function(e,t,n){this.charStyles.hasOwnProperty(e)?this.charStyles[e][t]=n:this.err("RG","addCharStyle","Unknown prop type: "+e)},removeCharStyle:function(e,t){this.charStyles.hasOwnProperty(e)&&delete this.charStyles[e][t]},getChar:function(e,t,n=null){return this.charStyles.hasOwnProperty(e)?n?this.charStyles[e][t][n]:this.charStyles[e][t]:"X"},getCssClass:function(e,t,n=null){if(this.cellStyles.hasOwnProperty(e)){if(n)return this.cellStyles[e][t][n];if(this.cellStyles[e].hasOwnProperty(t))return this.cellStyles[e][t]}return""},charStyles:{elements:{default:".",exit:".",exploration:"?",lever:"&",leverdoor:{isClosed:"+",default:"/"},marker:{getChar:"",default:"X"},passage:".",placeholder:"?",shop:".",stairsDown:">",stairsUp:"<",wall:"#",wallcave:"#",wallcrypt:"#",wallice:"#",wallwooden:"#",wallmount:"^",door:{isClosed:"+",default:"/"}},actors:{default:"X"},items:{default:"?",corpse:"§"}},cellStyles:{elements:{default:"cell-element-default",door:"cell-element-door",exit:"cell-element-exit",exploration:"cell-element-exploration",marker:{getClassName:"",default:"cell-element-marker"},lever:"cell-element-door",leverdoor:"cell-element-door",passage:"cell-element-passage",placeholder:"cell-element-placeholder",shop:"cell-element-shop",stairsDown:"cell-element-stairs",stairsUp:"cell-element-stairs",wall:"cell-element-wall",wallcave:"cell-element-wall-cave",wallcrypt:"cell-element-wall-crypt",wallice:"cell-element-wall-ice",wallwooden:"cell-element-wall-wooden",wallmount:"cell-element-wall-mount"},actors:{default:"cell-actor-default",player:"cell-actor-player",spirit:"cell-actor-spirit"},items:{potion:"cell-item-potion",spiritgem:"cell-item-spiritgem",default:"cell-item-default"}},debug:function(e,t){0},err:function(e,t,n){if(!s.suppressErrorMessages){const s=`[ERROR]: ${e} ${t} -> |${n}|`;throw console.error(s),new Error(s)}},warn:function(e,t,n){if(!s.suppressWarningMessages){const s=`[WARN]: ${e} ${t} -> |${n}|`;console.error(s)}},diag:function(e){if(!s.suppressDiagnosticMessages){const t=(new Error).stack.split("at ");if(t.length>3){const e=t[3].trim();console.info(e)}console.info(e)}},log:function(...e){s.suppressLogs||console.log("[INFO]:",...e)},assertType:function(e,t){e.getType?e.getType()!==t&&s.err("RG","assertType",`Exp: ${t}, Got: ${e.getType()}`):s.err("RG","assertType",`object ${e} has no getType()`)},extend2:function(e,t){s.isNullOrUndef([e])&&s.err("RG","extend2",`Child not defined. Parent: ${t}`),s.isNullOrUndef([t])&&s.err("RG","extend2",`Parent not defined. Child: ${e}`);const n=t.prototype,r=e.prototype;for(const e in n)r.hasOwnProperty(e)||(r[e]=n[e]);if(r.hasOwnProperty("uber")){const e=[r.uber];e.push(n),r.uber=e}else r.uber=[],r.uber.push(n)},nullOrUndefError:function(e,t,n){if(this.isNullOrUndef([n])){const n=`nullOrUndef ${e} ${t}`;throw console.error(n),new Error(n)}},isNullOrUndef:function(e){for(let t=0;t<e.length;t++)if(null===e[t]||void 0===e[t]||void 0===e)return!0;return!1},addStackedItems:function(e,t){if(e.equals(t)){const n=t.getCount();return e.incrCount(n),!0}return!1},removeStackedItems:function(e,t){if(t>0){let n=null;return 1===t&&1===e.getCount()?e:t<e.getCount()?(e.decrCount(t),(n=e.clone()).setCount(t),n):e}return null},getItemDamage:function(e){if(e.rollDamage)return e.rollDamage();{const t=e.getWeight();return Math.ceil(t/1.1)}},getMeleeAttack:function(e){let t=e.getAttack();const n=e.getInvEq().getMissile(),s=e.getInvEq().getMissileWeapon();return n&&(t-=n.getAttack()),s&&(t-=s.getAttack()),t},getMeleeAttackRange:function(e){const t=e.get("Combat").getAttackRange(),n=e.getWeapon();if(n&&n.getAttackRange){const e=n.getAttackRange();return e>t?e:t}return t},getMeleeDamageAdded:function(e){let t=e.getCombatBonus("getDamage");return t+=s.strengthToDamage(e.getStrength())},getMeleeAttackInfo:function(e){let t="Att: "+s.getMeleeAttack(e);const n=e.getWeapon();return n&&n.getDamageDie?t+=" D: "+n.getDamageDie().toString():t+=" D: "+e.get("Combat").getDamageDie().toString(),t+=" + "+s.getMeleeDamageAdded(e)},getMissileAgilityDmg:function(e){return Math.round(e/3)},getMissileDamageAdded:function(e,t){let n=s.getMissileAgilityDmg(e.get("Stats").getAgility());return t.has("Ammo")&&(n+=e.getMissileWeapon().rollDamage()),e.has("StrongShot")&&(n+=this.strengthToDamage(e.getStrength())),n},getMissileDamage:function(e,t){let n=t.rollDamage();return n+=s.getMissileDamageAdded(e,t)},getMissileAttack:function(e){let t=e.get("Combat").getAttack();t+=e.getInvEq().getEquipment().getAttack(),t+=e.get("Stats").getAccuracy()/2,t+=e.getInvEq().getEquipment().getAccuracy()/2;const n=e.getWeapon();return n&&n.getAttack&&(t-=n.getAttack()),t},getMissileAttackInfo:function(e){const t=e.getMissileWeapon(),n=e.getInvEq().getMissile();if(!n)return"No missile equipped";let r="Att: "+s.getMissileAttack(e);if(r+=" D: "+n.getDamageDie().toString(),t){r+=" + "+t.getDamageDie().toString()+" (wpn)"}return r+=" + "+s.getMissileDamageAdded(e,n),r+=" R: "+s.getMissileRange(e,n)},getMissileRange:function(e,t){let n=t.getAttackRange();if(t.has("Ammo")){const t=e.getMissileWeapon();if(!t)return 0;n+=t.getAttackRange()}return e.has("LongRangeShot")&&(n*=2),e.has("EagleEye")&&(n+=2),e.has("Skills")&&(t.has("Ammo")?n+=e.get("Skills").getLevel("Archery"):n+=e.get("Skills").getLevel("Throwing")),n},strengthToDamage:function(e){return Math.round(e/4)},accuracyToAttack:function(e){return Math.floor(e/2)},agilityToDefense:function(e){return Math.floor(e/2)},findEnemyCellForActor:function(e,t){const n=[];return t.filter(e=>e.hasActors()).forEach(t=>{const s=t.getActors();let r=!1;for(let t=0;t<s.length;t++)e!==s[t]&&"function"==typeof s[t].isEnemy&&s[t].isEnemy(e)&&(r=!0);r&&n.push(t)}),n},PLAYER_FOV_RANGE:10,NPC_FOV_RANGE:5,ACTION_DUR:100,BASE_SPEED:100,DEFAULT_HP:50,MAX_ACTIVE_LEVELS:3,EVT_ACTOR_CREATED:"EVT_ACTOR_CREATED",EVT_ACTOR_KILLED:"EVT_ACTOR_KILLED",EVT_DESTROY_ITEM:"EVT_DESTROY_ITEM",EVT_MSG:"EVT_MSG",EVT_LEVEL_CHANGED:"EVT_LEVEL_CHANGED",EVT_LEVEL_ENTERED:"EVT_LEVEL_ENTERED",EVT_TILE_CHANGED:"EVT_TILE_CHANGED",EVT_EXPLORED_ZONE_LEFT:"EVT_EXPLORED_ZONE_LEFT",EVT_LEVEL_PROP_ADDED:"EVT_LEVEL_PROP_ADDED",EVT_LEVEL_PROP_REMOVED:"EVT_LEVEL_PROP_REMOVED",EVT_ACT_COMP_ADDED:"EVT_ACT_COMP_ADDED",EVT_ACT_COMP_REMOVED:"EVT_ACT_COMP_REMOVED",EVT_ACT_COMP_ENABLED:"EVT_ACT_COMP_ENABLED",EVT_ACT_COMP_DISABLED:"EVT_ACT_COMP_DISABLED",EVT_WIN_COND_TRUE:"EVT_WIN_COND_TRUE",EVT_ANIMATION:"EVT_ANIMATION",EVT_CREATE_BATTLE:"EVT_CREATE_BATTLE",EVT_BATTLE_OVER:"EVT_BATTLE_OVER",EVT_ARMY_EVENT:"EVT_ARMY_EVENT",EVT_ITEM_PICKED_UP:"EVT_ITEM_PICKED_UP",EVT_ACTOR_DAMAGED:"EVT_ACTOR_DAMAGED",EVT_ACTOR_ATTACKED:"EVT_ACTOR_ATTACKED",EVT_ACTOR_USED_STAIRS:"EVT_ACTOR_USED_STAIRS",EVT_WEATHER_CHANGED:"EVT_WEATHER_CHANGED",EVT_DAY_PHASE_CHANGED:"EVT_DAY_PHASE_CHANGED",EVT_DAY_CHANGED:"EVT_DAY_CHANGED",EVT_MONTH_CHANGED:"EVT_MONTH_CHANGED",EVT_SEASON_CHANGED:"EVT_SEASON_CHANGED",EVT_YEAR_CHANGED:"EVT_YEAR_CHANGED",TYPE_ACTOR:"actors",TYPE_ELEM:"elements",TYPE_ITEM:"items",ITEM:{}};s.ITEM.BASE="base",s.ITEM.FOOD="food",s.ITEM.BOOK="book",s.ITEM.CORPSE="corpse",s.ITEM.WEAPON="weapon",s.ITEM.ARMOUR="armour",s.ITEM.SPIRITGEM="spiritgem",s.ITEM.GOLD="gold",s.ITEM.MINERAL="mineral",s.ITEM.MISSILE="missile",s.ITEM.MISSILE_WEAPON="missileweapon",s.ITEM.AMMUNITION="ammo",s.ITEM.POTION="potion",s.ITEM.RUNE="rune",s.ITEM.GOLD_COIN="goldcoin",s.SHOP_TYPES=["ammo","armour","food","mineral","missile","missileweapon","potion","rune","spiritgem","weapon"],s.USE={DRINK:"DRINK",DIG:"DIG",LEVER:"LEVER"},s.LEVEL_ID_ADD=1e9,s.ENTITY_ID_ADD=1e9,s.WATCHDOG=100,s.NO_TARGET=-1,s.LEVEL_EMPTY="empty",s.LEVEL_FOREST="forest",s.LEVEL_MOUNTAIN="mountain",s.energy={ATTACK:15,DEFAULT:5,JUMP:50,MISSILE:10,MOVE:10,PICKUP:5,REST:5,RUN:20,USE:5,SPELL:15},s.BIAS={ALWAYS:10,NOT_POSSIBLE:-10,Explore:.2,Flee:.2,Guard:1.1,Order:.7,Patrol:1},s.FMODE_NORMAL=0,s.FMODE_FAST=1,s.FMODE_SLOW=2,s.ITEM_SUFFIX_CHANCE=.1,s.ITEM_PREFIX_CHANCE=.1,s.PROT_BYPASS_CHANCE=.05,s.MISSILE_CRITICAL_SHOT=.1,s.DANGER_ADJ_FACTOR=1.4,s.DAMAGE_ADJ_FACTOR=2,s.PLAYER_HP_REGEN_PERIOD=40,s.PLAYER_PP_REGEN_PERIOD=40,s.MIN_VALUE=30,s.TRAINER_PROB=.2,s.EPIC_PROB=.05,s.GOLD_COIN_WEIGHT=.03,s.GOLD_COIN_NAME="Gold coin",s.HUNGER_PROB=.1,s.HUNGER_DMG=1,s.ALIGN_GOOD="ALIGN_GOOD",s.ALIGN_EVIL="ALIGN_EVIL",s.ALIGN_NEUTRAL="ALIGN_NEUTRAL",s.EVIL_RACES=["catfolk","dogfolk","wolfclan","wildling","undead","goblin"],s.NEUTRAL_RACES=["dwarf","bearfolk","animal"],s.ACTOR_RACES=["catfolk","dogfolk","wolfclan","wildling","goblin","bearfolk","dwarf","human","hyrkhian"],s.ACTOR_RACES=s.ACTOR_RACES.sort(),s.ALL_RACES=["avianfolk"].concat(s.ACTOR_RACES),s.CARDINAL_DIR=Object.freeze(["north","south","east","west"]),s.CARDINAL_DIR_ABBR=Object.freeze(["N","S","E","W"]),s.DIR={N:[0,-1],S:[0,1],E:[1,0],W:[-1,0],NE:[1,-1],SE:[1,1],NW:[-1,-1],SW:[-1,1]},s.DIR_NSEW=[s.DIR.N,s.DIR.S,s.DIR.E,s.DIR.W],s.DIR_DIAG=[s.DIR.NE,s.DIR.SE,s.DIR.NW,s.DIR.SW],s.SEASON={AUTUMN:"AUTUMN",AUTUMN_WINTER:"AUTUMN_WINTER",WINTER:"WINTER",WINTER_SPRING:"WINTER_SPRING",SPRING:"SPRING",SPRING_SUMMER:"SPRING_SUMMER",SUMMER:"SUMMER",SUMMER_AUTUMN:"SUMMER_AUTUMN"},s.DAY={DAWN:"DAWN",MORNING:"MORNING",NOON:"NOON",AFTERNOON:"AFTERNOON",EVENING:"EVENING",DUSK:"DUSK",NIGHT:"NIGHT"},s.AREA_LEVEL_COLS=100,s.AREA_LEVEL_ROWS=100,s.LETTERS=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],s.LETTERS_UC=s.LETTERS.map(e=>e.toUpperCase()),s.dirTodXdY=function(e){if(Array.isArray(e))return e;if(s.DIR.hasOwnProperty(e)){const t=e.toUpperCase();return s.DIR[t]}return s.err("RG","dirTodXdY",`Arg must be array/string (N,S,E,W..). Got: ${e}`),null},s.dXdYToDir=function(e){const[t,n]=e;let s="";return 1===n?s+="S":-1===n&&(s+="N"),1===t?s+="E":-1===t&&(s+="W"),s},s.dirToChar=function(e){const[t,n]=e;return 0!==t?0===n?"-":1===t&&1===n?"\\":-1===t&&1===n?"/":-1===t&&-1===n?"\\":"/":"|"},s.DMG={ACID:"ACID",BLUNT:"BLUNT",COLD:"COLD",DIRECT:"DIRECT",ENERGY:"ENERGY",FIRE:"FIRE",HUNGER:"HUNGER",ICE:"ICE",LIGHTNING:"LIGHTNING",MAGIC:"MAGIC",MELEE:"MELEE",MISSILE:"MISSILE",NECRO:"NECRO",PIERCE:"PIERCE",POISON:"POISON",SLASH:"SLASH",SLIME:"SLIME",VOID:"VOID",WATER:"WATER"},s.classNameDMG={ACID:"cell-damage-ACID",BLUNT:"cell-damage-BLUNT",COLD:"cell-damage-COLD",ENERGY:"cell-damage-ENERGY",FIRE:"cell-damage-FIRE",HUNGER:"cell-damage-HUNGER",ICE:"cell-damage-ICE",LIGHTNING:"cell-damage-LIGHTNING",MAGIC:"cell-damage-MAGIC",MELEE:"cell-damage-MELEE",MISSILE:"cell-damage-MISSILE",NECRO:"cell-damage-NECRO",PIERCE:"cell-damage-PIERCE",POISON:"cell-damage-POISON",SLASH:"cell-damage-SLASH",WATER:"cell-damage-WATER",VOID:"cell-damage-VOID"},s.STATS=["Accuracy","Agility","Magic","Perception","Strength","Willpower"],s.STATS_LC=s.STATS.map(e=>e.toLowerCase()),s.LEVEL_NOT_LOADED="LEVEL_NOT_LOADED",s.TILE_NOT_LOADED="TILE_NOT_LOADED",s.STATS_ABBR=s.STATS.map(e=>e.substr(0,3)),s.GET_STATS=s.STATS.map(e=>"get"+e),s.SET_STATS=s.STATS.map(e=>"set"+e),s.getDmgClassName=function(e){return s.classNameDMG[e]},s.key2Num=function(e){const[t,n]=e.split(",");return[parseInt(t,10),parseInt(n,10)]},s.isEmpty=(e=>!!s.isNullOrUndef([e])||("string"==typeof e?""===e:!!Array.isArray(e)&&0===e.length)),s.getName=(e=>{if(e.getName)return e.getName();if(e.getParent){return e.getParent().getName()}return""}),s.getObjRefArray=((e,t)=>{const n=t.map(t=>s.getObjRef(e,t));return n.$objRefArray=!0,n}),s.getObjRef=((e,t)=>{if("entity"===e){if(s.isItem(t)){const e=" Got: |"+t.getName()+"|";s.err("RG","getObjRef","objRefs to items not supported."+e)}return{$objRef:{type:e,id:t.getID()}}}if("object"===e){if(t.$objID)return t.getObjRef();if(t.$objRef)return{$objRef:{type:"object",id:t.$objRef}}}else{if("component"===e)return{$objRef:{type:"component",id:t.getID()}};if("place"===e)return{$objRef:{type:"place",id:t.getID()}};if("item"===e)return{$objRef:{type:"item",id:t.getID()}};if("element"===e)return{$objRef:{type:"element",id:t.getID()}}}return s.err("RG","getObjRef",`Type ${e} not supported. Obj: ${t}`),null}),s.getForestConf=function(e,t){const n=e/s.LEVEL_MEDIUM_X*(t/s.LEVEL_MEDIUM_Y);return{ratio:.5,nForests:Math.floor(30*n),forestSize:100}},s.cellRenderArray=s.cellRenderVisible,s.PROP_TYPES=[s.TYPE_ACTOR,s.TYPE_ELEM,s.TYPE_ITEM],s.FMODES=[s.FMODE_NORMAL,s.FMODE_FAST,s.FMODE_SLOW],s.ALIGNMENTS=[s.ALIGN_GOOD,s.ALIGN_NEUTRAL,s.ALIGN_EVIL],s.cellRenderArray=s.cellRenderVisible,s.getDangerProb=((e,t)=>{if(e>t)return console.error("RG.getDangerProb param order is min < max"),console.error(`\tGot min: ${e}, max: ${t}`),{};const n=t+1,r=[];for(let t=e;t<=n;t++)r.push(t);const a=r[r.length-1],o=a%2==0?a/2:(a+1)/2,i={};return r.forEach(e=>{const t=Math.abs(e-o);let n=a-Math.floor(s.DANGER_ADJ_FACTOR*t);n=0===n?n+1:n,i[e]=n}),i}),s.getMaxDanger=((e,t)=>{let n=2*t+e;return n<2&&(n=2),n}),s.getMaxValue=((e,t)=>{let n=20*t+10*e;return n<=s.MIN_VALUE&&(n=s.MIN_VALUE),n}),s.getFoodWeightDistr=(()=>({.1:20,.2:10,.3:5,.4:3,.5:1})),s.getGoldCoinCountDistr=(e=>{const t=e+1,n={};for(let s=1;s<=t;s++)n[s]=e;return n}),s.getRuneChargeDistr=(()=>({0:2,1:10,2:30,3:10,4:5,5:2})),s.valueToGoldWeight=(e=>{let t=e,n=1;for(;t>=100;)t-=100,++n;return(n*e+10)/200}),s.scaleItemValue=((e,t,n)=>{const s=n.getValue();let r=1;switch(e){case"combat":r*=1+.1*t;break;case"stats":r*=1+.2*t;break;default:r=1}const a=Math.floor(s*r);n.setValue(a)}),s.hasEnoughGold=((e,t)=>{const n=s.getGoldInCoins(t),r=e.getInvEq().getInventory().getItems();for(let e=0;e<r.length;e++)if("goldcoin"===r[e].getType()&&r[e].getCount()>=n)return!0;return!1}),s.removeNCoins=((e,t)=>{let n=0;const s=e.getInvEq().getInventory().getItems();let r=null;for(let e=0;e<s.length;e++)"goldcoin"===s[e].getType()&&(s[e].getCount()>t?(n=t,s[e].decrCount(t)):(n=(r=s[e]).getCount(),r.setCount(0)));return null!==r&&e.getInvEq().removeItem(r),n}),s.getItemStat=((e,t)=>{if(!t)return 0;let n=0;if("function"==typeof t[e]&&(n+=t[e]()),t.has("Stats")){const s=t.get("Stats");"function"==typeof s[e]&&(n+=s[e]())}if(t.has("GemBound")){const s=t.get("GemBound").getGem();"function"==typeof s[e]&&(n+=s[e]())}return n}),s.getExpRequired=(e=>{let t=0;for(let n=1;n<=e;n++)t+=10*(n-1);return t}),s.newXYFromDir=((e,t)=>{let[n,s]=[0,0];return Array.isArray(t)?[n,s]=t:t.getX&&([n,s]=t.getXY()),[n+e[0],s+e[1]]}),s.dXdY=((e,t)=>{let[n,s,r,a]=[0,0,0,0];return Array.isArray(e)?(n=e[0],s=e[1]):e.getX&&(n=e.getX(),s=e.getY()),Array.isArray(t)?(r=t[0],a=t[1]):t.getX&&(r=t.getX(),a=t.getY()),[n-r,s-a]}),s.dXdYAbs=((e,t)=>{const[n,r]=s.dXdY(e,t);return[Math.abs(n),Math.abs(r)]}),s.dXdYUnit=((e,t)=>{const[n,r]=s.dXdY(e,t);return[0===n?0:n/Math.abs(n),0===r?0:r/Math.abs(r)]}),s.withinRange=((e,t,n)=>{const[r,a]=s.dXdYAbs(t,n);return r<=e&&a<=e}),s.levelUpActor=((e,t)=>{if(e.has("Experience")){let n=e.get("Experience").getExpLevel();if(n<t)for(;n<t;){const t=n+1;if(++n,e.get("Experience").setExpLevel(t),e.has("ActorClass"))e.get("ActorClass").getClass().advanceLevel();else if(s.levelUpStats(e,t),s.levelUpCombatStats(e,t),e.has("Health")){const t=e.get("Health");let n=2;e.isPlayer()&&(n=5),t.setMaxHP(t.getMaxHP()+n),t.setHP(t.getHP()+n)}}else{let e=`Curr: ${n}, New: ${t}`;e+=" New level must be > current level.",s.err("RG","levelUpActor",e)}}else s.err("RG","levelUpActor","No exp. component found.")}),s.levelUpStats=function(e,t){const n=r.Random.getRNG().arrayGetRand(s.STATS_LC);e.get("Stats").incrStat(n,1)},s.levelUpCombatStats=function(e,t){if(e.has("Combat")){const n=e.get("Combat"),s=1;n.setAttack(n.getAttack()+s);const r=1;if(n.setDefense(n.getDefense()+r),t%3==0){const e=n.getProtection();n.setProtection(e+1)}const a=n.getDamageDie();a.setDice(a.getDice()+1),t%3==0&&a.setMod(a.getMod()+1)}},s.printObj=function(e,t,n){const r=(e,t)=>{"object"==typeof e?(s.diag("\t## "+t,n),s.diag(e,n)):s.diag("\t## "+t+" -> "+e,n)};if(t){if(Array.isArray(t))t.forEach(n=>{if("function"==typeof e[n]){const t=e[n]();r(t,n)}else{const n=JSON.stringify(e);s.err("RG","printObj",`No func ${t} in object ${n}`)}});else if("string"==typeof t)if("function"==typeof e[t]){const n=e[t]();r(n,t)}else s.err("RG","printObj",`No func ${t} in object ${JSON.stringify(e)}`)}else s.diag(e,n)},s.printObjList=function(e,t,n){const r=e.length;console.log(`List has ${r} objects`),e.forEach((e,r)=>{"function"==typeof n?n(e)&&(console.log(`Object [${r}]: `),s.printObj(e,t)):(console.log(`Object [${r}]: `),s.printObj(e,t))})},s.getUseCmd=function(e,t){return{cmd:"use",item:e,target:t}},s.getDropCmd=function(e,t){return{cmd:"drop",item:e,count:t}},s.getEquipCmd=function(e,t){return{cmd:"equip",item:e,count:t}},s.getUnequipCmd=function(e,t,n){return{cmd:"unequip",slot:e,slotNumber:t,count:n}},s.ONE_SHOT_ITEMS=["potion"],s.isOneShotItem=(e=>{const t=e.getType();return s.ONE_SHOT_ITEMS.indexOf(t)>=0}),s.isActor=(e=>!(!e||!e.getPropType)&&e.getPropType()===s.TYPE_ACTOR),s.isElement=(e=>!(!e||!e.getPropType)&&e.getPropType()===s.TYPE_ELEM),s.isItem=(e=>!(!e||!e.getPropType)&&e.getPropType()===s.TYPE_ITEM),s.isEntity=(e=>!!(e.comps&&e.compsByType&&e.add&&e.get)),s.isActorActive=(e=>e&&!e.has("Dead")),s.getItemUseType=((e,t)=>{let n=t;switch(t.target&&(n=t.target).getActors&&n.hasActors()&&(n=n.getActors()[0]),e.getType()){case"potion":if(s.isActor(n))return s.USE.DRINK;break;default:return""}return""}),s.getGoldInCoins=(e=>Math.round(e/s.GOLD_COIN_WEIGHT)),s.BLOCK_X=20,s.BLOCK_Y=7,s.LEVEL_SMALL_X=3*s.BLOCK_X,s.LEVEL_SMALL_Y=3*s.BLOCK_Y,s.LEVEL_MEDIUM_X=4*s.BLOCK_X,s.LEVEL_MEDIUM_Y=4*s.BLOCK_Y,s.LEVEL_LARGE_X=5*s.BLOCK_X,s.LEVEL_LARGE_Y=5*s.BLOCK_Y,s.LEVEL_HUGE_X=7*s.BLOCK_X,s.LEVEL_HUGE_Y=7*s.BLOCK_Y,s.LOOT_SPARSE_SQR=200,s.LOOT_MEDIUM_SQR=120,s.LOOT_ABUNDANT_SQR=50,s.ACTOR_SPARSE_SQR=200,s.ACTOR_MEDIUM_SQR=120,s.ACTOR_ABUNDANT_SQR=50,s.WEAKNESS={},s.WEAKNESS.MINOR=1,s.WEAKNESS.MEDIUM=3,s.WEAKNESS.SEVERE=7,s.WEAKNESS.FATAL=10,s.RESISTANCE={},s.RESISTANCE.MINOR=1,s.RESISTANCE.MEDIUM=3,s.RESISTANCE.STRONG=6,s.RESISTANCE.IMMUNITY=10,s.RESISTANCE.ABSORB=15,s.SYS={},s.SYS.ANIMATION=Symbol("ANIMATION"),s.SYS.AREA_EFFECTS=Symbol("AREA_EFFECTS"),s.SYS.ATTACK=Symbol("ATTACK"),s.SYS.BATTLE=Symbol("BATTLE"),s.SYS.BASE_ACTION=Symbol("BASE_ACTION"),s.SYS.CHAT=Symbol("CHAT"),s.SYS.COMMUNICATION=Symbol("COMMUNICATION"),s.SYS.DAMAGE=Symbol("DAMAGE"),s.SYS.DEATH=Symbol("DEATH"),s.SYS.DISABILITY=Symbol("DISABILITY"),s.SYS.DRAIN_STATS=Symbol("DRAIN_STATS"),s.SYS.EQUIP=Symbol("EQUIP"),s.SYS.EVENTS=Symbol("EVENTS"),s.SYS.EXP_POINTS=Symbol("EXP_POINTS"),s.SYS.HUNGER=Symbol("HUNGER"),s.SYS.MISSILE=Symbol("MISSILE"),s.SYS.MOVEMENT=Symbol("MOVEMENT"),s.SYS.QUEST=Symbol("QUEST"),s.SYS.SHOP=Symbol("SHOP"),s.SYS.SKILLS=Symbol("SKILLS"),s.SYS.SPELL_CAST=Symbol("SPELL_CAST"),s.SYS.SPELL_EFFECT=Symbol("SPELL_EFFECT"),s.SYS.SPIRIT=Symbol("SPIRIT"),s.SYS.TIME_EFFECTS=Symbol("TIME_EFFECTS"),s.SYS.WEATHER=Symbol("WEATHER"),s.NO_DAMAGE_SRC=null,s.getCardinalDirection=((e,t)=>{const n=e.getMap().cols,s=e.getMap().rows,r=t.getX(),a=t.getY();return 0===a?"north":a===s-1?"south":r===n-1?"east":0===r?"west":"somewhere"}),s.getTextualDir=((e,t,n=10)=>{let r="";const[a,o]=s.dXdY(e,t),i=a/10,l=o/10;return l>0?r+="south":l<0&&(r+="north"),i>0?r+=" east":i<0&&(r+="west"),""===r&&(r="nearby from here"),r}),s.printMap=(e=>{let t=null;if(Array.isArray(e)?t=s.colsToRows(e):Array.isArray(e._map)&&(t=s.colsToRows(e._map)),t){const e=t.length;for(let n=0;n<e;n++)console.log(t[n].join(""))}}),s.forEach2D=((e,t)=>{for(let n=0;n<e.length;n++)for(let s=0;s<e[n].length;s++)t(n,s,e[n][s])}),s.map2D=((e,t)=>{const n=[];return s.forEach2D(e,(e,s,r)=>{n.push(t(e,s,r))}),n}),s.copy2D=(e=>{const t=new Array(e.length);for(let n=0;n<e.length;n++){t[n]=new Array(e[n].length);for(let s=0;s<e[n].length;s++)t[n][s]=e[n][s]}return t}),s.colsToRows=(e=>{const t=[],n=e[0].length,s=e.length;for(let r=0;r<n;r++){t[r]=[];for(let n=0;n<s;n++)t[r][n]=e[n][r]}return t}),s.flattenTo2D=(e=>{const t=e.length,n=[];for(let r=0;r<t;r++){let t=e[r];t=s(t),n.push(t)}function s(e){let t=[];return e.forEach(e=>{Array.isArray(e)?t=t.concat(s(e)):t.push(e)}),t}return n}),s.uniquifyCoord=(e=>{const t={},n=[];for(let s=0;s<e.length;s++){const[r,a]=e[s],o=r+","+a;t[o]||(t[o]=!0,n.push(e[s]))}return n}),s.setAllExplored=((e,t)=>{const n=e.getMap();for(let e=0;e<n.cols;e++)for(let s=0;s<n.rows;s++){n._map[e][s].setExplored(t)}}),s.inSameLevel=((e,t)=>e.getLevel().getID()===t.getLevel().getID()),s.getImpassableMsg=((e,t,n)=>{return`${n} ${`cannot venture beyond ${t.getBaseElem().getType()}`}`}),s.formatLocationName=(e=>{const t=e.getParent();if(!t)return"";switch(t.getType()){case"branch":case"face":case"quarter":{const e=t.getParent(),n=t.getName(),s=e.getName();return n===s?n:`${s}`}default:return t.getName()}});const r=n(9);s.isSuccess=function(e){return r.Random.getRNG().getUniform()<=e},s.ent=function(e){if(window.PLAYER){const t=window.PLAYER.getLevel();if(Number.isInteger(e)){const n=t.getActors().find(t=>t.getID()===e);if(n){const t=n.getName();return s.diag(`RG.ent: Found ${t} with ID ${e}`),s.diag(JSON.stringify(n)),n}const r=t.getItems().find(t=>t.getID()===e);if(r){const t=r.getName();return s.diag(`RG.ent: Item Found ${t} with ID ${e}`),s.diag(JSON.stringify(r)),r}}}return null},s.comp=function(e,t=-1){let n=null;if(t>=0&&(n=s.ent(t)),n){const t=n.getComponents();if(t[e]){const n=t[e],r=n.getType();console.log(`RG.comp: Found ${r} with ID ${e}`);const a=n.toJSON();return a?s.diag(JSON.stringify(a)):(s.diag("Not serialisable"),s.diag(n)),n}}return null},s.while=function(e,t,n=-1){let s=n;for(;e();)if(t(),0==--s)return!1;return!0};const a=n(18).EventPool.getPool();s.gameMsg=function(e){this.emitMsgEvent("prim",e)},s.gameInfo=function(e){this.emitMsgEvent("info",e)},s.gameDescr=function(e){this.emitMsgEvent("descr",e)},s.gameSuccess=function(e){this.emitMsgEvent("success",e)},s.gameWarn=function(e){this.emitMsgEvent("warn",e)},s.gameDanger=function(e){this.emitMsgEvent("danger",e)},s.gameIntError=function(e){this.emitMsgEvent("bg-danger text-white",e)},s.emitMsgEvent=function(e,t){let n="";if("object"==typeof t){const s=t,r={cell:s.cell,msg:n=(n=s.msg)[0].toUpperCase()+n.substring(1),style:e};a.emitEvent(this.EVT_MSG,r)}else n=t[0].toUpperCase()+t.substring(1),a.emitEvent(this.EVT_MSG,{msg:n,style:e})},s.destroyItemIfNeeded=(e=>{if(s.isOneShotItem(e))if(1===e.getCount()){const t={item:e};a.emitEvent(s.EVT_DESTROY_ITEM,t)}else e.decrCount(1)}),t.default=s},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=s(n(23)),o=[-1,0,1],i=[-1,1];class l{static setRNG(e){l.instance=e}static getRNG(){return l.instance||(l.instance=new l(666)),l.instance}static reseed(e){a.default.RNG.setSeed(e),l.getRNG().setSeed(e)}constructor(e=0){this.seed=e,this.rng=a.default.RNG.clone(),this.rng.setSeed(this.seed)}setSeed(e){console.log("Setting RNG seed to "+e),this.seed=e,this.rng.setSeed(e)}setState(e){this.rng.setState(e)}randProp(e){const t=Object.keys(e);return e[t[this.randIndex(t)]]}arrayGetRand(e){return e[this.randIndex(e)]}getUniqueItems(e,t=2){if(e.length<=t)return e.slice();const n={},s=[];for(;s.length<t;){const t=this.randIndex(e);n[t]||(n[t]=!0,s.push(e[t]))}return s}getUniformInt(e,t){return this.rng.getUniformInt(e,t)}randIndex(e){return Math.floor(this.rng.getUniform()*e.length)}getUniform(){return this.rng.getUniform()}getUniformRange(e,t){return e+(t-e)*this.getUniform()}getNormal(e,t){return this.rng.getNormal(e,t)}getWeighted(e){return this.rng.getWeightedValue(e)}getWeightedLinear(e){const t={};for(let n=0;n<e;n++)t[n]=n+1;return this.rng.getWeightedValue(t)}toJSON(){return{seed:this.seed,state:this.rng.getState()}}getRandDir(){const e=this.arrayGetRand(o);let t=this.arrayGetRand(o);return 0===e&&(t=this.arrayGetRand(i)),[e,t]}getCardinalDir(){return this.arrayGetRand(r.default.CARDINAL_DIR)}getCardinalDirLetter(){return this.arrayGetRand(r.default.CARDINAL_DIR_ABBR)}getRandInBbox(e){const{ulx:t,uly:n,lrx:s,lry:r}=e;return[this.getUniformInt(t,s),this.getUniformInt(n,r)]}shuffle(e){if(e.length<=1)return e;let t,n=e.length-1,s=0;for(;0!==n;)s=this.getUniformInt(0,n),t=e[n-=1],e[n]=e[s],e[s]=t;return e}}t.Random=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=o(n(1)),a=o(n(78));function o(e){return e&&e.__esModule?e:{default:e}}t.default=(0,a.default)(function(e,t,n,a,o){var i=e[t],l=void 0===i?"undefined":s(i);return r.default.isValidElement(i)?new Error("Invalid "+a+" `"+o+"` of type ReactElement supplied to `"+n+"`, expected an element type (a string or a ReactClass)."):"function"!==l&&"string"!==l?new Error("Invalid "+a+" `"+o+"` of value `"+i+"` supplied to `"+n+"`, expected an element type (a string or a ReactClass)."):null}),e.exports=t.default},function(e,t,n){"use strict";function s(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}Object.defineProperty(t,"__esModule",{value:!0});const r=n(40);s(n(40)),s(n(25));const a=n(181);s(n(181));const o=n(187);s(n(187)),r.Component.MindControl=a.MindControl,r.Component.Abilities=o.Abilities},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(9).Random.getRNG();function o(e){e.forEach(t=>{if(!Number.isInteger(t)){const t=JSON.stringify(e);r.default.err("Geometry","verifyInt","Value not an Int. Arr: "+t)}})}t.Geometry={getBoxAround(e,t,n,s=!1){o([e,t]);const r=[];for(let s=e-n;s<=e+n;s++)for(let a=t-n;a<=t+n;a++)s===e&&a===t||r.push([s,a]);return s&&r.push([e,t]),r},getCrossAround(e,t,n,s=!1){o([e,t,n]);const r=[];for(let s=e-n;s<=e+n;s++)for(let a=t-n;a<=t+n;a++)s!==e&&a!==t||s===e&&a===t||r.push([s,a]);return s&&r.push([e,t]),r},getDiagCross(e,t,n,s=!1){o([e,t,n]);const r=[];for(let s=e-n;s<=e+n;s++)for(let a=t-n;a<=t+n;a++){const n=a-t;0!==s-e&&0!==n&&r.push([s,a])}return s&&r.push([e,t]),r},getCrossCaveConn(e,t,n,s=!1){o([e,t,n]);const r=[];for(let s=e-n;s<=e+n;s++)for(let a=t-n;a<=t+n;a++)s!==e&&a!==t||s===e&&a===t||r.push([s,a]);return s&&r.push([e,t]),r},getBox(e,t,n,s){o([e,t,n,s]);const r=[];for(let a=e;a<=n;a++)for(let e=t;e<=s;e++)r.push([a,e]);return r},convertBbox:e=>e.hasOwnProperty("llx")?{ulx:e.llx,uly:e.ury,lrx:e.urx,lry:e.lly}:e,getCoordBbox(e){const{ulx:t,uly:n,lrx:s,lry:r}=e;return this.getBox(t,n,s,r)},getBorderForBbox(e){const{ulx:t,uly:n,lrx:s,lry:r}=e;return this.getHollowBox(t,n,s,r)},getCellsInBbox(e,t){const n=this.getCoordBbox(t),s=[];return n.forEach(t=>{s.push(e[t[0]][t[1]])}),s},isInBbox(e,t,n){const{ulx:s,uly:r,lrx:a,lry:o}=n;return e>=s&&e<=a&&t>=r&&t<=o},isValidBbox(e){if(!e)return!1;const{ulx:t,uly:n,lrx:s,lry:a}=e;return!r.default.isNullOrUndef([t,n,s,a])},dirToBbox(e,t,n){const s=Math.round(e/3),a=Math.round(t/3),o=s,i=a,l=2*s-1,c=2*a-1,u=r.default.dirTodXdY(n);return u?{ulx:o+u[0]*s,uly:i+u[1]*a,lrx:l+u[0]*s,lry:c+u[1]*a}:(r.default.err("Geometry","dirToBbox",`Invalid dir ${n} given.`),null)},getBoxCornersForCells(e,t){const[n,s]=[e.getX(),e.getY()],[r,a]=[t.getX(),t.getY()];return{ulx:n<=r?n:r,uly:s<=a?s:a,lrx:r>n?r:n,lry:a>s?a:s}},getHollowBox(e,t,n,s){o([e,t,n,s]);const r=[];for(let a=e;a<=n;a++)for(let o=t;o<=s;o++)o!==t&&o!==s&&a!==e&&a!==n||r.push([a,o]);return r},getHollowDiamond(e,t,n){o([e,t,n]);const s=e+2*n,r=e+n,a=t+n,i=t-n,l=[[e,t]],c={N:[r,a],S:[r,i],E:[s,t],W:[e,t],coord:[]};for(let n=e+1;n<=r;n++){for(let e=t+1;e<=a;e++)l.push([n,e]);for(let e=t-1;e>=i;e--)l.push([n,e])}for(let e=r+1;e<=s;e++){for(let n=t+1;n<=a;n++)l.push([e,n]);for(let n=t-1;n>=i;n--)l.push([e,n])}return c.coord=l,c},isCorner:(e,t,n,s,r,a)=>(e===n||e===r)&&(t===s||t===a),removeMatching(e,t){let n=0;return Array.isArray(e)?t.forEach(t=>{const s=e.findIndex(e=>e[0]===t[0]&&e[1]===t[1]);s>=0&&(e.splice(s,1),++n)}):t.forEach(t=>{const s=t[0]+","+t[1];e.hasOwnProperty(s)&&(delete e[s],++n)}),n},getCellsAround(e,t){const n=t.getXY(),s=this.getBoxAround(n[0],n[1],1),a=e.getCellsWithCoord(s),o={};return a.forEach(e=>{const t=r.default.dXdYUnit(e,n),s=r.default.dXdYToDir(t);o[s]=e.getBaseElem().getType()}),o},tileLevels(e,t,n){const{x:s,y:r}=n;let a=s,o=r;if(n.alignLeft)t.forEach(t=>{this.mergeLevels(e,t,a,o),o+=t.getMap().rows});else if(n.centerX){const n=Math.round(e.getMap().cols/2);t.forEach(t=>{a=n-Math.round(t.getMap().cols/2),this.mergeLevels(e,t,a,o),o+=t.getMap().rows})}else if(n.centerY){const n=Math.round(e.getMap().rows/2);t.forEach(t=>{o=n-Math.round(t.getMap().rows/2),this.mergeLevels(e,t,a,o),a+=t.getMap().cols})}},mergeLevels(e,t,n,s){const a=e.getMap(),o=t.getMap(),i=e.getActors().length+t.getActors().length,l=t.getActors().slice(),c=t.getItems().slice(),u=t.getElements().slice(),h=(0===l.length&&0===c.length&&u.length,e=>[e.getX()+n,e.getY()+s]);l.forEach(n=>{const[s,r]=h(n);a.hasXY(s,r)&&t.removeActor(n)&&e.addActor(n,s,r)}),c.forEach(n=>{const[s,r]=[n.getX(),n.getY()],[o,i]=h(n);a.hasXY(o,i)&&t.removeItem(n,s,r)&&e.addItem(n,o,i)}),u.forEach(n=>{const[s,r]=[n.getX(),n.getY()],[o,i]=h(n);a.hasXY(o,i)&&t.removeElement(n,s,r)&&e.addElement(n,o,i)}),this.mergeMapBaseElems(a,o,n,s);const d=e.getActors().length;d!==i&&r.default.err("Geometry","mergeLevels",`Num actors new: ${d}, exp: ${i}`)},mergeMapBaseElems(e,t,n,s){if(e.cols<t.cols){const n=`m1: ${e.cols} m2: ${t.cols}`;r.default.err("Geometry","mergeMapBaseElems","Cols: m2 cols must be smaller/equal: "+n)}if(e.rows<t.rows){const n=`m1: ${e.rows} m2: ${t.rows}`;r.default.err("Geometry","mergeMapBaseElems","Rows: m2 rows must be smaller/equal: "+n)}const a=n+t.cols-1,o=s+t.rows-1;for(let r=n;r<=a;r++)for(let a=s;a<=o;a++)if(e.hasXY(r,a)){const o=t.getCell(r-n,a-s);e._map[r][a].setBaseElem(o.getBaseElem())}},mergeMapCellsUnsafe(e,t,n,s){const a=n+t.cols-1,o=s+t.rows-1;for(let i=n;i<=a;i++)for(let a=s;a<=o;a++)if(e.hasXY(i,a)){const o=t.getCell(i-n,a-s);o||r.default.err("Geometry","mergeMapCellsUnsafe",`Null cell: ${n},${s}, [${i}][${a}]`),e.moveCellUnsafe(i,a,o)}},mergeMaps(e,t,n,s,r=((e,t)=>!0)){const a=n+t.cols-1,o=s+t.rows-1;for(let i=n;i<=a;i++)for(let a=s;a<=o;a++)if(e.hasXY(i,a)){const o=t.getCell(i-n,a-s),l=e._map[i][a];r(l,o)&&l.setBaseElem(o.getBaseElem())}},iterateMapWithBBox(e,t,n){for(let s=t.ulx;s<=t.lrx;s++)for(let r=t.uly;r<=t.lry;r++)e.hasXY(s,r)&&n(s,r)},insertEntity(e,t,n,s){switch(t){case r.default.TYPE_ACTOR:this.insertActors(e,t,n,s);break;case r.default.TYPE_ITEM:this.insertItems(e,t,n,s);break;case r.default.TYPE_ELEM:this.insertElements(e,t,n);break;default:r.default.err("Geometry","insertEntity",`No type ${t} supported`)}},insertElements(e,t,n){const s=e.getMap();this.iterateMapWithBBox(s,n,(e,n)=>{const a=r.default.FACT.createElement(t);t.match(/(wall|floor)/)?s._map[e][n].setBaseElem(a):s._map[e][n].setProp("elements",a)})},insertActors(e,t,n,s){const a=e.getMap();this.iterateMapWithBBox(a,n,(n,o)=>{if(a.getCell(n,o).isFree()){const a=s.createActualObj(r.default.TYPE_ACTOR,t);e.addActor(a,n,o)}})},insertItems(e,t,n,s){const a=e.getMap();this.iterateMapWithBBox(a,n,(n,o)=>{if(a.getCell(n,o).isFree()){const a=s.createActualObj(r.default.TYPE_ITEM,t);e.addItem(a,n,o)}})},getFreeArea(e,t,n,s){let r=!1;const o=e.slice(),i={};for(e.forEach(e=>{i[e[0]+","+e[1]]=e});!r&&o.length>0;){const e=a.getUniformInt(0,o.length-1),l=o[e][0],c=o[e][1];let u=!0;for(let e=l;e<l+t;e++)for(let t=c;t<c+n;t++)i[e+","+t]?s.push([e,t]):u=!1;(r=u)||(s=[],o.splice(e))}return r},isLine:(e,t,n,s)=>e===n||t===s||Math.abs(n-e)===Math.abs(s-t),xyInLine(e){for(let t=1;t<e.length;t++){const[n,s]=[e[t],e[t-1]],[r,a]=n,[o,i]=s;if(!this.isLine(r,a,o,i))return!1}return!0},sameXOrY(e){for(let t=1;t<e.length;t++){const[n,s]=[e[t],e[t-1]],[r,a]=n,[o,i]=s;if(r!==o&&a!==i)return!1}return!0},getStraightLine(e,t,n,s,r=!0){if(this.isLine(e,t,n,s)){const a=[],o=n===e?0:(n-e)/Math.abs(n-e),i=s===t?0:(s-t)/Math.abs(s-t);for(r&&a.push([e,t]);e!==n||t!==s;)e!==n&&(e+=o),t!==s&&(t+=i),e===n&&t===s?r&&a.push([e,t]):a.push([e,t]);return a}return[]},getBresenham(e,t,n,s){let[r,a,o,i]=[0,0,0,0],[l,c,u,h]=[0,0,0,0],[d,p]=[0,0];const f=[];if((r=n-e)<0&&(r=-r),(a=s-t)<0&&(a=-a),l=1,n<e&&(l=-1),c=1,s<t&&(c=-1),d=e,p=t,f.push([d,p]),r>a)for(i=2*a-r,u=2*(a-r),h=2*a,o=0;o<r;o++)i>=0?(p+=c,i+=u):i+=h,d+=l,f.push([d,p]);else for(i=2*r-a,u=2*(r-a),h=2*r,o=0;o<a;o++)i>=0?(d+=l,i+=u):i+=h,p+=c,f.push([d,p]);return f},getMissilePath(e,t,n,s,r=!0){let a=[];if(this.isLine(e,t,n,s))a=this.getStraightLine(e,t,n,s,r);else{r&&a.push([e,t]);const o=n-e,i=s-t,l=Math.abs(o),c=Math.abs(i),u=o/l,h=i/c;let d=l,p=c,f=e,m=t;if(l>c){for(;p>=0&&d%p!=0;)f+=u,m+=h,a.push([f,m]),d-=1,p-=1;if(0===p)for(;f!==n;)f+=u,a.push([f,m]);else{const e=d/p;for(;f!==n&&m!==s;){m!==s&&(m+=h);for(let t=0;t<e;t++)f!==n&&(f+=u,a.push([f,m]))}}}else if(c>l){for(;d>=0&&p%d!=0;)f+=u,m+=h,a.push([f,m]),d-=1,p-=1;if(0===d)for(;m!==s;)m+=h,a.push([f,m]);else{const e=p/d;for(;f!==n&&m!==s;){f!==n&&(f+=u);for(let t=0;t<e;t++)m!==s&&(m+=h,a.push([f,m]))}}}}return a}},t.Geometry.floodfill=function(e,t,n,s=!1){let r=n;if("string"==typeof n&&(r=(e=>e.getBaseElem().getType()===n)),!r(t))return[];let a=t;const o=[],i=[t],l={};l[t.getKeyXY()]=!0;const c=function(t,n){if(e.hasXY(t,n)&&!l[t+","+n]){const s=e.getCell(t,n);r(s)&&(l[s.getKeyXY()]=!0,i.push(s),o.push(s))}};for(;a;){const[e,t]=a.getXY(),n=e-1;c(n,t);const r=e+1;c(r,t);const i=t-1;c(e,i);const l=t+1;c(e,l),s&&(c(n,i),c(r,i),c(n,l),c(r,l)),a=o.shift()}return i},t.Geometry.floodfill2D=function(e,t,n,s=!1,r=!1){const[a,o]=t;if(e[a][o]!==n)return[];let i=t;const l=[],c=[i],u={};u[a+","+o]=!0;const h=function(t,r){if(t>=0&&t<e.length&&r>=0&&r<e[0].length&&!u[t+","+r]){e[t][r]===n&&(u[t+","+r]=!0,c.push([t,r]),s&&(s[t+","+r]=!0),l.push([t,r]))}};for(;i;){const[e,t]=i,n=e-1;h(n,t);const s=e+1;h(s,t);const a=t-1;h(e,a);const o=t+1;h(e,o),r&&(h(n,a),h(s,a),h(n,o),h(s,o)),i=l.shift()}return c},t.Geometry.getMassCenter=function(e){let t=0,n=0;for(let s=0;s<e.length;s++)t+=e[s][0],n+=e[s][1];return[Math.round(t/e.length),Math.round(n/e.length)]},t.Geometry.squareFill=function(e,t,n,s){const[a,o]=t.getXY(),[i,l]=s;0!==i&&0!==l||r.default.err("Geometry","squareFill",`dx,dy must be -1 or 1. Got ${s}`);let c=!1,u=[t],h=t;for(;!c;){const t=[],[s,r]=h.getXY(),[d,p]=[s+i,r+l];if(e.hasXY(d,p)){const s=e.getCell(d,p);if(s.getBaseElem().getType()!==n){c=!0;break}t.push(s);let r=d;do{r+=-i;const s=e.getCell(r,p);if(s.getBaseElem().getType()!==n){c=!0;break}t.push(s)}while(r!==a);let f=p;do{f+=-l;const s=e.getCell(d,f);if(s.getBaseElem().getType()!==n){c=!0;break}t.push(s)}while(f!==o);c||(u=u.concat(t)),h=s}}return u},t.Geometry.histArrayVals=function(e){const t={};return e.forEach(e=>{t[e]?t[e]+=1:t[e]=1}),t},t.Geometry.tesselateLine=function(e,n,s,r,o,i){const l=Math.abs(e-s),c=Math.abs(n-r),u=e<s?e:s,h=e>s?e:s,d=n<r?n:r,p=n>r?n:r;if(l>=o&&c>=o){const l=a.getUniformInt(u,h),c=a.getUniformInt(d,p);t.Geometry.tesselateLine(e,n,l,c,o,i),t.Geometry.tesselateLine(l,c,s,r,o,i)}else{t.Geometry.getBresenham(e,n,s,r).forEach(e=>{i.push(e)})}},t.Geometry.getCaveConnLine=function(e,n,s,r,o){let i=[];const l=[];t.Geometry.tesselateLine(e,n,s,r,4,l);let c=t.Geometry.getCrossCaveConn;return o&&"function"==typeof o.brush&&(c=o.brush),l.forEach(e=>{const[t,n]=e,s=a.getUniformInt(1,3),r=c(t,n,s,!0);i=i.concat(r)}),i}},function(e,t){e.exports=ReactDOM},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(302),i=n(87),l=r(n(53)),c=r(n(34)),u=n(184),h=n(20),d=n(9),p=n(15),f=r(n(11)),m=n(30),g=n(185),y=n(44),v=n(129),_=d.Random.getRNG();t.ObjectShell={},t.Creator=function(e,t){this._db=e,this._dbNoRandom=t;const n={actors:{type:"setType",attack:{comp:"Combat",func:"setAttack"},defense:{comp:"Combat",func:"setDefense"},damage:{comp:"Combat",func:"setDamageDie"},speed:{comp:"Stats",func:"setSpeed"},strength:{comp:"Stats",func:"setStrength"},accuracy:{comp:"Stats",func:"setAccuracy"},agility:{comp:"Stats",func:"setAgility"},willpower:{comp:"Stats",func:"setWillpower"},perception:{comp:"Stats",func:"setPerception"},magic:{comp:"Stats",func:"setMagic"},fovrange:{comp:"Perception",func:"setFOVRange"},pp:{comp:"SpellPower",func:["setPP","setMaxPP"]},maxPP:{comp:"SpellPower",func:"setMaxPP"},hp:{comp:"Health",func:["setHP","setMaxHP"]},danger:{comp:"Experience",func:"setDanger"},brain:{func:"setBrain",factory:this.createBrain}},items:{type:"setType",value:"setValue",weight:{comp:"Physical",func:"setWeight"},damageType:"setDamageType",armour:{attack:"setAttack",defense:"setDefense",protection:"setProtection",armourType:"setArmourType"},weapon:{damage:"setDamageDie",attack:"setAttack",defense:"setDefense",weaponType:"setWeaponType",range:"setAttackRange"},missile:{damage:"setDamageDie",attack:"setAttack",range:"setAttackRange"},food:{energy:"setEnergy"}},elements:{type:"setType",msg:"setMsg"}};n.items.missileweapon=n.items.weapon,n.items.missileweapon.fireRate="setFireRate",n.items.ammo=n.items.missile,n.items.ammo.ammoType="setAmmoType",this.get=((e,t)=>this._dbNoRandom[e][t]?this._dbNoRandom[e][t]:this._db[e][t]),this.createComponent=((e,t)=>{switch(e){case"Combat":return new f.Combat;case"Experience":return new f.Experience;case"Health":return new f.Health(t);case"Stats":return new f.Stats;default:if(f.hasOwnProperty(e))return new f[e];a.default.err("Creator","createComponent","Component |"+e+"| does not exist.")}return null}),this.createActualObj=function(e,t){const s=this.get(e,t),r=n[e];s||a.default.err("Creator","createActualObj",`shell for ${t} is not found.`);const o=this.createNewObject(e,s);o||a.default.err("ObjectShell.creator","createActualObj",`Failed to create obj with ${JSON.stringify(s)}`),s.hasOwnProperty("addComp")&&this.addComponents(s,o);for(const e in s)if(r.hasOwnProperty(e)){const t=r[e];if("object"==typeof t){if(t.hasOwnProperty("comp"))this.addCompToObj(o,t,s[e]);else if(t.hasOwnProperty("factory")){if("brain"===e){const n=t.factory(o,s[e]);o[t.func](n)}}else for(const n in t)if(t.hasOwnProperty(n)){const r=t[n];o.hasOwnProperty(r)&&o[r](s[e])}}else o[t](s[e])}else if(s.hasOwnProperty("type")&&r.hasOwnProperty(s.type)){const t=r[s.type];if(t.hasOwnProperty(e)){const n=t[e];if("object"==typeof n){for(const t in n)if(n.hasOwnProperty(t)){const r=n[t];o.hasOwnProperty(r)&&o[n[t]](s[e])}}else o[n](s[e])}}return s.hasOwnProperty("use")&&this.addUseEffects(s,o),s.hasOwnProperty("equip")&&this.addEquippedItems(s,o),s.hasOwnProperty("inv")&&this.addInventoryItems(s,o),s.hasOwnProperty("loot")&&this.addLootComponents(s,o),s.hasOwnProperty("poison")&&this.addPoison(s,o),s.hasOwnProperty("enemies")&&this.addEnemies(s,o),s.hasOwnProperty("spells")&&this.addSpellbookAndSpells(s,o),s.hasOwnProperty("onHit")&&this.addOnHitProperties(s,o),s.hasOwnProperty("onAttackHit")&&this.addOnAttackHitProperties(s,o),s.hasOwnProperty("onEquip")&&this.addOnEquipProperties(s,o),s.hasOwnProperty("goals")&&this.addGoalsToObject(s,o),o},this.addPoison=((e,t)=>{const n=e.poison,s=new f.Poison;s.setProb(n.prob),s.setSource(t),s.setDamageDie(m.Dice.create(n.damage));const r=m.Dice.create(n.duration);s.setDurationDie(r);const a=new f.AddOnHit;a.setComp(s),t.add(a)}),this.addOnHitProperties=((e,t)=>{e.onHit.forEach(e=>{this.processAddComp(e,t)})}),this.addOnAttackHitProperties=((e,t)=>{e.onAttackHit.forEach(e=>{const n=this.processAddComp(e,t);n.setOnDamage(!1),n.setOnAttackHit(!0)})}),this.addOnEquipProperties=((e,t)=>{e.onEquip.forEach(e=>{this.processAddComp(e,t,!0)})}),this.processAddComp=((e,t,n=!1)=>{let s=null;if(s=n?new f.AddOnEquip:new f.AddOnHit,e.addComp){const n=this.createComponent(e.addComp);n.setSource&&a.default.isActor(t)&&n.setSource(t),Array.isArray(e.func)&&e.func.forEach(e=>{if("function"==typeof n[e.setter])n[e.setter](e.value);else{const t=n.toJSON();a.default.err("ObjectShellParser","addOnHitProperties",`Not a func: ${e.setter} in comp ${t}`)}});const r=n;if(e.duration){const t=m.Dice.create(e.duration),n=new f.Duration;n.setDurationDie(t),n.setComp(r),s.setComp(n),e.expireMsg&&n.setExpireMsg(e.expireMsg)}else s.setComp(r);return t.add(s),s}return e.transientComp?(s.setComp(JSON.parse(JSON.stringify(e))),t.add(s),s):null}),this.addEnemies=((e,t)=>{e.enemies.forEach(e=>{t.getBrain().addEnemyType(e)})}),this.addSpellbookAndSpells=((e,t)=>{t.setBook(new g.Spell.SpellBook(t)),e.spells.forEach(e=>{const n=this.getUsedObject(e);if(g.Spell[n])t.getBook().addSpell(new g.Spell[n]);else{const e=`Spell |${n}| does not exist.`;a.default.err("Creator","addSpellbookAndSpells",e)}})}),this.addGoalsToObject=((e,t)=>{if(a.default.isActor(t)){const{goals:n}=e;n.forEach(e=>{const{name:n,bias:s}=e,r=new y.Evaluator[n](s);Object.keys(e).forEach(t=>{"name"!==t&&"bias"!==t&&r[t](e[t])}),t.getBrain().getGoal().addEvaluator(r)})}}),this.getUsedObject=(e=>"object"==typeof e&&e.random?_.arrayGetRand(e.random):e),this.createNewObject=((e,t)=>{switch(e){case a.default.TYPE_ACTOR:t.type;switch(t.actorType){case"BaseActor":return new l.BaseActor(t.name);default:return new l.SentientActor(t.name)}case a.default.TYPE_ITEM:const n=t.type;switch(n){case"armour":return new c.Armour(t.name);case"book":return new c.Book(t.name);case"food":return new c.Food(t.name);case"gold":return new c.Gold(t.name);case"goldcoin":return new c.GoldCoin(t.name);case"mineral":return new c.Mineral(t.name);case"missile":return new c.Missile(t.name);case"missileweapon":return new c.MissileWeapon(t.name);case"ammo":return new c.Ammo(t.name);case"potion":return new c.Potion(t.name);case"rune":return new c.Rune(t.name);case"spiritgem":return new c.SpiritGem(t.name);case"weapon":return new c.Weapon(t.name);default:{if(n){const e=new c.ItemBase(t.name);return e.setType(t.type),e}const e=`Null/undef type: ${n}, obj: ${JSON.stringify(t)}`;a.default.err("","createNewObject",e)}}break;case a.default.TYPE_ELEM:{const e=t.type||t.name;return new p.ElementBase(t.name,e)}}return null}),this.addCompToObj=function(e,t,n){if(t.hasOwnProperty("func"))if(Array.isArray(t.func))t.func.forEach(s=>{const r=t.comp;if(e.has(r))"function"==typeof e.get(r)[s]?e.get(r)[s](n):this.noFuncError(r,s,t);else{const a=this.createComponent(r);"function"==typeof a[s]?(a[s](n),e.add(a)):this.noFuncError(r,s,t)}});else{const s=t.func,r=t.comp;if(e.has(r)&&"string"==typeof s)e.get(r)[s](n);else{const o=this.createComponent(r);if(e.add(o),"function"==typeof o[s])o[s](n);else if("object"==typeof s){Object.keys(t.func).forEach(n=>{const s={func:n,comp:r},a=t.func[n];this.addCompToObj(e,s,a)})}else a.default.log(JSON.stringify(s)),a.default.err("ObjectShellParser","addCompToObj",`No function ${s} in ${r}`)}}else e.has(t.comp)?a.default.err("ObjectShellParser","xxx","Not implemented"):e.add(this.createComponent(t.comp,n))},this.noFuncError=((e,t,n)=>{const s="compData "+JSON.stringify(n);a.default.err("ObjectShellParser","addCompToObj",`Comp: ${e} no func ${t}, ${s}`)}),this.addComponents=((e,t)=>{if("string"==typeof e.addComp)s(e.addComp,t);else if(Array.isArray(e.addComp))e.addComp.forEach(e=>{let n=e;e.random&&(n=_.arrayGetRand(e.random)),"string"==typeof n?s(n,t):r(t,n)});else if("object"==typeof e.addComp){let n=e.addComp;e.addComp.random&&(n=_.arrayGetRand(e.addComp.random)),r(t,n)}else a.default.err("Creator","addComponents","Giving up. shell.addComp must be string, array or object.")});const s=(e,t)=>{try{const n=new f[e];t.add(n)}catch(t){let n=`shell.addComp |${e}|`;n+="Component names are capitalized.",a.default.err("Creator","_addCompFromString",`${t.message} - ${n}`)}},r=(e,t)=>{this.addCompToObj(e,t,null)};this.addInventoryItems=function(e,t){e.inv.forEach(e=>{const n=e.name||e,s=e.count||1,r=this.createActualObj(a.default.TYPE_ITEM,n);r?(r.setCount(s),t.getInvEq().addItem(r)):a.default.err("Creator","addInventoryItems",`itemObj for ${n} is null. Actor: ${t.getName()}`)})},this.addLootComponents=function(e,t){const n=e.loot,s=this.createActualObj(a.default.TYPE_ITEM,n),r=new f.Loot(s);t.add(r)},this.addEquippedItems=function(e,t){const n=e.equip;let s=!1;n.forEach(e=>{const n=e.name||e,r=e.count||1,o=this.createActualObj(a.default.TYPE_ITEM,n);o?(o.setCount(r),t.getInvEq().restoreEquipped(o)||(s=!0)):a.default.err("Creator","addEquippedItems",`itemObj for ${e} is null. Actor: ${t.getName()}`)}),s&&_.shuffle(e.equip)},this.addUseEffects=((e,t)=>{if(t.useFuncs=[],t.useItem=this._db.effects.use.func.bind(t),"object"==typeof e.use&&e.use.hasOwnProperty("length"))for(let n=0;n<e.use.length;n++)o(e,t,e.use[n]);else if("object"==typeof e.use)for(const n in e.use)e.use.hasOwnProperty(n)&&o(e,t,n);else o(e,t,e.use)});const o=(e,t,n)=>{const s=n;if(this._db.effects.hasOwnProperty(s)){const r=this._db.effects[s],o=r.func;if(t.useFuncs.push(o),r.hasOwnProperty("requires"))if(e.use.hasOwnProperty(n)){t.useArgs={};const s=r.requires;if("object"==typeof s)for(let r=0;r<s.length;r++)i(e.use[n],t,s[r]);else i(e.use[n],t,s)}else a.default.err("ObjectParser","addUseEffects","useEffect shell has 'requires'.\n                        Item shell 'use' must be an object.");if(r.hasOwnProperty("optional")){r.optional.forEach(s=>{e.use[n].hasOwnProperty(s)&&(t.useArgs[s]=e.use[n][s])})}}else a.default.err("ObjectParser","addUseEffects","Unknown effect: |"+s+"|")},i=(e,t,n)=>{e.hasOwnProperty(n)?t.useArgs[n]=e[n]:a.default.err("ObjectParser","_verifyAndAddReq",`Req |${n}| not specified in item shell. Item: ${t}`)};this.createFromShell=function(e,t){return t?this.createActualObj(e,t.name):(a.default.err("Creator","createFromShell","obj given must be defined."),null)}},t.ObjectShell.Creator=t.Creator,t.Creator.prototype.createBrain=function(e,t){if(h.Brain[t])return new h.Brain[t](e);const n=`ERROR. No brain type |${t}| found`;a.default.err("Creator","createBrain",n)},t.ProcGen=function(e,t){this._db=e,this._dbDanger=t;const n={actorWeights:{}};this.dbGet=(e=>{const t=e.name,n=e.categ,s=e.danger;if(!a.default.isNullOrUndef([t]))return n||a.default.err("ProcGen","dbGet","Both name and categ must be given!"),this._db[n][t];if(!a.default.isNullOrUndef([s])){if(this._dbDanger.hasOwnProperty(s)){const e=this._dbDanger[s];return void 0!==n?e.hasOwnProperty(n)?e[n]:{}:this._dbDanger[s]}return{}}return!a.default.isNullOrUndef([n])&&this._db.hasOwnProperty(n)?this._db[n]:{}}),this.filterCategWithFunc=function(e,t){const n=this.dbGet({categ:e}),s=[],r=Object.keys(n);for(let e=0;e<r.length;e++){const a=n[r[e]];t(a)&&s.push(a)}return s},this.dbGetRand=function(e){const t=e.danger,n=e.categ;if(void 0!==t&&void 0!==n&&this._dbDanger.hasOwnProperty(t)){const e=this._dbDanger[t][n];return this.getRandFromObj(e)}return null},this.getRandomActor=function(e){if(e.hasOwnProperty("danger")){const t=e.danger,n=this.dbGetRand({danger:t,categ:a.default.TYPE_ACTOR});if(null!==n)return n}else if(e.hasOwnProperty("func")){const t=this.filterCategWithFunc(a.default.TYPE_ACTOR,e.func);return _.arrayGetRand(t)}return null},this.getRandomItem=function(e){if("function"==typeof e){const t=this.filterCategWithFunc(a.default.TYPE_ITEM,e);return _.arrayGetRand(t)}if(e.hasOwnProperty("func")){const t=this.filterCategWithFunc(a.default.TYPE_ITEM,e.func);return _.arrayGetRand(t)}return a.default.err("ProcGen","getRandomItem",`No function with func. obj arg: ${JSON.stringify(e)}`),null},this.getRandomActorWeighted=function(e,t){const s=e+","+t;n.actorWeights.hasOwnProperty(s)||(n.actorWeights[s]=a.default.getDangerProb(e,t));const r=_.getWeighted(n.actorWeights[s]);return this.getRandomActor({danger:r})},this.getRandFromObj=(e=>{const t=Object.keys(e);return e[t[_.randIndex(t)]]})},t.ObjectShell.ProcGen=t.ProcGen,t.Parser=function(){this._base={actors:{},effects:{},items:{},elements:{}},this._db={actors:{},effects:{},items:{},elements:{}},this._dbDanger={},this._dbNoRandom={actors:{},items:{},elements:{}},this._creator=new t.Creator(this._db,this._dbNoRandom),this._procgen=new t.ProcGen(this._db,this._dbDanger),this.getCreator=function(){return this._creator},this.getProcGen=function(){return this._procgen},this.parseShellData=function(e){const t=Object.keys(e);for(let n=0;n<t.length;n++)this.parseShellCateg(t[n],e[t[n]])},this.parseShellCateg=function(e,t){for(let n=0;n<t.length;n++)this.parseObjShell(e,t[n])},this.parseObjShell=function(e,t){if(this.validShellGiven(t)){if(t.hasOwnProperty("base")){("string"==typeof t.base?[t.base]:t.base).forEach(n=>{this.baseExists(e,n)?t=this.extendObj(t,this.getBase(e,n)):a.default.err("ObjectParser","parseObjShell","Unknown base "+n+" specified for "+JSON.stringify(t))})}return e===a.default.TYPE_ACTOR&&this.addTypeIfUntyped(t),this.storeIntoDb(e,t),t}return null},this.validShellGiven=(e=>!!e.hasOwnProperty("name")||(a.default.err("Parser","validShellGiven",`shell doesn't have a name. shell: ${JSON.stringify(e)}`),!1)),this.addTypeIfUntyped=(e=>{e.hasOwnProperty("type")||(e.type=e.name)}),this.get=((e,t)=>this._db[e][t]),this.getBase=((e,t)=>this._base[e][t]),this.storeForUsingAsBase=((e,t)=>{this._base[e][t.name]=t}),this.storeIntoDb=function(e,t){if(this._db.hasOwnProperty(e)){if(this.storeForUsingAsBase(e,t),t.hasOwnProperty("noRandom"))this._dbNoRandom[e][t.name]=t;else if(!t.hasOwnProperty("dontCreate")&&(this._db[e][t.name]=t,t.hasOwnProperty("danger"))){const n=t.danger;this._dbDanger.hasOwnProperty(n)||(this._dbDanger[n]={}),this._dbDanger[n].hasOwnProperty(e)||(this._dbDanger[n][e]={}),this._dbDanger[n][e][t.name]=t}}else a.default.err("ObjectParser","storeIntoDb","Unknown category: "+e);this.storeRenderingInfo(e,t)},this.storeRenderingInfo=((e,t)=>{if(t.hasOwnProperty("color")){if(a.default.isNullOrUndef([t.color])){const e=JSON.stringify(t);a.default.err("Parser","storeRenderingInfo",`obj.color null/undef! obj: ${e}`)}let{fg:e,bg:n}=t.color;if(t.hasOwnProperty("colorfg")&&(e=t.colorfg),t.hasOwnProperty("colorbg")&&(n=t.colorbg),!e||!n){const e=JSON.stringify(t.color);a.default.err("Parser","storeRenderingInfo",`fg and bg must be given. ${t.name} Got: ${e}`)}t.className||(t.className=""),t.className+=" cell-fg-"+e.toLowerCase()+" cell-bg-"+n.toLowerCase()}t.hasOwnProperty("char")&&(t.hasOwnProperty("name")?(a.default.addCharStyle(e,t.name,t.char),t.dontCreate&&a.default.addCharStyle(e,t.type,t.char)):a.default.addCharStyle(e,t.type,t.char)),t.hasOwnProperty("className")&&(t.hasOwnProperty("name")?(a.default.addCellStyle(e,t.name,t.className),t.dontCreate&&a.default.addCellStyle(e,t.type,t.className)):a.default.addCellStyle(e,t.type,t.className))}),this.baseExists=((e,t)=>!!this._base.hasOwnProperty(e)&&this._base[e].hasOwnProperty(t)),this.extendObj=((e,t)=>{for(const n in t)e.hasOwnProperty(n)||"dontCreate"!==n&&(e[n]=t[n]);return e}),this.createEntity=function(e){return this.hasObj(a.default.TYPE_ITEM,e)?this.createItem(e):this.hasObj(a.default.TYPE_ACTOR,e)?this.createActor(e):null},this.createActor=function(e){return this.createActualObj(a.default.TYPE_ACTOR,e)},this.createItem=function(e){return this.createActualObj(a.default.TYPE_ITEM,e)},this.createElement=function(e){return this.createActualObj(a.default.TYPE_ELEM,e)},this.hasItem=function(e){return this.hasObj(a.default.TYPE_ITEM,e)},this.hasObj=function(e,t){return this.dbExists(e,t)},this.createActualObj=function(e,t){return this.dbExists(e,t)?this._creator.createActualObj(e,t):(a.default.err("Parser","createActualObj",`Categ: ${e} Name: ${t} doesn't exist.`),null)},this.createFromShell=((e,t)=>(this.dbExists(e,t.name)||this.parseObjShell(e,t),this._creator.createFromShell(e,t))),this.dbExists=((e,t)=>!(!this._db.hasOwnProperty(e)||!this._db[e].hasOwnProperty(t))||!!this._dbNoRandom[e][t]),this.dbGet=(e=>this._procgen.dbGet(e)),this.dbGetActor=(e=>{const t={name:e.name,categ:a.default.TYPE_ACTOR};return this._procgen.dbGet(t)}),this.dbGetItem=(e=>{const t={name:e.name,categ:a.default.TYPE_ITEM};return this._procgen.dbGet(t)}),this.dbGetRand=(e=>this._procgen.dbGetRand(e)),this.filter=function(e,t){return this._procgen.filterCategWithFunc(e,t)},this.filterItems=function(e){return this._procgen.filterCategWithFunc(a.default.TYPE_ITEM,e)},this.dbGetNoRandom=(e=>{const t=e.name,n=e.categ,s=e.danger;if(n&&this._dbNoRandom[n]){if(!t)return Object.values(this._dbNoRandom[n]);{const e=this._dbNoRandom[n][t];if(e)return[e]}}else n&&s&&a.default.err("ProcGen","dbGetNoRandom","Query by danger not implemented yet");return[]}),this.createRandomActor=(e=>{const t=this._procgen.getRandomActor(e);return t?this._creator.createFromShell(a.default.TYPE_ACTOR,t):null}),this.createRandomActorWeighted=function(e,t,n){const s=this._procgen.getRandomActorWeighted(e,t);return s?this._creator.createFromShell(a.default.TYPE_ACTOR,s):a.default.isNullOrUndef([n])?null:this.createRandomActor(n)},this.createRandomItem=(e=>{const t=this._procgen.getRandomItem(e);return t?this._creator.createFromShell("items",t):null}),this.toJSON=function(){const e={_base:{},_db:{},_dbDanger:this._dbDanger,_dbNoRandom:this._dbNoRandom};return["actors","items","elements"].forEach(t=>{e._base[t]=this._base[t],e._db[t]=this._db[t]}),e},this.restoreFromDb=function(e){["_base","_db","_dbDanger","_dbNoRandom"].forEach(t=>{Object.keys(e[t]).forEach(n=>{this[t][n]=e[t][n]})})}},t.ObjectShell.Parser=t.Parser,t.createItem=function(e){const n=t.ObjectShell.getParser(),s=n.getCreator();return"string"==typeof e?s.createItem(e):(n.parseObjShell(a.default.TYPE_ITEM,e),s.createFromShell(a.default.TYPE_ITEM,e))},t.getParser=function(){if(!t.ObjectShell.parserInstance){const e=new t.Parser;e.parseShellData(u.Effects);const n=JSON.stringify(o.Objects),s=JSON.parse(n);i.adjustActorValues(s.actors),e.parseShellData(s),t.ObjectShell.parserInstance=e;const r=v.ActorGen.genActors(100);e.parseShellData({actors:r})}return t.ObjectShell.parserInstance},t.ObjectShell.getParser=t.getParser,t.restoreParser=function(e){const n=new t.Parser;n.restoreFromDb(e),n.parseShellData(u.Effects),t.ObjectShell.parserInstance=n},t.ObjectShell.restoreParser=t.restoreParser},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(52),i=r(n(103)),l=r(n(25)),c=n(40);t.Element={};const u=/wall/,h=/(?:highrock|water|chasm|wall)/;t.Element.canJumpOver=(e=>!(u.test(e)||/highrock/.test(e)));class d extends(i.Typed(o.Entity)){constructor(e,t){let n=null,s=null;"object"==typeof e?(n=e.name,s=e.type):(n=e,s=t),s=s||n,super({propType:a.default.TYPE_ELEM,type:s}),a.default.elementsCreated+=1,this._name=n,this.msg={}}getName(){return this._name}setName(e){this._name=e}isWall(){return u.test(this.getType())}isObstacle(){return h.test(this.getType())}isPassable(){return!this.has("Impassable")}isPassableByAir(){return!this.has("Impassable")||this.get("Impassable").canFlyOver}isSpellPassable(){return!this.has("Impassable")||this.get("Impassable").spellPasses}lightPasses(){return!this.has("Opaque")}setMsg(e){this.msg=e}getMsg(e){return this.msg[e]}hasMsg(e){return this.msg.hasOwnProperty(e)}onSystemAdd(e){}onSystemRemove(e){}toJSON(){const e=c.compsToJSON(this),t={id:this.getID(),name:this.getName(),type:this.getType(),msg:this.msg};return e&&(t.components=e),t}}t.ElementBase=d,t.Element.Base=d,a.default.elementsCreated=0;class p extends d{constructor(e){super(e),this.add(new l.Opaque);const t=new l.Impassable;t.setAllImpassable(),this.add(t)}}t.ElementWall=p,t.Element.Wall=p;class f extends(i.Locatable(d)){constructor(e,t,n){super({name:e,type:"connection"}),this._srcLevel=t,this._targetLevel=n,this._targetStairs=null}isConnected(){return!a.default.isNullOrUndef([this._srcLevel,this._targetLevel,this._targetLevel])}setSrcLevel(e){a.default.isNullOrUndef([e])?a.default.err("Element.Stairs","setSrcLevel","Cannot set null/undefined level"):this._srcLevel=e}getSrcLevel(){return this._srcLevel}setTargetLevel(e){a.default.isNullOrUndef([e])?a.default.err("Element.Stairs","setTargetLevel","Cannot set null/undefined level."):this._targetLevel=e}getTargetLevel(){return this._targetLevel}setTargetStairs(e){if(a.default.isNullOrUndef([e]))a.default.err("Element.Stairs","setTargetStairs","Cannot set null/undefined stairs.");else{this._targetStairs=e;const t=e.getSrcLevel();a.default.isNullOrUndef([t])||this.setTargetLevel(t)}}getTargetStairs(){return this._targetStairs}getID(){const e=this.getX(),t=this.getY();return`${this._srcLevel.getID()},${e},${t}`}connect(e,t=0){Array.isArray(e)?(e.forEach(e=>{e.setTargetStairs(this),e.setTargetLevel(this.getSrcLevel())}),this.setTargetStairs(e[t]),this.setTargetLevel(e[t].getSrcLevel())):(this.setTargetStairs(e),e.setTargetStairs(this),this.setTargetLevel(e.getSrcLevel()),e.setTargetLevel(this.getSrcLevel()))}isDown(){return/stairsDown/.test(this.getName())}useStairs(e){if(!a.default.isNullOrUndef([this._targetStairs,this._targetLevel]))if(this._targetStairs instanceof f){const t=this._targetStairs.getX(),n=this._targetStairs.getY();if(this._srcLevel.removeActor(e)&&this._targetLevel.addActor(e,t,n))return!0}else a.default.err("ElementStairs","useStairs","Tried to use stairs without proper targetStairs");return!1}setConnObj(e){this._targetStairs=e.targetStairs,this._targetLevel=e.targetLevel}getConnObj(){const e=this.getTargetStairs();if(e instanceof f){const t=this.getTargetLevel();return{targetStairs:{x:e.getX(),y:e.getY()},targetLevel:t.getID()}}return{targetStairs:{x:e.x,y:e.y},targetLevel:this.getTargetLevel()}}toJSON(){const e={name:this.getName(),type:this.getType()};this._srcLevel&&(e.srcLevel=this.getSrcLevel().getID()),Number.isInteger(this._targetLevel)?e.targetLevel=this._targetLevel:this._targetLevel&&(e.targetLevel=this.getTargetLevel().getID());const t=this.getTargetStairs();return t&&(e.targetStairs=t instanceof f?{x:t.getX(),y:t.getY()}:t),e}}t.ElementStairs=f,t.Element.Stairs=f;class m extends(i.Locatable(d)){constructor(e){super("door"),this._closed=void 0===e||e,this._opaque=new l.Opaque;const t=new l.Impassable;t.setAllImpassable(),this._impassable=t,this._closed&&this.closeDoor()}canToggle(){return!0}isOpen(){return!this._closed}isClosed(){return this._closed}openDoor(){this._closed=!1,this.remove("Opaque"),this.remove("Impassable")}closeDoor(){this._closed=!0,this.add(this._opaque),this.add(this._impassable)}toJSON(){const e=super.toJSON();return e.closed=this._closed,e}}t.ElementDoor=m,t.Element.Door=m;class g extends m{constructor(e=!0){super(e),this.setType("leverdoor")}canToggle(){return!1}onUse(){this.isOpen()?this.closeDoor():this.openDoor()}toJSON(){const e=super.toJSON();return e.type="leverdoor",e}}t.ElementLeverDoor=g,t.Element.LeverDoor=g;class y extends(i.Locatable(d)){constructor(){super("lever"),this._targets=[]}getTargets(){return this._targets}addTarget(e){this._targets.push(e)}onUse(e){this._targets.forEach(t=>{t.onUse&&t.onUse(e)})}toJSON(){return{id:this.getID(),type:"lever",addTarget:this._targets.map(e=>a.default.getObjRef("entity",e))}}}t.ElementLever=y,t.Element.Lever=y;class v extends(i.Locatable(d)){constructor(){super("shop"),this._shopkeeper=null,this._costFactorShopSells=1,this._costFactorShopBuys=.5,this._isAbandoned=!0}isAbandoned(){return this._isAbandoned}reclaim(e){this._shopkeeper=e,this._isAbandoned=!1}getItemPriceForBuying(e){if(e.has("Unpaid")){const t=e.getValue(),n=a.default.valueToGoldWeight(t);let s=a.default.getGoldInCoins(n);return s*=e.getCount(),0===(s=Math.ceil(this._costFactorShopSells*s))?1:s}return a.default.err("Element.Shop","getItemPriceForBuying","Item "+e.getName()+" is not Unpaid item"),0}getItemPriceForSelling(e,t){const n=e.getValue(),s=a.default.valueToGoldWeight(n);let r=a.default.getGoldInCoins(s);return r*=t||e.getCount(),r=Math.floor(this._costFactorShopBuys*r)}abandonShop(){this._shopkeeper=null,this._isAbandoned=!0}setShopkeeper(e){a.default.isNullOrUndef([e])?a.default.err("Element.Shop","setShopkeeper","Shopkeeper must be non-null and defined."):(this._shopkeeper=e,this._isAbandoned=!1)}getShopkeeper(){return this._shopkeeper}setCostFactor(e,t){a.default.isNullOrUndef([e,t])?a.default.err("Element.Shop","setCostFactor","Args buy/sell must be non-null and defined!"):(this._costFactorShopSells=t,this._costFactorShopBuys=e)}getCostFactorSell(){return this._costFactorShopSells}getCostFactorBuy(){return this._costFactorShopBuys}toJSON(){let e=null;this._shopkeeper&&(e=this._shopkeeper.getID());const t={type:"shop",isAbandoned:this._isAbandoned,costFactorSell:this._costFactorShopSells,costFactorBuy:this._costFactorShopBuys};return null!==e&&(t.shopkeeper=e),t}}t.ElementShop=v,t.Element.Shop=v;class _ extends(i.Locatable(d)){constructor(){super("exploration"),this.exp=0}setData(e){this.data=e}addData(e,t){this.data[e]=t}getData(){return this.data}hasData(){return!!this.data}setExp(e){Number.isInteger(e)?this.exp=e:a.default.err("ElementExploration","setExp",`exp is not an integer: ${e}`)}getExp(){return this.exp}toJSON(){const e={type:this.getType(),setExp:this.getExp()};return this.hasData()&&(e.data=this.data),e}}t.ElementExploration=_,t.Element.Exploration=_;class b extends(i.Locatable(d)){constructor(e){super(e)}onSystemAdd(e){e.getSentientActors().forEach(e=>{e.add(new l.Entrapped)})}onSystemRemove(e){e.getSentientActors().forEach(e=>{e.remove("Entrapped")})}}t.ElementTrap=b;class E extends b{constructor(){super("web");const e=new l.Entrapping;e.setDestroyOnMove(!0),e.setDifficulty(20),this.add(e)}setDifficulty(e){this.get("Entrapping").setDifficulty(e)}}t.ElementWeb=E,t.Element.Web=E;class S extends b{constructor(){super("slime");const e=new l.Entrapping;e.setDestroyOnMove(!0),e.setDifficulty(30),this.add(e)}setDifficulty(e){this.get("Entrapping").setDifficulty(e)}}t.ElementSlime=S,t.Element.Slime=S;class C extends b{constructor(){super("hole");const e=new l.Entrapping;e.setDestroyOnMove(!1),e.setDifficulty(50),this.add(e)}setDifficulty(e){this.get("Entrapping").setDifficulty(e)}}t.ElementHole=C,t.Element.Hole=C;class w extends(i.Locatable(d)){constructor(){super("placeholder")}}t.ElementPlaceholder=w,t.Element.PlaceHolder=w;class T extends(i.Locatable(d)){constructor(e){super("marker"),this.char=e,this.tag="",this.className=!1}getClassName(){return this.className}setClassName(e){this.className=e}getChar(){return this.char}setChar(e){this.char=e}setTag(e){this.tag=e}getTag(){return this.tag}toJSON(){const e=super.toJSON();return e.char=this.char,e.tag=this.tag,e}}t.ElementMarker=T,t.Element.Marker=T,t.create=function(e,...n){e.capitalize();return t.Element.hasOwnProperty(e)?new t.Element[e](...n):null},t.Element.create=t.create},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=r(n(11)),i=n(18),l=n(9),c=n(17)("bitn:System"),u=i.EventPool.getPool();t.SystemBase=class{static addSkillsExp(e,t,n=1){if(e.has("Skills")){const s=new o.SkillsExp;s.setSkill(t),s.setPoints(n),e.add(s)}}static addCompToEntAfterHit(e,t,n){const s=e.clone();if(s.hasOwnProperty("duration")){const e=s.rollDuration(),n=new o.Expiration;n.addEffect(s,e),t.add(n)}if(s.getSource){const e=s.getSource();a.default.isNullOrUndef([e])&&s.setSource(n)}t.add(s)}constructor(e,t,n){Array.isArray(t)||a.default.err("System.Base","new","2nd arg must be an array of component types"),this.type=e,this.compTypes=t,this.entities={},this.compTypesAny=!1,this.hasNotify=!0;for(let e=0;e<this.compTypes.length;e++)o.hasOwnProperty(this.compTypes[e])||a.default.err("System.Base","new",`Comp type |${this.compTypes[e]}| not in Component`),n?n.listenEvent(this.compTypes[e],this):u.listenEvent(this.compTypes[e],this);this.debugEnabled=c.enabled,this.rng=l.Random.getRNG()}setRNG(e){this.rng=e}addEntity(e){this.entities[e.getID()]=e}removeEntity(e){delete this.entities[e.getID()]}notify(e,t){t.hasOwnProperty("add")?this.hasCompTypes(t.entity)&&this.addEntity(t.entity):t.hasOwnProperty("remove")&&(this.hasCompTypes(t.entity)||this.removeEntity(t.entity))}hasCompTypes(e){const t=this.compTypes;return!1===this.compTypesAny?e.hasAll(t):e.hasAny(t)}hasEntities(){return Object.keys(this.entities).length>0}update(){for(const e in this.entities)e&&this.updateEntity(this.entities[e])}updateEntity(e){a.default.err("SystemBase","updateEntity","Not implemented in the base class")}dbg(e){if(this.debugEnabled){const t=Object.keys(this.entities).length;let n=`[System ${this.type.toString()}]`;n+=` nEntities: ${t}`,c.enabled?c(`${n} ${e}`):console.log(`${n} ${e}`)}}}},function(e,t,n){(function(s){function r(){var e;try{e=t.storage.debug}catch(e){}return!e&&void 0!==s&&"env"in s&&(e=s.env.DEBUG),e}(t=e.exports=n(298)).log=function(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(e){var n=this.useColors;if(e[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+e[0]+(n?"%c ":" ")+"+"+t.humanize(this.diff),!n)return;var s="color: "+this.color;e.splice(1,0,s,"color: inherit");var r=0,a=0;e[0].replace(/%[a-zA-Z%]/g,function(e){"%%"!==e&&(r++,"%c"===e&&(a=r))}),e.splice(a,0,s)},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=r,t.useColors=function(){if("undefined"!=typeof window&&window.process&&"renderer"===window.process.type)return!0;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],t.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},t.enable(r())}).call(this,n(182))},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8));class a{constructor(){this.reset()}static getPool(){return a.poolInstance||(a.poolInstance=new a),a.poolInstance}getNumListeners(){return this._nListeners}getNumEventsListened(){return Object.keys(this._listeners).length}emitEvent(e,t){if(r.default.isNullOrUndef([e]))r.default.nullOrUndefError("EventPool: emitEvent","Event name must be given.",e);else if(++this.notifyStackSize,this._listeners.hasOwnProperty(e)){this.cannotRemove=!0;const n=this._listeners[e];for(let s=0,r=n.length;s<r;s++)n[s].notify(e,t)}1===this.notifyStackSize&&(this.cannotRemove=!1,this.pendingRemoves.length>0&&(this.pendingRemoves.forEach(e=>{this.removeListener(e)}),this.pendingRemoves=[])),--this.notifyStackSize}listenEvent(e,t){if(r.default.isNullOrUndef([e]))r.default.err("EventPool","listenEvent","Event name not well defined.");else if(t.hasOwnProperty("notify")||t.hasNotify){if(this._listeners.hasOwnProperty(e)){-1===this._listeners[e].indexOf(t)&&this._listeners[e].push(t)}else this._listeners[e]=[],this._listeners[e].push(t);++this._nListeners,t.hasOwnProperty("listenerID")||(t.listenerID=this._listenerID++)}else{let n="evtName: "+e;n+="\nprototype: "+JSON.stringify(t),n+="\nCannot add object. Listener must implement notify()!",r.default.err("EventPool","listenEvent",n)}}isListener(e){let t=!1;return this.forEachEvent(e,e=>{t=!0}),t}forEachEvent(e,t){const n=e.listenerID;Object.keys(this._listeners).forEach(s=>{this._listeners[s].findIndex(e=>e.listenerID===n)>=0&&t(e,s)})}removeListener(e){if(e.hasOwnProperty("listenerID")){if(this.cannotRemove)return void this.pendingRemoves.push(e);let t=0;const n=e.listenerID;Object.keys(this._listeners).forEach(e=>{const s=this._listeners[e].findIndex(e=>e.listenerID===n);s>=0&&(this._listeners[e].splice(s,1),++t,--this._nListeners,0===this._listeners[e].length&&delete this._listeners[e])}),0===t&&r.default.warn("EventPool","removeListener",`ListenerID ${e.listenerID} not found`),delete e.listenerID}else{const t=JSON.stringify(e);r.default.err("EventPool","removeListener",`No prop listener ID from on object ${t}`)}}removeAll(){if(this.cannotRemove)r.default.err("EventPool","removeAll","Cannot remove listeners. cannotRemove is set");else{const e={};Object.keys(this._listeners).forEach(t=>{this._listeners[t].forEach(t=>{e[t.listenerID]=t})}),Object.values(e).forEach(e=>{this.removeListener(e)})}}reset(){this._listeners={},this._nListeners=0,this._listenerID=0,this._lastEmitted=null,this._lastRemoved=null,this.pendingRemoves=[],this.notifyStackSize=0}getListeners(e){return this._listeners.hasOwnProperty(e)?this._listeners[e].slice():[]}printListeners(){Object.keys(this._listeners).forEach(e=>{r.default.diag(`Listeners for event ${String(e)}`),r.default.diag(this._listeners[e])})}}a.id=0,t.EventPool=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(14),r=n(15);t.ELEM={};const a=Object.freeze,o=s.ObjectShell.getParser();t.ELEM.BED=a(o.createElement("bed")),t.ELEM.BRIDGE=a(o.createElement("bridge")),t.ELEM.CHASM=a(o.createElement("chasm")),t.ELEM.GRASS=a(o.createElement("grass")),t.ELEM.GRASS_SNOW=a(o.createElement("snowy grass")),t.ELEM.HIGH_ROCK=a(o.createElement("highrock")),t.ELEM.LAVA=a(o.createElement("lava")),t.ELEM.PATH=a(o.createElement("path")),t.ELEM.ROAD=a(o.createElement("road")),t.ELEM.SKY=a(o.createElement("sky")),t.ELEM.SNOW=a(o.createElement("snow")),t.ELEM.SNOW_TRACKS=a(o.createElement("snow with tracks")),t.ELEM.SNOW_DEEP=a(o.createElement("deep snow")),t.ELEM.SNOW_DEEP_TRACKS=a(o.createElement("deep snow with tracks")),t.ELEM.SNOW_LIGHT=a(o.createElement("light snow")),t.ELEM.SNOW_LIGHT_TRACKS=a(o.createElement("light snow with tracks")),t.ELEM.STONE=a(o.createElement("stone")),t.ELEM.TREE=a(o.createElement("tree")),t.ELEM.TREE_SNOW=a(o.createElement("snow-covered tree")),t.ELEM.WINDOW=a(o.createElement("closed window")),t.ELEM.FLOOR=a(o.createElement("floor")),t.ELEM.FLOOR_CASTLE=a(o.createElement("floorcastle")),t.ELEM.FLOOR_CAVE=a(o.createElement("floorcave")),t.ELEM.FLOOR_CRYPT=a(o.createElement("floorcrypt")),t.ELEM.FLOOR_HOUSE=a(o.createElement("floorhouse")),t.ELEM.FLOOR_WOODEN=a(o.createElement("floorwooden")),t.ELEM.WALL=a(new r.ElementWall("wall")),t.ELEM.WALL_CASTLE=a(new r.ElementWall("wallcastle")),t.ELEM.WALL_CAVE=a(new r.ElementWall("wallcave")),t.ELEM.WALL_CRYPT=a(new r.ElementWall("wallcrypt")),t.ELEM.WALL_ICE=a(new r.ElementWall("wallice")),t.ELEM.WALL_WOODEN=a(new r.ElementWall("wallwooden")),t.ELEM.WALL_MOUNT=a(new r.ElementWall("wallmount")),t.ELEM.WATER=a(o.createElement("water")),t.ELEM.WATER_FROZEN=a(o.createElement("frozen water")),t.ELEM.FORT=a(o.createElement("fort")),t.ELEM_MAP={},t.ELEM_MAP.elemTypeToObj={},t.ELEM_MAP.elemTypeToIndex={},t.ELEM_MAP.elemIndexToType={},t.ELEM_MAP.elemIndexToElemObj={};let i=1;Object.keys(t.ELEM).forEach(e=>{const n=t.ELEM[e].getType();t.ELEM_MAP.elemTypeToObj[n]=t.ELEM[e],t.ELEM_MAP.elemTypeToIndex[n]=i,t.ELEM_MAP.elemIndexToType[i]=n,t.ELEM_MAP.elemIndexToElemObj[i]=t.ELEM[e],++i})},function(e,t,n){"use strict";function s(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}var r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0}),s(n(105)),s(n(65));const a=n(65);t.Brain=a.Brain,s(n(124)),s(n(123));const o=n(127);s(n(127));const i=n(85);s(n(85));const l=r(n(186));s(n(186)),a.Brain.Animal=l.BrainAnimal,a.Brain.Commander=l.BrainCommander,a.Brain.Explorer=l.BrainExplorer,a.Brain.GoalOriented=l.BrainGoalOriented,a.Brain.SpellCaster=l.BrainSpellCaster,a.Brain.Spirit=l.BrainSpirit,a.Brain.Thief=l.BrainThief,a.Brain.Flame=l.BrainFlame,a.Brain.Cloud=l.BrainCloud,a.Brain.Virtual=i.BrainVirtual,a.Brain.Weather=o.BrainWeather},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(23));t.Path={};const a=Object.freeze([]);function o(e,t,n,s){for(let r=e-1;r<=e+1;r++)for(let e=t-1;e<=t+1;e++)if(n.hasXY(r,e)&&s(r,e))return!1;return!0}function i(e){e.length>1&&(e.shift(),e.pop())}t.Path.getShortestPath=function(e,t,n,s,a=((e,t)=>!0)){const o=[],i=a;return new r.default.Path.AStar(n,s,i).compute(e,t,(e,t)=>{o.push({x:e,y:t})}),o},t.Path.getShortestSeenPath=function(e,t,n,s){const l=e.getBrain().getSeenCells(),c={};l.forEach(e=>{c[e.getKeyXY()]=e});const u=(e,r)=>!!c.hasOwnProperty(e+","+r)&&(t.isPassable(e,r)||e===h&&r===d||e===n&&r===s),[h,d]=e.getXY();if(o(h,d,t,u))return a;const p=[];return new r.default.Path.AStar(n,s,u).compute(h,d,(e,t)=>{p.push({x:e,y:t})}),i(p),p},t.Path.getShortestPassablePath=function(e,t,n,s,a){const o=[];return new r.default.Path.AStar(s,a,(t,n)=>e.isPassable(t,n)).compute(t,n,(e,t)=>{o.push({x:e,y:t})}),o},t.Path.getActorToActorPath=function(e,t,n,s,l){const c=[],u=(r,a)=>!!e.hasXY(r,a)&&(e.isPassable(r,a)||r===t&&a===n||r===s&&a===l);return o(t,n,e,u)?a:(new r.default.Path.AStar(s,l,u).compute(t,n,(e,t)=>{c.push({x:e,y:t})}),i(c),c)},t.Path.getShortestActorPath=function(e,t,n,s,i,l){const c=[],u=(s,r)=>!!e.hasXY(s,r)&&(l?l(s,r)||s===t&&r===n:e.isPassable(s,r)||s===t&&r===n);return o(t,n,e,u)?a:(new r.default.Path.AStar(s,i,u).compute(t,n,(e,t)=>{c.push({x:e,y:t})}),function(e){e.length>0&&e.shift()}(c),c)},t.Path.getShortestPassablePathWithDoors=function(e,t,n,s,a){const o=[];return new r.default.Path.AStar(s,a,(t,n)=>!!e.hasXY(t,n)&&(e.isPassable(t,n)||e.getCell(t,n).hasDoor())).compute(t,n,(e,t)=>{o.push({x:e,y:t})}),o},t.Path.shortestDist=function(e,n,s,r){return t.Path.getShortestPath(e,n,s,r).length-1},t.Path.getPathWeight=((e,t)=>{let n=0;return t.forEach(t=>{if(e.hasXY(t.x,t.y)){switch(e.getBaseElemXY(t.x,t.y).getType()){case"floor":n+=1;break;case"forest":case"stone":n+=2;break;case"water":case"highrock":n+=4;break;case"chasm":n+=5;break;case"wall":n+=20;break;default:n+=0}}}),n}),t.Path.getMinWeightPath=function(e,n,s,r,a,o){let i=[];i=o?o(e,n,s,r,a):t.Path.getShortestPassablePath(e,n,s,r,a);const l=t.Path.getShortestPath(n,s,r,a),c=t.Path.getPathWeight(e,i),u=t.Path.getPathWeight(e,l);let h=null;return h=0===i.length?l:c>=u?l:i},t.Path.getMinWeightOrShortest=function(e,n,s,r,a,o){const i=t.Path.getShortestPath(n,s,r,a),l=[];o.forEach(e=>{const o=t.Path.getShortestPath(n,s,r,a,e);o.length>0&&l.push(o)}),l.push(i);let c=null,u=-1;return l.forEach(n=>{const s=t.Path.getPathWeight(e,n);(-1===u||s<u)&&(u=s,c=n)}),c},t.Path.getWeightPathSegmented=function(e,n,s,r,a,o,i){const l=r-n,c=a-s,u=t.Path.getPathSeg(l,o),h=t.Path.getPathSeg(c,o);let d=[],[p,f]=[n,s];for(let n=0;n<o;n++){const[s,r]=[p+u[n],f+h[n]],a=t.Path.getMinWeightPath(e,p,f,s,r,i);[p,f]=[s,r],d=d.concat(a)}return d},t.Path.getPathSeg=function(e,t){let n=e;const s=[],r=Math.floor(e/t);for(let e=0;e<t-1;e++)s.push(r),n-=r;return s.push(n),s}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(52),i=n(25),l=n(40),c=n(9),u=n(18),h=n(19),d=r(n(25)),p=u.EventPool.getPool(),{TYPE_ACTOR:f,TYPE_ELEM:m,TYPE_ITEM:g}=a.default,y=c.Random.getRNG();t.LevelCallback=class{constructor(e){this.cbType=e}execute(){a.default.gameMsg(this.msg)}getCbType(){return this.cbType}toJSON(){return{cbType:this.getCbType(),msg:this.msg}}};t.Level=class extends o.Entity{static createLevelID(){return o.Entity.createEntityID()}constructor(){super(),this._map=null,this._parent=null,this._p={actors:[],elements:[],items:[]},this._levelNo=0,this._callbacks={},this._cbState={onFirstEnterDone:!1,onFirstExitDone:!1},this.add(new d.Lore)}setLevelNumber(e){this._levelNo=e}getLevelNumber(){return this._levelNo}getParent(){return this._parent}getParentZone(){const e=this.getParent();if(e){if(e.getParent)return e.getParent();a.default.err("Level","getParentZone",`No getParent() in ${JSON.stringify(e)}`)}return null}setParent(e){a.default.isNullOrUndef([e])?a.default.err("Map.Level","setParent","Parent is not defined."):this._parent=e}getActors(){return this._p.actors}getItems(){return this._p.items}getElements(){return this._p.elements}getStairs(){const e=[];return this._p.elements.forEach(t=>{this._isStairs(t)&&e.push(t)}),e}getPassages(){const e=[];return this._p.elements.forEach(t=>{if("passage"===t.getName()){const n=t;e.push(n)}}),e}getConnections(){const e=[];return this._p.elements.forEach(t=>{if("connection"===t.getType()){const n=t;e.push(n)}}),e}_isStairs(e){return/stairs(Down|Up)/.test(e.getName())}setMap(e,t){this._map=e,t&&(t.elements&&(this._p.elements=t.elements),this._p.elements.forEach(e=>{e.setLevel(this)}))}getMap(){return this._map}getStairsToLevel(e){a.default.isNullOrUndef([e])&&a.default.err("Map.Level","getStairs","arg |level| required.");const t=this.getStairs();for(let n=0;n<t.length;n++)if(t[n].getTargetLevel()===e)return t[n];return null}addStairs(e,t,n){if(a.default.isNullOrUndef([t,n]))a.default.err("Map.Level","addStairs","Cannot add stairs. x, y missing.");else{if(this._map.hasXY(t,n))return e.setSrcLevel(this),this._map.setBaseElemXY(t,n,h.ELEM.FLOOR),this._addPropToLevelXY(a.default.TYPE_ELEM,e,t,n);{const e=`x,y ${t},${n} out of map bounds.`;a.default.err("Map.Level","addStairs",`${e}: cols ${this._map.cols}, rows: ${this._map.rows}`)}}return!1}useStairs(e){const t=this._map.getCell(e.getX(),e.getY());if(t.hasConnection()){if(t.getConnection().useStairs(e))return!0;a.default.err("Level","useStairs","Failed to use connection.")}return!1}addElement(e,t,n){if("connection"===e.getType())return this.addStairs(e,t,n);if(!a.default.isNullOrUndef([t,n]))return this._addPropToLevelXY(a.default.TYPE_ELEM,e,t,n);const[s,r]=this._getFreeCellXY();return a.default.isNullOrUndef([s,r])&&(this.debugPrintInASCII(),a.default.err("Level","addElement","Cannot add prop to null xy-coord")),this._addPropToLevelXY(a.default.TYPE_ELEM,e,s,r)}removeElement(e,t,n){return this._removePropFromLevelXY(a.default.TYPE_ELEM,e,t,n)}addEntity(e,t,n){return a.default.isActor(e)?this.addActor(e,t,n):a.default.isItem(e)?this.addItem(e,t,n):a.default.isElement(e)?this.addElement(e,t,n):(a.default.err("Level","addEntity","No support for ents without getPropType"),!1)}addItem(e,t,n){if(!a.default.isNullOrUndef([t,n]))return this._addPropToLevelXY(a.default.TYPE_ITEM,e,t,n);const[s,r]=this._getFreeCellXY();return this._addPropToLevelXY(a.default.TYPE_ITEM,e,s,r)}removeItem(e,t,n){return this._removePropFromLevelXY(a.default.TYPE_ITEM,e,t,n)}pickupItem(e){const t=new i.Pickup;e.add(t)}moveActorTo(e,t,n){const s=e.getLevel(),[r,a]=[e.getX(),e.getY()],o=e.getPropType();return!!s._removePropFromLevelXY(o,e,r,a)&&this._addPropToLevelXY(o,e,t,n)}addActor(e,t,n){return a.default.debug(this,"addActor called with x,y "+t+", "+n),a.default.isNullOrUndef([t,n])?(a.default.nullOrUndefError("Level: addActor","arg |x|",t),a.default.nullOrUndefError("Level: addActor","arg |y|",n),!1):this._map.hasXY(t,n)?(this._addPropToLevelXY(a.default.TYPE_ACTOR,e,t,n),a.default.debug(this,"Added actor to map x: "+t+" y: "+n),!0):(a.default.err("Level","addActor","No coordinates "+t+", "+n+" in the map."),!1)}addActorToFreeCell(e){a.default.debug(this,"Adding actor to free slot");const t=this._map.getFree();if(t.length>0){const n=t[0].getX(),s=t[0].getY();if(this._addPropToLevelXY(a.default.TYPE_ACTOR,e,n,s))return a.default.debug(this,"Added actor to free cell in "+n+", "+s),!0}else a.default.err("Level","addActor","No free cells for the actor.");return!1}_addPropToLevelXY(e,t,n,s){return this._p.hasOwnProperty(e)?(this._p[e].push(t),t.isOwnable||(t.setXY(n,s),t.setLevel(this)),this._map.setProp(n,s,e,t),p.emitEvent(a.default.EVT_LEVEL_PROP_ADDED,{level:this,obj:t,propType:e}),!0):(a.default.err("Map.Level","_addPropToLevelXY",`No prop ${e} supported. Obj: ${JSON.stringify(t)}`),!1)}addVirtualProp(e,t){return this._p.hasOwnProperty(e)?(this._p[e].push(t),t.setLevel(this),p.emitEvent(a.default.EVT_LEVEL_PROP_ADDED,{level:this,obj:t,propType:e}),!0):(a.default.err("Map.Level","addVirtualProp",`No prop ${e} supported. Obj: ${JSON.stringify(t)}`),!1)}_removePropFromLevelXY(e,t,n,s){if(this._p.hasOwnProperty(e)){const r=this._p[e].indexOf(t);return r>=0?(this._p[e].splice(r,1),t.getOwner||(t.setXY(null,null),t.unsetLevel()),p.emitEvent(a.default.EVT_LEVEL_PROP_REMOVED,{level:this,obj:t,propType:e}),this._map.removeProp(n,s,e,t)):(a.default.err("Map.Level","_removePropFromLevelXY",`Obj index not found in list this._p[${e}]`),!1)}return a.default.err("Map.Level","_removePropFromLevelXY",`No prop ${e} supported. Obj: ${JSON.stringify(t)}`),!1}removeVirtualProp(e,t){if(this._p.hasOwnProperty(e)){const n=this._p[e].indexOf(t);if(n>=0)return this._p[e].splice(n,1),p.emitEvent(a.default.EVT_LEVEL_PROP_REMOVED,{level:this,obj:t,propType:e}),!0}return!1}removeActor(e){const t=this._p.actors.indexOf(e),n=e.getX(),s=e.getY();return!!this._map.removeProp(n,s,a.default.TYPE_ACTOR,e)&&(this._p.actors.splice(t,1),!0)}exploreCells(e){const t=this._map.getVisibleCells(e);for(let e=0;e<t.length;e++)t[e].setExplored();return t}getExploredCells(){return this._map.getExploredCells()}setExtras(e){this._extras=e}getExtras(){return this._extras||(this._extras={}),this._extras}hasExtras(){return!a.default.isNullOrUndef([this._extras])&&Object.keys(this._extras).length>0}addExtras(e,t){this._extras||(this._extras={}),this._extras[e]=t}getBbox(){return{ulx:0,uly:0,lrx:this.getMap().cols-1,lry:this.getMap().rows-1}}getColsRows(){return[this.getMap().cols,this.getMap().rows]}setOnEnter(e){this._callbacks.OnEnter=e}setOnFirstEnter(e){this._callbacks.OnFirstEnter=e}setOnExit(e){this._callbacks.OnExit=e}setOnFirstExit(e){this._callbacks.OnFirstExit=e}onEnter(){this._callbacks.hasOwnProperty("OnEnter")&&this._callbacks.OnEnter(this)}onFirstEnter(){this._cbState.onFirstEnterDone||(this._callbacks.hasOwnProperty("OnFirstEnter")&&this._callbacks.OnFirstEnter(this),this._cbState.onFirstEnterDone=!0)}onExit(){this._callbacks.hasOwnProperty("OnExit")&&this._callbacks.OnExit(this)}onFirstExit(){this._cbState.onFirstExitDone||(this._callbacks.hasOwnProperty("OnFirstExit")&&this._callbacks.OnFirstExit(this),this._cbState.onFirstExitDone=!0)}getFreeRandCell(){const e=this.getMap().getFree();return e.length>0?e[y.randIndex(e)]:null}getEmptyRandCell(){const e=this.getMap().getEmptyCells();return e.length>0?e[y.randIndex(e)]:null}_getFreeCellXY(){const e=this._map.getFree();return e.length>0?[e[0].getX(),e[0].getY()]:[null,null]}debugPrintInASCII(){this.getMap().debugPrintInASCII()}removeElements(e){this._p.elements.filter(e).forEach(e=>{const t=e.getX(),n=e.getY();this.removeElement(e,t,n)})}getCell(e,t){return this._map.getCell(e,t)}getPlayer(){return this._p.actors.find(e=>e.isPlayer&&e.isPlayer())}toJSON(){const e={isJSON:!0,id:this.getID(),levelNumber:this.getLevelNumber(),actors:[],items:[],elements:[],map:this.getMap().toJSON(),cbState:this._cbState};return this._parent&&(e.parent=this._parent.getName(),"string"!=typeof e.parent&&a.default.err("Map.Level","toJSON","Parent name not a string")),e.components=l.compsToJSON(this),[f,g,m].forEach(t=>{this._p[t].forEach(n=>{const s={x:n.getX(),y:n.getY(),obj:n.toJSON()};!t===a.default.TYPE_ACTOR?e[t].push(s):s.obj.isPlayer||e[t].push(s)})}),e}}},function(e,t,n){"use strict";n.r(t);var s={isSupported:function(){return!(!document.createElement("canvas").getContext||!Function.prototype.bind)},DEFAULT_WIDTH:80,DEFAULT_HEIGHT:25,DIRS:{4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95};s.Text={RE_COLORS:/%([bc]){([^}]*)}/g,TYPE_TEXT:0,TYPE_NEWLINE:1,TYPE_FG:2,TYPE_BG:3,measure:function(e,t){var n={width:0,height:1},s=this.tokenize(e,t),r=0;for(let e=0;e<s.length;e++){const t=s[e];switch(t.type){case this.TYPE_TEXT:r+=t.value.length;break;case this.TYPE_NEWLINE:n.height++,n.width=Math.max(n.width,r),r=0}}return n.width=Math.max(n.width,r),n},tokenize:function(e,t){var n=[],r=0;e.replace(this.RE_COLORS,function(t,a,o,i){var l=e.substring(r,i);return l.length&&n.push({type:s.Text.TYPE_TEXT,value:l}),n.push({type:"c"===a?s.Text.TYPE_FG:s.Text.TYPE_BG,value:o.trim()}),r=i+t.length,""});var a=e.substring(r);return a.length&&n.push({type:s.Text.TYPE_TEXT,value:a}),this._breakLines(n,t)},_breakLines:function(e,t){t||(t=1/0);for(var n=0,r=0,a=-1;n<e.length;){if((h=e[n]).type===s.Text.TYPE_NEWLINE&&(r=0,a=-1),h.type==s.Text.TYPE_TEXT){for(;0===r&&" "===h.value.charAt(0);)h.value=h.value.substring(1);var o=h.value.indexOf("\n");if(-1!=o){h.value=this._breakInsideToken(e,n,o,!0);for(var i=h.value.split("");i.length&&" "===i[i.length-1];)i.pop();h.value=i.join("")}if(h.value.length){if(r+h.value.length>t){for(o=-1;;){var l=h.value.indexOf(" ",o+1);if(-1===l)break;if(r+l>t)break;o=l}if(-1!=o)h.value=this._breakInsideToken(e,n,o,!0);else if(-1!=a){var c=(h=e[a]).value.lastIndexOf(" ");h.value=this._breakInsideToken(e,a,c,!0),n=a}else h.value=this._breakInsideToken(e,n,t-r,!1)}else r+=h.value.length,-1!=h.value.indexOf(" ")&&(a=n);n++}else e.splice(n,1)}else n++}e.push({type:s.Text.TYPE_NEWLINE});var u=null;for(n=0;n<e.length;n++){var h;switch((h=e[n]).type){case s.Text.TYPE_TEXT:u=h;break;case s.Text.TYPE_NEWLINE:if(u){for(i=u.value.split("");i.length&&" "===i[i.length-1];)i.pop();u.value=i.join("")}u=null}}return e.pop(),e},_breakInsideToken:function(e,t,n,r){var a={type:s.Text.TYPE_NEWLINE},o={type:s.Text.TYPE_TEXT,value:e[t].value.substring(n+(r?1:0))};return e.splice(t+1,0,a,o),e[t].value.substring(0,n)}},Array.prototype.random=Array.prototype.random||function(){return this.length?this[Math.floor(s.RNG.getUniform()*this.length)]:null},Array.prototype.randomize=Array.prototype.randomize||function(){for(var e=[];this.length;){var t=this.indexOf(this.random());e.push(this.splice(t,1)[0])}return e},Number.prototype.mod=Number.prototype.mod||function(e){return(this%e+e)%e},String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)},String.prototype.lpad=String.prototype.lpad||function(e,t){for(var n=e||"0",s=t||2,r="";r.length<s-this.length;)r+=n;return(r=r.substring(0,s-this.length))+this},String.prototype.rpad=String.prototype.rpad||function(e,t){for(var n=e||"0",s=t||2,r="";r.length<s-this.length;)r+=n;return this+(r=r.substring(0,s-this.length))},String.format=String.format||function(e){var t=String.format.map,n=Array.prototype.slice.call(arguments,1);return e.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,function(s,r,a,o){if("%"===e.charAt(o-1))return s.substring(1);if(!n.length)return s;var i=n[0],l=(r||a).split(","),c=l.shift(),u=t[c.toLowerCase()];if(!u)return s;var h=(i=n.shift())[u].apply(i,l),d=c.charAt(0);return d!=d.toLowerCase()&&(h=h.capitalize()),h})},String.format.map=String.format.map||{s:"toString"},String.prototype.format=String.prototype.format||function(){var e=Array.prototype.slice.call(arguments);return e.unshift(this),String.format.apply(String,e)},Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t}),Function.prototype.extend=Function.prototype.extend||function(e){return this.prototype=Object.create(e.prototype),this.prototype.constructor=this,this},"undefined"!=typeof window&&(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return setTimeout(e,1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(e){return clearTimeout(e)}),s.Display=function(e){var t=document.createElement("canvas");this._context=t.getContext("2d"),this._data={},this._dirty=!1,this._options={},this._backend=null;var n={width:s.DEFAULT_WIDTH,height:s.DEFAULT_HEIGHT,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1,termColor:"xterm"};for(var r in e)n[r]=e[r];this.setOptions(n),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),requestAnimationFrame(this._tick)},s.Display.prototype.DEBUG=function(e,t,n){var s=[this._options.bg,this._options.fg];this.draw(e,t,null,null,s[n%s.length])},s.Display.prototype.clear=function(){this._data={},this._dirty=!0},s.Display.prototype.setOptions=function(e){for(var t in e)this._options[t]=e[t];if(e.width||e.height||e.fontSize||e.fontFamily||e.spacing||e.layout){e.layout&&(this._backend=new(s.Display[e.layout.capitalize()])(this._context));var n=(this._options.fontStyle?this._options.fontStyle+" ":"")+this._options.fontSize+"px "+this._options.fontFamily;this._context.font=n,this._backend.compute(this._options),this._context.font=n,this._context.textAlign="center",this._context.textBaseline="middle",this._dirty=!0}return this},s.Display.prototype.getOptions=function(){return this._options},s.Display.prototype.getContainer=function(){return this._context.canvas},s.Display.prototype.computeSize=function(e,t){return this._backend.computeSize(e,t,this._options)},s.Display.prototype.computeFontSize=function(e,t){return this._backend.computeFontSize(e,t,this._options)},s.Display.prototype.eventToPosition=function(e){var t,n;e.touches?(t=e.touches[0].clientX,n=e.touches[0].clientY):(t=e.clientX,n=e.clientY);var s=this._context.canvas.getBoundingClientRect();return t-=s.left,n-=s.top,t*=this._context.canvas.width/this._context.canvas.clientWidth,n*=this._context.canvas.height/this._context.canvas.clientHeight,t<0||n<0||t>=this._context.canvas.width||n>=this._context.canvas.height?[-1,-1]:this._backend.eventToPosition(t,n)},s.Display.prototype.draw=function(e,t,n,s,r){s||(s=this._options.fg),r||(r=this._options.bg),this._data[e+","+t]=[e,t,n,s,r],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[e+","+t]=!0)},s.Display.prototype.drawText=function(e,t,n,r){var a=null,o=null,i=e,l=t,c=1;r||(r=this._options.width-e);for(var u=s.Text.tokenize(n,r);u.length;){var h=u.shift();switch(h.type){case s.Text.TYPE_TEXT:var d=!1,p=!1,f=!1,m=!1;for(let e=0;e<h.value.length;e++){var g=h.value.charCodeAt(e),y=h.value.charAt(e);f=g>255&&g<65377||g>65500&&g<65512&&g>65518,d=32===y.charCodeAt(0)||12288===y.charCodeAt(0),!m||f||d||i++,f&&!p&&i++,this.draw(i++,l,y,a,o),p=d,m=f}break;case s.Text.TYPE_FG:a=h.value||null;break;case s.Text.TYPE_BG:o=h.value||null;break;case s.Text.TYPE_NEWLINE:i=e,l++,c++}}return c},s.Display.prototype._tick=function(){if(requestAnimationFrame(this._tick),this._dirty){if(!0===this._dirty)for(var e in this._context.fillStyle=this._options.bg,this._context.fillRect(0,0,this._context.canvas.width,this._context.canvas.height),this._data)this._draw(e,!1);else for(var t in this._dirty)this._draw(t,!0);this._dirty=!1}},s.Display.prototype._draw=function(e,t){var n=this._data[e];n[4]!=this._options.bg&&(t=!0),this._backend.draw(n,t)},s.Display.Backend=function(e){this._context=e},s.Display.Backend.prototype.compute=function(e){},s.Display.Backend.prototype.draw=function(e,t){},s.Display.Backend.prototype.computeSize=function(e,t){},s.Display.Backend.prototype.computeFontSize=function(e,t){},s.Display.Backend.prototype.eventToPosition=function(e,t){},s.Display.Rect=function(e){s.Display.Backend.call(this,e),this._spacingX=0,this._spacingY=0,this._canvasCache={},this._options={}},s.Display.Rect.extend(s.Display.Backend),s.Display.Rect.cache=!1,s.Display.Rect.prototype.compute=function(e){this._canvasCache={},this._options=e;var t=Math.ceil(this._context.measureText("W").width);this._spacingX=Math.ceil(e.spacing*t),this._spacingY=Math.ceil(e.spacing*e.fontSize),this._options.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._context.canvas.width=e.width*this._spacingX,this._context.canvas.height=e.height*this._spacingY},s.Display.Rect.prototype.draw=function(e,t){this.constructor.cache?this._drawWithCache(e,t):this._drawNoCache(e,t)},s.Display.Rect.prototype._drawWithCache=function(e,t){var n,s=e[0],r=e[1],a=e[2],o=e[3],i=e[4],l=""+a+o+i;if(l in this._canvasCache)n=this._canvasCache[l];else{var c=this._options.border,u=(n=document.createElement("canvas")).getContext("2d");if(n.width=this._spacingX,n.height=this._spacingY,u.fillStyle=i,u.fillRect(c,c,n.width-c,n.height-c),a){u.fillStyle=o,u.font=this._context.font,u.textAlign="center",u.textBaseline="middle";var h=[].concat(a);for(let e=0;e<h.length;e++)u.fillText(h[e],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[l]=n}this._context.drawImage(n,s*this._spacingX,r*this._spacingY)},s.Display.Rect.prototype._drawNoCache=function(e,t){var n=e[0],s=e[1],r=e[2],a=e[3],o=e[4];if(t){var i=this._options.border;this._context.fillStyle=o,this._context.fillRect(n*this._spacingX+i,s*this._spacingY+i,this._spacingX-i,this._spacingY-i)}if(r){this._context.fillStyle=a;var l=[].concat(r);for(let e=0;e<l.length;e++)this._context.fillText(l[e],(n+.5)*this._spacingX,Math.ceil((s+.5)*this._spacingY))}},s.Display.Rect.prototype.computeSize=function(e,t){return[Math.floor(e/this._spacingX),Math.floor(t/this._spacingY)]},s.Display.Rect.prototype.computeFontSize=function(e,t){var n=Math.floor(e/this._options.width),s=Math.floor(t/this._options.height),r=this._context.font;this._context.font="100px "+this._options.fontFamily;var a=Math.ceil(this._context.measureText("W").width);this._context.font=r;var o=a/100*s/n;return o>1&&(s=Math.floor(s/o)),Math.floor(s/this._options.spacing)},s.Display.Rect.prototype.eventToPosition=function(e,t){return[Math.floor(e/this._spacingX),Math.floor(t/this._spacingY)]},s.Display.Hex=function(e){s.Display.Backend.call(this,e),this._spacingX=0,this._spacingY=0,this._hexSize=0,this._options={}},s.Display.Hex.extend(s.Display.Backend),s.Display.Hex.prototype.compute=function(e){this._options=e;var t,n,s=Math.ceil(this._context.measureText("W").width);this._hexSize=Math.floor(e.spacing*(e.fontSize+s/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,e.transpose?(t="height",n="width"):(t="width",n="height"),this._context.canvas[t]=Math.ceil((e.width+1)*this._spacingX),this._context.canvas[n]=Math.ceil((e.height-1)*this._spacingY+2*this._hexSize)},s.Display.Hex.prototype.draw=function(e,t){var n=e[0],s=e[1],r=e[2],a=e[3],o=e[4],i=[(n+1)*this._spacingX,s*this._spacingY+this._hexSize];if(this._options.transpose&&i.reverse(),t&&(this._context.fillStyle=o,this._fill(i[0],i[1])),r){this._context.fillStyle=a;var l=[].concat(r);for(let e=0;e<l.length;e++)this._context.fillText(l[e],i[0],Math.ceil(i[1]))}},s.Display.Hex.prototype.computeSize=function(e,t){return this._options.transpose&&(e+=t,e-=t=e-t),[Math.floor(e/this._spacingX)-1,Math.floor((t-2*this._hexSize)/this._spacingY+1)]},s.Display.Hex.prototype.computeFontSize=function(e,t){this._options.transpose&&(e+=t,e-=t=e-t);var n=2*e/((this._options.width+1)*Math.sqrt(3))-1,s=t/(2+1.5*(this._options.height-1)),r=Math.min(n,s),a=this._context.font;this._context.font="100px "+this._options.fontFamily;var o=Math.ceil(this._context.measureText("W").width);this._context.font=a;var i=o/100,l=2*(r=Math.floor(r)+1)/(this._options.spacing*(1+i/Math.sqrt(3)));return Math.ceil(l)-1},s.Display.Hex.prototype.eventToPosition=function(e,t){var n;this._options.transpose?(e+=t,e-=t=e-t,n=this._context.canvas.width):n=this._context.canvas.height;var s=n/this._options.height;return(t=Math.floor(t/s)).mod(2)?(e-=this._spacingX,e=1+2*Math.floor(e/(2*this._spacingX))):e=2*Math.floor(e/(2*this._spacingX)),[e,t]},s.Display.Hex.prototype._fill=function(e,t){var n=this._hexSize,s=this._options.border;this._context.beginPath(),this._options.transpose?(this._context.moveTo(e-n+s,t),this._context.lineTo(e-n/2+s,t+this._spacingX-s),this._context.lineTo(e+n/2-s,t+this._spacingX-s),this._context.lineTo(e+n-s,t),this._context.lineTo(e+n/2-s,t-this._spacingX+s),this._context.lineTo(e-n/2+s,t-this._spacingX+s),this._context.lineTo(e-n+s,t)):(this._context.moveTo(e,t-n+s),this._context.lineTo(e+this._spacingX-s,t-n/2+s),this._context.lineTo(e+this._spacingX-s,t+n/2-s),this._context.lineTo(e,t+n-s),this._context.lineTo(e-this._spacingX+s,t+n/2-s),this._context.lineTo(e-this._spacingX+s,t-n/2+s),this._context.lineTo(e,t-n+s)),this._context.fill()},s.Display.Tile=function(e){s.Display.Rect.call(this,e),this._options={},this._colorCanvas=document.createElement("canvas")},s.Display.Tile.extend(s.Display.Rect),s.Display.Tile.prototype.compute=function(e){this._options=e,this._context.canvas.width=e.width*e.tileWidth,this._context.canvas.height=e.height*e.tileHeight,this._colorCanvas.width=e.tileWidth,this._colorCanvas.height=e.tileHeight},s.Display.Tile.prototype.draw=function(e,t){var n=e[0],s=e[1],r=e[2],a=e[3],o=e[4],i=this._options.tileWidth,l=this._options.tileHeight;if(t&&(this._options.tileColorize?this._context.clearRect(n*i,s*l,i,l):(this._context.fillStyle=o,this._context.fillRect(n*i,s*l,i,l))),r){var c=[].concat(r);for(let e=0;e<c.length;e++){var u=this._options.tileMap[c[e]];if(!u)throw new Error("Char '"+c[e]+"' not found in tileMap");if(this._options.tileColorize){var h=this._colorCanvas,d=h.getContext("2d");d.clearRect(0,0,i,l),d.drawImage(this._options.tileSet,u[0],u[1],i,l,0,0,i,l),"transparent"!=a&&(d.fillStyle=a,d.globalCompositeOperation="source-atop",d.fillRect(0,0,i,l)),"transparent"!=o&&(d.fillStyle=o,d.globalCompositeOperation="destination-over",d.fillRect(0,0,i,l)),this._context.drawImage(h,n*i,s*l,i,l)}else this._context.drawImage(this._options.tileSet,u[0],u[1],i,l,n*i,s*l,i,l)}}},s.Display.Tile.prototype.computeSize=function(e,t){return[Math.floor(e/this._options.tileWidth),Math.floor(t/this._options.tileHeight)]},s.Display.Tile.prototype.computeFontSize=function(e,t){return[Math.floor(e/this._options.width),Math.floor(t/this._options.height)]},s.Display.Tile.prototype.eventToPosition=function(e,t){return[Math.floor(e/this._options.tileWidth),Math.floor(t/this._options.tileHeight)]},s.RNG={getSeed:function(){return this._seed},setSeed:function(e){return e=e<1?1/e:e,this._seed=e,this._s0=(e>>>0)*this._frac,e=69069*e+1>>>0,this._s1=e*this._frac,e=69069*e+1>>>0,this._s2=e*this._frac,this._c=1,this},getUniform:function(){var e=2091639*this._s0+this._c*this._frac;return this._s0=this._s1,this._s1=this._s2,this._c=0|e,this._s2=e-this._c,this._s2},getUniformInt:function(e,t){var n=Math.max(e,t),s=Math.min(e,t);return Math.floor(this.getUniform()*(n-s+1))+s},getNormal:function(e,t){var n;do{var s=2*this.getUniform()-1,r=2*this.getUniform()-1;n=s*s+r*r}while(n>1||0===n);return(e||0)+s*Math.sqrt(-2*Math.log(n)/n)*(t||1)},getPercentage:function(){return 1+Math.floor(100*this.getUniform())},getWeightedValue:function(e){var t=0;for(var n in e)t+=e[n];var s=this.getUniform()*t,r=0;for(var n in e)if(s<(r+=e[n]))return n;return n},getState:function(){return[this._s0,this._s1,this._s2,this._c]},setState:function(e){return this._s0=e[0],this._s1=e[1],this._s2=e[2],this._c=e[3],this},clone:function(){var e=Object.create(this);return e.setState(this.getState()),e},_s0:0,_s1:0,_s2:0,_c:0,_frac:2.3283064365386963e-10},s.RNG.setSeed(0),s.StringGenerator=function(e){for(var t in this._options={words:!1,order:3,prior:.001},e)this._options[t]=e[t];this._boundary=String.fromCharCode(0),this._suffix=this._boundary,this._prefix=[];for(let e=0;e<this._options.order;e++)this._prefix.push(this._boundary);this._priorValues={},this._priorValues[this._boundary]=this._options.prior,this._data={}},s.StringGenerator.prototype.clear=function(){this._data={},this._priorValues={}},s.StringGenerator.prototype.generate=function(){for(var e=[this._sample(this._prefix)];e[e.length-1]!=this._boundary;)e.push(this._sample(e));return this._join(e.slice(0,-1))},s.StringGenerator.prototype.observe=function(e){var t=this._split(e);for(let e=0;e<t.length;e++)this._priorValues[t[e]]=this._options.prior;for(t=this._prefix.concat(t).concat(this._suffix),i=this._options.order;i<t.length;i++){var n=t.slice(i-this._options.order,i),s=t[i];for(let e=0;e<n.length;e++){var r=n.slice(e);this._observeEvent(r,s)}}},s.StringGenerator.prototype.getStats=function(){var e=[],t=0;for(var n in this._priorValues)t++;t--,e.push("distinct samples: "+t);var s=0,r=0;for(var n in this._data)for(var a in s++,this._data[n])r++;return e.push("dictionary size (contexts): "+s),e.push("dictionary size (events): "+r),e.join(", ")},s.StringGenerator.prototype._split=function(e){return e.split(this._options.words?/\s+/:"")},s.StringGenerator.prototype._join=function(e){return e.join(this._options.words?" ":"")},s.StringGenerator.prototype._observeEvent=function(e,t){var n=this._join(e);n in this._data||(this._data[n]={});var s=this._data[n];t in s||(s[t]=0),s[t]++},s.StringGenerator.prototype._sample=function(e){e=this._backoff(e);var t=this._join(e),n=this._data[t],r={};if(this._options.prior){for(var a in this._priorValues)r[a]=this._priorValues[a];for(a in n)r[a]+=n[a]}else r=n;return s.RNG.getWeightedValue(r)},s.StringGenerator.prototype._backoff=function(e){for(e.length>this._options.order?e=e.slice(-this._options.order):e.length<this._options.order&&(e=this._prefix.slice(0,this._options.order-e.length).concat(e));!(this._join(e)in this._data)&&e.length>0;)e=e.slice(1);return e},s.EventQueue=function(){this._time=0,this._events=[],this._eventTimes=[]},s.EventQueue.prototype.getTime=function(){return this._time},s.EventQueue.prototype.clear=function(){return this._events=[],this._eventTimes=[],this};const r=function(e,t,n){let s=e.length;for(;s-- >=t;)e[s+1]=e[s];return e[t]=n,e};s.EventQueue.prototype.add=function(e,t){var n=this._events.length;for(let e=0;e<this._eventTimes.length;e++)if(this._eventTimes[e]>t){n=e;break}r(this._events,n,e),r(this._eventTimes,n,t)},s.EventQueue.prototype.get=function(){if(!this._events.length)return null;var e=this._eventTimes.shift();if(e>0){this._time+=e;for(let t=0;t<this._eventTimes.length;t++)this._eventTimes[t]-=e}return this._events.shift()},s.EventQueue.prototype.remove=function(e){var t=this._events.indexOf(e);return-1!==t&&(this._remove(t),!0)};const a=function(e,t){const n=e.length;if(n){for(;t<n;)e[t]=e[t+1],t++;e.length--}};s.EventQueue.prototype._remove=function(e){a(this._events,e),a(this._eventTimes,e)},s.Scheduler=function(){this._queue=new s.EventQueue,this._repeat=[],this._current=null},s.Scheduler.prototype.getTime=function(){return this._queue.getTime()},s.Scheduler.prototype.add=function(e,t){return t&&this._repeat.push(e),this},s.Scheduler.prototype.clear=function(){return this._queue.clear(),this._repeat=[],this._current=null,this},s.Scheduler.prototype.remove=function(e){var t=this._queue.remove(e),n=this._repeat.indexOf(e);return-1!=n&&this._repeat.splice(n,1),this._current===e&&(this._current=null),t},s.Scheduler.prototype.next=function(){return this._current=this._queue.get(),this._current},s.Scheduler.Simple=function(){s.Scheduler.call(this)},s.Scheduler.Simple.extend(s.Scheduler),s.Scheduler.Simple.prototype.add=function(e,t){return this._queue.add(e,0),s.Scheduler.prototype.add.call(this,e,t)},s.Scheduler.Simple.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),s.Scheduler.prototype.next.call(this)},s.Scheduler.Speed=function(){s.Scheduler.call(this)},s.Scheduler.Speed.extend(s.Scheduler),s.Scheduler.Speed.prototype.add=function(e,t){return this._queue.add(e,1/e.getSpeed()),s.Scheduler.prototype.add.call(this,e,t)},s.Scheduler.Speed.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed()),s.Scheduler.prototype.next.call(this)},s.Scheduler.Action=function(){s.Scheduler.call(this),this._defaultDuration=1,this._duration=this._defaultDuration},s.Scheduler.Action.extend(s.Scheduler),s.Scheduler.Action.prototype.add=function(e,t,n){return this._queue.add(e,n||this._defaultDuration),s.Scheduler.prototype.add.call(this,e,t)},s.Scheduler.Action.prototype.clear=function(){return this._duration=this._defaultDuration,s.Scheduler.prototype.clear.call(this)},s.Scheduler.Action.prototype.remove=function(e){return e===this._current&&(this._duration=this._defaultDuration),s.Scheduler.prototype.remove.call(this,e)},s.Scheduler.Action.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),s.Scheduler.prototype.next.call(this)},s.Scheduler.Action.prototype.setDuration=function(e){return this._current&&(this._duration=e),this},s.Engine=function(e){this._scheduler=e,this._lock=1},s.Engine.prototype.start=function(){return this.unlock()},s.Engine.prototype.lock=function(){return this._lock++,this},s.Engine.prototype.unlock=function(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){var e=this._scheduler.next();if(!e)return this.lock();var t=e.act();t&&t.then&&(this.lock(),t.then(this.unlock.bind(this)))}return this},s.Map=function(e,t){this._width=e||s.DEFAULT_WIDTH,this._height=t||s.DEFAULT_HEIGHT},s.Map.prototype.create=function(e){},s.Map.prototype._fillMap=function(e){var t=[];for(let n=0;n<this._width;n++){t.push([]);for(let s=0;s<this._height;s++)t[n].push(e)}return t},s.Map.prototype.getCols=function(){return this._width},s.Map.prototype.getRows=function(){return this._height},s.Map.prototype.getCenterXY=function(){return[Math.floor(this._width/2),Math.floor(this._height/2)]},s.Map.Arena=function(e,t){s.Map.call(this,e,t)},s.Map.Arena.extend(s.Map),s.Map.Arena.prototype.create=function(e){var t=this._width-1,n=this._height-1;for(let s=0;s<=t;s++)for(let r=0;r<=n;r++){e(s,r,s&&r&&s<t&&r<n?0:1)}return this},s.Map.DividedMaze=function(e,t){s.Map.call(this,e,t),this._stack=[]},s.Map.DividedMaze.extend(s.Map),s.Map.DividedMaze.prototype.create=function(e){var t=this._width,n=this._height;this._map=[];for(let e=0;e<t;e++){this._map.push([]);for(let r=0;r<n;r++){var s=0===e||0===r||e+1===t||r+1===n;this._map[e].push(s?1:0)}}this._stack=[[1,1,t-2,n-2]],this._process();for(let s=0;s<t;s++)for(let t=0;t<n;t++)e(s,t,this._map[s][t]);return this._map=null,this},s.Map.DividedMaze.prototype._process=function(){for(;this._stack.length;){var e=this._stack.shift();this._partitionRoom(e)}},s.Map.DividedMaze.prototype._partitionRoom=function(e){var t=[],n=[];for(let n=e[0]+1;n<e[2];n++){var s=this._map[n][e[1]-1],r=this._map[n][e[3]+1];!s||!r||n%2||t.push(n)}for(let t=e[1]+1;t<e[3];t++){var a=this._map[e[0]-1][t],o=this._map[e[2]+1][t];!a||!o||t%2||n.push(t)}if(t.length&&n.length){var i=t.random(),l=n.random();this._map[i][l]=1;var c=[],u=[];c.push(u);for(let t=e[0];t<i;t++)this._map[t][l]=1,u.push([t,l]);u=[];c.push(u);for(let t=i+1;t<=e[2];t++)this._map[t][l]=1,u.push([t,l]);u=[];c.push(u);for(let t=e[1];t<l;t++)this._map[i][t]=1,u.push([i,t]);u=[];c.push(u);for(let t=l+1;t<=e[3];t++)this._map[i][t]=1,u.push([i,t]);var h=c.random();for(let e=0;e<c.length;e++){if((u=c[e])!==h){var d=u.random();this._map[d[0]][d[1]]=0}}this._stack.push([e[0],e[1],i-1,l-1]),this._stack.push([i+1,e[1],e[2],l-1]),this._stack.push([e[0],l+1,i-1,e[3]]),this._stack.push([i+1,l+1,e[2],e[3]])}},s.Map.IceyMaze=function(e,t,n){s.Map.call(this,e,t),this._regularity=n||0},s.Map.IceyMaze.extend(s.Map),s.Map.IceyMaze.prototype.create=function(e){var t=this._width,n=this._height,r=this._fillMap(1);t-=t%2?1:2,n-=n%2?1:2;var a=0,o=0,i=0,l=0,c=0,u=!1,h=[[0,0],[0,0],[0,0],[0,0]];do{if(a=1+2*Math.floor(s.RNG.getUniform()*(t-1)/2),o=1+2*Math.floor(s.RNG.getUniform()*(n-1)/2),c||(r[a][o]=0),!r[a][o]){this._randomize(h);do{0===Math.floor(s.RNG.getUniform()*(this._regularity+1))&&this._randomize(h),u=!0;for(let e=0;e<4;e++)if(i=a+2*h[e][0],l=o+2*h[e][1],this._isFree(r,i,l,t,n)){r[i][l]=0,r[a+h[e][0]][o+h[e][1]]=0,a=i,o=l,u=!1,c++;break}}while(!u)}}while(c+1<t*n/4);for(let t=0;t<this._width;t++)for(let n=0;n<this._height;n++)e(t,n,r[t][n]);return this._map=null,this},s.Map.IceyMaze.prototype._randomize=function(e){for(let t=0;t<4;t++)e[t][0]=0,e[t][1]=0;switch(Math.floor(4*s.RNG.getUniform())){case 0:e[0][0]=-1,e[1][0]=1,e[2][1]=-1,e[3][1]=1;break;case 1:e[3][0]=-1,e[2][0]=1,e[1][1]=-1,e[0][1]=1;break;case 2:e[2][0]=-1,e[3][0]=1,e[0][1]=-1,e[1][1]=1;break;case 3:e[1][0]=-1,e[0][0]=1,e[3][1]=-1,e[2][1]=1}},s.Map.IceyMaze.prototype._isFree=function(e,t,n,s,r){return!(t<1||n<1||t>=s||n>=r)&&e[t][n]},s.Map.EllerMaze=function(e,t){s.Map.call(this,e,t)},s.Map.EllerMaze.extend(s.Map),s.Map.EllerMaze.prototype.create=function(e){var t=this._fillMap(1),n=Math.ceil((this._width-2)/2),r=[],a=[];for(let e=0;e<n;e++)r.push(e),a.push(e);r.push(n-1);let o=0;for(let e=1;e+3<this._height;e+=2){for(let o=0;o<n;o++){var i=e;t[l=2*o+1][i]=0,o!=r[o+1]&&s.RNG.getUniform()>.375&&(this._addToList(o,r,a),t[l+1][i]=0),o!=r[o]&&s.RNG.getUniform()>.375?this._removeFromList(o,r,a):t[l][i+1]=0}o=e}for(let e=0;e<n;e++){var l;i=o;t[l=2*e+1][i]=0,e!=r[e+1]&&(e===r[e]||s.RNG.getUniform()>.375)&&(this._addToList(e,r,a),t[l+1][i]=0),this._removeFromList(e,r,a)}for(let n=0;n<this._width;n++)for(let s=0;s<this._height;s++)e(n,s,t[n][s]);return this},s.Map.EllerMaze.prototype._removeFromList=function(e,t,n){n[t[e]]=n[e],t[n[e]]=t[e],n[e]=e,t[e]=e},s.Map.EllerMaze.prototype._addToList=function(e,t,n){n[t[e+1]]=n[e],t[n[e]]=t[e+1],n[e]=e+1,t[e+1]=e},s.Map.Cellular=function(e,t,n){s.Map.call(this,e,t),this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8},this.setOptions(n),this._dirs=s.DIRS[this._options.topology],this._map=this._fillMap(0)},s.Map.Cellular.extend(s.Map),s.Map.Cellular.prototype.randomize=function(e){for(let t=0;t<this._width;t++)for(let n=0;n<this._height;n++)this._map[t][n]=s.RNG.getUniform()<e?1:0;return this},s.Map.Cellular.prototype.setOptions=function(e){for(var t in e)this._options[t]=e[t]},s.Map.Cellular.prototype.set=function(e,t,n){this._map[e][t]=n},s.Map.Cellular.prototype.create=function(e){var t=this._fillMap(0),n=this._options.born,s=this._options.survive;for(let e=0;e<this._height;e++){var r=1,a=0;6===this._options.topology&&(r=2,a=e%2);for(let l=a;l<this._width;l+=r){var o=this._map[l][e],i=this._getNeighbors(l,e);o&&-1!=s.indexOf(i)?t[l][e]=1:o||-1==n.indexOf(i)||(t[l][e]=1)}}this._map=t,this.serviceCallback(e)},s.Map.Cellular.prototype.serviceCallback=function(e){if(e)for(let s=0;s<this._height;s++){var t=1,n=0;6===this._options.topology&&(t=2,n=s%2);for(let r=n;r<this._width;r+=t)e(r,s,this._map[r][s])}},s.Map.Cellular.prototype._getNeighbors=function(e,t){var n=0;for(let o=0;o<this._dirs.length;o++){var s=this._dirs[o],r=e+s[0],a=t+s[1];r<0||r>=this._width||r<0||a>=this._width||(n+=1===this._map[r][a]?1:0)}return n},s.Map.Cellular.prototype.connect=function(e,t,n){t||(t=0);var r=[],a={};for(let e=0;e<this._width;e++)for(let n=0;n<this._height;n++)if(this._freeSpace(e,n,t)){var o=[e,n];a[this._pointKey(o)]=o,r.push([e,n])}var i=r[s.RNG.getUniformInt(0,r.length-1)],l=this._pointKey(i),c={};for(c[l]=i,delete a[l],this._findConnected(c,a,[i],!1,t);Object.keys(a).length>0;){var u=(o=this._getFromTo(c,a))[0],h=o[1],d={};for(var p in d[this._pointKey(u)]=u,this._findConnected(d,a,[u],!0,t),this._tunnelToConnected(h,u,c,a,t,n),d){var f=d[p];this._map[f[0]][f[1]]=t,c[p]=f,delete a[p]}}this.serviceCallback(e)},s.Map.Cellular.prototype._getFromTo=function(e,t){var n,r,a=Object.keys(e),o=Object.keys(t);for(let l=0;l<5;l++){var i;if(a.length<o.length)r=e[(i=a)[s.RNG.getUniformInt(0,i.length-1)]],n=this._getClosest(r,t);else n=t[(i=o)[s.RNG.getUniformInt(0,i.length-1)]],r=this._getClosest(n,e);if((n[0]-r[0])*(n[0]-r[0])+(n[1]-r[1])*(n[1]-r[1])<64)break}return[n,r]},s.Map.Cellular.prototype._getClosest=function(e,t){var n=null,s=null;for(var r in t){var a=t[r],o=(a[0]-e[0])*(a[0]-e[0])+(a[1]-e[1])*(a[1]-e[1]);(null===s||o<s)&&(s=o,n=a)}return n},s.Map.Cellular.prototype._findConnected=function(e,t,n,s,r){for(;n.length>0;){var a=n.splice(0,1)[0],o=[[a[0]+1,a[1]],[a[0]-1,a[1]],[a[0],a[1]+1],[a[0],a[1]-1]];for(let a=0;a<o.length;a++){var i=this._pointKey(o[a]);null===e[i]&&this._freeSpace(o[a][0],o[a][1],r)&&(e[i]=o[a],s||delete t[i],n.push(o[a]))}}},s.Map.Cellular.prototype._tunnelToConnected=function(e,t,n,s,r,a){var o,i;this._pointKey(t);t[0]<e[0]?(o=t,i=e):(o=e,i=t);for(let e=o[0];e<=i[0];e++){this._map[e][o[1]]=r;var l=[e,o[1]];n[u=this._pointKey(l)]=l,delete s[u]}a&&o[0]<i[0]&&a(o,[i[0],o[1]]);var c=i[0];t[1]<e[1]?(o=t,i=e):(o=e,i=t);for(let e=o[1];e<i[1];e++){this._map[c][e]=r;var u;l=[c,e];n[u=this._pointKey(l)]=l,delete s[u]}a&&o[1]<i[1]&&a([i[0],o[1]],[i[0],i[1]])},s.Map.Cellular.prototype._freeSpace=function(e,t,n){return e>=0&&e<this._width&&t>=0&&t<this._height&&this._map[e][t]===n},s.Map.Cellular.prototype._pointKey=function(e){return e[0]+"."+e[1]},s.Map.Dungeon=function(e,t){s.Map.call(this,e,t),this._rooms=[],this._corridors=[]},s.Map.Dungeon.extend(s.Map),s.Map.Dungeon.prototype.getRooms=function(){return this._rooms},s.Map.Dungeon.prototype.getCorridors=function(){return this._corridors},s.Map.Digger=function(e,t,n){for(var r in s.Map.Dungeon.call(this,e,t),this._options={roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3},n)this._options[r]=n[r];this._features={Room:4,Corridor:4},this._featureAttempts=20,this._walls={},this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)},s.Map.Digger.extend(s.Map.Dungeon),s.Map.Digger.prototype.create=function(e){this._rooms=[],this._map=this._fillMap(1),this._walls={},this._dug=0,this._corridors=[];var t=(this._width-2)*(this._height-2);this._firstRoom();var n=Date.now();do{if(Date.now()-n>this._options.timeLimit)break;var s=this._findWall();if(!s)break;var r=s.split(","),a=parseInt(r[0]),o=parseInt(r[1]),i=this._getDiggingDirection(a,o);if(i){var l=0;do{if(l++,this._tryFeature(a,o,i[0],i[1])){this._removeSurroundingWalls(a,o),this._removeSurroundingWalls(a-i[0],o-i[1]);break}}while(l<this._featureAttempts);var c=0;for(var u in this._walls)this._walls[u]>1&&c++}}while(this._dug/t<this._options.dugPercentage||c);if(this._addDoors(),e)for(let t=0;t<this._width;t++)for(let n=0;n<this._height;n++)e(t,n,this._map[t][n]);return this._walls={},this._map=null,this},s.Map.Digger.prototype._digCallback=function(e,t,n){0===n||2===n?(this._map[e][t]=0,this._dug++):this._walls[e+","+t]=1},s.Map.Digger.prototype._isWallCallback=function(e,t){return!(e<0||t<0||e>=this._width||t>=this._height)&&1===this._map[e][t]},s.Map.Digger.prototype._canBeDugCallback=function(e,t){return!(e<1||t<1||e+1>=this._width||t+1>=this._height)&&1===this._map[e][t]},s.Map.Digger.prototype._priorityWallCallback=function(e,t){this._walls[e+","+t]=2},s.Map.Digger.prototype._firstRoom=function(){let e=this._startRoom;if(!e){var t=Math.floor(this._width/2),n=Math.floor(this._height/2);e=s.Map.Feature.Room.createRandomCenter(t,n,this._options)}this._rooms.push(e),e.create(this._digCallback),this._extraRooms&&this._extraRooms.forEach(e=>{this._rooms.push(e),e.create(this._digCallback)})},s.Map.Digger.prototype.startRoom=function(e){this._startRoom=e},s.Map.Digger.prototype.addRoom=function(e){this._startRoom?(this._extraRooms||(this._extraRooms=[]),this._extraRooms.push(e)):this._startRoom=e},s.Map.Digger.prototype._findWall=function(){var e=[],t=[];for(var n in this._walls){2===this._walls[n]?t.push(n):e.push(n)}var s=t.length?t:e;if(!s.length)return null;n=s.sort().random();return delete this._walls[n],n},s.Map.Digger.prototype._tryFeature=function(e,t,n,r){var a=s.RNG.getWeightedValue(this._features);return!!(a=s.Map.Feature[a].createRandomAt(e,t,n,r,this._options)).isValid(this._isWallCallback,this._canBeDugCallback)&&(a.create(this._digCallback),a instanceof s.Map.Feature.Room&&this._rooms.push(a),a instanceof s.Map.Feature.Corridor&&(a.createPriorityWalls(this._priorityWallCallback),this._corridors.push(a)),!0)},s.Map.Digger.prototype._removeSurroundingWalls=function(e,t){var n=s.DIRS[4];for(let s=0;s<n.length;s++){var r=n[s],a=e+r[0],o=t+r[1];delete this._walls[a+","+o];a=e+2*r[0],o=t+2*r[1];delete this._walls[a+","+o]}},s.Map.Digger.prototype._getDiggingDirection=function(e,t){if(e<=0||t<=0||e>=this._width-1||t>=this._height-1)return null;var n=null,r=s.DIRS[4];for(let s=0;s<r.length;s++){var a=r[s],o=e+a[0],i=t+a[1];if(!this._map[o][i]){if(n)return null;n=a}}return n?[-n[0],-n[1]]:null},s.Map.Digger.prototype._addDoors=function(){var e=this._map,t=function(t,n){return 1===e[t][n]};for(let e=0;e<this._rooms.length;e++){var n=this._rooms[e];n.clearDoors(),n.addDoors(t)}},s.Map.Uniform=function(e,t,n){for(var r in s.Map.Dungeon.call(this,e,t),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3},n)this._options[r]=n[r];this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)},s.Map.Uniform.extend(s.Map.Dungeon),s.Map.Uniform.prototype.create=function(e){for(var t=Date.now();;){if(Date.now()-t>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),this._startRoom&&(this._rooms.push(this._startRoom),this._startRoom.create(this._digCallback)),!(this._rooms.length<2)&&this._generateCorridors())break}if(e)for(let t=0;t<this._width;t++)for(let n=0;n<this._height;n++)e(t,n,this._map[t][n]);return this},s.Map.Uniform.prototype.startRoom=function(e){this._startRoom=e},s.Map.Uniform.prototype._generateRooms=function(){var e=this._width-2,t=this._height-2;do{var n=this._generateRoom();if(this._dug/(e*t)>this._options.roomDugPercentage)break}while(n)},s.Map.Uniform.prototype._generateRoom=function(){for(var e=0;e<this._roomAttempts;){e++;var t=s.Map.Feature.Room.createRandom(this._width,this._height,this._options);if(t.isValid(this._isWallCallback,this._canBeDugCallback))return t.create(this._digCallback),this._rooms.push(t),t}return null},s.Map.Uniform.prototype._generateCorridors=function(){for(var e=0;e<this._corridorAttempts;){e++,this._corridors=[],this._map=this._fillMap(1);for(let e=0;e<this._rooms.length;e++){var t=this._rooms[e];t.clearDoors(),t.create(this._digCallback)}for(this._unconnected=this._rooms.slice().randomize(),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){var n=this._connected.random(),s=this._closestRoom(this._unconnected,n),r=this._closestRoom(this._connected,s);if(!this._connectRooms(s,r))break;if(!this._unconnected.length)return!0}}return!1},s.Map.Uniform.prototype._closestRoom=function(e,t){var n=1/0,s=t.getCenter(),r=null;for(let t=0;t<e.length;t++){var a=e[t],o=a.getCenter(),i=o[0]-s[0],l=o[1]-s[1],c=i*i+l*l;c<n&&(n=c,r=a)}return r},s.Map.Uniform.prototype._connectRooms=function(e,t){var n=e.getCenter(),s=t.getCenter(),r=s[0]-n[0],a=s[1]-n[1];if(Math.abs(r)<Math.abs(a))var o=((u=a>0?2:0)+2)%4,i=t.getLeft(),l=t.getRight(),c=0;else{var u;o=((u=r>0?1:3)+2)%4,i=t.getTop(),l=t.getBottom(),c=1}var h=this._placeInWall(e,u);if(!h)return!1;if(h[c]>=i&&h[c]<=l){var d=h.slice(),p=null;switch(o){case 0:p=t.getTop()-1;break;case 1:p=t.getRight()+1;break;case 2:p=t.getBottom()+1;break;case 3:p=t.getLeft()-1}d[(c+1)%2]=p,this._digLine([h,d])}else if(h[c]<i-1||h[c]>l+1){var f=h[c]-s[c];switch(o){case 0:case 1:var m=f<0?3:1;break;case 2:case 3:m=f<0?1:3}if(o=(o+m)%4,!(d=this._placeInWall(t,o)))return!1;(y=[0,0])[c]=h[c],y[g=(c+1)%2]=d[g],this._digLine([h,y,d])}else{var g=(c+1)%2;if(!(d=this._placeInWall(t,o)))return!1;var y=Math.round((d[g]+h[g])/2),v=[0,0],_=[0,0];v[c]=h[c],v[g]=y,_[c]=d[c],_[g]=y,this._digLine([h,v,_,d])}return e.addDoor(h[0],h[1]),t.addDoor(d[0],d[1]),-1!=(c=this._unconnected.indexOf(e))&&(this._unconnected.splice(c,1),this._connected.push(e)),-1!=(c=this._unconnected.indexOf(t))&&(this._unconnected.splice(c,1),this._connected.push(t)),!0},s.Map.Uniform.prototype._placeInWall=function(e,t){var n=[0,0],s=[0,0],r=0;switch(t){case 0:s=[1,0],n=[e.getLeft(),e.getTop()-1],r=e.getRight()-e.getLeft()+1;break;case 1:s=[0,1],n=[e.getRight()+1,e.getTop()],r=e.getBottom()-e.getTop()+1;break;case 2:s=[1,0],n=[e.getLeft(),e.getBottom()+1],r=e.getRight()-e.getLeft()+1;break;case 3:s=[0,1],n=[e.getLeft()-1,e.getTop()],r=e.getBottom()-e.getTop()+1}var a=[],o=-2;for(let e=0;e<r;e++){var i=n[0]+e*s[0],l=n[1]+e*s[1];a.push(null),1===this._map[i][l]?o!=e-1&&(a[e]=[i,l]):(o=e,e&&(a[e-1]=null))}for(let e=a.length-1;e>=0;e--)a[e]||a.splice(e,1);return a.length?a.random():null},s.Map.Uniform.prototype._digLine=function(e){for(let a=1;a<e.length;a++){var t=e[a-1],n=e[a],r=new s.Map.Feature.Corridor(t[0],t[1],n[0],n[1]);r.create(this._digCallback),this._corridors.push(r)}},s.Map.Uniform.prototype._digCallback=function(e,t,n){this._map[e][t]=n,0===n&&this._dug++},s.Map.Uniform.prototype._isWallCallback=function(e,t){return!(e<0||t<0||e>=this._width||t>=this._height)&&1===this._map[e][t]},s.Map.Uniform.prototype._canBeDugCallback=function(e,t){return!(e<1||t<1||e+1>=this._width||t+1>=this._height)&&1===this._map[e][t]},s.Map.Rogue=function(e,t,n){for(var r in s.Map.call(this,e,t),this._options={cellWidth:3,cellHeight:3},n)this._options[r]=n[r];this._options.hasOwnProperty("roomWidth")||(this._options.roomWidth=this._calculateRoomSize(this._width,this._options.cellWidth)),this._options.hasOwnProperty("roomHeight")||(this._options.roomHeight=this._calculateRoomSize(this._height,this._options.cellHeight))},s.Map.Rogue.extend(s.Map),s.Map.Rogue.prototype.create=function(e){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),e)for(let t=0;t<this._width;t++)for(let n=0;n<this._height;n++)e(t,n,this.map[t][n]);return this},s.Map.Rogue.prototype._calculateRoomSize=function(e,t){var n=Math.floor(e/t*.8),s=Math.floor(e/t*.25);return s<2&&(s=2),n<2&&(n=2),[s,n]},s.Map.Rogue.prototype._initRooms=function(){for(let e=0;e<this._options.cellWidth;e++){this.rooms.push([]);for(let t=0;t<this._options.cellHeight;t++)this.rooms[e].push({x:0,y:0,width:0,height:0,connections:[],cellx:e,celly:t})}},s.Map.Rogue.prototype._connectRooms=function(){var e,t,n,r,a,o=s.RNG.getUniformInt(0,this._options.cellWidth-1),i=s.RNG.getUniformInt(0,this._options.cellHeight-1),l=!1;do{var c=[0,2,4,6];c=c.randomize();do{if(l=!1,e=c.pop(),t=o+s.DIRS[8][e][0],n=i+s.DIRS[8][e][1],!(t<0||t>=this._options.cellWidth||n<0||n>=this._options.cellHeight)){if((r=this.rooms[o][i]).connections.length>0&&r.connections[0][0]===t&&r.connections[0][1]===n)break;0===(a=this.rooms[t][n]).connections.length&&(a.connections.push([o,i]),this.connectedCells.push([t,n]),o=t,i=n,l=!0)}}while(c.length>0&&!1===l)}while(c.length>0)},s.Map.Rogue.prototype._connectUnconnectedRooms=function(){var e,t,n=this._options.cellWidth,r=this._options.cellHeight;this.connectedCells=this.connectedCells.randomize();for(let u=0;u<this._options.cellWidth;u++)for(let h=0;h<this._options.cellHeight;h++)if(0===(e=this.rooms[u][h]).connections.length){var a=[0,2,4,6];a=a.randomize();var o=!1;do{var i=a.pop(),l=u+s.DIRS[8][i][0],c=h+s.DIRS[8][i][1];if(!(l<0||l>=n||c<0||c>=r)){if(o=!0,0===(t=this.rooms[l][c]).connections.length)break;for(let e=0;e<t.connections.length;e++)if(t.connections[e][0]===u&&t.connections[e][1]===h){o=!1;break}if(o)break}}while(a.length);o?e.connections.push([t.cellx,t.celly]):console.log("-- Unable to connect room.")}},s.Map.Rogue.prototype._createRandomRoomConnections=function(e){},s.Map.Rogue.prototype._createRooms=function(){var e,t,n,r,a,o=this._width,i=this._height,l=this._options.cellWidth,c=this._options.cellHeight,u=Math.floor(this._width/l),h=Math.floor(this._height/c),d=this._options.roomWidth,p=this._options.roomHeight;for(let g=0;g<l;g++)for(let l=0;l<c;l++){if(0===(n=u*g)&&(n=1),0===(r=h*l)&&(r=1),e=s.RNG.getUniformInt(d[0],d[1]),t=s.RNG.getUniformInt(p[0],p[1]),l>0)for(a=this.rooms[g][l-1];r-(a.y+a.height)<3;)r++;if(g>0)for(a=this.rooms[g-1][l];n-(a.x+a.width)<3;)n++;for(var f=Math.round(s.RNG.getUniformInt(0,u-e)/2),m=Math.round(s.RNG.getUniformInt(0,h-t)/2);n+f+e>=o;)f?f--:e--;for(;r+m+t>=i;)m?m--:t--;n+=f,r+=m,this.rooms[g][l].x=n,this.rooms[g][l].y=r,this.rooms[g][l].width=e,this.rooms[g][l].height=t;for(let s=n;s<n+e;s++)for(let e=r;e<r+t;e++)this.map[s][e]=0}},s.Map.Rogue.prototype._getWallPosition=function(e,t){var n,r,a;return 1===t||3===t?(n=s.RNG.getUniformInt(e.x+1,e.x+e.width-2),a=1===t?(r=e.y-2)+1:(r=e.y+e.height+1)-1,this.map[n][a]=0):2!==t&&4!==t||(r=s.RNG.getUniformInt(e.y+1,e.y+e.height-2),a=2===t?(n=e.x+e.width+1)-1:(n=e.x-2)+1,this.map[a][r]=0),[n,r]},s.Map.Rogue.prototype._drawCorridore=function(e,t){var n,r,a,o,i=t[0]-e[0],l=t[1]-e[1],c=e[0],u=e[1],h=[],d=Math.abs(i),p=Math.abs(l),f=s.RNG.getUniform(),m=f,g=1-f;for(r=i>0?2:6,a=l>0?4:0,d<p?(n=Math.ceil(p*m),h.push([a,n]),h.push([r,d]),n=Math.floor(p*g),h.push([a,n])):(n=Math.ceil(d*m),h.push([r,n]),h.push([a,p]),n=Math.floor(d*g),h.push([r,n])),this.map[c][u]=0;h.length>0;)for(o=h.pop();o[1]>0;)c+=s.DIRS[8][o[0]][0],u+=s.DIRS[8][o[0]][1],this.map[c][u]=0,o[1]=o[1]-1},s.Map.Rogue.prototype._createCorridors=function(){var e,t,n,s,r,a=this._options.cellWidth,o=this._options.cellHeight;for(let i=0;i<a;i++)for(let a=0;a<o;a++){e=this.rooms[i][a];for(let a=0;a<e.connections.length;a++)t=e.connections[a],(n=this.rooms[t[0]][t[1]]).cellx>e.cellx?(s=2,r=4):n.cellx<e.cellx?(s=4,r=2):n.celly>e.celly?(s=3,r=1):n.celly<e.celly&&(s=1,r=3),this._drawCorridore(this._getWallPosition(e,s),this._getWallPosition(n,r))}},s.Map.Feature=function(){},s.Map.Feature.prototype.isValid=function(e){},s.Map.Feature.prototype.create=function(e){},s.Map.Feature.prototype.debug=function(){},s.Map.Feature.createRandomAt=function(e,t,n,s,r){},s.Map.Feature.Room=function(e,t,n,s,r,a){this._x1=e,this._y1=t,this._x2=n,this._y2=s,this._doors={},this._feats={},this._stairs={},arguments.length>4&&this.addDoor(r,a)},s.Map.Feature.Room.extend(s.Map.Feature),s.Map.Feature.Room.createRandomAt=function(e,t,n,r,a){var o,i,l=a.roomWidth[0],c=a.roomWidth[1],u=s.RNG.getUniformInt(l,c),h=(l=a.roomHeight[0],c=a.roomHeight[1],s.RNG.getUniformInt(l,c));if(1===n)return new this(e+1,o=t-Math.floor(s.RNG.getUniform()*h),e+u,o+h-1,e,t);if(-1===n)return new this(e-u,o=t-Math.floor(s.RNG.getUniform()*h),e-1,o+h-1,e,t);if(1===r)return new this(i=e-Math.floor(s.RNG.getUniform()*u),t+1,i+u-1,t+h,e,t);if(-1===r)return new this(i=e-Math.floor(s.RNG.getUniform()*u),t-h,i+u-1,t-1,e,t);throw new Error("dx or dy must be 1 or -1")},s.Map.Feature.Room.createRandomCenter=function(e,t,n){var r=n.roomWidth[0],a=n.roomWidth[1],o=s.RNG.getUniformInt(r,a),i=(r=n.roomHeight[0],a=n.roomHeight[1],s.RNG.getUniformInt(r,a)),l=e-Math.floor(s.RNG.getUniform()*o),c=t-Math.floor(s.RNG.getUniform()*i);return new this(l,c,l+o-1,c+i-1)},s.Map.Feature.Room.createCenter=function(e,t,n){var r=n.roomWidth[0],a=n.roomWidth[1],o=s.RNG.getUniformInt(r,a),i=(r=n.roomHeight[0],a=n.roomHeight[1],s.RNG.getUniformInt(r,a)),l=e-Math.floor(o/2),c=t-Math.floor(i/2);return new this(l,c,l+o-1,c+i-1)},s.Map.Feature.Room.createRandom=function(e,t,n){var r=n.roomWidth[0],a=n.roomWidth[1],o=s.RNG.getUniformInt(r,a),i=(r=n.roomHeight[0],a=n.roomHeight[1],s.RNG.getUniformInt(r,a)),l=e-o-1,c=t-i-1,u=1+Math.floor(s.RNG.getUniform()*l),h=1+Math.floor(s.RNG.getUniform()*c);return new this(u,h,u+o-1,h+i-1)},s.Map.Feature.Room.prototype.addDoor=function(e,t){return this._doors[e+","+t]=1,this},s.Map.Feature.Room.prototype.addStairs=function(e,t,n){return this._stairs[e+","+t]=n,this},s.Map.Feature.Room.prototype.hasStairs=function(e,t){return Object.keys(this._stairs).length>0},s.Map.Feature.Room.prototype.hasStairsUp=function(e,t){const n=Object.values(this._stairs);for(let e=0;e<n.length;e++)if(!1===n[e])return!0;return!1},s.Map.Feature.Room.add=function(e,t,n){this._feats[t+","+n]||(this._feats[t+","+n]=[]),this._feats[t+","+n].push(e)},s.Map.Feature.Room.prototype.getDoors=function(e){for(var t in this._doors){var n=t.split(",");e(parseInt(n[0]),parseInt(n[1]))}return this},s.Map.Feature.Room.prototype.clearDoors=function(){return this._doors={},this},s.Map.Feature.Room.prototype.addDoors=function(e){var t=this._x1-1,n=this._x2+1,s=this._y1-1,r=this._y2+1;for(let a=t;a<=n;a++)for(let o=s;o<=r;o++)a!=t&&a!=n&&o!=s&&o!=r||e(a,o)||this.addDoor(a,o);return this},s.Map.Feature.Room.prototype.debug=function(){console.log("room",this._x1,this._y1,this._x2,this._y2)},s.Map.Feature.Room.prototype.isValid=function(e,t){var n=this._x1-1,s=this._x2+1,r=this._y1-1,a=this._y2+1;for(let o=n;o<=s;o++)for(let i=r;i<=a;i++)if(o===n||o===s||i===r||i===a){if(!e(o,i))return!1}else if(!t(o,i))return!1;return!0},s.Map.Feature.Room.prototype.create=function(e){var t=this._x1-1,n=this._x2+1,s=this._y1-1,r=this._y2+1;for(let a=t;a<=n;a++)for(let o=s;o<=r;o++)e(a,o,a+","+o in this._doors?2:a===t||a===n||o===s||o===r?1:0)},s.Map.Feature.Room.prototype.getWidth=function(){return this._x2-this._x1},s.Map.Feature.Room.prototype.getHeight=function(){return this._y2-this._y1},s.Map.Feature.Room.prototype.getCorners=function(){return{nw:[this._x1,this._y1],ne:[this._x2,this._y1],sw:[this._x1,this._y2],se:[this._x2,this._y2]}},s.Map.Feature.Room.prototype.isTerm=function(){return 1===this.getDoors().length},s.Map.Feature.Room.prototype.getID=function(){return this._roomID},s.Map.Feature.Room.prototype.setID=function(e){this._roomID=e},s.Map.Feature.Room.prototype.getCenter=function(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]},s.Map.Feature.Room.prototype.getLeft=function(){return this._x1},s.Map.Feature.Room.prototype.getRight=function(){return this._x2},s.Map.Feature.Room.prototype.getTop=function(){return this._y1},s.Map.Feature.Room.prototype.getBottom=function(){return this._y2},s.Map.Feature.Room.prototype.getBbox=function(){return{ulx:this._x1,uly:this._y1,lrx:this._x2,lry:this._y2}},s.Map.Feature.Room.prototype.getOuterBbox=function(){return{ulx:this._x1-1,uly:this._y1-1,lrx:this._x2+1,lry:this._y2+1}},s.Map.Feature.prototype.getInnerBbox=function(e=1){const t=this._x1+e,n=this._x2-e;if(t>n)return{};const s=this._y1+e,r=this._y2-e;return s>r?{}:{ulx:t,uly:s,lrx:n,lry:r}},s.Map.Feature.Room.prototype.getAreaSize=function(){return(this._x2-this._x1)*(this._y2-this._y1)},s.Map.Feature.Corridor=function(e,t,n,s){this._startX=e,this._startY=t,this._endX=n,this._endY=s,this._endsWithAWall=!0},s.Map.Feature.Corridor.extend(s.Map.Feature),s.Map.Feature.Corridor.createRandomAt=function(e,t,n,r,a){var o=a.corridorLength[0],i=a.corridorLength[1],l=s.RNG.getUniformInt(o,i);return new this(e,t,e+n*l,t+r*l)},s.Map.Feature.Corridor.prototype.debug=function(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)},s.Map.Feature.Corridor.prototype.isValid=function(e,t){var n=this._startX,s=this._startY,r=this._endX-n,a=this._endY-s,o=1+Math.max(Math.abs(r),Math.abs(a));r&&(r/=Math.abs(r)),a&&(a/=Math.abs(a));var i=a,l=-r,c=!0;for(let d=0;d<o;d++){var u=n+d*r,h=s+d*a;if(t(u,h)||(c=!1),e(u+i,h+l)||(c=!1),e(u-i,h-l)||(c=!1),!c){o=d,this._endX=u-r,this._endY=h-a;break}}if(0===o)return!1;if(1===o&&e(this._endX+r,this._endY+a))return!1;var d=!e(this._endX+r+i,this._endY+a+l),p=!e(this._endX+r-i,this._endY+a-l);return this._endsWithAWall=e(this._endX+r,this._endY+a),!d&&!p||!this._endsWithAWall},s.Map.Feature.Corridor.prototype.create=function(e){var t=this._startX,n=this._startY,s=this._endX-t,r=this._endY-n,a=1+Math.max(Math.abs(s),Math.abs(r));s&&(s/=Math.abs(s)),r&&(r/=Math.abs(r));for(let o=0;o<a;o++){e(t+o*s,n+o*r,0)}return!0},s.Map.Feature.Corridor.prototype.createPriorityWalls=function(e){if(this._endsWithAWall){var t=this._startX,n=this._startY,s=this._endX-t,r=this._endY-n;s&&(s/=Math.abs(s)),r&&(r/=Math.abs(r));var a=r,o=-s;e(this._endX+s,this._endY+r),e(this._endX+a,this._endY+o),e(this._endX-a,this._endY-o)}},s.Noise=function(){},s.Noise.prototype.get=function(e,t){},s.Noise.Simplex=function(e){s.Noise.call(this),this._F2=.5*(Math.sqrt(3)-1),this._G2=(3-Math.sqrt(3))/6,this._gradients=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];var t=[],n=e||256;for(let e=0;e<n;e++)t.push(e);t=t.randomize(),this._perms=[],this._indexes=[];for(let e=0;e<2*n;e++)this._perms.push(t[e%n]),this._indexes.push(this._perms[e]%this._gradients.length)},s.Noise.Simplex.extend(s.Noise),s.Noise.Simplex.prototype.get=function(e,t){var n,s,r,a=this._perms,o=this._indexes,i=a.length/2,l=this._G2,c=0,u=0,h=0,d=(e+t)*this._F2,p=Math.floor(e+d),f=Math.floor(t+d),m=(p+f)*l,g=e-(p-m),y=t-(f-m);g>y?(s=1,r=0):(s=0,r=1);var v=g-s+l,_=y-r+l,b=g-1+2*l,E=y-1+2*l,S=p.mod(i),C=f.mod(i),w=.5-g*g-y*y;w>=0&&(w*=w,n=o[S+a[C]],c=w*w*((O=this._gradients[n])[0]*g+O[1]*y));var T=.5-v*v-_*_;T>=0&&(T*=T,n=o[S+s+a[C+r]],u=T*T*((O=this._gradients[n])[0]*v+O[1]*_));var O,M=.5-b*b-E*E;M>=0&&(M*=M,n=o[S+1+a[C+1]],h=M*M*((O=this._gradients[n])[0]*b+O[1]*E));return 70*(c+u+h)},s.FOV=function(e,t){for(var n in this._lightPasses=e,this._options={topology:8},t)this._options[n]=t[n]},s.FOV.prototype.compute=function(e,t,n,s){},s.FOV.prototype._getCircle=function(e,t,n){var r,a,o,i=[];switch(this._options.topology){case 4:a=1,o=[0,1],r=[s.DIRS[8][7],s.DIRS[8][1],s.DIRS[8][3],s.DIRS[8][5]];break;case 6:r=s.DIRS[6],a=1,o=[-1,1];break;case 8:r=s.DIRS[4],a=2,o=[-1,1]}var l=e+o[0]*n,c=t+o[1]*n;for(let e=0;e<r.length;e++)for(let t=0;t<n*a;t++)i.push([l,c]),l+=r[e][0],c+=r[e][1];return i},s.FOV.DiscreteShadowcasting=function(e,t){s.FOV.call(this,e,t)},s.FOV.DiscreteShadowcasting.extend(s.FOV),s.FOV.DiscreteShadowcasting.prototype.compute=function(e,t,n,s){this._coords,this._map;if(s(e,t,0,1),this._lightPasses(e,t)){var r,a,o,i,l,c=[];for(let d=1;d<=n;d++){var u=this._getCircle(e,t,d),h=360/u.length;for(let e=0;e<u.length;e++)if(o=u[e][0],i=u[e][1],a=(r=h*(e-.5))+h,l=!this._lightPasses(o,i),this._visibleCoords(Math.floor(r),Math.ceil(a),l,c)&&s(o,i,d,1),2===c.length&&0===c[0]&&360===c[1])return}}},s.FOV.DiscreteShadowcasting.prototype._visibleCoords=function(e,t,n,s){if(e<0){var r=arguments.callee(0,t,n,s),a=arguments.callee(360+e,360,n,s);return r||a}for(var o=0;o<s.length&&s[o]<e;)o++;if(o===s.length)return n&&s.push(e,t),!0;var i=0;if(o%2){for(;o<s.length&&s[o]<t;)o++,i++;return 0!==i&&(n&&(i%2?s.splice(o-i,i,t):s.splice(o-i,i)),!0)}for(;o<s.length&&s[o]<t;)o++,i++;return(e!==s[o-i]||1!==i)&&(n&&(i%2?s.splice(o-i,i,e):s.splice(o-i,i,e,t)),!0)},s.FOV.PreciseShadowcasting=function(e,t){s.FOV.call(this,e,t)},s.FOV.PreciseShadowcasting.extend(s.FOV),s.FOV.PreciseShadowcasting.prototype.compute=function(e,t,n,s){if(s(e,t,0,1),this._lightPasses(e,t)){var r,a,o,i,l,c,u=[];for(let p=1;p<=n;p++){var h=this._getCircle(e,t,p),d=h.length;for(let e=0;e<d;e++)if(r=h[e][0],a=h[e][1],i=[e?2*e-1:2*d-1,2*d],l=[2*e+1,2*d],o=!this._lightPasses(r,a),(c=this._checkVisibility(i,l,o,u))&&s(r,a,p,c),2===u.length&&0===u[0][0]&&u[1][0]===u[1][1])return}}},s.FOV.PreciseShadowcasting.prototype._checkVisibility=function(e,t,n,s){if(e[0]>t[0])return(this._checkVisibility(e,[e[1],e[1]],n,s)+this._checkVisibility([0,1],t,n,s))/2;for(var r=0,a=!1;r<s.length;){if((l=(c=s[r])[0]*e[1]-e[0]*c[1])>=0){0!==l||r%2||(a=!0);break}r++}for(var o=s.length,i=!1;o--;){var l,c=s[o];if((l=t[0]*c[1]-c[0]*t[1])>=0){0===l&&o%2&&(i=!0);break}}var u,h=!0;if(r===o&&(a||i)?h=!1:a&&i&&r+1===o&&o%2?h=!1:r>o&&r%2&&(h=!1),!h)return 0;var d=o-r+1;if(d%2)if(r%2){var p=s[r];u=(t[0]*p[1]-p[0]*t[1])/(p[1]*t[1]),n&&s.splice(r,d,t)}else{u=((p=s[o])[0]*e[1]-e[0]*p[1])/(e[1]*p[1]),n&&s.splice(r,d,e)}else{if(!(r%2))return n&&s.splice(r,d,e,t),1;var f=s[r],m=s[o];u=(m[0]*f[1]-f[0]*m[1])/(f[1]*m[1]),n&&s.splice(r,d)}return u/((t[0]*e[1]-e[0]*t[1])/(e[1]*t[1]))},s.FOV.RecursiveShadowcasting=function(e,t){s.FOV.call(this,e,t)},s.FOV.RecursiveShadowcasting.extend(s.FOV),s.FOV.RecursiveShadowcasting.OCTANTS=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]],s.FOV.RecursiveShadowcasting.prototype.compute=function(e,t,n,r){r(e,t,0,1);for(let a=0;a<s.FOV.RecursiveShadowcasting.OCTANTS.length;a++)this._renderOctant(e,t,s.FOV.RecursiveShadowcasting.OCTANTS[a],n,r)},s.FOV.RecursiveShadowcasting.prototype.compute180=function(e,t,n,r,a){a(e,t,0,1);var o=(r-1+8)%8,i=(r-2+8)%8,l=(r+1+8)%8;this._renderOctant(e,t,s.FOV.RecursiveShadowcasting.OCTANTS[i],n,a),this._renderOctant(e,t,s.FOV.RecursiveShadowcasting.OCTANTS[o],n,a),this._renderOctant(e,t,s.FOV.RecursiveShadowcasting.OCTANTS[r],n,a),this._renderOctant(e,t,s.FOV.RecursiveShadowcasting.OCTANTS[l],n,a)},s.FOV.RecursiveShadowcasting.prototype.compute90=function(e,t,n,r,a){a(e,t,0,1);var o=(r-1+8)%8;this._renderOctant(e,t,s.FOV.RecursiveShadowcasting.OCTANTS[r],n,a),this._renderOctant(e,t,s.FOV.RecursiveShadowcasting.OCTANTS[o],n,a)},s.FOV.RecursiveShadowcasting.prototype._renderOctant=function(e,t,n,s,r){this._castVisibility(e,t,1,1,0,s+1,n[0],n[1],n[2],n[3],r)},s.FOV.RecursiveShadowcasting.prototype._castVisibility=function(e,t,n,s,r,a,o,i,l,c,u){if(!(s<r))for(let _=n;_<=a;_++){for(var h=-_-1,d=-_,p=!1,f=0;h<=0;){var m=e+(h+=1)*o+d*i,g=t+h*l+d*c,y=(h-.5)/(d+.5),v=(h+.5)/(d-.5);if(!(v>s)){if(y<r)break;if(h*h+d*d<a*a&&u(m,g,_,1),p){if(!this._lightPasses(m,g)){f=v;continue}p=!1,s=f}else!this._lightPasses(m,g)&&_<a&&(p=!0,this._castVisibility(e,t,_+1,s,y,a,o,i,l,c,u),f=v)}}if(p)break}},s.Color={fromString:function(e){var t,n;if(e in this._cache)t=this._cache[e];else{if("#"===e.charAt(0)){var s=e.match(/[0-9a-f]/gi).map(function(e){return parseInt(e,16)});if(3===s.length)t=s.map(function(e){return 17*e});else{for(let e=0;e<3;e++)s[e+1]+=16*s[e],s.splice(e,1);t=s}}else t=(n=e.match(/rgb\(([0-9, ]+)\)/i))?n[1].split(/\s*,\s*/).map(function(e){return parseInt(e)}):[0,0,0];this._cache[e]=t}return t.slice()},add:function(e,t){var n=e.slice();for(let e=0;e<3;e++)for(let t=1;t<arguments.length;t++)n[e]+=arguments[t][e];return n},add_:function(e,t){for(let t=0;t<3;t++)for(let n=1;n<arguments.length;n++)e[t]+=arguments[n][t];return e},multiply:function(e,t){var n=e.slice();for(let e=0;e<3;e++){for(let t=1;t<arguments.length;t++)n[e]*=arguments[t][e]/255;n[e]=Math.round(n[e])}return n},multiply_:function(e,t){for(let t=0;t<3;t++){for(let n=1;n<arguments.length;n++)e[t]*=arguments[n][t]/255;e[t]=Math.round(e[t])}return e},interpolate:function(e,t,n){arguments.length<3&&(n=.5);var s=e.slice();for(let r=0;r<3;r++)s[r]=Math.round(s[r]+n*(t[r]-e[r]));return s},interpolateHSL:function(e,t,n){arguments.length<3&&(n=.5);var s=this.rgb2hsl(e),r=this.rgb2hsl(t);for(let e=0;e<3;e++)s[e]+=n*(r[e]-s[e]);return this.hsl2rgb(s)},randomize:function(e,t){t instanceof Array||(t=Math.round(s.RNG.getNormal(0,t)));var n=e.slice();for(let e=0;e<3;e++)n[e]+=t instanceof Array?Math.round(s.RNG.getNormal(0,t[e])):t;return n},rgb2hsl:function(e){var t,n,s=e[0]/255,r=e[1]/255,a=e[2]/255,o=Math.max(s,r,a),i=Math.min(s,r,a),l=(o+i)/2;if(o===i)t=n=0;else{var c=o-i;switch(n=l>.5?c/(2-o-i):c/(o+i),o){case s:t=(r-a)/c+(r<a?6:0);break;case r:t=(a-s)/c+2;break;case a:t=(s-r)/c+4}t/=6}return[t,n,l]},hsl2rgb:function(e){var t=e[2];if(0===e[1])return[t=Math.round(255*t),t,t];var n=function(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e},s=e[1],r=t<.5?t*(1+s):t+s-t*s,a=2*t-r,o=n(a,r,e[0]+1/3),i=n(a,r,e[0]),l=n(a,r,e[0]-1/3);return[Math.round(255*o),Math.round(255*i),Math.round(255*l)]},toRGB:function(e){return"rgb("+this._clamp(e[0])+","+this._clamp(e[1])+","+this._clamp(e[2])+")"},toHex:function(e){var t=[];for(let n=0;n<3;n++)t.push(this._clamp(e[n]).toString(16).lpad("0",2));return"#"+t.join("")},_clamp:function(e){return e<0?0:e>255?255:e},_cache:{black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]}},s.Lighting=function(e,t){this._reflectivityCallback=e,this._options={passes:1,emissionThreshold:100,range:10},this._fov=null,this._lights={},this._reflectivityCache={},this._fovCache={},this.setOptions(t)},s.Lighting.prototype.setOptions=function(e){for(var t in e)this._options[t]=e[t];return e&&e.range&&this.reset(),this},s.Lighting.prototype.setFOV=function(e){return this._fov=e,this._fovCache={},this},s.Lighting.prototype.setLight=function(e,t,n){var r=e+","+t;return n?this._lights[r]="string"==typeof n?s.Color.fromString(n):n:delete this._lights[r],this},s.Lighting.prototype.clearLights=function(){this._lights={}},s.Lighting.prototype.reset=function(){return this._reflectivityCache={},this._fovCache={},this},s.Lighting.prototype.compute=function(e){var t={},n={},r={};for(var a in this._lights){var o=this._lights[a];n[a]=[0,0,0],s.Color.add_(n[a],o)}for(let e=0;e<this._options.passes;e++)this._emitLight(n,r,t),e+1!==this._options.passes&&(n=this._computeEmitters(r,t));for(var i in r){var l=i.split(",");e(parseInt(l[0]),parseInt(l[1]),r[i])}return this},s.Lighting.prototype._emitLight=function(e,t,n){for(var s in e){var r=s.split(","),a=parseInt(r[0]),o=parseInt(r[1]);this._emitLightFromCell(a,o,e[s],t),n[s]=1}return this},s.Lighting.prototype._computeEmitters=function(e,t){var n={};for(var s in e)if(!(s in t)){var r=e[s];if(s in this._reflectivityCache)var a=this._reflectivityCache[s];else{var o=s.split(","),i=parseInt(o[0]),l=parseInt(o[1]);a=this._reflectivityCallback(i,l);this._reflectivityCache[s]=a}if(0!==a){var c=[],u=0;for(let e=0;e<3;e++){var h=Math.round(r[e]*a);c[e]=h,u+=h}u>this._options.emissionThreshold&&(n[s]=c)}}return n},s.Lighting.prototype._emitLightFromCell=function(e,t,n,s){var r=e+","+t;if(r in this._fovCache)var a=this._fovCache[r];else a=this._updateFOV(e,t);for(var o in a){var i=a[o];if(o in s)var l=s[o];else{l=[0,0,0];s[o]=l}for(let e=0;e<3;e++)l[e]+=Math.round(n[e]*i)}return this},s.Lighting.prototype._updateFOV=function(e,t){var n=e+","+t,s={};this._fovCache[n]=s;var r=this._options.range;return this._fov.compute(e,t,r,function(e,t,n,a){var o=a*(1-n/r);0!==o&&(s[e+","+t]=o)}.bind(this)),s},s.Path=function(e,t,n,r){for(var a in this._toX=e,this._toY=t,this._fromX=null,this._fromY=null,this._passableCallback=n,this._options={topology:8},r)this._options[a]=r[a];this._dirs=s.DIRS[this._options.topology],8===this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])},s.Path.prototype.compute=function(e,t,n){},s.Path.prototype._getNeighbors=function(e,t){var n=[];for(let o=0;o<this._dirs.length;o++){var s=this._dirs[o],r=e+s[0],a=t+s[1];this._passableCallback(r,a)&&n.push([r,a])}return n},s.Path.Dijkstra=function(e,t,n,r){s.Path.call(this,e,t,n,r),this._computed={},this._todo=[],this._add(e,t,null)},s.Path.Dijkstra.extend(s.Path),s.Path.Dijkstra.prototype.compute=function(e,t,n){var s=e+","+t;if(s in this._computed||this._compute(e,t),s in this._computed)for(var r=this._computed[s];r;)n(r.x,r.y),r=r.prev},s.Path.Dijkstra.prototype._compute=function(e,t){for(;this._todo.length;){var n=this._todo.shift();if(n.x===e&&n.y===t)return;var s=this._getNeighbors(n.x,n.y);for(let e=0,t=s.length;e<t;e++){var r=s[e][0],a=s[e][1],o=r+","+a;o in this._computed||this._add(o,r,a,n)}}},s.Path.Dijkstra.prototype._add=function(e,t,n,s){var r={x:t,y:n,prev:s};this._computed[e]=r,this._todo.push(r)},s.Path.AStar=function(e,t,n,r){s.Path.call(this,e,t,n,r),this._todo=[],this._done={},this._fromX=null,this._fromY=null},s.Path.AStar.extend(s.Path),s.Path.AStar.prototype.compute=function(e,t,n){if(this._todo=[],this._done={},this._fromX=e,this._fromY=t,this._add(this._toX,this._toY,null),0===this._getNeighbors(e,t).length)return;for(;this._todo.length;){const n=this._todo.shift();if(n.x===e&&n.y===t)break;const s=this._getNeighbors(n.x,n.y);for(let e=0;e<s.length;e++){const t=s[e],r=t[0],a=t[1];r+","+a in this._done||this._add(r,a,n)}}let s=this._done[e+","+t];if(s)for(;s;)n(s.x,s.y),s=s.prev},s.Path.AStar.prototype._add=function(e,t,n){var s=this._distance(e,t),a={x:e,y:t,prev:n,g:n?n.g+1:0,h:s};this._done[e+","+t]=a;var o=a.g+a.h;for(let e=0;e<this._todo.length;e++){var i=this._todo[e],l=i.g+i.h;if(o<l||o===l&&s<i.h)return void r(this._todo,e,a)}this._todo.push(a)},s.Path.AStar.prototype._distance=function(e,t){return Math.max(Math.abs(e-this._fromX),Math.abs(t-this._fromY))},t.default=s},function(e,t,n){"use strict";e.exports=function(){}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=r(n(103)),i=n(180),l=n(40),c=n(18),u=n(30),h=n(12),d=c.EventPool.getPool(),p=l.Component.DataComponent,f=l.Component.UniqueDataComponent,m=l.Component.UniqueDataComponent,g=l.Component.TransientDataComponent,y=l.Component.TransientTagComponent,v=l.Component.TagComponent,_=l.Component.UniqueTagComponent,b=l.ComponentBase.prototype,E=Object.freeze("");t.ImpossibleCmd=_("ImpossibleCmd"),t.Action=m("Action",{energy:0,active:!1}),t.Action.prototype.addEnergy=function(e){this.energy+=e},t.Action.prototype.resetEnergy=function(){this.energy=0},t.Action.prototype.enable=function(){if(!1===this.active)d.emitEvent(a.default.EVT_ACT_COMP_ENABLED,{actor:this.getEntity()}),this.active=!0;else{this.getEntity().getName(),this.getEntity().getID()}},t.Action.prototype.disable=function(){!0===this.active&&(d.emitEvent(a.default.EVT_ACT_COMP_DISABLED,{actor:this.getEntity()}),this.active=!1)},t.Location=f("Location",{x:-1,y:-1,level:null}),t.Location.prototype.getXY=function(){return[this.x,this.y]},t.Location.prototype.setXY=function(e,t){this.x=e,this.y=t},t.Location.prototype.unsetLevel=function(){this.level?this.level=null:a.default.err("Location","unsetLevel","Trying to unset already null level.")},t.Location.prototype.isLocated=function(){return this.x>=0&&this.y>=0&&null!==this.level},t.Location.prototype.getCell=function(){return this.level?this.level.getMap().getCell(this.x,this.y):null},t.Location.prototype.toJSON=function(){const e={setType:this.getType(),setID:this.getID(),setX:this.x,setY:this.y};return this.level&&(e.setLevel=a.default.getObjRef("entity",this.level)),e},t.Typed=f("Typed",{objType:E,propType:E}),t.Typed.prototype._init=function(e,t){this.objType=e,this.propType=t},t.Item=f("Item",{value:1,damageType:a.default.DMG.BLUNT,count:1}),t.Item.prototype.incrCount=function(e){this.count+=e},t.Item.prototype.decrCount=function(e){this.count-=e},t.Hunger=f("Hunger",{energy:2e4,maxEnergy:2e4,minEnergy:-5e3}),t.Hunger.prototype.addEnergy=function(e){this.energy+=e,this.energy>this.maxEnergy&&(this.energy=this.maxEnergy)},t.Hunger.prototype.decrEnergy=function(e){this.energy-=e,this.energy<this.minEnergy&&(this.energy=this.minEnergy)},t.Hunger.prototype.isStarving=function(){return this.energy<=0},t.Hunger.prototype.isFull=function(){return this.energy===this.maxEnergy},t.Health=f("Health",{HP:10,maxHP:10}),t.Health.prototype.addHP=function(e){this.HP+=e,this.HP>this.maxHP&&(this.HP=this.maxHP)},t.Health.prototype.decrHP=function(e){this.HP-=e},t.Health.prototype.isAlive=function(){return this.HP>0},t.Health.prototype.isDead=function(){return this.HP<=0},t.Health.prototype.hpLost=function(){return this.maxHP-this.HP},t.Health.prototype._init=function(e){this.HP=e,this.maxHP=e},t.Dead=_("Dead"),t.DeathEvent=m("DeathEvent",{msg:"",source:null}),t.Corporeal=_("Corporeal"),t.Damage=g("Damage",{damage:0,weapon:null,damageType:"",damageCateg:"",source:null,sourceActor:null}),t.Damage.prototype._init=function(e,t){this.damage=e,this.damageType=t},t.Damage.prototype.isType=function(e){return this.damageType===e},t.DirectDamage=p("DirectDamage",{damage:0,damageType:"",damageCateg:"",prob:1,source:null,msg:""}),t.DirectDamage.prototype.rollDamage=function(){return this.damage.roll()},t.DirectDamage.prototype.setDamage=function(e){this.damage="number"==typeof e?new u.Dice(0,0,e):"object"==typeof e?e.clone():u.Dice.create(e)},t.DirectDamage.prototype.toJSON=function(){const e=l.ComponentBase.prototype.toJSON.call(this);return this.source?e.setSource=a.default.getObjRef("entity",this.source):delete e.setSource,e.setDamage=this.damage.toString(),e},t.Damaged=f("Damaged",{damageLevel:0}),t.Broken=_("Broken"),t.Impassable=f("Impassable",{canFlyOver:!0,canJumpOver:!0,spellPasses:!0}),t.Impassable.prototype.setAllImpassable=function(){this.canFlyOver=!1,this.spellPasses=!1},t.Opaque=_("Opaque"),t.Experience=f("Experience",{exp:0,expLevel:1,danger:1}),t.ExpPoints=g("ExpPoints",{expPoints:null,skillPoints:null}),t.ExpPoints.prototype._init=function(e){this.expPoints=e,this.skills={}},t.ExpPoints.prototype.addSkillPoints=function(e,t){this.skills[e]=t},t.ExpPoints.prototype.addExpPoints=function(e){this.expPoints+=e},t.Combat=f("Combat",{attack:1,defense:1,protection:0,attackRange:1,damageDie:null}),t.Combat.prototype._init=function(){this.damageDie=u.Dice.create("1d4")},t.Combat.prototype.rollDamage=function(){return this.damageDie.roll()},t.Combat.prototype.setDamageDie=function(e){this.damageDie="string"==typeof e?u.Dice.create(e):e},t.Combat.prototype.copy=function(e){b.copy.call(this,e),this.damageDie=e.getDamageDie().clone()},t.Combat.prototype.toJSON=function(){const e=b.toJSON.call(this);return e.setDamageDie=this.damageDie.toString(),e},t.CombatMods=p("CombatMods",{attack:0,defense:0,protection:0,attackRange:0,damage:0,tag:""}),t.Stats=f("Stats",{accuracy:5,agility:5,strength:5,willpower:5,perception:5,magic:5,speed:100}),t.Stats.prototype.clearValues=function(){this.setAccuracy(0),this.setAgility(0),this.setStrength(0),this.setWillpower(0),this.setPerception(0),this.setSpeed(0),this.setMagic(0)},t.Stats.prototype.incrStat=function(e,t){const n="set"+e.capitalize(),s=this["get"+e.capitalize()]();this[n](s+t)},t.Stats.prototype.toString=function(){let e="";return a.default.GET_STATS.forEach((t,n)=>{const s=this[t]();0!==s&&(e+=a.default.STATS_ABBR[n]+": "+s)}),e},t.Stats.prototype.equals=function(e){let t=this.getType()===e.getType();return t=(t=(t=(t=(t=(t=(t=t&&this.getAccuracy()===e.getAccuracy())&&this.getAgility()===e.getAgility())&&this.getStrength()===e.getStrength())&&this.getWillpower()===e.getWillpower())&&this.getSpeed()===e.getSpeed())&&this.getPerception()===e.getPerception())&&this.getMagic()===e.getMagic()},t.StatsMods=p("StatsMods",{accuracy:0,agility:0,strength:0,willpower:0,perception:0,magic:0,speed:0,tag:""}),t.Perception=f("Perception",{FOVRange:a.default.NPC_FOV_RANGE}),t.Attack=g("Attack",{target:null}),t.Movement=g("Movement",{x:0,y:0,level:null}),t.Movement.prototype.setXY=function(e,t){this.x=e,this.y=t},t.Movement.prototype.getXY=function(){return[this.x,this.y]},t.Movement.prototype._init=function(e,t,n){this.x=e,this.y=t,this.level=n},t.Chat=g("Chat",{args:null}),t.Trainer=f("Trainer",{chatObj:null}),delete t.Trainer.prototype.setChatObj,t.Trainer.prototype._init=function(){this.chatObj=new i.ChatTrainer;this.addCallback("onAdd",()=>{this.chatObj.setTrainer(this.getEntity())})},t.Missile=g("Missile",{x:null,y:null,source:null,level:null,flying:!0,targetX:null,targetY:null,range:0,attack:0,damage:0,path:null}),t.Missile.prototype._init=function(e){this.source=e,this.x=e.getX(),this.y=e.getY(),this.level=e.getLevel(),this.path=[],this.pathIter=-1},t.Missile.prototype.hasRange=function(){return this.range>0},t.Missile.prototype.isFlying=function(){return this.flying},t.Missile.prototype.stopMissile=function(){this.flying=!1},t.Missile.prototype.setTargetXY=function(e,t){this.path=h.Geometry.getBresenham(this.x,this.y,e,t),this.targetX=e,this.targetY=t,this.path.length>0&&(this.pathIter=0)},t.Missile.prototype.inTarget=function(){return this.x===this.targetX&&this.y===this.targetY},t.Missile.prototype.iteratorValid=function(){return this.pathIter>=0&&this.pathIter<this.path.length},t.Missile.prototype.setValuesFromIterator=function(){const e=this.path[this.pathIter];this.x=e[0],this.y=e[1]},t.Missile.prototype.first=function(){return this.pathIter=0,this.setValuesFromIterator(),[this.x,this.y]},t.Missile.prototype.next=function(){return this.iteratorValid()?(--this.range,++this.pathIter,this.setValuesFromIterator(),!0):null},t.Missile.prototype.prev=function(){return this.iteratorValid()?(++this.range,--this.pathIter,this.setValuesFromIterator(),!0):null},t.Loot=function(e){l.ComponentBase.call(this,"Loot"),this._lootEntity=e},a.default.extend2(t.Loot,l.ComponentBase),l.Component.Loot=t.Loot,t.Loot.prototype.dropLoot=function(e){const t=this.getEntity().getLevel();if(this._lootEntity.getPropType){const n=this._lootEntity.getPropType();"elements"===n?this.setElemToCell(e):n===a.default.TYPE_ITEM?t.addItem(this._lootEntity,e.getX(),e.getY()):a.default.err("Component.Loot","dropLoot","Unsupported propType for entity: "+n)}else a.default.err("Loot","dropLoot","Loot has no propType!")},t.Loot.prototype.setElemToCell=function(e){const t=this.getEntity().getLevel();this._lootEntity.hasOwnProperty("useStairs")&&(a.default.debug(this,"Added stairs to "+e.getX()+", "+e.getY()),t.addStairs(this._lootEntity,e.getX(),e.getY()))},t.Loot.prototype.setLootEntity=function(e){this._lootEntity=e},t.Loot.prototype.toJSON=function(){const e=l.ComponentBase.prototype.toJSON.call(this),t=this._lootEntity.toJSON();return this._lootEntity.getPropType()===a.default.TYPE_ITEM?e.setLootEntity={createFunc:"createItem",value:t}:this._lootEntity.getPropType()===a.default.TYPE_ACTOR?e.setLootEntity={createFunc:"createActor",value:t}:a.default.err("Loot","toJSON","Only items/actors loot types are supported"),e},t.Communication=g("Communication",{msg:null}),t.Communication.prototype._init=function(){this.msg=[]},t.Communication.prototype.addMsg=function(e){this.msg.push(e)},t.Damaging=p("Damaging",{damage:1,damageType:""}),t.OneShot=_("OneShot"),t.Physical=f("Physical",{weight:1,size:1}),t.Ethereal=v("Ethereal",{description:"Ethereal beings cannot interact physically with others"}),t.Stun=p("Stun",{source:null}),t.Stun.prototype.toJSON=function(){const e=l.ComponentBase.prototype.toJSON.call(this);return a.default.isActorActive(this.source)&&(e.setSource=a.default.getObjRef("entity",this.source)),e},t.Stun.description="Stunning prevents some actions to be done",t.Paralysis=p("Paralysis",{source:null}),t.Paralysis.description="Paralysed actors cannot perform any actions",t.Paralysis.prototype.toJSON=function(){const e=l.ComponentBase.prototype.toJSON.call(this);return a.default.isActorActive(this.source)&&(e.setSource=a.default.getObjRef("entity",this.source)),e},t.Created=f("Created",{creator:null}),t.Created.prototype.toJSON=function(){const e=l.ComponentBase.prototype.toJSON.call(this);return e.setCreator=a.default.getObjRef("entity",this.creator),e},t.Named=f("Named",{name:"",uniqueName:""}),t.Named.prototype.prepend=function(e){this.name=e+this.name},t.Named.prototype.getBaseName=function(){return this.name},t.Named.prototype.getFullName=function(){return""!==this.uniqueName?`${this.uniqueName}, ${this.name}`:this.name};class S extends(o.DurationRoll(o.DamageRoll(l.ComponentBase))){constructor(){super("Poison"),this._src=null,this._prob=.05}getProb(){return this._prob}setProb(e){this._prob=e}getSource(){return this._src}setSource(e){this._src=e}copy(e){super.copy(e),this._prob=e.getProb(),this._src=e.getSource()}toJSON(){const e=super.toJSON();return e.setType=this.getType(),e.setProb=this._prob,a.default.isActorActive(this._src)&&(e.setSource=a.default.getObjRef("entity",this._src)),e}}t.Poison=S,S.description="Poison causes damage periodically until it stop",l.Component.Poison=S,t.Coldness=v("Coldness",{description:"Coldness will gradually freeze a non-resistant beings"}),t.Heat=v("Heat"),t.BodyTemp=f("BodyTemp",{temp:100,maxTemp:100,minTemp:-100}),t.BodyTemp.prototype.incr=function(){this.temp<this.maxTemp&&(this.temp+=1)},t.BodyTemp.prototype.decr=function(){this.temp>this.minTemp&&(this.temp-=1)},t.BodyTemp.prototype.isFreezing=function(){return this.temp<=0},t.BodyTemp.prototype.isFrozen=function(){return this.temp===this.minTemp},t.Owned=f("Owned",{owner:null}),t.Stolen=v("Stolen"),t.Unpaid=v("Unpaid"),t.Breakable=_("Breakable"),t.Indestructible=_("Indestructible"),t.Ammo=v("Ammo"),t.Flying=v("Flying",{description:"Flying beings can avoid difficult terrain and obstacles"}),t.Undead=v("Undead"),t.Summoned=v("Summoned"),t.Sharpener=v("Sharpener",{description:"You can sharpen weapons (once per weapoon"}),t.Sharpened=v("Sharpened"),t.Possessed=v("Possessed"),t.Flame=g("Flame",{damageType:"",damage:1,source:null}),t.Weakness=p("Weakness",{effect:"",level:a.default.WEAKNESS.MINOR},{description:"Weakness increases damage from attacks of that type"}),t.Resistance=p("Resistance",{effect:"",level:a.default.RESISTANCE.MINOR},{description:"Resistance reduces damage from attacks of that type"}),t.Magical=_("Magical"),t.NonSentient=_("NonSentient"),t.ActorClass=function(){l.ComponentBase.call(this,"ActorClass"),this._class=null,this._className=null,this.setClassName=(e=>{this._className=e}),this.getClassName=(()=>this._className),this.getClass=(()=>this._class),this.setActorClass=(e=>{this._class=e})},a.default.extend2(t.ActorClass,l.ComponentBase),l.Component.ActorClass=t.ActorClass,t.ActorClass.prototype.toJSON=function(){const e=b.toJSON.call(this);return e.setActorClass={createFunc:"createActorClass",value:{className:this._className,actorRef:a.default.getObjRef("entity",this.getEntity())}},e},t.Defender=_("Defender",{description:"Grants a minor defense (Def) bonus"}),t.Attacker=_("Attacker",{description:"Grants a minor attack (Att) bonus"}),t.BiDirStrike=_("BiDirStrike",{description:"You can attack to 2 opposite directions"}),t.CounterAttack=_("CounterAttack",{desciption:"You perform a counterattack when attacked by enemies"}),t.Ambidexterity=_("Ambidexterity"),t.LongReach=_("LongReach"),t.FirstStrike=_("FirstStrike",{description:"You can hit enemies first before they attack you"}),t.MasterEquipper=p("MasterEquipper",{factor:.5}),t.BypassProtection=p("BypassProtection",{chance:0}),t.Charm=p("Charm",{level:1,targetActor:a.default.NO_TARGET}),t.Climber=_("Climber"),t.Jumper=f("Jumper",{jumpRange:2}),t.Camouflage=_("Camouflage"),t.SnowWalk=_("SnowWalk"),t.Amphibious=_("Amphibious"),t.EagleEye=v("EagleEye",{description:"Grants bonus to missile range and visibility"}),t.StrongShot=v("StrongShot",{description:"Strength (Str) adds extra damage to missile attacks"}),t.ThroughShot=v("ThroughShot",{description:"You can shoot through enemies to hit another target"}),t.MixedShot=v("MixedShot",{description:"Allows mixing of ammo from different type of weapons"}),t.LongRangeShot=v("LongRangeShot",{description:"Doubles missile attack range"}),t.RangedEvasion=v("RangedEvasion",{description:"Grants 50% chance to evade missile/ranged spell attacks"}),t.CriticalShot=v("CriticalShot"),t.DoubleShot=v("DoubleShot"),t.SpellPower=f("SpellPower",{PP:10,maxPP:10}),t.SpellPower.prototype.addPP=function(e){this.PP+=e,this.PP>this.maxPP&&(this.PP=this.maxPP)},t.SpellPower.prototype.decrPP=function(e){this.PP-=e},t.SpellPower.prototype.hasPower=function(){return this.PP>0},t.SpellPower.prototype.canCast=function(e){return this.PP>=e},t.PowerDrain=p("PowerDrain",{drainDist:5}),t.PowerDrain.description="Counters any spell cast near you, gives you power and then disappears",t.SpellBase=function(e){l.ComponentBase.call(this,e);let t=null,n=null,s=null;this.getSpell=(()=>t),this.setSpell=(e=>{t=e}),this.getSource=(()=>n),this.setSource=(e=>{n=e}),this.getArgs=(()=>s),this.setArgs=(e=>{s=e})},a.default.extend2(t.SpellBase,l.ComponentBase),t.SpellCast=function(){t.SpellBase.call(this,"SpellCast")},a.default.extend2(t.SpellCast,t.SpellBase),t.SpellRay=function(){t.SpellBase.call(this,"SpellRay")},a.default.extend2(t.SpellRay,t.SpellBase),t.SpellMissile=function(){t.SpellBase.call(this,"SpellMissile")},a.default.extend2(t.SpellMissile,t.SpellBase),t.SpellCell=function(){t.SpellBase.call(this,"SpellCell")},a.default.extend2(t.SpellCell,t.SpellBase),t.SpellArea=function(){t.SpellBase.call(this,"SpellArea")},a.default.extend2(t.SpellArea,t.SpellBase),t.SpellSelf=function(){t.SpellBase.call(this,"SpellSelf")},a.default.extend2(t.SpellSelf,t.SpellBase),t.SpellStop=_("SpellStop"),t.NourishedOne=_("NourishedOne",{description:"You gain triple amount of energy from food"}),t.SpiritBind=g("SpiritBind",{binder:null,target:null}),t.GemBound=f("GemBound",{gem:null}),t.GemBound.prototype.toJSON=function(){return{setID:this.getID(),setType:"GemBound",setGem:{createFunc:"createItem",value:this.getGem().toJSON()}}},t.SpiritItemCrafter=_("SpiritItemCrafter",{description:"Grants ability to bind gems to items such as weapons/armour"}),t.Skills=function(){l.ComponentBase.call(this,"Skills"),this._isUnique=!0,this._skills={},this.hasSkill=(e=>this._skills.hasOwnProperty(e)),this.addSkill=(e=>{this._skills[e]={name:e,level:1,points:0}}),this.getLevel=(e=>this.hasSkill(e)?this._skills[e].level:0),this.setLevel=((e,t)=>{this._skills[e].level=t}),this.getPoints=(e=>this._skills[e].points),this.resetPoints=(e=>{this._skills[e].points=0}),this.addPoints=((e,t)=>{this.hasSkill(e)&&(this._skills[e].points+=t)}),this.getSkills=(()=>this._skills),this.setSkills=(e=>{this._skills=e}),this.toJSON=(()=>({setID:this.getID(),setType:this.getType(),setSkills:this._skills}))},a.default.extend2(t.Skills,l.ComponentBase),l.Component.Skills=t.Skills,t.SkillsExp=g("SkillsExp",{skill:"",points:0}),t.Shopkeeper=f("Shopkeeper",{levelID:-1,cells:null,doorXY:null}),t.Shopkeeper._init=function(){this.cells=[]},t.Transaction=g("Transaction",{args:null}),t.InBattle=function(){l.ComponentBase.call(this,"InBattle"),this._isUnique=!0;let e=null;this.setData=(t=>{e=t}),this.getData=(()=>e),this.updateData=(t=>{e=Object.assign(e||{},t)})},a.default.extend2(t.InBattle,l.ComponentBase),l.Component.InBattle=t.InBattle,t.BattleExp=function(){l.ComponentBase.call(this,"BattleExp");let e=null;this.setData=(t=>{e=t}),this.getData=(()=>e),this.updateData=(t=>{e=Object.assign(e||{},t)})},a.default.extend2(t.BattleExp,l.ComponentBase),l.Component.BattleExp=t.BattleExp,t.BattleOver=_("BattleOver"),t.BattleBadge=function(){l.ComponentBase.call(this,"BattleBadge");let e=null;this.setData=(t=>{e=t}),this.getData=(()=>e),this.updateData=(t=>{e=Object.assign(e,t)}),this.isWon=(()=>"Won"===e.status),this.isLost=(()=>"Lost"===e.status),this.isTraitor=(()=>"Traitor"===e.status)},a.default.extend2(t.BattleBadge,l.ComponentBase),l.Component.BattleBadge=t.BattleBadge,t.BattleOrder=p("BattleOrder",{args:null}),t.Commander=v("Commander"),t.Reputation=function(){l.ComponentBase.call(this,"Reputation");let e=null;this.setData=(t=>{e=t}),this.getData=(()=>e),this.updateData=(t=>{e=Object.assign(e,t)}),this.addToFame=(t=>{e||(e={}),e.hasOwnProperty("fame")?e.fame+=t:e.fame=t})},a.default.extend2(t.Reputation,l.ComponentBase),l.Component.Reputation=t.Reputation,t.Event=g("Event",{args:null}),t.Event.prototype._init=function(e){this.args=e},t.Effects=g("Effects",{args:null,effectType:""}),t.Effects.prototype._init=function(e){this.args=e||{}},t.PlayerControlled=_("PlayerControlled"),t.Player=_("Player"),t.AddOnHit=p("AddOnHit",{comp:null,onDamage:!0,onAttackHit:!1}),t.AddOnHit.prototype.getCompToAdd=function(){return this.comp.toJSON?this.comp:l.Component.createFromObj(this.comp.transientComp,this.comp.func)},t.AddOnHit.prototype.toJSON=function(){const e={setID:this.getID(),setType:this.getType(),setComp:this.comp,setOnDamage:this.onDamage,setOnAttackHit:this.onAttackHit};return this.comp.toJSON&&(e.setComp={createComp:this.comp.toJSON()}),e},t.Equip=g("Equip",{args:null,item:null,isRemove:!1}),t.AddOnEquip=p("AddOnEquip",{comp:null,addedToActor:!1}),t.AddOnEquip.prototype.toJSON=function(){const e={setID:this.getID(),setType:this.getType(),setAddedToActor:this.addedToActor};if(this.addedToActor)e.setComp={createComp:this.comp};else{const t=this.comp.toJSON();e.setComp={createComp:t}}return e},t.RegenEffect=p("RegenEffect",{PP:1,HP:1,waitPP:30,waitHP:30,maxWaitPP:60,maxWaitHP:60}),t.Telepathy=p("Telepathy",{target:null,source:null},{description:"Grants ability to see through eyes of another being"}),t.Telepathy.prototype.toJSON=function(){const e={setID:this.getID(),setType:this.getType()};return a.default.isActorActive(this.target)&&(e.setTarget=a.default.getObjRef("entity",this.target)),a.default.isActorActive(this.source)&&(e.setSource=a.default.getObjRef("entity",this.source)),e},t.Animation=g("Animation",{args:null}),t.Animation.prototype._init=function(e){this.args=e},t.addToExpirationComp=((e,n,s,r)=>{if(e.has("Expiration"))e.get("Expiration").addEffect(n,s,r);else{const a=new t.Expiration;a.addEffect(n,s,r),e.add(a)}e.has(n)||e.add(n)}),t.Give=g("Give",{giveTarget:null,item:null}),t.Jump=g("Jump",{x:-1,y:-1}),t.OpenDoor=g("OpenDoor",{door:null}),t.Pickup=y("Pickup"),t.Read=g("Read",{readTarget:null}),t.Rest=y("Rest"),t.UseElement=g("UseElement",{element:null,useType:""}),t.UseItem=g("UseItem",{item:null,useType:"",target:null,targetType:null,effect:null}),t.UseStairs=y("UseStairs"),t.GameInfo=f("GameInfo",{data:null}),t.GameInfo.prototype._init=function(){this.data={zones:{}}},t.GameInfo.prototype.updateData=function(e){const t=this.data;this.data=Object.assign(t,e)},t.GameInfo.prototype.addZone=function(e){this.data.zones[e]=!0},t.GameInfo.prototype.hasZone=function(e){return this.data.zones[e]},t.GameInfo.prototype.addZoneType=function(e){const t=this.data;t.zones.hasOwnProperty(e)?t.zones[e]+=1:t.zones[e]=1,this.data=t},t.Fading=p("Fading",{duration:0}),t.Fading.prototype.decrDuration=function(){this.duration-=1},t.Expiration=p("Expiration",{duration:null,expireMsg:null}),t.Expiration.prototype._init=function(){this.expireMsg={}},t.Expiration.prototype.addEffect=function(e,t,n){this.duration||(this.duration={});const s=e.getID();this.duration.hasOwnProperty(s)?this.duration[s]+=t:(this.duration[s]=t,e.addCallback("onRemove",()=>{this.removeEffect(e)})),n&&(this.expireMsg||(this.expireMsg={}),this.expireMsg[s]=n)},t.Expiration.prototype.decrDuration=function(){for(const e in this.duration)if(this.duration[e]){const t=parseInt(e,10);if(t>=0&&(this.duration[t]-=1,0===this.duration[t])){const e=this.getEntity();if(this.expireMsg&&this.expireMsg[t]){const n=this.expireMsg[t];a.default.gameMsg({cell:e.getCell(),msg:n})}else{const t="An effect wears of from "+e.getName();a.default.gameMsg({cell:e.getCell(),msg:t})}e.remove(t),delete this.duration[t]}}},t.Expiration.prototype.hasEffects=function(){return Object.keys(this.duration).length>0},t.Expiration.prototype.hasEffect=function(e){const t=e.getID();return this.duration.hasOwnProperty(t)},t.Expiration.prototype.removeEffect=function(e){const t=e.getID();this.duration.hasOwnProperty(t)&&delete this.duration[t],this.expireMsg&&this.expireMsg.hasOwnProperty(t)&&delete this.expireMsg[t]},t.Expiration.prototype.cleanup=function(){const e=this.getEntity();Object.keys(this.duration).forEach(t=>{e.remove(parseInt(t,10))})};class C extends(o.DurationRoll(l.ComponentBase)){constructor(){super("Duration"),this._comp=null,this._source=null,this._addedOnActor=!1,this._expireMsg=""}setSource(e){this._source=e}setExpireMsg(e){this._expireMsg=e}getExpireMsg(){return this._expireMsg}getSource(){return this._source}setComp(e){if(this._comp=e,!this._addedOnActor){const e=()=>{this.getEntity().add(this._comp),this._comp.setSource&&this._source&&this._comp.setSource(this._source),this._comp=this._comp.getID(),this._addedOnActor=!0,this.removeCallbacks("onAdd")};this.addCallback("onAdd",e)}this.addCallback("onRemove",()=>{this.getEntity().has(this._comp)&&this.getEntity().remove(this._comp)})}getComp(){return this._comp}copy(e){super.copy(e);const t=e.getComp().clone();this.setComp(t)}clone(){const e=super.clone();return e.copy(this),e}setAddedOnActor(e){this._addedOnActor=e}getAddedOnActor(){return this._addedOnActor}toJSON(){const e=super.toJSON();if(a.default.isActorActive(this._source)&&(e.setSource=a.default.getObjRef("entity",this._source)),this._addedOnActor)return Object.assign(e,{setAddedOnActor:!0,setComp:this._comp});{const t=this._comp.toJSON();return Object.assign(e,{setComp:{createComp:t}})}}}t.Duration=C,l.Component.Duration=C;t.QuestGiver=f("QuestGiver",{hasGivenQuest:!1,descr:"",questID:-1,danger:1,reward:-1,hasGivenReward:!1,questTargets:null}),t.QuestGiver.prototype._init=function(e){this.chatObj=new i.ChatQuest,this.descr=e,this.questID=this.getID(),this.questTargets=[];this.addCallback("onAdd",()=>{this.chatObj.setQuestGiver(this.getEntity())})},t.QuestGiver.prototype.hasReward=function(){return this.reward&&-1!==this.reward},t.QuestGiver.prototype.giveQuest=function(e){e?(this.questGivenTo=e,this.hasGivenQuest=!0):this.hasGivenQuest=!1},t.QuestGiver.prototype.addTarget=function(e,t){t||a.default.err("QuestGiver","addTarget",`No target given. Type ${e}`);const n=a.default.getName(t);if(a.default.isEmpty(n))a.default.err("QuestGiver","addTarget",`Empty name got for target ${JSON.stringify(t)}`);else{const s={id:t.getID(),name:n,targetType:e,subQuestID:-1},r=t.get("QuestTarget");-1!==r.getSubQuestID()&&(s.subQuestID=r.getSubQuestID()),this.questTargets.push(s)}},t.QuestGiver.prototype.toJSON=function(){const e=b.toJSON.call(this);return this.questGivenTo&&(e.giveQuest=a.default.getObjRef("entity",this.questGivenTo)),e},t.QuestGiver.prototype.getChatObj=function(){return this.chatObj},t.QuestTarget=p("QuestTarget",{targetType:"",target:null,isCompleted:!1,targetID:-1,questID:-1,subQuestID:-1}),t.QuestTarget.prototype.isKill=function(){return"kill"===this.targetType},t.QuestTarget.prototype.toString=function(){let e="";if(this.target.getName)e=this.target.getName();else if(this.target.getParent){const t=this.target.getParent();if(t&&(e=t.getName()),t.getParent){e+=" of "+t.getParent().getName()}}return`${this.targetType} ${e}`},t.QuestTarget.prototype.toJSON=function(){const e=b.toJSON.call(this);return e.setTargetType=this.targetType,this.target.$objID?e.setTarget=a.default.getObjRef("object",this.target):e.setTarget=a.default.getObjRef("entity",this.target),e},t.QuestEscortTarget=p("QuestEscortTarget",{escortTo:-1,question:"Can I help you safely somewhere?"}),t.QuestEscortTarget.prototype.toJSON=function(){const e=b.toJSON.call(this);return e.setEscortTo=a.default.getObjRef("entity",this.escortTo),e},t.Quest=p("Quest",{giver:null,questTargets:null,questID:-1,descr:""}),t.Quest.prototype._init=function(){this.questTargets=[]},t.Quest.prototype.addTarget=function(e){this.questTargets.push(e)},t.Quest.prototype.isInThisQuest=function(e){return this.getQuestID()===e.getQuestID()},t.Quest.prototype.getTargetsByType=function(e){return this.questTargets.filter(t=>t.targetType===e)},t.Quest.prototype.first=function(e){const t=this.questTargets.find(t=>t.targetType===e);return t||null},t.Quest.prototype.isCompleted=function(){return this.questTargets.reduce((e,t)=>e&&t.isCompleted,!0)},t.Quest.prototype.isTargetInQuest=function(e){const t=e.getTarget();for(let e=0;e<this.questTargets.length;e++){if(this.questTargets[e].id===t.getID())return!0}return!1},t.Quest.prototype.toString=function(){let e="";return this.questTargets.forEach((t,n)=>{n>0&&(e+=". "),"subquest"===t.targetType?e+="Talk to "+t.name:e+=t.targetType+" "+t.name}),e},t.QuestInfo=p("QuestInfo",{question:"",info:"",givenBy:-1}),t.QuestReport=p("QuestReport",{expectInfoFrom:-2}),t.QuestCompleted=g("QuestCompleted",{giver:null}),t.GiveQuest=g("GiveQuest",{target:null,giver:null}),t.QuestTargetEvent=g("QuestTargetEvent",{targetComp:null,args:null,eventType:""}),t.QuestTargetEvent.prototype.setTargetComp=function(e){a.default.assertType(e,"QuestTarget"),this.targetComp=e},t.Weather=p("Weather",{weatherType:"clear"}),t.WeatherEffect=g("WeatherEffect",{effectType:"clear"}),t.Indoor=_("Indoor"),t.Snowy=_("Snowy"),t.Entrapping=f("Entrapping",{difficulty:1,destroyOnMove:!1}),t.Entrapped=_("Entrapped"),t.Lore=f("Lore",{topics:null}),t.Lore.prototype.addTopic=function(e,t){this.topics[e]||(this.topics[e]=[]),this.topics[e].push(t)},t.Lore.prototype._init=function(){this.topics={}},t.DrainStat=g("DrainStat",{drainAmount:1,sourceComp:"",sourceGetter:"",sourceSetter:"",targetComp:"",targetGetter:"",targetSetter:"",source:null,drainMsg:""}),t.DrainStat.prototype.applyComp=function(){const e=this.getEntity().get(this.sourceComp);if(e){const t=e[this.sourceGetter]();e[this.sourceSetter](t-this.drainAmount);const n=this.source.get(this.targetComp);if(n){const e=n[this.targetGetter]();return n[this.targetSetter](e+this.drainAmount),!0}}return!1}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=s(n(23)),i=n(35),l=n(21),c=n(191),u=n(90),h=n(192),d=n(193),p=n(108),f=n(330),m=n(12),g=n(19),y=n(9),v=n(332),_=n(333),b=n(334),E=n(335),S=r(n(15)),C=S.ElementMarker,w=y.Random.getRNG(),T=function(e,t,n){return e>=t&&e<=n},O=function(e,t,n,s,r){let a=!0;if(r.exclude){if(r.exclude.bbox){const{ulx:o,uly:i,lrx:l,lry:c}=r.exclude.bbox;T(e,o,l)&&T(t,i,c)&&(a=!1),T(n,o,l)&&T(s,i,c)&&(a=!1)}}else r.maxY&&(a=s<=r.maxY);return a};class M{static getAndSetRNG(e){if(e){if(e.rng)return e.rng;e.rng=w}return w}static addRandomSnow(e,t,n){const s=e.getFree().filter(e=>e.isOutdoors()),r=M.getAndSetRNG(n);for(let e=0;e<s.length;e++){const n=r.getUniform(),a=s[e];if(n<=t){const t=a.getBaseElem().getType();let n=M.snowElemMap.default;M.snowElemMap[t]&&(n=M.snowElemMap[t]),s[e].setBaseElem(n)}}}static fromAsciiMap(e,t){const n=e.length,s=e[0].length,r=new i.CellMap(n,s);for(let a=0;a<n;a++)for(let n=0;n<s;n++){const s=e[a][n];if(t.hasOwnProperty(s)){const e=t[s];"function"!=typeof e?r.setBaseElemXY(a,n,e):e(r,a,n)}else if("+"===s){const e=new S.ElementMarker("+");e.setTag("door"),r.setBaseElemXY(a,n,t["."]),r.setElemXY(a,n,e)}}return{map:r}}static getWallElem(e){switch(e){case"cave":case"wallcave":return g.ELEM.WALL_CAVE;case"castle":case"wallcastle":return g.ELEM.WALL_CASTLE;case"crypt":case"wallcrypt":return g.ELEM.WALL_CRYPT;case"ice":case"wallice":return g.ELEM.WALL_ICE;case"wooden":case"wallwooden":return g.ELEM.WALL_WOODEN;default:return g.ELEM.WALL}}static getFloorElem(e){switch(e){case"cave":case"floorcave":return g.ELEM.FLOOR_CAVE;case"castle":case"floorcastle":return g.ELEM.FLOOR_CASTLE;case"crypt":case"floorcrypt":return g.ELEM.FLOOR_CRYPT;case"ice":case"floorice":return g.ELEM.FLOOR_ICE;case"wooden":case"floorwooden":return g.ELEM.FLOOR_WOODEN;default:return g.ELEM.FLOOR}}static createSplashes(e,t,n){const s=n.elem||g.ELEM.WATER,r=new i.CellMap(e,t);return new v.MapForest(e,t,n).create((e,t,n)=>{r.setBaseElemXY(e,t,g.ELEM.FLOOR),1===n&&r.setBaseElemXY(e,t,s)}),{map:r}}static getOptions(e){return M.options[e]?Object.assign({},M.options[e]):(a.default.warn("MapGenerator","getOptions",`Unknown map type ${e}`),{})}constructor(){this.cols=a.default.LEVEL_MEDIUM_X,this.rows=a.default.LEVEL_MEDIUM_Y,this._mapGen=new o.default.Map.Arena(this.cols,this.rows),this._mapType=null,this._wall=1,this.defaultMapElem=g.ELEM.FLOOR}createEmptyMap(){return{map:new i.CellMap(this.cols,this.rows,this.defaultMapElem)}}getMap(e={}){const t={};if("function"==typeof this._mapGen)t.map=this._mapGen();else{const n=M.getWallElem(e.wallType),s=M.getFloorElem(e.floorType),r=new i.CellMap(this.cols,this.rows,this.defaultMapElem);this._mapGen.create((e,t,a)=>{a===this._wall?r.setBaseElemXY(e,t,n):r.setBaseElemXY(e,t,s)}),t.map=r,"uniform"!==this._mapType&&"digger"!==this._mapType||(t.rooms=this._mapGen.getRooms(),t.corridors=this._mapGen.getCorridors())}return t}createRuins(e,t,n={}){let s={born:[4,5,6,7,8],survive:[2,3,4,5],connected:!0};s=Object.assign(s,n);const r=new o.default.Map.Cellular(e,t,s);r.randomize(.9);for(let e=0;e<5;e++)r.create();return r.connect(null,1),this._wall=0,r}createCellular(e,t){const n=new o.default.Map.Cellular(e,t,{connected:!0});n.randomize(.52);for(let e=0;e<5;e++)n.create();return n.connect(null,1),this._wall=0,n}createRooms(e,t){return new o.default.Map.Digger(e,t,{roomWidth:[5,20],dugPercentage:.7})}createTownBSP(e,t,n){const s=n.maxHouseX||100,r=n.maxHouseY||100,a=M.getAndSetRNG(n),o=new c.BSP.BSPGen({rng:a}),l=e-2,u=t-2,h=new c.BSP.Container(0,0,l,u),d=o.splitContainer(h,7).getLeafs();d.forEach(e=>{e.x+=1,e.y+=1}),a.shuffle(d);const p=M.getFloorElem(n.floorType),m=new i.CellMap(e,t,p),g=[],y=[],v=new f.HouseGenerator;return d.forEach(a=>{const{w:o,h:i}=a;let l=o-1,c=i-1;if(l>s&&(l=Math.round(l/2)),c>r&&(c=Math.round(c/2)),1===a.x?(a.x+=1,a.w-=1,l-=1):a.x===e-1&&(a.x-=1,a.w-=1,l-=1),1===a.y?(a.y+=1,a.h-=1,c-=1):a.y===t-1&&(a.y-=1,a.h-=1,c-=1),l>=5&&c>=5){l>10&&l%2!=0&&(l-=1),c>10&&c%2!=0&&(c-=1);const e={cols:l,rows:c};e.addWindows=n.addWindows;const t=v.createHouse(e);t&&(this.placeHouse(t,m,a.x,a.y,n),y.push(t))}else g.push(a)}),{map:m,houses:y,unused:g}}placeHouse(e,t,n,s,r){const a=e.coord,o=Object.keys(a),i=M.getWallElem(r.wallType);o.forEach(e=>{"#"===e?a[e].forEach(e=>{const r=e[0]+n,a=e[1]+s;t.setBaseElemXY(r,a,i)}):"+"===e||(":"===e?a[e].forEach(e=>{const r=e[0]+n,a=e[1]+s;t.setBaseElemXY(r,a,g.ELEM.FLOOR_HOUSE)}):"windows"===e&&a[e].forEach(e=>{const r=e[0]+n,a=e[1]+s;t.setBaseElemXY(r,a,g.ELEM.WINDOW)}))}),e.adjustCoord(n,s)}createForest(e){const t=new i.CellMap(this.cols,this.rows,this.defaultMapElem);return this.addForestToMap(t,e),{map:t}}addForestToMap(e,t){const n=t.ratio,{freeOnly:s}=t,r=M.getAndSetRNG(t);this._mapGen=new v.MapForest(this.cols,this.rows,t),s?this._mapGen.create((t,s,a)=>{const o=r.getUniform()<=n;1===a&&o?e.getCell(t,s).isFree()&&e.setBaseElemXY(t,s,g.ELEM.TREE):1===a&&e.getCell(t,s).isFree()&&e.setBaseElemXY(t,s,g.ELEM.GRASS)}):this._mapGen.create((t,s,a)=>{const o=r.getUniform()<=n;1===a&&o?e.setBaseElemXY(t,s,g.ELEM.TREE):1===a&&e.setBaseElemXY(t,s,g.ELEM.GRASS)})}createLakes(e){const t=new i.CellMap(this.cols,this.rows,this.defaultMapElem);return this._mapGen=new v.MapForest(this.cols,this.rows,e),this.addLakesToMap(t,e),{map:t}}addLakesToMap(e,t){t.freeOnly?this._mapGen.create((t,n,s)=>{1===s&&e.getCell(t,n).isFree()&&e.setBaseElemXY(t,n,g.ELEM.WATER)}):this._mapGen.create((t,n,s)=>{e.setBaseElemXY(t,n,g.ELEM.FLOOR),1===s&&e.setBaseElemXY(t,n,g.ELEM.WATER)})}addLakes(e,t,n){const s=n.lrx-n.ulx,r=n.lry-n.uly;this.setGen("lakes",s,r);const a=this.createLakes(t).map;this.addElementsToMap(e,a,"water",t,n)}addForest(e,t,n){this.cols=n.lrx-n.ulx,this.rows=n.lry-n.uly;const s=this.createForest(t).map;this.addElementsToMap(e,s,"tree",t,n)}addElementsToMap(e,t,n,s,r){a.default.forEach2D(t._map,(a,o)=>{const i=a+r.ulx,l=o+r.uly;if(m.Geometry.isInBbox(i,l,r)&&e.hasXY(i,l)){const r=t.getBaseElemXY(a,o);if(r.getType()===n)if(s.skipTypes){const t=e.getBaseElemXY(i,l).getType();s.skipTypes.hasOwnProperty(t)||e.setBaseElemXY(i,l,r)}else e.setBaseElemXY(i,l,r)}})}createWall(e,t,n){const s=new i.CellMap(e,t,this.defaultMapElem),r=n.wallElem||g.ELEM.WALL;return this._mapGen=new E.MapWall(e,t,n),this._mapGen.create((e,t,n)=>{1===n&&s.setBaseElemXY(e,t,r)}),{map:s}}createMountain(e,t,n){const s=new i.CellMap(e,t,this.defaultMapElem);n||(n=M.getOptions("mountain"));const r=M.getAndSetRNG(n);this._mapGen=new b.MapMountain(this.cols,this.rows,n),this._mapGen.create((e,t,a)=>{if(a>n.highRockThr)s.setBaseElemXY(e,t,g.ELEM.HIGH_ROCK);else if(a>n.stoneThr)s.setBaseElemXY(e,t,g.ELEM.STONE);else if(a<n.chasmThr)s.setBaseElemXY(e,t,g.ELEM.CHASM);else{r.getUniform()<n.snowRatio?s.setBaseElemXY(e,t,g.ELEM.SNOW):s.setBaseElemXY(e,t,g.ELEM.FLOOR)}});let a=[];return n.nRoadTurns>0&&(a=this.createMountainPath(s,n)),{map:s,paths:a}}createMountainPath(e,t){const n=[],s=t.nRoadTurns||10;let r=Math.floor(e.rows/s);t.yPerTurn&&(r=t.yPerTurn),r<4&&(r=4);const a=[2,e.cols-3,Math.floor(e.cols/2)];let o=!0,i=-1,c=-1;const h=[(t,n)=>e.hasXY(t,n)&&e.getCell(t,n).isFree(),(t,n)=>e.hasXY(t,n)&&"highrock"!==e.getCell(t,n).getBaseElem().getType()],d=M.getAndSetRNG(t);for(let p=0;o&&p<s;p++){o=!1;let s=i,f=c;0===p&&(s=Number.isInteger(t.startX)?t.startX:d.arrayGetRand(a),f=t.startY?t.startY:0);const m=d.arrayGetRand(a),g=(p+1)*r+f;if(O(s,f,m,g,t)){const t=l.Path.getMinWeightOrShortest(e,s,f,m,g,h);if(t){const s=u.Builder.addPathToMap(e,t);s.length>0&&(o=!0),n.push(s),i=m,c=g}else o=!0}else o=!0}if(t.maxY&&n.length>0){const s=n[n.length-1];if(s.length>0){const r=s[s.length-1],[o,i]=[r.x,r.y];let c=d.arrayGetRand(a);const p=t.maxY;if(t.endX&&(c=t.endX),p>i&&O(o,i,c,p,t)){const t=l.Path.getMinWeightOrShortest(e,o,i,c,p,h);if(t){const s=u.Builder.addPathToMap(e,t);n.push(s)}}}}return n}createSummit(e,t,n){const s=new i.CellMap(e,t,g.ELEM.SKY),r=n.ratio||.3;let[a,o]=[Math.floor(e/2),Math.floor(t/2)];const l=e*t,c=[[a,o]];s.setBaseElemXY(a,o,g.ELEM.FLOOR);let u=1;const h=M.getAndSetRNG(n);let d=1e4;for(;u/l<r;){[a,o]=h.arrayGetRand(c);const[e,t]=h.getRandDir();if(a+=e,o+=t,s.hasXY(a,o)&&"sky"===s.getBaseElemXY(a,o).getType()&&(c.push([a,o]),++u,s.setBaseElemXY(a,o,g.ELEM.FLOOR)),--d<=0)break}return{map:s}}createCave(e,t,n){this._mapGen=new _.MapMiner(e,t,n);const s=new i.CellMap(e,t,this.defaultMapElem),r=n.wallElem||g.ELEM.WALL_CAVE,a=n.floorElem||g.ELEM.FLOOR_CAVE;return this._mapGen.create((e,t,n)=>{1===n?s.setBaseElemXY(e,t,r):s.setBaseElemXY(e,t,a)}),{map:s,mapGen:this._mapGen}}createCryptNew(e,t,n={}){const s=n.tilesX||12,r=n.tilesY||7,a=new h.TemplateLevel(s,r);a.use(d.Crypt);const o=n.genParams||[2,2,2,2],i=n.roomCount||40;a.setGenParams(o),a.setRoomCount(i),a.create();const l={"#":g.ELEM.WALL_CRYPT,".":g.ELEM.FLOOR_CRYPT},c=M.fromAsciiMap(a.map,l);return c.tiles=a.getPlacedData(),c}createCastle(e,t,n={}){const s=n.genParams||[1,1,1,1],r=5+s[0]+s[1],a=5+s[2]+s[3],o=n.tilesX||Math.ceil(e/r),i=n.tilesY||Math.ceil(t/a),l=new h.TemplateLevel(o,i);l.use(p.Castle),n.models||n.templates?"string"==typeof n.models?l.setTemplates(p.Castle.Models[n.models]):"string"==typeof n.templates?l.setTemplates(p.Castle.templates[n.templates]):l.setTemplates(n.models):l.setTemplates(p.Castle.Models.full),2===n.nGates?l.setStartRoomFunc(p.Castle.startFuncTwoGates):n.startRoomFunc&&l.setStartRoomFunc(n.startRoomFunc),n.constraintFunc&&l.setConstraintFunc(n.constraintFunc);const c=n.roomCount||40;return l.setGenParams(s),l.setRoomCount(c),n.callbacks&&Object.keys(n.callbacks).forEach(e=>{l.addCallback(e,n.callbacks[e])}),l.create(),this.createCastleMapObj(l,n)}createCastleWall(e,t,n={}){const s=n.tilesX||Math.ceil(e/7),r=n.tilesY||Math.ceil(t/7),a=new h.TemplateLevel(s,r);a.use(p.Castle),a.setTemplates(p.Castle.Models.outerWall),a.setFiller(p.Castle.tiles.fillerFloor),2===n.nGates?a.setStartRoomFunc(p.Castle.startFuncTwoGates):n.startRoomFunc&&a.setStartRoomFunc(n.startRoomFunc),n.constraintFunc&&a.setConstraintFunc(n.constraintFunc),a.create();const o={"#":M.getWallElem(n.wallType),".":M.getFloorElem(n.floorType)},i=M.fromAsciiMap(a.map,o);return i.tiles=a.getPlacedData(),i}createCastleMapObj(e,t){const n=[],s={"#":M.getWallElem(t.wallType),".":M.getFloorElem(t.floorType),"&":(e,s,r)=>{if(e.setBaseElemXY(s,r,M.getFloorElem(t.floorType)),t.preserveMarkers){const t=new C("&");t.setTag("lever"),e.getCell(s,r).setProp(a.default.TYPE_ELEM,t),t.setXY(s,r),n.push(t)}},"|":(e,s,r)=>{if(e.setBaseElemXY(s,r,M.getFloorElem(t.floorType)),t.preserveMarkers){const t=new C("|");t.setTag("leverdoor"),e.getCell(s,r).setProp(a.default.TYPE_ELEM,t),t.setXY(s,r),n.push(t)}},":":(e,s,r)=>{if(e.setBaseElemXY(s,r,g.ELEM.FLOOR_HOUSE),t.preserveMarkers){const t=new C(":");t.setTag("living_quarter"),e.getCell(s,r).setProp(a.default.TYPE_ELEM,t),t.setXY(s,r),n.push(t)}},"+":(e,s,r)=>{if(e.setBaseElemXY(s,r,M.getFloorElem(t.floorType)),t.preserveMarkers){const t=new C("+");t.setTag("door"),e.getCell(s,r).setProp(a.default.TYPE_ELEM,t),t.setXY(s,r),n.push(t)}}},r=M.fromAsciiMap(e.map,s);return r.tiles=e.getPlacedData(),r.elements=n,r}createTownWithWall(e,t,n={}){const s=Math.ceil(e/7),r=Math.ceil(t/7),a=this.createCastleWall(e,t,n);n.levelType="empty";const o=7*(s-2),i=7*(r-2),l=this.createTownBSP(o,i,n),c=a.map;m.Geometry.mergeMapBaseElems(c,l.map,7,7);const u=l.houses;u.forEach(e=>{e.moveHouse(7,7)});const h=l.unused;return h&&h.forEach(e=>{e.x+=7,e.y+=7}),{map:c,houses:u,unused:h,tiles:a.tiles}}createArctic(e,t,n={}){const s=n.snowRatio||1;this.setGen("empty",e,t);const r=new i.CellMap(e,t,this.defaultMapElem);return M.addRandomSnow(r,s),{map:r}}setGen(e,t,n){switch(this.cols=t,this.rows=n,e=e.toLowerCase(),this._mapType=e,e){case"arctic":this._mapGen=new o.default.Map.Dungeon(t,n);break;case"arena":this._mapGen=new o.default.Map.Arena(t,n);break;case"cave":this._mapGen=new _.MapMiner(t,n);break;case"cellular":this._mapGen=this.createCellular(t,n);break;case"castle":break;case"crypt":this._mapGen=new o.default.Map.Uniform(t,n);break;case"digger":this._mapGen=new o.default.Map.Digger(t,n);break;case"divided":this._mapGen=new o.default.Map.DividedMaze(t,n);break;case"dungeon":this._mapGen=new o.default.Map.Rogue(t,n);break;case"empty":this._mapGen=new o.default.Map.Dungeon(t,n);break;case"eller":this._mapGen=new o.default.Map.EllerMaze(t,n);break;case"forest":case"lakes":this._mapGen=new v.MapForest(t,n);break;case"labyrinth":this._mapGen=new o.default.Map.DividedMaze(t,n);break;case"miner":this._mapGen=new _.MapMiner(t,n);break;case"mountain":this._mapGen=new b.MapMountain(t,n);break;case"icey":this._mapGen=new o.default.Map.IceyMaze(t,n);break;case"rogue":this._mapGen=new o.default.Map.Rogue(t,n);break;case"uniform":this._mapGen=new o.default.Map.Uniform(t,n);break;case"ruins":this._mapGen=this.createRuins(t,n);break;case"rooms":this._mapGen=this.createRooms(t,n);break;case"town":this._mapGen=new o.default.Map.Arena(t,n);break;case"townwithwall":case"summit":break;case"wall":this._mapGen=new E.MapWall(t,n);break;default:a.default.err("MapGen","setGen","this._mapGen type "+e+" is unknown")}}}t.MapGenerator=M,M.options={},M.options.mountain=Object.freeze({noiseMult:1,noiseDivider:20,highRockThr:.75,stoneThr:.5,chasmThr:-.4,nRoadTurns:8,snowRatio:0}),M.snowElemMap={floor:g.ELEM.SNOW_LIGHT,"light snow":g.ELEM.SNOW,"light snow with tracks":g.ELEM.SNOW,snow:g.ELEM.SNOW_DEEP,"snow with tracks":g.ELEM.SNOW,tree:g.ELEM.TREE_SNOW,"snow-covered tree":g.ELEM.TREE_SNOW,water:g.ELEM.WATER_FROZEN,"frozen water":g.ELEM.WATER_FROZEN,grass:g.ELEM.GRASS_SNOW,"snowy grass":g.ELEM.GRASS_SNOW,"deep snow":g.ELEM.SNOW_DEEP,"deep snow with tracks":g.ELEM.SNOW_DEEP},M.snowMeltMap={"light snow":g.ELEM.FLOOR,"light snow with tracks":g.ELEM.FLOOR,snow:g.ELEM.SNOW_LIGHT,"snow with tracks":g.ELEM.SNOW_LIGHT,"snow-covered tree":g.ELEM.TREE,"frozen water":g.ELEM.WATER,"snowy grass":g.ELEM.GRASS,"deep snow":g.ELEM.SNOW,"deep snow with tracks":g.ELEM.SNOW}},function(e,t,n){"use strict";
/*
object-assign
(c) Sindre Sorhus
@license MIT
*/var s=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable;e.exports=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},n=0;n<10;n++)t["_"+String.fromCharCode(n)]=n;if("0123456789"!==Object.getOwnPropertyNames(t).map(function(e){return t[e]}).join(""))return!1;var s={};return"abcdefghijklmnopqrst".split("").forEach(function(e){s[e]=e}),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},s)).join("")}catch(e){return!1}}()?Object.assign:function(e,t){for(var n,o,i=function(e){if(null==e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}(e),l=1;l<arguments.length;l++){for(var c in n=Object(arguments[l]))r.call(n,c)&&(i[c]=n[c]);if(s){o=s(n);for(var u=0;u<o.length;u++)a.call(n,o[u])&&(i[o[u]]=n[o[u]])}}return i}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=s(n(23));t.Keys={},t.Keys.VK_a=a.default.VK_A+32,t.Keys.VK_b=a.default.VK_B+32,t.Keys.VK_c=a.default.VK_C+32,t.Keys.VK_d=a.default.VK_D+32,t.Keys.VK_e=a.default.VK_E+32,t.Keys.VK_f=a.default.VK_F+32,t.Keys.VK_g=a.default.VK_G+32,t.Keys.VK_h=a.default.VK_H+32,t.Keys.VK_i=a.default.VK_I+32,t.Keys.VK_j=a.default.VK_J+32,t.Keys.VK_k=a.default.VK_K+32,t.Keys.VK_l=a.default.VK_L+32,t.Keys.VK_m=a.default.VK_M+32,t.Keys.VK_n=a.default.VK_N+32,t.Keys.VK_o=a.default.VK_O+32,t.Keys.VK_p=a.default.VK_P+32,t.Keys.VK_q=a.default.VK_Q+32,t.Keys.VK_r=a.default.VK_R+32,t.Keys.VK_s=a.default.VK_S+32,t.Keys.VK_t=a.default.VK_T+32,t.Keys.VK_u=a.default.VK_U+32,t.Keys.VK_v=a.default.VK_V+32,t.Keys.VK_w=a.default.VK_W+32,t.Keys.VK_x=a.default.VK_X+32,t.Keys.VK_y=a.default.VK_Y+32,t.Keys.VK_z=a.default.VK_Z+32,t.Keys.VK_COMMA=44,t.Keys.VK_PERIOD=46,t.Keys.VK_LT=60,t.Keys.VK_GT=62,t.Keys.KeyMap={moveKeyMap:{},initMap(){this.moveKeyMap[t.Keys.KEY.MOVE_N]=0,this.moveKeyMap[t.Keys.KEY.MOVE_NE]=1,this.moveKeyMap[t.Keys.KEY.MOVE_E]=2,this.moveKeyMap[t.Keys.KEY.MOVE_SE]=3,this.moveKeyMap[t.Keys.KEY.MOVE_S]=4,this.moveKeyMap[t.Keys.KEY.MOVE_SW]=5,this.moveKeyMap[t.Keys.KEY.MOVE_W]=6,this.moveKeyMap[t.Keys.KEY.MOVE_NW]=7,this.moveKeyMap[a.default.VK_8]=0,this.moveKeyMap[a.default.VK_9]=1,this.moveKeyMap[a.default.VK_6]=2,this.moveKeyMap[a.default.VK_3]=3,this.moveKeyMap[a.default.VK_2]=4,this.moveKeyMap[a.default.VK_1]=5,this.moveKeyMap[a.default.VK_4]=6,this.moveKeyMap[a.default.VK_7]=7},inMoveCodeMap(e){return this.moveKeyMap.hasOwnProperty(e)},isRest:e=>e===t.Keys.VK_s||e===t.Keys.VK_PERIOD,isPickup:e=>e===t.Keys.KEY.PICKUP,isUseStairs:e=>e===t.Keys.KEY.USE_STAIRS_DOWN||e===t.Keys.KEY.USE_STAIRS_UP,isChat:e=>e===t.Keys.KEY.CHAT,isConfirmYes:e=>e===t.Keys.KEY.YES,isFightMode:e=>e===t.Keys.KEY.FIGHT,isGive:e=>e===t.Keys.KEY.GIVE,isGoto:e=>e===t.Keys.KEY.GOTO,isJump:e=>e===t.Keys.KEY.JUMP,isIssueOrder:e=>e===t.Keys.KEY.ORDER,isLook:e=>e===t.Keys.KEY.LOOK,isMark:e=>e===t.Keys.KEY.MARK,isNextItem:e=>e===t.Keys.KEY.NEXT_ITEM,isNextTarget:e=>e===t.Keys.KEY.NEXT,isPrevTarget:e=>e===t.Keys.KEY.PREV,isRead:e=>e===t.Keys.KEY.READ,isRunMode:e=>e===t.Keys.KEY.RUN,isSelect:e=>e===t.Keys.KEY.SELECT,isSelectAll:e=>e===t.Keys.KEY.SELECT_ALL,isTargetMode:e=>e===t.Keys.KEY.TARGET,isToggleDoor:e=>e===t.Keys.KEY.DOOR,isUsePower:e=>e===t.Keys.KEY.POWER,isUseAbility:e=>e===t.Keys.KEY.ABILITY,isMultiPurpose:e=>e===t.Keys.KEY.MULTI,getDiff(e,n,s){if(this.moveKeyMap.hasOwnProperty(e)){const t=a.default.DIRS[8][this.moveKeyMap[e]];return[n+t[0],s+t[1]]}return e===t.Keys.VK_s?[n,s]:null},getDir(e){if(this.moveKeyMap.hasOwnProperty(e)){const t=this.moveKeyMap[e];return a.default.DIRS[8][t]}return this.isRest(e)?[0,0]:null},dirToKeyCode(e,n){let s=e,a=n;switch(Array.isArray(e)&&(s=e[0],a=e[1]),0!==s&&(s/=Math.abs(s)),0!==a&&(a/=Math.abs(a)),s){case-1:switch(a){case-1:return t.Keys.KEY.MOVE_NW;case 0:return t.Keys.KEY.MOVE_W;case 1:return t.Keys.KEY.MOVE_SW;default:r.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${s},${a} not supported`)}break;case 0:switch(a){case-1:return t.Keys.KEY.MOVE_N;case 0:return t.Keys.KEY.REST;case 1:return t.Keys.KEY.MOVE_S;default:r.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${s},${a} not supported`)}break;case 1:switch(a){case-1:return t.Keys.KEY.MOVE_NE;case 0:return t.Keys.KEY.MOVE_E;case 1:return t.Keys.KEY.MOVE_SE;default:r.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${s},${a} not supported`)}break;default:r.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${s},${a} not supported`)}return null},keyCodeToCardinalDir(e){switch(e){case t.Keys.KEY.MOVE_NW:return"NW";case t.Keys.KEY.MOVE_W:return"W";case t.Keys.KEY.MOVE_SW:return"SW";case t.Keys.KEY.MOVE_N:return"N";case t.Keys.KEY.REST:return"REST";case t.Keys.KEY.MOVE_S:return"S";case t.Keys.KEY.MOVE_NE:return"NE";case t.Keys.KEY.MOVE_E:return"E";case t.Keys.KEY.MOVE_SE:return"SE";default:return""}}},t.Keys.menuIndices=[0,1,2,3,4,5,6,7,8,9,"a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],t.Keys.EXIT_INDEX=t.Keys.menuIndices.indexOf("Q"),t.Keys.codeToMenuChar=(e=>{const n=t.Keys.codeToIndex(e);return t.Keys.menuIndices[n]});const o=/[a-z]/,i=/[A-Z]/;t.Keys.selectIndexToCode=(e=>{const n=t.Keys.menuIndices.findIndex(t=>t===e);if(n>=0){if(n>=0&&n<=9)return a.default.VK_0+n;if(o.test(e)){const e=n-t.Keys.menuIndices.indexOf("a");return t.Keys.VK_a+e}if(i.test(e)){const e=n-t.Keys.menuIndices.indexOf("A");return a.default.VK_A+e}}return r.default.err("RG","selectIndexToCode",`Invalid select index |${e}|`),-1}),t.Keys.codeToIndex=(e=>e>=a.default.VK_0&&e<=a.default.VK_9?e-a.default.VK_0:e>=t.Keys.VK_a&&e<=t.Keys.VK_z?e-t.Keys.VK_a+t.Keys.menuIndices.indexOf("a"):e>=a.default.VK_A&&e<=a.default.VK_Z?e-a.default.VK_A+t.Keys.menuIndices.indexOf("A"):-1),t.Keys.isNumeric=(e=>e>=a.default.VK_0&&e<=a.default.VK_9),t.Keys.KEY={},t.Keys.KEY.MOVE_N=a.default.VK_W+32,t.Keys.KEY.MOVE_NE=a.default.VK_E+32,t.Keys.KEY.MOVE_E=a.default.VK_D+32,t.Keys.KEY.MOVE_SE=a.default.VK_C+32,t.Keys.KEY.MOVE_S=a.default.VK_X+32,t.Keys.KEY.MOVE_SW=a.default.VK_Z+32,t.Keys.KEY.MOVE_W=a.default.VK_A+32,t.Keys.KEY.MOVE_NW=a.default.VK_Q+32,t.Keys.KEY.ABILITY=t.Keys.VK_k,t.Keys.KEY.CHAT=a.default.VK_C,t.Keys.KEY.DELETE=a.default.VK_D,t.Keys.KEY.DOOR=a.default.VK_O+32,t.Keys.KEY.FIGHT=a.default.VK_F+32,t.Keys.KEY.GIVE=a.default.VK_G,t.Keys.KEY.GOTO=t.Keys.VK_g,t.Keys.KEY.JUMP=t.Keys.VK_j,t.Keys.KEY.LOOK=a.default.VK_L+32,t.Keys.KEY.MARK=t.Keys.VK_b,t.Keys.KEY.MULTI=a.default.VK_SPACE,t.Keys.KEY.NEXT=t.Keys.VK_n,t.Keys.KEY.NEXT_ITEM=a.default.VK_H+32,t.Keys.KEY.ORDER=a.default.VK_O,t.Keys.KEY.PICKUP=t.Keys.VK_COMMA,t.Keys.KEY.POWER=a.default.VK_P+32,t.Keys.KEY.PREV=a.default.VK_P+32,t.Keys.KEY.QUIT_MENU=t.Keys.VK_q,t.Keys.KEY.READ=a.default.VK_R,t.Keys.KEY.REST=a.default.VK_S+32,t.Keys.KEY.RUN=a.default.VK_R+32,t.Keys.KEY.SELECT=t.Keys.VK_s,t.Keys.KEY.SELECT_ALL=a.default.VK_A,t.Keys.KEY.TARGET=t.Keys.VK_t,t.Keys.KEY.USE_ABILITY=t.Keys.VK_k,t.Keys.KEY.USE_STAIRS_DOWN=t.Keys.VK_GT,t.Keys.KEY.USE_STAIRS_UP=t.Keys.VK_LT,t.Keys.KEY.YES=a.default.VK_Y+32,t.Keys.KeyMap.initMap(),t.Keys.KEY.NO_ACTION=a.default.VK_CAPS_LOCK,t.Keys.GUI={},t.Keys.GUI.CharInfo=a.default.VK_I,t.Keys.GUI.Goto=t.Keys.KEY.GOTO,t.Keys.GUI.Help=a.default.VK_H,t.Keys.GUI.Inv=t.Keys.VK_i,t.Keys.GUI.Look=t.Keys.VK_l,t.Keys.GUI.Map=t.Keys.VK_m,t.Keys.GUI.OwMap=a.default.VK_M,t.Keys.GUI.Use=t.Keys.VK_u,t.Keys.isValidKey=(e=>{let n=!1;return Object.keys(t.Keys.KEY).forEach(s=>{n=n||t.Keys.KEY[s]===e}),n=n||t.Keys.KeyMap.inMoveCodeMap(e)}),t.Keys.getChar=(e=>"`"+String.fromCharCode(e)+"`")},function(e,t){var n=(t=e.exports=function(e){if(e&&"object"==typeof e){var t=e.which||e.keyCode||e.charCode;t&&(e=t)}if("number"==typeof e)return a[e];var r,o=String(e);return(r=n[o.toLowerCase()])?r:(r=s[o.toLowerCase()])||(1===o.length?o.charCodeAt(0):void 0)}).code=t.codes={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,"pause/break":19,"caps lock":20,esc:27,space:32,"page up":33,"page down":34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46,command:91,"left command":91,"right command":93,"numpad *":106,"numpad +":107,"numpad -":109,"numpad .":110,"numpad /":111,"num lock":144,"scroll lock":145,"my computer":182,"my calculator":183,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222},s=t.aliases={windows:91,"⇧":16,"⌥":18,"⌃":17,"⌘":91,ctl:17,control:17,option:18,pause:19,break:19,caps:20,return:13,escape:27,spc:32,pgup:33,pgdn:34,ins:45,del:46,cmd:91};
/*!
 * Programatically add the following
 */
for(r=97;r<123;r++)n[String.fromCharCode(r)]=r-32;for(var r=48;r<58;r++)n[r-48]=r;for(r=1;r<13;r++)n["f"+r]=r+111;for(r=0;r<10;r++)n["numpad "+r]=r+96;var a=t.names=t.title={};for(r in n)a[n[r]]=r;for(var o in s)n[o]=s[o]},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(9);class o{constructor(e,t,n){this._num=parseInt(e,10),this._dice=parseInt(t,10),this._mod=parseInt(n,10)}static create(e){const t=o.parseDieSpec(e);if(3===t.length)return new o(t[0],t[1],t[2]);r.default.err("Dice","create","Could not create dice properly")}static getValue(e){if("number"!=typeof e){if("string"==typeof e){const t=o.parseDieSpec(e);return new o(t[0],t[1],t[2]).roll()}return e.roll()}if(Number.isInteger(e))return e}static parseDieSpec(e){if("number"==typeof e)return[0,0,e];if("object"==typeof e){if(e.length>=3)return[e[0],e[1],e[2]]}else{const t=o.DIE_RE.exec(e);if(null!==t){let e=null;return[t[1],t[2],e=r.default.isNullOrUndef([t[3],t[4]])?"0":"+"===t[3]?t[4]:"-"+t[4]]}if(o.DIE_NUMBER.test(e))return[0,0,parseInt(e,10)];r.default.err("RG","parseDieSpec","Cannot parse: "+e)}return[]}static combine(e,t){const n=e.getNum()+t.getNum();let s=e.getNum()*e.getDice()+t.getNum()*t.getDice();s=Math.round(s/n);const r=e.getMod()+t.getMod();return new o(n,s,r)}static addDice(e,t){const n=e.getNum()+t.getNum(),s=e.getDice()+t.getDice(),r=e.getMod()+t.getMod();return new o(n,s,r)}getNum(){return this._num}setNum(e){this._num=e}getDice(){return this._dice}setDice(e){this._dice=e}getMod(){return this._mod}setMod(e){this._mod=e}roll(){let e=0;for(let t=0;t<this._num;t++)e+=o.RNG.getUniformInt(1,this._dice);return e+this._mod}toString(){let e="+ "+this._mod;return this._mod<0?e="- "+Math.abs(this._mod):0===this._mod&&(e=""),this._num+"d"+this._dice+" "+e}copy(e){this._num=e.getNum(),this._dice=e.getDice(),this._mod=e.getMod()}clone(){return new o(this._num,this._dice,this._mod)}equals(e){let t=this._num===e.getNum();return t=(t=t&&this._dice===e.getDice())&&this._mod===e.getMod()}toJSON(){return[this._num,this._dice,this._mod]}}o.DIE_RE=/\s*(\d+)d(\d+)\s*(\+|-)?\s*(\d+)?/,o.DIE_NUMBER=/^\s*(-?\d+)\s*$/,t.Dice=o,o.RNG=new a.Random((new Date).getTime())},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(26),i=n(22),l=n(15),c=r(n(45)),u=n(68);class h{static createLevel(e,t,n,s){return(new h).createLevel(e,t,n,s)}constructor(){this._verif=new c.Conf("FactoryLevel")}createLevel(e,t,n,s){const r=new o.MapGenerator;let l=null;const c=new i.Level;if(r.setGen(e,t,n),"empty"===e?l=r.createEmptyMap():"town"===e?(l=r.createTownBSP(t,n,s),c.setMap(l.map),this.createHouseElements(c,l),this.createShops(c,l,s),this.createTrainers(c,s)):"townwithwall"===e?(l=r.createTownWithWall(t,n,s),c.setMap(l.map),this.createHouseElements(c,l),this.createShops(c,l,s),this.createTrainers(c,s)):l="forest"===e?r.createForest(s):"lakes"===e?r.createLakes(s):"mountain"===e?r.createMountain(t,n,s):"summit"===e?r.createSummit(t,n,s):"crypt"===e?r.createCryptNew(t,n,s):"cave"===e?r.createCave(t,n,s):"castle"===e?r.createCastle(t,n,s):"wall"===e?r.createWall(t,n,s):"arctic"===e?r.createArctic(t,n,s):r.getMap(),l)c.setMap(l.map);else{const t=JSON.stringify(s);a.default.err("FactoryBase","createLevel",`mapObj is null. type: ${e}. ${t}`)}return this.setLevelExtras(c,l),c}setLevelExtras(e,t){const n={};["rooms","corridors","vaults","houses","paths"].forEach(e=>{t.hasOwnProperty(e)&&(n[e]=t[e])}),e.setExtras(n)}createHouseElements(e,t){if(!t.hasOwnProperty("houses"))return;const n=t.houses;for(let t=0;t<n.length;t++){const s=n[t].door,r=new l.ElementDoor(!0);e.addElement(r,s[0],s[1])}}createShops(e,t,n){this._verif.verifyConf("createShops",n,["nShops"]);const s=new u.DungeonPopulate;e.addExtras("houses",t.houses),s.createShops(e,n)}createTrainers(e,t){(new u.DungeonPopulate).createTrainers(e,t)}}t.FactoryLevel=h},function(e,t,n){e.exports={default:n(373),__esModule:!0}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=!("undefined"==typeof window||!window.document||!window.document.createElement),e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(40),i=r(n(25)),l=r(n(103)),c=n(52),u=n(18),h=n(30),d=u.EventPool.getPool();t.Item={};class p extends c.Entity{constructor(e){super(),this.isOwnable=!0,this._owner=null,this._name=e,this.isUsable=!1,this.add(new i.Typed(a.default.ITEM.BASE,a.default.TYPE_ITEM)),this.add(new i.Item),this.add(new i.Physical)}setOwner(e){a.default.isNullOrUndef([e])?a.default.err("ItemBase","setOwner","Owner cannot be null."):this._owner=e}getTopOwner(){let e=this._owner;for(;e.getOwner;)e=e.getOwner();return e}getOwner(){return this._owner}getX(){return this._owner?this._owner.getX():null}getY(){return this._owner?this._owner.getY():null}getXY(){return this._owner?this._owner.getXY():null}getLevel(){return this._owner?this._owner.getLevel():null}setName(e){this._name=e}getName(){return this._name}setWeight(e){this.get("Physical").setWeight(e)}getWeight(){return this.get("Physical").getWeight()}setValue(e){this.get("Item").setValue(e)}getValue(){return this.get("Item").getValue()}incrCount(e){this.get("Item").incrCount(e)}decrCount(e){this.get("Item").decrCount(e)}getCount(){return this.get("Item").getCount()}setCount(e){this.get("Item").setCount(e)}getType(){return this.get("Typed").getObjType()}setType(e){return this.get("Typed").setObjType(e)}getPropType(){return this.get("Typed").getPropType()}setPropType(e){return this.get("Typed").setPropType(e)}setDamageType(e){this.get("Item").setDamageType(e)}getDamageType(){return this.get("Item").getDamageType()}getNameWithCount(){return`${this.getName()} (x${this.getCount()})`}toString(){let e=this.getName()+", "+this.getType()+", ";return e+=(this.getWeight()*this.getCount()).toFixed(2)+"kg",e=this.getCount()+" x "+e,this.has("GemBound")&&(e+=" (Bound)"),this.has("Stats")&&(e+=" "+this.get("Stats").toString()),e}copy(e){this.setName(e.getName()),this.setType(e.getType()),this.setWeight(e.getWeight()),this.setValue(e.getValue()),e.useArgs&&(this.useArgs=e.useArgs),e.isUsable&&(this.useItem=e.useItem.bind(this)),Object.values(e.getComponents()).forEach(e=>{this.add(e.clone())})}useItem(e){return!1}clone(){const e=new p(this.getName());return e.copy(this),e}equals(e){if(this.getType()!==e.getType())return!1;if(this.getID()===e.getID())return!0;let t=this.getName()===e.getName();return t=(t=t&&this.getWeight()===e.getWeight())&&!(this.has("GemBound")||e.has("GemBound"))}toJSON(){const e={setID:this.getID(),setName:this.getName(),setType:this.getType(),isUsable:this.isUsable};return e.components=o.compsToJSON(this),e}}t.ItemBase=p,t.Item.Base=p;class f extends p{constructor(e){super(e),this.setType(a.default.ITEM.FOOD),this._energy=0,this.isUsable=!0}setEnergy(e){this._energy=e}getEnergy(){return this._energy}useItem(e){if(e.hasOwnProperty("target")){const t=e.target;if(t.hasActors()){const e=t.getProp("actors")[0];if(e.has("Hunger")){let t=this.getConsumedEnergy();if(e.has("NourishedOne")&&(t*=3),e.get("Hunger").addEnergy(t),1===this.getCount()){const t={item:this};d.emitEvent(a.default.EVT_DESTROY_ITEM,t),a.default.gameMsg(e.getName()+" consumes "+this.getName())}else this.decrCount(1);return!0}a.default.gameWarn(e.getName()+" is not interested in eating.")}else a.default.gameWarn("There's no one to give food to.")}else a.default.err("ItemFood","useItem","No target given in obj.");return!1}getConsumedEnergy(){return Math.round(this.getWeight()*this._energy/.1)}toJSON(){const e=super.toJSON();return e.setEnergy=this.getEnergy(),e}clone(){const e=new t.Item.Food(this.getName());return e.copy(this),e.setEnergy(this.getEnergy()),e}}t.Food=f,t.Item.Food=f;class m extends p{constructor(e){super(e),this.setType(a.default.ITEM.CORPSE)}setActorName(e){this.actorName=e}getActorName(){return this.actorName}}t.Corpse=m,t.Item.Corpse=m;class g extends(l.Damage(p)){constructor(e){super(e),this.setType(a.default.ITEM.WEAPON),this._weaponType=""}copy(e){super.copy(e),this._weaponType=e.getWeaponType()}clone(){const e=new g(this.getName());return e.copy(this),e}setWeaponType(e){this._weaponType=e}getWeaponType(){return this._weaponType}toJSON(){const e=super.toJSON();return e.setWeaponType=this._weaponType,e}}t.Weapon=g,t.Item.Weapon=g;class y extends g{constructor(e){super(e),this.setType(a.default.ITEM.MISSILE_WEAPON),this._fireRate=1}setFireRate(e){this._fireRate=e}getFireRate(){return this._fireRate}copy(e){super.copy(e),this.setFireRate(e.getFireRate())}clone(){const e=new y(this.getName());return e.copy(this),e}equals(e){return!!super.equals(e)&&this._fireRate===e.getFireRate()}toJSON(){const e=super.toJSON();return e.setFireRate=this._fireRate,e}}t.MissileWeapon=y,t.Item.MissileWeapon=y;class v extends g{constructor(e){super(e),this.setType(a.default.ITEM.AMMUNITION),this.add(new i.Ammo),this._ammoType=""}setAmmoType(e){this._ammoType=e}getAmmoType(){return this._ammoType}copy(e){super.copy(e),this.setAmmoType(e.getAmmoType())}clone(){const e=new v(this.getName());return e.copy(this),e}equals(e){return!!super.equals(e)&&this._ammoType===e.getAmmoType()}toJSON(){const e=super.toJSON();return e.setAmmoType=this._ammoType,e}}t.Ammo=v,t.Item.Ammo=v;class _ extends(l.Defense(p)){constructor(e){super(e),this.setType(a.default.ITEM.ARMOUR),this._armourType=null}setArmourType(e){this._armourType=e}getArmourType(){return this._armourType}copy(e){super.copy(e),this.setArmourType(e.getArmourType())}clone(){const e=new _(this.getName());return e.copy(this),e}equals(e){let t=super.equals(e);return t=t&&this._armourType===e.getArmourType()}toJSON(){const e=super.toJSON();return e.setArmourType=this.getArmourType(),e}}t.Armour=_,t.Item.Armour=_;class b extends p{constructor(e){super(e),this.setType(a.default.ITEM.POTION),this.isUsable=!0}useItem(e){if(e.hasOwnProperty("target")){const t=e.target;if(t.hasActors()){const e=t.getProp("actors")[0],n=new h.Dice(1,10,2).roll();if(e.has("Health")){e.get("Health").addHP(n);const t=this.getOwner().getOwner(),s=new i.UseItem;return s.setTarget(e),s.setItem(this),s.setUseType(a.default.USE.DRINK),t.add(s),!1}}else a.default.gameWarn("Cannot see anyone there for using the potion.")}else a.default.err("ItemPotion","useItem","No target given in obj.");return!1}clone(){const e=new t.Item.Potion(this.getName());return e.copy(this),e}}t.Potion=b,t.Item.Potion=b;class E extends p{constructor(e){super(e),this.setType(a.default.ITEM.RUNE),this._charges=1}getCharges(){return this._charges}setCharges(e){this._charges=e}clone(){const e=new E(this.getName());return e.copy(this),e}copy(e){super.copy(e),this.setCharges(e.getCharges())}equals(e){let t=super.equals(e);return!!e.getCharges&&(t=t&&this.getCharges()===e.getCharges())}toString(){let e=super.toString();return e+=` charges: ${this.getCharges()}`}toJSON(){const e=super.toJSON();return e.setCharges=this.getCharges(),e}}t.Rune=E,t.Item.Rune=E;class S extends g{constructor(e){super(e),this.setType(a.default.ITEM.MISSILE)}clone(){const e=new S(this.getName());return e.copy(this),e}}t.Missile=S,t.Item.Missile=S;class C extends p{constructor(e){super("container"),this.setOwner(e),this._items=[],this._iter=0,this._removedItem=null}_addItem(e){let t=!1;for(let n=0;n<this._items.length;n++)if(this._items[n].equals(e)){this._items[n].incrCount(e.getCount()),t=!0;break}t||(e.setOwner(this),this._items.push(e))}getWeight(){let e=0;for(let t=0;t<this._items.length;t++)e+=this._items[t].getWeight()*this._items[t].getCount();return e}addItem(e){if(e.getCount()<=0){const t=JSON.stringify(e);a.default.warn("Container","addItem",`Possible bug. Tried to add item with count 0: ${t}`)}"container"===e.getType()?this.getOwner()!==e?this._addItem(e):a.default.err("Item","addItem","Added item is container's owner. Impossible."):this._addItem(e)}getItems(){return this._items.slice()}hasItemRef(e){return-1!==this._items.indexOf(e)}hasItem(e){if(this.hasItemRef(e))return!0;return this._getMatchingItemIndex(e)>=0}removeItem(e){return this.hasItem(e)?this._removeItem(e):(this._removedItem=null,!1)}_getMatchingItemIndex(e){for(let t=0;t<this._items.length;t++)if(e.equals(this._items[t]))return t;return-1}_removeItem(e){const t=this._getMatchingItemIndex(e);return-1===t?(a.default.err("ItemContainer","_removeItem","Negative index found. Horribly wrong."),!1):(1===this._items[t].getCount()?(this._removedItem=e,this._items.splice(t,1)):(this._removedItem=a.default.removeStackedItems(this._items[t],1),0===this._items[t].getCount()&&this._items.splice(t,1)),!0)}getRemovedItem(){return this._removedItem}removeNItems(e,t){let n=0;for(;n<t&&this.removeItem(e);)++n;return null===this._removedItem?(a.default.err("ItemContainer","removeNItems","this._removedItem was null. It should be a valid item."),!1):(this._removedItem.setCount(n),n>0)}first(){return this._items.length>0?(this._iter=1,this._items[0]):null}next(){return this._iter<this._items.length?this._items[this._iter++]:null}last(){return this._items[this._items.length-1]}isEmpty(){return 0===this._items.length}toString(){let e="Container: "+this.getName()+"\n";const t=this.getItems();for(let n=0;n<t.length;n++)e+=t[n].toString()+"\n";return e}toJSON(){const e=[],t=this.getItems();for(let n=0;n<t.length;n++)e.push(t[n].toJSON());return e}}t.Container=C,t.Item.Container=C;class w extends p{constructor(e){super(e),this.setType(a.default.ITEM.GOLD),this._purity=1}getPurity(){return this._purity}setPurity(e){this._purity=e}toJSON(){const e=super.toJSON();return e.setType=this.getType(),e.setPurity=this._purity,e}}t.Gold=w,t.Item.Gold=w;class T extends w{constructor(e){super(e||a.default.GOLD_COIN_NAME),this.setType(a.default.ITEM.GOLD_COIN),this._purity=1,this.setWeight(.03)}}t.GoldCoin=T,t.Item.GoldCoin=T;class O extends p{constructor(e){super(e),this.setType(a.default.ITEM.SPIRITGEM),this._spirit=null,this._hasSpirit=!1}getArmourType(){return this.getType()}hasSpirit(){return this._hasSpirit}getSpirit(){return this._spirit}setSpirit(e){this._hasSpirit?a.default.err("Item.SpiritGem","setSpirit","Tried to overwrite spirit"):(this._hasSpirit=!0,this._spirit=e)}useItem(e){const t=this.getOwner().getOwner();if(t){const n=new i.SpiritBind;return n.setTarget(e.target),n.setBinder(t),this.add(n),!0}{const t=`binder is null. obj: ${JSON.stringify(e)}`;a.default.err("Item.SpiritGem","useItem",t)}return!1}clone(){const e=new O(this.getName());return e.copy(this),e}copy(e){super.copy(e),e.hasSpirit()&&this.setSpirit(e.getSpirit())}equals(e){let t=super.equals(e);return t=t&&this.getSpirit()===e.getSpirit()}toString(){let e=super.toString();if(this.hasSpirit()){const t=this.getSpirit().get("Stats");e+="("+this.getSpirit().getName()+")",e+=" Str: "+t.getStrength(),e+=" Agi: "+t.getAgility(),e+=" Acc: "+t.getAccuracy(),e+=" Wil: "+t.getWillpower()}else e+="(Empty)";return e}toJSON(){const e=super.toJSON();return e.hasSpirit=this.hasSpirit(),e.hasSpirit&&(e.setSpirit=this.getSpirit().toJSON()),e}}t.SpiritGem=O,t.Item.SpiritGem=O;for(let e=0;e<a.default.GET_STATS.length;e++)O.prototype[a.default.GET_STATS[e]]=function(){return(()=>{const t=a.default.GET_STATS[e];return this._hasSpirit?this._spirit.get("Stats")[t]():0})()};class M extends p{constructor(e){super(e),this.setType(a.default.ITEM.MINERAL)}}t.Mineral=M,t.Item.Mineral=M;class A extends p{constructor(e){super(e),this.setType(a.default.ITEM.BOOK),this.text=[],this.metaData={}}addMetaData(e,t){this.metaData.hasOwnProperty[e]||(this.metaData[e]=[]),this.metaData[e].push(t)}setMetaData(e){this.metaData=e}getMetaData(e){return this.metaData[e]}useItem(){const e=this.getTopOwner();if(e){const t=new i.Read;return t.setReadTarget(this),e.add(t),!0}return!1}getText(){return this.text}addText(e){this.text.push(e)}setText(e){this.text=e}clone(){const e=new A(this.getName());return e.copy(this),e}copy(e){super.copy(e);const t=e.getText().slice();this.setText(t),this.metaData=JSON.parse(JSON.stringify(e.metaData))}equals(e){return this.getID()===e.getID()}toJSON(){const e=super.toJSON();return e.setText=this.text,e.setMetaData=this.metaData,e}}t.Book=A,t.Item.Book=A},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(23)),a=s(n(8)),o=n(136),i=n(15),l=n(19),c=new i.ElementBase("floor"),u=new i.ElementWall("wall");class h{static invertMap(e){for(let t=0;t<e.cols;t++)for(let n=0;n<e.rows;n++){const s=e._map[t][n].getBaseElem().getType();"wall"===s?e._map[t][n].setBaseElem(c):"floor"===s&&e._map[t][n].setBaseElem(u)}}static createWithoutCells(e,t){const n=new h(0,0);n._map=new Array(e);for(let s=0;s<e;s++)n._map[s]=new Array(t);return n.cols=e,n.rows=t,n}constructor(e,t,n=c){this._map=[],this.cols=e,this.rows=t,"number"==typeof this.cols&&"number"==typeof this.rows||a.default.err("Map.CellList","constructor","Map.CellList(rows, cols) expects 2 integers."),this._map=new Array(this.cols);for(let e=0;e<this.cols;e++){this._map[e]=new Array(this.rows);for(let t=0;t<this.rows;t++)this._map[e][t]=new o.Cell(e,t,n)}this.fov=new r.default.FOV.RecursiveShadowcasting(this.lightPasses.bind(this)),this.passableCallback=this.passableCallback.bind(this),this.passableCallbackFlying=this.passableCallbackFlying.bind(this)}hasXY(e,t){return e>=0&&e<this.cols&&t>=0&&t<this.rows}setProp(e,t,n,s){this._map[e][t].setProp(n,s)}removeProp(e,t,n,s){return this._map[e][t].removeProp(n,s)}moveProp(e,t,n,s){return!!this.removeProp(e[0],e[1],n,s)&&(this.setProp(t[0],t[1],n,s),!0)}setElemXY(e,t,n){this.setProp(e,t,a.default.TYPE_ELEM,n)}setBaseElemXY(e,t,n){this._map[e][t].setBaseElem(n)}getBaseElemXY(e,t){return this._map[e][t].getBaseElem()}getCell(e,t){return this._map[e][t]}isExplored(e,t){return this._map[e][t].isExplored()}getBaseElemRow(e){const t=[];for(let n=0;n<this.cols;++n)t.push(this._map[n][e].getBaseElem());return t}getCellRow(e){const t=[];for(let n=0;n<this.cols;++n)t.push(this._map[n][e]);return t}getFree(){const e=[];for(let t=0;t<this.cols;t++)for(let n=0;n<this.rows;n++)this._map[t][n].isFree()&&e.push(this._map[t][n]);return e}getFreeNotOnEdge(){return this.getFree().filter(e=>e._x>0&&e._x<this.cols-1&&e._y>0&&e._y<this.rows-1)}getFirstFreeFromRight(e=0,t=this.rows-1){for(let n=this.cols-1;n>=0;n--)for(let s=e;s<=t;s++)if(this._map[n][s].isFree())return this._map[n][s];return null}getFreeInBbox(e){const t=[];for(let n=e.ulx;n<=e.lrx;n++)for(let s=e.uly;s<e.lry;s++)this._map[n][s].isFree()&&t.push(this._map[n][s]);return t}getEmptyCells(){const e=[];for(let t=0;t<this.cols;t++)for(let n=0;n<this.rows;n++)this._map[t][n].hasProps()||e.push(this._map[t][n]);return e}lightPasses(e,t){return!!this.hasXY(e,t)&&this._map[e][t].lightPasses()}hasObstacle(e,t){return!!this.hasXY(e,t)&&this._map[e][t].hasObstacle()}isPassable(e,t){return!!this.hasXY(e,t)&&this._map[e][t].isPassable()}isPassableByAir(e,t){return!!this.hasXY(e,t)&&this._map[e][t].isPassableByAir()}getVisibleCells(e){const t=[],[n,s]=e.getXY(),r=e.getFOVRange();return e.isLocated()&&e.getLevel().getMap()===this&&this.fov.compute(n,s,r,(e,n,s,r)=>{r&&this.hasXY(e,n)&&t.push(this._map[e][n])}),t}getExploredCells(){const e=[];for(let t=0;t<this.cols;t++)for(let n=0;n<this.rows;n++)this._map[t][n].isExplored()&&e.push(this._map[t][n]);return e}exploreAll(e=!0){for(let t=0;t<this.cols;t++)for(let n=0;n<this.rows;n++)this._map[t][n]._explored=e}isBorderXY(e,t){return 0===e||(0===t||(e===this.cols-1||t===this.rows-1))}debugPrintInASCII(){let e="";for(let t=0;t<this.rows;t++){let n="";for(let e=0;e<this.cols;e++){const s=this._map[e][t],r=s.getBaseElem();if(!r){n+="X";continue}const a=r.getType();if(s.hasActors())s.getFirstActor().isPlayer()?n+="@":n+="A";else if(s.hasItems())n+="I";else if(null!==s.getStairs())n+=">";else if(s.hasConnection())n+="c";else if(s.hasElements()){const e=s.getElements()[0];if("marker"===e.getType()){n+=e.char}else"door"===e.getType()?n+="+":n+="E"}else/floor/.test(a)?n+=".":/water|chasm|lava/.test(a)?n+="~":/wall/.test(a)?n+="#":/tree/.test(a)?n+="T":/grass/.test(a)?n+='"':/highrock/.test(a)?n+="^":/road/.test(a)?n+="R":/arctic/.test(a)?n+=".":n+="?"}e+=n+"\n"}a.default.diag(e)}getCellRowFast(e){return this._isRowOptimized||this._optimizeForRowAccess(),this._rowMap[e]}findObj(e){let t=[];for(let n=0;n<this.cols;n++)for(let s=0;s<this.rows;s++)t=t.concat(this._map[n][s].findObj(e));return t}getCells(e=(e=>!0)){const t=[];for(let n=0;n<this.cols;n++)for(let s=0;s<this.rows;s++)e(this._map[n][s])&&t.push(this._map[n][s]);return t}getCellsWithCoord(e){const t=[];return e.forEach(e=>{this.hasXY(e[0],e[1])&&t.push(this._map[e[0]][e[1]])}),t}setBaseElems(e,t){e.forEach(e=>{this._map[e[0]][e[1]].setBaseElem(t)})}has(e,t){const[n,s]=e;if(this.hasXY(n,s)){const e=this.getCell(n,s);if("string"==typeof t){if(e.getBaseElem().getType()===t)return!0}}return!1}_optimizeForRowAccess(){this._rowMap=[];for(let e=0;e<this.rows;e++){this._rowMap[e]=[];for(let t=0;t<this.cols;t++)this._rowMap[e][t]=this._map[t][e]}this._isRowOptimized=!0}toJSON(){const e=new Array(this.cols),t={},n=[],s={};for(let r=0;r<this.cols;r++){e[r]=new Array(this.rows);for(let a=0;a<this.rows;a++){const o=this.getCell(r,a).toJSON();e[r][a]=o.t,s[o.t]=0,o.ex&&n.push([r,a]),o.elements&&(t[r+","+a]=t)}}return{cols:this.cols,rows:this.rows,cells:e,explored:n,elements:t,baseTypes:s}}toJSONEncoded(){const e=this.toJSON(),{cells:t,baseTypes:n}=e;for(let e=0;e<this.cols;e++)for(let s=0;s<this.rows;s++)n[t[e][s]]+=1;let s=-1,r=0;Object.keys(n).forEach(e=>{n[e]>r&&(r=n[e],s=parseInt(e,10))});const a={};for(let e=0;e<this.cols;e++)for(let n=0;n<this.rows;n++)t[e][n]!==s&&(a[e]||(a[e]=[]),a[e].push([n,t[e][n]]));return delete e.cells,e.defaultType=s,e.cellsXY=a,e.encoded=!0,e}getShortestPathTo(e,t,n){const[s,a]=e.getXY();let o=this.passableCallback.bind(null,s,a);e.has("Flying")&&(o=this.passableCallbackFlying.bind(null,s,a));const i=new r.default.Path.AStar(t,n,o),l=[];return i.compute(s,a,(e,t)=>{this.hasXY(e,t)&&l.push(this._map[e][t])}),l}getShortestPathCached(e,t,n){return[]}passableCallback(e,t,n,s){let r=this.isPassable(n,s);return r||(r=n===e&&s===t),r}passableCallbackFlying(e,t,n,s){let r=this.isPassableByAir(n,s);return r||(r=n===e&&s===t),r}moveCellUnsafe(e,t,n){n.setXY([e,t]),this._map[e][t]=n}}t.CellMap=h,h.fromJSON=function(e){if(e.encoded){const{defaultType:t}=e,n=l.ELEM_MAP.elemIndexToElemObj[t],s=new h(e.cols,e.rows,n);return Object.keys(e.cellsXY).forEach(t=>{const n=e.cellsXY[t],r=parseInt(t,10);n.forEach(e=>{const t=l.ELEM_MAP.elemIndexToElemObj[e[1]];s.setBaseElemXY(r,e[0],t)})}),e.explored.forEach(e=>{const[t,n]=e;s._map[t][n].setExplored()}),s}}},function(e,t){var n=e.exports={version:"2.5.3"};"number"==typeof __e&&(__e=n)},function(e,t,n){var s=n(146)("wks"),r=n(110),a=n(48).Symbol,o="function"==typeof a;(e.exports=function(e){return s[e]||(s[e]=o&&a[e]||(o?a:r)("Symbol."+e))}).store=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return e&&e.ownerDocument||document},e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s,r=n(375),a=(s=r)&&s.__esModule?s:{default:s};t.default=(0,a.default)({shouldComponentUpdate:function(){return!this._notifying}},function(e,t,n,s,r){n&&(e._notifying=!0,n.call.apply(n,[e,s].concat(r)),e._notifying=!1),e._values[t]=s,e.unmounted||e.forceUpdate()}),e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8));n(83),t.C={ID:{},ID2TYPE:{}},t.Component={},t.Component.createdCompDecls={},t.NO_SERIALISATION=(()=>null),t.Component.NO_SERIALISATION=t.NO_SERIALISATION;const a=new Set(["description"]);let o=1;function i(e,t){a.forEach(n=>{t.hasOwnProperty(n)&&(e[n]=t[n])})}function l(e,n){t.Component.hasOwnProperty(e)?r.default.err("Component","addCompDecl",`Comp ${e} exists already!`):(t.Component[e]=n,t.C.ID[e]=o++,t.C.ID2TYPE[t.C.ID[e]]=e)}function c(e){t.Component.createdCompDecls[e]&&r.default.err("Component","Tag/DataComponent",`Duplicate decl: ${e}`)}function u(e){return t.Component.idCount=e}t.TagComponent=function(e,n={}){c(e);const s=function(){t.ComponentBase.call(this,e),Object.keys(n).forEach(e=>{a.has(e)||(this[e]=n[e])})};return r.default.extend2(s,t.ComponentBase),t.Component.createdCompDecls[e]=s,i(s,n),l(e,s),s},t.Component.TagComponent=t.TagComponent,t.DataComponent=((e,n,s={})=>{if(c(e),"string"!=typeof e){const t=JSON.stringify(e);r.default.err("component.base.js","DataComponent: NO TYPE GIVEN","First arg must be string! Got: |"+t+"|")}("object"!=typeof n||Array.isArray(n))&&r.default.err("component.base.js",`DataComponent: ${e}`,"Members must be given as key/value pairs.");const a=function(...r){t.ComponentBase.call(this,e),Object.keys(s).forEach(e=>{this[e]=s[e]}),Object.keys(n).forEach(e=>{r&&r[0]&&r[0].hasOwnProperty(e)?this[e]=r[0][e]:"object"==typeof n[e]?this[e]=JSON.parse(JSON.stringify(n[e])):this[e]=n[e]}),this._init&&"function"==typeof this._init&&this._init(...r)};return r.default.extend2(a,t.ComponentBase),Object.keys(n).forEach(n=>{t.ComponentBase.prototype.hasOwnProperty(n)&&r.default.err("component.js",`DataComponent: ${e}`,`${n} is reserved in Base`);const s=function(e){return"set"+e.capitalize()}(n);t.ComponentBase.prototype.hasOwnProperty(s)&&r.default.err("component.js",`DataComponent: ${e}`,`${s} is reserved in Base`),a.prototype[s]=function(e){this[n]=e};const o=function(e){return"get"+e.capitalize()}(n);t.ComponentBase.prototype.hasOwnProperty(s)&&r.default.err("component.js",`DataComponent: ${e}`,`${o} is reserved in Base`),a.prototype[o]=function(){return this[n]}}),s.objRefs&&(a.prototype.objRefs=Object.freeze(s.objRefs)),a.prototype.members=Object.freeze(n),i(a,s),t.Component.createdCompDecls[e]=a,l(e,a),a}),t.Component.DataComponent=t.DataComponent,t.UniqueTagComponent=((e,n={})=>t.TagComponent(e,Object.assign({_isUnique:!0},n))),t.Component.UniqueTagComponent=t.UniqueTagComponent,t.UniqueDataComponent=((e,n,s={})=>t.DataComponent(e,n,Object.assign({_isUnique:!0},s))),t.Component.UniqueDataComponent=t.UniqueDataComponent,t.TransientTagComponent=((e,n={})=>t.TagComponent(e,Object.assign({toJSON:t.NO_SERIALISATION},n))),t.Component.TransientTagComponent=t.TransientTagComponent,t.TransientDataComponent=((e,n,s={})=>t.DataComponent(e,n,Object.assign({toJSON:t.NO_SERIALISATION},s))),t.Component.TransientDataComponent=t.TransientDataComponent,t.UniqueTransientDataComponent=((e,n,s={})=>t.DataComponent(e,n,Object.assign({_isUnique:!0,toJSON:t.NO_SERIALISATION},s))),t.Component.UniqueTransientDataComponent=t.UniqueTransientDataComponent,t.compsToJSON=(e=>{const t={},n=e.getComponents();return Object.keys(n).forEach(e=>{const s=n[e].toJSON();s&&(t[e]=s)}),t}),t.Component.compsToJSON=t.compsToJSON,t.Component.idCount=0,t.getIDCount=function(){return t.Component.idCount},t.setIDCount=u,t.Component.setIDCount=u,t.ComponentBase=function(e){this._type=e,this._entity=null,this._id=t.Component.idCount++,this._isUnique=!1,this._onAddCallbacks=[],this._onRemoveCallbacks=[]},t.Component.ComponentBase=t.ComponentBase,t.ComponentBase.prototype.getID=function(){return this._id},t.ComponentBase.prototype.setID=function(e){this._id=e},t.ComponentBase.prototype.getEntity=function(){return this._entity},t.ComponentBase.prototype.setEntity=function(e){null===this._entity&&null!==e?this._entity=e:null===e?this._entity=null:r.default.err("Base","setEntity","Entity already set.")},t.ComponentBase.prototype.changeEntity=function(e){r.default.isNullOrUndef([this._entity])?r.default.err("Base","changeEntity","No entity set. Use setEntity() instead of changeEntity()"):(this._entity.remove(this.getID()),e.add(this))},t.ComponentBase.prototype.isUnique=function(){return this._isUnique},t.ComponentBase.prototype.getType=function(){return this._type},t.ComponentBase.prototype.setType=function(e){this._type=e},t.ComponentBase.prototype.entityAddCallback=function(e){this.setEntity(e);for(let e=0;e<this._onAddCallbacks.length;e++)this._onAddCallbacks[e]()},t.ComponentBase.prototype.entityRemoveCallback=function(){for(let e=0;e<this._onRemoveCallbacks.length;e++)this._onRemoveCallbacks[e]();this.setEntity(null)},t.ComponentBase.prototype.addCallback=function(e,t){"onAdd"===e?this._onAddCallbacks.push(t):"onRemove"===e?this._onRemoveCallbacks.push(t):r.default.err("Base","addCallback","CB name "+e+" must be onAdd/onRemove")},t.ComponentBase.prototype.removeCallbacks=function(e){"onAdd"===e?this._onAddCallbacks=[]:"onRemove"===e?this._onRemoveCallbacks=[]:(this._onAddCallbacks=[],this._onRemoveCallbacks=[])},t.ComponentBase.prototype.clone=function(){const e=this.getType();if(t.Component.hasOwnProperty(e)){const n=new t.Component[e];return n.copy(this),n}return r.default.err("Base","clone",`No type |${e}| in Component.`),null},t.ComponentBase.prototype.copy=function(e){for(const t in this)if(/^get/.test(t)){const n=t;if("getEntity"!==n&&"getID"!==n){const t=n.replace("get","set");if("function"==typeof e[n]&&"function"==typeof this[t]){const s=e[n]();this[t](s)}}}},t.ComponentBase.prototype.equals=function(e){return this.getType()===e.getType()},t.ComponentBase.prototype.is=function(e){return t.Component[e]||r.default.err("ComponentBase","is",`Unknown type: ${e}`),this._type===e},t.ComponentBase.prototype.toString=function(){return"Component: "+this.getType()},t.ComponentBase.prototype.toJSON=function(){const e={};for(const t in this)if(/^get/.test(t)){const n=t;if("getEntity"!==n&&"function"==typeof this[n]){const t=n.replace("get","set");"function"==typeof this[t]&&(e[t]=this[n]())}}return e},t.Component.Base=t.ComponentBase,t.createFromObj=function(e,n){if(t.Component[e]){const s=new t.Component[e];return n.forEach(e=>{e.setter&&e.value?s[e.setter](e.value):Object.keys(e).forEach(t=>{const n=e[t];s[t](n)})}),s}return r.default.err("Component","createFromObj",`Comp type |${e}| does not exist. Args: ${n}`),null},t.Component.createFromObj=t.createFromObj,t.create=function(e,...n){return t.Component[e]?new t.Component[e](...n):(r.default.err("Component","create",`Comp type |${e}| does not exist.`),null)},t.Component.create=t.create,t.defineComponent=function(e,n){if(!t.Component.hasOwnProperty(e)){return t.DataComponent(e,n)}return r.default.err("Component","defineComponent",`Component ${e} already defined`),null},t.Component.defineComponent=t.defineComponent,t.undefineComponent=function(e){delete t.Component.createdCompDecls[e],delete t.Component[e]},t.Component.undefineComponent=t.undefineComponent},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=n(17)("bitn:world"),o=s(n(8)),i=r(n(15)),l=n(18),c=n(9),u=n(31),h=r(n(11)),d=n(52),p=l.EventPool.getPool(),f=i.ElementStairs;t.World={};const m=c.Random.getRNG(),g={east:"west",north:"south",south:"north",west:"east"};function y(e,t,n){const s=e.getMap().getCell(t,n);if(s.hasConnection()){const r=s.getConnection();a(`world.js Removing conn@${t},${n}`),e.removeElement(r,t,n)||o.default.err("world.ts","removeExistingConnection",`Failed to remove conn @ ${t}, ${n}`)}}function v(e,t,n){const s=t.find(t=>t.getName()===e);if(s){const t=s.getLevels();if(t.length>n)return t[n];{const s=`Name: ${e}`;o.default.err("world.js","findLevel",`${s} nLev ${n} out of bounds (${t.length-1})`)}}return null}function _(e){let t=e.getFreeRandCell();for(;t.hasConnection();)t=e.getFreeRandCell();return t}function b(e){const t=e.length,n=[],s=[];for(let r=0;r<t;r++){const a=e[r];let o=null;if(a.hasExtras()&&(o=a.getExtras()),r<t-1){const t=e[r+1],s=new f("stairsDown",a,t),i=_(a);let[l,c]=[i.getX(),i.getY()];o&&o.endPoint&&([l,c]=o.endPoint),a.addStairs(s,l,c),n.push(s)}if(r>0){const t=e[r-1],n=new f("stairsUp",a,t),i=_(a);let[l,c]=[i.getX(),i.getY()];o&&o.startPoint&&([l,c]=o.startPoint),a.addStairs(n,l,c),s.push(n)}}for(let e=0;e<t;e++)e<t-1&&n[e].connect(s[e])}function E(e,t,n){let s=t,r=n;return"string"==typeof t&&"string"==typeof n&&(s=e.find(e=>e.getName()===t),r=e.find(e=>e.getName()===n)),[s,r]}function S(e,t){if(null===t)return null;const{x:n,y:s}=t;return e[t.levelNumber].getMap().getCell(n,s).getStairs()}t.addExitsToEdge=((e,t="passage",n="any",s=!1)=>{const r=e.getMap(),a=r.cols,o=r.rows,i=[];for(let l=1;l<o-1;l++){if(("any"===n||"west"===n)&&(r.isPassable(0,l)||s)){const n=new f(t,e);y(e,0,l),s?e.addStairs(n,0,l):e.addElement(n,0,l),i.push(n)}if(("any"===n||"east"===n)&&(r.isPassable(a-1,l)||s)){const n=new f(t,e);y(e,a-1,l),s?e.addStairs(n,a-1,l):e.addElement(n,a-1,l),i.push(n)}}for(let l=1;l<a-1;l++){if(("any"===n||"north"===n)&&(r.isPassable(l,0)||s)){const n=new f(t,e);y(e,l,0),s?e.addStairs(n,l,0):e.addElement(n,l,0),i.push(n)}if(("any"===n||"south"===n)&&(r.isPassable(l,o-1)||s)){const n=new f(t,e);y(e,l,o-1),s?e.addStairs(n,l,o-1):e.addElement(n,l,o-1),i.push(n)}}return i}),t.edgeHasConnections=((e,t)=>{const n=e.getMap(),s=n.cols,r=n.rows;for(let e=1;e<r-1;e++){if(("any"===t||"west"===t)&&n.getCell(0,e).hasConnection())return!0;if(("any"===t||"east"===t)&&n.getCell(s-1,e).hasConnection())return!0}for(let e=1;e<s-1;e++){if(("any"===t||"north"===t)&&n.getCell(e,0).hasConnection())return!0;if(("any"===t||"south"===t)&&n.getCell(e,r-1).hasConnection())return!0}return!1}),t.World.connectLevelsLinear=b,t.World.addExitsToEdge=t.addExitsToEdge,t.World.edgeHasConnections=t.edgeHasConnections;class C extends d.Entity{constructor(e){super(),this.name=e,this.type="base",this.parent=null}getName(){return this.name}getHierName(){return this.hierName}setHierName(e){this.hierName=e}getType(){return this.type}setType(e){this.type=e}getParent(){return this.parent}setParent(e){this.parent=e}toJSON(){const e={hierName:this.hierName,id:this.getID(),name:this.name,type:this.type};return this.parent&&(e.parent=this.parent.getID()),e.components=h.compsToJSON(this),e}}t.WorldBase=C,t.World.Base=C;class w extends C{constructor(e){super(e),this._subZones=[]}getSubZoneArgs(e,t){return E(this._subZones,e,t)}setTileXY(e,t){this.tileX=e,this.tileY=t}getTileXY(){return[this.tileX,this.tileY]}addSubZone(e){return e.getID()===this.getID()&&o.default.err("ZoneBase","addSubZone","Tried to add itself as sub zone: "+this.getName()),!o.default.isNullOrUndef([e])&&(e.setParent(this),this._subZones.push(e),!0)}hasSubZone(e){return this._subZones.indexOf(e)>=0}getLevels(){let e=[];return this._subZones.forEach(t=>{e=e.concat(t.getLevels())}),e}getPlaceEntities(){let e=[this];return this._subZones.forEach(t=>{e.push(t)}),e}connectSubZones(e,t,n,s){!function(e,t,n,s,r){o.default.isNullOrUndef([s,r])&&o.default.err("World","connectSubZones",`l1 (${s}) and l2 (${r}) must be non-null and integers.`);const[a,i]=E(e,t,n);o.default.isNullOrUndef([a,i])&&o.default.err("World","connectSubZones","Cannot connect null subZones. Check the names/refs.");let l=!0;s>r&&(l=!1);const c=new f(l?"stairsDown":"stairsUp"),u=i.getLevels();if(r<u.length){const e=_(u[r]);u[r].addStairs(c,e.getX(),e.getY()),c.setSrcLevel(u[r]),a.connectLevelToStairs(s,c)}else o.default.err("World","connectSubZones","Level "+r+" doesn't exist in sub-zone "+i.getName())}(this._subZones,e,t,n,s)}findLevel(e,t){return v(e,this._subZones,t)}findSubZone(e){return function(e,t){return t.find(t=>t.getName()===e)}(e,this._subZones)}getEntrances(){const e=[];return this._subZones.forEach(t=>{const n=t.getEntrance();n&&e.push(n)}),e}removeListeners(){this._subZones.forEach(e=>{e.removeListeners()})}toJSON(){const e=super.toJSON();return e.x=this.tileX,e.y=this.tileY,e}getID2Place(){const e={[this.getID()]:this};return this._subZones.forEach(t=>{e[t.getID()]=t}),e}}t.ZoneBase=w,t.World.ZoneBase=w;class T extends C{constructor(e){super(e),this._levelFeatures=new Map,this._levels=[],this._levelCount=0}getEntrance(){return S(this._levels,this._entrance)}getLevelN(e){if(e<this._levels.length)return this._levels[e];{const t=this._levels.length;o.default.err("SubZoneBase","getLevels",`No nLevel ${e} found. Max: ${t}`)}return null}getLevels(){return this._levels.slice()}hasLevel(e){return this._levels.indexOf(e)>=0}connectLevelToStairs(e,t){(function(e,t,n){if(t<e.length){const s=e[t],r=n.getSrcLevel();if(!o.default.isNullOrUndef([r])){const e=!n.isDown(),t=new f(e?"stairsDown":"stairsUp",s,r),a=_(s);return s.addStairs(t,a.getX(),a.getY()),t.connect(n),!0}}else o.default.err("world.js","connectLevelToStairs",`nLevel: ${t} out of bounds (${e.length})`);return!1})(this._levels,e,t)||o.default.err("SubZoneBase","connectLevelToStairs","Stairs must be first connected to other level.")}getStairsOther(){return function(e,t){const n=[];return t.forEach(t=>{t.getStairs().forEach(t=>{const s=t.getTargetLevel();if(s&&s.getParent){const r=s.getParent();r&&r.getName()!==e&&n.push(t)}})}),n}(this.getName(),this._levels)}addLevelFeature(e){const t=e.getType();this._levelFeatures.has(t)||(this._levelFeatures[t]=[]),this._levelFeatures[t].push(e)}removeListeners(){}getLevel(e){if(e<this._levels.length)return this._levels[e];{const t=`${this.getType()}, ${this.getName()}`,n=`Has ${this._levels.length} levels`;o.default.err("SubZoneBase","getLevel",`${t}, nLevel: ${e}, ${n}`)}return null}addLevel(e){if(o.default.isNullOrUndef([e]))o.default.err("SubZoneBase","addLevel","Level is not defined.");else if(this.hasLevel(e)){let t="Trying to add existing level. ";t+=" ID: "+e.getID(),o.default.err("SubZoneBase","addLevel",t)}else e.setLevelNumber(this._levelCount++),this._levels.push(e),e.setParent(this)}toJSON(){const e=super.toJSON();return e.nLevels=this._levels.length,e.levels=this._levels.map(e=>e.getID()),e}}t.SubZoneBase=T,t.World.SubZoneBase=T;class O extends T{constructor(e){super(e),this.setType("branch"),this._entrance=null}addEntrance(e){const t=new f("stairsUp");this.setEntrance(t,e)}setEntrance(e,t){if(t<this._levels.length){const n=this._levels[t],s=_(n);let[r,a]=s.getXY();if(n.hasExtras()){const e=n.getExtras();e.startPoint&&([r,a]=e.startPoint)}n.addStairs(e,r,a),this._entrance={levelNumber:t,x:r,y:a}}else o.default.err("World.Branch","setEntrance",`Invalid level number. Must be < ${this._levels.length}`)}setEntranceLocation(e){o.default.isNullOrUndef([e])?o.default.err("World.Branch","setEntranceLocation","Arg entrance is not defined."):this._entrance=e}getEntrance(){return S(this._levels,this._entrance)}connectLevels(){b(this._levels)}toJSON(){const e=super.toJSON(),t={};return this._entrance&&(t.entrance=this._entrance),Object.assign(t,e)}}t.Branch=O,t.World.Branch=O;class M extends w{constructor(e){super(e),this.setType("dungeon"),this._entranceNames=[]}hasBranch(e){return this.hasSubZone(e)}getBranches(){return this._subZones}setEntrance(e){this._entranceNames="string"==typeof e?[e]:e}addBranch(e){return!this.hasBranch(e)&&(this._subZones.push(e),e.setParent(this),1===this._subZones.length&&this.setEntrance(e.getName()),!0)}getEntrances(){const e=[],t=this._subZones.length;for(let n=0;n<t;n++){const t=this._subZones[n];if(this._entranceNames.indexOf(t.getName())>=0){const n=t.getEntrance();o.default.isNullOrUndef([n])||e.push(n)}}return e}toJSON(){const e=super.toJSON(),t={branch:this._subZones.map(e=>e.toJSON()),entranceNames:this._entranceNames,nBranches:this._subZones.length};return Object.assign(t,e)}}t.Dungeon=M,t.World.Dungeon=M;class A{constructor(e,t,n){this._tileX=e,this._tileY=t,this._area=n,this.cols=null,this.rows=null,this._level=null,this.zones={Dungeon:[],Mountain:[],City:[],BattleZone:[]}}getLevel(){return this._level}getTileX(){return this._tileX}getTileY(){return this._tileY}isNorthEdge(){return 0===this._tileY}isSouthEdge(){return this._tileY===this._area.getSizeY()-1}isWestEdge(){return 0===this._tileX}isEastEdge(){return this._tileX===this._area.getSizeX()-1}isEdge(){return!!this.isNorthEdge()||(!!this.isSouthEdge()||(!!this.isWestEdge()||!!this.isEastEdge()))}setLevel(e){this._level=e,this.cols=this._level.getMap().cols,this.rows=this._level.getMap().rows}connect(e,t){const n=this.cols-1,s=this.rows-1;if(!o.default.isNullOrUndef([e])){const t=e.getLevel(),r=this._level.getMap(),a=t.getMap();for(let e=1;e<=s-1;e++){const s=r.getCell(n,e),o=a.getCell(0,e);if(s.isFree()&&o.isFree()){const s=new f("passage",this._level,t),r=new f("passage",t,this._level);s.setTargetStairs(r),r.setTargetStairs(s),this._level.addStairs(s,n,e),t.addStairs(r,0,e)}}}if(!o.default.isNullOrUndef([t])){const e=t.getLevel(),r=this._level.getMap(),a=e.getMap();for(let t=1;t<=n-1;t++){const n=r.getCell(t,s),o=a.getCell(t,0);if(n.isFree()&&o.isFree()){const n=new f("passage",this._level,e),r=new f("passage",e,this._level);n.setTargetStairs(r),r.setTargetStairs(n),this._level.addStairs(n,t,s),e.addStairs(r,t,0)}}}}addZone(e,t){o.default.isNullOrUndef([t.tileX,t.tileY])&&o.default.err("AreaTile","addZone","No tileX/tileY given!"),this.zones[e]||(this.zones[e]=[]),this.zones[e].push(t)}getZones(e){if(e)return this.zones[e];let t=[];return Object.keys(this.zones).forEach(e=>{t=t.concat(this.zones[e])}),t}getLevels(){let e=[this._level];if(Object.keys(this.zones).forEach(t=>{this.zones[t].forEach(t=>{e=e.concat(t.getLevels())})}),a.enabled){let t=this.toString();t=` Tile ${t} has ${e.length} levels from toJSON()`,1344===this._level.getID()&&(t+=`\tLevels: ${e.map(e=>e.getID())}`),console.error(t)}return e}getPlaceEntities(){let e=[];return Object.keys(this.zones).forEach(t=>{this.zones[t].forEach(t=>{e=e.concat(t.getPlaceEntities())})}),e}toString(){let e=`${this._tileX},${this._tileY}, ID: ${this._level.getID()}`;return e+=` nZones: ${this.getZones().length}`}toJSON(){return{x:this._tileX,y:this._tileY,level:this._level.getID(),levels:this.getLevels().map(e=>e.toJSON()),nDungeons:this.zones.Dungeon.length,dungeon:this.getZones("Dungeon").map(e=>e.toJSON()),nMountains:this.zones.Mountain.length,mountain:this.getZones("Mountain").map(e=>e.toJSON()),nCities:this.zones.City.length,city:this.getZones("City").map(e=>e.toJSON()),nBattleZones:this.zones.BattleZone.length,battlezone:this.getZones("BattleZone").map(e=>e.toJSON())}}removeListeners(){Object.values(this.zones).forEach(e=>{e.forEach(e=>{e.removeListeners()})})}}t.AreaTile=A,t.World.AreaTile=A;class N extends C{constructor(e,t,n,s,r,a){super(e),this.setType("area"),this._sizeX=parseInt(t,10),this._sizeY=parseInt(n,10),this._cols=s||30,this._rows=r||30,this._tiles=[],this._conf={},this.zonesCreated={},this.tilesLoaded=[],this._init(a)}getSizeX(){return this._sizeX}getSizeY(){return this._sizeY}isLoaded(e,t){return this.tilesLoaded[e][t]}setLoaded(e,t){this.tilesLoaded[e][t]=!0}setUnloaded(e,t){this.tilesLoaded[e][t]=!1}markAllZonesCreated(){Object.keys(this.zonesCreated).forEach(e=>{this.zonesCreated[e]=!0})}markTileZonesCreated(e,t){this.zonesCreated[e+","+t]=!0}tileHasZonesCreated(e,t){return this.zonesCreated[e+","+t]}getTiles(){return this._tiles}setTile(e,t,n){this._tiles[e][t]=n}setConf(e){this._conf=e}getConf(){return this._conf}_init(e){for(let t=0;t<this._sizeX;t++){const n=[];this.tilesLoaded.push([]);for(let s=0;s<this._sizeY;s++){this.zonesCreated[t+","+s]=!1;const r=new A(t,s,this),a=o.default.getForestConf(this._cols,this._rows);let i=null;if(e)i=e[t][s];else{i=(new u.FactoryLevel).createLevel("forest",this._cols,this._rows,a)}i!==o.default.LEVEL_NOT_LOADED?(this.tilesLoaded[t][s]=!0,i.setParent(this),r.setLevel(i),n.push(r)):(this.tilesLoaded[t][s]=!1,n.push(o.default.TILE_NOT_LOADED))}this._tiles.push(n)}e||this.connectTiles()}connectTiles(){!function(e,t,n){1!==t&&1!==n||o.default.err("world.js","connectTiles","sizeX or sizeY == 1 not implemented.");for(let s=0;s<t;s++)for(let r=0;r<n;r++)a(`Trying to connect tile ${s},${r} now`),s<t-1&&r<n-1?(a(`>> Connecting tile ${s},${r} now`),e[s][r].connect(e[s+1][r],e[s][r+1])):s<t-1?(a(`>> Connecting tile ${s},${r} now`),e[s][r].connect(e[s+1][r],null)):r<n-1&&(a(`>> Connecting tile ${s},${r} now`),e[s][r].connect(null,e[s][r+1]))}(this._tiles,this._sizeX,this._sizeY)}getLevels(){let e=[];for(let t=0;t<this._tiles.length;t++)for(let n=0;n<this._tiles[t].length;n++)this.tilesLoaded[t][n]&&(e=e.concat(this._tiles[t][n].getLevels()));return e}findTileXYById(e){for(let t=0;t<this._tiles.length;t++)for(let n=0;n<this._tiles[t].length;n++)if(this.tilesLoaded[t][n]){const s=this._tiles[t][n].getLevel().getID();try{if(s===e)return[t,n]}catch(e){let s=`Area ${this.getID()} ERROR`;throw s+=`\nFailed to call getLevel for tile ${t},${n}`,s+="Tile as JSON: ', this._tiles[x][y]",console.error(s),new Error(e)}}return this.printLevelIDs(),null}hasTileWithId(e){for(let t=0;t<this._tiles.length;t++)for(let n=0;n<this._tiles[t].length;n++)if(this.tilesLoaded[t][n]){if(this._tiles[t][n].getLevel().getID()===e)return!0}else if(this._tiles[t][n].level===e)return!0;return!1}hasTiles(e){let t=e.length>0;return e.forEach(e=>{if("function"==typeof e.getID)t=t&&this.hasTileWithId(e.getID());else if(Number.isInteger(e))t=t&&this.hasTileWithId(e);else{const t=JSON.stringify(e);o.default.err("Area","hasTiles",`Invalid level given ${t}. Must be Map.Level/ID`)}}),t}getTileXY(e,t){if(e>=0&&e<this.getSizeX()&&t>=0&&t<this.getSizeY())return this._tiles[e][t];{const n=this.getSizeX(),s=this.getSizeY();o.default.err("Area","getTileXY",`Tile x,y (${e}, ${t}) is out of bounds (${n}, ${s}).`)}return null}addZone(e,t){o.default.isNullOrUndef([t.tileX,t.tileY])&&o.default.err("Area","addZone","No tileX/tileY given!"),this._tiles[t.tileX][t.tileY].addZone(e,t),t.setParent(this)}getZones(e){let t=[];for(let n=0;n<this._tiles.length;n++)for(let s=0;s<this._tiles[n].length;s++)this.tilesLoaded[n][s]&&(t=t.concat(this._tiles[n][s].getZones(e)));return t}createAreaConfig(){return{name:this.getName(),maxX:this._sizeX,maxY:this._sizeY}}toJSON(){const e=super.toJSON(),t=[];this._tiles.forEach((e,n)=>{const s=e.map((e,t)=>this.tilesLoaded[n][t]?e.toJSON():e);t.push(s)});const n={isJSON:!0,conf:this.getConf(),maxX:this._sizeX,maxY:this._sizeY,cols:this._cols,rows:this._rows,tiles:t,tilesLoaded:this.tilesLoaded,zonesCreated:this.zonesCreated};return Object.assign(n,e)}forEachTileLoaded(e){for(let t=0;t<this._tiles.length;t++)for(let n=0;n<this._tiles[t].length;n++)this.tilesLoaded[t][n]&&e(t,n,this._tiles[t][n])}forEachTile(e){for(let t=0;t<this._tiles.length;t++)for(let n=0;n<this._tiles[t].length;n++)e(t,n,this._tiles[t][n])}getPlaceEntities(){let e=[this];return this.forEachTileLoaded((t,n,s)=>{e=e.concat(this._tiles[t][n].getPlaceEntities())}),e}printLevelIDs(){const e=[];this.forEachTile((t,n,s)=>{this.tilesLoaded[t][n]?e.push(this._tiles[t][n].getLevel().getID()):e.push(this._tiles[t][n].level)})}printDebugInfo(){const e=[],t=[],n=[];this.forEachTile((s,r,a)=>{a.isJSON?e.push([s,r]):this.tilesLoaded[s][r]?t.push([s,r]):n.push([s,r])});let s=`Area ID ${this.getID()} debug info:\n`;s+=`\t\nTiles as JSON: ${e.join(" | ")}`,s+=`\t\nTiles LOADED: ${t.join(" | ")}`,s+=`\t\nTiles OTHER: ${n.join(" | ")}`,this.printLevelIDs(),console.log("Tile[0][2]: ",this._tiles[0][2]),console.log(s)}}t.Area=N,t.World.Area=N;class P extends w{constructor(e){super(e),this.setType("mountain")}findLevel(e,t){const n=this.getFaces(),s=this.getSummits();let r=v(e,n,t);return r||(r=v(e,s,t)),r}addSummit(e){this.addSubZone(e)}addFace(e){this.addSubZone(e)}getFaces(){return this._subZones.filter(e=>"face"===e.getType())}getSummits(){return this._subZones.filter(e=>"summit"===e.getType())}connectFaceAndSummit(e,t,n,s){const[r,a]=this.getSubZoneArgs(e,t);if("summit"!==a.getType()){const e=a.getType();o.default.err("World.Mountain","connectFaceAndSummit",`Expected 2nd arg summit, got: ${e}`)}!function(e,t){const n=e.level,s=t.level;let r=Math.floor(n.getMap().cols/2),a=e.y();const o=n.getMap();let i=o.getCell(r,a);for(;i.hasConnection();)(r+=1)===o.cols&&(r=0,a>0&&--a),i=o.getCell(r,a);const l=_(s),[c,u]=[l.getX(),l.getY()],h=new f("stairsUp",n,s),d=new f("stairsDown",s,n);h.connect(d),n.addStairs(h,r,a),s.addStairs(d,c,u)}({y:()=>0,level:r.getLevelN(n)},{level:a.getLevelN(s)})}connectSubZones(e,t,n,s){const[r,a]=this.getSubZoneArgs(e,t);if("face"===r.getType()){if("summit"===a.getType())return void this.connectFaceAndSummit(r,a,n,s)}else if("summit"===r.getType()&&"face"===a.getType())return void this.connectFaceAndSummit(a,r,s,n);super.connectSubZones(e,t,n,s)}toJSON(){const e=super.toJSON(),t={nFaces:this.getFaces().length,face:this.getFaces().map(e=>e.toJSON()),nSummits:this.getSummits().length,summit:this.getSummits().map(e=>e.toJSON())};return Object.assign(t,e)}}t.Mountain=P,t.World.Mountain=P;class x extends T{constructor(e){super(e),this.setType("face"),this._entrance=null}setEntrance(e){this._entrance=e}setEntranceLocation(e){o.default.isNullOrUndef([e])?o.default.err("MountainFace","setEntranceLocation","Arg entrance is not defined."):this._entrance=e}getEntrance(){return S(this._levels,this._entrance)}toJSON(){const e=super.toJSON(),t={};return this._entrance&&(t.entrance=this._entrance),Object.assign(t,e)}addEntrance(e){if(null===this._entrance){const t=this._levels[e],n=new f("stairsDown",t),s=t.getMap(),r=Math.floor(s.cols/2);let a=r,o=s.rows-1;for(;!s.getCell(a,o).isFree();)0===a&&(a=r+1),a<=r&&--a,a>r&&++a,a===s.cols-1&&(a=r,--o);t.addStairs(n,a,o),this._entrance={levelNumber:e,x:a,y:o}}else o.default.err("MountainFace","addEntrance","Entrance already added.")}}t.MountainFace=x,t.World.MountainFace=x;class I extends T{constructor(e){super(e),this.setType("summit")}getEntrance(){return null}}t.MountainSummit=I,t.World.MountainSummit=I;class D extends w{constructor(e){super(e),this.setType("city")}getQuarters(){return this._subZones}addQuarter(e){this.addSubZone(e)||o.default.err("World.City","addQuarter",`City ${this.getName()} quarter not defined.`)}abutQuarters(e,n,s,r){return function(e,n,s,r,a){const o=m.arrayGetRand(["north","south","east","west"]),i=g[o],[l,c]=E(e,n,s),u=l.getLevel(r),h=c.getLevel(a),d=t.addExitsToEdge(u,"exit",o,!0),p=t.addExitsToEdge(h,"exit",i,!0);if(0===d.length||0===p.length)return!1;const f=d,y=p,v=f.length,_=y.length,b=v<=_?v:_;for(let e=0;e<b;e++)f[e].connect(y[e]);return!0}(this._subZones,e,n,s,r)}hasQuarter(e){return this.hasSubZone(e)}toJSON(){const e=super.toJSON(),t={nQuarters:this._subZones.length,quarter:this._subZones.map(e=>e.toJSON())};return Object.assign(t,e)}}t.City=D,t.World.City=D;class k extends T{constructor(e){super(e),this.setType("quarter"),this._entrance=null,this._shops=[]}removeListeners(){this._shops.forEach(e=>{e.isAbandoned()||p.removeListener(e)})}addShop(e){this._shops.push(e)}getShops(){return this._shops}setEntranceLocation(e){o.default.isNullOrUndef([e])?o.default.err("CityQuarter","setEntranceLocation","Arg entrance is not defined."):this._entrance=e}getEntrance(){return S(this._levels,this._entrance)}addEntrance(e){if(null===this._entrance){const t=this._levels[e],n=new f("stairsDown",t);t.addStairs(n,1,1),this._entrance={levelNumber:e,x:1,y:1}}else o.default.err("CityQuarter","addEntrance","Entrance already added.")}connectLevels(){b(this._levels)}toJSON(){const e=super.toJSON(),t={shops:this._shops.map(e=>e.toJSON())};return this._entrance&&(t.entrance=this._entrance),Object.assign(t,e)}}t.CityQuarter=k,t.World.CityQuarter=k;class L extends w{constructor(e){super(e),this.setType("battlezone"),this._levels=[]}addLevel(e){return this._levels.push(e)}getLevels(){return this._levels}toJSON(){const e=super.toJSON(),t=this._levels.length,n={nLevels:t,levels:this._levels.map(e=>e.getID())};return 0===t&&o.default.err("World.BattleZone","toJSON",`Bz ${this.getName()} called without levels`),Object.assign(n,e)}}t.BattleZone=L,t.World.BattleZone=L;class R extends C{constructor(e){super(e),this.setType("world"),this._areas=[],this.currAreaIndex=0,this._conf={}}getConf(){return this._conf}setConf(e){this._conf=e}addArea(e){e.setParent(this),this._areas.push(e)}getLevels(){let e=[];return this._areas.map(t=>{e=e.concat(t.getLevels())}),e}getAreas(){return this._areas}getZones(e){let t=[];return this._areas.forEach(n=>{t=t.concat(n.getZones(e))}),t}getStairs(){const e=[];return this.getZones().forEach(t=>t.getLevels().forEach(t=>t.getStairs().forEach(t=>e.push(t)))),e}getPlaceEntities(){let e=[this];return this._areas.map(t=>{e=e.concat(t.getPlaceEntities())}),e}getCurrentArea(){return this._areas[this.currAreaIndex]}toJSON(){const e=super.toJSON(),t=this._areas.map(e=>e.toJSON());let n=!0;this.getConf().hasOwnProperty("createAllZones")&&(n=this.getConf().createAllZones);const s={conf:this.getConf(),nAreas:this._areas.length,area:t,createAllZones:n};return s.conf.area||(s.conf.area=this.createAreaConfig()),Object.assign(s,e)}createAreaConfig(){const e=[];return this._areas.forEach(function(t){e.push(t.createAreaConfig())}),e}getID2Place(){let e={[this.getID()]:this};return this._areas.forEach(t=>{e[t.getID()]=t}),this.getZones().forEach(t=>{e[t.getID()]=t;const n=t.getID2Place();e=Object.assign(e,n)}),e}}t.WorldTop=R,t.World.WorldTop=R;class B{constructor(){this._shopkeeper=null,this._level=null,this._coord=[],this._isAbandoned=!1,this.hasNotify=!0}setLevel(e){this._level=e}setCoord(e){this._coord=e}isAbandoned(){return this._isAbandoned}notify(e,t){this._shopkeeper&&t.actor.getID()===this._shopkeeper.getID()&&(this.setShopAbandoned(),p.removeListener(this))}getLevel(){return this._level}getShopkeeper(){return this._shopkeeper}setShopkeeper(e){e?(this._shopkeeper=e,p.listenEvent(o.default.EVT_ACTOR_KILLED,this)):o.default.err("WorldShop","setShopkeeper","Tried to set null shopkeeper")}setShopAbandoned(){this._isAbandoned=!0,this._shopkeeper=null,this._coord.forEach(e=>{const t=this.getCell(e);t.getShop().abandonShop();const n=t.getItems();n&&n.forEach(e=>{e.has("Unpaid")&&e.remove("Unpaid")})})}getCell(e){return this._level.getMap().getCell(e[0],e[1])}reclaimShop(e){this._isAbandoned&&(this._isAbandoned=!1,this.setShopkeeper(e),this._coord.forEach(t=>{const n=this.getCell(t);n.getShop().reclaim(e);const s=n.getItems();s&&s.forEach(e=>{e.has("Unpaid")||e.add(new h.Unpaid)})}))}emptyCells(){const e=[];return this._coord.forEach(t=>{const n=this._level.getMap().getCell(t[0],t[1]);n.hasItems()||e.push(n)}),e}refreshShopItems(e){let t=0;this._coord.forEach(n=>{this._level.getMap().getCell(n[0],n[1]).hasItems()||t<e.length&&(e[t].add(new h.Unpaid),this._level.addItem(e[t],n[0],n[1]),++t)})}toJSON(){const e={isAbandoned:this._isAbandoned,level:this._level.getID(),coord:this._coord};return this._isAbandoned||(e.shopkeeper=this._shopkeeper.getID()),e}}t.WorldShop=B,t.World.WorldShop=B,t.World.isZone=function(e){if(e.getType){const t=e.getType();return/(city|battlezone|mountain|dungeon)/.test(t)}return!1}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,r=n(33),a=(s=r)&&s.__esModule?s:{default:s};function o(e,t){if(t)do{if(t===e)return!0}while(t=t.parentNode);return!1}t.default=a.default?function(e,t){return e.contains?e.contains(t):e.compareDocumentPosition?e===t||!!(16&e.compareDocumentPosition(t)):o(e,t)}:o,e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(28),{KeyMap:o}=a.Keys;t.Menu={},t.Menu.EXIT_MENU=null,t.Menu.NO_ACTION="NO_ACTION",t.Menu.NEXT_STATE="NEXT_STATE";const i=function(e){const t={};return e.forEach((e,n)=>{const s=a.Keys.menuIndices[n];if(e.key){const n=e,s=a.Keys.codeToIndex(n.key);n.menu?t[s]=n.menu:n.func?t[s]=n.func:n.funcToCall&&(t[s]={funcToCall:n.funcToCall})}else if(2===e.length)t[s]=e;else{let e="Each item must have 2 values: menu msg and ret val";e+="\nItem can also be {key: , menu: } for nested menus",r.default.err("menu.js","createMenuTable",e)}}),t};t.Menu.isSelectionDone=function(e){return"function"==typeof e},t.Menu.isMenuItem=function(e){return e&&"object"==typeof e};class l{constructor(e=[]){this.table=i(e),this.msg="",this.pre=[],this.post=[],this._showMenu=!0,this.parent=null}setName(e){this.name=e}setMsg(e){this.msg=e}showMsg(){this.msg.length>0&&r.default.gameMsg(this.msg)}setParent(e){this.parent=e}getParent(){return this.parent}addItem(e,t){const n=a.Keys.codeToIndex(e);this.table[n]=t}showMenu(){return this._showMenu}setCallback(e){this.callback=e}getMenu(){const e={pre:[],post:[]};return Object.keys(this.table).forEach(t=>{const n=a.Keys.menuIndices[t];e[n]=this.table[t][0]}),e.pre=this.pre,e.post=this.post,e}addPost(e){Array.isArray(e)?this.post=this.post.concat(e):this.post.push(e)}addPre(e){Array.isArray(e)?this.pre=this.pre.concat(e):this.pre.push(e)}dbg(...e){console.log(`MENU ${this.name}`,...e)}select(e){const t=a.Keys.codeToIndex(e);if(this.table.hasOwnProperty(t)){const e=this.table[t];return 2===e.length?e[1]:e.funcToCall?e.funcToCall:e}}}t.MenuBase=l,t.Menu.Base=l;class c extends l{constructor(){super()}select(e){return 0===a.Keys.codeToIndex(e)?t.Menu.EXIT_MENU:this}getMenu(){return{0:"Back to game.",pre:this.pre,post:this.post}}}t.MenuInfoOnly=c,r.default.extend2(c,l),t.Menu.InfoOnly=c;class u extends l{constructor(e){super(e);const n=a.Keys.codeToIndex(a.Keys.KEY.QUIT_MENU);this.table[n]=["Quit menu",t.Menu.EXIT_MENU]}select(e){const n=a.Keys.codeToIndex(e);if(this.table.hasOwnProperty(n)){const e=this.table[n][1];return e===t.Menu.EXIT_MENU&&this.onQuit&&this.onQuit(),e}return this}}t.MenuWithQuit=u,t.Menu.WithQuit=u;class h extends l{constructor(e){super(e)}select(e){const t=a.Keys.codeToIndex(e);return this.table.hasOwnProperty(t)?this.table[t][1]:this}}t.MenuSelectRequired=h,t.Menu.SelectRequired=h;class d extends l{constructor(e=[]){super(e),this._enableSelectAll=!1,this._showMenu=!1}enableSelectAll(){this._enableSelectAll=!0}select(e){if(o.inMoveCodeMap(e))return this.callback(e),this;if(o.isSelect(e)){const t=a.Keys.codeToIndex(e),n=this.table[t];return n.funcToCall?n.funcToCall:n}return this._enableSelectAll&&o.isSelectAll(e)?(this.callback(e),this):t.Menu.EXIT_MENU}}t.MenuSelectCell=d,r.default.extend2(d,l),t.Menu.SelectCell=d;t.MenuSelectTarget=class extends d{constructor(e=[]){super(e),this.targetCallback=null}select(e){const n=d.prototype.select.call(this,e);if(n===t.Menu.EXIT_MENU){if(o.isNextTarget(e))return this.targetCallback&&this.targetCallback(e),this;if(o.isPrevTarget(e))return this.targetCallback&&this.targetCallback(e),this;if(e===o.KEY.TARGET){const t=a.Keys.codeToIndex(e),n=this.table[t];return n.funcToCall?n.funcToCall:n}return t.Menu.EXIT_MENU}return n}};class p extends l{constructor(e){super(e),this._showMenu=!1}select(e){if(o.inMoveCodeMap(e)){const t=a.Keys.KeyMap.getDir(e);return this.callback.bind(null,t)}return t.Menu.EXIT_MENU}}t.MenuSelectDir=p,t.Menu.SelectDir=p;t.PlayerMissileMenu=class extends d{constructor(e=[],t){super(e),this.actor=t,this._showMenu=!1;const n=this.actor.getBrain();if(n.selectCell){const e=n.selectCell.bind(n);this.setCallback(e)}else r.default.err("PlayerMissileMenu","constructor","brain does not have selectCell() function");n.startTargeting(),n.hasTargetSelected()?console.log("Brain has target selected"):(n.selectCell(),console.log("Brain no target selected. Using cell."))}select(e){const n=d.prototype.select.call(this,e);if(n!==t.Menu.EXIT_MENU)return n;switch(e){case a.Keys.KEY.NEXT:return this.actor.getBrain().nextTarget(),this;case a.Keys.KEY.PREV:return this.actor.getBrain().prevTarget(),this;case a.Keys.KEY.TARGET:{const t=a.Keys.codeToIndex(e);return this.table[t]}default:return t.Menu.EXIT_MENU}return t.Menu.EXIT_MENU}};class f extends u{constructor(e){super(e),this._showMenu=!0,this.keyToState={},this.stateToTable={},this.stateToPost={},this.stateToPre={},this.menuState=""}select(e){if(this.keyToState.hasOwnProperty(e))return this.menuState=this.keyToState[e],this;{const n=a.Keys.codeToIndex(e);if(this.table.hasOwnProperty(n)){const e=this.table[n][1];return e===t.Menu.EXIT_MENU&&this.onQuit&&this.onQuit(),e}const s=this.stateToTable[this.menuState];if(s.hasOwnProperty(n)){return s[n][1]}return this}}addState(e,t){this.stateToTable[e]=i(t)}addTransition(e,t){this.keyToState[t]=e}getMenu(){const e=u.prototype.getMenu.call(this),t=this.menuState,n=this.stateToTable[t];let s={pre:this.pre,post:this.post};return Object.keys(n).forEach(e=>{const t=a.Keys.menuIndices[e];s[t]=n[e][0]}),s=Object.assign(s,e),this.stateToPre[t]&&s.pre.push(this.stateToPre[t]),this.stateToPost[t]&&s.post.push(this.stateToPost[t]),s}addPreState(e,t){t?this.stateToPre[t]=e:u.prototype.addPre.call(this,e)}addPostState(e,t){t?this.stateToPost[t]=e:u.prototype.addPost.call(this,e)}}t.MenuWithState=f,t.Menu.WithState=f},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(84),o=n(300),i=n(9),l=n(20);a.Goal.Thief=o.GoalThief,t.Evaluator={},t.Evaluator.hist={},t.Evaluator.NOT_POSSIBLE=r.default.BIAS.NOT_POSSIBLE,t.Evaluator.ALWAYS=r.default.BIAS.ALWAYS;const c=i.Random.getRNG();class u{constructor(e){this.actorBias=e,this.type="Base"}calculateDesirability(e){throw new Error("Pure virtual function")}setActorGoal(e,...n){const s=e.getBrain().getGoal();if(a.Goal[this.type]){const r=new a.Goal[this.type](e,...n);s.addGoal(r),++t.Evaluator.hist[this.type]}else r.default.err("EvaluatorBase","setActorGoal",`No Goal.${this.type} found!`)}isOrder(){return!1}getType(){return this.type}setBias(e){this.actorBias=e}toJSON(){return{type:this.getType(),bias:this.actorBias}}setArgs(e){}}t.EvaluatorBase=u,t.Evaluator.Base=u;class h extends u{constructor(e){super(e),this.type="AttackActor"}calculateDesirability(e){const n=e.getBrain(),s=n.getSeenCells(),r=n.findEnemyCell(s);if(r){const e=1;return this.enemyActor=r.getActors()[0],this.actorBias*e*2}return t.Evaluator.NOT_POSSIBLE}setActorGoal(e){super.setActorGoal(e,this.enemyActor)}}t.EvaluatorAttackActor=h,t.Evaluator.AttackActor=h,t.Evaluator.hist.AttackActor=0;class d extends u{constructor(e){super(e),this.type="Explore"}calculateDesirability(){return this.actorBias}}t.EvaluatorExplore=d,t.Evaluator.Explore=d,t.Evaluator.hist.Explore=0;class p extends u{constructor(e){super(e),this.type="Flee"}calculateDesirability(e){const n=e.getBrain().getSeenEnemies();if(n.length>0){const t=e.get("Health"),s=t.getMaxHP(),r=t.getHP()/s;if(r<this.actorBias){let e=-1;this.enemyActor&&(e=n.findIndex(e=>e.getID()===this.enemyActor.getID())),-1===e&&(this.enemyActor=n[0]);const t=Math.pow(r,2);return this.actorBias*(1-r)/t}}return this.enemyActor=null,t.Evaluator.NOT_POSSIBLE}setActorGoal(e){if(this.enemyActor){const n=e.getBrain().getGoal(),s=new a.Goal.FleeFromActor(e,this.enemyActor);n.addGoal(s),++t.Evaluator.hist[this.type]}else r.default.err("EvaluatorFlee","setActorGoal","Enemy actor is null. Cannot flee.")}}t.EvaluatorFlee=p,t.Evaluator.Flee=p,t.Evaluator.hist.Flee=0;class f extends u{constructor(e,t=[]){super(e),this.type="Patrol",this.coords=t}setCoords(e){this.coords=e}calculateDesirability(){return this.actorBias}setActorGoal(e){const n=e.getBrain().getGoal(),s=this.coords;if(s.length>0){const r=new a.Goal.Patrol(e,s);n.addGoal(r),++t.Evaluator.hist[this.type]}else r.default.err("EvaluatorPatrol","setActorGoal","No guard points set with setCoords()")}setArgs(e){this.coords=e.coords}toJSON(){const e=super.toJSON();return e.args={coords:this.coords},e}}t.EvaluatorPatrol=f,t.Evaluator.Patrol=f,t.Evaluator.hist.Patrol=0;class m extends u{constructor(e,t){super(e),this.type="Guard",t&&this.setXY(t)}setXY(e){this.x=e[0],this.y=e[1]}setArgs(e){const{xy:t}=e;this.setXY(t)}calculateDesirability(){return this.actorBias}setActorGoal(e){const n=e.getBrain().getGoal(),s=new a.Goal.Guard(e,[this.x,this.y]);n.addGoal(s),++t.Evaluator.hist[this.type]}toJSON(){const e=super.toJSON();return e.args={xy:[this.x,this.y]},e}}t.EvaluatorGuard=m,t.Evaluator.Guard=m,t.Evaluator.hist.Guard=0;class g extends u{constructor(e){super(e),this.type="Orders",this.goal=null}setArgs(e){this.goal=e.goal,this.srcActor=e.srcActor}calculateDesirability(){let e=this.goal.getCategory()===a.Goal.Types.Kill?.5:1;return e*=this.actorBias,this.acceptsOrdersFromSource()?1*e:0}acceptsOrdersFromSource(){return!!this.srcActor.has("Commander")||!!this.srcActor.isPlayer()}setActorGoal(e){if(this.goal){e.getBrain().getGoal().addGoal(this.goal),++t.Evaluator.hist[this.type]}else r.default.err("EvaluatorOrder","setActorGoal","this.goal must not be null")}setSubEvaluator(e){this.subEval=e}isOrder(){return!0}}t.EvaluatorOrders=g,t.Evaluator.Orders=g,t.Evaluator.hist.Orders=0;class y extends u{constructor(e){super(e),this.type="CastSpell",this._castingProb=.2}setCastingProbability(e){this._castingProb=e}getCastingProbability(){return this._castingProb}calculateDesirability(e){return this.spell=this.getRandomSpell(e),this.spell&&this.canCastSpell(e)&&this.shouldCastSpell(e)?this.actorBias:0}setActorGoal(e){if(this.spell){const n=e.getBrain().getGoal(),s=new a.Goal.CastSpell(e,this.spell,this.spellArgs);n.addGoal(s),++t.Evaluator.hist[this.type]}else r.default.err("EvaluatorFlee","setActorGoal","Enemy actor is null. Cannot flee.")}getRandomSpell(e){const t=e.getBook();if(t&&t.getSpells().length>0){return c.arrayGetRand(t.getSpells())}return null}canCastSpell(e){if(e.has("SpellPower")){if(e.get("SpellPower").getPP()>=this.spell.getCastingPower()&&c.getUniform()<=this._castingProb)return!0}return!1}shouldCastSpell(e){const t=e.getBrain(),n=t.getSeenCells(),s=t.findEnemyCell(n),a={actor:e,actorCellsAround:l.Brain.getActorCellsAround(e)};if(s&&(a.enemy=s.getActors()[0]),this.spell.aiShouldCastSpell)return this.spell.aiShouldCastSpell(a,(e,t)=>{this.spellArgs=t});{let e=`Spell ${this.spell.getName()} cannot be cast by AI`;e+=" no aiShouldCastSpell() defined for the spell",r.default.warn("Evaluator.CastSpell","shouldCastSpell",e)}return!1}}t.EvaluatorCastSpell=y,t.Evaluator.CastSpell=y,t.Evaluator.hist.CastSpell=0;class v extends u{constructor(e){super(e),this.type="Shopkeeper"}calculateDesirability(e){return e.has("Shopkeeper")?this.actorBias:(r.default.err("EvaluatorShopkeeper","calculateDesirability",`An actor is not shopkeeper: ${e}`),0)}setActorGoal(e){const n=e.getBrain().getGoal(),s=new a.Goal.Shopkeeper(e,this.x,this.y);n.addGoal(s),++t.Evaluator.hist[this.type]}setArgs(e){const{xy:t}=e;this.x=t[0],this.y=t[1]}toJSON(){const e=super.toJSON();return e.args={xy:[this.x,this.y]},e}}t.EvaluatorShopkeeper=v,t.Evaluator.Shopkeeper=v,t.Evaluator.hist.Shopkeeper=0;class _ extends u{constructor(e){super(e),this.type="GoHome",this.timeToHomeSick=c.getUniformInt(20,40),this.timeToStay=0,this.maxDistHome=5}calculateDesirability(e){if(this.timeToHomeSick>0)return this.timeToHomeSick-=1,0;if(0===this.timeToHomeSick&&(this.timeToHomeSick=-1,this.timeToStay=c.getUniformInt(20,40)),this.timeToStay>0){const t=[this.x,this.y];return r.default.withinRange(this.maxDistHome,t,e)&&(this.timeToStay-=1),this.actorBias}return 0===this.timeToStay&&(this.timeToStay=-1,this.timeToHomeSick=c.getUniformInt(20,40)),0}setActorGoal(e){const n=e.getBrain().getGoal(),s=new a.Goal.GoHome(e,this.x,this.y,this.maxDistHome);n.addGoal(s),++t.Evaluator.hist[this.type]}setArgs(e){const{xy:t}=e;this.x=t[0],this.y=t[1],this.timeToHomeSick=e.timeToHomeSick}toJSON(){const e=super.toJSON();return e.args={xy:[this.x,this.y],timeToHomeSick:this.timeToHomeSick},e}}t.EvaluatorGoHome=_,t.Evaluator.GoHome=_,t.Evaluator.hist.GoHome=0;class b extends u{constructor(e){super(e),this.type="Thief"}calculateDesirability(){return this.actorBias}}t.EvaluatorThief=b,t.Evaluator.Thief=b,t.Evaluator.hist.Thief=0;class E extends u{constructor(e){super(e),this.type="Communicate"}calculateDesirability(e){if(this.willCommunicate(e))return this.actorBias}willCommunicate(e){const t=e.getBrain(),n=c.getUniform(),s=t.getSeenCells(),a=t.findFriendCell(s),o=t.getMemory();let i=null;return!r.default.isNullOrUndef([a])&&(i=a.getActors()[0],!o.hasCommunicatedWith(i)&&(!i.has("Communication")&&!(n<1-this.actorBias)))}}t.EvaluatorCommunicate=E,t.Evaluator.Communicate=E},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8));t.verifyStairsConnections=function(e,t){e.getLevels().map(e=>e.getStairs()).forEach(e=>{e.forEach(e=>{if("function"!=typeof e.isConnected)r.default.err("verify.js","verifyStairsConnections","stairs not correct type: "+JSON.stringify(e));else if(!e.isConnected()){let n="|"+t+"| stairs: "+JSON.stringify(e);const s=e.getSrcLevel();n+=s?" srcLevel parent "+s.getParent()+",":" srcLevel missing,";const a=e.getTargetStairs();n+=a?" targetLevel parent: "+a.getParent():" targetLevel missing,",e.getTargetStairs()||(n+=" targetStairs missing"),r.default.err("verify.js","verifyConnections",n)}})})};t.Conf=class{constructor(e){this._name=e}verifyConf(e,t,n){let s=!0,a="";return n.forEach(e=>{this.verifyReq(t,e)?function(e,t){const n=t.split("|"),s=n.length>0;let a=!1;for(const t of n)e.hasOwnProperty(t)&&r.default.isNullOrUndef([e[t]])&&(a=!0);return!s&&a}(t,e)&&(s=!1,a+=` Undef/null value in: ${e}`):(s=!1,a+=` Missing: ${e}`)}),s||r.default.err(this._name,"verifyConf",`${e} ${a}`),s}verifyReq(e,t){const n=t.split("|");let s=!1;return n.forEach(n=>{if(e.hasOwnProperty(n))if(s){const n=JSON.stringify(e),s=`Req ${t} is mutex. Conf: ${n}`;r.default.err(this._name,"verifyReq",s)}else s=!0}),s}},t.verifySaveData=function(e,t=!0){o(e,t)};const a=[];function o(e,t,n=30){const s=[];for(const r in e)if(e.hasOwnProperty(r)){if(a.push(r),a.length<n)if("object"==typeof e[r])o(e[r]);else if("function"==typeof e[r]){let n=`Error. Func in ${JSON.stringify(a)}`;if(n+=`\n\tProp: ${r}`,n+=`\n\tValue: ${e[r].toString()}`,t)throw new Error(n);s.push(n)}else if("string"==typeof e[r]&&/function/.test(e[r])){let t=`function in string <<${e[r]}>>\n`;throw t+=`\tStack is ${a.join(".")}`,new Error(t)}a.pop()}if(s.length>0){const e=s.join("\n");throw new Error(e)}}t.traverseObj=o,t.verifyLevelCache=function(e){const t=e.getItems(),n=e.getMap().getCells(),s={};n.forEach(e=>{e.hasItems()&&e.getItems().forEach(e=>{s[e.getID()]=e})});const r={};t.forEach(e=>{r[e.getID()]=e});const a=Object.keys(s).length,o=Object.keys(r).length;if(o!==a){let e=`nCellItems: ${a}`;e+=`, nLevelItems: ${o}`,console.error("Mismatch in cell/level item length:",e)}const i=[];Object.keys(s).forEach(e=>{r.hasOwnProperty(e)?delete r[e]:i.push(s[e])});const l=[];Object.keys(r).forEach(e=>{s.hasOwnProperty(e)?delete s[e]:l.push(r[e])}),i.forEach(e=>{console.error("\tIn cells but NOT level: ",e.getName())}),l.forEach(e=>{console.error("\tIn level but NOT cells: ",e.getName())})}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(9),i=n(54),l=n(14),c=r(n(11)),u=o.Random.getRNG();t.ItemRandomizer=function(){this.adjustItem=((e,t)=>{const n=e.getType();r.hasOwnProperty(n)&&r[n](e,t)});const e=a.default.getFoodWeightDistr(),t=e=>{const t=u.getUniformInt(5,15);e.setCount(t)},n=e=>{const t=u.getUniform();if((e=>e>=0&&e<=.02)(t)){const t=u.getUniformInt(1,5);switch(u.getUniformInt(0,4)){case 0:case 1:e.setAttack(e.getAttack()+t);break;case 2:case 3:e.setDefense(e.getDefense()+t);break;case 4:e.setProtection(e.getProtection()+t)}a.default.scaleItemValue("combat",t,e)}else if((e=>e>=.1&&e<=.12)(t)){const t=u.getUniformInt(1,3);let n=null;e.has("Stats")?n=e.get("Stats"):((n=new c.Stats).clearValues(),e.add(n));const s=(()=>u.arrayGetRand(a.default.STATS))(),r="get"+s;n["set"+s](n[r]()+t),a.default.scaleItemValue("stats",t,e)}},s=a.default.getRuneChargeDistr(),r={food:t=>{const n=u.getWeighted(e);t.setWeight(n)},goldcoin:(e,t)=>{if(a.default.isNullOrUndef([t]))a.default.err("ItemRandomizer","_adjustGoldCoin","nLevel is not defined.");else{const n=a.default.getGoldCoinCountDistr(t),s=u.getWeighted(n);e.setCount(parseInt(s,10))}},missile:t,weapon:n,armour:e=>{n(e)},ammo:t,rune:e=>{const t=u.getWeighted(s);e.setCharges(t)}}},t.FactoryItem=function(){this._itemRandomizer=new t.ItemRandomizer;const e=(e,t)=>{this._itemRandomizer.adjustItem(e,t)};this.createItem=function(e){return l.ObjectShell.getParser().createRandomItem(e)},this.addNRandItems=((t,n)=>{const s=this.generateItems(n),r=l.ObjectShell.getParser();if(n.food){const t=r.createRandomItem({func:e=>"food"===e.type});t?(e(t,n.maxValue),s.push(t)):a.default.warn("FactoryItem","addNRandItems","Item.Food was not created properly.")}return i.Placer.addPropsToFreeCells(t,s,a.default.TYPE_ITEM),s.length}),this.generateItems=function(t){const n=t.itemsPerLevel||t.nItems,s=[],r=l.ObjectShell.getParser();for(let a=0;a<n;a++){const n=r.createRandomItem({func:t.func});n&&(e(n,t.maxValue),s.push(n))}return s},this.generateGold=function(t){const n=t.goldPerLevel||t.nGold,s=l.ObjectShell.getParser(),r=[];for(let o=0;o<n;o++){const n=s.createActualObj(a.default.TYPE_ITEM,a.default.GOLD_COIN_NAME);e(n,t.nLevel),r.push(n)}return r},this.addRandomGold=((e,t,n)=>{const s=this.generateGold(n);i.Placer.addPropsToFreeCells(e,s,a.default.TYPE_ITEM)}),this.getShopItem=((t,n)=>{let s=null;return n.shopFunc?"function"==typeof n.shopFunc[t]?s=n.parser.createRandomItem({func:n.shopFunc[t]}):a.default.err("FactoryItem","createShop -> getShopItem","shopFunc must be a function."):s=Array.isArray(n.shopType)?n.parser.createRandomItem({func:e=>e.type===n.shopType[t]}):"string"==typeof n.shopType?n.parser.createRandomItem({func:e=>e.type===n.shopType}):n.parser.createRandomItem({func:e=>e.value<=50+100*t}),e(s,50+100*t),s}),this.addItemsToCells=function(e,t,n,s){s.maxValue||a.default.err("FactoryItem","addItemsToCells","conf is missing maxValue");const r=this.generateItems(s);i.Placer.addPropsToCells(e,n,r,a.default.TYPE_ITEM)}},t.FactoryItem.addItemsToActor=function(e,t){const n=l.ObjectShell.getParser();let s=null;t.forEach(t=>{"string"==typeof t?s=n.createItem(t):"object"==typeof t&&(s=n.createItem(t.name)),s&&e.getInvEq().addItem(s)})},t.FactoryItem.equipFullGearType=function(e,n){const s=l.ObjectShell.getParser(),r=new RegExp(n),a=s.filterItems(e=>"armour"===e.type&&r.test(e.name));return t.FactoryItem.equipItemsToActor(e,a)},t.FactoryItem.equipWeaponOfType=function(e,n){const s=l.ObjectShell.getParser(),r=new RegExp(n),a=s.filterItems(e=>"weapon"===e.type&&r.test(e.name)),o=u.arrayGetRand(a);return t.FactoryItem.equipItemsToActor(e,[o])},t.FactoryItem.equipItemsToActor=function(e,t){const n=l.ObjectShell.getParser();let s=null,r=!0;return t.forEach(t=>{if("string"==typeof t)s=n.createItem(t);else if("object"==typeof t){s=n.createItem(t.name);const e=t.count||1;s.setCount(e)}if(s){const t=s.getCount();e.getInvEq().addItem(s),r=r&&e.getInvEq().equipNItems(s,t)}}),r}},function(e,t,n){var s=n(48),r=n(36),a=n(140),o=n(69),i=function(e,t,n){var l,c,u,h=e&i.F,d=e&i.G,p=e&i.S,f=e&i.P,m=e&i.B,g=e&i.W,y=d?r:r[t]||(r[t]={}),v=y.prototype,_=d?s:p?s[t]:(s[t]||{}).prototype;for(l in d&&(n=t),n)(c=!h&&_&&void 0!==_[l])&&l in y||(u=c?_[l]:n[l],y[l]=d&&"function"!=typeof _[l]?n[l]:m&&c?a(u,s):g&&_[l]==u?function(e){var t=function(t,n,s){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,n)}return new e(t,n,s)}return e.apply(this,arguments)};return t.prototype=e.prototype,t}(u):f&&"function"==typeof u?a(Function.call,u):u,f&&((y.virtual||(y.virtual={}))[l]=u,e&i.R&&v&&!v[l]&&o(v,l,u)))};i.F=1,i.G=2,i.S=4,i.P=8,i.B=16,i.W=32,i.U=64,i.R=128,e.exports=i},function(e,t){var n=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n){var c="",u="",h=t;if("string"==typeof t){if(void 0===n)return e.style[(0,s.default)(t)]||(0,a.default)(e).getPropertyValue((0,r.default)(t));(h={})[t]=n}Object.keys(h).forEach(function(t){var n=h[t];n||0===n?(0,l.default)(t)?u+=t+"("+n+") ":c+=(0,r.default)(t)+": "+n+";":(0,o.default)(e,(0,r.default)(t))}),u&&(c+=i.transform+": "+u+";");e.style.cssText+=";"+c};var s=c(n(174)),r=c(n(280)),a=c(n(282)),o=c(n(283)),i=n(175),l=c(n(284));function c(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return(0,a.default)(function(){for(var e=arguments.length,n=Array(e),s=0;s<e;s++)n[s]=arguments[s];var r=null;return t.forEach(function(e){if(null==r){var t=e.apply(void 0,n);null!=t&&(r=t)}}),r})};var s,r=n(78),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return function(t,n,s,r,a){var o=s||"<<anonymous>>",i=a||n;if(null==t[n])return new Error("The "+r+" `"+i+"` is required to make `"+o+"` accessible for users of assistive technologies such as screen readers.");for(var l=arguments.length,c=Array(l>5?l-5:0),u=5;u<l;u++)c[u-5]=arguments[u];return e.apply(void 0,[t,n,s,r,a].concat(c))}},e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(104),o=n(18),i=function(e,t){const n=e.length;if(n){for(;t<n;)e[t]=e[t+1],t++;e.length--}};class l extends a.GameObject{static createEntityID(){return a.GameObject.createObjectID()}static setPool(e){l.POOL=e}static getIDCount(){return a.GameObject.ID}constructor(...e){super(),this.comps={},this.compsByType={}}remove(e){if(++l.num.remove,"object"==typeof e){const t=e.getID();if(this.comps.hasOwnProperty(t)){const e=this.comps[t],n=e.getType();e.entityRemoveCallback(this),delete this.comps[t];const s=this.compsByType[n].indexOf(e);i(this.compsByType[n],s),0===this.compsByType[n].length&&delete this.compsByType[n],l.POOL.emitEvent(n,{entity:this,remove:!0})}}else if(Number.isInteger(e)){const t=e;this.comps[t]&&this.remove(this.comps[t])}else{const t=this.get(e);if(t)this.remove(t);else{const t=parseInt(e,10);if(t)this.remove(t);else{const t=typeof e;r.default.warn("Entity","remove",`No comp found ->  |${e}|, type: ${t}`)}}}}equals(e){return this.getID()===e.getID()}get(e){return++l.num.get,this.compsByType[e]?this.compsByType[e][0]:null}getByID(e){return this.comps[e]}getList(e){return++l.num.getList,this.compsByType[e]?this.compsByType[e].slice():[]}add(e){"string"==typeof e&&r.default.err("Entity","add","No string support anymore"),++l.num.add;const t=e.getType();e.isUnique()&&this.has(t)&&this.removeAll(t),this.comps[e.getID()]=e,this.compsByType.hasOwnProperty(t)?this.compsByType[t].push(e):this.compsByType[t]=[e],e.entityAddCallback(this),l.POOL.emitEvent(t,{entity:this,add:!0})}has(e){return++l.num.has,!!this.compsByType.hasOwnProperty(e)||this.comps.hasOwnProperty(e)}hasAny(e){++l.num.hasAny;for(const t of e)if(this.compsByType.hasOwnProperty(t))return!0;return!1}hasNone(e){return!this.hasAny(e)}hasAll(e){for(const t of e)if(!this.compsByType.hasOwnProperty(t))return!1;return!0}removeAll(e){++l.num.removeAll;let t=e;if("object"==typeof e&&(t=e.getType()),this.has(t)){this.compsByType[t].slice().forEach(e=>{this.remove(e)})}}replace(e,t){this.removeAll(e),t?this.add(t):this.add(e)}getComponents(){return this.comps}copy(e){throw new Error("copy() not implemented in Entity")}clone(){throw new Error("clone() not implemented in Entity")}toJSON(){throw new Error("toJSON() not implemented in Entity")}}t.Entity=l,l.setPool(o.EventPool.getPool()),l.num={},l.num.add=0,l.num.get=0,l.num.getList=0,l.num.has=0,l.num.hasAny=0,l.num.hasAll=0,l.num.remove=0,l.num.removeAll=0},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(52),i=r(n(25)),l=n(40),c=n(20),u=n(124),h=n(183),d=r(n(66));t.Actor={},t.ACTOR_NO_ACTION=Object.freeze(()=>{});Object.freeze({});const p=a.default.BASE_SPEED*a.default.ACTION_DUR;class f extends o.Entity{constructor(e){super({propType:a.default.TYPE_ACTOR,type:null});const t=new i.Named;t.setName(e),this.add(t),this.add(new i.Action),this.add(new i.Location),this.add(new i.Typed("BaseActor",a.default.TYPE_ACTOR))}getType(){return this.get("Typed").getObjType()}setType(e){return this.get("Typed").setObjType(e)}getPropType(){return this.get("Typed").getPropType()}setPropType(e){return this.get("Typed").setPropType(e)}getCell(){return this.get("Location").getCell()}isLocated(){return this.get("Location").isLocated()}unsetLevel(){this.get("Location").unsetLevel()}setLevel(e){return this.get("Location").setLevel(e)}getLevel(){return this.get("Location").getLevel()}getX(){return this.get("Location").getX()}getY(){return this.get("Location").getY()}getXY(){return this.get("Location").getXY()}setXY(e,t){this.get("Location").setXY(e,t)}isPlayer(){return this.has("Player")||this.has("PlayerControlled")}isEnemy(e){return!1}addEnemy(e){}addEnemyType(e){}setName(e){this.get("Named").setName(e)}getName(){return this.get("Named").getFullName()}getBrain(){return this._brain}setBrain(e){this._brain=e,this._brain.setActor(this)}getSpeed(){return a.default.BASE_SPEED}getEquipProtection(){return 0}nextAction(e){const n=this._brain.decideNextAction(e);let s=null;if(null!==n){const e=Math.round(p/this.getSpeed());if(s=new d.Action(e,n),this._brain.hasOwnProperty("energy")){const e=this._brain;s.energy=e.energy}}else s=new d.Action(0,t.ACTOR_NO_ACTION);return s.actor=this,s}toJSON(){let e=null;this.getLevel()&&(e=this.getLevel().getID());const t={id:this.getID(),type:this.getType(),levelID:e,brain:this._brain.toJSON(),new:"Base"};return t.components=l.compsToJSON(this),null===t.type&&a.default.err("Actor.Virtual","toJSON",`Type null for ${JSON.stringify(t)}`),t}}t.BaseActor=f,t.Actor.Base=f;class m extends f{constructor(e){super(e),this._brain=new c.BrainGoalOriented(this),this._brain.getMemory().addEnemyType("player"),this._invEq=new h.Inventory(this),this._maxWeight=10,this.add(new i.Experience),this.add(new i.Combat),this.add(new i.Stats),this.add(new i.Health(50)),this.add(new i.Corporeal);const t=new i.Perception;t.setFOVRange(a.default.NPC_FOV_RANGE),this.add(t)}getFOVRange(){let e=this.get("Perception").getFOVRange();return this.has("EagleEye")&&(e+=2),e}setFOVRange(e){this.get("Perception").setFOVRange(e)}addEnemyType(e){this._brain.getMemory().addEnemyType(e)}addEnemy(e){this._brain.addEnemy(e)}addFriend(e){this._brain.addFriend(e)}isEnemy(e){return this._brain.getMemory().isEnemy(e)}isFriend(e){return this._brain.getMemory().isFriend(e)}getInvEq(){return this._invEq}getWeapon(){return this._invEq.getWeapon()}getMissileWeapon(){return this._invEq.getMissileWeapon()}getMissile(){return this._invEq.getEquipment().getItem("missile")}getEquipAttack(){let e=this._invEq.getEquipment().getAttack();return this.has("Skills")&&(e+=this.get("Skills").getLevel("Melee")),e}getEquipDefense(){let e=this._invEq.getEquipment().getDefense();return this.has("Skills")&&(e+=this.get("Skills").getLevel("Shields")),e}getEquipProtection(){return this._invEq.getEquipment().getProtection()}getShieldDefense(){const e=this._invEq.getEquipment().getEquipped("shield");let t=0;if(e){t=e.getDefense(),this.has("Skills")&&(t+=this.get("Skills").getLevel("Shields"))}return t}setActorClass(e){this._actorClass=e}getActorClass(){return this._actorClass}setBook(e){this._spellbook=e}getBook(){return this._spellbook}getMaxWeight(){return 2*this.get("Stats").getStrength()+2*this._invEq.getEquipment().getStrength()+this._maxWeight}setIsPlayer(e){e?(this._brain=new u.BrainPlayer(this),y(this),this.add(new i.Player),this.has("SpellPower")||this.add(new i.SpellPower)):a.default.err("Actor.Sentient","setIsPlayer","Actor cannot be changed from player to mob.")}setPlayerCtrl(e){var t;e?(this.add(new i.PlayerControlled),this._actualBrain=this._brain,this._brain=new u.BrainPlayer(this),y(this),this.add(new i.Possessed)):(this.remove("PlayerControlled"),this.remove("Possessed"),t=this,g.forEach(e=>{let n=-1;if(t.has(e)){const s=t.getList(e);s.forEach(e=>{"brain-player"===e.getTag()&&(n=e.getID())})}-1!==n&&t.remove(n)}),this._brain=this._actualBrain,delete this._actualBrain)}getCell(){const e=this.getX(),t=this.getY(),n=this.getLevel();return n?n.getMap().getCell(e,t):null}isInLevel(e){return!!this.getLevel()&&this.getLevel().getID()===e.getID()}toJSON(){let e=null;this.getLevel()&&(e=this.getLevel().getID());const t={id:this.getID(),name:this.getName(),type:this.getType(),x:this.getX(),y:this.getY(),fovRange:this.getFOVRange(),levelID:e,inventory:this.getInvEq().getInventory().toJSON(),equipment:this.getInvEq().getEquipment().toJSON(),brain:this._brain.toJSON(),new:"Sentient",components:l.compsToJSON(this)};return null===t.type&&a.default.err("Actor.Sentient","toJSON",`Type null for ${JSON.stringify(t)}`),this._spellbook&&(t.spellbook=this._spellbook.toJSON()),this.has("Player")&&(t.isPlayer=!0),this._actualBrain&&(t.brain=this._actualBrain.toJSON()),t}getAttack(){let e=this.get("Combat").getAttack();return e+=this.getEquipAttack(),e+=this._addFromCompList("CombatMods","getAttack"),e+=a.default.accuracyToAttack(this.getAccuracy())}getDefense(){let e=this.get("Combat").getDefense();return e+=this.getEquipDefense(),e+=this._addFromCompList("CombatMods","getDefense"),e+=a.default.agilityToDefense(this.getAgility())}getProtection(){let e=this.get("Combat").getProtection();return e+=this.getEquipProtection(),e+=this._addFromCompList("CombatMods","getProtection")}getDamage(){let e=this.get("Combat").rollDamage();const t=this.getWeapon();if(t){const n=a.default.getItemDamage(t);n>e&&(e=n)}const n=this.getStrength();return e+=a.default.strengthToDamage(n),e+=this._addFromCompList("CombatMods","getDamage")}getCombatBonus(e){return this._addFromCompList("CombatMods",e)}_addFromCompList(e,t){const n=this.getList(e);return n.length>0?n.reduce((e,n)=>e+n[t](),0):0}getAccuracy(){let e=this.get("Stats").getAccuracy();return e+=this.getInvEq().getEquipment().getAccuracy(),e+=this._addFromCompList("StatsMods","getAccuracy")}getAgility(){let e=this.get("Stats").getAgility();return e+=this.getInvEq().getEquipment().getAgility(),e+=this._addFromCompList("StatsMods","getAgility")}getStrength(){let e=this.get("Stats").getStrength();return e+=this.getInvEq().getEquipment().getStrength(),e+=this._addFromCompList("StatsMods","getStrength")}getWillpower(){let e=this.get("Stats").getWillpower();return e+=this.getInvEq().getEquipment().getWillpower(),e+=this._addFromCompList("StatsMods","getWillpower")}getSpeed(){let e=this.get("Stats").getSpeed();return e+=this.getInvEq().getEquipment().getSpeed(),e+=this._addFromCompList("StatsMods","getSpeed")}getPerception(){let e=this.get("Stats").getPerception();return e+=this.getInvEq().getEquipment().getPerception(),e+=this._addFromCompList("StatsMods","getPerception")}getMagic(){let e=this.get("Stats").getMagic();return e+=this.getInvEq().getEquipment().getMagic(),e+=this._addFromCompList("StatsMods","getMagic")}getStatBonus(e){return this._addFromCompList("StatsMods",e)}}t.SentientActor=m;const g=["StatsMods","CombatMods"];function y(e){g.forEach(t=>{let n=!1;if(e.has(t)){e.getList(t).forEach(e=>{"brain-player"===e.getTag()&&(n=!0)})}if(!n){const n=new i[t];n.setTag("brain-player"),e.add(n)}})}t.Actor.Sentient=m,m.getFormattedStats=function(e){const t=e.getLevel().getLevelNumber(),n=a.default.formatLocationName(e.getLevel());let s=null;e.has("SpellPower")&&(s=e.get("SpellPower").getPP()+"/"+e.get("SpellPower").getMaxPP());const r={HP:e.get("Health").getHP()+"/"+e.get("Health").getMaxHP(),PP:s,Att:[e.getAttack(),e.getCombatBonus("getAttack")],Def:[e.getDefense(),e.getCombatBonus("getDefense")],Pro:[e.getProtection(),e.getCombatBonus("getProtection")],Str:[e.getStrength(),e.getStatBonus("getStrength")],Agi:[e.getAgility(),e.getStatBonus("getAgility")],Acc:[e.getAccuracy(),e.getStatBonus("getAccuracy")],Wil:[e.getWillpower(),e.getStatBonus("getWillpower")],Per:[e.getPerception(),e.getStatBonus("getPerception")],Mag:[e.getMagic(),e.getStatBonus("getMagic")],Speed:[e.getSpeed(),e.getStatBonus("getSpeed")],XP:e.get("Experience").getExp(),XL:e.get("Experience").getExpLevel(),DL:t,Loc:n};return e.has("Hunger")&&(r.E=e.get("Hunger").getEnergy()),r},t.isSentient=function(e){if(e)return"function"==typeof e.getBrain().getGoal}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(9).Random.getRNG();t.Placer={},t.Placer.addPropsToFreeCells=function(e,n,s){const r=e.getMap().getFree();t.Placer.addPropsToCells(e,r,n,s)},t.Placer.addPropsToCells=function(e,t,n,s){let o=n.length>0&&t.length>0;for(let i=0;i<n.length;i++)if(t.length>0){const l=a.randIndex(t),c=t[l];s===r.default.TYPE_ACTOR?o=o&&e.addActor(n[i],c.getX(),c.getY()):s===r.default.TYPE_ITEM?o=o&&e.addItem(n[i],c.getX(),c.getY()):r.default.err("Placer","addPropsToCells",`Type ${s} not supported`),t.splice(l,1)}return o},t.Placer.addPropsToRoom=function(e,n,s){Array.isArray(s)||r.default.err("Placer","addPropsToRoom",`props must be an array. Got: ${s}`);const a=n.getBbox(),o=s[0];return r.default.isActor(o)?t.Placer.addActorsToBbox(e,a,s):r.default.isItem(o)?t.Placer.addItemsToBbox(e,a,s):(r.default.err("Placer","addPropsToRoom",`Prop type not supported: ${o}`),!1)},t.Placer.addActorsToBbox=function(e,n,s){const a=s.length,o=e.getMap().getFreeInBbox(n);return o.length<a&&r.default.warn("Factory","addActorsToBbox","Not enough free cells"),t.Placer.addPropsToCells(e,o,s,r.default.TYPE_ACTOR)},t.Placer.addItemsToBbox=function(e,n,s){const a=e.getMap().getFreeInBbox(n);return t.Placer.addPropsToCells(e,a,s,r.default.TYPE_ITEM)},t.Placer.addEntityToCellType=function(e,t,n){let s=!1;const o=t.getMap().getCells(n);if(0===o.length)return!1;const i=a.arrayGetRand(o),[l,c]=i.getXY();return r.default.isActor(e)?s=t.addActor(e,l,c):r.default.isItem(e)?s=t.addItem(e,l,c):r.default.isElement(e)&&(s=t.addElement(e,l,c)),s}},function(e,t,n){var s=n(70),r=n(196),a=n(141),o=Object.defineProperty;t.f=n(72)?Object.defineProperty:function(e,t,n){if(s(e),t=a(t,!0),s(n),r)try{return o(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(e[t]=n.value),e}},function(e,t){var n={}.hasOwnProperty;e.exports=function(e,t){return n.call(e,t)}},function(e,t,n){var s=n(199),r=n(143);e.exports=function(e){return s(r(e))}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(136),i=r(n(45)),l=n(54),c=n(109),u=n(46),h=n(31),d=n(18),p=n(9),f=r(n(15)),m=n(19),g=d.EventPool.getPool(),y=p.Random.getRNG(),v=function(e){["itemsPerLevel","maxValue","func"].forEach(t=>{if(t in e)this[t]=e[t];else{const e=`${t} must be given`;a.default.err("ItemConf","new",e)}})};t.Factory={},t.Factory.cityConfBase=(e=>{const t=e||{},n={nShops:1,shopFunc:[e=>e.type===y.arrayGetRand(a.default.SHOP_TYPES)],shopType:"",levelType:"arena"};return Object.assign(n,t)}),t.FactoryBase=function(){this._verif=new i.Conf("FactoryBase"),this._actorFact=new c.FactoryActor,this._itemFact=new u.FactoryItem,this._levelFact=new h.FactoryLevel,this.createDie=(e=>a.default.createDie(e)),this.createPlayer=((e,t)=>this._actorFact.createPlayer(e,t)),this.createActor=((e,t={})=>this._actorFact.createActor(e,t)),this.createBrain=((e,t)=>this._actorFact.createBrain(e,t)),this.createSpell=(e=>this._actorFact.createSpell(e)),this.createElement=(e=>{if(m.ELEM_MAP.elemTypeToObj[e])return m.ELEM_MAP.elemTypeToObj[e];switch(e){case"door":return new f.ElementDoor(!0);case"opendoor":return new f.ElementDoor(!1);default:return null}}),this.createFloorCell=((e,t)=>new o.Cell(e,t,new f.ElementBase("floor"))),this.createWallCell=((e,t)=>new o.Cell(e,t,new f.ElementWall("wall"))),this.createLevel=function(e,t,n,s){return this._levelFact.createLevel(e,t,n,s)},this.addNRandItems=((e,t,n)=>(this._verif.verifyConf("addNRandItems",n,["func","maxValue"]),this._itemFact.addNRandItems(e,t,n))),this.addNRandActors=((e,t,n)=>{this._verif.verifyConf("addNRandActors",n,["maxDanger","actorsPerLevel"]);const s=n.maxDanger,r=this.generateNActors(n.actorsPerLevel,n.func,s);return r?(l.Placer.addPropsToFreeCells(e,r,a.default.TYPE_ACTOR),r.length):0}),this.setParser=(e=>{this._parser=e}),this.generateNActors=((e,t,n)=>this._actorFact.generateNActors(e,t,n)),this.addRandomGold=((e,t,n)=>{this._itemFact.addRandomGold(e,t,n)}),this.createHumanArmy=((e,t)=>{for(let n=0;n<2;n++){for(let s=0;s<20;s++){const r=t.createActualObj("actors","fighter");e.addActor(r,s+1,4+n)}const s=t.createActualObj("actors","warlord");e.addActor(s,10,n+7)}}),this.createDemonArmy=((e,t)=>{for(let n=0;n<2;n++)for(let s=0;s<10;s++){const r=t.createActualObj("actors","Winter demon");e.addActor(r,s+10,14+n),g.emitEvent(a.default.EVT_ACTOR_CREATED,{actor:r,level:e,msg:"DemonSpawn"})}}),this.createBeastArmy=function(e,t){const n=e.getMap().cols/2,s=e.getMap().rows/2;for(let r=s;r<s+2;r++)for(let s=n;s<n+10;s++){const n=t.createActualObj("actors","Blizzard beast"),o=s+10,i=r+14;e.getMap().hasXY(o,i)?(e.addActor(n,o,i),g.emitEvent(a.default.EVT_ACTOR_CREATED,{actor:n,level:e,msg:"DemonSpawn"})):a.default.warn("FactoryBase","createBeastArmy",`Cannot put beast to ${o}, ${i}.`)}},this.addActorsToBbox=((e,t,n)=>{const s=n.nActors||4,{maxDanger:r,func:a}=n,o=this.generateNActors(s,a,r);l.Placer.addActorsToBbox(e,t,o)}),this.addItemsToBbox=((e,t,n)=>{const s=n.nItems||4;let r=Object.assign({itemsPerLevel:s},n);r=new v(r);const o=(new u.FactoryItem).generateItems(r),i=e.getMap().getFreeInBbox(t);l.Placer.addPropsToCells(e,i,o,a.default.TYPE_ITEM)})}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(15);t.LevelGenerator=class{static getOptions(){return{addActors:!1,actorFunc:e=>e.danger<=5,addItems:!0,cellsAround:{N:"wallmount",S:"tree",E:"grass",W:"snow",NW:"water",SE:"water"},surroundX:10,surroundY:10,maxValue:100,maxDanger:5,shouldRemoveMarkers:!0}}constructor(){this.shouldRemoveMarkers=!0}addStartAndEndPoint(e,t,n){if(t){const[n,s]=t,r=new a.ElementMarker("<");r.setTag("start_point"),e.addElement(r,n,s)}if(n){const[t,s]=n,r=new a.ElementMarker(">");r.setTag("end_point"),e.addElement(r,t,s)}}removeMarkers(e,t){let n=0,s=["start_point","end_point","critical_path"];return t.markersPreserved?s=s.concat(t.markersPreserved):!1===t.markersPreserved&&(s=[]),r.default.isNullOrUndef([t.shouldRemoveMarkers])||(this.shouldRemoveMarkers=t.shouldRemoveMarkers),this.shouldRemoveMarkers&&e.removeElements(e=>{if(e.getTag){const t=e.getTag();if(s.indexOf(t)<0)return++n,!0}return!1}),n}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(413),i=n(129),l=n(128),c=n(17)("bitn:Factory.World"),u=r(n(45)),h=n(220),d=r(n(41)),p=n(58),f=n(157),m=n(109),g=n(14),y=n(159),v=n(160),_=n(114),b=n(415),E=n(156),S=n(416),C=r(n(15)).ElementStairs,w=["City","Mountain","Dungeon","BattleZone"],T={tile:{Small:{x:40,y:20},Medium:{x:60,y:30},Large:{x:80,y:40},Huge:{x:140,y:60}},mountain:{Small:{x:40,y:20},Medium:{x:60,y:30},Large:{x:80,y:40},Huge:{x:140,y:60}},dungeon:{Small:{x:a.default.LEVEL_SMALL_X,y:a.default.LEVEL_SMALL_Y},Medium:{x:a.default.LEVEL_MEDIUM_X,y:a.default.LEVEL_MEDIUM_Y},Large:{x:a.default.LEVEL_LARGE_X,y:a.default.LEVEL_LARGE_Y},Huge:{x:a.default.LEVEL_HUGE_X,y:a.default.LEVEL_HUGE_Y}},city:{Small:{x:40,y:20},Medium:{x:60,y:30},Large:{x:80,y:40},Huge:{x:140,y:60}}};function O(e,t,n){if("Iron hills"===e.name){a.default.diag(n+" Creating iron hills connection now");const e=t.getConnections().filter(e=>"mountain"===e.getName());if(a.default.diag("\t## Ex. conns: "+JSON.stringify(e)),e.length>0){const t=e[0].getTargetLevel();a.default.diag("\t## Parent: "+t.getParent().getName())}}}t.FactoryWorld=function(){this._verif=new u.Conf("FactoryWorld"),this.factZone=new f.FactoryZone,this.createAllZones=!0,this.worldElemByID={},this.presetLevels={},this._conf=new h.ConfStack,this.id2level={},this.id2levelSet=!1,this.id2entity={},this.setRNG=function(e){this.factZone.setRNG(e)},this.setPresetLevels=function(e){this.presetLevels=e,this.debug("PresetLevels were set.")},this.setId2Level=function(e){0===Object.keys(e).length&&a.default.warn("FactoryWorld","setId2Level","There are no levels/keys present in id2level map. Bug?"),this.id2level=e,this.id2levelSet=!0,this.debug("Id2Level was set OK.")},this.pushScope=function(e){this._conf.pushScope(e)},this.popScope=function(e){this._conf.popScope(e)},this.setGlobalConf=function(e={}){const t=e.levelSize||"Medium",n=e.sqrPerActor||a.default.ACTOR_MEDIUM_SQR,s={levelSize:t,dungeonX:T.dungeon[t].x,dungeonY:T.dungeon[t].y,sqrPerActor:n,sqrPerItem:e.sqrPerItem||a.default.LOOT_MEDIUM_SQR,set:!0};this._conf.setGlobalConf(s),this.debug("globalConf set to "+JSON.stringify(s))},this.getGlobalConf=function(){return this._conf.getGlobalConf()},this.getConf=function(e){return this._conf.getConf(e)},this.setOverWorld=function(e){this.overworld=e},this.getHierName=(()=>this._conf.getScope().join(".")),this.createWorld=function(e){this._verif.verifyConf("createWorld",e,["name","nAreas"]),this.getGlobalConf().set||this.setGlobalConf({}),e.hasOwnProperty("createAllZones")&&(this.createAllZones=e.createAllZones,this.debug("createAllZones set to "+this.createAllZones)),this.pushScope(e);const t=new d.WorldTop(e.name);t.setConf(e);for(let n=0;n<e.nAreas;n++){const s=e.area[n],r=this.createArea(s);s.zonesCreated&&this.restoreCreatedZones(t,r,s),t.addArea(r),this.addWorldID(s,r)}return this.popScope(e),this.addWorldID(e,t),t},this.createArea=function(e){this._verif.verifyConf("createArea",e,["name","maxX","maxY"]),this.pushScope(e);const t=this.getHierName();let n=null;this.id2levelSet?n=this.getAreaLevels(e):(n=this.getPresetLevels(t,e))&&0!==n.length||(n=null);const s=new d.Area(e.name,e.maxX,e.maxY,e.cols,e.rows,n);return s.setConf(e),s.setHierName(this.getHierName()),this.createAllZones?(this._createAllZones(s,e),s.markAllZonesCreated()):this.debug("Skipping the zone creating due to createZones=false"),this.popScope(e),s},this.restoreCreatedZones=((e,t,n)=>{Object.keys(n.zonesCreated).forEach(s=>{const[r,a]=s.split(","),[o,i]=[parseInt(r,10),parseInt(a,10)];n.zonesCreated[s]&&(this.debug(`\tRestoring created zones for tile ${o},${i}`),this.createZonesForTile(e,t,o,i))})}),this.createZonesForTile=((e,t,n,s)=>{if(t.tileHasZonesCreated(n,s))this.debug(`Area ${n},${s} zones already created`);else{this.debug(`Creating Area ${n},${s} zones (not created yet)`);const r=e.getConf();this.pushScope(r);const a=t.getConf();this.pushScope(a),this.populateAreaLevel(t,n,s),this._createAllZones(t,a,n,s),t.markTileZonesCreated(n,s),this.createQuests(e,t,n,s),this.popScope(a),this.popScope(r)}}),this.populateAreaLevel=((e,t,n)=>{const s=Math.floor(e.getSizeX()/2),r=e.getSizeY()-1,o=g.ObjectShell.getParser(),i=e.getTileXY(t,n).getLevel(),l=Math.abs(s-t),c=r-n,u=7+l+2*c,h=10*(c+1)+2*l+10,d=new p.FactoryBase;d.setParser(o);const f=a.default.getMaxValue(l,c),m=a.default.getMaxDanger(l,c),y={itemsPerLevel:u,item:e=>e.value<=f&&"food"!==e.type,actor:e=>e.danger<=m,gold:()=>!1,food:()=>!1,maxValue:f,actorsPerLevel:h,maxDanger:m};this.setAreaLevelConstraints(y,t,n),y.func=y.item,d.addNRandItems(i,o,y),y.func=y.actor,d.addNRandActors(i,o,y),this.addActorSpawner(i,o,y)}),this._createAllZones=((e,t,n=-1,s=-1)=>{if(this.debug(`_createAllZones ${n}, ${s}`),t.tiles)if(n<0||s<0)this.createZonesFromArea(e,t,n,s);else{const r=t.tiles[n][s];this.createZonesFromTile(e,r,n,s)}else this.createZonesFromArea(e,t,n,s)}),this.createZonesFromArea=((e,t,n=-1,s=-1)=>{this.debug(`createZonesFromArea ${n}, ${s}`),w.forEach(r=>{const a=r.toLowerCase(),o="create"+r;let i=0;Array.isArray(t[a])&&(i=t[a].length),this.debug(`\tnZones (${r}) is now ${i}`);for(let l=0;l<i;l++){const i=t[a][l],{x:c,y:u}=i;if(!(-1!==n&&n!==c||-1!==s&&s!==u)){const t=this[o](i);t.setTileXY(c,u),e.addZone(r,t),this.addWorldID(i,t),this.id2levelSet||this.createAreaZoneConnection(e,t,i)}}})}),this.createZonesFromTile=((e,t,n,s)=>{w.forEach(r=>{const a=r.toLowerCase();let o=0;Array.isArray(t[a])&&(o=t[a].length),this.debug(`\t[${n}][${s}]: nZones (${r}) is now ${o}`);for(let i=0;i<o;i++){const o=t[a][i],l="create"+r,{x:c,y:u}=o;if(!(-1!==n&&n!==c||-1!==s&&s!==u)){const t=this[l](o);t.setTileXY(c,u),e.addZone(r,t),this.addWorldID(o,t),this.id2levelSet||this.createAreaZoneConnection(e,t,o)}}})}),this.getAreaLevels=(e=>{const t=[];return e.tiles?e.tiles.forEach(e=>{const n=[];e.forEach(e=>{const t=this.id2level[e.level];t?n.push(t):a.default.err("FactoryWorld","getAreaLevels",`No level ID ${e.level} in id2level`)}),t.push(n)}):a.default.err("FactoryWorld","getAreaLevels","conf.tiles null/undefined, but id2levelSet true"),t}),this.createDungeon=function(e){this._verif.verifyConf("createDungeon",e,["name","nBranches"]),this.pushScope(e);const t=new d.Dungeon(e.name);if(t.setHierName(this.getHierName()),e.nBranches!==e.branch.length){const t=e.branch.length;a.default.err("Factory.World","createDungeon",`Branch number mismatch [] = ${t}, n: ${e.nBranches}`)}for(let n=0;n<e.nBranches;n++){const s=e.branch[n],r=this.createBranch(s);t.addBranch(r),this.addWorldID(s,r)}return e.entrance&&t.setEntrance(e.entrance),this.id2levelSet||e.nBranches>1&&(e.connectLevels?e.connectLevels.forEach(e=>{4===e.length?t.connectSubZones(...e):a.default.err("Factory.World","createDungeon","Each connection.length must be 4.")}):a.default.err("Factory.World","createDungeon","nBranches > 1, but no conf.connectLevels.")),this.popScope(e),t},this.createBranch=function(e){this._verif.verifyConf("createBranch",e,["name","nLevels"]),this.pushScope(e);const t=new d.Branch(e.name),n=this.getHierName();t.setHierName(n);const s=this.getPresetLevels(n,e);for(let n=0;n<e.nLevels;n++){const r=this.getConf("maxDanger"),a=this.getConf("maxValue"),o={x:this.getConf("dungeonX"),y:this.getConf("dungeonY"),sqrPerActor:this.getConf("sqrPerActor"),sqrPerItem:this.getConf("sqrPerItem"),maxValue:a?a+20*n:20*(n+1),maxDanger:r?r+n:2+n,nLevel:n},i=this.getConf("dungeonType");i&&(o.dungeonType=i),this.setLevelConstraints(o);let l=this.getFromPresetLevels(n,s);if(l)e.createPresetLevels&&e.create&&this.addFixedFeatures(n,l,t);else if(e.levels)l=this.id2level[e.levels[n]];else{const[s,r]=[o.x,o.y];if(o.markersPreserved=!1,/(crypt)/i.test(i)){l=(new b.CryptGenerator).create(s,r,o),this.factZone.addItemsAndActors(l,o),this.factZone.addExtraDungeonFeatures(l,o)}else if(/cave/.test(i)){l=(new v.CaveGenerator).create(s,r,o),this.factZone.addItemsAndActors(l,o),this.factZone.addExtraDungeonFeatures(l,o)}else if(/(fort|castle)/.test(i)){l=(new _.CastleGenerator).create(s,r,o)}else{l=(new y.DungeonGenerator).create(s,r,o)}this.addFixedFeatures(n,l,t);const a=new S.DungeonFeatures("dungeon");n===e.nLevels-1&&a.addLastLevelFeatures(n,l,o)}t.addLevel(l)}return this.id2levelSet?e.hasOwnProperty("entrance")&&t.setEntranceLocation(e.entrance):(t.connectLevels(),e.hasOwnProperty("entranceLevel")&&t.addEntrance(e.entranceLevel)),this.popScope(e),t},this.getFromPresetLevels=((e,t)=>{let n=null;if(t.length>0){const s=t.find(t=>t.nLevel===e);s&&(n=s.level)}return n});const e=e=>{"function"==typeof e&&a.default.err("Factory","_errorOnFunc",`Function constraint not supported anymore: ${e.toString()}`)};this.setLevelConstraints=function(t){const n=this.getConf("constraint"),s=new l.Constraints;if(n){const r=this.getHierName();if(n.actor){e(n.actor),t.actor=s.getConstraints(n.actor);const a=JSON.stringify(n.actor);this.debug(`Found actor constraint for ${r}: ${a}`)}if(n.item){e(n.item),t.item=s.getConstraints(n.item);const a=JSON.stringify(n.item);this.debug(`Found item constraint for ${r}: ${a}`)}if(n.food){e(n.food),t.food=s.getConstraints(n.food);const a=JSON.stringify(n.food);this.debug(`Found food constraint for ${r}: ${a}`)}if(n.gold){e(n.gold),t.gold=s.getConstraints(n.gold);const a=JSON.stringify(n.gold);this.debug(`Found gold constraint for ${r}: ${a}`)}if(n.shop){const e=[];n.shop.forEach(t=>{e.push(s.getConstraints(t))}),t.shopFunc=e;const a=JSON.stringify(n.shop);this.debug(`Found shop constraint for ${r}: ${a}`)}if(n.disposition){n.disposition;t.disposition=n.disposition}if(n.cellsAround){const{cellsAround:e}=n;t.cellsAround=e}}const r=this.getConf("groupType"),a=this.getConf("cityType"),o=this.getConf("quarterType"),i=this.getConf("alignment"),c=this.getConf("wallType"),u=this.getConf("floorType"),h=this.getConf("friendly");r&&(t.groupType=r),a&&(t.cityType=a),o&&(t.cityType=o),i&&(t.alignment=i),c&&(t.wallType=c),u&&(t.floorType=u),h&&(t.friendly=!0)},this._verifyConstraintKeys=function(e){const t=new Set(["actor","item","food","gold","shop","disposition"]);Object.keys(e).forEach(n=>{if(!t.has(n)){const t=JSON.stringify(e);a.default.err("Factory.World","_verifyConstraintKeys",`Unsupported key ${n} in ${t}`)}})},this.setAreaLevelConstraints=function(e,t,n){const s=t+","+n,r=this.getConf("constraint");if(r&&r.hasOwnProperty(s)){const t={name:"AreaLevel["+s+"]",constraint:r[s]};this.pushScope(t),this.setLevelConstraints(e),this.popScope(t)}},this.addFixedFeatures=function(e,t,n){const s=this.getConf("create");if(s&&s.actor){s.actor.forEach(s=>{if(s.nLevel===e){const e=s.name;s.hasOwnProperty("target")&&(n.getName(),s.target),this.factZone.addActorToLevel(e,t)}})}if(s&&s.stairs){s.stairs.forEach(n=>{if(n.nLevel===e){const{x:e,y:s,isDown:r}=n,a=new C(r?"stairsDown":"stairsUp",t);t.addStairs(a,e,s)}})}},this.getPresetLevels=function(e,t){const n=this.getConf("presetLevels");if(n){const t=Object.keys(n).find(t=>new RegExp(t+"$").test(e));if(t)return n[t]}const s=Object.keys(this.presetLevels).find(t=>new RegExp(t+"$").test(e));if(s)return this.presetLevels[s];if(t&&t.createPresetLevels){const{createPresetLevels:e}=t,n=new o.LevelFactory(this).create(e.new,e.args);if(!n){let e="Found createPresetLevels but no levels created";e+=" conf: "+JSON.stringify(t),a.default.err("Factory","getPresetLevels",e)}return n}return[]},this.createMountain=function(e){this._verif.verifyConf("createMountain",e,["name","nFaces","face"]),this.pushScope(e);const t=new d.Mountain(e.name);if(t.setHierName(this.getHierName()),e.nFaces!==e.face.length){const t=e.face.length;a.default.err("Factory.World","createMountain",`Face number mismatch [] = ${t}, n: ${e.nFaces}`)}for(let n=0;n<e.nFaces;n++){const s=e.face[n],r=this.createMountainFace(s);t.addSubZone(r),this.addWorldID(s,r)}for(let n=0;n<e.nSummits;n++){const s=e.summit[n],r=this.createSummit(s);t.addSubZone(r),this.addWorldID(s,r)}return this.id2levelSet||(e.nFaces>1||1===e.nFaces&&e.nSummits>0)&&(e.connectLevels&&e.connectLevels.length>0?e.connectLevels.forEach(e=>{4===e.length?t.connectSubZones(...e):a.default.err("Factory.World","createMountain","Each connection.length must be 4.")}):a.default.err("Factory.World","createMountain","nFaces > 1, but no conf.connectLevels.")),this.popScope(e),t},this.createMountainFace=function(e){this.id2levelSet?this._verif.verifyConf("createMountainFace",e,["name","nLevels"]):this._verif.verifyConf("createMountainFace",e,["name","nLevels","x","y"]);const t=e.name;this.pushScope(e);const n=new d.MountainFace(t),s={x:e.x,y:e.y};this.setLevelConstraints(s);for(let t=0;t<e.nLevels;t++){let r=null;if(this.id2levelSet){const n=e.levels[t];r=this.id2level[n]}else r=this.factZone.createMountainLevel(s);n.addLevel(r)}return this._addEntranceToSubZone(n,e),this.popScope(e),n},this.createSummit=function(e){this._verif.verifyConf("createSummit",e,["name","nLevels"]),this.pushScope(e);const t=new d.MountainSummit(e.name),n=Object.assign({},e);this.setLevelConstraints(n),this.addMaxDangerIfMissing(n);for(let s=0;s<e.nLevels;s++){let r=null;if(this.id2levelSet){const t=e.levels[s];r=this.id2level[t]}else{r=this.factZone.createSummitLevel(n);const t=new S.DungeonFeatures("mountain");s===e.nLevels-1&&t.addLastLevelFeatures(s,r,n)}t.addLevel(r)}return this._addEntranceToSubZone(t,e),this.popScope(e),t},this.addMaxDangerIfMissing=function(e){if(Number.isInteger(e.maxDanger)||(e.maxDanger=this.getConf("maxDanger")),!Number.isInteger(e.maxValue)){const t=this.getConf("maxValue");t&&(e.maxValue=t)}},this._addEntranceToSubZone=function(e,t){t.hasOwnProperty("entranceLevel")?e.addEntrance(t.entranceLevel):t.hasOwnProperty("entrance")&&e.setEntranceLocation(t.entrance)},this.createCity=function(e){this._verif.verifyConf("createCity",e,["name","nQuarters"]),this.pushScope(e);const t=new d.City(e.name);if(t.setHierName(this.getHierName()),e.nQuarters!==e.quarter.length){const t=e.quarter.length;a.default.err("Factory.World","createCity",`Quarter number mismatch [] = ${t}, n: ${e.nQuarters}`)}for(let n=0;n<e.nQuarters;n++){const s=e.quarter[n],r=this.createCityQuarter(s);t.addSubZone(r),this.addWorldID(s,r)}if(!this.id2levelSet&&e.nQuarters>1)if(e.connectLevels)e.connectLevels.forEach(e=>{4===e.length?t.abutQuarters(...e):a.default.err("Factory.World","createCity","Each connection.length must be 4.")});else{let t="nQuarters > 1, but no conf.connectLevels.";t+=`cityConf: ${JSON.stringify(e)}`,a.default.err("Factory.World","createCity",t)}return this.popScope(e),t},this.createCityQuarter=function(e){this._verif.verifyConf("createCityQuarter",e,["name","nLevels"]),this.pushScope(e);const t=new d.CityQuarter(e.name),n=this.getHierName();t.setHierName(n);const s=this.getPresetLevels(n,e),r={x:e.x||80,y:e.y||40,nShops:e.nShops||1,shopFunc:e.shop||[t=>t.value<=50+50*e.nLevels]};0===e.nShops&&(r.nShops=0),this.setLevelConstraints(r);for(let i=0;i<e.nLevels;i++){let l=this.getFromPresetLevels(i,s);if(l)if(l.stub){(l=new o.LevelFactory(this).create(l.new,l.args))||a.default.err("Factory","createCityQuarter","Stub found but cannot create level"),c.enabled&&this.debug("Creating level from stub "+JSON.stringify(l.stub))}else e.createPresetLevels&&e.create?this.addFixedFeatures(i,l,t):this.debug(`cityQuarter ${n} ${i} from preset level`);else if(this.id2levelSet){const t=e.levels[i];l=this.id2level[t]}else l=this.factZone.createCityLevel(i,r),this.addFixedFeatures(i,l,t);if(!this.id2levelSet&&l.hasExtras()){const e=l.getExtras();Array.isArray(e.shops)&&e.shops.forEach(e=>{t.addShop(e)})}t.addLevel(l)}return this.id2levelSet||t.connectLevels(),this._addEntranceToSubZone(t,e),e.hasOwnProperty("shops")&&e.shops.forEach(e=>{const n=new d.WorldShop;if(n.setLevel(this.id2level[e.level]),n.setCoord(e.coord),n._isAbandoned=e.isAbandoned,!e.isAbandoned){const t=this.id2entity[e.shopkeeper];if(t)n.setShopkeeper(t);else{const t=e.shopkeeper,n=`Possible IDs: ${Object.keys(this.id2entity)}`;a.default.err("Factory","createCityQuarter",`Cannot find shopkeeper ID ${t}. ${n}`)}}t.addShop(n)}),this.popScope(e),t},this.createBattleZone=(e=>{this.pushScope(e);const t=new d.BattleZone(e.name);this.id2levelSet||a.default.err("Factory","createBattleZone","Can create BattleZones only during restore");for(let n=0;n<e.nLevels;n++){const s=e.levels[n],r=this.id2level[s];r?t.addLevel(r):a.default.err("Factory","createBattleZone",`Cannot find level ID ${s} for BattleZone`)}return this.popScope(e),t}),this.getConnectionName=function(e,t,n){let s="";if("city"===t)s="town",e.groupType&&"fort"===e.groupType&&(s="cityfort");else if("mountain"===t)s="mountain";else if(Array.isArray(n)){s=!n[0].isDown()?"stairsDown":"stairsUp"}else{s=!n.isDown()?"stairsDown":"stairsUp"}return s},this.getTileStairsXY=((e,t)=>{let[n,s]=[t.levelX,t.levelY];if(a.default.isNullOrUndef([n,s])){const t=e.getEmptyRandCell();n=t.getX(),s=t.getY()}let r=e.getMap().getCell(n,s),o=a.default.WATCHDOG;for(;r.hasConnection();){const t=e.getEmptyRandCell();if(n=t.getX(),s=t.getY(),r=e.getMap().getCell(n,s),--o<=0)break}return[n,s]}),this.getEntryStairs=((e,t,n)=>{if(n.length>0){const s=t.getX(),r=t.getY();return e.getElements().indexOf(t)>=0&&(e.removeElement(t,s,r)||a.default.err("Factory.World","getEntryStairs","Cannot remove entryStairs")),n}return t}),this.processConnObject=((e,t,n)=>{const s=e.nLevel,r=e.levelX,o=e.levelY,i=e.name;this.debug(`Processing connection obj ${i}: ${r},${o}`);const l=t.findLevel(i,s);if(l){let s=e.stairs||null;if(s&&!a.default.isNullOrUndef([s.getStairs])){const e=s.getStairs;if(s=l.getStairs()[e])this.debug("conn found via getStairs connObject");else{let t=`zoneStairs null, index: ${e}`;t+=`\tPoss: ${JSON.stringify(l.getStairs())}`,a.default.err("Factory.World","processConnObject",t)}}if(s){if("function"!=typeof s.getSrcLevel){const e=JSON.stringify(s);a.default.err("Factory.World","processConnObject",`zoneStairs not a proper stairs object ${e}`)}}else s=this.createNewZoneConnects(t,l);let i="stairsDown";"city"===t.getType()?i="town":"mountain"===t.getType()&&(i="mountain");const c=new C(i,n,l);n.addStairs(c,r,o);try{c.connect(s)}catch(e){console.error(e);let t=`zoneLevel: ${JSON.stringify(l,null,1)}`;t+=`\n\tzoneStairs: ${JSON.stringify(s)}`,a.default.err("Factory.World","createAreaZoneConnection",t)}}else{let n=`connectToAreaXY: ${JSON.stringify(e)}`;n+=`zone: ${JSON.stringify(t)}`,a.default.err("Factory.World","createAreaZoneConnection",`No level found. ${n}`)}}),this.createNewZoneConnects=((e,t)=>{let n=null;return"dungeon"===e.getType()?n=this.createDungeonZoneConnect(e,t):"city"===e.getType()?n=this.createCityZoneConnect(e,t):"mountain"===e.getType()&&(this.debug("Creating new mountain south connection"),n=d.addExitsToEdge(t,"passage","south",!0)),n}),this.createDungeonZoneConnect=((e,t)=>{this.debug("Creating dungeon connection");let n=0,s=0;if(t.hasExtras()){const r=t.getExtras();if(r.startPoint)[n,s]=r.startPoint;else if(r.connectEdges)return this.createCityZoneConnect(e,t)}else{const e=t.getFreeRandCell();[n,s]=e.getXY()}const r=new C("stairsUp",t);return t.addStairs(r,n,s),r}),this.createCityZoneConnect=((e,t)=>{let n=null;this.debug("Creating new city edge connection");let s=[];if(a.default.CARDINAL_DIR.forEach(e=>{if(!d.edgeHasConnections(t,e)){const n=d.addExitsToEdge(t,"passage",e);n.length>0&&(s=s.concat(n))}}),0===(n=s).length){const e=t.getFreeRandCell(),s=e.getX(),r=e.getY();n=new C("stairsUp",t),t.addStairs(n,s,r),n=[n],this.debug("City edge connection failed. Added stairs")}return n}),this.debugPrintCityConns=((e,t)=>{if(c.enabled&&"city"===e){const e=t.getConnections();let n=JSON.stringify(e[0],null,1);e.length>1&&(n+=JSON.stringify(e[e.length-1],null,1)),this.debug(`First/last conn: ${n}`),this.debug(`conn length after: ${e.length}`)}}),this.addWorldID=function(e,t){a.default.isNullOrUndef([e.id])||t.setID(e.id),this.worldElemByID[t.getID()]=t},this.createQuests=function(e,t,n,s){(new E.QuestPopulate).createQuests(e,t,n,s)}},t.FactoryWorld.prototype.createAreaZoneConnection=function(e,t,n){this._verif.verifyConf("createAreaZoneConnection",n,["x","y"]),this.debug("Creating area-zone connections");const{x:s,y:r}=n,o=e.getTileXY(s,r).getLevel();O(n,o," CALL 1"),"function"!=typeof t.getEntrances&&a.default.err("Factory.World","createAreaZoneConnection","No getEntrances method for zone.");const i=t.getEntrances();if(i.length>0){let e=i[0];const s=e.getSrcLevel(),r=t.getType();this.debug("Connecting area-zone by entrance");let l=null;if(r.match(/(city|mountain)/)||n.connectEdges){c.enabled&&(l=s.getConnections(),this.debug(`conn length before: ${l.length}`));const n=this.createNewZoneConnects(t,s);e=this.getEntryStairs(s,e,n)}const u=this.getConnectionName(n,r,e);O(n,o," CALL 2");const h=new C(u,o,s),[d,p]=this.getTileStairsXY(o,n);try{o.addStairs(h,d,p),h.connect(e)}catch(e){throw a.default.log("Given conf: "+JSON.stringify(n)),e}this.debugPrintCityConns(r,s)}else if(!n.hasOwnProperty("connectToAreaXY")){const e=`No entrances in ${t.getHierName()}.`;a.default.err("Factory.World","createAreaZoneConnection",`${e}. Cannot connect to tile.`)}if(n.hasOwnProperty("connectToAreaXY")){n.connectToAreaXY.forEach(e=>{this.processConnObject(e,t,o)})}},t.FactoryWorld.prototype.addActorSpawner=function(e,t,n){const s=n.maxDanger+1,r=[{op:"eq",prop:"type",value:i.ActorGen.getRaces()}],o=(new m.FactoryActor).createActorSpawner(s,r);e.addVirtualProp(a.default.TYPE_ACTOR,o)},t.FactoryWorld.prototype.debug=function(e){if(c.enabled){let t=this.getHierName();t||(t="EMPTY"),c(`|${t}| ${e}`)}}},function(e,t){
/*!
 * Chai - flag utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t,n){var s=e.__flags||(e.__flags=Object.create(null));if(3!==arguments.length)return s[t];s[t]=n}},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=E(n(0)),a=E(n(1)),o=E(n(101)),i=n(13),l=E(n(271)),c=E(n(176)),u=E(n(291)),h=E(n(294)),d=E(n(295)),p=E(n(296)),f=E(n(297)),m=E(n(178)),g=E(n(38)),y=E(n(33)),v=E(n(76)),_=E(n(49)),b=E(n(63));function E(e){return e&&e.__esModule?e:{default:e}}var S={},C="modal",w=void 0;function T(e){return a.default.createElement(u.default,s({},e,{timeout:M.TRANSITION_DURATION}))}function O(e){return a.default.createElement(u.default,s({},e,{timeout:M.BACKDROP_TRANSITION_DURATION}))}var M=function(e){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.call(this));return n.handleEntering=n.handleEntering.bind(n),n.handleExiting=n.handleExiting.bind(n),n.state={classes:""},n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.getDefaultPrefix=function(){return C},t.prototype.getChildContext=function(){return this._context||(this._context={onModalHide:this.props.onHide})},t.prototype.componentDidMount=function(){var e,t,n,s=this;w=w||(t=document.createElement("div"),n=document.createElement("div"),t.className="modal hide",n.className="modal-backdrop hide",document.body.appendChild(t),document.body.appendChild(n),S.modal=+(0,_.default)(t,"z-index"),S.backdrop=+(0,_.default)(n,"z-index"),e=S.modal-S.backdrop,document.body.removeChild(t),document.body.removeChild(n),function(t){return S[t]+e*(s.props.manager.modals.length-1)})},t.prototype.handleEntering=function(){this._show.apply(this,arguments),this.props.onEntering&&this.props.onEntering()},t.prototype.handleExiting=function(){this._removeAttentionClasses(),this.props.onExiting&&this.props.onExiting()},t.prototype.render=function(){var e=this,n=this.props,r=n.className,o=n.children,i=n.keyboard,c=n.transition,u=n.modalPrefix,h=n.dialogClassName,d=n.container,p=n.onEnter,f=n.onEntered,m=n.onExit,g=n.onExited,y=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(n,["className","children","keyboard","transition","modalPrefix","dialogClassName","container","onEnter","onEntered","onExit","onExited"]),v=this.state,_=v.dialog,E=v.classes,S=v.backdrop;delete y.manager;var C,w,M=(C=y,w=Object.keys(t.propTypes),Object.keys(C).reduce(function(e,t){return-1===w.indexOf(t)&&(e[t]=C[t]),e},{})),A=u||t.getDefaultPrefix();!0===c&&(c=T);var N=a.default.createElement("div",s({},M,{ref:function(t){return e.dialog=t},style:_,className:(0,b.default)(r,A,{in:y.show&&!c}),onClick:this.props.backdrop?function(t){return e.handleBackdropClick(t)}:null}),a.default.createElement("div",{key:"modal",ref:function(t){return e.innerRef=t},className:(0,b.default)(A+"-dialog",h,E,(y.small||y.sm)&&A+"-sm",(y.large||y.lg)&&A+"-lg")},a.default.createElement("div",{className:A+"-content"},o)));return a.default.createElement(l.default,{keyboard:i,ref:function(t){e.modal=t&&t.modal,e.backdrop=t&&t.backdrop},container:d,backdrop:y.backdrop,show:y.show,backdropStyle:S,backdropClassName:A+"-backdrop",containerClassName:A+"-open",transition:c||void 0,backdropTransition:c?O:void 0,onHide:this.props.onHide,onEnter:p,onEntering:this.handleEntering,onEntered:f,onExit:m,onExiting:this.handleExiting,onExited:g},N)},t.prototype.attention=function(){var e=this,t=this.props.attentionClass;t&&this.setState({classes:""},function(){e.props.show&&(e.innerRef.offsetWidth,e.setState({classes:t+" animated"}))})},t.prototype.handleBackdropClick=function(e){if(e.target===e.currentTarget)return"static"===this.props.backdrop?this.attention():void this.props.onHide()},t.prototype._show=function(){this.props.show&&this.setState(this._getStyles())},t.prototype._getStyles=function(){if(!y.default)return{};var e=(0,i.findDOMNode)(this.dialog),t=(0,g.default)(e),n=e.scrollHeight,s=(0,c.default)(this.props.container||t.body),r=n>t.documentElement.clientHeight;return{dialog:{zIndex:w("modal"),paddingRight:s&&!r?(0,v.default)():void 0,paddingLeft:!s&&r?(0,v.default)():void 0},backdrop:{zIndex:w("backdrop")}}},t.prototype._removeAttentionClasses=function(){this.setState({classes:""})},t}(a.default.Component);function A(){return C}M.propTypes={show:r.default.bool,small:r.default.bool,sm:r.default.bool,large:r.default.bool,lg:r.default.bool,backdrop:r.default.oneOf(["static",!0,!1]),keyboard:r.default.bool,animate:r.default.bool,transition:r.default.any,container:r.default.oneOfType([o.default,r.default.func]),onHide:r.default.func,onEnter:r.default.func,onEntering:r.default.func,onEntered:r.default.func,onExit:r.default.func,onExiting:r.default.func,onExited:r.default.func,modalPrefix:r.default.string,dialogClassName:r.default.string,attentionClass:r.default.string},M.defaultProps={backdrop:!0,keyboard:!0,animate:!0,transition:!0,container:y.default?document.body:null,attentionClass:"shake",manager:(l.default.getDefaultProps?l.default.getDefaultProps():l.default.defaultProps).manager},M.childContextTypes={onModalHide:r.default.func},M.injectCSSPrefix=function(e){C=e},h.default.getDefaultPrefix=A,d.default.getDefaultPrefix=A,p.default.getDefaultPrefix=A,f.default.getDefaultPrefix=A,M.Body=h.default,M.Header=d.default,M.Title=p.default,M.Footer=f.default,M.Dismiss=m.default,M.BaseModal=M,M.TRANSITION_DURATION=300,M.BACKDROP_TRANSITION_DURATION=150,t.default=M,e.exports=t.default},function(e,t,n){var s;
/*!
  Copyright (c) 2017 Jed Watson.
  Licensed under the MIT License (MIT), see
  http://jedwatson.github.io/classnames
*/
/*!
  Copyright (c) 2017 Jed Watson.
  Licensed under the MIT License (MIT), see
  http://jedwatson.github.io/classnames
*/
!function(){"use strict";var n={}.hasOwnProperty;function r(){for(var e=[],t=0;t<arguments.length;t++){var s=arguments[t];if(s){var a=typeof s;if("string"===a||"number"===a)e.push(s);else if(Array.isArray(s)&&s.length){var o=r.apply(null,s);o&&e.push(o)}else if("object"===a)for(var i in s)n.call(s,i)&&s[i]&&e.push(i)}}return e.join(" ")}e.exports?(r.default=r,e.exports=r):void 0===(s=function(){return r}.apply(t,[]))||(e.exports=s)}()},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(43),i=r(n(11)),l=n(185),c=n(9),u=n(131),h=n(126),d=n(14),{Abilities:p}=u.Ability,f=c.Random.getRNG();t.ActorClass={},t.ActorClass.create=function(e,n){if(t.ActorClass.hasOwnProperty(e)){return new t.ActorClass[e](n)}return a.default.diag("Called with entity:"),a.default.diag(n),a.default.err("ActorClass","create",`No class ${e} in ActorClass`),null},t.ActorClass.getLevelUpObject=function(e,t){const n=new o.MenuInfoOnly,s=t.getActor(),r=t.getClassName(),a=t.getLevelUpMsg(e),i=`${s.getName()} is now level ${e} ${r}`;return n.addPre([`Congratulations! ${i}`]),n.addPre(a),n},t.ActorClass.addAbility=function(e,t){let n=null;if(n=t.has("Abilities")?t.get("Abilities").abilities:new p,u.Ability.hasOwnProperty(e)){const t=new u.Ability[e];n.addAbility(t)}else a.default.err("ActorClass","addAbility",`Cannot find Ability.${e} for new`)};t.ActorClass.startingItems={Alpinist:[{name:"Ration",count:1},{name:"rope",count:1},{func:e=>"mineral"===e.type,count:2}],Adventurer:[{name:"Ration",count:2},{name:"firemaking kit",count:1},{func:e=>"potion"===e.type,count:1}],Cryomancer:[{name:"Ration",count:1},{name:"Potion of power",count:1}],Marksman:[{name:"Ration",count:1}],Blademaster:[{name:"Ration",count:1}],Spiritcrafter:[{name:"Ration",count:1},{name:"Ordinary spirit gem"},{name:"Potion of spirit form"}],Spellsinger:[{name:"Ration",count:1},{name:"Potion of eagle",count:1}]};t.ActorClass.equipment={Alpinist:[{name:"Piolet",count:1},{name:"Spiked boots",count:1}],Adventurer:[{name:"Short sword",count:1},{name:"Leather armour",count:1}],Cryomancer:[{name:"Robe",count:1},{name:"Wooden staff",count:1}],Marksman:[{name:"Leather armour",count:1},{name:"Wooden bow",count:1},{name:"Wooden arrow",count:15}],Blademaster:[{name:"Longsword",count:1},{name:"Chain helmet",count:1},{name:"Chain armour",count:1}],Spiritcrafter:[{name:"Robe",count:1},{name:"Mace",count:1}],Spellsinger:[{name:"Iron staff",count:1},{name:"Leather armour",count:1}]},t.ActorClass.getEquipment=function(e){return C(t.ActorClass.equipment[e])},t.ActorClass.getStartingItems=function(e){return C(t.ActorClass.startingItems[e])};class m{constructor(e,t){this._actor=e,e.setActorClass(this),this._className=t}getActor(){return this._actor}getClassName(){return this._className}getLevelUpMsg(e){let t="";return this._messages.hasOwnProperty(e)&&(t+=this._messages[e]),t+=`\n${this._lastStateIncr}`}advanceLevel(){const e=this._actor.get("Experience").getExpLevel();if(this._messages.hasOwnProperty(e)){const t=this._actor.getCell();t&&a.default.gameMsg({cell:t,msg:this._messages[e]})}this._advances.hasOwnProperty(e)&&this._advances[e](),this.incrStats(e)}incrStats(e){const t=this._actor;this._lastStateIncr="";const n=t.get("Health"),s=Math.ceil(t.getStrength()/2);if(n.setMaxHP(n.getMaxHP()+s),n.setHP(n.getHP()+s),t.has("SpellPower")){const e=Math.ceil(t.getMagic()/2),n=t.get("SpellPower");n.setMaxPP(n.getMaxPP()+e),n.addPP(e)}const r=f.arrayGetRand(a.default.STATS);this._lastStateIncr=`${r} was increased`,t.get("Stats").incrStat(r,1),a.default.levelUpCombatStats(t,e)}}t.ActorClassBase=m;class g extends m{constructor(e){super(e,"Alpinist");const n=e.getName();this._messages={4:`${n} can climb on difficult terrain now`,8:`${n} can jump over obstacles such as chasms now`,12:`${n} can now hide from enemies using terrain`},this._advances={1:()=>{},4:()=>{this._actor.add(new i.Climber)},8:()=>{this._actor.add(new i.Jumper)},12:()=>{t.ActorClass.addAbility("Camouflage",this._actor)},16:()=>{},20:()=>{},24:()=>{},28:()=>{},32:()=>{}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("perception",3),e.incrStat("agility",3),e.incrStat("magic",-2)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("perception",1),this._lastStateIncr+="\nPerception was increased."),e%3!=1&&(t.incrStat("agility",1),this._lastStateIncr+="\nAgility was increased.")}}t.Alpinist=g,t.ActorClass.Alpinist=g;class y extends m{constructor(e){super(e,"Adventurer");const t=e.getName();this._messages={4:`Food is now more nourishing for ${t}`},this._advances={1:()=>{const e=new l.Spell.SpellBook(this._actor);this._actor.setBook(e)},4:()=>{this._actor.add(new i.NourishedOne)}}}advanceLevel(){super.advanceLevel();const e=this._actor.get("Experience").getExpLevel();if(e%4==0&&!this._advances.hasOwnProperty(e)){const n=f.arrayGetRand(t.ACTOR_CLASSES_NO_ADV),s=new t.ActorClass[n](this.getActor());s.advanceLevel(),this._messages[e]=s._messages[e]}}setStartingStats(){const e=this._actor.get("Stats");for(let t=0;t<3;t++){let t=f.arrayGetRand(a.default.STATS);t=t.toLowerCase(),e.incrStat(t,f.getUniformInt(1,3))}}incrStats(e){super.incrStats(e);const t=f.arrayGetRand(a.default.STATS);this._lastStateIncr+=`\n${t} was increased.`,this._actor.get("Stats").incrStat(t,1)}}t.Adventurer=y,t.ActorClass.Adventurer=y;class v extends m{constructor(e){super(e,"Blademaster");const n=e.getName();this._messages={4:`${n} knows now how to defend more skillfully`,8:`${n} knows now how to hit enemies more accurately`,12:`${n} knows now how to handle equipment better`,16:`${n} can now strike in two directions`,20:`${n} can now keep the weapons sharp`,24:`${n} can now wield two blades at once`,28:`${n} can now strike back immediately when attacked`,32:`${n} has become a True Blademaster`},this._advances={1:()=>{},4:()=>{this._actor.add(new i.Defender)},8:()=>{this._actor.add(new i.Attacker)},12:()=>{this._actor.add(new i.MasterEquipper)},16:()=>{this._actor.add(new i.BiDirStrike)},20:()=>{this._actor.add(new i.Sharpener),t.ActorClass.addAbility("Sharpener",this._actor)},24:()=>{this._actor.add(new i.Ambidexterity)},28:()=>{this._actor.add(new i.CounterAttack)},32:()=>{this._actor.get("Combat").setAttackRange(2),this._actor.add(new i.LongReach)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("strength",3),e.incrStat("magic",-3)}getLevelUpMsg(e){return super.getLevelUpMsg(e)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("strength",1),this._lastStateIncr+="\nStrength was increased."),e%3==0&&(t.incrStat("accuracy",1),this._lastStateIncr+="\nAccuracy was increased.")}}t.Blademaster=v,t.ActorClass.Blademaster=v;class _ extends m{constructor(e){super(e,"Cryomancer");const t=e.getName();this._messages={4:`${t} learns a protection spell`,8:`${t} learns a spell to attack enemies from distance`,12:`${t} can freeze enemies on their tracks`,16:`${t} can summon an ice companion now`,20:`${t} can drain power from other spellcasters`,24:`${t} can fire ice arrows towards enemies`,28:`${t} can control their enemies now`,32:`${t} has become a True Cryomancer, Harbinger of Blizzard`},this._advances={1:()=>{const e=new l.Spell.SpellBook(this._actor),t=new l.Spell.GraspOfWinter;e.addSpell(t),this._actor.setBook(e)},4:()=>{this._actor.getBook().addSpell(new l.Spell.IceShield)},8:()=>{this._actor.getBook().addSpell(new l.Spell.FrostBolt)},12:()=>{this._actor.getBook().addSpell(new l.Spell.IcyPrison)},16:()=>{this._actor.getBook().addSpell(new l.Spell.SummonIceMinion)},20:()=>{this._actor.getBook().addSpell(new l.Spell.PowerDrain)},24:()=>{this._actor.getBook().addSpell(new l.Spell.IceArrow)},28:()=>{this._actor.getBook().addSpell(new l.Spell.MindControl)},32:()=>{this._actor.getBook().addSpell(new l.Spell.Blizzard)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("strength",-2),e.incrStat("magic",3)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("magic",1),this._lastStateIncr+="\nMagic was increased."),e%3==0&&(t.incrStat("willpower",1),this._lastStateIncr+="\nWillpower was increased.")}}t.Cryomancer=_,t.ActorClass.Cryomancer=_;class b extends m{constructor(e){super(e,"Marksman");const t=e.getName();this._messages={4:`${t} can now see and shoot further`,8:`${t} deals now more damage with each shot`,12:`${t} can bypass enemies with ranged attacks`,16:`${t} can use arrows/bolts interchangeably`,20:`${t} can shoot even further`,24:`${t} can evade ranged attacks`,28:`${t} can shoot enemies critically`,32:`${t} has become a True Marksman`},this._advances={1:()=>{},4:()=>{this._actor.add(new i.EagleEye)},8:()=>{this._actor.add(new i.StrongShot)},12:()=>{this._actor.add(new i.ThroughShot)},16:()=>{this._actor.add(new i.MixedShot)},20:()=>{this._actor.add(new i.LongRangeShot)},24:()=>{this._actor.add(new i.RangedEvasion)},28:()=>{this._actor.add(new i.CriticalShot)},32:()=>{this._actor.add(new i.DoubleShot)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("accuracy",3),e.incrStat("perception",2),e.incrStat("magic",-3)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("accuracy",1),this._lastStateIncr+="\nAccuracy was increased."),e%3==0&&(t.incrStat("perception",1),this._lastStateIncr+="\nPerception was increased."),e%3==1&&(t.incrStat("agility",1),this._lastStateIncr+="\nAgility was increased.")}}t.Marksman=b,t.ActorClass.Marksman=b;class E extends m{constructor(e){super(e,"Spellsinger");const t=e.getName();this._messages={4:`${t} can now summon animals`,8:`${t} can heal wounds`,12:`${t} can fly like an eagle`,16:`${t} can now paralyse enemies`,20:`${t} can summon lightning on enemies`,24:`${t} controls powers of the sky`,28:`${t} can attack enemies in multiple directions`,32:`${t} has become a Mighty Spellsinger`},this._advances={1:()=>{const e=new l.Spell.SpellBook(this._actor);this._actor.setBook(e),this._actor.getBook().addSpell(new l.Spell.MagicArmor)},4:()=>{this._actor.getBook().addSpell(new l.Spell.SummonAnimal)},8:()=>{this._actor.getBook().addSpell(new l.Spell.Heal)},12:()=>{this._actor.getBook().addSpell(new l.Spell.Flying)},16:()=>{this._actor.getBook().addSpell(new l.Spell.Paralysis)},20:()=>{this._actor.getBook().addSpell(new l.Spell.LightningArrow)},24:()=>{const e=new l.Spell.SummonAirElemental;this._actor.getBook().addSpell(e)},28:()=>{this._actor.getBook().addSpell(new l.Spell.CrossBolt)},32:()=>{this._actor.getBook().addSpell(new l.Spell.RockStorm)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("perception",2),e.incrStat("magic",2)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("magic",1),this._lastStateIncr+="\nMagic was increased."),e%3==0&&(t.incrStat("perception",1),this._lastStateIncr+="\nPerception was increased.")}}t.Spellsinger=E,t.ActorClass.Spellsinger=E;class S extends m{constructor(e){super(e,"Spiritcrafter");const t=e.getName();this._messages={4:`${t} can now equip 2 spirit gems`,8:`${t} learns to project small amounts of energy`,12:`${t} learns to create protective forcefields`,16:`${t} can now equip 3 spirit gems`,20:`${t} can now bind spirit gems to items`,24:`${t} can take a spirit form now`,28:`${t} gains new skill`,32:`${t} has become a Mighty Spiritcrafter`},this._advances={1:()=>{const e=new l.Spell.SpellBook(this._actor);this._actor.setBook(e)},4:()=>{this.getActor().getInvEq().getEquipment().addSlot("spiritgem",new h.EquipSlot("spiritgem"))},8:()=>{this._actor.getBook().addSpell(new l.Spell.EnergyArrow)},12:()=>{this._actor.getBook().addSpell(new l.Spell.ForceField)},16:()=>{this.getActor().getInvEq().getEquipment().addSlot("spiritgem",new h.EquipSlot("spiritgem"))},20:()=>{this._actor.add(new i.SpiritItemCrafter)},24:()=>{this._actor.getBook().addSpell(new l.Spell.SpiritForm)},28:()=>{this._actor.getBook().addSpell(new l.Spell.EnergyStorm)},32:()=>{this.getActor().getInvEq().getEquipment().addSlot("spiritgem",new h.EquipSlot("spiritgem")),this._actor.getBook().addSpell(new l.Spell.RingOfEnergy)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("willpower",4),e.incrStat("magic",2)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("willpower",1),this._lastStateIncr+="\nWillpower was increased."),e%3==0&&(t.incrStat("magic",1),this._lastStateIncr+="\nMagic was increased.")}}function C(e){const t=d.ObjectShell.getParser(),n=[];return e.forEach(e=>{if("function"==typeof e){const s=t.createRandomItem(e);n.push({name:s.getName(),count:1})}else if(e.func){const s=t.createRandomItem(e.func);e.count?n.push({name:s.getName(),count:e.count}):n.push({name:s.getName(),count:1})}else n.push(e)}),n}t.Spiritcrafter=S,t.ActorClass.Spiritcrafter=S,t.ACTOR_CLASSES=["Cryomancer","Blademaster","Marksman","Spiritcrafter","Adventurer","Alpinist","Spellsinger"],t.ACTOR_CLASSES_NO_ADV=t.ACTOR_CLASSES.filter(e=>"Adventurer"!==e)},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=r(n(11)),i=n(12),l=n(105),c=n(123),u=n(9);t.ACTION_ALREADY_DONE=Object.freeze(()=>{}),t.NO_ACTION_TAKEN=Object.freeze(()=>{});const h=u.Random.getRNG();t.Brain={},t.Brain.getCellsAroundActor=((e,t=1)=>{const n=e.getLevel().getMap(),[s,r]=e.getXY(),a=[];for(let e=s-t;e<=s+t;e++)for(let o=r-t;o<=r+t;o++)n.hasXY(e,o)&&(e===s&&o===r||a.push(n.getCell(e,o)));return a}),t.Brain.getBoxOfFreeCellsAround=((e,t)=>{const n=e.getLevel().getMap(),[s,r]=e.getXY();let a=i.Geometry.getBoxAround(s,r,t),o=(a=a.filter(e=>n.hasXY(e[0],e[1]))).map(e=>n.getCell(e[0],e[1]));return o=o.filter(e=>e.isFree())}),t.Brain.findCellsWithActors=((e,t,n)=>{const s=[];for(let r=0,a=t.length;r<a;r++)if(t[r].hasProp("actors")){const a=t[r].getProp("actors");a[0].getID()!==e.getID()&&(n&&n(a),s.push(t[r]))}return s}),t.Brain.getActorsInCells=((e,t)=>{const n=[];for(let s=0,r=e.length;s<r;s++)if(e[s].hasProp("actors")){const r=e[s].getProp("actors");1===r.length?t?t(r[0])&&n.push(r[0]):n.push(r[0]):r.forEach(e=>{t?t(e)&&n.push(e):n.push(e)})}return n}),t.Brain.getSeenHostiles=(e=>{const n=e.getBrain().getSeenCells();return t.Brain.getActorsInCells(n,t=>t.isEnemy(e))}),t.Brain.findCellsWithFriends=((e,t)=>{const n=[];for(let s=0,r=t.length;s<r;s++)if(t[s].hasActors()){t[s].getSentientActors().forEach(r=>{r.getID()!==e.getID()&&(r.isEnemy(e)||n.push(t[s]))})}return n}),t.Brain.getActorCellsAround=(e=>{return t.Brain.getCellsAroundActor(e).filter(e=>e.hasActors())}),t.Brain.getActorsAround=(e=>{const n=t.Brain.getCellsAroundActor(e);let s=[];return n.forEach(e=>{e.hasActors()&&(s=s.concat(e.getActors()))}),s}),t.Brain.getEnemyCellsAround=(e=>{return t.Brain.getCellsAroundActor(e).filter(t=>t.hasActors()&&e.getBrain().getMemory().isEnemy(t.getActors()[0]))}),t.Brain.getFriendCellsAround=(e=>{return t.Brain.getCellsAroundActor(e).filter(t=>t.hasActors()&&e.getBrain().getMemory().isFriend(t.getActors()[0]))}),t.Brain.distToActor=((e,t)=>{const[n,s]=e.getXY(),[r,a]=t.getXY();return function(e,t,n,s){const r=i.Geometry.getBresenham(e,t,n,s).length-1;return r>0?r:0}(n,s,r,a)}),t.Brain.getTelepathyCells=function(e){const t=e.getLevel().getID(),n=e.getList("Telepathy");let s=[];return n.forEach(e=>{const n=e.getTarget(),r=n.getLevel();if(a.default.isActorActive(n)&&r.getID()===t){const e=r.getMap().getVisibleCells(n);s=s.concat(e)}}),s};class d extends l.BrainBase{constructor(e){super(e),this.setType("NonSentient")}decideNextAction(e){return t.NO_ACTION_TAKEN}}t.BrainNonSentient=d,t.Brain.NonSentient=d;class p extends l.BrainBase{constructor(e){super(e),this._explored={},this._type="Sentient",this._memory=new c.Memory,this._cache={seen:null}}getMemory(){return this._memory}addEnemy(e){this._memory.addEnemy(e)}addFriend(e){this._memory.addFriend(e)}addEnemyType(e){this._memory.addEnemyType(e)}decideNextAction(e){return this._cache.seen=null,a.default.err("BrainSentient","decideNextAction","Not implemented in this class"),null}getSeenCells(){if(this._cache.seen)return this._cache.seen;const e=this._actor.getLevel().getMap();if(this._cache.seen=e.getVisibleCells(this._actor),this._actor.has("Telepathy")){const e=t.Brain.getTelepathyCells(this._actor);this._cache.seen=this._cache.seen.concat(e)}return this._cache.seen}canMeleeAttack(e,t){const n=this._actor.get("Combat").getAttackRange(),[s,r]=a.default.dXdYAbs([e,t],this._actor);return s<=n&&r<=n}findSeenCell(e){return this.getSeenCells().filter(e)}canSeeActor(e){const n=this.getSeenCells(),s=t.Brain.findCellsWithActors(this._actor,n);let r=!1;return s.forEach(t=>{t.getActors().forEach(t=>{t.getID()===e.getID()&&(r=!0)})}),r}findEnemyCell(e){const n=[],s=t.Brain.findCellsWithActors(this._actor,e);for(let e=0;e<s.length;e++){const t=s[e].getSentientActors();for(let r=0;r<t.length;r++)if(this._memory.isEnemy(t[r])){if(this._memory.addEnemySeenCell(t[r]),this._memory.wasLastAttacked(t[r]))return s[e];n.push(s[e])}}return n.length>0?h.arrayGetRand(n):null}findFriendCell(e){const n=this.getMemory(),s=t.Brain.findCellsWithActors(this._actor,e);for(let e=0;e<s.length;e++){const t=s[e].getActors();if(!n.isEnemy(t[0]))return s[e]}return null}toJSON(){return{type:this.getType(),memory:this.getMemory().toJSON()}}canPickupItem(){const e=this._actor.getCell();if(e.hasItems()){const t=e.getItems()[0];return this._actor.getInvEq().canCarryItem(t)}return!1}pickupItem(){return()=>{const e=new o.Pickup;this._actor.add(e)}}actionTowardsEnemy(e){const t=this._actor.getLevel(),n=e.getX(),s=e.getY();return this.canMeleeAttack(n,s)?()=>{const e=t.getMap().getCell(n,s).getProp("actors")[0],r=new o.Attack({target:e});this._actor.add(r)}:this.tryToMoveTowardsCell(e)}tryToMoveTowardsCell(e){const n=this._actor.getLevel(),[s,r]=this._actor.getXY(),[a,i]=[e.getX(),e.getY()];let[l,c]=[a-s,i-r];l=0!==l?l/Math.abs(l):0,c=0!==c?c/Math.abs(c):0;const[u,h]=[s+l,r+c];if(n.getMap().getCell(u,h).isPassable())return()=>{const e=new o.Movement(u,h,n);this._actor.add(e)};const d=this.getShortestPathTo(e);if(d.length>1){const e=d[1].getX(),t=d[1].getY();return()=>{const s=new o.Movement(e,t,n);this._actor.add(s)}}return t.NO_ACTION_TAKEN}getSeenFriends(){const e=[],n=this.getMemory(),s=this.getSeenCells(),r=t.Brain.findCellsWithActors(this._actor,s);for(let t=0;t<r.length;t++){const s=r[t].getActors();n.isFriend(s[0])&&e.push(s[0])}return e}getSeenEnemies(){const e=this.getMemory(),n=this.getSeenCells();return t.Brain.getActorsInCells(n,t=>e.isEnemy(t))}exploreLevel(e){let n=-1,s=[];for(let t=0;t<e.length;t++)s.push(t);for(let r=0,a=(s=h.shuffle(s)).length;r<a;r++){const a=s[r],i=e[a];if(i.isFree()){const e=i.getX()+","+i.getY();if(!this._explored.hasOwnProperty(e)){this._explored[e]=!0,n=a;break}}else if(i.hasDoor()){const e=i.getPropType("door")[0];if(e.canToggle()){const n=new o.OpenDoor;return n.setDoor(e),this._actor.add(n),t.ACTION_ALREADY_DONE}}}return-1===n&&(n=h.randIndex(e)),this.tryToMoveTowardsCell(e[n])}getShortestPathTo(e){const[t,n]=e.getXY();return this._actor.getLevel().getMap().getShortestPathTo(this._actor,t,n)}fleeFromCell(e,t){const n=e.getX(),s=e.getY(),r=this._actor.getX(),a=this._actor.getY(),o=r-(n-r),i=a-(s-a);if(this._actor.getLevel().getMap().hasXY(o,i)){const e=this._actor.getLevel().getMap().getCell(o,i);if(e.isPassable())return this.tryToMoveTowardsCell(e);if(this._actor.has("Flying")&&e.isPassableByAir())return this.tryToMoveTowardsCell(e)}return this.exploreLevel(t)}getFreeCellsAround(){return t.Brain.getCellsAroundActor(this._actor).filter(e=>e.isFree())}getRandAdjacentFreeCell(){const e=this.getFreeCellsAround();return e.length>0?h.arrayGetRand(e):null}}t.BrainSentient=p,t.Brain.Sentient=p},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(23)),a=s(n(8)),o=n(18).EventPool.getPool();t.Time={};class i{constructor(e,t){this._duration=e,this._cb=t,this._energy=0}setEnergy(e){this._energy=e}getEnergy(){return this._energy}getDuration(){return this._duration}doAction(){this._cb()}}t.Action=i;class l{constructor(e,t,n,s){this.isEvent=!0,this.dur=e,this.cb=t,this._repeat=n,this._offset=s,this._level=null}isPlayer(){return!1}nextAction(){return new i(this.dur,this.cb)}getRepeat(){return this._repeat}setRepeat(e){this._repeat=e}getOffset(){return this._offset}setOffset(e){this._offset=e}setLevel(e){this._level=e}getLevel(){return this._level}}t.GameEvent=l;t.RegenEvent=class extends l{constructor(e,t){super(t,()=>{e.get("Health").addHP(1)},!0,0)}};t.RegenPPEvent=class extends l{constructor(e,t){super(t,()=>{e.get("SpellPower").addPP(1)},!0,0)}};t.OneShotEvent=class extends l{constructor(e,t,n){super(0,()=>{a.default.isNullOrUndef([n])||a.default.gameMsg(n),e()},!1,t)}},t.Scheduler=function(){this._scheduler=new r.default.Scheduler.Action,this._scheduler._defaultDuration=0,this._scheduler._duration=0,this._events=[],this._actors=[],this.hasNotify=!0,o.listenEvent(a.default.EVT_ACTOR_KILLED,this)},t.Scheduler.prototype.add=function(e,t,n){this._scheduler.add(e,t,n),e.hasOwnProperty("isEvent")?this._events.push(e):this._actors.push(e)},t.Scheduler.prototype.next=function(){return this._scheduler.next()},t.Scheduler.prototype.setAction=function(e){this._scheduler.setDuration(e.getDuration())},t.Scheduler.prototype.remove=function(e){if(e.hasOwnProperty("isEvent"))return this.removeEvent(e);{const t=this._actors.indexOf(e);-1!==t&&this._actors.splice(t,1)}return this._scheduler.remove(e)},t.Scheduler.prototype.removeEvent=function(e){let t=-1;return e.hasOwnProperty("isEvent")&&-1!==(t=this._events.indexOf(e))&&this._events.splice(t,1),this._scheduler.remove(e)},t.Scheduler.prototype.getTime=function(){return this._scheduler.getTime()},t.Scheduler.prototype.notify=function(e,t){e===a.default.EVT_ACTOR_KILLED&&t.hasOwnProperty("actor")&&this.remove(t.actor)}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8));t.Template={},t.Template.$DEBUG=0;const a=/[A-Z]/,o=/\s*=\s*/,i=/\s*:\s*/,l=e=>{t.Template.$DEBUG&&console.log("[DEBUG "+e)};function c(e){const t=e.length,n={},s=[1];let r="",o="",i=0;for(let l=1;l<t;l++)o=e[l],a.test(o)?i>0?r===o?++i:(n[s.length]=i,s.push(i),i=1):++i:i>0?(n[s.length]=i,s.push(i),s.push(1),i=0):s.push(1),r=o;return i>0&&(n[s.length]=i,s.push(i)),{genPos:n,widths:s}}t.Template.createTemplate=function(e){const n=e.split("\n");let s=0,a=n[0];0===a.length&&(a=n[++s]);const u={},h={};for(;a&&a.length>0;){if(o.test(a)){const e=a.split(o);if(2===e.length){const t=e[0],n=e[1];t.length===n.length?u[e[0]]=e[1]:r.default.err("Template","createTemplate",`Key ${t}, val ${n} have different len`)}}else if(i.test(a)){const e=a.split(i);if(2===e.length){const t=e[0],n=e[1];h[t]=n}else r.default.warn("Template","createTemplate",`Prop must be key:val. Ignoring line ${a}`)}a=n[++s]}s===n.length&&r.default.err("Template","createTemplate","No empty line between header and template section."),++s;const d=[];for(;s<n.length;)d.push(n[s]),++s;let p=d[0].split("");const{genPos:f,widths:m}=c(p);l(JSON.stringify(f)),l(JSON.stringify(m));const g=[],y=[];let v=0;for(let e=0;e<d.length;e++){let t=0,n=0;y.push([]),p=d[e].split(""),l(JSON.stringify(`y: ${v} currLineArr: ${p}`)),g.push(p[0]);for(let e=0;e<m.length;e++){const s=m[e],r=p.slice(t,t+s);l(`x: ${t}, w: ${s}, elem: ${r}`),r&&(y[v][n]=r),t+=s,++n}++v}y.forEach((e,t)=>{l(`Row[${t}]: ${JSON.stringify(e)}`)}),l("firstCols is: "+JSON.stringify(g));const{genPos:_,widths:b}=c(g);l("@yGenPos: "+JSON.stringify(_)),l("@yWidths: "+JSON.stringify(b));const E={xGenPos:f,yGenPos:_,xWidths:m,yWidths:b,rows:y,elemMap:u},S=new t.ElemTemplate(E);return S.setProps(h),S},t.ElemTemplate=function(e){if(e&&(this.elemMap=e.elemMap,this.nMaps=Object.keys(this.elemMap).length,this.sizeX=e.xWidths.length,this.sizeY=e.rows.length,this.xWidths=e.xWidths,this.yWidths=e.yWidths,this.xGenPos=e.xGenPos,this.yGenPos=e.yGenPos),this.elemPropMap={},this.elemArr=[],this.hasGenRow={},e){for(let t=0;t<this.sizeX;t++){this.elemArr[t]=[];for(let n=0;n<this.sizeY;n++)this.elemArr[t][n]=e.rows[n][t].join("")}Object.keys(this.xGenPos).forEach(e=>{for(let t=0;t<this.sizeY;t++){const n=this.elemArr[e][t];this.elemArr[e][t]=new u(n)}})}this.setProps=function(e){this.elemPropMap=e},this.getProp=function(e){return this.elemPropMap[e]},this.getDir=function(){const e=this.getProp("dir");return e?e.split("").sort().join(""):""},this.setProp=function(e,t){this.elemPropMap[e]=t},this.getChars=function(e){if(e){if(Number.isInteger(e)){const t=e;e=[];for(let n=0;n<this.nMaps;n++)e.push(t)}}else{e=[];for(let t=0;t<this.nMaps;t++)e.push(1)}if(!(e.length>0&&e.length<this.nMaps)){let t=0,n=!1;const s=[];for(let r=0;r<this.sizeX;r++){s[r]=[];for(let a=0;a<this.sizeY;a++)if("object"==typeof this.elemArr[r][a]){const o=e[t];s[r][a]=this.elemArr[r][a].getChars(o),n=!0}else s[r][a]=this.elemArr[r][a];n&&(++t,n=!1)}this.substituteXMaps(s),l("X before split: "+JSON.stringify(s));const a=this.splitMultiElements(s);if(l("After-X, Before-Y: "+JSON.stringify(a)),Object.keys(this.yGenPos).length>0){const n=[];for(let e=0;e<this.sizeX;e++){n[e]=[];let t=0,r=0;this.yWidths.forEach(a=>{n[e][t]=s[e].slice(r,r+a),++t,r+=a})}l("y after widths "+JSON.stringify(n)),Object.keys(this.yGenPos).forEach(s=>{for(let r=0;r<this.sizeX;r++)n[r][s]=this.expandYGen(e[t],n[r][s]);++t});const a=r.default.flattenTo2D(n);l("y after flatten "+JSON.stringify(a));const o=this.splitMultiElements(a);return l("y after flatten "+JSON.stringify(o)),this.substituteYMaps(o),o}return l("X-Before subst: "+JSON.stringify(s)),l("X-After, split: "+JSON.stringify(a)),a}return r.default.err("ElemTemplate","getChars",`Input array length must be ${this.nMaps}.`),[]},this.expandYGen=((e,t)=>{l(`expandYGen ${e} -> ${t}`);const n=[];for(let s=0;s<e;s++)n.push(t);return n}),this.substituteXMaps=function(e){const t=e.length;Object.keys(this.elemMap).forEach(n=>{const s=new RegExp(n,"g");for(let r=0;r<t;r++)e[r][0]=e[r][0].replace(s,this.elemMap[n])})},this.substituteYMaps=function(e){let n=[];const s=e[0].length;for(let t=0;t<s;t++)n.push(e[0][t]);l("firstCol is now: "+JSON.stringify(n));let a=n.join("");Object.keys(this.elemMap).forEach(e=>{const t=new RegExp(e,"g");a=a.replace(t,this.elemMap[e])}),n=a.split(""),l("firstCol END: "+JSON.stringify(n)),t.Template.$DEBUG&&r.default.printMap(e);for(let t=0;t<s;t++)e[0][t]=n[t]},this.splitMultiElements=(e=>{const t=e.length,n=[];let s=0;for(let r=0;r<t;r++){const t=e[r],a=t[0].length;if(a>1){l(`Splitting ${a} nChars: ${t}`);for(let e=0;e<t.length;e++){const r=t[e];let a=s;r.split("").forEach(t=>{0===e?(n.push([t]),l("\tres push "+JSON.stringify(n))):(n[a++].push(t),l("\tres[x] push "+JSON.stringify(n)))})}s+=a}else++s,n.push(t)}return n}),this.clone=(()=>{const e=new t.ElemTemplate,n=JSON.parse(JSON.stringify(this));return Object.keys(n).forEach(t=>{e[t]=n[t]}),Object.keys(this.xGenPos).forEach(t=>{for(let n=0;n<this.sizeY;n++){const s=e.elemArr[t][n].genX;e.elemArr[t][n]=new u(s)}}),e})},t.Template.ElemTemplate=t.ElemTemplate;const u=function(e){const t=e.length;this.length=(()=>t),this.getChars=((t=1)=>e.repeat(t)),this.toJSON=(()=>({genX:e}))};t.Template.ElemGenX=u;const h={N:"E",E:"S",S:"W",W:"N"},d={rotate90:h,rotate180:h,rotate270:h};t.Template.rotateR90=function(e,t=h){const n=e.clone();f(n,t);const s=[];let r=Object.keys(n.xGenPos).length;r+=Object.keys(n.yGenPos).length;for(let e=0;e<r;e++)s.push(1);const a=n.getChars(s),o=a[0].length,i=new Array(o);for(let e=0;e<o;e++)i[e]=[];for(let e=0;e<a.length;e++)for(let t=0;t<o;t++)i[o-1-t].push(a[e][t]);n.yGenPos=Object.assign({},e.xGenPos);const l=i.length;return n.xGenPos={},Object.keys(e.yGenPos).forEach(t=>{const s=l-1-parseInt(t,10);n.xGenPos[s]=e.yGenPos[t]}),n.elemArr=i,Object.keys(n.xGenPos).forEach(e=>{for(let t=0;t<n.sizeY;t++)try{n.elemArr[e][t]=new u(n.elemArr[e][t])}catch(e){throw console.log("Template:",n.getProp("name")),console.log("xGenPos: ",n.xGenPos),new Error(e)}}),n},t.Template.rotateR180=function(e,n=h){const s=t.Template.rotateR90(e,n);return t.Template.rotateR90(s,n)},t.Template.rotateR270=function(e,n=h){const s=t.Template.rotateR180(e,n);return t.Template.rotateR90(s,n)};const p={E:"W",W:"E"};function f(e,t){const n=e.getProp("dir");if(n){const s=n.split("");s.forEach((e,n)=>{t.hasOwnProperty(e)&&(s[n]=t[e])}),e.setProp("dir",s.join(""))}}function m(e,t){let n=t.getProp("name");switch(e){case"rotateR90":n+="_r90";break;case"rotateR180":n+="_r180";break;case"rotateR270":n+="_r270";break;case"flipVer":n+="_flip"}t.setProp("name",n)}d.flipVer=p,t.Template.flipVer=function(e,t=p){const n=e.clone();f(n,t);const s=[];let r=Object.keys(n.xGenPos).length;r+=Object.keys(n.yGenPos).length;for(let e=0;e<r;e++)s.push(1);const a=n.sizeX,o=new Array(a);for(let e=0;e<a;e++)o[e]=[];const i=n.sizeY,l=n.getChars(s);for(let e=0;e<a;e++)for(let t=0;t<i;t++)o[a-1-e][t]=l[e][t];const c=o.length;return n.xGenPos={},Object.keys(e.xGenPos).forEach(t=>{if(parseInt(t,10)<c-1){const s=c-1-parseInt(t,10);n.xGenPos[s]=e.xGenPos[t]}else{const s=t;n.xGenPos[s]=e.xGenPos[t]}}),n.elemArr=o,Object.keys(n.xGenPos).forEach(e=>{for(let t=0;t<n.sizeY;t++)n.elemArr[e][t]=new u(n.elemArr[e][t])}),n},t.Template.transformList=function(e,n,s){r.default.isNullOrUndef([e])&&r.default.err("Template","transformList","Input list templates is null");let a=[];return n||(n={all:"*",flipVer:[],rotateR90:[],rotateR180:[],rotateR270:[]}),Object.keys(n).forEach(r=>{if("all"!==r){const o=[];let i=n[r];(i="*"===n.all?e.map(e=>e.getProp("name")):i.concat(n.all)).forEach(a=>{const i=e.find(e=>e.getProp("name")===a);if(i){const e=s?s[r]:d[r],l=t.Template[r](i,e);m(r,l),o.push(l),"flipVer"===r&&function(e,t){const n=[];return["rotateR90","rotateR180","rotateR270"].forEach(s=>{(e[s].indexOf(t)>=0||"*"===e.all)&&n.push(s)}),n}(n,a).forEach(e=>{const n=s?s[e]:d[e],r=t.Template[e](l,n);m(e,r),o.push(r)})}}),a=a.concat(o)}}),a}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(9),i=n(12),l=n(44),c=n(54),u=n(46),h=n(109),d=r(n(11)),p=n(41),f=r(n(34)),m=r(n(15)),g=n(14),y=n(195),v=n(129),_=2,b=o.Random.getRNG(),E=["NOTHING","LOOT","GOLD","GUARDIAN","ELEMENT","CORPSE","TIP"],S=.5;t.DungeonPopulate=class{constructor(e={}){this.theme=e.theme||"",this.maxDanger=e.maxDanger||5,this.maxValue=e.maxValue||50,this._itemFact=new u.FactoryItem,this._actorFact=new h.FactoryActor}populateLevel(e){const t=e.getExtras(),n=this.maxDanger,s=this.maxValue;let r=!1;const o={};t.bigRooms&&t.bigRooms.forEach(t=>{const{room:i,type:l}=t,c=i.getBbox(),u=i.getAreaSize(),h={maxDanger:n,func:e=>e.danger<=n+2,nActors:0};let d=!1;if(/cross/.test(l)?(h.nActors=Math.floor(u/6),d=this.addActorsToBbox(e,c,h)):(h.nActors=Math.floor(u/3),d=this.addActorsToBbox(e,c,h)),!d){const e="Failed to add actors to bbox ";a.default.warn("DungeonPopulate","populateLevel",e+JSON.stringify(c))}if(!r){const t=i.getCenter();r=this.addMainLoot(e,t,s)}o[i.getID()]=!0}),t.terms&&t.terms.forEach(t=>{if(!t.hasStairsUp()){const n=t.getBbox();if(!r){const n=t.getCenter();r=this.addMainLoot(e,n,s)}const a=t.getAreaSize(),o=Math.ceil(a/10),l={maxValue:s,itemsPerLevel:o,func:e=>e.value<=s};this.addItemsToBbox(e,n,l),i.Geometry.getCoordBbox(n).forEach(t=>{const n=new m.ElementMarker("e");n.setTag("enemy"),e.addElement(n,t[0],t[1])})}o[t.getID()]=!0}),t.rooms&&t.rooms.forEach(t=>{const r=t.getBbox(),a=t.getAreaSize(),i={maxDanger:n,func:e=>e.danger<=n,nActors:Math.floor(a/6)};i.nActors<_&&(i.nActors=_),this.addActorsToBbox(e,r,i);const l=Math.ceil(a/20),c={maxValue:s,itemsPerLevel:l,func:e=>e.value<=s};this.addItemsToBbox(e,r,c),o[t.getID()]=!0}),t.endPoint&&this.addPointGuardian(e,t.endPoint,n)}setActorFunc(e){"function"==typeof e?this.actorFunc=e:a.default.err("DungeonPopulate","setActorFunc",`Tried to set non-function ${e} as actorFunc`)}addPointGuardian(e,t,n){const s=t;(a.default.isNullOrUndef([n])||n<1)&&a.default.err("DungeonPopulate","addPointGuardian",`maxDanger must be > 0. Got: |${n}|`);const r=this.getEndPointGuardian(n);if(r){if(r.getBrain().getGoal){const e=new l.Evaluator.Guard(a.default.BIAS.Guard,s);r.getBrain().getGoal().addEvaluator(e)}e.addActor(r,s[0],s[1])}else{const e=`Could not get guardian for endpoint: ${t}`;a.default.warn("DungeonPopulate","addPointGuardian",e)}}getEndPointGuardian(e){let t=e,n=null,s=t=>n=>n.danger<=e&&n.danger>=t;for(this.actorFunc&&(s=(e=>n=>this.actorFunc(n)&&n.danger<=t&&n.danger>=e));!n&&t>0;)n=this._actorFact.createRandomActor({func:s(t)}),--t;return n}addMainLoot(e,t,n){const[s,r]=t,o=b.getUniformInt(2,3),i=o*n,l=(o-1)*n,c=e=>e.value>=l&&e.value<=i;let u=null;if(a.default.isSuccess(S)){const e=g.ObjectShell.getParser(),t=y.ItemGen.genRandShellWith(c);u=e.createFromShell(a.default.TYPE_ITEM,t)}else u=this._itemFact.createItem({func:c});return!!u&&(e.addItem(u,s,r),!0)}populatePoint(e,t,n){const{maxDanger:s}=n;switch(b.arrayGetRand(E)){case"NOTHING":break;case"LOOT":this.addLootToPoint(e,t);break;case"GUARDIAN":this.addPointGuardian(e,t,s);break;case"ELEMENT":this.addElementToPoint(e,t,n);break;case"CORPSE":this.addCorpseToPoint(e,t,n);break;case"GOLD":this.addGoldToPoint(e,t);break;case"TIP":this.addTipToPoint(e,t,n)}}addElementToPoint(e,t,n){n.true}addCorpseToPoint(e,t,n){n.true}addLootToPoint(e,t){const n=this.maxValue,s=[a.default.ITEM_POTION,a.default.ITEM_SPIRITGEM,a.default.ITEM_AMMUNITION,a.default.ITEM_POTION,a.default.ITEM_RUNE],r=b.arrayGetRand(s),o=g.ObjectShell.getParser().createRandomItem({func:e=>e.type>=r&&e.value<=n});if(o){const[n,s]=t;return e.addItem(o,n,s),!0}return!1}addGoldToPoint(e,t){const n=this.maxValue,s=new f.GoldCoin;s.setCount(n);const[r,a]=t;e.addItem(s,r,a)}addTipToPoint(e,t,n){n.true}createShops(e,t){const n=e.getExtras(),s=[];if(n.hasOwnProperty("houses")){const r=n.houses,o=[];let i=0;n.shops=[];for(let c=0;c<t.nShops;c++){const u=new p.WorldShop;let h=b.randIndex(r);for(;o.indexOf(h)>=0;)h=b.randIndex(r),++i==2*r.length&&a.default.err("DungeonPopulate","createShops","WatchDog reached max houses");o.push(h);const f=n.houses[h];s.push(f);const y=f.floor,[v,_]=f.door,E=e.getMap().getCell(v,_);if(!E.hasDoor()){const t=new m.ElementDoor(!0);e.addElement(t,v,_)}const S=this.createShopkeeper(t),C=[];let w=!1;for(let n=0;n<y.length;n++){const s=y[n],r=new m.ElementShop;r.setShopkeeper(S),e.addElement(r,s[0],s[1]),0===n&&(w=!0,e.addActor(S,s[0],s[1])),t.parser||(t.parser=g.ObjectShell.getParser());const o=this._itemFact.getShopItem(c,t);if(o)o.add(new d.Unpaid),e.addItem(o,s[0],s[1]),C.push(s);else{const e="item null. "+`conf: ${JSON.stringify(t)}`;a.default.err("DungeonPopulate","createShop",`${e} shopFunc/type${c} not well defined.`)}}if(!w){const e=JSON.stringify(f);a.default.err("DungeonPopulate","createShops","Could not add keeper to "+e)}if(S.has("Shopkeeper")){const t=S.get("Shopkeeper");t.setCells(C),t.setLevelID(e.getID()),t.setDoorXY(E.getXY());const n=S.getType()+" shopkeeper";S.setName(n),a.default.addCellStyle(a.default.TYPE_ACTOR,n,"cell-actor-shopkeeper");const s=b.arrayGetRand(C);if(S.getBrain().getGoal){const e=new l.Evaluator.Shopkeeper(1.5);e.setArgs({xy:s}),S.getBrain().getGoal().addEvaluator(e)}}u.setShopkeeper(S),u.setLevel(e),u.setCoord(C),n.shops.push(u)}}else a.default.err("DungeonPopulate","createShops","No houses in extras.");return s}createShopkeeper(e){let t=null;if(e.parser)if(e.actor){if(!(t=e.parser.createRandomActor({func:e.actor}))){let t="conf.actor given but no actor found";"function"==typeof e.actor?t+=" conf.actor |\n"+e.actor.toString()+"|":t+=" conf.actor must be function",a.default.err("Factory","createShopkeeper",t)}const n=t.getType()+" shopkeeper";t.setName(n),a.default.addCellStyle(a.default.TYPE_ACTOR,n,"cell-actor-shopkeeper")}else t=e.parser.createActor("shopkeeper");else t=this._actorFact.createActor("shopkeeper",{brain:"Human"});t.add(new d.Shopkeeper);const n=new f.GoldCoin(a.default.GOLD_COIN_NAME);n.setCount(b.getUniformInt(50,200)),t.getInvEq().addItem(n);let s=10;return e.maxDanger>=6&&(s=2*e.maxDanger),a.default.levelUpActor(t,s),t}createTrainers(e,t){const n=e.getExtras().houses;if(a.default.isSuccess(a.default.TRAINER_PROB)){let s=null;if(t.parser)s=t.parser.createActor("trainer");else{const e={maxDanger:5,actorFunc:e=>a.default.ALL_RACES.indexOf(e.type)>=0};s=this.createActor(e)}const r=new d.Trainer;s.add(r);const o=e.getFreeRandCell();if(e.addActor(s,o.getX(),o.getY()),n){const e=b.arrayGetRand(n);if(s.getBrain().getGoal){const t=new l.Evaluator.GoHome(1.5),n=e.getCenter();return t.setArgs({xy:n}),s.getBrain().getGoal().addEvaluator(t),[e]}}}return[]}populateHouse(e,t,n){const s=t.numFloor;let r=Math.round(s/9);0===r&&(r=1);for(let s=0;s<r;s++){const s=this.createActor(n);if(s.getBrain().getGoal){const n=new l.Evaluator.GoHome(1.5),r=t.getFloorCenter();n.setArgs({xy:r}),s.getBrain().getGoal().addEvaluator(n);const a=new m.ElementMarker("H");a.setTag("home"),e.addElement(a,r[0],r[1])}const r=b.arrayGetRand(t.floor);e.addActor(s,r[0],r[1])}}createActor(e){const t=g.ObjectShell.getParser(),n=e.maxDanger||this.maxDanger;let s=null;if(n>0){let r=e=>e.danger<=n;this.actorFunc?r=(e=>this.actorFunc(e)&&e.danger<=n):e.actorFunc&&(r=(t=>e.actorFunc(t)&&t.danger<=n)),s=t.createRandomActor({func:r})}else a.default.err("DungeonPopulate","createActor","maxDanger must be > 0");return s}addActorsToBbox(e,t,n){const s=n.nActors||4,{maxDanger:r,func:a}=n,o=this._actorFact.generateNActors(s,a,r);return c.Placer.addActorsToBbox(e,t,o)}addItemsToBbox(e,t,n){const s=n.nItems||4,r=Object.assign({itemsPerLevel:s},n),a=this._itemFact.generateItems(r);return c.Placer.addItemsToBbox(e,t,a)}addToughAdventurer(e,t,n){const{maxDanger:s}=n.maxDanger,r=s-1,o=v.ActorGen.genRandShellWith(e=>e.danger<=s+4&&e.danger>=r);if(o){const[n,s]=t,r=g.ObjectShell.getParser().createFromShell(a.default.TYPE_ACTOR,o);if(r&&e.addActor(r,n,s))return!0}return!1}}},function(e,t,n){var s=n(55),r=n(92);e.exports=n(72)?function(e,t,n){return s.f(e,t,r(1,n))}:function(e,t,n){return e[t]=n,e}},function(e,t,n){var s=n(71);e.exports=function(e){if(!s(e))throw TypeError(e+" is not an object!");return e}},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t,n){e.exports=!n(91)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e){return(0,r.default)(s.default.findDOMNode(e))};var s=a(n(13)),r=a(n(38));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=n(17)("bitn:Game.FromJSON"),o=s(n(8)),i=n(97),l=n(138),c=n(106),u=n(44),h=n(130),d=n(104),p=n(156),f=n(419),m=n(22),g=n(64),y=n(18),v=n(30),_=n(88),b=n(19),E=n(14),S=n(11),C=n(34),w=n(53),T=n(35),O=r(n(15)),M=n(60),A=r(n(41)),N=n(9),P=n(98),x=r(n(66)),I=n(223),D=n(20),k=n(124),L=n(85),R=y.EventPool.getPool(),B=w.Actor.Sentient;D.Brain.Player=k.BrainPlayer,D.Brain.Spawner=L.BrainSpawner;const G=Symbol();t.FromJSON=function(){this._dungeonLevel=1,this._parser=E.ObjectShell.getParser(),this.id2level={},this.id2entity={},this.id2EntityJson={},this.id2Object={},this.id2Place={},this.actorsKilled={},this.id2Component={},this.id2CompJSON={},this.compsWithMissingRefs={},this.stairsInfo={},this.IND=0},t.FromJSON.prototype.reset=function(){this.id2level={},this.id2entity={},this.id2EntityJson={},this.id2Object={},this.id2Component={},this.id2CompJSON={},this.id2Place={},this.stairsInfo={},this.compsWithMissingRefs={}},t.FromJSON.prototype.setChunkMode=function(e){this.chunkMode=e},t.FromJSON.prototype.getDungeonLevel=function(){return this._dungeonLevel},t.FromJSON.prototype.addObjRef=function(e,t,n){const s=t.getID();Number.isInteger(s)||o.default.err("FromJSON","addObjRef",`ID must be integer. Got: |${s}|`),this.id2entity[s]=t,this.id2Object[s]=t,n&&(this.id2EntityJson[s]=n),"level"===e?(this.id2level[s]=t,this.id2Place[s]=t):"element"===e||"entity"===e||o.default.err("FromJSON","addObjRef",`Unsupported type ${e} give`)},t.FromJSON.prototype.getObjByRef=function(e){let t=null;if("entity"===(t=e.$objRef?e.$objRef:e).type){const e=this.id2entity[t.id];if(!e){if(this.actorsKilled[t.id])return G;o.default.err("FromJSON","getObjRef",`No ID ${t.id} found`)}return e}return"level"===t.type?this.id2level[t.id]:"object"===t.type?this.id2Object[t.id]:"component"===t.type?this.id2Component[t.id]:"place"===t.type?this.id2Place[t.id]:null},t.FromJSON.prototype.createGame=function(e,t){"string"==typeof t&&o.default.err("Game.FromJSON","createGame","An object must be given instead of string"),this.dbg("createGame: Restoring now full game"),this.IND=1,this.setGlobalConfAndObjects(e,t),t.chunkManager&&this.setChunkMode(!0),S.Component.setIDCount(t.lastComponentID);const n=[];if(this.getLevelsToRestore(t).forEach(t=>{const s=this.restoreLevel(t);n.push(s),t.parent||(this.dbg(">> No parent. Adding directly "+s.getID()),e.addLevel(s))}),t.places&&Object.keys(t.places).forEach(n=>{const s=t.places[n],r=this.restorePlace(s);e.addPlace(r)}),t.overworld){const n=this.restoreOverWorld(t.overworld);e.setOverWorld(n)}if(t.worldSim&&e.setWorldSim(this.restoreWorldSim(t.worldSim)),this.connectGameLevels(n),t.player){const n=this.restorePlayer(t.player);this.addRestoredPlayerToGame(n,e,t)}this.restoreEntityData(),this.restoreComponentData();const s=this.restoreGameMaster(e,t.gameMaster);if(e.setGameMaster(s),this.restoreChunkManager(e,t),this.checkNumOfLevels(e,t),d.GameObject.ID=t.gameObjectID,a.enabled&&this.dbg(`Restored GameObject ID count to ${d.GameObject.ID}`),t.rng){const n=new N.Random(t.rng.seed);n.setState(t.rng.state),e.setRNG(n)}if(t.diceRng){const e=new N.Random(t.diceRng.seed);e.setState(t.diceRng.state),v.Dice.RNG=e}return this.IND=0,e},t.FromJSON.prototype.restorePlayer=function(e){const t=new B(e.name);return t.setIsPlayer(!0),t.remove("StatsMods"),t.remove("CombatMods"),t.setType(e.type),t.setID(e.id),this._dungeonLevel=e.dungeonLevel,this.addObjRef("entity",t,e),o.default.addCellStyle(o.default.TYPE_ACTOR,e.name,"cell-actor-player"),t},t.FromJSON.prototype.restorePlayerBrain=function(e,t){const n=e.getBrain(),s=n.getMemory(),r=t.memory;Object.keys(r).forEach(e=>{s[e](r[e])}),t.markList&&n._markList.fromJSON(t.markList)},t.FromJSON.prototype.addRestoredPlayerToGame=function(e,t,n){this._addRegenEvents(t,e);const s=n.player.levelID,r=t.getLevels().find(e=>e.getID()===s);if(r){const s=n.player.x,a=n.player.y;r.addActor(e,s,a),t.addPlayer(e)}else{const e=`IDs available: ${t.getLevels().map(e=>e.getID())}`;o.default.err("Game.FromJSON","addRestoredPlayerToGame",`Cannot find player level object with level ID ${s}. ${e}`)}},t.FromJSON.prototype.restoreEntity=function(e,t){return o.default.isActor(t)?(this.createBrain(e.brain,t),this._addEntityFeatures(e,t)):o.default.isElement(t)?this.restoreElementEntity(e,t):this.restoreLevelEntity(e,t),t},t.FromJSON.prototype._addEntityFeatures=function(e,t){this.addCompsToEntity(t,e.components),this.createInventoryItems(e,t),this.createEquippedItems(e,t),e.fovRange&&t.setFOVRange(e.fovRange),e.spellbook&&this.createSpells(e,t)},t.FromJSON.prototype.restoreElementEntity=function(e,t){"lever"===t.getType()&&e.addTarget.forEach(e=>{const n=e.$objRef,s=this.id2entity[n.id];s&&t.addTarget(s)})},t.FromJSON.prototype.restoreLevelEntity=function(e,t){this.addCompsToEntity(t,e.components)},t.FromJSON.prototype.addCompsToEntity=function(e,t){for(const n in t)if(n){const s=t[n],r=s.setType;if(!r){const e='No "name" in component: ';o.default.err("Game.FromJSON","addCompsToEntity",e+": "+JSON.stringify(s))}const a=this.createComponent(r,s);e.add(a)}},t.FromJSON.prototype.createComponent=function(e,t){if(!S.Component.hasOwnProperty(e)){let n=`No |${e}| in Component.`;n+=` compJSON: ${JSON.stringify(t)}`,o.default.err("Game.FromJSON","createComponent",n)}const n=new S.Component[e];for(const s in t)if("function"==typeof n[s]){const e=t[s],r=this.getCompValue(n,t,s,e);n[s](r)}else{const n=JSON.stringify(t);o.default.err("FromJSON","createComponent",`${s} not function in ${e}. Comp: ${n}`)}const s=n.getID();return this.id2Component[s]=n,this.id2CompJSON[s]=t,n},t.FromJSON.prototype.getCompValue=function(e,t,n,s){if(o.default.isNullOrUndef([s])){const e=JSON.stringify(t);let r=`valueToSet |${s}|. setFunc |${n}|`;r+=`Comp |${t.setType}|, json: ${e}`,o.default.err("FromJSON","addCompsToEntity",r)}else{if(Array.isArray(s)){if(s.$objRefArray)return this.compsWithMissingRefs[t.setID]=e,s;const r=[];return s.forEach(s=>{const a=this.getCompValue(e,t,n,s);r.push(a)}),r}if(s.createFunc){return this[s.createFunc](s.value)}if(s.createComp){const e=s.createComp.setType;return this.createComponent(e,s.createComp)}if(!s.$objRef)return s;if("component"===s.$objRef.type)return this.compsWithMissingRefs[t.setID]=e,s;{const e=this.getObjByRef(s.$objRef);if(e)return e;{let e=`Null obj for objRef ${JSON.stringify(s.$objRef)}`;e+=` compJSON: ${JSON.stringify(t)}`,o.default.err("FromJSON","getCompValue",e)}}}return null},t.FromJSON.prototype.createActorClass=function(e){const{className:t,actorRef:n}=e,s=this.getObjByRef(n);return s?g.ActorClass.create(t,s):(o.default.err("FromJSON","createActorClass",`No actor for class ${t} found`),null)},t.FromJSON.prototype.createQuestData=function(e){const t=new p.QuestData;return e.path.forEach(e=>{let n=null;if((n=e.target.$objRef?this.getObjByRef(e.target.$objRef):e.target)===G)n={msg:"Quest target missing/killed"};else if(!n){const t=`Missing objRef: ${JSON.stringify(e.target)}`;o.default.err("FromJSON","createQuest",t)}t.addTarget(e.type,n)}),t},t.FromJSON.prototype.createBrain=function(e,t){const n=e.type;if(D.Brain[n]){const s=new D.Brain[n](t);if(t.setBrain(s),"Player"===n)return void this.restorePlayerBrain(t,e);e.constraint&&s.setConstraint(e.constraint),e.placeConstraint&&s.setPlaceConstraint(e.constraint),e.spawnProb&&(s.spawnProb=e.spawnProb);const r=s.getMemory(),a=e.memory;if(a){if(a.enemyTypes.forEach(e=>{s.addEnemyType(e)}),a.lastAttackedID){const e=this.id2entity[a.lastAttackedID];r.setLastAttacked(e)}if(a.enemies&&a.enemies.forEach(e=>{const t=this.id2entity[e];t&&r.addEnemy(t)}),a.friends&&a.friends.forEach(e=>{const t=this.id2entity[e];t&&r.addFriend(t)}),a.seen&&(r._actors.seen=a.seen),e.goal){const n=this.createTopGoal(e.goal,t);s.setGoal(n)}}else"Rogue"===n&&s.getMemory().addEnemyType("player")}else o.default.err("FromJSON","createBrain",`Cannot find Brain.${n}, JSON: ${e}`)},t.FromJSON.prototype.createTopGoal=function(e,t){const n=new c.GoalsTop[e.type](t);return n.removeEvaluators(),e.evaluators.forEach(e=>{let s=null;if(u.Evaluator[e.type])s=new u.Evaluator[e.type](e.bias);else if(h.EvaluatorsBattle[e.type])s=new h.EvaluatorsBattle[e.type](e.bias);else{const n=`Entity: ${JSON.stringify(t)}`;o.default.err("FromJSON","createTopGoal",`Evaluator ${e.type} not found. ${n}`)}e.args&&s.setArgs(e.args),n.addEvaluator(s)}),n},t.FromJSON.prototype.createSpells=function(e,t){return t._spellbook=new _.Spell.SpellBook(t),e.spellbook.spells.forEach(e=>{if(_.Spell.hasOwnProperty(e.new)){const n=this.restoreSpell(e,t);t._spellbook.addSpell(n)}else o.default.err("FromJSON","createSpells",`No spell ${e.new} found in Spell`)}),t._spellbook},t.FromJSON.prototype.restoreSpell=function(e,t){const n=new _.Spell[e.new];if(n.setPower(e.power),e.range&&n.setRange(e.range),e.dice){const t={};Object.keys(e.dice).forEach(n=>{const s=e.dice[n];t[n]=v.Dice.create(s)}),n._dice=t}return e.spells&&(n.removeSpells(),e.spells.forEach(e=>{const s=this.restoreSpell(e,t);n.addSpell(s)})),n},t.FromJSON.prototype.createItem=function(e){const t=e;let n=null;if(this._parser.hasItem(e.setName))n=this._parser.createItem(e.setName);else{const s=this.getItemObjectType(t);if(C.Item[s])n=new C.Item[s];else{let t=`No RG.Item[${s}] found for new()`;t+=` JSON: ${JSON.stringify(e)}`,o.default.err("FromJSON","createItem",t)}}for(const e in t)if("setSpirit"===e){const s=t[e],r=this.createActor(s);this._addEntityFeatures(s,r),n[e](r)}else if("function"==typeof n[e])n[e](t[e]);else if("components"!==e&&"isUsable"!==e){const t=JSON.stringify(n);o.default.err("Game.FromJSON","createItem",`${e} not func in ${t}`)}return this.addEntityInfo(n,e),t.components&&this.addCompsToEntity(n,e.components),n},t.FromJSON.prototype.createInventoryItems=function(e,t){if(e.hasOwnProperty("inventory")){const n=e.inventory;for(let e=0;e<n.length;e++){const s=this.createItem(n[e]);t.getInvEq().addItem(s)}}},t.FromJSON.prototype.createEquippedItems=function(e,t){if(e.hasOwnProperty("equipment")){const n=e.equipment;for(let e=0;e<n.length;e++){const s=this.createItem(n[e]);t.getInvEq().restoreEquipped(s)}}},t.FromJSON.prototype.getItemObjectType=function(e){if("spiritgem"===e.setType)return"SpiritGem";if("goldcoin"===e.setType)return"GoldCoin";if("missileweapon"===e.setType)return"MissileWeapon";if(o.default.isNullOrUndef([e]))o.default.err("Game.Save","getItemObjectType","item is undefined");else{if(!o.default.isNullOrUndef([e.setType]))return e.setType.capitalize();{const t=JSON.stringify(e);o.default.err("Game.Save","getItemObjectType","item.setType is undefined. item: "+t)}}return null},t.FromJSON.prototype.restoreLevel=function(e){const t=new m.Level;t.setID(e.id),t.setLevelNumber(e.levelNumber);const n=this.createCellMap(e.map);return t.setMap(n),e.actors.forEach(e=>{const n=this.createActor(e.obj);null!==n?this.isVirtual(e)?t.addVirtualProp(o.default.TYPE_ACTOR,n):t.addActor(n,e.x,e.y):o.default.err("FromJSON","restoreLevel",`Actor ${JSON.stringify(e)} returned null`)}),e.elements.forEach(e=>{const n=this.createElement(e);null!==n?t.addElement(n,e.x,e.y):o.default.err("FromJSON","restoreLevel",`createElement ${JSON.stringify(e)} returned null`)}),e.items.forEach(e=>{const n=this.createItem(e.obj);null!==n?t.addItem(n,e.x,e.y):o.default.err("FromJSON","restoreLevel",`Actor ${JSON.stringify(e)} returned null`)}),this.addLevels([t],"restoreLevel",[e]),t},t.FromJSON.prototype.isVirtual=function(e){return-1===e.x&&-1===e.y},t.FromJSON.prototype.createElement=function(e){const t=e.obj,n=t.type;let s=null;if("connection"===n)s=this.createUnconnectedStairs(e);else if("shop"===n){const e=new O.ElementShop;let n=null;o.default.isNullOrUndef([t.shopkeeper])||((n=this.id2entity[t.shopkeeper])?e.setShopkeeper(n):o.default.err("Game.FromJSON","createElement",`Shopkeeper with ID ${t.shopkeeper} not found`)),e.setCostFactor(t.costFactorBuy,t.costFactorSell),t.isAbandoned&&e.abandonShop(),s=e}else if("door"===n)s=new O.ElementDoor(t.closed);else if("leverdoor"===n)s=new O.ElementLeverDoor(t.closed);else if("lever"===n)s=new O.ElementLever;else if("marker"===n)(s=new O.ElementMarker(t.char)).setTag(t.tag);else if("exploration"===n){const e=new O.ElementExploration;e.setExp(t.setExp),t.data&&e.setData(t.data),s=e}else"web"===n?s=new O.ElementWeb:"slime"===n?s=new O.ElementSlime:"hole"===n&&(s=new O.ElementHole);if(t.msg&&s.setMsg(t.msg),s){const e=t.id;Number.isInteger(e)&&(s.setID(e),this.addObjRef("element",s,t))}return s},t.FromJSON.prototype.createActor=function(e){null===e.type&&o.default.err("FromJSON","createActor",`json.type null, json: ${JSON.stringify(e)}`);let t=null;if(e.new&&w.Actor[e.new])t=new w.Actor[e.new](e.name);else{let t="";const n=JSON.stringify(e);if(e.new){const s=Object.keys(w.Actor);t=`${e.new} not in RG.Actor: ${s}. JSON obj: `+n}else t="No json.new given. JSON obj: "+n;o.default.err("Game.FromJSON","createActor",t)}return t.setType(e.type),t.setID(e.id),this.addEntityInfo(t,e),t},t.FromJSON.prototype.addEntityInfo=function(e,t){this.addObjRef("entity",e,t)},t.FromJSON.prototype.createUnconnectedStairs=function(e){const{x:t,y:n}=e,s=`${e.obj.srcLevel},${t},${n}`,r=e.obj,a=new O.ElementStairs(r.name);return this.stairsInfo[s]={targetLevel:r.targetLevel,targetStairs:r.targetStairs},a},t.FromJSON.prototype.createCellMap=function(e){if(e.encoded)return T.CellMap.fromJSON(e);const t=new T.CellMap(e.cols,e.rows);return e.cells.forEach((e,n)=>{e.forEach((e,s)=>{const r=this.createBaseElem(e);t.setBaseElemXY(n,s,r)})}),e.explored.forEach(e=>{t.getCell(e[0],e[1]).setExplored()}),t},t.FromJSON.prototype.createBaseElem=function(e){const t=b.ELEM_MAP.elemIndexToType[e];return b.ELEM_MAP.elemTypeToObj[t]?b.ELEM_MAP.elemTypeToObj[t]:(o.default.err("Game.fromJSON","createBaseElem",`Unknown type ${t}`),null)},t.FromJSON.prototype.setGlobalConfAndObjects=function(e,t){t.globalConf&&(this.dbg("Setting globalConf for game: "+JSON.stringify(t.globalConf,null,1)),e.setGlobalConf(t.globalConf)),t.cellStyles&&(o.default.cellStyles=t.cellStyles),t.charStyles&&(o.default.charStyles=t.charStyles),t.actorsKilled&&(this.actorsKilled=t.actorsKilled,e.actorsKilled=t.actorsKilled),t.objectShellParser&&E.ObjectShell.restoreParser(t.objectShellParser)},t.FromJSON.prototype.connectGameLevels=function(e){e.forEach(e=>{e.getConnections().forEach(t=>{const n=this.stairsInfo[t.getID()],s=this.id2level[n.targetLevel];if(!s&&this.chunkMode)return void t.setConnObj(n);const r=n.targetStairs;r||(o.default.diag(JSON.stringify(e,null,1)),o.default.diag(n),o.default.diag("Parent: "+e.getParent().getName()),o.default.diag(JSON.stringify(t)));const a=r.x,i=r.y;if(s){t.setTargetLevel(s);const e=s.getMap().getCell(a,i).getConnection();e?t.connect(e):o.default.err("Game.FromJSON","connectGameLevels","Target stairs was null. Cannot connect.")}else{const e=n.targetLevel;o.default.err("Game.FromJSON","connectGameLevels",`Target level ${e} null. Cannot connect.`)}})})},t.FromJSON.prototype.restoreGameMaster=function(e,t){++this.IND;const n=e.getGameMaster(),s={};return Object.keys(t.battles).forEach(e=>{t.battles[e].forEach(t=>{if(s[e]=[],this.id2level[e]){this.dbg(`FromJSON Restoring Battle ${e}`);const n=this.restoreBattle(t);s[e].push(n)}else this.dbg(`FromJSON Battle ${e} not created`),this.dbg(JSON.stringify(t)),s[e].push(t)})}),n.setBattles(s),t.battlesDone&&(n.battlesDone=t.battlesDone),--this.IND,n},t.FromJSON.prototype.restoreBattle=function(e){const t=this.getLevelOrFatal(e.level,"restoreBattle");if(t){++this.IND,this.dbg(`\trestoreBattle found level ID ${e.level}`);const n=new l.Battle(e.name);n.setLevel(t),n.setStats(e.stats),n.finished=e.finished;const s=[];return e.armies.forEach(e=>{s.push(this.restoreArmy(e))}),n.setArmies(s),n.finished&&(a(`${e.name} finished. rm listeners`),R.removeListener(n),s.forEach(e=>{R.removeListener(e)})),--this.IND,n}return o.default.err("Game.FromJSON","restoreBattle",`No level for battle ID's ${e.level}`),null},t.FromJSON.prototype.restoreArmy=function(e){const t=new l.Army(e.name);return e.actors.forEach(e=>{this.id2entity[e]&&t.addActor(this.id2entity[e])}),t.setDefeatThreshold(e.defeatThreshold),Object.entries(e.alignment).forEach(e=>{const[n,s]=e;t.addAlignment(n,s)}),t},t.FromJSON.prototype.restorePlace=function(e){const t=new f.WorldFromJSON(this.id2level,this.id2entity).createPlace(e);return this.id2Place=Object.assign(this.id2Place,t.getID2Place()),t},t.FromJSON.prototype.restoreOverWorld=function(e){const t=i.OWMap.fromJSON(e),n=new P.OverWorld.CoordMap;for(const t in e.coordMap)e.coordMap.hasOwnProperty(t)&&(n[t]=e.coordMap[t]);return t.coordMap=n,t},t.FromJSON.prototype.restoreWorldSim=function(e){return I.WorldSimulation.fromJSON(e)},t.FromJSON.prototype.restoreEntityData=function(){Object.keys(this.id2EntityJson).forEach(e=>{const t=this.id2EntityJson[e],n=this.id2entity[e];if(t&&n)this.restoreEntity(t,n);else{let s=t?"":"|JSON is null/undef|";s+=n?"":"|entity is null/undef|",o.default.err("FromJSON","restoreEntityData",`ID: ${e} ${s}`)}})},t.FromJSON.prototype.restoreComponentData=function(){Object.keys(this.compsWithMissingRefs).forEach(e=>{const t=this.compsWithMissingRefs[e],n=this.id2CompJSON[e];this.restoreComponent(n,t)})},t.FromJSON.prototype.restoreComponent=function(e,t){Object.keys(e).forEach(n=>{const s=e[n];if(Array.isArray(s)){if(s.$objRefArray){const e=[];s.forEach(t=>{if(t.$objRef)e.push(this.getObjByRef(t.$objRef));else{const e=JSON.stringify(s);o.default.err("FromJSON","restoreComponent",`$objRefArray found but no $objRefs inside: ${e}`)}}),t[n](e)}}else s.$objRef&&"component"===s.$objRef.type&&t[n](this.getObjByRef(s.$objRef))})},t.FromJSON.prototype.reportMissingLevel=function(e){let t=`connObj: ${JSON.stringify(e)}`;Object.keys(this.id2level).forEach(e=>{t+=`\n\t${e}`}),console.warn(t+"\n")},t.FromJSON.prototype._addRegenEvents=function(e,t){const n=new x.RegenEvent(t,20*o.default.ACTION_DUR);if(e.addEvent(n),t.has("SpellPower")){const n=new x.RegenPPEvent(t,30*o.default.ACTION_DUR);e.addEvent(n)}},t.FromJSON.prototype.dbg=function(e){if(a.enabled){const t=">".repeat(this.IND);a(`${t} ${e}`)}},t.FromJSON.prototype.getLevelsToRestore=function(e){let t=[],n=0;return e.levels?e.levels:e.places?(Object.keys(e.places).forEach(s=>{const r=e.places[s];r.area&&r.area.forEach(e=>{e.tiles.forEach((s,r)=>{s.forEach((s,a)=>{e.tilesLoaded[r][a]&&(n+=s.levels.length,t=t.concat(s.levels))})})})}),this.dbg(`Restoring ${t.length} out of ${n}`),t):t},t.FromJSON.prototype.createTiles=function(e,t){const n=e.getLevels();this.addLevels(n,"createTiles");let s=[];t.forEach(e=>{s=s.concat(e.levels)});const r=[];s.forEach(e=>{const t=this.restoreLevel(e);r.push(t),n.push(t)}),this.connectGameLevels(r),this.restoreEntityData(),this.restoreComponentData();const a=e.getCurrentWorld().getCurrentArea(),o=new M.FactoryWorld;o.setId2Level(this.id2level),o.id2entity=this.id2entity,t.forEach(t=>{const[n,s]=[t.x,t.y],r=new A.AreaTile(n,s,a),i=this.id2level[t.level];r.setLevel(i),e.addLevel(i);const l=JSON.parse(JSON.stringify(t));a.setTile(n,s,r),i.setParent(a),o.createZonesFromTile(a,l,n,s),this.restoreSerializedBattles(e,r)})},t.FromJSON.prototype.restoreSerializedBattles=function(e,t){const n=t.getLevel().getID(),s=e.getGameMaster();if(s.battles[n]){const e=s.battles[n];s.battles[n]=[],e.forEach(e=>{const t=this.restoreBattle(e);s.battles[n].push(t)})}},t.FromJSON.prototype.addLevels=function(e,t="",n=[]){e.forEach((e,s)=>{const r=e.getID();if(this.id2level.hasOwnProperty(r))o.default.log(e),o.default.err("Game.FromJSON",`addLevels - ${t}`,`Duplicate level ID detected ${r}`);else{let a=null;s<n.length&&(a=n[s]),this.addObjRef("level",e,a),this.dbg(`Added level ${r} to this.id2level ${t}`)}})},t.FromJSON.prototype.connectTileLevels=function(e,t){t.forEach(e=>{const t=e.getID(),n=e.getTargetLevel();this.stairsInfo[t]={targetLevel:n,targetStairs:e.getTargetStairs()}}),this.addLevels(e,"connectTileLevels"),this.connectConnections(t)},t.FromJSON.prototype.connectConnections=function(e){e.forEach(e=>{const t=this.stairsInfo[e.getID()],n=this.id2level[t.targetLevel],s=t.targetStairs,{x:r,y:a}=s;if(n){e.setTargetLevel(n);const t=n.getMap().getCell(r,a).getConnection();t?e.connect(t):o.default.err("Game.FromJSON","connectConnections","Target stairs was null. Cannot connect.")}else{const e=t.targetLevel;o.default.err("Game.FromJSON","connectConnections",`Target level ${e} null. Cannot connect.`)}})},t.FromJSON.prototype.restoreChunkManager=function(e,t){t.chunkManager&&e.setEnableChunkUnload(!0)},t.FromJSON.prototype.checkNumOfLevels=function(e,t){const n=e.getLevels().length;if(t.levels&&n!==t.levels.length){const e=t.levels.length;o.default.err("Game.FromJSON","checkNumOfLevels",`Exp. ${e} levels, after restore ${n}`)}},t.FromJSON.prototype.getLevelOrFatal=function(e,t){if(!Number.isInteger(e)){const n=`ID must be number. Got ${e}`;o.default.err("Game.FromJSON",t,n)}if(this.id2level.hasOwnProperty(e))return this.id2level[e];let n=`No level with ID ${e}.`;return n+=` Available: ${Object.keys(this.id2level)}`,o.default.err("Game.FromJSON",t,n),null}},function(e,t){e.exports={includeStack:!1,showDiff:!0,truncateThreshold:40}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){if((!o&&0!==o||e)&&a.default){var t=document.createElement("div");t.style.position="absolute",t.style.top="-9999px",t.style.width="50px",t.style.height="50px",t.style.overflow="scroll",document.body.appendChild(t),o=t.offsetWidth-t.clientWidth,document.body.removeChild(t)}return o};var s,r=n(33),a=(s=r)&&s.__esModule?s:{default:s};var o=void 0;e.exports=t.default},function(e,t,n){"use strict";e.exports=function(e,t,n,s,r,a,o,i){if(!e){var l;if(void 0===t)l=new Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var c=[n,s,r,a,o,i],u=0;(l=new Error(t.replace(/%s/g,function(){return c[u++]}))).name="Invariant Violation"}throw l.framesToPop=1,l}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){function t(t,n,s,r,a,o){var i=r||"<<anonymous>>",l=o||s;if(null==n[s])return t?new Error("Required "+a+" `"+l+"` was not specified in `"+i+"`."):null;for(var c=arguments.length,u=Array(c>6?c-6:0),h=6;h<c;h++)u[h-6]=arguments[h];return e.apply(void 0,[n,s,i,a,l].concat(u))}var n=t.bind(null,!1);return n.isRequired=t.bind(null,!0),n},e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=S(n(118)),a=S(n(42)),o=S(n(33)),i=S(n(0)),l=S(n(111)),c=S(n(388)),u=S(n(10)),h=n(1),d=S(h),p=S(n(13)),f=S(n(24)),m=S(n(389)),g=S(n(208)),y=S(n(392)),v=S(n(207)),_=S(n(393)),b=S(n(112)),E=S(n(73));function S(e){return e&&e.__esModule?e:{default:e}}function C(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var w=new m.default,T=function(e){function t(){var n,s;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var r=arguments.length,a=Array(r),o=0;o<r;o++)a[o]=arguments[o];return n=s=C(this,e.call.apply(e,[this].concat(a))),O.call(s),C(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.omitProps=function(e,t){var n=Object.keys(e),s={};return n.map(function(n){Object.prototype.hasOwnProperty.call(t,n)||(s[n]=e[n])}),s},t.prototype.render=function(){var e=this.props,n=e.show,r=e.container,a=e.children,o=e.transition,i=e.backdrop,l=e.dialogTransitionTimeout,c=e.className,u=e.style,p=e.onExit,f=e.onExiting,m=e.onEnter,v=e.onEntering,_=e.onEntered,b=d.default.Children.only(a),E=this.omitProps(this.props,t.propTypes);if(!(n||o&&!this.state.exited))return null;var S=b.props,C=S.role,w=S.tabIndex;return void 0!==C&&void 0!==w||(b=(0,h.cloneElement)(b,{role:void 0===C?"document":C,tabIndex:null==w?"-1":w})),o&&(b=d.default.createElement(o,{transitionAppear:!0,unmountOnExit:!0,in:n,timeout:l,onExit:p,onExiting:f,onExited:this.handleHidden,onEnter:m,onEntering:v,onEntered:_},b)),d.default.createElement(g.default,{ref:this.setMountNode,container:r,onRendered:this.onPortalRendered},d.default.createElement("div",s({ref:this.setModalNodeRef,role:C||"dialog"},E,{style:u,className:c}),i&&this.renderBackdrop(),d.default.createElement(y.default,{ref:this.setDialogRef},b)))},t.prototype.componentWillReceiveProps=function(e){e.show?this.setState({exited:!1}):e.transition||this.setState({exited:!0})},t.prototype.componentWillUpdate=function(e){!this.props.show&&e.show&&this.checkForFocus()},t.prototype.componentDidMount=function(){this._isMounted=!0,this.props.show&&this.onShow()},t.prototype.componentDidUpdate=function(e){var t=this.props.transition;!e.show||this.props.show||t?!e.show&&this.props.show&&this.onShow():this.onHide()},t.prototype.componentWillUnmount=function(){var e=this.props,t=e.show,n=e.transition;this._isMounted=!1,(t||n&&!this.state.exited)&&this.onHide()},t.prototype.autoFocus=function(){if(this.props.autoFocus){var e=this.getDialogElement(),t=(0,r.default)((0,E.default)(this));e&&!(0,a.default)(e,t)&&(this.lastFocus=t,e.hasAttribute("tabIndex")||((0,f.default)(!1,'The modal content node does not accept focus. For the benefit of assistive technologies, the tabIndex of the node is being set to "-1".'),e.setAttribute("tabIndex",-1)),e.focus())}},t.prototype.restoreLastFocus=function(){this.lastFocus&&this.lastFocus.focus&&(this.lastFocus.focus(),this.lastFocus=null)},t.prototype.getDialogElement=function(){return p.default.findDOMNode(this.dialog)},t.prototype.isTopModal=function(){return this.props.manager.isTopModal(this)},t}(d.default.Component);T.propTypes=s({},g.default.propTypes,{show:i.default.bool,container:i.default.oneOfType([l.default,i.default.func]),onShow:i.default.func,onHide:i.default.func,backdrop:i.default.oneOfType([i.default.bool,i.default.oneOf(["static"])]),renderBackdrop:i.default.func,onEscapeKeyDown:i.default.func,onEscapeKeyUp:(0,c.default)(i.default.func,"Please use onEscapeKeyDown instead for consistency"),onBackdropClick:i.default.func,backdropStyle:i.default.object,backdropClassName:i.default.string,containerClassName:i.default.string,keyboard:i.default.bool,transition:u.default,dialogTransitionTimeout:i.default.number,backdropTransitionTimeout:i.default.number,autoFocus:i.default.bool,enforceFocus:i.default.bool,restoreFocus:i.default.bool,onEnter:i.default.func,onEntering:i.default.func,onEntered:i.default.func,onExit:i.default.func,onExiting:i.default.func,onExited:i.default.func,manager:i.default.object.isRequired}),T.defaultProps={show:!1,backdrop:!0,keyboard:!0,autoFocus:!0,enforceFocus:!0,restoreFocus:!0,onHide:function(){},manager:w,renderBackdrop:function(e){return d.default.createElement("div",e)}};var O=function(){var e=this;this.state={exited:!this.props.show},this.renderBackdrop=function(){var t=e.props,n=t.backdropStyle,s=t.backdropClassName,r=t.renderBackdrop,a=t.transition,o=t.backdropTransitionTimeout,i=r({ref:function(t){return e.backdrop=t},style:n,className:s,onClick:e.handleBackdropClick});return a&&(i=d.default.createElement(a,{transitionAppear:!0,in:e.props.show,timeout:o},i)),i},this.onPortalRendered=function(){e.autoFocus(),e.props.onShow&&e.props.onShow()},this.onShow=function(){var t=(0,E.default)(e),n=(0,b.default)(e.props.container,t.body);e.props.manager.add(e,n,e.props.containerClassName),e._onDocumentKeydownListener=(0,v.default)(t,"keydown",e.handleDocumentKeyDown),e._onDocumentKeyupListener=(0,v.default)(t,"keyup",e.handleDocumentKeyUp),e._onFocusinListener=(0,_.default)(e.enforceFocus)},this.onHide=function(){e.props.manager.remove(e),e._onDocumentKeydownListener.remove(),e._onDocumentKeyupListener.remove(),e._onFocusinListener.remove(),e.props.restoreFocus&&e.restoreLastFocus()},this.setMountNode=function(t){e.mountNode=t?t.getMountNode():t},this.setModalNodeRef=function(t){e.modalNode=t},this.setDialogRef=function(t){e.dialog=t},this.handleHidden=function(){var t;(e.setState({exited:!0}),e.onHide(),e.props.onExited)&&(t=e.props).onExited.apply(t,arguments)},this.handleBackdropClick=function(t){t.target===t.currentTarget&&(e.props.onBackdropClick&&e.props.onBackdropClick(t),!0===e.props.backdrop&&e.props.onHide())},this.handleDocumentKeyDown=function(t){e.props.keyboard&&27===t.keyCode&&e.isTopModal()&&(e.props.onEscapeKeyDown&&e.props.onEscapeKeyDown(t),e.props.onHide())},this.handleDocumentKeyUp=function(t){e.props.keyboard&&27===t.keyCode&&e.isTopModal()&&e.props.onEscapeKeyUp&&e.props.onEscapeKeyUp(t)},this.checkForFocus=function(){o.default&&(e.lastFocus=(0,r.default)())},this.enforceFocus=function(){if(e.props.enforceFocus&&e._isMounted&&e.isTopModal()){var t=e.getDialogElement(),n=(0,r.default)((0,E.default)(e));t&&!(0,a.default)(t,n)&&t.focus()}}};T.Manager=m.default,t.default=T,e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1));t.default=(e=>r.createElement("div",{className:"modal-header"},r.createElement("button",{"aria-label":"Close",className:"close","data-dismiss":"modal",type:"button"},r.createElement("span",{"aria-hidden":"true"},"×")),r.createElement("h4",{className:"modal-title",id:e.id},e.text)))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return e===e.window?e:9===e.nodeType&&(e.defaultView||e.parentWindow)},e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,r=n(33);var a=function(){};((s=r)&&s.__esModule?s:{default:s}).default&&(a=document.addEventListener?function(e,t,n,s){return e.addEventListener(t,n,s||!1)}:document.attachEvent?function(e,t,n){return e.attachEvent("on"+t,function(t){(t=t||window.event).target=t.target||t.srcElement,t.currentTarget=e,n.call(e,t)})}:void 0),t.default=a,e.exports=t.default},function(e,t){String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(17)).default("bitn:Goal"),o=s(n(8)),i=r(n(11)),l=n(20),c=n(21),u=n(9).Random.getRNG();var h;t.Goal={},t.Goal.ACTOR_FILTER="",t.Goal.StatusStrings={1:"GOAL_ACTIVE",2:"GOAL_COMPLETED",3:"GOAL_INACTIVE",4:"GOAL_FAILED"},function(e){e[e.NORMAL=1]="NORMAL",e[e.MOVE=2]="MOVE",e[e.KILL=3]="KILL",e[e.FIND=4]="FIND",e[e.AGGRESSION=5]="AGGRESSION"}(h=t.GoalType||(t.GoalType={})),t.Goal.Types=h;const d=null;var p;!function(e){e[e.GOAL_ACTIVE=1]="GOAL_ACTIVE",e[e.GOAL_COMPLETED=2]="GOAL_COMPLETED",e[e.GOAL_INACTIVE=3]="GOAL_INACTIVE",e[e.GOAL_FAILED=4]="GOAL_FAILED"}(p=t.GoalStatus||(t.GoalStatus={}));let f=0;class m{constructor(e){this.subGoals=d,this.actor=e,this.status=p.GOAL_INACTIVE,this.type="",this.category=h.NORMAL,this.planBGoal=null,this._debug=!1}dbg(e){if(a.enabled||this._debug){let n=!1;if(t.Goal.ACTOR_FILTER||(n=!0),!n){n=new RegExp(t.Goal.ACTOR_FILTER).test(this.actor.getName())}if(n){const n="  ".repeat(f),s=this.actor.getName(),r=function(e){return t.Goal.StatusStrings[e]}(this.status),a=`[${this.getType()}] ${r}`;console.log(`${n}${a} ${s} ${e}`)}}}setCategory(e){this.category=e}getCategory(){return this.category}setType(e){this.type=e}getType(){return this.type}hasPlanB(){return null!==this.planBGoal}getPlanB(){return this.planBGoal}activate(){throw new Error("Pure virtual method")}activateIfInactive(){this.isInactive()&&(this.dbg("Activating inactive"),this.activate())}reactivateIfFailed(){this.hasFailed()&&(this.dbg("Re-Activating failed"),this.status=p.GOAL_INACTIVE)}process(){if(Array.isArray(this.subGoals)){return this.subGoals[0].process()}return this.status}terminate(){this.dbg("Goal terminated!"),this.status=p.GOAL_COMPLETED}handleMsg(e){Array.isArray(this.subGoals)&&this.subGoals[this.subGoals.length-1].handleMsg(e)}processSubGoals(){++f;let e=p.GOAL_FAILED;if(this.dbg("Start processSubGoals()"),!Array.isArray(this.subGoals)){const e=this.actor.getName(),t=`Type: ${this.type}, actor: ${e}`;throw new Error(`${t} No subgoals in atomic goal`)}if(this.removeFinishedOrFailed(),this.subGoals.length>0){const t=this.subGoals[0];(e=t.process())===p.GOAL_COMPLETED&&this.subGoals.length>1?e=p.GOAL_ACTIVE:e===p.GOAL_FAILED&&t.hasPlanB()&&(this.subGoals[0]=t.getPlanB(),this.subGoals[0].setType(t.getType()),e=p.GOAL_ACTIVE)}else e=p.GOAL_COMPLETED;return--f,this.dbg(`End processSubGoals() with status ${e}`),a.enabled&&this.dbg(`  subGoals left: ${this.subGoals.map(e=>e.getType())}`),e}removeFinishedOrFailed(){this.subGoals=this.subGoals.filter(e=>!e.isCompleted()&&!e.hasFailed())}removeAllSubGoals(){Array.isArray(this.subGoals)&&(this.subGoals.forEach(e=>{e.terminate()}),this.subGoals=[]),this.dbg("Removed all subGoals")}removeSubGoalsOfType(e){let t=0;if(Array.isArray(this.subGoals)){let n=this.subGoals.findIndex(t=>t.type===e);for(;n>=0;)this.subGoals[n].terminate(),this.subGoals.splice(n,1),++t,n=this.subGoals.findIndex(t=>t.type===e)}return t}getSubGoals(){return this.subGoals}hasSubGoals(e){if(Array.isArray(this.subGoals)){if(e){return this.subGoals.findIndex(t=>t.type===e)>=0}return this.subGoals.length>0}return!1}addSubGoal(e){if(Array.isArray(this.subGoals)||(this.subGoals=[]),this.subGoals.unshift(e),a.enabled){this.dbg(`Added subGoal ${e.getType()}`);const t=this.subGoals.map(e=>e.getType());this.dbg(`   Subgoals are now: ${t}`)}this._debug&&(e._debug=!0)}isInactive(){return this.status===p.GOAL_INACTIVE}isActive(){return this.status===p.GOAL_ACTIVE}hasFailed(){return this.status===p.GOAL_FAILED}isCompleted(){return this.status===p.GOAL_COMPLETED}isGoalPresent(e){if(Array.isArray(this.subGoals)){const t=this.subGoals.find(t=>t.getType()===e);if(t&&!t.hasFailed()&&!t.isCompleted())return a.enabled&&(this.dbg(`subGoal ${e} already present.`),this.dbg(`  SubGoal status: ${t.status}`)),!0}return!1}}t.GoalBase=m,t.Goal.Base=m;class g extends m{constructor(e,t){super(e),this.setType("GoalFollowPath"),this.path=[],this.xy=t}activate(){const[e,t]=this.xy,[n,s]=[this.actor.getX(),this.actor.getY()];this.dbg(`Calc path ${n},${s} -> ${e},${t}`);const r=this.actor.getLevel().getMap(),a=c.Path.getShortestActorPath(r,n,s,e,t);this.path=a,this.status=p.GOAL_ACTIVE,this.dbg(`activate() path length: ${this.path.length}`)}process(){return this.activateIfInactive(),this.path.length>0?this.followPath():(this.dbg("process() ret GoalStatus.GOAL_COMPLETED"),this.status=p.GOAL_COMPLETED,p.GOAL_COMPLETED)}followPath(){const e=this.actor.getLevel(),[t,n]=this.actor.getXY(),{x:s,y:r}=this.path[0],[a,o]=[s,r],l=this.path.length;if(this.dbg(`followPath() test move ${t},${n} -> ${s},${r}, path ${l} `),e.getMap().isPassable(a,o)){const c=Math.abs(t-s),u=Math.abs(n-r);if(c<=1&&u<=1){const t=new i.Movement(a,o,e);return this.actor.add(t),this.path.shift(),0===this.path.length?(this.dbg(`followPath() ret GOAL_COMPL, path ${l}`),this.status=p.GOAL_COMPLETED,p.GOAL_COMPLETED):(this.dbg(`followPath() ret GoalStatus.GOAL_ACTIVE, path ${l}`),this.status=p.GOAL_ACTIVE,p.GOAL_ACTIVE)}return this.dbg(`followPath() strayed, ret GoalStatus.GOAL_FAILED, path ${l}`),this.status=p.GOAL_FAILED,p.GOAL_FAILED}return this.dbg("followPathl() next NOT passable ret GoalStatus.GOAL_FAILED"),this.status=p.GOAL_FAILED,p.GOAL_FAILED}}t.GoalFollowPath=g,t.Goal.FollowPath=g;class y extends m{constructor(e,t){super(e),this.setType("GoalMoveUntilEnemy"),this.dir=t}activate(){this.timeout=100,this.status=p.GOAL_ACTIVE}process(){this.activateIfInactive();const e=this.actor.getBrain(),t=e.getSeenCells(),n=e.findEnemyCell(t),[s,r]=function(e,t){const[n,s]=e.getXY();return[n+t[0],s+t[1]]}(this.actor,this.dir),o=this.actor.getLevel().getMap();if(n){const[e,t]=[n.getX(),n.getY()];a.enabled&&this.dbg(`Has moved enough. Enemy found @${e},${t}`),this.status=p.GOAL_COMPLETED}else if(o.hasObstacle(s,r))this.status=p.GOAL_FAILED,a.enabled&&this.dbg("OBSTACLE ENCOUNTERED");else if(0===this.timeout)this.status=p.GOAL_FAILED,a.enabled&&this.dbg("TIMEOUT REACHED");else if(o.isPassable(s,r)){const e=this.actor.getLevel(),t=new i.Movement(s,r,e);this.actor.add(t);const n=this.actor.getName();a.enabled&&this.dbg(`Moving ${n} to ${s},${r}`)}return--this.timeout,this.status}}t.GoalMoveUntilEnemy=y,t.Goal.MoveUntilEnemy=y;class v extends g{constructor(e,t){super(e,[0,0]),this.setType("GoalGotoActor"),this.xy=t.getXY(),this.targetActor=t,this.pathFunc=c.Path.getActorToActorPath}activate(){const e=this.getPath();this.dbg(`activate() path length: ${e.length}`),this.path=e,this.status=p.GOAL_ACTIVE,this.dbg(`activate() path length: ${this.path.length}`)}getPath(){const e=this.actor.getLevel().getMap(),[t,n]=this.xy,[s,r]=[this.actor.getX(),this.actor.getY()];return this.dbg(`${this.getType()} ${s},${r} -> ${t},${n}`),c.Path.getActorToActorPath(e,s,r,t,n)}process(){this.activateIfInactive();const[e,t]=[this.targetActor.getX(),this.targetActor.getY()],[n,s]=this.xy,r=Math.abs(e-n),a=Math.abs(t-s);return r>2||a>2?(this.followPath(),this.status=p.GOAL_FAILED,p.GOAL_FAILED):this.path.length>0?this.followPath():(this.dbg("process() ret GoalStatus.GOAL_COMPLETED"),this.status=p.GOAL_COMPLETED,p.GOAL_COMPLETED)}}t.GoalGotoActor=v,t.Goal.GotoActor=v;class _ extends v{constructor(e,t){super(e,t),this.setType("GoalGotoSeenActor")}getPath(){const e=this.actor.getLevel().getMap(),[t,n]=this.xy;return c.Path.getShortestSeenPath(this.actor,e,t,n)}}t.GoalGotoSeenActor=_,t.Goal.GotoSeenActor=_;class b extends m{constructor(e,t,n=1){super(e),this.setType("GoalGuard"),this.dist=n,this.x=t[0],this.y=t[1],this.subGoals=[]}activate(){this.checkDistToGuardPoint()}process(){if(this.activateIfInactive(),this.status=this.processSubGoals(),this.subGoals.length>0){this.subGoals[0].hasFailed()&&this.checkDistToGuardPoint()}else this.checkDistToGuardPoint();return this.status}checkDistToGuardPoint(){const[e,t]=o.default.dXdYAbs([this.x,this.y],this.actor.getXY());(e>this.dist||t>this.dist)&&this.addSubGoal(new g(this.actor,[this.x,this.y]))}}t.GoalGuard=b,t.Goal.Guard=b;class E extends m{constructor(e,t){super(e),this.setType("GoalPatrol"),this.coords=t,this.coords.length<2&&o.default.err("GoalPatrol","constructor",`Provide >= 2 coords for patrolling. Got ${t}`),this.currIndex=0,this.currTarget=t[this.currIndex],this.patrolDist=3}activate(){this.dbg(`${this.getType()} activate()`),this.recomputePatrolPath()}process(){this.activateIfInactive(),this.status=this.processSubGoals(),this.dbg(`GoalPatrol process(), got subStatus: ${this.status}`);const e=this.subGoals[0];if(e.isCompleted())this.nextPatrolPoint();else if(e.hasFailed()){this.dbg(`${this.getType()} process() path failed`);const[e,t]=this.actor.getXY(),[n,s]=this.currTarget;c.Path.shortestDist(e,t,n,s)<=this.patrolDist?this.nextPatrolPoint():this.recomputePatrolPath()}else this.dbg(`${this.getType()} XXX NOT HERE!`);return this.status}nextPatrolPoint(){++this.currIndex,this.currIndex>=this.coords.length&&(this.currIndex=0),this.currTarget=this.coords[this.currIndex],this.addSubGoal(new g(this.actor,this.currTarget)),this.dbg(`${this.getType()} next patrol point ${this.currTarget}`),this.status=p.GOAL_ACTIVE}recomputePatrolPath(){this.addSubGoal(new g(this.actor,this.currTarget)),this.dbg(`${this.getType()} recompute to point ${this.currTarget}`),this.status=p.GOAL_ACTIVE}}t.GoalPatrol=E,t.Goal.Patrol=E;class S extends m{constructor(e,t){super(e),this.setType("GoalAttackActor"),this.targetActor=t}activate(){this.dbg("activate() called"),this.selectSubGoal(),this.isCompleted()||(this.status=p.GOAL_ACTIVE)}process(){this.activateIfInactive();const e=this.actor.getBrain(),t=e.getSeenCells(),n=e.findEnemyCell(t);if(n){const t=n.getActors()[0];if(this.targetActor.getID()!==t.getID()){if(this.print){const e=this.actor.getName(),n=this.targetActor.getName(),s=t.getName();o.default.log(`${e}:: Recomp target ${n} -> ${s}`)}this.targetActor=t,e.getMemory().setLastAttacked(t),this.selectSubGoal()}}else this.checkTargetStatus();return this.isCompleted()||this.hasFailed()||(this.status=this.processSubGoals()),this.status}terminate(){this.dbg("Terminating completed attack actor task"),this.status=p.GOAL_COMPLETED}canMissileAttack(){const[e,t]=this.targetActor.getXY(),[n,s]=this.actor.getXY(),r=this.actor.getInvEq().getEquipment().getItem("missile");if(r){const a=o.default.getMissileRange(this.actor,r);if(c.Path.shortestDist(e,t,n,s)<=a)return!0}return!1}selectSubGoal(){const e=this.actor.getBrain();if(this.checkTargetStatus(),!this.isCompleted()){const[t,n]=this.targetActor.getXY();if(e.canMeleeAttack(t,n)){this.removeAllSubGoals(),this.dbg("canMeleeAttack() OK");const e=new C(this.actor,this.targetActor);this.addSubGoal(e)}else if(this.canMissileAttack()){this.removeAllSubGoals(),this.dbg("canMissileAttack() OK");const e=new w(this.actor,this.targetActor);this.addSubGoal(e)}else if(e.canSeeActor(this.targetActor)){this.removeAllSubGoals(),this.dbg("canSeeActor subGoal GoalGotoActor");const e=new _(this.actor,this.targetActor);this.addSubGoal(e)}else{this.removeAllSubGoals(),this.dbg("Moving blind subGoal GoalGotoActor");const e=new v(this.actor,this.targetActor);this.addSubGoal(e)}}}checkTargetStatus(){const e=this.targetActor.get("Health");if(!e){const e=JSON.stringify(this.targetActor),t=JSON.stringify(this.actor);o.default.log("Attacker: "+t),o.default.err("GoalAttackActor","checkTargetStatus","target has no health: "+e)}e.isDead()?(this.removeAllSubGoals(),this.status=p.GOAL_COMPLETED,this.dbg("Enemy is dead. Goal completed")):o.default.inSameLevel(this.actor,this.targetActor)||(this.removeAllSubGoals(),this.status=p.GOAL_COMPLETED,this.dbg("Enemy not in this level. Goal completed"))}}t.GoalAttackActor=S,t.Goal.AttackActor=S;class C extends m{constructor(e,t){super(e),this.setType("GoalHitActor"),this.targetActor=t}activate(){const e=this.actor.getLevel(),[t,n]=this.targetActor.getXY(),s=e.getMap().getCell(t,n).getProp("actors")[0],r=new i.Attack({target:s});this.actor.add(r),this.dbg(`${this.getType()} added Attack comp`),this.status=p.GOAL_ACTIVE}process(){return this.activateIfInactive(),this.status=p.GOAL_COMPLETED,this.status}}t.GoalHitActor=C;class w extends m{constructor(e,t){super(e),this.setType("GoalShootActor"),this.targetActor=t}activate(){const e=this.actor.getInvEq().unequipAndGetItem("missile",1,0);if(!e)return;const[t,n]=this.targetActor.getXY(),s=new i.Missile(this.actor);s.setTargetXY(t,n),s.setDamage(o.default.getMissileDamage(this.actor,e)),s.setAttack(o.default.getMissileAttack(this.actor,e)),s.setRange(o.default.getMissileRange(this.actor,e)),e.add(s),this.dbg(`${this.getType()} added Missile comp`),this.status=p.GOAL_ACTIVE}process(){return this.activateIfInactive(),this.status=p.GOAL_COMPLETED,this.status}}t.GoalShootActor=w;class T extends m{constructor(e,t=-1){super(e),this.setType("GoalExplore"),this.dur=t}activate(){this.setNewPassableDir(),this.dbg(`activate Explore dX,dY: ${this.dX},${this.dY}`),this.status=p.GOAL_ACTIVE}setCallback(e){this.exploreCb=e}setNewPassableDir(){let e=5,[t,n]=u.getRandDir();for(;e>0&&!this.isDirPassable(t,n);)[t,n]=u.getRandDir(),--e;this.dX=t,this.dY=n}isDirPassable(e,t){const[n,s]=this.actor.getXY(),r=n+e,a=s+t;return this.actor.getLevel().getMap().isPassable(r,a)}shouldMoveTo(e,t,n){const s=e.getCell(t,n);return!!s.isPassable()&&!s.isDangerous()}process(){this.activateIfInactive(),this.checkChangeDir(),--this.dur;const[e,t]=this.actor.getXY(),n=e+this.dX,s=t+this.dY,r=this.actor.getLevel(),a=r.getMap();if(a.hasXY(n,s))if(this.shouldMoveTo(a,n,s)){const e=new i.Movement(n,s,r);this.actor.add(e)}else this.canOpenDoorAt(a,n,s)||this.setNewPassableDir();else this.setNewPassableDir();return 0===this.dur&&(this.status=p.GOAL_COMPLETED),this.exploreCb&&this.exploreCb(n,s),this.status}canOpenDoorAt(e,t,n){const s=e.getCell(t,n);if(s.hasDoor()){const e=s.getPropType("door")[0];if(e.canToggle()){const t=new i.OpenDoor;return t.setDoor(e),this.actor.add(t),!0}}return!1}checkChangeDir(){const e=u.getUniform();if(e<=.07){const e=this.changeDir(this.dX);this.isDirPassable(e,this.dY)&&(0===e&&0===this.dY||(this.dX=e))}else if(e<=.14){const e=this.changeDir(this.dY);this.isDirPassable(this.dX,e)&&(0===e&&0===this.dX||(this.dY=e))}}changeDir(e){switch(e){case 0:return u.arrayGetRand([-1,1]);case 1:case-1:return 0;default:return e}}terminate(){this.status=p.GOAL_COMPLETED}}t.GoalExplore=T,t.Goal.Explore=T;class O extends m{constructor(e,t){super(e),this.setType("GoalFleeFromActor"),this.targetActor=t}activate(){const e=this.actor.getBrain().getSeenCells(),n=l.Brain.findCellsWithActors(this.actor,e);let s=null;if(n.forEach(e=>{const t=e.getActors();t&&t.forEach(t=>{t.getID()===this.targetActor.getID()&&(s=e)})}),s){const e=this.actor.getX(),n=this.actor.getY(),s=o.default.dXdYUnit(this.actor,this.targetActor),r=e+s[0],a=n+s[1],l=this.actor.getLevel(),c=[[r,a],[e,a],[r,n]];u.shuffle(c);for(let e=0;e<3;e++){const[t,n]=c[e];if(l.getMap().isPassable(t,n)){const e=new i.Movement(t,n,l);this.dbg(`${this.getType()} movComp to ${t},${n}`),this.actor.add(e),this.status=p.GOAL_COMPLETED;break}}this.status!==p.GOAL_COMPLETED&&(this.status=p.GOAL_FAILED,this.planBGoal=new t.Goal.AttackActor(this.actor,this.targetActor))}else this.status=p.GOAL_FAILED}process(){return this.activateIfInactive(),this.status}}t.GoalFleeFromActor=O,t.Goal.FleeFromActor=O;class M extends m{constructor(e,t,n){super(e),this.setType("GoalCastSpell"),this.spell=t,this.spellArgs=n}activate(){this.spell.getCastFunc(this.actor,this.spellArgs)(),this.status=p.GOAL_COMPLETED}process(){return this.activateIfInactive(),this.status}}t.GoalCastSpell=M,t.Goal.CastSpell=M;class A extends m{constructor(e,t){super(e),this.setType("GoalFollow"),this.targetActor=t}activate(){this.actor.getBrain().canSeeActor(this.targetActor)&&(this.status=p.GOAL_ACTIVE)}process(){this.activateIfInactive();const e=this.actor.getBrain(),[t,n]=this.actor.getXY();if(e.canSeeActor(this.targetActor)){const[e,s]=o.default.dXdYUnit(this.targetActor,this.actor),[r,a]=o.default.dXdY(this.targetActor,this.actor);let l=t+e,u=n+s;const h=this.targetActor.getLevel(),d=h.getMap();if(Math.abs(r)<=1&&Math.abs(a)<=1)this.status=p.GOAL_ACTIVE;else if(d.isPassable(l,u)){const e=new i.Movement(l,u,h);this.actor.add(e)}else{const[e,s]=this.targetActor.getXY(),r=c.Path.getActorToActorPath(d,t,n,e,s);if(r.length>0)if([l,u]=[r[0].x,r[0].y],d.isPassable(l,u)){const e=new i.Movement(l,u,h);this.actor.add(e)}else this.status=p.GOAL_FAILED;else this.status=p.GOAL_FAILED}}else this.status=p.GOAL_FAILED;return this.status}}t.GoalFollow=A,t.Goal.Follow=A;class N extends m{constructor(e,t){super(e),this.setType("GoalGetItem"),this.targetItem=t}activate(){const e=this.targetItem.getID(),t=this.actor.getBrain().getSeenCells();let n=null;if(t.forEach(t=>{if(t.hasItems()){t.getItems().find(t=>t.getID()===e)&&(n=t)}}),n){const[e,t]=this.actor.getXY(),[s,r]=n.getXY();if(e===s&&t===r){const e=new i.Pickup;this.actor.add(e),this.status=p.GOAL_COMPLETED}else{const e=new g(this.actor,[s,r]);this.removeAllSubGoals(),this.addSubGoal(e),this.status=this.processSubGoals()}}else this.status=p.GOAL_FAILED}process(){return this.activateIfInactive(),this.hasSubGoals()&&(this.status=this.processSubGoals()),this.status}}t.GoalGetItem=N,t.Goal.GetItem=N;class P extends m{constructor(e){super(e),this.setType("GoalOrders")}activate(){this.status=p.GOAL_ACTIVE}process(){return this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}t.GoalOrders=P,t.Goal.Orders=P;class x extends m{constructor(e,t,n){super(e),this.setType("GoalShopkeeper"),this.x=t,this.y=n,this.hasShouted=!1,this.subGoals=[]}activate(){this.status=p.GOAL_ACTIVE;const e=this.actor.getCell();if(e.hasShop())if(o.default.isSuccess(.6))D(this.actor);else if(this.hasShouted)e.hasItems();else{const e=new i.Communication;e.addMsg({src:this.actor,type:"Shout",shout:"Hello traveller!"}),this.actor.add(e)}else{this.dbg(`${this.x},${this.y} has shop`);const e=new g(this.actor,[this.x,this.y]);this.addSubGoal(e),this.status=this.processSubGoals()}}process(){return this.dbg(`process(), x,y is ${this.x},${this.y}`),this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}t.GoalShopkeeper=x,t.Goal.Shopkeeper=x;class I extends m{constructor(e,t,n,s){super(e),this.setType("GoalGoHome"),this.x=t,this.y=n,this.maxDist=s,this.subGoals=[],this.timeToFindPath=u.getUniformInt(100,200)}activate(){this.status=p.GOAL_ACTIVE;const e=this.actor.getCell();if(this.timeToFindPath--,"floorhouse"===e.getBaseElem().getType())if(o.default.isSuccess(.03)){const e=new i.Communication;e.addMsg({src:this.actor,type:"Shout",shout:"Home sweet home!"}),this.actor.add(e)}else D(this.actor);else if(o.default.withinRange(this.maxDist,[this.x,this.y],this.actor))D(this.actor);else if(this.timeToFindPath<=0){const e=new g(this.actor,[this.x,this.y]);this.addSubGoal(e),this.status=this.processSubGoals(),this.timeToFindPath=u.getUniformInt(100,200)}else D(this.actor)}process(){return this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}function D(e){const t=e.getLevel(),n=t.getMap();let s=u.getRandDir(),r=o.default.newXYFromDir(s,e),a=10;for(;!n.hasXY(r[0],r[1])&&(s=u.getRandDir(),r=o.default.newXYFromDir(s,e),0!=--a););if(a>0){const n=new i.Movement(r[0],r[1],t);e.add(n)}}t.GoalGoHome=I,t.Goal.GoHome=I,t.Goal.moveToRandomDir=D,t.Goal.moveActorTo=function(e,t){const n=t.getXY(),s=e.getLevel();if(s.getMap().isPassable(n[0],n[1])){const t=new i.Movement(n[0],n[1],s);e.add(t)}};class k{constructor(e){this.goal=e}}t.GoalMonitor=k,t.Goal.Monitor=k;class L extends m{constructor(e){super(e),this.setType("GoalCommunicate")}activate(){this.communicateEnemies()}process(){return this.activateIfInactive(),p.GOAL_COMPLETED}communicateEnemies(){const e=this.actor.getBrain(),t=e.getMemory(),n=t.getEnemyActors(),s=e.getSeenCells(),r=e.findFriendCell(s).getActors()[0],a=new i.Communication,o={type:"Enemies",enemies:n,src:this.actor};a.addMsg(o),r.add(a),t.addCommunicationWith(r)}}t.GoalCommunicate=L,t.Goal.Communicate=L},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(128),o=n(105),i=n(14),l=n(9),c=.1,u=l.Random.getRNG(),h=()=>{};class d extends o.BrainBase{constructor(e){super(e),this.setType("Virtual")}}t.BrainVirtual=d;t.BrainSpawner=class extends d{constructor(e){super(e),this.setType("Spawner"),this.constraint=null,this._constraintFunc=null,this.placeConstraint=null,this._placeConstraintFunc=null,this.spawnProb=c}setConstraint(e){Array.isArray(e)?this.constraint=e:this.constraint=[e],this._constraintFunc=(new a.Constraints).getConstraints(e)}setPlaceConstraint(e){Array.isArray(e)?this.placeConstraint=e:this.placeConstraint=[e],this._placeConstraintFunc=(new a.Constraints).getConstraints(e)}decideNextAction(){return r.default.isSuccess(this.spawnProb)?()=>{const e=this.getActor().getLevel();let t=null;if(this.placeConstraint){let n=100;const s=e.getMap().getFree();for(t=u.arrayGetRand(s);!this._placeConstraintFunc(t)&&(t=u.arrayGetRand(s),0!=--n););}else t=e.getFreeRandCell();const[n,s]=[t.getX(),t.getY()],a=i.ObjectShell.getParser().createRandomActor({func:this._constraintFunc});if(a){e.addActor(a,n,s);const t=a.getName();r.default.gameMsg(`You feel danger at ${n}, ${s} from ${t}`)}}:h}toJSON(){const e={type:this.getType(),constraint:this.constraint,spawnProb:this.spawnProb};return this.placeConstraint&&(e.placeConstraint=this.placeConstraint),e}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(30);t.meleeHitDamage=((e,t,n,s)=>{const a={addComp:"DirectDamage",func:[{setter:"setDamage",value:e},{setter:"setDamageType",value:r.default.DMG[n]},{setter:"setDamageCateg",value:r.default.DMG.MELEE}],duration:t};return s&&(a.expireMsg=s),a}),t.directDamage=((e,n,s,a,o)=>{const i=t.meleeHitDamage(e,n,s);return i.func[2].value=r.default.DMG.DIRECT,a&&i.func.push({setter:"setProb",value:a}),o&&(i.expireMsg=o),i}),t.color=function(e,t){return{fg:e,bg:t}};const o=new Set(["addComp","spells","inv","equip","onAttackHit"]),i=new Set(["hp","maxHP","pp","maxPP","defense","protection","attack","danger","speed","rarity"].concat(r.default.STATS_LC)),l={damage:function(e,t,n){const s=t[e];if(n[e]){const t=n[e],r=a.Dice.create(s),o=a.Dice.create(t),i=a.Dice.combine(r,o);n[e]=i.toString()}else n[e]=s},addDamage:function(e,t,n){const s=t[e];if(n.damage){const e=a.Dice.create(s),t=a.Dice.create(n.damage),r=a.Dice.addDice(e,t);n.damage=r.toString()}}},c=new Set(["weight","value","rarity"]);function u(e,t,n,s){o.has(e)?n.hasOwnProperty(e)?n[e]=n[e].concat(t[e]):n[e]=t[e].slice():Array.isArray(t[e])?n[e]=t[e].slice():"object"==typeof t[e]?n[e]=JSON.parse(JSON.stringify(t[e])):i.has(e)?function(e,t,n){n.hasOwnProperty(e)?n[e]+=t[e]:n[e]=t[e]}(e,t,n):c.has(e)?function(e,t,n){n.hasOwnProperty(e)?n[e]*=t[e]:n[e]=t[e]}(e,t,n):l.hasOwnProperty(e)?l[e](e,t,n):n[e]=t[e]}t.mixNewShell=function(e,t){const n={};return e.forEach(e=>{for(const s in e)e.hasOwnProperty(s)&&u(s,e,n,t)}),n}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(86),o="GoalOriented";function i(e,t){return{comp:"Resistance",func:{setEffect:r.default.DMG[e.toUpperCase()],setLevel:r.default.RESISTANCE[t.toUpperCase()]}}}function l(e){return{comp:"BypassProtection",func:{setChance:e}}}t.ActorsData=[{name:"animal",dontCreate:!0,type:"animal",className:"cell-actor-animal",attack:1,defense:1,hp:5,protection:0,range:1,danger:1,speed:100,brain:"Animal",enemies:r.default.ACTOR_RACES},{name:"rat",char:"r",base:"animal"},{name:"cloud of insects",char:"i",base:"animal",color:a.color("Green","black"),damage:"1d1",defense:2,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1"}]},{name:"bat",char:"b",base:"animal",defense:2,addComp:"Flying"},{name:"giant ant",char:"a",base:"animal",defense:2,hp:7},{name:"badger",char:"c",base:"animal",attack:1,defense:4,damage:"1d4",hp:10,danger:2},{name:"coyote",char:"c",base:"animal",colorfg:"Yellow",attack:3,defense:3,damage:"1d4",hp:12,danger:2},{name:"lynx",char:"f",base:"animal",colorfg:"Orange",attack:5,defense:1,damage:"1d6",hp:12,danger:3},{name:"hawk",char:"H",base:"animal",attack:4,defense:1,damage:"1d5",hp:9,danger:3,addComp:"Flying"},{name:"wolf",char:"w",base:"animal",attack:4,defense:2,damage:"1d6",hp:15,danger:3},{name:"rattlesnake",char:"s",base:"animal",attack:2,defense:3,damage:"1d3",hp:10,danger:3,poison:{duration:"1d6",damage:"1d10",prob:"0.1"}},{name:"cave spider",char:"S",base:"animal",attack:2,defense:4,damage:"1d5",hp:15,danger:4,poison:{duration:"3d6",damage:"1d4 + 1",prob:"0.15"}},{name:"woolly spider",char:"S",base:"animal",attack:4,defense:4,damage:"1d6 + 2",hp:20,danger:4,poison:{duration:"3d6",damage:"1d4 + 1",prob:"0.15"},onHit:[{addComp:"Paralysis",duration:"1"}]},{name:"wolverine",char:"W",base:"animal",attack:4,defense:4,damage:"1d7",hp:20,danger:4},{name:"auroch",char:"A",base:"animal",attack:2,defense:4,protection:5,damage:"1d7",hp:23,danger:4},{name:"eagle",char:"E",base:"animal",attack:4,defense:4,damage:"1d7",hp:20,danger:4,addComp:"Flying"},{name:"dire wolf",char:"w",base:"animal",colorfg:"Gray",attack:6,defense:2,damage:"1d8 + 2",hp:23,danger:5},{name:"giant spider",char:"S",base:"animal",colorfg:"Green",attack:6,defense:3,damage:"1d8 + 2",hp:17,danger:5,poison:{duration:"4d6",damage:"1d4 + 2",prob:"0.20"}},{name:"black vulture",char:"V",base:"animal",attack:5,defense:5,damage:"1d7",hp:25,danger:5,addComp:"Flying"},{name:"giant scorpion",char:"S",base:"animal",attack:5,defense:5,damage:"1d6 + 1",hp:19,danger:5,brain:"SpellCaster",spells:["ScorpionsTail"],maxPP:1,pp:1,poison:{duration:"4d6",damage:"1d4 + 2",prob:"0.20"}},{name:"bear",char:"B",base:"animal",attack:5,defense:5,damage:"1d9",hp:30,danger:5},{name:"mountain lion",char:"f",base:"animal",attack:6,defense:3,damage:"2d4",hp:25,danger:5},{name:"sabretooth tiger",char:"f",base:"animal",attack:8,defense:3,damage:"3d3",colorfg:"Red",hp:25,danger:5,speed:110},{name:"dire bear",char:"B",base:"animal",colorfg:"Gray",attack:8,defense:5,damage:"4d4",hp:40,danger:6},{name:"griffin",char:"G",base:"animal",attack:7,defense:4,damage:"3d3",hp:35,danger:6,addComp:"Flying",speed:130},{name:"polar bear",char:"B",base:"animal",color:a.color("blue","white"),attack:10,defense:5,protection:7,damage:"4d4 + 5",hp:50,danger:8,onHit:[{addComp:"Stun",duration:"1d2 + 1"}],addComp:[i("ICE","HIGH")]},{name:"mammoth",char:"M",base:"animal",attack:4,defense:4,protection:7,damage:"1d9",strength:30,hp:40,danger:8,addComp:[i("ICE","MEDIUM")]},{name:"dire mammoth",char:"M",base:"animal",attack:4,defense:4,protection:10,damage:"1d15",strength:35,hp:50,danger:9,colorfg:"Gray",addComp:[i("ICE","MEDIUM")]},{name:"polar bear king",char:"B",base:"animal",color:a.color("cyan","white"),attack:15,defense:7,damage:"5d5 + 5",hp:75,danger:10,onHit:[{addComp:"Stun",duration:"1d2 + 1"}],addComp:[i("ICE","IMMUNITY")]},{name:"thunderbird",char:"G",base:"animal",attack:7,defense:7,damage:"2d8",hp:45,danger:10,addComp:"Flying",brain:"SpellCaster",spells:["LightningArrow"],maxPP:30,pp:30},{name:"manticore",char:"M",base:"animal",attack:7,defense:7,damage:"2d10",hp:50,danger:10,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1d4 + 1"}]},{name:"forest wurm",char:"W",base:"animal",color:a.color("Green","Brown"),attack:12,defense:7,protection:15,damage:"3d10",hp:70,danger:10},{name:"spider queen",char:"S",base:"animal",color:a.color("Purple","Green"),attack:7,defense:7,protection:7,damage:"2d8 + 7",hp:45,danger:11,brain:"SpellCaster",spells:["SummonSpiders","ArrowOfWebs"],maxPP:40,pp:40,poison:{duration:"10d6",damage:"1d5 + 3",prob:"0.20"}},{name:"ancient manticore",char:"M",base:"animal",color:a.color("Gray","Brown"),attack:15,defense:10,protection:10,damage:"2d10 + 10",hp:75,danger:15,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1d6 + 1"}],spells:["SummonKin"],maxPP:30,pp:30},{name:"BeastBase",type:"beast",dontCreate:!0,enemies:r.default.ACTOR_RACES},{name:"cave dweller",base:"BeastBase",char:"C",color:a.color("Black","Red"),attack:5,defense:5,protection:5,damage:"1d10 + 2",hp:30,danger:5,brain:"SpellCaster",spells:["SlimeBolt"],maxPP:18,pp:18},{name:"hezrou",base:"BeastBase",char:"B",className:"cell-actor-poison",attack:5,defense:5,protection:3,hp:50,danger:11,damage:"4d4",addComp:[i("POISON","IMMUNITY")],brain:"SpellCaster",spells:["PoisonCloud"],maxPP:40,pp:40},{name:"ConstructBase",type:"construct",dontCreate:!0,enemies:r.default.ACTOR_RACES},{name:"water elemental",base:"ConstructBase",char:"E",className:"cell-actor-water",attack:5,defense:5,protection:3,hp:38,danger:9,damage:"4d4",addComp:"Amphibious",brain:"SpellCaster",spells:["WaterBolt"],maxPP:40,pp:40},{name:"air elemental",base:"ConstructBase",char:"E",className:"cell-actor-air",attack:5,defense:5,protection:3,hp:38,danger:9,damage:"4d4",addComp:"Flying",brain:"SpellCaster",spells:["LightningBolt"],maxPP:40,pp:40},{name:"earth elemental",base:"ConstructBase",char:"E",className:"cell-actor-earth",attack:6,defense:3,protection:12,hp:47,danger:11,damage:"4d4",brain:"SpellCaster",spells:["RockStorm"],maxPP:70,pp:70},{name:"void elemental",base:"ConstructBase",color:a.color("Purple","Black"),char:"E",className:"cell-actor-void",attack:7,defense:7,protection:7,hp:60,danger:13,damage:"5d4",brain:"SpellCaster",spells:["PowerDrain"],addComp:["SpellStop",i("MAGIC","ABSORB"),i("VOID","IMMUNITY")],maxPP:70,pp:70},{name:"goblin",char:"g",type:"goblin",className:"cell-actor-goblin",attack:1,defense:1,damage:"1d6",range:1,hp:7,protection:1,danger:2,enemies:["human"],brain:o},{name:"goblin slinger",base:"goblin",attack:2,defense:1,hp:10,equip:[{name:"Rock",count:10}]},{name:"goblin fighter",base:"goblin",attack:2,defense:3,protection:1,hp:12,danger:2},{name:"goblin healer",base:"goblin",attack:2,defense:4,protection:2,hp:15,danger:3,brain:"SpellCaster",pp:18,maxPP:18,spells:["Heal"]},{name:"goblin sergeant",base:"goblin",damage:"1d7",attack:4,defense:4,protection:2,hp:21,danger:4},{name:"goblin summoner",base:"goblin",attack:2,defense:4,protection:2,hp:25,maxPP:20,pp:20,brain:"SpellCaster",spells:["SummonAnimal"],danger:5},{name:"goblin lord",base:"goblin",attack:5,defense:4,protection:3,hp:30,danger:7},{name:"goblin king",base:"goblin",attack:7,defense:7,protection:3,hp:40,danger:10},{name:"HyrmBase",char:"Y",type:"hyrm",color:a.color("Black","Purple"),dontCreate:!0,attack:1,defense:1,damage:"1d4",range:1,hp:10,danger:2,brain:o,enemies:["player"]},{name:"hyrm warrior",base:"HyrmBase",attack:3,defense:3,damage:"1d8",hp:15,danger:2},{name:"hyrm catapulter",base:"HyrmBase",attack:3,defense:3,damage:"1d8",hp:25,danger:4,equip:[{name:"Large rock",count:4}]},{name:"hyrm runemage",base:"HyrmBase",attack:3,defense:3,damage:"1d8",hp:25,danger:5,brain:"SpellCaster",spells:["SummonKin","StunningTouch"],maxPP:20,pp:20},{name:"hyrm hulk",base:"HyrmBase",attack:6,defense:3,damage:"2d8",hp:40,strength:15,speed:90,danger:7},{name:"humanoid",char:"h",type:"humanoid",attack:1,defense:1,damage:"1d4",range:1,hp:10,danger:2,brain:o,enemies:["human","player"]},{name:"dark warrior",char:"h",type:"humanoid",className:"cell-actor-void",attack:6,defense:4,protection:2,damage:"2d5 + 3",range:1,hp:25,enemies:r.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes"],maxPP:16,pp:16,danger:5},{name:"dark archer",char:"h",type:"humanoid",className:"cell-actor-void",attack:8,defense:3,protection:4,damage:"2d5",range:1,hp:30,enemies:r.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes"],maxPP:16,pp:16,danger:7,equip:["Iron bow",{name:"Steel arrow",count:8}],addComp:["LongRangeShot"]},{name:"dark assassin",char:"h",type:"humanoid",className:"cell-actor-void",attack:10,defense:5,protection:6,damage:"3d5 + 3",range:1,hp:50,enemies:r.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes"],maxPP:30,pp:30,danger:10,addComp:[i("POISON","IMMUNITY")],poison:{duration:"4d6",damage:"1d4 + 2",prob:"0.20"}},{name:"dark lord",char:"h",type:"humanoid",color:a.color("Yellow","Purple"),attack:12,defense:10,protection:8,damage:"4d5 + 5",range:1,hp:75,enemies:r.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes","PoisonArrow"],maxPP:60,pp:60,danger:15,addComp:[i("POISON","IMMUNITY")],poison:{duration:"4d6",damage:"2d4 + 2",prob:"0.25"}},{name:"AvianFolkBase",char:"A",className:"cell-actor-avianfolk",type:"avianfolk",dontCreate:!0,enemies:["player","human","catfolk","dogfolk","wolfclan"],brain:o,addComp:"Flying",attack:2,defense:2,damage:"1d6",range:1,protection:1,hp:15,danger:2},{name:"avian townsfolk",base:"AvianFolkBase",danger:1,attack:1,defense:1,damage:"1d4",hp:10},{name:"avian scout",base:"AvianFolkBase",danger:2,attack:3,defense:3,damage:"2d4",hp:20,speed:110,fovrange:6},{name:"avian fighter",base:"AvianFolkBase",danger:4,attack:6,defense:7,damage:"3d4",hp:30},{name:"avian arbalist",base:"AvianFolkBase",danger:5,attack:6,defense:7,damage:"3d4",hp:30,equip:["Wooden crossbow",{name:"Wooden bolt",count:10}]},{name:"avian duelist",base:"AvianFolkBase",danger:8,attack:7,defense:10,damage:"3d5",hp:40,addComp:["CounterAttack","Flying"]},{name:"avian judicator",base:"AvianFolkBase",danger:9,attack:7,defense:10,damage:"4d4",hp:45,addComp:["FirstStrike","Flying"]},{name:"avian archmage",base:"AvianFolkBase",danger:11,attack:5,defense:10,damage:"3d4",hp:45,brain:"SpellCaster",spells:["SummonAirElemental"],pp:40,maxPP:40},{name:"avian emperor",base:"AvianFolkBase",danger:16,attack:8,defense:14,damage:"5d5",hp:85,addComp:["Flying",l(.15)]},{name:"BearfolkBase",char:"B",className:"cell-actor-bearfolk",dontCreate:!0,type:"bearfolk",attack:1,defense:1,damage:"1d5 + 1",range:1,hp:10,danger:1,enemies:["goblin","dwarf","undead","demon"],brain:o},{name:"bearfolk thief",base:"BearfolkBase",color:a.color("Yellow","Black"),damage:"1d7",brain:"Thief",attack:1,defense:1,danger:2,hp:12},{name:"bearfolk fighter",base:"BearfolkBase",damage:"1d8",attack:2,defense:2,danger:2,hp:15},{name:"bearfolk archer",base:"BearfolkBase",damage:"1d6",attack:2,defense:2,danger:3,hp:13,equip:["Wooden bow",{name:"Wooden arrow",count:10}]},{name:"bearfolk mage",base:"BearfolkBase",damage:"1d6",attack:2,defense:2,danger:4,hp:15,equip:["Robe","Wooden staff"],brain:"SpellCaster",spells:["SummonKin"],pp:20,maxPP:20},{name:"bearfolk magistrate",base:"BearfolkBase",damage:"1d10 + 2",colorfg:"Purple",attack:4,defense:4,danger:5,hp:30,equip:["Leather armour"]},{name:"bearfolk elite",base:"BearfolkBase",damage:"2d6",attack:5,defense:5,hp:37,danger:6,onHit:[{addComp:"Stun",duration:"1d4 + 1"}]},{name:"bearfolk king",base:"BearfolkBase",damage:"3d6",strength:16,attack:7,defense:7,protection:5,danger:8,hp:75},{name:"UndeadBase",className:"cell-actor-undead",color:a.color("White","Black"),dontCreate:!0,addComp:"Undead",brain:"GoalOriented",attack:1,defense:1,protection:0,range:1,enemies:r.default.ACTOR_RACES,type:"undead"},{name:"skeletal dog",char:"d",base:"UndeadBase",damage:"1d6",danger:1,brain:"Animal",hp:6},{name:"skeletal spider",char:"S",base:"UndeadBase",attack:2,defense:1,damage:"1d4",danger:1,hp:5,brain:"Animal",poison:{duration:"2d10",damage:"1d2",prob:"0.2"}},{name:"necrocentipede",char:"w",base:"UndeadBase",attack:1,defense:1,damage:"1d7",danger:2,brain:"Animal",speed:125,hp:6},{name:"skeleton",char:"z",base:"UndeadBase",attack:2,defense:1,damage:"1d5",danger:1,hp:9},{name:"zombie",char:"z",base:"UndeadBase",colorfg:"Brown",attack:2,defense:2,damage:"1d6",danger:2,hp:12},{name:"skeleton archer",char:"z",base:"UndeadBase",colorfg:"Yellow",attack:4,defense:2,damage:"1d8",danger:4,hp:15,equip:["Wooden bow",{name:"Wooden arrow",count:5}]},{name:"skeleton warrior",char:"z",base:"UndeadBase",attack:3,defense:3,damage:"1d8 + 2",danger:4,hp:20},{name:"necrowurm",char:"W",base:"UndeadBase",attack:4,defense:4,damage:"1d9",danger:5,brain:"Animal",speed:115,hp:21},{name:"skeleton berserker",char:"z",base:"UndeadBase",colorfg:"Pink",attack:6,defense:1,damage:"1d10 + 4",danger:5,hp:15},{name:"ghoul",char:"z",base:"UndeadBase",colorfg:"LightGray",attack:3,defense:3,damage:"1d7 + 2",danger:5,hp:15,onHit:[{addComp:"Paralysis",duration:"1d4"}]},{name:"crypt zombie",char:"z",base:"UndeadBase",colorfg:"Yellow",attack:2,defense:2,protection:4,damage:"3d5",danger:6,hp:30},{name:"ghost",char:"G",base:"UndeadBase",attack:4,defense:4,damage:"2d5 + 2",danger:6,onHit:[{addComp:"StatsMods",func:[{setter:"setSpeed",value:-5}],duration:"3d10"}],hp:25},{name:"wraith",char:"Z",base:"UndeadBase",colorfg:"Cyan",attack:5,defense:5,damage:"2d5 + 2",danger:6,onHit:[{addComp:"StatsMods",func:[{setter:"setStrength",value:-1}],duration:"2d10"}],hp:25},{name:"specter",char:"Z",base:"UndeadBase",colorfg:"Blue",attack:6,defense:6,damage:"2d5 + 5",danger:7,onHit:[{addComp:"StatsMods",func:[{setter:"setMagic",value:-1}],duration:"10d10"}],hp:25,addComp:["Flying",i("ICE","HIGH")]},{name:"boneclaw",char:"B",base:"UndeadBase",attack:12,defense:4,damage:"2d7 + 2",danger:9,speed:100,onAttackHit:[{addComp:"DirectDamage",func:[{setter:"setDamage",value:2},{setter:"setDamageType",value:r.default.DMG.NECRO},{setter:"setDamageCateg",value:r.default.DMG.MELEE}],duration:"1d8 + 2"}],hp:35},{name:"ghost lord",char:"G",base:"UndeadBase",colorfg:"LightGray",attack:7,defense:7,damage:"2d5 + 2",danger:8,onHit:[{addComp:"StatsMods",func:[{setter:"setSpeed",value:-10}],duration:"3d10"}],hp:35},{name:"skeleton king",char:"Z",base:"UndeadBase",colorfg:"red",attack:6,defense:6,damage:"3d5 + 5",danger:9,hp:45,addComp:[i("PIERCE","HIGH"),i("SLASH","HIGH"),i("ICE","HIGH")]},{name:"vampire",char:"V",base:"UndeadBase",colorfg:"Purple",attack:6,defense:6,damage:"3d5 + 2",danger:9,speed:120,onHit:[{addComp:"StatsMods",func:[{setter:"setStrength",value:-2}],duration:"5d10"}],hp:40},{name:"undead unicorn",char:"U",base:"UndeadBase",colorfg:"GhostWhite",attack:7,defense:7,protection:7,damage:"2d5 + 5",danger:9,speed:102,hp:50,addComp:[l(.25)]},{name:"necrowyrm",char:"W",base:"UndeadBase",colorfg:"GhostWhite",attack:7,defense:7,protection:7,damage:"3d5",danger:10,brain:"Animal",speed:107,hp:50,addComp:["Flying"]},{name:"ghost king",char:"G",base:"UndeadBase",colorfg:"Yellow",attack:7,defense:7,damage:"3d5 + 2",danger:12,brain:"SpellCaster",onHit:[{addComp:"StatsMods",func:[{setter:"setSpeed",value:-15}],duration:"3d10"}],hp:50,addComp:[l(.2)]},{name:"lich",char:"L",base:"UndeadBase",attack:4,defense:8,protection:4,damage:"1d8 + 6",danger:12,hp:50,brain:"SpellCaster",spells:["GraspOfWinter","SummonDead"],maxPP:50,pp:50,addComp:[i("ICE","MEDIUM")]},{name:"lich king",char:"L",base:"UndeadBase",colorfg:"Yellow",attack:8,defense:8,protection:6,damage:"2d8 + 2",danger:17,hp:75,brain:"SpellCaster",spells:["SummonDead","AnimateDead"],maxPP:75,pp:75,onHit:[a.meleeHitDamage(4,"1d6","NECRO")],addComp:[i("ICE","MEDIUM"),i("POISON","IMMUNITY"),i("NECRO","IMMUNITY")]},{name:"WinterBeingBase",dontCreate:!0,enemies:r.default.ACTOR_RACES,color:a.color("Blue","White"),addComp:["SnowWalk",i("ICE","MEDIUM")]},{name:"Crevasse worm",char:"w",base:"WinterBeingBase",attack:1,defense:1,damage:"1d4",speed:110,danger:1,hp:5,type:"animal"},{name:"Ice bat",char:"b",base:"WinterBeingBase",attack:1,defense:1,damage:"1d6",speed:110,danger:2,hp:8,brain:"Animal",addComp:["Flying",i("ICE","MEDIUM")],type:"animal"},{name:"Arctic fox",char:"f",base:"WinterBeingBase",attack:4,defense:1,damage:"1d7 + 3",speed:105,danger:3,hp:12,brain:"Animal",type:"animal"},{name:"Frost goblin",char:"g",base:"WinterBeingBase",attack:3,defense:3,protection:1,damage:"1d7",hp:12,danger:3,type:"icebeing",brain:o},{name:"Frost viper",char:"s",base:"WinterBeingBase",attack:3,defense:3,protection:3,damage:"1d7",hp:18,danger:4,type:"animal",poison:{duration:"1d6 + 5",damage:"1d6",prob:"0.1"}},{name:"Arctic Wolf",char:"w",base:"WinterBeingBase",attack:4,defense:2,damage:"1d8",brain:"Animal",hp:21,danger:5,type:"animal"},{name:"Glacial shaman",char:"@",base:"WinterBeingBase",colorfg:"CadetBlue",attack:4,defense:4,protection:3,damage:"1d7 + 2",type:"icebeing",danger:5,hp:25,spells:["IcyPrison"],maxPP:22,pp:21,brain:"SpellCaster"},{name:"Glacial golem",char:"G",base:"WinterBeingBase",attack:4,defense:4,protection:3,damage:"2d4",speed:90,danger:5,hp:30,type:"construct"},{name:"Ice minion",base:"WinterBeingBase",char:"m",attack:4,defense:4,protection:2,damage:"2d4",hp:20,danger:5,type:"demon",onHit:[{addComp:"Coldness",duration:"10d10"}]},{name:"Mighty raven",base:"WinterBeingBase",char:"R",attack:4,defense:10,damage:"2d4 + 2",range:1,hp:20,danger:5,brain:"Animal",addComp:["Flying",i("ICE","MEDIUM")]},{name:"Snow leopard",base:"WinterBeingBase",char:"f",attack:8,defense:4,damage:"1d6 + 5",range:1,hp:25,danger:5,brain:"Animal",type:"animal",speed:120},{name:"Cryomancer",base:"WinterBeingBase",char:"@",type:"icebeing",attack:4,defense:4,damage:"1d6",range:1,hp:30,danger:5,spells:["FrostBolt"],maxPP:22,pp:21,brain:"SpellCaster"},{name:"Winter demon",type:"demon",char:"&",colorfg:"CadetBlue",attack:5,defense:5,protection:2,damage:"3d3",range:1,hp:30,danger:10,brain:"GoalOriented",base:"WinterBeingBase"},{name:"Harbinger of winter",type:"demon",char:"@",colorfg:"DarkBlue",attack:5,defense:5,protection:2,damage:"3d3",range:1,hp:35,danger:10,brain:"SpellCaster",base:"WinterBeingBase",spells:["GraspOfWinter"],maxPP:30,pp:30},{name:"Stormrider",type:"demon",char:"&",colorfg:"DarkBlue",attack:6,defense:6,protection:3,damage:"4d3",range:1,hp:40,danger:12,brain:"GoalOriented",base:"WinterBeingBase",equip:["Permaice short sword"]},{name:"Ice archon",type:"demon",char:"A",attack:6,defense:6,protection:3,damage:"4d3",range:1,hp:40,danger:12,base:"WinterBeingBase",brain:"SpellCaster",pp:30,maxPP:30,spells:["RingOfFrost"]},{name:"Ice djinn",type:"demon",char:"&",attack:7,defense:6,protection:6,damage:"3d5+5",range:1,hp:45,danger:14,brain:"GoalOriented",base:"WinterBeingBase"},{name:"Blizzard beast",type:"demon",char:"B",colorfg:"CadetBlue",attack:7,defense:6,protection:8,damage:"3d5+5",range:1,hp:50,danger:16,brain:"GoalOriented",base:"WinterBeingBase"},{name:"Ice behemoth",type:"demon",char:"B",colorfg:"DarkBlue",attack:10,defense:3,protection:8,damage:"4d5+5",range:2,hp:65,danger:16,brain:"GoalOriented",base:"WinterBeingBase",onHit:[{addComp:"Coldness"}]},{name:"Frost Titan",type:"giant",char:"H",attack:8,defense:7,protection:12,damage:"5d5",range:1,hp:80,danger:18,brain:"GoalOriented",base:"WinterBeingBase",onHit:[{addComp:"Stun",duration:"1d8"}]},{name:"Frostburn monarch",type:"demon",char:"M",attack:10,defense:10,protection:10,damage:"4d5",range:1,hp:70,danger:20,brain:"SpellCaster",base:"WinterBeingBase",onHit:[{addComp:"Coldness"}],spells:["FrostBolt","SummonIceMinion"],pp:50,maxPP:50},{name:"dwarf",char:"h",type:"dwarf",className:"cell-actor-dwarf",attack:2,defense:2,protection:1,damage:"1d4",range:1,hp:20,danger:3,enemies:["human","undead","demon"],brain:o},{name:"dwarven fighter",base:"dwarf",attack:4,defense:4,protection:2,damage:"1d7",range:1,hp:30,danger:4,equip:["Spear"]},{name:"dwarven axeman",base:"dwarf",attack:4,defense:4,protection:3,damage:"1d8",range:1,hp:40,danger:5,equip:["Battle axe","Chain armour"]},{name:"dwarven hammerer",base:"dwarf",attack:4,defense:6,protection:4,damage:"1d10",range:1,hp:45,danger:6,equip:["Dwarven pick-axe","Leather armour"]},{name:"dwarven bolter",base:"dwarf",attack:7,defense:3,damage:"1d8",range:1,hp:40,danger:7,fovrange:7,equip:["Steel crossbow",{name:"Steel bolt",count:7}]},{name:"dwarven rifleman",base:"dwarf",attack:4,defense:4,damage:"1d8",range:1,hp:40,danger:8,fovrange:7,equip:["Rifle",{name:"Steel bullet",count:10}]},{name:"dwarven elite",base:"dwarf",attack:5,defense:6,damage:"3d5 + 3",range:1,hp:50,danger:9,equip:["Battle axe","Steel armour"]},{name:"dwarven commander",base:"dwarf",attack:8,defense:8,protection:7,damage:"2d5",range:1,hp:60,danger:10,equip:["Great battle axe","Steel armour"]},{name:"dwarven king",base:"dwarf",colorfg:"red",attack:12,defense:12,protection:10,damage:"4d5 + 5",range:1,hp:75,danger:15,equip:["Mithril armour"]},{name:"human",char:"@",type:"human",className:"cell-actor-human",attack:2,defense:2,damage:"1d4",range:1,hp:20,danger:3,brain:o},{name:"townsfolk",base:"human",attack:1,defense:1,damage:"1d4",range:1,hp:10,danger:1},{name:"robber",base:"human",attack:2,defense:4,danger:3,enemies:["player"]},{name:"miner",base:"human",attack:4,danger:4,damage:"1d5",equip:["Pick-axe"]},{name:"fighter",base:"human",hp:25,attack:4,defense:4,damage:"1d8",danger:5},{name:"warlord",char:"W",base:"human",hp:35,attack:5,defense:6,damage:"3d3",danger:6},{name:"trainer",char:"@",base:"human",hp:50,attack:10,defense:10,protection:5,damage:"3d3",className:"cell-actor-trainer",noRandom:!0,danger:6,inv:[{name:"Gold coin",count:50}],addComp:"Trainer"},{name:"shopkeeper",char:"@",base:"human",hp:50,attack:10,defense:10,protection:5,damage:"3d3",className:"cell-actor-shopkeeper",noRandom:!0,danger:6,inv:[{name:"Gold coin",count:100}]},{name:"summoner",char:"@",base:"human",hp:50,attack:7,defense:7,protection:3,damage:"2d4",brain:"SpellCaster",spells:["SummonKin"],maxPP:30,pp:30,danger:10},{name:"wildling",char:"I",className:"cell-actor-wildling",type:"wildling",brain:o,attack:2,defense:1,damage:"1d6",range:1,hp:15,danger:3,enemies:["player","human"]},{name:"wildling hunter",base:"wildling",char:"I",attack:3,defense:3,damage:"1d6",hp:20,danger:3,equip:["Tomahawk"]},{name:"wildling archer",base:"wildling",char:"I",attack:3,defense:3,damage:"1d6",hp:20,danger:4,equip:["Wooden bow",{name:"Wooden arrow",count:10}],colorfg:"Yellow",brain:o},{name:"wildling fighter",base:"wildling",char:"I",attack:4,defense:3,damage:"1d9",hp:25,danger:5},{name:"wildling elite",base:"wildling",char:"I",attack:5,defense:3,damage:"1d10",hp:32,danger:6},{name:"wildling warlord",base:"wildling",char:"I",attack:6,defense:3,damage:"1d12",hp:40,danger:7,colorfg:"YellowGreen"},{name:"wildling king",base:"wildling",char:"I",attack:8,defense:5,damage:"1d15",hp:50,danger:10,colorfg:"Red"},{name:"CatfolkBase",char:"f",className:"cell-actor-catfolk",type:"catfolk",dontCreate:!0,attack:1,defense:1,protection:1,damage:"1d6",range:1,hp:10,danger:1,enemies:["player","human","dogfolk","wolfclan"],brain:o},{name:"catfolk townsfolk",base:"CatfolkBase",attack:1,defense:1,hp:10,danger:1},{name:"catfolk hunter",base:"CatfolkBase",attack:1,defense:4,damage:"3d2",hp:15,danger:2},{name:"catfolk darter",base:"CatfolkBase",attack:1,defense:4,damage:"3d2",hp:15,danger:3,brain:o,equip:[{name:"Iron dart",count:9}]},{name:"catfolk warrior",base:"CatfolkBase",attack:2,defense:5,damage:"4d2",hp:20,danger:4},{name:"catfolk elite",base:"CatfolkBase",attack:3,defense:7,damage:"5d2",hp:27,danger:5,addComp:"CounterAttack"},{name:"catfolk wizard",base:"CatfolkBase",attack:3,defense:6,damage:"4d2",hp:25,danger:6,brain:"SpellCaster",spells:["EnergyArrow"],maxPP:20,pp:20},{name:"catfolk warlord",base:"CatfolkBase",attack:4,defense:8,damage:"6d2",hp:35,danger:7},{name:"catfolk queen",base:"CatfolkBase",attack:6,defense:15,damage:"7d3",hp:45,danger:10,colorfg:"Purple",addComp:"FirstStrike"},{name:"catfolk king",base:"CatfolkBase",attack:10,defense:12,protection:6,damage:"7d3 + 5",hp:60,danger:13,colorfg:"Red"},{name:"WolfclanBase",dontCreate:!0,danger:1,attack:1,defense:1,damage:"1d4",range:1,protection:2,className:"cell-actor-wolfclan",char:"w",type:"wolfclan",enemies:["player","human","catfolk","dogfolk","bearfolk"],brain:o},{name:"wolfclan folk",base:"WolfclanBase",danger:1,hp:12,attack:2,defense:1,damage:"1d6",range:1},{name:"wolfclan brave",base:"WolfclanBase",danger:4,attack:4,defense:3,damage:"2d4",hp:25},{name:"wolfclan skirmisher",base:"WolfclanBase",danger:5,attack:5,defense:4,damage:"2d4+3",hp:30},{name:"wolfclan scourger",base:"WolfclanBase",danger:6,attack:7,defense:5,damage:"2d4+7",hp:35},{name:"wolfclan mage",base:"WolfclanBase",danger:7,attack:7,defense:5,damage:"2d4+7",hp:35,spells:["PowerDrain"],maxPP:30,pp:30,brain:"SpellCaster"},{name:"wolfclan elite",base:"WolfclanBase",danger:8,attack:8,defense:5,protection:5,damage:"2d4+10",hp:50,addComp:"CounterAttack"},{name:"wolfclan judicator",base:"WolfclanBase",danger:9,attack:8,defense:8,damage:"3d4+6",hp:55,addComp:"FirstStrike"},{name:"wolfclan commander",base:"WolfclanBase",danger:10,attack:10,defense:5,damage:"4d4+10",hp:60},{name:"wolfclan king",base:"WolfclanBase",danger:14,attack:10,defense:10,damage:"5d4+10",hp:75},{name:"DogfolkBase",dontCreate:!0,className:"cell-actor-dogfolk",char:"d",type:"dogfolk",protection:1,enemies:["player","catfolk","wolfclan"],brain:o},{name:"dogfolk gatherer",base:"DogfolkBase",attack:1,defense:3,damage:"1d4 + 1",hp:10,danger:1},{name:"dogfolk hunter",base:"DogfolkBase",attack:2,defense:3,damage:"6d1",hp:15,danger:2},{name:"dogfolk thrower",base:"DogfolkBase",attack:2,defense:3,damage:"6d1+1",hp:15,danger:3,equip:[{name:"Throwing axe",count:7}]},{name:"dogfolk warrior",base:"DogfolkBase",danger:4,attack:3,defense:3,damage:"7d1+3",hp:20},{name:"dogfolk skirmisher",base:"DogfolkBase",danger:5,attack:4,defense:3,damage:"9d1+3",hp:25},{name:"dogfolk elite",base:"DogfolkBase",danger:8,attack:6,defense:6,damage:"8d2+4",hp:35,addComp:"CounterAttack"},{name:"dogfolk commander",base:"DogfolkBase",danger:10,attack:8,defense:8,damage:"8d3+4",hp:50},{name:"dogfolk king",base:"DogfolkBase",danger:13,colorfg:"red",colorbg:"white",attack:12,defense:8,damage:"8d3+8",hp:65},{name:"SpiritBase",char:"Q",className:"cell-actor-spirit",type:"spirit",dontCreate:!0,addComp:["Ethereal"],brain:"Spirit"},{name:"Rat spirit",base:"SpiritBase",strength:0,accuracy:0,agility:1,willpower:0,power:1,danger:1},{name:"Wolf spirit",base:"SpiritBase",strength:1,accuracy:0,agility:1,willpower:0,power:2,danger:2},{name:"Bear spirit",base:"SpiritBase",strength:2,accuracy:0,agility:1,willpower:0,power:3,danger:3},{name:"Fighter spirit",base:"SpiritBase",strength:2,accuracy:2,agility:1,willpower:0,power:4,danger:4},{name:"Shaman spirit",base:"SpiritBase",strength:0,accuracy:0,agility:0,willpower:6,power:5,danger:5},{name:"Winter demon spirit",base:"SpiritBase",strength:3,accuracy:3,agility:3,willpower:3,power:7,danger:7},{name:"Monarch spirit",base:"SpiritBase",strength:6,accuracy:0,agility:1,willpower:6,power:10,danger:12},{name:"HyrkhianBase",dontCreate:!0,className:"cell-actor-hyrkh",char:"y",enemies:["undead","demon","beast","animal"],damage:"1d6",type:"hyrkhian",brain:o},{name:"Hyrkhian townsfolk",base:"HyrkhianBase",damage:"1d6",attack:1,defense:1,protection:1,hp:7,danger:1},{name:"Hyrkhian footman",base:"HyrkhianBase",attack:2,defense:2,protection:2,hp:15,danger:3,equip:["Longsword"]},{name:"Hyrkhian phalanx",base:"HyrkhianBase",attack:4,defense:4,protection:2,hp:25,danger:5,equip:["Chain armour","Spear"]},{name:"Hyrkhian archer",base:"HyrkhianBase",attack:4,defense:4,protection:2,damage:"1d8",hp:20,equip:["Steel bow",{name:"Steel arrow",count:15}],danger:6},{name:"Hyrkhian adept",base:"HyrkhianBase",attack:4,defense:4,protection:2,hp:25,danger:7,maxPP:30,pp:30,brain:"SpellCaster",spells:["Heal","MagicArmor"]},{name:"Hyrkhian elite",base:"HyrkhianBase",attack:6,defense:6,protection:3,hp:35,brain:o,strength:13,equip:["Mithril short sword","Chain armour","Chain helmet"],danger:8},{name:"Hyrkhian commander",base:"HyrkhianBase",attack:8,defense:8,protection:4,hp:50,brain:o,strength:15,equip:["Great battle axe","Steel armour","Steel helmet"],danger:10},{name:"SpecialBase",noRandom:!0,actorType:"BaseActor",dontCreate:!0},{name:"Fire",className:"cell-actor-fire",base:"SpecialBase",char:"*",type:"flame",brain:"Flame",addComp:["Ethereal","NonSentient",{comp:"Damaging",func:{setDamageType:r.default.DMG.FIRE}}]},{name:"Ice flame",className:"cell-actor-winter",base:"SpecialBase",char:"*",type:"flame",brain:"Flame",addComp:["Ethereal","NonSentient",{comp:"Damaging",func:{setDamageType:r.default.DMG.ICE}}],onHit:[{addComp:"Coldness",duration:"10d10"}]},{name:"Poison gas",className:"cell-actor-poison",base:"SpecialBase",char:"*",type:"flame",brain:"Cloud",color:a.color("Green","Gray"),addComp:["Ethereal","NonSentient",{comp:"Damaging",func:{setDamageType:r.default.DMG.POISON}}],poison:{duration:"1d10",damage:"1d10",prob:"0.1"}},{name:"Forcefield",className:"cell-actor-forcefield",base:"SpecialBase",char:"*",type:"forcefield",brain:"NonSentient",speed:1,hp:25,defense:0,addComp:["Health","NonSentient","Combat","SpellStop","Breakable",{comp:"Weakness",func:{setEffect:r.default.DMG.MAGIC,setLevel:r.default.WEAKNESS.FATAL}}]},{name:"flying eye",className:"cell-actor-void",base:"SpecialBase",char:"e",type:"eye",addComp:["Ethereal"],brain:"Explorer",hp:1,speed:130,fovrange:3,actorType:"Sentient"},{name:"UniqueBase",dontCreate:!0,className:"cell-actor-unique",noRandom:!0,unique:!0,addComp:["RegenEffect"],color:a.color("DarkViolet","Beige")},{name:"Thabba, Son of Ice",base:"UniqueBase",char:"@",danger:200,enemies:["human"],type:"finalboss",spells:["FrostBolt","RingOfFrost"],hp:266,pp:100,brain:"SpellCaster",damage:"4d5",strength:30,accuracy:15,agility:20,willpower:20,perception:15,magic:30,attack:30,defense:30,protection:10,equip:["Permaice katana","Permaice armour"],addComp:["SnowWalk",i("ICE","HIGH"),"RegenEffect"]},{name:"Zamoned, Son of Frost",base:"UniqueBase",char:"@",danger:200,enemies:["human"],type:"finalboss",hp:200,pp:100,brain:o,strength:20,accuracy:25,agility:35,willpower:15,perception:25,magic:10,attack:30,defense:30,protection:10,damage:"4d5",equip:["Permaice axe","Permaice armour","Bow of Defense",{name:"Runed arrow",count:100}],addComp:["SnowWalk",i("ICE","HIGH"),"RegenEffect"]},{name:"Hag of North",type:"wolfclan",base:"UniqueBase",char:"w",danger:100,damage:"4d4+5",hp:75,pp:50,brain:"SpellCaster",spells:["IcyPrison","FrostBolt"],strength:15,accuracy:15,agility:15,willpower:30,perception:25,magic:25,attack:15,defense:15,protection:5,equip:["Ruby glass armour","Ruby glass collar"],addComp:["SnowWalk",i("ICE","HIGH"),"RegenEffect"]},{name:"Aime Aeon en Nev, Mighty spellsinger",type:"dogfolk",base:"UniqueBase",char:"d",danger:100,damage:"5d5 + 5",hp:100,pp:75,brain:"SpellCaster",spells:["Paralysis","Flying","Heal","LightningArrow"],strength:18,accuracy:19,agility:18,willpower:28,perception:15,magic:25,attack:20,defense:15,protection:5,equip:["Runed armour","Runed collar"],onHit:[{addComp:"Stun",duration:"1d4 + 1"}],addComp:["RegenEffect"]},{name:"Aspelin Primoen, the Blacksmith",type:"dogfolk",base:"UniqueBase",char:"d",danger:75,damage:"3d7 + 3",hp:134,brain:o,strength:25,accuracy:20,agility:19,willpower:15,perception:19,magic:13,attack:25,defense:15,protection:10,equip:["Hammer of Void","Mithril armour"]},{name:"Elene Immolate Kinin, Queen of cats",type:"catfolk",base:"UniqueBase",char:"f",danger:100,damage:"10d3 + 3",hp:123,pp:50,brain:"SpellCaster",spells:["ScorpionsTail","EnergyArrow","SummonKin"],strength:15,accuracy:25,agility:25,willpower:17,perception:25,magic:17,attack:25,defense:15,protection:5,equip:["Steel armour","Runed collar"],addComp:["FirstStrike","RangedEvasion","RegenEffect"]},{name:"Tajun Eon en Lotus, lich lord",type:"undead",base:"UniqueBase",char:"L",danger:85,color:{fg:"Red",bg:"Black"},enemies:r.default.ACTOR_RACES,damage:"2d9 + 4",hp:90,pp:100,maxPP:100,brain:"SpellCaster",strength:14,accuracy:15,agility:14,willpower:25,perception:19,magic:30,attack:25,defense:15,protection:10,equip:["Runed robe"],onHit:[a.meleeHitDamage(4,"2d8 + 2","NECRO")],spells:["SummonDead","FrostBolt","GraspOfWinter"],addComp:["RegenEffect"]},{name:"Zargoth, undead sorcerer",type:"undead",base:"UniqueBase",char:"Z",danger:75,color:{fg:"DarkSalmon",bg:"Black"},enemies:r.default.ACTOR_RACES,damage:"2d9 + 4",hp:100,pp:75,maxPP:75,brain:"SpellCaster",strength:17,accuracy:20,agility:17,willpower:21,perception:19,magic:25,attack:25,defense:15,protection:10,fovrange:7,onHit:[a.meleeHitDamage(2,"1d8 + 2","NECRO")],spells:["SummonUndeadUnicorns","ShadowRay"],addComp:["RegenEffect"]},{name:"Emption Agana Sunkist, Emperor bear",type:"bearfolk",base:"UniqueBase",char:"B",danger:75,damage:"4d7 + 3",hp:123,brain:o,strength:35,accuracy:17,agility:17,willpower:17,perception:17,magic:10,attack:35,defense:35,protection:15,equip:["Mithril armour","Mithril shield"],onHit:[a.meleeHitDamage(8,"1d2","LIGHTNING"),{addComp:"Stun",duration:"1d4 + 1"}]},{name:"Dvaling, dwarven sharpshooter",type:"dwarf",base:"UniqueBase",char:"h",danger:70,damage:"4d7 + 3",hp:123,brain:o,strength:35,accuracy:17,agility:17,willpower:17,perception:30,magic:10,attack:35,defense:35,protection:5,fovrange:9,equip:["Chain armour","Chain helmet","Chain boots","Double crossbow",{name:"Void bolt",count:30}],addComp:["EagleEye","RangedEvasion","StrongShot","RegenEffect"]},{name:"Sierra Lilith Hupoith Zoic, the arcavian",type:"avianfolk",base:"UniqueBase",char:"A",danger:77,damage:"4d7 + 3",hp:123,brain:o,strength:20,accuracy:21,agility:21,willpower:17,perception:23,magic:22,attack:25,defense:25,protection:7,fovrange:7,equip:["Ruby glass armour","Mithril helmet","Mithril shield"],addComp:["Flying","RegenEffect","RangedEvasion"]}],t.Actors={},t.Actors.scaleValue=function(e,t,n){e.forEach(e=>{Number.isInteger(e[t])&&(e[t]=Math.round(n*e[t]))})},t.Actors.addValue=function(e,t,n){e.forEach(e=>{Number.isInteger(e[t])&&(e[t]+=n)})},t.Actors.scale={attack:2,danger:1,hp:1.5},t.Actors.add={attack:4},t.Actors.modToFunc={scale:"scaleValue",add:"addValue"},t.Actors.modOrder=["scale","add"],t.adjustActorValues=((e,n=t.Actors.modOrder)=>{n.forEach(n=>{const s=t.Actors.modToFunc[n];Object.keys(t.Actors[n]).forEach(r=>{t.Actors[s](e,r,t.Actors[n][r])})})}),t.resistance=i,t.BypassComp=l},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(28),i=r(n(11)),l=n(9),c=n(30),u=n(14),h=n(20),d=n(12),p=n(21),f=n(43),m=l.Random.getRNG(),{KeyMap:g}=o.Keys,y=i.create;t.Spell={};t.Spell.addPoisonEffect=((e,t)=>{const n=t.get("Experience").getExpLevel(),s=new c.Dice(1,n,Math.ceil(n/2));let r=.07*n;r>=.5&&(r=.5);const a=new c.Dice(2,n+5,Math.ceil(n/2)).roll();v(e,t,a,s,r)});const v=(e,t,n,s,r)=>{const a=new i.Poison;a.setDamageDie(s);const o=new i.Expiration;o.addEffect(a,n),a.setSource(t),a.setProb(r),e.add(a),e.add(o)},_=(e,t,n)=>{const s=n.getCaster();s.getLevel().addActor(e,t.getX(),t.getY());const r=new i.Fading,a=n.getDuration();r.setDuration(a),e.add(r);const o=new i.Created;o.setCreator(s),e.add(o)};t.Spell.addFadingActorToCell=_;const b=(e,t,n)=>{const s=[t.getX()-e.getX(),t.getY()-e.getY()];n(e,{dir:s,src:e})};t.Spell.aiSpellCellDone=b;t.Spell.aiSpellCellEnemy=((e,t)=>{const{actor:n,actorCellsAround:s}=e;let r=null;return s.forEach(t=>{t.getActors().forEach(t=>{if(n.isEnemy(t)){const n=t.get("Health");r?e.compFunc?e.compFunc(r,t)&&(r=t):n.getMaxHP()>r.get("Health").getMaxHP()&&(r=t):r=t}})}),!!r&&(b(n,r,t),!0)});t.Spell.aiSpellCellFriend=((e,t)=>{const{actor:n,actorCellsAround:s}=e;let r=null;return s.forEach(t=>{t.getActors().forEach(t=>{if(n.isFriend(t))if(r)if(e.compFunc)e.compFunc(r,t)&&(r=t);else{const e=r.get("Health");t.get("Health").hpLost()>e.hpLost()&&(r=t)}else r=t})}),!!r&&(b(n,r,t),!0)});t.Spell.aiSpellCellSelf=((e,t)=>{const{actor:n}=e;let s=!0;return e.compFunc&&(s=!!e.compFunc(n)),s&&b(n,n,t),s}),t.Spell.getSelectionObjectSelf=((e,t)=>{return()=>{const n=new i.SpellCast;n.setSource(t),n.setSpell(e),n.setArgs({src:t}),t.add(n)}}),t.Spell.getSelectionObjectDir=((e,t,n)=>(a.default.gameMsg(n),{select:n=>{const s={dir:g.getDir(n)};return s.dir?(s.src=t,()=>{const n=new i.SpellCast;n.setSource(t),n.setSpell(e),n.setArgs(s),t.add(n)}):null},showMenu:()=>!1}));const E=function(e,t){return{from:t.src.getXY(),dir:t.dir,spell:e,src:t.src}};t.Spell.getDirSpellArgs=E;class S{constructor(e){this._actor=e,this._spells=[],a.default.isNullOrUndef([this._actor])&&a.default.err("Spell.SpellBook","new","actor must be given.")}getActor(){return this._actor}addSpell(e){this._spells.push(e),e.setCaster(this.getActor())}getSpells(){return this._spells}equals(e){const t=e.getSpells();let n=!0;return this._spells.forEach((e,s)=>{(n=n&&e.equals(t[s]))||console.log("Spell",e.getName()," caused error")}),n}getSelectionObject(){const e=this._spells;return{select:t=>{const n=o.Keys.codeToIndex(t);return n<e.length?e[n].getSelectionObject(this._actor):null},getMenu:()=>{a.default.gameMsg("Please select a spell to cast:");const t=o.Keys.menuIndices.slice(0,this._spells.length),n={pre:["You know the following spells:"]};return e.forEach((e,s)=>{n[t[s]]=e.toString()}),n},showMenu:()=>!0}}toJSON(){return{spells:this._spells.map(e=>e.toJSON())}}}function C(e,t,n){const{actor:s,enemy:r}=e;if(!r)return!1;if(h.Brain.distToActor(s,r)<=n.getRange()){return t(s,{target:r,src:s}),!0}return!1}t.SpellBook=S,t.Spell.SpellBook=S,t.SpellBase=function(e,t){this._name=e,this._power=t||5,this._caster=null,this._dice={},this._range=0,this.setName(e)},t.SpellBase.prototype.setCaster=function(e){this._caster=e},t.SpellBase.prototype.getCaster=function(){return this._caster},t.SpellBase.prototype.setName=function(e){const t=e.split(/\s+/),n=[];t.forEach(e=>{n.push(e.capitalize())}),this._new=n.join("")},t.SpellBase.prototype.getName=function(){return this._name},t.SpellBase.prototype.getPower=function(){return this._power},t.SpellBase.prototype.canCast=function(){return this._caster.get("SpellPower").getPP()>=this.getCastingPower()},t.SpellBase.prototype.getCastingPower=function(){let e=this._power;const t=this._caster.get("Experience").getExpLevel();if(e-=Math.ceil(t/3),this._caster.has("Skills")){const t=this._caster.get("Skills").getLevel("SpellCasting");e-=Math.ceil(t/2)}const n=Math.round(.5*this._power);return e<n?n:e},t.SpellBase.prototype.getRange=function(){return this._range},t.SpellBase.prototype.setRange=function(e){this._range=e},t.SpellBase.prototype.getDuration=function(e=1){let t=0;if(this._dice.duration&&(t=this._dice.duration.roll()),e>0){const n=this._caster.get("Experience").getExpLevel();t+=Math.round(n/e)}return t},t.SpellBase.prototype.getDamage=function(e=1){let t=0;this._dice.damage&&(t=this._dice.damage.roll());const n=this._caster.get("Experience").getExpLevel();return t+=Math.round(n/e)},t.SpellBase.prototype.setPower=function(e){this._power=e},t.SpellBase.prototype.getCastFunc=function(e,t){return t.dir||t.target||t.src?(t.src=e,()=>{const n=new i.SpellCast;n.setSource(e),n.setSpell(this),n.setArgs(t),e.add(n)}):null},t.SpellBase.prototype.toString=function(){const e=this.getCastingPower();let t=`${this.getName()} - ${e}PP`;return this._dice.damage&&(t+=` Dmg: ${this._dice.damage.toString()}`),this._dice.duration&&(t+=` Dur: ${this._dice.duration.toString()}`),this._range>0&&(t+=` R: ${this.getRange()}`),t},t.SpellBase.prototype.getCasterExpBonus=function(e){const t=this.getCaster().get("Experience").getExpLevel();return Math.round(t/e)},t.SpellBase.prototype.getCasterStatBonus=function(e,t){const n="get"+e.capitalize(),s=this.getCaster()[n]();return Math.round(s/t)},t.SpellBase.prototype.equals=function(e){let t=this.getName()===e.getName();return t=(t=t&&this.getPower()===e.getPower())&&this.getRange()===e.getRange(),Object.keys(this._dice).forEach(n=>{t=!!e._dice[n]&&(t&&this._dice[n].equals(e._dice[n]))}),t},t.SpellBase.prototype.setDice=function(e,t){"string"==typeof t?this._dice[e]=c.Dice.create(t):t.roll&&(this._dice[e]=t)},t.SpellBase.prototype.getDice=function(e){return this._dice[e]},t.SpellBase.prototype.hasDice=function(e){return!(!this._dice.hasOwnProperty(e)||!this._dice[e])},t.SpellBase.prototype.removeDice=function(e){this._dice[e]=null},t.SpellBase.prototype.rollDice=function(e){return this._dice[e]?this._dice[e].roll():(a.default.err("SpellBase","rollDice",`No dice with name ${e} found`),0)},t.SpellBase.prototype.aiShouldCastSpell=function(e,t){return!1},t.SpellBase.prototype.toJSON=function(){const e={};return Object.keys(this._dice).forEach(t=>{a.default.isNullOrUndef([this._dice[t]])||(e[t]=this._dice[t].toJSON())}),{name:this.getName(),new:this._new,power:this.getPower(),dice:e,range:this._range}},t.Spell.AddComponent=function(e,n){t.SpellBase.call(this,e,n),this._compName="",this._dice.duration=c.Dice.create("1d6 + 3")},a.default.extend2(t.Spell.AddComponent,t.SpellBase),t.Spell.AddComponent.prototype.setDuration=function(e){this._dice.duration=e},t.Spell.AddComponent.prototype.setCompName=function(e){this._compName=e},t.Spell.AddComponent.prototype.getCompName=function(){return this._compName},t.Spell.AddComponent.prototype.cast=function(e){const t=E(this,e),n=y(this._compName);if(n.setSource&&n.setSource(e.src),t.addComp={comp:n},this.hasDice("duration")){const e=this.rollDice("duration");t.addComp.duration=e}const s=new i.SpellCell;s.setArgs(t),e.src.add(s)},t.Spell.AddComponent.prototype.getSelectionObject=function(e){return t.Spell.getSelectionObjectDir(this,e,"Select a direction for the spell:")},t.Spell.RemoveComponent=function(e,n){t.SpellBase.call(this,e,n),this._compNames=[],this.setCompNames=(e=>{this._compNames="string"==typeof e?[e]:e}),this.getCompNames=(()=>this._compNames),this.cast=function(e){const t=E(this,e);t.removeComp=this._compNames;const n=new i.SpellCell;n.setArgs(t),e.src.add(n)},this.getSelectionObject=function(e){return t.Spell.getSelectionObjectDir(this,e,"Select a direction for the spell:")}},a.default.extend2(t.Spell.RemoveComponent,t.SpellBase),t.Spell.Ranged=function(e,n){t.SpellBase.call(this,e,n),this._dice.damage=c.Dice.create("4d4 + 4"),this._range=5},a.default.extend2(t.Spell.Ranged,t.SpellBase),t.Spell.BoltBase=function(e,n){t.Spell.Ranged.call(this,e,n),this.stopOnHit=!1,this.cast=function(e){const t=E(this,e);t.damageType=this.damageType,t.damage=this.rollDice("damage");const n=new i.SpellRay;n.setArgs(t),e.src.add(n)},this.getSelectionObject=function(e){return a.default.gameMsg("Select a direction for firing:"),{select:t=>{const n=g.getDir(t);return this.getCastFunc(e,{dir:n})},showMenu:()=>!1}},this.aiShouldCastSpell=((e,t)=>{const{actor:n,enemy:s}=e;if(!s)return!1;const[r,o]=[n.getX(),n.getY()],[i,l]=[s.getX(),s.getY()],c=d.Geometry.getStraightLine(r,o,i,l);if(c.length>1){const e={dir:[c[1][0]-c[0][0],c[1][1]-c[0][1]]};return"function"==typeof t?t(n,e):a.default.err("Spell.BoltBase","aiShouldCastSpell","No callback function given!"),!0}return!1})},a.default.extend2(t.Spell.BoltBase,t.Spell.Ranged),t.Spell.SummonBase=function(e,n){t.SpellBase.call(this,e,n),this.summonType="",this.nActors=1,this.summonFunc=null,this.setSummonType=(e=>{this.summonType=e}),this.cast=function(e){const t=E(this,e),n=c.Dice.getValue(this.nActors);t.callback=(t=>{if(1===n)t.isFree()&&this._createAndAddActor(t,e);else{const t=e.src,s=t.getLevel().getMap(),[r,o]=t.getXY(),i=d.Geometry.getBoxAround(r,o,2);let l=0,c=30;for(;l<n;){const[t,n]=m.arrayGetRand(i);if(s.hasXY(t,n)){const r=s.getCell(t,n);r.isFree()&&(this._createAndAddActor(r,e),++l)}if(0==--c)break}if(l<n){const e=`${t.getName()} has no space to summon`;a.default.gameMsg({cell:t.getCell(),msg:e})}}});const s=new i.SpellCell;s.setArgs(t),e.src.add(s)},this.getSelectionObject=function(e){return t.Spell.getSelectionObjectDir(this,e,"Select a free cell for summoning:")},this.aiShouldCastSpell=((e,t)=>{const{actor:n,enemy:s}=e;if(0===h.Brain.getFriendCellsAround(n).length)if("function"==typeof t){const s=n.getBrain().getRandAdjacentFreeCell();if(s)return e.dir=a.default.dXdY(s,n),t(n,e),!0}else a.default.err(`Spell.${this.getName()}`,"aiShouldCastSpell",`No callback function given! enemy: ${s}`);return!1}),this._createAndAddActor=((e,t)=>{const[n,s]=[e.getX(),e.getY()],r=t.src,o=r.getLevel(),i=u.ObjectShell.getParser();let l=null;if(""!==this.summonType?l=i.createActor(this.summonType):this.summonFunc&&(l=i.createRandomActor({func:this.summonFunc})),l){o.addActor(l,n,s),l.getBrain().getMemory().copyMemoryFrom(r),l.addFriend(r),r.addFriend(l);const i=`${r.getName()} summons ${l.getName()}!`;a.default.gameMsg({cell:e,msg:i}),"function"==typeof this.postSummonCallback&&this.postSummonCallback(e,t,l)}else{let e=`Failed to create summon type |${this.summonType}|`;if(this.summonFunc){e=`summonFunc ${this.summonFunc.toString()} gave no actors`}a.default.warn("Spell.SummonBase","_createAndActor",e)}})},a.default.extend2(t.Spell.SummonBase,t.SpellBase),t.Spell.Missile=function(e,n){t.Spell.Ranged.call(this,e,n),this.ammoName=""},a.default.extend2(t.Spell.Missile,t.Spell.Ranged),t.Spell.Missile.prototype.getAmmoName=function(){return this.ammoName},t.Spell.Missile.prototype.cast=function(e){const[t,n]=[e.src.getX(),e.src.getY()],s={from:[t,n],target:e.target,spell:this,src:e.src,to:[e.target.getX(),e.target.getY()]};s.damageType=this.damageType,s.damage=this.getDamage();const r=new i.SpellMissile;r.setArgs(s),e.src.add(r)},t.Spell.Missile.prototype.getSelectionObject=function(e){a.default.gameMsg("Press [n/p] for next/prev target. [t] to fire."),e.getBrain().startTargeting();const t=[{key:o.Keys.KEY.TARGET,func:()=>{const t=e.getBrain().getTarget();if(t){console.log("ZZZ Target is",t);const n=new i.SpellCast;n.setSource(e),n.setSpell(this),n.setArgs({src:e,target:t}),e.add(n),e.getBrain().cancelTargeting()}}}];return new f.PlayerMissileMenu(t,e)},t.Spell.Missile.prototype.aiShouldCastSpell=function(e,t){const{actor:n,enemy:s}=e;if(s){const[e,r]=s.getXY(),[a,o]=n.getXY();if(p.Path.shortestDist(e,r,a,o)<=this.getRange()){return t(n,{target:s,src:n}),!0}}return!1},t.Spell.AreaBase=function(e,n){t.Spell.Ranged.call(this,e,n),this.getSelectionObject=function(e){return t.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=((e,t)=>C(e,t,this)),this.cast=function(e){const t={src:e.src,range:this.getRange(),spell:this};t.damageType=this.damageType,t.damage=this.getDamage();const n=new i.SpellArea;n.setArgs(t),e.src.add(n);const s=e.src.getName(),r=`Huge ${this.getName()} emanates from ${s}`;a.default.gameMsg({msg:r,cell:e.src.getCell()})}},a.default.extend2(t.Spell.AreaBase,t.Spell.Ranged),t.Spell.RingBase=function(e,n){t.SpellBase.call(this,e,n),t.SpellBase.call(this,e,n),this._dice.duration=c.Dice.create("10d10"),this._range=2,this._createdActor="Fire",this.cast=function(e){const t=E(this,e);t.callback=this.castCallback.bind(this);const n=new i.SpellSelf;n.setArgs(t),e.src.add(n)},this.getSelectionObject=function(e){return t.Spell.getSelectionObjectSelf(this,e)},this.castCallback=(()=>{const e=u.ObjectShell.getParser(),t=this._caster;h.Brain.getCellsAroundActor(t,this._range).forEach(t=>{if(t.isPassable()||t.hasActors()){const n=e.createActor(this._createdActor);_(n,t,this)}})}),this.aiShouldCastSpell=((e,t)=>C(e,t,this))},a.default.extend2(t.Spell.RingBase,t.SpellBase),t.Spell.MultiSpell=function(e,n){t.SpellBase.call(this,e,n),this._spells=[]},a.default.extend2(t.Spell.MultiSpell,t.SpellBase),t.Spell.MultiSpell.prototype.addSpell=function(e){this._spells.push(e)},t.Spell.MultiSpell.prototype.removeSpells=function(){this._spells=[]},t.Spell.MultiSpell.prototype.canCast=function(){return this._caster.get("SpellPower").getPP()>=this.getCastingPower()},t.Spell.MultiSpell.prototype.cast=function(e){this._spells.forEach(t=>{t.cast(e)})},t.Spell.MultiSpell.prototype.getCastingPower=function(){return this._spells.map(e=>e.getCastingPower()).reduce((e,t)=>e+t,0)},t.Spell.MultiSpell.prototype.getPower=function(){return this._spells.map(e=>e.getPower()).reduce((e,t)=>e+t,0)},t.Spell.MultiSpell.prototype.aiShouldCastSpell=function(e,t){let n=!0;return this._spells.forEach(s=>{n=n&&s.aiShouldCastSpell(e,t)}),n},t.Spell.MultiSpell.prototype.equals=function(e){if(!e._spells)return!1;if(e._spells.length!==this._spells.length)return!1;let t=!0;return this._spells.forEach((n,s)=>{(t=t&&n.equals(e._spells[s]))||console.log("Spell",n.getName()," caused error")}),t},t.Spell.MultiSpell.prototype.toJSON=function(){const e=t.SpellBase.prototype.toJSON.call(this);return e.spells=this._spells.map(e=>e.toJSON()),e},t.Spell.MultiSpell.prototype.setCaster=function(e){this._spells.forEach(t=>{t.setCaster(e)})},t.Spell.defineSpell=function(e,n){const s=class extends n{constructor(...t){super(e,0),this._init&&"function"==typeof this._init&&this._init(...t)}};return t.Spell[e]=s,s},t.Spell.undefineSpell=function(e){delete t.Spell[e]}},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(19),o=n(35),i=n(22),l=n(31);t.Builder={},t.Builder.addPathToMap=function(e,t){const n=[];for(let s=0;s<t.length;s++){const r=t[s];if(e.hasXY(r.x,r.y)){const t=e.getBaseElemXY(r.x,r.y).getType();t.match(/(chasm|water)/)?e.setBaseElemXY(r.x,r.y,a.ELEM.BRIDGE):/stone|highrock/.test(t)?e.setBaseElemXY(r.x,r.y,a.ELEM.PATH):e.setBaseElemXY(r.x,r.y,a.ELEM.ROAD),n.push(r)}}return n},t.Builder.splitLevel=function(e,t){const n=[],s=e.getMap().cols/t.nLevelsX,a=e.getMap().rows/t.nLevelsY,c=e.getActors().slice(),u=e.getItems().slice(),h=c.length>0||u.length>0;for(let e=0;e<t.nLevelsX;e++){const e=[];for(let n=0;n<t.nLevelsY;n++){let t=null;if(h)t=(new l.FactoryLevel).createLevel("empty",s,a);else{t=new i.Level;const e=o.CellMap.createWithoutCells(s,a);t.setMap(e)}e.push(t)}n.push(e)}const d=(e,t)=>{const r=Math.floor(e/s),o=Math.floor(t/a);return n[r][o]},p=e=>e%s,f=e=>e%a,m=e.getMap();for(let e=0;e<m.cols;e++)for(let t=0;t<m.rows;t++){const n=d(e,t),s=p(e),r=f(t);h?n.getMap().setBaseElemXY(s,r,m.getBaseElemXY(e,t)):n.getMap().moveCellUnsafe(s,r,m.getCell(e,t))}return c.forEach(t=>{const n=t.getX(),s=t.getY();if(e.removeActor(t)){const e=d(n,s),r=p(n),a=f(s);e.addActor(t,r,a)}else r.default.warn("Geometry","splitLevel",`removeActor failed on ${JSON.stringify(t)}`)}),u.forEach(t=>{const n=t.getX(),s=t.getY();e.removeItem(t,n,s);const r=d(n,s),a=p(n),o=f(s);r.addItem(t,a,o)}),e.getStairs().length>0&&r.default.warn("Geometry","splitLevel","Function does not move stairs correctly (yet)."),n}},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t,n){var s=n(198),r=n(147);e.exports=Object.keys||function(e){return s(e,r)}},function(e,t){t.f={}.propertyIsEnumerable},function(e,t){e.exports={}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Names={};const r=s(n(8)),a=n(9),o=n(412),i=a.Random.getRNG();t.Names.place={},t.Names.place.generic={branch:["Hand","Foot","Small","Large"],dungeon:["Crypt","Catacombs","Tombs","Dungeon","Cells","Cave","Grotto","Cavern","Lair","Labyrinth"],mountain:["Summit","Volcano","Tops","Peaks","Bluff","Highlands","Pinnacle","Rise","Needle","Hills","Slopes"],face:["Face","Buttress","Ridge","Shoulder","Crag","Crest","Brink","Cairn","Col","Pass","Crown","Scree","Watershed"],forest:["Grove","Wilds","Woodlands","Timberland","Forest","Covert","Woods","Thicket","Glade"],city:["Town","Village","Fort","City"],lake:["Basin","Cove","Reservoir","Depths","Gorge","Lagoon","Domain","Pond","Expanse","Lake","Shallows","Loch","Falls","Rapids"],quarter:["Market","Bazaar","Plaza","Row","Works","Side","Acre","Garden","Park","Temple","Necropolis","Cemetery","Library","Arcane","Royal","Slum","Living","Arena","Military","Barracks"],area:[]},t.Names.place.unique={city:{first:["Stag","Small","Mud","Ebon","Silk","Spirit","Basin","Shadow","Gold","Silver","Snow","Frost","Ice","Hound","Moon","Dire","Ever","Iron","Ruby","Star","Crystal","Glimmer","Winters","Raven","Pine","Ever","Never","Rune","Glace","Lumen","Confer","Flamen","Jotun","Troll","Winds","Oaken","Willow","Anvil","Ashen","Kosken","Storm"],second:["guard","point","fell","mire","shield","crest","yard","minster","swallow","grasp","cliff","cross","host","barrow","vein","view","home","gard","wall","heim","creek","gasp","mane","thorne","keep"]}},t.Names.place.unique.mountain={first:t.Names.place.unique.city.first,second:t.Names.place.generic.mountain.map(e=>" "+e.toLowerCase())},t.Names.place.unique.dungeon={first:t.Names.place.unique.city.first,second:t.Names.place.generic.dungeon.map(e=>" "+e.toLowerCase())},t.Names.actor={},t.Names.item={steal:{adjective:["emerald","exquisite","golden","silver","bronze","ruby","diamond"],substantive:["ring","amulet","plate","vase","goblet"],char:{ring:"=",amulet:"^",plate:"_",vase:"]",goblet:"]"}},gather:{adjective:[],substantive:[]}},t.Names.getItemToStealName=(()=>{const e=t.Names.item.steal,n=i.arrayGetRand(e.adjective),s=i.arrayGetRand(e.substantive);return n.capitalize()+" "+s}),t.Names.getItemToGather=(()=>{const e=t.Names.item.gather,n=i.arrayGetRand(e.adjective),s=i.arrayGetRand(e.substantive);return n.capitalize()+" "+s}),t.Names.getVillageType=(()=>i.arrayGetRand(["Village","Hamlet","Town","Township"])),t.Names.alreadyUsed=new Set([""]),t.Names.getUniqueName=(e=>{const n=t.Names.place.unique[e];if(n){let e="";for(;t.Names.alreadyUsed.has(e);){e=i.arrayGetRand(n.first)+i.arrayGetRand(n.second)}return e}return r.default.err("name-gen.js","Names.getUniqueName",`No unique names for type ${e}`),""}),t.Names.getGenericPlaceName=(e=>{const n=t.Names.place.generic[e];return i.arrayGetRand(n)}),t.Names.getActorName=(()=>o.ActorNames.getName());const l=["old","ancient","dusty","worn","well-preserved","heavy","light","thick","thin"],c=["rune-covered","worm-ridden","leather","hard-cover","metal-plated","decorated","exquisite","engraved","plain","ordinary","aesthetic","ornamental","skeletal"],u=["tome","book","tract","codex","opus","handbook","volume","treatise","grimoire","rariora","compendium","epitome","manuscript"];t.Names.getBookName=(()=>{let e="";for(;t.Names.alreadyUsed.has(e);){let t=i.arrayGetRand(l);e=`${t=t.capitalize()} ${i.arrayGetRand(c)} ${i.arrayGetRand(u)}`}return e})},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(17)("bitn:OW"),a=s(n(8)),o=n(35),i=n(12),l=n(116),c=n(9),u=n(221),h=n(161),d=n(15),p=c.Random.getRNG;class f{constructor(){this._baseMap=[],this._explored={},this._subLevels=[],this._hWalls=[],this._vWalls=[],this._features={},this._featureData={},this._featuresByXY={},this._biomeMap={},this._terrMap=null}getSizeXY(){return[this.getSizeX(),this.getSizeY()]}getCenterX(){return Math.round(this.getSizeX()/2)}getCenterY(){return Math.round(this.getSizeY()/2)}isWallTile(e,t){const n=this._baseMap[e][t];return l.OW.ALL_WALLS_LUT.hasOwnProperty(n)}numTiles(e){let t=0;const[n,s]=this.getSizeXY();for(let r=0;r<n;r++)for(let n=0;n<s;n++)this._baseMap[r][n]===e&&++t;return t}numWallTiles(){let e=0;const[t,n]=this.getSizeXY();for(let s=0;s<t;s++)for(let t=0;t<n;t++)this.isWallTile(s,t)&&++e;return e}getBiomeMap(){return this._biomeMap}getBiome(e,t){const n=e+","+t;return this._biomeMap.hasOwnProperty(n)?this._biomeMap[e+","+t]:(a.default.err("OWMap","getBiome",`No biome set for x,y ${e},${t}`),"")}getMap(){return this._baseMap}getCell(e){return this._baseMap[e[0]][e[1]]}numHWalls(){return this._hWalls.length}numVWalls(){return this._vWalls.length}getHWalls(){return this._hWalls}getVWalls(){return this._vWalls}setMap(e){const t=e.length;this._baseMap=e;for(let e=0;e<t;e++)this._subLevels[e]=[]}setTerrMap(e){this._terrMap=e}getTerrMap(){return this._terrMap}addBiome(e,t,n){const s=e+","+t;this._biomeMap[s]=n}addVWall(e){e.type="vertical",this._vWalls.push(e)}addHWall(e){e.type="horizontal",this._hWalls.push(e)}addFeature(e,t){const n=e[0]+","+e[1];this._features.hasOwnProperty(t)||(this._features[t]=[]),this._featuresByXY.hasOwnProperty(n)||(this._featuresByXY[n]=[]),this._features[t].push(e),this._featuresByXY[n].push(t)}addFeatureData(e,t){const n=e[0]+","+e[1];this._featureData.hasOwnProperty(n)||(this._featureData[n]=[]),this._featureData[n].push(t)}getFeaturesByType(e){return this._features.hasOwnProperty(e)?this._features[e]:[]}getFeaturesByXY(e){const t=e[0]+","+e[1];return this._featuresByXY[t]}addSubLevel(e,t){this._subLevels[e[0]][e[1]]=t}getSubLevel(e){return this._subLevels[e[0]][e[1]]}clearSubLevels(){this._subLevels=[]}getSubLevelsWithFeature(e){return this.getFeaturesByType(e).map(e=>this.getSubLevel(e))}getAreaXY(){return this.getSizeX()*this.getSizeY()}getSizeX(){return this._baseMap.length}getSizeY(){return this._baseMap[0].length>0?this._baseMap[0].length:(a.default.warn("OWMap","getSizeY","Y-size requested but returning zero value"),0)}setExplored(e){this._explored[e[0]+","+e[1]]=!0}isExplored(e){return this._explored[e[0]+","+e[1]]}toJSON(){const e={baseMap:this._baseMap,biomeMap:this._biomeMap,features:this._features,featuresByXY:this._featuresByXY,vWalls:this._vWalls,hWalls:this._hWalls,explored:this._explored};return this.coordMap&&(e.coordMap=this.coordMap.toJSON()),this._terrMap&&(e.terrMap=this._terrMap.toJSON()),e}getOWMap(e=!1){const t=JSON.parse(JSON.stringify(this._baseMap)),n=t[0].length,s=t.length;if(Object.keys(this._features).forEach(e=>{this._features[e].forEach(n=>{t[n[0]][n[1]]=e})}),e)for(let e=0;e<s;e++)for(let s=0;s<n;s++)this._explored[e+","+s]||(t[e][s]="?");return t}getCellList(){const e=this.getOWMap(),t=e[0].length,n=e.length,s=new o.CellMap(n,t);for(let r=0;r<n;r++)for(let n=0;n<t;n++){const t=new d.ElementMarker(e[r][n]);l.OW.classNames[e[r][n]]?t.setClassName(l.OW.classNames[e[r][n]]):t.setClassName(l.OW.classNames.default),s.setProp(r,n,a.default.TYPE_ELEM,t)}return s}mapToString(e=!1){const t=this.getOWMap(e),n=t[0].length,s=t.length,r=[];for(let e=0;e<n;e++){const n=[];for(let r=0;r<s;r++)n.push(t[r][e]);r.push(n)}return r.map(e=>e.join(""))}biomeMapToString(){const e=this.getSizeX()-1,t=this.getSizeY()-1,n=Object.keys(l.OW.biomeTypeMap),s={},r=n.map((e,t)=>(s[e]=""+t,`${t} - ${e}`));let a="";for(let n=0;n<t;n++){let t="";for(let r=0;r<e;r++){const e=r+","+n;t+=","+s[this._biomeMap[e]]}a+=t+="\n"}return a+="\n"+r.join("\n")}}function m(e,t,n,s=!1){const r=n.length;let a=!1;const o={y:t,x:[1]};n[0][t]=l.OW.TT_W,s||(n[r-1][t]=l.OW.TT_E);for(let e=1;e<r-1;e++)a||(n[e][t]!==l.OW.EMPTY?s?(a=!0,n[e][t]=l.OW.TT_E,o.x.push(e)):n[e][t]=l.OW.XX:n[e][t]=p().getWeighted(l.OW.LINE_WE_WEIGHT));a||(s&&(n[r-1][t]=l.OW.TT_E),o.x.push(r-1)),e.addHWall(o)}function g(e,t,n,s=!1){const r=n[0].length;let a=!1;const o={x:t,y:[1]};n[t][0]=l.OW.TT_N,s||(n[t][r-1]=l.OW.TT_S);for(let e=1;e<r-1;e++)a||(n[t][e]!==l.OW.EMPTY?s?(a=!0,n[t][e]=l.OW.TT_S,o.y.push(e)):n[t][e]=l.OW.XX:n[t][e]=p().getWeighted(l.OW.LINE_NS_WEIGHT));a||(s&&(n[t][r-1]=l.OW.TT_S),o.y.push(r-1)),e.addVWall(o)}function y(e,t,n){if(n[e][t]===l.OW.EMPTY){const s=function(e,t,n){const s=n[0].length,r=n.length,a=[];if(t>0){const s=l.OW.CAN_CONNECT[n[e][t-1]].N;a.push([n[e][t-1],s])}if(t<s-1){const s=l.OW.CAN_CONNECT[n[e][t+1]].S;a.push([n[e][t+1],s])}if(e<r-1){const s=l.OW.CAN_CONNECT[n[e+1][t]].E;a.push([n[e+1][t],s])}if(e>0){const s=l.OW.CAN_CONNECT[n[e-1][t]].W;a.push([n[e-1][t],s])}return a}(e,t,n).filter(e=>e[0]!==l.OW.EMPTY&&e[0]!==l.OW.TERM);1===s.length&&s[0][1].length>0?n[e][t]=p().arrayGetRand(s[0][1]):n[e][t]=l.OW.TERM}}function v(e,t){const n=e.getSizeX()*e.getSizeY(),s=e.numTiles(l.OW.TERM),r=e.numWallTiles(),o=t.nDungeonsSouth||Math.floor(r/12),c=t.nDungeonsCenter||Math.floor(r/24),h=t.nDungeonsNorth||Math.floor(r/24),d=t.nMountainsNorth||Math.floor(n/40),p=t.nMountainsMiddle||Math.floor(n/60),f=t.nMountainsSouth||Math.floor(n/80);!function(e,t,n,s){const r=e.getMap(),o=r[0].length,i=r.length;let c=M(t,n,i,o),u=1e3;for(;r[c[0]][c[1]]!==l.OW.TERM;){if(c=M(t,n,i,o),0===u){a.default.warn("OverWorld","addFeature","No empty cell to add "+s+", "+t);break}--u}e.addFeature(c,s)}(e,"NE",.5,l.OW.BTOWER);const m=e.numHWalls();if(m>1&&(_(e,e._hWalls[1],l.OW.WCAPITAL),_(e,e._hWalls[0],l.OW.WTOWER)),m>2)for(let t=2;t<m;t++)_(e,e._hWalls[t],l.OW.VTUNNEL);const g=e.numVWalls();g>0&&(_(e,e._vWalls[g-1],l.OW.BTOWER),_(e,e._vWalls[g-1],l.OW.BCAPITAL));const y={y:{start:["wall",0],end:["wall",1]}},v={y:{start:"N",end:"wall"}},T={y:{start:["wall",1],end:"S"}};b(e,v,l.OW.BIOME.ALPINE),b(e,{x:{start:["wall",0],end:"E"}},l.OW.BIOME.ARCTIC),b(e,y,l.OW.BIOME.TUNDRA),b(e,T,l.OW.BIOME.TAIGA),E(e,o,T),E(e,c,y),E(e,h,v);const O=t.nCitySouth||Math.floor(.5*s/80),A=t.nCityCenter||Math.floor(.2*s/100),N=t.nCityNorth||Math.floor(.2*s/80);S(e,f,T),S(e,p,y),S(e,d,v),t.createTerritory?(function(e,t){const{playerRace:n,playerX:s,playerY:r}=t,a=u.TerritoryMap.create(e,n,[s,r]);e.setTerrMap(a)}(e,t),function(e){const t=e.getTerrMap(),n=t.getMap();a.default.forEach2D(n,(n,s)=>{const r=[n,s],o=t.getRival(r);if(t.hasRival(r))if(a.default.isSuccess(.13)){w(e,r);const t=o+"_city";e.addFeatureData(r,{type:t})}else{const t=i.Geometry.getBoxAround(n,s,1);let r=!1;t.forEach(t=>{if(!r&&e.isWallTile(t[0],t[1])&&a.default.isSuccess(.09)){e.addFeature(t,l.OW.MFORT);const n=o+"_fort";e.addFeatureData(t,{type:n}),r=!0}})}})}(e)):(C(e,O,T),C(e,A,y),C(e,N,v))}function _(e,t,n){const s=e.getMap();let a=null;if("horizontal"===t.type){const e=t.x[0],n=t.x[t.x.length-1];a=O(s,A(e,t.y,n,t.y),l.OW.LL_WE)}if("vertical"===t.type){const e=t.y[0],n=t.y[t.y.length-1];a=O(s,A(t.x,e,t.x,n),l.OW.LL_NS)}r(`Placed feature ${n} to ${a}`),e.addFeature(a,n)}function b(e,t,n){const s=N(e,t);for(let t=s.ulx;t<=s.lrx;t++)for(let r=s.uly;r<=s.lry;r++)e.addBiome(t,r,n)}function E(e,t,n){const s=N(e,n);for(let n=0;n<t;n++){const t=O(e.getMap(),s,l.OW.ALL_WALLS);e.addFeature(t,l.OW.WDUNGEON)}}function S(e,t,n){const s=N(e,n);for(let n=0;n<t;n++){const t=O(e.getMap(),s,[l.OW.TERM]);e.addFeature(t,l.OW.MOUNTAIN)}}function C(e,t,n){const s=N(e,n);for(let n=0;n<t;n++){const t=O(e.getMap(),s,[l.OW.TERM]);w(e,t)}}function w(e,t){a.default.isSuccess(l.OW.PROB_BVILLAGE)?e.addFeature(t,l.OW.BVILLAGE):e.addFeature(t,l.OW.WVILLAGE)}function T(e,t){let n=t;return"string"==typeof t&&(n=[t]),n.indexOf(l.OW.CELL_ANY)>=0||n.indexOf(e)>=0}function O(e,t,n){const{ulx:s,uly:r,lrx:o,lry:i}=t;let l=s===o?s:p().getUniformInt(s,o),c=i===r?i:p().getUniformInt(r,i),u=100*(o-s+1)*(i-r+1),h=T(e[l][c],n);for(;!h;){if(l=s===o?s:p().getUniformInt(s,o),c=i===r?i:p().getUniformInt(r,i),h=T(e[l][c],n),0===u){const e=`(${s},${i}) -> (${o},${r})`;a.default.warn("OverWorld","findCellRandXYInBox",`No cells of type ${n} in ${e}`);break}--u}return[l,c]}function M(e,t,n,s){let r=0,a=0,o=0,i=0;return e.match(/N/)&&(i=0,a=Math.floor(.25*t*s)),e.match(/S/)&&(a=s-1,i=.75*s,i=Math.floor(i+(1-t)*(a-i))),e.match(/E/)&&(o=n-1,r=.75*n,r=Math.floor(r+(1-t)*(o-r))),e.match(/W/)&&(r=0,o=Math.floor(.25*t*n)),[p().getUniformInt(r,o),p().getUniformInt(i,a)]}function A(e,t,n,s){return a.default.isNullOrUndef([e,t,n,s])&&a.default.err("overworld.map.js","bBox",`bBox coord(s) undef/null: ${e},${t},${n},${s}`),{isBox:!0,ulx:e,lry:t,lrx:n,uly:s}}function N(e,t){if(t.isBox)return t;let n=0,s=e.getSizeX()-1,r=0,a=e.getSizeY()-1;if(t.x){const r=t.x.start,a=t.x.end;if("W"===r)n=0;else if("wall"===r){const t=e.getVWalls();t.length>0&&(n=t[0].x)}else if(Array.isArray(r)&&"wall"===r[0]){const t=e.getVWalls();t.length>r[1]&&(n=t[r[1]].x)}if("E"===a)s=e.getSizeX()-1;else if("wall"===a){const t=e.getVWalls();t.length>0&&(s=t[0].x)}else if(Array.isArray(a)&&"wall"===a[0]){const t=e.getVWalls();t.length>a[1]&&(s=t[a[1]].x)}}if(t.y){const n=t.y.start,s=t.y.end;if("N"===n)r=0;else if("wall"===n){const t=e.getHWalls();t.length>0&&(r=t[0].y)}else if(Array.isArray(n)&&"wall"===n[0]){const t=e.getHWalls();t.length>n[1]&&(r=t[n[1]].y)}if("S"===s)a=e.getSizeY()-1;else if("wall"===s){const t=e.getHWalls();t.length>0&&(a=t[0].y)}else if(Array.isArray(s)&&"wall"===s[0]){const t=e.getHWalls();t.length>s[1]&&(a=t[s[1]].y)}}return{ulx:n,lrx:s,uly:r,lry:a}}t.OWMap=f,f.createOverWorld=function(e={}){const t=void 0===e.yFirst||e.yFirst,n=void 0===e.topToBottom||e.topToBottom,s=void 0!==e.printResult&&e.printResult,r=e.owTilesX||40,o=e.owTilesY||20,i=new f,c=function(e,t){const n=[];for(let s=0;s<e;s++){n[s]=[];for(let e=0;e<t;e++)n[s][e]=l.OW.EMPTY}return n}(r,o);return function(e){const t=e[0].length,n=e.length;e[0][0]=l.OW.CC_NW,e[0][t-1]=l.OW.CC_SW,e[n-1][t-1]=l.OW.CC_SE,e[n-1][0]=l.OW.CC_NE;for(let t=1;t<n-1;t++)e[t][0]=p().arrayGetRand(l.OW.N_BORDER);for(let s=1;s<n-1;s++)e[s][t-1]=p().arrayGetRand(l.OW.S_BORDER);for(let s=1;s<t-1;s++)e[n-1][s]=p().arrayGetRand(l.OW.E_BORDER);for(let n=1;n<t-1;n++)e[0][n]=p().arrayGetRand(l.OW.W_BORDER)}(c),function(e,t,n){const s=t[0].length,r=t.length;let a=void 0!==n.nHWalls?n.nHWalls:[.3,.5],o=void 0!==n.nVWalls?n.nVWalls:[];const i=void 0!==n.stopOnWall&&n.stopOnWall;if(Number.isInteger(n.nHWalls)){a=[];for(let e=0;e<n.nHWalls;e++){const e=p().getUniformInt(1,19);a.push(.05*e)}a=a.sort()}if(Number.isInteger(n.nVWalls)){o=[];for(let e=0;e<n.nVWalls;e++){const e=p().getUniformInt(1,19);o.push(.05*e)}o=a.sort()}for(let n=0;n<a.length;n++){let r=i;"random"===i&&(r=p().getUniform()>=.5),m(e,Math.floor(s*a[n]),t,r)}for(let n=0;n<o.length;n++){let s=i;"random"===i&&(s=p().getUniform()>=.5),g(e,Math.floor(r*o[n]),t,s)}}(i,c,e),function(e,t,n){const s=t[0].length,r=t.length,a=n.innerWallRatio||.05,o=Math.floor(r*s*a);for(let e=0;e<o;e++){const e=p().getUniformInt(2,r-2),n=p().getUniformInt(2,s-2);t[e][n]===l.OW.EMPTY&&(t[e][n]=p().arrayGetRand(l.OW.ALL_WALLS))}}(0,c,e),n?function(e,t=!0){const n=e[0].length,s=e.length;if(t)for(let t=0;t<s;t++)for(let s=0;s<n;s++)y(t,s,e);else for(let t=0;t<n;t++)for(let n=0;n<s;n++)y(n,t,e)}(c,t):function(e,t=!0){const n=e[0].length,s=e.length;if(t)for(let t=0;t<s;t++)for(let s=n-1;s>=0;s--)y(t,s,e);else for(let t=n-1;t>=0;t--)for(let n=0;n<s;n++)y(n,t,e)}(c,t),e.printResult&&a.default.printMap(c),i.setMap(c),v(i,e),s&&a.default.log("\n",i.mapToString().join("\n")),i},f.fromJSON=function(e){const t=new f;return t.setMap(e.baseMap),t._features=e.features,t._featuresByXY=e.featuresByXY,t._vWalls=e.vWalls,t._hWalls=e.hWalls,t._biomeMap=e.biomeMap,t._explored=e.explored,e.terrMap&&(t._terrMap=h.Territory.fromJSON(e.terrMap)),t}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(96),o=n(222),i=n(21),l=n(90),c=n(26),u=n(97),h=n(116),d=n(19),p=n(9),f=n(31),m=n(12),g=n(17)("bitn:overworld");t.OverWorld={};const y=/(capital|city|abandoned fort|fort|village)/,v=/(dwarven city|abandoned fort|capital)/,_=d.ELEM.WALL_MOUNT.getType(),b=111,E=1,S=1,C=!1;let w=!1;const T=p.Random.getRNG;t.OverWorld.TILE_SIZE_X=100,t.OverWorld.TILE_SIZE_Y=100;const{TILE_SIZE_X:O,TILE_SIZE_Y:M}=t.OverWorld;class A{constructor(e){this.type=e,this.coord=[]}addWallCoord(e){this.coord.push(e)}getCoordAt(e){return this.coord[e]}getWallPos(){return"vertical"===this.type?this.coord[0][0][0]:"horizontal"===this.type?this.coord[0][0][1]:h.OW.ILLEGAL_POS}getWallStart(){return"vertical"===this.type?this.coord[0][0][1]:"horizontal"===this.type?this.coord[0][0][0]:h.OW.ILLEGAL_POS}getWallEnd(){const e=this.coord.length-1;return"vertical"===this.type?this.coord[e][0][1]:"horizontal"===this.type?this.coord[e][0][0]:-1}toString(){let e=`type: ${this.type} `;return e+=`Length: ${this.coord.length}\n`,e+=`Start: ${this.getWallStart()} End: ${this.getWallEnd()}\n`,e+=`Tiles: ${JSON.stringify(this.coord)}`}}t.OWWall=A;class N{constructor(e,t){this.type=e,this.coord=t,this.cellsAround=null,Array.isArray(t)?0===t.length?r.default.err("OWSubFeature","new","coord len is 0."):Array.isArray(t[0])||r.default.err("OWSubFeature","new","Each coord must be [x, y] pair."):r.default.err("OWSubFeature","new","coord must be an array.")}getLastCoord(){return this.coord.length>0?this.coord[this.coord.length-1]:[-1,-1]}}t.OWSubFeature=N;class P{constructor(e){this._level=e,this._hWalls=[],this._vWalls=[],this._subX=e.getMap().rows,this._subY=e.getMap().cols,this._features={},this._featuresByXY={}}getFeatures(){return this._features}getSubX(){return this._subX}getSubY(){return this._subY}addWall(e){"vertical"===e.type?this._vWalls.push(e):"horizontal"===e.type&&this._hWalls.push(e)}getWall(){const e=this._hWalls.length,t=this._vWalls.length;return 0===e&&0===t?null:0===e?this._vWalls[0]:0===t?this._hWalls[0]:(r.default.warn("OWSubLevel","getWall",`Return hor wall. Too many walls: vLen: ${t}, hLen: ${e}`),this._hWalls[0])}addFeature(e){const t=e.type;this._features.hasOwnProperty(t)||(this._features[t]=[]),this._features[t].push(e),e.coord.forEach(e=>{const n=e[0]+","+e[1];this._featuresByXY[n]=t})}getFeaturesByType(e){return this._features.hasOwnProperty(e)?this._features[e]:[]}}t.OWSubLevel=P;class x{constructor(e={}){this.worldCols=e.worldCols||0,this.worldRows=e.worldRows||0,this.nTilesX=e.nTilesX||0,this.nTilesY=e.nTilesY||0,this.xMap=e.xMap||0,this.yMap=e.yMap||0}setXYMap(e,t){this.xMap=e,this.yMap=t}getAreaLevelCols(){return this.worldCols/this.nTilesX}getAreaLevelRows(){return this.worldRows/this.nTilesY}toOwLevelXY(e,t){return[e[0]*this.xMap+t[0],e[1]*this.xMap+t[1]]}toOWTileXY(e,t){const n=this.getOWTileBboxFromAreaTileXY(e[0],e[1]);return[n.ulx+Math.floor(t[0]/this.xMap),n.uly+Math.floor(t[1]/this.yMap)]}getAreaXYFromOWTileXY(e,t){return[Math.floor(e/this.xMap),Math.floor(t/this.yMap)]}getOWTileBboxFromAreaTileXY(e,t){return Number.isInteger(e)&&Number.isInteger(t)?{ulx:e*O/this.xMap,uly:t*M/this.yMap,lrx:(e+1)*O/this.xMap-1,lry:(t+1)*M/this.yMap-1}:(r.default.err("OverWorld.CoordMap","getOWTileBboxFromAreaTileXY",`Args (x,y) must be ints. Got ${e}, ${t}`),null)}toJSON(){return{worldCols:this.worldCols,worldRows:this.worldRows,nTilesX:this.nTilesX,nTilesY:this.nTilesY,xMap:this.xMap,yMap:this.yMap}}}function I(e,t,n,s,a){const o=e.getMap()[t][n],i=e.getBiome(t,n),l=s,u=a,p=(new f.FactoryLevel).createLevel(r.default.LEVEL_EMPTY,l,u);!function(e,t){const n=t.getMap().cols,s=t.getMap().rows,r=T().getUniform();if("arctic"===e)c.MapGenerator.addRandomSnow(t.getMap(),1);else if("alpine"===e){if(c.MapGenerator.addRandomSnow(t.getMap(),.5),r<.1){const e=new c.MapGenerator;e.setGen("lakes",n,s);const r={ratio:.15,freeOnly:!0};e.addLakesToMap(t.getMap(),r)}}else if("tundra"===e){if(c.MapGenerator.addRandomSnow(t.getMap(),.1),r<.2){const e=new c.MapGenerator;e.setGen("lakes",n,s);const r={ratio:.3,freeOnly:!0};e.addLakesToMap(t.getMap(),r)}}else if("taiga"===e||"forest"===e){const e={ratio:.6,freeOnly:!0},a=new c.MapGenerator;if(a.setGen("forest",n,s),a.addForestToMap(t.getMap(),e),r<.3){a.setGen("lakes",n,s);const e={ratio:.4,freeOnly:!0};a.addLakesToMap(t.getMap(),e)}}else if("grassland"===e){const e={ratio:.1},r=new c.MapGenerator;r.setGen("forest",n,s),r.addForestToMap(t.getMap(),e)}}(i,p);const y=new P(p);return e.addSubLevel([t,n],y),function(e,t,n){const s=n.getMap(),r=h.OW.N_HAS_CONN.findIndex(t=>t===e)>=0,a=h.OW.S_HAS_CONN.findIndex(t=>t===e)>=0,o=h.OW.E_HAS_CONN.findIndex(t=>t===e)>=0,i=h.OW.W_HAS_CONN.findIndex(t=>t===e)>=0,l=s.cols,c=s.rows,u=Math.floor(l/2),p=Math.floor(c/2);let f=null,m=-1,g=-1;r&&a?(m=0,g=c-1):r?(m=0,g=p-1):a&&(m=p,g=c-1);let y=k(g+1,5,3,l,3);if(r||a){const e=new A("vertical");for(let t=m;t<=g;t++){f=y[t-m];const n=[];1===f&&(f=5);for(let e=u-(f-1);e<=u+(f-1);e++)s.setBaseElemXY(e,t,d.ELEM.WALL_MOUNT),n.push([e,t]);e.addWallCoord(n)}t.addWall(e)}let v=-1,_=-1;o&&i?(v=0,_=l-1):o?(v=u,_=l-1):i&&(v=0,_=u-1);if(y=k(_+1,5,3,l,3),o||i){const e=new A("horizontal");for(let t=v;t<=_;t++){f=y[t-v];const n=[];1===f&&(f=5);for(let e=p-(f-1);e<=p+(f-1);e++)s.setBaseElemXY(t,e,d.ELEM.WALL_MOUNT),n.push([t,e]);e.addWallCoord(n)}t.addWall(e)}}(o,y,p),function(e,t,n,s){const a=[t,n],o=e.getSubLevel(a),i=e.getFeaturesByXY(a),l=e.getCell(a);if(!i)return;let c=0;i.forEach(e=>{e===h.OW.WCAPITAL?R(e,o,s):function(e,t){return!(e!==h.OW.LL_WE&&e!==h.OW.LL_NS||t!==h.OW.BTOWER&&t!==h.OW.WTOWER)}(l,e)?R(e,o,s):e===h.OW.BTOWER||e===h.OW.WTOWER?function(e,t,n){let s=!1;const r=n.getMap().getFree().map(e=>e.getXY());let a=[],o=b;for(;9!==a.length&&(m.Geometry.getFreeArea(r,3,3,a)&&(s=!0),a.length<9&&(g("addTowerToSubLevel. Too few coords. Retrying."),s=!1,a=[]),!(--o<=0)););const i=e===h.OW.BTOWER?"blacktower":"whitetower";if(s){g("addTowerToSubLevel feat placed with "+JSON.stringify(a)),n.getMap().setBaseElems(a,d.ELEM.FORT);const s=new N(i,a);s.alignment=B(e),t.addFeature(s)}}(e,o,s):e===h.OW.WDUNGEON?function(e,t){const n=F(t);if(n&&n.length>0){const t=new N("dungeon",n);e.addFeature(t)}}(o,s):e===h.OW.WVILLAGE?function(e,t,n){const s=n.getMap().getFreeNotOnEdge();if(s.length>0){const r=s.map(e=>e.getXY()),a=T().arrayGetRand(r),o=new N("village",[a]);o.alignment=B(e);const[i,l]=a;G(n,o,i,l),t.addFeature(o)}else r.default.err("overworld.js","addVillageToSubLevel","No free cells found in the level.")}(e,o,s):e===h.OW.MOUNTAIN?function(e,t){let n=!1;const s=t.getMap().getFreeNotOnEdge().map(e=>[e.getX(),e.getY()]);if(0===s.length)return;let r=[],a=10*b;for(;!n;){const e=T().arrayGetRand(s);if(r=[e],n=!0,--a<=0)break}if(n){const t=new N("mountain",r);e.addFeature(t)}}(o,s):e===h.OW.VTUNNEL?function(e,t){const n=t.getMap(),s=n.cols,r=T().getUniformInt(0,s-1);for(let e=0;e<n.rows;e++)n.setBaseElemXY(r,e,d.ELEM.FLOOR)}(0,s):e===h.OW.MFORT?function(e,t){const n=F(t,!1);if(n&&n.length>0){const s=new N("fort",n),[r,a]=n[0];G(t,s,r,a),e.addFeature(s)}}(o,s):(g("addSubLevelFeat Skipped: "+`Base: ${l}, ${e}`),++c)}),c>0&&g(`Skipped ${c} features in addSubLevelFeatures`)}(e,t,n,p),p}function D(e,t,n){let s=Math.floor(T().getNormal(e,t));return s>n/2?s=n/2-1:s<1&&(s=1),s}function k(e,t,n,s,r){const a=[];for(let r=0;r<e;r++)a.push(D(t,n,s));const o=[];for(let e=0;e<r;e++)o.push(a[e]);for(let t=r;t<e-r;t++){const e=L(a,t,r);o.push(e)}for(let t=e-r;t<e;t++)o.length<a.length&&o.push(a[t]);return o}function L(e,t,n){const s=2*n+1;let r=0;for(let s=t-n;s<=t+n;s++)r+=e[s];return Math.floor(r/s)}function R(e,t,n){const s=t.getWall(),a=s.getWallStart(),o=s.getWallEnd(),i=T().getUniformInt(a,o),l=s.getCoordAt(i);let c=null;switch(e){case h.OW.WTOWER:c="dwarven city";break;case h.OW.BTOWER:c="abandoned fort";break;case h.OW.WCAPITAL:c="capital";break;case h.OW.BCAPITAL:c="dark city";break;default:r.default.err("overworld.js","addMountainFortToSubLevel",`Type ${e} not supported`)}n.getMap().setBaseElems(l,d.ELEM.FORT);const u=new N(c,l);u.alignment=B(e),t.addFeature(u)}function B(e){switch(e){case h.OW.BCAPITAL:case h.OW.BTOWER:case h.OW.BVILLAGE:return r.default.ALIGN_EVIL;case h.OW.WCAPITAL:case h.OW.WTOWER:case h.OW.WVILLAGE:return r.default.ALIGN_GOOD;default:return r.default.ALIGN_NEUTRAL}}function G(e,t,n,s){const r=e.getMap();t.cellsAround=m.Geometry.getCellsAround(r,r.getCell(n,s))}function F(e,t=!0){let n=!1;const s=e.getMap();let a=s.getFree().map(e=>e.getXY());if(!t){const{cols:e,rows:t}=s;a=a.filter(n=>0!==n[0]&&n[0]!==e-1&&0!==n[1]&&n[1]!==t-1)}if(0===a.length)return null;let o=[],i=10*b;for(;!n;){const e=T().arrayGetRand(a);let l=[];try{l=m.Geometry.getBoxAround(e[0],e[1],1)}catch(e){r.default.diag(e),r.default.diag(a),s.debugPrintInASCII()}if(!t){const{cols:e,rows:t}=s;l=l.filter(n=>0!==n[0]&&n[0]!==e-1&&0!==n[1]&&n[1]!==t-1)}if(l.forEach(e=>{if(!n&&s.hasXY(e[0],e[1])){s.getBaseElemXY(e[0],e[1]).getType()===_&&(o=[e],n=!0,s.setBaseElemXY(e[0],e[1],d.ELEM.FLOOR))}}),--i<=0)break}return o}function W(e,t,n){const{x:s,y:a}=n,o=Math.abs(e-s),i=Math.abs(t-a);n.maxDanger=r.default.getMaxDanger(o,i),n.maxValue=r.default.getMaxValue(o,i),T().getUniform()<=r.default.EPIC_PROB&&(n.isEpic=!0,n.maxDanger*=2,n.maxValue*=3)}function Y(e,t,n){if(Number.isInteger(e)){const s=e+t*n;return s>=O&&console.warn(`WARNING mapX: ${s}, ${e}, ${t}, ${n}`),s}return r.default.err("overworld.js","mapX",`x must be an integer. Got: ${e}`),null}function j(e,t,n){return Number.isInteger(e)?e+t*n:(r.default.err("overworld.js","mapY",`y must be an integer. Got: ${e}`),null)}function X(e,t,n){const s={name:"Blashyrkh",nQuarters:1,quarter:[{name:"Capital cave",nLevels:1}],owX:t.x,owY:t.y,presetLevels:{"Blashyrkh.Capital cave":[{nLevel:0,level:{stub:!0,new:"Capital",args:[200,500,{}]}}]}};V(e,t,s);const r={name:"Capital cave",levelX:s.levelX,levelY:s.levelY,nLevel:0,stairs:{getStairs:1}};s.connectToAreaXY[0].stairs={getStairs:0},s.connectToAreaXY.push(r),n.nCities+=1,n.city.push(s)}function U(e,t,n){const s={stub:!0,new:"DwarvenCity",args:[300,250,{}]},r={name:"Dwarven City",nQuarters:1,quarter:[{name:"Fort main level",nLevels:1}],owX:t.x,owY:t.y};r.presetLevels={"Dwarven City.Fort main level":[{nLevel:0,level:s}]},V(e,t,r);const a={name:"Fort main level",levelX:r.levelX,levelY:r.levelY,nLevel:0,stairs:{getStairs:1}};r.connectToAreaXY[0].stairs={getStairs:0},r.connectToAreaXY.push(a),n.nCities+=1,n.city.push(r)}function $(e,t,n){const s={stub:!0,new:"AbandonedFort",args:[500,200,{}]},r={name:"Abandoned fort",nQuarters:1,quarter:[{name:"Fort ground level",nLevels:1}],owX:t.x,owY:t.y};r.presetLevels={"Abandoned fort.Fort ground level":[{nLevel:0,level:s}]},V(e,t,r,!1);const a={name:"Fort ground level",levelX:r.levelX,levelY:r.levelY,nLevel:0,stairs:{getStairs:0}};r.connectToAreaXY[0].stairs={getStairs:1},r.connectToAreaXY.push(a),n.nCities+=1,n.city.push(r)}function K(e,t,n){e.coord;const s=a.Names.getUniqueName("city"),i=o.LevelGen.getCityConf(s,e);i.owX=t.x,i.owY=t.y,i.groupType=e.type,V(e,t,i),i.alignment=e.alignment||T().arrayGetRand(r.default.ALIGNMENTS),e.cellsAround&&(i.constraint||(i.constraint={}),i.constraint.cellsAround=e.cellsAround),n.nCities+=1,n.city.push(i)}function V(e,t,n,s=!0){const{slX:r,slY:a,aX:o,aY:i,subX:l,subY:c}=t,u=e.coord,h=u.length-1;let d=Y(u[h][0],r,l),p=j(u[h][1],a,c);if(s||(d=Y(u[0][0],r,l)-1,p=j(u[0][1],a,c)),p>=M&&(p-=1),v.test(e.type)){let e=Y(u[0][0],r,l),t=j(u[0][1],a,c);s||(e=Y(u[h][0],r,l)+1,t=j(u[h][1],a,c));const o=n.nQuarters-1;n.connectToAreaXY=[{name:n.quarter[o].name,levelX:e,levelY:t,nLevel:0}]}n.x=o,n.y=i,n.levelX=d,n.levelY=p,g(`Feat: ${e.type}, ${o},${i} : ${d},${p}`)}function H(e,t,n){const{slX:s,slY:a,aX:i,aY:l,subX:c,subY:u}=t,h=e.coord[7];if(r.default.isNullOrUndef([h])){const t="xy null/undef. feat: "+JSON.stringify(e);r.default.err("overworld.js","addBlackTowerConfToArea",t)}const d=Y(h[0],s,c),p=j(h[1],a,u),f=o.LevelGen.getDungeonConf("Elder raventhrone");C?(g("BlackTower: Placing to player position."),function(e,t){const[n,s]=q(t);Object.assign(e,{x:n,y:s,levelX:E,levelY:S}),console.log("BlackTower was added to tile",n,s),console.log("BlackTower was added to level X,Y",E,S)}(f,t)):Object.assign(f,{x:i,y:l,levelX:d,levelY:p}),g(`BlackTower: ${i},${l}, x,y ${d},${p}`),f.connectEdges=!0,f.branch[0].entranceLevel=0,f.branch[0].nLevels=5;const m=f.branch[0].nLevels-1;f.branch[0].createPresetLevels={new:"BlackTower",args:[180,90]},f.branch[0].create={actor:[{name:"Thabba, Son of Ice",nLevel:m},{name:"Zamoned, Son of Frost",nLevel:m}]},n.nDungeons+=1,n.dungeon.push(f)}function q(e){const{xMap:t,yMap:n,nSubLevelsX:s,nSubLevelsY:r}=e;return[Math.floor(s/t/2),r/n-1]}function J(e,t,n,s){const r=e*n,a=t*s;return[r,a+s-1,r+n-1,a]}function z(e){let[t,n]=e;return 0===t&&(t=1),t===O-1&&(t-=1),0===n&&(n=1),n===M-1&&(n-=1),[t,n]}t.CoordMap=x,t.OverWorld.CoordMap=x,t.OverWorld.createOverWorld=((e={})=>{const n=u.OWMap.createOverWorld(e);return t.OverWorld.createOverWorldLevel(n,e)}),t.OverWorld.createOverWorldLevel=((e,n)=>{const s=new x;return s.worldCols=n.worldX||400,s.worldRows=n.worldY||400,s.nTilesX=n.nTilesX||s.worldCols/O,s.nTilesY=n.nTilesY||s.worldRows/M,s.xMap=Math.floor(s.worldCols/e.getSizeX()),s.yMap=Math.floor(s.worldRows/e.getSizeY()),e.coordMap=s,w=n.addMainRoads||w,function(e,n){const{worldCols:s,worldRows:a,xMap:o,yMap:c,nTilesX:u,nTilesY:d}=n,p=e.getSizeX(),g=e.getSizeY(),y=(new f.FactoryLevel).createLevel(r.default.LEVEL_EMPTY,s,a);for(let t=0;t<p;t++)for(let n=0;n<g;n++){const s=I(e,t,n,o,c),r=t*o,a=n*c;m.Geometry.mergeLevels(y,s,r,a)}const v=t.OverWorld.createWorldConf(e,p,g,u,d);return function(e,t,n,s){const[a,o]=function(e,t){const n=Math.floor(e.getSizeX()/2-1)*O,s=t.worldRows-Math.floor(M/2);return[n,s]}(e,s),c=e.getFeaturesByType(h.OW.WCAPITAL)[0],u=e.getSubLevel(c).getFeaturesByType("capital")[0],d=u.getLastCoord(),[p,f]=s.toOwLevelXY(c,d);if(w){const e=i.Path.getWeightPathSegmented(t.getMap(),a,o,p,f,5);0===e.length&&r.default.err("overworld.js","addGlobalFeatures","No path from player to capital."),l.Builder.addPathToMap(t.getMap(),e)}const m=u.coord[0],g=s.toOwLevelXY(c,m),y=e.getFeaturesByType(h.OW.WTOWER)[0],v=e.getSubLevel(y).getFeaturesByType("dwarven city")[0].getLastCoord(),_=s.toOwLevelXY(y,v);if(w){const e=i.Path.getWeightPathSegmented(t.getMap(),g[0],g[1],_[0],_[1],5);l.Builder.addPathToMap(t.getMap(),e)}}(e,y,0,n),[y,v]}(e,s)}),t.OverWorld.createWorldConf=function(e,t,n,s,i){const l={name:"The North",nAreas:1,area:[{name:"The Northern Realm",maxX:s,maxY:i,biome:{},dungeon:[],mountain:[],city:[],nDungeons:0,nMountains:0,nCities:0}]},c=l.area[0];if(!t||!n){const e=`levels in X: ${t}, Y: ${n}`;r.default.err("OverWorld","createWorldConf",`Illegal num of sublevels: ${e}`)}const u=t/s,h=n/i;g(`nSubLevelsX: ${t}, nTilesX: ${s}`),g(`nSubLevelsY: ${n}, nTilesY: ${i}`),g(`MapX: ${u} levels to one tile`),g(`MapY: ${h} levels to one tile`),Number.isInteger(u)||r.default.err("OverWorld","createWorldConf",`xMap not int: ${u}, `+`sub X :${t}, nTilesX: ${s}`),Number.isInteger(h)||r.default.err("OverWorld","createWorldConf",`yMap not int: ${h}, `+`sub Y :${n}, nTilesY: ${i}`);for(let s=0;s<t;s++)for(let i=0;i<n;i++){const l=s%u,d=i%h,p=Math.floor(s/u),f=Math.floor(i/h),m=e.getSubLevel([s,i]),v=m.getSubX(),_=m.getSubY(),b={xMap:u,yMap:h,nSubLevelsX:t,nSubLevelsY:n,x:s,y:i,slX:l,slY:d,aX:p,aY:f,subLevel:m,subX:v,subY:_},[E,S]=q(b),C=m.getFeatures();Object.keys(C).forEach(e=>{C[e].forEach(e=>{if(e.coord||r.default.err("OverWorld","createWorldConf",`coord must exist. feat: ${JSON.stringify(e)}`),"capital"===e.type)X(e,b,c);else if("dwarven city"===e.type)U(e,b,c);else if("abandoned fort"===e.type)$(e,b,c);else if("dark city"===e.type)K(e,b,c);else if(y.test(e.type))K(e,b,c);else if("dungeon"===e.type){const t=e.coord;let n=Y(t[0][0],l,v),r=j(t[0][1],d,_);[n,r]=z([n,r]);const u=a.Names.getGenericPlaceName("dungeon"),h=o.LevelGen.getDungeonConf(u);Object.assign(h,{x:p,y:f,levelX:n,levelY:r,owX:s,owY:i}),c.nDungeons+=1,W(E,S,h),c.dungeon.push(h)}else if("mountain"===e.type){const t=e.coord,n=Y(t[0][0],l,v),r=j(t[0][1],d,_),u=a.Names.getUniqueName("mountain"),h=o.LevelGen.getMountainConf(u);Object.assign(h,{x:p,y:f,levelX:n,levelY:r,owX:s,owY:i}),W(E,S,h),c.nMountains+=1,c.mountain.push(h)}else"blacktower"===e.type&&(g("Adding final blacktower now"),H(e,b,c))})})}return function(e,t){const n=e.getSizeX(),s=e.getSizeY(),r=n/t.maxX,a=s/t.maxY;for(let n=0;n<t.maxX;n++)for(let s=0;s<t.maxY;s++){const o=J(n,s,r,a),i=n+","+s,l=e.getBiome(o[0],o[3]);t.biome[i]=l}}(e,c),l}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(14),i=n(16),l=r(n(11)),c=o.ObjectShell.getParser();function u(e){a.default.gameInfo(e)}t.SystemQuest=class extends i.SystemBase{static addQuestEvent(e,t,n,s={}){const r=new l.QuestTargetEvent;r.setArgs(s),r.setEventType(n),r.setTargetComp(t),e.add(r)}constructor(e,t){super(a.default.SYS.QUEST,e,t),this.compTypesAny=!0,this._eventTable={battle:this.onBattleEvent=this.onBattleEvent.bind(this),damage:this.onDamageEvent=this.onDamageEvent.bind(this),escort:this.onEscortEvent=this.onEscortEvent.bind(this),get:this.onGetEvent=this.onGetEvent.bind(this),give:this.onGiveEvent=this.onGiveEvent.bind(this),goto:this.onGotoEvent=this.onGotoEvent.bind(this),kill:this.onKillEvent=this.onKillEvent.bind(this),listen:this.onListenEvent=this.onListenEvent.bind(this),read:this.onReadEvent=this.onReadEvent.bind(this),report:this.onReportEvent=this.onReportEvent.bind(this)}}updateEntity(e){if(e.has("GiveQuest")){const t=e.get("GiveQuest");this.processGiveQuestComp(e,t),e.remove(t)}if(e.has("QuestCompleted")){const t=e.get("QuestCompleted");this.processComplComp(e,t),e.remove(t)}if(e.has("QuestTargetEvent")){const t=e.get("QuestTargetEvent");this.processQuestEvent(e,t),e.remove(t)}}processGiveQuestComp(e,t){const n=t.getGiver(),s=n.get("QuestGiver");if(s.getHasGivenQuest())return;const r=s.getQuestTargets(),o=new l.Quest;o.setQuestID(s.getQuestID()),0===r.length&&a.default.err("SystemQuest","processGiveQuestComp",`No keys in questData, giver: ${n.getName}`),r.forEach(e=>{const t=Object.assign({},e);t.isCompleted=!1,o.addTarget(t)}),s.giveQuest(e),o.setGiver({name:n.getName(),id:n.getID()}),o.setDescr(s.getDescr()),e.add(o),this.checkQuestMsgEmits(e,o)}checkQuestMsgEmits(e,t){const n=e.getLevel(),s=t.first("location");let r=`You accept the quest from ${t.getGiver().name}.`;s&&(n.getID()===s.id?(r+=" You are already in the first quest location",this.setTargetCompleted(s,t)):r+=" You should try to get to the first quest location"),u({cell:e.getCell(),msg:r})}processComplComp(e,t){const n=t.getGiver(),s=n.get("QuestGiver").getQuestID();if(e.getList("Quest").find(e=>e.getQuestID()===s).isCompleted()){const t=n.get("QuestGiver"),s=t.getQuestTargets().length,r=t.getDanger()*s,a=new l.ExpPoints(r);e.add(a),this.giveQuestReward(e,t)}else a.default.gameDanger({cell:e.getCell(),msg:"Quest is not completed!"})}giveQuestReward(e,t){if(t.hasReward())if(t.getHasGivenReward()){const t="Reward has already been given!";u({cell:e.getCell(),msg:t})}else{t.setHasGivenReward(!0);const n=t.getReward();if("item"===n.type){const t=n.name,s=c.createItem(t);if(s){let t=`${e.getName()} receives ${s.getName()} as`;t+=" a reward for completing the quest",u({cell:e.getCell(),msg:t}),e.getInvEq().getInventory().addItem(s)}}}}processQuestEvent(e,t){const n=t.getEventType(),s=e.getList("Quest");if("function"==typeof this._eventTable[n])s.forEach(s=>{(function(e,t){const n=e.getTargetComp();return t.isInThisQuest(n)})(t,s)&&this._eventTable[n](e,t,s)});else{const e=Object.keys(this._eventTable);a.default.err("SystemQuest","processQuestEvent",`No function for ${n} in eventTable. Found: ${e}`)}}onBattleEvent(e,t,n){const s=t.getArgs(),r=t.getTargetComp(),a=r.getTarget(),o=r.getTargetType(),i=function(e,t){return e.getQuestTargets().find(e=>e.id===t.getID())}(n,a);if("winbattle"===o){if(s.isWon){this.setTargetCompleted(i,n);let t=`${e.getName()} has won a battle as `;t+="as a quest objective!",u({cell:e.getCell(),msg:t})}}else if("finishbattle"===o){this.setTargetCompleted(i,n);let t=`${e.getName()} has finished a battle as `;t+="as a quest objective!",u({cell:e.getCell(),msg:t})}}onDamageEvent(e,t,n){const s=t.getTargetComp().getTarget(),r=n.getQuestTargets().find(e=>e.id===s.getID());this.setTargetCompleted(r,n);let a=`${e.getName()} has finished a quest objective `;a+=`to damage ${s.getDamage()}`,u({cell:e.getCell(),msg:a})}onEscortEvent(e,t,n){const s=t.getTargetComp().getTarget(),r=n.getQuestTargets().find(e=>e.id===s.getID());this.setTargetCompleted(r,n);let a="";const o=e.getLevel().getParentZone();o&&(a=" to "+o.getName());let i=`${e.getName()} has escorted ${s.getName()} `;i+=`safely back${a} as a quest objective!`,u({cell:e.getCell(),msg:i})}onGetEvent(e,t,n){const s=t.getTargetComp().getTarget(),r=n.getQuestTargets().find(e=>e.id===s.getID());this.setTargetCompleted(r,n);let a=`${e.getName()} has found ${s.getName()} `;a+="as a quest objective!",u({cell:e.getCell(),msg:a})}onGiveEvent(e,t,n){console.log("processing onGiveEvent");const s=t.getArgs(),{actor:r,item:a}=s,o=n.getQuestTargets().find(e=>e.id===r.getID());this.setTargetCompleted(o,n);let i=`${e.getName()} has given ${a.getName()} `;i+=`to ${r.getName()} as quest objective!`,u({cell:e.getCell(),msg:i})}onGotoEvent(e,t,n){const s=t.getTargetComp().getTarget(),r=n.getQuestTargets().find(e=>e.id===s.getID());this.setTargetCompleted(r,n);const a=`${e.getName()} has arrived to a quest target location!`;u({cell:e.getCell(),msg:a})}onKillEvent(e,t,n){const s=t.getArgs();if(s&&s.corpse){const r=t.getTargetComp().getTarget();this.moveQuestTargetComp(r,s.corpse);const a=n.getQuestTargets().find(e=>e.id===r.getID());this.setTargetCompleted(a,n);let o=`${e.getName()} has reached quest target of killing`;o+=` ${r.getName()}.`,u({cell:e.getCell(),msg:o})}else a.default.err("SystemQuest","onKillEvent",`Args must contain |corpse|. Got: ${JSON.stringify(s)}`)}onListenEvent(e,t,n){const s=t.getArgs();if(s&&s.info){const t=s.info.getInfo(),r=s.src;e.add(s.info.clone());const a=r.getID(),o=n.getQuestTargets().find(e=>e.id===a);this.setTargetCompleted(o,n),u({msg:`${r.getName()} tells about ${t}`,cell:e.getCell()})}else a.default.err("SystemQuest","onListenEvent",`Args must contain |info|. Got: ${JSON.stringify(s)}`)}onReadEvent(e,t,n){const s=t.getTargetComp().getTarget(),r=n.getQuestTargets(),a=r.find(e=>e.id===s.getID());this.setTargetCompleted(a,n);const o=s.getMetaData("place");if(o){const t=o[0];if(t.levelID===e.getLevel().getID()){const e=r.find(e=>e.id===t.levelID&&!e.isCompleted);this.setTargetCompleted(e,n)}else{let n=`${e.getName()} learns to travel to `;n+=`${t.placeName} as part of the quest.`,u({cell:e.getCell(),msg:n})}}}onReportEvent(e,t,n){const s=n.getQuestTargets(),r=t.getTargetComp(),a=r.getTarget(),o=a.getName();let i=!1;if(a.has("QuestReport")){const l=a.get("QuestReport"),c=t.getArgs().info;if(c)if(l.getExpectInfoFrom()===c.getGivenBy())i=!0;else{const t=`${o} is not interested in this info`;u({cell:e.getCell(),msg:t})}else n.isTargetInQuest(r)&&(i=s.filter(e=>e.id!==a.getID()).reduce((e,t)=>e&&t.isCompleted,!0))}if(i){const t=s.find(e=>e.id===a.getID()),r=`${e.getName()} reports info to ${o}`;u({cell:e.getCell(),msg:r}),this.setTargetCompleted(t,n)}}moveQuestTargetComp(e,t){try{const n=e.get("QuestTarget");n.changeEntity(t),n.setIsCompleted(!0),n.setTarget(t)}catch(t){console.log("srcEnt is",e),console.log(t.message)}}setTargetCompleted(e,t){const n=t.getEntity();if(!1===e.isCompleted)e.isCompleted=!0;else{let n="targetObj: "+JSON.stringify(e);n+="targetQuest: "+JSON.stringify(t),a.default.err("SystemQuest","setTargetCompleted","Tried to set completed quest to completed again: "+n)}if(t.isCompleted()){let e=`${n.getName()} has completed a quest!`;e+=" now it is time to go collect the reward.",u({cell:n.getCell(),msg:e}),this.checkSubQuestCompletion(n,t)}}checkSubQuestCompletion(e,t){const n=t.getQuestID();e.getList("Quest").forEach(e=>{e.getTargetsByType("subquest").forEach(e=>{e.subQuestID===n&&(e.isCompleted=!0)})})}}},function(e,t,n){e.exports={default:n(371),__esModule:!0}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=o(n(1)),a=o(n(171));function o(e){return e&&e.__esModule?e:{default:e}}t.default=(0,a.default)(function(e,t,n,a,o){var i=e[t],l=void 0===i?"undefined":s(i);return r.default.isValidElement(i)?new Error("Invalid "+a+" `"+o+"` of type ReactElement supplied to `"+n+"`, expected a ReactComponent or a DOMElement. You can usually obtain a ReactComponent or DOMElement from a ReactElement by attaching a ref to it."):"object"===l&&"function"==typeof i.render||1===i.nodeType?null:new Error("Invalid "+a+" `"+o+"` of value `"+i+"` supplied to `"+n+"`, expected a ReactComponent or a DOMElement.")}),e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,r=n(33);var a=function(){};((s=r)&&s.__esModule?s:{default:s}).default&&(a=document.addEventListener?function(e,t,n,s){return e.removeEventListener(t,n,s||!1)}:document.attachEvent?function(e,t,n){return e.detachEvent("on"+t,n)}:void 0),t.default=a,e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(30);t.Mixin={};class o{}t.Base=o,t.Mixin.Base=o,t.Typed=(e=>(class extends e{constructor(t){e&&super(t),this.type=t.type||"",this._propType=t.propType||""}getPropType(){return this._propType}getType(){return this.type}setPropType(e){r.default.PROP_TYPES.indexOf(e)>=0?this._propType=e:r.default.err("Object.Typed","setPropType","Unknown prop type: |"+e+"|")}setType(e){this.type=e,r.default.nullOrUndefError("Object.Typed: setType","arg |type|",e)}})),t.Locatable=(e=>(class extends e{constructor(e){super(e),this._x=null,this._y=null,this._level=null}setX(e){this._x=e}setY(e){this._y=e}getX(){return this._x}getY(){return this._y}isAtXY(e,t){return e===this._x&&t===this._y}getXY(){return[this._x,this._y]}setXY(e,t){this._x=e,this._y=t}getCell(){return this._level.getMap().getCell(this._x,this._y)}setLevel(e){this._level=e,r.default.nullOrUndefError("Mixin.Locatable: setLevel","arg |level|",e)}unsetLevel(){this._level?this._level=null:r.default.err("Mixin.Locatable","unsetLevel","Trying to unset already null level.")}getLevel(){return this._level}isLocated(){return null!==this._x&&null!==this._y&&null!==this._level}})),t.DamageRoll=(e=>(class extends e{constructor(e){super(e),this.damageDie=a.Dice.create("1d4")}rollDamage(){if(this.getEntity().hasOwnProperty("getWeapon")){const e=this.getEntity().getWeapon();if(null!==e)return e.rollDamage()}return this.damageDie.roll()}getDamageDie(){return this.damageDie}setDamageDie(e){this.damageDie="string"==typeof e?a.Dice.create(e):e}copy(e){super.copy(e),this.damageDie=e.getDamageDie().clone()}toJSON(){const e=super.toJSON();return e.setDamageDie=this.damageDie.toString(),e}})),t.DurationRoll=(e=>(class extends e{constructor(e){super(e)}rollDuration(){return this.duration.roll()}setDurationDie(e){this.duration="string"==typeof e?a.Dice.create(e):e}getDurationDie(){return this.duration}copy(e){super.copy(e),this.duration=e.getDurationDie().clone()}toJSON(){const e=super.toJSON();return e.setDurationDie=this.duration.toString(),e}})),t.Defense=(e=>(class extends e{constructor(e){super(e),this._attack=1,this._defense=1,this._protection=0}getAttack(){return this._attack}setAttack(e){this._attack=e}getDefense(){return this._defense}setDefense(e){this._defense=e}getProtection(){return this._protection}setProtection(e){this._protection=e}copy(e){super.copy(e),this.setAttack(e.getAttack()),this.setDefense(e.getDefense()),this.setProtection(e.getProtection())}equals(e){let t=super.equals(e);return t&&(t=this.getAttack()===e.getAttack()&&this.getDefense()===e.getDefense()&&this.getProtection()===e.getProtection()),t}toString(){let e=super.toString();return e+=` A: ${this.getAttack()}, D: ${this.getDefense()}, `,e+=` P: ${this.getProtection()}, `}toJSON(){const e=super.toJSON();return e.setAttack=this.getAttack(),e.setDefense=this.getDefense(),e.setProtection=this.getProtection(),e}})),t.Damage=(e=>(class extends(t.Defense(e)){constructor(e){super(e),this._damageDie=new a.Dice(1,4,0),this._range=1}setAttackRange(e){this._range=e}getAttackRange(){return this._range}rollDamage(){if(this.hasOwnProperty("getWeapon")){const e=this.getWeapon();if(!r.default.isNullOrUndef([e]))return e.rollDamage()}return this._damageDie.roll()}getDamageDie(){return this._damageDie}setDamageDie(e){"string"==typeof e?this._damageDie=a.Dice.create(e):"object"==typeof e&&(this._damageDie=e)}copy(e){super.copy(e),this.setAttackRange(e.getAttackRange());const t=e.getDamageDie().clone();this.setDamageDie(t)}equals(e){let t=super.equals(e);return t&&(t=(t=this.getDamageDie().equals(e.getDamageDie()))&&this.getAttackRange()===e.getAttackRange()),t}toString(){let e=super.toString();return e+="Dmg: "+this.getDamageDie().toString(),e+=", R:"+this.getAttackRange()}toJSON(){const e=super.toJSON();return e.setAttackRange=this.getAttackRange(),e.setDamageDie=this.getDamageDie().toString(),e}}))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=null;class r{static deserialize(e,t,n={}){const s=new t[e.$proto];for(const a in e)if(e.hasOwnProperty(a)){const o=e[a];if(r.isPrimitive(o))s[a]=o;else if(Array.isArray(o)){const e=[];s.forEach(s=>{e.push(r.deserialize(s,t,n))}),s[a]=e}else o.$objID?n.hasOwnProperty(o.$objID)?s[a]=n[o.$objID]:s[a]=r.deserialize(o,t,n):s[a]=o}return delete s.$proto,s}static deref(e){return e?e.value:s}static createObjectID(){return r.ID++}static getProtoName(e){return Object.getPrototypeOf(e).constructor.name}static isPrimitive(e){return"object"!=typeof e}static serialize(e){if(r.isPrimitive(e))return e;if(Array.isArray(e)){const t=[];return e.forEach(e=>{t.push(r.serialize(e))}),t}return e.$objID?e.serialize():e.toJSON?e.toJSON():e.$objRef?{$objRef:e.value.getID()}:e}constructor(){this.$objID=r.ID++}getID(){return this.$objID}setID(e){this.$objID=e}getObjRef(){return{$objRef:{type:"object",id:this.$objID}}}getRefAndVal(){const e=this.getObjRef();return e.value=this,e}}t.GameObject=r,r.ID=1},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=null;t.BrainBase=class{constructor(e){r.default.isNullOrUndef([e])&&r.default.err("BrainSentient","constructor","Actor must not be null."),this._actor=e,this._type=null}setActor(e){this._actor=e}getActor(){return this._actor}getType(){return this._type}setType(e){this._type=e}getMemory(){return a}getSeenCells(){return[]}findEnemyCell(e){return null}findFriendCell(e){return null}canMeleeAttack(e,t){return!1}canSeeActor(e){return!1}getSeenFriends(){return[]}getSeenEnemies(){return[]}decideNextAction(e){return r.default.err("BrainBase","decideNextAction","Not implemented. Do in derived class"),null}toJSON(){return{type:this._type}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(84),o=n(9),i=n(44),l=n(130),c=n(17)("bitn:goals-top"),{GOAL_COMPLETED:u,GOAL_INACTIVE:h,GOAL_FAILED:d}=a.GoalStatus,p=o.Random.getRNG();t.GoalsTop={};class f extends a.Goal.Base{constructor(e){super(e),this.setType("GoalTop"),this.evaluators=[]}removeEvaluators(){this.evaluators=[]}addEvaluator(e){this.evaluators.push(e)}activate(){this.arbitrate()}getEvaluator(e){return this.evaluators.find(t=>t.getType()===e)}process(){this.activateIfInactive();const e=this.processSubGoals();return e===u||e===d?(this.dbg(`process() COMPL/FAILED got status ${e}`),h):(this.removeFinishedOrFailed(),this.dbg(`process() got status ${e}`),e)}setBias(e){Object.keys(e).forEach(t=>{const n=this.evaluators.find(e=>e.getType()===t);if(n)n.setBias(e[t]);else{const e=this.evaluators.map(e=>e.getType()),n=`Bias ${t} not matching any evaluator: ${e}`;r.default.warn("GoalTop","setBias",n)}})}toJSON(){const e=[];return this.evaluators.forEach(t=>{"Order"!==t.getType()&&e.push(t.toJSON())}),{type:this.getType(),evaluators:e}}arbitrate(){this.dbg("arbitrate() started"),0===this.evaluators.length&&r.default.err("GoalTop","arbitrate",`No evaluators in ${this.getType}, actor: ${this.actor}`);let e=0,t=null;this.evaluators.forEach(n=>{const s=n.calculateDesirability(this.actor);(e<s||null===t)&&(t=n,e=s)}),t?t.setActorGoal(this.actor):r.default.err("GoalTop","arbitrate","No next goal found"),this.dbg("arbitrate() finished")}}t.GoalTop=f,t.GoalsTop.Top=f;class m extends f{constructor(e){super(e),this.setType("ThinkBasic");const[t,n]=[.5,1.5];this.bias={attack:p.getUniformRange(t,n),explore:r.default.BIAS.Explore,flee:r.default.BIAS.Flee,order:r.default.BIAS.Order,patrol:r.default.BIAS.Patrol},this.updateEvaluators()}updateEvaluators(){this.removeEvaluators(),this.evaluators.push(new i.Evaluator.AttackActor(this.bias.attack)),this.evaluators.push(new i.Evaluator.Flee(this.bias.flee)),this.evaluators.push(new i.Evaluator.Explore(this.bias.explore))}giveOrders(e){this.dbg("Received an order!!",e),this.addEvaluator(e)}clearOrders(){this.evaluators.filter(e=>e.isOrder()).forEach(e=>{const t=e;t.goal.isActive()&&t.goal.terminate();const n=this.evaluators.indexOf(t);this.evaluators.splice(n,1)})}addGoal(e){const t=e.getType();this.dbg(`addGoal() ${t}`),this.isGoalPresent(t)||(this.removeSubGoalsOfType(t),this.addSubGoal(e),c.enabled&&r.default.log("Actor subgoals are now: "+this.subGoals.map(e=>e.getType())))}}t.ThinkBasic=m,t.GoalsTop.ThinkBasic=m;class g extends m{constructor(e){super(e),this.setType("ThinkSpellcaster"),this.bias.castSpell=1,this.evaluators.push(new i.Evaluator.CastSpell(this.bias.castSpell))}}t.ThinkSpellcaster=g,t.GoalsTop.ThinkSpellcaster=g;class y extends m{constructor(e){super(e),this.setType("ThinkCommander"),this.bias.attack=.1,this.bias.winBattle=.8,this.bias.retreat=.3,this.updateEvaluators()}updateEvaluators(){super.updateEvaluators();const e=new l.EvaluatorsBattle.WinBattle(this.bias.winBattle);this.evaluators.push(e);const t=new l.EvaluatorsBattle.Retreat(this.bias.retreat);this.evaluators.push(t)}}t.ThinkCommander=y,t.GoalsTop.ThinkCommander=y},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(311);t.ALL_VISIBLE="ALL";const o=function(e,n,s){const a=[],o=[];let i=-1,l=-1;if(null!==s&&(i=s.getX(),l=s.getY()),!e)return a.fill("cell-not-seen",0,n.length-1),o.fill("X",0,n.length-1),[a,o];for(let s=0;s<n.length;s++){const c=n[s];let u=!1;if(e===t.ALL_VISIBLE)u=!0;else{u=!(e.indexOf(c)<0)}let h=r.default.getCssClassForCell(c,u);const d=r.default.getCharForCell(c,u);i===c.getX()&&l===c.getY()&&(h="cell-target-selected"),u||c.isExplored()&&(h+=" cell-not-seen"),a.push(h),o.push(d)}return[a,o]},i=function(e,n,s,a,o={},i,l){let c=null,u=null,h=0,d=0;const p=[],f=[];i=i||r.default.getCssClassForCell.bind(r.default),l=l||r.default.getCharForCell.bind(r.default);let m=null;if(s&&(m=new Map,Array.isArray(s)?s.forEach(e=>{m.set(e.getX()+","+e.getY(),e)}):m.set(s.getX()+","+s.getY(),s)),!e)return p.fill("cell-not-seen",0,n.length-1),f.fill("X",0,n.length-1),[p,f];let g="",y="";for(let s=0;s<n.length;s++){const r=n[s],v=r.getX(),_=r.getY();let b=!1;if(e===t.ALL_VISIBLE)b=!0;else{b=!(e.indexOf(r)<0)}if(g=i(r,b),y=l(r,b),b&&a){const e=v+","+_;a[e]&&(g=a[e].className,y=a[e].char)}m&&m.has(r.getKeyXY())&&(g=o.selectedCell?o.selectedCell:"cell-target-selected"),b||r.isExplored()&&(g+=" cell-not-seen"),g!==u&&u||y!==c&&c?(p.push([d,u]),d=1,f.push([h,c]),h=1):(++d,++h),c=y,u=g}return d>0&&p.push([d,g]),h>0&&f.push([h,y]),[p,f]},l=function(e,t){const n=[],s=[];let a=-1,o=-1;null!==t&&(a=t.getX(),o=t.getY());for(let t=0;t<e.length;t++){const i=e[t];let l=r.default.getCssClassFullMap(i);const c=r.default.getCharFullMap(i);a===i.getX()&&o===i.getY()&&(l="cell-target-selected"),n.push(l),s.push(c)}return[n,s]},c=function(e,t){let n=null,s=null,a=0,o=0;const i=[],l=[];let c=null;t&&(c=new Map,t.forEach(e=>{c.set(e.getX()+","+e.getY(),e)}));let u="",h="";for(let t=0;t<e.length;t++){const d=e[t];if(u=r.default.getCssClassFullMap(d),h=r.default.getCharFullMap(d),c){const[e,t]=[d.getX(),d.getY()];c.has(e+","+t)&&(u="cell-target-selected")}u!==s&&s||h!==n&&n?(i.push([o,s]),o=1,l.push([a,n]),a=1):(++o,++a),n=h,s=u}return o>0&&i.push([o,u]),a>0&&l.push([a,h]),[i,l]};class u{constructor(e,t){this.viewportX=e,this.viewportY=t,this.selectedCell=null,this.styles={},this._charRows=[],this._classRows=[],this._mapShown=!1,this.viewport=new a.Viewport(e,t)}getStartX(){return this.viewport.startX}setSelectedCell(e){this.selectedCell=e}setViewportXY(e,t){this.viewportX=e,this.viewportY=t,this.viewport.setViewportXY(e,t),this._charRows=[],this._classRows=[];for(let e=0;e<t;e++)this._charRows.push([]),this._classRows.push([])}setMapShown(e){this._mapShown=e}getCharRows(){return this._charRows}getClassRows(){return this._classRows}_initRender(e,t,n){this._mapShown?this.setViewportXY(n.cols,n.rows):this.setViewportXY(this.viewportX,this.viewportY),this.viewport.initCellsInViewPort(e,t,n),this.startX=this.viewport.startX,this.endX=this.viewport.endX,this.startY=this.viewport.startY,this.endY=this.viewport.endY}render(e,t,n,s){this._initRender(e,t,n);let r=0;for(let e=this.viewport.startY;e<=this.viewport.endY;++e){const t=this.viewport.getCellRow(e),n=o(s,t,this.selectedCell);this._classRows[r]=n[0],this._charRows[r]=n[1],++r}}renderAllVisible(e,n,s){this.render(e,n,s,t.ALL_VISIBLE)}renderWithRLE(e,t,n,s,r,a,o){this._initRender(e,t,n);let l=0;for(let e=this.viewport.startY;e<=this.viewport.endY;++e){const t=this.viewport.getCellRow(e),n=i(s,t,this.selectedCell,r,this.styles,a,o);this._classRows[l]=n[0],this._charRows[l]=n[1],++l}}renderFullMap(e){this.startX=0,this.endX=e.cols-1,this.startY=0,this.endY=e.rows-1;for(let t=0;t<e.rows;++t){const n=l(e.getCellRowFast(t),this.selectedCell);this._classRows[t]=n[0],this._charRows[t]=n[1]}}renderFullMapWithRLE(e){this.startX=0,this.endX=e.cols-1,this.startY=0,this.endY=e.rows-1;for(let t=0;t<e.rows;++t){const n=c(e.getCellRowFast(t),this.selectedCell);this._classRows[t]=n[0],this._charRows[t]=n[1]}}clear(){this._classRows=[],this._charRows=[],this.selectedCell=null,this.startX=0,this.endX=-1,this.startY=0,this.endY=-1,this.styles={}}setStyle(e,t){this.styles[e]=t}printRenderedChars(){this._charRows.forEach(e=>{console.log(e.join(""))})}printRenderedClasses(){this._classRows.forEach(e=>{console.log(e.join(""))})}}t.Screen=u;t.ScreenBuffered=class extends u{constructor(e,t){super(e,t),this.isInitialized=!1,this.getCellChar=this.getCellChar.bind(this),this.getCellClass=this.getCellClass.bind(this),this.prevVisible=[]}invalidate(){this.isInitialized=!1,this.prevVisible=[]}renderWithRLE(e,t,n,s,a,o,i){return s||r.default.err("ScreenBuffered","renderWithRLE","undef visibleCells"),this.isInitialized||this.initializeFullMap(n,s),this.getCellsInFirstOnly(this.prevVisible,s).forEach(e=>{const[t,n]=e.getXY(),s=r.default.getCssClassForCell(e,!1),a=r.default.getCharForCell(e,!1);this.fullMapClassRows[t][n]=s,this.fullMapCharRows[t][n]=a}),s.forEach(e=>{const[t,n]=e.getXY(),s=r.default.getCssClassForCell(e,!0),a=r.default.getCharForCell(e,!0);this.fullMapClassRows[t][n]=s,this.fullMapCharRows[t][n]=a}),this.prevVisible=s,super.renderWithRLE(e,t,n,s,a,this.getCellClass,this.getCellChar)}initializeFullMap(e,t){const n=e.getCells();this.fullMapClassRows=new Array(e.cols),this.fullMapCharRows=new Array(e.cols);for(let t=0;t<e.cols;t++)this.fullMapCharRows[t]=new Array(e.rows),this.fullMapClassRows[t]=new Array(e.rows);const s=new Map;t.forEach(e=>{s[e.getKeyXY()]=!0}),n.forEach(e=>{const[t,n]=e.getXY(),a=s[e.getKeyXY()],o=r.default.getCssClassForCell(e,a),i=r.default.getCharForCell(e,a);this.fullMapClassRows[t][n]=o,this.fullMapCharRows[t][n]=i}),this.isInitialized=!0}getCellsInFirstOnly(e,t){const n=[];return e.forEach(e=>{t.indexOf(e)<0&&n.push(e)}),n}getCellClass(e,t){const[n,s]=e.getXY();return this.fullMapClassRows[n][s]}getCellChar(e,t){const[n,s]=e.getXY();return this.fullMapCharRows[n][s]}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(9),r=n(67),a=n(194),o=s.Random.getRNG();t.Castle={},t.Castle.corridorDoorThr=.2,t.Castle.tiles={},t.Castle.tiles.corner=["\ndir:NW\nname:corner_se\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n......#\nY.....#\n......#\n#######","\ndir:NW\nname:corner_se1\nX=#\nY=#\n\n#X#+#X#\nY.....#\n+.....#\n+...#.#\n+..####\nY...###\n#######","\ndir:NE\nname:corner_sw\nX=.\nY=#\n\n#X...X#\n#.....#\nY......\n#......\nY......\n#.....#\n#######","\ndir:SW\nname:corner_ne\nX=#\nY=.\n\n#X###X#\nY.....#\n......#\n......#\n......#\nY.....#\n#.....#","\ndir:SE\nname:corner_nw\nX=#\nY=#\n\n#X###X#\n#......\nY......\n#......\nY......\n#......\n#.....#"],t.Castle.tiles.term=["\ndir:N\nname:term_n\nX=#\nY=#\n\n#X#+#X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n#######","\ndir:S\nname:term_s\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n###+###","\ndir:E\nname:term_e\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n#.....+\nY.....#\n#.....#\n#######","\ndir:W\nname:term_w\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n+.....#\nY.....#\n#.....#\n#######"],t.Castle.tiles.entrance=["\ndir:NEW\nname:entrance_n\nX=.\nY=#\n\n#X...X#\n##...##\nY##.###\n..#+#..\n.......\nY.....#\n#######","\ndir:SEW\nname:entrance_s\nX=#\nY=#\n\n#X###X#\nY......\n..#.#..\n.##+##.\nY#...##\n#.....#\n##...##","\ndir:NSW\nname:entrance_w\nX=#\nY=#\n\n##X..X#\nY.##..#\n...##.#\n....+.#\n...##.#\nY.##..#\n###...#","\ndir:NSE\nname:entrance_e\nX=#\nY=#\n\n#.X.X##\nY.#..##\n#.##.#.\n#....+.\n#..#.#.\nY.##.##\n#.....#","\ndir:SEW\nname:entrance_ne\nX=#\nY=#\n\n##X#X##\nY.#..##\n..##.#.\n.....+.\n...#.#.\nY.##.##\n#.....#","\ndir:SEW\nname:entrance_nw\nX=#\nY=#\n\n##X##X#\nY###..#\n.####.#\n.+....#\n.####.#\nY###..#\n###...#","\ndir:NEW\nname:entrance_se\nX=#\nY=#\n\n##X.X##\nY....##\n.....#.\n.....+.\n...#.#.\nY.##.##\n#######","\ndir:NEW\nname:entrance_sw\nX=#\nY=#\n\n##X..X#\nY##...#\n.#....#\n.+....#\n.#....#\nY###..#\n#######"],t.Castle.tiles.entranceWall=["\ndir:NEW\nname:entrance_n\nX=.\nY=#\n\n#X...X#\n##...##\nY##.###\n..#+#..\n.......\nY.....#\n##...##","\ndir:SEW\nname:entrance_s\nX=#\nY=#\n\n#X...X#\nY.....#\n..#.#..\n.##+##.\nY#...##\n#.....#\n#.....#","\ndir:NSW\nname:entrance_w\nX=#\nY=#\n\n##X..X#\nY.##..#\n...##.#\n....+.#\n...##.#\nY.##..#\n###...#","\ndir:NSE\nname:entrance_e\nX=.\nY=#\n\n#.#XX##\nY.##.##\n...#.#.\n.....+.\n...#.#.\nY.##.##\n#.....#"],t.Castle.tiles.corridor=["\ndir:NS\nname:corridor_east\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n#.....#","\ndir:NS\nname:corridor_west\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n#.....#","\ndir:EW\nname:corridor_north\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n.......\n#######","\ndir:EW\nname:corridor_south\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n.......\n#######"],t.Castle.tiles.corridorWithExit=["\ndir:NS\nname:corridor_east\nX=.\nY=#\n\n#X...X#\n#.....#\nY#....#\n......#\nY#....#\n#.....#\n#.....#","\ndir:NS\nname:corridor_west\nX=.\nY=#\n\n#X...X#\n#.....#\nY....##\n#......\nY....##\n#.....#\n#.....#","\ndir:EW\nname:corridor_north\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n..#.#..\n###.###","\ndir:EW\nname:corridor_south\nX=#\nY=.\n\n#X#.#X#\n..#.#..\nY......\n.......\nY......\n..#.#..\n#######"],t.Castle.tiles.branch=["\ndir:NSE\nname:corridor_nse\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n#.....+\nY.....#\n#.....#\n#.....#","\ndir:NSW\nname:corridor_nsw\nX=#\nY=#\n\n#X...X#\n#.....#\nY.....#\n+.....#\nY.....#\n#.....#\n##...##","\ndir:NEW\nname:corridor_new\nX=#\nY=.\n\n#X#+#X#\n.......\nY......\n.......\nY......\n.......\n#######","\ndir:SEW\nname:corridor_sew\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n.......\n###+###"],t.Castle.tiles.storerooms=["\ndir:S\nname:storeroom_s\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n#.....#\nY.....#\n###|###\n##..&##","\ndir:N\nname:storeroom_n\nX=#\nY=#\n\n#X&..X#\n###|###\nY.....#\n#.....#\nY.....#\n#######\n#######","\ndir:W\nname:storeroom_w\nX=#\nY=#\n\n##X#X##\nY#.#.##\n.#....#\n.|...##\n&#....#\nY#.#.##\n#######","\ndir:E\nname:storeroom_e\nX=#\nY=#\n\n##X#X##\nY#.#.##\n#....#&\n#....|.\n#....#.\nY..#.##\n#######"],t.Castle.tiles.residential=["\nname:living2x2\nX=#\nY=#\n\n#X+#+X#\n#::#::#\nY::#::#\n#######\nY::#::#\n#::#::#\n##+#+##","\nname:living2x2\ndir:NS\nX=#\nY=#\n\n#X#.#X#\n#:+.+:#\nY:#.#:#\n###.###\nY:#.#:#\n#:+.+:#\n###.###","\nname:living2x2\ndir:NS\nX=#\nY=#\n\n#X#.#X#\nY:#.#:#\n#:+.+:#\n###.###\n#:+.+:#\nY:#.#:#\n###.###","\nname:livingL2S\ndir:S\nX=#\nY=#\n\n#X###X#\n#:::::#\nY:::::#\n###+###\nY:#.#:#\n#:+.+:#\n###.###","\nname:livingL_corner\ndir:NE\nX=#\nY=#\n\n#X#..X#\n#:#+#..\nY:::##.\n#::::#.\nY::::##\n#:::::#\n#######","\nname:living_3dir\ndir:NSE\nX=#\nY=#\n\n#X#.X##\nY:#.#:#\n#:#.#+#\n#:#....\nY:#.###\n#:+.###\n###.###","\nname:living_corner\ndir:NE\nX=#\nY=#\n\n#X#.#X#\n#:#...#\nY:###.#\n#:::+..\nY:::###\n#:::+:#\n#######","\nname:living_corner2\ndir:NE\nX=#\nY=#\n\n#X#.#X#\n#:#...#\nY:###..\n#:::+#.\nY::::##\n#:::::#\n#######"],t.Castle.tiles.crossCenter=["\nname:cross_center1\ndir:NSEW\nX=.\nY=.\n\n#X...X#\n##...##\nY..#...\n..###..\nY..#...\n##...##\n##...##"],t.Castle.tiles.fillerFloor="\nname:FILLER\nX=.\nY=.\n\n.X...X.\nY......\n.......\n.......\n.......\nY......\n.......",t.Castle.tiles.fillerWall="\nname:FILLER\nX=#\nY=#\n\n#X###X#\nY######\n#######\n#######\n#######\nY######\n#######",t.Castle.startFuncs={},t.Castle.startRoomFunc=function(){const e=Math.floor(this.tilesX/2);let t=null,n=0;return o.getUniform()<=.5?t=this.findTemplate({name:"entrance_n"}):(t=this.findTemplate({name:"entrance_s"}),n=this.tilesY-1),{x:e,y:n,room:t}},t.Castle.startRoomFuncNorth=function(){return{x:Math.floor(this.tilesX/2),y:0,room:this.findTemplate({name:"entrance_n"})}},t.Castle.startFuncs.N=t.Castle.startRoomFuncNorth,t.Castle.startRoomFuncSouth=function(){const e=this.tilesY-1;return{x:Math.floor(this.tilesX/2),y:e,room:this.findTemplate({name:"entrance_s"})}},t.Castle.startFuncs.S=t.Castle.startRoomFuncSouth,t.Castle.startRoomFuncWest=function(){return{x:0,y:Math.floor(this.tilesY/2),room:this.findTemplate({name:"entrance_w"})}},t.Castle.startFuncs.W=t.Castle.startRoomFuncWest,t.Castle.startRoomFuncEast=function(){const e=Math.floor(this.tilesY/2);return{x:this.tilesX-1,y:e,room:this.findTemplate({name:"entrance_e"})}},t.Castle.startFuncs.E=t.Castle.startRoomFuncEast,t.Castle.startRoomFuncNorthEast=function(){return{x:this.tilesX-1,y:0,room:this.findTemplate({name:"entrance_ne"})}},t.Castle.startFuncs.NE=t.Castle.startRoomFuncNorthEast,t.Castle.startRoomFuncNorthWest=function(){return{x:0,y:0,room:this.findTemplate({name:"entrance_nw"})}},t.Castle.startFuncs.NW=t.Castle.startRoomFuncNorthWest,t.Castle.startRoomFuncSouthEast=function(){const e=this.tilesY-1;return{x:this.tilesX-1,y:e,room:this.findTemplate({name:"entrance_se"})}},t.Castle.startFuncs.SE=t.Castle.startRoomFuncSouthEast,t.Castle.startRoomFuncSouthWest=function(){return{x:0,y:this.tilesY-1,room:this.findTemplate({name:"entrance_sw"})}},t.Castle.startFuncs.SW=t.Castle.startRoomFuncSouthWest,t.Castle.startFuncTwoGates=function(){const e=Math.floor(this.tilesX/2),t=this.findTemplate({name:"entrance_n"}),n=this.findTemplate({name:"entrance_s"});return this.addRoom(t,e,0),{x:e,y:this.tilesY-1,room:n}},t.Castle.startFuncFourGates=function(){const e=Math.floor(this.tilesX/2),t=Math.floor(this.tilesY/2),n=this.findTemplate({name:"entrance_n"}),s=this.findTemplate({name:"entrance_s"}),r=this.findTemplate({name:"entrance_e"}),a=this.findTemplate({name:"entrance_w"});return this.addRoom(n,e,0),this.addRoom(r,this.tilesX-1,t),this.addRoom(a,0,t),{x:e,y:this.tilesY-1,room:s}},t.Castle.constraintFunc=function(e,n,s){if(0===e&&0===n)return this.findTemplate({name:"corner_nw"});if(0===e&&n===this.tilesY-1)return this.findTemplate({name:"corner_sw"});if(e===this.tilesX-1&&0===n)return this.findTemplate({name:"corner_ne"});if(e===this.tilesX-1&&n===this.tilesY-1)return this.findTemplate({name:"corner_se"});if(0===n){const e=this.findTemplate({name:"corridor_north"}),n=this.findTemplate({name:"corridor_sew"});if(n){if("S"===s)return n;if(o.getUniform()<t.Castle.corridorDoorThr)return n}return e}if(n===this.tilesY-1){const e=this.findTemplate({name:"corridor_south"}),n=this.findTemplate({name:"corridor_new"});if(n){if("N"===s)return n;if(o.getUniform()<t.Castle.corridorDoorThr)return n}return e}if(0===e){const e=this.findTemplate({name:"corridor_west"}),n=this.findTemplate({name:"corridor_nse"});if(n){if("E"===s)return n;if(o.getUniform()<t.Castle.corridorDoorThr)return n}return e}if(e===this.tilesX-1){const e=this.findTemplate({name:"corridor_east"}),n=this.findTemplate({name:"corridor_nsw"});if(n){if("W"===s)return n;if(o.getUniform()<t.Castle.corridorDoorThr)return n}return e}return null},t.Castle.constraintFuncCross=function(e,n,s){const a=t.Castle.constraintFunc.call(this,e,n,s),i=Math.floor(this.tilesX/2),l=Math.floor(this.tilesY/2);if(null===a||e===i||n===l){if(0===e&&n===l)return this.findTemplate({name:"corridor_nse"});if(e===this.tilesX-1&&n===l)return this.findTemplate({name:"corridor_nsw"});if(0===n&&e===i)return this.findTemplate({name:"corridor_sew"});if(n===this.tilesY-1&&e===i)return this.findTemplate({name:"corridor_new"});if(e===i&&n===l){const e=o.arrayGetRand(t.Castle.tiles.crossCenter);return r.Template.createTemplate(e)}if(e===i){if("E"===s)return this.findTemplate({name:"corridor_nse"});if("W"===s)return this.findTemplate({name:"corridor_nsw"});const e=this.findTemplate({name:"corridor_east"}),t=this.findTemplate({name:"corridor_nsw"}),n=this.findTemplate({name:"corridor_west"}),r=this.findTemplate({name:"corridor_nse"});return o.arrayGetRand([e,t,n,r])}if(n===l){if("S"===s)return this.findTemplate({name:"corridor_sew"});if("N"===s)return this.findTemplate({name:"corridor_new"});const e=this.findTemplate({name:"corridor_north"}),t=this.findTemplate({name:"corridor_sew"}),n=(this.findTemplate({name:"corridor_south"}),this.findTemplate({name:"corridor_new"}));return o.arrayGetRand([e,t,e,n])}}return a},t.Castle.roomCount=-1,t.Castle.Models={},t.Castle.Models.full=[].concat(t.Castle.tiles.branch).concat(t.Castle.tiles.corner).concat(t.Castle.tiles.term).concat(t.Castle.tiles.entrance).concat(t.Castle.tiles.corridor).concat(t.Castle.tiles.storerooms).concat(a.Vault.tiles.vault).concat(a.Vault.tiles.corner),t.Castle.Models.residential=t.Castle.tiles.residential.concat(t.Castle.Models.full),t.Castle.Models.outerWall=[].concat(t.Castle.tiles.entranceWall).concat(t.Castle.tiles.corner).concat(t.Castle.tiles.corridor).concat(t.Castle.tiles.corridorWithExit),t.Castle.templates={},t.Castle.templates.all=t.Castle.Models.full.map(e=>r.Template.createTemplate(e));let i=r.Template.transformList(t.Castle.templates.all);t.Castle.templates.all=t.Castle.templates.all.concat(i),t.Castle.templates.livingOnly=t.Castle.tiles.residential.map(e=>r.Template.createTemplate(e)),i=r.Template.transformList(t.Castle.templates.livingOnly),t.Castle.templates.livingOnly=t.Castle.templates.livingOnly.concat(i),t.Castle.templates.residential=t.Castle.templates.livingOnly.concat(t.Castle.templates.all)},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=r(n(53)),i=r(n(20)),l=r(n(14)),c=n(336),u=n(88),h=r(n(11)),d=n(137),p=n(17)("bitn:FactoryActor"),f=(e,t)=>{const{hp:n,att:s,def:r,prot:o}=t;if(!a.default.isNullOrUndef([n])){const t=e.get("Health");t.setHP(n),t.setMaxHP(n)}let i=null;e.has("Combat")?i=e.get("Combat"):(i=new h.Combat,e.add(i)),a.default.isNullOrUndef([s])||i.setAttack(s),a.default.isNullOrUndef([r])||i.setDefense(r),a.default.isNullOrUndef([o])||i.setProtection(o)};t.ActorRandomizer=function(){},t.ActorRandomizer.prototype.adjustActor=function(e){const t=e.getType();if(c.ActorMods.hasOwnProperty(t)){const{stats:n}=c.ActorMods[t];Object.keys(n).forEach(t=>{const s=a.default.formatSetterName(t),r=a.default.formatSetterName(t),o=e.get("Stats")[r]+n[t];e.get("Stats")[s](o)})}},t.FactoryActor=function(){this._randomizer=new t.ActorRandomizer,this.dbg=function(...e){p.enabled&&p(...e)},this.createPlayer=((e,t)=>{const n=new o.SentientActor(e);return n.setIsPlayer(!0),f(n,t),this._randomizer.adjustActor(n),n}),this.createRandomActor=function(e){return l.getParser().createRandomActor(e)},this.createActor=function(e,t={}){const n=new o.SentientActor(e);n.setType(e);const s=t.brain;if(f(n,t),this._randomizer.adjustActor(n),!a.default.isNullOrUndef([s]))if("object"==typeof s)n.setBrain(s);else{const e=this.createBrain(n,s);n.setBrain(e)}return n},this.createBrain=((e,t)=>{switch(t){case"Flame":return new i.BrainFlame(e);case"GoalOriented":return new i.BrainGoalOriented(e);case"NonSentient":return new i.BrainNonSentient(e);case"SpellCaster":return new i.BrainSpellCaster(e);case"Spirit":return new i.BrainSpirit(e);default:if(i[t])return new i[t](e);if(t&&""!==t){let e=`Warning. No brain type ${t} found`;e+="Using the default Brain.BrainSentient instead.",console.warn(e)}return new i.BrainSentient(e)}})},t.FactoryActor.prototype.createSpell=function(e){if(u.Spell.hasOwnProperty(e))return new u.Spell[e];{const t=Object.keys(u.Spell).join("\n\t");a.default.err("FactoryActor","createSpell",`No spell ${e} found in Spell: \n\t${t}`)}return null},t.FactoryActor.prototype.generateNActors=function(e,t,n){(!Number.isInteger(n)||n<=0)&&a.default.err("Factory.Actor","generateNActors","maxDanger (> 0) must be given. Got: "+n),n<3&&(n=3);const s=l.getParser(),r=[],o={func:e=>e.danger<=n};for(let i=0;i<e;i++){let e=null;if(e=t?s.createRandomActor({func:e=>t(e)&&e.danger<=n}):s.createRandomActorWeighted(1,n,o)){const t=s.dbGet(a.default.TYPE_ACTOR,e.getName()),o=n-t.danger;o>1&&a.default.levelUpActor(e,o),r.push(e)}else{let e="Factory Could not meet constraints for actor.";if(e+=" maxDanger: "+n,a.default.diag(e),t.constraint){const e=JSON.stringify(t.constraint);a.default.diag("Used constraints were: "+e)}else t||a.default.diag("No func was given, so used randomWeighted")}}return r},t.FactoryActor.prototype.createActorSpawner=function(e,t){const n=new d.SpawnerActor("spawner"),s=n.getBrain(),r=[{op:"lte",prop:"danger",value:e}].concat(t);return s.setConstraint(r),n}},function(e,t){var n=0,s=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++n+s).toString(36))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=o(n(1)),a=o(n(78));function o(e){return e&&e.__esModule?e:{default:e}}t.default=(0,a.default)(function(e,t,n,a,o){var i=e[t],l=void 0===i?"undefined":s(i);return r.default.isValidElement(i)?new Error("Invalid "+a+" `"+o+"` of type ReactElement supplied to `"+n+"`, expected a ReactComponent or a DOMElement. You can usually obtain a ReactComponent or DOMElement from a ReactElement by attaching a ref to it."):"object"===l&&"function"==typeof i.render||1===i.nodeType?null:new Error("Invalid "+a+" `"+o+"` of value `"+i+"` supplied to `"+n+"`, expected a ReactComponent or a DOMElement.")}),e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t){return e="function"==typeof e?e():e,a.default.findDOMNode(e)||t};var s,r=n(13),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(59),r=n(26),a=n(68),o=n(139),i=n(9),l=n(22),c=n(19),u=n(15),h=i.Random.getRNG();class d extends s.LevelGenerator{static getOptions(){const e=s.LevelGenerator.getOptions();return e.hasWall=!1,e.nShops=1,e.shopFunc=[()=>!0],e.shopType=["potion"],e}constructor(){super(),this.addDoors=!0,this.shouldRemoveMarkers=!0}create(e,t,n){let s=this.createLevel(e,t,n);return n.cellsAround&&(s=this.createCitySurroundings(s,n)),this.populateCityLevel(s,n),this.removeMarkers(s,n),s}createLevel(e,t,n){const s=new r.MapGenerator;let a=null;a=n.hasWall?s.createTownWithWall(e,t,n):s.createTownBSP(e,t,n);const o=new l.Level;return o.setMap(a.map),o.addExtras("houses",a.houses),this.createHouseElements(o),this.fillUnusedAreas(o,a.unused),o}createHouseElements(e){const t=e.getExtras().houses;for(let n=0;n<t.length;n++){const s=t[n].door,r=new u.ElementDoor(!0);e.addElement(r,s[0],s[1])}}fillUnusedAreas(e,t){const n=e.getMap(),s=[c.ELEM.GRASS,c.ELEM.TREE,c.ELEM.WATER];t.forEach(e=>{const t=h.arrayGetRand(s);let{w:r,h:a}=e;const{x:o,y:i}=e;r-=2,a-=2;for(let e=o;e<=o+r;e++)for(let s=i;s<=i+a;s++)n.setBaseElemXY(e,s,t)})}populateCityLevel(e,t){let n=e.getExtras().houses;const s=new a.DungeonPopulate(t),r=s.createShops(e,t);n=n.filter(e=>r.indexOf(e)<0);const o=s.createTrainers(e,t);n=n.filter(e=>o.indexOf(e)<0),e.addExtras("houses",n),this.createTownsfolk(e,t)}createTownsfolk(e,t){const n=new a.DungeonPopulate(t);e.getExtras().houses.forEach(s=>{n.populateHouse(e,s,t)})}createCitySurroundings(e,t){const n=new o.LevelSurroundings,s=n.surround(e,t);return s.setExtras(e.getExtras()),n.scaleExtras(s),s}}t.CityGenerator=d,d.options={village:{actorsPerLevel:30,maxDanger:3,itemsPerLevels:6},capital:{},stronghold:{},fort:{}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=s(n(23)),i=r(n(15)),l=n(59),c=n(26),u=n(22),h=n(68),d=n(108),p=n(139),f=n(46),m=n(54),g=n(9),y=n(12),v=g.Random.getRNG(),_=o.default.Map.Feature.Room;class b extends l.LevelGenerator{static getOptions(){const e=l.LevelGenerator.getOptions();return e.centralCorridors=!1,e.roomCount=-1,e}constructor(){super(),this.addDoors=!0,this.shouldRemoveMarkers=!0,this.nItemsAdded=0}create(e,t,n){const s=this.createLevel(e,t,n);return this.removeMarkers(s,n),n.addItems&&(this.nItemsAdded=this.addItemsToCastle(s,n)),this.populateStoreRooms(s,n),n.addActors&&a.default.err("CastleGenerator","create","addActors == true not supported yet"),s}createLevel(e,t,n){const s=Object.assign({dungeonType:"castle",wallType:"wallcastle"},n);s.preserveMarkers=!0;const r=new c.MapGenerator,o=function(e){if(e.cellsAround){const{cellsAround:t}=e,n=[];if(w(t.N)||n.push(d.Castle.startRoomFuncNorth),w(t.S)||n.push(d.Castle.startRoomFuncSouth),w(t.E)||n.push(d.Castle.startRoomFuncEast),w(t.W)||n.push(d.Castle.startRoomFuncWest),w(t.NE)||n.push(d.Castle.startRoomFuncNorthEast),w(t.NW)||n.push(d.Castle.startRoomFuncNorthWest),w(t.SE)||n.push(d.Castle.startRoomFuncSouthEast),w(t.SW)||n.push(d.Castle.startRoomFuncSouthWest),0!==n.length)return v.arrayGetRand(n);a.default.warn("CastleGenerator","getGateDirFunction","No free cellsAround "+JSON.stringify(t))}return null}(n);o&&(s.startRoomFunc=o),n.centralCorridors&&(s.constraintFunc=d.Castle.constraintFuncCross);const i=r.createCastle(e,t,s);let l=new u.Level;return l.setMap(i.map,i),this.addMarkersFromTiles(l,i.tiles),n.cellsAround&&(l=this.createCastleSurroundings(l,n)),this.createDoorsAndLevers(l),l}addItemsToCastle(e,t){let n=0;const s=e.getExtras(),r=s.storeroom,{maxValue:o}=t,i={func:e=>e.value<=2*o&&e.value>=o,maxValue:o,nItems:1},l=new f.FactoryItem;if(r.forEach(t=>{const s=l.generateItems(i);m.Placer.addPropsToRoom(e,t,s)&&(n+=s.length)}),a.default.isSuccess(E)){const t=v.arrayGetRand(r),s=v.getUniformInt(6,12),a=l.generateGold({nGold:5,nLevel:s});m.Placer.addPropsToRoom(e,t,a)&&(n+=a.length)}const c=s.room;return i.nItems=c.length,l.generateItems(i).forEach(t=>{const s=v.arrayGetRand(c);m.Placer.addPropsToRoom(e,s,[t])&&(n+=1)}),n}addMarkersFromTiles(e,t){e.setExtras({corridor:[],entrance:[],room:[],storeroom:[],vault:[]}),Object.values(t).forEach(t=>{S.storeroom.test(t.name)?this.addToExtras(e,t,"storeroom"):S.vault.test(t.name)?this.addToExtras(e,t,"vault"):S.entrance.test(t.name)?this.addToExtras(e,t,"entrance"):S.corridor.test(t.name)?this.addToExtras(e,t,"corridor"):S.filler.test(t.name)||this.addToExtras(e,t,"room")})}addToExtras(e,t,n){const s=y.Geometry.convertBbox(t);e.getMap().getFreeInBbox(s).forEach(t=>{const[s,r]=t.getXY(),a=new i.ElementMarker(C[n]);a.setTag(n),e.addElement(a,s,r)});const r=new _(s.ulx,s.uly,s.lrx,s.lry);e.getExtras()[n].push(r)}createDoorsAndLevers(e){const t=e.getMap(),n=t.getCells(),s={},r=[];n.forEach(n=>{if(n.hasElements()){const[o,l]=n.getXY();if(n.hasMarker("leverdoor")){const r=new i.ElementLeverDoor;t.getCell(o,l).removeProps(a.default.TYPE_ELEM),e.addElement(r,o,l),s[n.getKeyXY()]=r}else if(n.hasMarker("lever")){const n=new i.ElementLever;t.getCell(o,l).removeProps(a.default.TYPE_ELEM),e.addElement(n,o,l),r.push(n)}else if(n.hasMarker("door")){const n=new i.ElementDoor(!0);t.getCell(o,l).removeProps(a.default.TYPE_ELEM),e.addElement(n,o,l)}}}),r.forEach(e=>{const[n,r]=e.getXY();y.Geometry.getBoxAround(n,r,1).forEach(o=>{const i=o[0]+","+o[1];if(s[i]){let s=t.getCell(o[0],o[1]).getPropType("leverdoor");s?s=s[0]:a.default.err("CastleGenerator","createDoorsAndLevers",`No door found for lever@${n},${r}`),e.addTarget(s)}})})}populateStoreRooms(e,t){const n=new h.DungeonPopulate;t.actorFunc&&n.setActorFunc(t.actorFunc);const s=t.maxDanger,r=e.getExtras();if(r.storeroom){const a=r.storeroom;a.forEach(t=>{const r=t.getCenter();n.addPointGuardian(e,r,s)});const o=v.arrayGetRand(a).getCenter();n.addMainLoot(e,o,t.maxValue)&&n.addPointGuardian(e,o,s+4)}}createCastleSurroundings(e,t){const n=new p.LevelSurroundings,s=e.getExtras(),r=n.surround(e,t);return r.setExtras(s),n.scaleExtras(r),r}}t.CastleGenerator=b,a.default.extend2(b,l.LevelGenerator);const E=.1,S={corridor:/(corridor|corner)/,entrance:/entrance/,storeroom:/storeroom/,vault:/vault/,filler:/filler/i},C={corridor:"C",room:"R",entrance:"E",storeroom:"S",vault:"V"};function w(e){switch(e){case"wallmount":return!0;default:return!1}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(9),o=n(96),i=a.Random.getRNG(),l={seed:0,difficulty:"Medium",items:"Medium",monsters:"Medium",worldSize:"Medium",areaSize:"Medium",climate:"Medium",elevation:"Medium",mountainSize:"Medium",excavation:"Medium",dungeonSize:"Medium",forestation:"Medium",population:"Medium",citySize:"Medium",size:"Medium",water:"Sparse"},c={Small:1,Medium:2,Large:4,Huge:8},u={Small:.7,Medium:1,High:1.3,Huge:1.7},h={Small:{x:3,y:3},Medium:{x:5,y:5},Large:{x:5,y:7},Huge:{x:7,y:9}};t.WorldConf={},t.WorldConf.featCoeff=.3;const d=(e,t)=>i.getUniformInt(e,t);t.WorldConf.getBaseConf=(e=>{let n=null;switch(e){case"branch":n=t.WorldConf.createSingleBranchConf();break;case"city":n={name:"city",nQuarters:1,quarter:[t.WorldConf.createSingleQuarterConf()]};break;case"dungeon":n={name:"dungeon",nBranches:1,branch:[t.WorldConf.createSingleBranchConf()]};break;case"face":n=t.WorldConf.createSingleFaceConf();break;case"mountain":n={name:"mountain",nFaces:1,face:[t.WorldConf.createSingleFaceConf()]};break;case"quarter":n=t.WorldConf.createSingleQuarterConf();break;default:console.log("No legal featureType given")}return n}),t.WorldConf.createQuarterConnections=(e=>{if(1===e.length)return null;const t=[];for(let n=1;n<e.length;n++){const s=e[n-1],a=e[n];let o=i.getWeightedLinear(s.nLevels-1);const l=0;r.default.isNullOrUndef([o])&&(o=s.nLevels-1);const c=[s.name,a.name,o,l];t.push(c)}return t}),t.WorldConf.createFaceConnections=((e,t)=>{if(1===t.length)return null;const n=[];for(let e=1;e<t.length;e++){const s=t[e-1],a=t[e];let o=i.getWeightedLinear(s.nLevels-1);const l=0;r.default.isNullOrUndef([o])&&(o=s.nLevels-1);const c=[s.name,a.name,o,l];n.push(c)}return n}),t.WorldConf.createBranchConnections=((e,t)=>{if(1===t.length)return null;const n=[];for(let e=1;e<t.length;e++){const s=t[e-1],a=t[e];let o=i.getWeightedLinear(s.nLevels-1);const l=0;r.default.isNullOrUndef([o])&&(o=s.nLevels-1);const c=[s.name,a.name,o,l];n.push(c)}return n}),t.WorldConf.setDistFromStart=((e,t)=>{const n=Math.floor(t.maxX/2),s=t.maxY;e.distX=Math.abs(e.x-n),e.distY=Math.abs(e.y-s),e.distSqr=Math.sqrt(Math.pow(e.distX,2)+Math.pow(e.distY,2))}),t.WorldConf.getPlayerStart=((e,t)=>{const n=e.maxY-1,s=Math.floor(e.maxX/2);return{place:t.name,x:s,y:n}}),t.WorldConf.getXYInArea=(e=>({x:d(0,e.maxX-1),y:d(0,e.maxY-1)})),t.WorldConf.getNumBranches=((e,t)=>{switch(t.dungeonSize){case"Small":return 1;case"Medium":return d(1,2);case"Large":return d(1,3);case"Huge":return d(1,4);default:return 1}}),t.WorldConf.getNumQuarters=((e,t)=>{switch(t.citySize){case"Small":return 1;case"Medium":return d(1,2);case"Large":return d(1,3);case"Huge":return d(1,4);default:return 1}}),t.WorldConf.getNumFaces=((e,t)=>{switch(t.mountainSize){case"Small":return 1;case"Medium":return d(1,2);case"Large":return d(1,3);case"Huge":return d(1,4);default:return 1}}),t.WorldConf.getNumLevels=(e=>{switch(e){case"dungeon":return d(1,10);case"city":case"mountain":return d(1,3);default:return 1}}),t.WorldConf.scaleNumFeatures=((e,t)=>{switch(e){case"dungeon":return u[t.excavation];case"mountain":return u[t.elevation];case"city":return u[t.population];default:r.default.err("Creator","scaleNumFeatures",`Unknown feat type ${e}`)}return 1}),t.WorldConf.getNumFeatures=((e,n,s)=>{let r=(n.maxX+1)*(n.maxY+1);return r=Math.ceil(r*t.WorldConf.scaleNumFeatures(e,s)),r=i.getNormal(r,t.WorldConf.featCoeff*r)}),t.WorldConf.createDungeonsConf=((e,n)=>{const s=t.WorldConf.getNumFeatures("dungeon",e,n),r=[];for(let a=0;a<s;a++){const s=t.WorldConf.createSingleDungeonConf(e,n);r.push(s)}return r}),t.WorldConf.createSingleDungeonConf=((e,n)=>{const s=t.WorldConf.getXYInArea(e),r=Object.assign({},e);r.x=s.x,r.y=s.y,t.WorldConf.setDistFromStart(r,e);const a=t.WorldConf.createBranchesConf(r,n),i=t.WorldConf.createBranchConnections("branch",a),l={name:o.Names.getGenericPlaceName("dungeon"),x:s.x,y:s.y,nBranches:a.length,branch:a};return i&&(l.connectLevels=i),l}),t.WorldConf.createBranchesConf=((e,n)=>{const s=t.WorldConf.getNumBranches(e,n),r=[];for(let e=0;e<s;e++){const n=t.WorldConf.createSingleBranchConf();r.push(n),0===e&&(n.entranceLevel=0)}return r}),t.WorldConf.createSingleBranchConf=(()=>{const e=t.WorldConf.getNumLevels("dungeon");return{dungeonX:80,dungeonY:28,sqrPerItem:40,sqrPerActor:40,maxDanger:2,maxValue:100,dungeonType:"digger",name:o.Names.getGenericPlaceName("branch"),nLevels:e}}),t.WorldConf.createSingleQuarterConf=(()=>{return{nLevels:t.WorldConf.getNumLevels("city"),name:o.Names.getGenericPlaceName("quarter")}}),t.WorldConf.createSingleFaceConf=(()=>{const e=t.WorldConf.getNumLevels("mountain");return{x:100,y:200,name:o.Names.getGenericPlaceName("face"),nLevels:e}});class p{constructor(){this.nCreated={}}createWorldConf(e){e.name||r.default.err("Creator","createWorldConf","conf.name must be specified."),Object.keys(l).forEach(t=>{e.hasOwnProperty(t)||(e[t]=l[t])}),this.rand=new a.Random,this.rand.setSeed(e.seed);const n=this.createAreasConf(e),s=t.WorldConf.getPlayerStart(n[0],e);return{name:e.name,nAreas:n.length,area:n,playerStart:s}}createAreasConf(e){const t=c[e.worldSize],n=[];for(let s=0;s<t;s++){const t=this.createSingleAreaConf(s,e);n.push(t)}return n}createSingleAreaConf(e,n){const s=h[n.areaSize],a=n.maxX||s.x,o=n.maxY||s.y,i={maxX:a,maxY:o,areaNum:e},l=t.WorldConf.createDungeonsConf(i,n),c=this.createCitiesConf(i,n),u=this.createMountainsConf(i,n);return{name:this.getName("area"),cols:r.default.AREA_LEVEL_COLS,rows:r.default.AREA_LEVEL_ROWS,maxX:a,maxY:o,nDungeons:l.length,nCities:c.length,nMountains:u.length,dungeon:l,city:c,mountain:u}}createCitiesConf(e,n){const s=t.WorldConf.getNumFeatures("city",e,n),r=[];for(let t=0;t<s;t++){const t=this.createSingleCityConf(e,n);r.push(t)}return r}createSingleCityConf(e,n){const s=t.WorldConf.getXYInArea(e),r=Object.assign({},e);r.x=s.x,r.y=s.y,t.WorldConf.setDistFromStart(r,e);const a=this.createQuartersConf(r,n),o=t.WorldConf.createQuarterConnections(a),i={name:"",x:s.x,y:s.y,nQuarters:a.length,quarter:a};return o&&(i.connectLevels=o),i}createQuartersConf(e,n){const s=t.WorldConf.getNumQuarters(e,n),r=[];for(let e=0;e<s;e++){const n=t.WorldConf.createSingleQuarterConf();0===e&&(n.entranceLevel=0),r.push(n)}return r}createMountainsConf(e,n){const s=t.WorldConf.getNumFeatures("mountain",e,n),r=[];for(let t=0;t<s;t++){const t=this.createSingleMountainConf(e,n);r.push(t)}return r}createSingleMountainConf(e,n){const s=t.WorldConf.getXYInArea(e),r=Object.assign({},e);r.x=s.x,r.y=s.y,t.WorldConf.setDistFromStart(r,e);const a=this.createFacesConf(r,n),o=t.WorldConf.createFaceConnections("mountain",a),i={name:"",x:s.x,y:s.y,nFaces:a.length,face:a};return o&&(i.connectLevels=o),i}createFacesConf(e,n){const s=t.WorldConf.getNumFaces(e,n),r=[];for(let e=0;e<s;e++){const n=t.WorldConf.createSingleFaceConf();r.push(n),0===e&&(n.entranceLevel=0)}return r}getName(e){return this.nCreated.hasOwnProperty(e)||(this.nCreated[e]=0),this.nCreated[e]+=1,`${e} ${this.nCreated[e]}`}}t.WorldCreator=p,t.WorldConf.Creator=p},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8));t.OW={},t.OW.LL_WE="═",t.OW.LL_NS="║",t.OW.CC_NW="╔",t.OW.CC_NE="╗",t.OW.CC_SW="╚",t.OW.CC_SE="╝",t.OW.XX="╬",t.OW.EMPTY="e",t.OW.TT_W="╠",t.OW.TT_E="╣",t.OW.TT_N="╦",t.OW.TT_S="╩",t.OW.TERM=".",t.OW.WCAPITAL="♔",t.OW.BCAPITAL="♚",t.OW.BTOWER="♜",t.OW.WTOWER="♖",t.OW.WDUNGEON="☖",t.OW.MOUNTAIN="^",t.OW.BVILLAGE="▲",t.OW.WVILLAGE="△",t.OW.VTUNNEL="|",t.OW.HTUNNEL="-",t.OW.MFORT="⟎",t.OW.PROB_BVILLAGE=.25,t.OW.biomeTypeMap={arctic:0,alpine:1,tundra:2,taiga:3,forest:4,grassland:5};const a=r.default.cellStyles.elements;t.OW.classNames={[t.OW.TERM]:a.floor,[t.OW.MOUNTAIN]:a.highrock,[t.OW.LL_WE]:a.mountain,[t.OW.LL_NS]:a.mountain,[t.OW.CC_NW]:a.mountain,[t.OW.CC_NE]:a.mountain,[t.OW.CC_SW]:a.mountain,[t.OW.CC_SE]:a.mountain,[t.OW.XX]:a.mountain,[t.OW.TT_W]:a.mountain,[t.OW.TT_E]:a.mountain,[t.OW.TT_N]:a.mountain,[t.OW.TT_S]:a.mountain,default:"cell-element-ow"},t.OW.BIOME={},t.OW.BIOME.ALPINE="alpine",t.OW.BIOME.ARCTIC="arctic",t.OW.BIOME.TUNDRA="tundra",t.OW.BIOME.TAIGA="taiga",t.OW.ILLEGAL_POS=-1,t.OW.CELL_ANY="OW.CELL_ANY",t.OW.E_HAS_CONN=[t.OW.XX,t.OW.TT_W,t.OW.TT_N,t.OW.TT_S,t.OW.CC_NW,t.OW.CC_SW,t.OW.LL_WE],t.OW.W_HAS_CONN=[t.OW.XX,t.OW.TT_E,t.OW.TT_N,t.OW.TT_S,t.OW.CC_NE,t.OW.CC_SE,t.OW.LL_WE],t.OW.N_HAS_CONN=[t.OW.XX,t.OW.TT_S,t.OW.TT_W,t.OW.TT_E,t.OW.CC_SW,t.OW.CC_SE,t.OW.LL_NS],t.OW.S_HAS_CONN=[t.OW.XX,t.OW.TT_N,t.OW.TT_W,t.OW.TT_E,t.OW.CC_NW,t.OW.CC_NE,t.OW.LL_NS],t.OW.N_BORDER=[t.OW.LL_WE,t.OW.TT_N],t.OW.S_BORDER=[t.OW.LL_WE,t.OW.TT_S],t.OW.E_BORDER=[t.OW.LL_NS,t.OW.TT_E],t.OW.W_BORDER=[t.OW.LL_NS,t.OW.TT_W],t.OW.ALL_WALLS=[t.OW.XX,t.OW.TT_N,t.OW.TT_S,t.OW.TT_E,t.OW.TT_W,t.OW.CC_SW,t.OW.CC_NW,t.OW.CC_SE,t.OW.CC_NE,t.OW.LL_WE,t.OW.LL_NS],t.OW.ALL_WALLS_LUT={},t.OW.ALL_WALLS.forEach(e=>{t.OW.ALL_WALLS_LUT[e]=e}),t.OW.LINE_WE_WEIGHT={[t.OW.LL_WE]:10,[t.OW.TT_N]:3,[t.OW.TT_S]:3,[t.OW.XX]:1},t.OW.LINE_NS_WEIGHT={[t.OW.LL_NS]:10,[t.OW.TT_E]:3,[t.OW.TT_W]:3,[t.OW.XX]:1},t.OW.CAN_CONNECT={[t.OW.LL_WE]:{N:[],S:[],E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.LL_NS]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:[],W:[]},[t.OW.CC_NW]:{N:t.OW.N_HAS_CONN,S:[],E:[],W:t.OW.W_HAS_CONN},[t.OW.CC_NE]:{N:t.OW.N_HAS_CONN,S:[],E:t.OW.E_HAS_CONN,W:[]},[t.OW.CC_SW]:{N:[],S:t.OW.S_HAS_CONN,E:[],W:t.OW.W_HAS_CONN},[t.OW.CC_SE]:{N:[],S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:[]},[t.OW.XX]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.EMPTY]:{N:[],S:[],E:[],W:[]},[t.OW.TT_W]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:[],W:t.OW.W_HAS_CONN},[t.OW.TT_E]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:[]},[t.OW.TT_N]:{N:t.OW.N_HAS_CONN,S:[],E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.TT_S]:{N:[],S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.TERM]:{N:[],S:[],E:[],W:[]}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(52),i=n(224),l=n(18),c=n(422),u=n(424),h=n(104),d=n(60),p=n(9),f=n(12),m=n(223),g=r(n(11)),y=r(n(41)),v=n(30),_=n(14),b=l.EventPool.getPool();t.Game={},t.GameMain=function(){this._players=[],this._places={},this._shownLevel=null,this._gameOver=!1,this.actorsKilled={},this._enableChunkUnload=!1,this._chunkManager=null,this._eventPool=b,b.reset(),this.currPlaceIndex=0,this._rng=new p.Random,this._engine=new c.Engine(this._eventPool),this._master=new u.GameMaster(this,this._eventPool),this._worldSim=new m.WorldSimulation(this._eventPool),this._engine.addRegularUpdate(this._worldSim),this.visibleCells=[],this.globalConf={},this.setGlobalConf=(e=>{this.globalConf=e}),this.getGlobalConf=(()=>this.globalConf),this.shownLevel=(()=>this._shownLevel),this.setShownLevel=(e=>{this._shownLevel=e}),this.getPool=(()=>this._eventPool),this.setGUICallbacks=((e,t)=>{this._engine.isGUICommand=e,this._engine.doGUICommand=t;const n=this.getPlayer();n&&n.getBrain().addGUICallback("GOTO",t)}),this.setRNG=(e=>{this._rng=e,p.Random.setRNG(this._rng)}),this.playerCommandCallback=(e=>{this.visibleCells=e.getBrain().getSeenCells(),this._engine.setVisibleArea(this.shownLevel(),this.visibleCells)}),this._engine.playerCommandCallback=this.playerCommandCallback.bind(this),this.isGameOver=(()=>this._gameOver),this._engine.isGameOver=this.isGameOver,this.getLevels=(()=>this._engine.getLevels()),this.getComponents=(()=>this._engine.getComponents()),this.getPlaces=(()=>this._places),this.getLevelsInAllPlaces=(()=>{let e=[];return Object.values(this._places).forEach(t=>{e=e.concat(t.getLevels())}),e}),this.setEnableChunkUnload=((e=!0)=>{if(this._enableChunkUnload=e,e&&this.getArea(0)){const e=this.getArea(0);this._chunkManager=new i.ChunkManager(this,e)}}),this.getPlayer=(()=>this._engine.getPlayer()),this.addPlayer=((n,s)=>{let r=!1;return this._master.setPlayer(n),(r=!a.default.isNullOrUndef([n.getLevel()])||(a.default.isNullOrUndef([s])?e(n,this.getLevels()):t(n,s)))&&(this._engine.nextActor=n,this._engine.setPlayer(n),null===this._shownLevel&&(this._shownLevel=n.getLevel()),this._players.push(n),this._engine.addActiveLevel(n.getLevel()),n.getLevel().onEnter(),n.getLevel().onFirstEnter()),r&&this._gameOver&&(this._gameOver=!1),r}),this.useAsPlayer=(e=>{let t=e;Number.isInteger(e)&&(t=a.default.ent(e)),t||(t=a.default.CLICKED_ACTOR),t.setIsPlayer(!0),t.add(new g.Player),this.addPlayer(t)}),this.movePlayer=((e,t,n=0,s=0)=>{const r=this.getPlayer(),o=this.getCurrentWorld().getAreas()[0];let i=null;this._enableChunkUnload?this._chunkManager.isLoaded(e,t)?i=o.getTileXY(e,t):(this._chunkManager.setPlayerTile(e,t),i=o.getTileXY(e,t)):i=o.getTileXY(e,t);const l=i.getLevel(),c=r.getLevel(),[u,h]=[r.getX(),r.getY()];c.removeActor(r)?l.addActor(r,n,s)?(b.emitEvent(a.default.EVT_LEVEL_CHANGED,{target:l,src:c,actor:r}),b.emitEvent(a.default.EVT_LEVEL_ENTERED,{actor:r,target:l})):l.addActorToFreeCell(r)?(b.emitEvent(a.default.EVT_LEVEL_CHANGED,{target:l,src:c,actor:r}),b.emitEvent(a.default.EVT_LEVEL_ENTERED,{actor:r,target:l})):c.addActor(r,u,h):console.error("Could not remove player from level")});const e=(e,t)=>{let n=!1;return t.length>0?(n=t[0].addActorToFreeCell(e))?this.checkIfTileChanged({actor:e,src:null,target:t[0]}):a.default.err("Game","addPlayer","Failed to add the player."):a.default.err("Game","addPlayer","No levels exist. Cannot add player."),n},t=(t,n)=>{if(n.hasOwnProperty("place")){const s=n.place;if(this._places.hasOwnProperty(s)){if(n.hasOwnProperty("x")&&n.hasOwnProperty("y")){const r=[this._places[s].getAreas()[0].getTileXY(n.x,n.y).getLevel()];return e(t,r)}{const n=this._places[s].getLevels();return e(t,n)}}a.default.err("GameMain","_addPlayerToPlace","No place |"+s+"| found.")}else a.default.err("GameMain","_addPlayerToPlace","obj.place must exist.");return!1};this.checkIfTileChanged=(e=>{const{actor:t,src:n,target:s}=e,r=[s];a.default.isNullOrUndef([n])||r.push(n);const o=this.getArea(0);o&&2===r.length&&o.hasTiles(r)&&b.emitEvent(a.default.EVT_TILE_CHANGED,{actor:t,target:s,src:n})}),this.isTileLevel=(e=>{return this.getArea(0).hasTiles([e])}),this.checkIfExploredZoneLeft=(e=>{const{actor:t,src:n,target:s}=e;let r=!1;if(t.has("GameInfo")&&n&&s){const e=n.getParent();if(e)if(e.getID){const n=e.getID();t.get("GameInfo").hasZone(n)&&(r=this.isTileLevel(s))}else a.default.warn("GameMain","checkIfExploredZoneLeft","No getID: "+JSON.stringify(e))}r&&b.emitEvent(a.default.EVT_EXPLORED_ZONE_LEFT,{actor:t,target:s,src:n})}),this.getMessages=(()=>this._engine.getMessages()),this.clearMessages=(()=>{this._engine.clearMessages()}),this.hasNewMessages=(()=>this._engine.hasNewMessages()),this.addActor=(e=>{this._engine.addActor(e)}),this.removeActor=(e=>{this._engine.removeActor(e)}),this.addEvent=(e=>{this._engine.addEvent(e)}),this.addActiveLevel=(e=>{this._engine.addActiveLevel(e)}),this.addLevel=(e=>{this._engine.hasLevel(e)?this.errorDuplicateLevel("addLevel",e):this._engine.addLevel(e)}),this.addLevelUnlessExists=(e=>{this._engine.hasLevel(e)||this._engine.addLevel(e)}),this.removeLevels=(e=>{this._engine.removeLevels(e)}),this.addPlace=(e=>{if("function"==typeof e.getLevels){const t=e.getName();if(this._places.hasOwnProperty(t))a.default.err("GameMain","addPlace","A place |"+t+"| exists.");else{const n=e.getLevels();if(n.length>0)for(const e of n)this.addLevel(e);else a.default.err("GameMain","addPlace",`Place ${t} has no levels!`);if(this._places[t]=e,this.getArea(0)){const e=this.getCurrentWorld().getCurrentArea();this._enableChunkUnload&&!this._chunkManager&&(this._chunkManager=new i.ChunkManager(this,e))}}}else a.default.err("GameMain","addPlace","Added place must have getLevels()")}),this.hasPlaces=(()=>Object.keys(this._places).length>0),this.getVisibleMap=(()=>{return this.getPlayer().getLevel().getMap()}),this.simulate=((e=1)=>{this._engine.simulateGame(e)}),this.simulateGame=((e=1)=>{this._engine.simulateGame(e)}),this.update=(e=>{this._engine.update(e)}),this.getArea=(e=>{const t=this.getCurrentWorld();return t&&"function"==typeof t.getAreas?t.getAreas()[e]:null}),this.hasNotify=!0,this.notify=((e,t)=>{if(e===a.default.EVT_ACTOR_KILLED){if(this.actorsKilled[t.actor.getID()]=!0,t.actor.isPlayer()){const{actor:e}=t,n=this._players.indexOf(e);n>=0&&(1===this._players.length&&(this._gameOver=!0,console.log("PLAYER DIED!!"),a.default.gameMsg("GAME OVER!")),this._players.splice(n,1))}}else if(e===a.default.EVT_LEVEL_CHANGED){const{actor:e}=t;e.isPlayer()&&(this._shownLevel=e.getLevel(),this._worldSim.setLevel(this._shownLevel),this._overworld&&this._worldSim.setOwPos(this.getPlayerOwPos()),this.checkIfTileChanged(t),this.checkIfExploredZoneLeft(t))}else if(e===a.default.EVT_TILE_CHANGED){const{actor:e,target:n}=t;if(e.isPlayer()){const e=n.getID(),s=this.getCurrentWorld();if(s&&s.getAreas){const n=s.getAreas()[0],[r,a]=n.findTileXYById(e),o=new d.FactoryWorld;o.setGlobalConf(this.getGlobalConf());let i=null,l=null;if(t.src){const e=n.findTileXYById(t.src.getID());e&&([i,l]=e)}this._enableChunkUnload&&this._chunkManager.setPlayerTile(r,a,i,l),o.createZonesForTile(s,n,r,a),s.getLevels().forEach(e=>{this.addLevelUnlessExists(e)})}}}}),this._eventPool.listenEvent(a.default.EVT_ACTOR_KILLED,this),this._eventPool.listenEvent(a.default.EVT_LEVEL_CHANGED,this),this._eventPool.listenEvent(a.default.EVT_TILE_CHANGED,this),this.addBattle=((e,t=-1,n=!1)=>{const s=e.getLevel();this.addLevel(s),n&&this._engine.addActiveLevel(s),this.hasPlaces()&&t>-1&&this._addBattleZoneToArea(e,t)}),this._addBattleZoneToArea=((e,t)=>{const n=e.getLevel(),s="Zone of "+e.getName(),r=new y.BattleZone(s);r.addLevel(n);const o=this.getCurrentWorld().getAreas()[0],i=o.findTileXYById(t);i?(r.setTileXY(i[0],i[1]),o.addZone("BattleZone",r)):a.default.err("GameMain","_addBattleZoneToArea",`ID ${t} not found in area.`)}),this.getChunkManager=(()=>this._chunkManager),this.getGameMaster=(()=>this._master),this.setGameMaster=(e=>{this._master=e,this._master.setPlayer(this.getPlayer());const t=Object.values(this._places)[0];this._master.setWorld(t),this._master.setGame(this)}),this.getOverWorld=(()=>this._overworld),this.setOverWorld=(e=>{this._overworld=e,this._worldSim.setOverWorld(e)}),this.setWorldSim=(e=>{e.setPool(this._eventPool),this._worldSim=e}),this.toJSON=(()=>{const e=_.ObjectShell.getParser(),t={engine:{},gameMaster:this._master.toJSON(),gameObjectID:h.GameObject.ID,lastComponentID:g.getIDCount(),globalConf:this.globalConf,rng:this._rng.toJSON(),diceRng:v.Dice.RNG.toJSON(),charStyles:a.default.charStyles,cellStyles:a.default.cellStyles,actorsKilled:this.actorsKilled,enableChunkUnload:this._enableChunkUnload,objectShellParser:e.toJSON()};if(this.hasPlaces()){const e={};Object.keys(this._places).forEach(t=>{const n=this._places[t];e[t]=n.toJSON()}),t.places=e}else{const e=[];this._engine.getLevels().forEach(t=>{e.push(t.toJSON())}),t.levels=e,t.places={}}const n=this.getPlayer();return n&&(t.player=n.toJSON()),this._overworld&&(t.overworld=this._overworld.toJSON()),this._chunkManager&&(t.chunkManager=this._chunkManager.toJSON()),this._worldSim&&(t.worldSim=this._worldSim.toJSON()),t}),this.isMenuShown=(()=>this._engine.isMenuShown()),this.getMenu=(()=>{const e=this.getPlayer();return e?e.getBrain().getMenu():null}),this.setAnimationCallback=(e=>{"function"==typeof e?this._engine.animationCallback=e:a.default.warn("GameMain","setAnimationCallback","Callback must be a function.")}),this.hasAnimation=(()=>this._engine.hasAnimation()),this.finishAnimation=(()=>this._engine.finishAnimation()),this.getAnimationFrame=(()=>this._engine.animation.nextFrame()),this.enableAnimations=(()=>{this._engine.enableAnimations()}),this.disableAnimations=(()=>{this._engine.disableAnimations()}),this.getPlayerOwPos=(()=>{const e=this.getPlayer();if(!this._overworld||!e)return null;const t=this._overworld;let n=this.getCurrentWorld().getAreas()[0].findTileXYById(e.getLevel().getID());if(!n&&!(n=this.tryToGetTileXY()))return null;const{xMap:s,yMap:r}=t.coordMap,a=100*n[0]+e.getX(),o=100*n[1]+e.getY();return[Math.floor(a/s),Math.floor(o/r)]}),this.tryToGetTileXY=(()=>{let e=this.getPlayer().getLevel().getParent();for(;e;)if((e=e.getParent?e.getParent():null)&&e.getTileXY)return e.getTileXY();return null}),this.setOverWorldExplored=(e=>{f.Geometry.getBoxAround(e[0],e[1],1,!0).forEach(e=>{this._overworld.setExplored(e)})}),this.getCurrentWorld=(()=>{const e=Object.values(this.getPlaces());return e.length>this.currPlaceIndex?e[this.currPlaceIndex]:null}),this.find=((e,t=-1,n="find")=>{const s=this._engine.getLevels();if(-1===t){return this.getPlayer().getLevel().getActors()[n](e)}if(Number.isInteger(t)){const r=s.find(e=>e.getID()===t);if(r)return r.getActors()[n](e)}else for(const t of s){const s=t.getActors()[n](e);if(s)return s}return null}),this.errorDuplicateLevel=((e,t)=>{const n=t.getParent(),s=t.toJSON();delete s.elements,delete s.map.cells;let r="";if(n){r=`Parent: ${a.default.formatLocationName(t)}| `}r+="Duplicate level ID "+t.getID(),r+=" JSON: "+JSON.stringify(s,null,1),a.default.err("GameMain",e,r)}),this.entityPrint=(()=>{a.default.diag(o.Entity.num)})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,a.default)();try{return e.activeElement}catch(e){}};var s,r=n(38),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=o(n(343)),r=o(n(354)),a="function"==typeof r.default&&"symbol"==typeof s.default?function(e){return typeof e}:function(e){return e&&"function"==typeof r.default&&e.constructor===r.default&&e!==r.default.prototype?"symbol":typeof e};function o(e){return e&&e.__esModule?e:{default:e}}t.default="function"==typeof r.default&&"symbol"===a(s.default)?function(e){return void 0===e?"undefined":a(e)}:function(e){return e&&"function"==typeof r.default&&e.constructor===r.default&&e!==r.default.prototype?"symbol":void 0===e?"undefined":a(e)}},function(e,t,n){"use strict";t.__esModule=!0,t.EXITING=t.ENTERED=t.ENTERING=t.EXITED=t.UNMOUNTED=void 0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=u(n(3)),a=u(n(82)),o=u(n(175)),i=u(n(0)),l=u(n(1)),c=u(n(13));function u(e){return e&&e.__esModule?e:{default:e}}var h=o.default.end,d=t.UNMOUNTED=0,p=t.EXITED=1,f=t.ENTERING=2,m=t.ENTERED=3,g=t.EXITING=4,y=function(e){function t(n,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.call(this,n,s));r.updateStatus=function(){if(null!==r.nextStatus){r.cancelNextCallback();var e=c.default.findDOMNode(r);r.nextStatus===f?(r.props.onEnter(e),r.safeSetState({status:f},function(){r.props.onEntering(e),r.onTransitionEnd(e,function(){r.safeSetState({status:m},function(){r.props.onEntered(e)})})})):(r.props.onExit(e),r.safeSetState({status:g},function(){r.props.onExiting(e),r.onTransitionEnd(e,function(){r.safeSetState({status:p},function(){r.props.onExited(e)})})})),r.nextStatus=null}else r.props.unmountOnExit&&r.state.status===p&&r.setState({status:d})},r.cancelNextCallback=function(){null!==r.nextCallback&&(r.nextCallback.cancel(),r.nextCallback=null)},r.safeSetState=function(e,t){r.setState(e,r.setNextCallback(t))},r.setNextCallback=function(e){var t=!0;return r.nextCallback=function(n){t&&(t=!1,r.nextCallback=null,e(n))},r.nextCallback.cancel=function(){t=!1},r.nextCallback},r.onTransitionEnd=function(e,t){r.setNextCallback(t),e?((0,a.default)(e,h,r.nextCallback),setTimeout(r.nextCallback,r.props.timeout)):setTimeout(r.nextCallback,0)};var o=void 0;return r.nextStatus=null,n.in?n.transitionAppear?(o=p,r.nextStatus=f):o=m:o=n.unmountOnExit||n.mountOnEnter?d:p,r.state={status:o},r.nextCallback=null,r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this.updateStatus()},t.prototype.componentWillReceiveProps=function(e){var t=this.state.status;e.in?(t===d&&this.setState({status:p}),t!==f&&t!==m&&(this.nextStatus=f)):t!==f&&t!==m||(this.nextStatus=g)},t.prototype.componentDidUpdate=function(){this.updateStatus()},t.prototype.componentWillUnmount=function(){this.cancelNextCallback()},t.prototype.render=function(){var e=this.state.status;if(e===d)return null;var n=this.props,a=n.children,o=n.className,i=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(n,["children","className"]);Object.keys(t.propTypes).forEach(function(e){return delete i[e]});var c=void 0;e===p?c=this.props.exitedClassName:e===f?c=this.props.enteringClassName:e===m?c=this.props.enteredClassName:e===g&&(c=this.props.exitingClassName);var u=l.default.Children.only(a);return l.default.cloneElement(u,s({},i,{className:(0,r.default)(u.props.className,o,c)}))},t}(l.default.Component);function v(){}y.propTypes={in:i.default.bool,mountOnEnter:i.default.bool,unmountOnExit:i.default.bool,transitionAppear:i.default.bool,timeout:i.default.number,exitedClassName:i.default.string,exitingClassName:i.default.string,enteredClassName:i.default.string,enteringClassName:i.default.string,onEnter:i.default.func,onEntering:i.default.func,onEntered:i.default.func,onExit:i.default.func,onExiting:i.default.func,onExited:i.default.func},y.displayName="Transition",y.defaultProps={in:!1,unmountOnExit:!1,transitionAppear:!1,timeout:5e3,onEnter:v,onEntering:v,onEntered:v,onExit:v,onExiting:v,onExited:v},t.default=y},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t){return e="function"==typeof e?e():e,a.default.findDOMNode(e)||t};var s,r=n(13),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e){return(0,r.default)(s.default.findDOMNode(e))};var s=a(n(13)),r=a(n(38));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=[],o=null;t.Memory=class{constructor(){this._actors={},this._enemyTypes={},this._communications=[],this._lastAttackedID=o}addEnemyType(e){this._enemyTypes[e]=!0}removeEnemyType(e){this._enemyTypes[e]&&delete this._enemyTypes[e]}isEnemy(e){if(this._actors.hasOwnProperty("enemies")&&this._actors.enemies.indexOf(e)>=0)return!0;if(!this.isFriend(e)){if(this._enemyTypes[e.getType()])return!0;if(e.isPlayer())return this._enemyTypes.player}return!1}isFriend(e){return!!this._actors.hasOwnProperty("friends")&&this._actors.friends.indexOf(e)>=0}addFriend(e){this.isEnemy(e)&&this.removeEnemy(e),this._actors.hasOwnProperty("friends")||(this._actors.friends=[]),this.isFriend(e)||this._actors.friends.push(e)}addEnemySeenCell(e){this._actors.seen||(this._actors.seen={}),this._actors.seen[e.getID()]={x:e.getX(),y:e.getY(),level:e.getLevel().getID()}}hasSeen(e){return!(!this._actors.seen||!this._actors.seen[e])}getLastSeen(e){return this._actors.seen[e.getID()]?this._actors.seen[e.getID()]:null}addEnemy(e){if(!r.default.isActor(e)){const t=JSON.stringify(e);r.default.err("Memory","addEnemy","Only actors can be added. Got: "+t)}this.isEnemy(e)||(this.isFriend(e)&&this.removeFriend(e),this._actors.hasOwnProperty("enemies")||(this._actors.enemies=[]),this._actors.enemies.push(e),this._communications.length>0&&(this._communications=[]))}removeEnemy(e){if(this._actors.hasOwnProperty("enemies")){const t=this._actors.enemies.indexOf(e);t>=0&&this._actors.enemies.splice(t,1)}}removeFriend(e){if(this._actors.hasOwnProperty("friends")){const t=this._actors.friends.indexOf(e);t>=0&&this._actors.friends.splice(t,1)}}getEnemyActors(){return this._actors.enemies||a}getFriendActors(){return this._actors.friends||a}copyMemoryFrom(e){const t=e.getBrain().getMemory(),n=t.getEnemyActors().slice();this._actors.enemies=n;const s=t.getFriendActors().slice();this._actors.friends=s,this._enemyTypes=Object.assign({},t._enemyTypes)}addCommunicationWith(e){this.hasCommunicatedWith(e)||this._communications.push(e)}wasLastAttacked(e){return this._lastAttackedID===e.getID()}setLastAttacked(e){this._lastAttackedID=e?e.getID():o}hasCommunicatedWith(e){return-1!==this._communications.indexOf(e)}toJSON(){const e={enemyTypes:Object.keys(this._enemyTypes)};return this._actors.hasOwnProperty("enemies")&&(e.enemies=this._actors.enemies.map(e=>e.getID())),this._actors.hasOwnProperty("friends")&&(e.friends=this._actors.friends.map(e=>e.getID())),this._lastAttackedID>=0&&(e.lastAttackedID=this._lastAttackedID),this._actors.hasOwnProperty("seen")&&(e.seen=this._actors.seen),e}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(43),i=n(28),l=r(n(125)),c=r(n(301)),u=r(n(25)),h=n(9),d=n(12),p=n(65),f=n(123),m=h.Random.getRNG(),g=i.Keys.KeyMap,{ACTION_ALREADY_DONE:y,ACTION_ZERO_ENERGY:v}=c,_='Select a target (all with "A"), then press "s" to choose it',b='Select a target with movement keys, then press "s" to choose it',E=e=>{return a.default.gameMsg("Select direction for chatting:"),{select:t=>{const n={dir:g.getDir(t),src:null};return n.dir?(n.src=e,()=>{const t=new u.Chat;t.setArgs(n),e.add(t)}):null},showMenu:()=>!1}};class S extends f.Memory{constructor(e){super(),this._lastAttackedID=null,this._player=e}setLastAttacked(e){Number.isInteger(e)?this._lastAttackedID=e:e&&(this._lastAttackedID=e.getID())}getLastAttacked(){return this._lastAttackedID}wasLastAttacked(e){return this._lastAttackedID===e.getID()}isEnemy(e){return!e.isPlayer()&&(!e.has("NonSentient")&&e.getBrain().getMemory().isEnemy(this._player))}toJSON(){const e={};return a.default.isNullOrUndef([this._lastAttackedID])||(e.setLastAttacked=this._lastAttackedID),e}}t.MemoryPlayer=S;const C="S_IDLE",w="S_TARGETING",T="S_LOOKING",O=256,M=null;class A{constructor(e){this._brain=e,this._targetList=[],this.targetIndex=-1,this._state=C}getActor(){return this._brain._actor}isTargeting(){return this._state===w}isLooking(){return this._state===T}nextTarget(){this.hasTargets()&&(++this.targetIndex,this.targetIndex>=this._targetList.length&&(this.targetIndex=0),this.setSelectedCells(this._targetList[this.targetIndex]))}prevTarget(){this.hasTargets()&&(--this.targetIndex,this.targetIndex<0&&(this.targetIndex=this._targetList.length-1),this.setSelectedCells(this._targetList[this.targetIndex]))}startLooking(){this._state=T}stopLooking(){this._state=C,this.selectedCells=M}startTargeting(){this._state=w,this._targetList=this.getTargetList(),this.targetIndex=this.getCellIndexToTarget(this._targetList),this.setSelectedCells(this._targetList[this.targetIndex])}cancelTargeting(){this._targetList=[],this._state=C,this.selectedCells=M,this.targetIndex=-1}getTargetList(){const e={},t=this._brain.getSeenCells(),n=this._brain._actor;return a.default.findEnemyCellForActor(n,t).forEach(t=>{e[t.getX()+","+t.getY()]=t}),Object.values(e)}setSelectedCells(e){if(e)if(Array.isArray(e))this.selectedCells=e;else{const t=e;if(this.selectedCells=[t],this.isTargeting()){const e=this.getActor(),[n,s]=[t.getX(),t.getY()],[r,a]=[e.getX(),e.getY()],o=d.Geometry.getBresenham(r,a,n,s).map(t=>e.getLevel().getMap().getCell(t[0],t[1]));this.selectedCells=this.selectedCells.concat(o)}}}getSelectedCells(){return this.selectedCells}getTarget(){return(this.isLooking()||this.isTargeting())&&this.selectedCells&&this.selectedCells.length>0?this.selectedCells[0]:this.selectedCells}getTargetCell(){return this.selectedCells.length>0?this.selectedCells[0]:null}getCellIndexToTarget(e){const t=this._brain.getMemory().getLastAttacked();for(let n=0;n<e.length;n++){const s=e[n].getProp("actors");for(let e=0;e<s.length;e++)if(s[e].getID()===t)return n}return 0}selectCell(e){const t=this._brain._actor,n=this._brain.getSeenCells();if(a.default.isNullOrUndef([e]))this.setSelectedCells(t.getCell());else if(e===i.Keys.KEY.SELECT_ALL){const e=p.Brain.findCellsWithFriends(t,n);this.setSelectedCells(e)}else{const s=this.selectedCells[0],r=t.getLevel().getMap(),[o,i]=[s.getX(),s.getY()],[l,c]=g.getDiff(e,o,i);if(r.hasXY(l,c)&&this.setSelectedCells(r.getCell(l,c)),this.isLooking()){const e=this.getTarget(),t=n.indexOf(e);let s="You cannot see there.";if(t>=0){const t=e.getPropNames();s="",t.forEach(e=>{s+=`You see ${e}. `}),a.default.gameMsg(s)}else a.default.gameMsg(s)}}}hasTargetSelected(){return!!this.selectedCells||!!this._targetList&&this.hasTargets()}hasTargets(){return this._targetList.length>0}processKey(e){if(g.isTargetMode(e)){if(this.isTargeting()){const e=this.getTarget();return this.cancelTargeting(),e?this._brain.handleCommand({cmd:"missile",target:e}):(a.default.gameMsg("No valid targets to attack."),this._brain.noAction())}return this.startTargeting(),this._brain.noAction()}return this.isTargeting()?(g.isNextTarget(e)?this.nextTarget():g.isPrevTarget(e)?this.prevTarget():this.cancelTargeting(),this._brain.noAction()):O}isTargetInRange(){const e=this.getTarget(),t=this._brain._actor;if(e&&e.getX){const[n,s]=[e.getX(),e.getY()],[r,o]=[t.getX(),t.getY()],i=d.Geometry.getBresenham(r,o,n,s),l=t.getInvEq().getEquipped("missile");if(l){const e=a.default.getMissileRange(t,l);if(i.length-1<=e)return!0}}return!1}}class N{constructor(e){this._brain=e,this._actor=e._actor,this._marks={}}addMark(e){const[t,n]=this._actor.getXY(),s=this._actor.getLevel().getID(),r={id:s,x:t,y:n};e&&(r.tag=e),this._marks[s]||(this._marks[s]=[]),this.markExists(s,t,n)||(this._marks[s].push(r),a.default.gameMsg('Added a mark to the current location. Press "g" to view them'))}getMenu(){const e=this._actor.getLevel().getID(),t=this._marks[e]||[],n=t.map(e=>{const{x:t,y:n}=e,s=this._brain._guiCallbacks.GOTO.bind(null,i.Keys.KEY.GOTO,t,n);return[this.getMarkListMsg(e),s]}),s=t.map(e=>{const{x:t,y:n}=e,s=e.id;return[this.getMarkListMsg(e),this.deleteMark.bind(this,s,t,n)]}),r=new o.Menu.WithState;return r.addPre("Choose a mark for travelling:"),r.addItem(i.Keys.KEY.DELETE,["Delete mark",o.Menu.NEXT_STATE]),r.addState("",n),r.addState("DELETE",s),r.addTransition("DELETE",i.Keys.KEY.DELETE),r.addPreState("Choose a mark to delete","DELETE"),r}deleteMark(e,t,n){if(this._marks[e]){const s=this._marks[e].findIndex(s=>s.id===e&&s.x===t&&s.y===n);s>=0&&this._marks[e].splice(s,1)}}getMark(e){const t=i.Keys.codeToIndex(e);return this._marks.length<=t?this._marks[t]:null}getMarkListMsg(e){const{x:t,y:n}=e;let s=`${t}, ${n}`;if(e.tag)s+=` ${e.tag}`;else{const e=this._actor.getLevel().getMap().getCell(t,n);if(e.hasElements()){if(s+=" "+e.getElements()[0].getName(),e.hasConnection()){const t=e.getConnection().getTargetLevel();if(t){const e=t.getParent();e&&(s+=" - "+e.getName())}}}else e.hasItems()&&(s+=" "+e.getItems()[0].getName())}return s}markExists(e,t,n){return this._marks[e].findIndex(e=>e.x===t&&e.y===n)>=0}toJSON(){return this._marks}fromJSON(e){this._marks=e}}const P=null;t.BrainPlayer=class extends p.BrainSentient{constructor(e){super(e),this._confirmCallback=null,this._guiCallbacks={},this._type="Player",this._memory=new S(e),this.energy=0,this._confirmCallback=null,this._wantConfirm=!1,this._confirmEnergy=0,this._wantSelection=!1,this._selectionObject=null,this._runModeEnabled=!1,this._fightMode=a.default.FMODE_NORMAL,this._fsm=new A(this),this._markList=new N(this),this._cache={seen:P},this._statBoosts={CombatMods:{setAttack:0,setDefense:0,setProtection:0},StatsMods:{setAccuracy:0,setAgility:0,setMagic:0,setPerception:0,setSpeed:0,setStrength:0,setWillpower:0}}}getType(){return this._type}setType(e){}getActor(){return this._actor}setActor(e){this._actor=e}addGUICallback(e,t){this._guiCallbacks[e]=t}getMemory(){return this._memory}_restoreBaseSpeed(){this._runModeEnabled=!1,this._actor.has("StatsMods")&&this._actor.get("StatsMods").setSpeed(0)}isRunModeEnabled(){return this._runModeEnabled}cmdNotPossible(e){return this.energy=0,a.default.gameWarn(e),v}isMenuShown(){return!!this._selectionObject&&this._selectionObject.showMenu()}getMenu(){return this._selectionObject&&this._selectionObject.showMenu()?this._selectionObject.getMenu():null}noAction(){return v}getFightMode(){return this._fightMode}toggleRunMode(){if(this.energy=0,this._runModeEnabled)this._restoreBaseSpeed();else{this._runModeEnabled=!0;const e=this._actor.get("Stats").getSpeed(),t=Math.floor(.2*e);this._actor.get("StatsMods").setSpeed(t)}}toggleFightMode(){this._fightMode+=1,this._fightMode>=a.default.FMODES.length&&(this._fightMode=a.default.FMODE_NORMAL)}_createBuyConfirmCallback(e){const t=e.getProp("items")[0],n=e.getPropType("shop")[0],s=n.getItemPriceForBuying(t);this._confirmEnergy=0,this._wantConfirm=!0,this._confirmCallback=(()=>{const e=new u.Transaction;e.setArgs({item:t,buyer:this._actor,shop:n,seller:n.getShopkeeper()}),this._actor.add(e)}),a.default.gameMsg("Press 'y' to buy "+t.getName()+" for "+s+" gold coins")}_setAttackStats(){const e=this._actor.get("Stats"),t=this._actor.get("Combat");let n=0,s=0,r=0;this._fightMode===a.default.FMODE_FAST?(n=Math.round(.2*e.getSpeed()),s=(s=-Math.round(.2*t.getAttack()))<=0?-1:s,r=-1):this._fightMode===a.default.FMODE_SLOW&&(n=-Math.round(.2*e.getSpeed()),s=0===(s=Math.round(.2*t.getAttack()))?1:s,r=2),this._actor.get("StatsMods").setSpeed(n),this._actor.get("CombatMods").setAttack(s),this._actor.get("CombatMods").setDamage(r)}handleCommand(e){switch(this._restoreBaseSpeed(),e.cmd){case"attack":return new c.CmdAttack(this).execute(e);case"missile":return new c.CmdMissile(this).execute(e);case"use":return new c.CmdUseItem(this).execute(e);case"drop":return new c.CmdDropItem(this).execute(e);case"equip":return new c.CmdEquipItem(this).execute(e);case"unequip":return new c.CmdUnequipItem(this).execute(e);case"use-element":return new c.CmdUseElement(this).execute(e);default:return()=>{}}}resetBoosts(){this.energy=0;for(const e in this._statBoosts)if(e){const t=this._statBoosts[e];for(const n in t)if(n){const s=t[n];this._actor.has(e)&&this._actor.get(e)[n](s)}}}tryToToggleDoor(){const e=p.Brain.getCellsAroundActor(this._actor).filter(e=>e.hasDoor());if(1===e.length)return this.openDoorFromCell(e[0]);if(e.length>1){const t=m.arrayGetRand(e);return this.openDoorFromCell(t)}return this.cmdNotPossible("There are no doors to open or close")}openDoorFromCell(e){if(e){const t=e.getPropType("door")[0];if(t){const e=new u.OpenDoor;return e.setDoor(t),this._actor.add(e),y}}return this.cmdNotPossible("There are no doors to open or close")}getSeenCells(){if(this._cache.seen===P){let e=this._actor.getLevel().exploreCells(this._actor);if(this._actor.has("Telepathy")){const t=this._actor.getLevel().getID();this._actor.getList("Telepathy").forEach(n=>{const s=n.getTarget(),r=s.getLevel();if(a.default.isActorActive(s)&&r.getID()===t){const t=r.exploreCells(s);e=e.concat(t)}})}this._cache.seen=e}return this._cache.seen}getTargetActor(){const e=this.getTarget();if(Array.isArray(e)){const t=e;if(t.length>0)return t[0].getFirstActor()}else if(e.getFirstActor)return e.getFirstActor();return null}setSelectionObject(e){this._wantSelection=!0,this._selectionObject=e}selectionDone(){this._wantSelection=!1,this._selectionObject=null}decideNextAction(e){if(this._cache.seen=P,e.hasOwnProperty("cmd"))return this.resetBoosts(),this.handleCommand(e);const t=e.code;if(a.default.isNullOrUndef([t])&&a.default.err("Brain.Player","decideNextAction",`obj.code or obj.cmd must exist. Got obj: ${JSON.stringify(e)}`),this._wantConfirm&&null!==this._confirmCallback)return this.processConfirm(t);if(this._wantSelection)return this.processMenuSelection(t);const n=this._fsm.processKey(t);if(n!==O)return n;if(g.isMark(t))return this._markList.addMark(),this.noAction();if(g.isGoto(t))return this.setSelectionObject(this._markList.getMenu()),this.noAction();if(this._guiCallbacks.hasOwnProperty(t))return this._guiCallbacks[t](t);if(g.isRunMode(t))return this.toggleRunMode(),this.noAction();if(g.isFightMode(t))return this.toggleFightMode(),this.noAction();if(g.isIssueOrder(t))return this.issueOrderCmd(),this.noAction();if(g.isLook(t))return this.lookCmd(),this.noAction();if(g.isJump(t))return this.jumpCmd(),this.noAction();if(g.isUseAbility(t))return this.useAbility(),this.noAction();if(g.isGive(t))return this.giveCmd(),this.noAction();const s=this._actor.getLevel();let r=this._actor.getX(),o=this._actor.getY();const i=s.getMap(),l=i.getCell(r,o);if(g.isNextItem(t))return function(e){if(e.hasItems()){const t=e.getItems();let n=t[0].getName();if(t.length>1){const e=t.shift();t.push(e),n=t[0].getName(),a.default.gameMsg("You see now "+n+" on top of the heap.")}else a.default.gameMsg("You see only "+n+" here")}else a.default.gameMsg("There are no items here to look through")}(l),this.noAction();let c="NULL";if(g.inMoveCodeMap(t)){const e=g.getDiff(t,r,o);r=e[0],o=e[1],c="MOVE"}else this._restoreBaseSpeed();if("NULL"===c){if(this.resetBoosts(),g.isRest(t)&&(c="REST"),g.isPickup(t))return c="PICKUP",l.hasProp("items")?l.hasShop()?l.getShop().isAbandoned()?(this.energy=a.default.energy.PICKUP,()=>{const e=new u.Pickup;this._actor.add(e)}):(this._createBuyConfirmCallback(l),this.noAction()):(this.energy=a.default.energy.PICKUP,()=>{const e=new u.Pickup;this._actor.add(e)}):this.cmdNotPossible("There are no items to pick up.");if(g.isUseStairs(t))return c="STAIRS",l.hasConnection()?()=>{const e=new u.UseStairs;this._actor.add(e)}:this.cmdNotPossible("There are no stairs or passage here.");if(g.isToggleDoor(t))return this.tryToToggleDoor();if(g.isUsePower(t))return this.hasPowers()?(this._wantSelection=!0,this._selectionObject=this._actor.getBook().getSelectionObject(),a.default.gameMsg("Press 0-9 to make a selection.")):a.default.gameMsg("You have no powers to use."),this.noAction();if(g.isChat(t)&&(this._wantSelection=!0,this._selectionObject=E(this._actor)),g.isRead(t)){const e=new u.Read;return this._actor.add(e),y}}return"MOVE"===c?this.moveCmd(s,i,r,o):"REST"===c?(this.energy=a.default.energy.REST,this._actor.add(new u.Rest),y):this.noAction()}hasPowers(){return!!this._actor.getBook()}processConfirm(e){return this._wantConfirm=!1,g.isConfirmYes(e)?(this.energy=this._confirmEnergy,this._confirmCallback):(a.default.gameMsg("You cancel the action."),this.noAction())}processMenuSelection(e){if(o.Menu.isMenuItem(this._selectionObject)){this._selectionObject.showMsg&&this._selectionObject.showMsg();const t=this._selectionObject.select(e);if(o.Menu.isSelectionDone(t))return this.selectionDone(),t;if(o.Menu.isMenuItem(t)){this._selectionObject=t;const e=t;return e.funcToCall?(this.selectionDone(),e.funcToCall()):this.noAction()}}return this.selectionDone(),a.default.gameMsg("You cancel the action."),this.noAction()}moveCmd(e,t,n,s){if(!t.hasXY(n,s)){if(this._actor.getCell().hasPassage()){const e=()=>{const e=new u.UseStairs;this._actor.add(e)},t="Press 'y' to move to another area";return this.setWantConfirm(a.default.energy.MOVE,e,t),this.noAction()}{const e="You cannot move there.";return this.cmdNotPossible(e)}}if(t.isPassable(n,s))return this.moveToCell(n,s,e);if(t.getCell(n,s).hasClosedDoor())return this.tryToToggleDoor();if(t.getCell(n,s).hasActors()){this._restoreBaseSpeed();const e=function(e,t,n){const s=e.getCell(t,n).getProp("actors");for(let e=0;e<s.length;e++)if(!s[e].has("Ethereal"))return s[e];return null}(t,n,s);null===e&&a.default.err("Brain.Player","decideNextAction","Null target for attack x,y: "+n+","+s);const r=()=>{this._setAttackStats();const t=new u.Attack({target:e});this._actor.add(t)};if(e.isEnemy(this._actor))return this.energy=a.default.energy.ATTACK,r;{const t=`Press 'y' to attack non-hostile ${e.getName()}`;return this.setWantConfirm(a.default.energy.ATTACK,r,t),this.noAction()}}if(this._actor.has("Flying")&&t.isPassableByAir(n,s))return this._restoreBaseSpeed(),this.moveToCell(n,s,e);{const e=a.default.getImpassableMsg(this._actor,t.getCell(n,s),"You");return this.cmdNotPossible(e)}}moveToCell(e,t,n){return this._runModeEnabled?this.energy=a.default.energy.RUN:(this.resetBoosts(),this.energy=a.default.energy.MOVE),()=>{const s=new u.Movement(e,t,n);this._actor.add(s)}}setWantConfirm(e,t,n){this._confirmEnergy=e,this._wantConfirm=!0,this._confirmCallback=t,n&&a.default.gameMsg(n)}issueOrderCmd(){const e=[["Follow me",this.giveOrder.bind(this,"Follow")],["Attack enemy",this.giveOrder.bind(this,"Attack")],["Pickup an item",this.giveOrder.bind(this,"Pickup")],["Forget my orders",this.giveOrder.bind(this,"Forget")]],t=new o.Menu.WithQuit(e);t.onQuit=this.cancelTargeting.bind(this);const n=[{key:i.Keys.KEY.SELECT,menu:t}];a.default.gameMsg(_);const s=new o.Menu.SelectCell(n);s.enableSelectAll(),s.setCallback(this.selectCell.bind(this)),this.setSelectionObject(s),this.selectCell()}lookCmd(){const e=[{key:i.Keys.KEY.SELECT,funcToCall:this.showSelectedCellInfo.bind(this)}];a.default.gameMsg(b);const t=new o.Menu.SelectCell(e);t.setCallback(this.selectCell.bind(this)),this.setSelectionObject(t),this._fsm.startLooking(),this.selectCell()}giveCmd(){const e=new o.Menu.SelectDir;e.setCallback(this.giveCallback.bind(this)),this.setSelectionObject(e),a.default.gameMsg("Please select direction to giving an item:")}giveCallback(e){const[t,n]=a.default.newXYFromDir(e,this._actor),s=this._actor.getLevel().getMap().getCell(t,n);if(s.hasActors()){const e=s.getFirstActor(),t=this._actor.getInvEq().getInventory().getItems().map(t=>[t.toString(),this.giveItemToActor.bind(this,t,e)]),n=new o.Menu.WithQuit(t);n.addPre("Select an item to give:"),this.setSelectionObject(n)}else a.default.gameDanger("There is no one there")}giveItemToActor(e,t){const n=new u.Give;n.setGiveTarget(t),n.setItem(e),this._actor.add(n)}jumpCmd(){const e=new o.Menu.SelectDir;e.setCallback(this.jumpCallback.bind(this)),this.setSelectionObject(e),a.default.gameMsg("Please select direction to jump"),this.energy=a.default.energy.JUMP}jumpCallback(e){const[t,n]=e,s=new u.Jump;s.setX(t),s.setY(n),this._actor.add(s)}giveOrder(e){const t=this.getTarget();t.forEach(n=>{if(n.hasActors()){const t=n.getActors()[0],s=t.getBrain();if(t&&s.getGoal)switch(e){case"Follow":this.giveFollowOrder(t);break;case"Forget":this.forgetOrders(t);break;case"Attack":this.giveOrderAttack(t);break;case"Pickup":this.giveOrderPickup(t)}}else 1===t.length&&a.default.gameDanger("This cell has no valid targets")}),this.setSelectedCells(null)}giveFollowOrder(e){const t=e.getName(),n={bias:.7,src:this._actor};l.giveFollowOrder(e,n),a.default.gameMsg(`You tell ${t} to follow you`)}forgetOrders(e){const t={bias:.7,src:this._actor};l.giveClearOrders(e,t),a.default.gameMsg(`You tell ${name} to forget your orders`)}giveOrderAttack(e){const t=this.getSeenCells(),n=a.default.findEnemyCellForActor(this._actor,t);if(0===n.length)return void a.default.gameMsg("There are no enemies around.");const s=n[this.getCellIndexToTarget(n)];if(s){const t=e.getName(),n=s.getActors()[0],r=n.getName(),o={bias:this.getOrderBias(),enemy:n,src:this._actor};l.giveAttackOrder(e,o),a.default.gameMsg(`You tell ${t} to attack ${r}`)}else a.default.gameMsg("There are no enemies around.")}giveOrderPickup(e){const t=this.getItemInSight(),n=e.getName();if(t){const s=t.getName(),r={bias:this.getOrderBias(),item:t,src:this._actor};l.givePickupOrder(e,r),a.default.gameMsg(`You tell ${n} to pickup ${s}`)}else a.default.gameMsg(`There are no items for ${n} to pickup`)}getOrderBias(){return this._actor.has("Leader")?1:this._actor.has("Commander")?1.5:.7}useAbility(){if(this._actor.has("Abilities")){const e=this._actor.get("Abilities").createMenu();this.setSelectionObject(e)}else a.default.gameMsg("You have no abilities to use")}addMark(e){this._markList.addMark(e)}getItemInSight(){const e=this.getSeenCells().filter(e=>e.hasItems());return e.length>0?m.arrayGetRand(e).getItems()[0]:null}toJSON(){return{type:this.getType(),memory:this._memory.toJSON(),markList:this._markList.toJSON()}}addEnemy(){}addFriend(){}hasTargetSelected(){return this._fsm.hasTargetSelected()}startTargeting(){this._fsm.startTargeting()}nextTarget(){this._fsm.nextTarget()}getTargetList(){return this._fsm.getTargetList()}getSelectedCells(){return this._fsm.getSelectedCells()}prevTarget(){this._fsm.prevTarget()}getTarget(){return this._fsm.getTarget()}isTargetInRange(){return this._fsm.isTargetInRange()}cancelTargeting(){this._fsm.cancelTargeting()}isTargeting(){return this._fsm.isTargeting()}getCellIndexToTarget(e){return this._fsm.getCellIndexToTarget(e)}setSelectedCells(e){e?this._fsm.setSelectedCells(e):this.cancelTargeting()}selectCell(e){this._fsm.selectCell(e)}showSelectedCellInfo(){this._fsm.stopLooking()}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(84),i=n(44),l=n(53),c=r(n(11)),{GOAL_ACTIVE:u,GOAL_COMPLETED:h}=o.GoalStatus;t.GoalsBattle={},t.orderWithGoal=((e,t)=>{const{bias:n}=t,s=new i.Evaluator.Orders(n);if(s.setArgs({srcActor:t.src,goal:t.goal}),e.isPlayer()){const n=new c.BattleOrder,s={srcActor:t.src};n.setArgs(s),e.add(n)}else{const t=e.getBrain();if("function"==typeof t.getGoal){const e=t.getGoal();e.clearOrders(),e.giveOrders(s)}else{const t="Actor without getGoal: "+JSON.stringify(e);a.default.warn("goals-battle.js","orderWithGoal",t)}}}),t.GoalsBattle.orderWithGoal=t.orderWithGoal,t.injectOrderEval=((e,t,n)=>{if(l.isSentient(e)){const s=new i.Evaluator.Orders(n.bias);s.setArgs({srcActor:n.src,goal:t});const r=e.getBrain().getGoal();r.clearOrders(),r.giveOrders(s)}}),t.giveFollowOrder=((e,n)=>{if(l.isSentient(e)){const s=new o.Goal.Follow(e,n.src);t.injectOrderEval(e,s,n)}}),t.GoalsBattle.giveFollowOrder=t.giveFollowOrder,t.giveAttackOrder=((e,n)=>{if(l.isSentient(e)){const s=new o.Goal.AttackActor(e,n.enemy);t.injectOrderEval(e,s,n)}}),t.GoalsBattle.giveAttackOrder=t.giveAttackOrder,t.givePickupOrder=((e,n)=>{if(l.isSentient(e)){const s=new o.Goal.GetItem(e,n.item);t.injectOrderEval(e,s,n)}}),t.GoalsBattle.givePickupOrder=t.givePickupOrder,t.giveClearOrders=((e,t)=>{if(l.isSentient(e)){const{src:n}=t;if(!e.isEnemy(n)){e.getBrain().getGoal().clearOrders()}}}),t.GoalsBattle.giveClearOrders=t.giveClearOrders;class d extends o.GoalBase{constructor(e){super(e),this.setType("GoalWinBattle")}activate(){const e=this.actor.getBrain(),t=e.getSeenCells();e.findEnemyCell(t)?(this.addSubGoal(new g(this.actor)),this.dbg("Activated goal. Added EngageEnemy")):(this.addSubGoal(new m(this.actor)),this.dbg("Activated goal. Added FindEnemyArmy")),this.status=u}process(){return this.dbg("process() begin"),this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}t.GoalWinBattle=d,t.GoalsBattle.WinBattle=d;class p extends o.GoalBase{constructor(e){super(e),this.setType("GoalFollowArmy")}activate(){}process(){return this.activateIfInactive(),this.status=h,this.status}}t.GoalFollowArmy=p,t.GoalsBattle.FollowArmy=p;class f{constructor(e,t,n){const s=e.getMap(),[r,a]=[s.cols,s.rows];let o=Math.floor(r/t),i=Math.floor(a/n);r%t!=0&&++o,a%n!=0&&++i,this.grid=[];for(let e=0;e<o;e++){this.grid[e]=[];for(let t=0;t<i;t++)this.grid[e][t]={data:[e,t]}}this.gridCols=o,this.gridRows=i,this.xMap=t,this.yMap=n,this.xMapHalf=Math.floor(t/2),this.yMapHalf=Math.floor(n/2)}getCenterLevelXY(e){const[t,n]=e;return[t*this.xMap+this.xMapHalf,n*this.yMap+this.yMapHalf]}getGridXY(e){const[t,n]=e;return[Math.floor(t/this.xMap),Math.floor(n/this.yMap)]}setDataLevelXY(e,t,n){const[s,r]=this.getGridXY(e);this.grid[s][r][t]=n}setDataGridXY(e,t,n){const[s,r]=e;this.grid[s][r][t]=n}isTrue(e,t){const[n,s]=e;return!0===this.grid[n][s][t]}hasProp(e,t){const[n,s]=e;return this.grid[n][s].hasOwnProperty(t)}getDataGridXY(e){const[t,n]=e;return this.grid[t][n]}getDataLevelXY(e){const[t,n]=this.getGridXY(e);return this.grid[t][n]}debugPrint(){for(let e=0;e<this.gridRows;e++){let t="||";for(let n=0;n<this.gridCols;n++)t+=JSON.stringify(this.grid[n][e])+" ||";a.default.diag(t),a.default.diag("=".repeat(t.length))}}}t.LevelGrid=f;class m extends o.GoalBase{constructor(e){super(e),this.setType("GoalFindEnemyArmy");const t=e.getLevel();this.gridSeen=new f(t,10,10);const[n,s]=this.actor.getXY();this.gridSeen.setDataLevelXY([n,s],"seen",!0),this.adjustRate=50}activate(){this.selectDirToMove(),this.status=u}process(){return this.activateIfInactive(),this.adjustRate>0?--this.adjustRate:(this.selectDirToMove(),this.adjustRate=50),this.status=this.processSubGoals(),this.status}selectDirToMove(){const e=this.actor.getBrain(),n=[0,0],s=this.actor.getLevel(),[r,a]=this.actor.getXY(),i=s.getMap().cols/2,l=s.getMap().rows/2;r<i?n[0]=1:r>i&&(n[0]=-1),a<l?n[1]=1:a>l&&(n[1]=-1),this.dbg(`Cmd army to move to dir ${n}`);const c=e.getSeenFriends();this.dbg(`${c.length} friends found for command`),c.forEach(e=>{const s=new o.Goal.MoveUntilEnemy(e,n);t.orderWithGoal(e,{src:this.actor,bias:1,goal:s})}),this.dbg("Issued Move order to "+c.length+" actors");const u=new o.Goal.MoveUntilEnemy(this.actor,n);this.removeAllSubGoals(),this.addSubGoal(u)}}t.GoalFindEnemyArmy=m,t.GoalsBattle.FindEnemyArmy=m;class g extends o.GoalBase{constructor(e){super(e),this.setType("GoalEngageEnemy")}activate(){this.dbg("ATTACK ENEMY activate()");const e=this.actor.getBrain(),n=e.getSeenEnemies();if(0===n.length)return;e.getSeenFriends().forEach(e=>{const s=new o.Goal.AttackActor(e,n[0]);t.orderWithGoal(e,{src:this.actor,bias:2,goal:s})}),this.enemy=n[0];const s=new o.Goal.AttackActor(this.actor,n[0]);this.addSubGoal(s),this.status=u}process(){return this.activateIfInactive(),this.dbg("ATTACK ENEMY process()"),this.status=this.processSubGoals(),this.status}}t.GoalEngageEnemy=g,t.GoalsBattle.EngageEnemy=g;class y extends o.GoalBase{constructor(e){super(e),this.setType("GoalHoldPosition")}}t.GoalHoldPosition=y,t.GoalsBattle.HoldPosition=y;class v extends o.GoalBase{constructor(e){super(e),this.setType("GoalRetreat")}}t.GoalRetreat=v,t.GoalsBattle.Retreat=v},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8));class a{constructor(e,t){this._type=e,this._item=null,this._hasItem=!1,this._unequipped=null,this._stacked=!1,r.default.isNullOrUndef([t])||(this._stacked=t)}isStacked(){return this._stacked}getUnequipped(){return this._unequipped}getItem(){return this._hasItem?this._item:null}hasItem(){return this._hasItem}equipItem(e){return!!this.canEquip(e)&&(this._stacked&&this._hasItem?r.default.addStackedItems(this._item,e)&&(this._hasItem=!0):(e.setOwner(this),this._item=e,this._hasItem=!0),this._hasItem)}unequipItem(e){if(this._hasItem){if(!this._stacked)return this._hasItem=!1,this._unequipped=this._item,!0;if(e>0)return 1===e&&1===this._item.getCount()?(this._hasItem=!1,this._unequipped=this._item):e===this._item.getCount()?(this._hasItem=!1,this._unequipped=this._item):this._unequipped=r.default.removeStackedItems(this._item,e),!0}return!1}canEquip(e){return!this._hasItem||!!this._stacked&&e.equals(this._item)}}t.EquipSlot=a;const o=["getDefense","getAttack","getProtection","getSpeed"].concat(r.default.GET_STATS);t.Equipment=class{constructor(e){this._actor=e,this._slots={chest:new a("chest"),feet:new a("feet"),hand:new a("hand"),head:new a("head"),missile:new a("missile",!0),missileweapon:new a("missileweapon"),neck:new a("neck"),shield:new a("shield"),spiritgem:new a("spiritgem")};for(let e=0;e<o.length;e++){const t=()=>()=>this.propertySum(o[e]);this[o[e]]=t()}}addSlot(e,t){if(this._hasSlot(e))if(Array.isArray(this._slots[e]))this._slots[e].push(t);else{const n=[this._slots[e]];n.push(t),this._slots[e]=n}else this._slots[e]=t}getWeight(){let e=0;const t=this.getEquippedItems();for(let n=0;n<t.length;n++)e+=t[n].getWeight()*t[n].getCount();return this._actor.has("MasterEquipper")&&(e*=this._actor.get("MasterEquipper").getFactor()),e}getNumSlots(e){return this._hasSlot(e)?Array.isArray(this._slots[e])?this._slots[e].length:1:0}getSlotTypes(){return Object.keys(this._slots)}getItems(e){return this._hasSlot(e)?Array.isArray(this._slots[e])?this._slots[e]:[this._slots[e]]:this.getEquippedItems()}getUnequipped(e,t){if(this._hasSlot(e)){const n=this._slots[e];return Array.isArray(n)?n[t].getUnequipped():this._slots[e].getUnequipped()}return r.default.err("Equipment","getUnequipped","No slot type: "+e),null}getItem(e){if(this._hasSlot(e)){const t=this._slots[e];return Array.isArray(t)?t.map(e=>e.getItem()):this._slots[e].getItem()}return null}equipItem(e){return e.getArmourType?this._equipToSlotType(e.getArmourType(),e):/^(missile|ammo)$/.test(e.getType())?!!this._slots.missile.equipItem(e):"missileweapon"===e.getType()?this._equipToSlotType("missileweapon",e):this._equipToSlotType("hand",e)}_equipToSlotType(e,t){const n=this._slots[e];if(Array.isArray(n)){for(let e=0;e<n.length;e++)if(n[e].equipItem(t))return!0}else if(n.equipItem(t))return!0;return!1}isEquipped(e){return-1!==this.getItems().indexOf(e)}getEquipped(e){return this.getItem(e)}getEquippedItems(){const e=[];return Object.values(this._slots).forEach(t=>{Array.isArray(t)?t.forEach(t=>{t.hasItem()&&e.push(t.getItem())}):t.hasItem()&&e.push(t.getItem())}),e}unequipItem(e,t,n){if(this._hasSlot(e)){const s=this._slots[e];if(!Array.isArray(s))return this._slots[e].unequipItem(t);if(n>=0){if(s[n].unequipItem(t))return!0}else for(let e=0;e<s.length;e++)if(s[e].unequipItem(t))return!0}else{const t="Non-existing slot type "+e;r.default.err("Equipment","unequipItem",t)}return!1}toJSON(){const e=[],t=this.getEquippedItems();for(let n=0;n<t.length;n++)e.push(t[n].toJSON());return e}propertySum(e){let t=0;return Object.keys(this._slots).forEach(n=>{let s=this._slots[n];Array.isArray(s)||(s=[s]),s.forEach(n=>{const s=n.getItem();t+=r.default.getItemStat(e,s)})}),t}_hasSlot(e){return this._slots.hasOwnProperty(e)}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=n(65),a=n(105),o=s(n(25));t.BrainWeather=class extends a.BrainBase{constructor(e){super(e),this.setType("Weather"),this.updateFreq=10}decideNextAction(e){--this.updateFreq;const t=this._actor.getLevel();if(0===this.updateFreq&&t.has("Weather")){const e=t.get("Weather").getWeatherType(),n=new o.WeatherEffect;n.setEffectType(e),this._actor.add(n),this.updateFreq=10}return r.ACTION_ALREADY_DONE}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8));t.Constraints=class{getConstraints(e){if(Array.isArray(e)){const t=e.map(e=>this.getFunc(e.op,e.prop,e.value)),n=function(e){let n=!0;return t.forEach(t=>{n=n&&t(e)}),n};return n.constraint=e,n}if("object"==typeof e){const{op:t,prop:n,value:s}=e;return this.getFunc(t,n,s)}{const t=`Param must be array/object. Got: ${e}`;r.default.err("Constrains","getConstraints",t)}return null}getFunc(e,t,n){if(Array.isArray(n)){const s=n.map(n=>this.getFunc(e,t,n)),r=function(e){let t=!1;return s.forEach(n=>{t=t||n(e)}),t};return r.constraint={op:e,prop:t,value:n},r}{let s=()=>!1;switch(e){case"==":case"===":case"eq":s=(e=>e[t]===n);break;case"!=":case"!==":case"neq":s=(e=>e[t]!==n);break;case">=":case"gte":s=(e=>e[t]>=n);break;case"<=":case"lte":s=(e=>e[t]<=n);break;case">":case"gt":s=(e=>e[t]>n);break;case"<":case"lt":s=(e=>e[t]<n);break;case"match":s=(e=>new RegExp(n).test(e[t]));break;default:r.default.err("Constraints","getFunc",`Unsupported op ${e} given`)}return s.constraint={op:e,prop:t,value:n},s}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(9),o=n(86),i=n(87);t.ActorGen={};const l=new a.Random,c={races:{},ranks:{},roles:{},roleBases:{}},u={range:1,danger:1,speed:100,brain:"GoalOriented",damage:"1d6",attack:1,defense:1,hp:5,protection:0,enemies:r.default.ACTOR_RACES,accuracy:5,agility:5,strength:5,magic:5,perception:5,willpower:5};c.races={arborean:{strength:3,willpower:5,type:"arborean",prefix:"arborean",char:"a",colorbg:"white"},elf:{strength:-1,agility:4,accuracy:4,magic:3,type:"elf",prefix:"elven",char:"e",colorbg:"green"},fae:{type:"fae",prefix:"fae",char:"f",colorbg:"purple",speed:10,strength:-2,magic:3,addComp:["Flying"]},gnome:{strength:-1,magic:3,perception:5,type:"gnome",prefix:"gnomish",char:"n",colorbg:"beige"},ogre:{strength:4,magic:-3,willpower:-3,type:"ogre",prefix:"ogre",char:"O",colorbg:"darkseagreen"},orc:{strength:2,magic:-2,willpower:-2,type:"orc",prefix:"orc",char:"o",colorg:"darkseagreen"},ratling:{agility:2,perception:4,type:"ratling",prefix:"ratling",char:"r",colorbg:"grey"},vachefolk:{strength:2,type:"vachefolk",prefix:"vachefolk",char:"v",colorbg:"brown"},valkyr:{strength:3,type:"valkyr",prefix:"valkyr",char:"V",colorbg:"darkblue",addComp:[i.resistance("ICE","MEDIUM")]}};const h=Object.keys(c.races);c.ranks={commoner:{danger:1,hp:5},adventurer:{danger:2,hp:10},sergeant:{danger:3,strength:1,hp:15},commander:{danger:5,strength:5,hp:20,equip:["Great battle axe","Steel armour","Steel helmet"]},steward:{danger:5,hp:20},lord:{danger:5,strength:7,hp:20},warlord:{danger:7,hp:25},captain:{danger:7,hp:25,strength:7,agility:3,accuracy:3},prince:{danger:5,hp:20},princess:{danger:5,agility:5,magic:5,hp:20},queen:{colorfg:"yellow",danger:10,hp:30,addComp:["FirstStrike"]},king:{colorfg:"red",strength:7,attack:7,defense:7,danger:12,hp:40},emperor:{colorfg:"purple",danger:15,strength:10,attack:10,defense:10,hp:50,addComp:[i.BypassComp(.15)]},empress:{colorfg:"palevioletred",danger:17,accuracy:10,agility:10,attack:10,defense:10,hp:45,addComp:[i.BypassComp(.25),"Charm"]},overlord:{danger:10,hp:35,addComp:[i.BypassComp(.1)]}};const d=Object.keys(c.ranks);c.roleBases={melee:{attack:2,defense:2,protection:2,danger:1},magic:{magic:3,willpower:2,danger:2,brain:"SpellCaster",maxPP:10,PP:10,addComp:["RegenEffect"]},ranged:{accuracy:3,agility:1,danger:2,addComp:[{random:["EagleEye","StrongShot","ThroughShot","LongRangeShot","RangedEvasion","CriticalShot"]}]},stealth:{defense:2,agility:3,perception:2,danger:1}},c.roles={melee:{axeman:{danger:2,hp:10},brave:{danger:2,hp:7,strength:2},duelist:{danger:3,hp:13,agility:3,strength:2},elite:{danger:5,hp:23,strength:4,addComp:["CounterAttack"]},fighter:{danger:2,hp:12,agility:1,strength:1},footman:{danger:1,equip:["Longsword"]},knight:{danger:4,hp:15,strength:4},phalanx:{danger:1,hp:10,defense:4,equip:["Spear"]},scourger:{danger:4,hp:20,attack:4,defense:4,strength:6},judicator:{danger:5,hp:30,attack:5,defense:5,strength:7,addComp:["FirstStrike"]},skirmisher:{danger:3,hp:15,attack:3,defense:3},hunter:{danger:2,hp:10,attack:3,defense:3},warrior:{danger:2,hp:10,attack:3,defense:3}},magic:{adept:{danger:1,pp:3,maxPP:3,hp:5,spells:["EnergyArrow"]},archmage:{danger:15,pp:40,maxPP:40,hp:30,spells:["PowerDrain",{random:["WaterBolt","SlimeBolt","FrostBolt"]},{random:["Heal","MagicArmor","Charm"]},{random:["IceArrow","PoisonArrow","ArrowOfWebs"]}]},bard:{danger:3,magic:5,pp:7,maxPP:7,hp:7,spells:["SummonAnimal"]},cleric:{danger:1,magic:2,willpower:3,pp:7,maxPP:7,spells:["Heal"]},healer:{danger:1,magic:2,pp:7,maxPP:7,spells:["Heal"]},mage:{danger:5,magic:5,willpower:5,hp:13,spells:[{random:["RingOfFire","RingOfFrost"]}]},telepath:{danger:4,pp:12,maxPP:12,hp:12,magic:4,willpower:4,spells:["SummonFlyingEyes","Telepathy"]},necromancer:{danger:5,pp:10,maxPP:10,hp:15,spells:["AnimateDead"]},runemage:{danger:3,pp:15,maxPP:15,hp:15,spells:["StunningTouch"]},shaman:{danger:3,pp:15,maxPP:15,hp:10,spells:["IcyPrison"]},summoner:{danger:7,pp:15,maxPP:15,hp:15,spells:[{random:["SummonKin","SummonAirElemental"]}]},wizard:{danger:10,maxPP:30,pp:30,hp:15,magic:7,willpower:7,spells:[{random:["CrossBolt","FrostBolt","LightningBolt"]},{random:["Heal","MagicArmor","Paralysis"]}]}},ranged:{arbalist:{danger:3,hp:10,equip:["Wooden crossbow",{name:"Wooden bolt",count:10}]},archer:{danger:3,hp:5,equip:["Wooden bow",{name:"Wooden arrow",count:10},"Steel bow",{name:"Steel arrow",count:15}]},bolter:{danger:4,hp:5,equip:["Steel crossbow",{name:"Steel bolt",count:7}]},rifleman:{danger:6,hp:15,equip:["Rifle",{name:"Steel bullet",count:7}]},darter:{danger:2,hp:5,speed:5,equip:[{name:"Iron dart",count:9}]},thrower:{danger:1,equip:[{name:"Throwing axe",count:7}]},catapulter:{danger:2,hp:15,strength:5,speed:-5,equip:[{name:"Large rock",count:4}]},sharpshooter:{danger:8,hp:20,accuracy:5,agility:5,equip:["Rifle",{name:"Steel bullet",count:10}],fovrange:7},slinger:{danger:1,hp:3,equip:[{name:"Rock",count:10}]}},stealth:{assassin:{danger:3,addComp:[i.resistance("POISON","MEDIUM")]},acrobat:{danger:2,brain:"Thief",speed:20},rogue:{},scout:{danger:2,speed:10,fovrange:7},thief:{danger:2,brain:"Thief"}}};const p=Object.keys(c.roles);t.ActorGen.genRandShell=function(){const e=l.getUniformInt(1,2),t=l.arrayGetRand(h),n=c.races[t],s=l.arrayGetRand(d),r=c.ranks[s],a=l.getUniqueItems(p,e),i=a.map(e=>c.roleBases[e]);let f="";const m=[],g=a.map(e=>{const t=c.roles[e],n=l.arrayGetRand(Object.keys(t));return f+=" "+n,m.push(n),t[n]}),y=[u,n,r].concat(i).concat(g),v=o.mixNewShell(y);return v.name="commoner"!==s?n.prefix+f+" "+s:n.prefix+f,v.roleTypes=a,v.roles=m,v},t.ActorGen.genActors=function(e){const n=[];for(let s=0;s<e;s++)n.push(t.ActorGen.genRandShell());return n},t.ActorGen.getRandShellWith=function(e){let n=100,s=null;for(;n>=0&&!e(s=t.ActorGen.genRandShell());)--n;return s},t.ActorGen.getRaces=function(){return h}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(125),r=n(44);t.EvaluatorsBattle={};class a extends r.Evaluator.Base{constructor(e){super(e),this.type="WinBattle"}calculateDesirability(e){return e.has("InBattle")?this.actorBias:r.Evaluator.NOT_POSSIBLE}setActorGoal(e){const t=e.getBrain().getGoal(),n=new s.GoalsBattle.WinBattle(e);t.addGoal(n)}}t.EvaluatorWinBattle=a,t.EvaluatorsBattle.WinBattle=a;class o extends r.Evaluator.Base{constructor(e){super(e),this.cooldown=5,this.type="Retreat"}calculateDesirability(){return 0===this.cooldown?this.actorBias:(--this.cooldown,0)}setActorGoal(e){const t=e.getBrain().getGoal(),n=new s.GoalsBattle.Retreat(e);t.addGoal(n)}}t.EvaluatorRetreat=o,t.EvaluatorsBattle.Retreat=o},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(9),i=r(n(43)),l=r(n(25)),c=o.Random.getRNG();t.Ability={};class u{constructor(e){this.name=e}getName(){return this.name}getMenuItem(){return[this.getName(),this.activate.bind(this)]}activate(e){const t=this.getName();a.default.err("Ability.Base","activate",`${t} should implement activate()`)}}t.AbilityBase=u,t.Ability.Base=u;class h extends u{constructor(e){super("Self")}getMenuItem(){return[this.getName(),this.activate.bind(this)]}}t.Self=h,t.Ability.Self=h;class d extends u{constructor(e){super("Camouflage")}activate(){this.actor.add(new l.Camouflage)}}t.Camouflage=d,t.Ability.Camouflage=d,t.Direction=function(){t.Ability.Base.call(this,name)},a.default.extend2(t.Direction,t.Ability.Base),t.Area=function(){t.Ability.Base.call(this,name)},a.default.extend2(t.Area,t.Ability.Base);class p extends u{constructor(e){super(e)}activate(e){const t=JSON.stringify(e);a.default.err("Ability.Item","activate","Not impl. in base class. Called with: "+t)}getMenuItem(){const e=this.actor.getInvEq().getInventory().getItems().map(e=>[e.toString(),this.activate.bind(this,e)]),t=new i.MenuWithQuit(e);return t.addPre("Select an item to sharpen:"),[this.getName(),t]}}t.Item=p,t.Ability.Item=p;class f extends t.Ability.Item{constructor(){super("Sharpener")}activate(e){const t=e.getName();if(e.has("Sharpened"))a.default.gameMsg(`${t} has already been sharpened`);else if(e.getDamageDie){e.add(new l.Sharpened);const n=c.getUniformInt(1,3),s=e.getDamageDie();s.setMod(s.getMod()+n),e.setValue(e.getValue()+10*n),a.default.gameMsg(`You sharpen ${t}`)}else a.default.gameMsg(`It's useless to sharpen ${t}`)}}t.Sharpener=f,t.Ability.Sharpener=f;class m{constructor(e){this.actor=e,this.abilities={}}getMenu(){const e=Object.values(this.abilities).map(e=>e.getMenuItem()),t=new i.MenuWithQuit(e);return t.setName("MenuAbilities"),t.addPre("Select an ability to use:"),t}addAbility(e){this.abilities[e.getName()]=e,e.actor=this.actor}toJSON(){return Object.keys(this.abilities)}}t.Abilities=m,t.Ability.Abilities=m},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(1)),o=r(n(310)),i=(e,t,n,s)=>{const r=e.clientX,a=e.clientY,o=n.sizeX,i=n.startX,l=n.startY,c=t.getBoundingClientRect(),u=t.getElementsByClassName(s)[0];if(u){const e=u.clientWidth/o,t=u.clientHeight,n=r-c.left,s=a-c.top;return[Math.floor(n/e)+i,Math.floor(s/t)+l]}return[0,0]};t.default=class extends a.Component{constructor(e){super(e),this.onCellClick=this.onCellClick.bind(this),this.onMouseOverCell=this.onMouseOverCell.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseOver=this.onMouseOver.bind(this),this.onMouseUp=this.onMouseUp.bind(this)}componentDidMount(){this.props.onMouseOverCell&&this.board.addEventListener("contextmenu",this.onMouseOverCell,!0),this.props.onMouseDown&&this.board.addEventListener("mousedown",this.onMouseDown,!0),this.props.onMouseUp&&this.board.addEventListener("mouseup",this.onMouseUp,!0),this.props.onMouseOver&&this.board.addEventListener("mouseover",this.onMouseOver,!0)}componentWillUnmount(){this.props.onMouseOverCell&&this.board.removeEventListener("contextmenu",this.onMouseOverCell),this.props.onMouseDown&&this.board.removeEventListener("mousedown",this.onMouseDown,!0),this.props.onMouseUp&&this.board.removeEventListener("mouseup",this.onMouseUp,!0),this.props.onMouseOver&&this.board.removeEventListener("mouseover",this.onMouseOver,!0)}onCellClick(e){const t=i(e,this.board,this.props,"game-board-row");t&&this.props.onCellClick(t[0],t[1])}onMouseOver(e){if(this.props.onMouseOver){e.preventDefault();const t=i(e,this.board,this.props,"game-board-row");this.props.onMouseOver(t[0],t[1])}}onMouseUp(e){if(this.props.onMouseUp){e.preventDefault();const t=i(e,this.board,this.props,"game-board-row");this.props.onMouseUp(t[0],t[1])}}onMouseDown(e){if(this.props.onMouseDown){e.preventDefault();const t=i(e,this.board,this.props,"game-board-row");this.props.onMouseDown(t[0],t[1])}}getCellXY(e){return i(e,this.board,this.props,"game-board-row")}render(){const e=[];for(let t=this.props.startY;t<=this.props.endY;++t){const n=t-this.props.startY,s=this.props.startX+","+t;e.push(a.createElement(o.default,{key:s,rowChars:this.props.charRows[n],rowClass:this.props.rowClass,rowClasses:this.props.classRows[n],startX:this.props.startX,useRLE:this.props.useRLE,y:t}))}return a.createElement("div",{className:`game-board ${this.props.boardClassName}`,onClick:this.onCellClick,ref:e=>{this.board=e}},e)}onMouseOverCell(e){if(this.props.onMouseOverCell){e.preventDefault(),console.log("<GameBoard> onMouseOverCell"),console.log(e);const t=i(e,this.board,this.props,"game-board-row");return console.log("<GameBoard> xy is "+t),this.props.onMouseOverCell(t[0],t[1]),!1}return!0}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KeyCode={},t.KeyCode.getKeyCode=function(e){return"number"==typeof e.which?e.which:e.keyCode}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.canUseDOM=void 0;var s,r=n(328);var a=((s=r)&&s.__esModule?s:{default:s}).default,o=a.canUseDOM?window.HTMLElement:{};t.canUseDOM=a.canUseDOM;t.default=o},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=n(128),o=s(n(8)),i=n(41),l=n(138),c=n(9),u=n(31),h=n(14),d=r(n(20)),p=r(n(11)),f=r(n(106)),m=r(n(15)),g=n(139),y=n(12),v=m.ElementStairs,_=c.Random.getRNG(),b=["avianfolk","human","dwarf","dogfolk","wolfclan","goblin","catfolk","bearfolk","wildling","undead"];t.FactoryBattle=class{constructor(){this.minCommDanger=5}createBattle(e,t={}){const n=t.cols||80,s=t.rows||40,r=e?e.getID():0,a=t.name||"Battle of level "+r;let c=this.createBattleLevel(n,s,t);if(e){const n=new v("battle",e),s=e.getMap();if(t.bbox){const{bbox:r}=t;let a=_.getRandInBbox(r),i=s.getCell(a[0],a[1]),l=o.default.WATCHDOG;for(;i.hasProps()&&(a=_.getRandInBbox(r),i=s.getCell(a[0],a[1]),0!=--l););e.addStairs(n,a[0],a[1]);const u=y.Geometry.getCellsAround(s,i);c=(new g.LevelSurroundings).surround(c,{cellsAround:u})}else e.addStairs(n,4,4);i.World.addExitsToEdge(c);const r=c.getConnections();n.connect(r[0]);for(let t=1;t<r.length;t++)r[t].setTargetLevel(e),r[t].setTargetStairs(n)}const u=new l.Battle(a);u.setLevel(c);const[h,d]=this.getFactions(t);let p=t.numRows||2;const f=t.armySize||20,m=t.numArmies||2,b=t.armies||[h,d];let E=Math.ceil(f/p);for(;E>n;)++p,E=Math.ceil(f/p);const S=[];for(let e=0;e<m;e++){const r=this.createArmy(u,b[e],t);let a=_.getUniformInt(0,n-1),i=_.getUniformInt(0,s-1);a+E>n-1&&(a=n-E),i+p>s-1&&(i=s-1-p),t.centerX&&(a=Math.floor(n/2),a-=Math.floor(f/p/2)),t.centerY&&(i=Math.floor(s/2),i-=e*(p+2)),(a>n-1||a<0)&&o.default.err("FactoryBattle","createBattle",`armyX ${a} out of bounds 0-${n-1}`),(i>s-1||i<0)&&o.default.err("FactoryBattle","createBattle",`armyY ${i} out of bounds 0-${s-1}`);const l={horizontal:!0,numRows:p};u.addArmy(r,a,i,l),S.push(r)}return this.makeArmiesAsEnemies(S),u}getFactions(e){let t=null,n=null;if(e.factions)[t,n]=e.factions;else for(t=_.arrayGetRand(b),n=_.arrayGetRand(b);t===n;)n=_.arrayGetRand(b);return[t,n]}createArmy(e,t,n){const s=h.ObjectShell.getParser(),r=n.armySize||20,i=n.danger||5,c=new l.Army(t);c.addAlignment(t,1);const u=[{op:"eq",prop:"type",value:t},{op:"lte",prop:"danger",value:i}],d=(new a.Constraints).getConstraints(u);for(let t=0;t<r-1;t++){const t=s.createRandomActor({func:d});if(t){const n=new p.InBattle;n.setData({name:e.getName(),army:c.getName()}),t.add(n),c.addActor(t)}}const f=s.createRandomActor({func:e=>e.type===t&&e.danger>=this.minCommDanger});if(f){this.addCommanderAbilities(f);const t=new p.InBattle;t.setData({name:e.getName(),army:c.getName()}),f.add(t),c.addActor(f)}else o.default.warn("FactoryBattle","createArmy","No commander for army generated");return c.setDefeatThreshold(Math.round(.1*r)),c}makeArmiesAsEnemies(e){e.forEach(t=>{e.forEach(e=>{t.getName()!==e.getName()&&t.getActors().forEach(t=>{e.getActors().forEach(e=>{t.addEnemy(e),e.addEnemy(t)})})}),t.getActors().forEach(e=>{t.getActors().forEach(t=>{e.getID()!==t.getID()&&(e.addFriend(t),t.addFriend(e))})})})}createBattleLevel(e,t,n){const s=n.levelType||"forest",r=o.default.getForestConf(e,t);return u.FactoryLevel.createLevel(s,e,t,r)}addCommanderAbilities(e){const t=new d.BrainGoalOriented(e),n=new f.ThinkCommander(e);e.setBrain(t),t.setGoal(n),e.add(new p.Commander),e.setFOVRange(10)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(19),{TYPE_ACTOR:o,TYPE_ITEM:i,TYPE_ELEM:l}=r.default;t.Cell=class{constructor(e,t,n){this._baseElem=n,this._x=e,this._y=t,this._explored=!1,this._p={},this._lightPasses=!n||n.lightPasses(),this._isPassable=!n||n.isPassable()}getX(){return this._x}getY(){return this._y}getXY(){return[this._x,this._y]}setX(e){this._x=e}setY(e){this._y=e}setXY(e){this._x=e[0],this._y=e[1]}isAtXY(e,t){return e===this._x&&t===this._y}getKeyXY(){return this._x+","+this._y}setBaseElem(e){this._baseElem=e,this._lightPasses=e.lightPasses(),this._isPassable=e.isPassable()}getBaseElem(){return this._baseElem}hasProp(e){return this._p.hasOwnProperty(e)}getProp(e){return this._p.hasOwnProperty(e)?this._p[e]:null}hasElements(){return this.hasProp(l)}getElements(){return this.getProp(l)}hasActors(){return this.hasProp(o)}getActors(){return this.getProp(o)}getFirstActor(){const e=this.getProp(o);return e&&e.length>0?e[0]:null}getSentientActors(){const e=this.getActors();return e?e.filter(e=>!e.has("NonSentient")):[]}hasItems(){return this.hasProp(i)}getItems(){return this.getProp(i)}hasMarker(e){if(this.hasElements()){const t=this.getElements();for(let n=0;n<t.length;n++)if("marker"===t[n].getType()&&t[n].getTag()===e)return!0}return!1}hasProps(){return Object.keys(this._p).length>0}hasStairs(){const e=this.getConnection();if(e){const t=e.getName();return/stairs(Up|Down)/.test(t)}return!1}hasPassage(){const e=this.getConnection();return!!e&&"passage"===e.getName()}hasShop(){return this.hasPropType("shop")}getShop(){return this.getPropType("shop")[0]}hasDoor(){return this.hasPropType("door")}hasClosedDoor(){if(this.hasDoor())return this.getPropType("door")[0].isClosed()}hasConnection(){return this.hasPropType("connection")}hasHouse(){return"floorhouse"===this._baseElem.getType()}hasConnectionType(e){return!!this.hasConnection()&&this.getConnection().getName()===e}hasTown(){return this.hasConnectionType("town")}hasBattle(){return this.hasConnectionType("battle")}hasMountain(){return this.hasConnectionType("mountain")}getStairs(){return this.hasStairs()?this.getConnection():null}getConnection(){return this.hasPropType("connection")?this.getPropType("connection")[0]:null}getPassage(){return this.hasPassage()?this.getConnection():null}lightPasses(){if(!this._lightPasses)return!1;const e=this._p[l];if(e)if(1===e.length){if(e[0].has("Opaque"))return!1}else for(let t=0;t<e.length;t++)if(e[t].has("Opaque"))return!1;return!0}isPassable(){return this.isFree()}isPassableByAir(){return this._baseElem.isPassableByAir()}isDangerous(){if(this._p[o]){const e=this.getProp(o);if(e)return e[0].has("Damaging")}return!1}hasObstacle(){return this._baseElem.isObstacle()}isSpellPassable(){return this._baseElem.isSpellPassable()}setExplored(){this._explored=!0}isExplored(){return this._explored}isFree(e=!1){if(!e&&!this._isPassable)return!1;if(this.hasProp(o)){for(let e=0;e<this._p.actors.length;e++)if(!this._p.actors[e].has("Ethereal"))return!1;return!0}if(this.hasProp(l)){if(this.hasPropType("door"))return this.getDoor().isOpen();if(this.hasPropType("leverdoor"))return this.getLeverDoor().isOpen()}return!e||this._baseElem.isPassableByAir()}getDoor(){return this.hasPropType("door")?this.getPropType("door")[0]:null}getLeverDoor(){return this.hasPropType("leverdoor")?this.getPropType("leverdoor")[0]:null}setProp(e,t){if("connection"===t.getType()&&this.hasConnection()){let e=`${this._x},${this._y}`;e+=`\nExisting: ${JSON.stringify(this.getConnection())}`,e+=`\nTried to add: ${JSON.stringify(t)}`,r.default.err("Cell","setProp",`Tried to add 2nd connection: ${e}`)}this._p.hasOwnProperty(e)?e===o?t.has("NonSentient")||t.has("Ethereal")?this._p[e].push(t):this._p[e].unshift(t):this._p[e].push(t):(this._p[e]=[],this._p[e].push(t)),t.isOwnable&&t.setOwner(this)}removeProps(e){delete this._p[e]}removeProp(e,t){if(this.hasProp(e)){const n=this._p[e].indexOf(t);return-1!==n&&(this._p[e].splice(n,1),0===this._p[e].length&&delete this._p[e],!0)}return!1}toString(){let e="Map.Cell "+this._x+", "+this._y;return e+=" explored: "+this._explored,e+=" passes light: "+this.lightPasses(),Object.keys(this._p).forEach(t=>{const n=this._p[t];for(let t=0;t<n.length;t++)n[t].hasOwnProperty("toString")?e+=n[t].toString():n[t].hasOwnProperty("toJSON")&&(e+=JSON.stringify(n[t].toJSON()))}),e}hasUsable(){const e=this.getProp(r.default.TYPE_ELEM);if(e)for(let t=0;t<e.length;t++)if(e[t].onUse)return!0;return!1}toJSON(){const e={t:a.ELEM_MAP.elemTypeToIndex[this._baseElem.getType()]};return this._explored&&(e.ex=1),e}getPropNames(){const e=[this._baseElem.getType()];return Object.keys(this._p).forEach(t=>{this.getProp(t).forEach(t=>{e.push(t.getName())})}),e}hasPropType(e){if(this._baseElem.getType()===e)return!0;const t=Object.keys(this._p);for(let n=0;n<t.length;n++){const s=t[n],r=this._p[s];for(let t=0;t<r.length;t++)if(r[t].getType()===e)return!0}return!1}getPropType(e){const t=[];return this._baseElem.getType()===e?[this._baseElem]:(Object.keys(this._p).forEach(n=>{const s=this._p[n];for(let n=0;n<s.length;n++)s[n].getType()===e&&t.push(s[n])}),t)}findObj(e){const t=[];return Object.keys(this._p).forEach(n=>{this._p[n].forEach(n=>{e(n)&&t.push(n)})}),t}isOutdoors(){return!this._baseElem.has("Indoor")}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=n(53),a=n(85),o=n(127),i=s(n(25));t.VirtualActor=class extends r.BaseActor{constructor(e){super(e),this._brain=new a.BrainVirtual(this)}};t.WeatherActor=class extends r.BaseActor{constructor(e){super(e),this._brain=new o.BrainWeather(this)}};t.SpawnerActor=class extends r.BaseActor{constructor(e){super(e),this._brain=new a.BrainSpawner(this),this.add(new i.Stats),this.get("Stats").setSpeed(10)}getSpeed(){return this.get("Stats").getSpeed()}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(18),o=n(19),i=n(17)("bitn:game.battle"),l=a.EventPool.getPool();t.Army=class{constructor(e){this._name=e,this._actors=[],this._battle=null,this._casualties=0,this._defeatThreshold=0,this.hasNotify=!0,this._alignment={},l.listenEvent(r.default.EVT_ACTOR_KILLED,this)}getName(){return this._name}addAlignment(e,t){this._alignment[e]=t}setDefeatThreshold(e){this._defeatThreshold=e}isDefeated(){return this._actors.length<=this._defeatThreshold}setBattle(e){this._battle=e}getBattle(){return this._battle}getCasualties(){return this._casualties}getActors(){return this._actors.slice()}hasActor(e){const t=e.getID();return this._actors.findIndex(e=>e.getID()===t)>=0}addActor(e){return this.hasActor(e)?(r.default.err("Game.Army","addActor","Actor already in army "+this.getName()),!1):(this._actors.push(e),!0)}removeActor(e){const t=this._actors.findIndex(t=>t.getID()===e.getID());return t>=0&&(this._actors.splice(t,1),!0)}removeAllActors(){this._actors=[]}notify(e,t){if(e===r.default.EVT_ACTOR_KILLED){i(`${this._name} got EVT_ACTOR_KILLED`);const e=t.actor;if(this.hasActor(e))if(this.removeActor(e)){++this._casualties;let t=`Battle: ${this.getBattle().getName()}, Army ${this._name}`;t+=` Actor: ${e.getID()}`,i(`\tCasualties: ${this._casualties} ${t}`);const n={type:"Actor killed",army:this};i(`${this._name} emit EVT_ARMY_EVENT`),l.emitEvent(r.default.EVT_ARMY_EVENT,n),0===this._actors.length&&(i("<>Army<> "+this._name+" decimated"),i(`\tCasualties: ${this._casualties}`),l.removeListener(this))}else{let t="Battle: "+this.getBattle().getName();t+="Couldn't remove the actor "+e.getName(),r.default.err("Game.Army","notify",t)}}}toJSON(){return{name:this._name,actors:this._actors.map(e=>e.getID()),defeatThreshold:this._defeatThreshold,alignment:this._alignment}}};t.Battle=class{constructor(e){this._name=e,this._armies=[],this._level=null,this.finished=!1,this._stats={duration:0,casualties:0,survivors:0},this.hasNotify=!0,l.listenEvent(r.default.EVT_ARMY_EVENT,this)}getType(){return"battle"}getArmies(){return this._armies.slice()}setArmies(e){this._armies=e,this._armies.forEach(e=>{e.setBattle(this)})}getName(){return this._name}setLevel(e){this._level=e,this._level.setParent(this)}getLevel(){return this._level}getStats(){return this._stats}setStats(e){this._stats=e}addArmy(e,t,n,s){const a=!!s.horizontal,o=s.numRows>0?s.numRows:1;if(r.default.isNullOrUndef([this._level]))r.default.err("Game.Battle","addArmy","Level must exist before adding army.");else{this._armies.push(e);const s=e.getActors(),r=Math.ceil(s.length/o);if(a){let e=0;for(let a=0;a<o;a++)for(let o=0;o<r;o++)e<s.length&&this.addActor(s[e++],t+o,n+a)}else{let e=0;for(let a=0;a<o;a++)for(let o=0;o<r;o++)e<s.length&&this.addActor(s[e++],t+a,n+o)}}e.setBattle(this)}addActor(e,t,n){const s=this._level.getMap().getCell(t,n);s.isPassable()||s.setBaseElem(o.ELEM.FLOOR),this._level.addActor(e,t,n)||r.default.err("Game.Battle","addActor",`Cannot add ${e} to ${t},${n}`)}armyInThisBattle(e){return this._armies.indexOf(e)>=0}isOver(){if(this._armies.length>1){let e=0;if(this._armies.forEach(t=>{t.isDefeated()||++e}),e<=1)return!0}else r.default.err("Game.Battle","isOver","Battle should have >= 2 armies.");return!1}notify(e,t){if(e===r.default.EVT_ARMY_EVENT){const e=this.getName();i(`${e} got EVT_ARMY_EVENT`);const{type:n,army:s}=t;if(this.armyInThisBattle(s)&&"Actor killed"===n&&!this.finished&&this.isOver()){i(`Battle |${e}| is over!`),i("\tRemoving all event listeners"),l.removeListener(this);const t={battle:this};i(`${e} emit EVT_BATTLE_OVER`),l.emitEvent(r.default.EVT_BATTLE_OVER,t),this.finished=!0}}}toJSON(){return{isJSON:!0,name:this._name,level:this._level.getID(),armies:this._armies.map(e=>e.toJSON()),stats:this._stats,finished:this.finished}}removeListeners(){this._armies.forEach(e=>{l.removeListener(e)}),l.removeListener(this)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(12),o=n(9),i=n(22),l=n(35),c=n(26),u=n(19),h=o.Random.getRNG();t.LevelSurroundings=class{surround(e,t){if(t.cellsAround)return this.surroundWithCellsAround(e,t);const n=JSON.stringify(t);return r.default.err("LevelSurroundings","surround",`No conf given for surround. Got: ${n}`),null}surroundWithCellsAround(e,t){const n=2*t.surroundX||20,s=2*t.surroundY||20,{cols:r,rows:o}=e.getMap(),u=r+n,h=o+s,{cellsAround:d}=t,p=new c.MapGenerator,f=new i.Level;if(this.hasAnyMountains(d)){const e=this.getWallConfFromCells(t,n,s),r=p.createWall(u,h,e);f.setMap(r.map)}else{const e=new l.CellMap(u,h);f.setMap(e)}const m={wallmount:!0};return Object.keys(d).forEach(e=>{if("water"===d[e]){const t={ratio:.6,skipTypes:m,forestSize:300,nForests:10},n=a.Geometry.dirToBbox(u,h,e);p.addLakes(f.getMap(),t,n)}else if("tree"===d[e]){const t={ratio:1,skipTypes:m,nForests:10},n=a.Geometry.dirToBbox(u,h,e);p.addForest(f.getMap(),t,n)}}),a.Geometry.mergeLevels(f,e,n/2,s/2),this.offsetFunc=((e,t)=>[e+n/2,t+s/2]),this.adjustCoord=(e=>e.map(e=>this.offsetFunc(e[0],e[1]))),this.lastLevelID=f.getID(),f}getWallConfFromCells(e,t,n){const{cellsAround:s}=e,r={};return"wallmount"===s.N?r.alignVertical="top":"wallmount"===s.S&&(r.alignVertical="bottom"),"wallmount"===s.E?(r.alignHorizontal="right",r.north=!0,r.south=!0):"wallmount"===s.W&&(r.alignHorizontal="left",r.north=!0,r.south=!0),r.meanWx=h.getUniformInt(5,t),r.meanWy=h.getUniformInt(5,n),r.wallElem=u.ELEM.WALL_MOUNT,r}hasAnyMountains(e){const t=Object.values(e);let n=!1;return t.forEach(e=>{"wallmount"===e&&(n=!0)}),n}scaleExtras(e){this.lastLevelID!==e.getID()&&r.default.err("LevelSurroundings","scaleExtras","Previous surrounded level not given. Scaling will not work");const t=e.getExtras();["corridor","entrance","room","storeroom","vault"].forEach(e=>{e in t&&this.scaleRooms(t[e])}),t.hasOwnProperty("houses")&&Object.values(t.houses).forEach(e=>{const t=e.getBbox(),[n,s]=this.offsetFunc(t.ulx,t.uly);e.adjustCoord(n,s)})}scaleRooms(e){e.forEach(e=>{[e._x1,e._y1]=this.offsetFunc(e._x1,e._y1),[e._x2,e._y2]=this.offsetFunc(e._x2,e._y2)})}}},function(e,t,n){var s=n(339);e.exports=function(e,t,n){if(s(e),void 0===t)return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,s){return e.call(t,n,s)};case 3:return function(n,s,r){return e.call(t,n,s,r)}}return function(){return e.apply(t,arguments)}}},function(e,t,n){var s=n(71);e.exports=function(e,t){if(!s(e))return e;var n,r;if(t&&"function"==typeof(n=e.toString)&&!s(r=n.call(e)))return r;if("function"==typeof(n=e.valueOf)&&!s(r=n.call(e)))return r;if(!t&&"function"==typeof(n=e.toString)&&!s(r=n.call(e)))return r;throw TypeError("Can't convert object to primitive value")}},function(e,t){var n={}.toString;e.exports=function(e){return n.call(e).slice(8,-1)}},function(e,t){e.exports=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t){var n=Math.ceil,s=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?s:n)(e)}},function(e,t,n){var s=n(146)("keys"),r=n(110);e.exports=function(e){return s[e]||(s[e]=r(e))}},function(e,t,n){var s=n(48),r=s["__core-js_shared__"]||(s["__core-js_shared__"]={});e.exports=function(e){return r[e]||(r[e]={})}},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t,n){var s=n(143);e.exports=function(e){return Object(s(e))}},function(e,t){e.exports=!0},function(e,t,n){var s=n(70),r=n(347),a=n(147),o=n(145)("IE_PROTO"),i=function(){},l=function(){var e,t=n(197)("iframe"),s=a.length;for(t.style.display="none",n(348).appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),l=e.F;s--;)delete l.prototype[a[s]];return l()};e.exports=Object.create||function(e,t){var n;return null!==e?(i.prototype=s(e),n=new i,i.prototype=null,n[o]=e):n=l(),void 0===t?n:r(n,t)}},function(e,t,n){var s=n(55).f,r=n(56),a=n(37)("toStringTag");e.exports=function(e,t,n){e&&!r(e=n?e:e.prototype,a)&&s(e,a,{configurable:!0,value:t})}},function(e,t,n){t.f=n(37)},function(e,t,n){var s=n(48),r=n(36),a=n(150),o=n(153),i=n(55).f;e.exports=function(e){var t=r.Symbol||(r.Symbol=a?{}:s.Symbol||{});"_"==e.charAt(0)||e in t||i(t,e,{value:o.f(e)})}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=r(n(11)),i=r(n(66)),l=r(n(45)),c=r(n(41)),u=n(64),h=n(87),d=n(407),p=n(418),f=n(52),m=n(18),g=n(58),y=n(46),v=n(60),_=n(74),b=n(117),E=n(12),S=n(90),C=n(97),w=n(14),T=n(98),O=n(9),M=n(221),A=n(115),N=n(22),P=n(64),x=m.EventPool.getPool(),I=O.Random.getRNG(),D={Weak:{att:1,def:1,prot:1,hp:15},Medium:{att:2,def:4,prot:2,hp:25},Strong:{att:5,def:6,prot:3,hp:40},Inhuman:{att:10,def:10,prot:4,hp:80}};t.FactoryGame=function(){g.FactoryBase.call(this),this._verif=new l.Conf("Factory.Game"),this._parser=w.ObjectShell.getParser(),this.presetLevels={},this.callbacks={}},a.default.extend2(t.FactoryGame,g.FactoryBase),t.FactoryGame.prototype.restoreGame=function(e){const t=new _.FromJSON,n=new b.GameMain;return t.createGame(n,e)},t.FactoryGame.prototype.createNewGame=function(e){this._verif.verifyConf("createNewGame",e,["sqrPerItem","sqrPerActor","playMode"]);const t=new b.GameMain;if(Number.isInteger(e.seed)){const n=new O.Random(e.seed);t.setRNG(n)}const n=this.createPlayerUnlessLoaded(e);switch(this.createPlayerRegenEvents(t,n),e.playMode){case"Arena":return this.createArenaDebugGame(e,t,n);case"Battle":return this.createDebugBattle(e,t,n);case"Creator":return this.createWorldWithCreator(e,t,n);case"World":return this.createFullWorld(e,t,n);case"OverWorld":return this.createOverWorldGame(e,t,n);case"Quests":return this.createQuestsDebugGame(e,t,n);default:return this.createEmptyGame(e,t,n)}},t.FactoryGame.prototype.createEmptyGame=function(e,t,n){return e.levels&&(e.levels.forEach(e=>{const s=e.getExtras();if(t.addLevel(e),s.startPoint){const[t,r]=s.startPoint;e.addActor(n,t,r)}}),t.addPlayer(n)),t},t.FactoryGame.prototype.createPlayerUnlessLoaded=function(e){let t=e.loadedPlayer;if(a.default.isNullOrUndef([t])){this._verif.verifyConf("createPlayerUnlessLoaded",e,["playerLevel","playerRace","playerName"]);const n=e.playerLevel,s=D[n];(t=this.createPlayer(e.playerName,{att:s.att,def:s.def,prot:s.prot})).setType(e.playerRace),t.add(new o.Health(s.hp)),this.addActorClass(e,t),t.add(new o.Skills),t.add(new o.GameInfo),t.add(new o.BodyTemp),t.add(new o.Abilities)}if(t.has("Hunger")){const e=t.get("Hunger");t.remove("Hunger"),t.add(e)}else{const e=new o.Hunger(2e4);t.add(e)}return a.default.addCellStyle(a.default.TYPE_ACTOR,t.getName(),"cell-actor-player"),"Emilia"===e.playerName?a.default.addCharStyle(a.default.TYPE_ACTOR,t.getName(),"E"):"Oliver"===e.playerName&&a.default.addCharStyle(a.default.TYPE_ACTOR,t.getName(),"O"),t},t.FactoryGame.prototype.createPlayerRegenEvents=function(e,t){const n=new i.RegenEvent(t,a.default.PLAYER_HP_REGEN_PERIOD*a.default.ACTION_DUR);if(e.addEvent(n),t.has("SpellPower")){const n=new i.RegenPPEvent(t,a.default.PLAYER_PP_REGEN_PERIOD*a.default.ACTION_DUR);e.addEvent(n)}},t.FactoryGame.prototype.addActorClass=function(e,t){if(e.playerClass)if(u.ActorClass.hasOwnProperty(e.playerClass)){const n=new o.ActorClass,s=u.ActorClass.create(e.playerClass,t);n.setClassName(e.playerClass),n.setActorClass(s),t.add(n);const r=e.playerClass,a=u.ActorClass.getStartingItems(r),i=u.ActorClass.getEquipment(r);y.FactoryItem.addItemsToActor(t,a),y.FactoryItem.equipItemsToActor(t,i),s.setStartingStats(),s.advanceLevel()}else a.default.err("Factory.Game","addActorClass",`${e.playerClass} not found in ActorClass.`)},t.FactoryGame.prototype.setCallback=function(e,t){this.callbacks[e]=t},t.FactoryGame.prototype.createOverWorldGame=function(e,n,s){const r=e.owMultiplier||1,o=t.FactoryGame.getOwConf(r,e),i=Math.floor(o.nLevelsX/2),l=o.nLevelsY-1;o.playerX=i,o.playerY=l,o.playerRace=e.playerRace,o.createTerritory=!0;const u=(new Date).getTime();this.progress("Creating Overworld Tile Map...");const h=C.OWMap.createOverWorld(o);if(this.progress("DONE"),!h._terrMap){this.progress("Generating territory for clans/races...");const t=this.createTerritoryMap(h,e.playerRace,i,l);h.setTerrMap(t),this.progress("DONE")}this.progress("Creating Overworld Level Map...");const d=T.OverWorld.createOverWorldLevel(h,o),[p,f]=d;this.progress("DONE"),this.progress("Mapping settlements into territory areas.."),this.mapZonesToTerritoryMap(h.getTerrMap(),f),this.progress("DONE"),this.progress("Splitting Overworld Level Map into AreaTiles...");const m=S.Builder.splitLevel(p,o);this.progress("DONE"),this.progress("Creating and connecting World.Area tiles..."),new c.Area("Ravendark",o.nLevelsX,o.nLevelsY,100,100,m).connectTiles(),this.progress("DONE");const g=new v.FactoryWorld;g.setOverWorld(h),g.setGlobalConf(e),n.setGlobalConf(e),g.setPresetLevels({Realm:m}),f.createAllZones=!1,this.progress("Creating places and local zones...");const y=m[i][l];this.createPlayerHome(f,s,y,i,l),this.createAreaLevelConstraints(f,h.getTerrMap());const _=g.createWorld(f);n.addPlace(_),h.clearSubLevels(),n.setOverWorld(h),n.setEnableChunkUnload(!0),this.progress("DONE"),this.progress("Adding player to the game..."),this.placePlayer(s,y),x.emitEvent(a.default.EVT_TILE_CHANGED,{actor:s,target:y}),s.setFOVRange(a.default.PLAYER_FOV_RANGE),n.addPlayer(s),this.progress("DONE");const b=(new Date).getTime()-u;return this.progress("World generation took "+b+" ms."),n},t.FactoryGame.prototype.progress=function(e){const t=(new Date).getTime();let n=0;this.timePrev&&(n=(t-this.timePrev)/1e3),this.timePrev=t,this.callbacks.progress&&this.callbacks.progress(e),"DONE"===e&&a.default.log(`${this.prevMsg} - Time: ${n} sec`),this.prevMsg=e},t.FactoryGame.prototype.placePlayer=function(e,t){const n=t.getMap().getFree(),s={};n.forEach(e=>{s[e.getKeyXY()]=!0});let r=null,o=!1,i=1e3;const l=Math.pow(5,2)-1;for(;!o;){r=I.arrayGetRand(n);const[e,t]=r.getXY(),c=E.Geometry.getBoxAround(e,t,2);c.length===l&&(o=!0);for(let e=0;e<c.length;e++){const[t,n]=c[e];o=o&&s[t+","+n]}if(--i<=0){a.default.log("Timeout reached");break}}o?t.addActor(e,r.getX(),r.getY()):t.addActorToFreeCell(e)},t.FactoryGame.prototype.createTerritoryMap=function(e,t,n,s){return M.TerritoryMap.create(e,t,[n,s])},t.FactoryGame.prototype.mapZonesToTerritoryMap=function(e,t){const n=h.ActorsData.filter(e=>"UniqueBase"===e.base),s={};const r=this.getDisposition(),o=e.getMap();t.area[0].city.forEach(t=>{const{owX:i,owY:l}=t,c=o[i][l];let u=e.getName(c),h=null;if(u){if(h=[{op:"eq",prop:"type",value:[u]},{op:"neq",prop:"base",value:["WinterBeingBase"]}],"winterbeing"===u&&(h={op:"eq",prop:"base",value:["WinterBeingBase"]}),a.default.isSuccess(.07)){const e=n.filter(e=>e.type===u);if(e.length>0){const n=I.arrayGetRand(e);if(!s.hasOwnProperty(n.name)){const e={name:n.name,nLevel:0};let r=t.quarter[0].create;r||(r={}),r.actor||(r.actor=[]),r.actor.push(e),s[n.name]=n,t.quarter[0].create=r,0}}}}else{const[t,n]=this.getAreaXYFromOWTileXY(i,l),s=this.getConstrWeightsForAreaXY(t,n,e),r=Object.keys(s);if(s.hasOwnProperty("winterbeing"))h={op:"eq",prop:"base",value:["WinterBeingBase"]};else if(r.length>0)u=I.getWeighted(s),h=[{op:"eq",prop:"type",value:[u]},{op:"neq",prop:"base",value:["WinterBeingBase"]}];else if(0===r.length){a.default.log("factory.game.js",e.mapToString());const s=`owX: ${i}, owY: ${l}`;a.default.err("FactoryGame","mapZonesToTerritoryMap",`No values for AreaTile ${t},${n}, ${s} found`)}}t.constraint||(t.constraint={}),t.constraint.actor=h,t.constraint.disposition=r[u],t.quarter.forEach(e=>{e.constraint||(e.constraint={}),e.constraint.actor=h,e.constraint.disposition=r[u],t.constraint.cellsAround&&(e.constraint.cellsAround=t.constraint.cellsAround)})})},t.FactoryGame.prototype.getDisposition=function(){const e=new p.Disposition(a.default.ALL_RACES);return e.randomize(),e.getTable()},t.FactoryGame.prototype.getAreaXYFromOWTileXY=function(e,t){return new T.OverWorld.CoordMap({xMap:10,yMap:10}).getAreaXYFromOWTileXY(e,t)},t.FactoryGame.prototype.createPlayerHome=function(e,t,n,s,r){let a=n.getFreeRandCell();for(;a.hasConnection();)a=n.getFreeRandCell();const o={name:"Home town of "+t.getName(),x:s,y:r,levelX:a.getX(),levelY:a.getY(),nQuarters:1,groupType:"village",friendly:!0,constraint:{actor:[{op:"eq",prop:"type",value:[t.getType()]},{op:"neq",prop:"base",value:["WinterBeingBase"]}],shop:[{op:"<=",prop:"value",value:50}],cellsAround:E.Geometry.getCellsAround(n.getMap(),a)},quarter:[{name:"Square",nLevels:1,entranceLevel:0,nShops:1}]};console.log("Hometown located @ ",a.getX(),a.getY()),e.area[0].city.push(o)},t.FactoryGame.prototype.createAreaLevelConstraints=function(e,t){const n=e.area[0],s={};for(let e=0;e<n.maxX;e++)for(let r=0;r<n.maxY;r++){const n=this.getConstrWeightsForAreaXY(e,r,t),a=Object.keys(n);a.push("animal"),s[e+","+r]={actor:{op:"eq",prop:"type",value:a}},n.hasOwnProperty("winterbeing")&&(s[e+","+r].actor={op:"eq",prop:"base",value:"WinterBeingBase"})}n.constraint=s},t.FactoryGame.prototype.getConstrWeightsForAreaXY=function(e,t,n){const s=n.getMap(),r=new T.CoordMap({xMap:10,yMap:10}).getOWTileBboxFromAreaTileXY(e,t),a=E.Geometry.getCellsInBbox(s,r),o=E.Geometry.histArrayVals(a);let i=Object.keys(o);i=i.filter(e=>"#"!==e&&"."!==e);const l={};return i.forEach(e=>{const t=n.getName(e);l[t]=o[e]}),l},t.FactoryGame.prototype.createWorldWithCreator=function(e,t,n){new A.WorldConf;return e.world=A.WorldConf.createWorldConf({name:"World",worldSize:"Small",areaSize:"Small"}),this.createFullWorld(e,t,n)},t.FactoryGame.prototype.createFullWorld=function(e,t,n){const s=e.world;if(this.processPresetLevels(s),!s)return a.default.err("Factory","createFullWorld","obj.world must exist!"),null;s.levelSize=e.levelSize;const r=new v.FactoryWorld;r.setGlobalConf(e),r.setPresetLevels(this.presetLevels);const o=r.createWorld(s),i=o.getLevels();let l={place:s.name,x:0,y:0};return s.playerStart&&(l=s.playerStart),i.length>0?(t.addPlace(o),t.addPlayer(n,l),t):(a.default.err("Factory","createFullWorld","There are no levels in the world!"),null)},t.FactoryGame.prototype.processPresetLevels=function(e){if(this.presetLevels={},e.hasOwnProperty("presetLevels")){Object.keys(e.presetLevels).forEach(t=>{this.presetLevels[t]=this.createPresetLevels(e.presetLevels[t]),e.presetLevels[t]=this.presetLevels[t]})}},t.FactoryGame.prototype.createPresetLevels=function(e){const t=new _.FromJSON;return e.map(e=>{if("function"==typeof e.level.getID)return e;const n=t.restoreLevel(e.level);return n.getID()<a.default.LEVEL_ID_ADD&&n.setID(N.Level.createLevelID()),n.getActors().forEach(e=>{e.getID()<a.default.ENTITY_ID_ADD&&e.setID(f.Entity.createEntityID())}),n.getItems().forEach(e=>{e.getID()<a.default.ENTITY_ID_ADD&&e.setID(f.Entity.createEntityID())}),a.default.setAllExplored(n,!1),{nLevel:e.nLevel,level:n}})},t.FactoryGame.prototype.createArenaDebugGame=function(e,t,n){return new d.DebugGame(this,this._parser).createArena(e,t,n)},t.FactoryGame.prototype.createQuestsDebugGame=function(e,t,n){return new d.DebugGame(this,this._parser).createQuestsDebug(e,t,n)},t.FactoryGame.prototype.createDebugBattle=function(e,t,n){return new d.DebugGame(this,this._parser).createDebugBattle(e,t,n)},t.FactoryGame.prototype.createOneDungeonAndBoss=function(e,t,n){return new d.DebugGame(this,this._parser).createOneDungeonAndBoss(e,t,n)},t.FactoryGame.getOwConf=function(e=1,t={}){const n=t.xMult||1,s=t.yMult||1,r={yFirst:!1,topToBottom:!1,stopOnWall:!0,nVWalls:[.8],owTilesX:n*e*40,owTilesY:s*e*40,worldX:n*e*400,worldY:s*e*400,nLevelsX:n*e*4,nLevelsY:s*e*4,nTilesX:n*e*4,nTilesY:s*e*4};return t.owConf&&Object.keys(t.owConf).forEach(e=>{r[e]=t.owConf[e]}),console.log("owConf is",r),r},t.FactoryGame.getGameConf=function(){return{cols:60,rows:30,levels:2,seed:(new Date).getTime(),playerLevel:"Medium",levelSize:"Medium",playerClass:P.ACTOR_CLASSES[0],playerRace:a.default.ACTOR_RACES[0],sqrPerActor:120,sqrPerItem:120,playMode:"OverWorld",loadedPlayer:null,loadedLevel:null,playerName:"Player",world:A.WorldConf,xMult:2,yMult:3}}},function(e,t,n){"use strict";function s(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}Object.defineProperty(t,"__esModule",{value:!0}),s(n(217)),s(n(218)),s(n(219)),s(n(410))},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(17)("bitn:FactoryZone"),i=r(n(45)),l=n(58),c=n(46),u=n(158),h=n(113),d=n(114),p=n(9),f=n(14),m=r(n(15)),g=p.Random.getRNG();t.FactoryZone=function(){l.FactoryBase.call(this),this._verif=new i.Conf("FactoryZone"),this._parser=f.ObjectShell.getParser(),this.rng=g,this.getRandLevelType=(()=>{const e=["uniform","rooms","rogue","digger"];return e[this.rng.randIndex(e)]}),this.setRNG=(e=>{this.rng=e}),this.addItemsAndActors=function(e,t){this._verif.verifyConf("addItemsAndActors",t,["nLevel","sqrPerItem","sqrPerActor","maxValue"]);const n=e.getMap().getFree().length,s=Math.round(n/t.sqrPerActor),r=Math.round(n/t.sqrPerItem),i=r;o(`Adding ${s} monsters and items `+`${r} to the level`);const l=(e,t)=>n=>n.value>=e&&n.value<=t,c={nLevel:t.nLevel,itemsPerLevel:r,func:l(0,t.maxValue),maxValue:t.maxValue,food:!0,gold:!0};t.hasOwnProperty("food")&&(c.food=t.food),t.hasOwnProperty("gold")&&(c.gold=t.gold),t.item?(c.func=t.item,o(`Set itemConf.func to ${t.item.toString()}`)):t.minValue&&(c.func=l(t.minValue,t.maxValue)),this.addNRandItems(e,this._parser,c);const u={actorsPerLevel:t.actorsPerLevel||s,maxDanger:t.maxDanger||t.nLevel+1};if(t.actor&&("function"==typeof t.actor?u.func=t.actor:a.default.err("FactoryZone","addItemsAndActors","conf.actor must be a function")),this.addNRandActors(e,this._parser,u),c.gold){const n={goldPerLevel:i,nLevel:t.nLevel+1};this.addRandomGold(e,this._parser,n)}},this.createDungeonLevel=function(e){this._verif.verifyConf("createDungeonLevel",e,["x","y"]);let t=null,n=this.getRandLevelType();return e.dungeonType&&""!==e.dungeonType&&(n=e.dungeonType),o(`dungeonLevel: ${n}, ${JSON.stringify(e)}`),t=this.createLevel(n,e.x,e.y,e),this.addItemsAndActors(t,e),this.addExtraDungeonFeatures(t,e),t},this.createMountainLevel=function(e){let t=Object.assign(u.MountainGenerator.getFaceOptions(),{maxValue:100,sqrPerActor:50,sqrPerItem:200,nLevel:4});t=Object.assign(t,e),o(`Creating mountain level with ${e}`);const n=(new u.MountainGenerator).createFace(e.x,e.y,t);return this.addItemsAndActors(n,t),n},this.createSummitLevel=function(e){this._verif.verifyConf("createSummitLevel",e,["cols","rows"]);let t={maxValue:100,sqrPerActor:20,sqrPerItem:200,nLevel:4};t=Object.assign(t,e);const n=(new u.MountainGenerator).createSummit(e.cols,e.rows,t);return o(`Creating summit level with ${e}`),this.addItemsAndActors(n,t),e.maxValue||(e.maxValue=t.maxValue),n},this.createCityLevel=function(e,t){const n=l.Factory.cityConfBase(t);n.parser=this._parser;let s=null;const{x:r,y:a}=t;if(n.groupType)switch(n.groupType){case"village":s=this.createVillageLevel(r,a,n);break;case"capital":s=this.createCapitalLevel(e,r,a,n);break;case"stronghold":s=this.createStrongholdLevel(r,a,n);break;case"fort":s=this.createFortLevel(r,a,n)}if(null===s&&(s=this.createLevel("town",r,a,n),this.populateCityLevel(s,n)),t.friendly){s.getActors().forEach(e=>{e.has("NonSentient")||e.getBrain().getMemory().removeEnemyType("player")})}if(t.disposition){const{disposition:e}=t;s.getActors().forEach(t=>{Object.keys(e).forEach(n=>{"enemy"===e[n]&&t.getBrain().getMemory().addEnemyType(n)})})}return s},this.createVillageLevel=function(e,t,n){n.levelType="empty",n.wallType="wooden",n.actorsPerLevel||(n.actorsPerLevel=30),n.maxDanger||(n.maxDanger=3),n.itemsPerLevel||(n.itemsPerLevel=2*n.maxDanger);const s=(new h.CityGenerator).create(e,t,n);return this.populateCityLevel(s,n),this.addItemsToCityLevel(s,n),s},this.createFortLevel=function(e,t,n){const s=new d.CastleGenerator;n.roomCount=-1,n.maxDanger||(n.maxDanger=6);const r=s.create(100,84,n);return this.populateCityLevel(r,n),r},this.createCapitalLevel=function(e,t,n,s){s.levelType="miner";let r=null;return 0===e?(s.levelType="townwithwall",r=this.createLevel("townwithwall",200,84,s)):r=this.createLevel("town",100,84,s),this.populateCityLevel(r,s),r},this.createStrongholdLevel=function(e,t,n){n.levelType="miner";const s=this.createLevel("town",100,84,n);return this.populateCityLevel(s,n),s},this.populateCityLevel=function(e,t){let n=t.alignment;n||(n=this.rng.arrayGetRand(a.default.ALIGNMENTS)),t.actor?this.populateWithActors(e,t):n===a.default.ALIGN_GOOD?this.populateWithHumans(e,t):n===a.default.ALIGN_EVIL?this.populateWithEvil(e,t):this.populateWithNeutral(e,t)},this.addItemsToCityLevel=function(e,t){const n=e.getMap().getCells(e=>"floorhouse"===e.getBaseElem().getType()),s=new c.FactoryItem,r=f.ObjectShell.getParser(),o={func:e=>e.value<=10*t.maxDanger,maxValue:50*t.maxDanger};a.default.isNullOrUndef([t.itemsPerLevel])||(o.itemsPerLevel=t.itemsPerLevel),s.addItemsToCells(e,r,n,o)},this.populateWithActors=function(e,t){const n={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,func:t.actor};if(0===this.addNRandActors(e,this._parser,n)){const t=e.getParent();let s="No actors added to level.";s+="\nUsed conf was "+JSON.stringify(n),t&&(s+="\nLevel parent: "+t.getName()),a.default.err("FactoryZone","populateWithActors",s)}},this.populateWithHumans=function(e,t){const n={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,func:e=>"human"===e.type&&"shopkeeper"!==e.name};t.func&&(n.func=t.func),this.addNRandActors(e,this._parser,n)},this.populateWithEvil=function(e,t){let n=!1;for(;!n;){const s=this.rng.arrayGetRand(a.default.EVIL_RACES),r={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,func:e=>e.type===s};t.func&&(r.func=t.func),n=this.addNRandActors(e,this._parser,r)}},this.populateWithNeutral=function(e,t){const n=this.rng.arrayGetRand(a.default.NEUTRAL_RACES),s={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,func:e=>e.type===n};t.func&&(s.func=t.func),this.addNRandActors(e,this._parser,s)},this.addActorToLevel=((e,t)=>{const n=this._parser.createActor(e),s=t.getFreeRandCell();t.addActor(n,s.getX(),s.getY())}),this.addExtraDungeonFeatures=((e,t)=>{const n=e.getExtras();if(n.rooms){n.rooms.forEach(t=>{t.getDoors((t,n)=>{e.addElement(new m.ElementDoor(!0),t,n)})});const s=this.rng.arrayGetRand(n.rooms).getBbox();this.addActorsToBbox(e,s,t)}})},a.default.extend2(t.FactoryZone,l.FactoryBase)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(26),r=n(22),a=n(12),o=n(21),i=n(68),l=n(9),c=n(19),u=n(59),h=l.Random.getRNG();class d{static getSummitOptions(){const e=u.LevelGenerator.getOptions();return Object.assign({},d.options.summit,e)}static getFaceOptions(){const e=u.LevelGenerator.getOptions(),t=s.MapGenerator.getOptions("mountain");return Object.assign({},t,d.options.face,e)}createMountain(e,t,n){return[this.createFace(e,t,n),this.createSummit(e,t,n)]}createFace(e,t,n){const a=new s.MapGenerator,o=new r.Level;a.setGen("mountain",e,t),n.nRoadTurns=0;const i=a.createMountain(e,t,n);return o.setMap(i.map),this.createCrux(o,n),o}createSummit(e,t,n){const a=new s.MapGenerator,o=new r.Level;a.setGen("mountain",e,t);const i=a.createSummit(e,t,n);return o.setMap(i.map),o.setExtras({}),o}createCrux(e,t){const n=e.getMap(),r=n.cols,o=Math.round(n.rows/6),l={wallElem:c.ELEM.HIGH_ROCK,meanWy:Math.round(o/2.5)},u=new s.MapGenerator;u.setGen("wall",r,o);const d=u.createWall(r,o,l).map,p=h.getUniformInt(0,r-1),f=h.getUniformInt(0,r-1),m=this.carvePath(d,p,0,f,o-1),g=Math.round(n.rows/5);a.Geometry.mergeMaps(n,d,0,g,(e,t)=>{const n=t.getBaseElem();return!/(floor)/.test(n.getType())});const y={startX:0,startY:0,maxY:g,yPerTurn:Math.round(g/4),endX:p};let v=u.createMountainPath(n,y);y.startY=g+o,y.maxY=n.rows-1,y.startX=f,y.yPerTurn=0,v=v.concat(u.createMountainPath(n,y)),e.addExtras("paths",v),m.forEach(e=>{e[1]+=g});const _=new i.DungeonPopulate(t);for(let n=0;n<3;n++){const n=h.arrayGetRand(m);_.addPointGuardian(e,n,t.maxDanger)}}carvePath(e,t,n,s,r){const i=[];return o.Path.getShortestPath(t,n,s,r).forEach(t=>{a.Geometry.getCrossAround(t.x,t.y,2,!0).forEach(t=>{const[n,s]=t;e.hasXY(n,s)&&(i.push(t),e.setBaseElemXY(n,s,c.ELEM.STONE))})}),i}}t.MountainGenerator=d,d.options={},d.options.face={},d.options.summit={ratio:.3}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=s(n(23)),o=n(59),i=n(35),l=n(22),c=n(12),u=n(26),h=n(21),d=n(68),p=n(9),f=n(19),m=n(14),g=n(15),y=1,v=p.Random.getRNG(),_=h.Path.getShortestPath,b=10,E={chasm:{elem:f.ELEM.CHASM},water:{elem:f.ELEM.WATER},forest:{elem:f.ELEM.TREE},fire:{elem:f.ELEM.LAVA}},S=.75,C={BIG_VAULT:.07,BIG_ROOM:.2,bigRoomWeights:{cross:1,corridor:1,vault:1,center:1}},w={cross:{special:["splashes"]},"small vault":{},"large vault":{},"large corridor":{special:["splashes"]},center:{}},T=function(e,t){this.room=t,this.type=e};class O extends o.LevelGenerator{static getOptions(e="digger"){const t=o.LevelGenerator.getOptions(),n={levelType:e,nBigRooms:1,bigRoomX:["cen"],bigRoomY:["cen"],bigRoomWidth:[10],bigRoomHeight:[10],minNumRooms:3,rerunOnFailure:!0,errorOnFailure:!1},s={options:M[e]};return Object.assign(n,s,t)}constructor(){super(),this.addDoors=!0,this.shouldRemoveMarkers=!0}create(e,t,n){const s=this._createLevel(e,t,n);return this.addSpecialFeatures(s),this.addStairsLocations(s),this.addCriticalPath(s),new d.DungeonPopulate({theme:""}).populateLevel(s),(n.rerunOnFailure||n.errorOnFailure)&&(this.verifyLevel(s,n)||this.create(e,t,n)),this.removeMarkers(s,n),s}_createLevel(e,t,n){e||(e=v.getUniformInt(80,120)),t||(t=v.getUniformInt(28,56));const s=n.minNumRooms||3;let r=null,a=null;const o=(e,t,n)=>{n===y&&a.setBaseElemXY(e,t,f.ELEM.WALL)};let c=10;for(;(!r||r.getRooms().length<s)&&(r=this.getMapGen(e,t,n),a=new i.CellMap(e,t),r.create(o),0!=--c););const u=new l.Level;u.setMap(a);const h={rooms:r.getRooms(),corridors:r.getCorridors()};return r.bigRooms&&(h.bigRooms=r.bigRooms),u.setExtras(h),u}getMapGen(e,t,n){let s=A();n.dungeonType&&""!==n.dungeonType&&(s=n.dungeonType);const r=n.options||M[s],o=new a.default.Map.Digger(e,t,r),i=this.addBigRooms(o,n);return i.length>0&&(o.bigRooms=i),o}addBigRooms(e,t){let n=[];if(t.nBigRooms>0&&(n=this.addCustomBigRooms(e,t)),v.getUniform()<=C.BIG_ROOM&&0===t.nBigRooms){const t=this.getBigRoomType();/center/.test(t)&&(n=this.addBigCenterRoom(e)),/large corridor/.test(t)&&(n=this.addLargeCorridorRoom(e)),/cross/.test(t)&&(n=this.addLargeCross(e)),/vault/.test(t)&&(n=this.addVault(e))}return n}getBigRoomType(){return v.arrayGetRand(Object.keys(w))}addCustomBigRooms(e,t){const[n,s]=e.getCenterXY(),[r,o]=[e.getCols(),e.getRows()],i=t.nBigRooms||0,l=[];for(let c=0;c<i;c++){let i=Math.floor(r/4);t.bigRoomWidth&&t.bigRoomWidth[c]&&(i=t.bigRoomWidth[c]);let u=Math.floor(o/4);t.bigRoomHeight&&t.bigRoomHeight[c]&&(u=t.bigRoomHeight[c]);const h=r-2-i;let d=v.getUniformInt(1,h),p="";t.bigRoomX&&(p=t.bigRoomX[c]),/cen/.test(p)&&(d=n-Math.floor(i/2));const f=o-2-u;let m=v.getUniformInt(1,f),g="";t.bigRoomY&&(g=t.bigRoomY[c]),/cen/.test(g)&&(m=s-Math.floor(u/2));const y=d+(i-1),_=m+(u-1),b=new a.default.Map.Feature.Room(d,m,y,_);e._options.dugPercentage+=.1,e.addRoom(b),l.push(new T("custom",b))}return l}addBigCenterRoom(e){const[t,n]=[e.getCols(),e.getRows()],[s,r]=e.getCenterXY(),o=v.getUniformInt(2,5),i=v.getUniformInt(2,6),l={roomWidth:[Math.floor(t/(i+1)),Math.floor(t/i)],roomHeight:[Math.floor(n/o),Math.floor(n/o)]},c=a.default.Map.Feature.Room.createCenter(s,r,l);return e._options.dugPercentage+=.2,e.addRoom(c),[new T("center",c)]}addLargeCorridorRoom(e){const[t,n]=[e.getCols(),e.getRows()],s=v.getCardinalDirLetter(),o="large corridor "+s;let i=null;if("E"===s){const e=v.getUniformInt(2,6),s=Math.floor(t/e);i=new a.default.Map.Feature.Room(1,1,s,n-2)}if("W"===s){const e=v.getUniformInt(2,6),s=t-2-Math.floor(t/e);i=new a.default.Map.Feature.Room(s,1,t-2,n-2)}if("N"===s){const e=v.getUniformInt(2,5),s=Math.floor(n/e);i=new a.default.Map.Feature.Room(1,1,t-2,s)}if("S"===s){const e=v.getUniformInt(2,5),s=n-2-Math.floor(n/e);i=new a.default.Map.Feature.Room(1,s,t-2,n-2)}return i||r.default.err("DungeonGenerator","addLargeCorridorRoom","room null something went wrong"),e._options.dugPercentage+=.2,e.addRoom(i),[new T(o,i)]}addLargeCross(e){const[t,n]=[e.getCols(),e.getRows()],[s,r]=e.getCenterXY(),o=v.getUniformInt(3,8),i=Math.floor(t/o),l=Math.floor(n/o),c={roomWidth:[t-2,t-2],roomHeight:[l,l]},u={roomHeight:[n-2,n-2],roomWidth:[i,i]},h=a.default.Map.Feature.Room.createCenter(s,r,c),d=a.default.Map.Feature.Room.createCenter(s,r,u);e.addRoom(h),e.addRoom(d);const p=(h.getAreaSize()+d.getAreaSize())/(t*n);return e._options.dugPercentage+=1.6*p,e._options.dugPercentage>=S&&(e._options.dugPercentage=S),[new T("crossHor",h),new T("crossVer",d)]}addVault(e){const[t,n]=[e.getCols(),e.getRows()],s=v.getUniform()<=C.BIG_VAULT;let r=Math.floor(t/2),o=Math.floor(n/2),i=["NE","NW","SW","SE"],l="small vault";s&&(v.getUniform()<=.5?(i=["NE","NW"],r=Math.floor(t/2),o=n-2):(i=["NW","SW"],r=t-2,o=Math.floor(n/2)),e._options.dugPercentage+=.25,l="large vault");const[c,u]=this.getRandCorner(r,o,t,n,i),h=c+r-1,d=u+o-1,p=new a.default.Map.Feature.Room(c,u,h,d);return e._options.dugPercentage+=.2,e.addRoom(p),[new T(l,p)]}getRandCorner(e,t,n,s,r){const a=v.arrayGetRand(r);let[o,i]=[1,1];switch(a){case"NW":o=1,i=1;break;case"NE":o=n-2-e,i=1;break;case"SW":o=1,i=s-2-t;break;case"SE":o=n-2-e,i=s-2-t}return[o,i]}addSpecialFeatures(e){const t=e.getExtras(),n=e.getMap();if(t.bigRooms){const n=t.bigRooms[0];let s={};if(Object.keys(w).forEach(e=>{new RegExp(e).test(n.type)&&(s=w[e])}),s.special){const n=v.arrayGetRand(s.special);this.addBigRoomSpecialFeat(e,n,t.bigRooms)}}if(t.rooms){const s=v.arrayGetRand(t.rooms),r=[];this.addFireToRoom(e,s),t.rooms.forEach((t,s)=>{t.setID(s);let a=0;const o=t.getOuterBbox();c.Geometry.getBorderForBbox(o).forEach(t=>{if(n.has(t,"floor"))++a;else{const n=new g.ElementMarker("w");n.setTag("room wall"),e.addElement(n,t[0],t[1])}}),this.addDoorsForRoom(e,t),1===a&&r.push(t)}),r.forEach(t=>{const n=t.getInnerBbox();c.Geometry.getCoordBbox(n).forEach(t=>{const n=new g.ElementMarker("t");n.setTag("term"),e.addElement(n,t[0],t[1])})}),t.terms=r}}addBigRoomSpecialFeat(e,t,n){n.forEach(n=>{const s=n.room;switch(s||r.default.err("DungeonGenerator","addBigRoomSpecialFeat","room is null for "+JSON.stringify(n)),t){case"splashes":this.addElemSplashes(e,s)}})}addDoorsForRoom(e,t){this.addDoors&&t.getDoors((t,n)=>{if(!e.getMap().getCell(t,n).hasDoor()){const s=new g.ElementDoor(!0);e.addElement(s,t,n)}})}addElemSplashes(e,t){const n=v.arrayGetRand(Object.keys(E)),s=E[n],r=s.elem;e.getExtras().theme=s;const a=t.getLeft()+1,o=t.getTop()+1,i=t.getWidth(),l=t.getHeight(),{map:h}=u.MapGenerator.createSplashes(i,l,{nForests:10,elem:r});c.Geometry.mergeMapBaseElems(e.getMap(),h,a,o)}addFireToRoom(e,t){const n=m.ObjectShell.getParser();Object.values(t.getCorners()).forEach(t=>{const s=n.createActor("Fire");e.addActor(s,t[0],t[1])})}addStairsLocations(e){const t=e.getExtras();let n=r.default.WATCHDOG;if(t.rooms){let[s,r]=v.getUniqueItems(t.rooms,2),a=null,o=null,i=0,l=0;const c=Math.floor(e.getMap().cols/2)+Math.floor(e.getMap().rows/2);for(;i<c&&([s,r]=v.getUniqueItems(t.rooms,2),(i=N(e,s,r))>l&&(l=i,a=s,o=r),0!=--n););s=a,r=o;const[u,h]=s.getCenter(),[d,p]=r.getCenter();t.startPoint=[d,p],t.endPoint=[u,h];const{startPoint:f,endPoint:m}=t;this.addStartAndEndPoint(e,f,m),s.addStairs(u,h,!0),r.addStairs(d,p,!1)}else{const e="rooms must be set as level extras";r.default.err("DungeonGenerator","addStairsLocations","Not enough rooms to add stairs. "+e)}}addCriticalPath(e){const t=e.getExtras(),[n,s]=t.startPoint,[a,o]=t.endPoint,i=e.getMap(),l=(e,t)=>i.isPassable(e,t)||i.getCell(e,t).hasDoor();let c=h.Path.getShortestPath(n,s,a,o,l);if(0===c.length){const e=(e,t)=>!/wall/.test(i.getCell(e,t).getBaseElem().getType());0===(c=h.Path.getShortestPath(n,s,a,o,e))?r.default.err("DungeonGenerator","addCriticalPath","No path found between stairs"):c.forEach(e=>{const{x:t,y:n}=e;i.isPassable(t,n)||i.setBaseElemXY(t,n,f.ELEM.BRIDGE)})}const u=(e,t)=>l(e,t)&&!i.getCell(e,t).hasMarker("path broken");let d=c;for(;c.length<50;){if(!this._breakPath(e,c))break;if(0===(c=_(n,s,a,o,u)).length){this.restorePath(e,d),c=d;break}d=c}this._addWallsToBrokenPath(e),c.forEach(t=>{const n=new g.ElementMarker("*");n.setTag("critical_path"),e.addElement(n,t.x,t.y)}),t.criticalPath=c}_breakPath(e,t){for(let n=0;n<t.length;n++){const{x:s,y:r}=t[n];if(e.getMap().getCell(s,r).hasDoor()){const t=new g.ElementMarker("X");return t.setTag("path broken"),e.addElement(t,s,r),!0}}return!1}_addWallsToBrokenPath(e){e.getElements().filter(e=>"marker"===e.getType()&&"path broken"===e.getTag()).forEach(t=>{const[n,s]=t.getXY();e.getMap().setBaseElemXY(n,s,f.ELEM.WALL)})}restorePath(e,t){for(let n=0;n<t.length;n++){const{x:s,y:r}=t[n];if(e.getMap().getCell(s,r).hasMarker("path broken")){e.getElements().filter(e=>e.isAtXY(s,r)).forEach(t=>{"marker"===t.getType()&&"path broken"===t.getTag()&&e.removeElement(t,s,r)})}}}verifyLevel(e,t){const n=e.getMap(),s=e=>e.isPassable()||e.hasDoor(),a=n.getCells(s),o=a[0],i=c.Geometry.floodfill(n,o,s),l=a.length,u=i.length;if(u!==l){const n=l-u;if(n>b){if(t.errorOnFailure){e.debugPrintInASCII();const t=`Max: ${b}, got: ${n}`;r.default.err("DungeonGenerator","verifyLevel","floodfill cannot reach all cells! "+t)}return!1}}return!0}}t.DungeonGenerator=O,O.mapOptions={digger:{roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2},uniform:{roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1}};const M=O.mapOptions,A=()=>v.arrayGetRand(["uniform","digger"]);function N(e,t,n){const s=e.getMap(),[r,a]=t.getCenter(),[o,i]=n.getCenter();return h.Path.getShortestPassablePathWithDoors(s,r,a,o,i).length}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(26),i=n(22),l=n(68),c=n(59),u=n(21),h=n(12),d=n(9),p=n(19),f=r(n(15)),m=d.Random.getRNG(),g=f.ElementMarker;function y(e,t,n=1){const s=Math.round(e/2),r=Math.round(t/2),a=e-1-n,o=t-1-n;return{N:{x:s,y:1,dirWeights:{E:1,W:1,S:5,SE:5,SW:5},dugCallback:(e,t,n)=>{t===o&&(n.dirWeights={})}},S:{x:s,y:o,dirWeights:{E:1,W:1,N:5,NE:5,NW:5},dugCallback:(e,t,n)=>{1===t&&(n.dirWeights={})}},E:{x:a,y:r,dirWeights:{N:1,S:1,NW:5,W:5,SW:5}},W:{x:1,y:r,dirWeights:{N:1,S:1,NE:5,E:5,SE:5}},NE:{x:a,y:1,dirWeights:{NW:1,W:10,SW:5,S:10}},NW:{x:1,y:1,dirWeights:{NE:1,E:10,SE:5,S:10}},SE:{x:a,y:o,dirWeights:{SW:1,W:10,NW:5,N:10}},SW:{x:1,y:o,dirWeights:{SE:1,E:10,NE:5,N:10}},C:{x:s,y:r,dirWeights:{N:1,S:1,E:2,W:2,NE:1,SE:1,NW:1,SW:1}}}}function v(e){const t=e[0],n={startX:t.x,startY:t.y,dirWeights:t.dirWeights},s=[];for(let t=1;t<e.length;t++)s.push(e[t]);return n.addMiners=s,n}t.CaveGenerator=class extends c.LevelGenerator{static getOptions(){const e=c.LevelGenerator.getOptions();return Object.assign(e,{dungeonType:"Lair",isCollapsed:!1})}constructor(){super(),this.shouldRemoveMarkers=!0}create(e,t,n){a.default.isNullOrUndef([e,t])&&a.default.err("CaveGenerator","create",`cols or rows not defined: cols: ${e} / rows: ${t}`);const s=this._createLevel(e,t,n);return this.addStairsLocations(s),this._addSpecialFeatures(s),this._addEncounters(s,n),this.removeMarkers(s,n),s}_createLevel(e,t,n){const s=this._createMapOptions(e,t,n),r=new o.MapGenerator,a=new i.Level;r.setGen("cave",e,t);const l=r.createCave(e,t,s);return a.setMap(l.map),this.setLevelExtras(a,l.mapGen),s.isCollapsed&&(a.getExtras().isCollapsed=!0),a}setLevelExtras(e,t){const n=t.getMapData();n.startPoints=a.default.uniquifyCoord(n.startPoints),e.setExtras(n)}_createMapOptions(e,n,s){let{dungeonType:r}=s,a={};const o=y(e,n);switch(r=r.capitalize()){case"Cave":a=t.Miners.getRandOpts(e,n,1,3);break;case"Grotto":a=t.Miners.getRandOpts(e,n,2,4);break;case"Lair":{const s=t.Miners.getMinersAndExclude(e,n,["C"]),r=[m.arrayGetRand(s),o.C];a=t.Miners.getOptsWithMiners(r);break}case"Cavern":a=t.Miners.getRandOpts(e,n,3,9);break;default:a=t.Miners.getRandOpts(e,n)}let i=m.getUniform()<=.1;return!1===s.isCollapsed&&(i=!1),(i||s.isCollapsed)&&(a.floorElem=p.ELEM.CHASM,a.isCollapsed=!0),a}addStairsLocations(e){const t=e.getExtras(),{startPoints:n}=t;let s=null,r=null;n.length>1?[s,r]=m.getUniqueItems(n,2):(s=n[0],r=this.getEndPointFromMap(e,s)),this.addStartAndEndPoint(e,s,r),t.startPoint=s,r&&(t.endPoint=r);const a=n.slice();t.points=[],a.splice(a.indexOf(s),1),a.splice(a.indexOf(r),1),a.forEach(n=>{const[s,r]=n,a=new g(">");a.setTag("end_point"),e.addElement(a,s,r),t.points.push(n)})}_addSpecialFeatures(e){e.getExtras().isCollapsed&&this._createCollapsedLevel(e)}getEndPointFromMap(e,t){const n=e.getMap(),s=this.getMapOfNonWallCells(e);return this.getRandomEndPoint(n,t,s)}getMapOfNonWallCells(e){const t=e.getMap().getCells(e=>!e.getBaseElem().isWall()),n={};return t.forEach(e=>{n[e.getKeyXY()]=e}),n}_createCollapsedLevel(e){const t=e.getExtras(),n=e.getMap();let{endPoint:s}=t;const{startPoint:r}=t,a=this.getMapOfNonWallCells(e);s||(s=this.getRandomEndPoint(n,r,a)),r&&s&&this.createPath(n,r,s).forEach(e=>{delete a[e[0]+","+e[1]]});const o=[r,s];t.points&&t.points.forEach(e=>{const t=m.arrayGetRand(o);this.createPath(n,e,t).forEach(e=>{delete a[e[0]+","+e[1]]}),o.push(e)});const i=m.getUniformInt(1,10);for(let e=0;e<i;e++){const e=this.getRandomPoint(n,r,a);if(e){const t=m.arrayGetRand(o);this.createPath(n,e,t).forEach(e=>{delete a[e[0]+","+e[1]]}),o.push(e)}}}createPath(e,t,n){const[s,r]=t,[a,o]=n,i=u.Path.getShortestPath(s,r,a,o,(t,n)=>e.hasXY(t,n)&&!e.getBaseElemXY(t,n).getType().match(/wall/)),l=[];return i.forEach(t=>{const{x:n,y:s}=t;h.Geometry.getCrossAround(n,s,1,!0).forEach(t=>{const[n,s]=t;"chasm"===e.getCell(n,s).getBaseElem().getType()&&(e.setBaseElemXY(n,s,p.ELEM.FLOOR_CAVE),l.push([n,s]))})}),l}getRandomEndPoint(e,t,n){const s=(t,n)=>e.hasXY(t,n)&&!e.getBaseElemXY(t,n).getType().match(/wall/),[r,a]=t;let o=null;const i=e.cols>e.rows?e.rows:e.cols;let l=0,c=10;const h=Object.values(n);let d=null;for(;l<i;){const e=m.arrayGetRand(h),[t,n]=e.getXY();if(o=[t,n],l=(d=u.Path.getShortestPath(t,n,r,a,s)).length,0===c)break;--c}return o&&d&&d.forEach(e=>{const t=e.x+","+e.y;delete n[t]}),o}getRandomPoint(e,t,n){const[s,r]=t,a=Object.values(n),o=m.arrayGetRand(a),[i,l]=o.getXY(),c=[i,l],h=u.Path.getShortestPath(i,l,s,r,(t,n)=>e.hasXY(t,n)&&!e.getBaseElemXY(t,n).getType().match(/wall/));return c&&h&&h.forEach(e=>{const t=e.x+","+e.y;delete n[t]}),c}_addEncounters(e,t){const{dungeonType:n}=t;"Lair"===n&&this._addLairBoss(e,t),this.populatePoints(e,t)}_addLairBoss(e,t){const{maxDanger:n,maxValue:s}=t,r=e.getExtras().endPoint;if(r){const t=new l.DungeonPopulate({});e.getExtras().isCollapsed&&t.setActorFunc(e=>e.flying),t.addPointGuardian(e,r,n+4),t.addMainLoot(e,r,s)}else{const t=JSON.stringify(e.getExtras());a.default.err("CaveGenerator","_addLairBoss","No endPoint in extras: "+t)}}populatePoints(e,t){const n=e.getExtras(),{points:s}=n,r=new l.DungeonPopulate({});s.forEach(n=>{r.populatePoint(e,n,t)})}},t.Miners={},t.Miners.getMiners=y,t.Miners.getMinersAndExclude=function(e,t,n){const s=y(e,t);return n.forEach(e=>{delete s[e]}),Object.values(s)},t.Miners.getOptsWithMiners=v,t.Miners.getRandOpts=function(e,t,n=1,s=9){const r=y(e,t),a=Object.values(r),o=m.getUniformInt(n,s),i=[];for(let e=0;e<o;e++){const e=m.arrayGetRand(a);i.push(e)}return v(i)},t.Miners.getMinersCorners=function(e,t,n){return n||(n=y(e,t)),{cols:e,rows:t,dirWeights:n.NW.dirWeights,addMiners:[n.SW,n.NE,n.SE],startX:n.NW.x,startY:n.NW.y}},t.Miners.getMinersNSEW=function(e,t,n){return n||(n=y(e,t)),{cols:100,rows:100,maxMinersCreated:100,startX:n.N.x,startY:n.N.y,dirWeights:n.N.dirWeights,addMiners:[n.S,n.E,n.W]}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(12),o=n(9).Random.getRNG(),i=".",l="#",c=-1;class u{static fromJSON(e){const t=new u(0,0,{});return Object.keys(e).forEach(n=>{t[n]=e[n]}),t}constructor(e,t,n={}){this.map=new Array(e),this.cols=e,this.rows=t,this.rivals=[],this.currRivals=[],this.empty={},this.occupied={},this.occupiedBy={},this.numEmpty=0,this.numCells=e*t,this.terrData={},this.rng=o,this.doPostProcess=!0,this.maxNumPos=1,this.startSize=1,this.maxFillRatio=1,this.dirs=r.default.DIR_NSEW.concat(r.default.DIR_DIAG);["maxNumPos","startSize","dirs","doPostProcess","maxFillRatio","rng"].forEach(e=>{n.hasOwnProperty(e)&&(this[e]=n[e])});for(let n=0;n<e;n++){this.map[n]=new Array(t);for(let e=0;e<t;e++)this._markEmpty(n,e)}}setRNG(e){this.rng=e}getMap(){return this.map}getData(){return this.terrData}getRivalData(e){return this.terrData[e]?this.terrData[e]:null}_markEmpty(e,t){this.map[e][t]=i,this.empty[e+","+t]=[e,t],++this.numEmpty}hasRival(e){return!this.isEmpty(e)&&!this.isFull(e)}getRival(e){const[t,n]=e,s=this.map[t][n];return this.getName(s)}useMap(e,t){this.numEmpty=0;for(let n=0;n<e.length;n++)for(let s=0;s<e[0].length;s++)t[e[n][s]]?this._markEmpty(n,s):(this.map[n][s]=l,delete this.empty[n+","+s])}addRival(e){this._initRival(e)}generate(e=c){this.currRivals=this.rivals.slice(),this.rng.shuffle(this.currRivals);let t=0;for(;this._hasTurnsLeftToProcess(t,e);){const e=this.currRivals.shift(),{name:n}=e,s=this.terrData[n],{open:r,currPos:a,maxNumPos:o}=s;if(a<o){const t=this._getStartPosition(n);this._addStartPosition(n,t),this.currRivals.push(e)}else if(Object.keys(r).length>0){const t=this.getRandOpenXY(n),s=this.getEmptyAdjacentXY(t);s?(this._addOccupied(n,s),this.currRivals.push(e)):(this._closeCell(n,t),Object.keys(r).length>0&&this.currRivals.push(e))}++t}this.doPostProcess&&this.postProcessData()}update(){this.currRivals=this.rivals.slice(),this.rng.shuffle(this.currRivals),this.currRivals.forEach(e=>{const{name:t}=e,n=this.getRandOpenXY(t),s=this.getEmptyAdjacentXY(n);s?this._addOccupied(t,s):this._closeCell(t,n)}),this.currRivals=[]}getName(e){const t=this.rivals.find(t=>t.char===e);return t?t.name:null}getFillRatio(){return(this.numCells-this.numEmpty)/this.numCells}_hasTurnsLeftToProcess(e,t){return this.hasEmpty()&&this.currRivals.length>0&&e!==t&&this.getFillRatio()<this.maxFillRatio}_getStartPosition(e){const t=this.terrData[e],{currPos:n}=t,s=this.getRandEmptyXY();t.startX.length>n?s[0]=t.startX[n]:t.startX.push(s[0]),t.startY.length>n?s[1]=t.startY[n]:t.startY.push(s[1]);const a=h(s);return this.empty.hasOwnProperty(a)||this.map[s[0]][s[1]]!==l&&r.default.warn("Territory","_getStartPosition",`${e} overriding another position @ ${s}`),t.currPos+=1,s}_addOccupied(e,t){const n=h(t);this.occupied[n]=t,this.occupiedBy[e].push(t),this.terrData[e].open[n]=t,this.terrData[e].occupied[n]=t,this.map[t[0]][t[1]]=this.terrData[e].char,this.empty[n]&&(--this.numEmpty,delete this.empty[n])}_addStartPosition(e,t){const n=this.getRivalData(e).startSize-1,s=a.Geometry.getBoxAround(t[0],t[1],n,!0);s.forEach(t=>{this.isEmpty(t)&&this._addOccupied(e,t)}),0===s.length&&r.default.err("Territory","_addStartPosition","No startCoord found!")}getRandEmptyXY(){return this.rng.arrayGetRand(Object.values(this.empty))}isFull(e){const[t,n]=e;return this.map[t][n]===l}isEmpty(e){const t=h(e);return this.empty.hasOwnProperty(t)}getRandOpenXY(e){const{open:t}=this.terrData[e];return this.rng.arrayGetRand(Object.values(t))}getEmptyAdjacentXY(e){const t=this.dirs.slice();for(this.rng.shuffle(t);t.length>0;){const n=t.shift(),[s,a]=r.default.newXYFromDir(n,e);if(this.hasXY(s,a)&&this.map[s][a]===i)return[s,a]}return null}hasXY(e,t){return e>=0&&t>=0&&e<this.map.length&&t<this.map[0].length}_closeCell(e,t){const n=h(t);this.terrData[e].closed[n]=t,delete this.terrData[e].open[n]}hasEmpty(){return this.numEmpty>0}mapToString(){const e=this.map[0].length,t=this.map.length,n=[];for(let s=0;s<e;s++){const e=[];for(let n=0;n<t;n++)e.push(this.map[n][s]);n.push(e)}return n.map(e=>e.join(""))}getAreaProportions(){const e={};return Object.keys(this.occupiedBy).forEach(t=>{e[t]=this.occupiedBy[t].length}),e}_initRival(e){this.rivals.push(e);const{name:t,char:n}=e;this.terrData[t]={currPos:0,maxNumPos:this.maxNumPos,char:n,occupied:{},closed:{},open:{},startX:[],startY:[],startSize:this.startSize},Array.isArray(e.startX)?this.terrData[t].startX=e.startX:e.startX>=0&&(this.terrData[t].startX=[e.startX]),Array.isArray(e.startY)?this.terrData[t].startY=e.startY:e.startY>=0&&(this.terrData[t].startY=[e.startY]),e.numPos?this.terrData[t].maxNumPos=e.numPos:e.maxNumPos&&(this.terrData[t].maxNumPos=e.maxNumPos),e.startSize&&(this.terrData[t].startSize=e.startSize),this.occupiedBy[t]=[]}postProcessData(){const e=this.dirs.length>4;Object.keys(this.terrData).forEach(t=>{const n=this.terrData[t],{startX:s,startY:r,char:o}=n;n.numOccupied=Object.keys(n.occupied).length,n.areas={},s.forEach((t,s)=>{const i=[t,r[s]],l=a.Geometry.floodfill2D(this.map,i,o,{},e);n.areas[h(i)]=l})})}toJSON(){return{terrData:this.terrData,map:this.map,cols:this.cols,rows:this.rows,currRivals:this.currRivals,empty:this.empty,occupied:this.occupied,occupiedBy:this.occupiedBy,numEmpty:this.numEmpty,dirs:this.dirs}}}function h(e){return e[0]+","+e[1]}t.Territory=u},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=n(30),l=r(n(11)),c=n(19),u=n(14),h=n(15),d={AddComp:!0,ModifyCompValue:!0,AddEntity:!0,AddElement:!0,RemoveElement:!0,ChangeElement:!0,RemoveComp:!0};let p=Object.keys(d);class f extends o.SystemBase{static addEffect(e,t){if(!d.hasOwnProperty(e)){const n="handle"+e.capitalize();return f.prototype[n]=t,d[e]=!0,p=Object.keys(d),!0}return a.default.err("SystemEffects","addEffect",`Effect ${e} already exists.`),!1}static getEffectTarget(e){const t=e.target;if(!t){const e="Possibly missing args for useItem().";a.default.err("system.effects.js","getEffectTarget",`Given object was null/undefined. ${e}`)}return f.getTargetFromObj(t,e.targetType)}static getTargetFromObj(e,t){if(!e.hasOwnProperty("target"))return e;{const n=e.target;let s=t;s||(s=["actors","items","elements","baseElem"]),Array.isArray(s)||(s=[s]);for(let e=0;e<s.length;e++){if(n.hasProp(s[e]))return n.getProp(s[e])[0];if(/base/.test(s[e]))return n.getBaseElem()}}return null}constructor(e,t){super(a.default.SYS.EFFECTS,e,t),this._dtable={},Object.keys(d).forEach(e=>{if(d[e]){const t="handle"+e.capitalize();this._dtable[e]=this[t].bind(this)}})}updateEntity(e){e.getList("Effects").forEach(t=>{const n=t.getEffectType();if(n&&""!==n)if(this._dtable.hasOwnProperty(n)){this._checkStartMsgEmits(e,t);const s=this._dtable[n](e,t);this._checkEndMsgEmits(e,t,s)}else a.default.err("SystemEffects","updateEntity",`Effect |${n}| not in handler list: ${p}`);else a.default.err("SystemEffects","updateEntity","No effect type in Effects comp");e.remove(t)})}_checkStartMsgEmits(e,t){const n=t.getArgs();n.startMsg&&a.default.gameMsg({cell:e.getCell(),msg:n.startMsg})}_checkEndMsgEmits(e,t,n){const s=t.getArgs();s.endMsg&&a.default.gameMsg({cell:e.getCell(),msg:s.endMsg}),n&&s.successMsg&&a.default.gameMsg({cell:e.getCell(),msg:s.successMsg}),!n&&s.failureMsg&&a.default.gameWarn({cell:e.getCell(),msg:s.failureMsg})}handleAddComp(e,t){const n=t.getArgs(),s=f.getEffectTarget(n),r=m(n,s);let o=null;if(l.hasOwnProperty(r)&&(o=new l[r]),n.setters){const e=n.setters;Object.keys(e).forEach(t=>{if("function"==typeof o[t]){const n=e[t],s=g(n);o[t](s)}else{const e=JSON.stringify(o);a.default.err("useEffect","addComp",`No ${t} in comp ${e}`)}})}o&&o.setSource&&o.setSource(e);const c=i.Dice.getValue(n.duration),u=n.expireMsg;return l.addToExpirationComp(s,o,c,u),!0}handleAddElement(e,t){const n=t.getArgs(),s=y(n);n.elementName||a.default.err("System.Effects","handleAddElement","No elementName found in useArgs: "+JSON.stringify(n));let r=h.Element.create(n.elementName);if(!r){r=u.ObjectShell.getParser().createEntity(n.elementName)}if(r){const[t,a]=[s.getX(),s.getY()],o=e.getLevel(),i=s.getPropType(r.getType());return(!i||i.length<n.numAllowed)&&(o.addElement(r,t,a)?("function"==typeof r.onSystemAdd&&r.onSystemAdd(s),!0):(console.error("Failed to add element "+n.elementName),!1))}{const e="Failed to create elem: "+JSON.stringify(n);a.default.err("System.Effects","handleAddElement",e)}return!1}handleRemoveElement(e,t){const n=t.getArgs(),s=y(n);n.elementName||a.default.err("System.Effects","handleRemoveElement","No elementName found in useArgs: "+JSON.stringify(n));const r=s.getPropType(n.elementName);if(r.length>0){const t=r[0],[n,a]=[s.getX(),s.getY()];if(e.getLevel().removeElement(t,n,a))return"function"==typeof t.onSystemRemove&&t.onSystemRemove(s),!0}return!1}handleModifyCompValue(e,t){const n=t.getArgs(),s=f.getEffectTarget(n),r=m(n,s);if(s&&s.has(r)){const e=s.get(r),t=e[n.get](),a=n.value,o=g(a);return e[n.set](t+o),!0}return!1}handleAddEntity(e,t){const n=t.getArgs(),s=y(n),r=u.ObjectShell.getParser().createEntity(n.entityName);if(r){const[t,a]=[s.getX(),s.getY()];if(e.getLevel().addEntity(r,t,a)){if(n.duration){const e=new l.Fading,{duration:t}=n;e.setDuration(t),r.add(e)}const t=new l.Created;return t.setCreator(e),r.add(t),!0}}return!1}handleChangeElement(e,t){const n=t.getArgs(),s=y(n),r=n.fromType,a=n.toType||c.ELEM.FLOOR;return s.getBaseElem().getType()===r&&(s.setBaseElem(a),!0)}handleRemoveComp(e,t){const n=t.getArgs(),s=f.getEffectTarget(n),r=m(n,s);return!!s.has(r)&&(n.all?s.removeAll(r):s.remove(r),!0)}}function m(e,t){const n=e.name;if(!n){let n="Unknown comp value. useArgs: "+JSON.stringify(e);t&&(n+=" targetEnt "+JSON.stringify(t)),a.default.err("SystemEffects","handleModifyCompValue",n)}return n.capitalize()}t.SystemEffects=f,f.handlerTable=d;const g=function(e){if(Number.isInteger(e))return e;if("string"==typeof e){const t=Number.parseFloat(e);if(!Number.isNaN(t))return t}return e};function y(e){if(e.target){const t=e.target;if(t.target)return t.target}const t=JSON.stringify(e);return a.default.err("system.effects.js","getTargetCellOrFail","Prop target must exist in useArgs "+t),null}},function(e,t,n){e.exports=n(441)},function(e,t,n){var s=n(257),r=n(444),a=n(445);e.exports=function(e,t,n,s){return i({showHidden:t,seen:[],stylize:function(e){return e}},e,void 0===n?2:n)};var o=function(e){return"object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName};function i(e,n,f){if(n&&"function"==typeof n.inspect&&n.inspect!==t.inspect&&(!n.constructor||n.constructor.prototype!==n)){var m=n.inspect(f);return"string"!=typeof m&&(m=i(e,m,f)),m}var g=function(e,t){switch(typeof t){case"undefined":return e.stylize("undefined","undefined");case"string":var n="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(n,"string");case"number":return 0===t&&1/t==-1/0?e.stylize("-0","number"):e.stylize(""+t,"number");case"boolean":return e.stylize(""+t,"boolean")}if(null===t)return e.stylize("null","null")}(e,n);if(g)return g;if(o(n)){if("outerHTML"in n)return n.outerHTML;try{if(document.xmlVersion)return(new XMLSerializer).serializeToString(n);var y=document.createElementNS("http://www.w3.org/1999/xhtml","_");return y.appendChild(n.cloneNode(!1)),html=y.innerHTML.replace("><",">"+n.innerHTML+"<"),y.innerHTML="",html}catch(e){}}var v=a(n),_=e.showHidden?r(n):v;if(0===_.length||d(n)&&(1===_.length&&"stack"===_[0]||2===_.length&&"description"===_[0]&&"stack"===_[1])){if("function"==typeof n){var b=(S=s(n))?": "+S:"";return e.stylize("[Function"+b+"]","special")}if(u(n))return e.stylize(RegExp.prototype.toString.call(n),"regexp");if(h(n))return e.stylize(Date.prototype.toUTCString.call(n),"date");if(d(n))return l(n)}var E,S,C,w="",T=!1,O=["{","}"];(E=n,(Array.isArray(E)||"object"==typeof E&&"[object Array]"===p(E))&&(T=!0,O=["[","]"]),"function"==typeof n)&&(w=" [Function"+(b=(S=s(n))?": "+S:"")+"]");return u(n)&&(w=" "+RegExp.prototype.toString.call(n)),h(n)&&(w=" "+Date.prototype.toUTCString.call(n)),d(n)?l(n):0!==_.length||T&&0!=n.length?f<0?u(n)?e.stylize(RegExp.prototype.toString.call(n),"regexp"):e.stylize("[Object]","special"):(e.seen.push(n),C=T?function(e,t,n,s,r){for(var a=[],o=0,i=t.length;o<i;++o)Object.prototype.hasOwnProperty.call(t,String(o))?a.push(c(e,t,n,s,String(o),!0)):a.push("");return r.forEach(function(r){r.match(/^\d+$/)||a.push(c(e,t,n,s,r,!0))}),a}(e,n,f,v,_):_.map(function(t){return c(e,n,f,v,t,T)}),e.seen.pop(),function(e,t,n){if(e.reduce(function(e,t){return 0,t.indexOf("\n")>=0&&0,e+t.length+1},0)>60)return n[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+n[1];return n[0]+t+" "+e.join(", ")+" "+n[1]}(C,w,O)):O[0]+w+O[1]}function l(e){return"["+Error.prototype.toString.call(e)+"]"}function c(e,t,n,s,r,a){var o,l;if(t.__lookupGetter__&&(t.__lookupGetter__(r)?l=t.__lookupSetter__(r)?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):t.__lookupSetter__(r)&&(l=e.stylize("[Setter]","special"))),s.indexOf(r)<0&&(o="["+r+"]"),l||(e.seen.indexOf(t[r])<0?(l=i(e,t[r],null===n?null:n-1)).indexOf("\n")>-1&&(l=a?l.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+l.split("\n").map(function(e){return"   "+e}).join("\n")):l=e.stylize("[Circular]","special")),void 0===o){if(a&&r.match(/^\d+$/))return l;(o=JSON.stringify(""+r)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.substr(1,o.length-2),o=e.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),o=e.stylize(o,"string"))}return o+": "+l}function u(e){return"object"==typeof e&&"[object RegExp]"===p(e)}function h(e){return"object"==typeof e&&"[object Date]"===p(e)}function d(e){return"object"==typeof e&&"[object Error]"===p(e)}function p(e){return Object.prototype.toString.call(e)}},function(e,t,n){"use strict";n.r(t);var s=n(1),r=n.n(s),a=n(0),o=n.n(a),i=n(3),l=n.n(i),c=n(27),u=n.n(c);function h(e){for(var t=arguments.length,n=Array(t>1?t-1:0),s=1;s<t;s++)n[s-1]=arguments[s];return"function"==typeof e&&e.apply(void 0,n)}function d(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var p="react-contextmenu",f="react-contextmenu--visible",m="react-contextmenu-wrapper",g="react-contextmenu-item",y="react-contextmenu-item--active",v="react-contextmenu-item--disabled",_="react-contextmenu-item--divider",b="react-contextmenu-item--selected",E="react-contextmenu-submenu",S={},C=Boolean("undefined"!=typeof window&&window.document&&window.document.createElement),w="REACT_CONTEXTMENU_SHOW",T="REACT_CONTEXTMENU_HIDE";function O(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:window,s=void 0;"function"==typeof window.CustomEvent?s=new window.CustomEvent(e,{detail:t}):(s=document.createEvent("CustomEvent")).initCustomEvent(e,!1,!0,t),n&&(n.dispatchEvent(s),u()(S,t))}function M(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments[1];O(w,u()({},e,{type:w}),t)}function A(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments[1];O(T,u()({},e,{type:T}),t)}var N=new function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.handleShowEvent=function(e){for(var n in t.callbacks)d(t.callbacks,n)&&t.callbacks[n].show(e)},this.handleHideEvent=function(e){for(var n in t.callbacks)d(t.callbacks,n)&&t.callbacks[n].hide(e)},this.register=function(e,n){var s=Math.random().toString(36).substring(7);return t.callbacks[s]={show:e,hide:n},s},this.unregister=function(e){e&&t.callbacks[e]&&delete t.callbacks[e]},this.callbacks={},C&&(window.addEventListener(w,this.handleShowEvent),window.addEventListener(T,this.handleHideEvent))},P=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},x=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();function I(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function D(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var k=function(e){function t(){var e,n,s;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var r=arguments.length,a=Array(r),o=0;o<r;o++)a[o]=arguments[o];return n=s=D(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(a))),s.handleClick=function(e){e.preventDefault(),s.props.disabled||s.props.divider||(h(s.props.onClick,e,u()({},s.props.data,S.data),S.target),s.props.preventClose||A())},D(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s["Component"]),x(t,[{key:"render",value:function(){var e,t=this,n=this.props,s=n.disabled,a=n.divider,o=n.children,i=n.attributes,c=n.selected,u=l()(g,i.className,(I(e={},l()(v,i.disabledClassName),s),I(e,l()(_,i.dividerClassName),a),I(e,l()(b,i.selectedClassName),c),e));return r.a.createElement("div",P({},i,{className:u,role:"menuitem",tabIndex:"-1","aria-disabled":s?"true":"false","aria-orientation":a?"horizontal":null,ref:function(e){t.ref=e},onMouseMove:this.props.onMouseMove,onMouseLeave:this.props.onMouseLeave,onTouchEnd:this.handleClick,onClick:this.handleClick}),a?null:o)}}]),t}();k.propTypes={children:o.a.node,attributes:o.a.object,data:o.a.object,disabled:o.a.bool,divider:o.a.bool,preventClose:o.a.bool,onClick:o.a.func,selected:o.a.bool,onMouseMove:o.a.func,onMouseLeave:o.a.func},k.defaultProps={disabled:!1,data:{},divider:!1,attributes:{},preventClose:!1,onClick:function(){return null},children:null,selected:!1,onMouseMove:function(){return null},onMouseLeave:function(){return null}};var L=k;var R=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return B.call(n),n.seletedItemRef=null,n.state={selectedItem:null,forceSubMenuOpen:!1},n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s["Component"]),t}();R.propTypes={children:o.a.node.isRequired};var B=function(){var e=this;this.handleKeyNavigation=function(t){if(!1!==e.state.isVisible)switch(t.keyCode){case 37:case 27:t.preventDefault(),e.hideMenu(t);break;case 38:t.preventDefault(),e.selectChildren(!0);break;case 40:t.preventDefault(),e.selectChildren(!1);break;case 39:e.tryToOpenSubMenu(t);break;case 13:t.preventDefault(),e.tryToOpenSubMenu(t);var n=e.seletedItemRef&&e.seletedItemRef.props&&e.seletedItemRef.props.disabled;e.seletedItemRef&&e.seletedItemRef.ref instanceof HTMLElement&&!n?e.seletedItemRef.ref.click():e.hideMenu(t)}},this.handleForceClose=function(){e.setState({forceSubMenuOpen:!1})},this.tryToOpenSubMenu=function(t){e.state.selectedItem&&e.state.selectedItem.type===e.getSubMenuType()&&(t.preventDefault(),e.setState({forceSubMenuOpen:!0}))},this.selectChildren=function(t){var n=e.state.selectedItem,s=[];r.a.Children.forEach(e.props.children,function t(n){n&&([L,e.getSubMenuType()].indexOf(n.type)<0?r.a.Children.forEach(n.props.children,t):n.props.divider||s.push(n))});var a=s.indexOf(n);a<0?e.setState({selectedItem:t?s[s.length-1]:s[0],forceSubMenuOpen:!1}):t?e.setState({selectedItem:s[a-1<0?s.length-1:a-1],forceSubMenuOpen:!1}):e.setState({selectedItem:s[a+1<s.length?a+1:0],forceSubMenuOpen:!1})},this.onChildMouseMove=function(t){e.state.selectedItem!==t&&e.setState({selectedItem:t,forceSubMenuOpen:!1})},this.onChildMouseLeave=function(){e.setState({selectedItem:null,forceSubMenuOpen:!1})},this.renderChildren=function(t){return r.a.Children.map(t,function(t){var n={};return r.a.isValidElement(t)?[L,e.getSubMenuType()].indexOf(t.type)<0?(n.children=e.renderChildren(t.props.children),r.a.cloneElement(t,n)):(n.onMouseLeave=e.onChildMouseLeave.bind(e),t.type===e.getSubMenuType()&&(n.forceOpen=e.state.forceSubMenuOpen&&e.state.selectedItem===t,n.forceClose=e.handleForceClose,n.parentKeyNavigationHandler=e.handleKeyNavigation),t.props.divider||e.state.selectedItem!==t?(n.onMouseMove=function(){return e.onChildMouseMove(t)},r.a.cloneElement(t,n)):(n.selected=!0,n.ref=function(t){e.seletedItemRef=t},r.a.cloneElement(t,n))):t})}},G=R,F=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},W=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();function Y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var j=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.getMenuPosition=function(){var e=window,t=e.innerWidth,s=e.innerHeight,r=n.subMenu.getBoundingClientRect(),a={};return r.bottom>s?a.bottom=0:a.top=0,r.right<t?a.left="100%":a.right="100%",a},n.getRTLMenuPosition=function(){var e=window.innerHeight,t=n.subMenu.getBoundingClientRect(),s={};return t.bottom>e?s.bottom=0:s.top=0,t.left<0?s.left="100%":s.right="100%",s},n.hideMenu=function(e){e.detail&&e.detail.id&&n.menu&&e.detail.id!==n.menu.id||(n.props.forceOpen&&n.props.forceClose(),n.setState({visible:!1,selectedItem:null}),n.unregisterHandlers())},n.handleClick=function(e){e.preventDefault(),n.props.disabled||h(n.props.onClick,e,u()({},n.props.data,S.data),S.target)},n.handleMouseEnter=function(){n.closetimer&&clearTimeout(n.closetimer),n.props.disabled||n.state.visible||(n.opentimer=setTimeout(function(){return n.setState({visible:!0,selectedItem:null})},n.props.hoverDelay))},n.handleMouseLeave=function(){n.opentimer&&clearTimeout(n.opentimer),n.state.visible&&(n.closetimer=setTimeout(function(){return n.setState({visible:!1,selectedItem:null})},n.props.hoverDelay))},n.menuRef=function(e){n.menu=e},n.subMenuRef=function(e){n.subMenu=e},n.registerHandlers=function(){document.removeEventListener("keydown",n.props.parentKeyNavigationHandler),document.addEventListener("keydown",n.handleKeyNavigation)},n.unregisterHandlers=function(e){document.removeEventListener("keydown",n.handleKeyNavigation),e||document.addEventListener("keydown",n.props.parentKeyNavigationHandler)},n.state=u()({},n.state,{visible:!1}),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,G),W(t,[{key:"componentDidMount",value:function(){this.listenId=N.register(function(){},this.hideMenu)}},{key:"getSubMenuType",value:function(){return t}},{key:"shouldComponentUpdate",value:function(e,t){return this.isVisibilityChange=!(this.state.visible===t.visible&&this.props.forceOpen===e.forceOpen||this.state.visible&&e.forceOpen||this.props.forceOpen&&t.visible),!0}},{key:"componentDidUpdate",value:function(){var e=this;if(this.isVisibilityChange)if(this.props.forceOpen||this.state.visible){(window.requestAnimationFrame||setTimeout)(function(){var t=e.props.rtl?e.getRTLMenuPosition():e.getMenuPosition();e.subMenu.style.removeProperty("top"),e.subMenu.style.removeProperty("bottom"),e.subMenu.style.removeProperty("left"),e.subMenu.style.removeProperty("right"),d(t,"top")&&(e.subMenu.style.top=t.top),d(t,"left")&&(e.subMenu.style.left=t.left),d(t,"bottom")&&(e.subMenu.style.bottom=t.bottom),d(t,"right")&&(e.subMenu.style.right=t.right),e.subMenu.classList.add(f),e.registerHandlers(),e.setState({selectedItem:null})})}else{this.subMenu.addEventListener("transitionend",function t(){e.subMenu.removeEventListener("transitionend",t),e.subMenu.style.removeProperty("bottom"),e.subMenu.style.removeProperty("right"),e.subMenu.style.top=0,e.subMenu.style.left="100%",e.unregisterHandlers()}),this.subMenu.classList.remove(f)}}},{key:"componentWillUnmount",value:function(){this.listenId&&N.unregister(this.listenId),this.opentimer&&clearTimeout(this.opentimer),this.closetimer&&clearTimeout(this.closetimer),this.unregisterHandlers(!0)}},{key:"render",value:function(){var e,t=this.props,n=t.children,s=t.attributes,a=t.disabled,o=t.title,i=t.selected,c=this.state.visible,u={ref:this.menuRef,onMouseEnter:this.handleMouseEnter,onMouseLeave:this.handleMouseLeave,className:l()(g,E,s.listClassName),style:{position:"relative"}},h={className:l()(g,s.className,(e={},Y(e,l()(v,s.disabledClassName),a),Y(e,l()(y,s.visibleClassName),c),Y(e,l()(b,s.selectedClassName),i),e)),onMouseMove:this.props.onMouseMove,onMouseOut:this.props.onMouseOut,onClick:this.handleClick},d={ref:this.subMenuRef,style:{position:"absolute",transition:"opacity 1ms",top:0,left:"100%"},className:l()(p,this.props.className)};return r.a.createElement("nav",F({},u,{role:"menuitem",tabIndex:"-1","aria-haspopup":"true"}),r.a.createElement("div",F({},s,h),o),r.a.createElement("nav",F({},d,{role:"menu",tabIndex:"-1"}),this.renderChildren(n)))}}]),t}();j.propTypes={children:o.a.node.isRequired,attributes:o.a.object,title:o.a.node.isRequired,className:o.a.string,disabled:o.a.bool,hoverDelay:o.a.number,rtl:o.a.bool,selected:o.a.bool,onMouseMove:o.a.func,onMouseOut:o.a.func,forceOpen:o.a.bool,forceClose:o.a.func,parentKeyNavigationHandler:o.a.func},j.defaultProps={disabled:!1,hoverDelay:500,attributes:{},className:"",rtl:!1,selected:!1,onMouseMove:function(){return null},onMouseOut:function(){return null},forceOpen:!1,forceClose:function(){return null},parentKeyNavigationHandler:function(){return null}};var X=j,U=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();var $=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.registerHandlers=function(){document.addEventListener("mousedown",n.handleOutsideClick),document.addEventListener("touchstart",n.handleOutsideClick),document.addEventListener("scroll",n.handleHide),document.addEventListener("contextmenu",n.handleHide),document.addEventListener("keydown",n.handleKeyNavigation),window.addEventListener("resize",n.handleHide)},n.unregisterHandlers=function(){document.removeEventListener("mousedown",n.handleOutsideClick),document.removeEventListener("touchstart",n.handleOutsideClick),document.removeEventListener("scroll",n.handleHide),document.removeEventListener("contextmenu",n.handleHide),document.removeEventListener("keydown",n.handleKeyNavigation),window.removeEventListener("resize",n.handleHide)},n.handleShow=function(e){if(e.detail.id===n.props.id&&!n.state.isVisible){var t=e.detail.position,s=t.x,r=t.y;n.setState({isVisible:!0,x:s,y:r}),n.registerHandlers(),h(n.props.onShow,e)}},n.handleHide=function(e){!n.state.isVisible||e.detail&&e.detail.id&&e.detail.id!==n.props.id||(n.unregisterHandlers(),n.setState({isVisible:!1,selectedItem:null,forceSubMenuOpen:!1}),h(n.props.onHide,e))},n.handleOutsideClick=function(e){n.menu.contains(e.target)||A()},n.handleMouseLeave=function(e){e.preventDefault(),h(n.props.onMouseLeave,e,u()({},n.props.data,S.data),S.target),n.props.hideOnLeave&&A()},n.handleContextMenu=function(e){e.preventDefault(),n.handleHide(e)},n.hideMenu=function(e){27!==e.keyCode&&13!==e.keyCode||A()},n.getMenuPosition=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s={top:t,left:e};if(!n.menu)return s;var r=window,a=r.innerWidth,o=r.innerHeight,i=n.menu.getBoundingClientRect();return t+i.height>o&&(s.top-=i.height),e+i.width>a&&(s.left-=i.width),s.top<0&&(s.top=i.height<o?(o-i.height)/2:0),s.left<0&&(s.left=i.width<a?(a-i.width)/2:0),s},n.getRTLMenuPosition=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s={top:t,left:e};if(!n.menu)return s;var r=window,a=r.innerWidth,o=r.innerHeight,i=n.menu.getBoundingClientRect();return s.left=e-i.width,t+i.height>o&&(s.top-=i.height),s.left<0&&(s.left+=i.width),s.top<0&&(s.top=i.height<o?(o-i.height)/2:0),s.left+i.width>a&&(s.left=i.width<a?(a-i.width)/2:0),s},n.menuRef=function(e){n.menu=e},n.state=u()({},n.state,{x:0,y:0,isVisible:!1}),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,G),U(t,[{key:"getSubMenuType",value:function(){return X}},{key:"componentDidMount",value:function(){this.listenId=N.register(this.handleShow,this.handleHide)}},{key:"componentDidUpdate",value:function(){var e=this;if(this.state.isVisible){var t=window.requestAnimationFrame||setTimeout;t(function(){var n=e.state,s=n.x,r=n.y,a=e.props.rtl?e.getRTLMenuPosition(s,r):e.getMenuPosition(s,r),o=a.top,i=a.left;t(function(){e.menu&&(e.menu.style.top=o+"px",e.menu.style.left=i+"px",e.menu.style.opacity=1,e.menu.style.pointerEvents="auto")})})}else{if(!this.menu)return;this.menu.style.opacity=0,this.menu.style.pointerEvents="none"}}},{key:"componentWillUnmount",value:function(){this.listenId&&N.unregister(this.listenId),this.unregisterHandlers()}},{key:"render",value:function(){var e,t,n,s=this.props,a=s.children,o=s.className,i=s.style,c=this.state.isVisible,h=u()({},i,{position:"fixed",opacity:0,pointerEvents:"none"}),d=l()(p,o,(n=c,(t=f)in(e={})?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e));return r.a.createElement("nav",{role:"menu",tabIndex:"-1",ref:this.menuRef,style:h,className:d,onContextMenu:this.handleContextMenu,onMouseLeave:this.handleMouseLeave},this.renderChildren(a))}}]),t}();$.propTypes={id:o.a.string.isRequired,children:o.a.node.isRequired,data:o.a.object,className:o.a.string,hideOnLeave:o.a.bool,rtl:o.a.bool,onHide:o.a.func,onMouseLeave:o.a.func,onShow:o.a.func,style:o.a.object},$.defaultProps={className:"",data:{},hideOnLeave:!1,rtl:!1,onHide:function(){return null},onMouseLeave:function(){return null},onShow:function(){return null},style:{}};var K=$,V=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();function H(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var q=function(e){function t(){var e,n,s;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var r=arguments.length,a=Array(r),o=0;o<r;o++)a[o]=arguments[o];return n=s=H(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(a))),s.touchHandled=!1,s.handleMouseDown=function(e){s.props.holdToDisplay>=0&&0===e.button&&(e.persist(),e.stopPropagation(),s.mouseDownTimeoutId=setTimeout(function(){return s.handleContextClick(e)},s.props.holdToDisplay)),h(s.props.attributes.onMouseDown,e)},s.handleMouseUp=function(e){0===e.button&&clearTimeout(s.mouseDownTimeoutId),h(s.props.attributes.onMouseUp,e)},s.handleMouseOut=function(e){0===e.button&&clearTimeout(s.mouseDownTimeoutId),h(s.props.attributes.onMouseOut,e)},s.handleTouchstart=function(e){s.touchHandled=!1,s.props.holdToDisplay>=0&&(e.persist(),e.stopPropagation(),s.touchstartTimeoutId=setTimeout(function(){s.handleContextClick(e),s.touchHandled=!0},s.props.holdToDisplay)),h(s.props.attributes.onTouchStart,e)},s.handleTouchEnd=function(e){s.touchHandled&&e.preventDefault(),clearTimeout(s.touchstartTimeoutId),h(s.props.attributes.onTouchEnd,e)},s.handleContextMenu=function(e){s.handleContextClick(e),h(s.props.attributes.onContextMenu,e)},s.handleContextClick=function(e){if(!s.props.disable){e.preventDefault(),e.stopPropagation();var t=e.clientX||e.touches&&e.touches[0].pageX,n=e.clientY||e.touches&&e.touches[0].pageY;s.props.posX&&(t-=s.props.posX),s.props.posY&&(n-=s.props.posY),A();var r=h(s.props.collect,s.props),a={position:{x:t,y:n},target:s.elem,id:s.props.id,data:r};r&&"function"==typeof r.then?r.then(function(e){a.data=e,M(a)}):M(a)}},s.elemRef=function(e){s.elem=e},H(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s["Component"]),V(t,[{key:"render",value:function(){var e=this.props,t=e.renderTag,n=e.attributes,s=e.children,a=u()({},n,{className:l()(m,n.className),onContextMenu:this.handleContextMenu,onMouseDown:this.handleMouseDown,onMouseUp:this.handleMouseUp,onTouchStart:this.handleTouchstart,onTouchEnd:this.handleTouchEnd,onMouseOut:this.handleMouseOut,ref:this.elemRef});return r.a.createElement(t,a,s)}}]),t}();q.propTypes={id:o.a.string.isRequired,children:o.a.node.isRequired,attributes:o.a.object,collect:o.a.func,disable:o.a.bool,holdToDisplay:o.a.number,posX:o.a.number,posY:o.a.number,renderTag:o.a.oneOfType([o.a.node,o.a.func])},q.defaultProps={attributes:{},collect:function(){return null},disable:!1,holdToDisplay:1e3,renderTag:"div",posX:0,posY:0};var J=q,z=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},Q=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();var Z=[].concat(function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(Object.keys(J.propTypes)),["children"]),ee=function(e){return function(t){return function(n){function a(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,t));return n.handleShow=function(t){if(t.detail.id===e){var s=t.detail.data,r={};for(var a in s)Z.includes(a)||(r[a]=s[a]);n.setState({trigger:r})}},n.handleHide=function(){n.setState({trigger:null})},n.state={trigger:null},n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(a,s["Component"]),Q(a,[{key:"componentDidMount",value:function(){this.listenId=N.register(this.handleShow,this.handleHide)}},{key:"componentWillUnmount",value:function(){this.listenId&&N.unregister(this.listenId)}},{key:"render",value:function(){return r.a.createElement(t,z({},this.props,{id:e,trigger:this.state.trigger}))}}]),a}()}};n.d(t,"ContextMenu",function(){return K}),n.d(t,"ContextMenuTrigger",function(){return J}),n.d(t,"MenuItem",function(){return L}),n.d(t,"SubMenu",function(){return X}),n.d(t,"connectMenu",function(){return ee}),n.d(t,"hideMenu",function(){return A}),n.d(t,"showMenu",function(){return M})},function(e,t,n){e.exports={default:n(337),__esModule:!0}},function(e,t,n){"use strict";t.__esModule=!0;var s=c(n(42)),r=c(n(0)),a=c(n(1)),o=c(n(13)),i=c(n(207)),l=c(n(73));function c(e){return e&&e.__esModule?e:{default:e}}var u=27;var h=function(e){function t(n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var a=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.call(this,n,r));return a.addEventListeners=function(){var e=a.props.event,t=(0,l.default)(a);a.documentMouseCaptureListener=(0,i.default)(t,e,a.handleMouseCapture,!0),a.documentMouseListener=(0,i.default)(t,e,a.handleMouse),a.documentKeyupListener=(0,i.default)(t,"keyup",a.handleKeyUp)},a.removeEventListeners=function(){a.documentMouseCaptureListener&&a.documentMouseCaptureListener.remove(),a.documentMouseListener&&a.documentMouseListener.remove(),a.documentKeyupListener&&a.documentKeyupListener.remove()},a.handleMouseCapture=function(e){var t;a.preventMouseRootClose=!!((t=e).metaKey||t.altKey||t.ctrlKey||t.shiftKey)||!function(e){return 0===e.button}(e)||(0,s.default)(o.default.findDOMNode(a),e.target)},a.handleMouse=function(e){!a.preventMouseRootClose&&a.props.onRootClose&&a.props.onRootClose(e)},a.handleKeyUp=function(e){e.keyCode===u&&a.props.onRootClose&&a.props.onRootClose(e)},a.preventMouseRootClose=!1,a}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this.props.disabled||this.addEventListeners()},t.prototype.componentDidUpdate=function(e){!this.props.disabled&&e.disabled?this.addEventListeners():this.props.disabled&&!e.disabled&&this.removeEventListeners()},t.prototype.componentWillUnmount=function(){this.props.disabled||this.removeEventListeners()},t.prototype.render=function(){return this.props.children},t}(a.default.Component);h.displayName="RootCloseWrapper",h.propTypes={onRootClose:r.default.func,children:r.default.element,disabled:r.default.bool,event:r.default.oneOf(["click","mousedown"])},h.defaultProps={event:"click"},t.default=h,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e){return(0,s.default)(e)||(t=e,t&&"body"===t.tagName.toLowerCase())?function(e){var t=(0,r.default)(e),n=(0,s.default)(t).innerWidth;if(!n){var a=t.documentElement.getBoundingClientRect();n=a.right-Math.abs(a.left)}return t.body.clientWidth<n}(e):e.scrollHeight>e.clientHeight;var t};var s=a(n(81)),r=a(n(38));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.listen=t.filter=t.off=t.on=void 0;var s=i(n(82)),r=i(n(102)),a=i(n(385)),o=i(n(387));function i(e){return e&&e.__esModule?e:{default:e}}t.on=s.default,t.off=r.default,t.filter=a.default,t.listen=o.default,t.default={on:s.default,off:r.default,filter:a.default,listen:o.default}},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=u(n(0)),a=u(n(10)),o=u(n(1)),i=u(n(208)),l=u(n(394)),c=u(n(167));function u(e){return e&&e.__esModule?e:{default:e}}var h=function(e){function t(n,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.call(this,n,s));return r.handleHidden=function(){var e;(r.setState({exited:!0}),r.props.onExited)&&(e=r.props).onExited.apply(e,arguments)},r.state={exited:!n.show},r.onHiddenListener=r.handleHidden.bind(r),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentWillReceiveProps=function(e){e.show?this.setState({exited:!1}):e.transition||this.setState({exited:!0})},t.prototype.render=function(){var e=this.props,t=e.container,n=e.containerPadding,s=e.target,r=e.placement,a=e.shouldUpdatePosition,u=e.rootClose,h=e.children,d=e.transition,p=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(e,["container","containerPadding","target","placement","shouldUpdatePosition","rootClose","children","transition"]);if(!(p.show||d&&!this.state.exited))return null;var f=h;if(f=o.default.createElement(l.default,{container:t,containerPadding:n,target:s,placement:r,shouldUpdatePosition:a},f),d){var m=p.onExit,g=p.onExiting,y=p.onEnter,v=p.onEntering,_=p.onEntered;f=o.default.createElement(d,{in:p.show,transitionAppear:!0,onExit:m,onExiting:g,onExited:this.onHiddenListener,onEnter:y,onEntering:v,onEntered:_},f)}return u&&(f=o.default.createElement(c.default,{onRootClose:p.onHide},f)),o.default.createElement(i.default,{container:t},f)},t}(o.default.Component);h.propTypes=s({},i.default.propTypes,l.default.propTypes,{show:r.default.bool,rootClose:r.default.bool,onHide:function(e){var t=r.default.func;e.rootClose&&(t=t.isRequired);for(var n=arguments.length,s=Array(n>1?n-1:0),a=1;a<n;a++)s[a-1]=arguments[a];return t.apply(void 0,[e].concat(s))},transition:a.default,onEnter:r.default.func,onEntering:r.default.func,onEntered:r.default.func,onExit:r.default.func,onExiting:r.default.func,onExited:r.default.func}),t.default=h,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){function t(t,n,s,r,a,o){var i=r||"<<anonymous>>",l=o||s;if(null==n[s])return t?new Error("Required "+a+" `"+l+"` was not specified in `"+i+"`."):null;for(var c=arguments.length,u=Array(c>6?c-6:0),h=6;h<c;h++)u[h-6]=arguments[h];return e.apply(void 0,[n,s,i,a,l].concat(u))}var n=t.bind(null,!1);return n.isRequired=t.bind(null,!0),n},e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasClass=t.removeClass=t.addClass=void 0;var s=o(n(277)),r=o(n(278)),a=o(n(173));function o(e){return e&&e.__esModule?e:{default:e}}t.addClass=s.default,t.removeClass=r.default,t.hasClass=a.default,t.default={addClass:s.default,removeClass:r.default,hasClass:a.default}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return e.classList?!!t&&e.classList.contains(t):-1!==(" "+(e.className.baseVal||e.className)+" ").indexOf(" "+t+" ")},e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return(0,a.default)(e.replace(o,"ms-"))};var s,r=n(279),a=(s=r)&&s.__esModule?s:{default:s};var o=/^-ms-/;e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.animationEnd=t.animationDelay=t.animationTiming=t.animationDuration=t.animationName=t.transitionEnd=t.transitionDuration=t.transitionDelay=t.transitionTiming=t.transitionProperty=t.transform=void 0;var s,r=n(33);var a="transform",o=void 0,i=void 0,l=void 0,c=void 0,u=void 0,h=void 0,d=void 0,p=void 0,f=void 0,m=void 0,g=void 0;if(((s=r)&&s.__esModule?s:{default:s}).default){var y=function(){for(var e=document.createElement("div").style,t={O:function(e){return"o"+e.toLowerCase()},Moz:function(e){return e.toLowerCase()},Webkit:function(e){return"webkit"+e},ms:function(e){return"MS"+e}},n=Object.keys(t),s=void 0,r=void 0,a="",o=0;o<n.length;o++){var i=n[o];if(i+"TransitionProperty"in e){a="-"+i.toLowerCase(),s=t[i]("TransitionEnd"),r=t[i]("AnimationEnd");break}}!s&&"transitionProperty"in e&&(s="transitionend");!r&&"animationName"in e&&(r="animationend");return e=null,{animationEnd:r,transitionEnd:s,prefix:a}}();o=y.prefix,t.transitionEnd=i=y.transitionEnd,t.animationEnd=l=y.animationEnd,t.transform=a=o+"-"+a,t.transitionProperty=c=o+"-transition-property",t.transitionDuration=u=o+"-transition-duration",t.transitionDelay=d=o+"-transition-delay",t.transitionTiming=h=o+"-transition-timing-function",t.animationName=p=o+"-animation-name",t.animationDuration=f=o+"-animation-duration",t.animationTiming=m=o+"-animation-delay",t.animationDelay=g=o+"-animation-timing-function"}t.transform=a,t.transitionProperty=c,t.transitionTiming=h,t.transitionDelay=d,t.transitionDuration=u,t.transitionEnd=i,t.animationName=p,t.animationDuration=f,t.animationTiming=m,t.animationDelay=g,t.animationEnd=l,t.default={transform:a,end:i,property:c,timing:h,delay:d,duration:u}},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e){return(0,s.default)(e)||(t=e,t&&"body"===t.tagName.toLowerCase())?function(e){var t=(0,r.default)(e),n=(0,s.default)(t).innerWidth;if(!n){var a=t.documentElement.getBoundingClientRect();n=a.right-Math.abs(a.left)}return t.body.clientWidth<n}(e):e.scrollHeight>e.clientHeight;var t};var s=a(n(81)),r=a(n(38));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";function s(){var e=this.constructor.getDerivedStateFromProps(this.props,this.state);null!=e&&this.setState(e)}function r(e){this.setState(function(t){var n=this.constructor.getDerivedStateFromProps(e,t);return null!=n?n:null}.bind(this))}function a(e,t){try{var n=this.props,s=this.state;this.props=e,this.state=t,this.__reactInternalSnapshotFlag=!0,this.__reactInternalSnapshot=this.getSnapshotBeforeUpdate(n,s)}finally{this.props=n,this.state=s}}function o(e){var t=e.prototype;if(!t||!t.isReactComponent)throw new Error("Can only polyfill class components");if("function"!=typeof e.getDerivedStateFromProps&&"function"!=typeof t.getSnapshotBeforeUpdate)return e;var n=null,o=null,i=null;if("function"==typeof t.componentWillMount?n="componentWillMount":"function"==typeof t.UNSAFE_componentWillMount&&(n="UNSAFE_componentWillMount"),"function"==typeof t.componentWillReceiveProps?o="componentWillReceiveProps":"function"==typeof t.UNSAFE_componentWillReceiveProps&&(o="UNSAFE_componentWillReceiveProps"),"function"==typeof t.componentWillUpdate?i="componentWillUpdate":"function"==typeof t.UNSAFE_componentWillUpdate&&(i="UNSAFE_componentWillUpdate"),null!==n||null!==o||null!==i){var l=e.displayName||e.name,c="function"==typeof e.getDerivedStateFromProps?"getDerivedStateFromProps()":"getSnapshotBeforeUpdate()";throw Error("Unsafe legacy lifecycles will not be called for components using new component APIs.\n\n"+l+" uses "+c+" but also contains the following legacy lifecycles:"+(null!==n?"\n  "+n:"")+(null!==o?"\n  "+o:"")+(null!==i?"\n  "+i:"")+"\n\nThe above lifecycles should be removed. Learn more about this warning here:\nhttps://fb.me/react-async-component-lifecycle-hooks")}if("function"==typeof e.getDerivedStateFromProps&&(t.componentWillMount=s,t.componentWillReceiveProps=r),"function"==typeof t.getSnapshotBeforeUpdate){if("function"!=typeof t.componentDidUpdate)throw new Error("Cannot polyfill getSnapshotBeforeUpdate() for components that do not define componentDidUpdate() on the prototype");t.componentWillUpdate=a;var u=t.componentDidUpdate;t.componentDidUpdate=function(e,t,n){var s=this.__reactInternalSnapshotFlag?this.__reactInternalSnapshot:n;u.call(this,e,t,s)}}return e}n.r(t),n.d(t,"polyfill",function(){return o}),s.__suppressDeprecationWarning=!0,r.__suppressDeprecationWarning=!0,a.__suppressDeprecationWarning=!0},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=o(n(1)),a=o(n(0));function o(e){return e&&e.__esModule?e:{default:e}}var i=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.render=function(){var e,t,n=this.props,a=n.component,o=n.children,i=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(n,["component","children"]);return r.default.createElement(a,s({},i,{onClick:(e=i.onClick,t=this.context.onModalHide,function(){e&&e.apply(void 0,arguments),t&&t.apply(void 0,arguments)})}),o)},t}(r.default.Component);i.propTypes={component:a.default.oneOfType([a.default.string,a.default.func])},i.defaultProps={component:"button"},i.contextTypes={onModalHide:a.default.func},t.default=i,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Texts={},t.Texts.intro={},t.Texts.intro.chapter1="\nWelcome to the wintry realms!\nWinds are ever-blowing. Blowing off the\nglaciers.\nAre you ready to face the challenges of the\nicy north? Hunger, coldness, ravenous\nbeasts, glacial chasms and forthcoming\neternal winter are waiting for you in the\ndarkness.\n",t.Texts.intro.chapter2="\nYou have come a long way from your homelands\nseeking\nthe thrill of the adventure. Now, you must\nfight freezing battles in\nthe north against hordes of winter demons\nand blizzard beasts. Will you bring back the\npeace\nto the grim and frostbitten kingdoms. Or\nwill you\nbring the Winter of Ages upon its lands,\nreigning\nyour kingdom cold for all eternity? Or will\nyou\nperish\nnameless and forgotten on the icy wastes?\n",t.Texts.battle={},t.Texts.battle.eyeOfStorm="You see an eye of the storm approaching. Brace yourself now..",t.Texts.battle.beastsSlain="All beasts have been slain. The blizzard seems to calm down",t.Texts.battle.enemiesDead="All enemies are dead! You emerge victorious. Congratulations!"},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(28),i=r(n(43)),l=r(n(34)),c=r(n(25));t.Chat={};const u=a.default.STATS,h=i.Menu.EXIT_MENU,d={name:"Say goodbye",option:h};t.Chat.tradeGoldWeightFromTo=((e,t,n)=>{const s=a.default.getGoldInCoins(e),r=new l.GoldCoin,o=a.default.removeNCoins(t,s);r.setCount(o),n.getInvEq().addItem(r)});class p{constructor(){this.options=[],this.parent=null}add({name:e,option:t}){this.options.push({name:e,option:t}),t&&t.setParent&&t.setParent(this)}clearOptions(){this.options=[]}setParent(e){this.parent=e}getParent(){return this.parent}getSelectionObject(){return{showMenu:()=>!0,getMenu:()=>{const e={pre:[],post:[]};return this.options.forEach((t,n)=>{e[o.Keys.menuIndices[n]]=t.name}),this.pre&&(e.pre=this.pre),this.post&&(e.post=this.post),e.Q=d.name,e},select:e=>{const t=o.Keys.codeToIndex(e);if(t<this.options.length){const e=this.options[t].option;return e!==h&&e.getSelectionObject?e.getSelectionObject():e}return h}}}}t.ChatBase=p,t.Chat.ChatBase=p;class f extends p{constructor(){super();const e={name:"Accept the quest",option:this.questCallback.bind(this)},t={name:"Refuse the quest",option:h};this.add(e),this.add(t)}setQuestGiver(e){this.questGiver=e}setTarget(e){const t=this.questGiver;this.chatter=e;const n=this.questGiver.get("QuestGiver");if(n.getHasGivenQuest()){this.pre=[`${t.getName()} has already given this quest:`,`${n.getDescr()}`,"What do you want to do?"],this.clearOptions();const e={name:"Claim the reward",option:this.rewardCallback.bind(this)};this.add(e)}else this.pre=[`${t.getName()} wants to offer a lengthy quest:`,`${n.getDescr()}`,"What do you want to do?"]}questCallback(){a.default.isNullOrUndef([this.chatter,this.questGiver])&&a.default.err("ChatQuest","questCallback","target and questGiver must be defined");const e=new c.GiveQuest;e.setTarget(this.chatter),e.setGiver(this.questGiver),this.chatter.add(e)}rewardCallback(){const e=new c.QuestCompleted;e.setGiver(this.questGiver),this.chatter.add(e)}}t.ChatQuest=f,t.Chat.Quest=f;class m extends p{constructor(){super(),this.selectionObject={showMenu:()=>!0,pre:["Please select a stat to train:"],getMenu:()=>{const e=o.Keys.menuIndices.slice(0,6),t={};return u.forEach((n,s)=>{t[e[s]]=u[s],t[e[s]]+=` (${this.costs[s]} gold)`}),t},select:e=>{const t=o.Keys.codeToIndex(e);if(t<u.length){const e=u[t],n=this.costs[t];return this.trainCallback(e,n)}return null}},this.trainCallback=this.trainCallback.bind(this)}setTrainer(e){this.trainer=e}setTarget(e){this.chatter=e,this.costs=[],u.forEach(t=>{const n="get"+t;this.costs.push(100*e.get("Stats")[n]())})}getSelectionObject(){return this.selectionObject}trainCallback(e,n){return()=>{const s=a.default.valueToGoldWeight(n),r=this.chatter.getName();if(!a.default.hasEnoughGold(this.chatter,s)){const e=`${r} does not have enough gold.`;return void a.default.gameMsg({cell:this.chatter.getCell(),msg:e})}t.Chat.tradeGoldWeightFromTo(s,this.chatter,this.trainer);const o=this.chatter.get("Stats"),i=this.trainer.get("Stats"),l="get"+e,c="set"+e,u=o[l](),h=i[l](),d=this.trainer.getName();if(u<h){const t=u+1;o[c](t);const n=`${d} trains ${e} of ${r}`;a.default.gameMsg({cell:this.chatter.getCell(),msg:n})}else{const e=`${d} doesn't have skill to train that stat`;a.default.gameMsg({cell:this.chatter.getCell(),msg:e})}}}}t.ChatTrainer=m,t.Chat.Trainer=m;class g extends p{constructor(){super(),this.costs={0:10,1:45,2:50},this.selectionObject={showMenu:()=>!0,getMenu:()=>{a.default.gameMsg("Please select a magical service to buy:");const e=this.wizard.get("SpellPower").getPP(),t={};e>=10&&(t[0]="Restore 10pp - 10 gold coins"),e>=50&&(t[1]="Restore 50pp - 45 gold coins"),e>=25&&(t[2]="Add one charge to rune - 50 gold coins")},select:e=>{const t=o.Keys.codeToIndex(e);return this.wizardCallback(t)}},this.wizardCallback=this.wizardCallback.bind(this)}setWizard(e){this.wizard=e}getSelectionObject(){return this.selectionObject}wizardCallback(e){const t=this.costs[e];return()=>{if(a.default.hasEnoughGold(this.chatter,t))switch(e){case 0:this.restorePP(10);break;case 1:this.restorePP(50);break;case 2:this.setRuneSelectionObject()}}}restorePP(e){this.wizard.get("SpellPower").decrPP(e),this.chatter.get("SpellPower").addPP(e)}setRuneSelectionObject(){this.chatter.getBrain().setSelectionObject({})}}t.ChatWizard=g,t.Chat.Wizard=g},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(40),o=n(20);t.MindControl=function(){a.ComponentBase.call(this,"MindControl");let e=null,t=null;this.getSource=(()=>e),this.setSource=(t=>{e=t});this.addCallback("onAdd",()=>{const e=this.getEntity();t=e.getBrain(),this.getSource().isPlayer()?e.setPlayerCtrl(!0):e.setBrain(new o.BrainMindControl(e))}),this.addCallback("onRemove",()=>{this.getSource().isPlayer()&&this.getEntity().setPlayerCtrl(!1),this.getEntity().setBrain(t)})},r.default.extend2(t.MindControl,a.ComponentBase),t.MindControl.prototype.toJSON=function(){const e=a.ComponentBase.prototype.toJSON.call(this);return r.default.isActorActive(this.getSource())&&(e.setSource=r.default.getObjRef("entity",this.getSource())),e}},function(e,t){var n,s,r=e.exports={};function a(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function i(e){if(n===setTimeout)return setTimeout(e,0);if((n===a||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:a}catch(e){n=a}try{s="function"==typeof clearTimeout?clearTimeout:o}catch(e){s=o}}();var l,c=[],u=!1,h=-1;function d(){u&&l&&(u=!1,l.length?c=l.concat(c):h=-1,c.length&&p())}function p(){if(!u){var e=i(d);u=!0;for(var t=c.length;t;){for(l=c,c=[];++h<t;)l&&l[h].run();h=-1,t=c.length}l=null,u=!1,function(e){if(s===clearTimeout)return clearTimeout(e);if((s===o||!s)&&clearTimeout)return s=clearTimeout,clearTimeout(e);try{s(e)}catch(t){try{return s.call(null,e)}catch(t){return s.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function m(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new f(e,t)),1!==c.length||u||i(p)},f.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=m,r.addListener=m,r.once=m,r.off=m,r.removeListener=m,r.removeAllListeners=m,r.emit=m,r.prependListener=m,r.prependOnceListener=m,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=r(n(34)),i=n(126);t.Inventory=class{static equipAnyItem(e,t){const n=e.getInvEq();n.hasItem(t)||n.addItem(t),n.equipItem(t)}constructor(e){this._actor=e,this._inv=new o.Container(e),this._eq=new i.Equipment(e)}addItem(e){this._inv.addItem(e)}hasItem(e){return this._inv.hasItem(e)}removeItem(e){return this._inv.removeItem(e)}removeNItems(e,t){return this._inv.removeNItems(e,t)}getRemovedItem(){return this._inv.getRemovedItem()}useItem(e,t){if(this._inv.hasItem(e)){if(e.useItem)return e.useItem(t),!0}else a.default.err("Inv.Inventory","useItem","Not in inventory, cannot use!");return!1}canCarryItem(e){return!(this._eq.getWeight()+this._inv.getWeight()+e.getWeight()>this._actor.getMaxWeight())}dropItem(e){if(this._inv.removeItem(e)){const e=this._actor.getLevel(),t=this.getRemovedItem(),[n,s]=this._actor.getXY();if(e.addItem(t,n,s))return!0;this._inv.addItem(t)}return!1}dropNItems(e,t){if(this.removeNItems(e,t)){const e=this._actor.getLevel(),t=this.getRemovedItem(),[n,s]=this._actor.getXY();if(e.addItem(t,n,s))return!0;this._inv.addItem(t)}return!1}removeAndGetItem(e){return this._inv.removeItem(e)?this.getRemovedItem():null}getInventory(){return this._inv}getEquipment(){return this._eq}equipItem(e){if(this._inv.hasItem(e)){const t=this._getItemToEquip(e);if(a.default.isNullOrUndef([t]))return a.default.err("Inv.Inventory","equipItem","equippedItem is null. Should not happen"),!1;if(this._eq.equipItem(t))return!0;this._inv.addItem(t)}else a.default.err("Inv.Inventory","equipItem","Cannot equip. Not in inventory.");return!1}_getItemToEquip(e){return this._inv.removeItem(e)?this._inv.getRemovedItem():null}equipNItems(e,t){if(this._inv.hasItem(e)&&this._inv.removeNItems(e,t)){const e=this._inv.getRemovedItem();if(this._eq.equipItem(e))return!0;this._inv.addItem(e)}return!1}unequipItem(e,t,n){if(a.default.isNullOrUndef([e])){let s="Some params null/undef: ";s+=`type: |${e}| n: |${t}| number: |${n}|`,a.default.err("InvInventory","unequipItem",s)}const s=this._eq.getItem(e);if(!a.default.isNullOrUndef([s])&&this._eq.unequipItem(e,t,n)){const t=this._eq.getUnequipped(e,n);if(null!==t)return this.addItem(t),!0}return!1}unequipAndGetItem(e,t,n){const s=this._eq.getItem(e);return!a.default.isNullOrUndef([s])&&this._eq.unequipItem(e,t)?this._eq.getUnequipped(e,n):null}getWeapon(){const e=this._eq.getItem("hand");return a.default.isNullOrUndef([e])?null:e}getMissileWeapon(){const e=this._eq.getItem("missileweapon");return a.default.isNullOrUndef([e])?null:e}getMissile(){const e=this._eq.getItem("missile");return e||null}getEquipped(e){return this._eq.getItem(e)}restoreEquipped(e){return this._eq.equipItem(e)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(30),i=r(n(11)),l=["actors","items","elements"],c=e=>{if(!e){const e="Possibly missing args for useItem().";a.default.err("effects.js","getTargetActor",`Given object was null/undefined. ${e}`)}if(e.hasOwnProperty("target")){const t=e.target;if(t.hasActors())return t.getProp("actors")[0]}return null},u=(e,t,n)=>{const s=new i.UseItem;s.setTarget(t),s.setItem(e),n&&s.setEffect(n);const r=a.default.getItemUseType(e,t);s.setUseType(r),e.getTopOwner().add(s)};t.Effects={effects:[{name:"use",func(e){if(this.getCharges&&0===this.getCharges()){const e=this.getName();return a.default.gameMsg(`${e} does not have any charges left`),!1}for(let t=0;t<this.useFuncs.length;t++)if(this.useFuncs[t].call(this,e))return!0;return!1}},{name:"addComp",requires:["name","duration"],optional:["setters"],func(e){const t={duration:this.useArgs.duration,effectType:"AddComp",name:this.useArgs.name,target:e,targetType:["actors","items"]};return this.useArgs.setters&&(t.setters=this.useArgs.setters),u(this,e,t),!0}},{name:"removeComp",requires:["name"],optional:["all"],func(e){const t={all:this.useArgs.all,effectType:"RemoveComp",name:this.useArgs.name,target:e,targetType:l};return u(this,e,t),!0}},{name:"modifyCompValue",requires:["name","set","get","value"],optional:["op"],func(e){const t={target:e,targetType:l,name:this.useArgs.name,set:this.useArgs.set,get:this.useArgs.get,value:this.useArgs.value,effectType:"ModifyCompValue"};return u(this,e,t),!0}},{name:"cure",requires:["effect"],func(e){const t=c(e);if(t){const e=this.useArgs.effect.capitalize();return t.has(e)?(t.remove(e),a.default.gameMsg(t.getName()+" seems to be cured of "+e)):a.default.gameMsg(this.getName()+" was wasted"),u(this,t),!0}return!1}},{name:"digger",func(e){const t=`${this.getTopOwner().getName()} digs through stone with ${this.getName()}`;return u(this,e,{effectType:"ChangeElement",fromType:"wall",target:e,startMsg:t,targetType:["elements"]}),!0}},{name:"heal",requires:["hp"],func(e){const t=c(e);if(t){const e=o.Dice.create(this.useArgs.hp).roll();if(t.has("Health"))return t.get("Health").addHP(e),u(this,t),a.default.gameMsg(t.getName()+" drinks "+this.getName()),!0}else a.default.gameWarn("Cannot see anyone there for using the potion.");return!1}},{name:"poison",requires:["duration","damage","prob"],func(e){const t=o.Dice.parseDieSpec(this.useArgs.damage),n=new o.Dice(t[0],t[1],t[2]),s={target:e,targetType:["actors","items"],name:"Poison",duration:this.useArgs.duration,effectType:"AddComp",setters:{setDamageDie:n,setProb:this.useArgs.prob,setSource:this.getTopOwner()}};return u(this,e,s),!0}},{name:"stun",requires:["duration"],func(e){const t=c(e);if(t){const e=function(e){const t=o.Dice.parseDieSpec(e);return new o.Dice(t[0],t[1],t[2]).roll()}(this.useArgs.duration),n=new i.Stun,s=new i.Expiration;s.addEffect(n,e);const r=this.getTopOwner();return n.setSource(r),t.add(n),t.add(s),u(this,t),a.default.gameMsg(t.getName()+" is stunned by "+this.getName()),!0}return!1}},{name:"modifyStat",requires:["statName","value"],func(e){const t={target:e,targetType:["actors"],name:"Stats",set:"set"+this.useArgs.statName.capitalize(),get:"get"+this.useArgs.statName.capitalize(),value:this.useArgs.value,effectType:"ModifyCompValue"};return u(this,e,t),!0}},{name:"addEntity",requires:["entityName"],optional:["duration"],func(e){const t={target:e,targetType:["cell"],entityName:this.useArgs.entityName,effectType:"AddEntity",duration:this.useArgs.duration};return u(this,e,t),!0}},{name:"addElement",requires:["elementName"],optional:["duration","numAllowed"],func(e){const t={target:e,targetType:["cell"],elementName:this.useArgs.elementName,effectType:"AddElement",duration:this.useArgs.duration,numAllowed:this.useArgs.numAllowed||1,successMsg:this.useArgs.successMsg,failureMsg:this.useArgs.failureMsg};return u(this,e,t),!0}},{name:"removeElement",requires:["elementName"],optional:["successMsg","failureMsg"],func(e){const t={target:e,targetType:["cell"],elementName:this.useArgs.elementName,effectType:"RemoveElement",successMsg:this.useArgs.successMsg,failureMsg:this.useArgs.failureMsg};return u(this,e,t),!0}}]}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(88);t.Spell=o.Spell;const i=r(n(11)),l=n(30),c=n(14),u=n(20),h=n(9),d=r(n(15)),p=h.Random.getRNG(),{getDirSpellArgs:f,aiSpellCellEnemy:m,aiSpellCellFriend:g,aiSpellCellSelf:y,addPoisonEffect:v,addFadingActorToCell:_,aiSpellCellDone:b}=o.Spell;o.Spell.DispelMagic=function(){o.Spell.RemoveComponent.call(this,"DispelMagic",8),this.setCompNames("Duration")},a.default.extend2(o.Spell.DispelMagic,o.Spell.RemoveComponent),o.Spell.Charm=function(){o.SpellBase.call(this,"Charm"),this._dice.duration=l.Dice.create("10d6 + 5")},a.default.extend2(o.Spell.Charm,o.SpellBase),o.Spell.Charm.prototype.cast=function(e){const t=f(this,e),n=new i.SpellCell;t.callback=this.charmCallback.bind(this),n.setArgs(t),e.src.add(n)},o.Spell.Charm.prototype.charmCallback=function(e){const t=e.getSentientActors();if(t&&t.length>0){const e=t[0];let n=1+this.getCasterExpBonus(3);n+=this.getCasterStatBonus("willpower",3);const s=new i.Charm;s.setTargetActor(e.getID()),s.setLevel(n);const r=this.getDuration();i.addToExpirationComp(this.getCaster(),s,r);const o=this.getCaster(),l=`${o.getName()} charms ${e.getName()}`;a.default.gameMsg({cell:o.getCell(),msg:l})}},o.Spell.Charm.prototype.getSelectionObject=function(e){return o.Spell.getSelectionObjectDir(this,e,"Select a direction for charming:")},o.Spell.Charm.prototype.aiShouldCastSpell=function(e,t){return m(e,t)},o.Spell.GraspOfWinter=function(){o.SpellBase.call(this,"Grasp of winter"),this._dice.damage=l.Dice.create("4d4 + 4")},a.default.extend2(o.Spell.GraspOfWinter,o.SpellBase),o.Spell.GraspOfWinter.prototype.cast=function(e){const t=f(this,e);t.damageType=a.default.DMG.ICE,t.damage=this.getDamage();const n=new i.SpellCell;n.setArgs(t),e.src.add(n)},o.Spell.GraspOfWinter.prototype.getSelectionObject=function(e){return o.Spell.getSelectionObjectDir(this,e,"Select a direction for grasping:")},o.Spell.GraspOfWinter.prototype.aiShouldCastSpell=function(e,t){return m(e,t)},o.Spell.AnimateDead=function(){o.Spell.AddComponent.call(this,"AnimateDead",5),this.setCompName("Undead"),delete this._dice.duration},a.default.extend2(o.Spell.AnimateDead,o.Spell.AddComponent),o.Spell.AnimateDead.prototype.cast=function(e){o.Spell.AddComponent.prototype.cast.call(this,e);const{src:t}=e;t.get("SpellCell").getArgs().callback=this.animateCallback.bind(this)},o.Spell.AnimateDead.prototype.animateCallback=function(e){const t=["Named","Stats","Combat","Experience"],n=this.getCaster();if(!e.hasItems())return;const s=e.getItems().find(e=>/corpse/.test(e.getName()));if(s.has("Undead")){const e=`${n.getName()} fails to reanimate undead remains`;a.default.gameMsg({cell:n.getCell(),msg:e})}else if(s){const e=c.ObjectShell.getParser().createActor(s.getActorName());e.add(new i.Undead),t.forEach(t=>{const n=s.get(t);e.remove(t),n.changeEntity(e)}),e.get("Named").prepend("undead "),a.default.addCellStyle(a.default.TYPE_ACTOR,e.get("Named").getName(),"cell-actor-undead");const[r,o]=s.getXY(),l=n.getLevel(),u=new i.Created;u.setCreator(n),e.add(u),e.add(new i.Undead),l.removeItem(s,r,o)&&(l.addActor(e,r,o),e.addFriend(n))}},o.Spell.AnimateDead.prototype.aiShouldCastSpell=((e,t)=>{const n=e.actor,s=u.Brain.getCellsAroundActor(n).filter(e=>e.hasItems()&&e.getItems().find(e=>"corpse"===e.getType()));if(0===s.length)return!1;const r=p.arrayGetRand(s);return b(n,r,t),!0}),o.Spell.Flying=function(){o.Spell.AddComponent.call(this,"Flying",5),this.setCompName("Flying"),this._dice.duration=l.Dice.create("10d5 + 5"),this.aiShouldCastSpell=((e,t)=>g(e,t))},a.default.extend2(o.Spell.Flying,o.Spell.AddComponent),o.Spell.Telepathy=function(){o.Spell.AddComponent.call(this,"Telepathy",5),this.setCompName("Telepathy"),this._dice.duration=l.Dice.create("10d10 + 10"),this.aiShouldCastSpell=((e,t)=>{let n=g(e,t);return n||(n=m(e,t)),n})},a.default.extend2(o.Spell.Telepathy,o.Spell.AddComponent),o.Spell.Telepathy.prototype.cast=function(e){o.Spell.AddComponent.prototype.cast.call(this,e);const{src:t}=e;if(t){const n=t.get("SpellCell").getArgs(),{addComp:s}=n,r=s.comp;if("Telepathy"===r.getType()){const{duration:a}=s,o=r.clone();let l={dir:[0,0],src:this._caster,spell:null};(l=f(this,l)).addComp={comp:o,duration:a},n.postCallback=(e=>{r.setSource(t),r.setTarget(e.getSentientActors()[0])}),l.postCallback=(()=>{o.setSource(r.getSource()),o.setTarget(r.getTarget())});const c=new i.SpellCell;c.setArgs(l),e.src.add(c)}}else{const t=JSON.stringify(e);a.default.err("Spell.Telepathy","cast","No src found in args: "+t)}},o.Spell.Paralysis=function(){o.Spell.AddComponent.call(this,"Paralysis",7),this.setCompName("Paralysis"),this.setDuration(l.Dice.create("1d6 + 2")),this.aiShouldCastSpell=((e,t)=>m(e,t))},a.default.extend2(o.Spell.Paralysis,o.Spell.AddComponent),o.Spell.StunningTouch=function(){o.Spell.AddComponent.call(this,"StunningTouch",7),this.setCompName("Stun"),this.setDuration(l.Dice.create("1d6 + 2")),this.aiShouldCastSpell=((e,t)=>m(e,t))},a.default.extend2(o.Spell.StunningTouch,o.Spell.AddComponent),o.Spell.SpiritForm=function(){o.Spell.AddComponent.call(this,"SpiritForm",10),this.setCompName("Ethereal"),this.setDuration(l.Dice.create("1d6 + 4")),this.aiShouldCastSpell=((e,t)=>g(e,t))},a.default.extend2(o.Spell.SpiritForm,o.Spell.AddComponent),o.Spell.FrostBolt=function(){o.Spell.BoltBase.call(this,"Frost bolt",5),this.setDice("damage",l.Dice.create("4d4 + 4")),this.setRange(5),this.damageType=a.default.DMG.ICE},a.default.extend2(o.Spell.FrostBolt,o.Spell.BoltBase),o.Spell.LightningBolt=function(){o.Spell.BoltBase.call(this,"Lightning bolt",8),this.damageType=a.default.DMG.LIGHTNING,this.setRange(6),this.setDice("damage",l.Dice.create("6d3 + 3"))},a.default.extend2(o.Spell.LightningBolt,o.Spell.BoltBase),o.Spell.ScorpionsTail=function(){o.Spell.BoltBase.call(this,"Scorpions tail",1),this.damageType=a.default.DMG.MELEE,this.setRange(2),this.setDice("damage",l.Dice.create("2d4 + 2"))},a.default.extend2(o.Spell.ScorpionsTail,o.Spell.BoltBase),o.Spell.ScorpionsTail.prototype.onHit=function(e,t){v(e,t)},o.Spell.ShadowRay=function(){o.Spell.BoltBase.call(this,"Shadow ray",8),this.setDice("damage",l.Dice.create("6d4 + 4")),this.setRange(8),this.damageType=a.default.DMG.NECRO},a.default.extend2(o.Spell.ShadowRay,o.Spell.BoltBase),o.Spell.CrossBolt=function(){o.Spell.BoltBase.call(this,"Cross bolt",20),this.damageType=a.default.DMG.LIGHTNING,this.setRange(6),this.setDice("damage",l.Dice.create("6d3 + 3")),this.cast=function(e){const t=e.dir;let n=a.default.DIR_NSEW;0!==t[0]&&0!==t[1]&&(n=a.default.DIR_DIAG),n.forEach(t=>{const n=Object.assign({},e);n.dir=t;const s=f(this,n);s.damageType=this.damageType,s.damage=this.rollDice("damage");const r=new i.SpellRay;r.setArgs(s),e.src.add(r)})}},a.default.extend2(o.Spell.CrossBolt,o.Spell.BoltBase),o.Spell.PoisonBreath=function(){o.Spell.BoltBase.call(this,"PoisonBreath",8),this.setDice("damage",l.Dice.create("6d4 + 4")),this.setRange(8),this.damageType=a.default.DMG.POISON,this.nActors=2,this.stopOnHit=!0,this._createdActor="Poison gas",this._dice.duration=l.Dice.create("5d5 + 5")},a.default.extend2(o.Spell.PoisonBreath,o.Spell.BoltBase),o.Spell.PoisonBreath.prototype.onHit=function(e,t){v(e,t);const n=c.ObjectShell.getParser(),s=u.Brain.getCellsAroundActor(e,1);for(let e=0;e<this.nActors;e++){const e=p.arrayGetRand(s);if(e.isPassable()||e.hasActors()){const t=n.createActor(this._createdActor);_(t,e,this)}}const r=`Poison clouds spread from poison breath of ${t.getName()}`;a.default.gameSuccess({cell:e.getCell(),msg:r})},o.Spell.WaterBolt=function(){o.Spell.BoltBase.call(this,"WaterBolt",10),this.setDice("damage",l.Dice.create("4d4 + 4")),this.setRange(5),this.damageType=a.default.DMG.WATER},a.default.extend2(o.Spell.WaterBolt,o.Spell.BoltBase),o.Spell.SlimeBolt=function(){o.Spell.BoltBase.call(this,"SlimeBolt",10),this.setDice("damage",l.Dice.create("4d4 + 4")),this.setRange(5),this.damageType=a.default.DMG.SLIME,this.stopOnHit=!0},a.default.extend2(o.Spell.SlimeBolt,o.Spell.BoltBase),o.Spell.SlimeBolt.prototype.onHit=function(e,t){const n=e.getLevel();u.Brain.getCellsAroundActor(e,1).forEach(e=>{if(e.isPassable()||e.hasActors()){const t=new d.ElementSlime;n.addElement(t,e.getX(),e.getY())}}),e.add(new i.Entrapped);const s=`Slime is spread around by ${t.getName()}`;a.default.gameSuccess({cell:e.getCell(),msg:s})},o.Spell.IceShield=function(){o.SpellBase.call(this,"Ice shield",6),this._dice.duration=l.Dice.create("5d5 + 15"),this._dice.defense=l.Dice.create("1d6 + 3"),this.cast=(e=>{const t=e.src,n=this.getDuration(),s=new i.CombatMods;s.setDefense(this.rollDice("defense")),i.addToExpirationComp(t,s,n),a.default.gameMsg({cell:t.getCell(),msg:`${t.getName()} is surrounded by defensive aura`})}),this.getSelectionObject=function(e){return o.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=((e,t)=>g(e,t))},a.default.extend2(o.Spell.IceShield,o.SpellBase),o.Spell.IceShield.prototype.toString=function(){let e=o.SpellBase.prototype.toString.call(this);return e+=` Def: ${this._dice.defense.toString()}`},o.Spell.MagicArmor=function(){o.SpellBase.call(this,"MagicArmor",5),this._dice.duration=l.Dice.create("6d5 + 15"),this._dice.protection=l.Dice.create("2d6 + 2"),this.cast=(e=>{const t=e.src,n=t.getName(),s={target:t,name:"CombatMods",setters:{setProtection:this.rollDice("protection")},duration:this._dice.duration,startMsg:`${n} is surrounded by a protective aura`,expireMsg:`Protective aura disappears from ${n}`},r=new i.Effects(s);r.setEffectType("AddComp"),t.add(r)}),this.getSelectionObject=function(e){return o.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=((e,t)=>g(e,t))},a.default.extend2(o.Spell.MagicArmor,o.SpellBase),o.Spell.MagicArmor.prototype.toString=function(){let e=o.SpellBase.prototype.toString.call(this);return e+=` Pro: ${this._dice.protection.toString()}`},o.Spell.IcyPrison=function(){o.SpellBase.call(this,"Icy prison",10),this._dice.duration=l.Dice.create("1d8 + 1"),this.cast=function(e){const t=f(this,e),n=this.getDuration(),s=new i.Paralysis;s.setSource(e.src),t.addComp={comp:s,duration:n};const r=new i.SpellCell;r.setArgs(t),e.src.add(r)},this.getSelectionObject=function(e){return o.Spell.getSelectionObjectDir(this,e,"Select a direction for casting:")},this.aiShouldCastSpell=((e,t)=>m(e,t))},a.default.extend2(o.Spell.IcyPrison,o.SpellBase),o.Spell.SummonIceMinion=function(){o.Spell.SummonBase.call(this,"SummonIceMinion",14),this.summonType="Ice minion"},a.default.extend2(o.Spell.SummonIceMinion,o.Spell.SummonBase),o.Spell.SummonAirElemental=function(){o.Spell.SummonBase.call(this,"SummonAirElemental",20),this.summonFunc=(e=>"air elemental"===e.name)},a.default.extend2(o.Spell.SummonAirElemental,o.Spell.SummonBase),o.Spell.SummonUndeadUnicorns=function(){o.Spell.SummonBase.call(this,"SummonUndeadUnicorns",15),this.nActors="1d4 + 1",this.summonFunc=(e=>"undead unicorn"===e.name)},a.default.extend2(o.Spell.SummonUndeadUnicorns,o.Spell.SummonBase),o.Spell.SummonAnimal=function(){o.Spell.SummonBase.call(this,"SummonAnimal",10),this.summonFunc=(e=>{const t=this.getCaster().get("Experience").getExpLevel();let n=Math.round(t/3)||1;n>10&&(n=10);const s=Math.round(t/2);return"animal"===e.type&&e.danger>=n&&e.danger<=s})},a.default.extend2(o.Spell.SummonAnimal,o.Spell.SummonBase),o.Spell.SummonDead=function(){o.Spell.SummonBase.call(this,"SummonDead",15),this.nActors=4,this.summonFunc=(e=>"undead"===e.type&&e.name!==this.getCaster().getName())},a.default.extend2(o.Spell.SummonDead,o.Spell.SummonBase),o.Spell.SummonSpiders=function(){o.Spell.SummonBase.call(this,"SummonSpiders",10),this.nActors="1d4 + 1",this.summonFunc=(e=>{const t=this.getCaster().get("Experience"),n=t.getDanger(),s=t.getExpLevel(),r=n+Math.round(s/2);return/spider/.test(e.name)&&e.danger<=r})},a.default.extend2(o.Spell.SummonSpiders,o.Spell.SummonBase),o.Spell.SummonKin=function(){o.Spell.SummonBase.call(this,"SummonKin",10),this.summonFunc=(e=>{const t=this.getCaster().getType(),n=this.getCaster().get("Experience"),s=n.getDanger(),r=n.getExpLevel(),a=s+Math.round(r/2);return e.type===t&&e.danger<=a})},a.default.extend2(o.Spell.SummonKin,o.Spell.SummonBase),o.Spell.SummonFlyingEyes=function(){o.Spell.SummonBase.call(this,"SummonFlyingEyes",4),this.summonType="flying eye",this.nActors="1d6 + 1",this._dice.duration=l.Dice.create("10d5 + 10"),this.postSummonCallback=((e,t,n)=>{const s=new i.Fading,r=this.getDuration();s.setDuration(r),n.add(s);const a=new i.Telepathy;a.setTarget(n),a.setSource(this._caster);const o=a.clone();i.addToExpirationComp(n,a,r),i.addToExpirationComp(this._caster,o,r)}),this.aiShouldCastSpell=((e,t)=>{const{actor:n}=e;return!n.has("Telepathy")&&(e.dir=[0,0],t(n,e),!0)})},a.default.extend2(o.Spell.SummonFlyingEyes,o.Spell.SummonBase),o.Spell.PowerDrain=function(){o.SpellBase.call(this,"PowerDrain",15),this._dice.duration=l.Dice.create("20d5 + 10"),this.cast=(e=>{const t=e.src,n=this.getDuration(),s=new i.PowerDrain;i.addToExpirationComp(t,s,n),a.default.gameMsg({cell:t.getCell(),msg:`${t.getName()} is surrounded by purple aura`})}),this.getSelectionObject=function(e){return o.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=((e,t)=>(this.compFuncArgs={enemy:e.enemy},e.compFunc=this.aiCompFunc.bind(this),y(e,t))),this.aiCompFunc=(e=>{const{enemy:t}=this.compFuncArgs;return!!t&&!(e.has("PowerDrain")||!t.has("SpellPower"))})},a.default.extend2(o.Spell.PowerDrain,o.SpellBase),o.Spell.IceArrow=function(){o.Spell.Missile.call(this,"IceArrow",16),this.setRange(9),this.damageType=a.default.DMG.ICE,this.ammoName="Ice arrow"},a.default.extend2(o.Spell.IceArrow,o.Spell.Missile),o.Spell.LightningArrow=function(){o.Spell.Missile.call(this,"LightningArrow",14),this.setRange(8),this.damageType=a.default.DMG.LIGHTNING,this.ammoName="Lightning arrow"},a.default.extend2(o.Spell.LightningArrow,o.Spell.Missile),o.Spell.EnergyArrow=function(){o.Spell.Missile.call(this,"EnergyArrow",2),this.setRange(5),this.setDice("damage",l.Dice.create("1d4 + 1")),this.damageType=a.default.DMG.ENERGY,this.ammoName="Energy arrow"},a.default.extend2(o.Spell.EnergyArrow,o.Spell.Missile),o.Spell.PoisonArrow=function(){o.Spell.Missile.call(this,"PoisonArrow",20),this.setRange(10),this.setDice("damage",l.Dice.create("1d6 + 2")),this.damageType=a.default.DMG.POISON,this.ammoName="Poison arrow"},a.default.extend2(o.Spell.PoisonArrow,o.Spell.Missile),o.Spell.PoisonArrow.prototype.cast=function(e){o.Spell.Missile.prototype.cast.call(this,e),e.src.get("SpellMissile").onHit=this.onHit.bind(this)},o.Spell.PoisonArrow.prototype.onHit=function(e){const t=this._caster;v(e,t)},o.Spell.ArrowOfWebs=function(){o.Spell.Missile.call(this,"ArrowOfWebs",10),this.setRange(7),this.setDice("damage",l.Dice.create("1d6 + 2")),this.damageType=a.default.DMG.PIERCE,this.ammoName="Arrow of webs"},a.default.extend2(o.Spell.ArrowOfWebs,o.Spell.Missile),o.Spell.ArrowOfWebs.prototype.cast=function(e){o.Spell.Missile.prototype.cast.call(this,e),e.src.get("SpellMissile").onHit=this.onHit.bind(this)},o.Spell.ArrowOfWebs.prototype.onHit=function(e){const t=this._caster,n={target:{target:e.getCell()},targetType:["cell"],elementName:"Web",effectType:"AddElement",numAllowed:1},s=new i.Effects(n);t.add(s)},o.Spell.RockStorm=function(){o.Spell.Missile.call(this,"RockStorm",35),this.setRange(4),this.setDice("damage",l.Dice.create("5d4 + 1")),this.damageType=a.default.DMG.MELEE,this.ammoName="Huge rock",this.cast=function(e){const[t,n]=[e.src.getX(),e.src.getY()];Object.values(a.default.DIR).forEach(s=>{const r=t+this.getRange()*s[0],a=n+this.getRange()*s[1],o={from:[t,n],spell:this,src:e.src,to:[r,a]};o.damageType=this.damageType,o.damage=this.getDamage(),o.destroyItem=!1;const l=new i.SpellMissile;l.setArgs(o),e.src.add(l)})},this.getSelectionObject=function(e){return o.Spell.getSelectionObjectSelf(this,e)}},a.default.extend2(o.Spell.RockStorm,o.Spell.Missile),o.Spell.MindControl=function(){o.SpellBase.call(this,"MindControl",25),this._dice.duration=l.Dice.create("1d6 + 3"),this.cast=function(e){const t=f(this,e),n=this.getDuration(),s=new i.MindControl;s.setSource(e.src),t.addComp={comp:s,duration:n};const r=new i.SpellCell;r.setArgs(t),e.src.add(r)},this.getSelectionObject=function(e){return o.Spell.getSelectionObjectDir(this,e,"Select an actor to control:")},this.aiShouldCastSpell=((e,t)=>m(e,t))},a.default.extend2(o.Spell.MindControl,o.SpellBase),o.Spell.Blizzard=function(){o.Spell.AreaBase.call(this,"Blizzard",35),this.setDice("damage",l.Dice.create("5d5 + 5")),this.damageType=a.default.DMG.ICE,this.setRange(6)},a.default.extend2(o.Spell.Blizzard,o.Spell.AreaBase),o.Spell.Blizzard.prototype.onHit=function(e){e.add(new i.Coldness)},o.Spell.EnergyStorm=function(){o.Spell.AreaBase.call(this,"EnergyStorm",20),this.setDice("damage",l.Dice.create("3d4 + 3")),this.damageType=a.default.DMG.ENERGY},a.default.extend2(o.Spell.EnergyStorm,o.Spell.AreaBase),o.Spell.Heal=function(){o.SpellBase.call(this,"Heal",6),this._dice.healing=l.Dice.create("2d4"),this.cast=function(e){const t=f(this,e);t.targetComp="Health",t.set="addHP",t.value=this._dice.healing.roll();const n=new i.SpellCell;n.setArgs(t),e.src.add(n)},this.getSelectionObject=function(e){return o.Spell.getSelectionObjectDir(this,e,"Select a direction for healing:")},this.aiShouldCastSpell=((e,t)=>g(e,t))},a.default.extend2(o.Spell.Heal,o.SpellBase),o.Spell.RingOfFire=function(){o.Spell.RingBase.call(this,"RingOfFire",10),this._dice.duration=l.Dice.create("10d10"),this._range=2,this._createdActor="Fire"},a.default.extend2(o.Spell.RingOfFire,o.Spell.RingBase),o.Spell.RingOfFrost=function(){o.Spell.RingBase.call(this,"RingOfFrost",10),this._dice.duration=l.Dice.create("10d10"),this._range=2,this._createdActor="Ice flame"},a.default.extend2(o.Spell.RingOfFrost,o.Spell.RingBase),o.Spell.RingOfEnergy=function(){o.Spell.RingBase.call(this,"RingOfEnergy",10),this._dice.duration=l.Dice.create("10d10"),this._range=3,this._createdActor="Forcefield"},a.default.extend2(o.Spell.RingOfEnergy,o.Spell.RingBase),o.Spell.PoisonCloud=function(){o.Spell.RingBase.call(this,"PoisonCloud",15),this._dice.duration=l.Dice.create("10d10"),this._range=1,this._createdActor="Poison gas"},a.default.extend2(o.Spell.PoisonCloud,o.Spell.RingBase),o.Spell.ForceField=function(){o.SpellBase.call(this,"ForceField",5),this._dice.duration=l.Dice.create("10d10"),this.cast=function(e){const t=f(this,e);t.callback=this.castCallback.bind(this,e);const n=new i.SpellSelf;n.setArgs(t),e.src.add(n)},this.getSelectionObject=function(e){return o.Spell.getSelectionObjectDir(this,e,"Select a direction for the forcefield:")},this.castCallback=(e=>{const t=c.ObjectShell.getParser(),n=this._caster.getLevel(),{dir:s}=e,[r,a]=this._caster.getXY(),[o,l]=[r+s[0],a+s[1]];this.getThreeCells(n.getMap(),s,o,l).forEach(e=>{if(e.isPassable()||!e.hasActors()){const s=t.createActor("Forcefield");n.addActor(s,e.getX(),e.getY());const r=new i.Fading,a=this.getDuration();r.setDuration(a),s.add(r)}})}),this.getThreeCells=function(e,t,n,s){return 0===t[0]?[e.getCell(n-1,s),e.getCell(n,s),e.getCell(n+1,s)]:0===t[1]?[e.getCell(n,s-1),e.getCell(n,s),e.getCell(n,s+1)]:-1===t[0]?[e.getCell(n+1,s),e.getCell(n,s),e.getCell(n,s-t[1])]:[e.getCell(n-1,s),e.getCell(n,s),e.getCell(n,s-t[1])]}},a.default.extend2(o.Spell.ForceField,o.SpellBase);o.Spell.IcyTouch=class extends o.Spell.MultiSpell{constructor(){super("IcyTouch",5),this._spells.push(new o.Spell.GraspOfWinter),this._spells.push(new o.Spell.RingOfFrost)}getSelectionObject(e){return o.Spell.getSelectionObjectDir(this,e,"Select a direction for touching:")}},o.Spell.addAllSpells=(e=>{e.addSpell(new o.Spell.AnimateDead),e.addSpell(new o.Spell.ArrowOfWebs),e.addSpell(new o.Spell.Blizzard),e.addSpell(new o.Spell.Charm),e.addSpell(new o.Spell.CrossBolt),e.addSpell(new o.Spell.DispelMagic),e.addSpell(new o.Spell.EnergyArrow),e.addSpell(new o.Spell.Flying),e.addSpell(new o.Spell.ForceField),e.addSpell(new o.Spell.FrostBolt),e.addSpell(new o.Spell.GraspOfWinter),e.addSpell(new o.Spell.Heal),e.addSpell(new o.Spell.IceArrow),e.addSpell(new o.Spell.IceShield),e.addSpell(new o.Spell.IcyPrison),e.addSpell(new o.Spell.IcyTouch),e.addSpell(new o.Spell.LightningArrow),e.addSpell(new o.Spell.LightningBolt),e.addSpell(new o.Spell.MagicArmor),e.addSpell(new o.Spell.MindControl),e.addSpell(new o.Spell.Paralysis),e.addSpell(new o.Spell.PoisonArrow),e.addSpell(new o.Spell.PoisonBreath),e.addSpell(new o.Spell.PoisonCloud),e.addSpell(new o.Spell.PowerDrain),e.addSpell(new o.Spell.RingOfEnergy),e.addSpell(new o.Spell.RingOfFire),e.addSpell(new o.Spell.RingOfFrost),e.addSpell(new o.Spell.RockStorm),e.addSpell(new o.Spell.SlimeBolt),e.addSpell(new o.Spell.SpiritForm),e.addSpell(new o.Spell.SummonAirElemental),e.addSpell(new o.Spell.SummonAnimal),e.addSpell(new o.Spell.SummonDead),e.addSpell(new o.Spell.SummonFlyingEyes),e.addSpell(new o.Spell.SummonIceMinion),e.addSpell(new o.Spell.SummonKin),e.addSpell(new o.Spell.SummonUndeadUnicorns),e.addSpell(new o.Spell.Telepathy)})},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=r(n(106)),i=n(65),l=n(44),c=r(n(25)),u=n(9).Random.getRNG(),h={};class d extends i.BrainSentient{constructor(e){super(e),this.setType("GoalOriented"),this.goal=new o.ThinkBasic(e)}getGoal(){return this.goal}setGoal(e){this.goal=e}decideNextAction(){return this._cache.seen=null,this.goal.process(),this._cache.seen=null,i.ACTION_ALREADY_DONE}toJSON(){const e=super.toJSON();return e.goal=this.goal.toJSON(),e}}t.BrainGoalOriented=d,h.GoalOriented=d;class p extends d{constructor(e){super(e),this.setType("SpellCaster"),this.goal=new o.ThinkSpellcaster(e),this.goal.setBias({CastSpell:2,AttackActor:.7}),this.goal.getEvaluator("CastSpell").setCastingProbability(.8)}}t.BrainSpellCaster=p,h.SpellCaster=p;class f extends d{constructor(e){super(e),this.setType("Explorer"),this.goal.removeEvaluators(),this.goal.addEvaluator(new l.Evaluator.Explore)}}t.BrainExplorer=f,h.Explorer=f;class m extends d{constructor(e){super(e),this.setType("Spirit"),this.goal.removeEvaluators(),this.goal.addEvaluator(new l.Evaluator.Explore)}}t.BrainSpirit=m,h.Spirit=m;class g extends d{constructor(e){super(e),this.setType("Thief"),this.goal.addEvaluator(new l.Evaluator.Thief(1.2)),this.goal.setBias({Thief:1.2,AttackActor:.7})}}t.BrainThief=g,h.Thief=g;class y extends d{constructor(e){super(e),this.setType("Animal"),this.goal=new o.ThinkBasic(e),this._memory.addEnemyType("player"),this._memory.addEnemyType("human"),this.getGoal=(()=>this.goal),this.setGoal=(e=>{this.goal=e})}decideNextAction(){return this._cache.seen=null,this.goal.process(),this._cache.seen=null,i.ACTION_ALREADY_DONE}}t.BrainAnimal=y,h.Animal=y;class v extends d{constructor(e){super(e),this.setType("Commander"),this.goal=new o.ThinkCommander(e)}decideNextAction(){return this._cache.seen=null,this.goal.process(),this._cache.seen=null,i.ACTION_ALREADY_DONE}}t.BrainCommander=v,h.Commander=v;class _ extends i.BrainSentient{constructor(e){super(e),this.setType("Flame")}decideNextAction(){return this._actor.getCell().getActors().forEach(e=>{const t=this.getActor().get("Damaging");if(t){const n=new c.Flame;n.setSource(this._actor),n.setDamageType(t.getDamageType()),e.add(n)}}),i.ACTION_ALREADY_DONE}}t.BrainFlame=_,h.Flame=_;class b extends _{constructor(e){super(e),this.setType("Cloud"),this.chanceToMove=.2}decideNextAction(){if(u.getUniform()<=this.chanceToMove){const e=u.getRandDir(),[t,n]=a.default.newXYFromDir(e,this._actor),s=this._actor.getLevel();if(s.getMap().hasXY(t,n)){const e=new c.Movement(t,n,s);this._actor.add(e)}}return super.decideNextAction.call(this)}}t.BrainCloud=b,h.Cloud=b;class E extends d{constructor(e){super(e),this.setType("MindControl"),this.goal=new o.ThinkBasic(e),this.getGoal=(()=>this.goal),this.setGoal=(e=>{this.goal=e})}decideNextAction(){return i.ACTION_ALREADY_DONE}}t.BrainMindControl=E,h.MindControl=E},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(131)),a=n(40),o=a.Component.UniqueDataComponent;t.Abilities=o("Abilities",{}),t.Abilities.prototype._init=function(){this.addCallback("onAdd",()=>{const e=new r.Abilities(this.getEntity());Array.isArray(this.abilities)&&this.abilities.forEach(t=>{const n=new r[t];e.addAbility(n)}),this.abilities=e,this.removeCallbacks("onAdd")})},t.Abilities.prototype.setAbilities=function(e){this.abilities=e},t.Abilities.prototype.createMenu=function(){return this.abilities.getMenu()},t.Abilities.prototype.addAbility=function(e){this.abilities.addAbility(e)},t.Abilities.prototype.toJSON=function(){const e=a.ComponentBase.prototype.toJSON.call(this);return e.setAbilities=this.abilities.toJSON(),e}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1));class a extends r.Component{shouldComponentUpdate(e){return e.message.length>0}render(){const e=this.props.message,t=a.styleToClassName,n=this.props.visibleCells,s=this.props.showAll;let o=[r.createElement("span",null,"Saving the game...")];return this.props.saveInProgress||(o=e.map((e,a)=>{let o=t[e.style];o||(o=e.style);let i=1;s?e.seen=!0:e.hasOwnProperty("seen")||e.hasOwnProperty("cell")&&(i=n.indexOf(e.cell))>=0&&(e.seen=!0);const l=1===e.count?"":` (x${e.count})`;let c=`${e.msg}${l}`;return c.match(/.$/)||(c+="."),c+=". ",i>=0||e.seen?r.createElement("span",{className:o,key:a},c):null})),r.createElement("div",{className:"game-messages"},o)}}t.default=a,a.styleToClassName={prim:"text-primary",info:"text-info",descr:"text-muted",warn:"text-warning",danger:"text-danger",success:"text-success"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return[].slice.call(e.querySelectorAll("*"),0).filter(o)};
/*!
 * Adapted from jQuery UI core
 *
 * http://jqueryui.com
 *
 * Copyright 2014 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/category/ui-core/
 */
var s=/input|select|textarea|button|object/;function r(e){var t=e.offsetWidth<=0&&e.offsetHeight<=0;if(t&&!e.innerHTML)return!0;var n=window.getComputedStyle(e);return t?"visible"!==n.getPropertyValue("overflow"):"none"==n.getPropertyValue("display")}function a(e,t){var n=e.nodeName.toLowerCase();return(s.test(n)&&!e.disabled||"a"===n&&e.href||t)&&function(e){for(var t=e;t&&t!==document.body;){if(r(t))return!1;t=t.parentNode}return!0}(e)}function o(e){var t=e.getAttribute("tabindex");null===t&&(t=void 0);var n=isNaN(t);return(n||t>=0)&&a(e,!n)}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.assertNodeList=l,t.setElement=function(e){var t=e;if("string"==typeof t&&o.canUseDOM){var n=document.querySelectorAll(t);l(n,t),t="length"in n?n[0]:n}return i=t||i},t.validateElement=c,t.hide=function(e){c(e)&&(e||i).setAttribute("aria-hidden","true")},t.show=function(e){c(e)&&(e||i).removeAttribute("aria-hidden")},t.documentNotReadyOrSSRTesting=function(){i=null},t.resetForTesting=function(){i=null};var s,r=n(24),a=(s=r)&&s.__esModule?s:{default:s},o=n(134);var i=null;function l(e,t){if(!e||!e.length)throw new Error("react-modal: No elements were found for selector "+t+".")}function c(e){return!(!e&&!i)||((0,a.default)(!1,["react-modal: App element is not defined.","Please use `Modal.setAppElement(el)` or set `appElement={el}`.","This is needed so screen readers don't see main content","when modal is opened. It is not recommended, but you can opt-out","by setting `ariaHideApp={false}`."].join(" ")),!1)}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(23));t.BSP={};const a={discardByRatio:!0,hRatio:.35,wRatio:.35,vertSplit:.5,minSplitW:8,minSplitH:8,discardBySize:!0,minRoomW:3,minRoomH:2};class o{constructor(e){this.leaf=e,this.lchild=null,this.rchild=null}getLeafs(){return null===this.lchild&&null===this.rchild?[this.leaf]:[].concat(this.lchild.getLeafs(),this.rchild.getLeafs())}getLevel(e,t){return t||(t=[]),1===e?t.push(this):(null!==this.lchild&&this.lchild.getLevel(e-1,t),null!==this.rchild&&this.rchild.getLevel(e-1,t)),t}}t.Tree=o,t.BSP.Tree=o;const i=function(e,t){this.x=e,this.y=t},l=function(e,t,n,s){this.x=e,this.y=t,this.w=n,this.h=s,this.center=new i(this.x+Math.floor(this.w/2),this.y+Math.floor(this.h/2))};t.BSP.Container=l;class c{constructor(e){return this.x=e.x+c.rng.getUniformInt(1,Math.floor(e.w/3)),this.y=e.y+c.rng.getUniformInt(1,Math.floor(e.h/3)),this.w=e.w-(this.x-e.x)-1,this.h=e.h-(this.y-e.y)-1,this.w-=c.rng.getUniformInt(0,this.w/3),this.h-=c.rng.getUniformInt(0,this.h/3),this.w<a.minRoomW&&(this.w=a.minRoomW),this.h<a.minRoomH&&(this.h=a.minRoomH),this}getCoord(){const e=[],t=this.x,n=t+(this.w-1),s=this.y,r=s+(this.h-1);for(let a=t;a<=n;a++)for(let t=s;t<=r;t++)e.push([a,t]);return e}getOuterBorder(){const[e,t]=[this.x-1,this.y-1],[n,s]=[this.x+this.w+1,this.y+this.h+1];return u(e,t,n,s)}getInnerBorder(){const[e,t]=[this.x,this.y],[n,s]=[this.x+this.w-1,this.y+this.h-1];return u(e,t,n,s)}}function u(e,t,n,s){const r=[];for(let a=e;a<=n;a++)for(let o=t;o<=s;o++)o!==t&&o!==s&&a!==e&&a!==n||r.push([a,o]);return r}t.Room=c,c.rng=r.default.RNG,t.BSP.Room=c;class h{constructor(e={}){this._opts=a,Object.keys(e).forEach(t=>{this._opts.hasOwnProperty(t)&&(this._opts[t]=e)}),this.rng=this._opts.rng||r.default.RNG}createPath(e,t){const n=[],s=e.center,r=t.center;if(s.x===r.x){const e=s.y>r.y?r.y:s.y,t=s.y<r.y?r.y:s.y;for(let r=e;r<=t;r++)n.push([s.x,r])}else{const e=s.x>r.x?r.x:s.x,t=s.x<r.x?r.x:s.x;for(let r=e;r<=t;r++)n.push([r,s.y])}return n}splitContainer(e,t){const n=new o(e);if(this.isLargeEnough(e)&&0!==t){const s=this.randomSplit(e);n.lchild=this.splitContainer(s[0],t-1),n.rchild=this.splitContainer(s[1],t-1)}return n}isLargeEnough(e){return!this._opts.discardBySize||e.w>=this._opts.minSplitW&&e.h>=this._opts.minSplitH}randomSplit(e){let t,n;if(this.rng.getUniform()<=this._opts.vertSplit){if(t=new l(e.x,e.y,this.rng.getUniformInt(1,e.w),e.h),n=new l(e.x+t.w,e.y,e.w-t.w,e.h),this._opts.discardByRatio&&this.isVRatioTooSmall(t,n))return this.randomSplit(e)}else if(t=new l(e.x,e.y,e.w,this.rng.getUniformInt(1,e.h)),n=new l(e.x,e.y+t.h,e.w,e.h-t.h),this._opts.discardByRatio&&this.isHRatioTooSmall(t,n))return this.randomSplit(e);return[t,n]}isVRatioTooSmall(e,t){const n=e.w/e.h,s=t.w/t.h;return n<this._opts.wRatio||s<this._opts.wRatio}isHRatioTooSmall(e,t){const n=e.h/e.w,s=t.h/t.w;return n<this._opts.hRatio||s<this._opts.hRatio}createWithRooms(e,t,n=5){const s=new l(0,0,e,t),r=this.splitContainer(s,n),a=r.getLeafs(),o=[];return a.forEach(e=>{o.push(new c(e))}),this.generated={tree:r,rooms:o},[r,o]}createWithRoomsAndPaths(e,t,n=5){const s=new l(0,0,e,t),r=this.splitContainer(s,n),a=r.getLeafs(),o=[];a.forEach(e=>{o.push(new c(e))});const i=[];return this.createPaths(r,i),this.generated={tree:r,rooms:o,paths:i},[r,o,i]}createPaths(e,t){if(null===e.lchild||null===e.rchild)return[];const n=this.createPath(e.lchild.leaf,e.rchild.leaf);return n.length>0&&t.push(n),this.createPaths(e.lchild,t),this.createPaths(e.rchild,t),t}get(e){return this.generated.hasOwnProperty(e)?this.generated[e]:null}}t.BSPGen=h,t.BSP.BSPGen=h},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(9),o=n(67),i=n(193);n(83);const l=n(17)("bitn:TemplateLevel"),c=i.Crypt.tiles.filler,u=a.Random.getRNG(),h=()=>{},d=20;t.TemplateLevel=class{constructor(e,t){this.tilesX=e,this.tilesY=t,this.genParams=[1,1,1,1],this.roomCount=40,this.callbacks={afterInit:h},this.filler=o.Template.createTemplate(c),this.templates=[],this.tryToMatchAllExits=!0,this.missingExitIsError=!1,this._ind=0,this._unusedExits=[],this._freeExits={},this._possibleDirections=["N","S","E","W"],this._sortedByExit={N:[],S:[],E:[],W:[]},this._sortedWithAllExits={}}setFiller(e){"string"==typeof e?(this.filler=o.Template.createTemplate(e),this.filler.setProp("name","FILLER")):(this.filler=e.clone(),this.filler.setProp("name","FILLER"))}setTemplates(e){this.templates=[],"string"==typeof e[0]?this.templates=e.map(e=>o.Template.createTemplate(e)):this.templates=e}addTemplate(e){"string"==typeof e?this.templates.push(o.Template.createTemplate(e)):e instanceof o.Template.ElemTemplate&&this.templates.push(e)}setGenParams(e){this.genParams=e}setRoomCount(e){this.roomCount=e}setConstraintFunc(e){this.constraintFunc=e.bind(this)}setStartRoomFunc(e){this.startRoomFunc=e.bind(this)}addCallback(e,t){this.callbacks.hasOwnProperty(e)?"function"==typeof t?this.callbacks[e]=t:r.default.err("TemplateLevel","setCallback",`Tried setting non-function as cb: ${t}`):r.default.err("TemplateLevel","setCallback",`No callback for ${e}`)}use(e){["constraintFunc","startRoomFunc","roomCount","genParams"].forEach(t=>{e.hasOwnProperty(t)&&this["set"+t.capitalize()](e[t])}),e.tiles&&e.tiles.filler&&this.setFiller(e.tiles.filler),e.Models&&e.Models.default&&this.setTemplates(e.Models.default)}create(){0===this.templates.length&&r.default.err("TemplateLevel","create","No templates set. Use setTemplates() before create()"),this._sortDataIntoListsByLocation(),this._initMapWithFillerCells();let e=!0,t=10;for(;e;){++this._ind,this.dbg(`Dungeon not ready. Tries left  ${t}/10`),this._placeStartRoom();let n=0;const s=this.roomCount;let a=0,o=!0;for(;a<1e3&&o;){const t=this._getRoomWithUnusedExits();if(null===t){o=!1;break}const{x:i,y:l}=t;this.dbg(`Current room in ${i},${l}`);const c=this._getFreeExits(t);this.dbg(`It has free exits: ${c}`);const h=u.arrayGetRand(c);this.dbg(`Chose exit: ${h} for next room`);const d=this.getMatchingExit(h),p=this._getNewX(i,d),f=this._getNewY(l,d);if(p===i&&f===l){let e=`Illegal ${i},${l} -> ${p},${f}`;e+=` Exits: Chosen ${h} -> ${d}`,r.default.err("TemplateLevel","create",e)}const m=this._getNextTemplate(p,f,d);if(this._isRoomLegal(p,f)&&(this._placeRoom(i,l,h,p,f,d,m),++n,this.dbg("Room count incremented to "+n)),++a,-1!==s&&n>=s){e=!1;break}}if(n>=s||-1===s)e=!1;else{if(0==--t){r.default.warn("Level.Template","create","Max tries reached. No valid level created");break}this._cleanupAndTryAgain()}--this._ind}this.expandTemplates()}_sortDataIntoListsByLocation(){const e=this._possibleDirections.map(e=>new RegExp(e));this.templates.forEach(t=>{const n=t.getProp("dir");if(n){this._possibleDirections.forEach((s,r)=>{e[r].test(n)&&this._sortedByExit[s].push(t)});const s=n.split("").sort().join("");this._sortedWithAllExits[s]||(this._sortedWithAllExits[s]=[]),this._sortedWithAllExits[s].push(t)}})}expandTemplates(){this.genParamsX=[],this.genParamsY=[];for(let e=0;e<this.tilesX;e++)if(this.genParams.x)this.genParamsX.push(this.genParams.x);else{const e=[this.genParams[0],this.genParams[1]];this.genParamsX.push(e)}for(let e=0;e<this.tilesY;e++)if(this.genParams.y)this.genParamsY.push(this.genParams.y);else{const e=[this.genParams[2],this.genParams[3]];this.genParamsY.push(e)}this.mapExpanded=[];for(let e=0;e<this.tilesX;e++){this.mapExpanded[e]=[];for(let t=0;t<this.tilesY;t++){const n=this.genParamsX[e].concat(this.genParamsY[t]);this.mapExpanded[e][t]=this.templMap[e][t].getChars(n)}}this.map=[],this.placedTileData={};let e=0,t=0;for(let n=0;n<this.tilesX;n++){const s=this.mapExpanded[n][0].length;t=e+s-1;for(let r=0;r<s;r++){let s=0,a=0,o=[];for(let i=0;i<this.tilesY;i++){const l=this.mapExpanded[n][i][r],c=l.length;s=a+c-1,o=o.concat(l),this.placedTileData[n+","+i]={name:this.templMap[n][i].getProp("name"),type:this.templMap[n][i].getProp("type"),llx:e,urx:t,ury:a,lly:s,tileX:n,tileY:i},a+=c}this.map.push(o)}e+=s}}getPlacedData(){return this.placedTileData}getMap(){return this.map||r.default.warn("TemplateLevel","getMap","Not not generated. Call create() first"),this.map}findTemplate(e){const t=[];return Object.keys(e).forEach(n=>{this.templates.forEach(s=>{s.getProp(n)===e[n]&&t.push(s)})}),t.length>0?u.arrayGetRand(t):null}removeTemplate(e){const t=Object.keys(e)[0],n=this.templates.findIndex(n=>n.getProp(t)===e[t]);n>=0&&this.templates.splice(n,1)}addRoom(e,t,n){const s={x:t,y:n,room:e};this._addRoomData(s),this._removeExitsOfAbuttingRooms(s),this._removeBorderExits(s),this.templMap[t][n]=e}_getNextTemplate(e,t,n){++this._ind;let s=null;if("function"==typeof this.constraintFunc&&(s=this.constraintFunc(e,t,n)),!s&&this.tryToMatchAllExits){this.dbg(`Compute required exits for ${e},${t}`);const n=this.getAllRequiredExits(e,t),s=this._getMatchWithExits(n);if(s.length>0)return this._getRandTemplate(s);let a=`x,y: ${e},${t}`;if(a+=`Required: ${n[1]}, Excl: ${n[2]}`,r.default.warn("TemplateLevel","_getNextTemplate",`Not all exits match. ${a}`),this.missingExitIsError){this.expandTemplates(),r.default.printMap(this.map);const s=`${e},${t} exitReqd: ${JSON.stringify(n)}`;throw new Error(s)}}if(!s){const e=this._sortedByExit[n];return u.arrayGetRand(e)}return--this._ind,s}_getRandTemplate(e){if(!this.weights)return u.arrayGetRand(e);const t={},n=e.map(e=>e.getProp("name")),s={};n.forEach((e,n)=>{s[e]=n,this.weights.hasOwnProperty(e)?t[e]=this.weights[e]:t[e]=1});const r=u.getWeighted(t);return e[s[r]]}_getRoomWithUnusedExits(){return this._unusedExits.length>0?u.arrayGetRand(this._unusedExits):null}_getFreeExits(e){const{x:t,y:n}=e,s=t+","+n;return this._freeExits[s]?this._freeExits[s]:(r.default.err("TemplateLevel","_getFreeExits",`No ${s}, Room: ${JSON.stringify(e)}`),null)}_removeChosenExit(e,t,n){const s=e+","+t,a=this._freeExits[s];this.dbg(JSON.stringify(this._freeExits)),this.dbg(`${e},${t} removeChosenExit ${n}`),this.dbg(`nExits: ${a.length}`);const o=a.indexOf(n);if(o>=0){if(this._freeExits[s].splice(o,1),0===this._freeExits[s].length){const n=this._unusedExits.findIndex(n=>n.x===e&&n.y===t);n>=0?(this._unusedExits.splice(n,1),delete this._freeExits[s],this.dbg(`${e},${t} has no unused exits anymore.`)):r.default.err("TemplateLevel","_removeChosenExit",`Cannot find ${e},${t} in unusedExits to remove.`)}this._freeExits[s]&&this.dbg(`_freeExits [${s}] After remove: `+JSON.stringify(this._freeExits[s]))}else{const s=JSON.stringify(this.templMap[e][t]);r.default.err("TemplateLevel","_removeChosenExit",`${e},${t} dir: ${n} not found. Templ: ${s}`)}}_isRoomLegal(e,t){return e>=0&&e<this.tilesX&&t>=0&&t<this.tilesY}_placeStartRoom(){++this._ind;let e=null;if("function"==typeof this.startRoomFunc)e=this.startRoomFunc(),["x","y","room"].forEach(t=>{if(!e.hasOwnProperty(t)){const e="room must have {x, y, room}.";r.default.err("TemplateLevel","_placeStartRoom",`Prop ${t} null/undef. ${e}.`)}});else{const t=u.getUniformInt(1,this.tilesX-2),n=u.getUniformInt(1,this.tilesY-2);e={x:t,y:n,room:this.getRandomTemplate()}}this.dbg("Start room: "+JSON.stringify(e)),this.templMap[e.x][e.y]=e.room,null!==e?(this._addRoomData(e),this._removeBorderExits(e)):r.default.err("TemplateLevel","_placeStartRoom","Starting room was null. Oh no!"),--this._ind}_placeRoom(e,t,n,s,r,a,o){this._removeChosenExit(e,t,n);const i={x:s,y:r,room:o};this._addRoomData(i),this._removeChosenExit(s,r,a),this._removeExitsOfAbuttingRooms(i),this._removeBorderExits(i),this.templMap[s][r]=o}_addRoomData(e){const t=e.room.getProp("dir");if(t){this._unusedExits.push(e);const n=t.split(""),s=e.x+","+e.y;this._freeExits[s]=n,this.dbg("Added room "+JSON.stringify(e),20)}}getMatchingExit(e){if(this.matchMap&&this.matchMap.hasOwnProperty(e))return this.matchMap[e];switch(e){case"N":return"S";case"S":return"N";case"E":return"W";case"W":return"E";default:return"N"}}_getNewX(e,t){let n=t;return this.dir2NSEWRemap&&this.dir2NSEWRemap[t]&&(n=this.dir2NSEWRemap[t]),"E"===n?e-1:"W"===n?e+1:e}_getNewY(e,t){let n=t;return this.dir2NSEWRemap&&this.dir2NSEWRemap[t]&&(n=this.dir2NSEWRemap[t]),"N"===n?e+1:"S"===n?e-1:e}getRandomTemplate(){return u.arrayGetRand(this.templates)}_removeBorderExits(e){const{x:t,y:n}=e;0===t&&(this._hasExit("W",t,n)&&this._removeChosenExit(t,n,"W"),this.nsew2DirRemap&&this._removeExitsRemapped(t,n,"W")),t===this.tilesX-1&&(this._hasExit("E",t,n)&&this._removeChosenExit(t,n,"E"),this.nsew2DirRemap&&this._removeExitsRemapped(t,n,"E")),0===n&&(this._hasExit("N",t,n)&&this._removeChosenExit(t,n,"N"),this.nsew2DirRemap&&this._removeExitsRemapped(t,n,"N")),n===this.tilesY-1&&(this._hasExit("S",t,n)&&this._removeChosenExit(t,n,"S"),this.nsew2DirRemap&&this._removeExitsRemapped(t,n,"S"))}_removeExitsRemapped(e,t,n){const s=this.nsew2DirRemap[n];this._hasExit(s,e,t)&&this._removeChosenExit(e,t,s)}_removeExitsOfAbuttingRooms(e){const{x:t,y:n}=e;if(this.dbg(`CheckAbut ${t},${n}`),t>0){const e=t-1;this._isFiller(e,n)||(this._removeExitByXY("W",t,n),this._removeExitByXY("E",e,n),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.W,t,n),this._removeExitByXY(this.nsew2DirRemap.E,e,n)))}if(t<this.tilesX-1){const e=t+1;this._isFiller(e,n)||(this._removeExitByXY("E",t,n),this._removeExitByXY("W",e,n),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.E,t,n),this._removeExitByXY(this.nsew2DirRemap.W,e,n)))}if(n>0){const e=n-1;this._isFiller(t,e)||(this._removeExitByXY("N",t,n),this._removeExitByXY("S",t,e),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.N,t,n),this._removeExitByXY(this.nsew2DirRemap.S,t,e)))}if(n<this.tilesY-1){const e=n+1;this._isFiller(t,e)||(this._removeExitByXY("S",t,n),this._removeExitByXY("N",t,e),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.S,t,n),this._removeExitByXY(this.nsew2DirRemap.N,t,e)))}}_isFiller(e,t){const n="FILLER"===this.templMap[e][t].getProp("name");return this.dbg(`isFiller x,y ${e},${t}: ${n}`),n}_removeExitByXY(e,t,n){this._hasExit(e,t,n)&&this._removeChosenExit(t,n,e)}_hasExit(e,t,n){const s=t+","+n;return!!this._freeExits[s]&&this._freeExits[s].indexOf(e)>=0}_cleanupAndTryAgain(){this._initMapWithFillerCells(),this._freeExits={},this._unusedExits=[]}_initMapWithFillerCells(){this.templMap=[];for(let e=0;e<this.tilesX;e++){this.templMap[e]=[];for(let t=0;t<this.tilesY;t++)this.templMap[e][t]=this.filler}this.callbacks.afterInit&&this.callbacks.afterInit(this)}setExitMap(e,t){this._possibleDirections=Object.keys(e),this._sortedByExit={},this._possibleDirections.forEach(e=>{this._sortedByExit[e]=[]}),this.matchMap=e,this.nsew2DirRemap=t;const n={};Object.keys(this.nsew2DirRemap).forEach(e=>{const t=this.nsew2DirRemap[e];n[t]=e}),this.dir2NSEWRemap=n}getAllRequiredExits(e,t){++this._ind;const n=[],s=[],r=[];let a=null,o=null;const i=t-1;this.nsew2DirRemap&&(a=this.nsew2DirRemap.N,o=this.matchMap[a]),i>=0?(this._isFiller(e,i)?n.push("N"):this._hasExit("S",e,i)?s.push("N"):r.push("N"),a&&(this._isFiller(e,i)?n.push(a):this._hasExit(o,e,i)?s.push(a):r.push(a))):(r.push("N"),a&&r.push(a));const l=t+1;this.nsew2DirRemap&&(a=this.nsew2DirRemap.S,o=this.matchMap[a]),l<this.tilesY?(this._isFiller(e,l)?n.push("S"):this._hasExit("N",e,l)?s.push("S"):r.push("S"),a&&(this._isFiller(e,l)?n.push(a):this._hasExit(o,e,l)?s.push(a):r.push(a))):(r.push("S"),a&&r.push(a));const c=e+1;this.nsew2DirRemap&&(a=this.nsew2DirRemap.E,o=this.matchMap[a]),c<this.tilesX?(this._isFiller(c,t)?n.push("E"):this._hasExit("W",c,t)?s.push("E"):r.push("E"),a&&(this._isFiller(c,t)?n.push(a):this._hasExit(o,c,t)?s.push(a):r.push(a))):(r.push("E"),a&&r.push(a));const u=e-1;return this.nsew2DirRemap&&(a=this.nsew2DirRemap.W,o=this.matchMap[a]),u>=0?(this._isFiller(u,t)?n.push("W"):this._hasExit("E",u,t)?s.push("W"):r.push("W"),a&&(this._isFiller(u,t)?n.push(a):this._hasExit(o,u,t)?s.push(a):r.push(a))):(r.push("W"),a&&r.push(a)),this.dbg("getAllRequired "+s),--this._ind,[n,s,r]}_getMatchWithExits(e){const[t,n,s]=e;this.dbg(`GOT: any:${t}, req:${n}, excl:${s}`);let r=Object.keys(this._sortedWithAllExits);s.forEach(e=>{r=r.filter(t=>!new RegExp(e).test(t))});let a=r.map(e=>e.split(""));a=a.filter(e=>this._arrayContainsArray(e,n)),r=a.map(e=>e.join(""));let o=[];return r.forEach(e=>{o=o.concat(this._sortedWithAllExits[e])}),o}_arrayContainsArray(e,t){return t.every(t=>e.indexOf(t)>=0)}dbg(e,t=10){if(l.enabled&&d>=t){const t=" ".repeat(this._ind);console.log(t+e)}}printTile(e,t){if(4===e&&3===t){const n=this.templMap[e][t];console.log(`Tile @{x},${t}`),console.log(`Has exits: ${n.getDir()}`),console.log(JSON.stringify(n,null,2))}}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(67),r=n(9).Random.getRNG();t.Crypt={Models:{default:[]},templates:{all:[]}},t.Crypt.tiles={},t.Crypt.tiles.filler="\nname:FILLER\nX=#\nY=#\n\n#X###X#\nY######\n#######\n#######\n#######\nY######\n#######",t.Crypt.tiles.start=["\ndir:NSEW\nname:start_nsew\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n+.###.+\n#.#.#.#\nY.....#\n###+###","\ndir:SEW\nname:start_sew\nX=#\nY=#\n\n#X###X#\nY.....#\n#.#.#.#\n+.###.+\n#.#.#.#\nY.....#\n###+###","\ndir:NEW\nname:start_new\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n+.###.+\n#.#.#.#\nY.....#\n#######","\ndir:NSE\nname:start_nse\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n#..#..+\n#.#.#.#\nY.....#\n###+###","\ndir:NSW\nname:start_nsw\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n+..#..#\n#.#.#.#\nY.....#\n###+###"],t.Crypt.tiles.omni=["\ndir:NSEW\nname:omni\nX=#\nY=#\n\n#X#.#X#\nY.....#\n#.....#\n...#...\n#.....#\nY.....#\n###.###","\ndir:NSEW\nname:omni\nX=#\nY=#\n\n#X#.#X#\nY.....#\n#.#.#.#\n...#...\n#.#.#.#\nY.....#\n###.###","\ndir:NSEW\nname:omni\nX=#\nY=#\n\n#.X.X.#\nY.....#\n#..#..#\n..###..\n#..#..#\nY.....#\n###.###","\nname:omni\ndir:NSEW\nX=#\nY=#\n\n#X...X#\n.......\nY..#..#\n..###..\nY..#..#\n.......\n##...##","\nname:omni\ndir:NSEW\nX=.\nY=.\n\n..X.X..\n.##.##.\nY#...#.\n...#...\nY#...#.\n.##.##.\n.......","\nname:omni\ndir:NSEW\nX=.\nY=.\n\n#.X.X.#\n###.###\nY#...#.\n...#...\nY#...#.\n###.###\n#.....#","\nname:omni\ndir:NSEW\nX=.\nY=.\n\n..X.X..\n.##.##.\nY##.##.\n.......\nY##.##.\n.##.##.\n.......","\ndir:NSEW\nname:omni\nX=.\nY=.\n\n..X.X..\n.##.##.\nY#...#.\n.#...#.\nY#...#.\n.##.##.\n......."],t.Crypt.tiles.term=["\ndir:N\nname:term\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.#.#.#\n###.###\nY.....#\n#.....#\n#######","\ndir:N\nname:term\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.#.#.#\n###.###\nY##.###\n##...##\n#######","\ndir:S\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY.#.#.#\n###.###\nY.#.#.#\n#.....#\n##...##","\ndir:S\nname:term\nX=#\nY=#\n\n#X###X#\n#######\nY######\n###.###\nY.....#\n#.....#\n##...##","\ndir:W\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY.#.#.#\n...####\nY.#.#.#\n#.....#\n#######","\ndir:W\nname:term\nX=#\nY=#\n\n#X###X#\n#.#...#\nY.#.###\n..#...#\nY.###.#\n#.....#\n#######","\ndir:E\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY..#..#\n#..#...\nY.###.#\n#.....#\n#######","\ndir:E\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY...###\n#...#..\nY.###.#\n#.....#\n#######"],t.Crypt.tiles.corridor=["\ndir:NS\nname:corridor\nX=#\nY=#\n\n#X...X#\n##...##\nY#...##\n##...##\nY#...##\n##...##\n##...##","\ndir:NS\nname:corridor\nX=#\nY=#\n\n#X...X#\n#.....#\nY#...##\n#.....#\nY#...##\n#.....#\n##...##","\ndir:EW\nname:corridor\nX=#\nY=#\n\n#X###X#\n#######\nY......\n.......\nY......\n#######\n#######","\ndir:EW\nname:corridor\nX=#\nY=#\n\n#X###X#\n#.#.#.#\nY.....#\n.......\nY.....#\n#.#.#.#\n#######"],t.Crypt.tiles.corner=["\ndir:NW\nname:corner\nX=#\nY=#\n\n#X...X#\n###.###\nY....##\n.....##\nY....##\n#######\n#######","\ndir:NW\nname:corner\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.....#\n......#\nY.###.#\n#.....#\n#######","\ndir:NE\nname:corner\nX=.\nY=#\n\n#X...X#\n###.###\nY#...#.\n##.....\nY#...#.\n#######\n#######","\ndir:NE\nname:corner\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.###.#\n#......\nY.....#\n#.....#\n#######","\ndir:SE\nname:corner\nX=#\nY=#\n\n#X###X#\n###.###\nY#...#.\n##.....\nY#...#.\n###.###\n###.###","\ndir:SE\nname:corner\nX=#\nY=#\n\n#X###X#\n#.#.#.#\nY#...##\n#......\nY#...##\n#.#.#.#\n###.###","\ndir:SW\nname:corner\nX=#\nY=.\n\n#X###X#\n###.###\nY#...##\n......#\nY#...##\n###.###\n###.###"],t.Crypt.tiles.misc=["\ndir:SEW\nname:threeway\nX=#\nY=.\n\n#X###X#\n###.###\nY#...#.\n.......\nY#...#.\n###.###\n###.###","\ndir:SEW\nname:threeway\nX=#\nY=#\n\n#X###X#\n#.....#\nY.#.#.#\n..#.#..\nY##.###\n#.....#\n#.....#","\ndir:NEW\nname:threeway\nX=#\nY=.\n\n#X...X#\n###.###\nY#...#.\n.......\nY#...#.\n#######\n#######","\ndir:NSW\nname:threeway\nX=#\nY=#\n\n#X...X#\n###.###\nY#...##\n......#\nY#...##\n###.###\n###.###","\ndir:NSE\nname:threeway\nX=#\nY=#\n\n#X...X#\n###.###\nY#...##\n##.....\nY#...##\n###.###\n###.###"],t.Crypt.templates.start=t.Crypt.tiles.start.map(e=>s.Template.createTemplate(e)),t.Crypt.startRoomFunc=function(){const e=r.arrayGetRand(t.Crypt.templates.start);let n=r.getUniformInt(0,this.tilesX-1),s=r.getUniformInt(0,this.tilesY-1);switch(e.getProp("name")){case"start_nsew":n=Math.floor(this.tilesX/2),s=Math.floor(this.tilesY/2);break;case"start_sew":s=0,0===n&&(n+=1),n===this.tilesX-1&&(n-=1);break;case"start_new":s=this.tilesY-1,0===n&&(n+=1),n===this.tilesX-1&&(n-=1);break;case"start_nse":n=0,0===s&&(s+=1),s===this.tilesY-1&&(s-=1);break;case"start_nsw":n=this.tilesX-1,0===s&&(s+=1),s===this.tilesY-1&&(s-=1)}return{x:n,y:s,room:e}},t.Crypt.Models.default=[].concat(t.Crypt.tiles.corner).concat(t.Crypt.tiles.corridor).concat(t.Crypt.tiles.omni).concat(t.Crypt.tiles.term).concat(t.Crypt.tiles.misc),t.Crypt.templates.all=t.Crypt.Models.default.map(e=>s.Template.createTemplate(e));const a=s.Template.transformList(t.Crypt.templates.all);t.Crypt.templates.all=t.Crypt.templates.all.concat(a)},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(67);t.Vault={},t.Vault.tiles={},t.Vault.tiles.vault=["\nname:vault_small_s\nX=#\nY=#\n\n#X###X#\n#..?..#\nY.....#\n#.....#\n#.....#\nY.....#\n###.###","\nname:vault_small_n\nX=#\nY=#\n\n#X#.#X#\nY.....#\n#.....#\n#.....#\nY.....#\n#..?..#\n#######","\nname:vault_small_e\nX=#\nY=#\n\n##X##X#\nY.....#\n#.....#\n#?.....\n#.....#\nY.....#\n#######","\nname:vault_small_w\nX=#\nY=#\n\n#X##X##\nY.....#\n#.....#\n.....?#\n#.....#\nY.....#\n#######","\nname:vault_medium_s\nX=#\nY=#\n\n#X...X#\nY.....#\n#.....#\n#.....#\n#.....#\nY.....#\n###.###","\nname:vault_medium_n\nX=#\nY=#\n\n#X###X#\n#..?..#\nY.....#\n#.....#\n#.....#\nY..#..#\n##...##"],t.Vault.tiles.corner=["\nname:vault_nw_corner\nX=#\nY=#\n\n#X###X#\nY......\n#......\n#......\n#......\nY......\n#......","\nname:vault_ne_corner\nX=#\nY=.\n\n#X###X#\nY.....#\n......#\n......#\n......#\nY.....#\n......#","\nname:vault_sw_corner\nX=.\nY=#\n\n#X...X.\nY......\n#......\n#......\n#......\nY......\n###.###","\nname:vault_se_corner\nX=.\nY=.\n\n.X...X#\nY.....#\n......#\n......#\n......#\nY.....#\n#######"],t.Vault.tiles.wall=["\nname:vault_n_wall\nX=#\nY=.\n\n#X###X#\nY......\n.......\n.......\n.......\nY......\n.......","\nname:vault_e_wall\nX=.\nY=.\n\n.X...X#\nY.....#\n......#\n......#\n......#\nY.....#\n......#","\nname:vault_w_wall\nX=.\nY=#\n\n#X...X.\nY......\n#......\n#......\n#......\nY......\n#......","\nname:vault_s_wall\nX=.\nY=.\n\n.X...X.\nY......\n.......\n.......\n.......\nY......\n##...##"],t.Vault.tiles.center=["\nname:vault_center1\nX=.\nY=.\n\n.X...X.\nY......\n.......\n.......\n.......\nY......\n.......","\nname:vault_center2\nX=.\nY=.\n\n.X...X.\nY..#...\n...#...\n.#####.\n...#...\nY..#...\n.......","\nname:vault_center3\nX=#\nY=#\n\n.X...X.\nY..#..#\n...#...\n.#####.\n...#...\nY..#..#\n.#...#."],t.Vault.func={},t.Vault.func.createMediumVault=((e,t,n,s)=>{const r=n.findTemplate({name:"vault_medium_n"}),a=n.findTemplate({name:"vault_medium_s"});n.addRoom(r,e,t),n.addRoom(a,e,t+1),s&&n.addRoom(s,e,t+2)}),t.Vault.func.createLargeVault=((e,t,n,s)=>{const r=n.findTemplate({name:"vault_nw_corner"}),a=n.findTemplate({name:"vault_ne_corner"}),o=n.findTemplate({name:"vault_sw_corner"}),i=n.findTemplate({name:"vault_se_corner"});n.addRoom(r,e,t),n.addRoom(a,e+1,t),n.addRoom(o,e,t+1),n.addRoom(i,e+1,t+1),s&&n.addRoom(s,e,t+2)}),t.Vault.func.createHugeVault=((e,t,n,s,a)=>{const o=n.findTemplate({name:"vault_nw_corner"}),i=n.findTemplate({name:"vault_ne_corner"}),l=n.findTemplate({name:"vault_sw_corner"}),c=n.findTemplate({name:"vault_se_corner"});r.default.isNullOrUndef([o,i,l,c])&&r.default.err("Vault.func","createHugeVault","Corner templates cannot be null. Check they are loaded"),n.addRoom(o,e,t),n.addRoom(i,e+2,t),n.addRoom(l,e,t+2),n.addRoom(c,e+2,t+2);const u=n.findTemplate({name:s});n.addRoom(u,e+1,t+1);const h=n.findTemplate({name:"vault_n_wall"}),d=n.findTemplate({name:"vault_e_wall"}),p=n.findTemplate({name:"vault_w_wall"}),f=n.findTemplate({name:"vault_s_wall"});if(n.addRoom(h,e+1,t),n.addRoom(d,e+2,t+1),n.addRoom(p,e,t+1),n.addRoom(f,e+1,t+2),a){let s=a;"string"==typeof a&&(s=n.findTemplate({name:a})),n.addRoom(s,e+1,t+3)}}),t.Vault.Models={},t.Vault.Models.default=[].concat(t.Vault.tiles.center).concat(t.Vault.tiles.corner).concat(t.Vault.tiles.wall).concat(t.Vault.tiles.vault),t.Vault.templates={},t.Vault.templates.all=t.Vault.Models.default.map(e=>a.Template.createTemplate(e));const o=a.Template.transformList(t.Vault.templates.all);t.Vault.templates.all=t.Vault.templates.all.concat(o)},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(86),o=n(9),i=n(86),l=o.Random.getRNG();t.ItemGen={};const c={};t.ItemGen.shellProps=c;const u={};u.weaponTypes=Object.keys({melee:["dagger","sword","staff","whip","axe","mace","saber","spear","morningstar","battle axe","warhammer","pick-axe","hammer","katana","falchion","scimitar"],ranged:["sling","short bow","crossbow","matchlock","musket","rifle"],ammo:["arrow","bolt","bullet"],missile:["rock","dart","throwing axe","throwing dagger","throwing knife","throwing spear","shuriken"]}),t.ItemGen.names=u;const h={weapon:{heavy:{weight:1.5,value:1.2,damage:"1d2 + 2",rarity:1.5},light:{weight:.6,value:1.2,rarity:2},poisoned:{value:3,rarity:3,onAttackHit:[a.meleeHitDamage(2,"1d4 + 1","POISON")],colorfg:"Green"},sharp:{damage:"2",value:1.1,rarity:1.5}}};h.armour={light:h.weapon.light,heavy:{weight:1.5,value:1.2,protection:2,rarity:1.5},plated:{weight:1.2,value:1.3,protection:2,rarity:1.3}},t.ItemGen.prefix=h,u.prefix={weapon:Object.keys(h.weapon),armour:Object.keys(h.armour)};const d={weapon:{ofAccuracy:{name:"of Accuracy",accuracy:5,rarity:2.5,value:2.5},ofAgility:{name:"of Agility",agility:5,rarity:2.5,value:2.5},ofDefense:{name:"of Defense",defense:5,rarity:3,value:3},ofFire:{name:"of Fire",onAttackHit:[a.meleeHitDamage(2,"1d6 + 1","FIRE")],rarity:3,value:3},ofMight:{name:"of Might",strength:4,rarity:3,value:3},ofNecropotence:{name:"of Necropotence",onAttackHit:[{transientComp:"DrainStat",func:[{setter:"setDrainAmount",value:1},{setter:"setSourceComp",value:"Health"},{setter:"setSourceGetter",value:"getHP"},{setter:"setSourceSetter",value:"setHP"},{setter:"setTargetComp",value:"SpellPower"},{setter:"setTargetGetter",value:"getPP"},{setter:"setTargetSetter",value:"setPP"},{setter:"setDrainMsg",value:"drains life from"}]}],onEquip:[a.directDamage(1,"1d1 + 3","NECRO",1,"You feel slightly easier"),{addComp:"DirectDamage",func:[{setter:"setDamage",value:1},{setter:"setDamageType",value:r.default.DMG.NECRO},{setter:"setDamageCateg",value:r.default.DMG.DIRECT},{setter:"setProb",value:.05},{setter:"setMsg",value:"Necropotence demands blood!"}]}],rarity:4,value:4},ofFrost:{name:"of Frost",onAttackHit:[a.meleeHitDamage(2,"1d6 + 1","ICE")],rarity:3,value:3},ofMagic:{name:"of Magic",magic:5,rarity:2.5,value:2.5},ofPerception:{name:"of Perception",perception:5,rarity:3,value:3},ofProtection:{name:"of Protection",protection:5,rarity:3,value:3},ofSpeed:{name:"of Speed",speed:10,rarity:3,value:3},ofVoid:{name:"of Void",onAttackHit:[a.meleeHitDamage(2,"1d8 + 1","VOID")],rarity:4,value:4},ofWillpower:{name:"of Willpower",willpower:6,rarity:3,value:3}}};d.armour={ofAccuracy:d.weapon.ofAccuracy,ofAgility:d.weapon.ofAgility,ofDefense:d.weapon.ofProtection,ofMagic:d.weapon.ofMagic,ofMight:d.weapon.ofMight,ofPerception:d.weapon.ofPerception,ofProtection:d.weapon.ofProtection,ofSpeed:d.weapon.ofSpeed,ofLevitation:{onEquip:[{addComp:"Flying"}],rarity:5,value:5},ofNecropotence:{onEquip:[{addComp:"RegenEffect",func:[{setter:"setHP",value:0},{setter:"setMaxWaitPP",value:25}]},{addComp:"DirectDamage",func:[{setter:"setDamage",value:1},{setter:"setDamageType",value:r.default.DMG.NECRO},{setter:"setDamageCateg",value:r.default.DMG.DIRECT},{setter:"setProb",value:.05},{setter:"setMsg",value:"Necropotence demands blood!"}]}]},ofWillpower:d.weapon.ofWillpower},t.ItemGen.suffix=d,u.suffix={weapon:Object.keys(d.weapon),armour:Object.keys(d.armour)};const p={weapon:{type:"weapon",range:1,value:1,attack:0,defense:0},armour:{type:"armour",value:1,attack:0,defense:0,protection:0}};c.weapon={dagger:{damage:"1d6",attack:1,weight:.2,rarity:1,value:10},sword:{damage:"1d8 + 2",attack:2,defense:1,weight:.8,rarity:2,value:20},spear:{damage:"1d9 + 1",attack:1,defense:3,weight:1,rarity:3,value:25},mace:{damage:"1d10",attack:2,weight:1.3,rarity:3,value:25},axe:{damage:"1d10",attack:2,weight:1.1,rarity:3,value:30},staff:{damage:"1d8",attack:2,defense:2,weight:.9,rarity:4,value:30}},u.weapon=Object.keys(c.weapon),c.armour={robe:{armourType:"chest",weight:1,protection:0,defense:0},cuirass:{armourType:"chest",weight:2,protection:3,defense:-1,attack:-1},boots:{armourType:"feet",weight:.5,protection:1,defense:0,attack:0},helmet:{armourType:"head",weight:.3,protection:1,defense:0,attack:0},collar:{armourType:"neck",weight:.2,protection:1,defense:0,attack:0},shield:{armourType:"shield",weight:.8,protection:2,defense:1,attack:0}},u.armour=Object.keys(c.armour),c.material={leather:{weight:1,value:1,rarity:1},wooden:{weight:1,value:1,rarity:1},iron:{weight:1.7,value:1.2,rarity:1,weapon:{damage:"1d2 + 1"}},steel:{weight:1.5,value:1.4,rarity:1.5,weapon:{damage:"1d3 + 2"}},mithril:{weight:.9,value:3,rarity:2,weapon:{damage:"2d2 + 3"}},rubyglass:{weight:.5,value:5,rarity:3,weapon:{damage:"2d3 + 3"}},permaice:{weight:3,value:8,rarity:4,weapon:{damage:"2d3 + 6"}},forium:{weight:1.2,value:7,rarity:5,weapon:{damage:"2d2 + 4"}},void:{weight:1.4,value:10,rarity:8,weapon:{damage:"2d2 + 6",onAttackHit:[a.meleeHitDamage(2,"1d6 + 1","VOID")]}}},u.materials=Object.keys(c.material);const f=["armour","weapon"];function m(e,t,n){let s=e;return s=n.name?n.name+" "+e:t+" "+e}function g(e,t,n){let s=e;return s=n.name?e+" "+n.name:e+" "+t}t.ItemGen.genRandShell=function(e){const t=r.default.isSuccess(r.default.ITEM_PREFIX_CHANCE),n=r.default.isSuccess(r.default.ITEM_SUFFIX_CHANCE);let s="",a="";const o=l.arrayGetRand(u.materials),f=c.material[o];let y=null;f[e]&&(y=f[e]);const v=l.arrayGetRand(u[e]),_=c[e][v],b=[p[e],_,f];y&&b.push(y);let E=o+" "+v;if(t){s=l.arrayGetRand(u.prefix[e]);const t=h[e][s];b.push(t),E=m(E,s,t)}if(n){a=l.arrayGetRand(u.suffix[e]);const t=d[e][a];b.push(t),E=g(E,a,t)}const S=i.mixNewShell(b);return S.name=E,S},t.ItemGen.buildShell=function(e){const{type:t}=e;t||r.default.err("ItemGen","buildShell","No type was given");const n=p[t],s=c.material[e.material];let a=null;s[t]&&(a=s[t]);const o=h[t][e.prefix],l=d[t][e.suffix],u=[n,s,c[t][e.name]];a&&u.push(a);let f=e.material+" "+e.name;o&&(u.push(o),f=m(f,e.prefix,o)),l&&(u.push(l),f=g(f,e.suffix,l));const y=i.mixNewShell(u);return y.name=f,y},t.ItemGen.genItems=function(e){const n=[];for(let s=0;s<e;s++){const e=l.arrayGetRand(f);n.push(t.ItemGen.genRandShell(e))}return n},t.ItemGen.genRandShellWith=function(e){let n=100,s=null;for(;n>=0;){const r=l.arrayGetRand(f);if(--n,e(s=t.ItemGen.genRandShell(r)))break}return s}},function(e,t,n){e.exports=!n(72)&&!n(91)(function(){return 7!=Object.defineProperty(n(197)("div"),"a",{get:function(){return 7}}).a})},function(e,t,n){var s=n(71),r=n(48).document,a=s(r)&&s(r.createElement);e.exports=function(e){return a?r.createElement(e):{}}},function(e,t,n){var s=n(56),r=n(57),a=n(341)(!1),o=n(145)("IE_PROTO");e.exports=function(e,t){var n,i=r(e),l=0,c=[];for(n in i)n!=o&&s(i,n)&&c.push(n);for(;t.length>l;)s(i,n=t[l++])&&(~a(c,n)||c.push(n));return c}},function(e,t,n){var s=n(142);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==s(e)?e.split(""):Object(e)}},function(e,t,n){var s=n(144),r=Math.min;e.exports=function(e){return e>0?r(s(e),9007199254740991):0}},function(e,t,n){"use strict";var s=n(345)(!0);n(202)(String,"String",function(e){this._t=String(e),this._i=0},function(){var e,t=this._t,n=this._i;return n>=t.length?{value:void 0,done:!0}:(e=s(t,n),this._i+=e.length,{value:e,done:!1})})},function(e,t,n){"use strict";var s=n(150),r=n(47),a=n(203),o=n(69),i=n(56),l=n(95),c=n(346),u=n(152),h=n(349),d=n(37)("iterator"),p=!([].keys&&"next"in[].keys()),f=function(){return this};e.exports=function(e,t,n,m,g,y,v){c(n,t,m);var _,b,E,S=function(e){if(!p&&e in O)return O[e];switch(e){case"keys":case"values":return function(){return new n(this,e)}}return function(){return new n(this,e)}},C=t+" Iterator",w="values"==g,T=!1,O=e.prototype,M=O[d]||O["@@iterator"]||g&&O[g],A=!p&&M||S(g),N=g?w?S("entries"):A:void 0,P="Array"==t&&O.entries||M;if(P&&(E=h(P.call(new e)))!==Object.prototype&&E.next&&(u(E,C,!0),s||i(E,d)||o(E,d,f)),w&&M&&"values"!==M.name&&(T=!0,A=function(){return M.call(this)}),s&&!v||!p&&!T&&O[d]||o(O,d,A),l[t]=A,l[C]=f,g)if(_={values:w?A:S("values"),keys:y?A:S("keys"),entries:N},v)for(b in _)b in O||a(O,b,_[b]);else r(r.P+r.F*(p||T),t,_);return _}},function(e,t,n){e.exports=n(69)},function(e,t,n){var s=n(198),r=n(147).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return s(e,r)}},function(e,t,n){var s=n(94),r=n(92),a=n(57),o=n(141),i=n(56),l=n(196),c=Object.getOwnPropertyDescriptor;t.f=n(72)?c:function(e,t){if(e=a(e),t=o(t,!0),l)try{return c(e,t)}catch(e){}if(i(e,t))return r(!s.f.call(e,t),e[t])}},function(e,t,n){var s=n(93),r=n(57),a=n(94).f;e.exports=function(e){return function(t){for(var n,o=r(t),i=s(o),l=i.length,c=0,u=[];l>c;)a.call(o,n=i[c++])&&u.push(e?[n,o[n]]:o[n]);return u}}},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t,n,a){return(0,s.default)(e,t,n,a),{remove:function(){(0,r.default)(e,t,n,a)}}};var s=a(n(82)),r=a(n(102));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=u(n(0)),r=u(n(111)),a=u(n(1)),o=u(n(13)),i=u(n(112)),l=u(n(73)),c=u(n(391));function u(e){return e&&e.__esModule?e:{default:e}}function h(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var d=function(e){function t(){var n,s;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var r=arguments.length,a=Array(r),o=0;o<r;o++)a[o]=arguments[o];return n=s=h(this,e.call.apply(e,[this].concat(a))),s.setContainer=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:s.props;s._portalContainerNode=(0,i.default)(e.container,(0,l.default)(s).body)},s.getMountNode=function(){return s._portalContainerNode},h(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this.setContainer(),this.forceUpdate(this.props.onRendered)},t.prototype.componentWillReceiveProps=function(e){e.container!==this.props.container&&this.setContainer(e)},t.prototype.componentWillUnmount=function(){this._portalContainerNode=null},t.prototype.render=function(){return this.props.children&&this._portalContainerNode?o.default.createPortal(this.props.children,this._portalContainerNode):null},t}(a.default.Component);d.displayName="Portal",d.propTypes={container:s.default.oneOfType([r.default,s.default.func]),onRendered:s.default.func},t.default=o.default.createPortal?d:c.default,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){var t=(0,a.default)(e),n=(0,r.default)(t),o=t&&t.documentElement,i={top:0,left:0,height:0,width:0};if(!t)return;if(!(0,s.default)(o,e))return i;void 0!==e.getBoundingClientRect&&(i=e.getBoundingClientRect());return i={top:i.top+(n.pageYOffset||o.scrollTop)-(o.clientTop||0),left:i.left+(n.pageXOffset||o.scrollLeft)-(o.clientLeft||0),width:(null==i.width?e.offsetWidth:i.width)||0,height:(null==i.height?e.offsetHeight:i.height)||0}};var s=o(n(42)),r=o(n(81)),a=o(n(38));function o(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var n=(0,a.default)(e);if(void 0===t)return n?"pageYOffset"in n?n.pageYOffset:n.document.documentElement.scrollTop:e.scrollTop;n?n.scrollTo("pageXOffset"in n?n.pageXOffset:n.document.documentElement.scrollLeft,t):e.scrollTop=t};var s,r=n(81),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1)),a=n(402);t.default=class extends r.Component{constructor(e){super(e),this.saveLevel=this.saveLevel.bind(this),this.loadLevel=this.loadLevel.bind(this)}shouldComponentUpdate(){return!1}saveLevel(){let e=this.props.objData;this.props.objData.toJSON&&(e=this.props.objData.toJSON());try{if(new Blob){const t=(new Date).getTime(),n=`${this.props.fNamePrefix||"bsave"}_${t}_${this.props.savedObjName}.json`;let s=null;s=this.props.pretty?JSON.stringify(e,null," "):JSON.stringify(e);const r=new Blob([s],{type:"text/plain;charset=utf-8"});a.saveAs(r,n),this.props.onSaveCallback&&this.props.onSaveCallback(e)}}catch(t){let n="No Blob support in browser. Saving to localStorage.\n";n+="You can visit /level.html to view the JSON.",localStorage.setItem("savedLevel",JSON.stringify(e)),this.props.setMsg({errorMsg:n})}}loadLevel(){const e="#"+this.props.id+"level-file-input",t=document.querySelector(e).files[0];if(t){const e=new FileReader;e.onloadend=(()=>{const t=e.result;try{const e=JSON.parse(t);this.props.onLoadCallback&&this.props.onLoadCallback(e)}catch(e){const t="File: Not valid JSON or level: "+e.message;console.log(e),this.props.setMsg({errorMsg:t})}}),e.onerror=(e=>{const t="Filereader error: "+e;this.props.setMsg({errorMsg:t})}),e.readAsText(t)}else{const e="Could not get the file.";this.props.setMsg({errorMsg:e})}}render(){return r.default.createElement("span",null,r.default.createElement("button",{id:this.props.id+"btn-save-level",onClick:this.saveLevel},this.props.saveButtonName||"Save"),r.default.createElement("input",{id:this.props.id+"level-file-input",onChange:this.loadLevel,type:"file"}))}}},function(e,t){(function(t){e.exports=t}).call(this,{})},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1)),a=n(165);t.default=class extends r.Component{constructor(e){super(e),this.handleClick=this.handleClick.bind(this)}shouldComponentUpdate(e){if(this.props.mouseOverCell){if(!e.mouseOverCell)return!0;const[t,n]=this.props.mouseOverCell.getXY(),[s,r]=e.mouseOverCell.getXY();if(s===t&&r===n)return!1}return!0}render(){const e=this.renderMenuItems();return r.createElement(a.ContextMenu,{className:"context-menu",id:"right-click-context-menu"},e)}handleClick(e,t){console.log("ContextMenuItems handleClick with",t),this.props.handleRightClick(e,t,this.props.mouseOverCell)}renderMenuItems(){const e=[];return Object.keys(this.props.menuItems).forEach(t=>{this.isCorrectContext(t)&&(this.getMenuItems(this.props.menuItems[t]).forEach((t,n)=>{e.push(r.createElement(a.MenuItem,{data:{type:t.type},key:n+"-"+t.text,onClick:this.handleClick},t.text))}),e.push(r.createElement(a.MenuItem,{divider:!0,key:"divider-"+t})))}),e}getMenuItems(e){let t=[];return Array.isArray(e)?e:(Object.keys(e).forEach(n=>{this.isCorrectContext(n)&&(t=t.concat(this.getMenuItems(e[n])))}),t)}isCorrectContext(e){const t=this.props.mouseOverCell;if(t){if("function"==typeof t[e])return t[e]();if("function"==typeof this[e])return this[e]()}return!1}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=n(58),a=n(46),o=n(31),i=n(14),l=n(21),c=n(90),u=s(n(15)),h=n(108),d=n(26),p=n(12),f=7;t.abandonedFortConf={outerColsRatio:.4,outerRowsRatio:.4,outerStartXRatio:.4,mountainWallRatio:.3,castleRowsRatio:.6,castleColsRatio:.6};t.AbandonedFort=class{constructor(e,n,s){s||(s=t.abandonedFortConf);const o=s.outerColsRatio||.4,l=s.outerRowsRatio||.4,c=s.outerStartXRatio||.4,m=s.mountainWallRatio||.3,g={meanWx:Math.floor(m*e),stdDev:10,filterW:7,north:!0,south:!0,east:!1,west:!1,alignHorizontal:"right"},y=this.createLevel("mountain",e,n,{nRoadTurns:0,snowRatio:.3}),v=y.getMap(),_=new d.MapGenerator,b={startRoomFunc:h.Castle.startRoomFuncWest},E=Math.round(o*e),S=Math.round(l*n),C=_.createCastleWall(E,S,b),w=Math.round(c*e),T=Math.round(n/2-C.map.rows/2);p.Geometry.mergeMapBaseElems(v,C.map,w,T);const O=Math.floor(e/2),M=this.createLevel("wall",O,n,g),A=e-M.getMap().cols;d.MapGenerator.addRandomSnow(M.getMap(),.3),p.Geometry.mergeLevels(y,M,A,0);const N=this.getCastleLevel(n,e,s),P=e-N.getMap().cols,x=Math.round((n-N.getMap().rows)/2);p.Geometry.mergeLevels(y,N,P,x);const I=Math.floor(n/2),D=new u.ElementStairs("stairsUp",y);y.addStairs(D,0,I);const k=N.getMap().rows,L=N.getMap().cols;let R=x,B=x+(k-1);R+=f,B-=f;const G=v.getFirstFreeFromRight(R,B),[F,W]=[G.getX(),G.getY()],Y=new u.ElementStairs("stairsDown",y);y.addStairs(Y,F,W);const j={ulx:P,uly:x,lrx:P+L-1,lry:x+k-1},X=i.ObjectShell.getParser(),U=new a.FactoryItem,$=v.getFreeInBbox(j);U.addItemsToCells(y,X,$,{itemsPerLevel:50,nLevel:0,func:e=>e.value>=100&&e.value<=200,maxValue:500});const K={"Mighty raven":!0,"Winter demon":!0,Cryomancer:!0,"Ice djinn":!0,Stormrider:!0,"Snow leopard":!0},V={actorsPerLevel:500,func:e=>K.hasOwnProperty(e.name),maxDanger:10};(new r.FactoryBase).addNRandActors(y,X,V),this.createPathToFort(y,P),this.level=y}getCastleLevel(e,t,n){const s=n.castleRowsRatio||.6,r=n.castleColsRatio||.6,a=Math.floor(s*e),o=Math.floor(r*t),i={tilesX:Math.round(o/7),tilesY:Math.round(a/7),roomCount:200,startRoomFunc:h.Castle.startRoomFuncWest};return this.createLevel("castle",o,a,i)}createLevel(e,t,n,s){return(new o.FactoryLevel).createLevel(e,t,n,s)}createPathToFort(e,t){const n=e.getMap(),s=t+1,r=Math.floor(n.rows/2),a=Math.floor(n.rows/2);this.createVariedPath(n,{x0:0,x1:s,y0:r,y1:a})}createVariedPath(e,t){const{x0:n,y0:s,x1:r,y1:a}=t;let o=[];for(let t=n;t<r;t+=20){let n=t+20;n>r&&(n=r);const i=l.Path.getMinWeightPath(e,t,s,n,a);o=o.concat(i)}c.Builder.addPathToMap(e,o)}getLevel(){return this.level}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(54),i=n(21),l=n(90),c=n(14),u=r(n(15)),h=n(31),d=n(12),p=n(113);t.Capital=class{constructor(e,t,n={}){a.default.isNullOrUndef([e,t])&&a.default.err("Capital","constructor","Use new Capital(cols, rows, conf?)");const s={meanWy:Math.floor(.9*t/2),stdDev:10,filterW:7};n.transpose&&(s.north=!0,s.south=!0,s.east=!1,s.west=!1,s.meanWx=Math.floor(.9*e/2));const r=(new h.FactoryLevel).createLevel("wall",e,t,s),f=r.getMap(),m=[.03,.2,.75,.95],g=[.5,.8,.6],y=c.ObjectShell.getParser(),v=e=>"Hyrkhian townsfolk"===e.name,_=[{actorFunc:v,nShops:2,parser:y,nGates:2,hasWall:!0},{actorFunc:v,nShops:5,parser:y,nGates:2,hasWall:!0},{actorFunc:v,nShops:2,parser:y,nGates:2,hasWall:!0}],b=[];for(let s=0;s<m.length-1;s++){const r=Math.floor(t*m[s]);let a=Math.floor(t*m[s+1])-r,o=Math.floor(g[s]*e);if(n.transpose){const n=Math.floor(e*m[s]);o=Math.floor(e*m[s+1])-n,a=Math.floor(g[s]*t)}_[s].nHouses=Math.floor(o*a/500),_[s].floorType="cave",_[s].wallType="castle",_[s].addWindows=!0;const i=(new p.CityGenerator).create(o,a,_[s]);b.push(i)}const E={x:0,y:Math.floor(m[0]*e),centerX:!0};if(n.transpose&&(E.centerY=!0,E.centerX=!1,E.y=0,E.x=Math.floor(m[0]*t)),d.Geometry.tileLevels(r,b,E),n.transpose){const n=Math.floor(t/2),s=new u.ElementStairs("stairsUp",r);r.addStairs(s,0,n);const a=new u.ElementStairs("stairsUp",r);r.addStairs(a,e-1,n);const o=i.Path.getMinWeightPath(f,0,n,e-1,n);l.Builder.addPathToMap(f,o)}else{const n=Math.floor(e/2),s=new u.ElementStairs("stairsUp",r);r.addStairs(s,n,0);const a=new u.ElementStairs("stairsUp",r);r.addStairs(a,n,t-1);const o=i.Path.getMinWeightPath(f,n,0,n,t-1,i.Path.getShortestPassablePathWithDoors);l.Builder.addPathToMap(f,o)}const S={footman:100,archer:50,elite:25,commander:5},C=[];Object.keys(S).forEach(e=>{const t=`Hyrkhian ${e}`,n=S[e];for(let e=0;e<n;e++){const e=y.createActor(t);C.push(e)}});for(let e=0;e<3;e++){const e=y.createActor("trainer");C.push(e)}o.Placer.addPropsToFreeCells(r,C,a.default.TYPE_ACTOR);const w=[y.createItem("Longsword")];o.Placer.addPropsToFreeCells(r,w,a.default.TYPE_ITEM),this.level=r}setConfig(){}getLevel(){return this.level}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(31),o=n(108),i=n(54),l=n(22),c=n(15),u=n(26),h=n(12),d=n(19),p=n(14),f=n(406),m={outerColsRatio:.45,outerRowsRatio:.4,outerStartXRatio:.3,cols:300,rows:250};t.dwarvenCityConf=m;const g=7;t.DwarvenCity=class{constructor(e,t,n=m){const s={meanWy:Math.floor(.85*t/2),stdDev:10,filterW:7},r=new a.FactoryLevel,o=r.createLevel("wall",e,t,s),i=n.outerColsRatio||.35,l=n.outerRowsRatio||.35;let c=Math.round(i*e),u=Math.round(l*t);c=this.adjustToTileSize(c),u=this.adjustToTileSize(u);const d=this.createEntryFortLevel(c,u),p=c+14,f=u+14,g=this.createMainFortLevel(p,f),y=f+u,v=Math.ceil((e-g.getMap().cols)/2),_=e-v,b={centerY:!1,centerX:!0,y:10,x:0},E=[g,d,r.createLevel("empty",14,50)];h.Geometry.tileLevels(o,E,b);const S={ulx:v,uly:10,lrx:_,lry:y};this.addItemsAndActors(o,S),this.addStairsToLevel(e,t,o),this.level=o}adjustToTileSize(e){for(;e%g!=0;)++e;return e%(2*g)==0&&(e+=g),e}createMainFortLevel(e,t){const n={startRoomFunc:o.Castle.startFuncFourGates},s=new u.MapGenerator,r=s.createCastleWall(e,t,n),a=e-42,i=t-28,c=s.createCastle(a,i,{roomCount:-1,nGates:2});(new l.Level).setMap(c.map),h.Geometry.mergeMapBaseElems(r.map,c.map,21,14);const p=new l.Level;p.setMap(r.map);const m=s.createCastle(49,35,{startRoomFunc:o.Castle.startRoomFuncEast,roomCount:-1,genParams:[1,1,1,1]}),g=s.createCastle(49,35,{startRoomFunc:o.Castle.startRoomFuncWest,roomCount:-1,genParams:[1,1,1,1]}),y=new l.Level;y.setMap(m.map);const v=new l.Level;v.setMap(g.map);const _=[y,p,v],b={centerY:!0,baseElem:d.ELEM.WALL};return f.LevelUtils.wrapAsLevel(_,b)}createEntryFortLevel(e,t){const n=new u.MapGenerator,s={startRoomFunc:o.Castle.startFuncFourGates},r=n.createCastleWall(e,t,s),a=e-42,i=t-42,c=n.createCastle(a,i,{nGates:2,roomCount:-1});(new l.Level).setMap(c.map),h.Geometry.mergeMapBaseElems(r.map,c.map,21,21);const p=n.createCastleWall(21,21,{startRoomFunc:o.Castle.startRoomFuncEast}),m=n.createCastleWall(21,21,{startRoomFunc:o.Castle.startRoomFuncWest}),g=new l.Level;g.setMap(r.map);const y=new l.Level;y.setMap(p.map);const v=new l.Level;v.setMap(m.map);const _=[y,g,v],b={centerY:!0,baseElem:d.ELEM.WALL};return f.LevelUtils.wrapAsLevel(_,b)}addItemsAndActors(e,t){const n=p.ObjectShell.getParser(),s=e.getMap().getFreeInBbox(t),a={fighter:200,axeman:100,elite:50,rifleman:50,commander:20},o=[];Object.keys(a).forEach(e=>{const t=`dwarven ${e}`,s=a[e];for(let e=0;e<s;e++){const e=n.createActor(t);o.push(e)}}),i.Placer.addPropsToCells(e,s,o,r.default.TYPE_ACTOR)}getLevel(){return this.level}addStairsToLevel(e,t,n){const s=Math.floor(e/2),r=new c.ElementStairs("stairsUp",n);n.addStairs(r,s,0);const a=new c.ElementStairs("stairsUp",n);n.addStairs(a,s,t-1)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8));class a{constructor(e){this.stepType="Task",this.name="",this.taskType=e}isTask(){return!0}isQuest(){return!1}getName(){return this.name}getTaskType(){return this.taskType}}t.Task=a;t.Quest=class{constructor(e,t){e&&"string"!=typeof e&&r.default.err("Quest","new","Quest must have a name!"),this.name=e,this.steps=[],this.stepType="Quest",this.motive="",this.terms=[],Array.isArray(t)&&t.forEach(e=>{if(e.isQuest)this.addStep(e);else if(e.isTask)this.addStep(e);else{const t=new a(e);this.addStep(t)}})}setName(e){this.name=e}getName(){return this.name}setMotive(e){this.motive=e}getMotive(){return this.motive}isTask(){return!1}isQuest(){return!0}addTerm(e){this.terms.push(e)}getTasks(){return this.steps.filter(e=>e.isTask())}addStep(e){Array.isArray(e)?this.steps=this.steps.concat(e):this.steps.push(e)}numQuests(){let e=1;return this.steps.forEach(t=>{t.isQuest&&t.isQuest()&&(e+=1)}),e}numTasks(){const e=this.numQuests()-1;return this.steps.length-e}getSteps(){return this.steps.slice()}numSteps(){return this.steps.length}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8));class a{constructor(){this._stacks={},this.path=[],this._ptr={}}addTarget(e,t){if(!r.default.isEntity(t)&&!t.createTarget){const e=JSON.stringify(t);r.default.err("QuestData","addTarget",`Only entities can be added. Got: ${e}`)}if(a.mapStepToType[e])this._stacks[e]||(this._stacks[e]=[]),this._stacks[e].push(t),this.path.push({type:e,target:t});else{const t=JSON.stringify(a.mapStepToType);r.default.err("QuestData","add",`Step type ${e} not supported. See:\n${t}`)}}replaceTarget(e,t,n){const s=this._stacks[e];let a=s.indexOf(t);if(a>=0){if(s.splice(a,1,n),(a=this.path.findIndex(e=>e.target===t))>=0){const e={target:n,type:this.path[a].type};this.path.splice(a,1,e)}else r.default.err("QuestData","replaceTarget","Could not replace target on path");return!0}return!1}numSteps(){return this.path.length}keys(){return Object.keys(this._stacks)}getPathTypes(){return this.path.map(e=>e.type)}getPathTargets(){return this.path.map(e=>e.target)}pop(e){return this._stacks[e]?this._stacks[e].pop():null}resetIter(){this.keys().forEach(e=>{this._ptr[e]=0})}next(e){if(this._stacks[e]){this._ptr.hasOwnProperty(e)||(this._ptr[e]=0);const t=this._ptr[e];if(t<this._stacks[e].length)return++this._ptr[e],this._stacks[e][t]}return null}getCurrent(e){if(this._stacks[e]){const t=this._stacks[e];return t[t.length-1]}return null}getCurrentLocation(){const e=this.getCurrent("location");if(e)return e;r.default.err("QuestGen","getCurrentLocation","No location found")}getDescr(){let e="";return this.path.forEach(t=>{const n=t.type,s=t.target,a=r.default.getName(s);e+=n+" "+a+". "}),e}toJSON(){const e=[];return this.path.forEach(t=>{const n=a.mapStepToType[t.type];if(n)if(t.target.getID){const s={type:t.type,target:r.default.getObjRef(n,t.target)};e.push(s)}else{const n={type:t.type,target:t.target};e.push(n)}else console.error("Used step is",t),r.default.err("QuestData","toJSON",`No refType for step type ${t.type}`)}),e.$objRefArray=!0,{createFunc:"createQuestData",value:{path:e}}}}t.QuestData=a,a.mapStepToType={capture:"entity",escort:"entity",exchange:"item",experiment:"item",explore:"element",damage:"entity",defend:"entity",get:"item",give:"entity",kill:"entity",listen:"entity",location:"place",finishbattle:"place",read:"item",repair:"element",report:"entity",reportListen:"entity",rescue:"entity",spy:"entity",steal:"item",take:"item",subquest:"entity",use:"item",winbattle:"place"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(17)("bitn:quest-gen"),r=n(9),a=n(408),o=n(217),i=n(409).QuestGrammar.grammar,l=r.Random.getRNG();class c{static parse(e){const t=a.parse(e),n={};return t.productions.forEach(e=>{n[e.lhs.text]=e.rhs.map(function(e,t){return t[e]}.bind(null,"terms"))}),n}constructor(e){this._init(),this.rng=e||l}_init(){this.stack=[],this.currQuest=null,this.ruleHist={},this.startRule="QUEST"}genQuestWithMotive(e={}){const{motive:t}=e,n=e.rules||c.rules,[s]=this.chooseRandomRule(n[t]),r=s.text;console.log("questType is",r);const a=Object.assign({},e);a.rules=n,a.startRule=r;const o=this.genQuestWithConf({startRule:r,rules:n});return o.setName(r),o.setMotive(t),o}genQuestWithConf(e={}){e.debug&&(s.enabled=!0);const t=e.rules||c.rules,n=e.startRule||"QUEST";let r=!1,a=e.maxTries||20,o=[];for(;!r;)if(this._init(),this.startRule=n,s("=== Generating new quest now ==="),o=this.generateQuest(t,n).split("|"),(r=this._questMeetsReqs(o,e))||s("QUEST DISCARDED"),0==--a){console.warn("Could not find a matching quest.");break}return this.currQuest}genQuestWithName(e){const t=new o.Quest(e),n=new o.Task("<goto>already_there");t.addStep(n);const s=new o.Task("<kill>kill");return t.addStep(s),t}_questMeetsReqs(e,t){let n=!0;const r=t.minLength||1,a=t.maxLength||-1;return(e.length<=a||-1===a)&&e.length>=r?(n=!0,s("MATCHING QUEST FOUND")):n=!1,t.minQuests&&(n=n&&this.currQuest.numQuests()>=t.minQuests),t.maxQuests&&(n=n&&this.currQuest.numQuests()<=t.maxQuests),n}generateQuest(e,t){if(this.ruleHist[t]?this.ruleHist[t]+=1:this.ruleHist[t]=1,s(`generateQuest with rule |${t}|`),t===this.startRule||"QUEST"===t){s("New (sub)-quest will be generated");const e="";this.currQuest=new o.Quest(e),this.stack.push(this.currQuest)}s(`Choosing randRule ${t} from ${JSON.stringify(e[t])}`);const n=this.chooseRandomRule(e[t]);if(Array.isArray(n)){const s=n.map(this.generateTerm.bind(this,e));return this._checkIfQuestOver(t),s.join("|")}return s(`generateQuest end reached, return |${n}|`),this._checkIfQuestOver(t),n}generateTerm(e,t){if(!t.text){const t=JSON.stringify(e);throw new Error(`Null/undef term.text with rules| ${t}|`)}return"terminal"===t.type?this.currQuest.addTerm(t.text):this.currQuest.addTerm("<<"+t.text+">>"),"terminal"===t.type?(this.currQuest.addStep(new o.Task(t.text)),t.text):(s(`genTerm: term.type ${t.type} text: ${t.text}`),s(`calling generate() with term.text |${t.text}|`),this.generateQuest(e,t.text))}_checkIfQuestOver(e){if(e===this.startRule||"QUEST"===e){if(s("Finishing current quest"),this.stack.length>1){const e=this.stack.pop();this.currQuest=this.stack[this.stack.length-1],this.currQuest.addStep(e)}}}chooseRandomRule(e){if(Array.isArray(e)){const t=this.rng.arrayGetRand(e);return s("chose next rule at RANDOM:",t),t}return s(`chooseRandomRule() not an ARRAY: |${e}`),null}}t.QuestGen=c,c.rules=c.parse(i),c.defaultConfig={rules:c.rules,startRule:"QUEST",maxTries:20,debug:!1,minQuests:1,maxQuests:-1,minLength:1,maxLength:-1}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(17)("bitn:ConfStack");t.ConfStack=class{constructor(){this.globalConf={},this.scope=[],this.confStack=[]}setGlobalConf(e){this.globalConf=e}getGlobalConf(){return this.globalConf}getScope(){return this.scope}pushScope(e){this.scope.push(e.name),this.confStack.push(e),this.dbg("Pushed scope: "+e.name)}popScope(e){const t=e.name,n=this.scope.pop();if(n!==t)r.default.err("Factory.ConfStack","popScope",`Popped: ${n}, Expected: ${t}`);else{const e=this.confStack.pop();this.dbg("Popped scope: "+e.name)}}getConf(e){for(let t=this.confStack.length-1;t>=0;t--)if(this.dbg(`[${t}] looking for |${e}|`),this.confStack[t].hasOwnProperty(e))return this.dbg(`  >> [${t}] Found key |${e}|`),this.confStack[t][e];return this.globalConf.hasOwnProperty(e)?this.globalConf[e]:null}dbg(e){a.enabled&&r.default.diag(e)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(161),r=n(116),a=n(9),o=n(98),i=a.Random.getRNG();t.TerritoryMap=function(){},t.TerritoryMap.create=function(e,t,n){const[a,l]=n,c=e.getFeaturesByType(r.OW.WCAPITAL)[0],u=e.getFeaturesByType(r.OW.WTOWER)[0],h=e.getFeaturesByType(r.OW.BTOWER)[0],d=e.getFeaturesByType(r.OW.BCAPITAL)[0],p=e.getOWMap(),f=new s.Territory(e.getSizeX(),e.getSizeY(),{startSize:2,maxNumPos:2});f.useMap(p,{[r.OW.TERM]:!0,[r.OW.MOUNTAIN]:!0,[r.OW.BVILLAGE]:!0,[r.OW.WVILLAGE]:!0,[r.OW.WCAPITAL]:!0,[r.OW.BCAPITAL]:!0,[r.OW.WTOWER]:!0,[r.OW.BTOWER]:!0});f.addRival({name:"avianfolk",char:"A"}),f.addRival({name:"wildling",char:"I"}),f.addRival({name:"bearfolk",char:"B"}),f.addRival({name:"wolfclan",char:"w"}),f.addRival({name:"catfolk",char:"f"}),f.addRival({name:"dogfolk",char:"d"}),f.addRival({name:"human",char:"@"});const m={name:"undead",char:"z",numPos:3,startX:[e.getCenterX()],startY:[e.getSizeY()-5]};f.addRival(m),f.addRival({name:"goblin",char:"g",numPos:8}),f.addRival({name:"dwarf",char:"h",startX:u[0],startY:u[1]}),f.addRival({name:"hyrkhian",char:"y",startX:c[0],startY:c[1]});const g={name:"winterbeing",char:"W",startX:[h[0],d[0]],startY:[h[1],d[1]]};f.addRival(g);const y=new o.OverWorld.CoordMap;y.xMap=10,y.yMap=10;const v=y.getOWTileBboxFromAreaTileXY(a,l),_=f.getRivalData(t);_.numPos+=1;const b=i.getUniformInt(v.ulx,v.lrx),E=i.getUniformInt(v.uly,v.lry);return _.startX.push(b),_.startY.push(E),f.generate(),f}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(96),o=n(115);t.LevelGen={};t.LevelGen.getDungeonConf=(e=>{let t=function(e){switch(e){case"Grotto":case"Cavern":case"Lair":return"Cave";case"Catacombs":case"Tombs":return"Crypt";case"Cells":return"Dungeon";default:return e}}(e);const n=function(e){switch(e){case"Cave":return 1;case"Crypt":return 2;case"Dungeon":return 3;case"Labyrinth":return 1;default:return 3}}(t),s=function(e){switch(e){case"Cave":return{actor:{op:"eq",prop:"type",value:["animal","goblin","beast"]}};case"Crypt":return{actor:{op:"eq",prop:"type",value:"undead"}};default:return null}}(t),[a,o]=function(e){const t=[r.default.LEVEL_MEDIUM_X,r.default.LEVEL_MEDIUM_Y];switch(e){case"Cave":return[80,50];case"Cavern":return[200,200];case"Grotto":return[120,60];case"Lair":return[200,150];case"Cells":case"Dungeon":return[100,50];case"Labyrinth":return[100,100];case"Crypt":return t;case"Tombs":return[100,100];case"Catacombs":return[r.default.LEVEL_HUGE_X,r.default.LEVEL_HUGE_Y];default:return t}}(e),i={name:e,dungeonX:a,dungeonY:o,dungeonType:t=t.toLowerCase(),nBranches:1,branch:[{name:e,nLevels:n,entranceLevel:0}]};return s&&(i.constraint=s),i}),t.LevelGen.getMountainConf=(e=>{const[t,n]=[80,240];return{name:e,nFaces:1,face:[{name:e,nLevels:1,entranceLevel:0,x:t,y:n}],nSummits:1,summit:[{name:"Summit",nLevels:1,cols:80,rows:50}],connectLevels:[[e,"Summit",0,0]]}});const i=()=>r.default.RAND.arrayGetRand(r.default.SHOP_TYPES),l=(e,t)=>{const n=t.maxValue||100,s=t.shopType||"random",a=t.name;if("Market"===a||"Bazaar"===a){const t=r.default.RAND.getUniformInt(1,3);e.nShops=t,e.constraint.shop=[];for(let r=0;r<t;r++){let t=i();"random"!==s&&0===r&&(t=s);const a=[{op:"eq",prop:"type",value:t},{op:"lte",prop:"value",value:n}];e.constraint.shop.push(a)}}else e.nShops=1};t.LevelGen.getCityConf=((e,t)=>{let n=a.Names.getGenericPlaceName("city");"fort"===t.type?n="Fort":t.capital?n="Capital":"stronghold"===t.type?n="Stronghold":"village"===t.type&&(n=a.Names.getVillageType());const s=(e=>{switch(e){case"Hamlet":case"Village":return 1;case"Town":return 2;case"Fort":return 1;case"Stronghold":return r.default.RAND.getUniformInt(2,4);case"Capital":return r.default.RAND.getUniformInt(3,5);default:return 1}})(n),i=((e,t)=>{const n=[];for(let s=0;s<e;s++){const e={name:a.Names.getGenericPlaceName("quarter"),nLevels:1,constraint:{}};0===s&&(e.entranceLevel=0),l(e,t),n.push(e)}return n})(s,t),c=o.WorldConf.createQuarterConnections(i),u={name:e,nQuarters:s,quarter:i};return c&&(u.connectLevels=c),u})},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=n(420),a=n(421),o=s(n(25));class i{constructor(e){this.dayMan=new a.DayManager(e),this.seasonMan=new r.SeasonManager(e)}setLevel(e){this.currLevel=e}setOwPos(e){this.seasonMan.setOwPos(e)}update(){if(this.dayMan.update(),this.dayMan.phaseChanged()&&this.seasonMan.changeWeather(),this.dayMan.dayChanged()&&(this.seasonMan.update(),this.seasonMan.monthChanged()&&this.seasonMan.seasonChanged()&&this.seasonMan.yearChanged()),this.changed("weather")){const e=this.seasonMan.getWeather();if(this.currLevel){this.currLevel.removeAll("Weather");const t=new o.Weather;t.setWeatherType(e),this.currLevel.add(t)}}}getSeason(){return this.seasonMan.getSeason()}getWeather(){return this.seasonMan.getWeather()}setUpdateRates(e){this.dayMan.setUpdateRate(e)}changed(e){switch(e){case"day":return this.dayMan.dayChanged();case"month":return this.seasonMan.monthChanged();case"season":return this.seasonMan.seasonChanged();case"year":return this.seasonMan.yearChanged();case"weather":return this.seasonMan.weatherChanged();default:throw new Error("No change for "+e)}return!1}setPool(e){this.dayMan.setPool(e),this.seasonMan.setPool(e)}setOverWorld(e){this.seasonMan.setBiomeMap(e.getBiomeMap())}toJSON(){return{dayManager:this.dayMan.toJSON(),seasonManager:this.seasonMan.toJSON()}}}t.WorldSimulation=i,i.fromJSON=function(e){const t=new i;return t.dayMan=a.DayManager.fromJSON(e.dayManager),t.seasonMan=r.SeasonManager.fromJSON(e.seasonManager),t}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(74),o=n(22),i=n(17)("bitn:ChunkManager"),l=Object.freeze({EMPTY:"EMPTY",LOADED:"LOADED",JSON:"JSON",ON_DISK:"ON_DISK",LOADED2JSON:"LOADED2JSON"}),c=Object.freeze({EMPTY:"EMPTY",CREATED:"CREATED",POPULATED:"POPULATED"});class u{constructor(e,t){const[n,s]=[t.getSizeX(),t.getSizeY()];this.sizeX=n,this.sizeY=s,this.area=t,this.game=e,this.state=[];for(let e=0;e<n;e++){this.state[e]=[];for(let n=0;n<s;n++)if(t.isLoaded(e,n)){const t={loadState:l.LOADED};this.state[e].push(t)}else{const t={loadState:l.JSON};this.state[e].push(t)}}this.loadDistX=1,this.loadDistY=1,this.onDiskDistX=n,this.onDiskDistY=s}setPlayerTile(e,t,n,s){const r=this.getMoveDir(e,t,n,s);i.enabled&&(i(`## setPlayerTile START ${n},${s}->${e},${t}`),this.debugPrint());const a=[];for(let n=0;n<this.sizeX;n++)for(let s=0;s<this.sizeY;s++)this.inLoadRange(e,t,n,s)?this.isLoaded(n,s)||a.push([n,s]):this.isLoaded(n,s)&&this.unloadTile(e,t,n,s,r);a.length>0&&this.loadTiles(e,t,a,r),i.enabled&&(i(`## setPlayerTile END ${n},${s}->${e},${t}`),this.debugPrint())}isLoaded(e,t){return this.state[e][t].loadState===l.LOADED}inLoadRange(e,t,n,s){for(let r=e-this.loadDistX;r<=e+this.loadDistX;r++)for(let e=t-this.loadDistY;e<=t+this.loadDistY;e++)if(n===r&&s===e)return!0;return!1}loadAllTiles(){this.setLoadStateAll(l.LOADED)}getNumInState(e){let t=0;for(let n=0;n<this.sizeX;n++)for(let s=0;s<this.sizeY;s++)this.state[n][s].loadState===e&&++t;return t}loadTiles(e,t,n,s){const r=this.area.getTiles();i("loadTiles: "+JSON.stringify(n));const a=n.map(e=>r[e[0]][e[1]]);this.createTiles(a),n.forEach(n=>{i(`ChunkManager load now tile ${n}`);const[a,o]=n;if(this.state[a][o].loadState=l.LOADED,this.area.setLoaded(a,o),""===s&&(i(`Rm adjacent conns to ${a},${o}`),this.removeAdjacentConnections(r,e,t,a,o)),0===n[0]&&2===n[1]){this.area.getTiles()}})}removeAdjacentConnections(e,t,n,s,r){this.inLoadRange(t,n,s,r-1)||r-1>=0&&(i(`Rm NORTH conns from ${s},${r}`),this.removeConnections("NORTH",e[s][r])),this.inLoadRange(t,n,s,r+1)||r+1<this.area.getSizeY()&&(i(`Rm SOUTH conns from ${s},${r}`),this.removeConnections("SOUTH",e[s][r])),this.inLoadRange(t,n,s+1,r)||s+1<this.area.getSizeX()&&(i(`Rm EAST conns from ${s},${r}`),this.removeConnections("EAST",e[s][r])),this.inLoadRange(t,n,s-1,r)||s-1>=0&&(i(`Rm WEST conns from ${s},${r}`),this.removeConnections("WEST",e[s][r]))}unloadTile(e,t,n,s,r){i(`Unloading tile ${n},${s}`);const a=this.area.getTiles();this.state[n][s].loadState=l.LOADED2JSON,this.area.setUnloaded(n,s);const o=a[n][s].getLevels();this.game.removeLevels(o);const c=a[n][s].getLevel();if(i(`\tUnloading battles @ ${n},${s}, id: ${c.getID()}`),this.game.getGameMaster().unloadBattles(c),i.enabled){const e=a[n][s].getLevels().map(e=>e.getID());i(`\t-- Unloading levels ${e}`)}if(a[n][s].removeListeners(),a[n][s]=a[n][s].toJSON(),"WEST"===r){const e=n-1;i(`Removing connections from tile ${n-1},${s}`),e<this.area.getSizeX()&&this.removeConnections("EAST",a[n-1][s])}else if("EAST"===r){const e=n+1;i(`Removing connections from tile ${n+1},${s}`),e<this.area.getSizeX()&&this.removeConnections("WEST",a[n+1][s])}else if("NORTH"===r){const e=s-1;i(`Removing connections from tile ${n},${s-1}`),e>=0&&this.removeConnections("SOUTH",a[n][s-1])}else if("SOUTH"===r){const e=s+1;i(`Removing connections from tile ${n},${s+1}`),e<this.area.getSizeY()&&this.removeConnections("NORTH",a[n][s+1])}else this.inLoadRange(e,t,n,s-1)&&s-1>=0&&this.isLoaded(n,s-1)&&(i(`Rm SOUTH conns from ${n},${s-1}`),this.removeConnections("SOUTH",a[n][s-1])),this.inLoadRange(e,t,n,s+1)&&s+1<this.area.getSizeY()&&this.isLoaded(n,s+1)&&(i(`Rm NORTH conns from ${n},${s+1}`),this.removeConnections("NORTH",a[n][s+1])),this.inLoadRange(e,t,n+1,s)&&n+1<this.area.getSizeX()&&this.isLoaded(n+1,s)&&(i(`Rm WEST conns from ${n+1},${s}`),this.removeConnections("WEST",a[n+1][s])),this.inLoadRange(e,t,n-1,s)&&n-1>=0&&this.isLoaded(n-1,s)&&(i(`Rm EAST conns from ${n-1},${s}`),this.removeConnections("EAST",a[n-1][s]));this.state[n][s].loadState=l.JSON}getLoadState(e,t){return this.state[e][t].loadState}toJSON(){return{state:this.state}}setLoadStateAll(e){this.state.forEach((t,n)=>{t.forEach((t,s)=>{this.state[n][s].loadState=e})})}createTiles(e){const t=e.length;i(`Creating ${t} AreaTiles with FromJSON`);const n=new a.FromJSON;n.setChunkMode(!0),n.createTiles(this.game,e)}addConnections(e,t,n){const s=this.getOpposite(e),r=this.getReplacedConnections(e,t),o=this.getReplacedConnections(s,n),i=new a.FromJSON,l=r.concat(o),c=[t.getLevel(),n.getLevel()];i.connectTileLevels(c,l)}removeConnections(e,t){this.getReplacedConnections(e,t).forEach(e=>{const t=e.getTargetStairs(),n=e.getTargetLevel();if(n instanceof o.Level){const s={targetLevel:n.getID(),targetStairs:{x:t.getX(),y:t.getY()}};e.setConnObj(s)}})}getReplacedConnections(e,t){const n=t.getLevel().getConnections();0===n.length&&r.default.err("ChunkManager","getReplacedConnections","No connections found.");let s=[];return"SOUTH"===e?s=n.filter(e=>e.getY()===t.rows-1):"NORTH"===e?s=n.filter(e=>0===e.getY()):"EAST"===e?s=n.filter(e=>e.getX()===t.cols-1):"WEST"===e&&(s=n.filter(e=>0===e.getX())),s}getOpposite(e){switch(e){case"NORTH":return"SOUTH";case"SOUTH":return"NORTH";case"EAST":return"WEST";case"WEST":return"EAST";default:r.default.err("ChunkManager","getOpposite",`Illegal dir ${e} given.`)}return""}getMoveDir(e,t,n,s){let[a,o]=[0,0],i="";if(!r.default.isNullOrUndef([n,s])){if(o=t-s,0!==(a=e-n)&&0!==o){const a=`MOVE: ${n},${s} -> ${e},${t}`;r.default.err("ChunkManager","getMoveDir",`Diagonal move not supported: ${a}`)}a>0?i="EAST":a<0&&(i="WEST"),o>0?i="SOUTH":o<0&&(i="NORTH")}return i}debugPrint(){let e="";for(let t=0;t<this.sizeY;t++){for(let n=0;n<this.sizeX;n++)e+=" "+this.stateToChar(this.state[n][t]);e+=` - ${t} \n`}e+="\n\tNum loaded: "+this.getNumInState(l.LOADED),e+="\n\tNum serialized: "+this.getNumInState(l.JSON),e+="\n\tNum on disk: "+this.getNumInState(l.ON_DISK),e+="\n";for(let t=0;t<this.area.getSizeY();t++){for(let n=0;n<this.area.getSizeX();n++){e+=`${n},${t}: `+(this.area.zonesCreated[n+","+t]?" X ":" - ")+"|"}e+="\n"}r.default.diag(e)}stateToChar(e){switch(e.loadState){case l.LOADED:return"L";case l.JSON:return"J";case l.ON_DISK:return"D";case l.EMPTY:return"E";case l.LOADED2JSON:return"*";default:return""}}}t.ChunkManager=u,t.Chunk={},t.Chunk.printTileConnections=function(e,t,n=-1){r.default.diag(e),"function"==typeof t.getLevel?t.getLevel().getID()!==n&&-1!==n||t.getLevel().getConnections().forEach(e=>{const t=e.getTargetLevel();Number.isInteger(t)?console.log(`\tTarget ID ${t} found`):console.log(`\tLevel ${t.getID()} found`)}):console.log("Skipping printTileConnections due to json input")},t.Chunk.LOAD=l,t.Chunk.CREATE=c,t.Chunk.ChunkManager=u},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(226);class o{static addSystemBefore(e,t){const n=o.systemOrder.indexOf(t);n>=0&&o.insertSystemAt(n,e)}static addSystemAfter(e,t){const n=o.systemOrder.indexOf(t);n>=0&&o.insertSystemAt(n+1,e)}static removeSystem(e){delete o.systems[e];const t=o.systemOrder.indexOf(e);t>=0&&o.systemOrder.splice(t,1)}static insertSystemAt(e,t){o.systemOrder.splice(e,0,t.name),"function"==typeof t.create?t.name?o.systems[t.name]=t:r.default.err("SystemManager","insertSystemAt","No system.name given"):r.default.err("SystemManager","insertSystemAt","Object must specify system.create")}constructor(e,t){this._engine=e,this.systemOrder=o.systemOrder;const n={};Object.keys(o.systems).forEach(e=>{const s=o.systems[e];if(s.create){const r=s;n[e]=r.create(r.comps,t)}else Array.isArray(s)&&(a.System[e]?n[e]=new a.System[e](s,t):r.default.err("SystemManager","new",`System[${e}] not found for new`))}),this.systems=n,this.loopSystemOrder=["Hunger"],this.loopSystems={},this.loopSystems.Hunger=new a.System.Hunger(["Action","Hunger"],t),this.timeSystems={};const s=new a.System.TimeEffects(["Expiration","Poison","Fading","Heat","Coldness","DirectDamage","RegenEffect"],t);this.timeSystems.TimeEffects=s,this._engine.addTimeSystem("TimeEffects",s)}get(e){return this.systems.hasOwnProperty(e)?this.systems[e]:null}updateSystems(){for(let e=0;e<this.systemOrder.length;e++){const t=this.systemOrder[e];this.systems[t].update()}}updateLoopSystems(){for(let e=0;e<this.loopSystemOrder.length;e++){const t=this.loopSystemOrder[e];this.loopSystems[t].update()}}setRNG(e){Object.values(this.systems).forEach(t=>{t.setRNG(e)})}}t.SystemManager=o,o.systemOrder=["AreaEffects","Disability","SpiritBind","BaseAction","Equip","Attack","Chat","Shop","SpellCast","SpellEffect","Missile","Movement","Effects","Animation","DrainStats","Damage","Death","Battle","Skills","Quest","ExpPoints","Communication","Events","Weather"],o.systems={Disability:["Stun","Entrapped","Paralysis"],SpiritBind:["SpiritBind"],BaseAction:["Pickup","UseStairs","OpenDoor","UseItem","UseElement","Jump","Read","Rest","Give"],Chat:["Chat"],Shop:["Transaction"],Attack:["Attack"],Missile:["Missile"],Movement:["Movement"],DrainStats:["DrainStat"],Damage:["Damage","Health"],Death:["DeathEvent"],Battle:["BattleOver","BattleOrder"],Skills:["SkillsExp"],Events:["Event"],AreaEffects:["Flame"],Equip:["Equip"],SpellCast:["SpellCast","PowerDrain"],SpellEffect:["SpellRay","SpellCell","SpellMissile","SpellArea","SpellSelf"],Effects:["Effects"],Animation:["Animation"],ExpPoints:["ExpPoints","Experience"],Communication:["Communication"],Quest:["GiveQuest","QuestCompleted","QuestTargetEvent"],Weather:["WeatherEffect"]}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8));t.System={};const a=n(16);var o=n(16);t.SystemBase=o.SystemBase,t.System.Base=a.SystemBase;const i=n(227);var l=n(227);t.SystemAnimation=l.SystemAnimation,t.System.Animation=i.SystemAnimation;const c=n(229);var u=n(229);t.SystemAreaEffects=u.SystemAreaEffects,t.System.AreaEffects=c.SystemAreaEffects;const h=n(230);var d=n(230);t.SystemAttack=d.SystemAttack,t.System.Attack=h.SystemAttack;const p=n(231);var f=n(231);t.SystemBaseAction=f.SystemBaseAction,t.System.BaseAction=p.SystemBaseAction;const m=n(232);var g=n(232);t.SystemBattle=g.SystemBattle,t.System.Battle=m.SystemBattle;const y=n(233);var v=n(233);t.SystemChat=v.SystemChat,t.System.Chat=y.SystemChat;const _=n(234);var b=n(234);t.SystemCommunication=b.SystemCommunication,t.System.Communication=_.SystemCommunication;const E=n(235);var S=n(235);t.SystemDamage=S.SystemDamage,t.System.Damage=E.SystemDamage;const C=n(236);var w=n(236);t.SystemDeath=w.SystemDeath,t.System.Death=C.SystemDeath;const T=n(237);var O=n(237);t.SystemDrainStats=O.SystemDrainStats,t.System.DrainStats=T.SystemDrainStats;const M=n(238);var A=n(238);t.SystemDisability=A.SystemDisability,t.System.Disability=M.SystemDisability;const N=n(162);var P=n(162);t.SystemEffects=P.SystemEffects,t.System.Effects=N.SystemEffects;const x=n(239);var I=n(239);t.SystemEquip=I.SystemEquip,t.System.Equip=x.SystemEquip;const D=n(240);var k=n(240);t.SystemEvents=k.SystemEvents,t.System.Events=D.SystemEvents;const L=n(241);var R=n(241);t.SystemExpPoints=R.SystemExpPoints,t.System.ExpPoints=L.SystemExpPoints;const B=n(242);var G=n(242);t.SystemHunger=G.SystemHunger,t.System.Hunger=B.SystemHunger;const F=n(243);var W=n(243);t.SystemMissile=W.SystemMissile,t.System.Missile=F.SystemMissile;const Y=n(244);var j=n(244);t.SystemMovement=j.SystemMovement,t.System.Movement=Y.SystemMovement;const X=n(99);var U=n(99);t.SystemQuest=U.SystemQuest,t.System.Quest=X.SystemQuest;const $=n(245);var K=n(245);t.SystemShop=K.SystemShop,t.System.Shop=$.SystemShop;const V=n(246);var H=n(246);t.SystemSkills=H.SystemSkills,t.System.Skills=V.SystemSkills;const q=n(247);var J=n(247);t.SystemSpellCast=J.SystemSpellCast,t.System.SpellCast=q.SystemSpellCast;const z=n(248);var Q=n(248);t.SystemSpellEffect=Q.SystemSpellEffect,t.System.SpellEffect=z.SystemSpellEffect;const Z=n(249);var ee=n(249);t.SystemSpiritBind=ee.SystemSpiritBind,t.System.SpiritBind=Z.SystemSpiritBind;const te=n(250);var ne=n(250);t.SystemTimeEffects=ne.SystemTimeEffects,t.System.TimeEffects=te.SystemTimeEffects;const se=n(251);var re=n(251);t.SystemWeather=re.SystemWeather,t.System.Weather=se.SystemWeather,t.System.defineSystem=function(e){const n=e.toUpperCase();r.default.SYS[n]=Symbol();const s=class extends a.SystemBase{constructor(e,...t){super(r.default.SYS[n],e),this._init&&"function"==typeof this._init&&this._init(e,...t)}};return t.System[e]=s,s},t.System.undefineSystem=function(e){const n=e.toUpperCase();delete r.default.SYS[n],delete t.System[e]}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(16),o=n(12),i=n(18),l=n(228),c=i.EventPool.getPool();t.SystemAnimation=class extends a.SystemBase{constructor(e,t){super(r.default.SYS.ANIMATION,e,t),this._enabled=!0,this.currAnim=null}enableAnimations(){this._enabled=!0}disableAnimations(){this._enabled=!1}missileAnimation(e,t){const n=t.missile,s=t.to[0],a=t.to[1],o=n.first();let i=o[0],l=o[1];const c=t.item,u=r.default.getChar(r.default.TYPE_ITEM,c.getName()),h=r.default.getCssClass(r.default.TYPE_ITEM,c.getName()),d=this._createAnimation(t);for(;i!==s||l!==a;){const e={},t=i+","+l;if(e[t]={},e[t].char=u,e[t].className=h,d.addFrame(e),!n.next())break;i=n.getX(),l=n.getY()}this._setCurrAnim(d)}lineAnimation(e,t){let n=t.from[0],s=t.from[1];const a=t.dir[0],o=t.dir[1];let i=t.range,l=r.default.dirToChar(t.dir);t.lineChar&&(l={args:t});const c=this._createAnimation(t),u={};if(t.ray)for(;i>0;){u[(n+=a)+","+(s+=o)]={char:l||"*",className:t.className||"cell-ray"};let e={};e=Object.assign(e,u),c.addFrame(e),--i}this._setCurrAnim(c)}cellAnimation(e,t){const n=this._createAnimation(t),s={};n.slowDown=10,t.coord.forEach(e=>{s[e[0]+","+e[1]]={char:t.cellChar||"*",className:t.className||"cell-animation"}}),n.addFrame(s),this._setCurrAnim(n)}areaAnimation(e,t){const n=this._createAnimation(t),s=t.range,[r,a]=[t.cX,t.cY];for(let e=1;e<=s;e++){const s={};o.Geometry.getBoxAround(r,a,e).forEach(e=>{s[e[0]+","+e[1]]={char:t.cellChar||"*",className:t.className||"cell-animation"}}),n.addFrame(s)}this._setCurrAnim(n)}_createAnimation(e){const t=new l.Animation;return t.setLevel(e.level),t}updateEntity(e){this._enabled&&e.getList("Animation").forEach(t=>{const n=t.getArgs();n.dir?this.lineAnimation(e,n):n.missile?this.missileAnimation(e,n):n.cell?this.cellAnimation(e,n):r.default.isNullOrUndef([n.range,n.cX,n.cY])||this.areaAnimation(e,n)}),e.removeAll("Animation"),this.hasEntities()||(c.emitEvent(r.default.EVT_ANIMATION,{animation:this.currAnim}),this.currAnim=null)}_setCurrAnim(e){this.currAnim?this.currAnim.combine(e):this.currAnim=e}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Animation=class{constructor(){this.levelID=-1,this.numFrames=0,this.currFrame=0,this.slowDown=2,this.frames=[]}setLevel(e){this.levelID=e.getID()}addFrame(e){for(let t=0;t<this.slowDown;t++)++this.numFrames,this.frames.push(e)}nextFrame(){return this.frames[this.currFrame++]}hasFrames(){return this.currFrame<this.frames.length}combine(e){let t=0;for(;e.hasFrames();){const n=e.nextFrame();if(t<this.frames.length){const e=Object.keys(n);for(let s=0;s<e.length;s++){const r=e[s];this.frames[t][r]=n[r]}}else this.frames.push(n);++t}}hasCoord(e){const t=this.frames.length;for(let n=0;n<t;n++){const t=this.frames[n];for(const n in t)if(e[n])return!0}return!1}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=r(n(11)),l=n(12);t.SystemAreaEffects=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.AREA_EFFECTS,e,t),this.radRange=1}updateEntity(e){const t=e.getList("Flame");let n=!1,s=!1;e.has("Health")?t.forEach(t=>{const r=t.getDamageType(),o=new i.Damage(t.getDamage(),r),l=t.getSource();if(o.setSource(l),l.has("Created")){const e=l.get("Created").getCreator();o.setSourceActor(e)}e.add(o),e.remove(t),r===a.default.DMG.FIRE?n=!0:r===a.default.DMG.ICE&&(s=!0)}):e.removeAll("Flame"),n?this._createRadiationComps(e,"Heat","Fire"):s&&this._createRadiationComps(e,"Coldness","Ice flame")}_createRadiationComps(e,t,n){const s=e.getLevel().getMap(),r=e.getCell(),[a,o]=r.getXY();l.Geometry.getBoxAround(a,o,this.radRange).forEach(e=>{if(s.hasXY(e[0],e[1])){const r=s.getCell(e[0],e[1]);r.hasActors()&&r.getActors().forEach(e=>{e.getName()!==n&&e.add(new i[t])})}})}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=r(n(11)),l=n(20);t.SystemAttack=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.ATTACK,e,t)}updateEntity(e){e.getList("Attack").forEach(t=>{this.processAttackComp(e,t),e.remove(t)})}processAttackComp(e,t){const n=e,s=t.getTarget(),r=n.getName(),o=s.getName();if(s.has("Ethereal"))a.default.gameMsg({cell:n.getCell(),msg:"Attack of "+r+" passes through "+o});else{if(s.has("FirstStrike")){const e=`${o} seems to strike first.`;a.default.gameMsg({cell:s.getCell(),msg:e}),this.performAttack(s,n,o,r)}if(this.performAttack(n,s,r,o),s.has("CounterAttack")){const e=`${o} seems to counter attack.`;a.default.gameMsg({cell:s.getCell(),msg:e}),this.performAttack(s,n,o,r)}if(n.has("BiDirStrike")){const e=this.getBiDirTarget(n,s);if(e){const t=`${r} tries to hit double strike.`;a.default.gameMsg({msg:t,cell:n.getCell()});const s=e.getName();if(this.performAttack(n,e,r,s),e.has("CounterAttack")){const t=`${s} seems to counter attack.`;a.default.gameMsg({cell:e.getCell(),msg:t}),this.performAttack(e,n,s,r)}}}n.getBrain().getMemory().setLastAttacked(s)}}addAttackerBonus(e){return l.Brain.getEnemyCellsAround(e).length}addDefenderBonus(e){return l.Brain.getEnemyCellsAround(e).length}performAttack(e,t,n,s){if(t.has("Charm")&&this.attIsCharmed(e,t)){let n=`${e.getName()} is charmed by ${t.getName()} `;return n+=", and does not attack",void a.default.gameMsg({cell:e.getCell(),msg:n})}let r=a.default.getMeleeAttack(e);e.has("Attacker")&&(r+=this.addAttackerBonus(e));const l=this.getEntityDefense(t),c=r/(r+l),u=this.rng.getUniform();if(this.dbg(`hitChance is ${c}, threshold ${u}`),c>=u){const r=e.getDamage();r>0?(this.doDamage(e,t,r),t.has("Experience")&&o.SystemBase.addSkillsExp(e,"Melee",1)):a.default.gameMsg({cell:e.getCell,msg:n+" fails to hurt "+s}),this._applyAddOnHitComp(e,t)}else this.checkForShieldSkill(u,r,l,t),a.default.gameMsg({cell:e.getCell(),msg:n+" misses "+s});if(t.addEnemy(e),e.isPlayer()||t.isPlayer()){const n=new i.Event;n.setArgs({type:a.default.EVT_ACTOR_ATTACKED,cause:e}),t.add(n)}}getEntityDefense(e){if(e.has("Paralysis"))return 0;let t=0;return e.getDefense&&(t=e.getDefense(),e.has("Defender")&&(t+=this.addDefenderBonus(e))),t}doDamage(e,t,n){const s=new i.Damage(n,a.default.DMG.MELEE);s.setSource(e),t.add(s),a.default.gameWarn({cell:e.getCell(),msg:e.getName()+" hits "+t.getName()})}getBiDirTarget(e,t){const[n,s]=[e.getX(),e.getY()],[r,a]=[t.getX(),t.getY()],o=n+-1*(r-n),i=s+-1*(a-s),l=e.getLevel().getMap();if(l.hasXY(o,i)){const t=l.getCell(o,i);if(t.hasActors()){const n=t.getActors();for(let t=0;t<n.length;t++)if(e.isEnemy(n[t]))return n[t]}}return null}checkForShieldSkill(e,t,n,s){s.has("Skills")&&t/(t+(n-s.getShieldDefense()))>e&&o.SystemBase.addSkillsExp(s,"Shields",1)}attIsCharmed(e,t){const n=t.getList("Charm");let s=!1;return n.forEach(t=>{const n=t.getTargetActor(),r=t.getLevel(),o=e.getWillpower();let i=r/(r+o);n!==a.default.NO_TARGET&&n===e.getID()&&(i=r/(r+o)*2)>.8&&(i=.8),a.default.isSuccess(i)&&(s=!0)}),s}_applyAddOnHitComp(e,t){const n=e.getWeapon();if(n&&n.has){if(n.has("AddOnHit")){const s=n.get("AddOnHit");if(s.getOnAttackHit()){const n=s.getCompToAdd();o.SystemBase.addCompToEntAfterHit(n,t,e)}}}else if(n&&n.onAttackHit){const s=e;n.onAttackHit(t,s)}else{const n=e;if(n&&n.has("AddOnHit")){const e=n.get("AddOnHit");if(e.getOnAttackHit()){const s=e.getCompToAdd();o.SystemBase.addCompToEntAfterHit(s,t,n)}}}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=r(n(43)),i=n(16),l=n(18),c=n(21),u=n(162),h=n(99),d=r(n(11)),p=n(20),f=n(15),m=l.EventPool.getPool(),g=["Pickup","UseStairs","OpenDoor","UseItem","UseElement","Jump","Read","Rest","Give"];t.SystemBaseAction=class extends i.SystemBase{constructor(e,t){super(a.default.SYS.BASE_ACTION,e,t),this.compTypesAny=!0,this._dtable={Give:this._handleGive.bind(this),Jump:this._handleJump.bind(this),OpenDoor:this._handleOpenDoor.bind(this),Pickup:this._handlePickup.bind(this),Read:this._handleRead.bind(this),UseElement:this._handleUseElement.bind(this),UseItem:this._handleUseItem.bind(this),UseStairs:this._handleUseStairs.bind(this),Rest:this._handleRest.bind(this)}}updateEntity(e){g.forEach(t=>{e.has(t)&&(this._dtable[t](e),e.remove(t))})}_handleGive(e){const t=e.get("Give"),n=t.getGiveTarget(),s=t.getItem();if(n.isEnemy(e)){let t=`${n.getName()} refuses to take `;t+=`${s.getName()} from ${e.getName()}`,a.default.gameMsg({cell:e.getCell(),msg:t})}else if(e.getInvEq().removeItem(s)){const t=e.getInvEq().getRemovedItem();if(n.getInvEq().addItem(t),t.has("QuestTarget")&&n.has("QuestTarget")){const s={actor:n,item:t},r=t.get("QuestTarget");h.SystemQuest.addQuestEvent(e,r,"give",s)}let r=`${e.getName()} gives `;r+=`${s.getName()} to ${n.getName()}`,a.default.gameMsg({cell:e.getCell(),msg:r})}}_handlePickup(e){const[t,n]=[e.getX(),e.getY()],s=e.getLevel(),r=s.getMap().getCell(t,n);if(r.hasProp(a.default.TYPE_ITEM)){const o=r.getProp(a.default.TYPE_ITEM)[0];if(e.getInvEq().canCarryItem(o)){e.getInvEq().addItem(o);try{s.removeItem(o,t,n)}catch(t){let n=`Unable to remove item ${JSON.stringify(o)}\n`;n+=`Actor for pickup: ${e.getName()}`,a.default.err("System.BaseAction","handlePickup",n)}let i=o.getName();o.getCount()>1&&(i+=" x"+o.getCount());const l={msg:e.getName()+" picked up "+i,cell:r};if(a.default.gameMsg(l),this._checkForAutoEquip(e,o),o.has("QuestTarget")){const t=o.get("QuestTarget");h.SystemQuest.addQuestEvent(e,t,"get")}}else{const t={msg:e.getName()+" cannot carry more weight",cell:r};a.default.gameMsg(t)}}const o={type:a.default.EVT_ITEM_PICKED_UP};this._createEventComp(e,o)}_checkForAutoEquip(e,t){const n=e.getInvEq().getMissile();if(n&&n.equals(t)&&e.getInvEq().equipNItems(t,t.getCount())){const n=t.getNameWithCount();a.default.gameMsg({cell:e.getCell(),msg:`${e.getName()} equips ${n}`})}}_handleUseStairs(e){const t=e.getLevel(),n=e.getCell(),s=p.Brain.getActorsAround(e);if(t.useStairs(e)){e.isPlayer()&&e.getBrain().addMark();const r=e.getLevel();if(r.has("QuestTarget")){const t=new d.QuestTargetEvent;t.setEventType("goto"),t.setTargetComp(r.get("QuestTarget")),e.add(t)}if(m.emitEvent(a.default.EVT_LEVEL_CHANGED,{target:r,src:t,actor:e}),m.emitEvent(a.default.EVT_LEVEL_ENTERED,{actor:e,target:r}),s.length>0){const n=p.Brain.getBoxOfFreeCellsAround(e,1);for(;s.length>0&&n.length>0;){const o=s.pop(),i=n.pop();if(t.removeActor(o)){const[t,n]=[i.getX(),i.getY()];r.addActor(o,t,n);const s=o.getName();a.default.gameMsg(`${s} follows ${e.getName()}`)}else{const e=JSON.stringify(o);a.default.warn("System.BaseAction","_handleUseStairs","Could not remove the actor: "+e)}}}const o={type:a.default.EVT_ACTOR_USED_STAIRS,cell:n};this._createEventComp(e,o)}}_handleOpenDoor(e){const t=e.get("OpenDoor").getDoor(),[n,s]=t.getXY(),r=e.getLevel().getCell(n,s);let o="";const i=e.getName();t.has("Broken")?o="Door is broken and does not move at all!":t.canToggle()?r.hasItems()?o="Door is blocked by an item":r.hasActors()?o="Door is blocked by someone":t.isOpen()?(t.closeDoor(),o=`${i} closes a door.`):(t.openDoor(),o=`${i} opens a door.`):o=`${i} cannot toggle the door.`,""!==o&&a.default.gameMsg({cell:r,msg:o})}_handleUseItem(e){const t=e.get("UseItem"),n=t.getItem();if(n.has("Broken")){const t=`${n.getName()} cannot be used because it is broken`;return void a.default.gameMsg({cell:e.getCell(),msg:t})}if(n.has("OneShot"))if(1===n.getCount()){const e={item:n};m.emitEvent(a.default.EVT_DESTROY_ITEM,e)}else n.decrCount(1);else n.getCharges&&n.getCharges()>0&&n.setCharges(n.getCharges()-1);this._checkUseItemMsgEmit(e,t);const s=t.getEffect();if(s){const t=new d.Effects(s);e.add(t)}}_handleUseElement(e){const t=e.get("UseElement"),n=t.getElement();n.has("Broken")||n.onUse&&n.onUse(e),this._checkUseElementMsgEmit(e,t)}_handleJump(e){const t=e.get("Jump"),[n,s]=[t.getX(),t.getY()];let r=2;e.has("Jumper")&&(r=e.get("Jumper").getJumpRange());const a=e.getLevel().getMap(),[o,i]=e.getXY(),l=o+n*r,u=i+s*r;if(c.Path.getShortestActorPath(a,o,i,l,u,(e,t)=>{const n=a.getCell(e,t);if(n.hasActors()){const e=n.getActors();for(let t=0;t<e.length;t++)if(!e[t].has("Ethereal"))return!1}return f.Element.canJumpOver(n.getBaseElem().getType())}).length===r){const t=new d.Movement(l,u,e.getLevel());e.add(t)}}_handleRead(e){let t=e.get("Read").getReadTarget();if(!t){const n=e.getCell();if(n.hasItems()){const e=n.getItems().find(e=>"book"===e.getType());e&&(t=e)}}if(t){const n=t.getText(),s=new o.MenuInfoOnly;s.addPre(n);const r=t.getName();a.default.gameInfo(`The book "${r}" reads:`),e.getBrain().setSelectionObject&&e.getBrain().setSelectionObject(s)}else{const t=`${e.getName()} finds nothing interesting to read.`;a.default.gameMsg({cell:e.getCell(),msg:t})}if(t.has("QuestTarget")){const n=new d.QuestTargetEvent;n.setEventType("read"),n.setTargetComp(t.get("QuestTarget")),e.add(n)}}_handleRest(e){const t=e.getCell();if("bed"===t.getBaseElem().getType())if(0===p.Brain.getSeenHostiles(e).length){e.get("Health").addHP(1);const n=`${e.getName()} rests for a while in bed`;a.default.gameMsg({cell:t,msg:n})}else{const n=`${e.getName()} cannot rest with enemies around`;a.default.gameMsg({cell:t,msg:n})}}_createEventComp(e,t){const n=new d.Event;n.setArgs(t),e.add(n)}_checkUseItemMsgEmit(e,t){if(t.getUseType()===a.default.USE.DRINK){const e=t.getItem(),n=function(e,t){return e.target?u.SystemEffects.getTargetFromObj(e,t):e.getCell?e:null}(t.getTarget(),t.getTargetType()),s=n.getCell(),r=n.getName()+" drinks "+e.getName();a.default.gameMsg({cell:s,msg:r})}}_checkUseElementMsgEmit(e,t){const n=t.getElement(),s=n.getName(),r=e.getCell();let o="";n.has("Broken")?o=`${s} is broken, and cannot be used.`:t.getUseType()===a.default.USE.LEVER&&(o=`${e.getName()} toggles the lever`),o&&a.default.gameMsg({cell:r,msg:o})}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=n(99),l=r(n(11));t.SystemBattle=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.BATTLE,e,t),this.compTypesAny=!0}updateEntity(e){if(e.has("BattleOver")){const t=e.get("BattleOver");if(e.has("BattleExp")){const t=e.get("BattleExp").getData(),n=t.name,s=this._getBadgeForBattle(n,e);if(t.kill>0)if(o.SystemBase.addSkillsExp(e,"Battle",t.kill),s)s.updateData({kill:t.kill});else{const e="No badge found for battle";a.default.err("System.Battle","updateEntity",e)}if(t.isTraitor&&s.updateDate({status:"Traitor"}),s.isWon()){let t=null;e.has("Reputation")?t=e.get("Reputation"):(t=new l.Reputation,e.add(t)),t.addToFame(1)}e.remove("BattleExp");const r=e.getLevel();if(e.has("Quest")&&r.has("QuestTarget")){const t=e.get("QuestTarget"),n={isWon:s.isWon()};i.SystemQuest.addQuestEvent(e,t,"battle",n)}}e.remove(t)}else if(e.has("BattleOrder")){const t=e.get("BattleOrder");this._emitMsg(e,t),e.remove(t)}}_getBadgeForBattle(e,t){return t.getList("BattleBadge").find(t=>t.getData().name===e)}_emitMsg(e,t){const n=t.getArgs().srcActor.getName(),s=e.getCell(),r=`${n} shouts a command into your direction.`;a.default.gameMsg({msg:r,cell:s})}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(16),o=n(180),i=n(99),l=Object.freeze([]);function c(e){return{quests:"Is anyone looking for help here?",places:"Do you know what places are nearby?",shops:"Is there a place for trading?",people:"What can you tell me about people here?",world:"Do you have any rumors from faraway lands?"}[e]}t.SystemChat=class extends a.SystemBase{constructor(e,t){super(r.default.SYS.CHAT,e,t)}updateEntity(e){const t=e.get("Chat").getArgs().dir,n=this.getActorsInDirection(e,t);let s=null;if(n.forEach(t=>{if(t.has("Trainer"))s=this.getChatObject(e,t,"Trainer");else if(t.has("QuestGiver"))s=this.getChatObject(e,t,"QuestGiver");else{s=this.getGenericChatObject(e,t);const n=`You chat with ${t.getName()} for a while.`;r.default.gameMsg({cell:e.getCell(),msg:n})}t.has("QuestTarget")&&this.addQuestTargetItems(e,t,s),this.addQuestSpecificItems(e,t,s),e.getLevel().has("Lore")&&(console.log("Level has some lore"),this.addLoreItems(e,t,s))}),s){const t=e.getBrain(),n=s.getSelectionObject();t.setSelectionObject(n)}e.remove("Chat")}getActorsInDirection(e,t){const[n,s]=[t[0],t[1]],a=e.getX()+n,o=e.getY()+s,i=e.getLevel().getMap();if(i.hasXY(a,o)){const e=i.getCell(a,o);if(e.hasActors())return e.getActors();{const t="There is no one to talk to.";r.default.gameMsg({cell:e,msg:t})}}else{const t="There is no one to talk to.";r.default.gameMsg({cell:e.getCell(),msg:t})}return l}getChatObject(e,t,n){const s=t.get(n).getChatObj();if(s.setTarget(e),s.getSelectionObject())return s;{const e=t.getName();r.default.err("SystemChat","setChatObject",`Null/undef selectObj with type ${n}, src: ${e}`)}return null}getGenericChatObject(e,t){const n=new o.Chat.ChatBase,s=t.getName();return n.pre=`${s} greets you. What do you say?`,n}addQuestTargetItems(e,t,n){const s=t.get("QuestTarget");if("escort"===s.getTargetType()){const r=t.get("QuestEscortTarget");r.getEscortTo().getID()!==e.getLevel().getID()?n.add({name:r.getQuestion(),option:()=>{}}):n.add({name:"I have escorted you safely to correct place now",option:()=>{const n={src:t};i.SystemQuest.addQuestEvent(e,s,"escort",n)}})}}addQuestSpecificItems(e,t,n){if(e.has("Quest")){if(e.get("Quest").getQuestTargets().forEach(e=>{this.addQuestTargetToChat(e,t,n)}),t.has("QuestInfo")){const s=t.get("QuestInfo"),r=t.get("QuestTarget");n.add({name:s.getQuestion(),option:()=>{const n={info:s,src:t};i.SystemQuest.addQuestEvent(e,r,"listen",n)}})}if(e.has("QuestInfo")&&t.has("QuestTarget")){const s=t.get("QuestTarget"),r=e.getList("QuestInfo"),a=t=>{i.SystemQuest.addQuestEvent(e,s,"report",{info:t})};r.forEach(e=>{n.add({name:"Tell about "+e.getInfo(),option:a.bind(null,e)})})}t.has("QuestReport")&&n.add({name:"Tell about quest being completed",option:()=>{i.SystemQuest.addQuestEvent(e,t.get("QuestTarget"),"report")}})}}addQuestTargetToChat(e,t,n){const s=t.getName(),a=e.name;let o=null;const i=e.id,l=t.getBrain().getMemory();if(l.hasSeen(i)){o=n.getSelectionObject();const{x:e,y:c}=l.getLastSeen(i),u=r.default.getTextualDxDy(t,[e,c]);let h=`${s} says: I know where ${a} is.`;h+=` I saw ${a} ${u} from here.`,r.default.gameInfo(h)}""!==a&&(o||(o=(()=>{const e=`${s} says: I know not where ${a} is`;r.default.gameInfo(e)})),n.add({name:`Do you know where is ${a}`,option:o}))}addLoreItems(e,t,n){const s=t.getLevel().get("Lore").getTopics();Object.keys(s).forEach(t=>{n.add({name:c(t),option:()=>{const n=this.rng.arrayGetRand(s[t]);r.default.gameInfo({cell:e.getCell(),msg:n})}})})}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(16);t.SystemCommunication=class extends a.SystemBase{constructor(e,t){super("Communication",e,t),this._msgFunc={Enemies:this.processEnemies.bind(this),Shout:this.processShout.bind(this)}}updateEntity(e){const t=e.get("Communication").getMsg();for(let n=0;n<t.length;n++)this.processMessage(e,t[n]);e.remove("Communication")}processMessage(e,t){this._msgFunc.hasOwnProperty(t.type)?this._msgFunc[t.type](e,t):r.default.err("CommunicationSystem","processMessage","No function for msg type |"+t.type+"| in dtable.")}processEnemies(e,t){const n=t.enemies,s=t.src.getName();for(let t=0;t<n.length;t++)e.addEnemy(n[t]);const a={cell:e.getCell(),msg:`${s} seems to communicate with ${e.getName()}`};r.default.gameInfo(a)}processShout(e,t){const n=t.shout,s=t.src.getName(),a={cell:t.src.getCell(),msg:`${s} shouts ${n}`};r.default.gameInfo(a)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=r(n(11));t.SystemDamage=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.DAMAGE,e,t)}processDamageComp(e,t){const n=e.get("Health");if(n){let s=this._getDamageModified(e,t);if(s<=0){s=0;const t="Attack doesn't penetrate protection of "+e.getName();a.default.gameMsg({msg:t,cell:e.getCell()})}else if(this._applyAddOnHitComp(e,t),n.decrHP(s),this.debugEnabled){const t=n.getMaxHP(),r=`(${s}),(${n.getHP()}/${t})`;a.default.gameDanger({msg:r,cell:e.getCell()})}const r=this._getUltimateDmgSource(t);if(r&&e.getID()!==r.getID()&&a.default.isActor(r)&&e.addEnemy(r),n.isDead()&&!e.has("Dead")&&!e.has("DeathEvent")){const n=new i.DeathEvent;if(n.setSource(r),t.isType(a.default.DMG.POISON)){const t=e.getName()+" dies horribly of poisoning";n.setMsg(t)}e.add(n)}if(r&&a.default.isActor(r)&&(r.isPlayer()||e.isPlayer())&&!a.default.isNullOrUndef([r,e])){const t=new i.Event;t.setArgs({type:a.default.EVT_ACTOR_DAMAGED,cause:r}),e.add(t),e.has("QuestTarget")&&this.checkForDamagedQuestEvent(e,r)}}}checkForDamagedQuestEvent(e,t){if("damage"===e.get("QuestTarget").getTargetType()){const n=new i.QuestTargetEvent;n.setEventType("damage"),n.setArgs({target:e}),n.setTargetComp(e.get("QuestTarget")),t.add(n)}}_getUltimateDmgSource(e){let t=e.getSourceActor();return t||(t=e.getSource()),t&&t.has&&t.has("Created")?t=t.get("Created").getCreator():t&&!t.has&&(console.log("Warning. No damageSrc.has():",t),a.default.err("System.Damage","_getUltimateDmgSource","No damageSrc.has()")),t}_getDamageModified(e,t){const n=t.getDamageType();let s=t.getSourceActor();s||(s=t.getSource());const r=this._getDmgAfterWeaknessAndResistance(e,t),o=e.getCell();if(n===a.default.DMG.POISON){const t="Poison is gnawing inside "+e.getName();return a.default.gameDanger({cell:o,msg:t}),r}if(n===a.default.DMG.HUNGER)return r;if(n===a.default.DMG.FIRE){const t=`Fire is burning ${e.getName()}.`;return a.default.gameDanger({cell:o,msg:t}),r}if(n===a.default.DMG.ICE){const t=`Ice is freezing ${e.getName()}.`;return a.default.gameDanger({cell:o,msg:t}),r}if(n===a.default.DMG.COLD){const t=`${e.getName()} is extremely hypothermic`;return a.default.gameInfo({cell:o,msg:t}),r}const i=t.getDamageCateg();if(i===a.default.DMG.MAGIC)return r;if(i===a.default.DMG.DIRECT)return r;if(this.isProtectionBypassed(e,s)){const t=`${s.getName()} hits ${e.getName()} through armor.`;return a.default.gameDanger({cell:o,msg:t}),r}return r-(e.getEquipProtection()+e.get("Combat").getProtection())}_getDmgAfterWeaknessAndResistance(e,t){const n=e.getName();let s=t.getDamage();if(e.has("Weakness")&&e.getList("Weakness").forEach(n=>{if(this.effectMatches(t,n))switch(n.getLevel()){case a.default.WEAKNESS.MINOR:s=Math.round(1.25*s);break;case a.default.WEAKNESS.MEDIUM:s=Math.round(1.5*s);break;case a.default.WEAKNESS.SEVERE:s*=2;break;case a.default.WEAKNESS.FATAL:s=e.get("Health").getMaxHP()}}),e.has("Resistance")){let r="";e.getList("Resistance").forEach(n=>{if(this.effectMatches(t,n))switch(n.getLevel()){case a.default.RESISTANCE.MINOR:s=Math.round(s/1.25),r+=" resists the attack slighty";break;case a.default.RESISTANCE.MEDIUM:s=Math.round(s/1.5),r+=" resists the attack";break;case a.default.RESISTANCE.STRONG:s=Math.round(s/2),r+=" resists the attack strongly";break;case a.default.RESISTANCE.IMMUNITY:s=0,r+=" is immune against the attack";break;case a.default.RESISTANCE.ABSORB:e.get("Health").addHP(s),r+=" absorbs the power of the attack"}}),""!==r&&(r=n+" "+r,a.default.gameMsg({msg:r,cell:e.getCell()}))}return s}effectMatches(e,t){const n=t.getEffect(),s=e.getDamageType(),r=e.getDamageCateg();return n===s||n===r}isProtectionBypassed(e,t){const n=this.rng.getUniform();return t&&!t.has&&(console.log("src is not entity:",t),console.log("With entity:",e),a.default.err("System.Damage","isProtectionBypassed","No src.has()")),t&&t.has("BypassProtection")?n<=t.get("BypassProtection").getChance():n<=a.default.PROT_BYPASS_CHANCE}_applyAddOnHitComp(e,t){const n=t.getWeapon();if(n&&n.has){if(n.has("AddOnHit")){const s=n.get("AddOnHit").getCompToAdd();o.SystemBase.addCompToEntAfterHit(s,e,t.getSource())}}else if(n&&n.onHit){const s=t.getSource();n.onHit&&n.onHit(e,s)}else{const n=t.getSource();if(n&&n.has("AddOnHit")){const t=n.get("AddOnHit").getCompToAdd();o.SystemBase.addCompToEntAfterHit(t,e,n)}}}updateEntity(e){e.getList("Damage").forEach(t=>{this.processDamageComp(e,t),e.remove(t)})}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=n(18),l=r(n(11)),c=r(n(34)),u=n(14),h=a.default.NO_DAMAGE_SRC,d=i.EventPool.getPool();t.SystemDeath=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.DEATH,e,t)}updateEntity(e){const t=e.get("DeathEvent"),n=t.getSource();if(e.has("Loot")){const t=e.getCell();e.get("Loot").dropLoot(t)}this._dropInvAndEq(e),this._killActor(n,e,t),e.remove(t)}_killActor(e,t,n){const s=t.getLevel(),r=t.getCell(),[o,i]=t.getXY();if(t.add(new l.Dead),s.removeActor(t)){const u=t.getName();t.has("Experience")&&this._giveExpToSource(e,t);const p=n.getMsg();p&&a.default.gameDanger({cell:r,msg:p});let f="killed";t.has("NonSentient")&&(f="destroyed");let m=u+" was "+f;e!==h&&(m+=" by "+e.getName()),a.default.gameDanger({cell:r,msg:m}),d.emitEvent(a.default.EVT_ACTOR_KILLED,{actor:t});const g=new l.Event;if(g.setArgs({type:a.default.EVT_ACTOR_KILLED,cause:e}),t.add(g),t.has("Corporeal")){const n=new c.Corpse(u+" corpse");n.setActorName(t.get("Named").getBaseName()),this._cloneComponentsToCorpse(t,n);const r=a.default.getCssClass(a.default.TYPE_ACTOR,u);if(a.default.addCellStyle(a.default.TYPE_ITEM,n.getName(),r),s.addItem(n,o,i),t.has("QuestTarget")){const s=new l.QuestTargetEvent;s.setEventType("kill"),s.setArgs({corpse:n}),s.setTargetComp(t.get("QuestTarget")),e.add(s)}this._addSpawnableUndeadActor(t)}this._cleanUpComponents(t)}else a.default.err("System.Damage","killActor","Couldn't remove actor")}_giveExpToSource(e,t){if(console.log("_giveExpToSource att is ",e),e!==h&&!e.has("Dead")){const n=t.get("Experience").getExpLevel(),s=t.get("Experience").getDanger(),r=new l.ExpPoints(n+s);e.add(r),e.has("InBattle")&&(this._giveBattleExpToSource(e),t.has("InBattle")&&this._checkIfKillerIsTraitor(e,t))}}_giveBattleExpToSource(e){if(!e.has("BattleExp")){const t=e.get("InBattle").getData();if(t){const n=t.name,s=new l.BattleExp;s.setData({kill:0,name:n}),e.add(s)}else{const t=`Actor: ${JSON.stringify(e)}`;a.default.err("System.Damage","_giveBattleExpToSource",`InBattle data is null. Actor: ${t}`)}}e.get("BattleExp").getData().kill+=1}_checkIfKillerIsTraitor(e,t){const n=e.get("InBattle").getData(),s=t.get("InBattle").getData();n.army===s.army&&(n.isTraitor=!0)}_dropInvAndEq(e){const[t,n]=e.getXY();if(!e.getInvEq)return;const s=e.getInvEq(),r=s.getInventory().getItems(),a=e.getLevel();r.forEach(e=>{if(s.removeNItems(e,e.getCount())){const e=s.getRemovedItem();a.addItem(e,t,n)}}),s.getEquipment().getItems().forEach(e=>{a.addItem(e,t,n)})}_cleanUpComponents(e){["Coldness","Expiration","Fading"].forEach(t=>{e.getList(t).forEach(t=>{"function"==typeof t.cleanup&&t.cleanup(),e.remove(t)})})}_cloneComponentsToCorpse(e,t){["Named","Health","Stats","Combat","Experience"].forEach(n=>{const s=e.get(n).clone();t.add(s)});const n=["Undead"];e.hasAny(n)&&n.forEach(n=>{if(e.has(n)){const s=e.get(n).clone();t.add(s)}})}_addSpawnableUndeadActor(e){if("undead"===e.getType()||e.has("Undead"))return;const t=e.get("Named").getBaseName(),n=u.ObjectShell.getParser(),s=n.dbGet({name:t,categ:a.default.TYPE_ACTOR});if(s){const e=s,t=JSON.parse(JSON.stringify(e));t.type="undead",t.addComp?Array.isArray(t.addComp)?t.addComp.push("Undead"):t.addComp=[t.addComp,"Undead"]:t.addComp=["Undead"],t.name="undead "+t.name,n.parseObjShell(a.default.TYPE_ACTOR,t),console.log("Added new actor ",t.name,"to parser")}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=r(n(11));t.SystemDrainStats=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.DRAIN_STATS,e,t)}updateEntity(e){e.getList("DrainStat").forEach(t=>{this.processDrainComp(e,t),e.remove(t)})}processDrainComp(e,t){if(t.applyComp()){let n=t.getDrainMsg();""!==n&&(n=t.getSource().getName()+" "+n+" "+e.getName(),a.default.gameMsg({cell:e.getCell(),msg:n}))}if(e.remove(t),e.has("Health")&&e.get("Health").isDead()&&!e.has("Dead")&&!e.has("DeathEvent")){const n=new i.DeathEvent;n.setSource(t.getSource());let s=e.getName()+" is drained out of life";s+=" permanently",n.setMsg(s),e.add(n)}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=r(n(11)),l={Entrapped:{Attack:"cannot attack while trapped",Movement:"cannot move while trapped",SpellCast:"cannot cast spells while trapped"},Paralysis:{Attack:"cannot attack under paralysis",Movement:"cannot move under paralysis",SpellCast:"cannot cast spells under paralysis"},Stun:{Attack:"is too stunned to attack",Movement:"is stunned, and stumbles",SpellCast:"is too stunned to cast spells"}};t.SystemDisability=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.DISABILITY,e,t),this.compTypesAny=!0,this._dispatchTable={Entrapped:{Attack:e=>{e.remove("Attack"),this._emitMsg("Paralysis","Attack",e)},Movement:e=>{this._handleEntrapped(e)},SpellCast:e=>{e.remove("SpellCast"),this._emitMsg("Entrapped","SpellCast",e)},UseStairs:e=>{e.remove("UseStairs"),this._emitMsg("Entrapped","UseStairs",e)}},Fear:{Attack:e=>{this._handleFear(e,"Attack")},Movement:e=>{this._handleFear(e,"Movement")}},Paralysis:{Attack:e=>{e.remove("Attack"),this._emitMsg("Paralysis","Attack",e)},Movement:e=>{e.remove("Movement"),this._emitMsg("Paralysis","Movement",e)},SpellCast:e=>{e.remove("SpellCast"),this._emitMsg("Paralysis","SpellCast",e)},UseStairs:e=>{e.remove("UseStairs"),this._emitMsg("Paralysis","Movement",e)}},Stun:{Attack:e=>{e.remove("Attack"),this._emitMsg("Stun","Attack",e)},Movement:e=>{const t=this.rng.getRandDir(),[n,s]=a.default.newXYFromDir(t,e);if(e.remove("Movement"),e.getLevel().getMap().hasXY(n,s)){const t=new i.Movement(n,s,e.getLevel());e.add(t)}this._emitMsg("Stun","Movement",e)},SpellCast:e=>{e.remove("SpellCast"),this._emitMsg("Stun","SpellCast",e)},UseStairs:e=>{a.default.isSuccess(.5)&&(e.remove("UseStairs"),this._emitMsg("Stun","Movement",e))}}},this._compOrder=["Paralysis","Entrapped","Stun"],this._actComp=["Attack","Movement","SpellCast"]}updateEntity(e){this._compOrder.forEach(t=>{e.has(t)&&this._actComp.forEach(n=>{e.has(n)&&this._dispatchTable[t][n](e)})})}_emitMsg(e,t,n){const s=n.getCell(),r=`${n.getName()} ${l[e][t]}`;a.default.gameMsg({cell:s,msg:r})}_handleEntrapped(e){const t=e.getCell(),n=t.getElements();if(!n)return void e.removeAll("Entrapped");const s=n.filter(e=>e.has("Entrapping"));let r=0;s.forEach(e=>{r+=e.get("Entrapping").getDifficulty()});const o=e.getStrength(),i=e.getAgility(),l=(o+i)/(o+i+r);if(a.default.isSuccess(l)){const n=e.getLevel();s.forEach(e=>{e.get("Entrapping").getDestroyOnMove()&&n.removeElement(e,e.getX(),e.getY())}),e.removeAll("Entrapped");const r=`${e.getName()} breaks free from traps!`;a.default.gameMsg({cell:t,msg:r})}else{e.remove("Movement");const n=`${e.getName()} is trapped and cannot move!`;a.default.gameMsg({cell:t,msg:n})}}_handleFear(e,t){const n=e.getList("Fear"),s=e.getBrain().getSeenEnemies();let r=0,o=null;if(n.forEach(e=>{const t=e.getTarget(),n=e.getFearLevel(),a=s.find(e=>e.getID()===t);a&&r<n&&(r=n,o=a)}),o){const n=e.getWillpower(),s=r/(n+r);if(a.default.isSuccess(s)){e.remove(t);const n=a.default.dXdY(o.getXY(),e.getXY()),[s,r]=a.default.newXYFromDir(n,e.getXY());if(e.getLevel().getMap().isPassable()){const t=new i.Movement(s,r,e.getLevel());e.add(t);const n=`${e.getName} panics, and runs away from ${o.getName()}`;a.default.gameMsg({cell:e.getCell(),msg:n})}else{const t=`${e.getName} is paralysed by fear!`;a.default.gameMsg({cell:e.getCell(),msg:t})}}}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=r(n(25));t.SystemEquip=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.EQUIP,e,t)}updateEntity(e){const t=e.get("Equip");t.getIsRemove()?this.unequipItem(e,t.getArgs()):this.equipItem(e,t.getArgs()),e.remove(t)}unequipItem(e,t){const n=t.slot,s=t.slotNumber,r=e.getInvEq();let a=!1,o=`Failed to remove item from slot ${n}.`;"missile"===n?null!==r.getEquipment().getItem("missile")&&r.unequipItem(n,t.count)&&(a=!0):r.unequipItem(n,1,s)&&(a=!0),t.hasOwnProperty("callback")&&(a&&(o=`Unequipping from ${n} succeeded!`),t.callback({msg:o,result:a}));const i=r.getEquipment().getUnequipped(n,s);a&&i.has("AddOnEquip")&&i.getList("AddOnEquip").forEach(t=>{this.handleAddOnEquip(e,t,!1)})}equipItem(e,t){const n=e.getInvEq(),s=t.item;let r=!1,a=`Failed to equip ${s.getName()}`;s.getType().match(/^(missile|ammo)$/)?n.equipNItems(s,t.count)&&(r=!0):n.equipItem(s)&&(r=!0),t.hasOwnProperty("callback")&&(r&&(a=`Equipping ${s.getName()} succeeded!`),t.callback({msg:a,result:r})),r&&s.has("AddOnEquip")&&s.getList("AddOnEquip").forEach(t=>{this.handleAddOnEquip(e,t)})}handleAddOnEquip(e,t,n=!0){if(n){const n=t.getComp();if(n.setSource&&n.setSource(t.getEntity()),n.is("Duration")){const t=n.rollDuration(),s=n.getExpireMsg();i.addToExpirationComp(e,n,t,s)}else e.add(n);t.setAddedToActor(!0)}else{const n=t.getComp();if("number"==typeof n){const s=e.get(n);e.remove(n),t.setComp(s),t.setAddedToActor(!1)}else a.default.err("System.Equip","handleAddOnEquip","Expected comp ID number. Got: "+n)}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(16),o=n(12);t.SystemEvents=class extends a.SystemBase{constructor(e,t){super(r.default.SYS.EVENTS,e,t),this.eventRadiusPerID={},this.eventRadius=10,this._dtable={[r.default.EVT_ACTOR_KILLED]:this._handleActorKilled.bind(this),[r.default.EVT_ITEM_PICKED_UP]:this._handleItemPickedUp.bind(this),[r.default.EVT_ACTOR_DAMAGED]:this._handleActorDamaged.bind(this),[r.default.EVT_ACTOR_ATTACKED]:this._handleActorAttacked.bind(this),[r.default.EVT_ACTOR_USED_STAIRS]:this._handleActorUsedStairs.bind(this)}}updateEntity(e){e.getList("Event").forEach(t=>{const n=t.getArgs(),{type:s}=n;let r=e.getCell();n.cell&&(r=n.cell);const a=this._getEventRadius(e),[i,l]=[r.getX(),r.getY()],c=o.Geometry.getBoxAround(i,l,a,!0);e.getLevel().getMap().getCellsWithCoord(c).forEach(n=>{const r=n.getActors();r&&r.forEach(n=>{!n.isPlayer()&&n.has("Perception")&&n.getBrain().getSeenCells().find(e=>e.getX()===i&&e.getY()===l)&&this._dtable[s](e,t,n)})}),e.remove(t)})}addLevel(e,t){this.eventRadiusPerID[e.getID()]=t}removeLevel(e){delete this.eventRadiusPerID[e.getID()]}_getEventRadius(e){const t=e.getLevel().getID();return this.eventRadiusPerID.hasOwnProperty(t)?this.eventRadiusPerID[t]:this.eventRadius}_handleActorKilled(e,t,n){if(e.isPlayer()){const s=t.getArgs().cause;if(s){const t=n.getName(),a=e.getName(),o=`${t} saw ${s.getName()} killing ${a}`;r.default.gameMsg({cell:e.getCell,msg:o})}}}_handleItemPickedUp(e,t,n){if(n.getID()!==e.getID()&&!n.isEnemy(e)){const t=e.getCell(),s=`${n.getName()} saw ${e.getName()} picking up an item.`;r.default.gameMsg({msg:s,cell:t})}}_handleActorDamaged(e,t,n){if(e.getID()!==n.getID()){const s=t.getArgs(),{cause:r}=s;this._addActorAsEnemy(r,e,n)}}_handleActorAttacked(e,t,n){if(e.getID()!==n.getID()){const s=t.getArgs(),{cause:r}=s;this._addActorAsEnemy(r,e,n)}}_handleActorUsedStairs(e,t,n){r.default.gameMsg(`${n.getName()} saw ${e.getName()} using stairs.`)}_addActorAsEnemy(e,t,n){e.getID()!==t.getID()&&(t.getType()===n.getType()?n.isEnemy(t)||t.isEnemy(n)||(n.isFriend(e)?(this._emitMsg("seems to dislike action",e,t,n),n.getBrain().getMemory().removeFriend(e)):(this._emitMsg("shows hatred against action",e,t,n),n.addEnemy(e))):n.isFriend(t)&&(this._emitMsg("shows hatred against action",e,t,n),n.addEnemy(e)))}_emitMsg(e,t,n,s){const a=t.getName(),o=n.getCell();let i=`${s.getName()} ${e} of ${a} `;i+=` towards ${n.getName()}`,r.default.gameMsg({cell:o,msg:i})}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(16),o=n(64);t.SystemExpPoints=class extends a.SystemBase{constructor(e,t){super(r.default.SYS.EXP_POINTS,e,t)}updateEntity(e){e.getList("ExpPoints").forEach(t=>{const n=e.get("Experience");let s=!0,a=n.getExp();for(a+=t.getExpPoints(),n.setExp(a);s;){const t=n.getExpLevel()+1;if(a>=r.default.getExpRequired(t)){r.default.levelUpActor(e,t);const n=e.getName();if(e.isPlayer()&&e.has("ActorClass")){const n=e.get("ActorClass").getClass(),s=o.ActorClass.getLevelUpObject(t,n);e.getBrain().setSelectionObject(s)}else{const t=`${n} is more experienced now.`;r.default.gameSuccess({msg:t,cell:e.getCell()})}s=!0}else s=!1}e.remove(t)})}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=r(n(11));t.SystemHunger=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.HUNGER,e,t)}updateEntity(e){const t=e.get("Hunger"),n=e.get("Action");if(t.decrEnergy(n.getEnergy()),n.resetEnergy(),t.isStarving()&&e.has("Health")&&a.default.isSuccess(a.default.HUNGER_PROB)){const t=new i.Damage(a.default.HUNGER_DMG,a.default.DMG.HUNGER);e.add(t),a.default.gameWarn(e.getName()+" is starving!")}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=r(n(11));t.SystemMissile=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.MISSILE,e,t),this.criticalShot=a.default.MISSILE_CRITICAL_SHOT}updateEntity(e){const t=e.get("Missile"),n=t.getSource(),s=t.getLevel().getMap(),r=t.getTargetX(),i=t.getTargetY();let l=null;s.hasXY(r,i)&&(l=s.getCell(r,i));const c=this._formatFiredMsg(e,n);if(l&&l.hasProp("actors")){const e=l.getSentientActors()[0];n.getBrain().getMemory().setLastAttacked(e)}for(;t.isFlying()&&!t.inTarget()&&t.hasRange();){t.next();const r=t.getX(),i=t.getY();let l=null;s.hasXY(r,i)&&(l=s.getCell(r,i));let u="";if(l)if(l.hasActors()||l.isPassableByAir())if(l.hasProp("actors")){const s=l.getActors()[0];if(this.targetWasHit(e,s,t)){this.finishMissileFlight(e,t,l),"function"==typeof t.onHit&&t.onHit(s);const r=this._addDamageToActor(s,t);a.default.debug(this,"Hit an actor"),u=`${c} ${r} ${s.getName()}`,s.has("Experience")&&("missile"===e.getType()?o.SystemBase.addSkillsExp(n,"Throwing",1):"ammo"===e.getType()&&o.SystemBase.addSkillsExp(n,"Archery",1)),a.default.gameWarn({cell:l,msg:u}),u=""}else if(t.inTarget()){this.finishMissileFlight(e,t,l),a.default.debug(this,"In target cell, and missed an entity");const n=l.getFirstActor();u=n?c+" misses "+n.getName():c+" misses the target"}else t.hasRange()||(this.finishMissileFlight(e,t,l),a.default.debug(this,"Missile out of range. Missed entity."),u=e.getName()+" does not reach the target")}else t.inTarget()?(this.finishMissileFlight(e,t,l),a.default.debug(this,"In target cell but no hits"),u=e.getName()+" doesn't hit anything"):t.hasRange()||(this.finishMissileFlight(e,t,l),a.default.debug(this,"Missile out of range. Hit nothing."),u=e.getName()+" doesn't hit anything");else{t.prev();const n=t.getX(),r=t.getY(),o=s.getCell(n,r);this.finishMissileFlight(e,t,o),a.default.debug(this,"Stopped missile to wall"),u=c+" thuds to an obstacle"}else{t.prev();const n=t.getX(),r=t.getY(),a=s.getCell(n,r);this.finishMissileFlight(e,t,a),u=c+" disappears"}u.length>0&&a.default.gameMsg({cell:l,msg:u})}}_addDamageToActor(e,t){let n="hits";const s=t.getDamage(),r=new i.Damage(s,a.default.DMG.MISSILE),o=t.getSource();r.setSource(o);let l=t.getDamage();return o.has("CriticalShot")&&a.default.isSuccess(this.criticalShot)&&(l*=2,n="critically hits"),r.setDamage(l),e.add(r),n}finishMissileFlight(e,t,n){t.stopMissile(),e.remove(t);const s=t.getLevel();let r=!0;if(t.destroyItem||(r=!1,e.has("Indestructible")||(t.destroyItem=this._isItemDestroyed(e))),t.destroyItem){if(!r){const t=`${e.getName()} is destroyed!`;a.default.gameMsg({cell:n,msg:t})}}else{let t=!1;n.hasItems()&&n.getItems().forEach(n=>{t||(t=a.default.addStackedItems(n,e))}),t||s.addItem(e,n.getX(),n.getY())}const o={missile:t,item:e,to:[n.getX(),n.getY()],level:s},l=new i.Animation(o);e.add(l)}_isItemDestroyed(e){const t=e.getName(),n=this.rng.getUniform();return e.has("Ammo")?/(magic|ruby|permaice)/i.test(t)?n>.95:/(iron|steel)/i.test(t)?n>.9:n>.85:/rock/i.test(t)?n>.95:/(magic|ruby|permaice)/i.test(t)?n>.97:n>.95}_formatFiredMsg(e,t){let n="thrown";return e.has("Ammo")&&(n="shot"),`${e.getName()} ${n} by ${t.getName()}`}targetWasHit(e,t,n){if(t.has("Ethereal"))return!1;const s=n.getSource();if(s.has("ThroughShot")&&!n.inTarget())return!1;const r="missile"===e.getType();let i=n.getAttack();s.has("Skills")&&(i+=r?s.get("Skills").getLevel("Throwing"):s.get("Skills").getLevel("Archery"));let l=t.getDefense();t.has("Skills")&&(l+=t.get("Skills").getLevel("Dodge"));const c=i/(i+l);return a.default.isSuccess(c)?!t.has("RangedEvasion")||a.default.isSuccess(.5):(o.SystemBase.addSkillsExp(t,"Dodge",1),!1)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=r(n(11)),l=n(19),c=n(17)("bitn:System.Movement"),{addSkillsExp:u}=o.SystemBase,h={"light snow":l.ELEM.SNOW_LIGHT_TRACKS,snow:l.ELEM.SNOW_TRACKS,"deep snow":l.ELEM.SNOW_DEEP_TRACKS},d={"deep snow":"snow","deep snow with tracks":"snow","light snow":"snow","light snow with tracks":"snow","snow with tracks":"snow"};t.SystemMovement=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.MOVEMENT,e,t),this.somethingSpecial=["QuestTarget"],this.climbRe=/highrock/,this._bonuses={water:{dontApplyTo:["Flying","Amphibious"],mods:[this.speedPenalty(.5),this.defensePenalty(.5),{value:-5,srcComp:"Combat",srcFunc:"getAttack",targetComp:"CombatMods",targetFunc:"setAttack"}]},grass:{mods:[this.speedPenalty(.1)]},bridge:{mods:[this.defensePenalty(.5)]},stone:{mods:[this.speedPenalty(.25)]},snow:{dontApplyTo:["Flying","SnowWalk"],mods:[this.speedPenalty(.25)]}}}speedPenalty(e){return{value:-e,srcComp:"Stats",srcFunc:"getSpeed",targetComp:"StatsMods",targetFunc:"setSpeed"}}defensePenalty(e){return{value:-e,srcComp:"Combat",srcFunc:"getDefense",targetComp:"CombatMods",targetFunc:"setDefense"}}checkMessageEmits(e,t){if(t.hasProp(a.default.TYPE_ELEM)){if(t.hasStairs()){const e=t.getStairs().getTargetLevel();let n="You see stairs here";e.getParent()&&(n+=`. They seem to be leading to ${a.default.formatLocationName(e)}`),a.default.gameMsg(n)}else if(t.hasPassage()){const e=t.getPassage().getTargetLevel();let n=`You see a passage to ${a.default.getCardinalDirection(e,t)} here.`;e.getParent()&&(n+=`. It seems to be leading to ${a.default.formatLocationName(e)}`),a.default.gameMsg(n)}else if(t.hasConnection()){const e=t.getConnection().getTargetLevel();let n="You see an entrance here";e.getParent()&&(n+=`. It seems to be leading to ${a.default.formatLocationName(e)}`),a.default.gameMsg(n)}t.hasPropType("lever")&&a.default.gameMsg("There is a lever on the floor"),!e.hasShop()&&t.hasShop()?t.getShop().isAbandoned()?a.default.gameMsg("This shop seems to be abandoned"):a.default.gameMsg("You have entered a shop."):t.hasShop()&&(t.getShop().isAbandoned()||a.default.gameMsg("You can drop items to sell them here."))}if(t.hasItems()){const e=t.getItems(),n=e[0];let s=n.getName();n.getCount()>1&&(s=`${s} (x${n.getCount()})`),e.length>1?a.default.gameMsg("There are several items here. "+`You see ${s} on top`):a.default.gameMsg(`You see ${s}`+" on the floor"),n.has("Unpaid")&&(n.getCount()>1?a.default.gameMsg("They are for sale"):a.default.gameMsg("It is for sale"));for(let t=0;t<e.length;t++)if(e[t].hasAny(this.somethingSpecial)){const n=e[t].getName();a.default.gameMsg(`There is something special about ${n}`)}}const n=t.getBaseElem();n.hasMsg("onEnter")&&a.default.gameMsg(n.getMsg("onEnter"))}updateEntity(e){const t=e.get("Movement"),[n,s]=t.getXY(),r=t.getLevel().getMap();if(!r.hasXY(n,s)){let t=`Tried to move to ${n},${s}.`;t+=" Entity: "+e.getName(),a.default.warn("System.Movement","updateEntity",t)}const o=r.getCell(n,s),i=e.getCell();let l=o.isFree(e.has("Flying"));if(l||(l=this._checkSpecialMovement(e,o)),l){const t=e.getXY();c.enabled&&a.default.debug(this,`Trying to move ent from ${t}`);const l=e.getPropType();if(r.moveProp(t,[n,s],l,e)){e.setXY(n,s),this.checkForStatsMods(e,i,o),e.isPlayer&&e.isPlayer()&&this.checkMessageEmits(i,o),o.hasElements()&&(e.isPlayer&&e.isPlayer()&&o.hasPropType("exploration")&&this._processExploreElem(e,o),this._checkEntrapment(e,o));const t=o.getBaseElem();if(t.has("Snowy")){const e=t.getType();h[e]&&o.setBaseElem(h[e])}}else this._moveError(e)}else a.default.debug(this,"Cell wasn't free at "+n+", "+s);e.remove(t)}checkForStatsMods(e,t,n){let[s,r]=[t.getBaseElem().getType(),n.getBaseElem().getType()];if(d[s]&&(s=d[s]),d[r]&&(r=d[r]),s!==r){if(this._bonuses.hasOwnProperty(r)){const t=this._bonuses[r];let n=!0;t.dontApplyTo&&t.dontApplyTo.forEach(t=>{e.has(t)&&(n=!1)}),n&&t.mods.forEach(t=>{if(Number.isInteger(t.value)){const n=i.create(t.targetComp);n[t.targetFunc](t.value),n.setTag(r),e.add(n)}else{const n=e.get(t.srcComp);if(n){let s=n[t.srcFunc]();s=Math.round(t.value*s);const a=i.create(t.targetComp);a[t.targetFunc](s),a.setTag(r),e.add(a)}}})}if(this._bonuses.hasOwnProperty(s)){const t=e.getList("StatsMods"),n=e.getList("CombatMods");t.forEach(t=>{t.getTag()===s&&e.remove(t)}),n.forEach(t=>{t.getTag()===s&&e.remove(t)})}}}_checkSpecialMovement(e,t){const n=t.getBaseElem().getType();if(this.climbRe.test(n)&&e.has("Climber")){const n=`${e.getName()} climbs the rocky terrain`;return a.default.gameMsg({cell:t,msg:n}),!0}return!1}_processExploreElem(e,t){const n=e.getLevel(),[s,r]=[t.getX(),t.getY()],o=t.getPropType("exploration")[0];if(n.removeElement(o,s,r)){const s=o.getExp(),r=new i.ExpPoints(s);if(e.add(r),u(e,"Exploration",1),o.hasData()){const t=o.getData();t.zoneType&&e.get("GameInfo").addZoneType(t.zoneType)}const l=n.getParent();l&&e.get("GameInfo").addZone(l.getID());let c=o.getMsg("onEnter");c&&0!==c.length||(c=`${e.getName()} has explored zone thoroughly.`),a.default.gameInfo({cell:t,msg:c}),e.isPlayer()&&e.getBrain().addMark()}}_checkEntrapment(e,t){const n=t.getElements();n&&n.forEach(n=>{if(n.has("Entrapping")&&!e.has("Entrapped")){const s=n.get("Entrapping").getDifficulty(),r=e.getStrength(),o=e.getAgility(),l=(r+o)/(r+o+s);if(a.default.isSuccess(l)){let s=`${e.getName()} avoids getting trapped`;s+=` by ${n.getName()}!`,a.default.gameMsg({cell:t,msg:s})}else{e.add(new i.Entrapped);let s=`${e.getName()} becomes trapped`;s+=` by ${n.getName()}!`,a.default.gameMsg({cell:t,msg:s})}}})}_moveError(e){const[t,n]=e.getXY(),s=e.getLevel(),r=s.getMap(),o=t+", "+n;a.default.diag("\n\nSystem.Movement list of actors:"),a.default.printObjList(s.getActors(),["getID","getName","getX","getY"]),this._diagnoseRemovePropError(t,n,r,e),a.default.err("MovementSystem","moveActorTo","Couldn't remove ent |"+e.getName()+"| @ "+o)}_diagnoseRemovePropError(e,t,n,s){const r=s.getPropType();let o=-1,i=-1;for(let e=0;e<n.cols;e++)for(let t=0;t<n.rows;t++)n.removeProp(e,t,r,s)&&(o=e,i=t);const l=n.getCell(e,t);a.default.diag(`Cell at ${e},${t}:`),a.default.diag(l);const c=s.getCell();a.default.diag("Cell of the entity:"),a.default.diag(c),a.default.diag("System.Movement: diagnoseRemovePropError:");const u=s.getName();if(o>=0&&i>=0){const n=`\tEnt |${u}| found from |${`${o},${i} instead of ${e},${t}.`}|`;a.default.diag(n)}else{const e=`\tNo ent |${u}| found on entire map.`;a.default.diag(e)}a.default.diag("map.Find list of objects: ");const h=n.findObj(e=>e.getName&&e.getName().match(/keeper/));a.default.diag(h)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=r(n(34)),l=r(n(11)),{addSkillsExp:c}=o.SystemBase;t.SystemShop=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.SHOP,e,t)}updateEntity(e){const t=e.get("Transaction"),n=t.getArgs(),{buyer:s}=n;this._checkTransArgsOK(e,n),s.getID()===e.getID()?this.buyItem(n):this.sellItem(n),e.remove(t)}_checkTransArgsOK(e,t){const{item:n,buyer:s,shop:r,seller:o}=t;let i="";n||(i+="Item is null/undef. "),s||(i+="Buyer is null/undef. "),o||(i+="Seller is null/undef. "),r||(i+="Shop (element) is null/undef. "),""!==i&&(i+="Entity: "+e.getName(),a.default.err("System.Shop","_checkTransArgsOK",i))}buyItem(e){const{item:t,buyer:n,shop:s,seller:r}=e,o=n.getCell(),l=t.getValue()*s.getCostFactorSell(),u=a.default.valueToGoldWeight(l),h=a.default.getGoldInCoins(u);if(a.default.hasEnoughGold(n,u)){const e=new i.GoldCoin(a.default.GOLD_COIN_NAME),l=a.default.removeNCoins(n,h);if(e.setCount(l),!n.getInvEq().canCarryItem(t))return n.getInvEq().addItem(e),void a.default.gameMsg(n.getName()+" cannot carry more weight");r.getInvEq().addItem(e),r.getLevel().removeItem(t,s.getX(),s.getY())?(n.getInvEq().addItem(t),t.remove("Unpaid"),a.default.gameMsg({cell:o,msg:n.getName()+" bought "+t.getName()+" for "+h+" coins."}),c(r,"Trading",1)):a.default.err("System.Shop","buyItem","Could not remove item from level")}else a.default.gameMsg({cell:o,msg:n.getName()+" doesn't have enough money to buy "+t.getName()+" for "+h+" coins."})}sellItem(e){const{item:t,buyer:n,seller:s,shop:r}=e;if(s||a.default.err("System.Shop","sellItem","Seller is null or undefined."),!this.willingToBuyItem(t,n)){t.getName();const r=`${n.getName()} is not interested in ${t.getName()}.`;return a.default.gameMsg({cell:s.getCell(),msg:r}),void(e.callback&&e.callback({msg:r,result:!1}))}const o=e.count||1,u=s.getCell(),h=o*t.getValue()*r.getCostFactorBuy(),d=a.default.valueToGoldWeight(h),p=a.default.getGoldInCoins(d);if(a.default.hasEnoughGold(n,d)){if(s.getInvEq().dropNItems(t,o)){const r=new i.GoldCoin(a.default.GOLD_COIN_NAME),o=a.default.removeNCoins(n,p);r.setCount(o),s.getInvEq().addItem(r);const h=s.getCell().getItems(),d=h[h.length-1];d.add(new l.Unpaid);const f=d.getName();if(a.default.gameMsg({cell:u,msg:s.getName()+" sold "+f+" for "+p+" coins."}),e.callback){const n=`${t.getName()} was sold.`;e.callback({msg:n,result:!0})}c(s,"Trading",1)}}else{const s=n.getName();if(a.default.gameMsg({cell:n.getCell(),msg:"Buyer "+s+" doesn't have enough gold to buy it."}),e.callback){const n=`Cannot sell ${t.getName()}.`;e.callback({msg:n,result:!1})}}}willingToBuyItem(e,t){return e.getName()!==a.default.GOLD_COIN_NAME}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=r(n(11));t.SystemSkills=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.SKILLS,e,t)}updateEntity(e){const t=e.getList("SkillsExp"),n=e.get("Skills"),s=e.getCell();t.forEach(t=>{const r=t.getSkill();n.hasSkill(r)||(n.addSkill(r),a.default.gameSuccess({cell:s,msg:`${e.getName()} learns a skill ${r}`}));const o=t.getPoints();n.addPoints(r,o);const l=n.getPoints(r),c=n.getLevel(r);if(l>=10*c){const t=e.getName();n.setLevel(r,c+1),n.resetPoints(r),a.default.gameSuccess({cell:s,msg:`${t} advances a skill ${r}`});const o=new i.ExpPoints(10*c);e.add(o),a.default.gameSuccess({cell:s,msg:`${t} gains experience from skill ${r}`})}e.remove(t)})}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(16),o=n(21),{addSkillsExp:i}=a.SystemBase;t.SystemSpellCast=class extends a.SystemBase{constructor(e,t){super(r.default.SYS.SPELL_CAST,e,t),this.compTypesAny=!0}updateEntity(e){const t=e.getName(),n=e.getCell();if(e.has("SpellPower")&&e.has("SpellCast")){const s=e.get("SpellCast"),a=e.get("SpellPower"),o=s.getSpell();if(o.getCastingPower()<=a.getPP()){const t=Object.values(this.entities).filter(e=>e.has("PowerDrain")),l=s.getArgs();if(a.decrPP(o.getCastingPower()),0===t.length)o.cast(l),i(e,"SpellCasting",1);else if(this._checkPowerDrain(o,l,t)){let e=`Spell ${o.getName()} was canceled by power drain of`;e+=` ${this._drainerName}`,r.default.gameMsg({cell:n,msg:e})}else o.cast(l),i(e,"SpellCasting",1)}else{const e=`${t} has no enough power to cast spell`;r.default.gameMsg({cell:n,msg:e})}e.remove("SpellCast")}}_checkPowerDrain(e,t,n){let s=!1;const r=t.src.getX(),a=t.src.getY();return this._drainerName="",n.forEach(n=>{if(n.getLevel().getID()===t.src.getLevel().getID()){const i=n.getX(),l=n.getY(),c=o.Path.shortestDist(r,a,i,l);if(n.getID()!==t.src.getID()&&c<=n.get("PowerDrain").drainDist){if(n.remove("PowerDrain"),s=!0,this._drainerName=n.getName(),n.has("SpellPower")){const t=e.getCastingPower();n.get("SpellPower").addPP(t)}return}}}),s}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=r(n(11)),l=n(14),c=n(12),{addSkillsExp:u}=o.SystemBase,h=["SpellRay","SpellCell","SpellMissile","SpellArea","SpellSelf"];function d(e,t,n){let s=a.default.getDmgClassName(t.damageType);s||(s=a.default.getDmgClassName(a.default.DMG.MAGIC));const r={cell:!0,coord:[n],className:s,level:e.getLevel()},o=new i.Animation(r);e.add(o)}t.SystemSpellEffect=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.SPELL_EFFECT,e,t),this.compTypesAny=!0,this._dtable={SpellRay:this.processSpellRay.bind(this),SpellCell:this.processSpellCell.bind(this),SpellMissile:this.processSpellMissile.bind(this),SpellArea:this.processSpellArea.bind(this),SpellSelf:this.processSpellSelf.bind(this)}}updateEntity(e){h.forEach(t=>{e.has(t)&&e.getList(t).forEach(n=>{this._dtable[t](e,n),e.remove(n)})})}processSpellRay(e,t){const n=t.getArgs(),s=e.getLevel().getMap(),r=n.spell,o=r.getName();let[l,c]=n.from;const[u,h]=n.dir;let d=r.getRange(),p=0;for(;d>0;)if(l+=u,c+=h,s.hasXY(l,c)){const e=s.getCell(l,c);if(r.onCellCallback&&r.onCellCallback(e),e.hasActors()){const t=e.getActors()[0],s=t.getName(),i=t.has("SpellStop");i||this.rayHitsActor(t,d)?(this._addDamageToActor(t,n),i?(d=0,a.default.gameMsg({cell:e,msg:`${o} is stopped by ${s}`})):r.stopOnHit&&(d=0),a.default.gameMsg({cell:e,msg:`${o} hits ${s}`})):a.default.gameMsg({cell:e,msg:`${o} misses ${s}`})}e.isSpellPassable()?++p:d=0,--d}else d=0;const f={dir:n.dir,ray:!0,from:n.from,range:p,className:a.default.getDmgClassName(n.damageType),level:e.getLevel()},m=new i.Animation(f);e.add(m)}rayHitsActor(e,t){if(!e.has("Health"))return!1;let n=e.get("Stats").getAgility();e.has("Skills")&&(n+=e.get("Skills").getLevel("Dodge")),(n-=t)<0&&(n=0);const s=(100-n)/100;return a.default.isSuccess(s)?!e.has("RangedEvasion")||a.default.isSuccess(.5):(u(e,"Dodge",1),!1)}processSpellCell(e,t){const n=t.getArgs(),s=e.getLevel().getMap(),r=n.spell.getName(),o=n.dir[0],l=n.dir[1],c=n.from[0]+o,u=n.from[1]+l;if(s.hasXY(c,u)){const t=s.getCell(c,u);if(n.preCallback&&n.preCallback(t),n.callback)n.callback(t);else if(t.hasActors()){const e=t.getActors()[0];if(n.targetComp){const s=n.set,o=n.get;if(e.has(n.targetComp)){const i=e.get(n.targetComp),l=e.getName();o?i[s](i[o()]+n.value):i[s](n.value),a.default.gameMsg({cell:t,msg:`Spell ${r} is cast on ${l}`})}}else if(n.addComp){const t=n.addComp.comp;if(t)if(n.addComp.duration){const s=n.addComp.duration;if(e.has("Expiration"))e.get("Expiration").addEffect(t,s);else{const n=new i.Expiration;n.addEffect(t,s),e.add(n)}e.add(t)}else e.add(t);else{const e=JSON.stringify(n);a.default.err("SystemSpellEffect","processSpellCell",`args.addComp.comp must be defined. Args: ${e}`)}const s=t.getType(),r=`${e.getName()} seems to have ${s}`;a.default.gameMsg({cell:e.getCell(),msg:r})}else n.removeComp?n.removeComp.forEach(t=>{e.has(t)&&e.removeAll(t)}):(this._addDamageToActor(e,n),a.default.gameMsg({cell:t,msg:`${r} hits ${e.getName()}`}))}n.postCallback&&n.postCallback(t),d(e,n,[c,u])}}processSpellMissile(e,t){const n=t.getArgs(),s=n.spell,r=l.ObjectShell.getParser(),o=s.getAmmoName();o||a.default.err("System.SpellEffect","processSpellMissile",`No |ammoName| set for spell ${s.getName()}`);const c=r.createItem(o),u=new i.Missile(n.src);u.setTargetXY(n.to[0],n.to[1]),u.destroyItem=!0,n.hasOwnProperty("destroyItem")&&(u.destroyItem=n.destroyItem),u.setDamage(n.damage),u.setAttack(100),u.setRange(s.getRange()),n.onHit&&!t.onHit?u.onHit=n.onHit:t.onHit&&!n.onHit?u.onHit=t.onHit:t.onHit&&n.onHit&&a.default.err("SystemSpellEffect","processSpellMissile","onHit given in both SpellMissile and its args"),c.add(u)}processSpellArea(e,t){const n=t.getArgs(),s=n.spell,r=s.getRange(),[o,l]=[n.src.getX(),n.src.getY()],u=n.src.getLevel().getMap();c.Geometry.getBoxAround(o,l,r).forEach(e=>{if(u.hasXY(e[0],e[1])){const t=u.getCell(e[0],e[1]);if(t.hasActors()){const e=t.getActors();for(let r=0;r<e.length;r++){this._addDamageToActor(e[r],n),s.onCellCallback&&s.onCellCallback(t);const o=e[r].getName();a.default.gameMsg({cell:e[r].getCell(),msg:`${o} is hit by ${s.getName()}`})}}}});const h={range:r,cX:o,cY:l,className:a.default.getDmgClassName(n.damageType),level:e.getLevel()},d=new i.Animation(h);e.add(d)}processSpellSelf(e,t){const n=t.getArgs();if("function"==typeof n.callback)n.callback();else{let e="args.callback must be a function. ";e+="Got args: "+JSON.stringify(n),a.default.err("SystemSpellEffect","processSpellSelf",e)}d(e,n,e.getXY())}_addDamageToActor(e,t){const n=new i.Damage;n.setSource(t.src),n.setDamageType(t.damageType),n.setDamage(t.damage),n.setDamageCateg(a.default.DMG.MAGIC),n.setWeapon(t.spell),e.add(n)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=r(n(11));t.SystemSpiritBind=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.SPIRIT,e,t),this.compTypesAny=!0}updateEntity(e){e.has("SpiritBind")&&this._doSpiritBind(e)}_doSpiritBind(e){const t=e.get("SpiritBind"),n=t.getBinder(),s=n.getName(),r=t.getTarget();if(e.hasSpirit()){if(r.hasItems())if(n.has("SpiritItemCrafter")){const t=r.getItems()[0],o=t.getName();if(t.has("GemBound")){const e=`${o} has already a gem bound to it.`;a.default.gameMsg({cell:r,msg:e})}else{const l=new i.GemBound,c=n.getInvEq().removeAndGetItem(e);l.setGem(c),t.add(l);const u=`${e.getName()} was bound to ${o} by ${s}`;a.default.gameMsg({cell:r,msg:u})}}else{const e=`${s} cannot bind gems to items.`;a.default.gameMsg({cell:r,msg:e})}}else{const t=r.getPropType("spirit");if(t.length>0){const n=t[0];n.get("Action").disable(),n.getLevel().removeActor(n),e.setSpirit(n);const o=`${n.getName()} was bound to gem by ${s}`;a.default.gameMsg({cell:r,msg:o})}else{const e="There are no spirits to capture there!";a.default.gameMsg({cell:r,msg:e})}}e.remove("SpiritBind")}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(16),i=n(18),l=r(n(11)),c=i.EventPool.getPool();t.SystemTimeEffects=class extends o.SystemBase{constructor(e,t){super(a.default.SYS.TIME_EFFECTS,e,t),this.compTypesAny=!0,this._dtable={},this._expiredEffects=[],this._dtable.Poison=this._applyPoison.bind(this),this._dtable.Fading=this._applyFading.bind(this),this._dtable.Heat=this._applyHeat.bind(this),this._dtable.Coldness=this._applyColdness.bind(this),this._dtable.DirectDamage=this._applyDirectDamage.bind(this),this._dtable.RegenEffect=this._applyRegenEffect.bind(this)}update(){for(const e in this.entities){if(!e)continue;const t=this.entities[e];for(let e=0;e<this.compTypes.length;e++)"Expiration"!==this.compTypes[e]&&t.has(this.compTypes[e])&&this._dtable[this.compTypes[e]](t);t.has("Expiration")&&this._decreaseDuration(t)}for(let e=0;e<this._expiredEffects.length;e++){const t=this._expiredEffects[e][0];this._expiredEffects[e][1].remove(t)}this._expiredEffects=[]}_decreaseDuration(e){e.getList("Expiration").forEach(t=>{t.decrDuration(),t.hasEffects()||this._expiredEffects.push([t.getID(),e])})}_applyPoison(e){e.getList("Poison").forEach(t=>{if(e.get("Health").isDead()){if(this._expiredEffects.push([t.getID(),e]),e.has("Expiration")){const n=e.get("Expiration");n.hasEffect(t)&&n.removeEffect(t)}}else if(a.default.isSuccess(t.getProb())){const n=t.rollDamage(),s=new l.Damage(n,a.default.DMG.POISON);s.setSource(t.getSource()),e.add(s)}})}_applyDirectDamage(e){e.getList("DirectDamage").forEach(t=>{if(e.get("Health").isDead()){if(this._expiredEffects.push([t.getID(),e]),e.has("Expiration")){const n=e.get("Expiration");n.hasEffect(t)&&n.removeEffect(t)}}else if(a.default.isSuccess(t.getProb())){const n=t.rollDamage(),s=new l.Damage(n,t.getDamageType());s.setDamageCateg(t.getDamageCateg()),s.setSource(t.getSource()),e.add(s);const r=t.getMsg();r&&a.default.gameMsg({cell:e.getCell(),msg:r})}})}_applyFading(e){const t=e.get("Fading");if(t.decrDuration(),t.getDuration()<=0){if(a.default.isActor(e)){const t=e.getCell();if(e.getLevel().removeActor(e)){c.emitEvent(a.default.EVT_ACTOR_KILLED,{actor:e});const n=`${e.getName()} disappears.`;a.default.gameMsg({cell:t,msg:n})}else{const t=JSON.stringify(e);a.default.err("System.TimeEffects","_applyFading",`Could not remove actor from level: ${t}`)}}else a.default.err("System.TimeEffects","_applyFading","Fading not handled for non-actors yet.");e.remove(t)}}_applyHeat(e){if(e.has("Coldness")){const t=e.getCell();e.removeAll("Coldness");const n=`Thanks to heat, ${e.getName()} stops shivering`;a.default.gameMsg({cell:t,msg:n})}e.removeAll("Heat")}_applyColdness(e){if(e.has("BodyTemp")){const t=e.get("BodyTemp");if(t.decr(),t.isFrozen()){const t=new l.Damage(1,a.default.DMG.COLD);e.add(t)}}}_applyRegenEffect(e){e.getList("RegenEffect").forEach(t=>{let n=!0;if(t.getHP()>0){const s=t.getWaitHP();if(0===s){const s=e.get("Health");s&&(s.addHP(t.getHP()),s.getHP()<s.getMaxHP()&&(n=!1)),t.setWaitHP(t.getMaxWaitHP())}else t.setWaitHP(s-1)}if(t.getPP()>0){const s=t.getWaitPP();if(0===s){const s=e.get("SpellPower");s&&(s.addPP(t.getPP()),s.getPP()<s.getMaxPP()&&(n=!1)),t.setWaitPP(t.getMaxWaitPP())}else t.setWaitPP(s-1)}n&&e.remove(t)})}printMatchedType(e){for(let t=0;t<this.compTypes.length;t++)e.has(this.compTypes[t])&&a.default.debug(this.compTypes[t],"Has component")}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(16),o=n(26),i=n(9).Random.getRNG();t.SystemWeather=class extends a.SystemBase{constructor(e,t){super(r.default.SYS.WEATHER,e,t),this._effTable={snowStorm:this.handleSnowStorm=this.handleSnowStorm.bind(this),warm:this.handleMeltSnow=this.handleMeltSnow.bind(this)}}updateEntity(e){if(e.has("WeatherEffect")){const t=e.get("WeatherEffect"),n=t.getEffectType();this._effTable[n]&&this._effTable[n](e,t),e.removeAll("WeatherEffect")}}handleSnowStorm(e,t){const n=e.getLevel().getMap();o.MapGenerator.addRandomSnow(n,.1)}handleMeltSnow(e,t){e.getLevel().getMap().getFree().filter(e=>e.getBaseElem().has("Snowy")).forEach(e=>{if(i.getUniform()<.1){const t=e.getBaseElem().getType(),n=o.MapGenerator.snowMeltMap[t];e.setBaseElem(n)}})}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=s(n(23)),o=n(28),i=n(117),l=n(253),c=n(107),u=n(433),h=n(254),d=n(434),p=n(74),f=n(436),m=n(468),g=n(469),y=n(155),v=n(18),_=n(30),b=n(133),E=n(14),S=n(470),C=n(472),w=n(17),{KeyMap:T}=(v.EventPool.getPool(),o.Keys),O=w("bitn:game-manager");t.VIEW_MAP=0,t.VIEW_PLAYER=1,t.STATUS_COMPS_GUI=[["Charm","success","Charming","stat-charm"],["Coldness","primary","Cold","stat-coldness"],["Ethereal","info","Ethereal","stat-ethereal"],["Entrapped","danger","Trapped","stat-trapped"],["Fear","danger","Afraid","stat-fear"],["Flying","primary","Flying","stat-flying"],["Paralysis","danger","Paralysed","stat-paralysis"],["Poison","danger","Poisoned","stat-poison"],["PowerDrain","success","Power drain","stat-power-drain"],["Stun","danger","Stunned","stat-stun"],["MindControl","danger","Mind controlled","stat-mind-ctrl"]];class M{static describeCell(e,t){if(-1!==t.indexOf(e))if(e.hasActors()){const t="You see "+e.getFirstActor().getName();r.default.gameMsg(t)}else if(e.hasProp("items")){const t=e.getProp("items");t.length>1?(r.default.gameMsg("There are several items there"),r.default.gameMsg("You see "+t[0].getName()+" on top")):r.default.gameMsg("You see "+t[0].getName()+" lying there.")}else e.hasPropType("door")?r.default.gameMsg("You see a door there."):r.default.gameMsg("There is nothing there.");else r.default.gameWarn("You cannot see there.")}static getAdjacentCell(e,t){if(T.inMoveCodeMap(t)||T.isRest(t)){const[n,s]=e.getXY(),r=T.getDiff(t,n,s);if(null!==r)return e.getLevel().getMap().getCell(r[0],r[1])}return null}}t.TopLogic=M;class A{constructor(e){this.hasNotify=!0,this.cbNotify=e}notify(e,t){this.cbNotify(e,t)}}t.GameManager=class{constructor(e){e||r.default.err("GameManager","constructor","no updateCb given (ie setState in react)"),this.updateCb=e,this.doGUICommand=this.doGUICommand.bind(this),this.isGUICommand=this.isGUICommand.bind(this),this.mainLoop=this.mainLoop.bind(this),this.notify=this.notify.bind(this),this.hasNotify=!0,this.listener=new A(this.notify),this.animation=null,this.game=null,this.gameSave=new l.GameSave,this.pluginManager=new f.PluginManager,this.finishAutoOnSight=!0,this.finishAutoDist=3,this.resetGameState(),this.viewportPlayerX=35,this.viewportPlayerY=15,this.viewportX=35,this.viewportY=15,this.resetGameControls(),this.gameSave.setStorage(window.localStorage),this.savedPlayerList=this.gameSave.getPlayersAsList(),this.finishAutoOnSight=!0,this.finishAutoDist=3,this.gameConf=y.FactoryGame.getGameConf(),this.gameConf.world=m.WorldConf,this.handleKeyDown=this.handleKeyDown.bind(this)}resetGameControls(){this.frameID=null,this.multiHandler=new u.MultiKeyHandler,this.screen=new c.ScreenBuffered(this.viewportX,this.viewportY),this.keyPending=!1,this.keysEnabled=!1,this.autoModeKeyBuffer=[],this.ctrlMode="MANUAL",this.recordedCommands=[]}setGameSettings(e,t){this.gameConf[e]=t}isGameValid(){return!!this.game}getPlayer(){return this.game.getPlayer()}setPlayerDriver(){const e=this.game.getPlayer();this.playerDriver=new h.PlayerDriver(e,this.game),e.remove("Hunger"),this.ctrlMode="AUTOMATIC",this.finishAutoOnSight=!1}renderScreen(){const e=this.game.getVisibleMap(),[t,n]=this.getPlayer().getXY();e&&this.screen.renderWithRLE(t,n,e,this.gameGUIState.visibleCells,this.animation)}resetGameState(){this.gameGUIState={autoTarget:!1,visibleCells:[],useModeEnabled:!1,isTargeting:!1,targetInRange:!1,enemyCells:[],numCurrCell:0}}guiState(e,t){return t?(console.log("guiState setting value",e,"to",t),this.gameGUIState[e]=t,this.gameGUIState[e]):this.gameGUIState[e]}setGUICommands(e){this.guiCommands=e}canUseWorker(){return void 0!==window.Worker&&!this.pluginManager.anyPluginsEnabled()}getPlugins(){return this.pluginManager.getPlugins()}isGUICommand(e){return!!this.gameGUIState&&(!this.gameGUIState.autoTarget||e!==o.Keys.VK_t)&&(!!this.gameGUIState.useModeEnabled||this.guiCommands.hasOwnProperty(e))}cancelAnim(){this.frameID&&cancelAnimationFrame(this.frameID)}restartMainLoop(){this.cancelAnim(),this.frameID=requestAnimationFrame(this.mainLoop)}setPlayerName(e){this.gameConf.playerName=e}getScreen(){return this.screen}getPlayersAsList(){return this.gameSave.getPlayersAsList()}enableKeys(){this.keysEnabled||(document.addEventListener("keypress",this.handleKeyDown,!0),this.keysEnabled=!0)}getRecordedCommands(){return this.recordedCommands}disableKeys(){this.keysEnabled&&(document.removeEventListener("keypress",this.handleKeyDown,!0),this.keysEnabled=!1)}isValidKey(e){return o.Keys.isValidKey(e)||this.guiCommands[e]||o.Keys.isNumeric(e)}handleKeyDown(e){e.stopPropagation(),e.preventDefault();const t=b.KeyCode.getKeyCode(e);if(!1===this.keyPending&&(this.keyPending=!0,this.nextCode=t,this.isGUICommand(t)||(this.gameGUIState.isTargeting=!1),o.Keys.KeyMap.isMultiPurpose(t))){const e=this.game.getPlayer(),t=this.multiHandler.getKeys(e);t&&t.length>0&&(this.playerDriver=new g.CellClickHandler(null,this.game),this.playerDriver.setKeys(t),this.playerDriver.hasKeys()&&this.setAutoMode())}}saveGame(e){if(this.game){const t=this.game.getPlayer().getName(),n=new S.Persist(t);this.gameToJSON().then(t=>{n.toStorage(t,()=>{this.gameSave.save(this.game,this.gameConf),this.savedPlayerList=this.gameSave.getPlayersAsList(),r.default.gameMsg("Your progress has been saved."),e()})})}}deleteGame(e,t){e&&new S.Persist(e).deleteStorage(()=>{this.gameSave.deletePlayer(e),this.savedPlayerList=this.gameSave.getPlayersAsList(),t()})}isMenuShown(){return!!this.game&&this.game.isMenuShown()}getMenu(){return this.game?this.game.getMenu():null}getMessages(){return this.game&&this.game.hasNewMessages()?this.game.getMessages():[]}getOWAndPlayerPos(){let e=null,t=null;return this.game&&(e=this.game.getOverWorld())&&(t=this.game.getPlayerOwPos())&&this.game.setOverWorldExplored(t),[e,t]}initRestoredGame(e){this.cancelAnim(),this.resetGameState(),this.game=e,this.initBeforeNewGame()}gameToJSON(){return new Promise((e,t)=>{try{e(this.game.toJSON())}catch(e){t(e)}})}loadGame(e,t){e&&new S.Persist(e).fromStorage().then(n=>{const s=new p.FromJSON,r=n,a=new i.GameMain,o=s.createGame(a,r),l=o.getPlayer();if(null!==l){this.gameConf.loadedPlayer=l,this.gameConf.loadedLevel=this.gameSave.getDungeonLevel();const n=this.gameSave.getPlayersAsObj()[e];this.restoreGameConf(n),t(o)}})}restoreGameConf(e){const t=["cols","rows","sqrPerActor","sqrPerItem","levels"];for(let n=0;n<t.length;n++)this.gameConf[t[n]]=e[t[n]]}initBeforeNewGame(){console.log("initBeforeNewGame starting also mainLoop"),this.game.setGUICallbacks(this.isGUICommand,this.doGUICommand),this.game.setAnimationCallback(this.playAnimation.bind(this)),this.setDebugRefsToWindow();const e=this.game.getPlayer();this.gameGUIState.visibleCells=e.getBrain().getSeenCells(),this.gameGUIState.visibleCells||r.default.err("GameManager","initBeforeNewGame","No visibleCells");const t=this.game.getPool();t.listenEvent(r.default.EVT_LEVEL_CHANGED,this.listener),t.listenEvent(r.default.EVT_DESTROY_ITEM,this.listener),this.frameID=requestAnimationFrame(this.mainLoop),this.updateCb({render:!0})}mainLoop(){if(!0===this.keyPending||"AUTOMATIC"===this.ctrlMode){const e=this.getNextCode();if(e.cmd?this.game.update(e):this.game.update({code:e}),this.recordedCommands.push(e),this.game.visibleCells||r.default.err("GameManager","mainLoop","No visible cells"),this.gameGUIState.visibleCells=this.game.visibleCells,this.game.isGameOver())this.updateCb({render:!0,showGameMenu:!1});else{const e=this.game.getPlayer().getBrain(),t={render:!0,showGameMenu:!1};e.hasTargetSelected()?(t.selectedCell=e.getSelectedCells(),this.screen.setSelectedCell(t.selectedCell),e.isTargeting()&&(e.isTargetInRange()?this.screen.setStyle("selectedCell","cell-target-selected"):this.screen.setStyle("selectedCell","cell-not-in-range")),this.gameGUIState.isTargeting=!0):(this.gameGUIState.isTargeting=!1,t.selectedCell=null,this.screen.setSelectedCell(null)),this.updateCb(t)}this.keyPending=!1,this.checkIfAutoModeDone()}this.frameID=requestAnimationFrame(this.mainLoop)}checkIfAutoModeDone(){if(this.playerDriver)if(this.playerDriver.hasKeys()){if(this.finishAutoOnSight){const[e,t]=this.game.getPlayer().getXY(),n=r.default.findEnemyCellForActor(this.game.getPlayer(),this.gameGUIState.visibleCells);if(n.length>0){let s=!1;n.forEach(n=>{const[a,o]=n.getXY(),[i,l]=r.default.dXdYAbs([e,t],[a,o]);(i<this.finishAutoDist||l<this.finishAutoDist)&&(s=!0)}),s&&(r.default.gameMsg("You spot an enemy"),this.ctrlMode="MANUAL",this.playerDriver.reset())}}}else this.ctrlMode="MANUAL"}setDebugRefsToWindow(){if(O.enabled){window.GAME=this.game;const e=this.game.getPlayer();window.PLAYER=e,window.RG=r.default,window.PARSER=E.ObjectShell.getParser()}}getNextCode(){if("AUTOMATIC"===this.ctrlMode){const e=this.playerDriver.getNextCode();return e||(this.ctrlMode="MANUAL",o.Keys.KEY.NO_ACTION)}return this.nextCode}setViewSize(e,t){"+"===e&&("X"===t?this.viewportX+=5:this.viewportY+=2),"-"===e&&("X"===t?this.viewportX-=5:this.viewportY-=2),this.screen.setViewportXY(this.viewportX,this.viewportY)}setViewType(e){e===t.VIEW_MAP?(this.viewportPlayerX=this.viewportX,this.viewportPlayerY=this.viewportY,this.viewportX=this.game.getPlayer().getLevel().getMap().cols,this.viewportY=this.game.getPlayer().getLevel().getMap().rows,this.screen.setMapShown(!0),this.screen.setViewportXY(this.viewportX,this.viewportY),this.boardClassName="game-board-map-view",this.showMap=!0):e===t.VIEW_PLAYER&&(this.viewportX=this.viewportPlayerX,this.viewportY=this.viewportPlayerY,this.screen.setMapShown(!1),this.screen.setViewportXY(this.viewportX,this.viewportY),this.boardClassName="game-board-player-view",this.showMap=!1)}setSeedName(e){let t=parseInt(e,10);if(Number.isNaN(t)){const n=C(e);t=parseInt(n,16)}""===e&&(t=(new Date).getTime()),console.log("setSeedName used seed is",t,"got name",e),a.default.RNG.setSeed(t),_.Dice.RNG.setSeed(t),this.gameConf.seed=t}GUILook(e){if(this.gameGUIState.isTargeting){const t=this.getNextTargetCell();if(t){const n=`You see ${t.getActors()[0].getName()} nearby.`;this.screen.setSelectedCell(t),r.default.gameMsg(n),e({selectedCell:t})}else this.gameGUIState.isTargeting=!1,this.screen.setSelectedCell(null),e({selectedCell:null})}else{this.gameGUIState.isTargeting=!0,this.gameGUIState.enemyCells=r.default.findEnemyCellForActor(this.game.getPlayer(),this.gameGUIState.visibleCells),this.gameGUIState.numCurrCell=0;let t="You do not see any enemies nearby.";if(this.gameGUIState.enemyCells.length>0){const n=this.gameGUIState.enemyCells[0];t=`You see ${n.getActors()[0].getName()} nearby.`,this.screen.setSelectedCell(n),r.default.gameMsg(t),e({selectedCell:n})}else r.default.gameMsg(t)}}getNextTargetCell(){const e=this.gameGUIState.enemyCells.length;if(e>0){let t=this.gameGUIState.numCurrCell+1;return t>=e&&(t=0),this.gameGUIState.numCurrCell=t,this.gameGUIState.enemyCells[t]}return null}setGameSetting(e,t){this.gameConf[e]=t}setSelectedCell(e){this.screen.setSelectedCell(e)}createNewGame(e){if(this.cancelAnim(),this.resetGameState(),this.resetGameControls(),this.gameConf.seed&&(this.gameConf.seed=(new Date).getTime()),e(),this.canUseWorker())console.log("documentURI:",document.documentURI),this.createGameWorker();else{const e=new y.FactoryGame;this.game=e.createNewGame(this.gameConf),this.initBeforeNewGame()}}createGameWorker(){const e=new d.MyWorkerImport;e.onmessage=(e=>{const t=e.data;if(t.progress)this.progressCb(t.progress);else if(t.ready){const e=JSON.parse(t.data),n=new p.FromJSON;let s=new i.GameMain;s=n.createGame(s,e),this.game=s,this.initBeforeNewGame()}else if(t.error)throw new Error("Worker threw error: "+t.error)}),e.postMessage([this.gameConf])}createGameFromLevels(e){this.cancelAnim(),this.resetGameState(),null!==this.game&&delete this.game;const t=Object.assign({},this.gameConf);t.levels=e,t.playMode="from_levels";const n=new y.FactoryGame;this.game=n.createNewGame(t),this.initBeforeNewGame()}useClickHandler(e,t,n,s){this.playerDriver=new g.CellClickHandler(null,this.game),this.playerDriver.handleClick(e,t,n,s),this.playerDriver.hasKeys()&&this.setAutoMode()}setAutoMode(){this.ctrlMode="AUTOMATIC"}getCellCurrMap(e,t){const n=this.game.getPlayer().getLevel().getMap();return n.hasXY(e,t)?n.getCell(e,t):null}notify(e,t){if(e===r.default.EVT_LEVEL_CHANGED){const e=t.actor;e.isPlayer()&&(this.screen.invalidate(),this.gameGUIState.visibleCells=e.getBrain().getSeenCells(),this.updateCb({render:!0}))}}playAnimation(){if(this.game.hasAnimation()){const e=this.game.getAnimationFrame();this.animation=e,this.updateCb({render:!0,animation:e}),this.animationID=requestAnimationFrame(this.playAnimation.bind(this))}else this.animation=null,this.game.finishAnimation(),this.updateCb({render:!0,animation:null})}onLoadRecordedKeys(e){const t=this.game.getPlayer();this.playerDriver=new h.DriverBase(t,this.game),this.playerDriver.setKeys(e),this.ctrlMode="AUTOMATIC",this.finishAutoOnSight=!1}onLoadCallback(e,t){if(e.plugin){const t=this.pluginManager.readJSON(e),n=r.default.ObjectShell.getParser();n.parseShellData(t.getData()),window.parser=n}else{const t=new p.FromJSON,n=new i.GameMain,s=t.createGame(n,e);null!==s.getPlayer()&&this.initRestoredGame(s)}t()}doGUICommand(e,...t){this.guiCommands.hasOwnProperty(e)?(console.log("doGUICommand() Calling GUI command with code",e),this.guiCommands[e](e)):o.Keys.KeyMap.isGoto(e)?this.guiCommands.GOTO(...t):console.error("Unknown keycode for GUI command.")}useItem(e,t){if(this.gameGUIState.useModeEnabled)if(this.gameGUIState.useModeEnabled=!1,null!==t){const n=this.game.getPlayer(),s=M.getAdjacentCell(n,e);null!==s?(this.game.update({cmd:"use",target:s,item:t}),t.has("OneShot")&&this.updateCb({selectedItem:null})):r.default.gameWarn("There are no targets there.")}else r.default.gameWarn("No item was selected for use!")}onLoadScript(e,t){const n=document.querySelector(e).files[0];if(n){const e=new FileReader;e.onloadend=(()=>{const n=e.result.toString();this.pluginManager.loadScript(n),t()}),e.readAsText(n)}}onLoadFromScript(e,t){console.log("onLoadFromScript called here"),this.readTextFromFile(e,e=>{try{const t=this.pluginManager.loadGameFromScript(e);t.levels?this.createGameFromLevels(t.levels):t.game&&(this.cancelAnim(),this.resetGameState(),this.game=t.game,this.initBeforeNewGame())}catch(e){console.error(e,e.message)}})}readTextFromFile(e,t){const n=document.querySelector(e).files[0];if(n){const e=new FileReader;e.onloadend=(()=>{const n=e.result.toString();t(n)}),e.readAsText(n)}}updateGame(e){this.game.update(e)}onCellClick(e,t){const n=this.getCellCurrMap(e,t);if(n){if(this.gameGUIState.isTargeting?(this.game.update({cmd:"missile",target:n}),this.gameGUIState.visibleCells=this.game.visibleCells,this.screen.setSelectedCell(null),this.updateCb({selectedCell:null}),this.gameGUIState.isTargeting=!1):(M.describeCell(n,this.gameGUIState.visibleCells),this.updateCb({selectedCell:n}),n.hasItems()?this.useClickHandler(e,t,n,"pickup"):this.useClickHandler(e,t,n,"move")),console.log(`Cell: ${JSON.stringify(n)}`),n.hasActors()){const e=n.getActors();console.log(`Actors: ${JSON.stringify(e)}`)}if(n.hasConnection()){const e=n.getPropType("connection");console.log(`Actors: ${JSON.stringify(e)}`)}}else r.default.warn("GameManager","onCellClick",`No cell ${e},${t} in the map.`)}menuItemClicked(e){let t=-1;if(e){t=/\d+/.test(e)?parseInt(e,10):e;const n=o.Keys.selectIndexToCode(t);n>=0&&(this.keyPending=!0,this.nextCode=n)}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(74);t.GameSave=class{constructor(){this._storageRef=null,this._dungeonLevel=null,this._playerList="_battles_player_data_"}setStorage(e){this._storageRef=e}getDungeonLevel(){return this._dungeonLevel}save(e,t){this.savePlayer(e,t)}restore(e){return r.default.isNullOrUndef([e])?(r.default.err("GameSave","restore","No name given (or null/undef)."),null):this.restorePlayer(e)}getPlayersAsList(){const e=this.getPlayersAsObj();return null!==e?Object.keys(e).map(t=>e[t]):[]}getPlayersAsObj(){this._checkStorageValid();const e=this._storageRef.getItem(this._playerList);return JSON.parse(e)}deletePlayer(e){this._checkStorageValid();let t=this._storageRef.getItem(this._playerList);const n=JSON.parse(t);n.hasOwnProperty(e)&&delete n[e],t=JSON.stringify(n),this._storageRef.setItem(this._playerList,t)}savePlayer(e,t){this._checkStorageValid();const n=e.getPlayer();if(r.default.isNullOrUndef([n]))r.default.err("GameSave","savePlayer","Cannot save null player. Forgot game.addPlayer?");else{const e=n.getName();this._savePlayerInfo(e,n.toJSON(),t)}}restorePlayer(e){if(this._checkStorageValid(),this.getPlayersAsObj().hasOwnProperty(e)){const t=this._storageRef.getItem("_battles_player_"+e),n=JSON.parse(t),s=new a.FromJSON,r=s.createGame(n.game);return this._dungeonLevel=s.getDungeonLevel(),r}return r.default.err("GameSave","restorePlayer","No player |"+e+"| found from the list."),null}_savePlayerInfo(e,t,n){let s=this._storageRef.getItem(this._playerList),r=JSON.parse(s);null===r&&(r={});const a=Object.values(t.components).find(e=>"Experience"===e.setType);r[e]={name:e,expLevel:a.setExpLevel,dungeonLevel:t.dungeonLevel};for(const t in n)t&&(r[e][t]=n[t]);s=JSON.stringify(r),this._storageRef.setItem(this._playerList,s)}_checkStorageValid(){if(r.default.isNullOrUndef([this._storageRef]))throw new Error("GameSave you must setStorage() first.")}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(21),o=n(107),i=n(28),l=n(18),c=n(20),u=n(9).Random.getRNG(),{KEY:h,KeyMap:d}=i.Keys,{getShortestPath:p}=a.Path,f=n(17)("bitn:PlayerDriver");f.enabled=!0;const m=[-1,0,1],g="=".repeat(78),y=l.EventPool.getPool();class v{constructor(e,t){this.player=e,this._game=t,this._keyBuffer=[]}setGame(e){this._game=e}setKeys(e){this._keyBuffer=e.slice()}handleClick(e,t,n,s){}reset(){this._keyBuffer=[]}hasKeys(){return this._keyBuffer.length>0}getNextCode(){return this._keyBuffer.length>0?this._keyBuffer.shift():null}}t.DriverBase=v;class _ extends v{constructor(e,t){super(e,t),this.action="",this.enemy=null,this.cmds=[],this.actions=[""],this.screen=new o.Screen(30,14),this.state={exploreTurns:0,usePassage:!1,useStairs:!1,exitZone:!1,path:[],stairsStack:[],tilesVisited:{},visitedStairs:{},visited:{}},this.maxExploreTurns=500,this.hpLow=.3,this.ppRestLimit=1,this.hpRestLimit=1,this.nTurns=0,this.screenPeriod=1e4,this._passableCallback=this._passableCallback.bind(this),this.hasNotify=!0,y.listenEvent(r.default.EVT_TILE_CHANGED,this)}setPlayer(e){this.player=e}getNextCode(){let e=super.getNextCode();return null===e&&(e=this.nextCmd()),e.code?e.code:e}hasKeys(){return!0}reset(){this.state.usePassage=!1,this.state.useStairs=!1,this.state.exitZone=!1,this.state.path=[]}nextCmd(){this.action="";const[e,t]=this.player.getXY(),n=this.player.getLevel();this.addVisited(n,e,t);const s=this.player.getLevel().getMap().getVisibleCells(this.player);this.printTurnInfo(s),this.checkForSelection(),""===this.action&&this.checkForEnemies(),""===this.action&&this.tryExploringAround(s);let r=this.getPlayerCmd();if(r||(r={code:h.REST}),f.enabled){const e=JSON.stringify(r),t=`action: |${this.action}|, cmd: ${e}`;this.debug(">>> PlayerDriver "+t)}return++this.nTurns,this.cmds.push(r),this.actions.push(this.action),r}checkForSelection(){this.player.getBrain().isMenuShown()&&(this.action="selection")}checkForEnemies(){const e=this.player.getBrain(),t=c.Brain.getCellsAroundActor(this.player).map(e=>e.getFirstActor());this.enemy=null,t.forEach(t=>{null===this.enemy&&t&&t.isEnemy(this.player)&&(this.enemy=t,this.hasEnoughHealth()?this.action="attack":e.isRunModeEnabled()?this.action="flee":this.action="run",this.state.path=[])}),""===this.action&&this.shouldRest()&&(this.action="rest")}tryExploringAround(e){const t=this.player.getLevel().getMap(),n=this.player.getCell(),[s,r]=[n.getX(),n.getY()];if(--this.state.exploreTurns,0===this.state.path.length){const a=s,o=r-1;if(this.shouldPickupFromCell(n))this.action="pickup";else if(this.shouldReturnBackUp())this.setState({useStairs:!0},"Return up true");else if(this.levelExploredEnough(e))this.setState({useStairs:!0},"new Stairs seen"),this.state.exploreTurns=this.maxExploreTurns;else if(!this.movingToConnect()&&o>=0){const n=t.getCell(a,o);n.isPassable()&&!this.cellVisited(n)?this.action="move north":(console.log("Trying to find a path to move"),this.findPathToMove(e))}else this.state.useStairs&&n.hasStairs()?(this.setState({useStairs:!1},"In stairs cell"),this.action="stairs",this.addUsedStairs(n)):this.state.usePassage&&n.hasPassage()?(this.setState({usePassage:!1},"cell hasPassage()"),this.action="stairs"):n.hasPassage()&&!this.passageVisited(n)?this.action="stairs":this.tryToFindPassage(e)}else this.action="path"}tryToSetPathToCell(e){const[t,n]=this.player.getXY();this.state.path=[],e.forEach(e=>{if(0===this.state.path.length){const[s,r]=[e.getX(),e.getY()];this.debug(`>> Looking for shortest path to cell ${s},${r}`);const a=p(t,n,s,r,this._passableCallback);a.length>1&&(this.debug("Found a non-zero path"),this.state.path=a,this.state.path.shift(),this.action="path")}})}findPathToMove(e,t=!1){const[n,s]=this.player.getXY();let r=e.filter(e=>e.isPassable());const a=e.filter(e=>e.hasDoor());t||(r=r.filter(e=>!this.cellVisited(e)));const o={north:r.filter(e=>e.getY()<s),south:r.filter(e=>e.getY()>s),east:r.filter(e=>e.getX()>n),west:r.filter(e=>e.getX()<n),doors:a};let i="";t&&(i=">>>>");let l=["north","west","east","south"];t&&(l=u.shuffle(l),console.log("Shuffled order is now",l));let c=">";l.forEach(e=>{if(0===this.state.path.length){if(this.debug(i+c+" Looking path to "+e),this.tryToSetPathToCell(o[e]),this.state.path.length>0)return void(this.action="path");c+=">"}}),""===this.action&&this.tryToSetPathToCell(o.doors),""===this.action&&(t?(console.log("We are screwed, no path found"),this.debug("We are screwed")):(this.debug(i+">>>> Looking passage out"),this.tryToFindPassage(e,!1),0===this.state.path.length?(this.debug(i+">>>>> Looking visited cells now"),this.findAlreadySeenPassage(),0===this.state.path.length&&(console.log("Trying now from visited cells"),this.findPathToMove(e,!0))):this.action="path"))}levelVisited(e){return this.state.visited.hasOwnProperty(e.getID())}cellVisited(e){const t=this.player.getLevel().getID();if(this.state.visited.hasOwnProperty(t)){const[n,s]=[e.getX(),e.getY()];return this.state.visited[t].hasOwnProperty(n+","+s)}return!1}addVisited(e,t,n){const s=e.getID();this.state.visited.hasOwnProperty(s)||(this.state.visited[s]={});const r=this.player.getCell();this.state.visited[s][t+","+n]={x:t,y:n,hasPassage:r.hasPassage()}}hasEnoughHealth(){const e=this.player.get("Health"),t=e.getMaxHP();return e.getHP()>Math.round(this.hpLow*t)}shouldRest(){if(this.player.has("SpellPower")){const e=this.player.get("SpellPower"),t=e.getPP(),n=e.getMaxPP();return t<this.ppRestLimit*n}const e=this.player.get("Health"),t=e.getMaxHP();return e.getHP()<this.hpRestLimit*t}newStairsSeen(e){const t=this.player.getLevel().getID(),n=e.find(e=>{const[n,s]=[e.getX(),e.getY()];return this.state.visitedStairs.hasOwnProperty(t)?!this.state.visitedStairs[t][n+","+s]&&e.hasStairs():e.hasStairs()});return!!(n&&(this.tryToSetPathToCell([n]),this.state.path.length>0))&&(this.debug("Found path to stairs. Going there."),!0)}tryToFindPassage(e,t=!0){this.debug("> Looking for north passage cells");const n=e.filter(e=>e.hasPassage()&&0===e.getY()&&!this.passageVisited(e));if(this.debug("> N passageCells "+n.length),this.tryToSetPathToCell(n),this.state.path.length>0)this.setState({usePassage:!0},"north passage"),this.action="path";else{this.debug(">> Looking for west passage cells");const n=e.filter(e=>e.hasPassage()&&0===e.getX()&&!this.passageVisited(e));if(this.tryToSetPathToCell(n),this.state.path.length>0)this.setState({usePassage:!0},"west passage"),this.action="path";else{this.debug(">> Looking for any passage cells");const n=e.filter(e=>e.hasPassage()&&!this.passageVisited(e));this.tryToSetPathToCell(n),this.state.path.length>0?(this.setState({usePassage:!0},"any passage"),this.action="path"):t?(this.debug(">>> No passages. Trying to move."),this.findPathToMove(e)):this.debug(">>> No passages. Terminating.")}}}passageVisited(e){const t=e.getPassage().getTargetLevel();return this.levelVisited(t)}findAlreadySeenPassage(){this.debug("Looking at remembered passages");const e=this.findVisitedCells(e=>e.hasPassage()&&!this.passageVisited(e));if(this.debug("Looking at non-visited passages"),this.tryToSetPathToCell(e),this.state.path.length>0)this.setState({usePassage:!0},"already seen passage"),this.action="path";else{this.debug("Looking at visited passages");const e=this.findVisitedCells(e=>e.hasPassage());this.tryToSetPathToCell(e),this.state.path.length>0?(this.setState({usePassage:!0},"already seen passage"),this.action="path"):this.debug("Nothing found among passages. Screwed!")}}findVisitedCells(e){const t=this.player.getLevel().getMap(),n=this.player.getLevel().getID();return Object.values(this.state.visited[n]).map(e=>t.getCell(e.x,e.y)).filter(e)}getPlayerCmd(){const e=this.enemy,t=this.player.getLevel().getMap(),[n,s]=this.player.getXY();let a=null;if("attack"===this.action){const[t,r]=[e.getX(),e.getY()],o=t-n,i=r-s,l=d.dirToKeyCode(o,i);if(this.canCastSpell()){a={code:h.POWER};const e=this.getCodeForSpell();e>=0?this._keyBuffer=[e,l]:a={code:l}}else a={code:l}}else if("pickup"===this.action)a={code:h.PICKUP};else if("flee"===this.action){if(this.player.getCell().hasPassage())a={code:h.USE_STAIRS_DOWN};else{const[r,o]=[e.getX(),e.getY()],i=-1*(r-n),l=-1*(o-s),c=n+i,h=s+l;if(t.isPassable(c,h)){const e=d.dirToKeyCode(i,l);this.debug(`flee to dx,dy ${i},${l}`),a={code:e}}else{this.debug("Pick random direction for fleeing");let r=u.arrayGetRand(m),o=u.arrayGetRand(m);const i=20;let l=0;for(;!(t.isPassable(n+r,s+o)||(r=u.arrayGetRand(m),o=u.arrayGetRand(m),++l>=i)););if(t.isPassable(r,o)){this.debug(`flee rand dir to dx,dy ${r},${o}`),a={code:d.dirToKeyCode(r,o)}}else{const[t,r]=[e.getX(),e.getY()],o=e.getName();this.debug(`No escape! Attack ${o} @${t},${r}`);const i=t-n,l=r-s;a={code:d.dirToKeyCode(i,l)}}}}}else if("move north"===this.action)a={code:h.MOVE_N};else if("stairs"===this.action)a={code:h.USE_STAIRS_DOWN};else if("path"===this.action){0===this.state.path.length&&r.default.err("PlayerDriver","getPlayerCmd","Tried to shift coord from 0 length path");let{x:e,y:t}=this.state.path.shift();const o=(e=parseInt(e,10))-n,i=(t=parseInt(t,10))-s;this.debug(`Taking action path ${e},${t}, dX,dY ${o},${i}`),a={code:d.dirToKeyCode(o,i)},0===this.state.path.length&&this.debug("PlayerDriver finished a path")}else"run"===this.action?a={code:h.RUN}:"selection"===this.action&&(a={code:i.Keys.selectIndexToCode(0)});return a}getLastAction(){return this.actions[this.actions.length-1]}printTurnInfo(e){const[t,n]=this.player.getXY(),s=this.player.getLevel(),r=s.getMap(),a=this.player.get("Health").getHP(),o=`@${t},${n} ID: ${s.getID()}`;f.enabled&&console.log(g),this.debug(`T: ${this.nTurns} ${o} | HP: ${a}`),this.nTurns%this.screenPeriod==0&&(this.screen.render(t,n,r,e),this.screen.printRenderedChars(),console.log("=".repeat(78)+"\n"))}addUsedStairs(e){if(this.state.exitZone)return this.state.stairsStack.pop(),this.debug("POP: stairsStack is now ",this.state.stairsStack),void this.setState({exitZone:!1},"addUsedStairs");const t=e.getStairs(),n=t.getTargetStairs(),s=t.getTargetLevel().getID(),r=this.player.getLevel().getID();this.state.visitedStairs.hasOwnProperty(r)||(this.state.visitedStairs[r]={});const[a,o]=[t.getX(),t.getY()];this.state.visitedStairs[r][a+","+o]=[a,o];const[i,l]=[n.getX(),n.getY()];this.state.stairsStack.push([s,i,l]),this.debug("PUSH: stairsStack is now ",this.state.stairsStack),this.state.visitedStairs[s]||(this.state.visitedStairs[s]={}),this.state.visitedStairs[s][i+","+l]=[s,i,l]}movingToConnect(){return this.state.useStairs||this.state.usePassage}getStairsMRU(){const e=this.state.stairsStack.length-1;return this.state.stairsStack[e]}shouldReturnBackUp(){if(this.state.stairsStack.length>0&&this.state.exploreTurns<=0){const e=this.getStairsMRU(),t=e[1],n=e[2],s=this.player.getLevel().getMap().getCell(t,n);if(this.tryToSetPathToCell([s]),this.state.path.length>0)return this.action="path",this.debug("Returning back up the stairs now"),this.setState({exitZone:!0},"shouldReturn"),!0;this.debug("Cannot find path to return back")}return!1}toJSON(){return{cmds:this.cmds,actions:this.actions,nTurns:this.nTurns,state:this.state}}debug(e,t=null){if(f.enabled){const n=`T${this.nTurns}: `;let s="";t&&(s="\n"+JSON.stringify(t)),f(`${n}${e}${s}`)}}setState(e,t=null){if(t&&f.enabled){const n=JSON.stringify(e);this.debug(`setState with ${n} |${t}|`)}Object.keys(e).forEach(t=>{this.state[t]=e[t]})}levelExploredEnough(e){return this.state.exploreTurns<=0&&!this.movingToConnect()&&this.newStairsSeen(e)}shouldPickupFromCell(e){if(e.hasItems()){if(e.getItems()[0].getType()!==r.default.ITEM_CORPSE)return"pickup"!==this.getLastAction()}return!1}notify(e,t){if(e===r.default.EVT_TILE_CHANGED){const{actor:e,target:n}=t;if(e===this.player){const e=n.getID();this.state.tilesVisited[e]||(this.state.tilesVisited[e]=0),this.state.tilesVisited[e]+=1}}}_passableCallback(e,t){const n=this.player.getLevel().getMap();let s=n.isPassable(e,t);if(s||(s=e===this.player.getX()&&t===this.player.getY()),!s&&n.hasXY(e,t)){s=n.getCell(e,t).hasDoor()}return s}canCastSpell(){if(this.player.get("SpellPower")){const e=this.player.getBook();if(e){return e.getSpells()[0].canCast()}}return!1}getCodeForSpell(){const e=this.player.getBook().getSpells().filter(e=>e.hasDice("damage"));if(0===e.length)return-1;const t={};let n=0;e.forEach((e,s)=>{if(e.canCast()){const r=e.getCastingPower();n+=r,t[s]=r}}),Object.keys(t).forEach(e=>{t[e]=n-t[e]});let s=u.getWeighted(t);s=parseInt(s,10);const r=i.Keys.menuIndices[s];return i.Keys.selectIndexToCode(r)}}t.PlayerDriver=_,_.fromJSON=function(e){const t=new _;return Object.keys(e).forEach(n=>{t[n]=e[n]}),t}},function(e,t){
/*!
 * assertion-error
 * Copyright(c) 2013 Jake Luer <jake@qualiancy.com>
 * MIT Licensed
 */
/*!
 * Return a function that will copy properties from
 * one object to another excluding any originally
 * listed. Returned function will create a new `{}`.
 *
 * @param {String} excluded properties ...
 * @return {Function}
 */
function n(){var e=[].slice.call(arguments);function t(t,n){Object.keys(n).forEach(function(s){~e.indexOf(s)||(t[s]=n[s])})}return function(){for(var e=[].slice.call(arguments),n=0,s={};n<e.length;n++)t(s,e[n]);return s}}function s(e,t,r){var a=n("name","message","stack","constructor","toJSON")(t||{});for(var o in this.message=e||"Unspecified AssertionError",this.showDiff=!1,a)this[o]=a[o];if(r=r||s,Error.captureStackTrace)Error.captureStackTrace(this,r);else try{throw new Error}catch(e){this.stack=e.stack}}
/*!
 * Inherit from Error.prototype
 */
/*!
 * Primary Exports
 */
e.exports=s,s.prototype=Object.create(Error.prototype),
/*!
 * Statically set name
 */
s.prototype.name="AssertionError",
/*!
 * Ensure correct constructor
 */
s.prototype.constructor=s,s.prototype.toJSON=function(e){var t=n("constructor","toJSON","stack")({name:this.name},this);return!1!==e&&this.stack&&(t.stack=this.stack),t}},function(e,t){
/*!
 * Chai - getActual utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t){return t.length>4?t[4]:e._obj}},function(e,t){
/*!
 * Chai - getName utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e){if(e.name)return e.name;var t=/^\s?function ([^(]*)\(/.exec(e);return t&&t[1]?t[1]:""}},function(e,t,n){
/*!
 * Chai - flag utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
/*!
 * Module dependancies
 */
var s=n(164),r=n(75);e.exports=function(e){var t=s(e),n=Object.prototype.toString.call(e);if(r.truncateThreshold&&t.length>=r.truncateThreshold){if("[object Function]"===n)return e.name&&""!==e.name?"[Function: "+e.name+"]":"[Function]";if("[object Array]"===n)return"[ Array("+e.length+") ]";if("[object Object]"===n){var a=Object.keys(e);return"{ Object ("+(a.length>2?a.splice(0,2).join(", ")+", ...":a.join(", "))+") }"}return t}return t}},function(e,t){
/*!
 * Chai - transferFlags utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t,n){var s=e.__flags||(e.__flags=Object.create(null));for(var r in t.__flags||(t.__flags=Object.create(null)),n=3!==arguments.length||n,s)(n||"object"!==r&&"ssfi"!==r&&"message"!=r)&&(t.__flags[r]=s[r])}},function(e,t,n){
/*!
 * Chai - getPathInfo utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
var s=n(261);
/*!
 * ## _getPathValue(parsed, obj)
 *
 * Helper companion function for `.parsePath` that returns
 * the value located at the parsed address.
 *
 *      var value = getPathValue(parsed, obj);
 *
 * @param {Object} parsed definition from `parsePath`.
 * @param {Object} object to search against
 * @param {Number} object to search against
 * @returns {Object|Undefined} value
 * @api private
 */
function r(e,t,n){for(var s,r=t,a=0,o=n=void 0===n?e.length:n;a<o;a++){var i=e[a];r?(void 0!==i.p?r=r[i.p]:void 0!==i.i&&(r=r[i.i]),a==o-1&&(s=r)):s=void 0}return s}e.exports=function(e,t){var n=
/*!
 * ## parsePath(path)
 *
 * Helper function used to parse string object
 * paths. Use in conjunction with `_getPathValue`.
 *
 *      var parsed = parsePath('myobject.property.subprop');
 *
 * ### Paths:
 *
 * * Can be as near infinitely deep and nested
 * * Arrays are also valid using the formal `myobject.document[3].property`.
 * * Literal dots and brackets (not delimiter) must be backslash-escaped.
 *
 * @param {String} path
 * @returns {Object} parsed
 * @api private
 */
function(e){return e.replace(/([^\\])\[/g,"$1.[").match(/(\\\.|[^.]+?)+/g).map(function(e){var t=/^\[(\d+)\]$/.exec(e);return t?{i:parseFloat(t[1])}:{p:e.replace(/\\([.\[\]])/g,"$1")}})}(e),a=n[n.length-1],o={parent:n.length>1?r(n,t,n.length-1):t,name:a.p||a.i,value:r(n,t)};return o.exists=s(o.name,o.parent),o}},function(e,t,n){
/*!
 * Chai - hasProperty utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
var s=n(163),r={number:Number,string:String};e.exports=function(e,t){var n=s(t);return"null"!==n&&"undefined"!==n&&(r[n]&&"object"!=typeof t&&(t=new r[n](t)),e in t)}},function(e,t,n){"use strict";n.r(t);var s={};n.r(s),n.d(s,"prefix",function(){return G}),n.d(s,"bsClass",function(){return F}),n.d(s,"bsStyles",function(){return W}),n.d(s,"bsSizes",function(){return Y}),n.d(s,"getClassSet",function(){return j}),n.d(s,"splitBsProps",function(){return $}),n.d(s,"splitBsPropsAndOmit",function(){return K}),n.d(s,"addStyle",function(){return V}),n.d(s,"_curry",function(){return H});var r={};n.r(r),n.d(r,"bootstrapUtils",function(){return s}),n.d(r,"createChainedFunction",function(){return q}),n.d(r,"ValidComponentChildren",function(){return J});var a=n(2),o=n.n(a),i=n(4),l=n.n(i),c=n(5),u=n.n(c),h=n(6),d=n.n(h),p=n(1),f=n.n(p),m=n(166),g=n.n(m),y=n(7),v=n.n(y),_=n(3),b=n.n(_),E=n(0),S=n.n(E),C=n(100),w=n.n(C),T=n(77),O=n.n(T),M="large",A="small",N="xsmall",P={large:"lg",medium:"md",small:"sm",xsmall:"xs",lg:"lg",md:"md",sm:"sm",xs:"xs"},x=["lg","md","sm","xs"],I={SUCCESS:"success",WARNING:"warning",DANGER:"danger",INFO:"info"},D="default",k="primary",L="link",R="inverse";function B(e){return function(){for(var t=arguments.length,n=Array(t),s=0;s<t;s++)n[s]=arguments[s];return"function"==typeof n[n.length-1]?e.apply(void 0,n):function(t){return e.apply(void 0,n.concat([t]))}}}function G(e,t){return null==e.bsClass&&O()(!1),e.bsClass+(t?"-"+t:"")}var F=B(function(e,t){var n=t.propTypes||(t.propTypes={}),s=t.defaultProps||(t.defaultProps={});return n.bsClass=S.a.string,s.bsClass=e,t}),W=B(function(e,t,n){"string"!=typeof t&&(n=t,t=void 0);var s=n.STYLES||[],r=n.propTypes||{};e.forEach(function(e){-1===s.indexOf(e)&&s.push(e)});var a=S.a.oneOf(s);(n.STYLES=s,a._values=s,n.propTypes=o()({},r,{bsStyle:a}),void 0!==t)&&((n.defaultProps||(n.defaultProps={})).bsStyle=t);return n}),Y=B(function(e,t,n){"string"!=typeof t&&(n=t,t=void 0);var s=n.SIZES||[],r=n.propTypes||{};e.forEach(function(e){-1===s.indexOf(e)&&s.push(e)});var a=[];s.forEach(function(e){var t=P[e];t&&t!==e&&a.push(t),a.push(e)});var i=S.a.oneOf(a);return i._values=a,n.SIZES=s,n.propTypes=o()({},r,{bsSize:i}),void 0!==t&&(n.defaultProps||(n.defaultProps={}),n.defaultProps.bsSize=t),n});function j(e){var t,n=((t={})[G(e)]=!0,t);e.bsSize&&(n[G(e,P[e.bsSize]||e.bsSize)]=!0);return e.bsStyle&&(n[G(e,e.bsStyle)]=!0),n}function X(e){return{bsClass:e.bsClass,bsSize:e.bsSize,bsStyle:e.bsStyle,bsRole:e.bsRole}}function U(e){return"bsClass"===e||"bsSize"===e||"bsStyle"===e||"bsRole"===e}function $(e){var t={};return w()(e).forEach(function(e){var n=e[0],s=e[1];U(n)||(t[n]=s)}),[X(e),t]}function K(e,t){var n={};t.forEach(function(e){n[e]=!0});var s={};return w()(e).forEach(function(e){var t=e[0],r=e[1];U(t)||n[t]||(s[t]=r)}),[X(e),s]}function V(e){for(var t=arguments.length,n=Array(t>1?t-1:0),s=1;s<t;s++)n[s-1]=arguments[s];W(n,e)}var H=B;var q=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.filter(function(e){return null!=e}).reduce(function(e,t){if("function"!=typeof t)throw new Error("Invalid Argument Type, must only provide functions, undefined, or null.");return null===e?t:function(){for(var n=arguments.length,s=Array(n),r=0;r<n;r++)s[r]=arguments[r];e.apply(this,s),t.apply(this,s)}},null)};var J={map:function(e,t,n){var s=0;return f.a.Children.map(e,function(e){return f.a.isValidElement(e)?t.call(n,e,s++):e})},forEach:function(e,t,n){var s=0;f.a.Children.forEach(e,function(e){f.a.isValidElement(e)&&t.call(n,e,s++)})},count:function(e){var t=0;return f.a.Children.forEach(e,function(e){f.a.isValidElement(e)&&++t}),t},find:function(e,t,n){var s=0,r=void 0;return f.a.Children.forEach(e,function(e){r||f.a.isValidElement(e)&&t.call(n,e,s++)&&(r=e)}),r},filter:function(e,t,n){var s=0,r=[];return f.a.Children.forEach(e,function(e){f.a.isValidElement(e)&&t.call(n,e,s++)&&r.push(e)}),r},every:function(e,t,n){var s=0,r=!0;return f.a.Children.forEach(e,function(e){r&&f.a.isValidElement(e)&&(t.call(n,e,s++)||(r=!1))}),r},some:function(e,t,n){var s=0,r=!1;return f.a.Children.forEach(e,function(e){r||f.a.isValidElement(e)&&t.call(n,e,s++)&&(r=!0)}),r},toArray:function(e){var t=[];return f.a.Children.forEach(e,function(e){f.a.isValidElement(e)&&t.push(e)}),t}},z={accordion:S.a.bool,activeKey:S.a.any,defaultActiveKey:S.a.any,onSelect:S.a.func,role:S.a.string},Q=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleSelect=r.handleSelect.bind(r),r.state={activeKey:n.defaultActiveKey},r}return d()(t,e),t.prototype.handleSelect=function(e,t){t.preventDefault(),this.props.onSelect&&this.props.onSelect(e,t),this.state.activeKey===e&&(e=null),this.setState({activeKey:e})},t.prototype.render=function(){var e=this,t=this.props,n=t.accordion,s=t.activeKey,r=t.className,a=t.children,i=K(v()(t,["accordion","activeKey","className","children"]),["defaultActiveKey","onSelect"]),l=i[0],c=i[1],u=void 0;n&&(u=null!=s?s:this.state.activeKey,c.role=c.role||"tablist");var h=j(l);return f.a.createElement("div",o()({},c,{className:b()(r,h)}),J.map(a,function(t){var s={bsStyle:t.props.bsStyle||l.bsStyle};return n&&g()(s,{headerRole:"tab",panelRole:"tabpanel",collapsible:!0,expanded:t.props.eventKey===u,onSelect:q(e.handleSelect,t.props.onSelect)}),Object(p.cloneElement)(t,s)}))},t}(f.a.Component);Q.propTypes=z,Q.defaultProps={accordion:!1};var Z=F("panel-group",Q),ee=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){return f.a.createElement(Z,o()({},this.props,{accordion:!0}),this.props.children)},t}(f.a.Component),te=n(32),ne=n.n(te),se={label:S.a.string.isRequired,onClick:S.a.func},re=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.label,n=e.onClick;return f.a.createElement("button",{type:"button",className:"close",onClick:n},f.a.createElement("span",{"aria-hidden":"true"},"×"),f.a.createElement("span",{className:"sr-only"},t))},t}(f.a.Component);re.propTypes=se,re.defaultProps={label:"Close"};var ae=re,oe={onDismiss:S.a.func,closeLabel:S.a.string},ie=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.onDismiss,s=t.closeLabel,r=t.className,a=t.children,i=$(v()(t,["onDismiss","closeLabel","className","children"])),l=i[0],c=i[1],u=!!n,h=o()({},j(l),((e={})[G(l,"dismissable")]=u,e));return f.a.createElement("div",o()({},c,{role:"alert",className:b()(r,h)}),u&&f.a.createElement(ae,{onClick:n,label:s}),a)},t}(f.a.Component);ie.propTypes=oe,ie.defaultProps={closeLabel:"Close alert"};var le=W(ne()(I),I.INFO,F("alert",ie)),ce={pullRight:S.a.bool},ue=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.hasContent=function(e){var t=!1;return f.a.Children.forEach(e,function(e){t||(e||0===e)&&(t=!0)}),t},t.prototype.render=function(){var e=this.props,t=e.pullRight,n=e.className,s=e.children,r=$(v()(e,["pullRight","className","children"])),a=r[0],i=r[1],l=o()({},j(a),{"pull-right":t,hidden:!this.hasContent(s)});return f.a.createElement("span",o()({},i,{className:b()(n,l)}),s)},t}(f.a.Component);ue.propTypes=ce,ue.defaultProps={pullRight:!1};var he=F("badge",ue),de=n(10),pe=n.n(de),fe={href:S.a.string,onClick:S.a.func,onKeyDown:S.a.func,disabled:S.a.bool,role:S.a.string,tabIndex:S.a.oneOfType([S.a.number,S.a.string]),componentClass:pe.a};function me(e){return!e||"#"===e.trim()}var ge=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleClick=r.handleClick.bind(r),r.handleKeyDown=r.handleKeyDown.bind(r),r}return d()(t,e),t.prototype.handleClick=function(e){var t=this.props,n=t.disabled,s=t.href,r=t.onClick;(n||me(s))&&e.preventDefault(),n?e.stopPropagation():r&&r(e)},t.prototype.handleKeyDown=function(e){" "===e.key&&(e.preventDefault(),this.handleClick(e))},t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.disabled,s=e.onKeyDown,r=v()(e,["componentClass","disabled","onKeyDown"]);return me(r.href)&&(r.role=r.role||"button",r.href=r.href||"#"),n&&(r.tabIndex=-1,r.style=o()({pointerEvents:"none"},r.style)),f.a.createElement(t,o()({},r,{onClick:this.handleClick,onKeyDown:q(this.handleKeyDown,s)}))},t}(f.a.Component);ge.propTypes=fe,ge.defaultProps={componentClass:"a"};var ye=ge,ve={active:S.a.bool,href:S.a.string,title:S.a.node,target:S.a.string},_e=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.active,n=e.href,s=e.title,r=e.target,a=e.className,i=v()(e,["active","href","title","target","className"]),l={href:n,title:s,target:r};return f.a.createElement("li",{className:b()(a,{active:t})},t?f.a.createElement("span",i):f.a.createElement(ye,o()({},i,l)))},t}(f.a.Component);_e.propTypes=ve,_e.defaultProps={active:!1};var be=_e,Ee=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=j(s);return f.a.createElement("ol",o()({},r,{role:"navigation","aria-label":"breadcrumbs",className:b()(t,a)}))},t}(f.a.Component);Ee.Item=be;var Se=F("breadcrumb",Ee),Ce={active:S.a.bool,disabled:S.a.bool,block:S.a.bool,onClick:S.a.func,componentClass:pe.a,href:S.a.string,type:S.a.oneOf(["button","reset","submit"])},we=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.renderAnchor=function(e,t){return f.a.createElement(ye,o()({},e,{className:b()(t,e.disabled&&"disabled")}))},t.prototype.renderButton=function(e,t){var n=e.componentClass,s=v()(e,["componentClass"]),r=n||"button";return f.a.createElement(r,o()({},s,{type:s.type||"button",className:t}))},t.prototype.render=function(){var e,t=this.props,n=t.active,s=t.block,r=t.className,a=$(v()(t,["active","block","className"])),i=a[0],l=a[1],c=o()({},j(i),((e={active:n})[G(i,"block")]=s,e)),u=b()(r,c);return l.href?this.renderAnchor(l,u):this.renderButton(l,u)},t}(f.a.Component);we.propTypes=Ce,we.defaultProps={active:!1,block:!1,disabled:!1};var Te=F("btn",Y([M,A,N],W([].concat(ne()(I),[D,k,L]),D,we))),Oe=n(50),Me=n.n(Oe),Ae={vertical:S.a.bool,justified:S.a.bool,block:Me()(S.a.bool,function(e){var t=e.block,n=e.vertical;return t&&!n?new Error("`block` requires `vertical` to be set to have any effect"):null})},Ne=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.block,s=t.justified,r=t.vertical,a=t.className,i=$(v()(t,["block","justified","vertical","className"])),l=i[0],c=i[1],u=o()({},j(l),((e={})[G(l)]=!r,e[G(l,"vertical")]=r,e[G(l,"justified")]=s,e[G(Te.defaultProps,"block")]=n,e));return f.a.createElement("div",o()({},c,{className:b()(a,u)}))},t}(f.a.Component);Ne.propTypes=Ae,Ne.defaultProps={block:!1,justified:!1,vertical:!1};var Pe=F("btn-group",Ne),xe=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=j(s);return f.a.createElement("div",o()({},r,{role:"toolbar",className:b()(t,a)}))},t}(f.a.Component),Ie=F("btn-toolbar",xe),De={componentClass:pe.a},ke=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=j(r);return f.a.createElement(t,o()({},a,{className:b()(n,i)}))},t}(f.a.Component);ke.propTypes=De,ke.defaultProps={componentClass:"div"};var Le=F("carousel-caption",ke),Re=n(13),Be=n.n(Re),Ge=!("undefined"==typeof window||!window.document||!window.document.createElement),Fe={transitionend:{transition:"transitionend",WebkitTransition:"webkitTransitionEnd",MozTransition:"mozTransitionEnd",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd"},animationend:{animation:"animationend",WebkitAnimation:"webkitAnimationEnd",MozAnimation:"mozAnimationEnd",OAnimation:"oAnimationEnd",msAnimation:"MSAnimationEnd"}},We=[];Ge&&function(){var e=document.createElement("div").style;for(var t in"AnimationEvent"in window||delete Fe.animationend.animation,"TransitionEvent"in window||delete Fe.transitionend.transition,Fe){var n=Fe[t];for(var s in n)if(s in e){We.push(n[s]);break}}}();var Ye={addEndEventListener:function(e,t){0!==We.length?We.forEach(function(n){!function(e,t,n){e.addEventListener(t,n,!1)}(e,n,t)}):window.setTimeout(t,0)},removeEndEventListener:function(e,t){0!==We.length&&We.forEach(function(n){!function(e,t,n){e.removeEventListener(t,n,!1)}(e,n,t)})}},je={direction:S.a.oneOf(["prev","next"]),onAnimateOutEnd:S.a.func,active:S.a.bool,animateIn:S.a.bool,animateOut:S.a.bool,index:S.a.number},Xe=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleAnimateOutEnd=r.handleAnimateOutEnd.bind(r),r.state={direction:null},r.isUnmounted=!1,r}return d()(t,e),t.prototype.componentWillReceiveProps=function(e){this.props.active!==e.active&&this.setState({direction:null})},t.prototype.componentDidUpdate=function(e){var t=this,n=this.props.active,s=e.active;!n&&s&&Ye.addEndEventListener(Be.a.findDOMNode(this),this.handleAnimateOutEnd),n!==s&&setTimeout(function(){return t.startAnimation()},20)},t.prototype.componentWillUnmount=function(){this.isUnmounted=!0},t.prototype.handleAnimateOutEnd=function(){this.isUnmounted||this.props.onAnimateOutEnd&&this.props.onAnimateOutEnd(this.props.index)},t.prototype.startAnimation=function(){this.isUnmounted||this.setState({direction:"prev"===this.props.direction?"right":"left"})},t.prototype.render=function(){var e=this.props,t=e.direction,n=e.active,s=e.animateIn,r=e.animateOut,a=e.className,i=v()(e,["direction","active","animateIn","animateOut","className"]);delete i.onAnimateOutEnd,delete i.index;var l={item:!0,active:n&&!s||r};return t&&n&&s&&(l[t]=!0),this.state.direction&&(s||r)&&(l[this.state.direction]=!0),f.a.createElement("div",o()({},i,{className:b()(a,l)}))},t}(f.a.Component);Xe.propTypes=je,Xe.defaultProps={active:!1,animateIn:!1,animateOut:!1};var Ue=Xe,$e={glyph:S.a.string.isRequired},Ke=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.glyph,s=t.className,r=$(v()(t,["glyph","className"])),a=r[0],i=r[1],l=o()({},j(a),((e={})[G(a,n)]=!0,e));return f.a.createElement("span",o()({},i,{className:b()(s,l)}))},t}(f.a.Component);Ke.propTypes=$e;var Ve=F("glyphicon",Ke),He={slide:S.a.bool,indicators:S.a.bool,interval:S.a.number,controls:S.a.bool,pauseOnHover:S.a.bool,wrap:S.a.bool,onSelect:S.a.func,onSlideEnd:S.a.func,activeIndex:S.a.number,defaultActiveIndex:S.a.number,direction:S.a.oneOf(["prev","next"]),prevIcon:S.a.node,prevLabel:S.a.string,nextIcon:S.a.node,nextLabel:S.a.string},qe={slide:!0,interval:5e3,pauseOnHover:!0,wrap:!0,indicators:!0,controls:!0,prevIcon:f.a.createElement(Ve,{glyph:"chevron-left"}),prevLabel:"Previous",nextIcon:f.a.createElement(Ve,{glyph:"chevron-right"}),nextLabel:"Next"},Je=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));r.handleMouseOver=r.handleMouseOver.bind(r),r.handleMouseOut=r.handleMouseOut.bind(r),r.handlePrev=r.handlePrev.bind(r),r.handleNext=r.handleNext.bind(r),r.handleItemAnimateOutEnd=r.handleItemAnimateOutEnd.bind(r);var a=n.defaultActiveIndex;return r.state={activeIndex:null!=a?a:0,previousActiveIndex:null,direction:null},r.isUnmounted=!1,r}return d()(t,e),t.prototype.componentDidMount=function(){this.waitForNext()},t.prototype.componentWillReceiveProps=function(e){var t=this.getActiveIndex();null!=e.activeIndex&&e.activeIndex!==t&&(clearTimeout(this.timeout),this.setState({previousActiveIndex:t,direction:null!=e.direction?e.direction:this.getDirection(t,e.activeIndex)})),null==e.activeIndex&&this.state.activeIndex>=e.children.length&&this.setState({activeIndex:0,previousActiveIndex:null,direction:null})},t.prototype.componentWillUnmount=function(){clearTimeout(this.timeout),this.isUnmounted=!0},t.prototype.getActiveIndex=function(){var e=this.props.activeIndex;return null!=e?e:this.state.activeIndex},t.prototype.getDirection=function(e,t){return e===t?null:e>t?"prev":"next"},t.prototype.handleItemAnimateOutEnd=function(){var e=this;this.setState({previousActiveIndex:null,direction:null},function(){e.waitForNext(),e.props.onSlideEnd&&e.props.onSlideEnd()})},t.prototype.handleMouseOut=function(){this.isPaused&&this.play()},t.prototype.handleMouseOver=function(){this.props.pauseOnHover&&this.pause()},t.prototype.handleNext=function(e){var t=this.getActiveIndex()+1;if(t>J.count(this.props.children)-1){if(!this.props.wrap)return;t=0}this.select(t,e,"next")},t.prototype.handlePrev=function(e){var t=this.getActiveIndex()-1;if(t<0){if(!this.props.wrap)return;t=J.count(this.props.children)-1}this.select(t,e,"prev")},t.prototype.pause=function(){this.isPaused=!0,clearTimeout(this.timeout)},t.prototype.play=function(){this.isPaused=!1,this.waitForNext()},t.prototype.select=function(e,t,n){if(clearTimeout(this.timeout),!this.isUnmounted){var s=this.props.slide?this.getActiveIndex():null;n=n||this.getDirection(s,e);var r=this.props.onSelect;if(r&&(r.length>1?(t?(t.persist(),t.direction=n):t={direction:n},r(e,t)):r(e)),null==this.props.activeIndex&&e!==s){if(null!=this.state.previousActiveIndex)return;this.setState({activeIndex:e,previousActiveIndex:s,direction:n})}}},t.prototype.waitForNext=function(){var e=this.props,t=e.slide,n=e.interval,s=e.activeIndex;!this.isPaused&&t&&n&&null==s&&(this.timeout=setTimeout(this.handleNext,n))},t.prototype.renderControls=function(e){var t=e.wrap,n=e.children,s=e.activeIndex,r=e.prevIcon,a=e.nextIcon,o=e.bsProps,i=e.prevLabel,l=e.nextLabel,c=G(o,"control"),u=J.count(n);return[(t||0!==s)&&f.a.createElement(ye,{key:"prev",className:b()(c,"left"),onClick:this.handlePrev},r,i&&f.a.createElement("span",{className:"sr-only"},i)),(t||s!==u-1)&&f.a.createElement(ye,{key:"next",className:b()(c,"right"),onClick:this.handleNext},a,l&&f.a.createElement("span",{className:"sr-only"},l))]},t.prototype.renderIndicators=function(e,t,n){var s=this,r=[];return J.forEach(e,function(e,n){r.push(f.a.createElement("li",{key:n,className:n===t?"active":null,onClick:function(e){return s.select(n,e)}})," ")}),f.a.createElement("ol",{className:G(n,"indicators")},r)},t.prototype.render=function(){var e=this,t=this.props,n=t.slide,s=t.indicators,r=t.controls,a=t.wrap,i=t.prevIcon,l=t.prevLabel,c=t.nextIcon,u=t.nextLabel,h=t.className,d=t.children,m=v()(t,["slide","indicators","controls","wrap","prevIcon","prevLabel","nextIcon","nextLabel","className","children"]),g=this.state,y=g.previousActiveIndex,_=g.direction,E=K(m,["interval","pauseOnHover","onSelect","onSlideEnd","activeIndex","defaultActiveIndex","direction"]),S=E[0],C=E[1],w=this.getActiveIndex(),T=o()({},j(S),{slide:n});return f.a.createElement("div",o()({},C,{className:b()(h,T),onMouseOver:this.handleMouseOver,onMouseOut:this.handleMouseOut}),s&&this.renderIndicators(d,w,S),f.a.createElement("div",{className:G(S,"inner")},J.map(d,function(t,s){var r=s===w,a=n&&s===y;return Object(p.cloneElement)(t,{active:r,index:s,animateOut:a,animateIn:r&&null!=y&&n,direction:_,onAnimateOutEnd:a?e.handleItemAnimateOutEnd:null})})),r&&this.renderControls({wrap:a,children:d,activeIndex:w,prevIcon:i,prevLabel:l,nextIcon:c,nextLabel:u,bsProps:S}))},t}(f.a.Component);Je.propTypes=He,Je.defaultProps=qe,Je.Caption=Le,Je.Item=Ue;var ze=F("carousel",Je),Qe=(n(24),{inline:S.a.bool,disabled:S.a.bool,title:S.a.string,validationState:S.a.oneOf(["success","warning","error",null]),inputRef:S.a.func}),Ze=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.inline,n=e.disabled,s=e.validationState,r=e.inputRef,a=e.className,i=e.style,l=e.title,c=e.children,u=$(v()(e,["inline","disabled","validationState","inputRef","className","style","title","children"])),h=u[0],d=u[1],p=f.a.createElement("input",o()({},d,{ref:r,type:"checkbox",disabled:n}));if(t){var m,g=((m={})[G(h,"inline")]=!0,m.disabled=n,m);return f.a.createElement("label",{className:b()(a,g),style:i,title:l},p,c)}var y=o()({},j(h),{disabled:n});return s&&(y["has-"+s]=!0),f.a.createElement("div",{className:b()(a,y),style:i},f.a.createElement("label",{title:l},p,c))},t}(f.a.Component);Ze.propTypes=Qe,Ze.defaultProps={inline:!1,disabled:!1,title:""};var et=F("checkbox",Ze);function tt(e){return""+e.charAt(0).toUpperCase()+e.slice(1)}var nt={componentClass:pe.a,visibleXsBlock:S.a.bool,visibleSmBlock:S.a.bool,visibleMdBlock:S.a.bool,visibleLgBlock:S.a.bool},st=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=j(r);return x.forEach(function(e){var t="visible"+tt(e)+"Block";a[t]&&(i["visible-"+e+"-block"]=!0),delete a[t]}),f.a.createElement(t,o()({},a,{className:b()(n,i)}))},t}(f.a.Component);st.propTypes=nt,st.defaultProps={componentClass:"div"};var rt=F("clearfix",st),at={htmlFor:S.a.string,srOnly:S.a.bool},ot={$bs_formGroup:S.a.object},it=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.context.$bs_formGroup,t=e&&e.controlId,n=this.props,s=n.htmlFor,r=void 0===s?t:s,a=n.srOnly,i=n.className,l=$(v()(n,["htmlFor","srOnly","className"])),c=l[0],u=l[1],h=o()({},j(c),{"sr-only":a});return f.a.createElement("label",o()({},u,{htmlFor:r,className:b()(i,h)}))},t}(f.a.Component);it.propTypes=at,it.defaultProps={srOnly:!1},it.contextTypes=ot;var lt=F("control-label",it),ct={componentClass:pe.a,xs:S.a.number,sm:S.a.number,md:S.a.number,lg:S.a.number,xsHidden:S.a.bool,smHidden:S.a.bool,mdHidden:S.a.bool,lgHidden:S.a.bool,xsOffset:S.a.number,smOffset:S.a.number,mdOffset:S.a.number,lgOffset:S.a.number,xsPush:S.a.number,smPush:S.a.number,mdPush:S.a.number,lgPush:S.a.number,xsPull:S.a.number,smPull:S.a.number,mdPull:S.a.number,lgPull:S.a.number},ut=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=[];return x.forEach(function(e){function t(t,n){var s=""+e+t,o=a[s];null!=o&&i.push(G(r,""+e+n+"-"+o)),delete a[s]}t("",""),t("Offset","-offset"),t("Push","-push"),t("Pull","-pull");var n=e+"Hidden";a[n]&&i.push("hidden-"+e),delete a[n]}),f.a.createElement(t,o()({},a,{className:b()(n,i)}))},t}(f.a.Component);ut.propTypes=ct,ut.defaultProps={componentClass:"div"};var ht=F("col",ut),dt=n(49),pt=n.n(dt),ft=n(120),mt=n.n(ft),gt={height:["marginTop","marginBottom"],width:["marginLeft","marginRight"]};var yt={in:S.a.bool,mountOnEnter:S.a.bool,unmountOnExit:S.a.bool,transitionAppear:S.a.bool,timeout:S.a.number,onEnter:S.a.func,onEntering:S.a.func,onEntered:S.a.func,onExit:S.a.func,onExiting:S.a.func,onExited:S.a.func,dimension:S.a.oneOfType([S.a.oneOf(["height","width"]),S.a.func]),getDimensionValue:S.a.func,role:S.a.string},vt={in:!1,timeout:300,mountOnEnter:!1,unmountOnExit:!1,transitionAppear:!1,dimension:"height",getDimensionValue:function(e,t){var n=t["offset"+tt(e)],s=gt[e];return n+parseInt(pt()(t,s[0]),10)+parseInt(pt()(t,s[1]),10)}},_t=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleEnter=r.handleEnter.bind(r),r.handleEntering=r.handleEntering.bind(r),r.handleEntered=r.handleEntered.bind(r),r.handleExit=r.handleExit.bind(r),r.handleExiting=r.handleExiting.bind(r),r}return d()(t,e),t.prototype._dimension=function(){return"function"==typeof this.props.dimension?this.props.dimension():this.props.dimension},t.prototype._getScrollDimensionValue=function(e,t){return e["scroll"+tt(t)]+"px"},t.prototype.handleEnter=function(e){var t=this._dimension();e.style[t]="0"},t.prototype.handleEntered=function(e){var t=this._dimension();e.style[t]=null},t.prototype.handleEntering=function(e){var t=this._dimension();e.style[t]=this._getScrollDimensionValue(e,t)},t.prototype.handleExit=function(e){var t=this._dimension();e.style[t]=this.props.getDimensionValue(t,e)+"px",e.offsetHeight},t.prototype.handleExiting=function(e){var t=this._dimension();e.style[t]="0"},t.prototype.render=function(){var e=this.props,t=e.onEnter,n=e.onEntering,s=e.onEntered,r=e.onExit,a=e.onExiting,i=e.className,l=v()(e,["onEnter","onEntering","onEntered","onExit","onExiting","className"]);delete l.dimension,delete l.getDimensionValue;var c=q(this.handleEnter,t),u=q(this.handleEntering,n),h=q(this.handleEntered,s),d=q(this.handleExit,r),p=q(this.handleExiting,a),m={width:"width"===this._dimension()};return f.a.createElement(mt.a,o()({},l,{"aria-expanded":l.role?l.in:null,className:b()(i,m),exitedClassName:"collapse",exitingClassName:"collapsing",enteredClassName:"collapse in",enteringClassName:"collapsing",onEnter:c,onEntering:u,onEntered:h,onExit:d,onExiting:p}))},t}(f.a.Component);_t.propTypes=yt,_t.defaultProps=vt;var bt=_t,Et=n(118),St=n.n(Et),Ct=n(42),wt=n.n(Ct),Tt=n(29),Ot=n.n(Tt),Mt=n(51),At=n.n(Mt),Nt=n(39),Pt=n.n(Nt),xt=n(263),It=n.n(xt),Dt=n(167),kt=n.n(Dt),Lt={open:S.a.bool,pullRight:S.a.bool,onClose:S.a.func,labelledBy:S.a.oneOfType([S.a.string,S.a.number]),onSelect:S.a.func,rootCloseEvent:S.a.oneOf(["click","mousedown"])},Rt=function(e){function t(n){l()(this,t);var s=u()(this,e.call(this,n));return s.handleRootClose=s.handleRootClose.bind(s),s.handleKeyDown=s.handleKeyDown.bind(s),s}return d()(t,e),t.prototype.getFocusableMenuItems=function(){var e=Be.a.findDOMNode(this);return e?It()(e.querySelectorAll('[tabIndex="-1"]')):[]},t.prototype.getItemsAndActiveIndex=function(){var e=this.getFocusableMenuItems(),t=e.indexOf(document.activeElement);return{items:e,activeIndex:t}},t.prototype.focusNext=function(){var e=this.getItemsAndActiveIndex(),t=e.items,n=e.activeIndex;0!==t.length&&t[n===t.length-1?0:n+1].focus()},t.prototype.focusPrevious=function(){var e=this.getItemsAndActiveIndex(),t=e.items,n=e.activeIndex;0!==t.length&&t[0===n?t.length-1:n-1].focus()},t.prototype.handleKeyDown=function(e){switch(e.keyCode){case Ot.a.codes.down:this.focusNext(),e.preventDefault();break;case Ot.a.codes.up:this.focusPrevious(),e.preventDefault();break;case Ot.a.codes.esc:case Ot.a.codes.tab:this.props.onClose(e,{source:"keydown"})}},t.prototype.handleRootClose=function(e){this.props.onClose(e,{source:"rootClose"})},t.prototype.render=function(){var e,t=this,n=this.props,s=n.open,r=n.pullRight,a=n.labelledBy,i=n.onSelect,l=n.className,c=n.rootCloseEvent,u=n.children,h=K(v()(n,["open","pullRight","labelledBy","onSelect","className","rootCloseEvent","children"]),["onClose"]),d=h[0],p=h[1],m=o()({},j(d),((e={})[G(d,"right")]=r,e));return f.a.createElement(kt.a,{disabled:!s,onRootClose:this.handleRootClose,event:c},f.a.createElement("ul",o()({},p,{role:"menu",className:b()(l,m),"aria-labelledby":a}),J.map(u,function(e){return f.a.cloneElement(e,{onKeyDown:q(e.props.onKeyDown,t.handleKeyDown),onSelect:q(e.props.onSelect,i)})})))},t}(f.a.Component);Rt.propTypes=Lt,Rt.defaultProps={bsRole:"menu",pullRight:!1};var Bt=F("dropdown-menu",Rt),Gt={noCaret:S.a.bool,open:S.a.bool,title:S.a.string,useAnchor:S.a.bool},Ft=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.noCaret,n=e.open,s=e.useAnchor,r=e.bsClass,a=e.className,i=e.children,l=v()(e,["noCaret","open","useAnchor","bsClass","className","children"]);delete l.bsRole;var c=s?ye:Te,u=!t;return f.a.createElement(c,o()({},l,{role:"button",className:b()(a,r),"aria-haspopup":!0,"aria-expanded":n}),i||l.title,u&&" ",u&&f.a.createElement("span",{className:"caret"}))},t}(f.a.Component);Ft.propTypes=Gt,Ft.defaultProps={open:!1,useAnchor:!1,bsRole:"toggle"};var Wt=F("dropdown-toggle",Ft),Yt=n(78),jt=n.n(Yt);var Xt=Wt.defaultProps.bsRole,Ut=Bt.defaultProps.bsRole,$t={dropup:S.a.bool,id:At()(S.a.oneOfType([S.a.string,S.a.number])),componentClass:pe.a,children:Me()(function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return jt()(function(e,n,s){var r=void 0;return t.every(function(t){return!!J.some(e.children,function(e){return e.props.bsRole===t})||(r=t,!1)}),r?new Error("(children) "+s+" - Missing a required child with bsRole: "+r+". "+s+" must have at least one child of each of the following bsRoles: "+t.join(", ")):null})}(Xt,Ut),function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return jt()(function(e,n,s){var r=void 0;return t.every(function(t){return!(J.filter(e.children,function(e){return e.props.bsRole===t}).length>1&&(r=t,1))}),r?new Error("(children) "+s+" - Duplicate children detected of bsRole: "+r+". Only one child each allowed with the following bsRoles: "+t.join(", ")):null})}(Ut)),disabled:S.a.bool,pullRight:S.a.bool,open:S.a.bool,defaultOpen:S.a.bool,onToggle:S.a.func,onSelect:S.a.func,role:S.a.string,rootCloseEvent:S.a.oneOf(["click","mousedown"]),onMouseEnter:S.a.func,onMouseLeave:S.a.func},Kt={componentClass:Pe},Vt=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleClick=r.handleClick.bind(r),r.handleKeyDown=r.handleKeyDown.bind(r),r.handleClose=r.handleClose.bind(r),r._focusInDropdown=!1,r.lastOpenEventType=null,r}return d()(t,e),t.prototype.componentDidMount=function(){this.focusNextOnOpen()},t.prototype.componentWillUpdate=function(e){!e.open&&this.props.open&&(this._focusInDropdown=wt()(Be.a.findDOMNode(this.menu),St()(document)))},t.prototype.componentDidUpdate=function(e){var t=this.props.open,n=e.open;t&&!n&&this.focusNextOnOpen(),!t&&n&&this._focusInDropdown&&(this._focusInDropdown=!1,this.focus())},t.prototype.focus=function(){var e=Be.a.findDOMNode(this.toggle);e&&e.focus&&e.focus()},t.prototype.focusNextOnOpen=function(){var e=this.menu;e.focusNext&&("keydown"!==this.lastOpenEventType&&"menuitem"!==this.props.role||e.focusNext())},t.prototype.handleClick=function(e){this.props.disabled||this.toggleOpen(e,{source:"click"})},t.prototype.handleClose=function(e,t){this.props.open&&this.toggleOpen(e,t)},t.prototype.handleKeyDown=function(e){if(!this.props.disabled)switch(e.keyCode){case Ot.a.codes.down:this.props.open?this.menu.focusNext&&this.menu.focusNext():this.toggleOpen(e,{source:"keydown"}),e.preventDefault();break;case Ot.a.codes.esc:case Ot.a.codes.tab:this.handleClose(e,{source:"keydown"})}},t.prototype.toggleOpen=function(e,t){var n=!this.props.open;n&&(this.lastOpenEventType=t.source),this.props.onToggle&&this.props.onToggle(n,e,t)},t.prototype.renderMenu=function(e,t){var n=this,s=t.id,r=t.onSelect,a=t.rootCloseEvent,i=v()(t,["id","onSelect","rootCloseEvent"]),l=function(e){n.menu=e};return"string"==typeof e.ref||(l=q(e.ref,l)),Object(p.cloneElement)(e,o()({},i,{ref:l,labelledBy:s,bsClass:G(i,"menu"),onClose:q(e.props.onClose,this.handleClose),onSelect:q(e.props.onSelect,r,function(e,t){return n.handleClose(t,{source:"select"})}),rootCloseEvent:a}))},t.prototype.renderToggle=function(e,t){var n=this,s=function(e){n.toggle=e};return"string"==typeof e.ref||(s=q(e.ref,s)),Object(p.cloneElement)(e,o()({},t,{ref:s,bsClass:G(t,"toggle"),onClick:q(e.props.onClick,this.handleClick),onKeyDown:q(e.props.onKeyDown,this.handleKeyDown)}))},t.prototype.render=function(){var e,t=this,n=this.props,s=n.componentClass,r=n.id,a=n.dropup,i=n.disabled,l=n.pullRight,c=n.open,u=n.onSelect,h=n.role,d=n.bsClass,p=n.className,m=n.rootCloseEvent,g=n.children,y=v()(n,["componentClass","id","dropup","disabled","pullRight","open","onSelect","role","bsClass","className","rootCloseEvent","children"]);delete y.onToggle;var _=((e={})[d]=!0,e.open=c,e.disabled=i,e);return a&&(_[d]=!1,_.dropup=!0),f.a.createElement(s,o()({},y,{className:b()(p,_)}),J.map(g,function(e){switch(e.props.bsRole){case Xt:return t.renderToggle(e,{id:r,disabled:i,open:c,role:h,bsClass:d});case Ut:return t.renderMenu(e,{id:r,open:c,pullRight:l,bsClass:d,onSelect:u,rootCloseEvent:m});default:return e}}))},t}(f.a.Component);Vt.propTypes=$t,Vt.defaultProps=Kt,F("dropdown",Vt);var Ht=Pt()(Vt,{open:"onToggle"});Ht.Toggle=Wt,Ht.Menu=Bt;var qt=Ht;function Jt(e,t){var n=t.propTypes,s={},r={};return w()(e).forEach(function(e){var t=e[0],a=e[1];n[t]?s[t]=a:r[t]=a}),[s,r]}var zt=o()({},qt.propTypes,{bsStyle:S.a.string,bsSize:S.a.string,title:S.a.node.isRequired,noCaret:S.a.bool,children:S.a.node}),Qt=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.bsSize,n=e.bsStyle,s=e.title,r=e.children,a=Jt(v()(e,["bsSize","bsStyle","title","children"]),qt.ControlledComponent),i=a[0],l=a[1];return f.a.createElement(qt,o()({},i,{bsSize:t,bsStyle:n}),f.a.createElement(qt.Toggle,o()({},l,{bsSize:t,bsStyle:n}),s),f.a.createElement(qt.Menu,null,r))},t}(f.a.Component);Qt.propTypes=zt;var Zt=Qt,en={in:S.a.bool,mountOnEnter:S.a.bool,unmountOnExit:S.a.bool,transitionAppear:S.a.bool,timeout:S.a.number,onEnter:S.a.func,onEntering:S.a.func,onEntered:S.a.func,onExit:S.a.func,onExiting:S.a.func,onExited:S.a.func},tn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){return f.a.createElement(mt.a,o()({},this.props,{className:b()(this.props.className,"fade"),enteredClassName:"in",enteringClassName:"in"}))},t}(f.a.Component);tn.propTypes=en,tn.defaultProps={in:!1,timeout:300,mountOnEnter:!1,unmountOnExit:!1,transitionAppear:!1};var nn=tn,sn={horizontal:S.a.bool,inline:S.a.bool,componentClass:pe.a},rn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.horizontal,n=e.inline,s=e.componentClass,r=e.className,a=$(v()(e,["horizontal","inline","componentClass","className"])),i=a[0],l=a[1],c=[];return t&&c.push(G(i,"horizontal")),n&&c.push(G(i,"inline")),f.a.createElement(s,o()({},l,{className:b()(r,c)}))},t}(f.a.Component);rn.propTypes=sn,rn.defaultProps={horizontal:!1,inline:!1,componentClass:"form"};var an=F("form",rn),on={$bs_formGroup:S.a.object},ln=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.getGlyph=function(e){switch(e){case"success":return"ok";case"warning":return"warning-sign";case"error":return"remove";default:return null}},t.prototype.renderDefaultFeedback=function(e,t,n,s){var r=this.getGlyph(e&&e.validationState);return r?f.a.createElement(Ve,o()({},s,{glyph:r,className:b()(t,n)})):null},t.prototype.render=function(){var e=this.props,t=e.className,n=e.children,s=$(v()(e,["className","children"])),r=s[0],a=s[1],i=j(r);if(!n)return this.renderDefaultFeedback(this.context.$bs_formGroup,t,i,a);var l=f.a.Children.only(n);return f.a.cloneElement(l,o()({},a,{className:b()(l.props.className,t,i)}))},t}(f.a.Component);ln.defaultProps={bsRole:"feedback"},ln.contextTypes=on;var cn=F("form-control-feedback",ln),un={componentClass:pe.a},hn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=j(r);return f.a.createElement(t,o()({},a,{className:b()(n,i)}))},t}(f.a.Component);hn.propTypes=un,hn.defaultProps={componentClass:"p"};var dn=F("form-control-static",hn),pn={componentClass:pe.a,type:S.a.string,id:S.a.string,inputRef:S.a.func},fn={$bs_formGroup:S.a.object},mn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.context.$bs_formGroup,t=e&&e.controlId,n=this.props,s=n.componentClass,r=n.type,a=n.id,i=void 0===a?t:a,l=n.inputRef,c=n.className,u=n.bsSize,h=$(v()(n,["componentClass","type","id","inputRef","className","bsSize"])),d=h[0],p=h[1],m=void 0;("file"!==r&&(m=j(d)),u)&&(m[G({bsClass:"input"},P[u]||u)]=!0);return f.a.createElement(s,o()({},p,{type:r,id:i,ref:l,className:b()(c,m)}))},t}(f.a.Component);mn.propTypes=pn,mn.defaultProps={componentClass:"input"},mn.contextTypes=fn,mn.Feedback=cn,mn.Static=dn;var gn=F("form-control",Y([A,M],mn)),yn={controlId:S.a.string,validationState:S.a.oneOf(["success","warning","error",null])},vn={$bs_formGroup:S.a.object.isRequired},_n=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.getChildContext=function(){var e=this.props;return{$bs_formGroup:{controlId:e.controlId,validationState:e.validationState}}},t.prototype.hasFeedback=function(e){var t=this;return J.some(e,function(e){return"feedback"===e.props.bsRole||e.props.children&&t.hasFeedback(e.props.children)})},t.prototype.render=function(){var e=this.props,t=e.validationState,n=e.className,s=e.children,r=K(v()(e,["validationState","className","children"]),["controlId"]),a=r[0],i=r[1],l=o()({},j(a),{"has-feedback":this.hasFeedback(s)});return t&&(l["has-"+t]=!0),f.a.createElement("div",o()({},i,{className:b()(n,l)}),s)},t}(f.a.Component);_n.propTypes=yn,_n.childContextTypes=vn;var bn=F("form-group",Y([M,A],_n)),En={fluid:S.a.bool,componentClass:pe.a},Sn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.fluid,n=e.componentClass,s=e.className,r=$(v()(e,["fluid","componentClass","className"])),a=r[0],i=r[1],l=G(a,t&&"fluid");return f.a.createElement(n,o()({},i,{className:b()(s,l)}))},t}(f.a.Component);Sn.propTypes=En,Sn.defaultProps={componentClass:"div",fluid:!1};var Cn=F("container",Sn),wn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=j(s);return f.a.createElement("span",o()({},r,{className:b()(t,a)}))},t}(f.a.Component),Tn=F("help-block",wn),On={responsive:S.a.bool,rounded:S.a.bool,circle:S.a.bool,thumbnail:S.a.bool},Mn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.responsive,s=t.rounded,r=t.circle,a=t.thumbnail,i=t.className,l=$(v()(t,["responsive","rounded","circle","thumbnail","className"])),c=l[0],u=l[1],h=((e={})[G(c,"responsive")]=n,e[G(c,"rounded")]=s,e[G(c,"circle")]=r,e[G(c,"thumbnail")]=a,e);return f.a.createElement("img",o()({},u,{className:b()(i,h)}))},t}(f.a.Component);Mn.propTypes=On,Mn.defaultProps={responsive:!1,rounded:!1,circle:!1,thumbnail:!1};var An=F("img",Mn),Nn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=j(s);return f.a.createElement("span",o()({},r,{className:b()(t,a)}))},t}(f.a.Component),Pn=F("input-group-addon",Nn),xn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=j(s);return f.a.createElement("span",o()({},r,{className:b()(t,a)}))},t}(f.a.Component),In=F("input-group-btn",xn),Dn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=j(s);return f.a.createElement("span",o()({},r,{className:b()(t,a)}))},t}(f.a.Component);Dn.Addon=Pn,Dn.Button=In;var kn=F("input-group",Y([M,A],Dn)),Ln={componentClass:pe.a},Rn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=j(r);return f.a.createElement(t,o()({},a,{className:b()(n,i)}))},t}(f.a.Component);Rn.propTypes=Ln,Rn.defaultProps={componentClass:"div"};var Bn=F("jumbotron",Rn),Gn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.hasContent=function(e){var t=!1;return f.a.Children.forEach(e,function(e){t||(e||0===e)&&(t=!0)}),t},t.prototype.render=function(){var e=this.props,t=e.className,n=e.children,s=$(v()(e,["className","children"])),r=s[0],a=s[1],i=o()({},j(r),{hidden:!this.hasContent(n)});return f.a.createElement("span",o()({},a,{className:b()(t,i)}),n)},t}(f.a.Component),Fn=F("label",W([].concat(ne()(I),[D,k]),D,Gn)),Wn={active:S.a.any,disabled:S.a.any,header:S.a.node,listItem:S.a.bool,onClick:S.a.func,href:S.a.string,type:S.a.string},Yn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.renderHeader=function(e,t){return f.a.isValidElement(e)?Object(p.cloneElement)(e,{className:b()(e.props.className,t)}):f.a.createElement("h4",{className:t},e)},t.prototype.render=function(){var e=this.props,t=e.active,n=e.disabled,s=e.className,r=e.header,a=e.listItem,i=e.children,l=$(v()(e,["active","disabled","className","header","listItem","children"])),c=l[0],u=l[1],h=o()({},j(c),{active:t,disabled:n}),d=void 0;return u.href?d="a":u.onClick?(d="button",u.type=u.type||"button"):d=a?"li":"span",u.className=b()(s,h),r?f.a.createElement(d,u,this.renderHeader(r,G(c,"heading")),f.a.createElement("p",{className:G(c,"text")},i)):f.a.createElement(d,u,i)},t}(f.a.Component);Yn.propTypes=Wn,Yn.defaultProps={listItem:!1};var jn=F("list-group-item",W(ne()(I),Yn)),Xn={componentClass:pe.a};var Un=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.children,n=e.componentClass,s=void 0===n?function(e){return e?J.some(e,function(e){return e.type!==jn||e.props.href||e.props.onClick})?"div":"ul":"div"}(t):n,r=e.className,a=$(v()(e,["children","componentClass","className"])),i=a[0],l=a[1],c=j(i),u="ul"===s&&J.every(t,function(e){return e.type===jn});return f.a.createElement(s,o()({},l,{className:b()(r,c)}),u?J.map(t,function(e){return Object(p.cloneElement)(e,{listItem:!0})}):t)},t}(f.a.Component);Un.propTypes=Xn;var $n=F("list-group",Un),Kn={align:S.a.oneOf(["top","middle","bottom"]),componentClass:pe.a},Vn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.align,s=e.className,r=$(v()(e,["componentClass","align","className"])),a=r[0],i=r[1],l=j(a);return n&&(l[G(us.defaultProps,n)]=!0),f.a.createElement(t,o()({},i,{className:b()(s,l)}))},t}(f.a.Component);Vn.propTypes=Kn,Vn.defaultProps={componentClass:"div"};var Hn=F("media-body",Vn),qn={componentClass:pe.a},Jn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=j(r);return f.a.createElement(t,o()({},a,{className:b()(n,i)}))},t}(f.a.Component);Jn.propTypes=qn,Jn.defaultProps={componentClass:"h4"};var zn=F("media-heading",Jn),Qn={align:S.a.oneOf(["top","middle","bottom"])},Zn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.align,n=e.className,s=$(v()(e,["align","className"])),r=s[0],a=s[1],i=j(r);return t&&(i[G(us.defaultProps,t)]=!0),f.a.createElement("div",o()({},a,{className:b()(n,i)}))},t}(f.a.Component);Zn.propTypes=Qn;var es=F("media-left",Zn),ts=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=j(s);return f.a.createElement("ul",o()({},r,{className:b()(t,a)}))},t}(f.a.Component),ns=F("media-list",ts),ss=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=j(s);return f.a.createElement("li",o()({},r,{className:b()(t,a)}))},t}(f.a.Component),rs=F("media",ss),as={align:S.a.oneOf(["top","middle","bottom"])},os=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.align,n=e.className,s=$(v()(e,["align","className"])),r=s[0],a=s[1],i=j(r);return t&&(i[G(us.defaultProps,t)]=!0),f.a.createElement("div",o()({},a,{className:b()(n,i)}))},t}(f.a.Component);os.propTypes=as;var is=F("media-right",os),ls={componentClass:pe.a},cs=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=j(r);return f.a.createElement(t,o()({},a,{className:b()(n,i)}))},t}(f.a.Component);cs.propTypes=ls,cs.defaultProps={componentClass:"div"},cs.Heading=zn,cs.Body=Hn,cs.Left=es,cs.Right=is,cs.List=ns,cs.ListItem=rs;var us=F("media",cs),hs={active:S.a.bool,disabled:S.a.bool,divider:Me()(S.a.bool,function(e){var t=e.divider,n=e.children;return t&&n?new Error("Children will not be rendered for dividers"):null}),eventKey:S.a.any,header:S.a.bool,href:S.a.string,onClick:S.a.func,onSelect:S.a.func},ds=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleClick=r.handleClick.bind(r),r}return d()(t,e),t.prototype.handleClick=function(e){var t=this.props,n=t.href,s=t.disabled,r=t.onSelect,a=t.eventKey;n&&!s||e.preventDefault(),s||r&&r(a,e)},t.prototype.render=function(){var e=this.props,t=e.active,n=e.disabled,s=e.divider,r=e.header,a=e.onClick,i=e.className,l=e.style,c=K(v()(e,["active","disabled","divider","header","onClick","className","style"]),["eventKey","onSelect"]),u=c[0],h=c[1];return s?(h.children=void 0,f.a.createElement("li",o()({},h,{role:"separator",className:b()(i,"divider"),style:l}))):r?f.a.createElement("li",o()({},h,{role:"heading",className:b()(i,G(u,"header")),style:l})):f.a.createElement("li",{role:"presentation",className:b()(i,{active:t,disabled:n}),style:l},f.a.createElement(ye,o()({},h,{role:"menuitem",tabIndex:"-1",onClick:q(a,this.handleClick)})))},t}(f.a.Component);ds.propTypes=hs,ds.defaultProps={divider:!1,disabled:!1,header:!1};var ps=F("dropdown",ds),fs=n(169),ms=n.n(fs),gs=n(38),ys=n.n(gs),vs=n(33),_s=n.n(vs),bs=n(76),Es=n.n(bs),Ss=n(79),Cs=n.n(Ss),ws=n(168),Ts=n.n(ws),Os={componentClass:pe.a},Ms=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=j(r);return f.a.createElement(t,o()({},a,{className:b()(n,i)}))},t}(f.a.Component);Ms.propTypes=Os,Ms.defaultProps={componentClass:"div"};var As=F("modal-body",Ms),Ns={dialogClassName:S.a.string},Ps=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.dialogClassName,s=t.className,r=t.style,a=t.children,i=$(v()(t,["dialogClassName","className","style","children"])),l=i[0],c=i[1],u=G(l),h=o()({display:"block"},r),d=o()({},j(l),((e={})[u]=!1,e[G(l,"dialog")]=!0,e));return f.a.createElement("div",o()({},c,{tabIndex:"-1",role:"dialog",style:h,className:b()(s,u)}),f.a.createElement("div",{className:b()(n,d)},f.a.createElement("div",{className:G(l,"content"),role:"document"},a)))},t}(f.a.Component);Ps.propTypes=Ns;var xs=F("modal",Y([M,A],Ps)),Is={componentClass:pe.a},Ds=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=j(r);return f.a.createElement(t,o()({},a,{className:b()(n,i)}))},t}(f.a.Component);Ds.propTypes=Is,Ds.defaultProps={componentClass:"div"};var ks=F("modal-footer",Ds),Ls={closeLabel:S.a.string,closeButton:S.a.bool,onHide:S.a.func},Rs={$bs_modal:S.a.shape({onHide:S.a.func})},Bs=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.closeLabel,n=e.closeButton,s=e.onHide,r=e.className,a=e.children,i=v()(e,["closeLabel","closeButton","onHide","className","children"]),l=this.context.$bs_modal,c=$(i),u=c[0],h=c[1],d=j(u);return f.a.createElement("div",o()({},h,{className:b()(r,d)}),n&&f.a.createElement(ae,{label:t,onClick:q(l&&l.onHide,s)}),a)},t}(f.a.Component);Bs.propTypes=Ls,Bs.defaultProps={closeLabel:"Close",closeButton:!1},Bs.contextTypes=Rs;var Gs=F("modal-header",Bs),Fs={componentClass:pe.a},Ws=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=j(r);return f.a.createElement(t,o()({},a,{className:b()(n,i)}))},t}(f.a.Component);Ws.propTypes=Fs,Ws.defaultProps={componentClass:"h4"};var Ys=F("modal-title",Ws),js=o()({},Cs.a.propTypes,xs.propTypes,{backdrop:S.a.oneOf(["static",!0,!1]),backdropClassName:S.a.string,keyboard:S.a.bool,animation:S.a.bool,dialogComponentClass:pe.a,autoFocus:S.a.bool,enforceFocus:S.a.bool,restoreFocus:S.a.bool,show:S.a.bool,onHide:S.a.func,onEnter:S.a.func,onEntering:S.a.func,onEntered:S.a.func,onExit:S.a.func,onExiting:S.a.func,onExited:S.a.func,container:Cs.a.propTypes.container}),Xs=o()({},Cs.a.defaultProps,{animation:!0,dialogComponentClass:xs}),Us={$bs_modal:S.a.shape({onHide:S.a.func})},$s=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleEntering=r.handleEntering.bind(r),r.handleExited=r.handleExited.bind(r),r.handleWindowResize=r.handleWindowResize.bind(r),r.handleDialogClick=r.handleDialogClick.bind(r),r.setModalRef=r.setModalRef.bind(r),r.state={style:{}},r}return d()(t,e),t.prototype.getChildContext=function(){return{$bs_modal:{onHide:this.props.onHide}}},t.prototype.componentWillUnmount=function(){this.handleExited()},t.prototype.setModalRef=function(e){this._modal=e},t.prototype.handleDialogClick=function(e){e.target===e.currentTarget&&this.props.onHide()},t.prototype.handleEntering=function(){ms.a.on(window,"resize",this.handleWindowResize),this.updateStyle()},t.prototype.handleExited=function(){ms.a.off(window,"resize",this.handleWindowResize)},t.prototype.handleWindowResize=function(){this.updateStyle()},t.prototype.updateStyle=function(){if(_s.a){var e=this._modal.getDialogElement(),t=e.scrollHeight,n=ys()(e),s=Ts()(Be.a.findDOMNode(this.props.container||n.body)),r=t>n.documentElement.clientHeight;this.setState({style:{paddingRight:s&&!r?Es()():void 0,paddingLeft:!s&&r?Es()():void 0}})}},t.prototype.render=function(){var e=this.props,n=e.backdrop,s=e.backdropClassName,r=e.animation,a=e.show,i=e.dialogComponentClass,l=e.className,c=e.style,u=e.children,h=e.onEntering,d=e.onExited,p=v()(e,["backdrop","backdropClassName","animation","show","dialogComponentClass","className","style","children","onEntering","onExited"]),m=Jt(p,Cs.a),g=m[0],y=m[1],_=a&&!r&&"in";return f.a.createElement(Cs.a,o()({},g,{ref:this.setModalRef,show:a,onEntering:q(h,this.handleEntering),onExited:q(d,this.handleExited),backdrop:n,backdropClassName:b()(G(p,"backdrop"),s,_),containerClassName:G(p,"open"),transition:r?nn:void 0,dialogTransitionTimeout:t.TRANSITION_DURATION,backdropTransitionTimeout:t.BACKDROP_TRANSITION_DURATION}),f.a.createElement(i,o()({},y,{style:o()({},this.state.style,c),className:b()(l,_),onClick:!0===n?this.handleDialogClick:null}),u))},t}(f.a.Component);$s.propTypes=js,$s.defaultProps=Xs,$s.childContextTypes=Us,$s.Body=As,$s.Header=Gs,$s.Title=Ys,$s.Footer=ks,$s.Dialog=xs,$s.TRANSITION_DURATION=300,$s.BACKDROP_TRANSITION_DURATION=150;var Ks=F("modal",Y([M,A],$s)),Vs={activeKey:S.a.any,activeHref:S.a.string,stacked:S.a.bool,justified:Me()(S.a.bool,function(e){var t=e.justified,n=e.navbar;return t&&n?Error("justified navbar `Nav`s are not supported"):null}),onSelect:S.a.func,role:S.a.string,navbar:S.a.bool,pullRight:S.a.bool,pullLeft:S.a.bool},Hs={$bs_navbar:S.a.shape({bsClass:S.a.string,onSelect:S.a.func}),$bs_tabContainer:S.a.shape({activeKey:S.a.any,onSelect:S.a.func.isRequired,getTabId:S.a.func.isRequired,getPaneId:S.a.func.isRequired})},qs=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.componentDidUpdate=function(){var e=this;if(this._needsRefocus){this._needsRefocus=!1;var t=this.props.children,n=this.getActiveProps(),s=n.activeKey,r=n.activeHref,a=J.find(t,function(t){return e.isActive(t,s,r)}),o=J.toArray(t).indexOf(a),i=Be.a.findDOMNode(this).children,l=i&&i[o];l&&l.firstChild&&l.firstChild.focus()}},t.prototype.getActiveProps=function(){var e=this.context.$bs_tabContainer;return e||this.props},t.prototype.getNextActiveChild=function(e){var t=this,n=this.props.children,s=n.filter(function(e){return null!=e.props.eventKey&&!e.props.disabled}),r=this.getActiveProps(),a=r.activeKey,o=r.activeHref,i=J.find(n,function(e){return t.isActive(e,a,o)}),l=s.indexOf(i);if(-1===l)return s[0];var c=l+e,u=s.length;return c>=u?c=0:c<0&&(c=u-1),s[c]},t.prototype.getTabProps=function(e,t,n,s,r){var a=this;if(!t&&"tablist"!==n)return null;var o=e.props,i=o.id,l=o["aria-controls"],c=o.eventKey,u=o.role,h=o.onKeyDown,d=o.tabIndex;return t&&(i=t.getTabId(c),l=t.getPaneId(c)),"tablist"===n&&(u=u||"tab",h=q(function(e){return a.handleTabKeyDown(r,e)},h),d=s?d:-1),{id:i,role:u,onKeyDown:h,"aria-controls":l,tabIndex:d}},t.prototype.handleTabKeyDown=function(e,t){var n=void 0;switch(t.keyCode){case Ot.a.codes.left:case Ot.a.codes.up:n=this.getNextActiveChild(-1);break;case Ot.a.codes.right:case Ot.a.codes.down:n=this.getNextActiveChild(1);break;default:return}t.preventDefault(),e&&n&&null!=n.props.eventKey&&e(n.props.eventKey),this._needsRefocus=!0},t.prototype.isActive=function(e,t,n){var s=e.props;return!!(s.active||null!=t&&s.eventKey===t||n&&s.href===n)||s.active},t.prototype.render=function(){var e,t=this,n=this.props,s=n.stacked,r=n.justified,a=n.onSelect,i=n.role,l=n.navbar,c=n.pullRight,u=n.pullLeft,h=n.className,d=n.children,m=v()(n,["stacked","justified","onSelect","role","navbar","pullRight","pullLeft","className","children"]),g=this.context.$bs_tabContainer,y=i||(g?"tablist":null),_=this.getActiveProps(),E=_.activeKey,S=_.activeHref;delete m.activeKey,delete m.activeHref;var C=$(m),w=C[0],T=C[1],O=o()({},j(w),((e={})[G(w,"stacked")]=s,e[G(w,"justified")]=r,e)),M=null!=l?l:this.context.$bs_navbar,A=void 0,N=void 0;if(M){var P=this.context.$bs_navbar||{bsClass:"navbar"};O[G(P,"nav")]=!0,N=G(P,"right"),A=G(P,"left")}else N="pull-right",A="pull-left";return O[N]=c,O[A]=u,f.a.createElement("ul",o()({},T,{role:y,className:b()(h,O)}),J.map(d,function(e){var n=t.isActive(e,E,S),s=q(e.props.onSelect,a,M&&M.onSelect,g&&g.onSelect);return Object(p.cloneElement)(e,o()({},t.getTabProps(e,g,y,n,s),{active:n,activeKey:E,activeHref:S,onSelect:s}))}))},t}(f.a.Component);qs.propTypes=Vs,qs.defaultProps={justified:!1,pullRight:!1,pullLeft:!1,stacked:!1},qs.contextTypes=Hs;var Js=F("nav",W(["tabs","pills"],qs)),zs={$bs_navbar:S.a.shape({bsClass:S.a.string})},Qs=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=e.children,s=v()(e,["className","children"]),r=G(this.context.$bs_navbar||{bsClass:"navbar"},"brand");return f.a.isValidElement(n)?f.a.cloneElement(n,{className:b()(n.props.className,t,r)}):f.a.createElement("span",o()({},s,{className:b()(t,r)}),n)},t}(f.a.Component);Qs.contextTypes=zs;var Zs=Qs,er={$bs_navbar:S.a.shape({bsClass:S.a.string,expanded:S.a.bool})},tr=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.children,n=v()(e,["children"]),s=this.context.$bs_navbar||{bsClass:"navbar"},r=G(s,"collapse");return f.a.createElement(bt,o()({in:s.expanded},n),f.a.createElement("div",{className:r},t))},t}(f.a.Component);tr.contextTypes=er;var nr=tr,sr={$bs_navbar:S.a.shape({bsClass:S.a.string})},rr=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=v()(e,["className"]),s=G(this.context.$bs_navbar||{bsClass:"navbar"},"header");return f.a.createElement("div",o()({},n,{className:b()(t,s)}))},t}(f.a.Component);rr.contextTypes=sr;var ar=rr,or={onClick:S.a.func,children:S.a.node},ir={$bs_navbar:S.a.shape({bsClass:S.a.string,expanded:S.a.bool,onToggle:S.a.func.isRequired})},lr=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.onClick,n=e.className,s=e.children,r=v()(e,["onClick","className","children"]),a=this.context.$bs_navbar||{bsClass:"navbar"},i=o()({type:"button"},r,{onClick:q(t,a.onToggle),className:b()(n,G(a,"toggle"),!a.expanded&&"collapsed")});return s?f.a.createElement("button",i,s):f.a.createElement("button",i,f.a.createElement("span",{className:"sr-only"},"Toggle navigation"),f.a.createElement("span",{className:"icon-bar"}),f.a.createElement("span",{className:"icon-bar"}),f.a.createElement("span",{className:"icon-bar"}))},t}(f.a.Component);lr.propTypes=or,lr.contextTypes=ir;var cr=lr,ur={fixedTop:S.a.bool,fixedBottom:S.a.bool,staticTop:S.a.bool,inverse:S.a.bool,fluid:S.a.bool,componentClass:pe.a,onToggle:S.a.func,onSelect:S.a.func,collapseOnSelect:S.a.bool,expanded:S.a.bool,role:S.a.string},hr={$bs_navbar:S.a.shape({bsClass:S.a.string,expanded:S.a.bool,onToggle:S.a.func.isRequired,onSelect:S.a.func})},dr=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleToggle=r.handleToggle.bind(r),r.handleCollapse=r.handleCollapse.bind(r),r}return d()(t,e),t.prototype.getChildContext=function(){var e=this.props,t=e.bsClass,n=e.expanded,s=e.onSelect,r=e.collapseOnSelect;return{$bs_navbar:{bsClass:t,expanded:n,onToggle:this.handleToggle,onSelect:q(s,r?this.handleCollapse:null)}}},t.prototype.handleCollapse=function(){var e=this.props,t=e.onToggle;e.expanded&&t(!1)},t.prototype.handleToggle=function(){var e=this.props;(0,e.onToggle)(!e.expanded)},t.prototype.render=function(){var e,t=this.props,n=t.componentClass,s=t.fixedTop,r=t.fixedBottom,a=t.staticTop,i=t.inverse,l=t.fluid,c=t.className,u=t.children,h=K(v()(t,["componentClass","fixedTop","fixedBottom","staticTop","inverse","fluid","className","children"]),["expanded","onToggle","onSelect","collapseOnSelect"]),d=h[0],p=h[1];void 0===p.role&&"nav"!==n&&(p.role="navigation"),i&&(d.bsStyle=R);var m=o()({},j(d),((e={})[G(d,"fixed-top")]=s,e[G(d,"fixed-bottom")]=r,e[G(d,"static-top")]=a,e));return f.a.createElement(n,o()({},p,{className:b()(c,m)}),f.a.createElement(Cn,{fluid:l},u))},t}(f.a.Component);dr.propTypes=ur,dr.defaultProps={componentClass:"nav",fixedTop:!1,fixedBottom:!1,staticTop:!1,inverse:!1,fluid:!1,collapseOnSelect:!1},dr.childContextTypes=hr,F("navbar",dr);var pr=Pt()(dr,{expanded:"onToggle"});function fr(e,t,n){var s=function(e,n){var s=n.$bs_navbar,r=void 0===s?{bsClass:"navbar"}:s,a=e.componentClass,i=e.className,l=e.pullRight,c=e.pullLeft,u=v()(e,["componentClass","className","pullRight","pullLeft"]);return f.a.createElement(a,o()({},u,{className:b()(i,G(r,t),l&&G(r,"right"),c&&G(r,"left"))}))};return s.displayName=n,s.propTypes={componentClass:pe.a,pullRight:S.a.bool,pullLeft:S.a.bool},s.defaultProps={componentClass:e,pullRight:!1,pullLeft:!1},s.contextTypes={$bs_navbar:S.a.shape({bsClass:S.a.string})},s}pr.Brand=Zs,pr.Header=ar,pr.Toggle=cr,pr.Collapse=nr,pr.Form=fr("div","form","NavbarForm"),pr.Text=fr("p","text","NavbarText"),pr.Link=fr("a","link","NavbarLink");var mr=W([D,R],D,pr),gr=o()({},qt.propTypes,{title:S.a.node.isRequired,noCaret:S.a.bool,active:S.a.bool,children:S.a.node}),yr=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.isActive=function(e,t,n){var s=e.props,r=this;return!!(s.active||null!=t&&s.eventKey===t||n&&s.href===n)||(!!J.some(s.children,function(e){return r.isActive(e,t,n)})||s.active)},t.prototype.render=function(){var e=this,t=this.props,n=t.title,s=t.activeKey,r=t.activeHref,a=t.className,i=t.style,l=t.children,c=v()(t,["title","activeKey","activeHref","className","style","children"]),u=this.isActive(this,s,r);delete c.active,delete c.eventKey;var h=Jt(c,qt.ControlledComponent),d=h[0],p=h[1];return f.a.createElement(qt,o()({},d,{componentClass:"li",className:b()(a,{active:u}),style:i}),f.a.createElement(qt.Toggle,o()({},p,{useAnchor:!0}),n),f.a.createElement(qt.Menu,null,J.map(l,function(t){return f.a.cloneElement(t,{active:e.isActive(t,s,r)})})))},t}(f.a.Component);yr.propTypes=gr;var vr=yr,_r={active:S.a.bool,disabled:S.a.bool,role:S.a.string,href:S.a.string,onClick:S.a.func,onSelect:S.a.func,eventKey:S.a.any},br=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleClick=r.handleClick.bind(r),r}return d()(t,e),t.prototype.handleClick=function(e){this.props.onSelect&&(e.preventDefault(),this.props.disabled||this.props.onSelect(this.props.eventKey,e))},t.prototype.render=function(){var e=this.props,t=e.active,n=e.disabled,s=e.onClick,r=e.className,a=e.style,i=v()(e,["active","disabled","onClick","className","style"]);return delete i.onSelect,delete i.eventKey,delete i.activeKey,delete i.activeHref,i.role?"tab"===i.role&&(i["aria-selected"]=t):"#"===i.href&&(i.role="button"),f.a.createElement("li",{role:"presentation",className:b()(r,{active:t,disabled:n}),style:a},f.a.createElement(ye,o()({},i,{disabled:n,onClick:q(s,this.handleClick)})))},t}(f.a.Component);br.propTypes=_r,br.defaultProps={active:!1,disabled:!1};var Er=br,Sr=n(170),Cr=n.n(Sr),wr=o()({},Cr.a.propTypes,{show:S.a.bool,rootClose:S.a.bool,onHide:S.a.func,animation:S.a.oneOfType([S.a.bool,pe.a]),onEnter:S.a.func,onEntering:S.a.func,onEntered:S.a.func,onExit:S.a.func,onExiting:S.a.func,onExited:S.a.func,placement:S.a.oneOf(["top","right","bottom","left"])}),Tr={animation:nn,rootClose:!1,show:!1,placement:"right"},Or=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.animation,n=e.children,s=v()(e,["animation","children"]),r=!0===t?nn:t||null,a=void 0;return a=r?n:Object(p.cloneElement)(n,{className:b()(n.props.className,"in")}),f.a.createElement(Cr.a,o()({},s,{transition:r}),a)},t}(f.a.Component);Or.propTypes=wr,Or.defaultProps=Tr;var Mr=Or;function Ar(e,t){return Array.isArray(t)?t.indexOf(e)>=0:e===t}var Nr=S.a.oneOf(["click","hover","focus"]),Pr=o()({},Mr.propTypes,{trigger:S.a.oneOfType([Nr,S.a.arrayOf(Nr)]),delay:S.a.number,delayShow:S.a.number,delayHide:S.a.number,defaultOverlayShown:S.a.bool,overlay:S.a.node.isRequired,onBlur:S.a.func,onClick:S.a.func,onFocus:S.a.func,onMouseOut:S.a.func,onMouseOver:S.a.func,target:S.a.oneOf([null]),onHide:S.a.oneOf([null]),show:S.a.oneOf([null])}),xr=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleToggle=r.handleToggle.bind(r),r.handleDelayedShow=r.handleDelayedShow.bind(r),r.handleDelayedHide=r.handleDelayedHide.bind(r),r.handleHide=r.handleHide.bind(r),r.handleMouseOver=function(e){return r.handleMouseOverOut(r.handleDelayedShow,e)},r.handleMouseOut=function(e){return r.handleMouseOverOut(r.handleDelayedHide,e)},r._mountNode=null,r.state={show:n.defaultOverlayShown},r}return d()(t,e),t.prototype.componentDidMount=function(){this._mountNode=document.createElement("div"),this.renderOverlay()},t.prototype.componentDidUpdate=function(){this.renderOverlay()},t.prototype.componentWillUnmount=function(){Be.a.unmountComponentAtNode(this._mountNode),this._mountNode=null,clearTimeout(this._hoverShowDelay),clearTimeout(this._hoverHideDelay)},t.prototype.handleDelayedHide=function(){var e=this;if(null!=this._hoverShowDelay)return clearTimeout(this._hoverShowDelay),void(this._hoverShowDelay=null);if(this.state.show&&null==this._hoverHideDelay){var t=null!=this.props.delayHide?this.props.delayHide:this.props.delay;t?this._hoverHideDelay=setTimeout(function(){e._hoverHideDelay=null,e.hide()},t):this.hide()}},t.prototype.handleDelayedShow=function(){var e=this;if(null!=this._hoverHideDelay)return clearTimeout(this._hoverHideDelay),void(this._hoverHideDelay=null);if(!this.state.show&&null==this._hoverShowDelay){var t=null!=this.props.delayShow?this.props.delayShow:this.props.delay;t?this._hoverShowDelay=setTimeout(function(){e._hoverShowDelay=null,e.show()},t):this.show()}},t.prototype.handleHide=function(){this.hide()},t.prototype.handleMouseOverOut=function(e,t){var n=t.currentTarget,s=t.relatedTarget||t.nativeEvent.toElement;s&&s===n||wt()(n,s)||e(t)},t.prototype.handleToggle=function(){this.state.show?this.hide():this.show()},t.prototype.hide=function(){this.setState({show:!1})},t.prototype.makeOverlay=function(e,t){return f.a.createElement(Mr,o()({},t,{show:this.state.show,onHide:this.handleHide,target:this}),e)},t.prototype.show=function(){this.setState({show:!0})},t.prototype.renderOverlay=function(){Be.a.unstable_renderSubtreeIntoContainer(this,this._overlay,this._mountNode)},t.prototype.render=function(){var e=this.props,t=e.trigger,n=e.overlay,s=e.children,r=e.onBlur,a=e.onClick,o=e.onFocus,i=e.onMouseOut,l=e.onMouseOver,c=v()(e,["trigger","overlay","children","onBlur","onClick","onFocus","onMouseOut","onMouseOver"]);delete c.delay,delete c.delayShow,delete c.delayHide,delete c.defaultOverlayShown;var u=f.a.Children.only(s),h=u.props,d={};return this.state.show&&(d["aria-describedby"]=n.props.id),d.onClick=q(h.onClick,a),Ar("click",t)&&(d.onClick=q(d.onClick,this.handleToggle)),Ar("hover",t)&&(d.onMouseOver=q(h.onMouseOver,l,this.handleMouseOver),d.onMouseOut=q(h.onMouseOut,i,this.handleMouseOut)),Ar("focus",t)&&(d.onFocus=q(h.onFocus,o,this.handleDelayedShow),d.onBlur=q(h.onBlur,r,this.handleDelayedHide)),this._overlay=this.makeOverlay(n,c),Object(p.cloneElement)(u,d)},t}(f.a.Component);xr.propTypes=Pr,xr.defaultProps={defaultOverlayShown:!1,trigger:["hover","focus"]};var Ir=xr,Dr=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=e.children,s=$(v()(e,["className","children"])),r=s[0],a=s[1],i=j(r);return f.a.createElement("div",o()({},a,{className:b()(t,i)}),f.a.createElement("h1",null,n))},t}(f.a.Component),kr=F("page-header",Dr),Lr={disabled:S.a.bool,previous:S.a.bool,next:S.a.bool,onClick:S.a.func,onSelect:S.a.func,eventKey:S.a.any},Rr=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleSelect=r.handleSelect.bind(r),r}return d()(t,e),t.prototype.handleSelect=function(e){var t=this.props,n=t.disabled,s=t.onSelect,r=t.eventKey;(s||n)&&e.preventDefault(),n||s&&s(r,e)},t.prototype.render=function(){var e=this.props,t=e.disabled,n=e.previous,s=e.next,r=e.onClick,a=e.className,i=e.style,l=v()(e,["disabled","previous","next","onClick","className","style"]);return delete l.onSelect,delete l.eventKey,f.a.createElement("li",{className:b()(a,{disabled:t,previous:n,next:s}),style:i},f.a.createElement(ye,o()({},l,{disabled:t,onClick:q(r,this.handleSelect)})))},t}(f.a.Component);Rr.propTypes=Lr,Rr.defaultProps={disabled:!1,previous:!1,next:!1};var Br=Rr,Gr=n(119),Fr=n.n(Gr),Wr={};function Yr(e,t,n){var s=void 0;"object"===(void 0===e?"undefined":Fr()(e))?s=e.message:(s=e+" is deprecated. Use "+t+" instead.",n&&(s+="\nYou can read more about it at "+n)),Wr[s]||(Wr[s]=!0)}Yr.wrapper=function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),s=1;s<t;s++)n[s-1]=arguments[s];return function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.componentWillMount=function(){if(Yr.apply(void 0,n),e.prototype.componentWillMount){for(var t,s=arguments.length,r=Array(s),a=0;a<s;a++)r[a]=arguments[a];(t=e.prototype.componentWillMount).call.apply(t,[this].concat(r))}},t}(e)};var jr=Yr.wrapper(Br,"`<PageItem>`","`<Pager.Item>`"),Xr={onSelect:S.a.func},Ur=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.onSelect,n=e.className,s=e.children,r=$(v()(e,["onSelect","className","children"])),a=r[0],i=r[1],l=j(a);return f.a.createElement("ul",o()({},i,{className:b()(n,l)}),J.map(s,function(e){return Object(p.cloneElement)(e,{onSelect:q(e.props.onSelect,t)})}))},t}(f.a.Component);Ur.propTypes=Xr,Ur.Item=Br;var $r=F("pager",Ur),Kr={componentClass:pe.a,className:S.a.string,eventKey:S.a.any,onSelect:S.a.func,disabled:S.a.bool,active:S.a.bool,onClick:S.a.func},Vr={componentClass:ye,active:!1,disabled:!1},Hr=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleClick=r.handleClick.bind(r),r}return d()(t,e),t.prototype.handleClick=function(e){var t=this.props,n=t.disabled,s=t.onSelect,r=t.eventKey;n||s&&s(r,e)},t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.active,s=e.disabled,r=e.onClick,a=e.className,i=e.style,l=v()(e,["componentClass","active","disabled","onClick","className","style"]);return t===ye&&delete l.eventKey,delete l.onSelect,f.a.createElement("li",{className:b()(a,{active:n,disabled:s}),style:i},f.a.createElement(t,o()({},l,{disabled:s,onClick:q(r,this.handleClick)})))},t}(f.a.Component);Hr.propTypes=Kr,Hr.defaultProps=Vr;var qr=Hr,Jr={activePage:S.a.number,items:S.a.number,maxButtons:S.a.number,boundaryLinks:S.a.bool,ellipsis:S.a.oneOfType([S.a.bool,S.a.node]),first:S.a.oneOfType([S.a.bool,S.a.node]),last:S.a.oneOfType([S.a.bool,S.a.node]),prev:S.a.oneOfType([S.a.bool,S.a.node]),next:S.a.oneOfType([S.a.bool,S.a.node]),onSelect:S.a.func,buttonComponentClass:pe.a},zr=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.renderPageButtons=function(e,t,n,s,r,a){var i=[],l=void 0,c=void 0;n&&n<t?c=(l=Math.max(Math.min(e-Math.floor(n/2,10),t-n+1),1))+n-1:(l=1,c=t);for(var u=l;u<=c;++u)i.push(f.a.createElement(qr,o()({},a,{key:u,eventKey:u,active:u===e}),u));return r&&s&&l>1&&(l>2&&i.unshift(f.a.createElement(qr,{key:"ellipsisFirst",disabled:!0,componentClass:a.componentClass},f.a.createElement("span",{"aria-label":"More"},!0===r?"…":r))),i.unshift(f.a.createElement(qr,o()({},a,{key:1,eventKey:1,active:!1}),"1"))),r&&c<t&&((!s||c<t-1)&&i.push(f.a.createElement(qr,{key:"ellipsis",disabled:!0,componentClass:a.componentClass},f.a.createElement("span",{"aria-label":"More"},!0===r?"…":r))),s&&i.push(f.a.createElement(qr,o()({},a,{key:t,eventKey:t,active:!1}),t))),i},t.prototype.render=function(){var e=this.props,t=e.activePage,n=e.items,s=e.maxButtons,r=e.boundaryLinks,a=e.ellipsis,i=e.first,l=e.last,c=e.prev,u=e.next,h=e.onSelect,d=e.buttonComponentClass,p=e.className,m=$(v()(e,["activePage","items","maxButtons","boundaryLinks","ellipsis","first","last","prev","next","onSelect","buttonComponentClass","className"])),g=m[0],y=m[1],_=j(g),E={onSelect:h,componentClass:d};return f.a.createElement("ul",o()({},y,{className:b()(p,_)}),i&&f.a.createElement(qr,o()({},E,{eventKey:1,disabled:1===t}),f.a.createElement("span",{"aria-label":"First"},!0===i?"«":i)),c&&f.a.createElement(qr,o()({},E,{eventKey:t-1,disabled:1===t}),f.a.createElement("span",{"aria-label":"Previous"},!0===c?"‹":c)),this.renderPageButtons(t,n,s,r,a,E),u&&f.a.createElement(qr,o()({},E,{eventKey:t+1,disabled:t>=n}),f.a.createElement("span",{"aria-label":"Next"},!0===u?"›":u)),l&&f.a.createElement(qr,o()({},E,{eventKey:n,disabled:t>=n}),f.a.createElement("span",{"aria-label":"Last"},!0===l?"»":l)))},t}(f.a.Component);zr.propTypes=Jr,zr.defaultProps={activePage:1,items:1,maxButtons:0,first:!1,last:!1,prev:!1,next:!1,ellipsis:!0,boundaryLinks:!1};var Qr=F("pagination",zr),Zr={collapsible:S.a.bool,onSelect:S.a.func,header:S.a.node,id:S.a.oneOfType([S.a.string,S.a.number]),footer:S.a.node,defaultExpanded:S.a.bool,expanded:S.a.bool,eventKey:S.a.any,headerRole:S.a.string,panelRole:S.a.string,onEnter:S.a.func,onEntering:S.a.func,onEntered:S.a.func,onExit:S.a.func,onExiting:S.a.func,onExited:S.a.func},ea=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleClickTitle=r.handleClickTitle.bind(r),r.state={expanded:r.props.defaultExpanded},r}return d()(t,e),t.prototype.handleClickTitle=function(e){e.persist(),e.selected=!0,this.props.onSelect?this.props.onSelect(this.props.eventKey,e):e.preventDefault(),e.selected&&this.setState({expanded:!this.state.expanded})},t.prototype.renderAnchor=function(e,t,n,s){return f.a.createElement("a",{role:n,href:t&&"#"+t,onClick:this.handleClickTitle,"aria-controls":t,"aria-expanded":s,"aria-selected":s,className:s?null:"collapsed"},e)},t.prototype.renderBody=function(e,t){var n=[],s=[],r=G(t,"body");function a(){s.length&&(n.push(f.a.createElement("div",{key:n.length,className:r},s)),s=[])}return f.a.Children.toArray(e).forEach(function(e){if(f.a.isValidElement(e)&&e.props.fill)return a(),void n.push(Object(p.cloneElement)(e,{fill:void 0}));s.push(e)}),a(),n},t.prototype.renderCollapsibleBody=function(e,t,n,s,r,a){return f.a.createElement(bt,o()({in:t},a),f.a.createElement("div",{id:e,role:n,className:G(r,"collapse"),"aria-hidden":!t},this.renderBody(s,r)))},t.prototype.renderHeader=function(e,t,n,s,r,a){var o=G(a,"title");return e?f.a.isValidElement(t)?Object(p.cloneElement)(t,{className:b()(t.props.className,o),children:this.renderAnchor(t.props.children,n,s,r)}):f.a.createElement("h4",{role:"presentation",className:o},this.renderAnchor(t,n,s,r)):f.a.isValidElement(t)?Object(p.cloneElement)(t,{className:b()(t.props.className,o)}):t},t.prototype.render=function(){var e=this.props,t=e.collapsible,n=e.header,s=e.id,r=e.footer,a=e.expanded,i=e.headerRole,l=e.panelRole,c=e.className,u=e.children,h=e.onEnter,d=e.onEntering,p=e.onEntered,m=e.onExit,g=e.onExiting,y=e.onExited,_=K(v()(e,["collapsible","header","id","footer","expanded","headerRole","panelRole","className","children","onEnter","onEntering","onEntered","onExit","onExiting","onExited"]),["defaultExpanded","eventKey","onSelect"]),E=_[0],S=_[1],C=null!=a?a:this.state.expanded,w=j(E);return f.a.createElement("div",o()({},S,{className:b()(c,w),id:t?null:s}),n&&f.a.createElement("div",{className:G(E,"heading")},this.renderHeader(t,n,s,i,C,E)),t?this.renderCollapsibleBody(s,C,l,u,E,{onEnter:h,onEntering:d,onEntered:p,onExit:m,onExiting:g,onExited:y}):this.renderBody(u,E),r&&f.a.createElement("div",{className:G(E,"footer")},r))},t}(f.a.Component);ea.propTypes=Zr,ea.defaultProps={defaultExpanded:!1};var ta=F("panel",W([].concat(ne()(I),[D,k]),D,ea)),na={id:At()(S.a.oneOfType([S.a.string,S.a.number])),placement:S.a.oneOf(["top","right","bottom","left"]),positionTop:S.a.oneOfType([S.a.number,S.a.string]),positionLeft:S.a.oneOfType([S.a.number,S.a.string]),arrowOffsetTop:S.a.oneOfType([S.a.number,S.a.string]),arrowOffsetLeft:S.a.oneOfType([S.a.number,S.a.string]),title:S.a.node},sa=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.placement,s=t.positionTop,r=t.positionLeft,a=t.arrowOffsetTop,i=t.arrowOffsetLeft,l=t.title,c=t.className,u=t.style,h=t.children,d=$(v()(t,["placement","positionTop","positionLeft","arrowOffsetTop","arrowOffsetLeft","title","className","style","children"])),p=d[0],m=d[1],g=o()({},j(p),((e={})[n]=!0,e)),y=o()({display:"block",top:s,left:r},u),_={top:a,left:i};return f.a.createElement("div",o()({},m,{role:"tooltip",className:b()(c,g),style:y}),f.a.createElement("div",{className:"arrow",style:_}),l&&f.a.createElement("h3",{className:G(p,"title")},l),f.a.createElement("div",{className:G(p,"content")},h))},t}(f.a.Component);sa.propTypes=na,sa.defaultProps={placement:"right"};var ra=F("popover",sa),aa=1e3;var oa={min:S.a.number,now:S.a.number,max:S.a.number,label:S.a.node,srOnly:S.a.bool,striped:S.a.bool,active:S.a.bool,children:function(e,t,n){var s=e[t];if(!s)return null;var r=null;return f.a.Children.forEach(s,function(e){if(!r&&e.type!==la){var t=f.a.isValidElement(e)?e.type.displayName||e.type.name||e.type:e;r=new Error("Children of "+n+" can contain only ProgressBar components. Found "+t+".")}}),r},isChild:S.a.bool};function ia(e,t,n){var s=(e-t)/(n-t)*100;return Math.round(s*aa)/aa}var la=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.renderProgressBar=function(e){var t,n=e.min,s=e.now,r=e.max,a=e.label,i=e.srOnly,l=e.striped,c=e.active,u=e.className,h=e.style,d=$(v()(e,["min","now","max","label","srOnly","striped","active","className","style"])),p=d[0],m=d[1],g=o()({},j(p),((t={active:c})[G(p,"striped")]=c||l,t));return f.a.createElement("div",o()({},m,{role:"progressbar",className:b()(u,g),style:o()({width:ia(s,n,r)+"%"},h),"aria-valuenow":s,"aria-valuemin":n,"aria-valuemax":r}),i?f.a.createElement("span",{className:"sr-only"},a):a)},t.prototype.render=function(){var e=this.props,t=e.isChild,n=v()(e,["isChild"]);if(t)return this.renderProgressBar(n);var s=n.min,r=n.now,a=n.max,i=n.label,l=n.srOnly,c=n.striped,u=n.active,h=n.bsClass,d=n.bsStyle,m=n.className,g=n.children,y=v()(n,["min","now","max","label","srOnly","striped","active","bsClass","bsStyle","className","children"]);return f.a.createElement("div",o()({},y,{className:b()(m,"progress")}),g?J.map(g,function(e){return Object(p.cloneElement)(e,{isChild:!0})}):this.renderProgressBar({min:s,now:r,max:a,label:i,srOnly:l,striped:c,active:u,bsClass:h,bsStyle:d}))},t}(f.a.Component);la.propTypes=oa,la.defaultProps={min:0,max:100,active:!1,isChild:!1,srOnly:!1,striped:!1};var ca=F("progress-bar",W(ne()(I),la)),ua={inline:S.a.bool,disabled:S.a.bool,title:S.a.string,validationState:S.a.oneOf(["success","warning","error",null]),inputRef:S.a.func},ha=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.inline,n=e.disabled,s=e.validationState,r=e.inputRef,a=e.className,i=e.style,l=e.title,c=e.children,u=$(v()(e,["inline","disabled","validationState","inputRef","className","style","title","children"])),h=u[0],d=u[1],p=f.a.createElement("input",o()({},d,{ref:r,type:"radio",disabled:n}));if(t){var m,g=((m={})[G(h,"inline")]=!0,m.disabled=n,m);return f.a.createElement("label",{className:b()(a,g),style:i,title:l},p,c)}var y=o()({},j(h),{disabled:n});return s&&(y["has-"+s]=!0),f.a.createElement("div",{className:b()(a,y),style:i},f.a.createElement("label",{title:l},p,c))},t}(f.a.Component);ha.propTypes=ua,ha.defaultProps={inline:!1,disabled:!1,title:""};var da=F("radio",ha),pa={children:S.a.element.isRequired,a16by9:S.a.bool,a4by3:S.a.bool},fa=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.a16by9,s=t.a4by3,r=t.className,a=t.children,i=$(v()(t,["a16by9","a4by3","className","children"])),l=i[0],c=i[1],u=o()({},j(l),((e={})[G(l,"16by9")]=n,e[G(l,"4by3")]=s,e));return f.a.createElement("div",{className:b()(u)},Object(p.cloneElement)(a,o()({},c,{className:b()(r,G(l,"item"))})))},t}(f.a.Component);fa.propTypes=pa,fa.defaultProps={a16by9:!1,a4by3:!1};var ma=F("embed-responsive",fa),ga={componentClass:pe.a},ya=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=j(r);return f.a.createElement(t,o()({},a,{className:b()(n,i)}))},t}(f.a.Component);ya.propTypes=ga,ya.defaultProps={componentClass:"div"};var va=F("row",ya),_a=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){return f.a.createElement(Wt,o()({},this.props,{useAnchor:!1,noCaret:!1}))},t}(f.a.Component);_a.defaultProps=Wt.defaultProps;var ba=_a,Ea=o()({},qt.propTypes,{bsStyle:S.a.string,bsSize:S.a.string,href:S.a.string,onClick:S.a.func,title:S.a.node.isRequired,toggleLabel:S.a.string,children:S.a.node}),Sa=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.bsSize,n=e.bsStyle,s=e.title,r=e.toggleLabel,a=e.children,i=v()(e,["bsSize","bsStyle","title","toggleLabel","children"]),l=Jt(i,qt.ControlledComponent),c=l[0],u=l[1];return f.a.createElement(qt,o()({},c,{bsSize:t,bsStyle:n}),f.a.createElement(Te,o()({},u,{disabled:i.disabled,bsSize:t,bsStyle:n}),s),f.a.createElement(ba,{"aria-label":r||s,bsSize:t,bsStyle:n}),f.a.createElement(qt.Menu,null,a))},t}(f.a.Component);Sa.propTypes=Ea,Sa.Toggle=ba;var Ca=Sa,wa=S.a.oneOfType([S.a.string,S.a.number]),Ta={id:function(e){var t=null;if(!e.generateChildId){for(var n=arguments.length,s=Array(n>1?n-1:0),r=1;r<n;r++)s[r-1]=arguments[r];(t=wa.apply(void 0,[e].concat(s)))||e.id||(t=new Error("In order to properly initialize Tabs in a way that is accessible to assistive technologies (such as screen readers) an `id` or a `generateChildId` prop to TabContainer is required"))}return t},generateChildId:S.a.func,onSelect:S.a.func,activeKey:S.a.any},Oa={$bs_tabContainer:S.a.shape({activeKey:S.a.any,onSelect:S.a.func.isRequired,getTabId:S.a.func.isRequired,getPaneId:S.a.func.isRequired})},Ma=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.getChildContext=function(){var e=this.props,t=e.activeKey,n=e.onSelect,s=e.generateChildId,r=e.id,a=s||function(e,t){return r?r+"-"+t+"-"+e:null};return{$bs_tabContainer:{activeKey:t,onSelect:n,getTabId:function(e){return a(e,"tab")},getPaneId:function(e){return a(e,"pane")}}}},t.prototype.render=function(){var e=this.props,t=e.children,n=v()(e,["children"]);return delete n.generateChildId,delete n.onSelect,delete n.activeKey,f.a.cloneElement(f.a.Children.only(t),n)},t}(f.a.Component);Ma.propTypes=Ta,Ma.childContextTypes=Oa;var Aa=Pt()(Ma,{activeKey:"onSelect"}),Na={componentClass:pe.a,animation:S.a.oneOfType([S.a.bool,pe.a]),mountOnEnter:S.a.bool,unmountOnExit:S.a.bool},Pa={$bs_tabContainer:S.a.shape({activeKey:S.a.any})},xa={$bs_tabContent:S.a.shape({bsClass:S.a.string,animation:S.a.oneOfType([S.a.bool,pe.a]),activeKey:S.a.any,mountOnEnter:S.a.bool,unmountOnExit:S.a.bool,onPaneEnter:S.a.func.isRequired,onPaneExited:S.a.func.isRequired,exiting:S.a.bool.isRequired})},Ia=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handlePaneEnter=r.handlePaneEnter.bind(r),r.handlePaneExited=r.handlePaneExited.bind(r),r.state={activeKey:null,activeChild:null},r}return d()(t,e),t.prototype.getChildContext=function(){var e=this.props,t=e.bsClass,n=e.animation,s=e.mountOnEnter,r=e.unmountOnExit,a=this.state.activeKey,o=this.getContainerActiveKey(),i=null!=a&&a!==o;return{$bs_tabContent:{bsClass:t,animation:n,activeKey:null!=a?a:o,mountOnEnter:s,unmountOnExit:r,onPaneEnter:this.handlePaneEnter,onPaneExited:this.handlePaneExited,exiting:i}}},t.prototype.componentWillReceiveProps=function(e){!e.animation&&this.state.activeChild&&this.setState({activeKey:null,activeChild:null})},t.prototype.componentWillUnmount=function(){this.isUnmounted=!0},t.prototype.getContainerActiveKey=function(){var e=this.context.$bs_tabContainer;return e&&e.activeKey},t.prototype.handlePaneEnter=function(e,t){return!!this.props.animation&&(t===this.getContainerActiveKey()&&(this.setState({activeKey:t,activeChild:e}),!0))},t.prototype.handlePaneExited=function(e){this.isUnmounted||this.setState(function(t){return t.activeChild!==e?null:{activeKey:null,activeChild:null}})},t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=K(v()(e,["componentClass","className"]),["animation","mountOnEnter","unmountOnExit"]),r=s[0],a=s[1];return f.a.createElement(t,o()({},a,{className:b()(n,G(r,"content"))}))},t}(f.a.Component);Ia.propTypes=Na,Ia.defaultProps={componentClass:"div",animation:!0,mountOnEnter:!1,unmountOnExit:!1},Ia.contextTypes=Pa,Ia.childContextTypes=xa;var Da=F("tab",Ia),ka={eventKey:S.a.any,animation:S.a.oneOfType([S.a.bool,pe.a]),id:S.a.string,"aria-labelledby":S.a.string,bsClass:S.a.string,onEnter:S.a.func,onEntering:S.a.func,onEntered:S.a.func,onExit:S.a.func,onExiting:S.a.func,onExited:S.a.func,mountOnEnter:S.a.bool,unmountOnExit:S.a.bool},La={$bs_tabContainer:S.a.shape({getTabId:S.a.func,getPaneId:S.a.func}),$bs_tabContent:S.a.shape({bsClass:S.a.string,animation:S.a.oneOfType([S.a.bool,pe.a]),activeKey:S.a.any,mountOnEnter:S.a.bool,unmountOnExit:S.a.bool,onPaneEnter:S.a.func.isRequired,onPaneExited:S.a.func.isRequired,exiting:S.a.bool.isRequired})},Ra={$bs_tabContainer:S.a.oneOf([null])},Ba=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleEnter=r.handleEnter.bind(r),r.handleExited=r.handleExited.bind(r),r.in=!1,r}return d()(t,e),t.prototype.getChildContext=function(){return{$bs_tabContainer:null}},t.prototype.componentDidMount=function(){this.shouldBeIn()&&this.handleEnter()},t.prototype.componentDidUpdate=function(){this.in?this.shouldBeIn()||this.handleExited():this.shouldBeIn()&&this.handleEnter()},t.prototype.componentWillUnmount=function(){this.in&&this.handleExited()},t.prototype.getAnimation=function(){if(null!=this.props.animation)return this.props.animation;var e=this.context.$bs_tabContent;return e&&e.animation},t.prototype.handleEnter=function(){var e=this.context.$bs_tabContent;e&&(this.in=e.onPaneEnter(this,this.props.eventKey))},t.prototype.handleExited=function(){var e=this.context.$bs_tabContent;e&&(e.onPaneExited(this),this.in=!1)},t.prototype.isActive=function(){var e=this.context.$bs_tabContent,t=e&&e.activeKey;return this.props.eventKey===t},t.prototype.shouldBeIn=function(){return this.getAnimation()&&this.isActive()},t.prototype.render=function(){var e=this.props,t=e.eventKey,n=e.className,s=e.onEnter,r=e.onEntering,a=e.onEntered,i=e.onExit,l=e.onExiting,c=e.onExited,u=e.mountOnEnter,h=e.unmountOnExit,d=v()(e,["eventKey","className","onEnter","onEntering","onEntered","onExit","onExiting","onExited","mountOnEnter","unmountOnExit"]),p=this.context,m=p.$bs_tabContent,g=p.$bs_tabContainer,y=K(d,["animation"]),_=y[0],E=y[1],S=this.isActive(),C=this.getAnimation(),w=null!=u?u:m&&m.mountOnEnter,T=null!=h?h:m&&m.unmountOnExit;if(!S&&!C&&T)return null;var O=!0===C?nn:C||null;m&&(_.bsClass=G(m,"pane"));var M=o()({},j(_),{active:S});g&&(E.id=g.getPaneId(t),E["aria-labelledby"]=g.getTabId(t));var A=f.a.createElement("div",o()({},E,{role:"tabpanel","aria-hidden":!S,className:b()(n,M)}));if(O){var N=m&&m.exiting;return f.a.createElement(O,{in:S&&!N,onEnter:q(this.handleEnter,s),onEntering:r,onEntered:a,onExit:i,onExiting:l,onExited:q(this.handleExited,c),mountOnEnter:w,unmountOnExit:T},A)}return A},t}(f.a.Component);Ba.propTypes=ka,Ba.contextTypes=La,Ba.childContextTypes=Ra;var Ga=F("tab-pane",Ba),Fa=o()({},Ga.propTypes,{disabled:S.a.bool,title:S.a.node,tabClassName:S.a.string}),Wa=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=o()({},this.props);return delete e.title,delete e.disabled,delete e.tabClassName,f.a.createElement(Ga,e)},t}(f.a.Component);Wa.propTypes=Fa,Wa.Container=Aa,Wa.Content=Da,Wa.Pane=Ga;var Ya=Wa,ja={striped:S.a.bool,bordered:S.a.bool,condensed:S.a.bool,hover:S.a.bool,responsive:S.a.bool},Xa=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.striped,s=t.bordered,r=t.condensed,a=t.hover,i=t.responsive,l=t.className,c=$(v()(t,["striped","bordered","condensed","hover","responsive","className"])),u=c[0],h=c[1],d=o()({},j(u),((e={})[G(u,"striped")]=n,e[G(u,"bordered")]=s,e[G(u,"condensed")]=r,e[G(u,"hover")]=a,e)),p=f.a.createElement("table",o()({},h,{className:b()(l,d)}));return i?f.a.createElement("div",{className:G(u,"responsive")},p):p},t}(f.a.Component);Xa.propTypes=ja,Xa.defaultProps={bordered:!1,condensed:!1,hover:!1,responsive:!1,striped:!1};var Ua=F("table",Xa),$a=Aa.ControlledComponent,Ka={activeKey:S.a.any,bsStyle:S.a.oneOf(["tabs","pills"]),animation:S.a.bool,id:At()(S.a.oneOfType([S.a.string,S.a.number])),onSelect:S.a.func,mountOnEnter:S.a.bool,unmountOnExit:S.a.bool};var Va=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.renderTab=function(e){var t=e.props,n=t.title,s=t.eventKey,r=t.disabled,a=t.tabClassName;return null==n?null:f.a.createElement(Er,{eventKey:s,disabled:r,className:a},n)},t.prototype.render=function(){var e=this.props,t=e.id,n=e.onSelect,s=e.animation,r=e.mountOnEnter,a=e.unmountOnExit,i=e.bsClass,l=e.className,c=e.style,u=e.children,h=e.activeKey,d=void 0===h?function(e){var t=void 0;return J.forEach(e,function(e){null==t&&(t=e.props.eventKey)}),t}(u):h,p=v()(e,["id","onSelect","animation","mountOnEnter","unmountOnExit","bsClass","className","style","children","activeKey"]);return f.a.createElement($a,{id:t,activeKey:d,onSelect:n,className:l,style:c},f.a.createElement("div",null,f.a.createElement(Js,o()({},p,{role:"tablist"}),J.map(u,this.renderTab)),f.a.createElement(Da,{bsClass:i,animation:s,mountOnEnter:r,unmountOnExit:a},u)))},t}(f.a.Component);Va.propTypes=Ka,Va.defaultProps={bsStyle:"tabs",animation:!0,mountOnEnter:!1,unmountOnExit:!1},F("tab",Va);var Ha=Pt()(Va,{activeKey:"onSelect"}),qa={src:S.a.string,alt:S.a.string,href:S.a.string,onError:S.a.func,onLoad:S.a.func},Ja=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.src,n=e.alt,s=e.onError,r=e.onLoad,a=e.className,i=e.children,l=$(v()(e,["src","alt","onError","onLoad","className","children"])),c=l[0],u=l[1],h=u.href?ye:"div",d=j(c);return f.a.createElement(h,o()({},u,{className:b()(a,d)}),f.a.createElement("img",{src:t,alt:n,onError:s,onLoad:r}),i&&f.a.createElement("div",{className:"caption"},i))},t}(f.a.Component);Ja.propTypes=qa;var za=F("thumbnail",Ja),Qa={type:S.a.oneOf(["checkbox","radio"]),name:S.a.string,checked:S.a.bool,disabled:S.a.bool,onChange:S.a.func,value:S.a.any.isRequired},Za=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.children,n=e.name,s=e.checked,r=e.type,a=e.onChange,i=e.value,l=v()(e,["children","name","checked","type","onChange","value"]),c=l.disabled;return f.a.createElement(Te,o()({},l,{active:!!s,componentClass:"label"}),f.a.createElement("input",{name:n,type:r,autoComplete:"off",value:i,checked:!!s,disabled:!!c,onChange:a}),t)},t}(f.a.Component);Za.propTypes=Qa;var eo=Za,to={name:S.a.string,value:S.a.any,onChange:S.a.func,type:S.a.oneOf(["checkbox","radio"]).isRequired},no=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.getValues=function(){var e=this.props.value;return null==e?[]:[].concat(e)},t.prototype.handleToggle=function(e){var t=this.props,n=t.type,s=t.onChange,r=this.getValues(),a=-1!==r.indexOf(e);"radio"!==n?s(a?r.filter(function(t){return t!==e}):[].concat(r,[e])):a||s(e)},t.prototype.render=function(){var e=this,t=this.props,n=t.children,s=t.type,r=t.name,a=v()(t,["children","type","name"]),i=this.getValues();return"radio"!==s||r||O()(!1),delete a.onChange,delete a.value,f.a.createElement(Pe,o()({},a,{"data-toggle":"buttons"}),J.map(n,function(t){var n=t.props,a=n.value,o=n.onChange;return f.a.cloneElement(t,{type:s,name:t.name||r,checked:-1!==i.indexOf(a),onChange:q(o,function(){return e.handleToggle(a)})})}))},t}(f.a.Component);no.propTypes=to,no.defaultProps={type:"radio"};var so=Pt()(no,{value:"onChange"});so.Button=eo;var ro=so,ao={id:At()(S.a.oneOfType([S.a.string,S.a.number])),placement:S.a.oneOf(["top","right","bottom","left"]),positionTop:S.a.oneOfType([S.a.number,S.a.string]),positionLeft:S.a.oneOfType([S.a.number,S.a.string]),arrowOffsetTop:S.a.oneOfType([S.a.number,S.a.string]),arrowOffsetLeft:S.a.oneOfType([S.a.number,S.a.string])},oo=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.placement,s=t.positionTop,r=t.positionLeft,a=t.arrowOffsetTop,i=t.arrowOffsetLeft,l=t.className,c=t.style,u=t.children,h=$(v()(t,["placement","positionTop","positionLeft","arrowOffsetTop","arrowOffsetLeft","className","style","children"])),d=h[0],p=h[1],m=o()({},j(d),((e={})[n]=!0,e)),g=o()({top:s,left:r},c),y={top:a,left:i};return f.a.createElement("div",o()({},p,{role:"tooltip",className:b()(l,m),style:g}),f.a.createElement("div",{className:G(d,"arrow"),style:y}),f.a.createElement("div",{className:G(d,"inner")},u))},t}(f.a.Component);oo.propTypes=ao,oo.defaultProps={placement:"right"};var io=F("tooltip",oo),lo=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=j(s);return f.a.createElement("div",o()({},r,{className:b()(t,a)}))},t}(f.a.Component),co=F("well",Y([M,A],lo));n.d(t,"Accordion",function(){return ee}),n.d(t,"Alert",function(){return le}),n.d(t,"Badge",function(){return he}),n.d(t,"Breadcrumb",function(){return Se}),n.d(t,"BreadcrumbItem",function(){return be}),n.d(t,"Button",function(){return Te}),n.d(t,"ButtonGroup",function(){return Pe}),n.d(t,"ButtonToolbar",function(){return Ie}),n.d(t,"Carousel",function(){return ze}),n.d(t,"CarouselItem",function(){return Ue}),n.d(t,"Checkbox",function(){return et}),n.d(t,"Clearfix",function(){return rt}),n.d(t,"CloseButton",function(){return ae}),n.d(t,"ControlLabel",function(){return lt}),n.d(t,"Col",function(){return ht}),n.d(t,"Collapse",function(){return bt}),n.d(t,"Dropdown",function(){return qt}),n.d(t,"DropdownButton",function(){return Zt}),n.d(t,"Fade",function(){return nn}),n.d(t,"Form",function(){return an}),n.d(t,"FormControl",function(){return gn}),n.d(t,"FormGroup",function(){return bn}),n.d(t,"Glyphicon",function(){return Ve}),n.d(t,"Grid",function(){return Cn}),n.d(t,"HelpBlock",function(){return Tn}),n.d(t,"Image",function(){return An}),n.d(t,"InputGroup",function(){return kn}),n.d(t,"Jumbotron",function(){return Bn}),n.d(t,"Label",function(){return Fn}),n.d(t,"ListGroup",function(){return $n}),n.d(t,"ListGroupItem",function(){return jn}),n.d(t,"Media",function(){return us}),n.d(t,"MenuItem",function(){return ps}),n.d(t,"Modal",function(){return Ks}),n.d(t,"ModalBody",function(){return As}),n.d(t,"ModalFooter",function(){return ks}),n.d(t,"ModalHeader",function(){return Gs}),n.d(t,"ModalTitle",function(){return Ys}),n.d(t,"Nav",function(){return Js}),n.d(t,"Navbar",function(){return mr}),n.d(t,"NavbarBrand",function(){return Zs}),n.d(t,"NavDropdown",function(){return vr}),n.d(t,"NavItem",function(){return Er}),n.d(t,"Overlay",function(){return Mr}),n.d(t,"OverlayTrigger",function(){return Ir}),n.d(t,"PageHeader",function(){return kr}),n.d(t,"PageItem",function(){return jr}),n.d(t,"Pager",function(){return $r}),n.d(t,"Pagination",function(){return Qr}),n.d(t,"PaginationButton",function(){return qr}),n.d(t,"Panel",function(){return ta}),n.d(t,"PanelGroup",function(){return Z}),n.d(t,"Popover",function(){return ra}),n.d(t,"ProgressBar",function(){return ca}),n.d(t,"Radio",function(){return da}),n.d(t,"ResponsiveEmbed",function(){return ma}),n.d(t,"Row",function(){return va}),n.d(t,"SafeAnchor",function(){return ye}),n.d(t,"SplitButton",function(){return Ca}),n.d(t,"Tab",function(){return Ya}),n.d(t,"TabContainer",function(){return Aa}),n.d(t,"TabContent",function(){return Da}),n.d(t,"Table",function(){return Ua}),n.d(t,"TabPane",function(){return Ga}),n.d(t,"Tabs",function(){return Ha}),n.d(t,"Thumbnail",function(){return za}),n.d(t,"ToggleButton",function(){return eo}),n.d(t,"ToggleButtonGroup",function(){return ro}),n.d(t,"Tooltip",function(){return io}),n.d(t,"Well",function(){return co}),n.d(t,"utils",function(){return r})},function(e,t,n){e.exports={default:n(377),__esModule:!0}},function(e,t,n){e.exports=n(265)},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1)),a=s(n(13)),o=n(266);if(a.default.render(r.default.createElement(o.BattlesTop,null),document.getElementById("mount-point")),/debug/.test(document.location.search)){let e=r.default.createClass;Object.defineProperty(r.default,"createClass",{set:t=>{e=t}})}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(1)),o=r(n(267)),i=r(n(307)),l=r(n(188)),c=r(n(309)),u=r(n(312)),h=r(n(132)),d=r(n(315)),p=r(n(320)),f=r(n(426)),m=r(n(211)),g=r(n(427)),y=r(n(428)),v=r(n(429)),_=r(n(430)),b=r(n(431)),E=r(n(473)),S=n(165),C=(n(17)("bitn:top"),r(n(8))),w=n(28),T=n(252),{KeyMap:O}=w.Keys,M="Inventory";t.BattlesTop=class extends a.Component{constructor(e){super(e),this.loadScriptId="#load-script-input",this.loadFromScriptId="#load-from-script-input",this.levelInputId="#level-file-input",this.gameManager=new T.GameManager(this.setState.bind(this)),this.gameManager.progressCb=this.progress.bind(this),this.state={animation:null,boardClassName:"game-board-player-view",editorData:{},equipSelected:null,invMsg:"",invMsgStyle:"",levelSize:"Medium",loadFromEditor:!1,mouseOverCell:null,playMode:"OverWorld",playerClass:"",playerRace:"",playerLevel:"Medium",playerName:"Player",plugins:[],progress:"",render:!0,saveInProgress:!1,seedName:"",selectedCell:null,selectedGame:null,selectedItem:null,showCharInfo:!1,showCreateScreen:!1,showEditor:!1,showGameMenu:!1,showHelpScreen:!1,showInventory:!1,showLoadScreen:!1,showMap:!1,showOWMap:!1,showPlugins:!1,showStartScreen:!0},this.bindCallbacks(),this.initGUICommandTable()}showPluginManager(){this.setState({showPlugins:!this.state.showPlugins})}toggleEditor(){this.gameManager.cancelAnim();const e=this.state.showEditor;this.setState({showStartScreen:e,showEditor:!this.state.showEditor})}selectSaveGame(e){this.setState({selectedGame:e})}setPlayerName(e){this.gameManager.setPlayerName(e),this.setState({playerName:e})}setSeedName(e){this.gameManager.setSeedName(e),this.setState({seedName:e})}setViewSize(e,t){this.gameManager.setViewSize(e,t),this.setState({render:!0})}setViewType(e){this.gameManager.setViewType(e),this.setState({render:!0,boardClassName:this.gameManager.boardClassName,showMap:this.gameManager.showMap})}newGame(){this.gameManager.enableKeys(),this.hideScreen("StartScreen"),this.state.loadFromEditor?this.createGameFromEditor():(this.createNewGame(),this.setState({render:!0}))}createGameFromEditor(){const e=this.state.editorData.levelsToPlay;this.gameManager.createGameFromLevels(e)}saveGame(){this.gameManager.saveGame(()=>{this.setState({saveInProgress:!1})})}loadGame(e){this.gameManager.loadGame(e,e=>{this.gameManager.initRestoredGame(e)})}deleteGame(e){this.gameManager.deleteGame(e,()=>{this.setState({render:!0,selectedGame:null})})}createNewGame(){this.gameManager.createNewGame(()=>{this.showScreen("CreateScreen")})}progress(e){this.setState({progress:e})}loadFromScript(){document.querySelector(this.loadFromScriptId).click()}selectItemTop(e){this.setState({selectedItem:e})}selectEquipTop(e){e?this.setState({selectedItem:e.item,equipSelected:e}):this.setState({selectedItem:null,equipSelected:null})}onMouseOverCell(e,t){const n=this.gameManager.getCellCurrMap(e,t);console.log("onMouseOverCell",e,t),n&&this.setState({mouseOverCell:n})}handleRightClick(e,t,n){const[s,r]=n.getXY();this.gameManager.useClickHandler(s,r,n,t.type)}onCellClick(e,t){this.gameManager.onCellClick(e,t)}importJSON(){document.querySelector(this.levelInputId).click()}loadScript(){document.querySelector(this.loadScriptId).click()}onLoadScript(){this.gameManager.onLoadScript(this.loadScriptId,()=>{this.updatePluginList()})}onLoadFromScript(){this.gameManager.onLoadFromScript(this.loadFromScriptId,()=>{this.setState({render:!0})})}updatePluginList(){this.setState({showPlugins:!0,plugins:this.gameManager.getPlugins()})}setPlayerDriver(){this.gameManager.setPlayerDriver()}onLoadCallback(e){this.gameManager.onLoadCallback(e,()=>{this.setState({render:!0})})}onLoadRecordedKeys(e){this.gameManager.onLoadRecordedKeys(e)}render(){const[e,t]=this.gameManager.getOWAndPlayerPos();let n="",s=null,r=null,C=null,w=null,T=null;const O=this.gameManager.getMessages(),M=this.gameManager.isGameValid(),A=this.gameManager.isMenuShown();M&&(s=this.gameManager.getPlayer(),this.gameManager.renderScreen(),C=(r=this.gameManager.getScreen()).getCharRows(),w=r.getClassRows(),T=r.getStartX(),n="cell-row-div-player-view",this.state.showMap&&(n="cell-row-div-map-view"));const N={playerClass:this.state.playerClass,playerRace:this.state.playerRace,playMode:this.state.playMode,playerLevel:this.state.playerLevel,levelSize:this.state.levelSize},P=this.getOneSelectedCell();return a.createElement("div",{className:"container main-div",id:"main-div"},a.createElement(g.default,{menuCallback:this.topMenuCallback}),(this.state.showStartScreen||this.state.showLoadScreen)&&a.createElement(o.default,{deleteGame:this.deleteGame,loadFromEditor:this.state.loadFromEditor,loadGame:this.loadGame,newGame:this.newGame,playerName:this.state.playerName,progress:this.state.progress,savedPlayerList:this.gameManager.getPlayersAsList(),seedName:this.state.seedName,selectedGame:this.state.selectedGame,selectGame:this.selectSaveGame,setPlayerClass:this.setPlayerClass,setPlayerLevel:this.setPlayerLevel,setPlayerName:this.setPlayerName,setPlayerRace:this.setPlayerRace,setPlayMode:this.setPlayMode,setSeedName:this.setSeedName,settings:N,showLoadScreen:this.state.showLoadScreen,showStartScreen:this.state.showStartScreen,toggleEditor:this.toggleEditor,toggleScreen:this.toggleScreen}),this.state.showCreateScreen&&a.createElement(y.default,{gameCreated:M,progress:this.state.progress,showCreateScreen:this.state.showCreateScreen,toggleScreen:this.toggleScreen}),this.state.showHelpScreen&&a.createElement(u.default,{showHelpScreen:this.state.showHelpScreen,toggleScreen:this.toggleScreen}),this.state.showOWMap&&a.createElement(c.default,{ow:e,playerOwPos:t,showOWMap:this.state.showOWMap,toggleScreen:this.toggleScreen}),M&&!this.state.showEditor&&this.state.showInventory&&a.createElement(d.default,{doInvCmd:this.doInvCmd,equipSelected:this.state.equipSelected,handleKeyDown:this.gameManager.handleKeyDown,invMsg:this.state.invMsg,msgStyle:this.state.invMsgStyle,player:s,selectedItem:this.state.selectedItem,selectEquipTop:this.selectEquipTop,selectItemTop:this.selectItemTop,setInventoryMsg:this.setInventoryMsg,showInventory:this.state.showInventory,toggleScreen:this.toggleScreen}),M&&!this.state.showEditor&&this.state.showCharInfo&&a.createElement(f.default,{player:s,showCharInfo:this.state.showCharInfo,toggleScreen:this.toggleScreen}),this.state.showPlugins&&a.createElement(_.default,{pluginManager:this.gameManager.pluginManager,plugins:this.state.plugins,updatePluginList:this.updatePluginList}),!this.state.showEditor&&a.createElement("div",{className:"row game-panel-div"},a.createElement("div",{className:"col-md-2"},M&&a.createElement("div",{className:"text-left game-stats-div"},a.createElement(b.default,{player:s,selectedCell:P,selectedItem:this.state.selectedItem,setViewType:this.setViewType,showMap:this.state.showMap,toggleScreen:this.toggleScreen}))),M&&a.createElement("div",{className:"col-md-10"},a.createElement("div",{className:"game-messages-div"},a.createElement(l.default,{message:O,saveInProgress:this.state.saveInProgress,showAll:!1,visibleCells:this.gameManager.guiState("visibleCells")})),a.createElement("div",{className:"game-board-div"},!A&&a.createElement(S.ContextMenuTrigger,{id:"right-click-context-menu"},a.createElement(h.default,{boardClassName:this.state.boardClassName,charRows:C,classRows:w,endY:r.endY,onCellClick:this.onCellClick,onMouseOverCell:this.onMouseOverCell,rowClass:n,sizeX:2*r.viewportX+1,startX:T,startY:r.startY,useRLE:!0})),A&&a.createElement(i.default,{height:28,menuItemClicked:this.menuItemClicked,menuObj:this.gameManager.getMenu(),width:80})))),!this.state.showEditor&&a.createElement(a.Fragment,null,a.createElement(m.default,{id:"",objData:this.gameManager.game,onLoadCallback:this.onLoadCallback,pretty:!1,savedObjName:s?"saveGame_"+s.getName():"",saveButtonName:"Save",setMsg:this.showMsg}),a.createElement(m.default,{fNamePrefix:"keys",id:"keys",loadInputValue:"Load keys",objData:this.gameManager.getRecordedCommands(),onLoadCallback:this.onLoadRecordedKeys,pretty:!1,savedObjName:s?"recorded_cmds_"+s.getName():"",saveButtonName:"SaveKeys",setMsg:this.showMsg})),!this.state.showEditor&&a.createElement(E.default,{handleRightClick:this.handleRightClick,mouseOverCell:this.state.mouseOverCell}),this.state.showEditor&&a.createElement(p.default,{editorData:this.state.editorData,setEditorData:this.setEditorData,toggleEditor:this.toggleEditor}),a.createElement(v.default,{inputId:"load-script-input",onLoadScript:this.onLoadScript}),a.createElement(v.default,{inputId:"load-from-script-input",onLoadScript:this.onLoadFromScript}))}menuItemClicked(e){this.gameManager.menuItemClicked(e)}setEditorData(e,t){const n={levelsToPlay:e,allLevels:t};this.setPlayMode("Editor"),this.setState({editorData:n,loadFromEditor:!0})}getOneSelectedCell(){if(Array.isArray(this.state.selectedCell)){const e=this.state.selectedCell;if(e.length>0)return e[0]}return this.state.selectedCell}initGUICommandTable(){const e={};e[w.Keys.GUI.Help]=this.GUIHelp.bind(this),e[w.Keys.GUI.Inv]=this.GUIInventory.bind(this),e[w.Keys.GUI.Map]=this.GUIMap.bind(this),e[w.Keys.GUI.OwMap]=this.GUIOverWorldMap.bind(this),e[w.Keys.GUI.Use]=this.GUIUseItem.bind(this),e[w.Keys.GUI.CharInfo]=this.GUICharInfo.bind(this),e.GOTO=this.GUIGoto.bind(this),this.gameManager.setGUICommands(e)}GUIHelp(){this.showScreen("HelpScreen")}GUICharInfo(){this.showScreen("CharInfo")}GUIGoto(e,t){const n=this.gameManager.getPlayer().getCell();this.gameManager.useClickHandler(e,t,n,"move")}doInvCmd(e){this.gameManager.updateGame(e)}setInventoryMsg(e){this.setState({invMsg:e.invMsg,invMsgStyle:e.msgStyle})}GUIInventory(){this.toggleScreen(M)}GUIMap(){this.state.showMap?this.setViewType(T.VIEW_PLAYER):this.setViewType(T.VIEW_MAP)}GUIOverWorldMap(){this.toggleScreen("OWMap")}GUILook(){this.gameManager.GUILook(e=>{this.setState(e)})}GUIUseItem(e){this.gameManager.guiState("useModeEnabled")?this.gameManager.useItem(e,this.state.selectedItem):(this.gameManager.guiState("useModeEnabled",!0),null===this.state.selectedItem&&this.showScreen("Inventory"),C.default.gameMsg("Select direction for using the item."))}GUINextTarget(){if(this.gameManager.guiState("isTargeting")){const e=this.gameManager.getNextTargetCell();this.gameManager.setSelectedCell(e),this.setState({selectedCell:e})}}showScreen(e){const t="show"+e;if(this.gameManager.disableKeys(),this.state.hasOwnProperty(t))this.setState({[t]:!0});else{const e=`showScreen: key ${t} not found in state`;console.error(e),C.default.gameIntError(`Screen for ${t} not implemented yet`)}}hideScreen(e){const t="show"+e;this.gameManager.enableKeys(),this.setState({[t]:!1})}toggleScreen(e){const t="show"+e,n=this.state[t];n?this.gameManager.enableKeys():this.gameManager.disableKeys(),this.setState({[t]:!n})}showStartScreen(){this.state.showStartScreen||this.setState({showStartScreen:!0})}showLoadScreen(){this.setState({showLoadScreen:!0})}setPlayerLevel(e){this.setGameSetting("playerLevel",e)}setPlayerClass(e){this.setGameSetting("playerClass",e)}setPlayerRace(e){this.setGameSetting("playerRace",e)}setPlayMode(e){this.setGameSetting("playMode",e)}setGameSetting(e,t){this.gameManager.setGameSettings(e,t),this.setState({[e]:t})}topMenuCallback(e,t){"function"==typeof this[e]?Array.isArray(t)?1===t.length?this[e](t):this[e](...t):this[e](t):(console.error(`${e} not a function in Top`),console.error(`Called with args ${t}`))}showMsg(e){let t=e;e.errorMsg&&(t=e.errorMsg),C.default.diag("showMsg:",t),console.log("showMsg arg:",e),this.setState({msg:t})}bindCallbacks(){this.newGame=this.newGame.bind(this),this.showMsg=this.showMsg.bind(this),this.deleteGame=this.deleteGame.bind(this),this.loadGame=this.loadGame.bind(this),this.setPlayMode=this.setPlayMode.bind(this),this.setPlayerLevel=this.setPlayerLevel.bind(this),this.setPlayerName=this.setPlayerName.bind(this),this.setSeedName=this.setSeedName.bind(this),this.setPlayerClass=this.setPlayerClass.bind(this),this.setPlayerRace=this.setPlayerRace.bind(this),this.setViewSize=this.setViewSize.bind(this),this.saveGame=this.saveGame.bind(this),this.setViewType=this.setViewType.bind(this),this.onCellClick=this.onCellClick.bind(this),this.handleRightClick=this.handleRightClick.bind(this),this.onMouseOverCell=this.onMouseOverCell.bind(this),this.GUIHelp=this.GUIHelp.bind(this),this.GUIInventory=this.GUIInventory.bind(this),this.GUIMap=this.GUIMap.bind(this),this.GUIOverWorldMap=this.GUIOverWorldMap.bind(this),this.GUINextTarget=this.GUINextTarget.bind(this),this.GUILook=this.GUILook.bind(this),this.GUIUseItem=this.GUIUseItem.bind(this),this.selectSaveGame=this.selectSaveGame.bind(this),this.setInventoryMsg=this.setInventoryMsg.bind(this),this.selectEquipTop=this.selectEquipTop.bind(this),this.selectItemTop=this.selectItemTop.bind(this),this.doInvCmd=this.doInvCmd.bind(this),this.setEditorData=this.setEditorData.bind(this),this.toggleEditor=this.toggleEditor.bind(this),this.toggleScreen=this.toggleScreen.bind(this),this.showScreen=this.showScreen.bind(this),this.hideScreen=this.hideScreen.bind(this),this.showStartScreen=this.showStartScreen.bind(this),this.showLoadScreen=this.showLoadScreen.bind(this),this.onLoadRecordedKeys=this.onLoadRecordedKeys.bind(this),this.onLoadCallback=this.onLoadCallback.bind(this),this.topMenuCallback=this.topMenuCallback.bind(this),this.menuItemClicked=this.menuItemClicked.bind(this),this.onLoadScript=this.onLoadScript.bind(this),this.onLoadFromScript=this.onLoadFromScript.bind(this),this.loadScript=this.loadScript.bind(this),this.updatePluginList=this.updatePluginList.bind(this)}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(1)),o=r(n(80)),i=r(n(268)),l=r(n(8)),c=r(n(62)),u=n(179),h=n(64),d=n(306);t.default=class extends a.Component{constructor(e){super(e),this.onNameChange=this.onNameChange.bind(this),this.deleteGame=this.deleteGame.bind(this),this.selectGame=this.selectGame.bind(this),this.loadGame=this.loadGame.bind(this),this.onSeedChange=this.onSeedChange.bind(this)}onNameChange(e){const t=e.target.value;e.stopPropagation(),this.props.setPlayerName(t)}onSeedChange(e){const t=e.target.value;e.stopPropagation(),this.props.setSeedName(t)}loadGame(){this.props.loadGame(this.props.selectedGame)}deleteGame(){this.props.deleteGame(this.props.selectedGame)}selectGame(e){this.props.selectGame(e)}render(){const e=this.props.setPlayerLevel,t=this.props.setPlayMode,n=this.props.savedPlayerList.map((e,t)=>a.createElement("div",{className:"player-list-item",key:t,onClick:this.selectGame.bind(this,e.name)},"Name: ",e.name,", L: ",e.expLevel," DL: ",e.dungeonLevel)),s=this.props.newGame,r=l.default.gameTitle+" Load a game";let p=null;return this.props.progress&&(p=a.createElement("div",null,a.createElement("p",{className:"text-info"},this.props.progress))),this.props.loadFromEditor&&(p=a.createElement("div",null,a.createElement("p",{className:"text-warning"},"Using Editor data for the Game"))),a.createElement("div",{id:"game-start-screen"},this.props.showLoadScreen&&a.createElement(c.default,{"aria-labelledby":"game-load-modal-label",id:"gameLoadModal",large:!0,onHide:this.toggleScreen.bind(this,"LoadScreen"),show:this.props.showLoadScreen},a.createElement(o.default,{id:"game-load-modal-label",text:r}),a.createElement("div",{className:"modal-body row"},n,a.createElement("p",null,"Selected game: ",this.props.selectedGame)),a.createElement("div",{className:"modal-footer row"},a.createElement("div",{className:"col-md-6"},a.createElement("button",{className:"btn btn-secondary btn-warning","data-dismiss":"modal",onClick:this.loadGame,type:"button"},"Load"),a.createElement("button",{className:"btn btn-secondary btn-danger",onClick:this.deleteGame,type:"button"},"Delete")))),this.props.showStartScreen&&a.createElement(c.default,{"aria-labelledby":"game-start-modal-label",id:"gameStartModal",large:!0,onHide:this.toggleScreen.bind(this,"StartScreen"),show:this.props.showStartScreen},a.createElement(c.default.Header,{closeButton:!0},a.createElement(c.default.Title,{id:"game-start-modal-label"},l.default.gameTitle)),a.createElement(c.default.Body,null,a.createElement("div",{className:"row"},a.createElement("div",{className:"col-md-6",id:"prologue-box"},a.createElement("p",null," ",u.Texts.intro.chapter1," "),a.createElement("p",null," ",u.Texts.intro.chapter2," "),a.createElement("label",null,"You'll be forgotten as:",a.createElement("input",{onChange:this.onNameChange,type:"text",value:this.props.playerName})),a.createElement("label",null,"You can enter a seed here (optional):",a.createElement("input",{onChange:this.onSeedChange,type:"text",value:this.props.seedName}))),a.createElement("div",{className:"col-md-6",id:"game-options-box"},a.createElement("p",null,"Game settings"),a.createElement("div",{className:"dropdown-select-div"},a.createElement(i.default,{callback:e,currValue:this.props.settings.playerLevel,options:["Weak","Medium","Strong","Inhuman"],titleName:"Player"}),a.createElement(i.default,{callback:this.props.setPlayerClass,currValue:this.props.settings.playerClass,options:h.ACTOR_CLASSES,titleName:"Player class"}),a.createElement(i.default,{callback:this.props.setPlayerRace,currValue:this.props.settings.playerRace,options:l.default.ACTOR_RACES,titleName:"Player race"})),a.createElement("div",{className:"dropdown-select-div"},a.createElement(i.default,{callback:t,currValue:this.props.settings.playMode,id:"dropdown-select-playmode",options:["OverWorld","Arena","Quests"],titleName:"Play mode"})),p))),a.createElement("div",{className:"modal-footer row"},a.createElement("div",{className:"col-md-6"},d.isDevel&&a.createElement("button",{className:"btn btn-primary","data-dismiss":"modal",onClick:this.props.toggleEditor,type:"button"},"Editor"),a.createElement("button",{className:"btn btn-success","data-dismiss":"modal",id:"embark-button",onClick:s,type:"button"},"Embark!"),a.createElement("button",{className:"btn btn-secondary btn-warning","data-dismiss":"modal",onClick:this.toggleScreen.bind(this,"LoadScreen"),type:"button"},"Load")))))}toggleScreen(e){this.props.toggleScreen(e)}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1));t.default=class extends r.Component{constructor(e){super(e),this.onChange=this.onChange.bind(this)}render(){this.props.id||this.props.titleName;const e=this.getOptElems();return r.createElement("label",null,this.props.titleName,r.createElement("select",{id:this.props.id,name:`name-${this.props.titleName}`,onChange:this.onChange,value:this.props.currValue},e))}onChange(e){const t=e.target.value;this.props.callback(t)}getOptElems(){return this.props.options?this.props.options.map(e=>{const t=`key-${this.props.titleName}-${e}`;return r.createElement("option",{key:t,value:e},e)}):null}}},function(e,t,n){"use strict";var s=n(270);function r(){}e.exports=function(){function e(e,t,n,r,a,o){if(o!==s){var i=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw i.name="Invariant Violation",i}}function t(){return e}e.isRequired=e;var n={array:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t};return n.checkPropTypes=r,n.PropTypes=n,n}},function(e,t,n){"use strict";e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=S(n(118)),a=S(n(42)),o=S(n(33)),i=S(n(0)),l=S(n(101)),c=S(n(272)),u=S(n(273)),h=n(1),d=S(h),p=S(n(13)),f=S(n(24)),m=S(n(276)),g=S(n(286)),y=S(n(288)),v=S(n(289)),_=S(n(290)),b=S(n(121)),E=S(n(122));function S(e){return e&&e.__esModule?e:{default:e}}function C(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var w=new m.default,T=function(e){function t(){var n,s;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var r=arguments.length,a=Array(r),o=0;o<r;o++)a[o]=arguments[o];return n=s=C(this,e.call.apply(e,[this].concat(a))),O.call(s),C(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.omitProps=function(e,t){var n=Object.keys(e),s={};return n.map(function(n){Object.prototype.hasOwnProperty.call(t,n)||(s[n]=e[n])}),s},t.prototype.render=function(){var e=this.props,n=e.show,r=e.container,a=e.children,o=e.transition,i=e.backdrop,l=e.className,c=e.style,u=e.onExit,p=e.onExiting,f=e.onEnter,m=e.onEntering,v=e.onEntered,_=d.default.Children.only(a),b=this.omitProps(this.props,t.propTypes);if(!(n||o&&!this.state.exited))return null;var E=_.props,S=E.role,C=E.tabIndex;return void 0!==S&&void 0!==C||(_=(0,h.cloneElement)(_,{role:void 0===S?"document":S,tabIndex:null==C?"-1":C})),o&&(_=d.default.createElement(o,{appear:!0,unmountOnExit:!0,in:n,onExit:u,onExiting:p,onExited:this.handleHidden,onEnter:f,onEntering:m,onEntered:v},_)),d.default.createElement(g.default,{ref:this.setMountNode,container:r,onRendered:this.onPortalRendered},d.default.createElement("div",s({ref:this.setModalNodeRef,role:S||"dialog"},b,{style:c,className:l}),i&&this.renderBackdrop(),d.default.createElement(y.default,{ref:this.setDialogRef},_)))},t.prototype.componentWillReceiveProps=function(e){e.show?this.setState({exited:!1}):e.transition||this.setState({exited:!0})},t.prototype.componentWillUpdate=function(e){!this.props.show&&e.show&&this.checkForFocus()},t.prototype.componentDidMount=function(){this._isMounted=!0,this.props.show&&this.onShow()},t.prototype.componentDidUpdate=function(e){var t=this.props.transition;!e.show||this.props.show||t?!e.show&&this.props.show&&this.onShow():this.onHide()},t.prototype.componentWillUnmount=function(){var e=this.props,t=e.show,n=e.transition;this._isMounted=!1,(t||n&&!this.state.exited)&&this.onHide()},t.prototype.autoFocus=function(){if(this.props.autoFocus){var e=this.getDialogElement(),t=(0,r.default)((0,E.default)(this));e&&!(0,a.default)(e,t)&&(this.lastFocus=t,e.hasAttribute("tabIndex")||((0,f.default)(!1,'The modal content node does not accept focus. For the benefit of assistive technologies, the tabIndex of the node is being set to "-1".'),e.setAttribute("tabIndex",-1)),e.focus())}},t.prototype.restoreLastFocus=function(){this.lastFocus&&this.lastFocus.focus&&(this.lastFocus.focus(),this.lastFocus=null)},t.prototype.getDialogElement=function(){return p.default.findDOMNode(this.dialog)},t.prototype.isTopModal=function(){return this.props.manager.isTopModal(this)},t}(d.default.Component);T.propTypes=s({},g.default.propTypes,{show:i.default.bool,container:i.default.oneOfType([l.default,i.default.func]),onShow:i.default.func,onHide:i.default.func,backdrop:i.default.oneOfType([i.default.bool,i.default.oneOf(["static"])]),renderBackdrop:i.default.func,onEscapeKeyDown:i.default.func,onEscapeKeyUp:(0,c.default)(i.default.func,"Please use onEscapeKeyDown instead for consistency"),onBackdropClick:i.default.func,backdropStyle:i.default.object,backdropClassName:i.default.string,containerClassName:i.default.string,keyboard:i.default.bool,transition:u.default,backdropTransition:u.default,autoFocus:i.default.bool,enforceFocus:i.default.bool,restoreFocus:i.default.bool,onEnter:i.default.func,onEntering:i.default.func,onEntered:i.default.func,onExit:i.default.func,onExiting:i.default.func,onExited:i.default.func,manager:i.default.object.isRequired}),T.defaultProps={show:!1,backdrop:!0,keyboard:!0,autoFocus:!0,enforceFocus:!0,restoreFocus:!0,onHide:function(){},manager:w,renderBackdrop:function(e){return d.default.createElement("div",e)}};var O=function(){var e=this;this.state={exited:!this.props.show},this.renderBackdrop=function(){var t=e.props,n=t.backdropStyle,s=t.backdropClassName,r=t.renderBackdrop,a=t.backdropTransition,o=r({ref:function(t){return e.backdrop=t},style:n,className:s,onClick:e.handleBackdropClick});return a&&(o=d.default.createElement(a,{appear:!0,in:e.props.show},o)),o},this.onPortalRendered=function(){e.autoFocus(),e.props.onShow&&e.props.onShow()},this.onShow=function(){var t=(0,E.default)(e),n=(0,b.default)(e.props.container,t.body);e.props.manager.add(e,n,e.props.containerClassName),e._onDocumentKeydownListener=(0,v.default)(t,"keydown",e.handleDocumentKeyDown),e._onDocumentKeyupListener=(0,v.default)(t,"keyup",e.handleDocumentKeyUp),e._onFocusinListener=(0,_.default)(e.enforceFocus)},this.onHide=function(){e.props.manager.remove(e),e._onDocumentKeydownListener.remove(),e._onDocumentKeyupListener.remove(),e._onFocusinListener.remove(),e.props.restoreFocus&&e.restoreLastFocus()},this.setMountNode=function(t){e.mountNode=t?t.getMountNode():t},this.setModalNodeRef=function(t){e.modalNode=t},this.setDialogRef=function(t){e.dialog=t},this.handleHidden=function(){var t;(e.setState({exited:!0}),e.onHide(),e.props.onExited)&&(t=e.props).onExited.apply(t,arguments)},this.handleBackdropClick=function(t){t.target===t.currentTarget&&(e.props.onBackdropClick&&e.props.onBackdropClick(t),!0===e.props.backdrop&&e.props.onHide())},this.handleDocumentKeyDown=function(t){e.props.keyboard&&27===t.keyCode&&e.isTopModal()&&(e.props.onEscapeKeyDown&&e.props.onEscapeKeyDown(t),e.props.onHide())},this.handleDocumentKeyUp=function(t){e.props.keyboard&&27===t.keyCode&&e.isTopModal()&&e.props.onEscapeKeyUp&&e.props.onEscapeKeyUp(t)},this.checkForFocus=function(){o.default&&(e.lastFocus=(0,r.default)())},this.enforceFocus=function(){if(e.props.enforceFocus&&e._isMounted&&e.isTopModal()){var t=e.getDialogElement(),n=(0,r.default)((0,E.default)(e));t&&!(0,a.default)(t,n)&&t.focus()}}};T.Manager=m.default,t.default=T,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=i;var s,r=n(24),a=(s=r)&&s.__esModule?s:{default:s};var o={};function i(e,t){return function(n,s,r,i,l){var c=r||"<<anonymous>>",u=l||s;if(null!=n[s]){var h=r+"."+s;(0,a.default)(o[h],"The "+i+" `"+u+"` of `"+c+"` is deprecated. "+t+"."),o[h]=!0}for(var d=arguments.length,p=Array(d>5?d-5:0),f=5;f<d;f++)p[f-5]=arguments[f];return e.apply(void 0,[n,s,r,i,l].concat(p))}}i._resetWarned=function(){o={}},e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=o(n(1)),r=n(274),a=o(n(171));function o(e){return e&&e.__esModule?e:{default:e}}t.default=(0,a.default)(function(e,t,n,a,o){var i=e[t];return s.default.isValidElement(i)?new Error("Invalid "+a+" `"+o+"` of type ReactElement supplied to `"+n+"`,expected an element type (a string , component class, or function component)."):(0,r.isValidElementType)(i)?null:new Error("Invalid "+a+" `"+o+"` of value `"+i+"` supplied to `"+n+"`, expected an element type (a string , component class, or function component).")}),e.exports=t.default},function(e,t,n){"use strict";e.exports=n(275)},function(e,t,n){"use strict";
/** @license React v16.6.1
 * react-is.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */Object.defineProperty(t,"__esModule",{value:!0});var s="function"==typeof Symbol&&Symbol.for,r=s?Symbol.for("react.element"):60103,a=s?Symbol.for("react.portal"):60106,o=s?Symbol.for("react.fragment"):60107,i=s?Symbol.for("react.strict_mode"):60108,l=s?Symbol.for("react.profiler"):60114,c=s?Symbol.for("react.provider"):60109,u=s?Symbol.for("react.context"):60110,h=s?Symbol.for("react.async_mode"):60111,d=s?Symbol.for("react.concurrent_mode"):60111,p=s?Symbol.for("react.forward_ref"):60112,f=s?Symbol.for("react.suspense"):60113,m=s?Symbol.for("react.memo"):60115,g=s?Symbol.for("react.lazy"):60116;function y(e){if("object"==typeof e&&null!==e){var t=e.$$typeof;switch(t){case r:switch(e=e.type){case h:case d:case o:case l:case i:return e;default:switch(e=e&&e.$$typeof){case u:case p:case c:return e;default:return t}}case a:return t}}}function v(e){return y(e)===d}t.typeOf=y,t.AsyncMode=h,t.ConcurrentMode=d,t.ContextConsumer=u,t.ContextProvider=c,t.Element=r,t.ForwardRef=p,t.Fragment=o,t.Profiler=l,t.Portal=a,t.StrictMode=i,t.isValidElementType=function(e){return"string"==typeof e||"function"==typeof e||e===o||e===d||e===l||e===i||e===f||"object"==typeof e&&null!==e&&(e.$$typeof===g||e.$$typeof===m||e.$$typeof===c||e.$$typeof===u||e.$$typeof===p)},t.isAsyncMode=function(e){return v(e)||y(e)===h},t.isConcurrentMode=v,t.isContextConsumer=function(e){return y(e)===u},t.isContextProvider=function(e){return y(e)===c},t.isElement=function(e){return"object"==typeof e&&null!==e&&e.$$typeof===r},t.isForwardRef=function(e){return y(e)===p},t.isFragment=function(e){return y(e)===o},t.isProfiler=function(e){return y(e)===l},t.isPortal=function(e){return y(e)===a},t.isStrictMode=function(e){return y(e)===i}},function(e,t,n){"use strict";t.__esModule=!0;var s=l(n(172)),r=l(n(49)),a=l(n(76)),o=l(n(176)),i=n(285);function l(e){return e&&e.__esModule?e:{default:e}}t.default=function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},l=n.hideSiblingNodes,c=void 0===l||l,u=n.handleContainerOverflow,h=void 0===u||u;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.add=function(e,n,l){var c=t.modals.indexOf(e),u=t.containers.indexOf(n);if(-1!==c)return c;if(c=t.modals.length,t.modals.push(e),t.hideSiblingNodes&&(0,i.hideSiblings)(n,e.mountNode),-1!==u)return t.data[u].modals.push(e),c;var h={modals:[e],classes:l?l.split(/\s+/):[],overflowing:(0,o.default)(n)};return t.handleContainerOverflow&&function(e,t){var n={overflow:"hidden"};e.style={overflow:t.style.overflow,paddingRight:t.style.paddingRight},e.overflowing&&(n.paddingRight=parseInt((0,r.default)(t,"paddingRight")||0,10)+(0,a.default)()+"px"),(0,r.default)(t,n)}(h,n),h.classes.forEach(s.default.addClass.bind(null,n)),t.containers.push(n),t.data.push(h),c},this.remove=function(e){var n=t.modals.indexOf(e);if(-1!==n){var r=function(e,t){return n=function(e){return-1!==e.modals.indexOf(t)},s=-1,e.some(function(e,t){if(n(e,t))return s=t,!0}),s;var n,s}(t.data,e),a=t.data[r],o=t.containers[r];a.modals.splice(a.modals.indexOf(e),1),t.modals.splice(n,1),0===a.modals.length?(a.classes.forEach(s.default.removeClass.bind(null,o)),t.handleContainerOverflow&&function(e,t){var n=e.style;Object.keys(n).forEach(function(e){return t.style[e]=n[e]})}(a,o),t.hideSiblingNodes&&(0,i.showSiblings)(o,e.mountNode),t.containers.splice(r,1),t.data.splice(r,1)):t.hideSiblingNodes&&(0,i.ariaHidden)(!1,a.modals[a.modals.length-1].mountNode)}},this.isTopModal=function(e){return!!t.modals.length&&t.modals[t.modals.length-1]===e},this.hideSiblingNodes=c,this.handleContainerOverflow=h,this.modals=[],this.containers=[],this.data=[]},e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){e.classList?e.classList.add(t):(0,a.default)(e,t)||("string"==typeof e.className?e.className=e.className+" "+t:e.setAttribute("class",(e.className&&e.className.baseVal||"")+" "+t))};var s,r=n(173),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){"use strict";function s(e,t){return e.replace(new RegExp("(^|\\s)"+t+"(?:\\s|$)","g"),"$1").replace(/\s+/g," ").replace(/^\s*|\s*$/g,"")}e.exports=function(e,t){e.classList?e.classList.remove(t):"string"==typeof e.className?e.className=s(e.className,t):e.setAttribute("class",s(e.className&&e.className.baseVal||"",t))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return e.replace(s,function(e,t){return t.toUpperCase()})};var s=/-(.)/g;e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return(0,a.default)(e).replace(o,"-ms-")};var s,r=n(281),a=(s=r)&&s.__esModule?s:{default:s};var o=/^ms-/;e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return e.replace(s,"-$1").toLowerCase()};var s=/([A-Z])/g;e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){if(!e)throw new TypeError("No Element passed to `getComputedStyle()`");var t=e.ownerDocument;return"defaultView"in t?t.defaultView.opener?e.ownerDocument.defaultView.getComputedStyle(e,null):window.getComputedStyle(e,null):{getPropertyValue:function(t){var n=e.style;"float"==(t=(0,a.default)(t))&&(t="styleFloat");var s=e.currentStyle[t]||null;if(null==s&&n&&n[t]&&(s=n[t]),i.test(s)&&!o.test(t)){var r=n.left,l=e.runtimeStyle,c=l&&l.left;c&&(l.left=e.currentStyle.left),n.left="fontSize"===t?"1em":s,s=n.pixelLeft+"px",n.left=r,c&&(l.left=c)}return s}}};var s,r=n(174),a=(s=r)&&s.__esModule?s:{default:s};var o=/^(top|right|bottom|left)$/,i=/^([+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|))(?!px)[a-z%]+$/i;e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return"removeProperty"in e.style?e.style.removeProperty(t):e.style.removeAttribute(t)},e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return!(!e||!s.test(e))};var s=/^((translate|rotate|scale)(X|Y|Z|3d)?|matrix(3d)?|perspective|skew(X|Y)?)$/i;e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.ariaHidden=a,t.hideSiblings=function(e,t){r(e,t,function(e){return a(!0,e)})},t.showSiblings=function(e,t){r(e,t,function(e){return a(!1,e)})};var s=["template","script","style"],r=function(e,t,n){t=[].concat(t),[].forEach.call(e.children,function(e){var r,a,o;-1===t.indexOf(e)&&(a=(r=e).nodeType,o=r.tagName,1===a&&-1===s.indexOf(o.toLowerCase()))&&n(e)})};function a(e,t){t&&(e?t.setAttribute("aria-hidden","true"):t.removeAttribute("aria-hidden"))}},function(e,t,n){"use strict";t.__esModule=!0;var s=u(n(0)),r=u(n(101)),a=u(n(1)),o=u(n(13)),i=u(n(121)),l=u(n(122)),c=u(n(287));function u(e){return e&&e.__esModule?e:{default:e}}function h(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var d=function(e){function t(){var n,s;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var r=arguments.length,a=Array(r),o=0;o<r;o++)a[o]=arguments[o];return n=s=h(this,e.call.apply(e,[this].concat(a))),s.setContainer=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:s.props;s._portalContainerNode=(0,i.default)(e.container,(0,l.default)(s).body)},s.getMountNode=function(){return s._portalContainerNode},h(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this.setContainer(),this.forceUpdate(this.props.onRendered)},t.prototype.componentWillReceiveProps=function(e){e.container!==this.props.container&&this.setContainer(e)},t.prototype.componentWillUnmount=function(){this._portalContainerNode=null},t.prototype.render=function(){return this.props.children&&this._portalContainerNode?o.default.createPortal(this.props.children,this._portalContainerNode):null},t}(a.default.Component);d.displayName="Portal",d.propTypes={container:s.default.oneOfType([r.default,s.default.func]),onRendered:s.default.func},t.default=o.default.createPortal?d:c.default,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=c(n(0)),r=c(n(101)),a=c(n(1)),o=c(n(13)),i=c(n(121)),l=c(n(122));function c(e){return e&&e.__esModule?e:{default:e}}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var h=function(e){function t(){var n,s;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var r=arguments.length,c=Array(r),h=0;h<r;h++)c[h]=arguments[h];return n=s=u(this,e.call.apply(e,[this].concat(c))),s._mountOverlayTarget=function(){s._overlayTarget||(s._overlayTarget=document.createElement("div"),s._portalContainerNode=(0,i.default)(s.props.container,(0,l.default)(s).body),s._portalContainerNode.appendChild(s._overlayTarget))},s._unmountOverlayTarget=function(){s._overlayTarget&&(s._portalContainerNode.removeChild(s._overlayTarget),s._overlayTarget=null),s._portalContainerNode=null},s._renderOverlay=function(){var e=s.props.children?a.default.Children.only(s.props.children):null;if(null!==e){s._mountOverlayTarget();var t=!s._overlayInstance;s._overlayInstance=o.default.unstable_renderSubtreeIntoContainer(s,e,s._overlayTarget,function(){t&&s.props.onRendered&&s.props.onRendered()})}else s._unrenderOverlay(),s._unmountOverlayTarget()},s._unrenderOverlay=function(){s._overlayTarget&&(o.default.unmountComponentAtNode(s._overlayTarget),s._overlayInstance=null)},s.getMountNode=function(){return s._overlayTarget},u(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this._isMounted=!0,this._renderOverlay()},t.prototype.componentDidUpdate=function(){this._renderOverlay()},t.prototype.componentWillReceiveProps=function(e){this._overlayTarget&&e.container!==this.props.container&&(this._portalContainerNode.removeChild(this._overlayTarget),this._portalContainerNode=(0,i.default)(e.container,(0,l.default)(this).body),this._portalContainerNode.appendChild(this._overlayTarget))},t.prototype.componentWillUnmount=function(){this._isMounted=!1,this._unrenderOverlay(),this._unmountOverlayTarget()},t.prototype.render=function(){return null},t}(a.default.Component);h.displayName="Portal",h.propTypes={container:s.default.oneOfType([r.default,s.default.func]),onRendered:s.default.func},t.default=h,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=a(n(0)),r=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}var o={children:s.default.node},i=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.render=function(){return this.props.children},t}(r.default.Component);i.propTypes=o,t.default=i,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t,n,a){return(0,s.default)(e,t,n,a),{remove:function(){(0,r.default)(e,t,n,a)}}};var s=a(n(82)),r=a(n(102));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e){var t=!document.addEventListener,n=void 0;t?(document.attachEvent("onfocusin",e),n=function(){return document.detachEvent("onfocusin",e)}):(document.addEventListener("focus",e,!0),n=function(){return document.removeEventListener("focus",e,!0)});return{remove:n}},e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s,r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},a=c(n(1)),o=n(292),i=c(o),l=c(n(63));function c(e){return e&&e.__esModule?e:{default:e}}var u=((s={})[o.ENTERING]="in",s[o.ENTERED]="in",s),h=function(e){function t(n,s){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.call(this,n,s))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=e.children,s=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(e,["className","children"]);return a.default.createElement(i.default,s,function(e,s){return a.default.cloneElement(n,r({},s,{className:(0,l.default)("fade",t,n.props.className,u[e])}))})},t}(a.default.Component);t.default=h,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=t.EXITING=t.ENTERED=t.ENTERING=t.EXITED=t.UNMOUNTED=void 0;var s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var s=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,n):{};s.get||s.set?Object.defineProperty(t,n,s):t[n]=e[n]}return t.default=e,t}(n(0)),r=i(n(1)),a=i(n(13)),o=n(177);n(293);function i(e){return e&&e.__esModule?e:{default:e}}var l="unmounted";t.UNMOUNTED=l;var c="exited";t.EXITED=c;var u="entering";t.ENTERING=u;var h="entered";t.ENTERED=h;t.EXITING="exiting";var d=function(e){var t,n;function s(t,n){var s;s=e.call(this,t,n)||this;var r,a=n.transitionGroup,o=a&&!a.isMounting?t.enter:t.appear;return s.appearStatus=null,t.in?o?(r=c,s.appearStatus=u):r=h:r=t.unmountOnExit||t.mountOnEnter?l:c,s.state={status:r},s.nextCallback=null,s}n=e,(t=s).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var o=s.prototype;return o.getChildContext=function(){return{transitionGroup:null}},s.getDerivedStateFromProps=function(e,t){return e.in&&t.status===l?{status:c}:null},o.componentDidMount=function(){this.updateStatus(!0,this.appearStatus)},o.componentDidUpdate=function(e){var t=null;if(e!==this.props){var n=this.state.status;this.props.in?n!==u&&n!==h&&(t=u):n!==u&&n!==h||(t="exiting")}this.updateStatus(!1,t)},o.componentWillUnmount=function(){this.cancelNextCallback()},o.getTimeouts=function(){var e,t,n,s=this.props.timeout;return e=t=n=s,null!=s&&"number"!=typeof s&&(e=s.exit,t=s.enter,n=s.appear),{exit:e,enter:t,appear:n}},o.updateStatus=function(e,t){if(void 0===e&&(e=!1),null!==t){this.cancelNextCallback();var n=a.default.findDOMNode(this);t===u?this.performEnter(n,e):this.performExit(n)}else this.props.unmountOnExit&&this.state.status===c&&this.setState({status:l})},o.performEnter=function(e,t){var n=this,s=this.props.enter,r=this.context.transitionGroup?this.context.transitionGroup.isMounting:t,a=this.getTimeouts();t||s?(this.props.onEnter(e,r),this.safeSetState({status:u},function(){n.props.onEntering(e,r),n.onTransitionEnd(e,a.enter,function(){n.safeSetState({status:h},function(){n.props.onEntered(e,r)})})})):this.safeSetState({status:h},function(){n.props.onEntered(e)})},o.performExit=function(e){var t=this,n=this.props.exit,s=this.getTimeouts();n?(this.props.onExit(e),this.safeSetState({status:"exiting"},function(){t.props.onExiting(e),t.onTransitionEnd(e,s.exit,function(){t.safeSetState({status:c},function(){t.props.onExited(e)})})})):this.safeSetState({status:c},function(){t.props.onExited(e)})},o.cancelNextCallback=function(){null!==this.nextCallback&&(this.nextCallback.cancel(),this.nextCallback=null)},o.safeSetState=function(e,t){t=this.setNextCallback(t),this.setState(e,t)},o.setNextCallback=function(e){var t=this,n=!0;return this.nextCallback=function(s){n&&(n=!1,t.nextCallback=null,e(s))},this.nextCallback.cancel=function(){n=!1},this.nextCallback},o.onTransitionEnd=function(e,t,n){this.setNextCallback(n),e?(this.props.addEndListener&&this.props.addEndListener(e,this.nextCallback),null!=t&&setTimeout(this.nextCallback,t)):setTimeout(this.nextCallback,0)},o.render=function(){var e=this.state.status;if(e===l)return null;var t=this.props,n=t.children,s=function(e,t){if(null==e)return{};var n,s,r={},a=Object.keys(e);for(s=0;s<a.length;s++)n=a[s],t.indexOf(n)>=0||(r[n]=e[n]);return r}(t,["children"]);if(delete s.in,delete s.mountOnEnter,delete s.unmountOnExit,delete s.appear,delete s.enter,delete s.exit,delete s.timeout,delete s.addEndListener,delete s.onEnter,delete s.onEntering,delete s.onEntered,delete s.onExit,delete s.onExiting,delete s.onExited,"function"==typeof n)return n(e,s);var a=r.default.Children.only(n);return r.default.cloneElement(a,s)},s}(r.default.Component);function p(){}d.contextTypes={transitionGroup:s.object},d.childContextTypes={transitionGroup:function(){}},d.propTypes={},d.defaultProps={in:!1,mountOnEnter:!1,unmountOnExit:!1,appear:!1,enter:!0,exit:!0,onEnter:p,onEntering:p,onEntered:p,onExit:p,onExiting:p,onExited:p},d.UNMOUNTED=0,d.EXITED=1,d.ENTERING=2,d.ENTERED=3,d.EXITING=4;var f=(0,o.polyfill)(d);t.default=f},function(e,t,n){"use strict";t.__esModule=!0,t.transitionTimeout=function(e){var t="transition"+e+"Timeout",n="transition"+e;return function(e){if(e[n]){if(null==e[t])return new Error(t+" wasn't supplied to CSSTransitionGroup: this can cause unreliable animations and won't be supported in a future version of React. See https://fb.me/react-animation-transition-group-timeout for more information.");if("number"!=typeof e[t])return new Error(t+" must be a number (in milliseconds)")}return null}},t.classNamesShape=t.timeoutsShape=void 0;var s,r=(s=n(0))&&s.__esModule?s:{default:s};var a=r.default.oneOfType([r.default.number,r.default.shape({enter:r.default.number,exit:r.default.number}).isRequired]);t.timeoutsShape=a;var o=r.default.oneOfType([r.default.string,r.default.shape({enter:r.default.string,exit:r.default.string,active:r.default.string}),r.default.shape({enter:r.default.string,enterDone:r.default.string,enterActive:r.default.string,exit:r.default.string,exitDone:r.default.string,exitActive:r.default.string})]);t.classNamesShape=o},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=i(n(1)),a=i(n(0)),o=i(n(63));function i(e){return e&&e.__esModule?e:{default:e}}var l=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.getDefaultPrefix=function(){return"modal"},t.prototype.render=function(){var e=this.props,n=e.modalPrefix,a=e.children,i=e.className,l=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(e,["modalPrefix","children","className"]),c=n||t.getDefaultPrefix();return r.default.createElement("div",s({},l,{className:(0,o.default)(i,c+"-body")}),a)},t}(r.default.Component);l.propTypes={modalPrefix:a.default.string},t.default=l,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=l(n(1)),a=l(n(0)),o=l(n(63)),i=l(n(178));function l(e){return e&&e.__esModule?e:{default:e}}var c=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.getDefaultPrefix=function(){return"modal"},t.prototype.render=function(){var e=this.props,n=e.modalPrefix,a=e.closeButton,l=e.children,c=e.className,u=e["aria-label"],h=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(e,["modalPrefix","closeButton","children","className","aria-label"]),d=n||t.getDefaultPrefix();return r.default.createElement("div",s({},h,{className:(0,o.default)(c,d+"-header")}),a&&r.default.createElement(i.default,{className:"close","aria-label":u},r.default.createElement("span",{"aria-hidden":"true"},"×")),l)},t}(r.default.Component);c._isModalHeader=!0,c.propTypes={closeButton:a.default.bool,modalPrefix:a.default.string,"aria-label":a.default.string},c.defaultProps={closeButton:!1,"aria-label":"Close Modal"},c.contextTypes={onModalHide:a.default.func},t.default=c,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=i(n(1)),a=i(n(0)),o=i(n(63));function i(e){return e&&e.__esModule?e:{default:e}}var l=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.getDefaultPrefix=function(){return"modal"},t.prototype.render=function(){var e=this.props,n=e.modalPrefix,a=e.className,i=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(e,["modalPrefix","className"]),l=n||t.getDefaultPrefix();return r.default.createElement("h4",s({},i,{className:(0,o.default)(a,l+"-title")}))},t}(r.default.Component);l.propTypes={modalPrefix:a.default.string},t.default=l,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=i(n(1)),a=i(n(0)),o=i(n(63));function i(e){return e&&e.__esModule?e:{default:e}}var l=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.getDefaultPrefix=function(){return"modal"},t.prototype.render=function(){var e=this.props,n=e.modalPrefix,a=e.children,i=e.className,l=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(e,["modalPrefix","children","className"]),c=n||t.getDefaultPrefix();return r.default.createElement("div",s({},l,{className:(0,o.default)(i,c+"-footer")}),a)},t}(r.default.Component);l.propTypes={modalPrefix:a.default.string},t.default=l,e.exports=t.default},function(e,t,n){var s;function r(e){function n(){if(n.enabled){var e=n,r=+new Date,a=r-(s||r);e.diff=a,e.prev=s,e.curr=r,s=r;for(var o=new Array(arguments.length),i=0;i<o.length;i++)o[i]=arguments[i];o[0]=t.coerce(o[0]),"string"!=typeof o[0]&&o.unshift("%O");var l=0;o[0]=o[0].replace(/%([a-zA-Z%])/g,function(n,s){if("%%"===n)return n;l++;var r=t.formatters[s];if("function"==typeof r){var a=o[l];n=r.call(e,a),o.splice(l,1),l--}return n}),t.formatArgs.call(e,o),(n.log||t.log||console.log.bind(console)).apply(e,o)}}return n.namespace=e,n.enabled=t.enabled(e),n.useColors=t.useColors(),n.color=function(e){var n,s=0;for(n in e)s=(s<<5)-s+e.charCodeAt(n),s|=0;return t.colors[Math.abs(s)%t.colors.length]}(e),"function"==typeof t.init&&t.init(n),n}(t=e.exports=r.debug=r.default=r).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){t.save(e),t.names=[],t.skips=[];for(var n=("string"==typeof e?e:"").split(/[\s,]+/),s=n.length,r=0;r<s;r++)n[r]&&("-"===(e=n[r].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){var n,s;for(n=0,s=t.skips.length;n<s;n++)if(t.skips[n].test(e))return!1;for(n=0,s=t.names.length;n<s;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=n(299),t.names=[],t.skips=[],t.formatters={}},function(e,t){var n=1e3,s=60*n,r=60*s,a=24*r,o=365.25*a;function i(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}e.exports=function(e,t){t=t||{};var l,c=typeof e;if("string"===c&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var i=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return i*o;case"days":case"day":case"d":return i*a;case"hours":case"hour":case"hrs":case"hr":case"h":return i*r;case"minutes":case"minute":case"mins":case"min":case"m":return i*s;case"seconds":case"second":case"secs":case"sec":case"s":return i*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:return}}(e);if("number"===c&&!1===isNaN(e))return t.long?i(l=e,a,"day")||i(l,r,"hour")||i(l,s,"minute")||i(l,n,"second")||l+" ms":function(e){if(e>=a)return Math.round(e/a)+"d";if(e>=r)return Math.round(e/r)+"h";if(e>=s)return Math.round(e/s)+"m";if(e>=n)return Math.round(e/n)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(84),i=n(9),l=n(20),c=r(n(11)),{GOAL_ACTIVE:u,GOAL_COMPLETED:h}=o.GoalStatus,d=i.Random.getRNG();class p extends o.Goal.Base{constructor(e){super(e),this.setType("GoalSearchHouse");const t=e.getCell();t.hasDoor()&&(this.door=t.getXY()),this.subGoals=[],this.searchTime=d.getUniformInt(20,40)}activate(){this.status=u;const e=this.actor.getBrain().getSeenCells();this.floorCells&&0!==this.floorCells.length||(this.floorCells=e.filter(e=>"floorhouse"===e.getBaseElem().getType()));let t=m(this.actor,e);if(!t&&this.floorCells.length>0){const e=d.arrayGetRand(this.floorCells);t=new o.Goal.FollowPath(this.actor,e.getXY())}if(this.searchTime<=0){const e=this.actor.getCell();if(e.hasDoor()){const e=l.Brain.getCellsAroundActor(this.actor);let t=null;e.forEach(e=>{"floorhouse"!==e.getBaseElem().getType()&&e.isPassable()&&(t=e)}),t?(o.Goal.moveActorTo(this.actor,t),this.status=h):a.default.warn("Goal.SearcHouse","activate","Could not move out of the house")}else t=o.Goal.FollowPath(this.actor,e.getXY())}t&&this.addSubGoal(t)}process(){return this.activateIfInactive(),--this.searchTime,this.hasSubGoals()?this.status=this.processSubGoals():(this.activate(),this.status!==h&&(this.status=this.processSubGoals())),this.status}}t.GoalSearchHouse=p;class f extends o.Goal.Base{constructor(e){super(e),this.setType("GoalThief"),this.subGoals=[],this.shopCooldown=20,this.doorCooldown=25,this.visitedDoors={},this.shops={}}activate(){this.status=u,this.chooseThiefTask()}process(){return this.activateIfInactive(),--this.shopCooldown,--this.doorCooldown,this.isCompleted()?h:(this.hasSubGoals()?this.status=this.processSubGoals():(this.chooseThiefTask(),this.hasSubGoals()?this.status=this.processSubGoals():this.status=h),this.status)}isInActiveShop(){const e=this.actor.getCell();if(e.hasShop()){if(!e.getShop().isAbandoned())return this.shops[e.getKeyXY()]=e,!0}return!1}tryToSellItem(){const e=this.actor.getInvEq().getInventory(),t=d.arrayGetRand(e.getItems()),n=this.actor.getCell();if(t){const e=n.getPropType("shop")[0],s=new c.Transaction;s.setArgs({item:t,seller:this.actor,shop:e,buyer:e.getShopkeeper(),count:t.getCount()}),this.actor.add(s)}else a.default.err("Goal.Thief","tryToSellItem",`Null item for sale. Inv: ${JSON.stringify(e)}`)}tryToGoToShopCell(){let e=null;const t=Object.values(this.shops);if(t.length>0){const e=a.default.arrayGetRand(t);return new o.Goal.FollowPath(this.actor,e.getXY())}const n=this.actor.getBrain().getSeenCells();for(let t=0;t<n.length;t++){const s=n[t];s.hasShop()&&(e=new o.Goal.FollowPath(this.actor,s.getXY()))}return e||(this.shopCooldown=20),e}chooseThiefTask(){const e=!this.actor.getInvEq().getInventory().isEmpty();let t=null;const n=this.actor.getCell();if(e&&this.isInActiveShop())this.tryToSellItem(),this.status=h;else if(e&&this.shopCooldown<=0)t=this.tryToGoToShopCell();else{const e=this.actor.getBrain().getSeenCells(),s={};!(t=m(this.actor,e,s,e=>e.hasElements()))&&!n.hasDoor()&&this.doorCooldown<=0?Object.values(s).forEach(e=>{if(e.hasDoor()){const n=e.getXY(),s=e.getKeyXY();if(!this.visitedDoors.hasOwnProperty(s))return this.doorCooldown=25,void(t=new o.Goal.FollowPath(this.actor,n))}}):n.hasDoor()&&(this.visitedDoors[n.getKeyXY()]=n.getXY(),this.thiefSeesHouse()&&(t=new p(this.actor))),t||(t=new o.Goal.Explore(this.actor,30)).setCallback(this.exploreCallback.bind(this))}t&&this.addSubGoal(t)}exploreCallback(e,t){const n=this.actor.getLevel().getMap();if(n.hasXY(e,t)){const s=n.getCell(e,t);s.hasShop()&&(this.shops[s.getKeyXY()]=s)}}thiefSeesHouse(){return this.actor.getBrain().getSeenCells().filter(e=>"floorhouse"===e.getBaseElem().getType()).length>0}}function m(e,t,n,s){let r=null;for(let a=0;a<t.length;a++){const i=t[a];if(i.hasItems()){const t=i.getItems()[0];if(!t.has("Unpaid")){r=new o.Goal.GetItem(e,t);break}}n&&s(t[a])&&(n[i.getKeyXY()]=i)}return r}t.GoalThief=f,o.Goal.Thief=f},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(21),i=r(n(25));t.Cmd={},t.ACTION_ALREADY_DONE=(()=>{}),t.ACTION_ZERO_ENERGY=null,t.Cmd.ACTION_ALREADY_DONE=t.ACTION_ALREADY_DONE,t.Cmd.ACTION_ZERO_ENERGY=t.ACTION_ZERO_ENERGY;class l{constructor(e){this._actor=e.getActor(),this.brain=e}}t.CmdBase=l;class c extends l{execute(e){let n=e.target;if(n.hasActors&&e.target.hasActors()&&(n=e.target.getSentientActors()[0]),n){const[e,s]=this._actor.getXY(),[r,l]=n.getXY();if(o.Path.shortestDist(e,s,r,l)<=a.default.getMeleeAttackRange(this._actor)){const e=new i.Attack({target:n});return this._actor.add(e),t.ACTION_ALREADY_DONE}return this.brain.cmdNotPossible("Target not within attack range")}return this.brain.cmdNotPossible("No valid targets for attack")}}t.CmdAttack=c,t.Cmd.Attack=c;class u extends l{execute(e){const n=this._actor.getInvEq();let s=1;this._actor.has("DoubleShot")&&(s=2);for(let t=0;t<s;t++){const t=n.unequipAndGetItem("missile",1,0);if(a.default.isNullOrUndef([t]))return this.brain.cmdNotPossible("No missile equipped.");if(t.has("Ammo")){const e=n.getEquipment().getEquipped("missileweapon");if(null===e){const e="No missile weapon equipped.";return this.brain.cmdNotPossible(e)}{const n=t.getAmmoType(),s=e.getWeaponType();if(this._actor.has("MixedShot")){const e=/bow/;if(!(e.test(n)&&e.test(s)||n===s)){const e="Ammo/weapon not compatible.";return this.brain.cmdNotPossible(e)}}else if(n!==s){const e="Ammo/weapon not compatible.";return this.brain.cmdNotPossible(e)}}}if(a.default.isNullOrUndef([e.target]))a.default.err("Brain.Player","handleCommand","No x,y given for missile.");else{const[n,s]=e.target.getXY(),r=new i.Missile(this._actor);r.setTargetXY(n,s),r.setDamage(a.default.getMissileDamage(this._actor,t)),r.setAttack(a.default.getMissileAttack(this._actor,t)),r.setRange(a.default.getMissileRange(this._actor,t)),t.add(r),this.brain.energy=a.default.energy.MISSILE}}return t.ACTION_ALREADY_DONE}}t.CmdMissile=u,t.Cmd.Missile=u;class h extends l{execute(e){if(e.hasOwnProperty("item")){const t=e.item;let n=!1,s=`You failed to use ${t.getName()}.`;if("function"==typeof t.useItem&&(this.brain.energy=a.default.energy.USE,t.useItem({target:e.target}),n=!0),e.hasOwnProperty("callback"))n&&(s=`You used ${t.getName()}!`),e.callback({msg:s,result:n});else if(n)a.default.gameMsg(`You used ${t.getName()}!`);else{const n=new i.UseItem;n.setItem(t),n.setTarget(e.target),this._actor.add(n)}}else a.default.err("Brain.Player","handleCommand","obj has no item");return t.ACTION_ALREADY_DONE}}t.CmdUseItem=h,t.Cmd.UseItem=h;class d extends l{execute(e){const n=e.target.getElements(),s=new i.UseElement;return n.forEach(e=>{e.onUse&&s.setElement(e)}),this._actor.add(s),t.ACTION_ALREADY_DONE}}t.CmdUseElement=d,t.Cmd.UseElement=d;class p extends l{execute(e){const n=this._actor.getInvEq(),s=this._actor.getCell();let r=!1,a=`Failed to drop ${e.item.getName()}`;const o=e.count<=e.item.getCount()?e.count:e.item.getCount();let l=!1;if(s.hasShop()){l=!s.getShop().isAbandoned()}if(l){const t=s.getPropType("shop")[0],n=()=>{const n=new i.Transaction;n.setArgs({item:e.item,seller:this._actor,shop:t,callback:e.callback,buyer:t.getShopkeeper(),count:o}),this._actor.add(n)};a=`Press y to sell item for ${t.getItemPriceForSelling(e.item,o)} gold coins.`,this.brain.setWantConfirm(this.brain.energy,n,a),e.hasOwnProperty("callback")&&e.callback({msg:a,result:r})}else n.dropNItems(e.item,o)&&(r=!0,a="Item dropped!");return e.hasOwnProperty("callback")&&e.callback({msg:a,result:r}),t.ACTION_ALREADY_DONE}}t.CmdDropItem=p,t.Cmd.DropItem=p;class f extends l{execute(e){const n=new i.Equip;return n.setArgs(e),n.setIsRemove(!1),this._actor.add(n),t.ACTION_ALREADY_DONE}}t.CmdEquipItem=f,t.Cmd.EquipItem=f;class m extends l{execute(e){const n=new i.Equip;return n.setArgs(e),n.setIsRemove(!0),this._actor.add(n),t.ACTION_ALREADY_DONE}}t.CmdUnequipItem=m,t.Cmd.UnequipItem=m},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(303)),a=n(87),o=s(n(305));t.Objects={actors:a.ActorsData,items:r.default,elements:o.default}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(304),o=n(86),i=1;function l(e,t){let n=0;if("string"==typeof e)switch(e){case"leather":case"chain":case"steel":n=1*t;break;case"permaice":case"ruby":case"magic":n=1.5*t;break;case"void":n=1.75*t;break;case"gem":n=1*t;break;default:n=t}else Number.isInteger(e)&&(n=e);return Math.floor(i*n)}const c=[{name:"Gold coin",className:"cell-item-gold-coin",char:"$",material:"gold",type:"goldcoin",value:l(10),weight:.03},{name:"MeleeWeaponBase",className:"cell-item-melee-weapon",char:"(",material:["iron","wood"],type:"weapon",range:1,attack:0,defense:0,dontCreate:!0},{name:"Dagger",base:"MeleeWeaponBase",material:"iron",damage:"1d4",weaponType:"dagger",weight:.2,value:l(5)},{name:"Bayonette",base:"MeleeWeaponBase",material:"iron",damage:"1d5",weaponType:"dagger",weight:.1,value:l(10)},{name:"Short sword",base:"MeleeWeaponBase",material:"iron",damage:"1d6",weaponType:"sword",weight:.5,value:l(20)},{name:"Wooden staff",base:"MeleeWeaponBase",material:"wood",damage:"1d6",weaponType:"staff",defense:1,weight:1,value:l(30)},{name:"Whip",base:"MeleeWeaponBase",material:"leather",damage:"1d6",range:2,attack:-1,weight:.2,value:l(10)},{name:"Tomahawk",base:"MeleeWeaponBase",material:["wood","stone","leather"],damage:"1d7",attack:1,defense:1,weaponType:"axe",weight:.7,value:l(35)},{name:"Iron staff",base:"MeleeWeaponBase",material:"iron",damage:"1d8",weaponType:"staff",defense:2,weight:1.9,value:l(40)},{name:"Piolet",base:"MeleeWeaponBase",damage:"1d8",attack:1,defense:1,weaponType:"axe",weight:.7,value:l(50)},{name:"Pick-axe",base:"MeleeWeaponBase",damage:"1d8",attack:1,defense:2,weaponType:"axe",weight:2.3,value:l(50),use:"digger"},{name:"Saber",base:"MeleeWeaponBase",material:"iron",damage:"2d4 + 1",attack:2,defense:1,weaponType:"sword",weight:.6,value:l(30)},{name:"Mace",base:"MeleeWeaponBase",material:"iron",damage:"2d4 + 2",attack:2,defense:0,weaponType:"mace",weight:.8,value:l(35)},{name:"Spear",base:"MeleeWeaponBase",damage:"1d8",attack:1,defense:3,weaponType:"spear",weight:1.2,value:l(50)},{name:"Iron axe",base:"MeleeWeaponBase",damage:"1d8",attack:3,defense:1,weaponType:"axe",weight:1.5,value:l(60)},{name:"Longsword",base:"MeleeWeaponBase",material:"steel",damage:"1d8",attack:2,defense:2,weaponType:"sword",weight:.8,value:l(75)},{name:"Morningstar",base:"MeleeWeaponBase",material:["wood","iron"],damage:"1d9 + 2",attack:2,defense:3,weaponType:"mace",weight:.7,value:l(75)},{name:"Battle axe",base:"MeleeWeaponBase",material:"iron",damage:"2d6 + 2",attack:2,defense:1,weaponType:"axe",weight:2.5,value:l(85)},{name:"Warhammer",base:"MeleeWeaponBase",material:"iron",damage:"2d6 + 5",attack:3,defense:1,weaponType:"hammer",weight:4.5,value:l(100)},{name:"Dwarven pick-axe",base:"MeleeWeaponBase",damage:"1d12",attack:2,defense:2,color:a.Colors.race.dwarven,weaponType:"axe",weight:3.5,value:l(120),use:"digger"},{name:"Great battle axe",base:"MeleeWeaponBase",material:"steel",damage:"2d8 + 4",attack:3,defense:0,weaponType:"axe",weight:4.5,value:l(130)},{name:"MithrilWeaponBase",base:"MeleeWeaponBase",className:"cell-item-mithril",material:"mithril",dontCreate:!0,attack:1},{name:"Mithril dagger",base:"MithrilWeaponBase",attack:2,damage:"1d7 + 3",weaponType:"dagger",weight:.15,value:l(50)},{name:"Mithril short sword",base:"MithrilWeaponBase",attack:3,damage:"1d9 + 4",defense:2,weight:.35,value:l(100),weaponType:"sword"},{name:"Mithril mace",base:"MithrilWeaponBase",damage:"1d11 + 5",weaponType:"mace",attack:3,defense:2,weight:2.5,value:l(150)},{name:"Mithril staff",base:"MithrilWeaponBase",damage:"1d12 + 2",weaponType:"staff",defense:6,weight:1.5,value:l(170)},{name:"Mithril axe",base:"MithrilWeaponBase",attack:4,damage:"1d15 + 2",defense:3,weaponType:"axe",weight:1.2,value:l(200)},{name:"Mithril hammer",base:"MithrilWeaponBase",attack:5,damage:"1d15 + 6",defense:1,weaponType:"axe",weight:2.4,value:l(250)},{name:"Mithril long sword",base:"MithrilWeaponBase",attack:5,damage:"1d15 + 4",defense:4,weight:.6,value:l(300),weaponType:"sword"},{name:"Mithril spear",base:"MithrilWeaponBase",attack:5,damage:"1d12 + 4",defense:8,weight:.9,value:l(350),weaponType:"spear"},{name:"IceWeaponBase",base:"MeleeWeaponBase",className:"cell-item-ice",material:"permaice",dontCreate:!0,attack:1},{name:"Permaice dagger",base:"IceWeaponBase",damage:"1d4 + 9",defense:6,weight:.6,value:l(150),weaponType:"dagger"},{name:"Permaice short sword",base:"IceWeaponBase",damage:"2d5 + 6",defense:6,weight:1.5,value:l(300),weaponType:"sword"},{name:"Permaice mace",base:"IceWeaponBase",damage:"2d7 + 6",weaponType:"mace",defense:6,weight:2.5,value:l(300)},{name:"Permaice staff",base:"IceWeaponBase",damage:"3d5",weaponType:"staff",defense:7,weight:3.8,value:l(300)},{name:"Permaice axe",base:"IceWeaponBase",damage:"3d6 + 6",defense:7,weaponType:"axe",weight:4.5,value:l(400)},{name:"Permaice hammer",base:"IceWeaponBase",damage:"3d6 + 10",defense:7,weaponType:"hammer",weight:6.5,value:l(440)},{name:"Permaice long sword",base:"IceWeaponBase",damage:"4d5 + 6",defense:8,weight:3,value:l(500),weaponType:"sword"},{name:"Permaice spear",base:"IceWeaponBase",damage:"4d5 + 6",defense:12,weight:3.5,value:l(550),weaponType:"spear"},{name:"Permaice katana",base:"IceWeaponBase",damage:"10d3 + 6",defense:10,weight:4,value:l(750),weaponType:"sword"},{name:"RubyWeaponBase",base:"MeleeWeaponBase",className:"cell-item-ruby-glass",material:"ruby glass",dontCreate:!0},{name:"Ruby glass dagger",base:"RubyWeaponBase",damage:"2d5 + 2",attack:4,defense:1,weight:.1,value:l(110),weaponType:"dagger"},{name:"Ruby glass short sword",base:"RubyWeaponBase",damage:"3d5 + 2",attack:3,defense:2,weight:.2,value:l(200),weaponType:"sword"},{name:"Ruby glass mace",base:"RubyWeaponBase",damage:"3d6 + 2",attack:3,defense:3,weight:.3,value:l(250),weaponType:"mace"},{name:"Ruby glass hammer",base:"RubyWeaponBase",damage:"3d6 + 4",attack:4,defense:2,weight:.6,value:l(250),weaponType:"hammer"},{name:"Ruby glass staff",base:"RubyWeaponBase",damage:"3d5",weaponType:"staff",attack:4,defense:5,weight:.4,value:l(300)},{name:"Ruby glass sword",base:"RubyWeaponBase",damage:"4d5 + 2",attack:5,defense:2,weight:.3,value:l(350),weaponType:"sword"},{name:"Ruby glass spear",base:"RubyWeaponBase",damage:"3d5 + 2",attack:3,defense:6,weight:.4,value:l(400),weaponType:"spear"},{name:"Ruby glass battle axe",base:"RubyWeaponBase",damage:"4d6 + 3",attack:6,defense:2,weight:.7,value:l(800),weaponType:"axe"},{name:"RunedWeaponBase",base:"MeleeWeaponBase",className:"cell-item-magic",material:"forium",dontCreate:!0},{name:"Runed dagger",base:"RunedWeaponBase",damage:"2d5 + 2",attack:2,defense:1,weight:.2,value:l(100),weaponType:"dagger"},{name:"Runed short sword",base:"RunedWeaponBase",damage:"3d5 + 2",attack:3,defense:2,weight:.5,value:l(300),weaponType:"sword"},{name:"Runed mace",base:"RunedWeaponBase",damage:"3d6 + 2",attack:3,defense:2,weight:1,value:l(340),weaponType:"mace"},{name:"Runed axe",base:"RunedWeaponBase",damage:"4d5 + 2",attack:4,defense:2,weight:1.5,value:l(400),weaponType:"axe"},{name:"Runed hammer",base:"RunedWeaponBase",damage:"4d5 + 4",attack:5,defense:1,weight:2.7,value:l(400),weaponType:"hammer"},{name:"Runed staff",base:"RunedWeaponBase",damage:"4d5",weaponType:"staff",attack:2,defense:9,weight:2,value:l(400)},{name:"Runed sword",base:"RunedWeaponBase",damage:"5d5 + 2",attack:5,defense:2,weight:1,value:l(500),weaponType:"sword"},{name:"Runed spear",base:"RunedWeaponBase",damage:"4d5 + 4",attack:4,defense:8,weight:1.4,value:l(600),weaponType:"spear"},{name:"Runed runesword",base:"RunedWeaponBase",damage:"3d10 + 2",attack:5,defense:5,weight:.8,value:l(750),weaponType:"sword"},{name:"Wintersbane",base:"RunedWeaponBase",damage:"3d8 + 4",attack:6,defense:3,weight:1,value:l(1e3),weaponType:"sword"},{name:"VoidWeaponBase",base:"MeleeWeaponBase",className:"cell-item-void",material:"netherium",dontCreate:!0,onAttackHit:[o.meleeHitDamage(2,"1d8 + 1","VOID")]},{name:"Void dagger",base:"VoidWeaponBase",damage:"2d5 + 1",attack:2,defense:1,weight:.3,value:l(200),weaponType:"dagger"},{name:"Void short sword",base:"VoidWeaponBase",damage:"3d5 + 1",attack:3,defense:2,weight:.7,value:l(300),weaponType:"sword"},{name:"Void mace",base:"VoidWeaponBase",damage:"3d6 + 1",attack:3,defense:2,weight:1.4,value:l(390),weaponType:"mace"},{name:"Void axe",base:"VoidWeaponBase",damage:"4d5 + 1",attack:4,defense:2,weight:1.9,value:l(450),weaponType:"axe"},{name:"Void staff",base:"VoidWeaponBase",damage:"3d6",weaponType:"staff",attack:2,defense:9,weight:2,value:l(450)},{name:"Void longsword",base:"VoidWeaponBase",damage:"5d5 + 1",attack:5,defense:2,weight:1.4,value:l(550),weaponType:"sword"},{name:"Void spear",base:"VoidWeaponBase",damage:"4d5 + 2",attack:4,defense:8,weight:1.8,value:l(650),weaponType:"spear"},{name:"Hammer of Void",base:"VoidWeaponBase",damage:"5d5 + 4",attack:8,defense:8,weight:3.7,value:l(850),weaponType:"hammer",onAttackHit:[o.meleeHitDamage(2,"2d8 + 4","VOID")]},{name:"ArmourBase",type:"armour",className:"cell-item-armour",char:"[",dontCreate:!0,attack:0,defense:0,protection:0},{name:"Robe",base:"ArmourBase",className:"cell-item-cloth",weight:1,defense:1,armourType:"chest",value:l(15)},{name:"Spiked boots",base:"ArmourBase",weight:.4,defense:1,protection:1,armourType:"feet",value:l(35)},{name:"Robe of defense",base:"ArmourBase",className:"cell-item-cloth",weight:.9,defense:4,armourType:"chest",value:l(200)},{name:"Robe of protection",base:"ArmourBase",className:"cell-item-cloth",weight:.8,protection:4,armourType:"chest",value:l(200)},{name:"Runed robe",base:"ArmourBase",className:"cell-item-cloth",weight:.7,defense:4,protection:4,armourType:"chest",value:l(350)},{name:"Boots of flying",base:"ArmourBase",weight:.4,defense:1,protection:1,armourType:"feet",value:l(35),onEquip:[{addComp:"Flying"}]},{name:"Snow shoes",base:"ArmourBase",weight:.4,defense:-1,protection:0,armourType:"feet",value:l(75),onEquip:[{addComp:"SnowWalk"}],noRandom:!0},{name:"LeatherArmourBase",base:"ArmourBase",dontCreate:!0,material:"leather",className:"cell-item-leather"},{name:"Leather helmet",base:"LeatherArmourBase",weight:.3,defense:1,armourType:"head",value:l(15)},{name:"Leather collar",base:"LeatherArmourBase",weight:.2,protection:1,armourType:"neck",value:l(15)},{name:"Leather boots",base:"LeatherArmourBase",weight:.5,defense:1,armourType:"feet",value:l(15)},{name:"Leather armour",base:"LeatherArmourBase",weight:2,defense:2,protection:2,armourType:"chest",value:l(30)},{name:"Leather shield",base:"LeatherArmourBase",weight:1,defense:2,attack:-1,armourType:"shield",value:l(15)},{name:"ChainArmourBase",base:"ArmourBase",dontCreate:!0,material:"iron",className:"cell-item-iron"},{name:"Chain helmet",base:"ChainArmourBase",weight:.6,defense:1,protection:1,armourType:"head",value:l(45)},{name:"Chain collar",base:"ChainArmourBase",weight:.4,protection:2,armourType:"neck",value:l(45)},{name:"Chain boots",base:"ChainArmourBase",weight:1.2,defense:1,protection:1,armourType:"feet",value:l(45)},{name:"Chain armour",base:"ChainArmourBase",weight:4,defense:1,protection:3,armourType:"chest",value:l(90)},{name:"Chain shield",base:"ChainArmourBase",weight:2,defense:3,attack:-2,armourType:"shield",value:l(40)},{name:"SteelArmourBase",base:"ArmourBase",dontCreate:!0,material:"steel",className:"cell-item-steel"},{name:"Steel helmet",base:"SteelArmourBase",weight:1.1,defense:1,protection:2,armourType:"head",value:l(75)},{name:"Steel collar",base:"SteelArmourBase",weight:.8,protection:3,armourType:"neck",value:l(75)},{name:"Steel boots",base:"SteelArmourBase",weight:2,defense:1,protection:2,armourType:"feet",value:l(75)},{name:"Steel armour",base:"SteelArmourBase",weight:8,defense:0,protection:5,armourType:"chest",value:l(150)},{name:"Steel shield",base:"SteelArmourBase",weight:3,defense:4,attack:-2,armourType:"shield",value:l(80)},{name:"MithrilArmourBase",base:"ArmourBase",dontCreate:!0,material:"mithril",className:"cell-item-mithril"},{name:"Mithril helmet",base:"MithrilArmourBase",weight:.8,defense:1,protection:2,armourType:"head",value:l(120)},{name:"Mithril collar",base:"MithrilArmourBase",weight:.6,protection:3,armourType:"neck",value:l(110)},{name:"Mithril boots",base:"MithrilArmourBase",weight:1.6,defense:1,protection:2,armourType:"feet",value:l(120)},{name:"Mithril armour",base:"MithrilArmourBase",weight:6,defense:0,protection:7,armourType:"chest",value:l(200)},{name:"Mithril shield",base:"MithrilArmourBase",weight:2.2,defense:5,attack:-1,armourType:"shield",value:l(120)},{name:"IceArmourBase",base:"ArmourBase",dontCreate:!0,material:"permaice",className:"cell-item-ice"},{name:"Permaice helmet",base:"IceArmourBase",weight:1.8,defense:0,protection:4,armourType:"head",value:l(200)},{name:"Permaice collar",base:"IceArmourBase",weight:1.8,defense:0,protection:4,armourType:"neck",value:l(200)},{name:"Permaice boots",base:"IceArmourBase",weight:3.6,defense:0,protection:3,armourType:"feet",value:l(200)},{name:"Permaice armour",base:"IceArmourBase",weight:12,defense:0,protection:12,armourType:"chest",value:l(400)},{name:"Permaice shield",base:"IceArmourBase",weight:6,defense:4,attack:-3,protection:2,armourType:"shield",value:l(120)},{name:"RubyArmourBase",base:"ArmourBase",dontCreate:!0,material:"ruby glass",className:"cell-item-ruby-glass"},{name:"Ruby glass helmet",base:"RubyArmourBase",weight:.1,defense:2,protection:2,armourType:"head",value:l("ruby",100)},{name:"Ruby glass collar",base:"RubyArmourBase",weight:.1,defense:2,protection:2,armourType:"neck",value:l("ruby",100)},{name:"Ruby glass boots",base:"RubyArmourBase",weight:.2,defense:3,protection:2,armourType:"feet",value:l("ruby",200)},{name:"Ruby glass armour",base:"RubyArmourBase",weight:1,defense:6,protection:6,armourType:"chest",value:l("ruby",500)},{name:"Ruby glass shield",base:"RubyArmourBase",weight:.4,defense:5,armourType:"shield",value:l("ruby",250)},{name:"RunedArmourBase",base:"ArmourBase",dontCreate:!0,material:"forium",className:"cell-item-magic"},{name:"Runed helmet",base:"RunedArmourBase",weight:.6,defense:3,protection:4,armourType:"head",value:l("magic",200)},{name:"Runed collar",base:"RunedArmourBase",weight:.4,defense:3,protection:2,armourType:"neck",value:l("magic",200)},{name:"Runed boots",base:"RunedArmourBase",weight:1.2,defense:3,protection:2,armourType:"feet",value:l("magic",200)},{name:"Runed armour",base:"RunedArmourBase",weight:4,defense:10,protection:7,armourType:"chest",value:l("magic",500)},{name:"Runed shield",base:"RunedArmourBase",weight:2,defense:5,attack:-2,armourType:"shield",value:l("magic",200)},{name:"MissileBase",className:"cell-item-missile",char:"/",type:"missile",dontCreate:!0,attack:1,damage:"1d1",range:2,weight:.1},{name:"Rock",base:"MissileBase",className:"cell-item-rock",char:"*",damage:"1d4",range:5,value:l(10),weight:.2},{name:"Large rock",base:"MissileBase",className:"cell-item-rock",char:"*",damage:"2d4 + 2",range:2,value:l(20),weight:1},{name:"Huge rock",base:"MissileBase",className:"cell-item-rock",char:"*",damage:"5d4 + 2",range:1,value:l(40),weight:20},{name:"Shuriken",base:"MissileBase",className:"cell-item-iron",char:"*",damage:"1d6",range:3,value:l(20),weaponType:"shuriken"},{name:"Iron dart",base:"MissileBase",className:"cell-item-iron",damage:"1d6 + 1",range:4,value:l(40),weaponType:"dart"},{name:"Steel dart",base:"MissileBase",className:"cell-item-steel",damage:"1d6 + 3",range:4,value:l(50),weaponType:"dart"},{name:"Throwing spear",base:"MissileBase",className:"cell-item-iron",attack:2,damage:"1d7 + 1",range:3,value:l(55),weight:.4,weaponType:"spear"},{name:"Throwing axe",base:"MissileBase",className:"cell-item-iron",attack:2,damage:"1d8 + 1",range:3,value:l(60),weight:.3,weaponType:"axe"},{name:"Ruby glass throwing knife",base:"MissileBase",className:"cell-item-ruby-glass",attack:3,damage:"1d10",range:5,value:l(80),weight:.1,weaponType:"dagger",material:"ruby glass"},{name:"Runed Shuriken",base:"MissileBase",attack:3,className:"cell-item-magic",char:"*",material:"forium",damage:"3d4 + 2",range:5,value:l(100),weight:.1,weaponType:"shuriken"},{name:"Throwing axe of death",base:"MissileBase",className:"cell-item-magic",attack:5,damage:"2d10 + 3",range:3,value:l(200),weight:.5,addComp:"Indestructible",weaponType:"axe"},{name:"MissileWeaponBase",dontCreate:!0,type:"missileweapon",fireRate:1,className:"cell-item-missileweapon",attack:0,defense:0,char:"{"},{name:"Wooden bow",base:"MissileWeaponBase",className:"cell-item-wooden",attack:1,range:4,value:l(75),weaponType:"bow",weight:1},{name:"Wooden crossbow",base:"MissileWeaponBase",className:"cell-item-wooden",attack:3,range:6,value:l(150),weaponType:"crossbow",weight:2},{name:"Iron bow",base:"MissileWeaponBase",className:"cell-item-iron",attack:1,range:5,value:l(110),weaponType:"bow",weight:1.5},{name:"Steel bow",base:"MissileWeaponBase",className:"cell-item-steel",attack:2,range:5,value:l(150),weaponType:"bow",weight:2},{name:"Steel crossbow",base:"MissileWeaponBase",className:"cell-item-steel",attack:4,range:7,value:l(250),weaponType:"crossbow",weight:3},{name:"Ruby glass bow",base:"MissileWeaponBase",className:"cell-item-ruby-glass",attack:6,range:6,value:l("ruby",300),weaponType:"bow",weight:.3},{name:"Double crossbow",base:"MissileWeaponBase",className:"cell-item-steel",attack:0,range:5,value:l(400),fireRate:2,weaponType:"crossbow",weight:4},{name:"Bow of Defense",base:"MissileWeaponBase",className:"cell-item-magic",attack:1,range:4,defense:6,value:l("magic",500),weaponType:"bow",weight:1},{name:"Rifle",base:"MissileWeaponBase",className:"cell-item-steel",attack:4,range:7,value:l(350),weaponType:"rifle",weight:4.5},{name:"Dwarven rifle",base:"MissileWeaponBase",className:"cell-item-steel",attack:4,range:8,damage:"1d6",value:l(500),weaponType:"rifle",weight:5.5},{name:"Wooden arrow",base:"MissileBase",className:"cell-item-wooden",type:"ammo",range:1,weight:.1,ammoType:"bow",attack:0,damage:"1d6",value:l(10)},{name:"Wooden bolt",base:"MissileBase",className:"cell-item-wooden",type:"ammo",range:1,weight:.1,ammoType:"crossbow",attack:1,damage:"1d8",value:l(15)},{name:"Steel arrow",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.1,ammoType:"bow",attack:0,damage:"1d6 + 2",value:l("steel",20)},{name:"Steel bolt",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.1,ammoType:"crossbow",attack:1,damage:"1d8",value:l("steel",25)},{name:"Stone bullet",base:"MissileBase",className:"cell-item-rock",type:"ammo",range:1,weight:.1,ammoType:"rifle",attack:-1,damage:"2d4",value:l(30)},{name:"Arrow of targeting",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.1,ammoType:"bow",attack:10,damage:"1d6 + 3",value:l("steel",40)},{name:"Runed arrow",base:"MissileBase",className:"cell-item-magic",type:"ammo",range:1,weight:.2,ammoType:"bow",attack:4,damage:"2d7",value:l("magic",50)},{name:"Ruby glass bolt",base:"MissileBase",className:"cell-item-ruby-glass",type:"ammo",range:2,weight:.05,ammoType:"crossbow",attack:3,damage:"2d8",value:l("ruby",60)},{name:"Steel bullet",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.05,ammoType:"rifle",attack:1,damage:"3d4",value:l(50)},{name:"Void bolt",base:"MissileBase",className:"cell-item-void",type:"ammo",range:1,weight:.1,ammoType:"crossbow",attack:5,damage:"4d4 + 4",value:l(100)},{name:"PotionBase",className:"cell-item-potion",char:"!",type:"potion",dontCreate:!0,weight:.1,addComp:"OneShot"},{name:"Healing potion",base:"PotionBase",use:{heal:{hp:"3d4"}},value:l(10)},{name:"Potion of venom",base:"PotionBase",use:{poison:{duration:"4d4 + 5",damage:"1d6",prob:"0.1"}},value:l(30)},{name:"Potion of stunning",base:"PotionBase",use:{stun:{duration:"2d4 + 1"}},value:l(50)},{name:"Potion of power",base:"PotionBase",use:{modifyCompValue:{name:"SpellPower",set:"setPP",get:"getPP",value:"1d10 + 2"}},value:l(50)},{name:"Potion of nourishment",base:"PotionBase",use:{modifyCompValue:{name:"Hunger",set:"setEnergy",get:"getEnergy",value:"10000"}},value:l(50)},{name:"Potion of cure poison",base:"PotionBase",use:{cure:{effect:"poison"}},value:l(80)},{name:"Potion of eagle",base:"PotionBase",use:{addComp:{name:"Flying",duration:"10d10 + 10"}},value:l(80)},{name:"Potion of paralysis",base:"PotionBase",use:{addComp:{name:"Paralysis",duration:"2d5"}},value:l(80)},{name:"Potion of frost poison",base:"PotionBase",use:{poison:{duration:"5d20",damage:"1d6 + 1",prob:"0.2"}},value:l(100)},{name:"Healing elixir",base:"PotionBase",use:{heal:{hp:"10d5"}},value:l(100)},{name:"Potion of spirit form",base:"PotionBase",use:{addComp:{name:"Ethereal",duration:"2d10"}},value:l(100)},{name:"Potion of mana",base:"PotionBase",use:{modifyCompValue:{name:"SpellPower",set:"setPP",get:"getPP",value:"6d5 + 5"}},value:l(150)},{name:"Potion of quickness",base:"PotionBase",use:{modifyStat:{value:2,statName:"speed"}},value:l(150)},{name:"Potion of willpower",base:"PotionBase",use:{modifyStat:{value:1,statName:"willpower"}},value:l(200)},{name:"Potion of strength",base:"PotionBase",use:{modifyStat:{value:1,statName:"strength"}},value:l(200)},{name:"Potion of agility",base:"PotionBase",use:{modifyStat:{value:1,statName:"agility"}},value:l(200)},{name:"Potion of accuracy",base:"PotionBase",use:{modifyStat:{value:1,statName:"accuracy"}},value:l(200)},{name:"Potion of magic",base:"PotionBase",use:{modifyStat:{value:1,statName:"magic"}},value:l(200)},{name:"FoodBase",className:"cell-item-food",char:"%",weight:.1,type:"food",dontCreate:!0,addComp:"OneShot"},{name:"Carrots",base:"FoodBase",energy:500,value:l(10)},{name:"Cabbage",base:"FoodBase",energy:700,value:l(10),color:o.color("green","black")},{name:"Berries",base:"FoodBase",energy:1700,value:l(30),color:o.color("white","blue")},{name:"Potatoes",base:"FoodBase",energy:1200,value:l(20)},{name:"Dried meat",base:"FoodBase",energy:1300,value:l(20)},{name:"Corn",base:"FoodBase",energy:1600,value:l(30)},{name:"Chunk of meat",base:"FoodBase",energy:1e3,value:l(20),weight:.4,color:o.color("white","red")},{name:"Rye bread",base:"FoodBase",energy:2e3,value:l(30)},{name:"Oats",base:"FoodBase",energy:2800,value:l(30)},{name:"Ration",base:"FoodBase",energy:2e3,value:l(40),weight:1},{name:"Dried fruit",base:"FoodBase",energy:3500,value:l(50)},{name:"Ghost pepper",base:"FoodBase",energy:100,value:l(50),use:{stun:{duration:"3d3"}}},{name:"Whale fat",base:"FoodBase",energy:8e3,value:l(100)},{name:"tool",type:"tool",uses:10,className:"cell-item-tool",char:"]",dontCreate:!0},{name:"shovel",base:"tool",use:{addElement:{elementName:"Hole",numAllowed:1,successMsg:"You dig a hole to the ground",failureMsg:"You fail to dig a hole there"}}},{name:"machete",base:"tool",char:"(",use:{removeElement:{elementName:"web",successMsg:"You remove the webs using machete",failureMsg:"You do not manage to remove any webs"}}},{name:"trapmaking kit",base:"tool"},{name:"firemaking kit",base:"tool",use:{addEntity:{entityName:"Fire",duration:20}}},{name:"repair tool kit",base:"tool",use:{removeComp:{name:"Broken"}},noRandom:!0},{name:"rope",base:"tool"},{name:"piece of wood",base:"tool",className:"cell-item-wooden"},{name:"SpiritGemBase",className:"cell-item-spiritgem",char:"*",weight:.1,type:"spiritgem",dontCreate:!0},{name:"Lesser spirit gem",base:"SpiritGemBase",value:l("gem",30),weight:4},{name:"Ordinary spirit gem",base:"SpiritGemBase",value:l("gem",60),weight:2.5},{name:"Greater spirit gem",base:"SpiritGemBase",value:l("gem",100),weight:1.5},{name:"Mystical spirit gem",base:"SpiritGemBase",value:l("gem",300),weight:.5},{name:"Mythic spirit gem",base:"SpiritGemBase",value:l("gem",500),weight:.2},{name:"RuneBase",dontCreate:!0,type:"rune",char:"*",className:"cell-item-rune",weight:1},{name:"rune of healing",base:"RuneBase",use:{heal:{hp:"4d4"}},value:l("rune",100)},{name:"rune of protection",base:"RuneBase",use:{addComp:{name:"CombatMods",duration:"10d5 + 10",setters:{setProtection:"2d5"}}},value:l("rune",100)},{name:"rune of defense",base:"RuneBase",use:{addComp:{name:"CombatMods",duration:"10d5 + 10",setters:{setProtection:"2d5"}}},value:l("rune",100)},{name:"rune of attack",base:"RuneBase",use:{addComp:{name:"CombatMods",duration:"10d5 + 10",setters:{setAttack:"2d5"}}},value:l("rune",100)},{name:"rune of webs",base:"RuneBase",use:{addElement:{elementName:"Web",numAllowed:1}},value:l("rune",100)},{name:"rune of cold",base:"RuneBase",use:{addComp:{name:"Coldness",duration:"100d5 + 50"}},value:l("rune",100)},{name:"rune of fire",base:"RuneBase",use:{addEntity:{entityName:"Fire",duration:50}},value:l("rune",100)},{name:"rune of force",base:"RuneBase",use:{addEntity:{entityName:"Forcefield"}},value:l("rune",100)},{name:"rune of skies",base:"RuneBase",use:{addComp:{name:"Flying",duration:"5d10 + 5"}},value:l("rune",100)},{name:"rune of ice flames",base:"RuneBase",use:{addEntity:{entityName:"Ice flame",duration:100}},value:l("rune",150)},{name:"rune of tunneling",base:"RuneBase",use:"digger",value:l("rune",150)},{name:"rune of traps",base:"RuneBase",use:{addElement:{elementName:"Hole",numAllowed:1}},value:l("rune",150)},{name:"rune of poison clouds",base:"RuneBase",use:{addEntity:{entityName:"Poison gas",duration:30}},value:l("rune",150)},{name:"rune of venom",base:"RuneBase",use:{poison:{duration:"4d6 + 5",damage:"1d8 + 2",prob:"0.2"}},value:l("rune",150)},{name:"rune of control",base:"RuneBase",use:{addComp:{name:"MindControl",duration:"1d4 + 2"}},value:l("rune",250)},{name:"MineralBase",dontCreate:!0,type:"mineral",char:"]"},{name:"iron ore",base:"MineralBase",weight:.3,value:l("mineral",20),className:"cell-item-iron"},{name:"ruby glass ore",base:"MineralBase",weight:.1,value:l("mineral",100),className:"cell-item-ruby-glass"},{name:"emerald",base:"MineralBase",weight:.15,value:l("mineral",150),char:"*",color:{fg:"Green",bg:"Black"}},{name:"permaice ore",base:"MineralBase",weight:.4,value:l("mineral",100),className:"cell-item-ice"},{name:"sapphire",base:"MineralBase",weight:.15,value:l("mineral",150),char:"*",color:{fg:"Blue",bg:"White"}},{name:"forium ore",base:"MineralBase",weight:.2,value:l("mineral",150),className:"cell-item-magic"},{name:"netherium ore",base:"MineralBase",weight:.3,value:l("mineral",200),className:"cell-item-void"},{name:"ruby",base:"MineralBase",weight:.2,value:l("mineral",250),char:"*",className:"cell-item-ruby-glass"},{name:"ice diamond",base:"MineralBase",weight:.3,value:l("mineral",400),char:"*",className:"cell-item-ice"},{name:"MagicalArrowBase",noRandom:!0,type:"ammo",char:"/",addComp:"Magical"},{name:"Ice arrow",base:"MagicalArrowBase",className:"cell-item-ice"},{name:"Lightning arrow",base:"MagicalArrowBase",className:"cell-item-lightning"},{name:"Energy arrow",base:"MagicalArrowBase",className:"cell-item-energy"},{name:"Poison arrow",base:"MagicalArrowBase",className:"cell-item-poison"},{name:"Arrow of webs",base:"MagicalArrowBase",className:"cell-item-energy"}];t.dmgTypes={sword:r.default.DMG.SLASH,spear:r.default.DMG.PIERCE,dagger:r.default.DMG.SLASH,axe:r.default.DMG.SLASH,dart:r.default.DMG.PIERCE,shuriken:r.default.DMG.SLASH,bow:r.default.DMG.PIERCE,crossbow:r.default.DMG.PIERCE,rifle:r.default.DMG.PIERCE},c.forEach(e=>{e.weaponType?t.dmgTypes.hasOwnProperty(e.weaponType)&&(e.damageType=t.dmgTypes[e.weaponType]):e.ammoType&&t.dmgTypes.hasOwnProperty(e.ammoType)&&(e.damageType=t.dmgTypes[e.ammoType])}),t.default=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Colors={},t.Colors.race={},t.Colors.race.animal={bg:"Brown"},t.Colors.race.avianfolk={bg:"GreenYellow"},t.Colors.race.bearfolk={bg:"GreenYellow"},t.Colors.race.catfolk={bg:"GreenYellow"},t.Colors.race.dark={bg:"Brown"},t.Colors.race.dogfolk={bg:"GreenYellow"},t.Colors.race.dwarven={fg:"White",bg:"Brown"},t.Colors.race.goblin={bg:"GreenYellow"},t.Colors.race.human={bg:"Brown"},t.Colors.race.hyrkhian={bg:"Brown"},t.Colors.race.hyrm={bg:"Brown"},t.Colors.race.spirit={bg:"White"},t.Colors.race.undead={bg:"Black"},t.Colors.race.wildling={bg:"Brown"},t.Colors.race.wolfclan={bg:"Brown"},t.Colors.role={},t.Colors.role.archer="Yellow",t.Colors.role.berserker="Pink",t.Colors.role.commander="Yellow",t.Colors.role.elite="Cyan",t.Colors.role.fighter="Blue",t.Colors.role.king="Red",t.Colors.role.mage="Purple",t.Colors.role.slinger="Purple"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=[{name:"bed",className:"cell-element-bed",char:"=",msg:{onEnter:"There is a bed here for resting"},addComp:["Indoor"]},{name:"bridge",className:"cell-element-bridge",char:"=",msg:{onEnter:"You are standing on a bridge."}},{name:"chasm",className:"cell-element-chasm",char:"~",addComp:["Impassable"]},{name:"grass",className:"cell-element-grass",char:'"',msg:{onEnter:"You see some grass."}},{name:"snowy grass",className:"cell-element-snowy-grass",char:'"',addComp:["Snowy"],msg:{onEnter:"You see some snow-covered grass."}},{name:"highrock",className:"cell-element-highrock",char:"^",addComp:["Impassable","Opaque"]},{name:"floor",className:"cell-element-floor",char:"."},{name:"floorcastle",className:"cell-element-floor-castle",char:".",addComp:["Indoor"]},{name:"floorcave",className:"cell-element-floor-cave",char:".",addComp:["Indoor"]},{name:"floorcrypt",className:"cell-element-floor-crypt",char:".",addComp:["Indoor"]},{name:"floorhouse",className:"cell-element-floor-house",char:".",addComp:["Indoor"]},{name:"floorwooden",className:"cell-element-floor-wooden",char:".",addComp:["Indoor"]},{name:"fort",className:"cell-element-fort",char:"#",addComp:["Impassable"]},{name:"lava",className:"cell-element-lava",char:"~",addComp:["Impassable"]},{name:"path",className:"cell-element-path",char:"."},{name:"road",className:"cell-element-road",char:".",msg:{onEnter:"You tread lightly on the road."}},{name:"sky",className:"cell-element-sky",char:"~",addComp:["Impassable"]},{name:"light snow",className:"cell-element-light-snow",char:".",addComp:["Snowy"],msg:{onEnter:"A thin layer of snow is on the ground"}},{name:"light snow with tracks",className:"cell-element-light-snow-tracks",char:".",addComp:["Snowy"],msg:{onEnter:"Someone has traversed this thin crust of snow"}},{name:"snow",className:"cell-element-snow",char:".",addComp:["Snowy"],msg:{onEnter:"Ground is covered with snow."}},{name:"snow with tracks",className:"cell-element-snow-tracks",char:".",addComp:["Snowy"],msg:{onEnter:"Someone has left their tracks on snow"}},{name:"deep snow",className:"cell-element-deep-snow",char:".",addComp:["Snowy"],msg:{onEnter:"Snow is deep and difficult to traverse here"}},{name:"deep snow with tracks",className:"cell-element-deep-snow-tracks",char:".",addComp:["Snowy"],msg:{onEnter:"Snow is deep, but there are some tracks here"}},{name:"stone",className:"cell-element-stone",char:"^"},{name:"tree",className:"cell-element-tree",char:"T",addComp:["Opaque"],msg:{onEnter:"There is a tree here."}},{name:"snow-covered tree",className:"cell-element-snow-tree",char:"T",addComp:["Opaque","Snowy"],msg:{onEnter:"There is a snow-covered tree here."}},{name:"water",className:"cell-element-water",char:"~",msg:{onEnter:"Water slows you down"}},{name:"frozen water",className:"cell-element-frozen-water",char:"~",addComp:["Snowy"],msg:{onEnter:"There is some ice here"}},{name:"closed window",className:"cell-element-window",char:"+",addComp:["Impassable"]},{dontCreate:!0,name:"web",char:"|",className:"cell-element-web"},{dontCreate:!0,name:"slime",char:"|",className:"cell-element-slime"},{dontCreate:!0,name:"hole",char:"^",className:"cell-element-hole"},{dontCreate:!0,name:"mountain",char:"^",className:"cell-element-mountain"},{dontCreate:!0,name:"town",char:"o",className:"cell-element-town"},{dontCreate:!0,name:"battle",char:"X",className:"cell-element-battle"},{dontCreate:!0,name:"cityfort",char:"o",className:"cell-element-fort"},{dontCreate:!0,name:"wallcastle",char:"#",className:"cell-element-castle"}]},function(e,t){e.exports={isProduction:!1,isDevel:!0,showEditor:!0}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1)),a=n(308)(77);function o(e,t,n,s="&nbsp;"){let r=e-t.length-n;return r<0&&(r=0),s.repeat(n)+t+s.repeat(r)}function i(e,t){const n=[];for(let s=0;s<t;s++){const t=r.createElement("div",{className:"cell-row-div-player-view",key:"id"+s},r.createElement("span",{className:"cell-not-explored",dangerouslySetInnerHTML:{__html:o(e,"",0)}}));n.push(t)}return n}t.default=class extends r.Component{constructor(e){super(e)}menuItemClicked(e){console.log("Clicked menu item "+e),this.props.menuItemClicked(e)}render(){const{menuObj:e,width:t,height:n}=this.props,s=n-3-Object.keys(e).length,l=i(t,3),c=i(t,s),u=Object.keys(e).map(n=>{if("pre"!==n&&"post"!==n){const s=o(t,`[${n}] - ${e[n]} `,3);return r.createElement("div",{className:"cell-row-div-player-view",key:n},r.createElement("span",{className:"game-menu-text-span game-menu-item-select",dangerouslySetInnerHTML:{__html:s},onClick:this.menuItemClicked.bind(this,n)}))}return null});let h=null;e.hasOwnProperty("pre")&&Array.isArray(e.pre)&&(h=e.pre.map(e=>{const t=a(e);return this.renderMenuLines(t)}));let d=null;return e.hasOwnProperty("post")&&Array.isArray(e.post)&&(d=e.post.map(e=>{const t=a(e);return this.renderMenuLines(t)})),r.createElement("div",{className:"game-board game-board-player-view"},l,h,u,d,c)}renderMenuLines(e){const t=e.split("\n").filter(e=>e.length>0),{width:n}=this.props;return t.map((e,t)=>{const s=o(n,`${e}`,3);return r.createElement("div",{className:"cell-row-div-player-view",key:"menu_line_"+t},r.createElement("span",{className:"game-menu-text-span",dangerouslySetInnerHTML:{__html:s}}))})}}},function(e,t){var n={html:{skipScheme:"html",lineBreakScheme:"html",whitespace:"collapse"}},s=/<\s*br(?:[\s\/]*|\s[^>]*)>/gi,r={unix:[/\n/g,"\n"],dos:[/\r\n/g,"\r\n"],mac:[/\r/g,"\r"],html:[s,"<br>"],xhtml:[s,"<br/>"]},a={"ansi-color":/\x1B\[[^m]*m/g,html:/<[^>]*>/g,bbcode:/\[[^]]*\]/g},o={soft:1,hard:1},i={collapse:1,default:1,line:1,all:1},l={all:1,multi:1,none:1},c=/([sm])(\d+)/,u=/[-\/\\^$*+?.()|[\]{}]/g;function h(e){return e.replace(u,"\\$&")}var d=e.exports=function(e,t,s){"object"==typeof e&&(e=(s=e).start,t=s.stop),"object"==typeof t&&(s=t,e=e||s.start,t=void 0),t||(t=e,e=0),s||(s={});var u,d,p,f,m,g,y,v,_,b,E,S,C,w,T,O,M,A,N="soft",P="default",x=4,I="all",D="",k="";if(u=s.preset)for(u instanceof Array||(u=[u]),A=0;A<u.length;A++){if(!(O=n[u[A]]))throw new TypeError('preset must be one of "'+Object.keys(n).join('", "')+'"');O.mode&&(N=O.mode),O.whitespace&&(P=O.whitespace),void 0!==O.tabWidth&&(x=O.tabWidth),O.skip&&(d=O.skip),O.skipScheme&&(p=O.skipScheme),O.lineBreak&&(f=O.lineBreak),O.lineBreakScheme&&(m=O.lineBreakScheme),O.respectLineBreaks&&(I=O.respectLineBreaks),void 0!==O.preservedLineIndent&&(y=O.preservedLineIndent),void 0!==O.wrapLineIndent&&(v=O.wrapLineIndent),O.wrapLineIndentBase&&(_=O.wrapLineIndentBase)}if(s.mode){if(!o[s.mode])throw new TypeError('mode must be one of "'+Object.keys(o).join('", "')+'"');N=s.mode}if(s.whitespace){if(!i[s.whitespace])throw new TypeError('whitespace must be one of "'+Object.keys(i).join('", "')+'"');P=s.whitespace}if(void 0!==s.tabWidth){if(!(parseInt(s.tabWidth,10)>=0))throw new TypeError("tabWidth must be a non-negative integer");x=parseInt(s.tabWidth,10)}if(T=new Array(x+1).join(" "),s.respectLineBreaks){if(!l[s.respectLineBreaks]&&!c.test(s.respectLineBreaks))throw new TypeError('respectLineBreaks must be one of "'+Object.keys(l).join('", "')+'", "m<num>", "s<num>"');I=s.respectLineBreaks}if("multi"===I)I="m",g=2;else if(!l[I]){var L=c.exec(I);I=L[1],g=parseInt(L[2],10)}if(void 0!==s.preservedLineIndent){if(!(parseInt(s.preservedLineIndent,10)>=0))throw new TypeError("preservedLineIndent must be a non-negative integer");y=parseInt(s.preservedLineIndent,10)}if(y>0&&(D=new Array(y+1).join(" ")),void 0!==s.wrapLineIndent){if(isNaN(parseInt(s.wrapLineIndent,10)))throw new TypeError("wrapLineIndent must be an integer");v=parseInt(s.wrapLineIndent,10)}if(s.wrapLineIndentBase&&(_=s.wrapLineIndentBase),_){if(void 0===v)throw new TypeError("wrapLineIndent must be specified when wrapLineIndentBase is specified");if(_ instanceof RegExp)w=_;else{if("string"!=typeof _)throw new TypeError("wrapLineIndentBase must be either a RegExp object or a string");w=new RegExp(h(_))}}else if(v>0)k=new Array(v+1).join(" ");else if(v<0)throw new TypeError("wrapLineIndent must be non-negative when a base is not specified");if(s.skipScheme){if(!a[s.skipScheme])throw new TypeError('skipScheme must be one of "'+Object.keys(a).join('", "')+'"');p=s.skipScheme}if(s.skip&&(d=s.skip),d)if(d instanceof RegExp)(b=d).global||(M="g",b.ignoreCase&&(M+="i"),b.multiline&&(M+="m"),b=new RegExp(b.source,M));else{if("string"!=typeof d)throw new TypeError("skip must be either a RegExp object or a string");b=new RegExp(h(d),"g")}if(!b&&p&&(b=a[p]),s.lineBreakScheme){if(!r[s.lineBreakScheme])throw new TypeError('lineBreakScheme must be one of "'+Object.keys(r).join('", "')+'"');m=s.lineBreakScheme}if(s.lineBreak&&(f=s.lineBreak),m&&(O=r[m])&&(E=O[0],S=O[1]),f)if(f instanceof Array&&(1===f.length?f=f[0]:f.length>=2&&(f[0]instanceof RegExp?(E=f[0],"string"==typeof f[1]&&(S=f[1])):f[1]instanceof RegExp?(E=f[1],"string"==typeof f[0]&&(S=f[0])):"string"==typeof f[0]&&"string"==typeof f[1]?(E=new RegExp(h(f[0]),"g"),S=f[1]):f=f[0])),"string"==typeof f)S=f,E||(E=new RegExp(h(f),"g"));else if(f instanceof RegExp)E=f;else if(!(f instanceof Array))throw new TypeError("lineBreak must be a RegExp object, a string, or an array consisted of a RegExp object and a string");E||(E=/\n/g,S="\n"),M="g",E.ignoreCase&&(M+="i"),E.multiline&&(M+="m"),C=new RegExp("\\s*(?:"+E.source+")(?:"+E.source+"|\\s)*",M),E.global||(E=new RegExp(E.source,M));var R="hard"===N?/\b/:/(\S+\s+)/,B=new Array(e+1).join(" "),G="default"===P||"collapse"===P,F="collapse"===P,W="line"===P,Y="all"===P,j=/\t/g,X=/  +/g,U=/^\s+/,$=/\s+$/,K=/\S/,V=/\s/,H=t-e;return function(n){var s;if(n=n.toString().replace(j,T),!S){if(E.lastIndex=0,!(s=E.exec(n)))throw new TypeError("Line break string for the output not specified");S=s[0]}var r,a,o,i,l,c,u,h,d,p=0;for(r=[],C.lastIndex=0,s=C.exec(n);s;){if(r.push(n.substring(p,s.index)),"none"!==I){for(o=[],i=0,E.lastIndex=0,a=E.exec(s[0]);a;)o.push(s[0].substring(i,a.index)),i=a.index+a[0].length,a=E.exec(s[0]);o.push(s[0].substring(i)),r.push({type:"break",breaks:o})}else l=F?" ":s[0].replace(E,""),r.push({type:"break",remaining:l});p=s.index+s[0].length,s=C.exec(n)}if(r.push(n.substring(p)),b)for(d=[],c=0;c<r.length;c++){var f=r[c];if("string"!=typeof f)d.push(f);else{for(p=0,b.lastIndex=0,s=b.exec(f);s;)d.push(f.substring(p,s.index)),d.push({type:"skip",value:s[0]}),p=s.index+s[0].length,s=b.exec(f);d.push(f.substring(p))}}else d=r;var m=[];for(c=0;c<d.length;c++){var y=d[c];if("string"!=typeof y)m.push(y);else{F&&(y=y.replace(X," "));var _=y.split(R),O=[];for(u=0;u<_.length;u++){var M=_[u];if("hard"===N)for(h=0;h<M.length;h+=H)O.push(M.slice(h,h+H));else O.push(M)}m=m.concat(O)}}var A,P=0,x=e+D.length,L=[B+D],q=0,J=!0,z=!0,Q=k;function Z(n){var s,r,a,o=L[P];if(Y)x>t&&(q=q||t,a=o.length-(x-q),L[P]=o.substring(0,a)),q=0;else{for(s=o.length-1;s>=e&&" "===o[s];)s--;for(;s>=e&&V.test(o[s]);)s--;++s!==o.length&&(L[P]=o.substring(0,s)),z&&J&&W&&x>t&&(a=o.length-(x-t))<s&&(a=s)}if(z&&(z=!1,w&&(s=L[P].substring(e).search(w),Q=s>=0&&s+v>0?new Array(s+v+1).join(" "):"")),a){for(;a+H<o.length;)Y?(r=o.substring(a,a+H),L.push(B+Q+r)):L.push(B+Q),a+=H,P++;if(!n)return r=o.substring(a),Q+r;Y?(r=o.substring(a),L.push(B+Q+r)):L.push(B+Q),P++}return""}for(c=0;c<m.length;c++){var ee=m[c];if(""!==ee)if("string"==typeof ee){for(var te;;){if(te=void 0,x+ee.length>t&&x+(te=ee.replace($,"")).length>t&&""!==te&&x>e){if(A=Z(!1),L.push(B+Q),P++,x=e+Q.length,A){L[P]+=A,x+=A.length,J=!0;continue}!G&&(!W||z&&J)||(ee=ee.replace(U,"")),J=!1}else J&&(G||W&&(!z||!J)?""!==(ee=ee.replace(U,""))&&(J=!1):K.test(ee)&&(J=!1));break}Y&&te&&x+te.length>t&&(q=x+te.length),L[P]+=ee,x+=ee.length}else if("break"===ee.type)if("none"!==I){var ne=ee.breaks,se=ne.length-1;if("s"===I){for(u=0;u<se;u++)ne[u+1].length<g?ne[u+1]=F?" ":ne[u]+ne[u+1]:(Y&&(L[P]+=ne[u],x+=ne[u].length),Z(!0),L.push(B+D),P++,x=e+D.length,z=J=!0);(!J||Y||W&&z)&&((F||!J&&""===ne[se])&&(ne[se]=" "),L[P]+=ne[se],x+=ne[se].length)}else if("m"===I&&se<g)(!J||Y||W&&z)&&(F?ee=" ":(ee=ne.join(""),J||""!==ee||(ee=" ")),L[P]+=ee,x+=ee.length);else if(G){for(Z(!0),u=0;u<se;u++)L.push(B+D),P++;x=e+D.length,z=J=!0}else for((Y||z&&J)&&(L[P]+=ne[0],x+=ne[0].length),u=0;u<se;u++)Z(!0),L.push(B+D+ne[u+1]),P++,x=e+D.length+ne[u+1].length,z=J=!0}else(!J||Y||W&&z)&&(ee=ee.remaining,(F||!J&&""===ee)&&(ee=" "),L[P]+=ee,x+=ee.length);else"skip"===ee.type&&(x>t&&(A=Z(!1),L.push(B+Q),P++,x=e+Q.length,A&&(L[P]+=A,x+=A.length),J=!0),L[P]+=ee.value)}return Z(!0),L.join(S)}};d.soft=d,d.hard=function(){var e=[].slice.call(arguments),t=e.length-1;return"object"==typeof e[t]?e[t].mode="hard":e.push({mode:"hard"}),d.apply(null,e)},d.wrap=function(e){var t=[].slice.call(arguments);return t.shift(),d.apply(null,t)(e)}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(1)),o=r(n(80)),i=r(n(132)),l=n(15),c=r(n(8)),u=n(107),h=r(n(62)),d=n(133),p=n(28),[f,m]=[10,10],g="game-board-player-view",y="cell-row-div-player-view";t.default=class extends a.Component{constructor(e){super(e),this.handleKeyDown=this.handleKeyDown.bind(this),this.toggleScreen=this.toggleScreen.bind(this),this.state={tabShown:"Region"}}shouldComponentUpdate(e,t){if(e.ow!==this.props.ow)return!0;if(this.props.playerOwPos&&e.playerOwPos){if(e.playerOwPos[0]!==this.props.playerOwPos[0])return!0;if(e.playerOwPos[1]!==this.props.playerOwPos[1])return!0}return this.state.tabShown!==t.tabShown}selectTab(e){this.setState({tabShown:e})}handleKeyDown(e){d.KeyCode.getKeyCode(e)===p.Keys.GUI.OwMap&&this.toggleScreen("OWMap")}render(){const e=this.renderTabButtons(),t=this.renderTabElement();return a.createElement(h.default,{"aria-labelledby":"game-overworld-map-modal-label",id:"gameOverWorldMapModal",large:!0,onHide:this.toggleScreen.bind(this,"OWMap"),onKeyDown:this.handleKeyDown,show:this.props.showOWMap},a.createElement(o.default,{id:"game-overworld-map-modal-label",text:"Overworld"}),a.createElement("div",{className:"modal-body row"},a.createElement("div",{className:"col-md-8"},e,t)),a.createElement("div",{className:"modal-footer row"},a.createElement("div",{className:"col-md-4"},a.createElement("button",{className:"btn btn-secondary",onClick:this.toggleScreen.bind(this,"OWMap"),type:"button"},"Close"))))}toggleScreen(e){this.props.toggleScreen(e)}renderTabElement(){return this.props.ow?"World"===this.state.tabShown?this.renderWorldMap():this.renderRegionMap():null}renderWorldMap(){let e="No map generated.";const t=this.props.ow.mapToString(!0).slice();if(this.props.playerOwPos){const[e,n]=this.props.playerOwPos;let s=t[n];s=s.substr(0,e)+"@"+s.substr(e+1),t[n]=s}return e=t.join("\n"),a.createElement("div",null,a.createElement("pre",{className:"game-overworld-map-pre"},e),a.createElement("p",null,"This map helps you to navigate in the world. It shows places of interest as well as the huge mountain walls blocking your passage."))}renderRegionMap(){const e=this.props.ow,t=e.getCellList();let[n,s]=[null,null];if(this.props.playerOwPos){[n,s]=this.props.playerOwPos;const e=new l.ElementMarker("@");t.getCell(n,s).removeProps(c.default.TYPE_ELEM),t.getCell(n,s).setProp(c.default.TYPE_ELEM,e)}t.getCells(t=>{e.isExplored(t.getXY())&&t.setExplored()});const r=new u.Screen(f,m);r.renderAllVisible(n,s,t);const o=r.getCharRows(),h=r.getClassRows(),d=r.getStartX();return a.createElement(i.default,{boardClassName:g,charRows:o,classRows:h,endY:r.endY,onCellClick:this.onCellClick,onMouseOverCell:this.onMouseOverCell,rowClass:y,sizeX:2*r.viewportX+1,startX:d,startY:r.startY,useRLE:!1})}onCellClick(e,t){console.log(`Clicked cell ${e},${t}`)}onMouseOverCell(e,t){console.log(`Mouse over cell ${e},${t}`)}renderTabButtons(){const e=a.createElement("ul",{className:"modal-tab-list"},a.createElement("button",{className:"tab-select-button",onClick:this.selectTab.bind(this,"Region")},"Region"),a.createElement("button",{className:"tab-select-button",onClick:this.selectTab.bind(this,"World")},"World"));return a.createElement("ul",null,e)}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1));t.default=class extends r.Component{shouldComponentUpdate(e){if(this.props.rowClass!==e.rowClass)return!0;const t=this.props.rowClasses.length,n=this.props.rowChars.length;if(t===e.rowClasses.length){if(n===e.rowChars.length)if(this.props.useRLE){for(let n=0;n<t;n++){if(this.props.rowClasses[n][0]!==e.rowClasses[n][0])return!0;if(this.props.rowClasses[n][1]!==e.rowClasses[n][1])return!0}for(let t=0;t<n;t++){if(this.props.rowChars[t][0]!==e.rowChars[t][0])return!0;if(this.props.rowChars[t][1]!==e.rowChars[t][1])return!0}}else{for(let n=0;n<t;n++)if(this.props.rowClasses[n]!==e.rowClasses[n])return!0;for(let t=0;t<n;t++)if(this.props.rowChars[t]!==e.rowChars[t])return!0}return!1}return!0}render(){const e=this.props.y,t=this.props.rowClass;let n=null;return n=this.props.useRLE?this.props.rowClasses.map((t,n)=>{const s=this.props.rowChars[n],a=parseInt(s[0],10);return r.createElement("span",{className:t[1],key:e+","+n},s[1].repeat(a))}):this.props.rowClasses.map((t,n)=>{const s=this.props.rowChars[n];return r.createElement("span",{className:t,key:e+","+n},s)}),r.createElement("div",{className:"game-board-row "+t},n)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Viewport=class{constructor(e,t){this.viewportX=e,this.viewportY=t}setViewportXY(e,t){this.viewportX=e,this.viewportY=t}initCellsInViewPort(e,t,n){let s=e-this.viewportX,r=e+this.viewportX,a=t-this.viewportY,o=t+this.viewportY;const i=n.cols-1,l=n.rows-1,c=this.viewportX-e;if(c>0)r+=c;else{const t=e+this.viewportX-i;t>0&&(s-=t)}const u=this.viewportY-t;if(u>0)o+=u;else{const e=t+this.viewportY-l;e>0&&(a-=e)}s<0&&(s=0),a<0&&(a=0),r>n.cols-1&&(r=n.cols-1),o>n.rows-1&&(o=n.rows-1),this.coord={};for(let e=a;e<=o;e++){this.coord[e]=[];for(let t=s;t<=r;t++)this.coord[e].push(n.getCell(t,e))}this.startX=s,this.endX=r,this.startY=a,this.endY=o,this.rows=n.rows}getCellRow(e){return this.coord[e]}debugPrint(){const[e,t]=[this.startY,this.endY];for(let n=e;n<=t;n++){const e=this.coord[n];console.log(e.join(""))}}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(1)),o=r(n(80)),i=r(n(8)),l=r(n(62)),c=n(313);t.TextHelp=(({char:e,descr:t})=>a.createElement("p",null,a.createElement("span",{className:"text-primary"},e),"- "+t));t.default=class extends a.Component{shouldComponentUpdate(){return!1}render(){return a.createElement(l.default,{"aria-labelledby":"game-help-modal-label",id:"gameHelpModal",large:!0,onHide:this.toggleScreen.bind(this,"HelpScreen"),show:this.props.showHelpScreen},a.createElement(o.default,{id:"game-help-modal-label",text:i.default.gameTitle+"Help"}),a.createElement("div",{className:"modal-body"},a.createElement("div",{className:"row"},a.createElement("div",{className:"col-md-12"},a.createElement("div",{dangerouslySetInnerHTML:{__html:c.Manual.fullText},id:"manual-text"})))),a.createElement("div",{className:"modal-footer row"},a.createElement("div",{className:"col-md-6"},a.createElement("button",{className:"btn btn-secondary",onClick:this.toggleScreen.bind(this,"HelpScreen"),type:"button"},"Close"))))}toggleScreen(e){this.props.toggleScreen(e)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(28),r=n(314),{GUI:a,KEY:o,getChar:i}=s.Keys;t.Manual={};const l=`\nBattles manual\n==============\n\nThis is a short manual accompanying Battles game. It should get you started with\ncontrols and basic commands of the game.\n\nAt the moment, you need both mouse and keyboard to play the game. While all the\nASCII-based menus are clickable by mouse, you need keyboard to open some of the\nmenus. Also, the Inventory menu cannot be used with keyboard at the moment.\nThese limitations will be addressed in the future versions of the game.\n\nAbout the Game\n--------------\n\nBattles is an RPG/roguelike-game in a northern setting. You control a single\nactor and interact with NPCs in the world. The game consists of an overworld\nand numerous smaller zones (dungeons, mountains, crypts, fortresses, caves),\nwhich are scattered around the overworld. There are also settlements such as\nvillages and cities, which are less hostile than previously mentioned\nzones.\n\nMouse controls\n--------------\n\nYou can move to an explored cell (not necessarily visible) by left-clicking that\ncell. If an enemy is seen before that cell is reached, the movement will stop.\n\nRight-clicking a cell will bring up a context menu, from which you can choose an\navailable action.\n\nKey controls\n------------\n\n${`\nTable below shows keyboard controls:\n\n| key                       | Command description                               |\n| ------                    | ------------------------------------------        |\n| ,                         | Pick up an item.                                  |\n| < or >                    | Use stairs/passage.                               |\n| ${i(o.CHAT)}      | Chat with another actor.                          |\n| ${i(a.Help)}      | Show/hide help.                                   |\n| ${i(a.OwMap)}     | Show overworld map.                               |\n| ${i(o.ORDER)}     | [Give an order to another actor.](#giving-orders) |\n| ${i(o.FIGHT)}     | Change fight mode.                                |\n| ${i(o.JUMP)}      | Jump to given a direction.                        |\n| ${i(o.NEXT_ITEM)} | See next item in the cell.                        |\n| ${i(a.Inv)}       | Show inventory.                                   |\n| ${i(a.Look)}      | Look around.                                      |\n| ${i(a.Map)}       | Toggle the map or player view.                    |\n| ${i(o.MARK)}      | Add a location marker for quick travel.           |\n| ${i(o.GOTO)}      | Open a location list for quick travel.            |\n| ${i(o.NEXT)}      | Next target (target-look).                        |\n| ${i(o.DOOR)}      | Open or close door.                               |\n| ${i(o.POWER)}     | [Use your powers.](#casting-spells)               |\n| ${i(o.READ)}      | Read something from the current cell.             |\n| ${i(o.RUN)}       | Toggle run mode (1.5 x speed).                    |\n| ${i(o.REST)}      | Rest (takes less energy than moving).             |\n| ${i(o.TARGET)}    | [Target/fire](#firing-missiles)                   |\n| ${i(a.Use)}       | [Use an item.](#using-items)                      |\n| ${i(o.ABILITY)}   | [Use an ability.](#abilities)                     |\n`}\n\nAlternatively, you can use the numpad keys to move.\n\nMovement\n--------\n\n\n<p>To move around, use:</p>\n<table className='table table-large mov-buttons-table'>\n  <thead />\n  <tbody>\n    <tr>\n      <td>⬉ q</td>\n      <td>⬆ w</td>\n      <td>⬈ e</td>\n    </tr>\n    <tr>\n      <td>⬅ a</td>\n      <td>Rest: s</td>\n      <td>➡ d</td>\n    </tr>\n    <tr>\n      <td>⬋ z</td>\n      <td>⬇ x</td>\n      <td>⬊ c</td>\n    </tr>\n  </tbody>\n</table>\n\n\nAttacking\n---------\n\nAttacking other actors using melee attacks can be done by bumping into adjacent\nactors. If the actor is not hostile, the game will ask you to confirm the\naction.\n\nAn exception is melee attack with range of 2 or more. Currently, these must be\nperformed by right-clicking the target with mouse and choosing attack. For example,\na whip can be used to attack enemies within range of two.\n\nFiring missiles\n---------------\n\nFirst, you need to have a missile or ammo + missile weapon equipped. Then, press\n${i(o.TARGET)} to select a target. You can switch between targets using\nnext key ${i(o.NEXT)} or previous key ${i(o.PREV)}. If the\ntarget\nis red, it is out of range. If it's yellow, then press ${i(o.TARGET)}\nagain to fire.\n\nCasting spells\n---------------\n\nPress ${i(o.POWER)} to view a list of spells. Press corresponding key to\ncast that spell or any other key to quit. Some spells require giving a direction\nor choosing an adjacent cell.\n\nUsing items\n-----------\n\nThere are 2 ways to use items:\n\n  1. When you enter inventory, you can use the items on yourself only.\n  2. If you want to use item on something else, you can do the following:\n    * Open inventory and select an item.\n    * Close inventory and press ${i(s.Keys.GUI.Use)}.\n    * Select direction for using.\n\nAbilities\n---------\n\nAbilities do not consume any power points.\n\nIf the actor has any abilities, they can be activated using ${i(o.ABILITY)}.\nPressing the key will open an ability menu from which an ability can be chosen.\nDepending on the ability, further input such as direction to use the ability, may\nbe requested.\n\nGiving orders\n-------------\n\nIn some situations, it is possible to give commands to other actors. Use\n${i(o.ORDER)} to give an order. The game will ask you to select a\ntarget. You can used the [Movement keys](#movement) to select a target by\npressing ${i(o.SELECT)} over desired target,\nor press ${i(o.SELECT_ALL)} to choose all valid targets.\n\nAfter the selection, you will get a list of possible commands. Choose one\nwith the keyboard or using the mouse.\n\nUsing marks for movement\n------------------------\n\nTo reduce the amount of backtracking in large levels, the game will automatically mark the\nenter/exit locations for each level. To place a mark to any other location, you can press\n${i(o.MARK)}. This mark will be added to the mark list of the current level.\n\nBy pressing ${i(o.GOTO)}, you can open a mark list for the current level you are in.\nBy selecting one of the marks from the list, the actor tries to navigate to that location. If\nany hostile actors or dangers are encountered, the navigation is immediately stopped. At the\nmoment you have to open the mark list again and choose a location.\n\nReading books\n-------------\n\nBooks can be read by pressing ${i(o.READ)} while there is something to read in\nthe same cell as the player. If they are in inventory, they can be read by using the\nbooks.\n\nGame settings\n-------------\n\nTODO\n\nImporting plugins\n-----------------\n\nTODO\n\n`;t.Manual.fullText=r(l)},function(e,t,n){(function(t){!function(t){"use strict";var n={newline:/^\n+/,code:/^( {4}[^\n]+\n*)+/,fences:m,hr:/^ {0,3}((?:- *){3,}|(?:_ *){3,}|(?:\* *){3,})(?:\n+|$)/,heading:/^ *(#{1,6}) *([^\n]+?) *#* *(?:\n+|$)/,nptable:m,blockquote:/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/,list:/^( *)(bull) [\s\S]+?(?:hr|def|\n{2,}(?! )(?!\1bull )\n*|\s*$)/,html:/^ *(?:comment *(?:\n|\s*$)|closed *(?:\n{2,}|\s*$)|closing *(?:\n{2,}|\s*$))/,def:/^ {0,3}\[(label)\]: *\n? *<?([^\s>]+)>?(?:(?: +\n? *| *\n *)(title))? *(?:\n+|$)/,table:m,lheading:/^([^\n]+)\n *(=|-){2,} *(?:\n+|$)/,paragraph:/^([^\n]+(?:\n?(?!hr|heading|lheading| {0,3}>|tag)[^\n]+)+)/,text:/^[^\n]+/};function s(e){this.tokens=[],this.tokens.links={},this.options=e||y.defaults,this.rules=n.normal,this.options.gfm&&(this.options.tables?this.rules=n.tables:this.rules=n.gfm)}n._label=/(?:\\[\[\]]|[^\[\]])+/,n._title=/(?:"(?:\\"|[^"]|"[^"\n]*")*"|'\n?(?:[^'\n]+\n?)*'|\([^()]*\))/,n.def=h(n.def).replace("label",n._label).replace("title",n._title).getRegex(),n.bullet=/(?:[*+-]|\d+\.)/,n.item=/^( *)(bull) [^\n]*(?:\n(?!\1bull )[^\n]*)*/,n.item=h(n.item,"gm").replace(/bull/g,n.bullet).getRegex(),n.list=h(n.list).replace(/bull/g,n.bullet).replace("hr","\\n+(?=\\1?(?:(?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$))").replace("def","\\n+(?="+n.def.source+")").getRegex(),n._tag="(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b",n.html=h(n.html).replace("comment",/<!--[\s\S]*?-->/).replace("closed",/<(tag)[\s\S]+?<\/\1>/).replace("closing",/<tag(?:"[^"]*"|'[^']*'|\s[^'"\/>\s]*)*?\/?>/).replace(/tag/g,n._tag).getRegex(),n.paragraph=h(n.paragraph).replace("hr",n.hr).replace("heading",n.heading).replace("lheading",n.lheading).replace("tag","<"+n._tag).getRegex(),n.blockquote=h(n.blockquote).replace("paragraph",n.paragraph).getRegex(),n.normal=g({},n),n.gfm=g({},n.normal,{fences:/^ *(`{3,}|~{3,})[ \.]*(\S+)? *\n([\s\S]*?)\n? *\1 *(?:\n+|$)/,paragraph:/^/,heading:/^ *(#{1,6}) +([^\n]+?) *#* *(?:\n+|$)/}),n.gfm.paragraph=h(n.paragraph).replace("(?!","(?!"+n.gfm.fences.source.replace("\\1","\\2")+"|"+n.list.source.replace("\\1","\\3")+"|").getRegex(),n.tables=g({},n.gfm,{nptable:/^ *(\S.*\|.*)\n *([-:]+ *\|[-| :]*)\n((?:.*\|.*(?:\n|$))*)\n*/,table:/^ *\|(.+)\n *\|( *[-:]+[-| :]*)\n((?: *\|.*(?:\n|$))*)\n*/}),s.rules=n,s.lex=function(e,t){return new s(t).lex(e)},s.prototype.lex=function(e){return e=e.replace(/\r\n|\r/g,"\n").replace(/\t/g,"    ").replace(/\u00a0/g," ").replace(/\u2424/g,"\n"),this.token(e,!0)},s.prototype.token=function(e,t){var s,r,a,o,i,l,c,u,h,d,p;for(e=e.replace(/^ +$/gm,"");e;)if((a=this.rules.newline.exec(e))&&(e=e.substring(a[0].length),a[0].length>1&&this.tokens.push({type:"space"})),a=this.rules.code.exec(e))e=e.substring(a[0].length),a=a[0].replace(/^ {4}/gm,""),this.tokens.push({type:"code",text:this.options.pedantic?a:a.replace(/\n+$/,"")});else if(a=this.rules.fences.exec(e))e=e.substring(a[0].length),this.tokens.push({type:"code",lang:a[2],text:a[3]||""});else if(a=this.rules.heading.exec(e))e=e.substring(a[0].length),this.tokens.push({type:"heading",depth:a[1].length,text:a[2]});else if(t&&(a=this.rules.nptable.exec(e))){for(e=e.substring(a[0].length),l={type:"table",header:a[1].replace(/^ *| *\| *$/g,"").split(/ *\| */),align:a[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:a[3].replace(/\n$/,"").split("\n")},u=0;u<l.align.length;u++)/^ *-+: *$/.test(l.align[u])?l.align[u]="right":/^ *:-+: *$/.test(l.align[u])?l.align[u]="center":/^ *:-+ *$/.test(l.align[u])?l.align[u]="left":l.align[u]=null;for(u=0;u<l.cells.length;u++)l.cells[u]=l.cells[u].split(/ *\| */);this.tokens.push(l)}else if(a=this.rules.hr.exec(e))e=e.substring(a[0].length),this.tokens.push({type:"hr"});else if(a=this.rules.blockquote.exec(e))e=e.substring(a[0].length),this.tokens.push({type:"blockquote_start"}),a=a[0].replace(/^ *> ?/gm,""),this.token(a,t),this.tokens.push({type:"blockquote_end"});else if(a=this.rules.list.exec(e)){for(e=e.substring(a[0].length),p=(o=a[2]).length>1,this.tokens.push({type:"list_start",ordered:p,start:p?+o:""}),s=!1,d=(a=a[0].match(this.rules.item)).length,u=0;u<d;u++)c=(l=a[u]).length,~(l=l.replace(/^ *([*+-]|\d+\.) +/,"")).indexOf("\n ")&&(c-=l.length,l=this.options.pedantic?l.replace(/^ {1,4}/gm,""):l.replace(new RegExp("^ {1,"+c+"}","gm"),"")),this.options.smartLists&&u!==d-1&&(o===(i=n.bullet.exec(a[u+1])[0])||o.length>1&&i.length>1||(e=a.slice(u+1).join("\n")+e,u=d-1)),r=s||/\n\n(?!\s*$)/.test(l),u!==d-1&&(s="\n"===l.charAt(l.length-1),r||(r=s)),this.tokens.push({type:r?"loose_item_start":"list_item_start"}),this.token(l,!1),this.tokens.push({type:"list_item_end"});this.tokens.push({type:"list_end"})}else if(a=this.rules.html.exec(e))e=e.substring(a[0].length),this.tokens.push({type:this.options.sanitize?"paragraph":"html",pre:!this.options.sanitizer&&("pre"===a[1]||"script"===a[1]||"style"===a[1]),text:a[0]});else if(t&&(a=this.rules.def.exec(e)))e=e.substring(a[0].length),a[3]&&(a[3]=a[3].substring(1,a[3].length-1)),h=a[1].toLowerCase(),this.tokens.links[h]||(this.tokens.links[h]={href:a[2],title:a[3]});else if(t&&(a=this.rules.table.exec(e))){for(e=e.substring(a[0].length),l={type:"table",header:a[1].replace(/^ *| *\| *$/g,"").split(/ *\| */),align:a[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:a[3].replace(/(?: *\| *)?\n$/,"").split("\n")},u=0;u<l.align.length;u++)/^ *-+: *$/.test(l.align[u])?l.align[u]="right":/^ *:-+: *$/.test(l.align[u])?l.align[u]="center":/^ *:-+ *$/.test(l.align[u])?l.align[u]="left":l.align[u]=null;for(u=0;u<l.cells.length;u++)l.cells[u]=l.cells[u].replace(/^ *\| *| *\| *$/g,"").split(/ *\| */);this.tokens.push(l)}else if(a=this.rules.lheading.exec(e))e=e.substring(a[0].length),this.tokens.push({type:"heading",depth:"="===a[2]?1:2,text:a[1]});else if(t&&(a=this.rules.paragraph.exec(e)))e=e.substring(a[0].length),this.tokens.push({type:"paragraph",text:"\n"===a[1].charAt(a[1].length-1)?a[1].slice(0,-1):a[1]});else if(a=this.rules.text.exec(e))e=e.substring(a[0].length),this.tokens.push({type:"text",text:a[0]});else if(e)throw new Error("Infinite loop on byte: "+e.charCodeAt(0));return this.tokens};var r={escape:/^\\([\\`*{}\[\]()#+\-.!_>])/,autolink:/^<(scheme:[^\s\x00-\x1f<>]*|email)>/,url:m,tag:/^<!--[\s\S]*?-->|^<\/?[a-zA-Z0-9\-]+(?:"[^"]*"|'[^']*'|\s[^<'">\/\s]*)*?\/?>/,link:/^!?\[(inside)\]\(href\)/,reflink:/^!?\[(inside)\]\s*\[([^\]]*)\]/,nolink:/^!?\[((?:\[[^\[\]]*\]|\\[\[\]]|[^\[\]])*)\]/,strong:/^__([\s\S]+?)__(?!_)|^\*\*([\s\S]+?)\*\*(?!\*)/,em:/^_([^\s_](?:[^_]|__)+?[^\s_])_\b|^\*((?:\*\*|[^*])+?)\*(?!\*)/,code:/^(`+)\s*([\s\S]*?[^`]?)\s*\1(?!`)/,br:/^ {2,}\n(?!\s*$)/,del:m,text:/^[\s\S]+?(?=[\\<!\[`*]|\b_| {2,}\n|$)/};function a(e,t){if(this.options=t||y.defaults,this.links=e,this.rules=r.normal,this.renderer=this.options.renderer||new o,this.renderer.options=this.options,!this.links)throw new Error("Tokens array requires a `links` property.");this.options.gfm?this.options.breaks?this.rules=r.breaks:this.rules=r.gfm:this.options.pedantic&&(this.rules=r.pedantic)}function o(e){this.options=e||{}}function i(){}function l(e){this.tokens=[],this.token=null,this.options=e||y.defaults,this.options.renderer=this.options.renderer||new o,this.renderer=this.options.renderer,this.renderer.options=this.options}function c(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function u(e){return e.replace(/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/gi,function(e,t){return"colon"===(t=t.toLowerCase())?":":"#"===t.charAt(0)?"x"===t.charAt(1)?String.fromCharCode(parseInt(t.substring(2),16)):String.fromCharCode(+t.substring(1)):""})}function h(e,t){return e=e.source,t=t||"",{replace:function(t,n){return n=(n=n.source||n).replace(/(^|[^\[])\^/g,"$1"),e=e.replace(t,n),this},getRegex:function(){return new RegExp(e,t)}}}function d(e,t){return p[" "+e]||(/^[^:]+:\/*[^\/]*$/.test(e)?p[" "+e]=e+"/":p[" "+e]=e.replace(/[^\/]*$/,"")),e=p[" "+e],"//"===t.slice(0,2)?e.replace(/:[\s\S]*/,":")+t:"/"===t.charAt(0)?e.replace(/(:\/*[^\/]*)[\s\S]*/,"$1")+t:e+t}r._scheme=/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/,r._email=/[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/,r.autolink=h(r.autolink).replace("scheme",r._scheme).replace("email",r._email).getRegex(),r._inside=/(?:\[[^\[\]]*\]|\\[\[\]]|[^\[\]]|\](?=[^\[]*\]))*/,r._href=/\s*<?([\s\S]*?)>?(?:\s+['"]([\s\S]*?)['"])?\s*/,r.link=h(r.link).replace("inside",r._inside).replace("href",r._href).getRegex(),r.reflink=h(r.reflink).replace("inside",r._inside).getRegex(),r.normal=g({},r),r.pedantic=g({},r.normal,{strong:/^__(?=\S)([\s\S]*?\S)__(?!_)|^\*\*(?=\S)([\s\S]*?\S)\*\*(?!\*)/,em:/^_(?=\S)([\s\S]*?\S)_(?!_)|^\*(?=\S)([\s\S]*?\S)\*(?!\*)/}),r.gfm=g({},r.normal,{escape:h(r.escape).replace("])","~|])").getRegex(),url:h(/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/).replace("email",r._email).getRegex(),_backpedal:/(?:[^?!.,:;*_~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_~)]+(?!$))+/,del:/^~~(?=\S)([\s\S]*?\S)~~/,text:h(r.text).replace("]|","~]|").replace("|","|https?://|ftp://|www\\.|[a-zA-Z0-9.!#$%&'*+/=?^_`{\\|}~-]+@|").getRegex()}),r.breaks=g({},r.gfm,{br:h(r.br).replace("{2,}","*").getRegex(),text:h(r.gfm.text).replace("{2,}","*").getRegex()}),a.rules=r,a.output=function(e,t,n){return new a(t,n).output(e)},a.prototype.output=function(e){for(var t,n,s,r,a="";e;)if(r=this.rules.escape.exec(e))e=e.substring(r[0].length),a+=r[1];else if(r=this.rules.autolink.exec(e))e=e.substring(r[0].length),s="@"===r[2]?"mailto:"+(n=c(this.mangle(r[1]))):n=c(r[1]),a+=this.renderer.link(s,null,n);else if(this.inLink||!(r=this.rules.url.exec(e))){if(r=this.rules.tag.exec(e))!this.inLink&&/^<a /i.test(r[0])?this.inLink=!0:this.inLink&&/^<\/a>/i.test(r[0])&&(this.inLink=!1),e=e.substring(r[0].length),a+=this.options.sanitize?this.options.sanitizer?this.options.sanitizer(r[0]):c(r[0]):r[0];else if(r=this.rules.link.exec(e))e=e.substring(r[0].length),this.inLink=!0,a+=this.outputLink(r,{href:r[2],title:r[3]}),this.inLink=!1;else if((r=this.rules.reflink.exec(e))||(r=this.rules.nolink.exec(e))){if(e=e.substring(r[0].length),t=(r[2]||r[1]).replace(/\s+/g," "),!(t=this.links[t.toLowerCase()])||!t.href){a+=r[0].charAt(0),e=r[0].substring(1)+e;continue}this.inLink=!0,a+=this.outputLink(r,t),this.inLink=!1}else if(r=this.rules.strong.exec(e))e=e.substring(r[0].length),a+=this.renderer.strong(this.output(r[2]||r[1]));else if(r=this.rules.em.exec(e))e=e.substring(r[0].length),a+=this.renderer.em(this.output(r[2]||r[1]));else if(r=this.rules.code.exec(e))e=e.substring(r[0].length),a+=this.renderer.codespan(c(r[2].trim(),!0));else if(r=this.rules.br.exec(e))e=e.substring(r[0].length),a+=this.renderer.br();else if(r=this.rules.del.exec(e))e=e.substring(r[0].length),a+=this.renderer.del(this.output(r[1]));else if(r=this.rules.text.exec(e))e=e.substring(r[0].length),a+=this.renderer.text(c(this.smartypants(r[0])));else if(e)throw new Error("Infinite loop on byte: "+e.charCodeAt(0))}else r[0]=this.rules._backpedal.exec(r[0])[0],e=e.substring(r[0].length),"@"===r[2]?s="mailto:"+(n=c(r[0])):(n=c(r[0]),s="www."===r[1]?"http://"+n:n),a+=this.renderer.link(s,null,n);return a},a.prototype.outputLink=function(e,t){var n=c(t.href),s=t.title?c(t.title):null;return"!"!==e[0].charAt(0)?this.renderer.link(n,s,this.output(e[1])):this.renderer.image(n,s,c(e[1]))},a.prototype.smartypants=function(e){return this.options.smartypants?e.replace(/---/g,"—").replace(/--/g,"–").replace(/(^|[-\u2014\/(\[{"\s])'/g,"$1‘").replace(/'/g,"’").replace(/(^|[-\u2014\/(\[{\u2018\s])"/g,"$1“").replace(/"/g,"”").replace(/\.{3}/g,"…"):e},a.prototype.mangle=function(e){if(!this.options.mangle)return e;for(var t,n="",s=e.length,r=0;r<s;r++)t=e.charCodeAt(r),Math.random()>.5&&(t="x"+t.toString(16)),n+="&#"+t+";";return n},o.prototype.code=function(e,t,n){if(this.options.highlight){var s=this.options.highlight(e,t);null!=s&&s!==e&&(n=!0,e=s)}return t?'<pre><code class="'+this.options.langPrefix+c(t,!0)+'">'+(n?e:c(e,!0))+"\n</code></pre>\n":"<pre><code>"+(n?e:c(e,!0))+"\n</code></pre>"},o.prototype.blockquote=function(e){return"<blockquote>\n"+e+"</blockquote>\n"},o.prototype.html=function(e){return e},o.prototype.heading=function(e,t,n){return"<h"+t+' id="'+this.options.headerPrefix+n.toLowerCase().replace(/[^\w]+/g,"-")+'">'+e+"</h"+t+">\n"},o.prototype.hr=function(){return this.options.xhtml?"<hr/>\n":"<hr>\n"},o.prototype.list=function(e,t,n){var s=t?"ol":"ul";return"<"+s+(t&&1!==n?' start="'+n+'"':"")+">\n"+e+"</"+s+">\n"},o.prototype.listitem=function(e){return"<li>"+e+"</li>\n"},o.prototype.paragraph=function(e){return"<p>"+e+"</p>\n"},o.prototype.table=function(e,t){return"<table>\n<thead>\n"+e+"</thead>\n<tbody>\n"+t+"</tbody>\n</table>\n"},o.prototype.tablerow=function(e){return"<tr>\n"+e+"</tr>\n"},o.prototype.tablecell=function(e,t){var n=t.header?"th":"td";return(t.align?"<"+n+' style="text-align:'+t.align+'">':"<"+n+">")+e+"</"+n+">\n"},o.prototype.strong=function(e){return"<strong>"+e+"</strong>"},o.prototype.em=function(e){return"<em>"+e+"</em>"},o.prototype.codespan=function(e){return"<code>"+e+"</code>"},o.prototype.br=function(){return this.options.xhtml?"<br/>":"<br>"},o.prototype.del=function(e){return"<del>"+e+"</del>"},o.prototype.link=function(e,t,n){if(this.options.sanitize){try{var s=decodeURIComponent(u(e)).replace(/[^\w:]/g,"").toLowerCase()}catch(e){return n}if(0===s.indexOf("javascript:")||0===s.indexOf("vbscript:")||0===s.indexOf("data:"))return n}this.options.baseUrl&&!f.test(e)&&(e=d(this.options.baseUrl,e));var r='<a href="'+e+'"';return t&&(r+=' title="'+t+'"'),r+=">"+n+"</a>"},o.prototype.image=function(e,t,n){this.options.baseUrl&&!f.test(e)&&(e=d(this.options.baseUrl,e));var s='<img src="'+e+'" alt="'+n+'"';return t&&(s+=' title="'+t+'"'),s+=this.options.xhtml?"/>":">"},o.prototype.text=function(e){return e},i.prototype.strong=i.prototype.em=i.prototype.codespan=i.prototype.del=i.prototype.text=function(e){return e},i.prototype.link=i.prototype.image=function(e,t,n){return""+n},i.prototype.br=function(){return""},l.parse=function(e,t){return new l(t).parse(e)},l.prototype.parse=function(e){this.inline=new a(e.links,this.options),this.inlineText=new a(e.links,g({},this.options,{renderer:new i})),this.tokens=e.reverse();for(var t="";this.next();)t+=this.tok();return t},l.prototype.next=function(){return this.token=this.tokens.pop()},l.prototype.peek=function(){return this.tokens[this.tokens.length-1]||0},l.prototype.parseText=function(){for(var e=this.token.text;"text"===this.peek().type;)e+="\n"+this.next().text;return this.inline.output(e)},l.prototype.tok=function(){switch(this.token.type){case"space":return"";case"hr":return this.renderer.hr();case"heading":return this.renderer.heading(this.inline.output(this.token.text),this.token.depth,u(this.inlineText.output(this.token.text)));case"code":return this.renderer.code(this.token.text,this.token.lang,this.token.escaped);case"table":var e,t,n,s,r="",a="";for(n="",e=0;e<this.token.header.length;e++)n+=this.renderer.tablecell(this.inline.output(this.token.header[e]),{header:!0,align:this.token.align[e]});for(r+=this.renderer.tablerow(n),e=0;e<this.token.cells.length;e++){for(t=this.token.cells[e],n="",s=0;s<t.length;s++)n+=this.renderer.tablecell(this.inline.output(t[s]),{header:!1,align:this.token.align[s]});a+=this.renderer.tablerow(n)}return this.renderer.table(r,a);case"blockquote_start":for(a="";"blockquote_end"!==this.next().type;)a+=this.tok();return this.renderer.blockquote(a);case"list_start":a="";for(var o=this.token.ordered,i=this.token.start;"list_end"!==this.next().type;)a+=this.tok();return this.renderer.list(a,o,i);case"list_item_start":for(a="";"list_item_end"!==this.next().type;)a+="text"===this.token.type?this.parseText():this.tok();return this.renderer.listitem(a);case"loose_item_start":for(a="";"list_item_end"!==this.next().type;)a+=this.tok();return this.renderer.listitem(a);case"html":var l=this.token.pre||this.options.pedantic?this.token.text:this.inline.output(this.token.text);return this.renderer.html(l);case"paragraph":return this.renderer.paragraph(this.inline.output(this.token.text));case"text":return this.renderer.paragraph(this.parseText())}};var p={},f=/^$|^[a-z][a-z0-9+.-]*:|^[?#]/i;function m(){}function g(e){for(var t,n,s=1;s<arguments.length;s++)for(n in t=arguments[s])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}function y(e,t,n){if(null==e)throw new Error("marked(): input parameter is undefined or null");if("string"!=typeof e)throw new Error("marked(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected");if(n||"function"==typeof t){n||(n=t,t=null);var r,a,o=(t=g({},y.defaults,t||{})).highlight,i=0;try{r=s.lex(e,t)}catch(e){return n(e)}a=r.length;var u=function(e){if(e)return t.highlight=o,n(e);var s;try{s=l.parse(r,t)}catch(t){e=t}return t.highlight=o,e?n(e):n(null,s)};if(!o||o.length<3)return u();if(delete t.highlight,!a)return u();for(;i<r.length;i++)!function(e){"code"!==e.type?--a||u():o(e.text,e.lang,function(t,n){return t?u(t):null==n||n===e.text?--a||u():(e.text=n,e.escaped=!0,void(--a||u()))})}(r[i])}else try{return t&&(t=g({},y.defaults,t)),l.parse(s.lex(e,t),t)}catch(e){if(e.message+="\nPlease report this to https://github.com/markedjs/marked.",(t||y.defaults).silent)return"<p>An error occurred:</p><pre>"+c(e.message+"",!0)+"</pre>";throw e}}m.exec=m,y.options=y.setOptions=function(e){return g(y.defaults,e),y},y.defaults={gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!1,sanitizer:null,mangle:!0,smartLists:!1,silent:!1,highlight:null,langPrefix:"lang-",smartypants:!1,headerPrefix:"",renderer:new o,xhtml:!1,baseUrl:null},y.Parser=l,y.parser=l.parse,y.Renderer=o,y.TextRenderer=i,y.Lexer=s,y.lexer=s.lex,y.InlineLexer=a,y.inlineLexer=a.output,y.parse=y,e.exports=y}(this||"undefined"!=typeof window&&window)}).call(this,n(89))},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(1)),o=r(n(62)),i=r(n(80)),l=r(n(316)),c=r(n(318)),u=r(n(8)),h=n(133),d=n(28),p="btn btn-secondary",f="btn btn-secondary disabled";t.default=class extends a.Component{constructor(e){super(e),this.dropItem=this.dropItem.bind(this),this.equipItem=this.equipItem.bind(this),this.unequipItem=this.unequipItem.bind(this),this.useItem=this.useItem.bind(this),this.setSelectedItem=this.setSelectedItem.bind(this),this.setEquipSelected=this.setEquipSelected.bind(this),this.onChangeCount=this.onChangeCount.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.state={count:"1",filter:"All"}}handleKeyDown(e){const t=h.KeyCode.getKeyCode(e);t===d.Keys.GUI.Inv?this.toggleScreen("Inventory"):d.Keys.KeyMap.isConfirmYes(t)&&this.props.handleKeyDown(e)}onChangeCount(e){const t=e.target.value;this.setState({count:t})}getCount(){const e=parseInt(this.state.count,10);return Number.isInteger(e)&&e>0?e:1}dropItem(){if(null!==this.props.selectedItem){const e=u.default.getDropCmd(this.props.selectedItem,this.getCount());e.callback=function(e){let t="text-success";e.result||(t="text-danger"),this.props.setInventoryMsg({invMsg:e.msg,msgStyle:t}),this.props.selectItemTop(null)}.bind(this),this.props.doInvCmd(e)}else this.props.setInventoryMsg({invMsg:"No item selected for dropping!",msgStyle:"text-danger"})}equipItem(){if(null!==this.props.selectedItem){const e=u.default.getEquipCmd(this.props.selectedItem,this.getCount());e.callback=function(e){let t="text-success";e.result||(t="text-danger"),this.props.setInventoryMsg({invMsg:e.msg,msgStyle:t}),this.props.selectItemTop(null)}.bind(this),this.props.doInvCmd(e)}else this.props.setInventoryMsg({invMsg:"No item selected for equipping!",msgStyle:"text-danger"})}unequipItem(){if(this.props.equipSelected){const e=this.props.equipSelected.slotName,t=this.props.equipSelected.slotNumber,n=u.default.getUnequipCmd(e,t,this.getCount());n.callback=function(e){let t="text-success";e.result||(t="text-danger"),this.props.setInventoryMsg({invMsg:e.msg,msgStyle:t}),this.props.selectEquipTop(null)}.bind(this),this.props.doInvCmd(n)}else this.props.setInventoryMsg({invMsg:"No equipment selected!",msgStyle:"text-danger"})}useItem(){const e=this.props.selectedItem;if(u.default.isNullOrUndef([e]))this.props.setInventoryMsg({invMsg:"You must choose item to use!",msgStyle:"text-danger"});else{const t=this.props.player.getCell(),n=u.default.getUseCmd(e,t);n.callback=function(t){let n="text-success";t.result||(n="text-danger"),this.props.setInventoryMsg({invMsg:t.msg,msgStyle:n}),e.has("OneShot")&&this.props.selectItemTop(null)}.bind(this),this.props.doInvCmd(n)}}setSelectedItem(e){const t="Inventory Selected: "+e.toString();this.props.selectItemTop(e),this.props.setInventoryMsg({invMsg:t,msgStyle:"text-info"}),this.setState({count:e.getCount()})}setEquipSelected(e){const t="Equipment Selected: "+e.item.toString();this.props.selectEquipTop(e),this.props.setInventoryMsg({invMsg:t,msgStyle:"text-info"}),this.setState({count:e.item.getCount()})}render(){const{player:e}=this.props,t=e.getInvEq().getInventory(),n=e.getInvEq().getEquipment(),s=e.getMaxWeight(),r=n.getWeight(),u=e.has("MasterEquipper"),h=this.getItemTabs(t),d=this.getItemButtons(),p=this.getEquipButtons();return a.createElement(o.default,{"aria-labelledby":"inventory-modal-label",id:"inventoryModal",large:!0,onHide:this.toggleScreen.bind(this,"Inventory"),onKeyPress:this.handleKeyDown,show:this.props.showInventory},a.createElement(i.default,{id:"inventory-modal-label",text:"Inventory"}),a.createElement("div",{className:"modal-body row"},a.createElement("div",{className:"items-box col-md-6"},h,d,a.createElement(l.default,{eqWeight:r,filter:this.state.filter,inv:t,maxWeight:s,setSelectedItem:this.setSelectedItem})),a.createElement("div",{className:"col-md-6",id:"equipment-box"},p,a.createElement(c.default,{eq:n,isMasterEquipper:u,setEquipSelected:this.setEquipSelected}))),a.createElement("div",{className:"modal-footer row"},a.createElement("div",{className:"col-md-6"},a.createElement("p",{className:this.props.msgStyle},this.props.invMsg)),a.createElement("div",{className:"col-md-6"},a.createElement("button",{className:"btn btn-danger",onClick:this.toggleScreen.bind(this,"Inventory"),type:"button"},"Close"))))}getItemTabs(e){const t={All:!0};e.getItems().forEach(e=>{t[e.getType()]=!0});const n=Object.keys(t).map(e=>{let t="btn btn-secondary btn-sm";return this.state.filter===e&&(t="btn btn-primary btn-sm"),a.createElement("button",{className:t,key:e,onClick:this.filterItems.bind(this,e)},e)});return a.createElement("ul",null,n)}getItemButtons(){const e=this.props.selectedItem,t=e?p:f,n=e?p:f,s=e?p:f,r=this.getUseButtonText();return a.createElement(a.Fragment,null,a.createElement("button",{className:n,onClick:this.equipItem,type:"button"},"Equip"),a.createElement("button",{className:s,onClick:this.useItem,type:"button"},r),a.createElement("button",{className:t,onClick:this.dropItem,type:"button"},"Drop"),a.createElement("label",null,"Count:",a.createElement("input",{onChange:this.onChangeCount,value:this.state.count})))}getEquipButtons(){const e=this.props.equipSelected?p:f;return a.createElement(a.Fragment,null,a.createElement("button",{className:e,onClick:this.unequipItem,type:"button"},"Remove"))}toggleScreen(e){this.props.toggleScreen(e)}filterItems(e){this.setState({filter:e})}getUseButtonText(){if(this.props.selectedItem){const e=this.props.selectedItem.getType();if("food"===e)return"Eat";if("potion"===e)return"Drink"}return"Use"}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(1)),o=r(n(317));t.default=class extends a.Component{render(){const e=this.props.inv,t=this.props.filter,n=[],s=this.props.setSelectedItem,r=(e.getWeight()+this.props.eqWeight).toFixed(2),i=this.props.maxWeight;let l=e.first(),c=0;for(;null!=l;)"All"!==t&&l.getType()!==t||n.push(a.createElement(o.default,{item:l,key:c,setSelectedItem:s})),l=e.next(),++c;return a.createElement("div",null,a.createElement("p",null,"Items: ",r," kg (max ",i," kg)"),n)}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(1)),o=r(n(8));t.default=class extends a.Component{constructor(e){super(e),this.setSelectedItem=this.setSelectedItem.bind(this)}setSelectedItem(){this.props.setSelectedItem(this.props.item)}render(){const e=this.props.item,t=e.toString(),n=e.getName(),s="inv-item-slot "+o.default.getCssClass(o.default.TYPE_ITEM,n);return a.createElement("div",{className:s,onClick:this.setSelectedItem},t)}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1)),a=n(319);t.default=(e=>{const t=e.eq,n=t.getSlotTypes(),s=[],o=e.setEquipSelected;let i="";e.isMasterEquipper&&(i="(Weight reduced by 50%)");for(let e=0;e<n.length;e++){let i=t.getEquipped(n[e]);null===i||Array.isArray(i)||(i=[i]);let l=""+e;if(i&&i.length>0)for(let t=0;t<i.length;t++)l+=","+t,s.push(r.createElement(a.GameEquipSlot,{item:i[t],key:l,setEquipSelected:o,slotName:n[e],slotNumber:t}));else s.push(r.createElement(a.GameEquipSlot,{item:null,key:l,setEquipSelected:o,slotName:n[e],slotNumber:0}))}return r.createElement("div",null,r.createElement("p",null,"Equipment ",i),s)})},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(1)),o=r(n(8));t.GameEquipSlot=class extends a.Component{constructor(e){super(e),this.setEquipSelected=this.setEquipSelected.bind(this)}setEquipSelected(){if(null!==this.props.item){const e={item:this.props.item,slotName:this.props.slotName,slotNumber:this.props.slotNumber};this.props.setEquipSelected(e)}}render(){const e=this.props.slotName,t=this.props.item;let n="Empty",s="inv-equip-slot";return null!==t&&(n=t.toString(),s+=" "+o.default.getCssClass(o.default.TYPE_ITEM,t.getName())),a.createElement("div",{className:s,onClick:this.setEquipSelected},e," ",n)}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(1)),o=r(n(321)),i=r(n(399)),l=r(n(400)),c=r(n(401)),u=r(n(188)),h=r(n(211)),d=r(n(404)),p=r(n(405)),f=r(n(8)),m=r(n(23)),g=n(214),y=n(215),v=n(35),_=n(216),b=n(58),E=n(155),S=n(31),C=n(60),w=n(74),T=n(117),O=n(12),M=n(28),A=n(97),N=n(14),P=n(98),x=n(21),I=n(107),D=n(115),k=n(26),L=n(159),R=n(160),B=n(425),G=n(158),F=n(114),W=n(113),Y=M.Keys.KeyMap,j=[],X=["FullGame","Castle","Cave","CaveBr","City","Dungeon","MountainFace","MountainSummit","------------","abandoned_fort","capital","dwarven_city","------------","arena","castle","cellular","cave","crypt","digger","divided","dungeon","eller","empty","forest","icey","miner","mountain","uniform","rogue","ruins","rooms","summit","town","townwithwall","wall"],U=["game-board-map-view-xxxxs","game-board-map-view-xxxs","game-board-map-view-xs","game-board-map-view","game-board-map-view-s","game-board-player-view","game-board-player-view-xl"],$=(e,t,n)=>{const[s,r]=[e.getX(),e.getY()],[a,o]=[t.getX(),t.getY()];if(s===a&&r===o)return[e];const i=O.Geometry.getBoxCornersForCells(e,t),l=O.Geometry.getBox(i.ulx,i.uly,i.lrx,i.lry),c=[];return l.forEach(e=>{c.push(n.getCell(e[0],e[1]))}),c},K=(e,t)=>()=>({level:t,startTime:e,simulationStarted:!0,frameCount:0}),V=(e,t)=>()=>({level:e,errorMsg:t});t.default=class extends a.Component{constructor(e){super(e),this.handleKeyDown=this.handleKeyDown.bind(this);const t={debug:!1,boardClassName:"game-board-player-view",boardIndex:U.indexOf("game-board-player-view"),lastTouchedConf:null,zoneType:"city",zoneList:[],zoneConf:{shown:""},levelX:80,levelY:50,levelType:"Cave",subLevelX:20,subLevelY:7,subLevelType:"arena",subLevelTileX:1,subLevelTileY:1,errorMsg:"",msg:"",itemFunc:e=>e.value<5e3,maxValue:5e3,selectedCell:null,selectMode:!1,selectBegin:null,selectEnd:null,elementType:"floor",actorName:"",itemName:"",numEntities:20,insertXWidth:1,insertYWidth:1,levelConf:{shown:""},subLevelConf:{shown:""},level:null,levelList:[],levelIndex:0,showAnimations:!0,frameCount:0,fps:0,simulationStarted:!1,simulationPaused:!1,turnsPerSec:1e3,turnsPerFrame:1,idCount:0,updateMap:!0,enablePathfind:!1,useRLE:!0,savedLevelName:"saved_level_from_editor.json"};this.screen=new I.Screen(t.levelX,t.levelY),t.levelConf.shown=t.levelType,t.levelConf[t.levelType]=this.getLevelConf(t.levelType),this.state=t;const n=this.createLevel(t.levelType);n.getMap()._optimizeForRowAccess(),n.editorID=t.idCount++,t.level=n,t.levelList.push(n),window.LEVEL=n,this.parser=N.ObjectShell.getParser(),this.intervalID=null,this.frameID=null,this.setMsg=this.setMsg.bind(this),this.getLevelConf=this.getLevelConf.bind(this),this.createLevel=this.createLevel.bind(this),this.generateWorld=this.generateWorld.bind(this),this.generateZone=this.generateZone.bind(this),this.generateGame=this.generateGame.bind(this),this.onChangeZoneType=this.onChangeZoneType.bind(this),this.generateLevel=this.generateLevel.bind(this),this.onChangeMapType=this.onChangeMapType.bind(this),this.subGenerateMap=this.subGenerateMap.bind(this),this.onChangeSubType=this.onChangeSubType.bind(this),this.generateActors=this.generateActors.bind(this),this.generateItems=this.generateItems.bind(this),this.setShownLevel=this.setShownLevel.bind(this),this.onCellClick=this.onCellClick.bind(this),this.onChangeCellSelectX=this.onChangeCellSelectX.bind(this),this.onChangeCellSelectY=this.onChangeCellSelectY.bind(this),this.onChangeInputInt=this.onChangeInputInt.bind(this),this.onInputChange=this.onInputChange.bind(this),this.insertElement=this.insertElement.bind(this),this.insertActor=this.insertActor.bind(this),this.insertItem=this.insertItem.bind(this),this.importConfig=this.importConfig.bind(this),this.exportConfig=this.exportConfig.bind(this),this.invertMap=this.invertMap.bind(this),this.simulateLevel=this.simulateLevel.bind(this),this.stepSimulation=this.stepSimulation.bind(this),this.playSimulation=this.playSimulation.bind(this),this.playFastSimulation=this.playFastSimulation.bind(this),this.pauseSimulation=this.pauseSimulation.bind(this),this.stopSimulation=this.stopSimulation.bind(this),this.onLoadCallback=this.onLoadCallback.bind(this),this.menuCallback=this.menuCallback.bind(this),this.addLevelToEditor=this.addLevelToEditor.bind(this),this.setEditorData=this.setEditorData.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseOver=this.onMouseOver.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseOverCell=this.onMouseOverCell.bind(this),this.handleRightClick=this.handleRightClick.bind(this)}componentDidMount(){if(document.addEventListener("keypress",this.handleKeyDown,!0),this.props.editorData){const{allLevels:e}=this.props.editorData;e&&e.length>0&&(this.state.levelList=e)}}getCurrMap(){return this.state.level.getMap()}getCellCurrMap(e,t){const n=this.getCurrMap();return n.hasXY(e,t)?n.getCell(e,t):null}handleRightClick(e,t,n){const[s,r]=n.getXY();this.useClickHandler(s,r,n,t.type)}useClickHandler(e,t,n,s){new p.default(this.state.level).handleClick(e,t,n,s)&&this.setState({level:this.state.level})}onMouseOverCell(e,t){const n=this.getCellCurrMap(e,t);n&&this.setState({mouseOverCell:n})}setCellsForPathfinding(e){const t=this.getFirstSelectedCell();if(t){const n=this.getCurrMap(),[s,r]=t.getXY(),[a,o]=e.getXY(),i=x.Path.getShortestPassablePath(n,s,r,a,o).map(e=>n.getCell(e.x,e.y));this.setState({selectedCell:i,mouseOverCell:e})}else this.setState({mouseOverCell:e})}onMouseDown(e,t){if(!this.state.selectMode){const n=this.getCellCurrMap(e,t);this.setState({selectMode:!0,selectBegin:n,selectEnd:n})}}onMouseUp(e,t){if(this.state.selectMode){const n=this.getCellCurrMap(e,t);if(n){const e={selectMode:!1,selectEnd:n,cellSelectX:n.getX(),cellSelectY:n.getY()};this.state.selectBegin===this.state.selectEnd&&(e.selectedCell=[n]),this.setState(e)}}}onMouseOver(e,t){const n=this.getCellCurrMap(e,t);if(this.state.selectMode){if(n){const e=this.getCurrMap(),t=$(this.state.selectBegin,n,e),s=n.getX()-this.state.selectBegin.getX(),r=n.getY()-this.state.selectBegin.getY();this.setState({selectedCell:t,selectEnd:n,selectDiffX:s,selectDiffY:r})}}else this.state.enablePathfind&&n&&this.setCellsForPathfinding(n)}componentWillUnmount(){document.removeEventListener("keypress",this.handleKeyDown,!0)}setStateWithLevel(e,t={}){e.getMap()._optimizeForRowAccess(),this.setState(Object.assign({level:e},t))}getFirstSelectedCell(){return this.state.selectedCell&&this.state.selectedCell.length>0?this.state.selectedCell[0]:null}handleKeyDown(e){const t=this.nextCode=e.keyCode;if(t===m.default.VK_PERIOD)this.setState({elementType:"floor"}),this.insertElement();else if(t===m.default.VK_W)this.setState({elementType:"wall"}),this.insertElement();else if(Y.inMoveCodeMap(t)){let e=1;t>=m.default.VK_1&&t<=m.default.VK_9&&(e=10);let n=this.getFirstSelectedCell();if(this.state.selectMode&&(n=this.state.selectEnd),n){const[s,r]=[n.getX(),n.getY()],a=Y.getDir(t),o=s+a[0]*e,i=r+a[1]*e,l=this.getCurrMap();if(l.hasXY(o,i)){const e=l.getCell(o,i);if(this.state.selectMode){const t=$(this.state.selectBegin,e,l),n=o-this.state.selectBegin.getX(),s=i-this.state.selectBegin.getY();this.setState({selectedCell:t,selectEnd:e,selectDiffX:n,selectDiffY:s})}else this.setState({selectedCell:[e],cellSelectX:o,cellSelectY:i})}}}else if(t===f.default.VK_s){const e=this.getFirstSelectedCell(),t=!this.state.selectMode;this.state.selectMode?e&&this.setState({selectMode:t,selectEnd:e}):e&&this.setState({selectMode:t,selectBegin:e,selectEnd:e})}}getLevel(){return this.state.levelList.length?this.state.levelList[this.state.levelIndex]:null}onCellClick(e,t){const n=this.getCurrMap();if(n.hasXY(e,t)){const s=n.getCell(e,t);console.log(`Clicked ${e},${t} ${JSON.stringify(s)}`),s.hasActors()&&(console.log(s.getActors()[0]),console.log(JSON.stringify(s.getActors()[0])))}}generateWorld(){const e=this.state.levelX/100,t=this.state.levelY/100,n={yFirst:!1,topToBottom:!1,stopOnWall:!0,nVWalls:[.8],owTilesX:10*e,owTilesY:10*t,worldX:1*this.state.levelX,worldY:1*this.state.levelY,nLevelsX:1*e,nLevelsY:1*t,areaX:1*e,areaY:1*t},s=A.OWMap.createOverWorld(n),r=P.OverWorld.createOverWorldLevel(s,n)[0];this.addLevelToEditor(r)}generateGame(){const e=new E.FactoryGame;this.game=e.createNewGame(this.state.levelConf.FullGame)}generateZone(){const e=this.state.zoneType,t=new C.FactoryWorld,n=this.state.zoneConf[e];try{let s=null;switch(e){case"branch":s=t.createBranch(n);break;case"city":s=t.createCity(n);break;case"dungeon":s=t.createDungeon(n);break;case"face":s=t.createMountainFace(n);break;case"mountain":s=t.createMountain(n);break;case"quarter":s=t.createCityQuarter(n);break;default:console.log("No legal zoneType given")}this.addZoneToEditor(e,s)}catch(e){this.setState({errorMsg:e.message})}}generateLevel(){const e=this.state.levelType,t=this.createLevel(e);this.addLevelToEditor(t),"FullGame"===e&&this.setState({levelList:this.game.getLevelsInAllPlaces()})}createLevel(e){let t={};this.state.levelConf.hasOwnProperty(e)&&(t=this.state.levelConf[e]),t.transpose=!1;const[n,s]=[this.state.levelX,this.state.levelY];t.parser=this.parser;let r=null;return"capital"===e?r=new y.Capital(n,s,t).getLevel():"abandoned_fort"===e?r=new g.AbandonedFort(n,s,t).getLevel():"dwarven_city"===e?r=new _.DwarvenCity(n,s,t).getLevel():"Dungeon"===e?r=(new L.DungeonGenerator).create(n,s,t):"Cave"===e?r=(new R.CaveGenerator).create(n,s,t):"CaveBr"===e?r=(new B.CaveBrGenerator).create(n,s,t):"Castle"===e?r=(new F.CastleGenerator).create(n,s,t):"City"===e?r=(new W.CityGenerator).create(n,s,t):"MountainFace"===e?r=(new G.MountainGenerator).createFace(n,s,t):"MountainSummit"===e?r=(new G.MountainGenerator).createSummit(n,s,t):"FullGame"===e?(this.generateGame(),r=this.game.shownLevel()):r=(new S.FactoryLevel).createLevel(e,this.state.levelX,this.state.levelY,t),delete t.parser,r}addLevelToEditor(e){e.getMap()._optimizeForRowAccess(),e.editorID=this.state.idCount++;const t=this.state.levelList;t.push(e);const n=t.length-1;this.setShownLevel({level:e,levelList:t,levelIndex:n})}addZoneToEditor(e,t){const n=t.getLevels(),s=this.state.levelList;n.forEach(e=>{e.getMap()._optimizeForRowAccess(),e.editorID=this.state.idCount++,s.push(e)});const r=this.state.zoneConf;r.shown=e;const a=this.state.levelIndex+1;this.setShownLevel({level:n[0],levelList:s,levelIndex:a,zoneConf:r})}subGenerateMap(){const e=this.state.level,t=this.state.subLevelType;let n={};this.state.subLevelConf.hasOwnProperty(t)&&(n=this.state.subLevelConf[t]);const s=this.state.subLevelX,r=this.state.subLevelY;if(this.state.selectedCell){const a=this.getFirstSelectedCell().getX(),o=this.getFirstSelectedCell().getY();let i="";try{for(let i=0;i<this.state.subLevelTileX;i++)for(let l=0;l<this.state.subLevelTileY;l++){const c=a+i*s,u=o+l*r,h=(new S.FactoryLevel).createLevel(t,s,this.state.subLevelY,n);O.Geometry.mergeLevels(e,h,c,u)}}catch(e){i=e.message,console.error(e.message)}e.getMap()._optimizeForRowAccess(),this.setState(V(e,i))}else{const e="You must select a cell first from the map.";this.setState({errorMsg:e})}}generateItems(){const e={func:this.state.itemFunc,maxValue:this.state.maxValue,itemsPerLevel:this.state.numEntities},t=this.state.level;t.getItems().forEach(e=>{t.removeItem(e,e.getX(),e.getY())}),(new b.FactoryBase).addNRandItems(t,this.parser,e),this.setStateWithLevel(t)}generateActors(){const e=this.state.level;e.getActors().forEach(t=>{e.removeActor(t)});const t={maxDanger:20,actorsPerLevel:this.state.numEntities,func:e=>e.danger<100},n=new b.FactoryBase;n.setParser(N.ObjectShell.getParser()),n.addNRandActors(e,this.parser,t),this.setStateWithLevel(e)}debugMsg(e){this.state.debug&&console.log("[DEBUG] "+e)}getBBoxForInsertion(){const e=this.state.selectBegin,t=this.state.selectEnd;return O.Geometry.getBoxCornersForCells(e,t)}insertElement(){const{ulx:e,uly:t,lrx:n,lry:s}=this.getBBoxForInsertion();this.debugMsg("insertElement: "+`${e}, ${t}, ${n}, ${s}`);const r=this.state.level;try{O.Geometry.insertElements(r,this.state.elementType,{ulx:e,uly:t,lrx:n,lry:s})}catch(e){this.setState({errorMsg:e.message})}this.setStateWithLevel(r)}insertActor(){const{ulx:e,uly:t,lrx:n,lry:s}=this.getBBoxForInsertion();this.debugMsg("insertActor: "+`${e}, ${t}, ${n}, ${s}`);const r=this.state.level;try{O.Geometry.insertActors(r,this.state.actorName,{ulx:e,uly:t,lrx:n,lry:s},this.parser)}catch(e){this.setState({errorMsg:e.message})}this.setStateWithLevel(r)}insertItem(){const{ulx:e,uly:t,lrx:n,lry:s}=this.getBBoxForInsertion(),r=this.state.level;try{O.Geometry.insertItems(r,this.state.itemName,{ulx:e,uly:t,lrx:n,lry:s},this.parser)}catch(e){this.setState({errorMsg:e.message})}this.setStateWithLevel(r)}invertMap(){const e=this.state.level,t=e.getMap();v.CellMap.invertMap(t),this.setStateWithLevel(e)}setMsg(e){this.setState({errorMsg:e})}render(){let e="cell-row-div-player-view";this.props.mapShown&&(e="cell-row-div-map-view"),"game-board-map-view-xxxs"===this.state.boardClassName&&(e="cell-row-div-map-view-xxxs");let t=null,n=null;this.state.level&&(t=this.state.level.getMap()),this.state.selectedCell&&this.screen.setSelectedCell(this.state.selectedCell),t?(n=t.cols,this.state.useRLE?this.screen.renderFullMapWithRLE(t):this.screen.renderFullMap(t)):this.screen.clear();const s=this.getEditorMsg(),r=this.getSimulationButtons();let c=[];this.state.simulationStarted&&this.game.hasNewMessages()&&(c=this.game.getMessages());const p=!this.state.simulationStarted||this.state.simulationStarted&&this.state.simulationPaused;let f=null;return p&&(f=this.getEditorPanelElement()),a.default.createElement("div",{className:"game-editor-main-div"},a.default.createElement("p",{className:"text-primary"},"Battles Game Editor: ",s),a.default.createElement(o.default,{addLevel:this.addLevelToEditor,level:this.state.level,menuCallback:this.menuCallback,toggleEditor:this.props.toggleEditor}),p&&f,this.state.simulationStarted&&a.default.createElement("div",{className:"game-editor-game-messages"},a.default.createElement(u.default,{message:c,saveInProgress:!1,showAll:!0,visibleCells:j})),a.default.createElement("div",{className:"row"},a.default.createElement("div",{className:"col-md-2"},a.default.createElement(l.default,{levelIndex:this.state.levelIndex,levelList:this.state.levelList,setShownLevel:this.setShownLevel})),a.default.createElement("div",{className:"col-md-10"},a.default.createElement("div",{className:"game-editor-board-div"},a.default.createElement(i.default,{boardClassName:this.state.boardClassName,onCellClick:this.onCellClick,onMouseDown:this.onMouseDown,onMouseOver:this.onMouseOver,onMouseOverCell:this.onMouseOverCell,onMouseUp:this.onMouseUp,rowClass:e,screen:this.screen,sizeX:n,updateMap:this.state.updateMap,useRLE:this.state.useRLE})))),a.default.createElement("div",{className:"game-editor-bottom-btn"},r,a.default.createElement("div",{className:"btn-div"},a.default.createElement(h.default,{id:"",objData:this.state.level,onLoadCallback:this.onLoadCallback,savedObjName:this.state.savedLevelName,setMsg:this.setMsg}),a.default.createElement("div",null,a.default.createElement("button",{className:"btn btn-danger btn-lg",onClick:this.props.toggleEditor},"Close editor"),a.default.createElement("button",{className:"btn btn-success btn-lg",onClick:this.setEditorData},"Set game data")))),a.default.createElement(d.default,{handleRightClick:this.handleRightClick,mouseOverCell:this.state.mouseOverCell}))}setEditorData(){this.props.setEditorData(this.state.levelList,this.state.levelList)}onLoadCallback(e){const t=new w.FromJSON,n=t.restoreLevel(e);t.restoreEntityData(),this.addLevelToEditor(n)}getEditorMsg(){return this.state.errorMsg.length>0?a.default.createElement("span",{className:"text-danger"},this.state.errorMsg):this.state.msg.length>0?a.default.createElement("span",{className:"text-info"},this.state.msg):a.default.createElement("span",{className:"text-success"},"OK. No errors.")}modifyLevelConf(e,t){t.shown=e,t[e]||(t[e]=this.getLevelConf(e))}getLevelConf(e){if(console.log("getLevelConf with",e),"town"===e)return b.Factory.cityConfBase({});if("townwithwall"===e)return b.Factory.cityConfBase({});if("forest"===e)return{nForests:5,forestSize:100,ratio:.5,factor:6};if("mountain"===e)return k.MapGenerator.getOptions("mountain");if("crypt"===e||"castle"===e)return{tilesX:12,tilesY:7,roomCount:30,genParams:[2,2,2,2]};if("wall"===e)return(new m.default.Map.Wall)._options;if("abandoned_fort"===e)return g.abandonedFortConf;if("dwarven_city"===e)return _.dwarvenCityConf;if("Dungeon"===e)return L.DungeonGenerator.getOptions();if("Cave"===e)return R.CaveGenerator.getOptions();if("CaveBr"===e)return B.CaveBrGenerator.getOptions();if("Castle"===e)return F.CastleGenerator.getOptions();if("City"===e)return W.CityGenerator.getOptions();if("cave"===e){const e=(new m.default.Map.Miner)._options;return delete e.rng,e}if("MountainFace"===e)return G.MountainGenerator.getFaceOptions();if("MountainSummit"===e)return G.MountainGenerator.getSummitOptions();if("FullGame"===e){const e=E.FactoryGame.getOwConf(),t=E.FactoryGame.getGameConf();return t.world=e,t}return{}}zoom(e){let t=this.state.boardIndex;"+"===e?t<U.length-1&&++t:"-"===e&&t>0&&--t;const n=U[t];this.setState({boardClassName:n,boardIndex:t})}onInputChange(e){const{name:t}=e.target;let{value:n}=e.target;const[s,r]=t.split("-");"checkbox"===s&&(n=e.target.checked),console.log("name",t),console.log("value",n),console.log("checked",e.target.checked),console.log("stateVar",r),r&&(this.state.hasOwnProperty(r)?this.setState({[r]:n}):console.warn(`onInputChange: <${s}> No ${r} in state`))}onChangeLevelConf(e,t,n){const s=`#${n}--${e}--${t}`,r=document.querySelector(s),a=parseInt(r.value,10);let o=null;o="main"===n?this.state.levelConf:"zone"===n?this.state.zoneConf:this.state.subLevelConf,t.match(/(\w+)Func/)||(isNaN(a)?o[e][t]=r.value:o[e][t]=a),"main"===n?this.setState({levelConf:o}):"zone"===n?this.setState({zoneConf:o}):this.setState({subLevelConf:o})}onChangeZoneType(e){const t=e.target.value,n=D.WorldConf.getBaseConf(t),s=this.state.zoneConf;s[t]=n,s.shown=t,this.setState({zoneType:t,zoneConf:s,lastTouchedConf:s})}onChangeMapType(e){const t=e.target.value,n=t,s=this.state.levelConf;this.modifyLevelConf(t,s),this.setState({levelType:n,levelConf:s,lastTouchedConf:s})}getInt(e,t){const n=parseInt(e,t);return Number.isInteger(n)?n:0}onChangeSubType(e){const t=e.target.value,n=this.state.subLevelConf;this.modifyLevelConf(t,n),this.setState({subLevelType:t,subLevelConf:n,lastTouchedConf:n})}onChangeInputInt(e){const[t,n]=e.target.name.split("-");if("input"===t){const t=this.getInt(e.target.value,10);this.setState({[n]:t})}}onChangeCellSelectX(e){const t=this.getInt(e.target.value,10),n=this.getFirstSelectedCell(),s={cellSelectX:t},r=this.state.level.getMap();if(Number.isInteger(t)&&n&&r.hasXY(t,n.getY())){const e=r.getCell(t,n.getY());e&&(s.selectedCell=[e])}this.setState(s)}onChangeCellSelectY(e){const t=this.getInt(e.target.value,10),n=this.getFirstSelectedCell(),s={cellSelectY:t},r=this.state.level.getMap();if(Number.isInteger(t)&&n&&r.hasXY(n.getX(),t)){const e=r.getCell(n.getX(),t);e&&(s.selectedCell=[e])}this.setState(s)}playAnimation(){if(this.game.hasAnimation()){const e=this.game.getAnimationFrame();this.setState({render:!0,animation:e}),this.animationID=requestAnimationFrame(this.playAnimation.bind(this))}else this.setState({render:!0,animation:null})}simulateLevel(e=!1){if(this.state.level)if(this.state.simulationStarted)this.playSimulation();else{this.game=new T.GameMain,window.GAME=this.game;const t=new w.FromJSON,n=this.state.level.toJSON(),s=t.restoreLevel(n);t.restoreEntityData(),s.getMap()._optimizeForRowAccess(),s.editorID=this.state.idCount++,this.game.addLevel(s),this.game.addActiveLevel(s),this.state.showAnimations&&this.game.setAnimationCallback(this.playAnimation.bind(this));const r=(new Date).getTime();this.setState(K(r,s)),e||(this.frameID=requestAnimationFrame(this.mainLoop.bind(this)))}else{const e="You must create a level before simulation!";this.setState({errorMsg:e})}}mainLoop(){const e=this.state.frameCount,t=1e3*e/((new Date).getTime()-this.state.startTime);for(let e=0;e<this.state.turnsPerFrame;e++)this.game.simulateGame();this.setState({frameCount:e+1,fps:t}),this.frameID=requestAnimationFrame(this.mainLoop.bind(this))}mainLoopFast(){for(let e=0;e<this.state.turnsPerSec;e++)this.game.simulateGame();this.setShownLevel({level:this.game.getLevels()[0]})}playSimulation(){this.state.simulationStarted?(null!==this.intervalID&&(clearInterval(this.intervalID),this.intervalID=null),null===this.frameID&&(this.frameID=requestAnimationFrame(this.mainLoop.bind(this))),this.setState({simulationPaused:!1})):console.error("Start simulation first using Simulate")}stepSimulation(){this.state.simulationStarted?(this.game.simulateGame(),this.setShownLevel({level:this.game.getLevels()[0]})):this.simulateLevel(!0)}playFastSimulation(){this.state.simulationStarted?(this.frameID&&(cancelAnimationFrame(this.frameID),this.frameID=null),this.intervalID=setInterval(this.mainLoopFast.bind(this),this.state.turnsPerSec),this.setState({simulationPaused:!1})):console.error("Start simulation first using Simulate")}pauseSimulation(){this.intervalID&&(clearInterval(this.intervalID),this.intervalID=null),this.frameID&&(cancelAnimationFrame(this.frameID),this.frameID=null),this.setState({simulationPaused:!0})}stopSimulation(){this.state.simulationStarted&&(this.intervalID&&(clearInterval(this.intervalID),this.intervalID=null),this.frameID&&(cancelAnimationFrame(this.frameID),this.frameID=null),this.game=null,window.GAME=null,delete this.game,this.setShownLevel({level:this.getLevel(),simulationStarted:!1,simulationPaused:!1}))}setShownLevel(e){window.LEVEL=e.level,this.setState(e)}getConfElement(e,t){let n=null;const s=t.shown;if(s.length>0){t.hasOwnProperty(s)||console.error(`No conf for level type ${s}`);const r=t[s];n=Object.keys(r).map(n=>{const o=t[s][n],i=o||r[n],l=this.onChangeLevelConf.bind(this,s,n,e);return"function"!=typeof r[n]?a.default.createElement("label",{key:`${s}--${n}`},n,a.default.createElement("input",{id:`${e}--${s}--${n}`,name:`${e}--{confType}-${n}`,onChange:l,value:i})):a.default.createElement("label",null,n)})}return a.default.createElement("div",{className:"game-editor-level-conf"},n)}getLevelSelectElement(){return X.map(e=>{const t="key-sel-type-"+e;return a.default.createElement("option",{key:t,value:e},e)})}getElementSelectElem(){return Object.keys(f.default.cellStyles.elements).map(e=>{if("default"!==e){const t="key-sel-element-"+e;return a.default.createElement("option",{key:t,value:e},e)}return null})}getSelectElem(e){const t=this.parser.dbGet({categ:e});return Object.values(t).map(t=>{const n=`key-sel-${e}-${t.name}`;return a.default.createElement("option",{key:n,value:t.name},t.name)})}getZoneSelectElem(){return Object.values(["branch","city","dungeon","face","mountain","quarter"]).map(e=>{const t=`key-sel-feature-${e}`;return a.default.createElement("option",{key:t,value:e},e)})}getEditorPanelElement(){const e=this.getZoneSelectElem(),t=this.getConfElement("zone",this.state.zoneConf),n=this.getConfElement("main",this.state.levelConf),s=this.getLevelSelectElement(),r=this.getElementSelectElem(),o=this.getSelectElem("actors"),i=this.getSelectElem("items"),l=this.getConfElement("sub",this.state.subLevelConf);return a.default.createElement("div",{className:"game-editor-panel"},a.default.createElement("div",{className:"row"},a.default.createElement("div",{className:"col-md-6"},a.default.createElement("div",{className:"btn-div"},a.default.createElement("button",{id:"btn-gen-world",onClick:this.generateWorld},"OverWorld"),a.default.createElement("span",null,"Zoom In/Out:",a.default.createElement("button",{id:"btn-zoom-in",onClick:this.zoom.bind(this,"+")},"+"),a.default.createElement("button",{id:"btn-zoom-out",onClick:this.zoom.bind(this,"-")},"-"),a.default.createElement("label",null,a.default.createElement("input",{checked:this.state.updateMap,name:"checkbox-updateMap",onChange:this.onInputChange,type:"checkbox"}),"Update map"),a.default.createElement("label",null,a.default.createElement("input",{checked:this.state.enablePathfind,name:"checkbox-enablePathfind",onChange:this.onInputChange,type:"checkbox"}),"Pathfinding"))),a.default.createElement("div",{className:"btn-div"},a.default.createElement("button",{id:"btn-gen-zone",onClick:this.generateZone},"Zone!"),a.default.createElement("select",{name:"feature-type",onChange:this.onChangeZoneType,value:this.state.zoneType},e),t),a.default.createElement("div",{className:"btn-div"},a.default.createElement("button",{id:"btn-gen-level",onClick:this.generateLevel},"Level!"),a.default.createElement("select",{name:"level-type",onChange:this.onChangeMapType,value:this.state.levelType},s),a.default.createElement("label",null,"Size:",a.default.createElement("input",{name:"input-levelX",onChange:this.onChangeInputInt,value:this.state.levelX}),a.default.createElement("input",{name:"input-levelY",onChange:this.onChangeInputInt,value:this.state.levelY})),a.default.createElement("button",{onClick:this.invertMap},"Invert"),n),a.default.createElement("div",{className:"btn-div"},a.default.createElement("button",{onClick:this.subGenerateMap},"SubGen!"),a.default.createElement("select",{name:"sublevel-type",onChange:this.onChangeSubType,value:this.state.subLevelType},s),a.default.createElement("label",null,"Size:",a.default.createElement("input",{name:"input-subLevelX",onChange:this.onChangeInputInt,value:this.state.subLevelX}),a.default.createElement("input",{name:"input-subLevelY",onChange:this.onChangeInputInt,value:this.state.subLevelY})),a.default.createElement("label",null,"Tiles:",a.default.createElement("input",{name:"input-subLevelTileX",onChange:this.onChangeInputInt,value:this.state.subLevelTileX}),a.default.createElement("input",{name:"input-subLevelTileY",onChange:this.onChangeInputInt,value:this.state.subLevelTileY})),l),a.default.createElement("div",{className:"btn-div"},a.default.createElement("button",{id:"btn-gen-actors",onClick:this.generateActors},"Actors!"),a.default.createElement("button",{id:"btn-gen-items",onClick:this.generateItems},"Items!"),a.default.createElement("input",{name:"input-numEntities",onChange:this.onChangeInputInt,value:this.state.numEntities})),a.default.createElement("div",{className:"btn-div"},a.default.createElement("button",{id:"btn-insert-element",onClick:this.insertElement},"Insert element"),a.default.createElement("select",{name:"input-elementType",onChange:this.onInputChange,value:this.state.elementType},r),a.default.createElement("button",{id:"btn-insert-actor",onClick:this.insertActor},"Insert actor"),a.default.createElement("select",{name:"input-actorName",onChange:this.onInputChange,value:this.state.actorName},o)),a.default.createElement("div",{className:"btn-div"},a.default.createElement("button",{id:"btn-insert-item",onClick:this.insertItem},"Insert item"),a.default.createElement("select",{name:"input-itemName",onChange:this.onInputChange,value:this.state.itemName},i),a.default.createElement("span",null,"| X by Y"),a.default.createElement("input",{name:"input-insertXWidth",onChange:this.onChangeInputInt,value:this.state.insertXWidth}),a.default.createElement("input",{name:"input-insertYWidth",onChange:this.onChangeInputInt,value:this.state.insertYWidth}))),a.default.createElement("div",{className:"col-md-6"},a.default.createElement("div",null,a.default.createElement("p",null,"Template/Config here"),a.default.createElement("textarea",{name:"input-confTemplText",onChange:this.onInputChange,rows:5,value:this.state.confTemplText}),a.default.createElement("button",{onClick:this.importConfig},"Import"),a.default.createElement("button",{onClick:this.exportConfig},"Export")),a.default.createElement("div",{className:"cell-selection"},a.default.createElement("span",null,"Selection:"),a.default.createElement("input",{name:"cell-select-x",onChange:this.onChangeCellSelectX,value:this.state.cellSelectX}),a.default.createElement("input",{name:"cell-select-y",onChange:this.onChangeCellSelectY,value:this.state.cellSelectY})),a.default.createElement("div",{className:"selection-diff"},a.default.createElement("span",null,"dX/dY:"),a.default.createElement("input",{name:"cell-select-diff-x",readOnly:!0,type:"text",value:this.state.selectDiffX}),a.default.createElement("input",{name:"cell-select-diff-x",readOnly:!0,type:"text",value:this.state.selectDiffY})))))}getSimulationButtons(){return a.default.createElement("div",{className:"btn-div"},a.default.createElement(c.default,{menuCallback:this.menuCallback,simulationStarted:this.state.simulationStarted}),a.default.createElement("div",null,a.default.createElement("label",null,"Turns per frame:",a.default.createElement("input",{name:"input-turnsPerFrame",onChange:this.onChangeInputInt,value:this.state.turnsPerFrame}))),a.default.createElement("p",null,"Frame count: ",this.state.frameCount),a.default.createElement("p",null,"FPS: ",this.state.fps))}importConfig(){if(this.state.lastTouchedConf){const e=this.state.lastTouchedConf.shown,t=this.state.lastTouchedConf[e],n=JSON.stringify(t,null,1);this.setState({confTemplText:n})}}exportConfig(){try{const e=JSON.parse(this.state.confTemplText),t=this.state.lastTouchedConf;t[t.shown]=e,this.setState({lastTouchedConf:t})}catch(e){this.setState({errorMsg:e.message})}}menuCallback(e,t){"function"==typeof this[e]?Array.isArray(t)?1===t.length?this[e](t):this[e](...t):this[e](t):(console.error(`${e} not a function in Top`),console.error(`Called with args ${t}`))}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(1)),o=r(n(322)),i=n(262);t.default=class extends a.Component{constructor(e){super(e),this.handleSelect=this.handleSelect.bind(this)}handleSelect(e){this.props.menuCallback(e),this.menuLogic.menuCallback(e)}render(){return a.default.createElement("div",{className:"editor-top-menu"},a.default.createElement(i.Nav,{activeKey:"1",bsStyle:"tabs",onSelect:this.handleSelect},a.default.createElement(i.NavDropdown,{eventKey:"file",id:"dropdown-file",title:"File"},a.default.createElement(i.MenuItem,{eventKey:"file-new"},"New..."),a.default.createElement(i.MenuItem,{eventKey:"file-save-as"},"Save as..."),a.default.createElement(i.MenuItem,{eventKey:"file-load"},"Load"),a.default.createElement(i.MenuItem,{eventKey:"file-import"},"Import")),a.default.createElement(i.NavDropdown,{eventKey:"edit",id:"dropdown-edit",title:"Edit"},a.default.createElement(i.MenuItem,{eventKey:"edit-select"},"Select"),a.default.createElement(i.MenuItem,{eventKey:"edit-select-shape"},"Select shape"),a.default.createElement(i.MenuItem,{eventKey:"edit-cut"},"Cut"),a.default.createElement(i.MenuItem,{eventKey:"edit-copy"},"Copy"),a.default.createElement(i.MenuItem,{eventKey:"edit-paste"},"Paste"),a.default.createElement(i.MenuItem,{eventKey:"edit-undo"},"Undo")),a.default.createElement(i.NavDropdown,{eventKey:"simulate",id:"dropdown-simulate",title:"Simulate"},a.default.createElement(i.MenuItem,{eventKey:"simulate-1"},"New game"),a.default.createElement(i.MenuItem,{eventKey:"simulate-2"},"Simulate level"),a.default.createElement(i.MenuItem,{eventKey:"simulate-3"},"Play/Pause"),a.default.createElement(i.MenuItem,{eventKey:"simulate-4"},"Stop"),a.default.createElement(i.MenuItem,{eventKey:"simulate-5"},"Play fast"),a.default.createElement(i.MenuItem,{eventKey:"simulate-6"},"Step")),a.default.createElement(i.NavDropdown,{eventKey:"view",id:"dropdown-view",title:"View"},a.default.createElement(i.MenuItem,{eventKey:"view-1"},"Refresh"),a.default.createElement(i.MenuItem,{eventKey:"view-2"},"Zoom in"),a.default.createElement(i.MenuItem,{eventKey:"view-3"},"Zoom out"),a.default.createElement(i.MenuItem,{eventKey:"view-4"},"Zoom fit")),a.default.createElement(i.NavDropdown,{eventKey:"insert",id:"dropdown-insert",title:"Insert"},a.default.createElement(i.MenuItem,{eventKey:"insert-1"},"Actor"),a.default.createElement(i.MenuItem,{eventKey:"insert-2"},"Item"),a.default.createElement(i.MenuItem,{eventKey:"insert-3"},"Element"),a.default.createElement(i.MenuItem,{eventKey:"insert-4"},"Sublevel"),a.default.createElement(i.MenuItem,{eventKey:"insert-5"},"Shape")),a.default.createElement(i.NavDropdown,{eventKey:"generate",id:"dropdown-generate",title:"Generate"},a.default.createElement(i.MenuItem,{eventKey:"level-new-level"},"New level"),a.default.createElement(i.MenuItem,{eventKey:"level-new-zone"},"New zone"),a.default.createElement(i.MenuItem,{eventKey:"level-new-world"},"New world"),a.default.createElement(i.MenuItem,{eventKey:"level-new-battle"},"New battle")),a.default.createElement(i.NavItem,{className:"text-danger",eventKey:"close",id:"dropdown-close",onClick:this.props.toggleEditor},"Close")),a.default.createElement(o.default,{addLevel:this.props.addLevel,level:this.props.level,onRef:e=>{this.menuLogic=e}}))}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(1)),o=r(n(323)),i=n(17)("bitn:TopMenuLogic"),l=n(135);t.default=class extends a.Component{constructor(e){super(e),this.state={showModal:!1,options:{},cmdOptionsText:"",errorMsg:"",currentCmd:""},this.battles=[],this.onClickModalOK=this.onClickModalOK.bind(this),this.onClickModalCancel=this.onClickModalCancel.bind(this),this.newBattle=this.newBattle.bind(this),this.onChangeCmdOptions=this.onChangeCmdOptions.bind(this),this.functions={"level-new-battle":{showModal:!0,func:this.newBattle}}}componentDidMount(){this.props.onRef(this)}componentWillUnmount(){this.props.onRef(null)}onClickModalCancel(){this.setState({showModal:!1,errorMsg:""})}onClickModalOK(){try{const e=JSON.parse(this.state.cmdOptionsText),t=this.functions[this.state.currentCmd].func;if("function"!=typeof t)throw new Error("Internal error occurred.");t(e),console.log(e),this.setState({showModal:!1,errorMsg:""})}catch(e){console.error(e),this.setState({errorMsg:e.message})}}onChangeCmdOptions(e){this.setState({cmdOptionsText:e.target.value})}menuCallback(e){const t=this.needsModal(e),n={name:e},s=JSON.stringify(n);this.setState({showModal:t,cmdOptionsText:s,currentCmd:e})}render(){let e=null;return""!==this.state.errorMsg&&(e=a.default.createElement("span",{className:"text-danger"},this.state.errorMsg)),a.default.createElement(o.default,{ariaHideApp:!1,isOpen:this.state.showModal},a.default.createElement("p",null,"Please set the options:"),a.default.createElement("textarea",{name:"menu-cmd-options",onChange:this.onChangeCmdOptions,rows:10,value:this.state.cmdOptionsText}),a.default.createElement("div",{className:"modal-footer row"},e,a.default.createElement("button",{className:"btn btn-danger",onClick:this.onClickModalCancel},"Cancel"),a.default.createElement("button",{className:"btn btn-success",onClick:this.onClickModalOK},"OK")))}needsModal(e){return this.functions.hasOwnProperty(e)&&this.functions[e].showModal?(i("TopMenuLogic needsModal true"),!0):(i("TopMenuLogic needsModal false"),!1)}newBattle(e){i("TopMenuLogic newBattle() begin");const t=(new l.FactoryBattle).createBattle(null,e),n=t.getLevel();this.battles.push(t),this.props.addLevel(n),i("TopMenuLogic newBattle() end")}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,r=n(324),a=(s=r)&&s.__esModule?s:{default:s};t.default=a.default,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bodyOpenClassName=t.portalClassName=void 0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),a=n(1),o=f(a),i=f(n(13)),l=f(n(0)),c=f(n(325)),u=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(190)),h=n(134),d=f(h),p=n(177);function f(e){return e&&e.__esModule?e:{default:e}}function m(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var g=t.portalClassName="ReactModalPortal",y=t.bodyOpenClassName="ReactModal__Body--open",v=void 0!==i.default.createPortal,_=function(){return v?i.default.createPortal:i.default.unstable_renderSubtreeIntoContainer};function b(e){return e()}var E=function(e){function t(){var e,n,r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var a=arguments.length,l=Array(a),u=0;u<a;u++)l[u]=arguments[u];return n=r=m(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(l))),r.removePortal=function(){!v&&i.default.unmountComponentAtNode(r.node),b(r.props.parentSelector).removeChild(r.node)},r.portalRef=function(e){r.portal=e},r.renderPortal=function(e){var n=_()(r,o.default.createElement(c.default,s({defaultStyles:t.defaultStyles},e)),r.node);r.portalRef(n)},m(r,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,a.Component),r(t,[{key:"componentDidMount",value:function(){h.canUseDOM&&(v||(this.node=document.createElement("div")),this.node.className=this.props.portalClassName,b(this.props.parentSelector).appendChild(this.node),!v&&this.renderPortal(this.props))}},{key:"getSnapshotBeforeUpdate",value:function(e){return{prevParent:b(e.parentSelector),nextParent:b(this.props.parentSelector)}}},{key:"componentDidUpdate",value:function(e,t,n){if(h.canUseDOM){var s=this.props,r=s.isOpen,a=s.portalClassName;e.portalClassName!==a&&(this.node.className=a);var o=n.prevParent,i=n.nextParent;i!==o&&(o.removeChild(this.node),i.appendChild(this.node)),(e.isOpen||r)&&!v&&this.renderPortal(this.props)}}},{key:"componentWillUnmount",value:function(){if(h.canUseDOM&&this.node&&this.portal){var e=this.portal.state,t=Date.now(),n=e.isOpen&&this.props.closeTimeoutMS&&(e.closesAt||t+this.props.closeTimeoutMS);n?(e.beforeClose||this.portal.closeWithTimeout(),setTimeout(this.removePortal,n-t)):this.removePortal()}}},{key:"render",value:function(){return h.canUseDOM&&v?(!this.node&&v&&(this.node=document.createElement("div")),_()(o.default.createElement(c.default,s({ref:this.portalRef,defaultStyles:t.defaultStyles},this.props)),this.node)):null}}],[{key:"setAppElement",value:function(e){u.setElement(e)}}]),t}();E.propTypes={isOpen:l.default.bool.isRequired,style:l.default.shape({content:l.default.object,overlay:l.default.object}),portalClassName:l.default.string,bodyOpenClassName:l.default.string,htmlOpenClassName:l.default.string,className:l.default.oneOfType([l.default.string,l.default.shape({base:l.default.string.isRequired,afterOpen:l.default.string.isRequired,beforeClose:l.default.string.isRequired})]),overlayClassName:l.default.oneOfType([l.default.string,l.default.shape({base:l.default.string.isRequired,afterOpen:l.default.string.isRequired,beforeClose:l.default.string.isRequired})]),appElement:l.default.instanceOf(d.default),onAfterOpen:l.default.func,onRequestClose:l.default.func,closeTimeoutMS:l.default.number,ariaHideApp:l.default.bool,shouldFocusAfterRender:l.default.bool,shouldCloseOnOverlayClick:l.default.bool,shouldReturnFocusAfterClose:l.default.bool,parentSelector:l.default.func,aria:l.default.object,data:l.default.object,role:l.default.string,contentLabel:l.default.string,shouldCloseOnEsc:l.default.bool,overlayRef:l.default.func,contentRef:l.default.func},E.defaultProps={isOpen:!1,portalClassName:g,bodyOpenClassName:y,role:"dialog",ariaHideApp:!0,closeTimeoutMS:0,shouldFocusAfterRender:!0,shouldCloseOnEsc:!0,shouldCloseOnOverlayClick:!0,shouldReturnFocusAfterClose:!0,parentSelector:function(){return document.body}},E.defaultStyles={overlay:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(255, 255, 255, 0.75)"},content:{position:"absolute",top:"40px",left:"40px",right:"40px",bottom:"40px",border:"1px solid #ccc",background:"#fff",overflow:"auto",WebkitOverflowScrolling:"touch",borderRadius:"4px",outline:"none",padding:"20px"}},(0,p.polyfill)(E),t.default=E},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(1),i=m(o),l=m(n(0)),c=f(n(326)),u=m(n(327)),h=f(n(190)),d=f(n(329)),p=m(n(134));function f(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function m(e){return e&&e.__esModule?e:{default:e}}var g={overlay:"ReactModal__Overlay",content:"ReactModal__Content"},y=9,v=27,_=0,b=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.setOverlayRef=function(e){n.overlay=e,n.props.overlayRef&&n.props.overlayRef(e)},n.setContentRef=function(e){n.content=e,n.props.contentRef&&n.props.contentRef(e)},n.afterClose=function(){var e=n.props,t=e.appElement,s=e.ariaHideApp,r=e.htmlOpenClassName,a=e.bodyOpenClassName;a&&d.remove(document.body,a),r&&d.remove(document.getElementsByTagName("html")[0],r),s&&_>0&&0===(_-=1)&&h.show(t),n.props.shouldFocusAfterRender&&(n.props.shouldReturnFocusAfterClose?(c.returnFocus(),c.teardownScopedFocus()):c.popWithoutFocus()),n.props.onAfterClose&&n.props.onAfterClose()},n.open=function(){n.beforeOpen(),n.state.afterOpen&&n.state.beforeClose?(clearTimeout(n.closeTimer),n.setState({beforeClose:!1})):(n.props.shouldFocusAfterRender&&(c.setupScopedFocus(n.node),c.markForFocusLater()),n.setState({isOpen:!0},function(){n.setState({afterOpen:!0}),n.props.isOpen&&n.props.onAfterOpen&&n.props.onAfterOpen()}))},n.close=function(){n.props.closeTimeoutMS>0?n.closeWithTimeout():n.closeWithoutTimeout()},n.focusContent=function(){return n.content&&!n.contentHasFocus()&&n.content.focus()},n.closeWithTimeout=function(){var e=Date.now()+n.props.closeTimeoutMS;n.setState({beforeClose:!0,closesAt:e},function(){n.closeTimer=setTimeout(n.closeWithoutTimeout,n.state.closesAt-Date.now())})},n.closeWithoutTimeout=function(){n.setState({beforeClose:!1,isOpen:!1,afterOpen:!1,closesAt:null},n.afterClose)},n.handleKeyDown=function(e){e.keyCode===y&&(0,u.default)(n.content,e),n.props.shouldCloseOnEsc&&e.keyCode===v&&(e.stopPropagation(),n.requestClose(e))},n.handleOverlayOnClick=function(e){null===n.shouldClose&&(n.shouldClose=!0),n.shouldClose&&n.props.shouldCloseOnOverlayClick&&(n.ownerHandlesClose()?n.requestClose(e):n.focusContent()),n.shouldClose=null},n.handleContentOnMouseUp=function(){n.shouldClose=!1},n.handleOverlayOnMouseDown=function(e){n.props.shouldCloseOnOverlayClick||e.target!=n.overlay||e.preventDefault()},n.handleContentOnClick=function(){n.shouldClose=!1},n.handleContentOnMouseDown=function(){n.shouldClose=!1},n.requestClose=function(e){return n.ownerHandlesClose()&&n.props.onRequestClose(e)},n.ownerHandlesClose=function(){return n.props.onRequestClose},n.shouldBeClosed=function(){return!n.state.isOpen&&!n.state.beforeClose},n.contentHasFocus=function(){return document.activeElement===n.content||n.content.contains(document.activeElement)},n.buildClassName=function(e,t){var s="object"===(void 0===t?"undefined":r(t))?t:{base:g[e],afterOpen:g[e]+"--after-open",beforeClose:g[e]+"--before-close"},a=s.base;return n.state.afterOpen&&(a=a+" "+s.afterOpen),n.state.beforeClose&&(a=a+" "+s.beforeClose),"string"==typeof t&&t?a+" "+t:a},n.attributesFromObject=function(e,t){return Object.keys(t).reduce(function(n,s){return n[e+"-"+s]=t[s],n},{})},n.state={afterOpen:!1,beforeClose:!1},n.shouldClose=null,n.moveFromContentToOverlay=null,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o.Component),a(t,[{key:"componentDidMount",value:function(){this.props.isOpen&&this.open()}},{key:"componentDidUpdate",value:function(e,t){this.props.isOpen&&!e.isOpen?this.open():!this.props.isOpen&&e.isOpen&&this.close(),this.props.shouldFocusAfterRender&&this.state.isOpen&&!t.isOpen&&this.focusContent()}},{key:"componentWillUnmount",value:function(){this.afterClose(),clearTimeout(this.closeTimer)}},{key:"beforeOpen",value:function(){var e=this.props,t=e.appElement,n=e.ariaHideApp,s=e.htmlOpenClassName,r=e.bodyOpenClassName;r&&d.add(document.body,r),s&&d.add(document.getElementsByTagName("html")[0],s),n&&(_+=1,h.hide(t))}},{key:"render",value:function(){var e=this.props,t=e.className,n=e.overlayClassName,r=e.defaultStyles,a=t?{}:r.content,o=n?{}:r.overlay;return this.shouldBeClosed()?null:i.default.createElement("div",{ref:this.setOverlayRef,className:this.buildClassName("overlay",n),style:s({},o,this.props.style.overlay),onClick:this.handleOverlayOnClick,onMouseDown:this.handleOverlayOnMouseDown},i.default.createElement("div",s({ref:this.setContentRef,style:s({},a,this.props.style.content),className:this.buildClassName("content",t),tabIndex:"-1",onKeyDown:this.handleKeyDown,onMouseDown:this.handleContentOnMouseDown,onMouseUp:this.handleContentOnMouseUp,onClick:this.handleContentOnClick,role:this.props.role,"aria-label":this.props.contentLabel},this.attributesFromObject("aria",this.props.aria||{}),this.attributesFromObject("data",this.props.data||{}),{"data-testid":this.props.testId}),this.props.children))}}]),t}();b.defaultProps={style:{overlay:{},content:{}},defaultStyles:{}},b.propTypes={isOpen:l.default.bool.isRequired,defaultStyles:l.default.shape({content:l.default.object,overlay:l.default.object}),style:l.default.shape({content:l.default.object,overlay:l.default.object}),className:l.default.oneOfType([l.default.string,l.default.object]),overlayClassName:l.default.oneOfType([l.default.string,l.default.object]),bodyOpenClassName:l.default.string,htmlOpenClassName:l.default.string,ariaHideApp:l.default.bool,appElement:l.default.instanceOf(p.default),onAfterOpen:l.default.func,onAfterClose:l.default.func,onRequestClose:l.default.func,closeTimeoutMS:l.default.number,shouldFocusAfterRender:l.default.bool,shouldCloseOnOverlayClick:l.default.bool,shouldReturnFocusAfterClose:l.default.bool,role:l.default.string,contentLabel:l.default.string,aria:l.default.object,data:l.default.object,children:l.default.node,shouldCloseOnEsc:l.default.bool,overlayRef:l.default.func,contentRef:l.default.func,testId:l.default.string},t.default=b,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleBlur=c,t.handleFocus=u,t.markForFocusLater=function(){o.push(document.activeElement)},t.returnFocus=function(){var e=null;try{return void(0!==o.length&&(e=o.pop()).focus())}catch(t){console.warn(["You tried to return focus to",e,"but it is not in the DOM anymore"].join(" "))}},t.popWithoutFocus=function(){o.length>0&&o.pop()},t.setupScopedFocus=function(e){i=e,window.addEventListener?(window.addEventListener("blur",c,!1),document.addEventListener("focus",u,!0)):(window.attachEvent("onBlur",c),document.attachEvent("onFocus",u))},t.teardownScopedFocus=function(){i=null,window.addEventListener?(window.removeEventListener("blur",c),document.removeEventListener("focus",u)):(window.detachEvent("onBlur",c),document.detachEvent("onFocus",u))};var s,r=n(189),a=(s=r)&&s.__esModule?s:{default:s};var o=[],i=null,l=!1;function c(){l=!0}function u(){if(l){if(l=!1,!i)return;setTimeout(function(){i.contains(document.activeElement)||((0,a.default)(i)[0]||i).focus()},0)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var n=(0,a.default)(e);if(!n.length)return void t.preventDefault();var s,r=t.shiftKey,o=n[0],i=n[n.length-1];if(e===document.activeElement){if(!r)return;s=i}i!==document.activeElement||r||(s=o);o===document.activeElement&&r&&(s=i);if(s)return t.preventDefault(),void s.focus();var l=/(\bChrome\b|\bSafari\b)\//.exec(navigator.userAgent);if(null==l||"Chrome"==l[1]||null!=/\biPod\b|\biPad\b/g.exec(navigator.userAgent))return;var c=n.indexOf(document.activeElement);c>-1&&(c+=r?-1:1);if(void 0===n[c])return t.preventDefault(),void(s=r?i:o).focus();t.preventDefault(),n[c].focus()};var s,r=n(189),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){var s;
/*!
  Copyright (c) 2015 Jed Watson.
  Based on code that is Copyright 2013-2015, Facebook, Inc.
  All rights reserved.
*/
/*!
  Copyright (c) 2015 Jed Watson.
  Based on code that is Copyright 2013-2015, Facebook, Inc.
  All rights reserved.
*/
!function(){"use strict";var r=!("undefined"==typeof window||!window.document||!window.document.createElement),a={canUseDOM:r,canUseWorkers:"undefined"!=typeof Worker,canUseEventListeners:r&&!(!window.addEventListener&&!window.attachEvent),canUseViewport:r&&!!window.screen};void 0===(s=function(){return a}.call(t,n,t,e))||(e.exports=s)}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dumpClassLists=function(){0};var s={},r={};t.add=function(e,t){return n=e.classList,a="html"==e.nodeName.toLowerCase()?s:r,void t.split(" ").forEach(function(e){!function(e,t){e[t]||(e[t]=0),e[t]+=1}(a,e),n.add(e)});var n,a},t.remove=function(e,t){return n=e.classList,a="html"==e.nodeName.toLowerCase()?s:r,void t.split(" ").forEach(function(e){!function(e,t){e[t]&&(e[t]-=1)}(a,e),0===a[e]&&n.remove(e)});var n,a}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(192),o=n(331),i=n(9),l=n(12),c=i.Random.getRNG(),u="#",h=":",d="+";class p{constructor(e){this.coord={},this.map=r.default.copy2D(e),this.trimEmpty(),this.x=0,this.y=0,this.w=e.length,this.h=e[0].length;let t=0,n=0;r.default.forEach2D(e,(e,s,r)=>{this.coord[r]||(this.coord[r]=[]),this.coord[r].push([e,s]),r===h?(t+=e,n+=s):r===d&&(this.door=[e,s])}),this.floor=this.coord[h],this.walls=this.coord[u];const s=Object.values(this.coord[h]).length;this.cX=Math.round(t/s),this.cY=Math.round(n/s),this.numFloor=s}getCenter(){return[this.cX,this.cY]}isFloor(e){const[t,n]=e;return this.floor.findIndex(e=>e[0]===t&&e[1]===n)>=0}getFloorCenter(){let e=this.getCenter();if(this.isFloor(e))return e;const[t,n]=e;return l.Geometry.getBoxAround(t,n,1).forEach(t=>{this.isFloor(t)&&(e=t)}),e||r.default.err("House","getFloorCenter","No floor centerpoint found"),e}getBbox(){return{ulx:this.x,uly:this.y,lrx:this.x+this.w-1,lry:this.y+this.h-1}}trimEmpty(){}adjustCoord(e,t){const n=e-this.x,s=t-this.y;this.moveHouse(n,s)}moveHouse(e,t){this.x+=e,this.y+=t,Object.keys(this.coord).forEach(n=>{this.coord[n].forEach(n=>{n[0]+=e,n[1]+=t})}),this.cX+=e,this.cY+=t,this.door=[this.door[0]+e,this.door[1]+t]}addWindows(e){this.coord.windows=[];const t=this.coord[u].slice();let n=0;c.shuffle(t);const s={};t.forEach(e=>{s[e[0]+","+e[1]]=!0}),this.coord[d].forEach(e=>{s[e[0]+","+e[1]]=!1});for(let r=0;r<t.length&&n!==e;r++){const a=t[r],o=[];l.Geometry.getBoxAround(a[0],a[1],1).forEach(e=>{s[e[0]+","+e[1]]&&o.push(e)}),2===o.length&&(n<e||-1===e)&&this.windowPosOk(a,o)&&(this.coord.windows.push(a),s[a[0]+","+a[1]]=!1,++n)}return this.coord.windows.forEach(e=>{const t=this.walls.findIndex(t=>t[0]===e[0]&&t[1]===e[1]);this.walls.splice(t,1)}),n}windowPosOk(e,t){const[n,s]=e,[r,a]=t[0],[o,i]=t[1];return n===r?2===Math.abs(a-i):s===a&&2===Math.abs(r-o)}}t.House=p;t.HouseGenerator=class{constructor(){this.baseSizeX=3,this.baseSizeY=3}createHouse(e){const{cols:t,rows:n}=e,{fullHouse:s}=e,r=this.getGenParams(t,n),{genParamsX:i,genParamsY:l}=r;let{tilesX:u,tilesY:h}=r;if(!Number.isInteger(u)||!Number.isInteger(h)){if(!(u>1))return null;if(u=Math.floor(u),!(h>1))return null;h=Math.floor(h)}const d=new a.TemplateLevel(u,h);d.setFiller(o.Houses5x5.tiles.filler),d.setTemplates(o.Houses5x5.templates.all),d.setGenParams({x:i,y:l}),d.roomCount=-1,s&&(d.roomCount=u*h,d.roomCount-=1),d.setStartRoomFunc(o.Houses5x5.startRoomFunc),d.create();const f=new p(d.map);if(e.addWindows){const e=u*h;f.addWindows(c.getUniformInt(1,e))}return f}getGenParams(e,t){const n=this.baseSizeX,s=this.baseSizeY;let a=c.getUniformInt(1,3),o=c.getUniformInt(1,3),i=n+a+o,l=r.default.WATCHDOG;for(;e%i!=0&&(i=n+(a=c.getUniformInt(1,3))+(o=c.getUniformInt(1,3)),0!=--l););const u=e/i,h=[a,1,o];let d=c.getUniformInt(1,3),p=c.getUniformInt(1,3),f=s+d+p,m=r.default.WATCHDOG;for(;t%f!=0&&(f=s+(d=c.getUniformInt(1,3))+(p=c.getUniformInt(1,3)),0!=--m););return{tilesX:u,tilesY:t/f,genParamsX:h,genParamsY:[d,1,p]}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(67),o=n(9);t.Houses5x5={tiles:{},templates:{},Models:{}};const i=o.Random.getRNG();t.Houses5x5.tiles.start1x1=["\nname:start1x1_A\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##","\nname:start1x1_B\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n.ABC.\nD#:##\nE:::#\nF:::#\n##+##","\nname:start1x1_C\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n.ABC.\nD#:#.\nE::##\nF:::#\n##+##","\nname:start1x1_D\nA=.\nB=.\nC=.\nD=#\nE=#\nF=#\n\n.ABC.\nD###.\nE::##\nF:::#\n##+##"],t.Houses5x5.tiles.start1xN=["\ndir:N\nstartY:max\nstartX:first\nname:start1xN_A\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##","\ndir:N\nstartY:max\nstartX:first\nname:start1xN_B\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD#:##\nE:::#\nF:::#\n##+##","\ndir:N\nstartY:max\nstartX:first\nname:start1xN_C\nA=:\nB=:\nC=:\nD=#\nE=#\nF=.\n\n#ABC#\nD:::#\nE#:##\nF#:#.\n.#+#.","\ndir:N\nstartY:max\nstartX:first\nname:start1xD_C\nA=#\nB=:\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##"],t.Houses5x5.tiles.start2xN=["\ndir:NE\nstartX:first\nstartY:max\nname:start2xN_A\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE::::\nF:::#\n##+##","\ndir:NW\nstartX:max\nstartY:max\nname:start2xN_B\nA=#\nB=:\nC=#\nD=#\nE=:\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##"],t.Houses5x5.tiles.start2xN=t.Houses5x5.tiles.start2xN.concat(t.Houses5x5.tiles.start1xN),t.Houses5x5.tiles.start=["\ndir:NEW\nname:entrance2\nA=:\nB=:\nC=:\nD=#\nE=:\nF=#\n\n#ABC#\nD:::#\nE::::\nF:::#\n##+##","\ndir:NW\nname:entrance3\nA=#\nB=:\nC=#\nD=#\nE=:\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##"],t.Houses5x5.tiles.corners=["\ndir:SE\nname:corner1\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD::::\nE::::\nF:::#\n#::##","\ndir:SEW\nname:corner2\nA=#\nB=#\nC=#\nD=:\nE=:\nF=#\n\n#ABC#\nD::::\nE::::\nF:::#\n##:##","\ndir:SE\nname:corner3\nA=.\nB=.\nC=.\nD=#\nE=#\nF=#\n\n.ABC#\nD####\nE::::\nF:::#\n##:##","\ndir:NSEW\nname:corner4\nA=:\nB=:\nC=:\nD=:\nE=:\nF=:\n\n#ABC#\nD::::\nE::::\nF::::\n#:::#"],t.Houses5x5.tiles.body=["\ndir:NS\nname:corridor\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n#:::#","\ndir:NSEW\nname:body1\nA=:\nB=:\nC=:\nD=:\nE=:\nF=:\n\n#ABC#\nD::::\nE:#::\nF::::\n#:::#","\ndir:NSEW\nname:body_cross\nA=:\nB=:\nC=:\nD=:\nE=:\nF=:\n\n#ABC#\nD:#::\nE###:\nF:#::\n#:::#"],t.Houses5x5.tiles.terms=["\ndir:S\nname:term3x1\nA=.\nB=.\nC=.\nD=.\nE=.\nF=#\n\n.ABC.\nD....\nE....\nF####\n#:::#","\ndir:S\nname:term3x2\nA=.\nB=.\nC=.\nD=.\nE=#\nF=#\n\n.ABC.\nD....\nE####\nF:::#\n#:::#","\ndir:S\nname:term3x3\nA=.\nB=.\nC=.\nD=#\nE=#\nF=#\n\n.ABC.\nD####\nE:::#\nF:::#\n#:::#","\ndir:S\nname:term3x4\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n#:::#"],t.Houses5x5.tiles.blocker="\nname:BLOCKER\nA=.\nB=.\nC=.\nD=.\nE=.\nF=.\n\n.ABC.\nD....\nE....\nF....\n.....",t.Houses5x5.tiles.filler="\nname:FILLER\nA=.\nB=.\nC=.\nD=.\nE=.\nF=.\n\n.ABC.\nD....\nE....\nF....\n.....",t.Houses5x5.startRoomFunc=function(){if(1===this.tilesX&&1===this.tilesY)return{x:0,y:0,room:i.arrayGetRand(t.Houses5x5.templates.start1x1)};if(1===this.tilesX){const e=t.Houses5x5.templates.start1xN.filter(e=>!/(R90|R270)/i.test(e.getProp("name"))),n=i.arrayGetRand(e);let s=this.tilesY-1;return/R180/i.test(n.getProp("name"))&&(s=0),{x:0,y:s,room:n}}if(1===this.tilesY){const e=t.Houses5x5.templates.start1xN.filter(e=>/(R90|R270)/i.test(e.getProp("name"))),n=i.arrayGetRand(e);let s=0;return/R270/i.test(n.getProp("name"))&&(s=this.tilesX-1),{x:s,y:0,room:n}}if(2===this.tilesX||2===this.tilesY){const e=t.Houses5x5.templates.start2xN,n=i.arrayGetRand(e);let s=0,r=0;return"max"===n.getProp("startX")&&(s=this.tilesX-1),"max"===n.getProp("startY")&&(r=this.tilesY-1),{x:s,y:r,room:n}}const e=Math.floor(this.tilesX/2),n=Math.floor(this.tilesY/2),s=i.arrayGetRand(t.Houses5x5.tiles.start),r=a.Template.createTemplate(t.Houses5x5.tiles.blocker);for(let t=n;t<this.tilesY;t++)this.addRoom(r,e,t);return{x:e,y:n,room:a.Template.createTemplate(s)}},t.Houses5x5.Models.default=[].concat(t.Houses5x5.tiles.terms).concat(t.Houses5x5.tiles.body).concat(t.Houses5x5.tiles.corners),t.Houses5x5.tiles.all=t.Houses5x5.Models.default;function l(e){const t=e.getProp("startX"),n=e.getProp("startY");r.default.isNullOrUndef([t])||e.setProp("startY",t),"max"===n?e.setProp("startX","first"):"first"===n&&e.setProp("startX","max")}["all","start1x1","start1xN","start2xN"].forEach(e=>{t.Houses5x5.templates[e]=t.Houses5x5.tiles[e].map(e=>a.Template.createTemplate(e));const n=a.Template.transformList(t.Houses5x5.templates[e]);t.Houses5x5.templates[e]=t.Houses5x5.templates[e].concat(n)}),t.Houses5x5.templates.start2xN.forEach(e=>{const t=e.getProp("name");/_flip/.test(t)&&function(e){const t=e.getProp("startX");"max"===t?e.setProp("startX","first"):"first"===t&&e.setProp("startX","max")}(e),/R90/i.test(t)?l(e):/R180/i.test(t)?(l(e),l(e)):/R270/i.test(t)&&(l(e),l(e),l(e))})},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(23));n(83),t.MapForest=function(e,t,n){r.default.Map.call(this,e,t),this._options={nForests:5,forestSize:100,factor:6,rng:r.default.RNG};for(const e in n)this._options.hasOwnProperty(e)&&(this._options[e]=n[e])},t.MapForest.extend(r.default.Map),t.MapForest.prototype.create=function(e){const t=this._options.rng;this.map=this._fillMap(0);for(let e=0;e<this._options.nForests;e++){const e=t.getUniformInt(0,this._width-1),n=t.getUniformInt(0,this._height-1);this.drawForest(e,n,this._options.forestSize)}if(e)for(let t=0;t<this._height;t++)for(let n=0;n<this._width;n++)e(n,t,this.map[n][t])},t.MapForest.prototype.inBounds=function(e,t){return e>=0&&e<this._width&&t>=0&&t<this._height},t.MapForest.prototype.drawForest=function(e,t,n){let s=e,r=t;const a=this._options.rng;for(let e=1;e<=n;e++){const e=a.getUniformInt(0,this._options.factor),t=a.getUniformInt(0,this._options.factor),n=a.getUniformInt(0,this._options.factor),o=a.getUniformInt(0,this._options.factor);1===e&&(s-=1,this.inBounds(s,r)&&(this.map[s][r]=1)),1===n&&(s+=1,this.inBounds(s,r)&&(this.map[s][r]=1)),1===t&&(r+=1,this.inBounds(s,r)&&(this.map[s][r]=1)),1===o&&(r-=1,this.inBounds(s,r)&&(this.map[s][r]=1))}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(23)),a=s(n(8)),o=n(12),i=n(21);n(83);const l=n(17)("bitn:Map.Miner");t.MapMiner=function(e,t,n={}){r.default.Map.call(this,e,t,{});const s=e>t?t:e,a=Math.floor(e*t/s),o=Math.round(this._width/2),i=Math.round(this._height/2);if(this._options={addMiners:[],dontDig:!1,maxMinersCreated:a,minerSpawnProb:.07,smooth:!0,rng:r.default.RNG,startX:o,startY:i,nSmooth:2,dirWeights:{N:1,NE:1,E:1,SE:1,S:1,SW:1,W:1,NW:1}},!n.dirWeights){const n=e>t?t:e;Object.keys(this._options.dirWeights).forEach(s=>{this._options.dirWeights[s]*="W"===s||"E"===s?6*e:"S"===s||"N"===s?t:n})}for(const e in n)this._options.hasOwnProperty(e)&&(this._options[e]=n[e]);if(n.maxMinersOp){let e=this._options.maxMinersCreated;const{op:t,value:s}=n.maxMinersOp;switch(t){case"+":e+=s;break;case"-":e-=s;break;case"/":e/=s;break;case"*":e*=s;break;default:console.warn(`Op ${t} illegal`)}this._options.maxMinersCreated=Math.round(e)}this._hist={minerDir:{}},this._verifyRngFunctions()},t.MapMiner.extend(r.default.Map),t.MapMiner.prototype.dbg=function(e,...t){l.enabled&&console.log(e,...t)};t.MapMiner.prototype.create=function(e){const t=this._options.rng;this._map=this._fillMap(1);const n=this._options.maxMinersCreated,s=this._options.minerSpawnProb;let r=[{id:0,x:this._options.startX,y:this._options.startY,dirWeights:this._options.dirWeights}];this.minerID=1,Array.isArray(this._options.addMiners)&&this._options.addMiners.forEach(e=>{if(this.inBounds(e.x,e.y)){const t=Object.assign({},e);t.id=this.minerID++,t.dirWeights||(t.dirWeights=this._options.dirWeights),r.push(t)}else console.error(e,"out of level mining bounds. Not added")}),r.forEach(e=>{a.default.isNullOrUndef([e.x,e.y])?a.default.err("Map.Miner","create",`miner.x,y must exist. ${e}`):this._markAsDug(e.x,e.y)});let o=0,i=0,c=0,u=[],h=[],d=0;for(;i<n&&(l.enabled&&this.printMap(),this.dbg("Active miners: "+r.length),r.forEach(e=>{const[n,a]=this._getXYToDig(e);if(0===this._map[n][a]&&r.length>1)u.push(e);else if(this.inBounds(n,a)){if(t.getUniform()<=s){const t=this._tryToAddNew(e,n,a);t&&(h.push(t),++o),++i}this._markAsDug(n,a,e),e.x=n,e.y=a}else u.push(e)}),u.forEach(e=>{const t=r.findIndex(t=>e.id===t.id);if(r.length>1){const{id:n,x:s,y:a}=e;this.dbg(`remove miner ${n} at ${s}, ${a}`),++c,r.splice(t,1)}}),r=r.concat(h),h=[],u=[],!(d>100*this._width*this._height))&&0!==r.length;)++d;if(this._options.smooth&&this.smoothWalls(2),this.connect(),e)for(let t=0;t<this._height;t++)for(let n=0;n<this._width;n++)e(n,t,this._map[n][t]);this._hist.minersSpawned=i,this._hist.minersAdded=o,this._hist.minersRemoved=c},t.MapMiner.prototype._tryToAddNew=function(e,t,n){let[s,a]=this._getXYToDig({x:t,y:n,dirWeights:e.dirWeights}),o=null;const i=this._options.rng;if(1===this._map[t][n]&&this.inBounds(s,a))o={id:this.minerID++,x:s,y:a},e.dugCallback&&(o.dugCallback=e.dugCallback),this._markAsDug(s,a,o),this.dbg(e,"spawned new miner:",o);else{const t=i.getUniformInt(0,7),n=r.default.DIRS[8][t];s+=n[0],a+=n[1],this.inBounds(s,a)&&(o={id:this.minerID++,x:s,y:a},e.dugCallback&&(o.dugCallback=e.dugCallback),this._markAsDug(s,a,o),this.dbg(e,"(else) spawned new miner:",o))}return o&&(o.dirWeights=e.dirWeights),o},t.MapMiner.prototype.printMap=function(){for(let e=0;e<this._height;e++){let t="";for(let n=0;n<this._width;n++)t+=1===this._map[n][e]?"#":".";console.log(t)}},t.MapMiner.prototype._getXYToDig=function(e){const t=this._options.rng,n=o.Geometry.getBoxAround(e.x,e.y,1).filter(e=>1===this._map[e[0]][e[1]]&&this.inBounds(e[0],e[1]));if(0===n.length)return this.dbg("No wall cells around "+e.x+", "+e.y),[e.x,e.y];this.dbg("UndugXY is now "+n);const s=n.map(t=>{const n=[t[0]-e.x,t[1]-e.y];return a.default.dXdYToDir(n)}),r=e.dirWeights,i={};if(s.forEach(e=>{r[e]&&(i[e]=r[e])}),0===Object.keys(i).length)return[e.x,e.y];l.enabled&&this.dbg("dirsLeft: "+JSON.stringify(i));let c=t.getWeightedValue(i),u=a.default.dirTodXdY(c),[h,d]=[e.x+u[0],e.y+u[1]];for(this.dbg(`dir: ${c}, COMP: dXdY: ${u}, x,y: ${h},${d}`),this._hist.minerDir[c]||(this._hist.minerDir[c]=0),this._hist.minerDir[c]+=1;0===this._map[h][d]&&(delete i[c],0!==Object.keys(i).length);)c=t.getWeightedValue(i),u=a.default.dirTodXdY(c),[h,d]=[e.x+u[0],e.y+u[1]],this.dbg(`dir: ${c}, COMP: dXdY: ${u}, x,y: ${h},${d}`),this._hist.minerDir[c]||(this._hist.minerDir[c]=0),this._hist.minerDir[c]+=1;return this.dbg(`Next x,y to dig is ${h},${d}`),[h,d]},t.MapMiner.prototype.inBounds=function(e,t){if(this._options.dontDig)if(this._options.dontDig.ulx){const{ulx:n,uly:s,lrx:r,lry:a}=this._options.dontDig;if(e>=n&&e<=r&&t>=s&&t<=a)return!1}else if(this._options.dontDig[e+","+t])return!1;return e>=1&&e<this._width-1&&t>=1&&t<this._height-1},t.MapMiner.prototype.connect=function(){const{addMiners:e}=this._options;let t=!0;const n={},s={};if(e.length>0){const r=e.map(e=>[e.x,e.y]);r.push([this._options.startX,this._options.startY]);let a=-1;r.forEach(e=>{const r={},i=o.Geometry.floodfill2D(this._map,e,0,r,!0);if(0===i.length){throw new Error(`Floodfill from: ${e} returned 0 cells`)}const l=e[0]+","+e[1];n[l]=i,s[l]=r,-1===a?a=i.length:a!==i.length&&(t=!1)})}t?this._regions=[]:this.connectFilledRegions(n,s)},t.MapMiner.prototype.connectFilledRegions=function(e,t){const n={};let s=0,r=null;const a=this._options.rng;Object.keys(e).forEach(t=>{const a=e[t];n[t]=o.Geometry.getMassCenter(a),a.length>s&&(s=a.length,r=t)});const i=[];this._regions=[],this._regions.push([e[r]]),Object.keys(n).forEach(n=>{if(n!==r){t[n][r]||(i.push(n),this._regions.push([e[n]]))}});const[l,c]=n[r];this._paths=[],i.forEach(e=>{const[t,s]=n[e],r=this._getPath(l,c,t,s);r.forEach(e=>{let t=a.getUniformInt(1,3);this._options.connWidth&&(t=this._options.connWidth),o.Geometry.getCrossCaveConn(e.x,e.y,t,!0).forEach(e=>{const[t,n]=e;this.inBounds(t,n)&&(this._map[t][n]=0)})}),this._paths.push(r)})},t.MapMiner.prototype.getMapData=function(){const e=this._options.addMiners,t=e.map(e=>[e.x,e.y]);return t.push([this._options.startX,this._options.startY]),{nRegions:1+e.length,regions:this._regions,startPoints:t,paths:this._paths}},t.MapMiner.prototype._getPath=function(e,t,n,s){return i.Path.getShortestPath(e,t,n,s)},t.MapMiner.prototype.smoothWalls=function(e){for(let t=0;t<e;t++)for(let e=1;e<this._width-1;e++)for(let t=1;t<this._height-1;t++)if(1===this._map[e][t]){const n=o.Geometry.getCrossAround(e,t,1);let s=0;n.forEach(e=>{this.inBounds(e[0],e[1])&&this._map[e[0]][e[1]]&&++s}),this.inBounds(e,t)&&s<this._options.nSmooth&&this._markAsDug(e,t)}},t.MapMiner.prototype._markAsDug=function(e,t,n){e<this._minX&&(this._minX=e),e>this._maxX&&(this._maxX=e),t<this._minY&&(this._minY=t),t>this._maxY&&(this._maxY=t),this._map[e][t]=0,this._options.dugCallback&&this._options.dugCallback(e,t,n),n&&n.dugCallback&&n.dugCallback(e,t,n)},t.MapMiner.prototype._verifyRngFunctions=function(){const{rng:e}=this._options,t=["getUniform","getUniformInt","getWeightedValue"];t.forEach(n=>{if("function"!=typeof e[n]){let e=`RNG must have functions: ${t}.`;throw new Error(e+="See ROT.RNG for example (you can use it)")}})}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(23)),a=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];t.MapMountain=function(e,t,n){if(r.default.Map.call(this,e,t),this._options={gradients:a,noiseMult:1,noiseDivider:20,rng:r.default.RNG},n)for(const e in this._options)this._options.hasOwnProperty(e)&&n.hasOwnProperty(e)&&(this._options[e]=n[e]);this.noise=new r.default.Noise.Simplex},t.MapMountain.extend(r.default.Map),t.MapMountain.prototype.create=function(e){const t=this._fillMap(0);for(let e=0;e<this._width;e++)for(let n=0;n<this._height;n++){const s=this.noise.get(e/this._options.noiseDivider,n/this._options.noiseDivider)*this._options.noiseMult;t[e][n]=s}for(let n=0;n<this._width;n++)for(let s=0;s<this._height;s++)e(n,s,t[n][s])},t.MapMountain.gradients=a},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(23));function a(e,t,n){const s=2*n+1;let r=0;for(let s=t-n;s<=t+n;s++)s>=0&&s<e.length&&(r+=e[s]);return Math.floor(r/s)}n(83),t.MapWall=function(e,t,n){if(r.default.Map.call(this,e,t),this._options={north:!1,south:!1,east:!0,west:!0,alignVertical:"center",alignHorizontal:"center",meanWx:5,meanWy:5,stdDev:3,filterW:3,rng:r.default.RNG},n)for(const e in this._options)this._options.hasOwnProperty(e)&&n.hasOwnProperty(e)&&(this._options[e]=n[e])},t.MapWall.extend(r.default.Map),t.MapWall.prototype.create=function(e){const t=this._fillMap(0),n=this._options.north,s=this._options.south,r=this._options.east,a=this._options.west,{alignVertical:o,alignHorizontal:i}=this._options,l=this._width,c=this._height,u=Math.floor(l/2),h=Math.floor(c/2),d=this._options.meanWx,p=this._options.meanWy,f=this._options.stdDev,m=this._options.filterW;let g=null,y=-1,v=-1;n&&s?(y=0,v=c-1):n?(y=0,v=h-1):s&&(y=h,v=c-1),this._wallNS=[];let _=this.getWidthMovingAvg(v+1,d,f,l,m);if(n||s)for(let e=y;e<=v;e++){const n=[];1===(g=_[e-y])&&(g=d);let s=u-(g-1),r=u+(g-1);"center"===i||("left"===i?r=(s=0)+(g-1):"right"===i&&(s=this._width-(g-1),r=this._width-1));for(let a=s;a<=r;a++)t[a][e]=1,n.push([a,e]);this._wallNS.push(n)}let b=-1,E=-1;if(r&&a?(b=0,E=l-1):r?(b=u,E=l-1):a&&(b=0,E=u-1),this._wallEW=[],_=this.getWidthMovingAvg(E+1,p,f,c,m),r||a)for(let e=b;e<=E;e++){const n=[];1===(g=_[e-b])&&(g=p);let s=h-(g-1),r=h+(g-1);"center"===o||("top"===o?r=(s=0)+(g-1):"bottom"===o&&(s=this._height-(g-1),r=this._height-1));for(let a=s;a<=r;a++)t[e][a]=1,n.push([e,a]);this._wallEW.push(n)}for(let n=0;n<this._width;n++)for(let s=0;s<this._height;s++)e(n,s,t[n][s])},t.MapWall.prototype.getWidthMovingAvg=function(e,t,n,s,r){const o=[];for(let r=0;r<e;r++)o.push(this.getWallWidth(t,n,s));let i=[];for(let e=0;e<r;e++)i.push(o[e]);for(let t=r;t<e-r;t++){const e=a(o,t,r);i.push(e)}for(let t=e-r;t<e;t++)i.length<o.length&&i.push(o[t]);return i=i.map(e=>Math.round(e))},t.MapWall.prototype.getWallWidth=function(e,t,n){const s=this._options.rng;let r=Math.floor(s.getNormal(e,t));return r>n/2?r=n/2-1:r<1&&(r=1),r}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ActorMods={},t.ActorMods.bearfolk={description:"",stats:{agility:-2,strength:3},player:{}},t.ActorMods.catfolk={stats:{agility:3,perception:2,strength:-2},player:{}},t.ActorMods.dogfolk={stats:{agility:2,perception:3},player:{}},t.ActorMods.dwarf={stats:{agility:-1,strength:2,willpower:1},player:{}},t.ActorMods.goblin={stats:{accuracy:1,agility:2},player:{}},t.ActorMods.human={stats:{accuracy:3,magic:1,willpower:1},player:{}},t.ActorMods.hyrkhian={stats:{magic:2,willpower:2},player:{}},t.ActorMods.wildling={stats:{accuracy:1,agility:1,perception:4},player:{}},t.ActorMods.wolfclan={stats:{strength:1,magic:2,willpower:2},player:{}}},function(e,t,n){n(338),e.exports=n(36).Object.assign},function(e,t,n){var s=n(47);s(s.S+s.F,"Object",{assign:n(340)})},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,n){"use strict";var s=n(93),r=n(148),a=n(94),o=n(149),i=n(199),l=Object.assign;e.exports=!l||n(91)(function(){var e={},t={},n=Symbol(),s="abcdefghijklmnopqrst";return e[n]=7,s.split("").forEach(function(e){t[e]=e}),7!=l({},e)[n]||Object.keys(l({},t)).join("")!=s})?function(e,t){for(var n=o(e),l=arguments.length,c=1,u=r.f,h=a.f;l>c;)for(var d,p=i(arguments[c++]),f=u?s(p).concat(u(p)):s(p),m=f.length,g=0;m>g;)h.call(p,d=f[g++])&&(n[d]=p[d]);return n}:l},function(e,t,n){var s=n(57),r=n(200),a=n(342);e.exports=function(e){return function(t,n,o){var i,l=s(t),c=r(l.length),u=a(o,c);if(e&&n!=n){for(;c>u;)if((i=l[u++])!=i)return!0}else for(;c>u;u++)if((e||u in l)&&l[u]===n)return e||u||0;return!e&&-1}}},function(e,t,n){var s=n(144),r=Math.max,a=Math.min;e.exports=function(e,t){return(e=s(e))<0?r(e+t,0):a(e,t)}},function(e,t,n){e.exports={default:n(344),__esModule:!0}},function(e,t,n){n(201),n(350),e.exports=n(153).f("iterator")},function(e,t,n){var s=n(144),r=n(143);e.exports=function(e){return function(t,n){var a,o,i=String(r(t)),l=s(n),c=i.length;return l<0||l>=c?e?"":void 0:(a=i.charCodeAt(l))<55296||a>56319||l+1===c||(o=i.charCodeAt(l+1))<56320||o>57343?e?i.charAt(l):a:e?i.slice(l,l+2):o-56320+(a-55296<<10)+65536}}},function(e,t,n){"use strict";var s=n(151),r=n(92),a=n(152),o={};n(69)(o,n(37)("iterator"),function(){return this}),e.exports=function(e,t,n){e.prototype=s(o,{next:r(1,n)}),a(e,t+" Iterator")}},function(e,t,n){var s=n(55),r=n(70),a=n(93);e.exports=n(72)?Object.defineProperties:function(e,t){r(e);for(var n,o=a(t),i=o.length,l=0;i>l;)s.f(e,n=o[l++],t[n]);return e}},function(e,t,n){var s=n(48).document;e.exports=s&&s.documentElement},function(e,t,n){var s=n(56),r=n(149),a=n(145)("IE_PROTO"),o=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=r(e),s(e,a)?e[a]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?o:null}},function(e,t,n){n(351);for(var s=n(48),r=n(69),a=n(95),o=n(37)("toStringTag"),i="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),l=0;l<i.length;l++){var c=i[l],u=s[c],h=u&&u.prototype;h&&!h[o]&&r(h,o,c),a[c]=a.Array}},function(e,t,n){"use strict";var s=n(352),r=n(353),a=n(95),o=n(57);e.exports=n(202)(Array,"Array",function(e,t){this._t=o(e),this._i=0,this._k=t},function(){var e=this._t,t=this._k,n=this._i++;return!e||n>=e.length?(this._t=void 0,r(1)):r(0,"keys"==t?n:"values"==t?e[n]:[n,e[n]])},"values"),a.Arguments=a.Array,s("keys"),s("values"),s("entries")},function(e,t){e.exports=function(){}},function(e,t){e.exports=function(e,t){return{value:t,done:!!e}}},function(e,t,n){e.exports={default:n(355),__esModule:!0}},function(e,t,n){n(356),n(361),n(362),n(363),e.exports=n(36).Symbol},function(e,t,n){"use strict";var s=n(48),r=n(56),a=n(72),o=n(47),i=n(203),l=n(357).KEY,c=n(91),u=n(146),h=n(152),d=n(110),p=n(37),f=n(153),m=n(154),g=n(358),y=n(359),v=n(70),_=n(71),b=n(57),E=n(141),S=n(92),C=n(151),w=n(360),T=n(205),O=n(55),M=n(93),A=T.f,N=O.f,P=w.f,x=s.Symbol,I=s.JSON,D=I&&I.stringify,k=p("_hidden"),L=p("toPrimitive"),R={}.propertyIsEnumerable,B=u("symbol-registry"),G=u("symbols"),F=u("op-symbols"),W=Object.prototype,Y="function"==typeof x,j=s.QObject,X=!j||!j.prototype||!j.prototype.findChild,U=a&&c(function(){return 7!=C(N({},"a",{get:function(){return N(this,"a",{value:7}).a}})).a})?function(e,t,n){var s=A(W,t);s&&delete W[t],N(e,t,n),s&&e!==W&&N(W,t,s)}:N,$=function(e){var t=G[e]=C(x.prototype);return t._k=e,t},K=Y&&"symbol"==typeof x.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof x},V=function(e,t,n){return e===W&&V(F,t,n),v(e),t=E(t,!0),v(n),r(G,t)?(n.enumerable?(r(e,k)&&e[k][t]&&(e[k][t]=!1),n=C(n,{enumerable:S(0,!1)})):(r(e,k)||N(e,k,S(1,{})),e[k][t]=!0),U(e,t,n)):N(e,t,n)},H=function(e,t){v(e);for(var n,s=g(t=b(t)),r=0,a=s.length;a>r;)V(e,n=s[r++],t[n]);return e},q=function(e){var t=R.call(this,e=E(e,!0));return!(this===W&&r(G,e)&&!r(F,e))&&(!(t||!r(this,e)||!r(G,e)||r(this,k)&&this[k][e])||t)},J=function(e,t){if(e=b(e),t=E(t,!0),e!==W||!r(G,t)||r(F,t)){var n=A(e,t);return!n||!r(G,t)||r(e,k)&&e[k][t]||(n.enumerable=!0),n}},z=function(e){for(var t,n=P(b(e)),s=[],a=0;n.length>a;)r(G,t=n[a++])||t==k||t==l||s.push(t);return s},Q=function(e){for(var t,n=e===W,s=P(n?F:b(e)),a=[],o=0;s.length>o;)!r(G,t=s[o++])||n&&!r(W,t)||a.push(G[t]);return a};Y||(i((x=function(){if(this instanceof x)throw TypeError("Symbol is not a constructor!");var e=d(arguments.length>0?arguments[0]:void 0),t=function(n){this===W&&t.call(F,n),r(this,k)&&r(this[k],e)&&(this[k][e]=!1),U(this,e,S(1,n))};return a&&X&&U(W,e,{configurable:!0,set:t}),$(e)}).prototype,"toString",function(){return this._k}),T.f=J,O.f=V,n(204).f=w.f=z,n(94).f=q,n(148).f=Q,a&&!n(150)&&i(W,"propertyIsEnumerable",q,!0),f.f=function(e){return $(p(e))}),o(o.G+o.W+o.F*!Y,{Symbol:x});for(var Z="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),ee=0;Z.length>ee;)p(Z[ee++]);for(var te=M(p.store),ne=0;te.length>ne;)m(te[ne++]);o(o.S+o.F*!Y,"Symbol",{for:function(e){return r(B,e+="")?B[e]:B[e]=x(e)},keyFor:function(e){if(!K(e))throw TypeError(e+" is not a symbol!");for(var t in B)if(B[t]===e)return t},useSetter:function(){X=!0},useSimple:function(){X=!1}}),o(o.S+o.F*!Y,"Object",{create:function(e,t){return void 0===t?C(e):H(C(e),t)},defineProperty:V,defineProperties:H,getOwnPropertyDescriptor:J,getOwnPropertyNames:z,getOwnPropertySymbols:Q}),I&&o(o.S+o.F*(!Y||c(function(){var e=x();return"[null]"!=D([e])||"{}"!=D({a:e})||"{}"!=D(Object(e))})),"JSON",{stringify:function(e){for(var t,n,s=[e],r=1;arguments.length>r;)s.push(arguments[r++]);if(n=t=s[1],(_(t)||void 0!==e)&&!K(e))return y(t)||(t=function(e,t){if("function"==typeof n&&(t=n.call(this,e,t)),!K(t))return t}),s[1]=t,D.apply(I,s)}}),x.prototype[L]||n(69)(x.prototype,L,x.prototype.valueOf),h(x,"Symbol"),h(Math,"Math",!0),h(s.JSON,"JSON",!0)},function(e,t,n){var s=n(110)("meta"),r=n(71),a=n(56),o=n(55).f,i=0,l=Object.isExtensible||function(){return!0},c=!n(91)(function(){return l(Object.preventExtensions({}))}),u=function(e){o(e,s,{value:{i:"O"+ ++i,w:{}}})},h=e.exports={KEY:s,NEED:!1,fastKey:function(e,t){if(!r(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!a(e,s)){if(!l(e))return"F";if(!t)return"E";u(e)}return e[s].i},getWeak:function(e,t){if(!a(e,s)){if(!l(e))return!0;if(!t)return!1;u(e)}return e[s].w},onFreeze:function(e){return c&&h.NEED&&l(e)&&!a(e,s)&&u(e),e}}},function(e,t,n){var s=n(93),r=n(148),a=n(94);e.exports=function(e){var t=s(e),n=r.f;if(n)for(var o,i=n(e),l=a.f,c=0;i.length>c;)l.call(e,o=i[c++])&&t.push(o);return t}},function(e,t,n){var s=n(142);e.exports=Array.isArray||function(e){return"Array"==s(e)}},function(e,t,n){var s=n(57),r=n(204).f,a={}.toString,o="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];e.exports.f=function(e){return o&&"[object Window]"==a.call(e)?function(e){try{return r(e)}catch(e){return o.slice()}}(e):r(s(e))}},function(e,t){},function(e,t,n){n(154)("asyncIterator")},function(e,t,n){n(154)("observable")},function(e,t,n){e.exports={default:n(365),__esModule:!0}},function(e,t,n){n(366),e.exports=n(36).Object.setPrototypeOf},function(e,t,n){var s=n(47);s(s.S,"Object",{setPrototypeOf:n(367).set})},function(e,t,n){var s=n(71),r=n(70),a=function(e,t){if(r(e),!s(t)&&null!==t)throw TypeError(t+": can't set as prototype!")};e.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(e,t,s){try{(s=n(140)(Function.call,n(205).f(Object.prototype,"__proto__").set,2))(e,[]),t=!(e instanceof Array)}catch(e){t=!0}return function(e,n){return a(e,n),t?e.__proto__=n:s(e,n),e}}({},!1):void 0),check:a}},function(e,t,n){e.exports={default:n(369),__esModule:!0}},function(e,t,n){n(370);var s=n(36).Object;e.exports=function(e,t){return s.create(e,t)}},function(e,t,n){var s=n(47);s(s.S,"Object",{create:n(151)})},function(e,t,n){n(372),e.exports=n(36).Object.entries},function(e,t,n){var s=n(47),r=n(206)(!0);s(s.S,"Object",{entries:function(e){return r(e)}})},function(e,t,n){n(374),e.exports=n(36).Object.values},function(e,t,n){var s=n(47),r=n(206)(!1);s(s.S,"Object",{values:function(e){return r(e)}})},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e};t.default=function(e,t){return function n(i,l){var c,u;var h=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];var d,p=i.displayName||i.name||"Component",f=o.getType(i).propTypes,m=o.isReactComponent(i),g=Object.keys(l);var y=["valueLink","checkedLink"].concat(g.map(o.defaultKey));d=o.uncontrolledPropTypes(l,f,p);(0,a.default)(m||!h.length,"[uncontrollable] stateless function components cannot pass through methods because they have no associated instances. Check component: "+p+", attempting to pass through methods: "+h.join(", "));h=o.transform(h,function(e,t){e[t]=function(){var e;return(e=this.refs.inner)[t].apply(e,arguments)}},{});var v=(u=c=function(n){function a(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,n.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(a,n),a.prototype.shouldComponentUpdate=function(){for(var t=arguments.length,n=Array(t),s=0;s<t;s++)n[s]=arguments[s];return!e.shouldComponentUpdate||e.shouldComponentUpdate.apply(this,n)},a.prototype.componentWillMount=function(){var e=this,t=this.props;this._values={},g.forEach(function(n){e._values[n]=t[o.defaultKey(n)]})},a.prototype.componentWillReceiveProps=function(t){var n=this,s=this.props;e.componentWillReceiveProps&&e.componentWillReceiveProps.call(this,t),g.forEach(function(e){void 0===o.getValue(t,e)&&void 0!==o.getValue(s,e)&&(n._values[e]=t[o.defaultKey(e)])})},a.prototype.componentWillUnmount=function(){this.unmounted=!0},a.prototype.getControlledInstance=function(){return this.refs.inner},a.prototype.render=function(){var e=this,n={},a=function(e){var t={};return o.each(e,function(e,n){-1===y.indexOf(n)&&(t[n]=e)}),t}(this.props);return o.each(l,function(s,r){var a=o.getLinkName(r),i=e.props[r];a&&!_(e.props,r)&&_(e.props,a)&&(i=e.props[a].value),n[r]=void 0!==i?i:e._values[r],n[s]=function(e,n){var s=o.getLinkName(e),r=this.props[l[e]];s&&_(this.props,s)&&!r&&(r=this.props[s].requestChange);for(var a=arguments.length,i=Array(a>2?a-2:0),c=2;c<a;c++)i[c-2]=arguments[c];t(this,e,r,n,i)}.bind(e,r)}),n=s({},a,n,{ref:m?"inner":null}),r.default.createElement(i,n)},a}(r.default.Component),c.displayName="Uncontrolled("+p+")",c.propTypes=d,u);s(v.prototype,h);v.ControlledComponent=i;v.deferControlTo=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments[2];return n(e,s({},l,t),r)};return v;function _(e,t){return void 0!==e[t]}}};var r=i(n(1)),a=i(n(77)),o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(376));function i(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.version=void 0,t.uncontrolledPropTypes=function(e,t,n){0;return{}},t.getType=function(e){return a[0]>=15||0===a[0]&&a[1]>=13?e:e.type},t.getValue=function(e,t){var n=i(t);return n&&!o(e,t)&&o(e,n)?e[n].value:e[t]},t.getLinkName=i,t.defaultKey=l,t.chain=function(e,t,n){return function(){for(var s=arguments.length,r=Array(s),a=0;a<s;a++)r[a]=arguments[a];t&&t.call.apply(t,[e].concat(r)),n&&n.call.apply(n,[e].concat(r))}},t.transform=function(e,t,n){return c(e,t.bind(null,n=n||(Array.isArray(e)?[]:{}))),n},t.each=c,t.has=u,t.isReactComponent=function(e){return!!(e&&e.prototype&&e.prototype.isReactComponent)};var s=r(n(1));r(n(77));function r(e){return e&&e.__esModule?e:{default:e}}var a=t.version=s.default.version.split(".").map(parseFloat);function o(e,t){return void 0!==e[t]}function i(e){return"value"===e?"valueLink":"checked"===e?"checkedLink":null}function l(e){return"default"+e.charAt(0).toUpperCase()+e.substr(1)}function c(e,t,n){if(Array.isArray(e))return e.forEach(t,n);for(var s in e)u(e,s)&&t.call(n,e[s],s,e)}function u(e,t){return!!e&&Object.prototype.hasOwnProperty.call(e,t)}},function(e,t,n){n(201),n(378),e.exports=n(36).Array.from},function(e,t,n){"use strict";var s=n(140),r=n(47),a=n(149),o=n(379),i=n(380),l=n(200),c=n(381),u=n(382);r(r.S+r.F*!n(384)(function(e){Array.from(e)}),"Array",{from:function(e){var t,n,r,h,d=a(e),p="function"==typeof this?this:Array,f=arguments.length,m=f>1?arguments[1]:void 0,g=void 0!==m,y=0,v=u(d);if(g&&(m=s(m,f>2?arguments[2]:void 0,2)),null==v||p==Array&&i(v))for(n=new p(t=l(d.length));t>y;y++)c(n,y,g?m(d[y],y):d[y]);else for(h=v.call(d),n=new p;!(r=h.next()).done;y++)c(n,y,g?o(h,m,[r.value,y],!0):r.value);return n.length=y,n}})},function(e,t,n){var s=n(70);e.exports=function(e,t,n,r){try{return r?t(s(n)[0],n[1]):t(n)}catch(t){var a=e.return;throw void 0!==a&&s(a.call(e)),t}}},function(e,t,n){var s=n(95),r=n(37)("iterator"),a=Array.prototype;e.exports=function(e){return void 0!==e&&(s.Array===e||a[r]===e)}},function(e,t,n){"use strict";var s=n(55),r=n(92);e.exports=function(e,t,n){t in e?s.f(e,t,r(0,n)):e[t]=n}},function(e,t,n){var s=n(383),r=n(37)("iterator"),a=n(95);e.exports=n(36).getIteratorMethod=function(e){if(null!=e)return e[r]||e["@@iterator"]||a[s(e)]}},function(e,t,n){var s=n(142),r=n(37)("toStringTag"),a="Arguments"==s(function(){return arguments}());e.exports=function(e){var t,n,o;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),r))?n:a?s(t):"Object"==(o=s(t))&&"function"==typeof t.callee?"Arguments":o}},function(e,t,n){var s=n(37)("iterator"),r=!1;try{var a=[7][s]();a.return=function(){r=!0},Array.from(a,function(){throw 2})}catch(e){}e.exports=function(e,t){if(!t&&!r)return!1;var n=!1;try{var a=[7],o=a[s]();o.next=function(){return{done:n=!0}},a[s]=function(){return o},e(a)}catch(e){}return n}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return function(n){var a=n.currentTarget,o=n.target,i=(0,r.default)(a,e);i.some(function(e){return(0,s.default)(e,o)})&&t.call(this,n)}};var s=a(n(42)),r=a(n(386));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var n,a="#"===t[0],o="."===t[0],i=a||o?t.slice(1):t;if(s.test(i))return a?(e=e.getElementById?e:document,(n=e.getElementById(i))?[n]:[]):e.getElementsByClassName&&o?r(e.getElementsByClassName(i)):r(e.getElementsByTagName(t));return r(e.querySelectorAll(t))};var s=/^[\w-]*$/,r=Function.prototype.bind.call(Function.prototype.call,[].slice);e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=o(n(33)),r=o(n(82)),a=o(n(102));function o(e){return e&&e.__esModule?e:{default:e}}var i=function(){};s.default&&(i=function(e,t,n,s){return(0,r.default)(e,t,n,s),function(){(0,a.default)(e,t,n,s)}}),t.default=i,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=i;var s,r=n(24),a=(s=r)&&s.__esModule?s:{default:s};var o={};function i(e,t){return function(n,s,r,i,l){var c=r||"<<anonymous>>",u=l||s;if(null!=n[s]){var h=r+"."+s;(0,a.default)(o[h],"The "+i+" `"+u+"` of `"+c+"` is deprecated. "+t+"."),o[h]=!0}for(var d=arguments.length,p=Array(d>5?d-5:0),f=5;f<d;f++)p[f-5]=arguments[f];return e.apply(void 0,[n,s,r,i,l].concat(p))}}i._resetWarned=function(){o={}},e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=l(n(172)),r=l(n(49)),a=l(n(76)),o=l(n(168)),i=n(390);function l(e){return e&&e.__esModule?e:{default:e}}t.default=function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},l=n.hideSiblingNodes,c=void 0===l||l,u=n.handleContainerOverflow,h=void 0===u||u;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.add=function(e,n,l){var c=t.modals.indexOf(e),u=t.containers.indexOf(n);if(-1!==c)return c;if(c=t.modals.length,t.modals.push(e),t.hideSiblingNodes&&(0,i.hideSiblings)(n,e.mountNode),-1!==u)return t.data[u].modals.push(e),c;var h={modals:[e],classes:l?l.split(/\s+/):[],overflowing:(0,o.default)(n)};return t.handleContainerOverflow&&function(e,t){var n={overflow:"hidden"};e.style={overflow:t.style.overflow,paddingRight:t.style.paddingRight},e.overflowing&&(n.paddingRight=parseInt((0,r.default)(t,"paddingRight")||0,10)+(0,a.default)()+"px"),(0,r.default)(t,n)}(h,n),h.classes.forEach(s.default.addClass.bind(null,n)),t.containers.push(n),t.data.push(h),c},this.remove=function(e){var n=t.modals.indexOf(e);if(-1!==n){var r=function(e,t){return n=function(e){return-1!==e.modals.indexOf(t)},s=-1,e.some(function(e,t){if(n(e,t))return s=t,!0}),s;var n,s}(t.data,e),a=t.data[r],o=t.containers[r];a.modals.splice(a.modals.indexOf(e),1),t.modals.splice(n,1),0===a.modals.length?(a.classes.forEach(s.default.removeClass.bind(null,o)),t.handleContainerOverflow&&function(e,t){var n=e.style;Object.keys(n).forEach(function(e){return t.style[e]=n[e]})}(a,o),t.hideSiblingNodes&&(0,i.showSiblings)(o,e.mountNode),t.containers.splice(r,1),t.data.splice(r,1)):t.hideSiblingNodes&&(0,i.ariaHidden)(!1,a.modals[a.modals.length-1].mountNode)}},this.isTopModal=function(e){return!!t.modals.length&&t.modals[t.modals.length-1]===e},this.hideSiblingNodes=c,this.handleContainerOverflow=h,this.modals=[],this.containers=[],this.data=[]},e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.ariaHidden=a,t.hideSiblings=function(e,t){r(e,t,function(e){return a(!0,e)})},t.showSiblings=function(e,t){r(e,t,function(e){return a(!1,e)})};var s=["template","script","style"],r=function(e,t,n){t=[].concat(t),[].forEach.call(e.children,function(e){var r,a,o;-1===t.indexOf(e)&&(a=(r=e).nodeType,o=r.tagName,1===a&&-1===s.indexOf(o.toLowerCase()))&&n(e)})};function a(e,t){t&&(e?t.setAttribute("aria-hidden","true"):t.removeAttribute("aria-hidden"))}},function(e,t,n){"use strict";t.__esModule=!0;var s=c(n(0)),r=c(n(111)),a=c(n(1)),o=c(n(13)),i=c(n(112)),l=c(n(73));function c(e){return e&&e.__esModule?e:{default:e}}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var h=function(e){function t(){var n,s;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var r=arguments.length,c=Array(r),h=0;h<r;h++)c[h]=arguments[h];return n=s=u(this,e.call.apply(e,[this].concat(c))),s._mountOverlayTarget=function(){s._overlayTarget||(s._overlayTarget=document.createElement("div"),s._portalContainerNode=(0,i.default)(s.props.container,(0,l.default)(s).body),s._portalContainerNode.appendChild(s._overlayTarget))},s._unmountOverlayTarget=function(){s._overlayTarget&&(s._portalContainerNode.removeChild(s._overlayTarget),s._overlayTarget=null),s._portalContainerNode=null},s._renderOverlay=function(){var e=s.props.children?a.default.Children.only(s.props.children):null;if(null!==e){s._mountOverlayTarget();var t=!s._overlayInstance;s._overlayInstance=o.default.unstable_renderSubtreeIntoContainer(s,e,s._overlayTarget,function(){t&&s.props.onRendered&&s.props.onRendered()})}else s._unrenderOverlay(),s._unmountOverlayTarget()},s._unrenderOverlay=function(){s._overlayTarget&&(o.default.unmountComponentAtNode(s._overlayTarget),s._overlayInstance=null)},s.getMountNode=function(){return s._overlayTarget},u(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this._isMounted=!0,this._renderOverlay()},t.prototype.componentDidUpdate=function(){this._renderOverlay()},t.prototype.componentWillReceiveProps=function(e){this._overlayTarget&&e.container!==this.props.container&&(this._portalContainerNode.removeChild(this._overlayTarget),this._portalContainerNode=(0,i.default)(e.container,(0,l.default)(this).body),this._portalContainerNode.appendChild(this._overlayTarget))},t.prototype.componentWillUnmount=function(){this._isMounted=!1,this._unrenderOverlay(),this._unmountOverlayTarget()},t.prototype.render=function(){return null},t}(a.default.Component);h.displayName="Portal",h.propTypes={container:s.default.oneOfType([r.default,s.default.func]),onRendered:s.default.func},t.default=h,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=a(n(0)),r=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}var o={children:s.default.node},i=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.render=function(){return this.props.children},t}(r.default.Component);i.propTypes=o,t.default=i,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e){var t=!document.addEventListener,n=void 0;t?(document.attachEvent("onfocusin",e),n=function(){return document.detachEvent("onfocusin",e)}):(document.addEventListener("focus",e,!0),n=function(){return document.removeEventListener("focus",e,!0)});return{remove:n}},e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=p(n(3)),a=p(n(0)),o=p(n(111)),i=n(1),l=p(i),c=p(n(13)),u=p(n(395)),h=p(n(112)),d=p(n(73));function p(e){return e&&e.__esModule?e:{default:e}}function f(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}var m=function(e){function t(n,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.call(this,n,s));return r.getTarget=function(){var e=r.props.target,t="function"==typeof e?e():e;return t&&c.default.findDOMNode(t)||null},r.maybeUpdatePosition=function(e){var t=r.getTarget();(r.props.shouldUpdatePosition||t!==r._lastTarget||e)&&r.updatePosition(t)},r.state={positionLeft:0,positionTop:0,arrowOffsetLeft:null,arrowOffsetTop:null},r._needsFlush=!1,r._lastTarget=null,r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this.updatePosition(this.getTarget())},t.prototype.componentWillReceiveProps=function(){this._needsFlush=!0},t.prototype.componentDidUpdate=function(e){this._needsFlush&&(this._needsFlush=!1,this.maybeUpdatePosition(this.props.placement!==e.placement))},t.prototype.render=function(){var e=this.props,t=e.children,n=e.className,a=f(e,["children","className"]),o=this.state,c=o.positionLeft,u=o.positionTop,h=f(o,["positionLeft","positionTop"]);delete a.target,delete a.container,delete a.containerPadding,delete a.shouldUpdatePosition;var d=l.default.Children.only(t);return(0,i.cloneElement)(d,s({},a,h,{positionLeft:c,positionTop:u,className:(0,r.default)(n,d.props.className),style:s({},d.props.style,{left:c,top:u})}))},t.prototype.updatePosition=function(e){if(this._lastTarget=e,e){var t=c.default.findDOMNode(this),n=(0,h.default)(this.props.container,(0,d.default)(this).body);this.setState((0,u.default)(this.props.placement,t,e,n,this.props.containerPadding))}else this.setState({positionLeft:0,positionTop:0,arrowOffsetLeft:null,arrowOffsetTop:null})},t}(l.default.Component);m.propTypes={target:a.default.oneOfType([o.default,a.default.func]),container:a.default.oneOfType([o.default,a.default.func]),containerPadding:a.default.number,placement:a.default.oneOf(["top","right","bottom","left"]),shouldUpdatePosition:a.default.bool},m.displayName="Position",m.defaultProps={containerPadding:0,placement:"right",shouldUpdatePosition:!1},t.default=m,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t,n,a,o){var i="BODY"===a.tagName?(0,s.default)(n):(0,r.default)(n,a),c=(0,s.default)(t),u=c.height,h=c.width,d=void 0,p=void 0,f=void 0,m=void 0;if("left"===e||"right"===e){p=i.top+(i.height-u)/2,d="left"===e?i.left-h:i.left+i.width;var g=function(e,t,n,s){var r=l(n),a=r.scroll,o=r.height,i=e-s-a,c=e+s-a+t;return i<0?-i:c>o?o-c:0}(p,u,a,o);p+=g,m=50*(1-2*g/u)+"%",f=void 0}else{if("top"!==e&&"bottom"!==e)throw new Error('calcOverlayPosition(): No such placement of "'+e+'" found.');d=i.left+(i.width-h)/2,p="top"===e?i.top-u:i.top+i.height;var y=function(e,t,n,s){var r=l(n).width,a=e-s,o=e+s+t;if(a<0)return-a;if(o>r)return r-o;return 0}(d,h,a,o);d+=y,f=50*(1-2*y/h)+"%",m=void 0}return{positionLeft:d,positionTop:p,arrowOffsetLeft:f,arrowOffsetTop:m}};var s=i(n(209)),r=i(n(396)),a=i(n(210)),o=i(n(73));function i(e){return e&&e.__esModule?e:{default:e}}function l(e){var t=void 0,n=void 0,r=void 0;if("BODY"===e.tagName)t=window.innerWidth,n=window.innerHeight,r=(0,a.default)((0,o.default)(e).documentElement)||(0,a.default)(e);else{var i=(0,s.default)(e);t=i.width,n=i.height,r=(0,a.default)(e)}return{width:t,height:n,scroll:r}}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e};t.default=function(e,t){var n,c={top:0,left:0};"fixed"===(0,l.default)(e,"position")?n=e.getBoundingClientRect():(t=t||(0,a.default)(e),n=(0,r.default)(e),"html"!==function(e){return e.nodeName&&e.nodeName.toLowerCase()}(t)&&(c=(0,r.default)(t)),c.top+=parseInt((0,l.default)(t,"borderTopWidth"),10)-(0,o.default)(t)||0,c.left+=parseInt((0,l.default)(t,"borderLeftWidth"),10)-(0,i.default)(t)||0);return s({},n,{top:n.top-c.top-(parseInt((0,l.default)(e,"marginTop"),10)||0),left:n.left-c.left-(parseInt((0,l.default)(e,"marginLeft"),10)||0)})};var r=c(n(209)),a=c(n(397)),o=c(n(210)),i=c(n(398)),l=c(n(49));function c(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){var t=(0,s.default)(e),n=e&&e.offsetParent;for(;n&&"html"!==o(e)&&"static"===(0,r.default)(n,"position");)n=n.offsetParent;return n||t.documentElement};var s=a(n(38)),r=a(n(49));function a(e){return e&&e.__esModule?e:{default:e}}function o(e){return e.nodeName&&e.nodeName.toLowerCase()}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var n=(0,a.default)(e);if(void 0===t)return n?"pageXOffset"in n?n.pageXOffset:n.document.documentElement.scrollLeft:e.scrollLeft;n?n.scrollTo(t,"pageYOffset"in n?n.pageYOffset:n.document.documentElement.scrollTop):e.scrollLeft=t};var s,r=n(81),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1)),a=s(n(132)),o=n(165);t.default=class extends r.default.Component{shouldComponentUpdate(e){return!!e.updateMap}render(){const{screen:e}=this.props;return r.default.createElement(o.ContextMenuTrigger,{id:"right-click-context-menu"},r.default.createElement(a.default,{boardClassName:this.props.boardClassName,charRows:e.getCharRows(),classRows:e.getClassRows(),endY:e.endY,onCellClick:this.props.onCellClick,onMouseDown:this.props.onMouseDown,onMouseOver:this.props.onMouseOver,onMouseOverCell:this.props.onMouseOverCell,onMouseUp:this.props.onMouseUp,rowClass:this.props.rowClass,sizeX:this.props.sizeX,startX:0,startY:0,useRLE:this.props.useRLE}))}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1));t.default=class extends r.default.Component{constructor(e){super(e),this.deleteLevel=this.deleteLevel.bind(this)}render(){const e=this.getLevelList();return r.default.createElement("div",{className:"list-group"},"List of levels:",e)}getLevelList(){return this.props.levelList.map((e,t)=>{const n=this.selectLevel.bind(this,e,t),s=this.props.levelIndex===t?"list-group-item list-group-item-info":"list-group-item",a=e.getActors().length,o=a?"A:"+a:"",i=e.getItems().length,l=i?"I:"+i:"";return r.default.createElement("a",{className:s,href:"#",key:e.getID(),onClick:n},"L",e.getID(),":",e.getMap().cols,"x",e.getMap().rows,"|",o,"|",l,r.default.createElement("button",{className:"btn-xs btn-danger pull-right",id:"btn-delete-level-"+t,onClick:this.deleteLevel},"X"))})}selectLevel(e,t){this.props.setShownLevel({level:e,levelIndex:t})}deleteLevel(e){e&&e.stopPropagation();const{id:t}=e.target;let n=t.match(/(\d+)$/)[1];n=parseInt(t,10);const s=this.props.levelList;s.splice(n,1);const r=s.length>0?s[0]:null;null===r?this.props.setShownLevel({level:null,levelIndex:-1,levelList:s}):this.props.setShownLevel({level:r,levelIndex:0,levelList:s})}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1));t.default=class extends r.Component{constructor(e){super(e),this.callback=this.callback.bind(this)}callback(e){const t=e.target.id;this.props.menuCallback(t)}render(){let e="btn btn-xs";return this.props.simulationStarted||(e="btn btn-xs disabled"),r.createElement("div",null,r.createElement("button",{className:"btn btn-xs",id:"simulateLevel",onClick:this.callback},"Simulate"),r.createElement("button",{className:"btn btn-xs",id:"stepSimulation",onClick:this.callback},"Step"),r.createElement("button",{className:e,id:"playSimulation",onClick:this.callback},"Play"),r.createElement("button",{className:e,id:"playFastSimulation",onClick:this.callback},">>>"),r.createElement("button",{className:e,id:"pauseSimulation",onClick:this.callback},"Pause"),r.createElement("button",{className:e,id:"stopSimulation",onClick:this.callback},"Stop"))}}},function(e,t,n){var s,r=r||function(e){"use strict";if(!(void 0===e||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var t=e.document,n=function(){return e.URL||e.webkitURL||e},s=t.createElementNS("http://www.w3.org/1999/xhtml","a"),r="download"in s,a=/constructor/i.test(e.HTMLElement)||e.safari,o=/CriOS\/[\d]+/.test(navigator.userAgent),i=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},l=function(e){setTimeout(function(){"string"==typeof e?n().revokeObjectURL(e):e.remove()},4e4)},c=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},u=function(t,u,h){h||(t=c(t));var d,p=this,f="application/octet-stream"===t.type,m=function(){!function(e,t,n){for(var s=(t=[].concat(t)).length;s--;){var r=e["on"+t[s]];if("function"==typeof r)try{r.call(e,n||e)}catch(e){i(e)}}}(p,"writestart progress write writeend".split(" "))};if(p.readyState=p.INIT,r)return d=n().createObjectURL(t),void setTimeout(function(){var e,t;s.href=d,s.download=u,e=s,t=new MouseEvent("click"),e.dispatchEvent(t),m(),l(d),p.readyState=p.DONE});!function(){if((o||f&&a)&&e.FileReader){var s=new FileReader;return s.onloadend=function(){var t=o?s.result:s.result.replace(/^data:[^;]*;/,"data:attachment/file;");e.open(t,"_blank")||(e.location.href=t),t=void 0,p.readyState=p.DONE,m()},s.readAsDataURL(t),void(p.readyState=p.INIT)}d||(d=n().createObjectURL(t)),f?e.location.href=d:e.open(d,"_blank")||(e.location.href=d);p.readyState=p.DONE,m(),l(d)}()},h=u.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return t=t||e.name||"download",n||(e=c(e)),navigator.msSaveOrOpenBlob(e,t)}:(h.abort=function(){},h.readyState=h.INIT=0,h.WRITING=1,h.DONE=2,h.error=h.onwritestart=h.onprogress=h.onwrite=h.onabort=h.onerror=h.onwriteend=null,function(e,t,n){return new u(e,t||e.name||"download",n)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);
/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */e.exports?e.exports.saveAs=r:null!==n(403)&&null!==n(212)&&(void 0===(s=function(){return r}.call(t,n,t,e))||(e.exports=s))},function(e,t){e.exports=function(){throw new Error("define cannot be used indirect")}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(1)),o=r(n(213)),i={hasActors:[{text:"Remove actor",type:"removeActor"},{text:"Edit actor",type:"editActor"}],hasItems:[{text:"Delete item"},{text:"Edit item"}],hasElements:[{text:"Delete element"},{text:"Edit element"}],hasConnection:[{text:"Create connection"}]};t.default=class extends a.Component{render(){return a.createElement(o.default,{handleRightClick:this.props.handleRightClick,menuItems:i,mouseOverCell:this.props.mouseOverCell})}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(e){this.level=e,this.funcTable={removeActor:this.removeActor.bind(this),editActor:this.editActor.bind(this)}}handleClick(e,t,n,s){return console.log("EditorClickHandler with cmd",s),!!this.funcTable[s]&&this.funcTable[s](n,e,t)}removeActor(e,t,n){return this.level.removeActor(e.getActors()[0])}editActor(e){const t=e.getActors()[0];return console.log("window.EDIT_ACTOR set. Use console to edit"),window.EDIT_ACTOR=t,!0}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(22),r=n(35),a=n(19),o=n(12);t.LevelUtils={},t.LevelUtils.wrapAsLevel=function(e,t){const n=(e,t)=>Math.max(e,t),i=e.map(e=>e.getMap().cols),l=e.map(e=>e.getMap().rows),c=new s.Level;let u=null;const h=t.baseElem||a.ELEM.FLOOR;if(t.centerY){const t=l.reduce(n),s=i.reduce((e,t)=>e+t,0);u=new r.CellMap(s,t,h),c.setMap(u),o.Geometry.tileLevels(c,e,{centerY:!0,x:0,y:0})}else if(t.centerX){const t=l.reduce((e,t)=>e+t,0),s=i.reduce(n);u=new r.CellMap(s,t,h),c.setMap(u),o.Geometry.tileLevels(c,e,{centerX:!0,x:0,y:0})}return c}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=r(n(11)),i=r(n(15)),l=r(n(34)),c=r(n(66)),u=n(131),h=n(87),d=n(85),p=n(138),f=n(113),m=n(126),g=n(46),y=n(26),v=n(9),_=n(88),b=n(179),E=n(137),S=n(19),C=n(195),w=n(156),T=n(18),O=n(58),M=n(31),A=n(60),N=n(41),P=n(115),x=n(417),I=n(191),D=T.EventPool.getPool(),k=v.Random.getRNG(),L=i.ElementStairs;t.DebugGame=function(e,t){this._fact=e,this._parser=t},t.DebugGame.prototype.createArena=function(e,t,n){I.Room.rng=k;const s=this._parser,r=e.sqrPerItem;e.cols=100,e.rows=100;const[c,p]=[50,50],f=this.createLastBattle(t,e);f.addActor(n,c,p);const y=new N.World.CityQuarter("Debug quarter");y.addLevel(f),f.getExtras().shops.forEach(e=>{y.addShop(e)});const v=new N.World.City("Wrapper city for Debug quarter");v.addQuarter(y),v.tileX=0,v.tileY=0;const b=new N.World.Area("Wrapper area",2,2,10,10);b.addZone("City",v);const T=new N.World.WorldTop("Wrapper world");T.addArea(b),t.addPlace(T);const O=this._parser.createActor("Wolf spirit");O.get("Stats").setStrength(500),f.addActor(O,2,1);const M=new l.SpiritGem("Lesser gem");f.addItem(M);const A=this._parser.createActualObj("items","Pick-axe");f.addItem(A,2,2);const P=this._parser.createActualObj("items","Potion of frost poison");P.setCount(5),f.addItem(P,2,2);const D=this._parser.createActualObj("items","Potion of cure poison");f.addItem(D,3,2);const L=this._parser.createActualObj("items","Rifle"),R=this._parser.createActualObj("items","Steel bullet");R.setCount(100),f.addItem(L,1,1),f.addItem(R,1,1);const B=this._parser.createActualObj("actors","shopkeeper"),G=new l.GoldCoin;G.setCount(50),B.getInvEq().addItem(G),f.addActor(B,2,2);const F=f.getMap().getFree().length,W={itemsPerLevel:Math.round(F/r),func:e=>e.value<=2500,maxValue:2500,food:()=>!0,gold:()=>!1};this._fact.addNRandItems(f,this._parser,W);const Y=f.getMap().cols,j=f.getMap().rows,X=this._parser.createActor("Thabba, Son of Ice");f.addActor(X,Y-2,j-2);const U=this._parser.createActor("Cryomancer");f.addActor(U,1,j-2);const $=this._parser.createActualObj("items","Potion of spirit form");n.getInvEq().addItem($);const K=this._parser.createItem("Potion of strength");n.getInvEq().addItem(K),n.add(new o.Attacker),n.add(new o.Defender),n.add(new o.MasterEquipper),n.add(new o.BiDirStrike),n.add(new o.BiDirStrike),n.add(new o.ThroughShot),new x.WinCondition("Kill a keeper",t.getPool()).addActorKilled(B),t.addPlayer(n),n.getInvEq().getEquipment().addSlot("spiritgem",new m.EquipSlot("spiritgem"));const V=this._parser.createItem("Lesser spirit gem"),H=this._parser.createItem("Greater spirit gem");n.getInvEq().addItem(V),n.getInvEq().addItem(H),n.add(new o.SpiritItemCrafter);const q=new i.ElementExploration;q.setExp(100),f.addElement(q,1,20);const J=this.createTrainer();f.addActor(J,1,2);const z=new l.GoldCoin;z.setCount(600),n.getInvEq().addItem(z);const Q=new _.Spell.SpellBook(n);n.setBook(Q),_.Spell.addAllSpells(Q),n.add(new o.SpellPower),n.get("SpellPower").setPP(100);const Z=new E.VirtualActor("spawner"),ee=new d.BrainSpawner(Z);ee.setConstraint({op:"lt",prop:"danger",value:10}),Z.setBrain(ee),f.addVirtualProp(a.default.TYPE_ACTOR,Z);const te=this._parser.createActor("Fire"),ne=new o.Fading;ne.setDuration(20),te.add(ne),f.addActor(te,7,1);const se=this._parser.createActor("thunderbird");f.addActor(se,20,1);const re=s.createEntity("firemaking kit");n.getInvEq().addItem(re),n.get("SpellPower").setPP(100),n.get("SpellPower").setMaxPP(100);const ae=new g.ItemRandomizer,oe=s.createItem("rune of protection");ae.adjustItem(oe,100),n.getInvEq().addItem(oe);const ie=s.createItem("rune of tunneling");ae.adjustItem(ie,100),n.getInvEq().addItem(ie);const le=s.createItem("rune of force");ae.adjustItem(le,100),n.getInvEq().addItem(le);const ce=new i.ElementLever;f.addElement(ce,2,1);for(let e=0;e<3;e++){const t=new i.ElementLeverDoor;ce.addTarget(t),f.addElement(t,3+e,1)}const ue=n.get("Abilities"),he=new u.Ability.Camouflage;ue.addAbility(he);const de=new u.Ability.Sharpener;ue.addAbility(de),this.addGoblinWithLoot(f);const pe=s.createItem("rune of control");ae.adjustItem(pe,250),n.getInvEq().addItem(pe);const fe=s.createItem("rune of venom");ae.adjustItem(fe,150),n.getInvEq().addItem(fe);const me=s.createItem("rune of poison clouds");ae.adjustItem(me,150),n.getInvEq().addItem(me);const ge=s.createItem("Void dagger");n.getInvEq().addItem(ge),n.getInvEq().unequipItem("hand",1,0),n.getInvEq().equipItem(ge);const ye=s.createItem("shovel");n.getInvEq().addItem(ye);const ve=s.createItem("machete");n.getInvEq().addItem(ve);const _e=s.createItem("rune of webs");n.getInvEq().addItem(_e);const be=s.createActor("bearfolk thief");f.addActor(be,c+1,p+1),n.getInvEq().addItem(s.createItem("Boots of flying"));const Ee=new o.RegenEffect;Ee.setPP(2),Ee.setWaitPP(0),Ee.setMaxWaitPP(0),n.add(Ee),f.getMap().setBaseElemXY(c-1,p-1,S.ELEM.WATER),h.ActorsData.filter(e=>"UniqueBase"===e.base).forEach(e=>{const{name:t}=e,n=s.createActor(t);n?f.addActorToFreeCell(n):a.default.warn("DebugGame","creating uniques","Failed to create unique actor: "+t)});const Se=new w.QuestPopulate,Ce=new l.Book("Book of shadows");Ce.addText("In the land of mordor where shadows lie..."),n.getInvEq().addItem(Ce);const we=new w.Quest("Report info to actor",["<goto>already_there","<report>listen","<goto>already_there","report"]);Se.mapQuestToResources(we,v,null),Se.addQuestComponents(v);const Te=f.getActors(),Oe=Te.find(e=>e.has("QuestGiver"));Oe.get("QuestGiver").setReward({type:"item",name:"Ruby glass mace"}),f.moveActorTo(Oe,c+1,p),Te.filter(e=>e.has("QuestTarget")).forEach((e,t)=>{f.moveActorTo(e,c,p+1+t),e.get("Stats").setSpeed(10)});const Me=new o.Weather;Me.setWeatherType("snowStorm"),f.add(Me);const Ae=new E.WeatherActor("Weather actor");f.addVirtualProp(a.default.TYPE_ACTOR,Ae);const Ne=f.getMap().getCells(e=>e.isFree());for(let e=0;e<200;e++){const e=k.arrayGetRand(Ne),[t,n]=e.getXY();f.addElement(new i.ElementWeb,t,n),f.getMap().hasXY(t+1,n+1)&&f.addElement(new i.ElementSlime,t+1,n+1)}const Pe=f.getMap().getCells(e=>e.hasPropType("floorhouse"));for(let e=0;e<40;e++){k.arrayGetRand(Pe).setBaseElem(S.ELEM.BED)}const xe=new o.Charm({level:10});n.add(xe);const Ie=new o.Lore({});Ie.addTopic("quests",Oe.getName()+" is looking for someone."),f.add(Ie);const De=s.createActor("necrowurm");f.addActor(De,n.getX()-1,n.getY());const ke=C.ItemGen.buildShell({type:"weapon",name:"sword",material:"steel",suffix:"ofNecropotence"}),Le=s.createFromShell(a.default.TYPE_ITEM,ke);return n.getInvEq().addItem(Le),t},t.DebugGame.prototype.createQuestsDebug=function(e,t,n){const s={name:"Quest test world",nAreas:1,area:[(new P.WorldCreator).createSingleAreaConf(0,{maxX:2,maxY:2})]},r=(new A.FactoryWorld).createWorld(s),a=r.getZones("City")[0].getLevels()[0],o=Math.floor(a.getMap().cols/2),i=Math.floor(a.getMap().rows/2);return a.addActor(n,o,i),t.addPlace(r),t.addPlayer(n),t},t.DebugGame.prototype.createTrainer=function(){const e=this._parser.createActor("fighter");e.setName("Old trainer");const t=new o.Trainer;return t.getChatObj().setTrainer(e),e.add(t),e},t.DebugGame.prototype.addGoblinWithLoot=function(e){const t=this._parser.createActor("goblin");t.setName("goblin with loot");const n=new o.Loot(new l.Weapon("sword"));t.add(n),e.addActor(t,2,10)},t.DebugGame.prototype.createDebugBattle=function(e,t,n){const s=new p.Battle("Battle of ice kingdoms"),r=new p.Army("Blue army"),a=new p.Army("Red army");this.addActorsToArmy(r,10,"warlord"),this.addActorsToArmy(a,10,"Winter demon");const o=(new M.FactoryLevel).createLevel("arena",60,30);return s.setLevel(o),s.addArmy(r,1,1,{}),s.addArmy(a,1,2,{}),t.addBattle(s),t.addPlayer(n),t},t.DebugGame.prototype.addActorsToArmy=((e,t,n)=>{for(let s=0;s<t;s++){const t=this._parser.createActualObj("actors",n);t.setFOVRange(10),e.addActor(t)}}),t.DebugGame.prototype.createOneDungeonAndBoss=function(e,t,n){const{cols:s,rows:r,nLevels:a,sqrPerActor:i,sqrPerItem:c}=e;let u=1;const h=["rooms","rogue","digger"],d=[],p=[],f=new N.World.Branch("StartBranch"),m=e=>t=>t.value<=e;for(let e=0;e<a;e++){let t=h[k.randIndex(h)];0===e&&(t="ruins");const n=this._fact.createLevel(t,s,r);f.addLevel(n);const a=n.getMap().getFree().length,o=Math.round(a/i),u=Math.round(a/c),d=new l.Potion("Healing potion");n.addItem(d);const g=this._parser.createActualObj("items","Shuriken");g.setCount(20),n.addItem(g);const y=20*(e+1),v={itemsPerLevel:u,func:m(y),maxValue:y,food:()=>!0};this._fact.addNRandItems(n,this._parser,v);const _={actorsPerLevel:o,maxDanger:e+1};this._fact.addNRandActors(n,this._parser,_),p.push(n)}const g=p.slice(-1)[0],y=g.getFreeRandCell(),v=this._fact.createActor("Summoner",{hp:100,att:10,def:10});v.setType("summoner"),v.get("Experience").setExpLevel(10),g.addActor(v,y.getX(),y.getY());const _=this.createLastBattle(t,{cols:80,rows:60});t.addLevel(_),_.setLevelNumber(u++),f.connectLevels(),t.addPlace(f);const b=new L(!0,p[a-1],_),E=new o.Loot(b);v.add(E),d.push(b);const S=d.slice(-1)[0],C=new L(!1,_,g),w=_.getFreeRandCell();_.addStairs(C,w.getX(),w.getY()),C.setTargetStairs(S),S.setTargetStairs(C);for(let e=0;e<10;e++){const e="Townsman",t=this._fact.createActor(e,{brain:"Human"});t.setType("human");const n=_.getFreeRandCell();_.addActor(t,n.getX(),n.getY())}if(null!==e.loadedLevel){const t=e.loadedLevel;t<=a?p[t-1].addActorToFreeCell(n):p[0].addActorToFreeCell(n)}return t.addPlayer(n,{place:"StartBranch"}),t},t.DebugGame.prototype.createLastBattle=function(e,t){const n=O.Factory.cityConfBase({});n.parser=this._parser,n.nShops=5;const s=e=>e.type===k.arrayGetRand(a.default.SHOP_TYPES);for(let e=0;e<n.nShops-1;e++)n.shopFunc.push(s);n.actorFunc=(e=>"bearfolk"===e.type),n.hasWall=!1;const r=(new f.CityGenerator).create(t.cols,t.rows,n);return this._listener=new R(this,e,r),this._fact.createHumanArmy(r,this._parser),r.setOnFirstEnter(()=>{const t=new c.OneShotEvent(this._fact.createDemonArmy.bind(this._fact,r,this._parser),2e3,"Demon hordes are unleashed from the unsilent abyss!");e.addEvent(t)}),r.setOnEnter(()=>{this._savedPlayerFOV=e.getPlayer().getFOVRange(),e.getPlayer().setFOVRange(20)}),r.setOnExit(()=>{e.getPlayer().setFOVRange(this._savedPlayerFOV)}),r};const R=function(e,t,n){this._game=t,this._level=n,this._maxBeasts=0,this._maxDemons=0,this._beastsKilled=0,this._demonsKilled=0,this.hasNotify=!0,this.notify=function(e,t){if(e===a.default.EVT_ACTOR_CREATED){if(t.hasOwnProperty("msg")&&"DemonSpawn"===t.msg){const e=t.actor;"Winter demon"===e.getName()&&++this._maxDemons,"Blizzard beast"===e.getName()&&++this._maxBeasts}}else if(e===a.default.EVT_ACTOR_KILLED){const e=t.actor;"Winter demon"===e.getName()?(++this._demonsKilled,this._demonsKilled===this._maxDemons&&this.allDemonsKilled(),a.default.debug(this,"A winter demon was slain! #"+this._demonsKilled),a.default.debug(this,"Max demons: "+this._maxDemons)):"Blizzard beast"===e.getName()&&(++this._beastsKilled,this._beastsKilled===this._maxBeasts&&this.allBeastsKilled())}},D.listenEvent(a.default.EVT_ACTOR_CREATED,this),D.listenEvent(a.default.EVT_ACTOR_KILLED,this),this.addSnow=((e,t)=>{const n=e.getMap();y.MapGenerator.addRandomSnow(n,t)}),this.allDemonsKilled=(()=>{a.default.gameMsg("Humans have vanquished all demons! But it's not over..");const t=new c.OneShotEvent(this.addSnow.bind(this,this._level,.2),2e3,"Winds are blowing stronger. You feel it's getting colder");this._game.addEvent(t);const n=new c.OneShotEvent(()=>{},3500,b.Texts.battle.eyeOfStorm);this._game.addEvent(n);const s=new c.OneShotEvent(e.createBeastArmy.bind(e,this._level,this._parser),5e3,"Winter spread by Blizzard Beasts! Hell seems to freeze.");this._game.addEvent(s)}),this.allBeastsKilled=(()=>{a.default.gameMsg(b.Texts.battle.beastsSlain);const e=new c.OneShotEvent(()=>{},1e3,b.Texts.battle.enemiesDead);this._game.addEvent(e);const t=new c.OneShotEvent(()=>{},2e3,"Battles in the North will continue soon in larger scale...");this._game.addEvent(t)})}},function(e,t,n){!function(e){"use strict";function t(t){var n=this!==e?this:{};n.input=t,n.pos=0,n.line=1,n.linePos=0}e.version="0.1.2",e.parse=function(e){return new t(e).grammar()},e.stringify=function e(t){switch(t.type){case"terminal":return'"'+s(t.text)+'"';case"nonterminal":return"<"+s(t.text)+">";case"expression":return t.terms.map(e).join(" ");case"production":return e(t.lhs)+" ::= "+t.rhs.map(e).join(" | ")+";";case"grammar":return t.productions.map(e).join("\n")+"\n"}throw new Error("Unknown node type: "+t.type)},e.Parser=t;var n=t.EOF=-1;function s(e){return e.replace(/\\/g,"\\\\").replace(/\"/g,'\\"').replace(/\n/g,"\\n").replace(/\t/g,"\\t")}t.prototype.error=function(e){throw new SyntaxError(e+" at "+this.line+":"+this.linePos)},t.prototype.peek=function(){return this.pos>=this.input.length?n:this.input[this.pos]},t.prototype.eat=function(e){var t=this.peek();return void 0!==e&&e!==t&&this.error("Expected "+e+", got"+t),t===n?n:(this.pos++,this.linePos++,t)},t.prototype.ws=function(){for(var e,t="";" \n\t".indexOf(e=this.peek())>=0;)"\n"===e&&(this.line++,this.linePos=0),t+=this.eat();return t},t.prototype.escaped=function(){this.eat("\\");var e=this.peek();switch(e){case"n":return this.eat(),"\n";case"t":return this.eat(),"\t";case'"':return this.eat(),'"';case"\\":return this.eat(),"\\"}this.error("Invalid escape sequence: \\"+e)},t.prototype.isChar=function(){var e=this.peek();return e!==n&&(/[a-zA-Z0-9\-_|:=; \/\(\)]/.test(e)||"\\"===e)},t.prototype.text=function(){for(var e="";this.isChar();)"\\"===this.peek()?e+=this.escaped():e+=this.eat();return e},t.prototype.terminal_text=function(){for(var e="",t=this.peek();this.isChar()||"<"===t||">"===t;)e+="\\"===t?this.escaped():this.eat(),t=this.peek();return e},t.prototype.terminal=function(){this.eat('"');var e=this.terminal_text();return this.eat('"'),{type:"terminal",text:e}},t.prototype.nonterminal=function(){this.eat("<");var e=this.text();return this.eat(">"),{type:"nonterminal",text:e}},t.prototype.term=function(){return"<"===this.peek()?this.nonterminal():this.terminal()},t.prototype.expression=function(){var e=[this.term()];for(this.ws();'<"'.indexOf(this.peek())>=0;)e.push(this.term()),this.ws();return{type:"expression",terms:e}},t.prototype.expressions=function(){for(var e=[this.expression()];"|"===this.peek();)this.eat("|"),this.ws(),e.push(this.expression());return e},t.prototype.production=function(){var e=this.nonterminal();this.ws(),this.eat(":"),this.eat(":"),this.eat("="),this.ws();var t=this.expressions();return this.eat(";"),{type:"production",lhs:e,rhs:t}},t.prototype.grammar=function(){var e=[this.production()];for(this.ws();"<"===this.peek();)e.push(this.production()),this.ws();return{type:"grammar",productions:e}}}(t)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(9).Random.getRNG();t.QuestGrammar={};const r="<Knowledge> ::= <Deliver_item_for_study> |\n <Spy> |\n <Interview_NPC> |\n <Use_an_item_in_the_field> ;\n\n<Comfort> ::= <Obtain_luxuries> |\n <Kill_pests>;\n\n<Reputation> ::= <Obtain_rare_items> |\n <Kill_enemies> |\n <Visit_a_dangerous_place>;\n\n<Serenity> ::= <Revenge_Justice> |\n <Capture_Criminal1> |\n <Capture_Criminal2> |\n <Check_on_NPC1> |\n <Check_on_NPC2> |\n <Recover_lost_or_stolen_item> |\n <Rescue_captured_NPC>;\n\n<Protection> ::= <Attack_threatening_entities> |\n <Treat_or_repair_1> |\n <Treat_or_repair_2> |\n <Create_Diversion_1> |\n <Create_Diversion_2> |\n <Assemble_fortification> |\n <Guard_Entity>;\n\n<Conquest> ::= <Attack_enemy> |\n <Steal_stuff>;\n\n<Wealth> ::= <Gather_raw_materials> |\n <Steal_valuables_for_resale> |\n <Make_valuables_for_resale>;\n\n<Ability> ::= <Assemble_tool_for_new_skill> |\n <Obtain_training_materials> |\n <Use_existing_tools> |\n <Practice_combat> |\n <Practice_skill> |\n <Research_a_skill1> |\n <Research_a_skill2>;\n\n<Equipment> ::= <Assemble> |\n    <Deliver_supplies> |\n    <Steal_supplies> |\n    <Trade_for_supplies>;\n\n<Strategy> ::= <Win_a_battle> |\n    <Survive_a_battle>;",a=`<QUEST> ::= <Knowledge> | <Comfort> |\n <Reputation> | <Serenity> |\n <Protection> | <Conquest> |\n <Wealth> | <Ability> | <Equipment> | <Strategy>;\n\n${r}\n\n<Deliver_item_for_study> ::= <get> <goto> "give";\n<Spy> ::= <spy>;\n<Interview_NPC> ::= <goto> "<report>listen" <goto> "report";\n<Use_an_item_in_the_field> ::= <get> <goto> "use" <goto> "give";\n\n<Obtain_luxuries> ::= <get> <goto> "give";\n<Kill_pests> ::= <goto> "damage" <goto> "report";\n\n<Obtain_rare_items> ::= <get> <goto> "give";\n<Kill_enemies> ::= <goto> <kill> <goto> "report";\n<Visit_a_dangerous_place> ::= <goto> <goto> "report";\n\n<Revenge_Justice> ::= <goto> "damage";\n<Capture_Criminal1> ::= <get> <goto> "use" <goto> "give";\n<Capture_Criminal2> ::= <get> <goto> "use" "capture" <goto> "give";\n<Check_on_NPC1> ::= <goto> "<report>listen" <goto> "report";\n<Check_on_NPC2> ::= <goto> "take" <goto> "give";\n<Recover_lost_or_stolen_item> ::= <get> <goto> "give";\n<Rescue_captured_NPC> ::= <goto> "damage" "escort" <goto_new_place> "report";\n\n<Attack_threatening_entities> ::=<goto> "damage" <goto> "report";\n<Treat_or_repair_1> ::= <get> <goto> "use";\n<Treat_or_repair_2> ::= <goto> "repair";\n<Create_Diversion_1> ::= <get> <goto> "use";\n<Create_Diversion_2> ::= <goto> "damage";\n<Assemble_fortification> ::= <goto> "repair";\n<Guard_Entity> ::= <goto> "defend";\n\n<Attack_enemy> ::= <goto> "damage";\n<Steal_stuff> ::= <goto> <steal> <goto> "give";\n\n<Gather_raw_materials> ::= <goto> <get>;\n<Steal_valuables_for_resale> ::= <goto> <steal>;\n<Make_valuables_for_resale> ::= "repair";\n\n<Assemble_tool_for_new_skill> ::="repair" "use";\n<Obtain_training_materials> ::= <get> "use";\n<Use_existing_tools> ::= "use";\n<Practice_combat> ::= "damage";\n<Practice_skill> ::= "use";\n<Research_a_skill1> ::= <get> "use";\n<Research_a_skill2> ::= <get> "experiment";\n\n<Assemble> ::= "repair";\n<Deliver_supplies> ::= <get> <goto> "give";\n<Steal_supplies> ::= <steal>;\n<Trade_for_supplies> ::= <goto> "<get>exchange";\n\n<Win_a_battle> ::= <goto> "winbattle";\n<Survive_a_battle> ::= <goto> "finishbattle";\n\n<subquest> ::= <goto> |\n    <goto> <QUEST> "<subquest>goto";\n\n<goto> ::= "<goto>already_there" | "<goto>explore" | <learn> "<goto>goto";\n\n<goto_new_place> ::= "<goto>explore" | <learn> "<goto>goto";\n\n<learn> ::= "<learn>already_know_it" |\n    <goto> <subquest> "listen" |\n    <goto> <get> "<learn>read" |\n    <get> <subquest> "give" "listen";\n\n<get> ::= "<get>already_have_it" |\n    <steal> |\n    <goto> "<get>gather" |\n    <goto> <get> <goto> <subquest> "<get>exchange";\n\n<steal> ::= <goto> "<steal>stealth" "<steal>take" |\n    <goto> <kill> "<steal>take";\n\n<spy> ::= <goto> "<spy>spy" <goto> "report";\n<capture> ::= <get> <goto> "capture";\n<kill> ::= <goto> "<kill>kill";`,o=/<(\w+)>\s*::=/;const i={Knowledge:180,Comfort:20,Reputation:70,Serenity:140,Protection:180,Conquest:200,Wealth:20,Ability:10,Equipment:180,Strategy:40};t.QuestGrammar.motiveWeights=i;const l=function(e){const t=[];return e.split("\n").forEach(e=>{const n=e.match(o);n&&n.length>1&&t.push(n[1])}),t}(r);t.QuestGrammar.setWeight=function(e,t,n=!1){n&&Object.keys(i).forEach(e=>{i[e]=0}),i[e]=t},t.QuestGrammar.getRandMotive=function(){s.getWeighted(i)},t.QuestGrammar.grammar=a,t.QuestGrammar.actorMotivations=l},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=n(17)("bitn:quest-gen"),o=s(n(8)),i=n(411),l=n(9),c=n(54),u=n(14),h=n(96),d=n(18),p=r(n(34)),f=r(n(11)),m=n(218),g=n(219),y=l.Random.getRNG(),v=d.EventPool.getPool();class _{constructor(e){this.resetData(),this.questList=[],this.conf={maxLength:10,minLength:1,minQuests:1,maxQuests:2,numQuestsPerZone:1},this.maxTriesPerZone=5,this.questTargetCallback={escort:this.handleEscort=this.handleEscort.bind(this),repair:this.handleRepair=this.handleRepair.bind(this),listen:this.handleListen=this.handleListen.bind(this),reportListen:this.handleListen=this.handleListen.bind(this),report:this.handleReport=this.handleReport.bind(this),subquest:this.handleSubQuest=this.handleSubQuest.bind(this)},this.checkImplemented=!0,this.IND=0,this.debug=a.enabled,this.rng=y,e&&e.rng&&(this.rng=e.rng),this.pool=v}resetData(){this.questData={quests:[]},this.questList=[],this._cleanup=[],this.flags={alreadyKnowIt:!1,escort:!1,listen:!1,read:!1,report:!1},this.listOfAllTasks=[],this.currQuest=null,this._data=new Map,this._questCrossRefs=new Map,this.questGivers=new Map}setDebug(e){this.debug=e,a.enabled=e}getParentQuestData(){const e=this.questData.quests.indexOf(this.currQuest);return e>0?this.questData.quests[e-1]:null}initQuestPopulDataForQuest(e){this._data.set(e,{actor:[],element:[],escort:[],item:[],listen:[],place:[],read:[],reportListen:[],return:[],zone:[]})}addQuestPopulData(e,t){if(this._data.has(this.currQuest)||this.initQuestPopulDataForQuest(this.currQuest),this._data.get(this.currQuest).hasOwnProperty(e))this._data.get(this.currQuest)[e].push(t);else{const t=Object.keys(this._data.get(this.currQuest)).join(",");o.default.err("QuestPopulate","addQuestPopulData",`Key ${e} not present. Choices: ${t}`)}}getQuestPopulData(e,t=!1){if(this._data.has(this.currQuest)){const n=this._data.get(this.currQuest);if(n.hasOwnProperty(e)&&n[e].length>0){const t=n[e].length;return n[e][t-1]}if(t){const t=this.getParentQuestData();if(t){const n=this._data.get(t);if(n.hasOwnProperty(e)){const t=n[e].length;return n[e][t-1]}}o.default.err("QuestPopulate","getQuestPopulData",`No data for type ${e}. Searched parent also`)}else{const t=Object.keys(n);o.default.err("QuestPopulate","getQuestPopulData",`No data for type ${e}. Keys: ${t}`)}}else o.default.err("QuestPopulate","getQuestPopulData","No data for currQuest exists");return null}createQuests(e,t,n,s){const r=t.getTileXY(n,s),a=r.getZones("City");let o=0;return a.forEach(e=>{o+=this.createQuestsForZone(e,r)}),o}createQuestsForZone(e,t){const n=this.conf.numQuestsPerZone||1;let s=0;for(let r=0;r<n;r++)for(let n=0;n<this.maxTriesPerZone;n++){const n=(new g.QuestGen).genQuestWithConf(this.conf);if(this.resetData(),this.mapQuestToResources(n,e,t)){this.addQuestComponents(e),++s;break}}return s}mapQuestToResources(e,t,n){++this.IND,this.currTile=n;const s=new m.QuestData;this.dbg("*** New quest started ****"),e.isQuest()&&(this.dbg("  Quest has "+e.numTasks()+" tasks"),this.dbg("  Quest has "+(e.numQuests()-1)+" sub-quests"));let r=null;if(this.currQuest){const e={createTarget:"createSubQuestTarget",subQuest:s,args:[]};this.dbg("Adding |subquest| target for current quest"),this.currQuest.addTarget("subquest",e),r=this.currQuest.getCurrentLocation()}r&&this.addQuestPopulData("return",r),this.currQuest=s,this.questData.quests.push(this.currQuest);const a=this.rng.arrayGetRand(t.getLevels());this.currQuest.addTarget("location",a);let o=!0;if(e.getSteps().forEach(t=>{const s=this.currQuest.getCurrentLocation();if(t.isQuest()){const e=s.getParentZone();o=o&&this.mapQuestToResources(t,e,n)}else{const r=s.getParentZone();o=o&&this.mapTask(e,t,r,n)}}),!(o=o&&this._checkQuestFlags()))return this.cleanUpFailedQuest(),--this.IND,!1;if(this.dbg("Created quest: "+this.currQuest.getDescr()),this.questData.quests.length>1){this.questList.unshift(this.questData.quests.pop());const e=this.questData.quests.length-1;this.currQuest=this.questData.quests[e]}else this.questList.unshift(this.currQuest);return--this.IND,!0}pushQuestCrossRef(e,t){const n=this.currTaskType;e||o.default.err("QuestPopulate","pushQuestCrossRef",`${n}: Undefined KEY with data ${t}`),t||o.default.err("QuestPopulate","pushQuestCrossRef",`${n}: Undefined DATA with key ${e}`),this._questCrossRefs.has(e)||this._questCrossRefs.set(e,[]),this._questCrossRefs.get(e).push(t)}popQuestCrossRef(e){if(this._questCrossRefs.has(e)){const t=this._questCrossRefs.get(e);if(t.length>0){const n=this._questCrossRefs.get(e).pop();return 0===t.length&&this._questCrossRefs.delete(e),n}}return null}mapTask(e,t,n,s){++this.IND;const r=t.getTaskType();let a=!1;if(this.checkImplemented&&!b.has(r))return console.log(`TaskType |${r}| not implemented. Bailing out...`),!1;switch(this.dbg("Processing taskType |"+r+"|"),this.listOfAllTasks.push(r),this.currTaskType=r,r){case"capture":{const e=this.getActorToCapture();e&&(this.currQuest.addTarget("capture",e),a=!0);break}case"damage":{const e=this.getEntityToDamage();e&&(this.currQuest.addTarget("damage",e),a=!0);break}case"defend":{const e=this.getEntityToDefend();e&&(this.currQuest.addTarget("defend",e),a=!0);break}case"escort":{const e=this.getActorToEscort(s);e&&(this.currQuest.addTarget("escort",e),a=!0,this.addQuestPopulData("escort",e),this.flags.escort=!0);break}case"experiment":{const e=this.getQuestPopulData("item");e&&(this.currQuest.addTarget("experiment",e),a=!0);break}case"<get>already_have_it":{const e=this.getAlreadyOwnedItem();e&&(this.currQuest.addTarget("get",e),a=!0,this.addQuestPopulData("item",e));break}case"<get>gather":{const e=this.getItemToGather();e&&(this.currQuest.addTarget("get",e),a=!0,this.addQuestPopulData("item",e));break}case"<get>exchange":{const e=this.getItemToExchange();e&&(this.currQuest.addTarget("exchange",e),a=!0,this.addQuestPopulData("item",e));break}case"give":{const e=this.currQuest.getCurrentLocation(),t=this.getActorForQuests(e.getActors());t&&(this.currQuest.addTarget("give",t),a=!0);break}case"<goto>already_there":a=!0,this.flags.escort&&(a=!1);break;case"<goto>explore":{const e=this.getNewExploreLocation(n,s);this.currQuest.addTarget("location",e);const t=this.getExploreTarget();if(t&&(this.currQuest.addTarget("explore",t),a=!0,this.flags.read&&(this.flags.read=!1,this.pushQuestCrossRef(this.getQuestPopulData("read"),e)),this.flags.escort)){this.flags.escort=!1;const t=this.getQuestPopulData("escort",!0);this.pushQuestCrossRef(t,e)}break}case"<goto>goto":{const e=this.getNewLocation(n,s);if(this.currQuest.addTarget("location",e),a=!0,this.flags.read&&(this.flags.read=!1,this.pushQuestCrossRef(this.getQuestPopulData("read"),e)),this.flags.listen&&(this.flags.listen=!1,this.pushQuestCrossRef(this.getQuestPopulData("listen"),e)),this.flags.escort){this.flags.escort=!1;const t=this.getQuestPopulData("escort",!0);this.pushQuestCrossRef(t,e)}break}case"<kill>kill":{const e=this.getActorToKill();e&&(this.currQuest.addTarget("kill",e),a=!0);break}case"<learn>already_know_it":this.flags.alreadyKnowIt=!0,a=!0;break;case"listen":{const e=this.getActorToListen();e&&(this.currQuest.addTarget("listen",e),this.flags.listen=!0,this.addQuestPopulData("listen",e),a=!0);break}case"finishbattle":this.currQuest.addTarget("finishbattle",{createTarget:"createBattle",args:[n,s]}),a=!0;break;case"<learn>read":{const e=this.getReadTarget(n,s);e&&(this.addQuestPopulData("read",e),this.flags.read=!0,this.currQuest.addTarget("read",e),a=!0);break}case"repair":{const e=this.getRepairTarget();e&&(this.currQuest.addTarget("repair",e),a=!0);break}case"<report>listen":{const e=this.getActorToListen();e&&(this.currQuest.addTarget("reportListen",e),this.flags.report=!0,this.addQuestPopulData("reportListen",e),a=!0);break}case"report":{const e=this.getActorForReport();if(e&&(this.currQuest.addTarget("report",e),a=!0,this.flags.report)){const t=this.getQuestPopulData("reportListen");this.pushQuestCrossRef(e,t),this.flags.report=!1}break}case"<spy>spy":{const e=this.getActorToSpy();e&&(this.currQuest.addTarget("spy",e),a=!0);break}case"<steal>stealth":a=!0;break;case"<subquest>goto":{const e=this.getQuestPopulData("return");if(e&&(this.currQuest.addTarget("location",e),a=!0,this.flags.escort)){this.flags.escort=!1;const t=this.getQuestPopulData("escort",!0);this.pushQuestCrossRef(t,e)}break}case"<steal>take":case"take":{const e=this.getItemToSteal();e&&(this.currQuest.addTarget("get",e),this.addQuestPopulData("item",e),a=!0);break}case"use":{const e=this.getItemToUse();e&&(this.currQuest.addTarget("use",e),a=!0);break}case"winbattle":this.currQuest.addTarget("winbattle",{createTarget:"createBattle",args:[n,s]}),a=!0;break;default:o.default.err("QuestPopulate","mapTask",`Task type ${t.taskType} not supported yet`)}return a||console.warn("QuestPopulate","mapTask",`Failed to map ${t.getTaskType()}, ${JSON.stringify(t)}`),--this.IND,a}getActorForQuests(e){let t=this.rng.arrayGetRand(e),n=20,s=!1;for(;!E(t);)if(t=this.rng.arrayGetRand(e),0==--n){s=!0;break}return t}getActorToKill(){let e=this.currQuest.getCurrentLocation().getActors();return e=e.filter(e=>!e.isPlayer()&&e.hasNone(["QuestGiver","QuestTarget"])),this.rng.arrayGetRand(e)}getActorForReport(){const e=this.currQuest.getCurrentLocation().getActors();return this.getActorForQuests(e)}getActorToSpy(){const e=this.currQuest.getCurrentLocation().getActors();return this.getActorForQuests(e)}getActorToListen(){const e=this.currQuest.getCurrentLocation();return this.getActorForQuests(e.getActors())}getActorToEscort(e){const t=this.currQuest.getCurrentLocation();return this.getActorForQuests(t.getActors())}dbg(e){if(this.debug){const t="==".repeat(this.IND);a(t+e)}}getAlreadyOwnedItem(){const e=this.currQuest.getCurrentLocation().getPlayer();if(e){const t=e.getInvEq().getInventory().getItems();return this.rng.arrayGetRand(t)}return null}getItemToSteal(){const e=this.currQuest.getCurrentLocation(),t=new p.ItemBase(h.Names.getItemToStealName());let n=c.Placer.addEntityToCellType(t,e,e=>e.hasHouse());return n||(n=c.Placer.addEntityToCellType(t,e,e=>e.isFree())),n?(this._cleanup.push({location:e,item:t,tag:"getItemToSteal"}),t):null}getItemToGather(){const e=this.currQuest.getCurrentLocation(),t=new p.ItemBase("Quest item to gather");return c.Placer.addEntityToCellType(t,e,e=>e.isPassable())?(this._cleanup.push({location:e,item:t,tag:"getItemToGather"}),t):null}getReadTarget(e,t){return{createTarget:"createBook",args:[this.currQuest.getCurrentLocation(),e,t]}}getItemToUse(){const e=this.currQuest.getCurrentLocation(),t=e.getItems().filter(e=>e.hasOwnProperty("useItem"));if(t.length>0)return this.rng.arrayGetRand(t);const n=u.ObjectShell.getParser().createRandomItem(e=>e.use);return c.Placer.addEntityToCellType(n,e,e=>e.isPassable())&&n?(this._cleanup.push({location:e,item:n,tag:"getItemToUse"}),n):null}getRepairTarget(){const e=this.currQuest.getCurrentLocation().getElements().filter(e=>"door"===e.getType()||"leverdoor"===e.getType()||"lever"===e.getType());if(e.length>0){return this.rng.arrayGetRand(e)}return null}getEntityToDamage(){const e=this.currQuest.getCurrentLocation(),t=e.getElements().filter(e=>"door"===e.getType());if(t){return this.rng.arrayGetRand(t)}const n=e.getActors();return n.length>0?this.rng.arrayGetRand(n):null}getEntityToDefend(){const e=this.currQuest.getCurrentLocation().getActors();return e.length>0?this.rng.arrayGetRand(e):null}getActorToCapture(){const e=this.currQuest.getCurrentLocation().getActors();return this.getActorForQuests(e)}getItemToExchange(){const e=this.currQuest.getCurrentLocation().getElements().filter(e=>"shop"===e.getType());for(this.rng.shuffle(e);e.length>0;){const t=e[0].getCell();if(t.hasItems()){const e=t.getItems().filter(e=>e.has("Unpaid"));if(e.length>0)return e[0]}e.shift()}return null}getNewLocation(e,t){this.flags.alreadyKnowIt&&(this.flags.alreadyKnowIt=!1);let n=t.getZones();n=n.filter(e=>"battlezone"!==e.getType());let s=this.rng.arrayGetRand(n);if(n.length>1)for(;s.getID()===e.getID();)s=this.rng.arrayGetRand(n);return this.addQuestPopulData("zone",s),this.rng.arrayGetRand(s.getLevels())}getNewExploreLocation(e,t){const n=t.getZones("Dungeon"),s=t.getZones("Mountain"),r=n.concat(s),a=new i.RandomCyclic(r);if(r.length>0){let t=a.next(),n=20;for(;t.getID()===e.getID()&&(t=a.next(),0!=--n););return this.addQuestPopulData("zone",t),t.getLevels()[0]}return null}getExploreTarget(){const e=this.getQuestPopulData("zone").getLevels();let t=null;return e.forEach(e=>{if(!t){const n=e.getElements();t=n.find(e=>"exploration"===e.getType())}}),t}addQuestComponents(e){for(let t=this.questList.length-1;t>=0;t--){const n=this.questList[t];n.resetIter(),n.keys().forEach(e=>{if(_.supportedKeys.has(e)){let t=n.next(e);for(;t;){if(o.default.isEntity(t))this.setAsQuestTarget(e,t);else if(t.createTarget){const{createTarget:s,args:r}=t;"function"!=typeof this[s]&&o.default.err("QuestPopulate","addQuestComponents",`${s} not a func in QuestPopulate`);const a=this[s](t,...r);this.setAsQuestTarget(e,a),n.replaceTarget(e,t,a)||o.default.err("QuestPopulate","addQuestComponents","Failed to repl obj for "+s)}t=n.next(e)}}else o.default.err("QuestPopulate","addQuestComponents",`Unsupported key |${e}| found`)});const s=this.rng.arrayGetRand(e.getLevels()),r=this.getActorForQuests(s.getActors()),a=new f.QuestGiver(n.getDescr());this.addTargetsToGiver(a,n),r.add(a),this.addUniqueName(r),s.get("Lore").addTopic("quests",r.getName()+" could have some work for you");const i=r;this.questGivers.set(n,i)}}addTargetsToGiver(e,t){const n=e.getQuestID();this.dbg("addTargetsToGiver now, ID "+n),++this.IND,t.getPathTargets().forEach(t=>{this._checkTargetValidity(t);const s=t.get("QuestTarget");if(s){const[t,r]=[s.getTarget(),s.getTargetType()];e.addTarget(r,t),s.setQuestID(n)}else{const e=JSON.stringify(t);o.default.err("QuestPopulate","addTargetsToGiver",`No QuestTarget found from target ${e}`)}}),--this.IND}_checkTargetValidity(e){if(!o.default.isEntity(e)){const t="Non-Entity given: "+JSON.stringify(e);o.default.err("QuestPopulate","_checkTargetValidity",t)}}setAsQuestTarget(e,t){if(!t){const t=`Null/undef target with key |${e}|`;o.default.err("QuestPopulate","setAsQuestTarget",t)}if("function"!=typeof t.getID){let n=`questTarget without getID() given with key ${e}:`;n+=` ${JSON.stringify(t)}`,o.default.err("QuestPopulate","setAsQuestTarget",n)}const n=f.create("QuestTarget");n.setTargetType(e),n.setTarget(t),n.setTargetID(t.getID()),t.add(n),(o.default.isActor(t)||o.default.isItem(t))&&this.addUniqueName(t),this.questTargetCallback[e]&&this.questTargetCallback[e](t)}handleEscort(e){const t=this.popQuestCrossRef(e);if(t){const n=f.create("QuestEscortTarget");n.setEscortTo(t),e.add(n)}else this.dumpInternalData("handleEscort"),this.errorQuestHandle(e,"handleEscort")}handleRepair(e){e.add(f.create("Broken"))}handleListen(e){const t=f.create("QuestInfo");t.setQuestion("Can you tell me something to report?"),t.setInfo("Generate something to report"),t.setGivenBy(e.getID()),e.add(t)}handleReport(e){const t=f.create("QuestReport"),n=this.popQuestCrossRef(e);n&&t.setExpectInfoFrom(n.getID()),e.add(t)}handleSubQuest(e){const t=e.get("QuestTarget"),n=e.get("QuestGiver");if(t&&n)t.setSubQuestID(n.getQuestID());else{const t=JSON.stringify(e);o.default.err("QuestPopulate","handleSubQuest","Target must have QuestTarget + Giver comps: "+t)}}addUniqueName(e){if(!e.has("Named")){const t=f.create("Named");e.getName&&t.setName(e.getName()),e.add(t)}const t=e.get("Named");if(o.default.isActor(e)){t.setUniqueName(h.Names.getActorName());const n=e.getName(),s=n[0];o.default.addCharStyle(o.default.TYPE_ACTOR,n,s),o.default.addCellStyle(o.default.TYPE_ACTOR,n,"cell-actor-unique")}else if(o.default.isItem(e)){const e="Quest item "+this.rng.getUniformInt(0,1e6);console.log("addUniqueName rand item name "+e),t.setUniqueName(e)}}createBattle(e,t,n){const s=n.getZones("BattleZone");if(s.length>0){return this.rng.arrayGetRand(s).getLevels()[0]}{const e={areaTile:n,zone:t};if(this.pool.emitEvent(o.default.EVT_CREATE_BATTLE,e),e.response){console.log("createBattle return eventArgs.response.level");const{battle:t}=e.response;if(t)return t.getLevel()}else o.default.err("QuestPopulate","createBattle","No response in eventArgs for EVT_CREATE_BATTLE")}return null}createBook(e,t){const n=new p.Book(h.Names.getBookName()),s=this.popQuestCrossRef(e);if(s){t.addItem(n);const e=o.default.formatLocationName(s),r=["Quest hint where to go:"];return r.push("You should go to place called "+e),n.setText(r),n.addMetaData("place",{levelID:s.getID(),name:e}),n}{const e=JSON.stringify(this._questCrossRefs);o.default.err("QuestPopulate","createBook",`No cross-refs set for book. refs: ${e}`)}return null}createSubQuestTarget(e){const{subQuest:t}=e;return this.questGivers.get(t)}_checkQuestFlags(){let e=!0;return Object.keys(this.flags).forEach(t=>{!1!==this.flags[t]&&(e=!1,console.log("Flag ",t,"still true!"))}),e}cleanUpFailedQuest(){let e=0;this._cleanup.forEach(t=>{const{location:n}=t;let s=!1,r=null;if(t.item){const[e,a]=t.item.getXY();r=t.item;try{s=n.removeItem(t.item,e,a)}catch(s){const{tag:r}=t,i=t.item.getName(),l=n.getItems().map(e=>e.toString());let c=`Failed to cleanup item ${i} @ ${e},${a}`;r&&(c+="\nTag specified: |"+r+"|"),c+="\n"+s.message,c+="\nItems at loc: "+l,o.default.err("QuestPopulate","cleanUpFailedQuest",c)}}else if(t.actor){const[e,a]=t.actor.getXY();s=n.removeActor(t.actor),r=t.actor}else if(t.element){const[e,a]=t.element.getXY();s=n.removeElement(t.element,e,a),r=t.element}s&&++e}),e!==this._cleanup.length&&o.default.warn("QuestPopulate","cleanUpFailedQuest","Did not remove all quest items for failed quest"),this._cleanup=[]}errorQuestHandle(e,t){let n="Failed to get location for escort: ";n+="\n\ttarget: "+e.getName(),n+="\n\tcrossRefs: "+JSON.stringify(Object.values(this._questCrossRefs.entries())),o.default.err("QuestPopulate",t,n)}dumpInternalData(e){"undefined"!=typeof window&&(window.QUEST_GEN=this)}}t.QuestPopulate=_;const b=new Set(["damage","escort","<get>gather","give","<kill>kill","<goto>already_there","<goto>explore","<goto>goto","<learn>already_know_it","<learn>read","listen","<report>listen","report","<steal>stealth","<steal>take","take","<subquest>goto","finishbattle","winbattle"]);function E(e){return e.has("Corporeal")&&o.default.ALL_RACES.indexOf(e.getType())>=0&&!(e.isPlayer()||e.has("QuestTarget")||e.has("QuestGiver"))}_.supportedKeys=new Set(["defend","capture","explore","kill","location","listen","give","report","reportListen","get","steal","use","repair","damage","winbattle","finishbattle","escort","spy","exchange","read","experiment","subquest"])},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(9).Random.getRNG();t.RandomCyclic=class{constructor(e){e&&0!==e.length||r.default.err("RandomCyclic","new","array with length > 0 must be given"),this.arr=e,this.reset(),this.length=e.length}reset(){this.indicesLeft=[],this.arr.forEach((e,t)=>{this.indicesLeft.push(t)}),this._prevValue=null,this._currValue=null}prev(){return this._prevValue}next(){0===this.indicesLeft.length&&this.reset();const e=a.arrayGetRand(this.indicesLeft);return this.indicesLeft=this.indicesLeft.filter(t=>t!==e),this._prevValue=this._currValue,this._currValue=this.arr[e],this._currValue}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(9).Random.getRNG(),o={1:5,2:30,3:30,4:20,5:5},i=r.default.LETTERS,l=/[aeiouy]/,c=i.filter(e=>l.test(e)),u=i.filter(e=>!l.test(e)),h=[],d=[],p=[],f=[],m={vowel:[],consonant:[]},g={vowel:[],consonant:[]};i.forEach(e=>{if(l.test(e)){const t=e;c.forEach(e=>{h.push(t+e),m.vowel.push(t+e),g.vowel.push(t+e),u.forEach(n=>{d.push(t+e+n),m.vowel.push(t+e+n),g.consonant.push(t+e+n)})}),u.forEach(e=>{h.push(t+e),m.vowel.push(t+e),g.consonant.push(t+e),c.forEach(n=>{d.push(t+e+n),m.vowel.push(t+e+n),g.vowel.push(t+e+n)})})}else{const t=e;c.forEach(e=>{h.push(t+e),g.vowel.push(t+e),m.consonant.push(t+e),i.forEach(n=>{d.push(t+e+n),m.consonant.push(t+e+n)}),u.forEach(n=>{c.forEach(s=>{p.push(t+e+n+s),m.consonant.push(t+e+n+s),g.vowel.push(t+e+n+s),u.forEach(r=>{const a=t+e+n+s+r;f.push(a),m.consonant.push(a),g.consonant.push(a)})}),u.forEach(s=>{const r=t+e+n+s;p.push(r),m.consonant.push(r),g.consonant.push(r),c.forEach(e=>{const t=r+e;f.push(t),m.consonant.push(t),g.vowel.push(t)})})})})}}),t.ActorNames={};const y=/[aeiouy][aeiouy][aeiouy]/,v=/[xqjv]$/;t.ActorNames.getName=function(e=o){const t=parseInt(a.getWeighted(o),10);let n=!1,s="";for(;!n;){if(s="",1===t)s=a.arrayGetRand(f);else for(let e=0;e<t;e++){let e="";s+=e=r.default.isSuccess(.4)?a.arrayGetRand(h):r.default.isSuccess(.4)?a.arrayGetRand(d):a.arrayGetRand(p)}y.test(s)||v.test(s)||(n=!0)}return s.capitalize()};const _=u.concat(["th","gr","dr","wh"]),b=["th","r","l","n","ch","zh"];function E(e){return!y.test(e)&&!v.test(e)}t.ActorNames.getModName=function(){let e="";r.default.isSuccess(.5)&&(e=a.arrayGetRand(_),e+=a.arrayGetRand(m.vowel)),r.default.isSuccess(.25)&&(e=a.arrayGetRand(c)+e,r.default.isSuccess(.25)&&(e=a.arrayGetRand(c)+e));let n="";r.default.isSuccess(.5)&&(n=a.arrayGetRand(b),r.default.isSuccess(.5)&&(n+=a.arrayGetRand(g.vowel)));let s=e+n;const o=e+(s=s.length<2?t.ActorNames.getName({2:50,3:35}).toLowerCase():s.length<4?t.ActorNames.getName({2:50}).toLowerCase():r.default.isSuccess(.5)?a.arrayGetRand(p):a.arrayGetRand(f))+n;return E(o)?o.capitalize():t.ActorNames.getModName()},t.ActorNames.isNameOk=E},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(214),a=n(414),o=n(215),i=n(216),l=s(n(8));class c{constructor(e){this.fact=e,this.createFunc={}}addFunction(e,t){this.createFunc[e]=t}create(e,t){return c.levels.hasOwnProperty(e)?c.levels[e](...t):this.createFunc.hasOwnProperty(e)?this.createFunc[e](...t):this.fact?this.fact.createLevel(e,...t):(l.default.err("LevelFactory","create","No factory/factory function given. Name: "+e),null)}}t.LevelFactory=c,c.levels={Capital:(...e)=>new o.Capital(...e).getLevel(),DwarvenCity:(...e)=>new i.DwarvenCity(...e).getLevel(),AbandonedFort:(...e)=>new r.AbandonedFort(...e).getLevel(),BlackTower:(...e)=>new a.BlackTower(...e).getLevels()}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(194),o=n(114),i=n(157),l=n(12),c=n(31),u=9;t.BlackTower=class{constructor(e,t,n={}){this.nLevels=n.nLevels||5,this.cols=e||100,this.rows=t||50,this.tilesX=Math.round(this.cols/u),this.tilesY=Math.round(this.rows/u),this.conf=n}getLevels(){const e=new o.CastleGenerator,t={wallType:"wallice",genParams:[2,2,2,2],nGates:2,roomCount:-1,tilesX:this.tilesX,tilesY:this.tilesY},n=[e.createLevel(this.cols,this.rows,t)];delete t.nGates;for(let s=0;s<this.nLevels-2;s++)n.push(e.createLevel(this.cols,this.rows,t));const[s,r]=[Math.round(this.tilesX/2),Math.round(this.tilesY/2)];t.callbacks={},t.callbacks.afterInit=(e=>{a.Vault.templates.all.forEach(t=>{e.addTemplate(t)}),a.Vault.func.createHugeVault(s-1,r-2,e,"vault_center1","entrance_n")});const i=e.createLevel(this.cols,this.rows,t);return n.push(i),this.generateYard(n),this.addProps(n),n.forEach((t,n)=>{e.removeMarkers(t,{markersPreserved:!1,shouldRemoveMarkers:!0});const s={maxDanger:this.getDanger(n)+5,actorFunc:e=>"WinterBeingBase"===e.base};e.populateStoreRooms(t,s)}),n.map((e,t)=>({nLevel:t,level:e}))}getDanger(e){return 7+3*e}addProps(e){const t=new i.FactoryZone;e.forEach((e,n)=>{const s=this.getDanger(n),a={nLevel:n,minValue:50+10*n,maxValue:65+20*(n+1),sqrPerItem:200,sqrPerActor:40-2*n,maxDanger:s,actor:e=>"WinterBeingBase"===e.base};t.addItemsAndActors(e,a),e.getActors().forEach(e=>{const t=e.get("Experience");if(t){const n=t.getDanger(),a=s-n,o=t.getExpLevel(),i=o+a;i>o&&r.default.levelUpActor(e,i)}})})}generateYard(e){const t=e[0],[n,s]=t.getColsRows(),r=Math.round(1.4*s),a=Math.round(1.4*n),o=(new c.FactoryLevel).createLevel("arctic",a,r),i=Math.round((a-n)/2),u=Math.round((r-s)/2);l.Geometry.mergeLevels(o,t,i,u),o.getExtras().connectEdges=!0,e[0]=o}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(59),r=n(26),a=n(22);t.CryptGenerator=class extends s.LevelGenerator{static getOptions(){let e=s.LevelGenerator.getOptions();return e=Object.assign(e,{tilesX:12,tilesY:7,genParams:[2,2,2,2],roomCount:40})}constructor(){super(),this.shouldRemoveMarkers=!0}create(e,t,n){return this.createLevel(e,t,n)}createLevel(e,t,n){const s=new r.MapGenerator,o=new a.Level;s.setGen("crypt",e,t);const i=s.createCryptNew(e,t,n);return o.setMap(i.map),o}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=r(n(45)),i=n(15),l=n(9),c=n(14),u=n(20),h=l.Random.getRNG();t.DungeonFeatures=function(e){this._verif=new o.Conf("DungeonFeatures"),this._zoneType=e,this.addLastLevelFeatures=function(e,t,n){this._verif.verifyConf("addLastLevelFeatures",n,["maxDanger","maxValue"]);const s=new i.ElementExploration,r=10*(e+1)*n.maxDanger;Number.isInteger(r)||a.default.err("DungeonFeatures","addLastLevelFeatures",`expPoints NaN. nLevel: ${e}, dang: ${n.maxDanger}`),s.setExp(r),s.setData({zoneType:this._zoneType});const o=t.getParent();o&&o.getName&&s.addData("zoneName",o.getName());const l=t.getExtras();if(l&&l.endPoint){const[e,n]=l.endPoint;t.addElement(s,e,n)}else t.addElement(s);const c=this.generateBoss(e,t,n);if(c)this.addMinions(c,e,t,n);else{let n=`Failed to created boss. nLevel: ${e}`;n+=` Level parent: ${t.getParent()}`,a.default.debug({},n)}},this.generateBoss=((e,t,n)=>{this._verif.verifyConf("generateBoss",n,["maxDanger","maxValue"]);const s=c.ObjectShell.getParser(),r=n.maxDanger+2,o=s.createRandomActor({func:e=>e.danger<=r&&e.danger>=n.maxDanger});if(o){t.addActorToFreeCell(o);const e=2*n.maxValue,r=s.createRandomItem({func:t=>t.value<=e});if(r)o.getInvEq().addItem(r);else{const t=`Value: ${e}`;a.default.err("DungeonFeatures","generateBoss","Failed to create prize item: "+t)}}return o}),this.addMinions=((e,t,n,s)=>{const r=c.ObjectShell.getParser(),a=e.getType(),o=h.getUniform()<=.5;let i=t+1,l=s.maxDanger;o&&(i*=2,l-=1);const d=Math.round(Math.sqrt(i))+1,p=u.Brain.getBoxOfFreeCellsAround(e,d);h.shuffle(p);const f=e=>e.danger<=l&&e.type===a;for(;p.length>0&&i>0;){const e=p.pop();--i;const t=r.createRandomActor({func:f});if(t){const[s,r]=[e.getX(),e.getY()];n.addActor(t,s,r)}}})}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8));t.WinCondition=class{constructor(e,t){this._name=e,this.description="",this._condIncomplete={},this._condFilled={},this.pool=t,this._isTrue=!1,this.hasNotify=!0,this._notifyCallbacks={[r.default.EVT_ACTOR_KILLED]:this.actorKilledCallback.bind(this)}}getName(){return this._name}setPool(e){e!==this.pool&&this.pool.isListener(this)&&this.pool.removeListener(this),this.pool=e}isTrue(){return this._isTrue}addNotifyCallback(e,t){this._notifyCallbacks[e]=t}notify(e,t){this._notifyCallbacks.hasOwnProperty(e)&&this._notifyCallbacks[e](t),this._isTrue||0===Object.keys(this._condIncomplete).length&&(this._isTrue=!0,this.onTrue())}_addEvent(e){this.pool.listenEvent(e,this)}addActorKilled(e){this._addEvent(r.default.EVT_ACTOR_KILLED),this._condIncomplete[r.default.EVT_ACTOR_KILLED]=[e.getID()]}onTrue(){let e=`Condition: ${this._name}, Description: ${this.description}.`;e+="Congratulations. You have won!",r.default.gameSuccess(e),this.pool.emitEvent(r.default.EVT_WIN_COND_TRUE,{name:this._name})}actorKilledCallback(e){const t=e.actor,n=this._condIncomplete[r.default.EVT_ACTOR_KILLED];if(n){const e=n.indexOf(t.getID());e>=0&&(n.splice(e,1),0===n.length&&delete this._condIncomplete[r.default.EVT_ACTOR_KILLED])}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(9).Random.getRNG();t.Disposition=function(e,t){this.rivals=e,this.conf=Object.assign({},t),this.weights={default:{ally:20,neutral:50,enemy:30}}},t.Disposition.prototype.setWeights=function(e){this.weights=e},t.Disposition.prototype.addWeight=function(e,t){this.weights[e]=t},t.Disposition.prototype.getTable=function(){return this.dispTable},t.Disposition.prototype._initTable=function(){this.dispTable={},this.rivals.forEach(e=>{this.dispTable[e]={}})},t.Disposition.prototype.randomize=function(){this._initTable(),this.rivals.forEach(e=>{this.rivals.forEach(t=>{if(!this.pairDone(e,t)){const n=this.getWeights(e,t),s=a.getWeighted(n);this.dispTable[e][t]=s,this.dispTable[t][e]=s}})})},t.Disposition.prototype.getWeights=function(e,t){return this.weights.hasOwnProperty(e)?this.weights[e]:this.weights.hasOwnProperty(t)?this.weights[t]:this.weights.default},t.Disposition.prototype.pairDone=function(e,t){return e===t||!!this.dispTable[e][t]&&(this.dispTable[t][e]||r.default.err("Disposition","pairDone","Something went wrong. No [r2][r1] but [r1][r2] exists"),!0)},t.Disposition.prototype.toString=function(){}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(220),i=n(60),l=r(n(45)),c=n(17)("bitn:WorldFromJSON"),u=r(n(41));t.WorldFromJSON=class{constructor(e,t){this.id2level=e,this.id2entity=t,this._conf=new o.ConfStack,this._verif=new l.Conf("WorldFromJSON"),this.worldElemByID={},this.createAllZones=!0,this._IND=0}createPlace(e){switch(e.type){case"world":return this.createWorld(e);case"quarter":{const t=new a.default.Factory.World;return t.setId2Level(this.id2level),t.createCityQuarter(e)}default:a.default.err("WorldFromJSON","createPlace",`No place ${e.type} implemented yet`)}return null}createWorld(e){let t=null;if(e.conf)this.dbg("Creating a restored world now"),t=this.createRestoredWorld(e);else{a.default.err("WorldFromJSON","Should not be called at all.","ERROR"),this.dbg("Creating world using Factory.World fully");const n=new i.FactoryWorld;n.setId2Level(this.id2level),t=n.createWorld(e)}return t}createRestoredWorld(e){e.conf||a.default.err("WorldFromJSON","createRestoredWorld","No worldJSON.conf. Does not look like restored world.");const t=this.createWorldFromJSON(e);t.setConf(e.conf);const n=t.getAreas();if(n.length>0){const t=`${Object.keys(e.conf)}`;e.conf.hasOwnProperty("area")||a.default.err("WorldFromJSON","createRestoredWorld",`No prop 'area' in ${e.conf}. Props ${t}`)}return n.forEach((t,n)=>{t.setConf(e.conf.area[n])}),t}pushScope(e){this._conf.pushScope(e),this.fact.pushScope(e),++this._IND}popScope(e){this._conf.popScope(e),this.fact.popScope(e),--this._IND}getHierName(){return this._conf.getScope().join(".")}createWorldFromJSON(e){const t=new i.FactoryWorld;t.setId2Level(this.id2level),t.id2entity=this.id2entity,this.fact=t,this.verify("createWorld",e,["name","nAreas"]),e.hasOwnProperty("createAllZones")&&(this.createAllZones=e.createAllZones,this.dbg("createAllZones set to "+this.createAllZones),t.createAllZones=this.createAllZones),this.pushScope(e);const n=new u.WorldTop(e.name);n.setConf(e);for(let t=0;t<e.nAreas;t++){const s=e.area[t];c.enabled&&this.printKeys("areaJSON keys",s);const r=this.restoreAreaFromJSON(s);s.zonesCreated&&this.restoreCreatedZones(n,r),n.addArea(r),this.addWorldID(s,r)}return this.popScope(e),this.addWorldID(e,n),n}restoreAreaFromJSON(e){this.verify("restoreAreaFromJSON",e,["name","maxX","maxY"]),this.pushScope(e);const t=this.getAreaLevels(e),{name:n,maxX:s,maxY:r,cols:a,rows:o}=e,i=new u.Area(n,s,r,a,o,t);return i.setConf(e),i.setHierName(this.getHierName()),i.tilesLoaded=e.tilesLoaded,i.zonesCreated=e.zonesCreated,this.setTileJSONForUnloadedTiles(i,e),this.createAllZones?(this.fact._createAllZones(i,e),i.markAllZonesCreated()):this.dbg("Skipping the zone creating due to createZones=false"),this.popScope(e),i}restoreCreatedZones(e,t){Object.keys(t.zonesCreated).forEach(n=>{const[s,r]=n.split(","),[a,o]=[parseInt(s,10),parseInt(r,10)];t.zonesCreated[n]&&t.tilesLoaded[a][o]&&(this.dbg(`\tRestoring created zones for tile ${a},${o}`),this.restoreZonesForTile(e,t,a,o))})}restoreZonesForTile(e,t,n,s){const r=e.getConf();this.pushScope(r);const a=t.getConf();this.pushScope(a),this.fact._createAllZones(t,a,n,s),this.popScope(a),this.popScope(r)}getAreaLevels(e){this.verify("getAreaLevels",e,["tilesLoaded"]),++this._IND;const t=[];return e.tiles?e.tiles.forEach((n,s)=>{const r=[];n.forEach((t,n)=>{if(e.tilesLoaded[s][n]){this.dbg(`Tile ${s},${n} is loaded`);const e=this.id2level[t.level];e?r.push(e):a.default.err("WorldFromJSON","getAreaLevels",`No level ID ${t.level} in id2level`)}else this.dbg(`Will NOT load Tile ${s},${n}`),r.push(a.default.LEVEL_NOT_LOADED)}),t.push(r)}):a.default.err("WorldFromJSON","getAreaLevels","areaJSON.tiles cannot be null/undefined"),--this._IND,t}setTileJSONForUnloadedTiles(e,t){const n=e.getTiles();n.forEach((e,s)=>{e.forEach((e,r)=>{n[s][r]===a.default.TILE_NOT_LOADED&&(n[s][r]=t.tiles[s][r])})})}addWorldID(e,t){a.default.isNullOrUndef([e.id])||t.setID(e.id),this.worldElemByID[t.getID()]=t}dbg(e){if(c.enabled){const t=" ".repeat(this._IND);a.default.diag(t+"WorldFromJSON: "+e)}}verify(e,t,n){this._verif.verifyConf(e,t,n)}printKeys(e,t){a.default.diag(e),a.default.diag(Object.keys(t))}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(9).Random.getRNG(),o=["sunny","cloudy"],i=.1,l=.5,c=32;t.seasonConfig={AUTUMN:{dur:2,temp:[0,15],weather:[],index:0},AUTUMN_WINTER:{dur:1,temp:[-10,10],weather:["snowFall","coldRain"],index:1},WINTER:{dur:4,temp:[-35,3],weather:["snowFall","snowStorm","hailStorm"],index:2},WINTER_SPRING:{dur:1,temp:[-10,10],weather:["snowFall"],index:3},SPRING:{dur:1,temp:[7,15],weather:[],index:4},SPRING_SUMMER:{dur:1,temp:[10,20],weather:[],index:5},SUMMER:{dur:1,temp:[15,25],weather:[],index:6},SUMMER_AUTUMN:{dur:1,temp:[10,20],weather:["rain"],index:7}},t.biomePossibleSeasons={arctic:["WINTER"],alpine:["WINTER","WINTER_SPRING"],tundra:["AUTUMN_WINTER","WINTER","WINTER_SPRING"],taiga:["all"],forest:["all"],grassland:["all"]},t.getSeasonDist=function(e,n){const s=t.seasonConfig[e].index,r=t.seasonConfig[n].index;return Math.abs(s-r)};class u{constructor(e){this._currSeason=r.default.SEASON.AUTUMN,this._monthLeft=c,this._seasonLeft=t.seasonConfig[this._currSeason].dur,this._currWeather="sunny",this._seasonChanged=!1,this._weatherChanged=!1,this._monthChanged=!1,this._yearChanged=!1,this.pool=e}setOwPos(e){this._owPos=e}setBiomeMap(e){this._biomeMap=e}seasonChanged(){return this._seasonChanged}monthChanged(){return this._monthChanged}yearChanged(){return this._yearChanged}weatherChanged(){return this._weatherChanged}update(){--this._monthLeft,this._seasonChanged=!1,this._monthChanged=!1,this._yearChanged=!1,0===this._monthLeft&&(this._seasonLeft-=1,this._monthLeft=c,this._monthChanged=!0),this._seasonLeft<=0&&(this.nextSeason(),this._seasonChanged=!0,this._checkMsgEmits())}nextSeason(){const e=Object.keys(t.seasonConfig);let n=e.indexOf(this._currSeason)+1;n>=e.length&&(n=0,this._yearChanged=!0,this.pool.emitEvent(r.default.EVT_YEAR_CHANGED,{prevSeason:this._currSeason,nextSeason:e[n]})),this.pool.emitEvent(r.default.EVT_SEASON_CHANGED,{prevSeason:this._currSeason,nextSeason:e[n]}),this._currSeason=e[n]}getWeather(){return this._currWeather}changeWeather(){if(this._weatherChanged=!1,r.default.isSuccess(l))return this._currWeather;const e=this.getSeasonModified();let n=this._currWeather;if(r.default.isSuccess(i)){const s=t.seasonConfig[e].weather;s.length>0&&(n=a.arrayGetRand(s))}else n=a.arrayGetRand(o);return n!==this._currWeather&&(this._weatherChanged=!0),this.pool.emitEvent(r.default.EVT_WEATHER_CHANGED,{prevWeather:this._currWeather,nextWeather:n}),this._currWeather=n,this._currWeather}getSeason(){return this._currSeason}getSeasonModified(){if(!this._biomeMap)return this._currSeason;if(!this._owPos)return this._currSeason;const e=this._owPos[0]+","+this._owPos[1],n=this._biomeMap[e],s=t.biomePossibleSeasons[n];if("all"===s[0])return this._currSeason;return s.indexOf(this._currSeason)>=0?this._currSeason:s[0]}setPool(e){this.pool=e}toJSON(){return{currSeason:this._currSeason,currWeather:this._currWeather,monthLeft:this._monthLeft,seasonLeft:this._seasonLeft,seasonChanged:this._seasonChanged,weatherChanged:this._weatherChanged,monthChanged:this._monthChanged,yearChanged:this._yearChanged,owPos:this._owPos,biomeMap:this._biomeMap}}_checkMsgEmits(){this.seasonChanged()&&(this._currSeason===r.default.SEASON.AUTUMN_WINTER?r.default.gameMsg("Winter is approaching quickly!"):this._currSeason===r.default.SEASON.WINTER&&r.default.gameMsg("The call of Winter has arrived!"))}}t.SeasonManager=u,u.fromJSON=function(e){const t=new u;return t._currSeason=e.currSeason,t._currWeather=e.currWeather,t._monthLeft=e.monthLeft,t._seasonLeft=e.seasonLeft,t._seasonChanged=e.seasonChanged,t._weatherChanged=e.weatherChanged,t._monthChanged=e.monthChanged,t._yearChanged=e.yearChanged,t._owPos=e.owPos,t._biomeMap=e.biomeMap,t}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a={DAWN:{dur:1,visibility:-1},MORNING:{dur:3},NOON:{dur:3},AFTERNOON:{dur:3},EVENING:{dur:3,visibility:-1},DUSK:{dur:1,visibility:-2},NIGHT:{dur:7,visibility:-3}};class o{constructor(e){this._currPhase=r.default.DAY.MORNING,this._currPhaseLeft=a[this._currPhase].dur,this._updateRate=.05,this._dayChanged=!1,this._phaseChanged=!1,this.pool=e}setUpdateRate(e){this._updateRate=e}update(){this._dayChanged=!1,this._phaseChanged=!1,this._currPhaseLeft-=this._updateRate,this._currPhaseLeft<=0&&(this.nextPhase(),this._phaseChanged=!0)}dayChanged(){return this._dayChanged}phaseChanged(){return this._phaseChanged}getCurrPhase(){return this._currPhase}nextPhase(){const e=Object.keys(a);let t=e.indexOf(this._currPhase)+1;t>=e.length&&(t=0,this.pool.emitEvent(r.default.EVT_DAY_CHANGED,{prevPhase:this._currPhase,nextPhase:e[t]}),this._dayChanged=!0),this.pool.emitEvent(r.default.EVT_DAY_PHASE_CHANGED,{prevPhase:this._currPhase,nextPhase:e[t]}),this._currPhase=e[t],this._currPhaseLeft=a[this._currPhase].dur}toJSON(){return{currPhase:this._currPhase,currPhaseLeft:this._currPhaseLeft,updateRate:this._updateRate,dayChanged:this._dayChanged,phaseChanged:this._phaseChanged}}setPool(e){this.pool=e}}t.DayManager=o,o.fromJSON=function(e){const t=new o;return t._currPhase=e.currPhase,t._currPhaseLeft=e.currPhaseLef,t._updateRate=e.updateRate,t._dayChanged=e.dayChanged,t._phaseChanged=e.phaseChanged,t}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=r(n(66)),i=n(225),l=n(423);t.Engine=class{constructor(e){this.isGUICommand=(()=>!1),this.doGUICommand=null,this.nextActor=null,this.animation=null,this.animationCallback=null,this._levelMap={},this._activeLevels=[],this._scheduler=new o.Scheduler,this._msg=new l.MessageHandler(e),this._eventPool=e,this.visibleCells=[],this._cache={visibleCoord:{},visibleValid:!1},this.sysMan=new i.SystemManager(this,e),this.hasNotify=!0,this._eventPool.listenEvent(a.default.EVT_DESTROY_ITEM,this),this._eventPool.listenEvent(a.default.EVT_ACT_COMP_ADDED,this),this._eventPool.listenEvent(a.default.EVT_ACT_COMP_REMOVED,this),this._eventPool.listenEvent(a.default.EVT_ACT_COMP_ENABLED,this),this._eventPool.listenEvent(a.default.EVT_ACT_COMP_DISABLED,this),this._eventPool.listenEvent(a.default.EVT_LEVEL_PROP_ADDED,this),this._eventPool.listenEvent(a.default.EVT_LEVEL_CHANGED,this),this._eventPool.listenEvent(a.default.EVT_ANIMATION,this)}getMessages(){return this._msg.getMessages()}hasNewMessages(){return this._msg.hasNew()}clearMessages(){this._msg.clear()}isMenuShown(){return!(this.hasAnimation()||!this.nextActor.isPlayer())&&this.nextActor.getBrain().isMenuShown()}getPlayer(){return this.currPlayer}setPlayer(e){this.currPlayer=e}numActiveLevels(){return this._activeLevels.length}hasLevel(e){return this._levelMap.hasOwnProperty(e.getID())}getLevels(){return Object.values(this._levelMap)}isGameOver(){return!1}isActiveLevel(e){return this._activeLevels.indexOf(e.getID())>=0}hasAnimation(){return null!==this.animation&&this.animation.hasFrames()}finishAnimation(){this.animation=null}setVisibleArea(e,t){this.visibleLevelID=e.getID(),this.visibleCells=t,this._cache.visibleCoord={},this._cache.visibleValid=!1}canPlayerSeeAnimation(e){return e.levelID===this.visibleLevelID&&(this._cache.visibleValid||(this.visibleCells.forEach(e=>{this._cache.visibleCoord[e.getKeyXY()]=!0}),this._cache.visibleValid=!0),e.hasCoord(this._cache.visibleCoord))}enableAnimations(){this.sysMan.get("Animation").enableAnimations()}disableAnimations(){this.sysMan.get("Animation").disableAnimations()}addTimeSystem(e,t){const n=new o.GameEvent(100,t.update.bind(t),!0,0);this.addEvent(n)}addRegularUpdate(e,t=100){const n=new o.GameEvent(t,e.update.bind(e),!0,0);this.addEvent(n)}getComponents(){const e=this.getEntities();let t=[];return e.forEach(e=>{const n=Object.keys(e.getComponents());t=t.concat(n.map(e=>parseInt(e,10)))}),t}getEntities(){const e=this.getLevels();let t=[];return e.forEach(e=>{t=(t=(t=t.concat(e.getActors())).concat(e.getItems())).concat(e.getElements())}),t}updateGameLoop(e){for(this.playerCommand(e),this.currPlayer=this.nextActor,this.nextActor=this.getNextActor(),this.sysMan.updateLoopSystems();!this.nextActor.isPlayer()&&!this.isGameOver();){const e=this.nextActor.nextAction();if(this.doAction(e),this.sysMan.updateSystems(),this._scheduler.setAction(e),this.nextActor=this.getNextActor(),a.default.isNullOrUndef([this.nextActor])){a.default.err("Game.Engine","updateGameLoop","Game loop out of events! Fatal!");break}}this.isGameOver()||this.setPlayer(this.nextActor)}playerCommand(e){!1===this.nextActor.isPlayer()&&this.nextActorNotPlayerError();const t=this.nextActor,n=t.nextAction(e);this.doAction(n),this.sysMan.updateSystems(),t.has("ImpossibleCmd")?t.remove("ImpossibleCmd"):this._scheduler.setAction(n),this.playerCommandCallback(t)}simulateGame(e=1){for(let t=0;t<e;t++)if(this.nextActor=this.getNextActor(),this.nextActor.isPlayer())a.default.err("Engine","simulateGame","Doesn't work with player.");else{const e=this.nextActor.nextAction();this.doAction(e),this.sysMan.updateSystems(),this._scheduler.setAction(e)}}addLevel(e){const t=e.getID();this._levelMap.hasOwnProperty(t)?a.default.err("Game.Engine","addLevel","Level ID "+t+" already exists!"):this._levelMap[e.getID()]=e}removeLevels(e){e.forEach(e=>{const t=e.getID();if(this._levelMap.hasOwnProperty(t)){const e=this._activeLevels.indexOf(t);if(e>=0){this._activeLevels.splice(e,1);const n=this._levelMap[t];if(n){const e=n.getActors();for(let t=0;t<e.length;t++)e[t].get("Action").disable()}}delete this._levelMap[t]}else a.default.err("Game.Engine","removeLevels",`No level with ID ${t}`)})}addActiveLevel(e){const t=e.getID(),n=this._activeLevels.indexOf(t);if(this._activeLevels.length===a.default.MAX_ACTIVE_LEVELS)if(-1===n){const e=this._activeLevels.pop(),t=this._levelMap[e];if(t){const e=t.getActors();for(let t=0;t<e.length;t++){const n=e[t].get("Action");n&&n.disable()}a.default.debug(this,"Removed active level to make space...")}else{const t=Object.keys(this._levelMap).join(", ");a.default.err("Game.Engine","addActiveLevel",`Failed to remove level ID ${e}.\n                        IDs: ${t}`)}}else this._activeLevels.splice(n,1),this._activeLevels.unshift(t),a.default.debug(this,"Moved level to the front of active levels.");if(-1===n){this._activeLevels.unshift(t);const n=e.getActors();for(let e=0;e<n.length;e++){const t=n[e].get("Action");t&&t.enable()}}}notify(e,t){if(e===a.default.EVT_DESTROY_ITEM){const e=t.item;e.getOwner().getOwner().getInvEq().removeItem(e)||a.default.err("Game.Engine","notify - DESTROY_ITEM","Failed to remove item from inventory.")}else if(e===a.default.EVT_ACT_COMP_ADDED)t.hasOwnProperty("actor")?this.addActor(t.actor):a.default.err("Game.Engine","notify - ACT_COMP_ADDED","No actor specified for the event.");else if(e===a.default.EVT_ACT_COMP_REMOVED)t.hasOwnProperty("actor")?this.removeActor(t.actor):a.default.err("Game.Engine","notify - ACT_COMP_REMOVED","No actor specified for the event.");else if(e===a.default.EVT_ACT_COMP_ENABLED)t.hasOwnProperty("actor")?this.addActor(t.actor):a.default.err("Game.Engine","notify - ACT_COMP_ENABLED","No actor specified for the event.");else if(e===a.default.EVT_ACT_COMP_DISABLED)t.hasOwnProperty("actor")?this.removeActor(t.actor):a.default.err("Game","notify - ACT_COMP_DISABLED","No actor specified for the event.");else if(e===a.default.EVT_LEVEL_PROP_ADDED)"actors"===t.propType&&this.isActiveLevel(t.level)&&t.obj.get("Action").enable();else if(e===a.default.EVT_LEVEL_CHANGED){const e=t.actor;e.isPlayer()&&(this.addActiveLevel(e.getLevel()),t.src.onExit(),t.src.onFirstExit(),t.target.onEnter(),t.target.onFirstEnter())}else e===a.default.EVT_ANIMATION&&this.canPlayerSeeAnimation(t.animation)&&this.animationCallback&&(this.animation?this.animation.combine(t.animation):this.animation=t.animation,this.animationCallback(this.animation))}update(e){if(this.isGameOver())this.clearMessages(),this._eventPool.emitEvent(a.default.EVT_MSG,{msg:"GAME OVER!"}),this.simulateGame(100);else if(this.clearMessages(),null!==this.nextActor)if(e.hasOwnProperty("code")){const t=e.code;!this.isMenuShown()&&this.isGUICommand(t)?(this.doGUICommand(t),this.playerCommandCallback(this.nextActor)):this.updateGameLoop({code:t})}else this.updateGameLoop(e)}getNextActor(){return this._scheduler.next()}addActor(e){this._scheduler.add(e,!0,0)}removeActor(e){this._scheduler.remove(e)}addEvent(e){const t=e.getRepeat(),n=e.getOffset();this._scheduler.add(e,t,n)}doAction(e){if(e.doAction(),e.hasOwnProperty("energy")&&e.hasOwnProperty("actor")){const t=e.actor;t.has("Action")&&t.get("Action").addEnergy(e.energy)}}nextActorNotPlayerError(){let e="";e=this.nextActor.hasOwnProperty("isEvent")?"Expected player, got an event: ":"Expected player, got: "+this.nextActor.getName(),e+="\n"+JSON.stringify(this.nextActor),a.default.err("Engine","playerCommand",e)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8));t.MessageHandler=class{constructor(e){this._lastMsg=null,this._messages=[],this._prevMessages=[],this._hasNew=!1,this.hasNotify=!0,e.listenEvent(r.default.EVT_MSG,this)}notify(e,t){if(e===r.default.EVT_MSG&&t.hasOwnProperty("msg")){const e={msg:t.msg,style:"prim",count:1};t.hasOwnProperty("cell")&&(e.cell=t.cell),t.hasOwnProperty("style")&&(e.style=t.style),this._lastMsg&&this._lastMsg.msg===e.msg?this._lastMsg.count+=1:(this._lastMsg=e,this._messages.push(e)),this._hasNew=!0}}hasNew(){return this._hasNew}getMessages(){return this._hasNew=!1,this._messages.length>0?this._messages:this._prevMessages.length>0?this._prevMessages:[]}clear(){this._messages.length>0&&(this._prevMessages=this._messages.slice()),this._messages=[]}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(8)),o=n(135),i=n(116),l=n(43),c=n(9),u=n(18),h=r(n(11)),d=n(17)("bitn:GameMaster"),p=u.EventPool.getPool(),f=c.Random.getRNG();t.GameMaster=class{constructor(e,t=p){this.player=null,this.game=e,this.fact=new o.FactoryBattle,this.pool=t,this.battles={},this.battlesDone={},this.hasNotify=!0,this.pool.listenEvent(a.default.EVT_LEVEL_CHANGED,this),this.pool.listenEvent(a.default.EVT_TILE_CHANGED,this),this.pool.listenEvent(a.default.EVT_BATTLE_OVER,this),this.pool.listenEvent(a.default.EVT_CREATE_BATTLE,this)}setBattles(e){this.battles=e}setPool(e){this.pool=e}setGame(e){this.game=e}setPlayer(e){this.player=e}setWorld(e){this.world=e}notify(e,t){if(e===a.default.EVT_LEVEL_CHANGED){d("EVT_LEVEL_CHANGED");const{actor:e}=t;e.isPlayer()&&(e.has("InBattle")?this.removePlayerFromBattle(t):this.tryToAddPlayerToBattle(t))}else if(e===a.default.EVT_CREATE_BATTLE){d("EVT_CREATE_BATTLE");const{areaTile:e}=t;t.response&&a.default.err("GameMaster","notify<EVT_CREATE_BATTLE>",`Args has response already: ${JSON.stringify(t)}`);const n=e.getLevel(),s=this.createBattleIntoAreaTileLevel(n);s&&(t.response={battle:s})}else if(e===a.default.EVT_TILE_CHANGED){if(d("EVT_TILE_CHANGED"),!this.player)return void d("\tBut player is NULL for the moment");d("\tPlayer not null. Creating battle");const e=this.player.getLevel();this.createBattleIntoAreaTileLevel(e)}else if(e===a.default.EVT_EXPLORED_ZONE_LEFT)a.default.diag("Explored zone left");else if(e===a.default.EVT_BATTLE_OVER){const{battle:e}=t;d(`EVT_BATTLE_OVER: ${e.getName()}`);const n=e.getLevel().getID();if(d(`1. battlesDone for ${n}: ${this.battlesDone[n]}`),!this.battlesDone[n]&&e){d(`2. battlesDone for ${n}: ${this.battlesDone[n]}`),this.battlesDone[n]=!0,d(`3. battlesDone for ${n}: ${this.battlesDone[n]}`),this.addBadgesForActors(e),this.moveActorsOutOfBattle(e);const t=e.getName();a.default.gameMsg(`Battle ${t} is over!`)}else{const e=JSON.stringify(t);a.default.err("Game.Master","notify",`Args ${e} does not contain "battle"`)}d("GameMaster registered battle over")}}getLevelBbox(e,t,n,s,r){const[a,o]=[e.getSizeX(),e.getSizeY()],[i,l]=s,[c,u]=[t.getSizeX(),t.getSizeY()],[h,d]=r.getColsRows(),p=c*h/a,f=u*d/o,m=i%(a/c),g=l%(o/u);return{ulx:m*p,uly:g*f,lrx:(m+1)*p-1,lry:(g+1)*f-1}}tryToAddPlayerToBattle(e){const{actor:t,target:n,src:s}=e,r=s.getID();if(this.battles.hasOwnProperty(r)){const e=this.getBattle(r);if(e.isJSON)return;const s=e;if(s.getLevel().getID()===n.getID())if(this.actorCanEnter(t,s)){const e=new h.InBattle;e.setData({name:s.getName()}),t.add(e);const n=this.getSelArmyObject(t,s);t.getBrain().setSelectionObject(n)}else s.isOver()?a.default.gameMsg("Looks like the battle is already fought.."):a.default.gameMsg("You cannot join the fight anymore, deserter.")}}addBattle(e,t){this.battles[e].push(t)}getBattle(e){return this.battles[e][0]}getBattles(e){return this.battles[e]}actorCanEnter(e,t){return!t.isOver()&&!this.actorDesertedBattle(e,t)}removePlayerFromBattle(e){const{actor:t,target:n,src:s}=e,r=n.getID(),o=s.getID(),i=this.getBattle(r),l=i.getLevel().getID(),c=t.get("InBattle").getData();if(o!==l){const e=`Level ID mismatch: ${o} !== ${l}`;a.default.err("GameMaster","removePlayerFromBattle",e)}if(!i.isOver()&&c.army){const e=new h.BattleBadge;e.setData({status:"Fled",name:i.getName(),army:c.army}),t.add(e),t.remove("InBattle"),t.add(new h.BattleOver)}else i.isOver()||c.army||t.remove("InBattle")}addBadgesForActors(e){e.getArmies().forEach(t=>{const n=t.getActors(),s=n.map(e=>e.getID());n.forEach(n=>{if(!this.actorDesertedBattle(n,e)){const r=new h.BattleBadge,a={name:e.getName(),army:t.getName(),allies:s,status:t.isDefeated()?"Lost":"Won"};r.setData(a),n.add(r),n.remove("InBattle"),n.add(new h.BattleOver)}})})}actorDesertedBattle(e,t){return!!e.getList("BattleBadge").find(e=>e.getData().name===t.getName())}moveActorsOutOfBattle(e){const t=e.getLevel(),n=t.getConnections();n&&0!==n.length||a.default.err("Game.Master","moveActorsOutOfBattle","No exit connnection in level");const s=n[0].getTargetLevel();e.getArmies().forEach(e=>{e.getActors().forEach(e=>{if(e.isInLevel(t))if(e.isPlayer()){const n=this.getLeaveBattleMenu(e,t);e.getBrain().setSelectionObject(n)}else if(t.removeActor(e))s.addActorToFreeCell(e);else{const t=JSON.stringify(e.toJSON());a.default.err("Game.Master","moveActorsOutOfBattle",`level.removeActor failed for actor ${t}`)}})})}getSelArmyObject(e,t){const n=t.getArmies(),s=s=>{const r=n[s],o=t.getLevel();let i=r.getActors();const l=i.length,c=i[f.getUniformInt(0,l-1)],[u,h]=c.getXY();c.get("Action").disable(),r.removeActor(c),o.removeActor(c),i=r.getActors(),r.addActor(e),e.get("InBattle").updateData({army:r.getName}),i.forEach(t=>{t.addFriend(e)}),n.forEach(t=>{t!==r&&t.getActors().forEach(t=>{t.addEnemy(e)})}),o.moveActorTo(e,u,h)||a.default.err("GameMaster","getSelArmyObject",`Could not move player to ${u},${h}`)},r=n.map((e,t)=>[" Army "+e.getName(),s.bind(this,t)]);r.push(["Take no side",l.Menu.EXIT_MENU]);const o=new l.Menu.SelectRequired(r);return o.addPre("Please select an army to join:"),o}getLeaveBattleMenu(e,t){const n=[["Leave immediately",()=>{const n=t.getConnections()[0];if(t.moveActorTo(e,n.getX(),n.getY())){const t=new h.UseStairs;e.add(t);const n=e.getName();a.default.gameMsg(`${n} leaves the battlefield`)}else a.default.err("GameMaster","moveActorsOutOfBattle","Cannot move player to stairs cell")}],["Stay behind to scavenge the bodies of the dead.",l.Menu.EXIT_MENU]],s=new l.Menu.SelectRequired(n);return s.addPre("Battle is over! Do you want to leave battle?"),s}toJSON(){const e=Object.keys(this.battles),t={};return e.forEach(e=>{this.getBattles(e).forEach(n=>{t.hasOwnProperty(e)?a.default.warn("Game.Master","toJSON",`Battle for ID ${e} exists already`):t[e]=[],"function"==typeof n.toJSON?t[e].push(n.toJSON()):n.name?t[e].push(n):a.default.err("GameMaster","toJSON","Does not look like proper battle object.")})}),{battles:t,battlesDone:this.battlesDone}}unloadBattles(e){const t=e.getID();if(this.battles.hasOwnProperty(t)){const e=this.getBattles(t);this.battles[t]=[],e.forEach(e=>{if("function"==typeof e.toJSON){const n=e;n.isOver()||n.removeListeners(),this.battles[t].push(n.toJSON())}else a.default.err("GameMaster","unloadBattle",`Unload for level ${t} failed`)})}}biomeToLevelType(e){switch(e){case i.OW.BIOME.ARCTIC:case i.OW.BIOME.TUNDRA:return"arctic";case i.OW.BIOME.ALPINE:return"mountain";case i.OW.BIOME.TAIGA:default:return"forest"}}getBattleLevels(){const e=[];return Object.values(this.battles).forEach(t=>{t.forEach(t=>{t.isJSON||e.push(t.getLevel())})}),e}createBattleIntoAreaTileLevel(e){e||a.default.err("GameMaster","createBattleIntoAreaTileLevel","Parent level is null");const t=e.getID(),n=this.game.getOverWorld();let s=4,r=20;const o={};let i="forest",l=e.getBbox();if(n){const a=this.game.getCurrentWorld().getAreas()[0],o=a.findTileXYById(t),c=2,u=a.getSizeY()-1,h=Math.abs(c-o[0]),p=Math.abs(u-o[1]);d(`${`dx,dy: ${h},${p} armySize ${r+=20*p+10*h}`} , danger: ${s+=h+p}`);const f=this.game.getPlayerOwPos();if(f){const t=n.getBiome(f[0],f[1]);i=this.biomeToLevelType(t),d("Creating battle on tile "+o),l=this.getLevelBbox(n,a,o,f,e)}}if(o.maxDanger=s,o.armySize=r,o.levelType=i,o.bbox=l,!this.battles.hasOwnProperty(t)){this.battles[t]=[];const n=this.fact.createBattle(e,o);return this.addBattle(t,n),this.game.addBattle(this.getBattle(t),t),n}return null}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(35),r=n(22),a=n(9),o=n(12),i=n(19),l=n(17)("bitn:cave-br"),c=a.Random.getRNG(),u=4,h=.9,[d,p]=[3,16],[f,m]=[4,8],[g,y]=[40,80],[v,_]=[40,80],[b,E]=[2,4],S=[];class C{create(e,t,n){return w(e,t,n)}}function w(e,t,n){const a=new r.Level,l=new s.CellMap(e,t,i.ELEM.WALL);return n.mapWidth=e,n.mapHeight=t,n.connectedRatio=n.connectedRatio||1,function(e,t){++T;let{mapWidth:n,mapHeight:s}=t;n-=1,s-=1;let r=Math.floor((n+s)/2/10);t.numBranches&&(r=t.numBranches);I("Creating",r,"branches for level",`${n+1}x${s+1}`);const a=c.getUniformInt(v,_),l=c.getUniformInt(g,y),u=c.getUniformInt(b,E),h=n-1,d=s-1,p=Math.floor(r*t.connectedRatio);let f=[];for(let t=0;t<p;++t){if(I("Creating connected branch",t),++T,0===c.getUniformInt(0,1)){I("Creating vertical connected branch",t);const n=A(e,2,h,2,d,u,a,l,f);f=f.concat(n)}else{I("\tCreating horizontal connected branch",t);const n=N(e,2,h,2,d,u,a,l,f);f=f.concat(n)}--T}const m=[],C=r-p;for(let t=0;t<C;++t)if(0===c.getUniformInt(0,1)){const t=A(e,2,h,2,d,u,a,l,S);m.push(t)}else{const t=N(e,2,h,2,d,u,a,l,S);m.push(t)}0===f.length&&(f=c.arrayGetRand(m));t.connectAll&&m.forEach(n=>{const[s,r]=c.arrayGetRand(n),[a,l]=c.arrayGetRand(f),u=o.Geometry.getCaveConnLine(s,r,a,l);!function(e,t,n){t.forEach(t=>{const[s,r]=t;e.hasXY(s,r)&&e.setBaseElemXY(s,r,n)})}(e,u,i.ELEM.FLOOR),t.appendConnected&&(f=f.concat(n))});(function(e,t,n){for(let s=0;s<=t;++s)e.setBaseElemXY(s,0,i.ELEM.WALL),e.setBaseElemXY(s,n,i.ELEM.WALL);for(let s=0;s<=n;++s)e.setBaseElemXY(0,s,i.ELEM.WALL),e.setBaseElemXY(t,s,i.ELEM.WALL)})(e,n,s),--T}(l,n),a.setMap(l),a}t.CaveBrGenerator=C,C.getOptions=(()=>({appendConnected:!1,connectAll:!0,connectedRatio:.5,numBranches:30,mapWidth:150,mapHeight:150})),t.createCaveLevel=w;let T=0;function O(e,t,n,s,r,a){++T;let o=c.getUniformInt(f,m),[i,l,d]=[0,0,0];if("h"===a){if(e.length>0){const[u,h]=c.arrayGetRand(e);I("Branch will start from",u,h,"type",a),l=h,I("xs, ys, blen",i=L(u,s),l,d=s-i-3),[o,i,l]=M(t,s,n,r,i,l,o,a),I("ADJ xs, ys, blen",i,l,d)}else I("no caveCoord xs, ys, blen",i=k(t,s,h),l=k(n,r,h),d=s-i-3);return[i,l,d=Math.floor(d/u),o]}if("v"===a){if(e.length>0){const[u,h]=c.arrayGetRand(e);I("Branch will start from",u,h,"type",a),I("xs, ys, blen",i=u,l=L(h,r),d=Math.floor(r-l-3)),[o,i,l]=M(t,s,n,r,i,l,o,a),I("ADJ xs, ys, blen",i,l,d)}else I("no caveCoord xs, ys, blen",i=k(t,s,h),l=k(n,r,h),d=r-l-3);return[i,l,d=Math.floor(d/u),o]}--T}function M(e,t,n,s,r,a,o,i){return++T,o<d?o=d:o>p&&(o=p),"v"===i&&(r<=e&&(r=e+1),r+o>=t&&(o=t-(r=t-o-1))),"h"===i&&(a<n&&(a=n+1),a+o>=s&&(o=s-(a=s-o-1))),--T,[o,r,a]}function A(e,t,n,s,r,a,o,i,l){++T;const u=[],[h,d,p,f]=O(l,t,s,n,r,"v"),m=h+f;P(e,h,m,d);for(let e=h;e<=m;e++)u.push([e,d]);let g=h,y=d,v=f;I("createVerCaveBranch magn:",a,"brLen",p);const _=D(-a,a).filter(e=>0!==e),b=D(-a,a).filter(e=>0!==e);for(let a=0;a<p;++a){if(y+=1,c.getUniformInt(1,100)<=i){v+=c.arrayGetRand(_)}if(c.getUniformInt(1,100)<=o){g+=c.arrayGetRand(b)}[v,g,y]=M(t,n,s,r,g,y,v,"v");const a=g+v;P(e,g,a,y);for(let e=g;e<=a;e++)u.push([e,y])}if(v>3)for(I("Ver br starting to round, width:",v);s<y&&y<r-1;){y+=1;const t=(g+=1)+(v=R(v,a));P(e,g,t,y);for(let e=g;e<=t;++e)u.push([e,y]);if(v<3)break}return--T,u}function N(e,t,n,s,r,a,o,i,l){++T;const u=[],[h,d,p,f]=O(l,t,s,n,r,"h"),m=d+f;x(e,d,m,h);for(let e=d;e<=m;++e)u.push([h,e]);let g=h,y=d,v=f;const _=D(-a,a).filter(e=>0!==e),b=D(-a,a).filter(e=>0!==e);I("Hor branch Magnitude is ",a,"brLen",p);for(let a=0;a<p;++a){if(g+=1,c.getUniformInt(1,100)<=i){v+=c.arrayGetRand(_)}if(c.getUniformInt(1,100)<=o){y+=c.arrayGetRand(b)}[v,g,y]=M(t,n,s,r,g,y,v,"h");const a=y+v;x(e,y,a,g);for(let e=y;e<=a;++e)u.push([g,e])}if(v>3)for(I("Hor br starting to round, width:",v);t<g&&g<n-1;){g+=1;const t=(y+=1)+(v=R(v,a));x(e,y,t,g);for(let e=y;e<=t;++e)u.push([g,e]);if(v<3)break}return--T,u}function P(e,t,n,s){++T;const r=Math.min(t,n),a=Math.max(t,n);I("createHoriSlice x:",r,"->",a,"y:",s);for(let t=r;t<=a;++t)e.hasXY(t,s)&&e.setBaseElemXY(t,s,i.ELEM.FLOOR);--T}function x(e,t,n,s){++T;const r=Math.min(t,n),a=Math.max(t,n);I("createVertSlice x:",s,"y:",r,"->",a);for(let t=r;t<=a;++t)e.hasXY(s,t)&&e.setBaseElemXY(s,t,i.ELEM.FLOOR);--T}function I(...e){if(l.enabled){const t=" ".repeat(T);console.log(t+"[DBG]",...e)}}function D(e,t,n){n||(n=1);const s=[];if(t<e||n<1)return[];if(void 0===t)for(let t=0;t<e;t+=n)s.push(t);else for(let r=e;r<t;r+=n)s.push(r);return s}function k(e,t,n){return e+c.getUniformInt(e,Math.floor(t*n))}function L(e,t){const n=Math.floor(.5*t);return e>Math.floor(.5*t)?e-2*(e-n):e}function R(e,t){return e-t<=1?1:e-t}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(1)),o=r(n(80)),i=r(n(8)),l=s(n(11)),c=r(n(62));class u extends a.Component{constructor(e){super(e),this.state={tabShown:"CharInfo"}}selectTab(e){this.setState({tabShown:e})}toggleScreen(e){this.props.toggleScreen(e)}render(){const e=this.renderTabElement(this.state.tabShown),t=this.renderTabButtons();return a.createElement(c.default,{"aria-labelledby":"char-info-modal-label",id:"char-info-modal",large:!0,onHide:this.toggleScreen.bind(this,"CharInfo"),show:this.props.showCharInfo},a.createElement(o.default,{id:"char-info-modal-label",text:"Character info"}),t,e,a.createElement("div",{className:"modal-footer row"},a.createElement("div",{className:"col-md-6"},"Placeholder"),a.createElement("div",{className:"col-md-6"},a.createElement("button",{className:"btn btn-danger",onClick:this.toggleScreen.bind(this,"CharInfo"),type:"button"},"Close"))))}renderTabElement(e){const t=this.props.player;return"CharInfo"===e?this.renderCharInfoGeneral(t):"Effects"===e?this.renderEffectsTab(t):"Skills"===e?this.renderSkillsTab(t):"Battles"===e?this.renderBattlesTab(t):"Quests"===e?this.renderQuestsTab(t):null}renderTabButtons(){const e=u.menuTabs.map(e=>a.createElement("button",{className:"tab-select-button",key:e,onClick:this.selectTab.bind(this,e)},e));return a.createElement("ul",null,a.createElement("ul",{className:"modal-tab-list"},e))}renderCharInfoGeneral(e){let t="None";e.has("ActorClass")&&(t=e.get("ActorClass").getClassName());const n=e.get("Experience").getExpLevel(),s=e.get("Experience").getExp(),r=this.getExploreInfo(e),o=i.default.getExpRequired(n+1),l=o-s,c=i.default.getMissileAttackInfo(e),u=i.default.getMeleeAttackInfo(e);return a.createElement("div",null,a.createElement("div",{className:"modal-body row",id:"char-info-general"},a.createElement("div",{className:"col-md-6"},a.createElement("h2",null,"General info"),a.createElement("p",null,"Name: ",e.getName()),a.createElement("p",null,"Class: ",t),a.createElement("p",null,"Race: ",e.getType()),a.createElement("p",null,"Exp. level: ",n),a.createElement("p",null,"Exp. points: ",s),a.createElement("p",null,"To next level: ",l," (",o,")")),a.createElement("div",{className:"col-md-6"},a.createElement("h2",null,"Exploration"),r)),a.createElement("div",{className:"modal-body row"},a.createElement("div",{className:"col-md-6"},a.createElement("h2",null,"Combat info"),a.createElement("p",null,"Melee: ",u),a.createElement("p",null,"Missile: ",c)),a.createElement("div",{className:"col-md-6",id:"char-info-box"},a.createElement("h2",null,"Also random"),a.createElement("p",null,"Someting goes here."))))}renderEffectsTab(e){const t=Object.values(e.getComponents()).map((e,t)=>{const n=l[e.getType()].description;return n?a.createElement("p",{key:t},a.createElement("span",{className:"text-info"},e.getType())," - ",n):null});return a.createElement("div",{className:"modal-body row",id:"char-info-components"},a.createElement("div",{className:"col-md-6",id:"char-info-box"},a.createElement("h2",null,"List of effects on player"),t))}renderSkillsTab(e){let t=null;if(e.has("Skills")){const n=e.get("Skills");t=Object.keys(n.getSkills()).map(e=>a.createElement("li",{key:e},e," L: ",n.getLevel(e)," P: ",n.getPoints(e)))}else t=a.createElement("li",null,"Actor has no skills.");return a.createElement("div",{className:"modal-body row",id:"char-info-skills"},a.createElement("div",{className:"col-md-6",id:"char-info-box"},a.createElement("h2",null,"List of Skills"),a.createElement("ul",null,t)))}renderBattlesTab(e){const t=e.getList("BattleBadge").map(e=>a.createElement("li",{key:e.getID()},a.createElement("p",null,"Name: ",e.getData().name,", Status: ",e.getData().status,", Kills: ",e.getData().kill)));return a.createElement("div",{className:"modal-body row",id:"char-info-battles"},a.createElement("div",{className:"col-md-6",id:"char-info-box"},a.createElement("h2",null,"Battles fought"),a.createElement("ul",null,t)))}renderQuestsTab(e){const t=e.getList("Quest").map(e=>a.createElement("li",{key:e.getID()},a.createElement("p",null,e.toString())));return a.createElement("div",{className:"modal-body row",id:"char-info-quests"},a.createElement("div",{className:"col-md-6",id:"char-info-box"},a.createElement("h2",null,"Quests received:"),a.createElement("ul",null,t)))}getExploreInfo(e){if(e.has("GameInfo")){const t=e.get("GameInfo").getData().zones,n=[];let s=0;return Object.keys(t).forEach((e,r)=>{const o=a.createElement("p",{key:e+"_"+r},e,": Explored ",t[e]," zones");n.push(o),s+=t[e]}),n.push(a.createElement("p",{key:"total-explored"},"Total number of places explored: ",s)),n}return a.createElement("p",null,"No exploration info available")}}t.default=u,u.menuTabs=["CharInfo","Effects","Skills","Battles","Quests"]},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1)),a=n(262);t.default=class extends r.default.Component{constructor(e){super(e),this.handleSelect=this.handleSelect.bind(this)}handleSelect(e){const t=e.split("#"),n=t.shift();this.props.menuCallback(n,t)}render(){return r.default.createElement("div",{className:"game-top-menu"},r.default.createElement(a.Nav,{activeKey:"1",bsStyle:"tabs",onSelect:this.handleSelect},r.default.createElement(a.NavDropdown,{eventKey:"game",id:"dropdown-game",title:"Game"},r.default.createElement(a.MenuItem,{eventKey:"showScreen#StartScreen"},"New"),r.default.createElement(a.MenuItem,{eventKey:"showScreen#LoadScreen"},"Load"),r.default.createElement(a.MenuItem,{eventKey:"loadFromScript"},"Load from script"),r.default.createElement(a.MenuItem,{eventKey:"saveGame#saveGame"},"Save"),r.default.createElement(a.MenuItem,{eventKey:"importJSON"},"Import JSON"),r.default.createElement(a.MenuItem,{eventKey:"game-export"},"Export JSON"),r.default.createElement(a.MenuItem,{eventKey:"setPlayerDriver"},"Load bot")),r.default.createElement(a.NavDropdown,{eventKey:"view",id:"dropdown-view",title:"View"},r.default.createElement(a.MenuItem,{eventKey:"setViewSize#+#X"},"Viewport +X"),r.default.createElement(a.MenuItem,{eventKey:"setViewSize#-#X"},"Viewport -X"),r.default.createElement(a.MenuItem,{eventKey:"setViewSize#+#Y"},"Viewport +Y"),r.default.createElement(a.MenuItem,{eventKey:"setViewSize#-#Y"},"Viewport -Y")),r.default.createElement(a.NavDropdown,{eventKey:"help",id:"dropdown-help",title:"Help"},r.default.createElement(a.MenuItem,{eventKey:"showScreen#HelpScreen"},"Help"),r.default.createElement(a.MenuItem,{eventKey:"showScreen#ManualScreen"},"Manual"),r.default.createElement(a.MenuItem,{eventKey:"showScreen#AboutScreen"},"About")),r.default.createElement(a.NavDropdown,{eventKey:"plugins",id:"dropdown-plugins",title:"Plugin"},r.default.createElement(a.MenuItem,{eventKey:"loadScript"},"Load script"),r.default.createElement(a.MenuItem,{eventKey:"showPluginManager"},"Plugin Manager"))))}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1)),a=n(62);t.default=class extends r.Component{constructor(e){super(e),this.state={progress:[]},this.onHide=this.onHide.bind(this)}render(){const e=this.renderProgressMsg();let t=null;const n=this.props.progress;if(n&&n.length>0)if("DONE"===n){const e=this.state.progress.length-1;let t=this.state.progress[e];t+=n,this.state.progress[e]=t}else this.state.progress.push(this.props.progress);return this.props.gameCreated&&(t=this.renderDoneButton()),r.createElement(a,{"aria-labelledby":"game-create-modal-label",id:"gameCreateModal",large:!0,onHide:this.onHide.bind(this),show:this.props.showCreateScreen},r.createElement(a.Header,{closeButton:!0},r.createElement(a.Title,{id:"game-start-modal-label"},"Creating the game")),r.createElement(a.Body,null,e),r.createElement(a.Footer,null,t))}onHide(){this.state.progress=[],this.toggleScreen("CreateScreen")}renderProgressMsg(){const e=this.state.progress.map((e,t)=>{const n=t+e.substring(0,1);return r.createElement("li",{className:"text-info",key:n},e)});return r.createElement("ul",null,e)}renderDoneButton(){return r.createElement("button",{className:"btn btn-success","data-dismiss":"modal",id:"embark-button",onClick:this.onHide,type:"button"},"Continue")}toggleScreen(e){this.props.toggleScreen(e)}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1));t.default=class extends r.Component{shouldComponentUpdate(){return!1}render(){return r.createElement("input",{id:this.props.inputId,onChange:this.props.onLoadScript,style:{display:"none"},type:"file"})}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1)),a=(e,t,n)=>r.createElement("input",{checked:n,name:e,onChange:t,type:"checkbox"}),o=e=>r.createElement("button",{className:"btn-xs btn-danger",onClick:e},"Delete");t.default=class extends r.Component{constructor(e){super(e),this.state={msg:""}}render(){const{plugins:e}=this.props,t=this.renderPluginList(e),n=this.renderMsg();return r.createElement("div",{className:"plugin-manager"},r.createElement("h2",null,"Plugin manager"),r.createElement("p",null,"You can enable/disable loaded plugins from here. Tick the box below to enable plugin loading."),n,r.createElement("div",null,r.createElement("input",{id:"plugin-maybe-unsafe",name:"input-unsafe",type:"checkbox"}),"I understand the risk of loading scripts from untrusted sources."),t)}onDelete(e){this.props.pluginManager.deletePlugin(e),this.props.updatePluginList()}isUnsafeChecked(){return document.querySelector("#plugin-maybe-unsafe").checked}onChange(e){if(this.isUnsafeChecked()){const t=e.target,n=t.checked,s=t.name;n?this.props.pluginManager.enablePlugin(s):this.props.pluginManager.disablePlugin(s),this.setState({msg:""}),this.props.updatePluginList()}else{const e="You must tick the box before loading plugins.";this.setState({msg:e})}}renderMsg(){return""===this.state.msg?null:r.createElement("p",{className:"text-danger"},this.state.msg)}renderPluginList(e){const t=e.map(e=>{const t=e.getName(),n=this.onChange.bind(this),s=this.onDelete.bind(this,t),i=e.isEnabled(),l=e.hasError()?"text-danger":"";return r.createElement("tr",{key:t},r.createElement("td",null,a(t,n,i)),r.createElement("td",null,t),r.createElement("td",null,e._description),r.createElement("td",null,e._type),r.createElement("td",null,r.createElement("span",{className:l},e._status)),r.createElement("td",null,o(s)))});return r.createElement("table",{className:"table table-dark plugin-table"},r.createElement("thead",null,r.createElement("tr",null,r.createElement("th",null,"Enabled"),r.createElement("th",null,"Name"),r.createElement("th",null,"Description"),r.createElement("th",null,"Type"),r.createElement("th",null,"Status"),r.createElement("th",null))),r.createElement("tbody",null,t))}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(1)),o=r(n(8)),i=r(n(432)),l=n(252);t.default=class extends a.Component{constructor(e){super(e),this.changeMapView=this.changeMapView.bind(this)}changeMapView(){this.props.showMap?this.props.setViewType(l.VIEW_PLAYER):this.props.setViewType(l.VIEW_MAP)}render(){const e=this.props.player,t=e.getName(),n=this.props.selectedItem,s=this.props.selectedCell;let r="";null!==n&&(r="Selected: "+n.getName());let l="";s&&s.hasActors()&&(l="Cell: "+s.getProp("actors")[0].getName());let c="Move: ",u="text-info";e.getBrain().isRunModeEnabled()?(c+=" Running",u="text-danger"):c+=" Walking";const h=e.getBrain().getFightMode();let d="Fight: ";h===o.default.FMODE_NORMAL?d+="Normal":h===o.default.FMODE_SLOW?d+="Slow":h===o.default.FMODE_FAST&&(d+="Fast");const p=this.getPlayerStatus(e);let f="Map View";return this.props.showMap&&(f="Player View"),a.createElement("div",{className:"game-stats"},a.createElement("p",null,t),a.createElement(i.default,{player:e}),a.createElement("ul",{className:"player-mode-list"},a.createElement("li",{className:u},c),a.createElement("li",{className:"text-primary"},d),a.createElement("li",{className:"text-warning"},r),a.createElement("li",{className:"text-danger"},l)),p,a.createElement("button",{className:"btn btn-xs btn-rg btn-info",id:"inventory-button",onClick:this.toggleScreen.bind(this,"Inventory")},"Inventory"),a.createElement("button",{className:"btn btn-xs btn-rg btn-info",id:"stats-button",onClick:this.toggleScreen.bind(this,"CharInfo")},"CharInfo"),a.createElement("button",{className:"btn btn-xs btn-rg btn-info",id:"map-player-button",onClick:this.changeMapView},f),a.createElement("button",{className:"btn btn-xs btn-rg btn-info",id:"show-overworld-button",onClick:this.toggleScreen.bind(this,"OWMap")},"Overworld"))}toggleScreen(e){this.props.toggleScreen(e)}getPlayerStatus(e){const t=[];return l.STATUS_COMPS_GUI.forEach(n=>{const[s,r,o,i]=n;e.has(s)&&t.push(a.createElement("p",{className:"text-"+r,key:i},o))}),t}}},function(e,t,n){"use strict";var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1)),a=n(53);t.default=class extends r.Component{constructor(e){super(e)}render(){const e=this.props.player,t=a.SentientActor.getFormattedStats(e),n=[];let s=0;for(const e in t)if(e){const a=t[e];if(Array.isArray(a)){const t=a[1];let o="",i="";t<0?(o="text-danger",i=`(${a[1]})`):t>0&&(o="text-success",i=`(+${a[1]})`),n.push(r.createElement("li",{className:o,key:e+","+s},e,": ",`${a[0]}${i}`))}else n.push(r.createElement("li",{key:e+","+s},e,": ",a));++s}return r.createElement("ul",{className:"game-stats-list"},n)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(65),o=n(28),i={hasItems:()=>[o.Keys.KEY.PICKUP],hasConnection:()=>[o.Keys.KEY.USE_STAIRS_DOWN],hasUsable:()=>[]},l=["hasItems","hasConnection","hasUsable"],c={hasDoor:()=>[o.Keys.KEY.DOOR],hasActors:(e,t)=>{const n=r.default.dXdY(t,e),s=o.Keys.KeyMap.dirToKeyCode(n);return[o.Keys.KEY.CHAT,s]}},u=["hasDoor","hasActors"];t.MultiKeyHandler=class{getKeys(e){const t=e.getCell();for(let n=0;n<l.length;n++){const s=l[n];if(t[s]())return i[s](e,t)}const n=a.Brain.getCellsAroundActor(e);for(let t=0;t<u.length;t++){const s=u[t];for(let t=0;t<n.length;t++){const r=n[t];if(r[s]())return c[s](e,r)}}return null}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(435));t.MyWorkerImport=r.default},function(e,t,n){e.exports=function(){return new Worker(n.p+"5f53a4b18b897b49e1d3.worker.js")}},function(module,exports,__webpack_require__){"use strict";(function(global){var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(exports,"__esModule",{value:!0});const rg_1=__importDefault(__webpack_require__(8)),objectshellparser_1=__webpack_require__(14),chai_1=__webpack_require__(437),AllCode=__importStar(__webpack_require__(466)),PLUGIN_TYPES=["plugin","items","actors","elements","system","spell"];class PluginEntry{constructor(e){this._enabled=!1,this._type=e.type,this._data=e.data,this._name=e.name,this._description=e.description,this._fileType=e.fileType,this._status="UNLOADED",this._errorMsg="",this._test=e.test,this._onLoad=e.onLoad,this._onRemove=e.onRemove}getData(){return this._data}hasError(){return/ERROR/.test(this._status)}getError(){return this._errorMsg}disable(){if(this._enabled){if("function"==typeof this._onRemove)try{this._onRemove(),this._status="UNLOADED",this._errorMsg=""}catch(e){throw this._errorMsg=e.message,this._status="UNLOAD ERROR",new Error(`${this._name}: ${e.message}`)}this._enabled=!1}}enable(){if(!this._enabled){if("function"==typeof this._onLoad)try{this._onLoad(),this._status="LOADED",this._errorMsg=""}catch(e){throw this._errorMsg=e.message,this._status="LOAD ERROR",new Error(`${this._name}: ${e.message}`)}this._enabled=!0}}getName(){return this._name}getType(){return this._type}isEnabled(){return this._enabled}runTest(){this._test&&this._test(chai_1.expect)}toJSON(){return{type:this._type,fileType:this._fileType,name:this._name,data:this._data,description:this._description}}}exports.PluginEntry=PluginEntry;class PluginManager{constructor(){this.parseShellsOnRead=(e=>{const t=e.getData(),n=e.getType();[rg_1.default.TYPE_ACTOR,rg_1.default.TYPE_ITEM,rg_1.default.TYPE_ELEM].forEach(e=>{if(n===e){objectshellparser_1.ObjectShell.getParser().parseShellCateg(e,t)}})}),this._plugins=[],this._errorMsg="",this._readCallbacks={[rg_1.default.TYPE_ACTOR]:this.parseShellsOnRead,[rg_1.default.TYPE_ITEM]:this.parseShellsOnRead,[rg_1.default.TYPE_ELEM]:this.parseShellsOnRead},this._globalRefsWereSet=!1}static fromJSON(e){const t=new PluginManager;return e.forEach(e=>{"json"===e.fileType?t.readJSON(e):t.loadScript(e.data)}),t.enableAll(),t}readJSON(e){e.fileType="json";const t=this.addPlugin(e),n=t.getType();return this._readCallbacks[n]&&this._readCallbacks[n](t),t}loadScript(text){let entry=null;try{this.setGlobalRefs();let pluginData=null;eval(text),pluginData?(pluginData.data=text,pluginData.fileType="script",entry=this.addPlugin(pluginData),this._errorMsg=""):this._errorMsg="no pluginData specified in the script",this._globalRefsWereSet&&this.unsetGlobalRefs()}catch(e){throw this._errorMsg=e.message,this._globalRefsWereSet&&this.unsetGlobalRefs(),e}return entry}loadGameFromScript(text){const entry={levels:null,game:null};try{let game=null,levels=null;if(this.setGlobalRefs(),eval(text),game)entry.game=game;else{if(!levels)throw new Error("Script must set game or levels!");entry.levels=levels}this._globalRefsWereSet&&this.unsetGlobalRefs()}catch(e){throw this._errorMsg=e.message,this._globalRefsWereSet&&this.unsetGlobalRefs(),e}return entry}anyPluginsEnabled(){for(let e=0;e<this._plugins.length;e++)if(this._plugins[e].isEnabled())return!0;return!1}findPlugin(e){return this._plugins.find(t=>t._name===e)}getPlugins(){return this._plugins.slice()}getPluginNames(){return this._plugins.map(e=>e._name)}addPlugin(e){this.validateType(e);const t=new PluginEntry(e);return this._plugins.push(t),t}deletePlugin(e){const t=this._plugins.findIndex(t=>t.getName()===e);t>=0&&(this._plugins[t].disable(),this._plugins[t].hasError()&&(this._errorMsg=this._plugins[t].getError()),this._plugins.splice(t,1))}disablePlugin(e){const t=this.findPlugin(e);this._errorMsg="",t?(this.setGlobalRefs(),t.disable(),t.hasError()&&(this._errorMsg=t.getError()),this.unsetGlobalRefs()):this._errorMsg="Could not find plugin "+e}enablePlugin(e){const t=this.findPlugin(e);t&&(this.setGlobalRefs(),t.enable(),t.hasError()&&(this._errorMsg=t.getError()),this.unsetGlobalRefs())}enableAll(){this._errorMsg="",this.setGlobalRefs(),this._plugins.forEach(e=>{e.enable(),e.hasError()&&(this._errorMsg+=e.getError()+"\n")}),this.unsetGlobalRefs()}disableAll(){this._errorMsg="",this.setGlobalRefs(),this._plugins.forEach(e=>{e.disable(),e.hasError()&&(this._errorMsg+=e.getError()+"\n")}),this.unsetGlobalRefs()}getError(){return this._errorMsg}toJSON(){return this._plugins.map(e=>e.toJSON())}setGlobalRefs(){"undefined"!=typeof window?window.RG||(this._globalRefsWereSet=!0,window.RG=AllCode):void 0!==global&&(global.RG||(this._globalRefsWereSet=!0,global.RG=AllCode))}unsetGlobalRefs(){this._globalRefsWereSet=!1,"undefined"!=typeof window?window.RG=void 0:void 0!==global&&(global.RG=void 0)}withGlobalRefs(e){this.setGlobalRefs(),e(),this.unsetGlobalRefs()}validateType(e){if(!e.type)throw new Error("pluginData must have type specified");if(PLUGIN_TYPES.indexOf(e.type)<0){let t="type must be any of the following: ";throw t+=JSON.stringify(PLUGIN_TYPES),t+=` but got |${e.type}|`,new Error(t)}}}exports.PluginManager=PluginManager}).call(this,__webpack_require__(89))},function(e,t,n){e.exports=n(438)},function(e,t,n){
/*!
 * chai
 * Copyright(c) 2011-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
var s=[];
/*!
 * Chai version
 */(t=e.exports={}).version="3.5.0",
/*!
 * Assertion Error
 */
t.AssertionError=n(255);
/*!
 * Utils for plugins (not exported)
 */
var r=n(439);t.use=function(e){return~s.indexOf(e)||(e(this,r),s.push(e)),this},
/*!
 * Utility Functions
 */
t.util=r;
/*!
 * Configuration
 */
var a=n(75);t.config=a;
/*!
 * Primary `Assertion` prototype
 */
var o=n(461);t.use(o);
/*!
 * Core Assertions
 */
var i=n(462);t.use(i);
/*!
 * Expect interface
 */
var l=n(463);t.use(l);
/*!
 * Should interface
 */
var c=n(464);t.use(c);
/*!
 * Assert interface
 */
var u=n(465);t.use(u)},function(e,t,n){
/*!
 * test utility
 */
(t=e.exports={}).test=n(440),
/*!
 * type utility
 */
t.type=n(163),
/*!
 * expectTypes utility
 */
t.expectTypes=n(442),
/*!
 * message utility
 */
t.getMessage=n(443),
/*!
 * actual utility
 */
t.getActual=n(256),
/*!
 * Inspect util
 */
t.inspect=n(164),
/*!
 * Object Display util
 */
t.objDisplay=n(258),
/*!
 * Flag utility
 */
t.flag=n(61),
/*!
 * Flag transferring utility
 */
t.transferFlags=n(259),
/*!
 * Deep equal utility
 */
t.eql=n(446),
/*!
 * Deep path value
 */
t.getPathValue=n(454),
/*!
 * Deep path info
 */
t.getPathInfo=n(260),
/*!
 * Check if a property exists
 */
t.hasProperty=n(261),
/*!
 * Function name
 */
t.getName=n(257),
/*!
 * add Property
 */
t.addProperty=n(455),
/*!
 * add Method
 */
t.addMethod=n(456),
/*!
 * overwrite Property
 */
t.overwriteProperty=n(457),
/*!
 * overwrite Method
 */
t.overwriteMethod=n(458),
/*!
 * Add a chainable method
 */
t.addChainableMethod=n(459),
/*!
 * Overwrite chainable method
 */
t.overwriteChainableMethod=n(460)},function(e,t,n){
/*!
 * Chai - test utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
/*!
 * Module dependancies
 */
var s=n(61);e.exports=function(e,t){var n=s(e,"negate"),r=t[0];return n?!r:r}},function(e,t){
/*!
 * type-detect
 * Copyright(c) 2013 jake luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
/*!
 * Primary Exports
 */
t=e.exports=s;var n=/^\[object (.*)\]$/;function s(e){var t=Object.prototype.toString.call(e).match(n)[1].toLowerCase();return"function"==typeof Promise&&e instanceof Promise?"promise":null===e?"null":void 0===e?"undefined":t}function r(){if(!(this instanceof r))return new r;this.tests={}}t.Library=r,r.prototype.of=s,r.prototype.define=function(e,t){return 1===arguments.length?this.tests[e]:(this.tests[e]=t,this)},r.prototype.test=function(e,t){if(t===s(e))return!0;var n=this.tests[t];if(n&&"regexp"===s(n))return n.test(e);if(n&&"function"===s(n))return n(e);throw new ReferenceError('Type test "'+t+'" not defined or invalid.')}},function(e,t,n){
/*!
 * Chai - expectTypes utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
var s=n(255),r=n(61),a=n(163);e.exports=function(e,t){e=r(e,"object");(t=t.map(function(e){return e.toLowerCase()})).sort();var n=t.map(function(e,n){var s=~["a","e","i","o","u"].indexOf(e.charAt(0))?"an":"a";return(t.length>1&&n===t.length-1?"or ":"")+s+" "+e}).join(", ");if(!t.some(function(t){return a(e)===t}))throw new s("object tested must be "+n+", but "+a(e)+" given")}},function(e,t,n){
/*!
 * Chai - message composition utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
/*!
 * Module dependancies
 */
var s=n(61),r=n(256),a=(n(164),n(258));e.exports=function(e,t){var n=s(e,"negate"),o=s(e,"object"),i=t[3],l=r(e,t),c=n?t[2]:t[1],u=s(e,"message");return"function"==typeof c&&(c=c()),c=(c=c||"").replace(/#\{this\}/g,function(){return a(o)}).replace(/#\{act\}/g,function(){return a(l)}).replace(/#\{exp\}/g,function(){return a(i)}),u?u+": "+c:c}},function(e,t){
/*!
 * Chai - getProperties utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e){var t=Object.getOwnPropertyNames(e);function n(e){-1===t.indexOf(e)&&t.push(e)}for(var s=Object.getPrototypeOf(e);null!==s;)Object.getOwnPropertyNames(s).forEach(n),s=Object.getPrototypeOf(s);return t}},function(e,t){
/*!
 * Chai - getEnumerableProperties utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e){var t=[];for(var n in e)t.push(n);return t}},function(e,t,n){e.exports=n(447)},function(e,t,n){
/*!
 * deep-eql
 * Copyright(c) 2013 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
/*!
 * Module dependencies
 */
var s,r=n(448);
/*!
 * Buffer.isBuffer browser shim
 */try{s=n(450).Buffer}catch(e){(s={}).isBuffer=function(){return!1}}
/*!
 * Primary Export
 */function a(e,t,n){return!!o(e,t)||("date"===r(e)?
/*!
 * Compare two Date objects by asserting that
 * the time values are equal using `saveValue`.
 *
 * @param {Date} a
 * @param {Date} b
 * @return {Boolean} result
 */
function(e,t){return"date"===r(t)&&o(e.getTime(),t.getTime())}
/*!
 * Compare two regular expressions by converting them
 * to string and checking for `sameValue`.
 *
 * @param {RegExp} a
 * @param {RegExp} b
 * @return {Boolean} result
 */(e,t):"regexp"===r(e)?function(e,t){return"regexp"===r(t)&&o(e.toString(),t.toString())}
/*!
 * Assert deep equality of two `arguments` objects.
 * Unfortunately, these must be sliced to arrays
 * prior to test to ensure no bad behavior.
 *
 * @param {Arguments} a
 * @param {Arguments} b
 * @param {Array} memoize (optional)
 * @return {Boolean} result
 */(e,t):s.isBuffer(e)?
/*!
 * Extension to `iterableEqual` specifically
 * for Node.js Buffers.
 *
 * @param {Buffer} a
 * @param {Mixed} b
 * @return {Boolean} result
 */
function(e,t){return!!s.isBuffer(t)&&l(e,t)}
/*!
 * Block for `objectEqual` ensuring non-existing
 * values don't get in.
 *
 * @param {Mixed} object
 * @return {Boolean} result
 */(e,t):"arguments"===r(e)?function(e,t,n){return"arguments"===r(t)&&(e=[].slice.call(e),t=[].slice.call(t),a(e,t,n))}
/*!
 * Get enumerable properties of a given object.
 *
 * @param {Object} a
 * @return {Array} property names
 */(e,t,n):!!
/*!
 * Compare the types of two given objects and
 * return if they are equal. Note that an Array
 * has a type of `array` (not `object`) and arguments
 * have a type of `arguments` (not `array`/`object`).
 *
 * @param {Mixed} a
 * @param {Mixed} b
 * @return {Boolean} result
 */
function(e,t){return r(e)===r(t)}(e,t)&&("object"!==r(e)&&"object"!==r(t)&&"array"!==r(e)&&"array"!==r(t)?o(e,t):
/*!
 * Recursively check the equality of two objects.
 * Once basic sameness has been established it will
 * defer to `deepEqual` for each enumerable key
 * in the object.
 *
 * @param {Mixed} a
 * @param {Mixed} b
 * @return {Boolean} result
 */
function(e,t,n){if(!c(e)||!c(t))return!1;if(e.prototype!==t.prototype)return!1;var s,r;if(n){for(s=0;s<n.length;s++)if(n[s][0]===e&&n[s][1]===t||n[s][0]===t&&n[s][1]===e)return!0}else n=[];try{var o=i(e),u=i(t)}catch(e){return!1}if(o.sort(),u.sort(),!l(o,u))return!1;for(n.push([e,t]),s=o.length-1;s>=0;s--)if(r=o[s],!a(e[r],t[r],n))return!1;return!0}(e,t,n)))}
/*!
 * Strict (egal) equality test. Ensures that NaN always
 * equals NaN and `-0` does not equal `+0`.
 *
 * @param {Mixed} a
 * @param {Mixed} b
 * @return {Boolean} equal match
 */function o(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}function i(e){var t=[];for(var n in e)t.push(n);return t}
/*!
 * Simple equality for flat iterable objects
 * such as Arrays or Node.js buffers.
 *
 * @param {Iterable} a
 * @param {Iterable} b
 * @return {Boolean} result
 */function l(e,t){if(e.length!==t.length)return!1;for(var n=0,s=!0;n<e.length;n++)if(e[n]!==t[n]){s=!1;break}return s}function c(e){return null!=e}e.exports=a},function(e,t,n){e.exports=n(449)},function(e,t){
/*!
 * type-detect
 * Copyright(c) 2013 jake luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
/*!
 * Primary Exports
 */
t=e.exports=s;
/*!
 * Detectable javascript natives
 */var n={"[object Array]":"array","[object RegExp]":"regexp","[object Function]":"function","[object Arguments]":"arguments","[object Date]":"date"};function s(e){var t=Object.prototype.toString.call(e);return n[t]?n[t]:null===e?"null":void 0===e?"undefined":e===Object(e)?"object":typeof e}function r(){this.tests={}}t.Library=r,r.prototype.of=s,r.prototype.define=function(e,t){return 1===arguments.length?this.tests[e]:(this.tests[e]=t,this)},r.prototype.test=function(e,t){if(t===s(e))return!0;var n=this.tests[t];if(n&&"regexp"===s(n))return n.test(e);if(n&&"function"===s(n))return n(e);throw new ReferenceError('Type test "'+t+'" not defined or invalid.')}},function(e,t,n){"use strict";(function(e){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 */
var s=n(451),r=n(452),a=n(453);function o(){return l.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function i(e,t){if(o()<t)throw new RangeError("Invalid typed array length");return l.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=l.prototype:(null===e&&(e=new l(t)),e.length=t),e}function l(e,t,n){if(!(l.TYPED_ARRAY_SUPPORT||this instanceof l))return new l(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return h(this,e)}return c(this,e,t,n)}function c(e,t,n,s){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,s){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(s||0))throw new RangeError("'length' is out of bounds");t=void 0===n&&void 0===s?new Uint8Array(t):void 0===s?new Uint8Array(t,n):new Uint8Array(t,n,s);l.TYPED_ARRAY_SUPPORT?(e=t).__proto__=l.prototype:e=d(e,t);return e}(e,t,n,s):"string"==typeof t?function(e,t,n){"string"==typeof n&&""!==n||(n="utf8");if(!l.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var s=0|f(t,n),r=(e=i(e,s)).write(t,n);r!==s&&(e=e.slice(0,r));return e}(e,t,n):function(e,t){if(l.isBuffer(t)){var n=0|p(t.length);return 0===(e=i(e,n)).length?e:(t.copy(e,0,0,n),e)}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(s=t.length)!=s?i(e,0):d(e,t);if("Buffer"===t.type&&a(t.data))return d(e,t.data)}var s;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function u(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function h(e,t){if(u(t),e=i(e,t<0?0:0|p(t)),!l.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function d(e,t){var n=t.length<0?0:0|p(t.length);e=i(e,n);for(var s=0;s<n;s+=1)e[s]=255&t[s];return e}function p(e){if(e>=o())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o().toString(16)+" bytes");return 0|e}function f(e,t){if(l.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var s=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return W(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return Y(e).length;default:if(s)return W(e).length;t=(""+t).toLowerCase(),s=!0}}function m(e,t,n){var s=e[t];e[t]=e[n],e[n]=s}function g(e,t,n,s,r){if(0===e.length)return-1;if("string"==typeof n?(s=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=r?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(r)return-1;n=e.length-1}else if(n<0){if(!r)return-1;n=0}if("string"==typeof t&&(t=l.from(t,s)),l.isBuffer(t))return 0===t.length?-1:y(e,t,n,s,r);if("number"==typeof t)return t&=255,l.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?r?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):y(e,[t],n,s,r);throw new TypeError("val must be string, number or Buffer")}function y(e,t,n,s,r){var a,o=1,i=e.length,l=t.length;if(void 0!==s&&("ucs2"===(s=String(s).toLowerCase())||"ucs-2"===s||"utf16le"===s||"utf-16le"===s)){if(e.length<2||t.length<2)return-1;o=2,i/=2,l/=2,n/=2}function c(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(r){var u=-1;for(a=n;a<i;a++)if(c(e,a)===c(t,-1===u?0:a-u)){if(-1===u&&(u=a),a-u+1===l)return u*o}else-1!==u&&(a-=a-u),u=-1}else for(n+l>i&&(n=i-l),a=n;a>=0;a--){for(var h=!0,d=0;d<l;d++)if(c(e,a+d)!==c(t,d)){h=!1;break}if(h)return a}return-1}function v(e,t,n,s){n=Number(n)||0;var r=e.length-n;s?(s=Number(s))>r&&(s=r):s=r;var a=t.length;if(a%2!=0)throw new TypeError("Invalid hex string");s>a/2&&(s=a/2);for(var o=0;o<s;++o){var i=parseInt(t.substr(2*o,2),16);if(isNaN(i))return o;e[n+o]=i}return o}function _(e,t,n,s){return j(W(t,e.length-n),e,n,s)}function b(e,t,n,s){return j(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,s)}function E(e,t,n,s){return b(e,t,n,s)}function S(e,t,n,s){return j(Y(t),e,n,s)}function C(e,t,n,s){return j(function(e,t){for(var n,s,r,a=[],o=0;o<e.length&&!((t-=2)<0);++o)n=e.charCodeAt(o),s=n>>8,r=n%256,a.push(r),a.push(s);return a}(t,e.length-n),e,n,s)}function w(e,t,n){return 0===t&&n===e.length?s.fromByteArray(e):s.fromByteArray(e.slice(t,n))}function T(e,t,n){n=Math.min(e.length,n);for(var s=[],r=t;r<n;){var a,o,i,l,c=e[r],u=null,h=c>239?4:c>223?3:c>191?2:1;if(r+h<=n)switch(h){case 1:c<128&&(u=c);break;case 2:128==(192&(a=e[r+1]))&&(l=(31&c)<<6|63&a)>127&&(u=l);break;case 3:a=e[r+1],o=e[r+2],128==(192&a)&&128==(192&o)&&(l=(15&c)<<12|(63&a)<<6|63&o)>2047&&(l<55296||l>57343)&&(u=l);break;case 4:a=e[r+1],o=e[r+2],i=e[r+3],128==(192&a)&&128==(192&o)&&128==(192&i)&&(l=(15&c)<<18|(63&a)<<12|(63&o)<<6|63&i)>65535&&l<1114112&&(u=l)}null===u?(u=65533,h=1):u>65535&&(u-=65536,s.push(u>>>10&1023|55296),u=56320|1023&u),s.push(u),r+=h}return function(e){var t=e.length;if(t<=O)return String.fromCharCode.apply(String,e);var n="",s=0;for(;s<t;)n+=String.fromCharCode.apply(String,e.slice(s,s+=O));return n}(s)}t.Buffer=l,t.SlowBuffer=function(e){+e!=e&&(e=0);return l.alloc(+e)},t.INSPECT_MAX_BYTES=50,l.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=o(),l.poolSize=8192,l._augment=function(e){return e.__proto__=l.prototype,e},l.from=function(e,t,n){return c(null,e,t,n)},l.TYPED_ARRAY_SUPPORT&&(l.prototype.__proto__=Uint8Array.prototype,l.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&l[Symbol.species]===l&&Object.defineProperty(l,Symbol.species,{value:null,configurable:!0})),l.alloc=function(e,t,n){return function(e,t,n,s){return u(t),t<=0?i(e,t):void 0!==n?"string"==typeof s?i(e,t).fill(n,s):i(e,t).fill(n):i(e,t)}(null,e,t,n)},l.allocUnsafe=function(e){return h(null,e)},l.allocUnsafeSlow=function(e){return h(null,e)},l.isBuffer=function(e){return!(null==e||!e._isBuffer)},l.compare=function(e,t){if(!l.isBuffer(e)||!l.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,s=t.length,r=0,a=Math.min(n,s);r<a;++r)if(e[r]!==t[r]){n=e[r],s=t[r];break}return n<s?-1:s<n?1:0},l.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},l.concat=function(e,t){if(!a(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return l.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var s=l.allocUnsafe(t),r=0;for(n=0;n<e.length;++n){var o=e[n];if(!l.isBuffer(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(s,r),r+=o.length}return s},l.byteLength=f,l.prototype._isBuffer=!0,l.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)m(this,t,t+1);return this},l.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)m(this,t,t+3),m(this,t+1,t+2);return this},l.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)m(this,t,t+7),m(this,t+1,t+6),m(this,t+2,t+5),m(this,t+3,t+4);return this},l.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?T(this,0,e):function(e,t,n){var s=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return N(this,t,n);case"utf8":case"utf-8":return T(this,t,n);case"ascii":return M(this,t,n);case"latin1":case"binary":return A(this,t,n);case"base64":return w(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return P(this,t,n);default:if(s)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),s=!0}}.apply(this,arguments)},l.prototype.equals=function(e){if(!l.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===l.compare(this,e)},l.prototype.inspect=function(){var e="",n=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,n).match(/.{2}/g).join(" "),this.length>n&&(e+=" ... ")),"<Buffer "+e+">"},l.prototype.compare=function(e,t,n,s,r){if(!l.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===s&&(s=0),void 0===r&&(r=this.length),t<0||n>e.length||s<0||r>this.length)throw new RangeError("out of range index");if(s>=r&&t>=n)return 0;if(s>=r)return-1;if(t>=n)return 1;if(this===e)return 0;for(var a=(r>>>=0)-(s>>>=0),o=(n>>>=0)-(t>>>=0),i=Math.min(a,o),c=this.slice(s,r),u=e.slice(t,n),h=0;h<i;++h)if(c[h]!==u[h]){a=c[h],o=u[h];break}return a<o?-1:o<a?1:0},l.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},l.prototype.indexOf=function(e,t,n){return g(this,e,t,n,!0)},l.prototype.lastIndexOf=function(e,t,n){return g(this,e,t,n,!1)},l.prototype.write=function(e,t,n,s){if(void 0===t)s="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)s=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===s&&(s="utf8")):(s=n,n=void 0)}var r=this.length-t;if((void 0===n||n>r)&&(n=r),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");s||(s="utf8");for(var a=!1;;)switch(s){case"hex":return v(this,e,t,n);case"utf8":case"utf-8":return _(this,e,t,n);case"ascii":return b(this,e,t,n);case"latin1":case"binary":return E(this,e,t,n);case"base64":return S(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,e,t,n);default:if(a)throw new TypeError("Unknown encoding: "+s);s=(""+s).toLowerCase(),a=!0}},l.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var O=4096;function M(e,t,n){var s="";n=Math.min(e.length,n);for(var r=t;r<n;++r)s+=String.fromCharCode(127&e[r]);return s}function A(e,t,n){var s="";n=Math.min(e.length,n);for(var r=t;r<n;++r)s+=String.fromCharCode(e[r]);return s}function N(e,t,n){var s=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>s)&&(n=s);for(var r="",a=t;a<n;++a)r+=F(e[a]);return r}function P(e,t,n){for(var s=e.slice(t,n),r="",a=0;a<s.length;a+=2)r+=String.fromCharCode(s[a]+256*s[a+1]);return r}function x(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function I(e,t,n,s,r,a){if(!l.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>r||t<a)throw new RangeError('"value" argument is out of bounds');if(n+s>e.length)throw new RangeError("Index out of range")}function D(e,t,n,s){t<0&&(t=65535+t+1);for(var r=0,a=Math.min(e.length-n,2);r<a;++r)e[n+r]=(t&255<<8*(s?r:1-r))>>>8*(s?r:1-r)}function k(e,t,n,s){t<0&&(t=4294967295+t+1);for(var r=0,a=Math.min(e.length-n,4);r<a;++r)e[n+r]=t>>>8*(s?r:3-r)&255}function L(e,t,n,s,r,a){if(n+s>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function R(e,t,n,s,a){return a||L(e,0,n,4),r.write(e,t,n,s,23,4),n+4}function B(e,t,n,s,a){return a||L(e,0,n,8),r.write(e,t,n,s,52,8),n+8}l.prototype.slice=function(e,t){var n,s=this.length;if((e=~~e)<0?(e+=s)<0&&(e=0):e>s&&(e=s),(t=void 0===t?s:~~t)<0?(t+=s)<0&&(t=0):t>s&&(t=s),t<e&&(t=e),l.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=l.prototype;else{var r=t-e;n=new l(r,void 0);for(var a=0;a<r;++a)n[a]=this[a+e]}return n},l.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||x(e,t,this.length);for(var s=this[e],r=1,a=0;++a<t&&(r*=256);)s+=this[e+a]*r;return s},l.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||x(e,t,this.length);for(var s=this[e+--t],r=1;t>0&&(r*=256);)s+=this[e+--t]*r;return s},l.prototype.readUInt8=function(e,t){return t||x(e,1,this.length),this[e]},l.prototype.readUInt16LE=function(e,t){return t||x(e,2,this.length),this[e]|this[e+1]<<8},l.prototype.readUInt16BE=function(e,t){return t||x(e,2,this.length),this[e]<<8|this[e+1]},l.prototype.readUInt32LE=function(e,t){return t||x(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},l.prototype.readUInt32BE=function(e,t){return t||x(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},l.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||x(e,t,this.length);for(var s=this[e],r=1,a=0;++a<t&&(r*=256);)s+=this[e+a]*r;return s>=(r*=128)&&(s-=Math.pow(2,8*t)),s},l.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||x(e,t,this.length);for(var s=t,r=1,a=this[e+--s];s>0&&(r*=256);)a+=this[e+--s]*r;return a>=(r*=128)&&(a-=Math.pow(2,8*t)),a},l.prototype.readInt8=function(e,t){return t||x(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},l.prototype.readInt16LE=function(e,t){t||x(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},l.prototype.readInt16BE=function(e,t){t||x(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},l.prototype.readInt32LE=function(e,t){return t||x(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},l.prototype.readInt32BE=function(e,t){return t||x(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},l.prototype.readFloatLE=function(e,t){return t||x(e,4,this.length),r.read(this,e,!0,23,4)},l.prototype.readFloatBE=function(e,t){return t||x(e,4,this.length),r.read(this,e,!1,23,4)},l.prototype.readDoubleLE=function(e,t){return t||x(e,8,this.length),r.read(this,e,!0,52,8)},l.prototype.readDoubleBE=function(e,t){return t||x(e,8,this.length),r.read(this,e,!1,52,8)},l.prototype.writeUIntLE=function(e,t,n,s){(e=+e,t|=0,n|=0,s)||I(this,e,t,n,Math.pow(2,8*n)-1,0);var r=1,a=0;for(this[t]=255&e;++a<n&&(r*=256);)this[t+a]=e/r&255;return t+n},l.prototype.writeUIntBE=function(e,t,n,s){(e=+e,t|=0,n|=0,s)||I(this,e,t,n,Math.pow(2,8*n)-1,0);var r=n-1,a=1;for(this[t+r]=255&e;--r>=0&&(a*=256);)this[t+r]=e/a&255;return t+n},l.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,1,255,0),l.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},l.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,2,65535,0),l.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):D(this,e,t,!0),t+2},l.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,2,65535,0),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):D(this,e,t,!1),t+2},l.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,4,4294967295,0),l.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):k(this,e,t,!0),t+4},l.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,4,4294967295,0),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):k(this,e,t,!1),t+4},l.prototype.writeIntLE=function(e,t,n,s){if(e=+e,t|=0,!s){var r=Math.pow(2,8*n-1);I(this,e,t,n,r-1,-r)}var a=0,o=1,i=0;for(this[t]=255&e;++a<n&&(o*=256);)e<0&&0===i&&0!==this[t+a-1]&&(i=1),this[t+a]=(e/o>>0)-i&255;return t+n},l.prototype.writeIntBE=function(e,t,n,s){if(e=+e,t|=0,!s){var r=Math.pow(2,8*n-1);I(this,e,t,n,r-1,-r)}var a=n-1,o=1,i=0;for(this[t+a]=255&e;--a>=0&&(o*=256);)e<0&&0===i&&0!==this[t+a+1]&&(i=1),this[t+a]=(e/o>>0)-i&255;return t+n},l.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,1,127,-128),l.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},l.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,2,32767,-32768),l.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):D(this,e,t,!0),t+2},l.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,2,32767,-32768),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):D(this,e,t,!1),t+2},l.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,4,2147483647,-2147483648),l.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):k(this,e,t,!0),t+4},l.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):k(this,e,t,!1),t+4},l.prototype.writeFloatLE=function(e,t,n){return R(this,e,t,!0,n)},l.prototype.writeFloatBE=function(e,t,n){return R(this,e,t,!1,n)},l.prototype.writeDoubleLE=function(e,t,n){return B(this,e,t,!0,n)},l.prototype.writeDoubleBE=function(e,t,n){return B(this,e,t,!1,n)},l.prototype.copy=function(e,t,n,s){if(n||(n=0),s||0===s||(s=this.length),t>=e.length&&(t=e.length),t||(t=0),s>0&&s<n&&(s=n),s===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(s<0)throw new RangeError("sourceEnd out of bounds");s>this.length&&(s=this.length),e.length-t<s-n&&(s=e.length-t+n);var r,a=s-n;if(this===e&&n<t&&t<s)for(r=a-1;r>=0;--r)e[r+t]=this[r+n];else if(a<1e3||!l.TYPED_ARRAY_SUPPORT)for(r=0;r<a;++r)e[r+t]=this[r+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+a),t);return a},l.prototype.fill=function(e,t,n,s){if("string"==typeof e){if("string"==typeof t?(s=t,t=0,n=this.length):"string"==typeof n&&(s=n,n=this.length),1===e.length){var r=e.charCodeAt(0);r<256&&(e=r)}if(void 0!==s&&"string"!=typeof s)throw new TypeError("encoding must be a string");if("string"==typeof s&&!l.isEncoding(s))throw new TypeError("Unknown encoding: "+s)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var a;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(a=t;a<n;++a)this[a]=e;else{var o=l.isBuffer(e)?e:W(new l(e,s).toString()),i=o.length;for(a=0;a<n-t;++a)this[a+t]=o[a%i]}return this};var G=/[^+\/0-9A-Za-z-_]/g;function F(e){return e<16?"0"+e.toString(16):e.toString(16)}function W(e,t){var n;t=t||1/0;for(var s=e.length,r=null,a=[],o=0;o<s;++o){if((n=e.charCodeAt(o))>55295&&n<57344){if(!r){if(n>56319){(t-=3)>-1&&a.push(239,191,189);continue}if(o+1===s){(t-=3)>-1&&a.push(239,191,189);continue}r=n;continue}if(n<56320){(t-=3)>-1&&a.push(239,191,189),r=n;continue}n=65536+(r-55296<<10|n-56320)}else r&&(t-=3)>-1&&a.push(239,191,189);if(r=null,n<128){if((t-=1)<0)break;a.push(n)}else if(n<2048){if((t-=2)<0)break;a.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;a.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;a.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return a}function Y(e){return s.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(G,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function j(e,t,n,s){for(var r=0;r<s&&!(r+n>=t.length||r>=e.length);++r)t[r+n]=e[r];return r}}).call(this,n(89))},function(e,t,n){"use strict";t.byteLength=function(e){var t=c(e),n=t[0],s=t[1];return 3*(n+s)/4-s},t.toByteArray=function(e){for(var t,n=c(e),s=n[0],o=n[1],i=new a(function(e,t,n){return 3*(t+n)/4-n}(0,s,o)),l=0,u=o>0?s-4:s,h=0;h<u;h+=4)t=r[e.charCodeAt(h)]<<18|r[e.charCodeAt(h+1)]<<12|r[e.charCodeAt(h+2)]<<6|r[e.charCodeAt(h+3)],i[l++]=t>>16&255,i[l++]=t>>8&255,i[l++]=255&t;2===o&&(t=r[e.charCodeAt(h)]<<2|r[e.charCodeAt(h+1)]>>4,i[l++]=255&t);1===o&&(t=r[e.charCodeAt(h)]<<10|r[e.charCodeAt(h+1)]<<4|r[e.charCodeAt(h+2)]>>2,i[l++]=t>>8&255,i[l++]=255&t);return i},t.fromByteArray=function(e){for(var t,n=e.length,r=n%3,a=[],o=0,i=n-r;o<i;o+=16383)a.push(u(e,o,o+16383>i?i:o+16383));1===r?(t=e[n-1],a.push(s[t>>2]+s[t<<4&63]+"==")):2===r&&(t=(e[n-2]<<8)+e[n-1],a.push(s[t>>10]+s[t>>4&63]+s[t<<2&63]+"="));return a.join("")};for(var s=[],r=[],a="undefined"!=typeof Uint8Array?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,l=o.length;i<l;++i)s[i]=o[i],r[o.charCodeAt(i)]=i;function c(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function u(e,t,n){for(var r,a,o=[],i=t;i<n;i+=3)r=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2]),o.push(s[(a=r)>>18&63]+s[a>>12&63]+s[a>>6&63]+s[63&a]);return o.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},function(e,t){t.read=function(e,t,n,s,r){var a,o,i=8*r-s-1,l=(1<<i)-1,c=l>>1,u=-7,h=n?r-1:0,d=n?-1:1,p=e[t+h];for(h+=d,a=p&(1<<-u)-1,p>>=-u,u+=i;u>0;a=256*a+e[t+h],h+=d,u-=8);for(o=a&(1<<-u)-1,a>>=-u,u+=s;u>0;o=256*o+e[t+h],h+=d,u-=8);if(0===a)a=1-c;else{if(a===l)return o?NaN:1/0*(p?-1:1);o+=Math.pow(2,s),a-=c}return(p?-1:1)*o*Math.pow(2,a-s)},t.write=function(e,t,n,s,r,a){var o,i,l,c=8*a-r-1,u=(1<<c)-1,h=u>>1,d=23===r?Math.pow(2,-24)-Math.pow(2,-77):0,p=s?0:a-1,f=s?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(i=isNaN(t)?1:0,o=u):(o=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-o))<1&&(o--,l*=2),(t+=o+h>=1?d/l:d*Math.pow(2,1-h))*l>=2&&(o++,l/=2),o+h>=u?(i=0,o=u):o+h>=1?(i=(t*l-1)*Math.pow(2,r),o+=h):(i=t*Math.pow(2,h-1)*Math.pow(2,r),o=0));r>=8;e[n+p]=255&i,p+=f,i/=256,r-=8);for(o=o<<r|i,c+=r;c>0;e[n+p]=255&o,p+=f,o/=256,c-=8);e[n+p-f]|=128*m}},function(e,t){var n={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==n.call(e)}},function(e,t,n){
/*!
 * Chai - getPathValue utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * @see https://github.com/logicalparadox/filtr
 * MIT Licensed
 */
var s=n(260);e.exports=function(e,t){return s(e,t).value}},function(e,t,n){
/*!
 * Chai - addProperty utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
var s=n(75),r=n(61);e.exports=function(e,t,n){Object.defineProperty(e,t,{get:function e(){r(this,"ssfi")&&!1===s.includeStack&&r(this,"ssfi",e);var t=n.call(this);return void 0===t?this:t},configurable:!0})}},function(e,t,n){
/*!
 * Chai - addMethod utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
var s=n(75),r=n(61);e.exports=function(e,t,n){e[t]=function(){r(this,"ssfi")&&!1===s.includeStack&&r(this,"ssfi",e[t]);var a=n.apply(this,arguments);return void 0===a?this:a}}},function(e,t){
/*!
 * Chai - overwriteProperty utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t,n){var s=Object.getOwnPropertyDescriptor(e,t),r=function(){};s&&"function"==typeof s.get&&(r=s.get),Object.defineProperty(e,t,{get:function(){var e=n(r).call(this);return void 0===e?this:e},configurable:!0})}},function(e,t){
/*!
 * Chai - overwriteMethod utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t,n){var s=e[t],r=function(){return this};s&&"function"==typeof s&&(r=s),e[t]=function(){var e=n(r).apply(this,arguments);return void 0===e?this:e}}},function(e,t,n){
/*!
 * Chai - addChainingMethod utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
/*!
 * Module dependencies
 */
var s=n(259),r=n(61),a=n(75),o="__proto__"in Object,i=/^(?:length|name|arguments|caller)$/,l=Function.prototype.call,c=Function.prototype.apply;e.exports=function(e,t,n,u){"function"!=typeof u&&(u=function(){});var h={method:n,chainingBehavior:u};e.__methods||(e.__methods={}),e.__methods[t]=h,Object.defineProperty(e,t,{get:function(){h.chainingBehavior.call(this);var t=function e(){r(this,"ssfi")&&!1===a.includeStack&&r(this,"ssfi",e);var t=h.method.apply(this,arguments);return void 0===t?this:t};if(o){var n=t.__proto__=Object.create(this);n.call=l,n.apply=c}else{Object.getOwnPropertyNames(e).forEach(function(n){if(!i.test(n)){var s=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,s)}})}return s(this,t),t},configurable:!0})}},function(e,t){
/*!
 * Chai - overwriteChainableMethod utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t,n,s){var r=e.__methods[t],a=r.chainingBehavior;r.chainingBehavior=function(){var e=s(a).call(this);return void 0===e?this:e};var o=r.method;r.method=function(){var e=n(o).apply(this,arguments);return void 0===e?this:e}}},function(e,t,n){
/*!
 * chai
 * http://chaijs.com
 * Copyright(c) 2011-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
var s=n(75);e.exports=function(e,t){
/*!
   * Module dependencies.
   */
var n=e.AssertionError,r=t.flag;
/*!
   * Module export.
   */
/*!
   * Assertion Constructor
   *
   * Creates object for chaining.
   *
   * @api private
   */
function a(e,t,n){r(this,"ssfi",n||arguments.callee),r(this,"object",e),r(this,"message",t)}e.Assertion=a,Object.defineProperty(a,"includeStack",{get:function(){return console.warn("Assertion.includeStack is deprecated, use chai.config.includeStack instead."),s.includeStack},set:function(e){console.warn("Assertion.includeStack is deprecated, use chai.config.includeStack instead."),s.includeStack=e}}),Object.defineProperty(a,"showDiff",{get:function(){return console.warn("Assertion.showDiff is deprecated, use chai.config.showDiff instead."),s.showDiff},set:function(e){console.warn("Assertion.showDiff is deprecated, use chai.config.showDiff instead."),s.showDiff=e}}),a.addProperty=function(e,n){t.addProperty(this.prototype,e,n)},a.addMethod=function(e,n){t.addMethod(this.prototype,e,n)},a.addChainableMethod=function(e,n,s){t.addChainableMethod(this.prototype,e,n,s)},a.overwriteProperty=function(e,n){t.overwriteProperty(this.prototype,e,n)},a.overwriteMethod=function(e,n){t.overwriteMethod(this.prototype,e,n)},a.overwriteChainableMethod=function(e,n,s){t.overwriteChainableMethod(this.prototype,e,n,s)},a.prototype.assert=function(e,a,o,i,l,c){var u=t.test(this,arguments);if(!0!==c&&(c=!1),!0!==s.showDiff&&(c=!1),!u){a=t.getMessage(this,arguments);var h=t.getActual(this,arguments);throw new n(a,{actual:h,expected:i,showDiff:c},s.includeStack?this.assert:r(this,"ssfi"))}},
/*!
   * ### ._obj
   *
   * Quick reference to stored `actual` value for plugin developers.
   *
   * @api private
   */
Object.defineProperty(a.prototype,"_obj",{get:function(){return r(this,"object")},set:function(e){r(this,"object",e)}})}},function(e,t){
/*!
 * chai
 * http://chaijs.com
 * Copyright(c) 2011-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t){var n=e.Assertion,s=(Object.prototype.toString,t.flag);function r(e,n){n&&s(this,"message",n),e=e.toLowerCase();var r=s(this,"object"),a=~["a","e","i","o","u"].indexOf(e.charAt(0))?"an ":"a ";this.assert(e===t.type(r),"expected #{this} to be "+a+e,"expected #{this} not to be "+a+e)}function a(){s(this,"contains",!0)}function o(e,r){t.expectTypes(this,["array","object","string"]),r&&s(this,"message",r);var a=s(this,"object"),o=!1;if("array"===t.type(a)&&"object"===t.type(e)){for(var i in a)if(t.eql(a[i],e)){o=!0;break}}else if("object"===t.type(e)){if(!s(this,"negate")){for(var l in e)new n(a).property(l,e[l]);return}var c={};for(var l in e)c[l]=a[l];o=t.eql(c,e)}else o=null!=a&&~a.indexOf(e);this.assert(o,"expected #{this} to include "+t.inspect(e),"expected #{this} to not include "+t.inspect(e))}function i(){var e=s(this,"object"),t=Object.prototype.toString.call(e);this.assert("[object Arguments]"===t,"expected #{this} to be arguments but got "+t,"expected #{this} to not be arguments")}function l(e,t){t&&s(this,"message",t);var n=s(this,"object");if(s(this,"deep"))return this.eql(e);this.assert(e===n,"expected #{this} to equal #{exp}","expected #{this} to not equal #{exp}",e,this._obj,!0)}function c(e,n){n&&s(this,"message",n),this.assert(t.eql(e,s(this,"object")),"expected #{this} to deeply equal #{exp}","expected #{this} to not deeply equal #{exp}",e,this._obj,!0)}function u(e,t){t&&s(this,"message",t);var r=s(this,"object");if(s(this,"doLength")){new n(r,t).to.have.property("length");var a=r.length;this.assert(a>e,"expected #{this} to have a length above #{exp} but got #{act}","expected #{this} to not have a length above #{exp}",e,a)}else this.assert(r>e,"expected #{this} to be above "+e,"expected #{this} to be at most "+e)}function h(e,t){t&&s(this,"message",t);var r=s(this,"object");if(s(this,"doLength")){new n(r,t).to.have.property("length");var a=r.length;this.assert(a>=e,"expected #{this} to have a length at least #{exp} but got #{act}","expected #{this} to have a length below #{exp}",e,a)}else this.assert(r>=e,"expected #{this} to be at least "+e,"expected #{this} to be below "+e)}function d(e,t){t&&s(this,"message",t);var r=s(this,"object");if(s(this,"doLength")){new n(r,t).to.have.property("length");var a=r.length;this.assert(a<e,"expected #{this} to have a length below #{exp} but got #{act}","expected #{this} to not have a length below #{exp}",e,a)}else this.assert(r<e,"expected #{this} to be below "+e,"expected #{this} to be at least "+e)}function p(e,t){t&&s(this,"message",t);var r=s(this,"object");if(s(this,"doLength")){new n(r,t).to.have.property("length");var a=r.length;this.assert(a<=e,"expected #{this} to have a length at most #{exp} but got #{act}","expected #{this} to have a length above #{exp}",e,a)}else this.assert(r<=e,"expected #{this} to be at most "+e,"expected #{this} to be above "+e)}function f(e,n){n&&s(this,"message",n);var r=t.getName(e);this.assert(s(this,"object")instanceof e,"expected #{this} to be an instance of "+r,"expected #{this} to not be an instance of "+r)}function m(e,n){n&&s(this,"message",n);var r=s(this,"object");this.assert(r.hasOwnProperty(e),"expected #{this} to have own property "+t.inspect(e),"expected #{this} to not have own property "+t.inspect(e))}function g(e,n,r){"string"==typeof n&&(r=n,n=null),r&&s(this,"message",r);var a=s(this,"object"),o=Object.getOwnPropertyDescriptor(Object(a),e);o&&n?this.assert(t.eql(n,o),"expected the own property descriptor for "+t.inspect(e)+" on #{this} to match "+t.inspect(n)+", got "+t.inspect(o),"expected the own property descriptor for "+t.inspect(e)+" on #{this} to not match "+t.inspect(n),n,o,!0):this.assert(o,"expected #{this} to have an own property descriptor for "+t.inspect(e),"expected #{this} to not have an own property descriptor for "+t.inspect(e)),s(this,"object",o)}function y(e,t){t&&s(this,"message",t);var r=s(this,"object");new n(r,t).to.have.property("length");var a=r.length;this.assert(a==e,"expected #{this} to have a length of #{exp} but got #{act}","expected #{this} to not have a length of #{act}",e,a)}function v(e,t){t&&s(this,"message",t);var n=s(this,"object");this.assert(e.exec(n),"expected #{this} to match "+e,"expected #{this} not to match "+e)}function _(e){var n,r=s(this,"object"),a=!0,o="keys must be given single argument of Array|Object|String, or multiple String arguments";switch(t.type(e)){case"array":if(arguments.length>1)throw new Error(o);break;case"object":if(arguments.length>1)throw new Error(o);e=Object.keys(e);break;default:e=Array.prototype.slice.call(arguments)}if(!e.length)throw new Error("keys required");var i=Object.keys(r),l=e,c=e.length,u=s(this,"any"),h=s(this,"all");(u||h||(h=!0),u)&&(a=l.filter(function(e){return~i.indexOf(e)}).length>0);if(h&&(a=e.every(function(e){return~i.indexOf(e)}),s(this,"negate")||s(this,"contains")||(a=a&&e.length==i.length)),c>1){var d=(e=e.map(function(e){return t.inspect(e)})).pop();h&&(n=e.join(", ")+", and "+d),u&&(n=e.join(", ")+", or "+d)}else n=t.inspect(e[0]);n=(c>1?"keys ":"key ")+n,n=(s(this,"contains")?"contain ":"have ")+n,this.assert(a,"expected #{this} to "+n,"expected #{this} to not "+n,l.slice(0).sort(),i.sort(),!0)}function b(e,r,a){a&&s(this,"message",a);var o=s(this,"object");new n(o,a).is.a("function");var i=!1,l=null,c=null,u=null;0===arguments.length?(r=null,e=null):e&&(e instanceof RegExp||"string"==typeof e)?(r=e,e=null):e&&e instanceof Error?(l=e,e=null,r=null):"function"==typeof e?(!(c=e.prototype.name)||"Error"===c&&e!==Error)&&(c=e.name||(new e).name):e=null;try{o()}catch(n){if(l)return this.assert(n===l,"expected #{this} to throw #{exp} but #{act} was thrown","expected #{this} to not throw #{exp}",l instanceof Error?l.toString():l,n instanceof Error?n.toString():n),s(this,"object",n),this;if(e&&(this.assert(n instanceof e,"expected #{this} to throw #{exp} but #{act} was thrown","expected #{this} to not throw #{exp} but #{act} was thrown",c,n instanceof Error?n.toString():n),!r))return s(this,"object",n),this;var h="error"===t.type(n)&&"message"in n?n.message:""+n;if(null!=h&&r&&r instanceof RegExp)return this.assert(r.exec(h),"expected #{this} to throw error matching #{exp} but got #{act}","expected #{this} to throw error not matching #{exp}",r,h),s(this,"object",n),this;if(null!=h&&r&&"string"==typeof r)return this.assert(~h.indexOf(r),"expected #{this} to throw error including #{exp} but got #{act}","expected #{this} to throw error not including #{act}",r,h),s(this,"object",n),this;i=!0,u=n}var d="",p=null!==c?c:l?"#{exp}":"an error";i&&(d=" but #{act} was thrown"),this.assert(!0===i,"expected #{this} to throw "+p+d,"expected #{this} to not throw "+p+d,l instanceof Error?l.toString():l,u instanceof Error?u.toString():u),s(this,"object",u)}function E(e,n){n&&s(this,"message",n);var r=s(this,"object"),a=s(this,"itself"),o="function"!==t.type(r)||a?r[e]:r.prototype[e];this.assert("function"==typeof o,"expected #{this} to respond to "+t.inspect(e),"expected #{this} to not respond to "+t.inspect(e))}function S(e,n){n&&s(this,"message",n);var r=e(s(this,"object"));this.assert(r,"expected #{this} to satisfy "+t.objDisplay(e),"expected #{this} to not satisfy"+t.objDisplay(e),!this.negate,r)}function C(e,r,a){a&&s(this,"message",a);var o=s(this,"object");if(new n(o,a).is.a("number"),"number"!==t.type(e)||"number"!==t.type(r))throw new Error("the arguments to closeTo or approximately must be numbers");this.assert(Math.abs(o-e)<=r,"expected #{this} to be close to "+e+" +/- "+r,"expected #{this} not to be close to "+e+" +/- "+r)}function w(e,t,n){return e.every(function(e){return n?t.some(function(t){return n(e,t)}):-1!==t.indexOf(e)})}function T(e,t,r){r&&s(this,"message",r);var a=s(this,"object");new n(e,r).to.have.property(t),new n(a).is.a("function");var o=e[t];a(),this.assert(o!==e[t],"expected ."+t+" to change","expected ."+t+" to not change")}function O(e,t,r){r&&s(this,"message",r);var a=s(this,"object");new n(e,r).to.have.property(t),new n(a).is.a("function");var o=e[t];a(),this.assert(e[t]-o>0,"expected ."+t+" to increase","expected ."+t+" to not increase")}function M(e,t,r){r&&s(this,"message",r);var a=s(this,"object");new n(e,r).to.have.property(t),new n(a).is.a("function");var o=e[t];a(),this.assert(e[t]-o<0,"expected ."+t+" to decrease","expected ."+t+" to not decrease")}["to","be","been","is","and","has","have","with","that","which","at","of","same"].forEach(function(e){n.addProperty(e,function(){return this})}),n.addProperty("not",function(){s(this,"negate",!0)}),n.addProperty("deep",function(){s(this,"deep",!0)}),n.addProperty("any",function(){s(this,"any",!0),s(this,"all",!1)}),n.addProperty("all",function(){s(this,"all",!0),s(this,"any",!1)}),n.addChainableMethod("an",r),n.addChainableMethod("a",r),n.addChainableMethod("include",o,a),n.addChainableMethod("contain",o,a),n.addChainableMethod("contains",o,a),n.addChainableMethod("includes",o,a),n.addProperty("ok",function(){this.assert(s(this,"object"),"expected #{this} to be truthy","expected #{this} to be falsy")}),n.addProperty("true",function(){this.assert(!0===s(this,"object"),"expected #{this} to be true","expected #{this} to be false",!this.negate)}),n.addProperty("false",function(){this.assert(!1===s(this,"object"),"expected #{this} to be false","expected #{this} to be true",!!this.negate)}),n.addProperty("null",function(){this.assert(null===s(this,"object"),"expected #{this} to be null","expected #{this} not to be null")}),n.addProperty("undefined",function(){this.assert(void 0===s(this,"object"),"expected #{this} to be undefined","expected #{this} not to be undefined")}),n.addProperty("NaN",function(){this.assert(isNaN(s(this,"object")),"expected #{this} to be NaN","expected #{this} not to be NaN")}),n.addProperty("exist",function(){this.assert(null!=s(this,"object"),"expected #{this} to exist","expected #{this} to not exist")}),n.addProperty("empty",function(){var e=s(this,"object"),t=e;Array.isArray(e)||"string"==typeof object?t=e.length:"object"==typeof e&&(t=Object.keys(e).length),this.assert(!t,"expected #{this} to be empty","expected #{this} not to be empty")}),n.addProperty("arguments",i),n.addProperty("Arguments",i),n.addMethod("equal",l),n.addMethod("equals",l),n.addMethod("eq",l),n.addMethod("eql",c),n.addMethod("eqls",c),n.addMethod("above",u),n.addMethod("gt",u),n.addMethod("greaterThan",u),n.addMethod("least",h),n.addMethod("gte",h),n.addMethod("below",d),n.addMethod("lt",d),n.addMethod("lessThan",d),n.addMethod("most",p),n.addMethod("lte",p),n.addMethod("within",function(e,t,r){r&&s(this,"message",r);var a=s(this,"object"),o=e+".."+t;if(s(this,"doLength")){new n(a,r).to.have.property("length");var i=a.length;this.assert(i>=e&&i<=t,"expected #{this} to have a length within "+o,"expected #{this} to not have a length within "+o)}else this.assert(a>=e&&a<=t,"expected #{this} to be within "+o,"expected #{this} to not be within "+o)}),n.addMethod("instanceof",f),n.addMethod("instanceOf",f),n.addMethod("property",function(e,n,r){r&&s(this,"message",r);var a=!!s(this,"deep"),o=a?"deep property ":"property ",i=s(this,"negate"),l=s(this,"object"),c=a?t.getPathInfo(e,l):null,u=a?c.exists:t.hasProperty(e,l),h=a?c.value:l[e];if(i&&arguments.length>1){if(void 0===h)throw r=null!=r?r+": ":"",new Error(r+t.inspect(l)+" has no "+o+t.inspect(e))}else this.assert(u,"expected #{this} to have a "+o+t.inspect(e),"expected #{this} to not have "+o+t.inspect(e));arguments.length>1&&this.assert(n===h,"expected #{this} to have a "+o+t.inspect(e)+" of #{exp}, but got #{act}","expected #{this} to not have a "+o+t.inspect(e)+" of #{act}",n,h),s(this,"object",h)}),n.addMethod("ownProperty",m),n.addMethod("haveOwnProperty",m),n.addMethod("ownPropertyDescriptor",g),n.addMethod("haveOwnPropertyDescriptor",g),n.addChainableMethod("length",y,function(){s(this,"doLength",!0)}),n.addMethod("lengthOf",y),n.addMethod("match",v),n.addMethod("matches",v),n.addMethod("string",function(e,r){r&&s(this,"message",r);var a=s(this,"object");new n(a,r).is.a("string"),this.assert(~a.indexOf(e),"expected #{this} to contain "+t.inspect(e),"expected #{this} to not contain "+t.inspect(e))}),n.addMethod("keys",_),n.addMethod("key",_),n.addMethod("throw",b),n.addMethod("throws",b),n.addMethod("Throw",b),n.addMethod("respondTo",E),n.addMethod("respondsTo",E),n.addProperty("itself",function(){s(this,"itself",!0)}),n.addMethod("satisfy",S),n.addMethod("satisfies",S),n.addMethod("closeTo",C),n.addMethod("approximately",C),n.addMethod("members",function(e,r){r&&s(this,"message",r);var a=s(this,"object");new n(a).to.be.an("array"),new n(e).to.be.an("array");var o=s(this,"deep")?t.eql:void 0;if(s(this,"contains"))return this.assert(w(e,a,o),"expected #{this} to be a superset of #{act}","expected #{this} to not be a superset of #{act}",a,e);this.assert(w(a,e,o)&&w(e,a,o),"expected #{this} to have the same members as #{act}","expected #{this} to not have the same members as #{act}",a,e)}),n.addMethod("oneOf",function(e,t){t&&s(this,"message",t);var r=s(this,"object");new n(e).to.be.an("array"),this.assert(e.indexOf(r)>-1,"expected #{this} to be one of #{exp}","expected #{this} to not be one of #{exp}",e,r)}),n.addChainableMethod("change",T),n.addChainableMethod("changes",T),n.addChainableMethod("increase",O),n.addChainableMethod("increases",O),n.addChainableMethod("decrease",M),n.addChainableMethod("decreases",M),n.addProperty("extensible",function(){var e,t=s(this,"object");try{e=Object.isExtensible(t)}catch(t){if(!(t instanceof TypeError))throw t;e=!1}this.assert(e,"expected #{this} to be extensible","expected #{this} to not be extensible")}),n.addProperty("sealed",function(){var e,t=s(this,"object");try{e=Object.isSealed(t)}catch(t){if(!(t instanceof TypeError))throw t;e=!0}this.assert(e,"expected #{this} to be sealed","expected #{this} to not be sealed")}),n.addProperty("frozen",function(){var e,t=s(this,"object");try{e=Object.isFrozen(t)}catch(t){if(!(t instanceof TypeError))throw t;e=!0}this.assert(e,"expected #{this} to be frozen","expected #{this} to not be frozen")})}},function(e,t){
/*!
 * chai
 * Copyright(c) 2011-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t){e.expect=function(t,n){return new e.Assertion(t,n)},e.expect.fail=function(t,n,s,r){throw s=s||"expect.fail()",new e.AssertionError(s,{actual:t,expected:n,operator:r},e.expect.fail)}}},function(e,t){
/*!
 * chai
 * Copyright(c) 2011-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t){var n=e.Assertion;function s(){Object.defineProperty(Object.prototype,"should",{set:function(e){Object.defineProperty(this,"should",{value:e,enumerable:!0,configurable:!0,writable:!0})},get:function e(){return this instanceof String||this instanceof Number||this instanceof Boolean?new n(this.valueOf(),null,e):new n(this,null,e)},configurable:!0});var t={fail:function(n,s,r,a){throw r=r||"should.fail()",new e.AssertionError(r,{actual:n,expected:s,operator:a},t.fail)},equal:function(e,t,s){new n(e,s).to.equal(t)},Throw:function(e,t,s,r){new n(e,r).to.Throw(t,s)},exist:function(e,t){new n(e,t).to.exist},not:{}};return t.not.equal=function(e,t,s){new n(e,s).to.not.equal(t)},t.not.Throw=function(e,t,s,r){new n(e,r).to.not.Throw(t,s)},t.not.exist=function(e,t){new n(e,t).to.not.exist},t.throw=t.Throw,t.not.throw=t.not.Throw,t}e.should=s,e.Should=s}},function(e,t){
/*!
 * chai
 * Copyright(c) 2011-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t){
/*!
   * Chai dependencies.
   */
var n=e.Assertion,s=t.flag,r=e.assert=function(t,s){new n(null,null,e.assert).assert(t,s,"[ negation message unavailable ]")};
/*!
   * Module export.
   */r.fail=function(t,n,s,a){throw s=s||"assert.fail()",new e.AssertionError(s,{actual:t,expected:n,operator:a},r.fail)},r.isOk=function(e,t){new n(e,t).is.ok},r.isNotOk=function(e,t){new n(e,t).is.not.ok},r.equal=function(e,t,a){var o=new n(e,a,r.equal);o.assert(t==s(o,"object"),"expected #{this} to equal #{exp}","expected #{this} to not equal #{act}",t,e)},r.notEqual=function(e,t,a){var o=new n(e,a,r.notEqual);o.assert(t!=s(o,"object"),"expected #{this} to not equal #{exp}","expected #{this} to equal #{act}",t,e)},r.strictEqual=function(e,t,s){new n(e,s).to.equal(t)},r.notStrictEqual=function(e,t,s){new n(e,s).to.not.equal(t)},r.deepEqual=function(e,t,s){new n(e,s).to.eql(t)},r.notDeepEqual=function(e,t,s){new n(e,s).to.not.eql(t)},r.isAbove=function(e,t,s){new n(e,s).to.be.above(t)},r.isAtLeast=function(e,t,s){new n(e,s).to.be.least(t)},r.isBelow=function(e,t,s){new n(e,s).to.be.below(t)},r.isAtMost=function(e,t,s){new n(e,s).to.be.most(t)},r.isTrue=function(e,t){new n(e,t).is.true},r.isNotTrue=function(e,t){new n(e,t).to.not.equal(!0)},r.isFalse=function(e,t){new n(e,t).is.false},r.isNotFalse=function(e,t){new n(e,t).to.not.equal(!1)},r.isNull=function(e,t){new n(e,t).to.equal(null)},r.isNotNull=function(e,t){new n(e,t).to.not.equal(null)},r.isNaN=function(e,t){new n(e,t).to.be.NaN},r.isNotNaN=function(e,t){new n(e,t).not.to.be.NaN},r.isUndefined=function(e,t){new n(e,t).to.equal(void 0)},r.isDefined=function(e,t){new n(e,t).to.not.equal(void 0)},r.isFunction=function(e,t){new n(e,t).to.be.a("function")},r.isNotFunction=function(e,t){new n(e,t).to.not.be.a("function")},r.isObject=function(e,t){new n(e,t).to.be.a("object")},r.isNotObject=function(e,t){new n(e,t).to.not.be.a("object")},r.isArray=function(e,t){new n(e,t).to.be.an("array")},r.isNotArray=function(e,t){new n(e,t).to.not.be.an("array")},r.isString=function(e,t){new n(e,t).to.be.a("string")},r.isNotString=function(e,t){new n(e,t).to.not.be.a("string")},r.isNumber=function(e,t){new n(e,t).to.be.a("number")},r.isNotNumber=function(e,t){new n(e,t).to.not.be.a("number")},r.isBoolean=function(e,t){new n(e,t).to.be.a("boolean")},r.isNotBoolean=function(e,t){new n(e,t).to.not.be.a("boolean")},r.typeOf=function(e,t,s){new n(e,s).to.be.a(t)},r.notTypeOf=function(e,t,s){new n(e,s).to.not.be.a(t)},r.instanceOf=function(e,t,s){new n(e,s).to.be.instanceOf(t)},r.notInstanceOf=function(e,t,s){new n(e,s).to.not.be.instanceOf(t)},r.include=function(e,t,s){new n(e,s,r.include).include(t)},r.notInclude=function(e,t,s){new n(e,s,r.notInclude).not.include(t)},r.match=function(e,t,s){new n(e,s).to.match(t)},r.notMatch=function(e,t,s){new n(e,s).to.not.match(t)},r.property=function(e,t,s){new n(e,s).to.have.property(t)},r.notProperty=function(e,t,s){new n(e,s).to.not.have.property(t)},r.deepProperty=function(e,t,s){new n(e,s).to.have.deep.property(t)},r.notDeepProperty=function(e,t,s){new n(e,s).to.not.have.deep.property(t)},r.propertyVal=function(e,t,s,r){new n(e,r).to.have.property(t,s)},r.propertyNotVal=function(e,t,s,r){new n(e,r).to.not.have.property(t,s)},r.deepPropertyVal=function(e,t,s,r){new n(e,r).to.have.deep.property(t,s)},r.deepPropertyNotVal=function(e,t,s,r){new n(e,r).to.not.have.deep.property(t,s)},r.lengthOf=function(e,t,s){new n(e,s).to.have.length(t)},r.throws=function(e,t,r,a){("string"==typeof t||t instanceof RegExp)&&(r=t,t=null);var o=new n(e,a).to.throw(t,r);return s(o,"object")},r.doesNotThrow=function(e,t,s){"string"==typeof t&&(s=t,t=null),new n(e,s).to.not.Throw(t)},r.operator=function(e,r,a,o){var i;switch(r){case"==":i=e==a;break;case"===":i=e===a;break;case">":i=e>a;break;case">=":i=e>=a;break;case"<":i=e<a;break;case"<=":i=e<=a;break;case"!=":i=e!=a;break;case"!==":i=e!==a;break;default:throw new Error('Invalid operator "'+r+'"')}var l=new n(i,o);l.assert(!0===s(l,"object"),"expected "+t.inspect(e)+" to be "+r+" "+t.inspect(a),"expected "+t.inspect(e)+" to not be "+r+" "+t.inspect(a))},r.closeTo=function(e,t,s,r){new n(e,r).to.be.closeTo(t,s)},r.approximately=function(e,t,s,r){new n(e,r).to.be.approximately(t,s)},r.sameMembers=function(e,t,s){new n(e,s).to.have.same.members(t)},r.sameDeepMembers=function(e,t,s){new n(e,s).to.have.same.deep.members(t)},r.includeMembers=function(e,t,s){new n(e,s).to.include.members(t)},r.includeDeepMembers=function(e,t,s){new n(e,s).to.include.deep.members(t)},r.oneOf=function(e,t,s){new n(e,s).to.be.oneOf(t)},r.changes=function(e,t,s){new n(e).to.change(t,s)},r.doesNotChange=function(e,t,s){new n(e).to.not.change(t,s)},r.increases=function(e,t,s){new n(e).to.increase(t,s)},r.doesNotIncrease=function(e,t,s){new n(e).to.not.increase(t,s)},r.decreases=function(e,t,s){new n(e).to.decrease(t,s)},r.doesNotDecrease=function(e,t,s){new n(e).to.not.decrease(t,s)}
/*!
   * ### .ifError(object)
   *
   * Asserts if value is not a false value, and throws if it is a true value.
   * This is added to allow for chai to be a drop-in replacement for Node's
   * assert class.
   *
   *     var err = new Error('I am a custom error');
   *     assert.ifError(err); // Rethrows err!
   *
   * @name ifError
   * @param {Object} object
   * @namespace Assert
   * @api public
   */,r.ifError=function(e){if(e)throw e},r.isExtensible=function(e,t){new n(e,t).to.be.extensible},r.isNotExtensible=function(e,t){new n(e,t).to.not.be.extensible},r.isSealed=function(e,t){new n(e,t).to.be.sealed},r.isNotSealed=function(e,t){new n(e,t).to.not.be.sealed},r.isFrozen=function(e,t){new n(e,t).to.be.frozen},r.isNotFrozen=function(e,t){new n(e,t).to.not.be.frozen},
/*!
   * Aliases.
   */
function e(t,n){return r[n]=r[t],e}("isOk","ok")("isNotOk","notOk")("throws","throw")("throws","Throw")("isExtensible","extensible")("isNotExtensible","notExtensible")("isSealed","sealed")("isNotSealed","notSealed")("isFrozen","frozen")("isNotFrozen","notFrozen")}},function(e,t,n){"use strict";function s(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(8));t.RG=o.default,s(n(45)),s(n(28)),s(n(18)),s(n(9)),s(n(104));const i=a(n(103));t.Mixin=i,s(n(12)),s(n(66)),s(n(67)),s(n(161));const l=a(n(228));t.Anim=l;const c=a(n(11));t.Component=c,s(n(34)),s(n(88)),s(n(226)),s(n(225)),s(n(467)),s(n(84)),s(n(125)),s(n(106)),s(n(20)),s(n(183)),s(n(53)),s(n(137)),s(n(15)),s(n(44)),s(n(130)),s(n(136)),s(n(35)),s(n(26)),s(n(22)),s(n(59)),s(n(158)),s(n(159)),s(n(160)),s(n(41)),s(n(184)),s(n(14)),s(n(43)),s(n(64)),s(n(117)),s(n(31)),s(n(109)),s(n(46)),s(n(58)),s(n(135)),s(n(157)),s(n(60)),s(n(96)),s(n(222)),s(n(97)),s(n(98)),s(n(74)),s(n(253)),s(n(224)),s(n(155))},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(17)("bitn:aisequence");function o(e,t,n){this.condFunc=e,this.actionIfTrue=t,this.actionIfFalse=n}function i(e){this.actionArray=e}function l(e){this.actionArray=e}function c(e){this.actionArray=e}function u(e,t,n){if(void 0===t.currActionDone||!0===t.currActionDone)if(Object.getPrototypeOf(e)===o.prototype)!function(e,t,n){u(e.condFunc,t,n)?u(e.actionIfTrue,t,n):u(e.actionIfFalse,t,n)}(e,t,n);else if(Object.getPrototypeOf(e)===i.prototype)!function(e,t,n){for(let s=0;s<e.actionArray.length;s++)u(e.actionArray[s],t,n)}(e,t,n);else if(Object.getPrototypeOf(e)===c.prototype)!function(e,t,n){r.default.RAND.shuffle(e.actionArray);for(let s=0;s<e.actionArray.length;s++)u(e.actionArray[s],t,n)}(e,t,n);else{if(Object.getPrototypeOf(e)!==l.prototype){const s=e(t);return"function"==typeof s&&n.push(s),s}!function(e,t,n){const s=r.default.RAND.randIndex(e.actionArray.length);u(e.actionArray[s],t,n)}(e,t,n)}return()=>{}}const h={Rogue:{}};h.Rogue.ifEnemyIsInSight=(e=>{const t=e.getBrain(),n=t.getSeenCells(),s=t.findEnemyCell(n);return a(`${e.getName()} playerSeen: ${s}`),null!==s}),h.Rogue.ifItemIsInSight=(e=>{return e.getBrain().findSeenCell(e=>e.hasItems()).length>0}),h.Rogue.moveToItem=(e=>{const t=e.getBrain(),n=t.findSeenCell(e=>e.hasItems());return t.tryToMoveTowardsCell(n[0])}),h.Rogue.canPickupItem=(e=>e.getBrain().canPickupItem()),h.Rogue.pickupItem=(e=>e.getBrain().pickupItem()),h.Rogue.canEquipItem=(e=>{}),h.Rogue.equipBestItem=(e=>{}),h.Rogue.ifShopIsInSight=(e=>{}),h.Rogue.moveToNearestShop=(e=>{}),h.Rogue.buyItem=(e=>{}),h.Rogue.sellItem=(e=>{}),h.Rogue.ifStairsInSight=(e=>{}),h.Rogue.ifPassageInSight=(e=>{}),h.Rogue.useStairs=(e=>{}),h.Rogue.usePassage=(e=>{}),h.Rogue.attackEnemy=(e=>{const t=e.getBrain(),n=t.getSeenCells(),s=t.findEnemyCell(n);return t.actionTowardsEnemy(s)}),h.Rogue.ifSeriouslyWounded=(e=>{const t=e.get("Health"),n=Math.round(.1*t.getMaxHP());return t.getHP()<=n}),h.Rogue.flee=(e=>{const t=e.getBrain(),n=t.getSeenCells(),s=t.findEnemyCell(n);return t.fleeFromCell(s,n)}),h.Rogue.exploreLevel=(e=>{const t=e.getBrain(),n=t.getSeenCells();return t.exploreLevel(n)}),h.Rogue.Nodes={},h.Rogue.Nodes.combat=new o(h.Rogue.ifSeriouslyWounded,h.Rogue.flee,h.Rogue.attackEnemy),h.Rogue.Nodes.exploreItems=new o(h.Rogue.canPickupItem,h.Rogue.pickupItem,new o(h.Rogue.ifItemIsInSight,h.Rogue.moveToItem,h.Rogue.exploreLevel)),h.Rogue.tree=new o(h.Rogue.ifEnemyIsInSight,h.Rogue.Nodes.combat,h.Rogue.exploreLevel),h.Human={},h.Human.isEnemyInSight=(e=>h.Rogue.ifEnemyIsInSight(e)),h.Human.willCommunicate=(e=>e.getBrain().willCommunicate()),h.Human.communicateEnemies=(e=>e.getBrain().communicateEnemies()),h.Human.tree=new o(h.Human.isEnemyInSight,new o(h.Human.willCommunicate,h.Human.communicateEnemies,h.Rogue.Nodes.combat),h.Rogue.exploreLevel),h.Demon={},h.Summoner={},h.Summoner.willSummon=(e=>e.getBrain().willSummon()),h.Summoner.summonMonster=(e=>e.getBrain().summonMonster()),h.Summoner.tree=new o(h.Rogue.ifEnemyIsInSight,new o(h.Summoner.willSummon,h.Summoner.summonMonster,h.Rogue.tree),h.Rogue.exploreLevel),h.Archer={},h.Archer.isOutOfAmmo=(e=>{return!e.getInvEq().getEquipment().getItem("missile")}),h.Archer.canSeeAmmo=(e=>{return e.getBrain().findSeenCell(e=>e.hasItems()).length>0}),h.Archer.pickupNearestAmmo=(e=>{}),h.Archer.canDoRangedAttack=(e=>e.getBrain().canDoRangedAttack()),h.Archer.doRangedAttack=(e=>e.getBrain().doRangedAttack()),h.Archer.tree=new o(h.Rogue.ifEnemyIsInSight,new o(h.Archer.canDoRangedAttack,h.Archer.doRangedAttack,h.Rogue.Nodes.combat),h.Rogue.exploreLevel),h.SpellCaster={},h.SpellCaster.shouldCastSpell=(e=>e.getBrain().shouldCastSpell()),h.SpellCaster.canCastSpell=(e=>e.getBrain().canCastSpell()),h.SpellCaster.castSpell=(e=>e.getBrain().castSpell()),h.SpellCaster.tree=new o(h.Rogue.ifEnemyIsInSight,new o(h.SpellCaster.shouldCastSpell,new o(h.SpellCaster.canCastSpell,h.SpellCaster.castSpell,h.Rogue.Nodes.combat),h.Rogue.Nodes.combat),h.Rogue.exploreLevel),t.BTree={SelectorNode:o,SequencerNode:i,SelectorRandomNode:l,SequencerRandomNode:c,execBehavTree:u,startBehavTree:function(e,t){const n=[];return t&&a("startBehavTree for actor "+t.getName()),u(e,t,n),n},Models:h}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s={beastDungeon:{x:0,y:0,name:"Beast dungeon",nBranches:1,constraint:{actor:{op:"eq",prop:"type",value:"animal"}},create:{actor:[{name:"goblin",target:"Animals",nLevel:4}]},branch:[{name:"Animals",nLevels:5,entranceLevel:0,create:{actor:[{name:"goblin",nLevel:4}]}}]},smallDungeon:{x:0,y:0,name:"Small dungeon",nBranches:1,branch:[{name:"main",nLevels:5,entranceLevel:0}]}};t.WorldConf={name:"The North",presetLevels:{},playerStart:{place:"The North",x:2,y:4},nAreas:1,area:[{name:"Ravendark",maxX:5,maxY:5,cols:100,rows:100,nDungeons:3,dungeon:[s.smallDungeon,s.beastDungeon,{x:0,y:0,name:"BranchTest",nBranches:2,connectLevels:[["main","side",0,0]],branch:[{name:"main",nLevels:1,entranceLevel:0},{name:"side",nLevels:1}]}],nCities:2,city:[{x:0,y:0,name:"Petit town",nQuarters:1,quarter:[{name:"Center",nLevels:1,entranceLevel:0}]},{x:2,y:2,name:"Blashyrkh",nQuarters:1,quarter:[{name:"Center",nLevels:1,entranceLevel:0,nShops:2,constraint:{shop:[{op:"eq",prop:"type",value:"food"},[{op:"eq",prop:"type",value:"weapon"},{op:"lt",prop:"value",value:100}]]}}]}],nMountains:2,mountain:[{x:1,y:3,name:"IceThorn",nFaces:1,face:[{name:"north",nLevels:1,x:50,y:200,entranceLevel:0}]},{x:2,y:4,name:"Perilous Needle",nFaces:2,connectLevels:[["north","east",0,0]],face:[{name:"north",nLevels:1,x:100,y:400,entranceLevel:0},{name:"east",nLevels:1,x:100,y:400}]}]}]}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(8)),a=n(21),o=n(28),i=n(254),l=o.Keys.KeyMap.dirToKeyCode;t.CellClickHandler=class extends i.DriverBase{constructor(e,t){super(e,t),this._game=t,this._keyBuffer=[]}handleClick(e,t,n,s){if(!this.hasKeys())switch(s){case"attack":this.handleAttack(e,t,n);break;case"chat":this.handleChat(e,t,n);break;case"door":this.handleDoor(e,t,n);break;case"move":this.handleMove(e,t,n);break;case"pickup":this.handlePickup(e,t,n);break;case"shoot":this.handleShoot(e,t,n);break;case"usestairs":this.handleUseStairs(e,t,n);break;case"use-element":this.handleUseElement(e,t,n)}}handleAttack(e,t,n){this._keyBuffer.push({cmd:"attack",target:n})}handleChat(e,t,n){const s=this._game.getPlayer();if(n.hasActors()&&r.default.withinRange(1,[e,t],s)){const n=r.default.dXdY([e,t],s),a=l(n);console.log("handleChat dXdY: ",n," keyCode:",a),this._keyBuffer.push(o.Keys.KEY.CHAT),this._keyBuffer.push(a)}}handleDoor(e,t,n){const s=this._game.getPlayer();n.hasDoor()&&(this.moveTo(s,e,t),this._keyBuffer.push(o.Keys.KEY.DOOR))}handleMove(e,t,n){const s=this._game.getPlayer();s.getLevel().getMap().hasXY(e,t)&&(n.hasActors(),this.moveTo(s,e,t))}handlePickup(e,t,n){if(n.hasItems()){const n=this._game.getPlayer();this.moveTo(n,e,t),this._keyBuffer.push(o.Keys.KEY.PICKUP)}}handleShoot(e,t,n){const s={cmd:"missile",target:n};this._keyBuffer.push(s)}handleUseStairs(e,t,n){const s=this._game.getPlayer();this.moveTo(s,e,t),this._keyBuffer.push(o.Keys.KEY.USE_STAIRS_DOWN)}handleUseElement(e,t,n){const s={cmd:"use-element",target:n};this._keyBuffer.push(s)}moveTo(e,t,n){let s=[],[o,i]=[e.getX(),e.getY()],c=!0;const u=e.getLevel().getMap();if(!u.isExplored(t,n))return this._keyBuffer=[],void r.default.gameMsg({msg:"Cannot move to unexplored cell."});for(;o!==t&&i!==n;){const e=t-o,r=n-i;if(s.push(l(e,r)),o+=e/Math.abs(e),i+=r/Math.abs(r),!u.isPassable(o,i)){c=!1;break}}if(c&&t!==o)for(;o!==t;){const e=t-o;if(s.push(l(e,0)),o+=e/Math.abs(e),!u.isPassable(o,i)){c=!1;break}}else if(c&&n!==i)for(;i!==n;){const e=n-i;if(s.push(l(0,e)),i+=e/Math.abs(e),!u.isPassable(o,i)){c=!1;break}}c||([o,i]=[e.getX(),e.getY()],s=[],a.Path.getShortestActorPath(u,o,i,t,n).forEach(e=>{const t=e.x-o,n=e.y-i;s.push(l(t,n)),0!==t&&(o+=t/Math.abs(t)),0!==n&&(i+=n/Math.abs(n))})),this._keyBuffer=s}}},function(e,t,n){"use strict";this&&this.__awaiter;Object.defineProperty(t,"__esModule",{value:!0});const s=n(471);t.Persist=function(e){this.fromStorage=(t=>s.getItem(e,t)),this.toStorage=((t,n)=>{s.setItem(e,t,n)}),this.deleteStorage=(t=>{s.removeItem(e).then(t)})}},function(e,t,n){(function(t){var n;e.exports=function e(t,s,r){function a(i,l){if(!s[i]){if(!t[i]){var c="function"==typeof n&&n;if(!l&&c)return n(i,!0);if(o)return o(i,!0);var u=new Error("Cannot find module '"+i+"'");throw u.code="MODULE_NOT_FOUND",u}var h=s[i]={exports:{}};t[i][0].call(h.exports,function(e){var n=t[i][1][e];return a(n||e)},h,h.exports,e,t,s,r)}return s[i].exports}for(var o="function"==typeof n&&n,i=0;i<r.length;i++)a(r[i]);return a}({1:[function(e,n,s){(function(e){"use strict";var t,s,r=e.MutationObserver||e.WebKitMutationObserver;if(r){var a=0,o=new r(u),i=e.document.createTextNode("");o.observe(i,{characterData:!0}),t=function(){i.data=a=++a%2}}else if(e.setImmediate||void 0===e.MessageChannel)t="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){u(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(u,0)};else{var l=new e.MessageChannel;l.port1.onmessage=u,t=function(){l.port2.postMessage(0)}}var c=[];function u(){var e,t;s=!0;for(var n=c.length;n;){for(t=c,c=[],e=-1;++e<n;)t[e]();n=c.length}s=!1}n.exports=function(e){1!==c.push(e)||s||t()}}).call(this,void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,t,n){"use strict";var s=e(1);function r(){}var a={},o=["REJECTED"],i=["FULFILLED"],l=["PENDING"];function c(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=l,this.queue=[],this.outcome=void 0,e!==r&&p(this,e)}function u(e,t,n){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}function h(e,t,n){s(function(){var s;try{s=t(n)}catch(t){return a.reject(e,t)}s===e?a.reject(e,new TypeError("Cannot resolve promise with itself")):a.resolve(e,s)})}function d(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function p(e,t){var n=!1;function s(t){n||(n=!0,a.reject(e,t))}function r(t){n||(n=!0,a.resolve(e,t))}var o=f(function(){t(r,s)});"error"===o.status&&s(o.value)}function f(e,t){var n={};try{n.value=e(t),n.status="success"}catch(e){n.status="error",n.value=e}return n}t.exports=c,c.prototype.catch=function(e){return this.then(null,e)},c.prototype.then=function(e,t){if("function"!=typeof e&&this.state===i||"function"!=typeof t&&this.state===o)return this;var n=new this.constructor(r);if(this.state!==l){var s=this.state===i?e:t;h(n,s,this.outcome)}else this.queue.push(new u(n,e,t));return n},u.prototype.callFulfilled=function(e){a.resolve(this.promise,e)},u.prototype.otherCallFulfilled=function(e){h(this.promise,this.onFulfilled,e)},u.prototype.callRejected=function(e){a.reject(this.promise,e)},u.prototype.otherCallRejected=function(e){h(this.promise,this.onRejected,e)},a.resolve=function(e,t){var n=f(d,t);if("error"===n.status)return a.reject(e,n.value);var s=n.value;if(s)p(e,s);else{e.state=i,e.outcome=t;for(var r=-1,o=e.queue.length;++r<o;)e.queue[r].callFulfilled(t)}return e},a.reject=function(e,t){e.state=o,e.outcome=t;for(var n=-1,s=e.queue.length;++n<s;)e.queue[n].callRejected(t);return e},c.resolve=function(e){return e instanceof this?e:a.resolve(new this(r),e)},c.reject=function(e){var t=new this(r);return a.reject(t,e)},c.all=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,s=!1;if(!n)return this.resolve([]);for(var o=new Array(n),i=0,l=-1,c=new this(r);++l<n;)u(e[l],l);return c;function u(e,r){t.resolve(e).then(function(e){o[r]=e,++i!==n||s||(s=!0,a.resolve(c,o))},function(e){s||(s=!0,a.reject(c,e))})}},c.race=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,s=!1;if(!n)return this.resolve([]);for(var o,i=-1,l=new this(r);++i<n;)o=e[i],t.resolve(o).then(function(e){s||(s=!0,a.resolve(l,e))},function(e){s||(s=!0,a.reject(l,e))});return l}},{1:1}],3:[function(e,n,s){(function(t){"use strict";"function"!=typeof t.Promise&&(t.Promise=e(2))}).call(this,void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(e,t,n){"use strict";var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(e){return}}();function a(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(a){if("TypeError"!==a.name)throw a;for(var n="undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder,s=new n,r=0;r<e.length;r+=1)s.append(e[r]);return s.getBlob(t.type)}}"undefined"==typeof Promise&&e(3);var o=Promise;function i(e,t){t&&e.then(function(e){t(null,e)},function(e){t(e)})}function l(e,t,n){"function"==typeof t&&e.then(t),"function"==typeof n&&e.catch(n)}function c(e){return"string"!=typeof e&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function u(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}var h="local-forage-detect-blob-support",d=void 0,p={},f=Object.prototype.toString,m="readonly",g="readwrite";function y(e){return"boolean"==typeof d?o.resolve(d):function(e){return new o(function(t){var n=e.transaction(h,g),s=a([""]);n.objectStore(h).put(s,"key"),n.onabort=function(e){e.preventDefault(),e.stopPropagation(),t(!1)},n.oncomplete=function(){var e=navigator.userAgent.match(/Chrome\/(\d+)/),n=navigator.userAgent.match(/Edge\//);t(n||!e||parseInt(e[1],10)>=43)}}).catch(function(){return!1})}(e).then(function(e){return d=e})}function v(e){var t=p[e.name],n={};n.promise=new o(function(e,t){n.resolve=e,n.reject=t}),t.deferredOperations.push(n),t.dbReady?t.dbReady=t.dbReady.then(function(){return n.promise}):t.dbReady=n.promise}function _(e){var t=p[e.name],n=t.deferredOperations.pop();if(n)return n.resolve(),n.promise}function b(e,t){var n=p[e.name],s=n.deferredOperations.pop();if(s)return s.reject(t),s.promise}function E(e,t){return new o(function(n,s){if(p[e.name]=p[e.name]||{forages:[],db:null,dbReady:null,deferredOperations:[]},e.db){if(!t)return n(e.db);v(e),e.db.close()}var a=[e.name];t&&a.push(e.version);var o=r.open.apply(r,a);t&&(o.onupgradeneeded=function(t){var n=o.result;try{n.createObjectStore(e.storeName),t.oldVersion<=1&&n.createObjectStore(h)}catch(n){if("ConstraintError"!==n.name)throw n;console.warn('The database "'+e.name+'" has been upgraded from version '+t.oldVersion+" to version "+t.newVersion+', but the storage "'+e.storeName+'" already exists.')}}),o.onerror=function(e){e.preventDefault(),s(o.error)},o.onsuccess=function(){n(o.result),_(e)}})}function S(e){return E(e,!1)}function C(e){return E(e,!0)}function w(e,t){if(!e.db)return!0;var n=!e.db.objectStoreNames.contains(e.storeName),s=e.version<e.db.version,r=e.version>e.db.version;if(s&&(e.version!==t&&console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),r||n){if(n){var a=e.db.version+1;a>e.version&&(e.version=a)}return!0}return!1}function T(e){var t=function(e){for(var t=e.length,n=new ArrayBuffer(t),s=new Uint8Array(n),r=0;r<t;r++)s[r]=e.charCodeAt(r);return n}(atob(e.data));return a([t],{type:e.type})}function O(e){return e&&e.__local_forage_encoded_blob}function M(e){var t=this,n=t._initReady().then(function(){var e=p[t._dbInfo.name];if(e&&e.dbReady)return e.dbReady});return l(n,e,e),n}function A(e,t,n,s){void 0===s&&(s=1);try{var r=e.db.transaction(e.storeName,t);n(null,r)}catch(r){if(s>0&&(!e.db||"InvalidStateError"===r.name||"NotFoundError"===r.name))return o.resolve().then(function(){if(!e.db||"NotFoundError"===r.name&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),C(e)}).then(function(){return function(e){v(e);for(var t=p[e.name],n=t.forages,s=0;s<n.length;s++){var r=n[s];r._dbInfo.db&&(r._dbInfo.db.close(),r._dbInfo.db=null)}return e.db=null,S(e).then(function(t){return e.db=t,w(e)?C(e):t}).then(function(s){e.db=t.db=s;for(var r=0;r<n.length;r++)n[r]._dbInfo.db=s}).catch(function(t){throw b(e,t),t})}(e).then(function(){A(e,t,n,s-1)})}).catch(n);n(r)}}var N={_driver:"asyncStorage",_initStorage:function(e){var t=this,n={db:null};if(e)for(var s in e)n[s]=e[s];var r=p[n.name];r||(r={forages:[],db:null,dbReady:null,deferredOperations:[]},p[n.name]=r),r.forages.push(t),t._initReady||(t._initReady=t.ready,t.ready=M);var a=[];function i(){return o.resolve()}for(var l=0;l<r.forages.length;l++){var c=r.forages[l];c!==t&&a.push(c._initReady().catch(i))}var u=r.forages.slice(0);return o.all(a).then(function(){return n.db=r.db,S(n)}).then(function(e){return n.db=e,w(n,t._defaultConfig.version)?C(n):e}).then(function(e){n.db=r.db=e,t._dbInfo=n;for(var s=0;s<u.length;s++){var a=u[s];a!==t&&(a._dbInfo.db=n.db,a._dbInfo.version=n.version)}})},_support:function(){try{if(!r)return!1;var e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),t="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!e||t)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e){return!1}}(),iterate:function(e,t){var n=this,s=new o(function(t,s){n.ready().then(function(){A(n._dbInfo,m,function(r,a){if(r)return s(r);try{var o=a.objectStore(n._dbInfo.storeName),i=o.openCursor(),l=1;i.onsuccess=function(){var n=i.result;if(n){var s=n.value;O(s)&&(s=T(s));var r=e(s,n.key,l++);void 0!==r?t(r):n.continue()}else t()},i.onerror=function(){s(i.error)}}catch(e){s(e)}})}).catch(s)});return i(s,t),s},getItem:function(e,t){var n=this;e=c(e);var s=new o(function(t,s){n.ready().then(function(){A(n._dbInfo,m,function(r,a){if(r)return s(r);try{var o=a.objectStore(n._dbInfo.storeName),i=o.get(e);i.onsuccess=function(){var e=i.result;void 0===e&&(e=null),O(e)&&(e=T(e)),t(e)},i.onerror=function(){s(i.error)}}catch(e){s(e)}})}).catch(s)});return i(s,t),s},setItem:function(e,t,n){var s=this;e=c(e);var r=new o(function(n,r){var a;s.ready().then(function(){return a=s._dbInfo,"[object Blob]"===f.call(t)?y(a.db).then(function(e){return e?t:(n=t,new o(function(e,t){var s=new FileReader;s.onerror=t,s.onloadend=function(t){var s=btoa(t.target.result||"");e({__local_forage_encoded_blob:!0,data:s,type:n.type})},s.readAsBinaryString(n)}));var n}):t}).then(function(t){A(s._dbInfo,g,function(a,o){if(a)return r(a);try{var i=o.objectStore(s._dbInfo.storeName);null===t&&(t=void 0);var l=i.put(t,e);o.oncomplete=function(){void 0===t&&(t=null),n(t)},o.onabort=o.onerror=function(){var e=l.error?l.error:l.transaction.error;r(e)}}catch(e){r(e)}})}).catch(r)});return i(r,n),r},removeItem:function(e,t){var n=this;e=c(e);var s=new o(function(t,s){n.ready().then(function(){A(n._dbInfo,g,function(r,a){if(r)return s(r);try{var o=a.objectStore(n._dbInfo.storeName),i=o.delete(e);a.oncomplete=function(){t()},a.onerror=function(){s(i.error)},a.onabort=function(){var e=i.error?i.error:i.transaction.error;s(e)}}catch(e){s(e)}})}).catch(s)});return i(s,t),s},clear:function(e){var t=this,n=new o(function(e,n){t.ready().then(function(){A(t._dbInfo,g,function(s,r){if(s)return n(s);try{var a=r.objectStore(t._dbInfo.storeName),o=a.clear();r.oncomplete=function(){e()},r.onabort=r.onerror=function(){var e=o.error?o.error:o.transaction.error;n(e)}}catch(e){n(e)}})}).catch(n)});return i(n,e),n},length:function(e){var t=this,n=new o(function(e,n){t.ready().then(function(){A(t._dbInfo,m,function(s,r){if(s)return n(s);try{var a=r.objectStore(t._dbInfo.storeName),o=a.count();o.onsuccess=function(){e(o.result)},o.onerror=function(){n(o.error)}}catch(e){n(e)}})}).catch(n)});return i(n,e),n},key:function(e,t){var n=this,s=new o(function(t,s){e<0?t(null):n.ready().then(function(){A(n._dbInfo,m,function(r,a){if(r)return s(r);try{var o=a.objectStore(n._dbInfo.storeName),i=!1,l=o.openCursor();l.onsuccess=function(){var n=l.result;n?0===e?t(n.key):i?t(n.key):(i=!0,n.advance(e)):t(null)},l.onerror=function(){s(l.error)}}catch(e){s(e)}})}).catch(s)});return i(s,t),s},keys:function(e){var t=this,n=new o(function(e,n){t.ready().then(function(){A(t._dbInfo,m,function(s,r){if(s)return n(s);try{var a=r.objectStore(t._dbInfo.storeName),o=a.openCursor(),i=[];o.onsuccess=function(){var t=o.result;t?(i.push(t.key),t.continue()):e(i)},o.onerror=function(){n(o.error)}}catch(e){n(e)}})}).catch(n)});return i(n,e),n},dropInstance:function(e,t){t=u.apply(this,arguments);var n,s=this.config();if((e="function"!=typeof e&&e||{}).name||(e.name=e.name||s.name,e.storeName=e.storeName||s.storeName),e.name){var a=e.name===s.name&&this._dbInfo.db,l=a?o.resolve(this._dbInfo.db):S(e).then(function(t){var n=p[e.name],s=n.forages;n.db=t;for(var r=0;r<s.length;r++)s[r]._dbInfo.db=t;return t});n=e.storeName?l.then(function(t){if(t.objectStoreNames.contains(e.storeName)){var n=t.version+1;v(e);var s=p[e.name],a=s.forages;t.close();for(var i=0;i<a.length;i++){var l=a[i];l._dbInfo.db=null,l._dbInfo.version=n}var c=new o(function(t,s){var a=r.open(e.name,n);a.onerror=function(e){var t=a.result;t.close(),s(e)},a.onupgradeneeded=function(){var t=a.result;t.deleteObjectStore(e.storeName)},a.onsuccess=function(){var e=a.result;e.close(),t(e)}});return c.then(function(e){s.db=e;for(var t=0;t<a.length;t++){var n=a[t];n._dbInfo.db=e,_(n._dbInfo)}}).catch(function(t){throw(b(e,t)||o.resolve()).catch(function(){}),t})}}):l.then(function(t){v(e);var n=p[e.name],s=n.forages;t.close();for(var a=0;a<s.length;a++){var i=s[a];i._dbInfo.db=null}var l=new o(function(t,n){var s=r.deleteDatabase(e.name);s.onerror=s.onblocked=function(e){var t=s.result;t&&t.close(),n(e)},s.onsuccess=function(){var e=s.result;e&&e.close(),t(e)}});return l.then(function(e){n.db=e;for(var t=0;t<s.length;t++){var r=s[t];_(r._dbInfo)}}).catch(function(t){throw(b(e,t)||o.resolve()).catch(function(){}),t})})}else n=o.reject("Invalid arguments");return i(n,t),n}},P="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",x="~~local_forage_type~",I=/^~~local_forage_type~([^~]+)~/,D="__lfsc__:",k=D.length,L="arbf",R="blob",B="si08",G="ui08",F="uic8",W="si16",Y="si32",j="ur16",X="ui32",U="fl32",$="fl64",K=k+L.length,V=Object.prototype.toString;function H(e){var t,n,s,r,a,o=.75*e.length,i=e.length,l=0;"="===e[e.length-1]&&(o--,"="===e[e.length-2]&&o--);var c=new ArrayBuffer(o),u=new Uint8Array(c);for(t=0;t<i;t+=4)n=P.indexOf(e[t]),s=P.indexOf(e[t+1]),r=P.indexOf(e[t+2]),a=P.indexOf(e[t+3]),u[l++]=n<<2|s>>4,u[l++]=(15&s)<<4|r>>2,u[l++]=(3&r)<<6|63&a;return c}function q(e){var t,n=new Uint8Array(e),s="";for(t=0;t<n.length;t+=3)s+=P[n[t]>>2],s+=P[(3&n[t])<<4|n[t+1]>>4],s+=P[(15&n[t+1])<<2|n[t+2]>>6],s+=P[63&n[t+2]];return n.length%3==2?s=s.substring(0,s.length-1)+"=":n.length%3==1&&(s=s.substring(0,s.length-2)+"=="),s}var J={serialize:function(e,t){var n="";if(e&&(n=V.call(e)),e&&("[object ArrayBuffer]"===n||e.buffer&&"[object ArrayBuffer]"===V.call(e.buffer))){var s,r=D;e instanceof ArrayBuffer?(s=e,r+=L):(s=e.buffer,"[object Int8Array]"===n?r+=B:"[object Uint8Array]"===n?r+=G:"[object Uint8ClampedArray]"===n?r+=F:"[object Int16Array]"===n?r+=W:"[object Uint16Array]"===n?r+=j:"[object Int32Array]"===n?r+=Y:"[object Uint32Array]"===n?r+=X:"[object Float32Array]"===n?r+=U:"[object Float64Array]"===n?r+=$:t(new Error("Failed to get type for BinaryArray"))),t(r+q(s))}else if("[object Blob]"===n){var a=new FileReader;a.onload=function(){var n=x+e.type+"~"+q(this.result);t(D+R+n)},a.readAsArrayBuffer(e)}else try{t(JSON.stringify(e))}catch(n){console.error("Couldn't convert value into a JSON string: ",e),t(null,n)}},deserialize:function(e){if(e.substring(0,k)!==D)return JSON.parse(e);var t,n=e.substring(K),s=e.substring(k,K);if(s===R&&I.test(n)){var r=n.match(I);t=r[1],n=n.substring(r[0].length)}var o=H(n);switch(s){case L:return o;case R:return a([o],{type:t});case B:return new Int8Array(o);case G:return new Uint8Array(o);case F:return new Uint8ClampedArray(o);case W:return new Int16Array(o);case j:return new Uint16Array(o);case Y:return new Int32Array(o);case X:return new Uint32Array(o);case U:return new Float32Array(o);case $:return new Float64Array(o);default:throw new Error("Unkown type: "+s)}},stringToBuffer:H,bufferToString:q};function z(e,t,n,s){e.executeSql("CREATE TABLE IF NOT EXISTS "+t.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],n,s)}function Q(e,t,n,s,r,a){e.executeSql(n,s,r,function(e,o){o.code===o.SYNTAX_ERR?e.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[t.storeName],function(e,i){i.rows.length?a(e,o):z(e,t,function(){e.executeSql(n,s,r,a)},a)},a):a(e,o)},a)}var Z={_driver:"webSQLStorage",_initStorage:function(e){var t=this,n={db:null};if(e)for(var s in e)n[s]="string"!=typeof e[s]?e[s].toString():e[s];var r=new o(function(e,s){try{n.db=openDatabase(n.name,String(n.version),n.description,n.size)}catch(e){return s(e)}n.db.transaction(function(r){z(r,n,function(){t._dbInfo=n,e()},function(e,t){s(t)})},s)});return n.serializer=J,r},_support:"function"==typeof openDatabase,iterate:function(e,t){var n=this,s=new o(function(t,s){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(n){Q(n,r,"SELECT * FROM "+r.storeName,[],function(n,s){for(var a=s.rows,o=a.length,i=0;i<o;i++){var l=a.item(i),c=l.value;if(c&&(c=r.serializer.deserialize(c)),void 0!==(c=e(c,l.key,i+1)))return void t(c)}t()},function(e,t){s(t)})})}).catch(s)});return i(s,t),s},getItem:function(e,t){var n=this;e=c(e);var s=new o(function(t,s){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(n){Q(n,r,"SELECT * FROM "+r.storeName+" WHERE key = ? LIMIT 1",[e],function(e,n){var s=n.rows.length?n.rows.item(0).value:null;s&&(s=r.serializer.deserialize(s)),t(s)},function(e,t){s(t)})})}).catch(s)});return i(s,t),s},setItem:function(e,t,n){return function e(t,n,s,r){var a=this;t=c(t);var l=new o(function(o,i){a.ready().then(function(){void 0===n&&(n=null);var l=n,c=a._dbInfo;c.serializer.serialize(n,function(n,u){u?i(u):c.db.transaction(function(e){Q(e,c,"INSERT OR REPLACE INTO "+c.storeName+" (key, value) VALUES (?, ?)",[t,n],function(){o(l)},function(e,t){i(t)})},function(n){if(n.code===n.QUOTA_ERR){if(r>0)return void o(e.apply(a,[t,l,s,r-1]));i(n)}})})}).catch(i)});return i(l,s),l}.apply(this,[e,t,n,1])},removeItem:function(e,t){var n=this;e=c(e);var s=new o(function(t,s){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(n){Q(n,r,"DELETE FROM "+r.storeName+" WHERE key = ?",[e],function(){t()},function(e,t){s(t)})})}).catch(s)});return i(s,t),s},clear:function(e){var t=this,n=new o(function(e,n){t.ready().then(function(){var s=t._dbInfo;s.db.transaction(function(t){Q(t,s,"DELETE FROM "+s.storeName,[],function(){e()},function(e,t){n(t)})})}).catch(n)});return i(n,e),n},length:function(e){var t=this,n=new o(function(e,n){t.ready().then(function(){var s=t._dbInfo;s.db.transaction(function(t){Q(t,s,"SELECT COUNT(key) as c FROM "+s.storeName,[],function(t,n){var s=n.rows.item(0).c;e(s)},function(e,t){n(t)})})}).catch(n)});return i(n,e),n},key:function(e,t){var n=this,s=new o(function(t,s){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(n){Q(n,r,"SELECT key FROM "+r.storeName+" WHERE id = ? LIMIT 1",[e+1],function(e,n){var s=n.rows.length?n.rows.item(0).key:null;t(s)},function(e,t){s(t)})})}).catch(s)});return i(s,t),s},keys:function(e){var t=this,n=new o(function(e,n){t.ready().then(function(){var s=t._dbInfo;s.db.transaction(function(t){Q(t,s,"SELECT key FROM "+s.storeName,[],function(t,n){for(var s=[],r=0;r<n.rows.length;r++)s.push(n.rows.item(r).key);e(s)},function(e,t){n(t)})})}).catch(n)});return i(n,e),n},dropInstance:function(e,t){t=u.apply(this,arguments);var n=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||n.name,e.storeName=e.storeName||n.storeName);var s,r=this;return i(s=e.name?new o(function(t){var s;s=e.name===n.name?r._dbInfo.db:openDatabase(e.name,"","",0),e.storeName?t({db:s,storeNames:[e.storeName]}):t(function(e){return new o(function(t,n){e.transaction(function(s){s.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(n,s){for(var r=[],a=0;a<s.rows.length;a++)r.push(s.rows.item(a).name);t({db:e,storeNames:r})},function(e,t){n(t)})},function(e){n(e)})})}(s))}).then(function(e){return new o(function(t,n){e.db.transaction(function(s){function r(e){return new o(function(t,n){s.executeSql("DROP TABLE IF EXISTS "+e,[],function(){t()},function(e,t){n(t)})})}for(var a=[],i=0,l=e.storeNames.length;i<l;i++)a.push(r(e.storeNames[i]));o.all(a).then(function(){t()}).catch(function(e){n(e)})},function(e){n(e)})})}):o.reject("Invalid arguments"),t),s}};function ee(e,t){var n=e.name+"/";return e.storeName!==t.storeName&&(n+=e.storeName+"/"),n}function te(){return!function(){try{return localStorage.setItem("_localforage_support_test",!0),localStorage.removeItem("_localforage_support_test"),!1}catch(e){return!0}}()||localStorage.length>0}var ne={_driver:"localStorageWrapper",_initStorage:function(e){var t={};if(e)for(var n in e)t[n]=e[n];return t.keyPrefix=ee(e,this._defaultConfig),te()?(this._dbInfo=t,t.serializer=J,o.resolve()):o.reject()},_support:function(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(e){return!1}}(),iterate:function(e,t){var n=this,s=n.ready().then(function(){for(var t=n._dbInfo,s=t.keyPrefix,r=s.length,a=localStorage.length,o=1,i=0;i<a;i++){var l=localStorage.key(i);if(0===l.indexOf(s)){var c=localStorage.getItem(l);if(c&&(c=t.serializer.deserialize(c)),void 0!==(c=e(c,l.substring(r),o++)))return c}}});return i(s,t),s},getItem:function(e,t){var n=this;e=c(e);var s=n.ready().then(function(){var t=n._dbInfo,s=localStorage.getItem(t.keyPrefix+e);return s&&(s=t.serializer.deserialize(s)),s});return i(s,t),s},setItem:function(e,t,n){var s=this;e=c(e);var r=s.ready().then(function(){void 0===t&&(t=null);var n=t;return new o(function(r,a){var o=s._dbInfo;o.serializer.serialize(t,function(t,s){if(s)a(s);else try{localStorage.setItem(o.keyPrefix+e,t),r(n)}catch(e){"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name||a(e),a(e)}})})});return i(r,n),r},removeItem:function(e,t){var n=this;e=c(e);var s=n.ready().then(function(){var t=n._dbInfo;localStorage.removeItem(t.keyPrefix+e)});return i(s,t),s},clear:function(e){var t=this,n=t.ready().then(function(){for(var e=t._dbInfo.keyPrefix,n=localStorage.length-1;n>=0;n--){var s=localStorage.key(n);0===s.indexOf(e)&&localStorage.removeItem(s)}});return i(n,e),n},length:function(e){var t=this.keys().then(function(e){return e.length});return i(t,e),t},key:function(e,t){var n=this,s=n.ready().then(function(){var t,s=n._dbInfo;try{t=localStorage.key(e)}catch(e){t=null}return t&&(t=t.substring(s.keyPrefix.length)),t});return i(s,t),s},keys:function(e){var t=this,n=t.ready().then(function(){for(var e=t._dbInfo,n=localStorage.length,s=[],r=0;r<n;r++){var a=localStorage.key(r);0===a.indexOf(e.keyPrefix)&&s.push(a.substring(e.keyPrefix.length))}return s});return i(n,e),n},dropInstance:function(e,t){if(t=u.apply(this,arguments),!(e="function"!=typeof e&&e||{}).name){var n=this.config();e.name=e.name||n.name,e.storeName=e.storeName||n.storeName}var s,r=this;return i(s=e.name?new o(function(t){e.storeName?t(ee(e,r._defaultConfig)):t(e.name+"/")}).then(function(e){for(var t=localStorage.length-1;t>=0;t--){var n=localStorage.key(t);0===n.indexOf(e)&&localStorage.removeItem(n)}}):o.reject("Invalid arguments"),t),s}},se=function(e,t){for(var n=e.length,s=0;s<n;){if((r=e[s])===(a=t)||"number"==typeof r&&"number"==typeof a&&isNaN(r)&&isNaN(a))return!0;s++}var r,a;return!1},re=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},ae={},oe={},ie={INDEXEDDB:N,WEBSQL:Z,LOCALSTORAGE:ne},le=[ie.INDEXEDDB._driver,ie.WEBSQL._driver,ie.LOCALSTORAGE._driver],ce=["dropInstance"],ue=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(ce),he={description:"",driver:le.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function de(e,t){e[t]=function(){var n=arguments;return e.ready().then(function(){return e[t].apply(e,n)})}}function pe(){for(var e=1;e<arguments.length;e++){var t=arguments[e];if(t)for(var n in t)t.hasOwnProperty(n)&&(re(t[n])?arguments[0][n]=t[n].slice():arguments[0][n]=t[n])}return arguments[0]}var fe=function(){function e(t){for(var n in function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),ie)if(ie.hasOwnProperty(n)){var s=ie[n],r=s._driver;this[n]=r,ae[r]||this.defineDriver(s)}this._defaultConfig=pe({},he),this._config=pe({},this._defaultConfig,t),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return e.prototype.config=function(e){if("object"===(void 0===e?"undefined":s(e))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var t in e){if("storeName"===t&&(e[t]=e[t].replace(/\W/g,"_")),"version"===t&&"number"!=typeof e[t])return new Error("Database version must be a number.");this._config[t]=e[t]}return!("driver"in e&&e.driver)||this.setDriver(this._config.driver)}return"string"==typeof e?this._config[e]:this._config},e.prototype.defineDriver=function(e,t,n){var s=new o(function(t,n){try{var s=e._driver,r=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!e._driver)return void n(r);for(var a=ue.concat("_initStorage"),l=0,c=a.length;l<c;l++){var u=a[l],h=!se(ce,u);if((h||e[u])&&"function"!=typeof e[u])return void n(r)}!function(){for(var t=function(e){return function(){var t=new Error("Method "+e+" is not implemented by the current driver"),n=o.reject(t);return i(n,arguments[arguments.length-1]),n}},n=0,s=ce.length;n<s;n++){var r=ce[n];e[r]||(e[r]=t(r))}}();var d=function(n){ae[s]&&console.info("Redefining LocalForage driver: "+s),ae[s]=e,oe[s]=n,t()};"_support"in e?e._support&&"function"==typeof e._support?e._support().then(d,n):d(!!e._support):d(!0)}catch(e){n(e)}});return l(s,t,n),s},e.prototype.driver=function(){return this._driver||null},e.prototype.getDriver=function(e,t,n){var s=ae[e]?o.resolve(ae[e]):o.reject(new Error("Driver not found."));return l(s,t,n),s},e.prototype.getSerializer=function(e){var t=o.resolve(J);return l(t,e),t},e.prototype.ready=function(e){var t=this,n=t._driverSet.then(function(){return null===t._ready&&(t._ready=t._initDriver()),t._ready});return l(n,e,e),n},e.prototype.setDriver=function(e,t,n){var s=this;re(e)||(e=[e]);var r=this._getSupportedDrivers(e);function a(){s._config.driver=s.driver()}function i(e){return s._extend(e),a(),s._ready=s._initStorage(s._config),s._ready}var c=null!==this._driverSet?this._driverSet.catch(function(){return o.resolve()}):o.resolve();return this._driverSet=c.then(function(){var e=r[0];return s._dbInfo=null,s._ready=null,s.getDriver(e).then(function(e){s._driver=e._driver,a(),s._wrapLibraryMethodsWithReady(),s._initDriver=function(e){return function(){var t=0;return function n(){for(;t<e.length;){var r=e[t];return t++,s._dbInfo=null,s._ready=null,s.getDriver(r).then(i).catch(n)}a();var l=new Error("No available storage method found.");return s._driverSet=o.reject(l),s._driverSet}()}}(r)})}).catch(function(){a();var e=new Error("No available storage method found.");return s._driverSet=o.reject(e),s._driverSet}),l(this._driverSet,t,n),this._driverSet},e.prototype.supports=function(e){return!!oe[e]},e.prototype._extend=function(e){pe(this,e)},e.prototype._getSupportedDrivers=function(e){for(var t=[],n=0,s=e.length;n<s;n++){var r=e[n];this.supports(r)&&t.push(r)}return t},e.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0,t=ue.length;e<t;e++)de(this,ue[e])},e.prototype.createInstance=function(t){return new e(t)},e}(),me=new fe;t.exports=me},{3:3}]},{},[4])(4)}).call(this,n(89))},function(module,exports,__webpack_require__){(function(process,global){var __WEBPACK_AMD_DEFINE_RESULT__;
/**
 * [js-md5]{@link https://github.com/emn178/js-md5}
 *
 * @namespace md5
 * @version 0.6.1
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */
/**
 * [js-md5]{@link https://github.com/emn178/js-md5}
 *
 * @namespace md5
 * @version 0.6.1
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */
!function(){"use strict";var ERROR="input is invalid type",WINDOW="object"==typeof window,root=WINDOW?window:{};root.JS_MD5_NO_WINDOW&&(WINDOW=!1);var WEB_WORKER=!WINDOW&&"object"==typeof self,NODE_JS=!root.JS_MD5_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;NODE_JS?root=global:WEB_WORKER&&(root=self);var COMMON_JS=!root.JS_MD5_NO_COMMON_JS&&"object"==typeof module&&module.exports,AMD=__webpack_require__(212),ARRAY_BUFFER=!root.JS_MD5_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,HEX_CHARS="0123456789abcdef".split(""),EXTRA=[128,32768,8388608,-2147483648],SHIFT=[0,8,16,24],OUTPUT_TYPES=["hex","array","digest","buffer","arrayBuffer","base64"],BASE64_ENCODE_CHAR="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),blocks=[],buffer8;if(ARRAY_BUFFER){var buffer=new ArrayBuffer(68);buffer8=new Uint8Array(buffer),blocks=new Uint32Array(buffer)}!root.JS_MD5_NO_NODE_JS&&Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),!ARRAY_BUFFER||!root.JS_MD5_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView||(ArrayBuffer.isView=function(e){return"object"==typeof e&&e.buffer&&e.buffer.constructor===ArrayBuffer});var createOutputMethod=function(e){return function(t){return new Md5(!0).update(t)[e]()}},createMethod=function(){var e=createOutputMethod("hex");NODE_JS&&(e=nodeWrap(e)),e.create=function(){return new Md5},e.update=function(t){return e.create().update(t)};for(var t=0;t<OUTPUT_TYPES.length;++t){var n=OUTPUT_TYPES[t];e[n]=createOutputMethod(n)}return e},nodeWrap=function(method){var crypto=eval("require('crypto')"),Buffer=eval("require('buffer').Buffer"),nodeMethod=function(e){if("string"==typeof e)return crypto.createHash("md5").update(e,"utf8").digest("hex");if(null==e)throw ERROR;return e.constructor===ArrayBuffer&&(e=new Uint8Array(e)),Array.isArray(e)||ArrayBuffer.isView(e)||e.constructor===Buffer?crypto.createHash("md5").update(new Buffer(e)).digest("hex"):method(e)};return nodeMethod};function Md5(e){if(e)blocks[0]=blocks[16]=blocks[1]=blocks[2]=blocks[3]=blocks[4]=blocks[5]=blocks[6]=blocks[7]=blocks[8]=blocks[9]=blocks[10]=blocks[11]=blocks[12]=blocks[13]=blocks[14]=blocks[15]=0,this.blocks=blocks,this.buffer8=buffer8;else if(ARRAY_BUFFER){var t=new ArrayBuffer(68);this.buffer8=new Uint8Array(t),this.blocks=new Uint32Array(t)}else this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.h0=this.h1=this.h2=this.h3=this.start=this.bytes=0,this.finalized=this.hashed=!1,this.first=!0}Md5.prototype.update=function(e){if(!this.finalized){var t,n=typeof e;if("string"!==n){if("object"!==n)throw ERROR;if(null===e)throw ERROR;if(ARRAY_BUFFER&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!(Array.isArray(e)||ARRAY_BUFFER&&ArrayBuffer.isView(e)))throw ERROR;t=!0}for(var s,r,a=0,o=e.length,i=this.blocks,l=this.buffer8;a<o;){if(this.hashed&&(this.hashed=!1,i[0]=i[16],i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),t)if(ARRAY_BUFFER)for(r=this.start;a<o&&r<64;++a)l[r++]=e[a];else for(r=this.start;a<o&&r<64;++a)i[r>>2]|=e[a]<<SHIFT[3&r++];else if(ARRAY_BUFFER)for(r=this.start;a<o&&r<64;++a)(s=e.charCodeAt(a))<128?l[r++]=s:s<2048?(l[r++]=192|s>>6,l[r++]=128|63&s):s<55296||s>=57344?(l[r++]=224|s>>12,l[r++]=128|s>>6&63,l[r++]=128|63&s):(s=65536+((1023&s)<<10|1023&e.charCodeAt(++a)),l[r++]=240|s>>18,l[r++]=128|s>>12&63,l[r++]=128|s>>6&63,l[r++]=128|63&s);else for(r=this.start;a<o&&r<64;++a)(s=e.charCodeAt(a))<128?i[r>>2]|=s<<SHIFT[3&r++]:s<2048?(i[r>>2]|=(192|s>>6)<<SHIFT[3&r++],i[r>>2]|=(128|63&s)<<SHIFT[3&r++]):s<55296||s>=57344?(i[r>>2]|=(224|s>>12)<<SHIFT[3&r++],i[r>>2]|=(128|s>>6&63)<<SHIFT[3&r++],i[r>>2]|=(128|63&s)<<SHIFT[3&r++]):(s=65536+((1023&s)<<10|1023&e.charCodeAt(++a)),i[r>>2]|=(240|s>>18)<<SHIFT[3&r++],i[r>>2]|=(128|s>>12&63)<<SHIFT[3&r++],i[r>>2]|=(128|s>>6&63)<<SHIFT[3&r++],i[r>>2]|=(128|63&s)<<SHIFT[3&r++]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this}},Md5.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[t>>2]|=EXTRA[3&t],t>=56&&(this.hashed||this.hash(),e[0]=e[16],e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.bytes<<3,this.hash()}},Md5.prototype.hash=function(){var e,t,n,s,r,a,o=this.blocks;this.first?t=((t=((e=((e=o[0]-680876937)<<7|e>>>25)-271733879<<0)^(n=((n=(-271733879^(s=((s=(-1732584194^2004318071&e)+o[1]-117830708)<<12|s>>>20)+e<<0)&(-271733879^e))+o[2]-1126478375)<<17|n>>>15)+s<<0)&(s^e))+o[3]-1316259209)<<22|t>>>10)+n<<0:(e=this.h0,t=this.h1,n=this.h2,t=((t+=((e=((e+=((s=this.h3)^t&(n^s))+o[0]-680876936)<<7|e>>>25)+t<<0)^(n=((n+=(t^(s=((s+=(n^e&(t^n))+o[1]-389564586)<<12|s>>>20)+e<<0)&(e^t))+o[2]+606105819)<<17|n>>>15)+s<<0)&(s^e))+o[3]-1044525330)<<22|t>>>10)+n<<0),t=((t+=((e=((e+=(s^t&(n^s))+o[4]-176418897)<<7|e>>>25)+t<<0)^(n=((n+=(t^(s=((s+=(n^e&(t^n))+o[5]+1200080426)<<12|s>>>20)+e<<0)&(e^t))+o[6]-1473231341)<<17|n>>>15)+s<<0)&(s^e))+o[7]-45705983)<<22|t>>>10)+n<<0,t=((t+=((e=((e+=(s^t&(n^s))+o[8]+1770035416)<<7|e>>>25)+t<<0)^(n=((n+=(t^(s=((s+=(n^e&(t^n))+o[9]-1958414417)<<12|s>>>20)+e<<0)&(e^t))+o[10]-42063)<<17|n>>>15)+s<<0)&(s^e))+o[11]-1990404162)<<22|t>>>10)+n<<0,t=((t+=((e=((e+=(s^t&(n^s))+o[12]+1804603682)<<7|e>>>25)+t<<0)^(n=((n+=(t^(s=((s+=(n^e&(t^n))+o[13]-40341101)<<12|s>>>20)+e<<0)&(e^t))+o[14]-1502002290)<<17|n>>>15)+s<<0)&(s^e))+o[15]+1236535329)<<22|t>>>10)+n<<0,t=((t+=((s=((s+=(t^n&((e=((e+=(n^s&(t^n))+o[1]-165796510)<<5|e>>>27)+t<<0)^t))+o[6]-1069501632)<<9|s>>>23)+e<<0)^e&((n=((n+=(e^t&(s^e))+o[11]+643717713)<<14|n>>>18)+s<<0)^s))+o[0]-373897302)<<20|t>>>12)+n<<0,t=((t+=((s=((s+=(t^n&((e=((e+=(n^s&(t^n))+o[5]-701558691)<<5|e>>>27)+t<<0)^t))+o[10]+38016083)<<9|s>>>23)+e<<0)^e&((n=((n+=(e^t&(s^e))+o[15]-660478335)<<14|n>>>18)+s<<0)^s))+o[4]-405537848)<<20|t>>>12)+n<<0,t=((t+=((s=((s+=(t^n&((e=((e+=(n^s&(t^n))+o[9]+568446438)<<5|e>>>27)+t<<0)^t))+o[14]-1019803690)<<9|s>>>23)+e<<0)^e&((n=((n+=(e^t&(s^e))+o[3]-187363961)<<14|n>>>18)+s<<0)^s))+o[8]+1163531501)<<20|t>>>12)+n<<0,t=((t+=((s=((s+=(t^n&((e=((e+=(n^s&(t^n))+o[13]-1444681467)<<5|e>>>27)+t<<0)^t))+o[2]-51403784)<<9|s>>>23)+e<<0)^e&((n=((n+=(e^t&(s^e))+o[7]+1735328473)<<14|n>>>18)+s<<0)^s))+o[12]-1926607734)<<20|t>>>12)+n<<0,t=((t+=((a=(s=((s+=((r=t^n)^(e=((e+=(r^s)+o[5]-378558)<<4|e>>>28)+t<<0))+o[8]-2022574463)<<11|s>>>21)+e<<0)^e)^(n=((n+=(a^t)+o[11]+1839030562)<<16|n>>>16)+s<<0))+o[14]-35309556)<<23|t>>>9)+n<<0,t=((t+=((a=(s=((s+=((r=t^n)^(e=((e+=(r^s)+o[1]-1530992060)<<4|e>>>28)+t<<0))+o[4]+1272893353)<<11|s>>>21)+e<<0)^e)^(n=((n+=(a^t)+o[7]-155497632)<<16|n>>>16)+s<<0))+o[10]-1094730640)<<23|t>>>9)+n<<0,t=((t+=((a=(s=((s+=((r=t^n)^(e=((e+=(r^s)+o[13]+681279174)<<4|e>>>28)+t<<0))+o[0]-358537222)<<11|s>>>21)+e<<0)^e)^(n=((n+=(a^t)+o[3]-722521979)<<16|n>>>16)+s<<0))+o[6]+76029189)<<23|t>>>9)+n<<0,t=((t+=((a=(s=((s+=((r=t^n)^(e=((e+=(r^s)+o[9]-640364487)<<4|e>>>28)+t<<0))+o[12]-421815835)<<11|s>>>21)+e<<0)^e)^(n=((n+=(a^t)+o[15]+530742520)<<16|n>>>16)+s<<0))+o[2]-995338651)<<23|t>>>9)+n<<0,t=((t+=((s=((s+=(t^((e=((e+=(n^(t|~s))+o[0]-198630844)<<6|e>>>26)+t<<0)|~n))+o[7]+1126891415)<<10|s>>>22)+e<<0)^((n=((n+=(e^(s|~t))+o[14]-1416354905)<<15|n>>>17)+s<<0)|~e))+o[5]-57434055)<<21|t>>>11)+n<<0,t=((t+=((s=((s+=(t^((e=((e+=(n^(t|~s))+o[12]+1700485571)<<6|e>>>26)+t<<0)|~n))+o[3]-1894986606)<<10|s>>>22)+e<<0)^((n=((n+=(e^(s|~t))+o[10]-1051523)<<15|n>>>17)+s<<0)|~e))+o[1]-2054922799)<<21|t>>>11)+n<<0,t=((t+=((s=((s+=(t^((e=((e+=(n^(t|~s))+o[8]+1873313359)<<6|e>>>26)+t<<0)|~n))+o[15]-30611744)<<10|s>>>22)+e<<0)^((n=((n+=(e^(s|~t))+o[6]-1560198380)<<15|n>>>17)+s<<0)|~e))+o[13]+1309151649)<<21|t>>>11)+n<<0,t=((t+=((s=((s+=(t^((e=((e+=(n^(t|~s))+o[4]-145523070)<<6|e>>>26)+t<<0)|~n))+o[11]-1120210379)<<10|s>>>22)+e<<0)^((n=((n+=(e^(s|~t))+o[2]+718787259)<<15|n>>>17)+s<<0)|~e))+o[9]-343485551)<<21|t>>>11)+n<<0,this.first?(this.h0=e+1732584193<<0,this.h1=t-271733879<<0,this.h2=n-1732584194<<0,this.h3=s+271733878<<0,this.first=!1):(this.h0=this.h0+e<<0,this.h1=this.h1+t<<0,this.h2=this.h2+n<<0,this.h3=this.h3+s<<0)},Md5.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,s=this.h3;return HEX_CHARS[e>>4&15]+HEX_CHARS[15&e]+HEX_CHARS[e>>12&15]+HEX_CHARS[e>>8&15]+HEX_CHARS[e>>20&15]+HEX_CHARS[e>>16&15]+HEX_CHARS[e>>28&15]+HEX_CHARS[e>>24&15]+HEX_CHARS[t>>4&15]+HEX_CHARS[15&t]+HEX_CHARS[t>>12&15]+HEX_CHARS[t>>8&15]+HEX_CHARS[t>>20&15]+HEX_CHARS[t>>16&15]+HEX_CHARS[t>>28&15]+HEX_CHARS[t>>24&15]+HEX_CHARS[n>>4&15]+HEX_CHARS[15&n]+HEX_CHARS[n>>12&15]+HEX_CHARS[n>>8&15]+HEX_CHARS[n>>20&15]+HEX_CHARS[n>>16&15]+HEX_CHARS[n>>28&15]+HEX_CHARS[n>>24&15]+HEX_CHARS[s>>4&15]+HEX_CHARS[15&s]+HEX_CHARS[s>>12&15]+HEX_CHARS[s>>8&15]+HEX_CHARS[s>>20&15]+HEX_CHARS[s>>16&15]+HEX_CHARS[s>>28&15]+HEX_CHARS[s>>24&15]},Md5.prototype.toString=Md5.prototype.hex,Md5.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,s=this.h3;return[255&e,e>>8&255,e>>16&255,e>>24&255,255&t,t>>8&255,t>>16&255,t>>24&255,255&n,n>>8&255,n>>16&255,n>>24&255,255&s,s>>8&255,s>>16&255,s>>24&255]},Md5.prototype.array=Md5.prototype.digest,Md5.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(16),t=new Uint32Array(e);return t[0]=this.h0,t[1]=this.h1,t[2]=this.h2,t[3]=this.h3,e},Md5.prototype.buffer=Md5.prototype.arrayBuffer,Md5.prototype.base64=function(){for(var e,t,n,s="",r=this.array(),a=0;a<15;)e=r[a++],t=r[a++],n=r[a++],s+=BASE64_ENCODE_CHAR[e>>>2]+BASE64_ENCODE_CHAR[63&(e<<4|t>>>4)]+BASE64_ENCODE_CHAR[63&(t<<2|n>>>6)]+BASE64_ENCODE_CHAR[63&n];return e=r[a],s+=BASE64_ENCODE_CHAR[e>>>2]+BASE64_ENCODE_CHAR[e<<4&63]+"=="};var exports=createMethod();COMMON_JS?module.exports=exports:(root.md5=exports,AMD&&(__WEBPACK_AMD_DEFINE_RESULT__=function(){return exports}.call(exports,__webpack_require__,exports,module),void 0===__WEBPACK_AMD_DEFINE_RESULT__||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__)))}()}).call(this,__webpack_require__(182),__webpack_require__(89))},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1)),a=s(n(213)),o={isPassable:[{text:"Move",type:"move"}],hasActors:[{text:"Attack",type:"attack"},{text:"Chat",type:"chat"},{text:"Order",type:"order"},{text:"Shoot",type:"shoot"}],hasDoor:[{text:"Open/close",type:"door"}],hasItems:[{text:"Pick up",type:"pickup"}],hasUsable:[{text:"Use element",type:"use-element"}],hasShop:[{text:"Buy item",type:"buyitem"},{text:"Sell item",type:"sellitem"}],hasConnection:{hasPassage:[{text:"Travel",type:"usestairs"}],hasStairs:[{text:"Use stairs",type:"usestairs"}],hasTown:[{text:"Goto town",type:"usestairs"}],hasBattle:[{text:"Goto battle",type:"usestairs"}],hasMountain:[{text:"Goto mountain",type:"usestairs"}]}};t.default=class extends r.default.Component{render(){return r.default.createElement(a.default,{handleRightClick:this.props.handleRightClick,menuItems:o,mouseOverCell:this.props.mouseOverCell})}}}]);
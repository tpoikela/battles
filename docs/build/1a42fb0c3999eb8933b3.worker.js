!function(e){var t={};function s(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=t,s.d=function(e,t,a){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(s.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(a,n,function(t){return e[t]}.bind(null,n));return a},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/build/",s(s.s=111)}([function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a={gameTitle:"Battles in the North (BitN)",suppressErrorMessages:!1,suppressLogs:!1,suppressWarningMessages:!1,suppressDiagnosticMessages:!1,cellRenderVisible:["actors","items","elements"],cellRenderAlways:["items","elements"],getCssClassForCell:function(e,t){this.cellRenderArray=t?this.cellRenderVisible:this.cellRenderAlways;const s=this.getStyleClassForCell(e);return this.cellRenderArray=this.cellRenderVisible,s},getCssClassFullMap:function(e){if(this.cellRenderArray=this.cellRenderVisible,!e.hasProps()){const t=e.getBaseElem().getType();return this.cellStyles.elements[t]}for(let t=0;t<3;t++){const s=this.cellRenderVisible[t];if(e.hasProp(s)){const t=e.getProp(s),a=this.cellStyles[s];return this.getPropClassOrChar(a,t[0])}}return null},getCharForCell:function(e,t){this.cellRenderArray=t?this.cellRenderVisible:this.cellRenderAlways;const s=this.getCellChar(e);return this.cellRenderArray=this.cellRenderVisible,s},getCharFullMap:function(e){if(this.cellRenderArray=this.cellRenderVisible,!e.hasProps()){const t=e.getBaseElem().getType();return this.charStyles.elements[t]}for(let t=0;t<3;t++)if(e.hasProp(this.cellRenderVisible[t])){const s=e.getProp(this.cellRenderVisible[t]),a=this.charStyles[this.cellRenderVisible[t]];return this.getPropClassOrChar(a,s[0])}return null},getStyleClassForCell:function(e){if(!e.isExplored())return"cell-not-explored";for(let t=0;t<this.cellRenderArray.length;t++){const s=this.cellRenderArray[t];if(e.hasProp(s)){const t=e.getProp(s),a=this.cellStyles[s],n=t[0];return this.getPropClassOrChar(a,n)}}const t=e.getBaseElem().getType();return this.cellStyles.elements[t]},getPropClassOrChar:function(e,t){let s=null;if(t.getName?(s=t.getName(),e.hasOwnProperty(s)||(s=t.getType())):s=t.getType(),e.hasOwnProperty(s)){if("object"==typeof e[s]){for(const a in e[s])if("default"!==a){const n=t[a]();if(!0===n)return e[s][a];if(!1!==n)return n}return e[s].default}return e[s]}return e.default},getCellChar:function(e){if(!e.isExplored())return"X";for(let t=0;t<this.cellRenderArray.length;t++)if(e.hasProp(this.cellRenderArray[t])){const s=e.getProp(this.cellRenderArray[t]),a=this.charStyles[this.cellRenderArray[t]],n=s[0];return this.getPropClassOrChar(a,n)}const t=e.getBaseElem().getType();return this.charStyles.elements[t]},addCellStyle:function(e,t,s){this.cellStyles.hasOwnProperty(e)?this.cellStyles[e][t]=s:this.err("RG","addCellStyle","Unknown prop type: "+e)},removeCellStyle:function(e,t){this.cellStyles.hasOwnProperty(e)&&delete this.cellStyles[e][t]},addCharStyle:function(e,t,s){this.charStyles.hasOwnProperty(e)?this.charStyles[e][t]=s:this.err("RG","addCharStyle","Unknown prop type: "+e)},removeCharStyle:function(e,t){this.charStyles.hasOwnProperty(e)&&delete this.charStyles[e][t]},getChar:function(e,t,s=null){return this.charStyles.hasOwnProperty(e)?s?this.charStyles[e][t][s]:this.charStyles[e][t]:"X"},getCssClass:function(e,t,s=null){if(this.cellStyles.hasOwnProperty(e)){if(s)return this.cellStyles[e][t][s];if(this.cellStyles[e].hasOwnProperty(t))return this.cellStyles[e][t]}return""},charStyles:{elements:{default:".",exit:".",exploration:"?",lever:"&",leverdoor:{isClosed:"+",default:"/"},marker:{getChar:"",default:"X"},passage:".",placeholder:"?",shop:".",stairsDown:">",stairsUp:"<",wall:"#",wallcave:"#",wallcrypt:"#",wallice:"#",wallwooden:"#",wallmount:"^",door:{isClosed:"+",default:"/"}},actors:{default:"X"},items:{default:"?",corpse:"§"}},cellStyles:{elements:{default:"cell-element-default",door:"cell-element-door",exit:"cell-element-exit",exploration:"cell-element-exploration",marker:{getClassName:"",default:"cell-element-marker"},lever:"cell-element-door",leverdoor:"cell-element-door",passage:"cell-element-passage",placeholder:"cell-element-placeholder",shop:"cell-element-shop",stairsDown:"cell-element-stairs",stairsUp:"cell-element-stairs",wall:"cell-element-wall",wallcave:"cell-element-wall-cave",wallcrypt:"cell-element-wall-crypt",wallice:"cell-element-wall-ice",wallwooden:"cell-element-wall-wooden",wallmount:"cell-element-wall-mount"},actors:{default:"cell-actor-default",player:"cell-actor-player",spirit:"cell-actor-spirit"},items:{potion:"cell-item-potion",spiritgem:"cell-item-spiritgem",default:"cell-item-default"}},debug:function(e,t){0},err:function(e,t,s){if(!a.suppressErrorMessages){const a=`[ERROR]: ${e} ${t} -> |${s}|`;throw console.error(a),new Error(a)}},warn:function(e,t,s){if(!a.suppressWarningMessages){const a=`[WARN]: ${e} ${t} -> |${s}|`;console.error(a)}},diag:function(e){if(!a.suppressDiagnosticMessages){const t=(new Error).stack.split("at ");if(t.length>3){const e=t[3].trim();console.info(e)}console.info(e)}},log:function(...e){a.suppressLogs||console.log("[INFO]:",...e)},assertType:function(e,t){e.getType?e.getType()!==t&&a.err("RG","assertType",`Exp: ${t}, Got: ${e.getType()}`):a.err("RG","assertType",`object ${e} has no getType()`)},extend2:function(e,t){a.isNullOrUndef([e])&&a.err("RG","extend2",`Child not defined. Parent: ${t}`),a.isNullOrUndef([t])&&a.err("RG","extend2",`Parent not defined. Child: ${e}`);const s=t.prototype,n=e.prototype;for(const e in s)n.hasOwnProperty(e)||(n[e]=s[e]);if(n.hasOwnProperty("uber")){const e=[n.uber];e.push(s),n.uber=e}else n.uber=[],n.uber.push(s)},nullOrUndefError:function(e,t,s){if(this.isNullOrUndef([s])){const s=`nullOrUndef ${e} ${t}`;throw console.error(s),new Error(s)}},isNullOrUndef:function(e){for(let t=0;t<e.length;t++)if(null===e[t]||void 0===e[t]||void 0===e)return!0;return!1},addStackedItems:function(e,t){if(e.equals(t)){const s=t.getCount();return e.incrCount(s),!0}return!1},removeStackedItems:function(e,t){if(t>0){let s=null;return 1===t&&1===e.getCount()?e:t<e.getCount()?(e.decrCount(t),(s=e.clone()).setCount(t),s):e}return null},getItemDamage:function(e){if(e.rollDamage)return e.rollDamage();{const t=e.getWeight();return Math.ceil(t/1.1)}},getMeleeAttack:function(e){let t=e.getAttack();const s=e.getInvEq().getMissile(),a=e.getInvEq().getMissileWeapon();return s&&(t-=s.getAttack()),a&&(t-=a.getAttack()),t},getMeleeAttackRange:function(e){const t=e.get("Combat").getAttackRange(),s=e.getWeapon();if(s&&s.getAttackRange){const e=s.getAttackRange();return e>t?e:t}return t},getMeleeDamageAdded:function(e){let t=e.getCombatBonus("getDamage");return t+=a.strengthToDamage(e.getStrength())},getMeleeAttackInfo:function(e){let t="Att: "+a.getMeleeAttack(e);const s=e.getWeapon();return s&&s.getDamageDie?t+=" D: "+s.getDamageDie().toString():t+=" D: "+e.get("Combat").getDamageDie().toString(),t+=" + "+a.getMeleeDamageAdded(e)},getMissileAgilityDmg:function(e){return Math.round(e/3)},getMissileDamageAdded:function(e,t){let s=a.getMissileAgilityDmg(e.get("Stats").getAgility());return t.has("Ammo")&&(s+=e.getMissileWeapon().rollDamage()),e.has("StrongShot")&&(s+=this.strengthToDamage(e.getStrength())),s},getMissileDamage:function(e,t){let s=t.rollDamage();return s+=a.getMissileDamageAdded(e,t)},getMissileAttack:function(e){let t=e.get("Combat").getAttack();t+=e.getInvEq().getEquipment().getAttack(),t+=e.get("Stats").getAccuracy()/2,t+=e.getInvEq().getEquipment().getAccuracy()/2;const s=e.getWeapon();return s&&s.getAttack&&(t-=s.getAttack()),t},getMissileAttackInfo:function(e){const t=e.getMissileWeapon(),s=e.getInvEq().getMissile();if(!s)return"No missile equipped";let n="Att: "+a.getMissileAttack(e);if(n+=" D: "+s.getDamageDie().toString(),t){n+=" + "+t.getDamageDie().toString()+" (wpn)"}return n+=" + "+a.getMissileDamageAdded(e,s),n+=" R: "+a.getMissileRange(e,s)},getMissileRange:function(e,t){let s=t.getAttackRange();if(t.has("Ammo")){const t=e.getMissileWeapon();if(!t)return 0;s+=t.getAttackRange()}return e.has("LongRangeShot")&&(s*=2),e.has("EagleEye")&&(s+=2),e.has("Skills")&&(t.has("Ammo")?s+=e.get("Skills").getLevel("Archery"):s+=e.get("Skills").getLevel("Throwing")),s},strengthToDamage:function(e){return Math.round(e/4)},accuracyToAttack:function(e){return Math.floor(e/2)},agilityToDefense:function(e){return Math.floor(e/2)},findEnemyCellForActor:function(e,t){const s=[];return t.filter(e=>e.hasActors()).forEach(t=>{const a=t.getActors();let n=!1;for(let t=0;t<a.length;t++)e!==a[t]&&"function"==typeof a[t].isEnemy&&a[t].isEnemy(e)&&(n=!0);n&&s.push(t)}),s},PLAYER_FOV_RANGE:10,NPC_FOV_RANGE:5,ACTION_DUR:100,BASE_SPEED:100,DEFAULT_HP:50,MAX_ACTIVE_LEVELS:3,EVT_ACTOR_CREATED:"EVT_ACTOR_CREATED",EVT_ACTOR_KILLED:"EVT_ACTOR_KILLED",EVT_DESTROY_ITEM:"EVT_DESTROY_ITEM",EVT_MSG:"EVT_MSG",EVT_LEVEL_CHANGED:"EVT_LEVEL_CHANGED",EVT_LEVEL_ENTERED:"EVT_LEVEL_ENTERED",EVT_TILE_CHANGED:"EVT_TILE_CHANGED",EVT_EXPLORED_ZONE_LEFT:"EVT_EXPLORED_ZONE_LEFT",EVT_LEVEL_PROP_ADDED:"EVT_LEVEL_PROP_ADDED",EVT_LEVEL_PROP_REMOVED:"EVT_LEVEL_PROP_REMOVED",EVT_ACT_COMP_ADDED:"EVT_ACT_COMP_ADDED",EVT_ACT_COMP_REMOVED:"EVT_ACT_COMP_REMOVED",EVT_ACT_COMP_ENABLED:"EVT_ACT_COMP_ENABLED",EVT_ACT_COMP_DISABLED:"EVT_ACT_COMP_DISABLED",EVT_WIN_COND_TRUE:"EVT_WIN_COND_TRUE",EVT_ANIMATION:"EVT_ANIMATION",EVT_CREATE_BATTLE:"EVT_CREATE_BATTLE",EVT_BATTLE_OVER:"EVT_BATTLE_OVER",EVT_ARMY_EVENT:"EVT_ARMY_EVENT",EVT_ITEM_PICKED_UP:"EVT_ITEM_PICKED_UP",EVT_ACTOR_DAMAGED:"EVT_ACTOR_DAMAGED",EVT_ACTOR_ATTACKED:"EVT_ACTOR_ATTACKED",EVT_ACTOR_USED_STAIRS:"EVT_ACTOR_USED_STAIRS",EVT_WEATHER_CHANGED:"EVT_WEATHER_CHANGED",EVT_DAY_PHASE_CHANGED:"EVT_DAY_PHASE_CHANGED",EVT_DAY_CHANGED:"EVT_DAY_CHANGED",EVT_MONTH_CHANGED:"EVT_MONTH_CHANGED",EVT_SEASON_CHANGED:"EVT_SEASON_CHANGED",EVT_YEAR_CHANGED:"EVT_YEAR_CHANGED",TYPE_ACTOR:"actors",TYPE_ELEM:"elements",TYPE_ITEM:"items",ITEM:{}};a.ITEM.BASE="base",a.ITEM.FOOD="food",a.ITEM.BOOK="book",a.ITEM.CORPSE="corpse",a.ITEM.WEAPON="weapon",a.ITEM.ARMOUR="armour",a.ITEM.SPIRITGEM="spiritgem",a.ITEM.GOLD="gold",a.ITEM.MINERAL="mineral",a.ITEM.MISSILE="missile",a.ITEM.MISSILE_WEAPON="missileweapon",a.ITEM.AMMUNITION="ammo",a.ITEM.POTION="potion",a.ITEM.RUNE="rune",a.ITEM.GOLD_COIN="goldcoin",a.SHOP_TYPES=["ammo","armour","food","mineral","missile","missileweapon","potion","rune","spiritgem","weapon"],a.USE={DRINK:"DRINK",DIG:"DIG",LEVER:"LEVER"},a.LEVEL_ID_ADD=1e9,a.ENTITY_ID_ADD=1e9,a.WATCHDOG=100,a.NO_TARGET=-1,a.LEVEL_EMPTY="empty",a.LEVEL_FOREST="forest",a.LEVEL_MOUNTAIN="mountain",a.energy={ATTACK:15,DEFAULT:5,JUMP:50,MISSILE:10,MOVE:10,PICKUP:5,REST:5,RUN:20,USE:5,SPELL:10},a.BIAS={ALWAYS:10,NOT_POSSIBLE:-10,Explore:.2,Flee:.2,Guard:1.1,Order:.7,Patrol:1},a.FMODE_NORMAL=0,a.FMODE_FAST=1,a.FMODE_SLOW=2,a.PROT_BYPASS_CHANCE=.05,a.MISSILE_CRITICAL_SHOT=.1,a.DANGER_ADJ_FACTOR=1.4,a.DAMAGE_ADJ_FACTOR=2,a.PLAYER_HP_REGEN_PERIOD=40,a.PLAYER_PP_REGEN_PERIOD=40,a.MIN_VALUE=30,a.TRAINER_PROB=.2,a.EPIC_PROB=.05,a.GOLD_COIN_WEIGHT=.03,a.GOLD_COIN_NAME="Gold coin",a.HUNGER_PROB=.1,a.HUNGER_DMG=1,a.ALIGN_GOOD="ALIGN_GOOD",a.ALIGN_EVIL="ALIGN_EVIL",a.ALIGN_NEUTRAL="ALIGN_NEUTRAL",a.EVIL_RACES=["catfolk","dogfolk","wolfclan","wildling","undead","goblin"],a.NEUTRAL_RACES=["dwarf","bearfolk","animal"],a.ACTOR_RACES=["catfolk","dogfolk","wolfclan","wildling","goblin","bearfolk","dwarf","human","hyrkhian"],a.ACTOR_RACES=a.ACTOR_RACES.sort(),a.ALL_RACES=["avianfolk"].concat(a.ACTOR_RACES),a.CARDINAL_DIR=Object.freeze(["north","south","east","west"]),a.CARDINAL_DIR_ABBR=Object.freeze(["N","S","E","W"]),a.DIR={N:[0,-1],S:[0,1],E:[1,0],W:[-1,0],NE:[1,-1],SE:[1,1],NW:[-1,-1],SW:[-1,1]},a.DIR_NSEW=[a.DIR.N,a.DIR.S,a.DIR.E,a.DIR.W],a.DIR_DIAG=[a.DIR.NE,a.DIR.SE,a.DIR.NW,a.DIR.SW],a.SEASON={AUTUMN:"AUTUMN",AUTUMN_WINTER:"AUTUMN_WINTER",WINTER:"WINTER",WINTER_SPRING:"WINTER_SPRING",SPRING:"SPRING",SPRING_SUMMER:"SPRING_SUMMER",SUMMER:"SUMMER",SUMMER_AUTUMN:"SUMMER_AUTUMN"},a.DAY={DAWN:"DAWN",MORNING:"MORNING",NOON:"NOON",AFTERNOON:"AFTERNOON",EVENING:"EVENING",DUSK:"DUSK",NIGHT:"NIGHT"},a.dirTodXdY=function(e){if(Array.isArray(e))return e;if(a.DIR.hasOwnProperty(e)){const t=e.toUpperCase();return a.DIR[t]}return a.err("RG","dirTodXdY",`Arg must be array/string (N,S,E,W..). Got: ${e}`),null},a.dXdYToDir=function(e){const[t,s]=e;let a="";return 1===s?a+="S":-1===s&&(a+="N"),1===t?a+="E":-1===t&&(a+="W"),a},a.dirToChar=function(e){const[t,s]=e;return 0!==t?0===s?"-":1===t&&1===s?"\\":-1===t&&1===s?"/":-1===t&&-1===s?"\\":"/":"|"},a.DMG={ACID:"ACID",BLUNT:"BLUNT",COLD:"COLD",ENERGY:"ENERGY",FIRE:"FIRE",HUNGER:"HUNGER",ICE:"ICE",LIGHTNING:"LIGHTNING",MAGIC:"MAGIC",MELEE:"MELEE",MISSILE:"MISSILE",NECRO:"NECRO",PIERCE:"PIERCE",POISON:"POISON",SLASH:"SLASH",SLIME:"SLIME",VOID:"VOID",WATER:"WATER"},a.classNameDMG={ACID:"cell-damage-ACID",BLUNT:"cell-damage-BLUNT",COLD:"cell-damage-COLD",ENERGY:"cell-damage-ENERGY",FIRE:"cell-damage-FIRE",HUNGER:"cell-damage-HUNGER",ICE:"cell-damage-ICE",LIGHTNING:"cell-damage-LIGHTNING",MAGIC:"cell-damage-MAGIC",MELEE:"cell-damage-MELEE",MISSILE:"cell-damage-MISSILE",NECRO:"cell-damage-NECRO",PIERCE:"cell-damage-PIERCE",POISON:"cell-damage-POISON",SLASH:"cell-damage-SLASH",WATER:"cell-damage-WATER",VOID:"cell-damage-VOID"},a.STATS=["Accuracy","Agility","Magic","Perception","Strength","Willpower"],a.STATS_LC=a.STATS.map(e=>e.toLowerCase()),a.LEVEL_NOT_LOADED="LEVEL_NOT_LOADED",a.TILE_NOT_LOADED="TILE_NOT_LOADED",a.STATS_ABBR=a.STATS.map(e=>e.substr(0,3)),a.GET_STATS=a.STATS.map(e=>"get"+e),a.SET_STATS=a.STATS.map(e=>"set"+e),a.getDmgClassName=function(e){return a.classNameDMG[e]},a.key2Num=function(e){const[t,s]=e.split(",");return[parseInt(t,10),parseInt(s,10)]},a.isEmpty=(e=>!!a.isNullOrUndef([e])||("string"==typeof e?""===e:!!Array.isArray(e)&&0===e.length)),a.getName=(e=>{if(e.getName)return e.getName();if(e.getParent){return e.getParent().getName()}return""}),a.getObjRefArray=((e,t)=>{const s=t.map(t=>a.getObjRef(e,t));return s.$objRefArray=!0,s}),a.getObjRef=((e,t)=>{if("entity"===e){if(a.isItem(t)){const e=" Got: |"+t.getName()+"|";a.err("RG","getObjRef","objRefs to items not supported."+e)}return{$objRef:{type:e,id:t.getID()}}}if("object"===e){if(t.$objID)return t.getObjRef();if(t.$objRef)return{$objRef:{type:"object",id:t.$objRef}}}else{if("component"===e)return{$objRef:{type:"component",id:t.getID()}};if("place"===e)return{$objRef:{type:"place",id:t.getID()}};if("item"===e)return{$objRef:{type:"item",id:t.getID()}};if("element"===e)return{$objRef:{type:"element",id:t.getID()}}}return a.err("RG","getObjRef",`Type ${e} not supported. Obj: ${t}`),null}),a.getForestConf=function(e,t){const s=e/a.LEVEL_MEDIUM_X*(t/a.LEVEL_MEDIUM_Y);return{ratio:.5,nForests:Math.floor(30*s),forestSize:100}},a.cellRenderArray=a.cellRenderVisible,a.PROP_TYPES=[a.TYPE_ACTOR,a.TYPE_ELEM,a.TYPE_ITEM],a.FMODES=[a.FMODE_NORMAL,a.FMODE_FAST,a.FMODE_SLOW],a.ALIGNMENTS=[a.ALIGN_GOOD,a.ALIGN_NEUTRAL,a.ALIGN_EVIL],a.cellRenderArray=a.cellRenderVisible,a.getDangerProb=((e,t)=>{if(e>t)return console.error("RG.getDangerProb param order is min < max"),console.error(`\tGot min: ${e}, max: ${t}`),{};const s=t+1,n=[];for(let t=e;t<=s;t++)n.push(t);const r=n[n.length-1],o=r%2==0?r/2:(r+1)/2,i={};return n.forEach(e=>{const t=Math.abs(e-o);let s=r-Math.floor(a.DANGER_ADJ_FACTOR*t);s=0===s?s+1:s,i[e]=s}),i}),a.getMaxDanger=((e,t)=>{let s=2*t+e;return s<2&&(s=2),s}),a.getMaxValue=((e,t)=>{let s=20*t+10*e;return s<=a.MIN_VALUE&&(s=a.MIN_VALUE),s}),a.getFoodWeightDistr=(()=>({.1:20,.2:10,.3:5,.4:3,.5:1})),a.getGoldCoinCountDistr=(e=>{const t=e+1,s={};for(let a=1;a<=t;a++)s[a]=e;return s}),a.getRuneChargeDistr=(()=>({0:2,1:10,2:30,3:10,4:5,5:2})),a.valueToGoldWeight=(e=>{let t=e,s=1;for(;t>=100;)t-=100,++s;return(s*e+10)/200}),a.scaleItemValue=((e,t,s)=>{const a=s.getValue();let n=1;switch(e){case"combat":n*=1+.1*t;break;case"stats":n*=1+.2*t;break;default:n=1}const r=Math.floor(a*n);s.setValue(r)}),a.hasEnoughGold=((e,t)=>{const s=a.getGoldInCoins(t),n=e.getInvEq().getInventory().getItems();for(let e=0;e<n.length;e++)if("goldcoin"===n[e].getType()&&n[e].getCount()>=s)return!0;return!1}),a.removeNCoins=((e,t)=>{let s=0;const a=e.getInvEq().getInventory().getItems();let n=null;for(let e=0;e<a.length;e++)"goldcoin"===a[e].getType()&&(a[e].getCount()>t?(s=t,a[e].decrCount(t)):(s=(n=a[e]).getCount(),n.setCount(0)));return null!==n&&e.getInvEq().removeItem(n),s}),a.getItemStat=((e,t)=>{if(!t)return 0;let s=0;if("function"==typeof t[e]&&(s+=t[e]()),t.has("Stats")){const a=t.get("Stats");"function"==typeof a[e]&&(s+=a[e]())}if(t.has("GemBound")){const a=t.get("GemBound").getGem();"function"==typeof a[e]&&(s+=a[e]())}return s}),a.getExpRequired=(e=>{let t=0;for(let s=1;s<=e;s++)t+=10*(s-1);return t}),a.newXYFromDir=((e,t)=>{let[s,a]=[0,0];return Array.isArray(t)?[s,a]=t:t.getX&&([s,a]=t.getXY()),[s+e[0],a+e[1]]}),a.dXdY=((e,t)=>{let[s,a,n,r]=[0,0,0,0];return Array.isArray(e)?(s=e[0],a=e[1]):e.getX&&(s=e.getX(),a=e.getY()),Array.isArray(t)?(n=t[0],r=t[1]):t.getX&&(n=t.getX(),r=t.getY()),[s-n,a-r]}),a.dXdYAbs=((e,t)=>{const[s,n]=a.dXdY(e,t);return[Math.abs(s),Math.abs(n)]}),a.dXdYUnit=((e,t)=>{const[s,n]=a.dXdY(e,t);return[0===s?0:s/Math.abs(s),0===n?0:n/Math.abs(n)]}),a.withinRange=((e,t,s)=>{const[n,r]=a.dXdYAbs(t,s);return n<=e&&r<=e}),a.levelUpActor=((e,t)=>{if(e.has("Experience")){let s=e.get("Experience").getExpLevel();if(s<t)for(;s<t;){const t=s+1;if(++s,e.get("Experience").setExpLevel(t),e.has("ActorClass"))e.get("ActorClass").getClass().advanceLevel();else if(a.levelUpStats(e,t),a.levelUpCombatStats(e,t),e.has("Health")){const t=e.get("Health");let s=2;e.isPlayer()&&(s=5),t.setMaxHP(t.getMaxHP()+s),t.setHP(t.getHP()+s)}}else{let e=`Curr: ${s}, New: ${t}`;e+=" New level must be > current level.",a.err("RG","levelUpActor",e)}}else a.err("RG","levelUpActor","No exp. component found.")}),a.levelUpStats=function(e,t){const s=n.Random.getRNG().arrayGetRand(a.STATS_LC);e.get("Stats").incrStat(s,1)},a.levelUpCombatStats=function(e,t){if(e.has("Combat")){const s=e.get("Combat"),a=1;s.setAttack(s.getAttack()+a);const n=1;if(s.setDefense(s.getDefense()+n),t%3==0){const e=s.getProtection();s.setProtection(e+1)}const r=s.getDamageDie();r.setDice(r.getDice()+1),t%3==0&&r.setMod(r.getMod()+1)}},a.printObj=function(e,t,s){const n=(e,t)=>{"object"==typeof e?(a.diag("\t## "+t,s),a.diag(e,s)):a.diag("\t## "+t+" -> "+e,s)};if(t){if(Array.isArray(t))t.forEach(s=>{if("function"==typeof e[s]){const t=e[s]();n(t,s)}else{const s=JSON.stringify(e);a.err("RG","printObj",`No func ${t} in object ${s}`)}});else if("string"==typeof t)if("function"==typeof e[t]){const s=e[t]();n(s,t)}else a.err("RG","printObj",`No func ${t} in object ${JSON.stringify(e)}`)}else a.diag(e,s)},a.printObjList=function(e,t,s){const n=e.length;console.log(`List has ${n} objects`),e.forEach((e,n)=>{"function"==typeof s?s(e)&&(console.log(`Object [${n}]: `),a.printObj(e,t)):(console.log(`Object [${n}]: `),a.printObj(e,t))})},a.getUseCmd=function(e,t){return{cmd:"use",item:e,target:t}},a.getDropCmd=function(e,t){return{cmd:"drop",item:e,count:t}},a.getEquipCmd=function(e,t){return{cmd:"equip",item:e,count:t}},a.getUnequipCmd=function(e,t,s){return{cmd:"unequip",slot:e,slotNumber:t,count:s}},a.ONE_SHOT_ITEMS=["potion"],a.isOneShotItem=(e=>{const t=e.getType();return a.ONE_SHOT_ITEMS.indexOf(t)>=0}),a.isActor=(e=>!(!e||!e.getPropType)&&e.getPropType()===a.TYPE_ACTOR),a.isElement=(e=>!(!e||!e.getPropType)&&e.getPropType()===a.TYPE_ELEM),a.isItem=(e=>!(!e||!e.getPropType)&&e.getPropType()===a.TYPE_ITEM),a.isEntity=(e=>!!(e.comps&&e.compsByType&&e.add&&e.get)),a.isActorActive=(e=>e&&!e.has("Dead")),a.getItemUseType=((e,t)=>{let s=t;switch(t.target&&(s=t.target).getActors&&s.hasActors()&&(s=s.getActors()[0]),e.getType()){case"potion":if(a.isActor(s))return a.USE.DRINK;break;default:return""}return""}),a.getGoldInCoins=(e=>Math.round(e/a.GOLD_COIN_WEIGHT)),a.BLOCK_X=20,a.BLOCK_Y=7,a.LEVEL_SMALL_X=3*a.BLOCK_X,a.LEVEL_SMALL_Y=3*a.BLOCK_Y,a.LEVEL_MEDIUM_X=4*a.BLOCK_X,a.LEVEL_MEDIUM_Y=4*a.BLOCK_Y,a.LEVEL_LARGE_X=5*a.BLOCK_X,a.LEVEL_LARGE_Y=5*a.BLOCK_Y,a.LEVEL_HUGE_X=7*a.BLOCK_X,a.LEVEL_HUGE_Y=7*a.BLOCK_Y,a.LOOT_SPARSE_SQR=200,a.LOOT_MEDIUM_SQR=120,a.LOOT_ABUNDANT_SQR=50,a.ACTOR_SPARSE_SQR=200,a.ACTOR_MEDIUM_SQR=120,a.ACTOR_ABUNDANT_SQR=50,a.WEAKNESS={},a.WEAKNESS.MINOR=1,a.WEAKNESS.MEDIUM=3,a.WEAKNESS.SEVERE=7,a.WEAKNESS.FATAL=10,a.RESISTANCE={},a.RESISTANCE.MINOR=1,a.RESISTANCE.MEDIUM=3,a.RESISTANCE.STRONG=6,a.RESISTANCE.IMMUNITY=10,a.RESISTANCE.ABSORB=15,a.SYS={},a.SYS.ANIMATION=Symbol("ANIMATION"),a.SYS.AREA_EFFECTS=Symbol("AREA_EFFECTS"),a.SYS.ATTACK=Symbol("ATTACK"),a.SYS.BATTLE=Symbol("BATTLE"),a.SYS.BASE_ACTION=Symbol("BASE_ACTION"),a.SYS.CHAT=Symbol("CHAT"),a.SYS.COMMUNICATION=Symbol("COMMUNICATION"),a.SYS.DAMAGE=Symbol("DAMAGE"),a.SYS.DISABILITY=Symbol("DISABILITY"),a.SYS.EQUIP=Symbol("EQUIP"),a.SYS.EVENTS=Symbol("EVENTS"),a.SYS.EXP_POINTS=Symbol("EXP_POINTS"),a.SYS.HUNGER=Symbol("HUNGER"),a.SYS.MISSILE=Symbol("MISSILE"),a.SYS.MOVEMENT=Symbol("MOVEMENT"),a.SYS.QUEST=Symbol("QUEST"),a.SYS.SHOP=Symbol("SHOP"),a.SYS.SKILLS=Symbol("SKILLS"),a.SYS.SPELL_CAST=Symbol("SPELL_CAST"),a.SYS.SPELL_EFFECT=Symbol("SPELL_EFFECT"),a.SYS.SPIRIT=Symbol("SPIRIT"),a.SYS.TIME_EFFECTS=Symbol("TIME_EFFECTS"),a.SYS.WEATHER=Symbol("WEATHER"),a.NO_DAMAGE_SRC=null,a.getCardinalDirection=((e,t)=>{const s=e.getMap().cols,a=e.getMap().rows,n=t.getX(),r=t.getY();return 0===r?"north":r===a-1?"south":n===s-1?"east":0===n?"west":"somewhere"}),a.getTextualDir=((e,t,s=10)=>{let n="";const[r,o]=a.dXdY(e,t),i=r/10,l=o/10;return l>0?n+="south":l<0&&(n+="north"),i>0?n+=" east":i<0&&(n+="west"),""===n&&(n="nearby from here"),n}),a.printMap=(e=>{let t=null;if(Array.isArray(e)?t=a.colsToRows(e):Array.isArray(e._map)&&(t=a.colsToRows(e._map)),t){const e=t.length;for(let s=0;s<e;s++)console.log(t[s].join(""))}}),a.forEach2D=((e,t)=>{for(let s=0;s<e.length;s++)for(let a=0;a<e[s].length;a++)t(s,a,e[s][a])}),a.map2D=((e,t)=>{const s=[];return a.forEach2D(e,(e,a,n)=>{s.push(t(e,a,n))}),s}),a.copy2D=(e=>{const t=new Array(e.length);for(let s=0;s<e.length;s++){t[s]=new Array(e[s].length);for(let a=0;a<e[s].length;a++)t[s][a]=e[s][a]}return t}),a.colsToRows=(e=>{const t=[],s=e[0].length,a=e.length;for(let n=0;n<s;n++){t[n]=[];for(let s=0;s<a;s++)t[n][s]=e[s][n]}return t}),a.flattenTo2D=(e=>{const t=e.length,s=[];for(let n=0;n<t;n++){let t=e[n];t=a(t),s.push(t)}function a(e){let t=[];return e.forEach(e=>{Array.isArray(e)?t=t.concat(a(e)):t.push(e)}),t}return s}),a.uniquifyCoord=(e=>{const t={},s=[];for(let a=0;a<e.length;a++){const[n,r]=e[a],o=n+","+r;t[o]||(t[o]=!0,s.push(e[a]))}return s}),a.setAllExplored=((e,t)=>{const s=e.getMap();for(let e=0;e<s.cols;e++)for(let a=0;a<s.rows;a++){s._map[e][a].setExplored(t)}}),a.inSameLevel=((e,t)=>e.getLevel().getID()===t.getLevel().getID()),a.getImpassableMsg=((e,t,s)=>{return`${s} ${`cannot venture beyond ${t.getBaseElem().getType()}`}`}),a.formatLocationName=(e=>{const t=e.getParent();if(!t)return"";switch(t.getType()){case"branch":case"face":case"quarter":{const e=t.getParent(),s=t.getName(),a=e.getName();return s===a?s:`${a}`}default:return t.getName()}});const n=s(1);a.isSuccess=function(e){return n.Random.getRNG().getUniform()<=e},a.ent=function(e){if(window.PLAYER){const t=window.PLAYER.getLevel();if(Number.isInteger(e)){const s=t.getActors().find(t=>t.getID()===e);if(s){const t=s.getName();return a.diag(`RG.ent: Found ${t} with ID ${e}`),a.diag(JSON.stringify(s)),s}const n=t.getItems().find(t=>t.getID()===e);if(n){const t=n.getName();return a.diag(`RG.ent: Item Found ${t} with ID ${e}`),a.diag(JSON.stringify(n)),n}}}return null},a.comp=function(e,t=-1){let s=null;if(t>=0&&(s=a.ent(t)),s){const t=s.getComponents();if(t[e]){const s=t[e],n=s.getType();console.log(`RG.comp: Found ${n} with ID ${e}`);const r=s.toJSON();return r?a.diag(JSON.stringify(r)):(a.diag("Not serialisable"),a.diag(s)),s}}return null},a.while=function(e,t,s=-1){let a=s;for(;e();)if(t(),0==--a)return!1;return!0};const r=s(7).EventPool.getPool();a.gameMsg=function(e){this.emitMsgEvent("prim",e)},a.gameInfo=function(e){this.emitMsgEvent("info",e)},a.gameDescr=function(e){this.emitMsgEvent("descr",e)},a.gameSuccess=function(e){this.emitMsgEvent("success",e)},a.gameWarn=function(e){this.emitMsgEvent("warn",e)},a.gameDanger=function(e){this.emitMsgEvent("danger",e)},a.emitMsgEvent=function(e,t){let s="";if("object"==typeof t){const a=t,n={cell:a.cell,msg:s=(s=a.msg)[0].toUpperCase()+s.substring(1),style:e};r.emitEvent(this.EVT_MSG,n)}else s=t[0].toUpperCase()+t.substring(1),r.emitEvent(this.EVT_MSG,{msg:s,style:e})},a.destroyItemIfNeeded=(e=>{if(a.isOneShotItem(e))if(1===e.getCount()){const t={item:e};r.emitEvent(a.EVT_DESTROY_ITEM,t)}else e.decrCount(1)}),t.default=a},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=a(s(12)),o=[-1,0,1],i=[-1,1];class l{static setRNG(e){l.instance=e}static getRNG(){return l.instance||(l.instance=new l(666)),l.instance}static reseed(e){r.default.RNG.setSeed(e),l.getRNG().setSeed(e)}constructor(e=0){this.seed=e,this.rng=r.default.RNG.clone(),this.rng.setSeed(this.seed)}setSeed(e){console.log("Setting RNG seed to "+e),this.seed=e,this.rng.setSeed(e)}setState(e){this.rng.setState(e)}randProp(e){const t=Object.keys(e);return e[t[this.randIndex(t)]]}arrayGetRand(e){return e[this.randIndex(e)]}getUniqueItems(e,t=2){if(e.length<=t)return e.slice();const s={},a=[];for(;a.length<t;){const t=this.randIndex(e);s[t]||(s[t]=!0,a.push(e[t]))}return a}getUniformInt(e,t){return this.rng.getUniformInt(e,t)}randIndex(e){return Math.floor(this.rng.getUniform()*e.length)}getUniform(){return this.rng.getUniform()}getUniformRange(e,t){return e+(t-e)*this.getUniform()}getNormal(e,t){return this.rng.getNormal(e,t)}getWeighted(e){return this.rng.getWeightedValue(e)}getWeightedLinear(e){const t={};for(let s=0;s<e;s++)t[s]=s+1;return this.rng.getWeightedValue(t)}toJSON(){return{seed:this.seed,state:this.rng.getState()}}getRandDir(){const e=this.arrayGetRand(o);let t=this.arrayGetRand(o);return 0===e&&(t=this.arrayGetRand(i)),[e,t]}getCardinalDir(){return this.arrayGetRand(n.default.CARDINAL_DIR)}getCardinalDirLetter(){return this.arrayGetRand(n.default.CARDINAL_DIR_ABBR)}getRandInBbox(e){const{ulx:t,uly:s,lrx:a,lry:n}=e;return[this.getUniformInt(t,a),this.getUniformInt(s,n)]}shuffle(e){if(e.length<=1)return e;let t,s=e.length-1,a=0;for(;0!==s;)a=this.getUniformInt(0,s),t=e[s-=1],e[s]=e[a],e[a]=t;return e}}t.Random=l},function(e,t,s){"use strict";function a(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}Object.defineProperty(t,"__esModule",{value:!0});const n=s(18);a(s(18)),a(s(13));const r=s(68);a(s(68));const o=s(73);a(s(73)),n.Component.MindControl=r.MindControl,n.Component.Abilities=o.Abilities},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(1).Random.getRNG();function o(e){e.forEach(t=>{if(!Number.isInteger(t)){const t=JSON.stringify(e);n.default.err("Geometry","verifyInt","Value not an Int. Arr: "+t)}})}t.Geometry={getBoxAround(e,t,s,a=!1){o([e,t]);const n=[];for(let a=e-s;a<=e+s;a++)for(let r=t-s;r<=t+s;r++)a===e&&r===t||n.push([a,r]);return a&&n.push([e,t]),n},getCrossAround(e,t,s,a=!1){o([e,t,s]);const n=[];for(let a=e-s;a<=e+s;a++)for(let r=t-s;r<=t+s;r++)a!==e&&r!==t||a===e&&r===t||n.push([a,r]);return a&&n.push([e,t]),n},getDiagCross(e,t,s,a=!1){o([e,t,s]);const n=[];for(let a=e-s;a<=e+s;a++)for(let r=t-s;r<=t+s;r++){const s=r-t;0!==a-e&&0!==s&&n.push([a,r])}return a&&n.push([e,t]),n},getCrossCaveConn(e,t,s,a=!1){o([e,t,s]);const n=[];for(let a=e-s;a<=e+s;a++)for(let r=t-s;r<=t+s;r++)a!==e&&r!==t||a===e&&r===t||n.push([a,r]);return a&&n.push([e,t]),n},getBox(e,t,s,a){o([e,t,s,a]);const n=[];for(let r=e;r<=s;r++)for(let e=t;e<=a;e++)n.push([r,e]);return n},convertBbox:e=>e.hasOwnProperty("llx")?{ulx:e.llx,uly:e.ury,lrx:e.urx,lry:e.lly}:e,getCoordBbox(e){const{ulx:t,uly:s,lrx:a,lry:n}=e;return this.getBox(t,s,a,n)},getBorderForBbox(e){const{ulx:t,uly:s,lrx:a,lry:n}=e;return this.getHollowBox(t,s,a,n)},getCellsInBbox(e,t){const s=this.getCoordBbox(t),a=[];return s.forEach(t=>{a.push(e[t[0]][t[1]])}),a},isInBbox(e,t,s){const{ulx:a,uly:n,lrx:r,lry:o}=s;return e>=a&&e<=r&&t>=n&&t<=o},isValidBbox(e){if(!e)return!1;const{ulx:t,uly:s,lrx:a,lry:r}=e;return!n.default.isNullOrUndef([t,s,a,r])},dirToBbox(e,t,s){const a=Math.round(e/3),r=Math.round(t/3),o=a,i=r,l=2*a-1,c=2*r-1,h=n.default.dirTodXdY(s);return h?{ulx:o+h[0]*a,uly:i+h[1]*r,lrx:l+h[0]*a,lry:c+h[1]*r}:(n.default.err("Geometry","dirToBbox",`Invalid dir ${s} given.`),null)},getBoxCornersForCells(e,t){const[s,a]=[e.getX(),e.getY()],[n,r]=[t.getX(),t.getY()];return{ulx:s<=n?s:n,uly:a<=r?a:r,lrx:n>s?n:s,lry:r>a?r:a}},getHollowBox(e,t,s,a){o([e,t,s,a]);const n=[];for(let r=e;r<=s;r++)for(let o=t;o<=a;o++)o!==t&&o!==a&&r!==e&&r!==s||n.push([r,o]);return n},getHollowDiamond(e,t,s){o([e,t,s]);const a=e+2*s,n=e+s,r=t+s,i=t-s,l=[[e,t]],c={N:[n,r],S:[n,i],E:[a,t],W:[e,t],coord:[]};for(let s=e+1;s<=n;s++){for(let e=t+1;e<=r;e++)l.push([s,e]);for(let e=t-1;e>=i;e--)l.push([s,e])}for(let e=n+1;e<=a;e++){for(let s=t+1;s<=r;s++)l.push([e,s]);for(let s=t-1;s>=i;s--)l.push([e,s])}return c.coord=l,c},isCorner:(e,t,s,a,n,r)=>(e===s||e===n)&&(t===a||t===r),removeMatching(e,t){let s=0;return Array.isArray(e)?t.forEach(t=>{const a=e.findIndex(e=>e[0]===t[0]&&e[1]===t[1]);a>=0&&(e.splice(a,1),++s)}):t.forEach(t=>{const a=t[0]+","+t[1];e.hasOwnProperty(a)&&(delete e[a],++s)}),s},tileLevels(e,t,s){const{x:a,y:n}=s;let r=a,o=n;if(s.alignLeft)t.forEach(t=>{this.mergeLevels(e,t,r,o),o+=t.getMap().rows});else if(s.centerX){const s=Math.round(e.getMap().cols/2);t.forEach(t=>{r=s-Math.round(t.getMap().cols/2),this.mergeLevels(e,t,r,o),o+=t.getMap().rows})}else if(s.centerY){const s=Math.round(e.getMap().rows/2);t.forEach(t=>{o=s-Math.round(t.getMap().rows/2),this.mergeLevels(e,t,r,o),r+=t.getMap().cols})}},mergeLevels(e,t,s,a){const r=e.getMap(),o=t.getMap(),i=e.getActors().length+t.getActors().length,l=t.getActors().slice(),c=t.getItems().slice(),h=t.getElements().slice(),u=(0===l.length&&0===c.length&&h.length,e=>[e.getX()+s,e.getY()+a]);l.forEach(s=>{const[a,n]=u(s);r.hasXY(a,n)&&t.removeActor(s)&&e.addActor(s,a,n)}),c.forEach(s=>{const[a,n]=[s.getX(),s.getY()],[o,i]=u(s);r.hasXY(o,i)&&t.removeItem(s,a,n)&&e.addItem(s,o,i)}),h.forEach(s=>{const[a,n]=[s.getX(),s.getY()],[o,i]=u(s);r.hasXY(o,i)&&t.removeElement(s,a,n)&&e.addElement(s,o,i)}),this.mergeMapBaseElems(r,o,s,a);const d=e.getActors().length;d!==i&&n.default.err("Geometry","mergeLevels",`Num actors new: ${d}, exp: ${i}`)},mergeMapBaseElems(e,t,s,a){if(e.cols<t.cols){const s=`m1: ${e.cols} m2: ${t.cols}`;n.default.err("Geometry","mergeMapBaseElems","Cols: m2 cols must be smaller/equal: "+s)}if(e.rows<t.rows){const s=`m1: ${e.rows} m2: ${t.rows}`;n.default.err("Geometry","mergeMapBaseElems","Rows: m2 rows must be smaller/equal: "+s)}const r=s+t.cols-1,o=a+t.rows-1;for(let n=s;n<=r;n++)for(let r=a;r<=o;r++)if(e.hasXY(n,r)){const o=t.getCell(n-s,r-a);e._map[n][r].setBaseElem(o.getBaseElem())}},mergeMapCellsUnsafe(e,t,s,a){const r=s+t.cols-1,o=a+t.rows-1;for(let i=s;i<=r;i++)for(let r=a;r<=o;r++)if(e.hasXY(i,r)){const o=t.getCell(i-s,r-a);o||n.default.err("Geometry","mergeMapCellsUnsafe",`Null cell: ${s},${a}, [${i}][${r}]`),e.moveCellUnsafe(i,r,o)}},mergeMaps(e,t,s,a,n=((e,t)=>!0)){const r=s+t.cols-1,o=a+t.rows-1;for(let i=s;i<=r;i++)for(let r=a;r<=o;r++)if(e.hasXY(i,r)){const o=t.getCell(i-s,r-a),l=e._map[i][r];n(l,o)&&l.setBaseElem(o.getBaseElem())}},iterateMapWithBBox(e,t,s){for(let a=t.ulx;a<=t.lrx;a++)for(let n=t.uly;n<=t.lry;n++)e.hasXY(a,n)&&s(a,n)},insertEntity(e,t,s,a){switch(t){case n.default.TYPE_ACTOR:this.insertActors(e,t,s,a);break;case n.default.TYPE_ITEM:this.insertItems(e,t,s,a);break;case n.default.TYPE_ELEM:this.insertElements(e,t,s);break;default:n.default.err("Geometry","insertEntity",`No type ${t} supported`)}},insertElements(e,t,s){const a=e.getMap();this.iterateMapWithBBox(a,s,(e,s)=>{const r=n.default.FACT.createElement(t);t.match(/(wall|floor)/)?a._map[e][s].setBaseElem(r):a._map[e][s].setProp("elements",r)})},insertActors(e,t,s,a){const r=e.getMap();this.iterateMapWithBBox(r,s,(s,o)=>{if(r.getCell(s,o).isFree()){const r=a.createActualObj(n.default.TYPE_ACTOR,t);e.addActor(r,s,o)}})},insertItems(e,t,s,a){const r=e.getMap();this.iterateMapWithBBox(r,s,(s,o)=>{if(r.getCell(s,o).isFree()){const r=a.createActualObj(n.default.TYPE_ITEM,t);e.addItem(r,s,o)}})},getFreeArea(e,t,s,a){let n=!1;const o=e.slice(),i={};for(e.forEach(e=>{i[e[0]+","+e[1]]=e});!n&&o.length>0;){const e=r.getUniformInt(0,o.length-1),l=o[e][0],c=o[e][1];let h=!0;for(let e=l;e<l+t;e++)for(let t=c;t<c+s;t++)i[e+","+t]?a.push([e,t]):h=!1;(n=h)||(a=[],o.splice(e))}return n},isLine:(e,t,s,a)=>e===s||t===a||Math.abs(s-e)===Math.abs(a-t),xyInLine(e){for(let t=1;t<e.length;t++){const[s,a]=[e[t],e[t-1]],[n,r]=s,[o,i]=a;if(!this.isLine(n,r,o,i))return!1}return!0},sameXOrY(e){for(let t=1;t<e.length;t++){const[s,a]=[e[t],e[t-1]],[n,r]=s,[o,i]=a;if(n!==o&&r!==i)return!1}return!0},getStraightLine(e,t,s,a,n=!0){if(this.isLine(e,t,s,a)){const r=[],o=s===e?0:(s-e)/Math.abs(s-e),i=a===t?0:(a-t)/Math.abs(a-t);for(n&&r.push([e,t]);e!==s||t!==a;)e!==s&&(e+=o),t!==a&&(t+=i),e===s&&t===a?n&&r.push([e,t]):r.push([e,t]);return r}return[]},getBresenham(e,t,s,a){let[n,r,o,i]=[0,0,0,0],[l,c,h,u]=[0,0,0,0],[d,g]=[0,0];const p=[];if((n=s-e)<0&&(n=-n),(r=a-t)<0&&(r=-r),l=1,s<e&&(l=-1),c=1,a<t&&(c=-1),d=e,g=t,p.push([d,g]),n>r)for(i=2*r-n,h=2*(r-n),u=2*r,o=0;o<n;o++)i>=0?(g+=c,i+=h):i+=u,d+=l,p.push([d,g]);else for(i=2*n-r,h=2*(n-r),u=2*n,o=0;o<r;o++)i>=0?(d+=l,i+=h):i+=u,g+=c,p.push([d,g]);return p},getMissilePath(e,t,s,a,n=!0){let r=[];if(this.isLine(e,t,s,a))r=this.getStraightLine(e,t,s,a,n);else{n&&r.push([e,t]);const o=s-e,i=a-t,l=Math.abs(o),c=Math.abs(i),h=o/l,u=i/c;let d=l,g=c,p=e,m=t;if(l>c){for(;g>=0&&d%g!=0;)p+=h,m+=u,r.push([p,m]),d-=1,g-=1;if(0===g)for(;p!==s;)p+=h,r.push([p,m]);else{const e=d/g;for(;p!==s&&m!==a;){m!==a&&(m+=u);for(let t=0;t<e;t++)p!==s&&(p+=h,r.push([p,m]))}}}else if(c>l){for(;d>=0&&g%d!=0;)p+=h,m+=u,r.push([p,m]),d-=1,g-=1;if(0===d)for(;m!==a;)m+=u,r.push([p,m]);else{const e=g/d;for(;p!==s&&m!==a;){p!==s&&(p+=h);for(let t=0;t<e;t++)m!==a&&(m+=u,r.push([p,m]))}}}}return r}},t.Geometry.floodfill=function(e,t,s,a=!1){let n=s;if("string"==typeof s&&(n=(e=>e.getBaseElem().getType()===s)),!n(t))return[];let r=t;const o=[],i=[t],l={};l[t.getKeyXY()]=!0;const c=function(t,s){if(e.hasXY(t,s)&&!l[t+","+s]){const a=e.getCell(t,s);n(a)&&(l[a.getKeyXY()]=!0,i.push(a),o.push(a))}};for(;r;){const[e,t]=r.getXY(),s=e-1;c(s,t);const n=e+1;c(n,t);const i=t-1;c(e,i);const l=t+1;c(e,l),a&&(c(s,i),c(n,i),c(s,l),c(n,l)),r=o.shift()}return i},t.Geometry.floodfill2D=function(e,t,s,a=!1,n=!1){const[r,o]=t;if(e[r][o]!==s)return[];let i=t;const l=[],c=[i],h={};h[r+","+o]=!0;const u=function(t,n){if(t>=0&&t<e.length&&n>=0&&n<e[0].length&&!h[t+","+n]){e[t][n]===s&&(h[t+","+n]=!0,c.push([t,n]),a&&(a[t+","+n]=!0),l.push([t,n]))}};for(;i;){const[e,t]=i,s=e-1;u(s,t);const a=e+1;u(a,t);const r=t-1;u(e,r);const o=t+1;u(e,o),n&&(u(s,r),u(a,r),u(s,o),u(a,o)),i=l.shift()}return c},t.Geometry.getMassCenter=function(e){let t=0,s=0;for(let a=0;a<e.length;a++)t+=e[a][0],s+=e[a][1];return[Math.round(t/e.length),Math.round(s/e.length)]},t.Geometry.squareFill=function(e,t,s,a){const[r,o]=t.getXY(),[i,l]=a;0!==i&&0!==l||n.default.err("Geometry","squareFill",`dx,dy must be -1 or 1. Got ${a}`);let c=!1,h=[t],u=t;for(;!c;){const t=[],[a,n]=u.getXY(),[d,g]=[a+i,n+l];if(e.hasXY(d,g)){const a=e.getCell(d,g);if(a.getBaseElem().getType()!==s){c=!0;break}t.push(a);let n=d;do{n+=-i;const a=e.getCell(n,g);if(a.getBaseElem().getType()!==s){c=!0;break}t.push(a)}while(n!==r);let p=g;do{p+=-l;const a=e.getCell(d,p);if(a.getBaseElem().getType()!==s){c=!0;break}t.push(a)}while(p!==o);c||(h=h.concat(t)),u=a}}return h},t.Geometry.histArrayVals=function(e){const t={};return e.forEach(e=>{t[e]?t[e]+=1:t[e]=1}),t},t.Geometry.tesselateLine=function(e,s,a,n,o,i){const l=Math.abs(e-a),c=Math.abs(s-n),h=e<a?e:a,u=e>a?e:a,d=s<n?s:n,g=s>n?s:n;if(l>=o&&c>=o){const l=r.getUniformInt(h,u),c=r.getUniformInt(d,g);t.Geometry.tesselateLine(e,s,l,c,o,i),t.Geometry.tesselateLine(l,c,a,n,o,i)}else{t.Geometry.getBresenham(e,s,a,n).forEach(e=>{i.push(e)})}},t.Geometry.getCaveConnLine=function(e,s,a,n,o){let i=[];const l=[];t.Geometry.tesselateLine(e,s,a,n,4,l);let c=t.Geometry.getCrossCaveConn;return o&&"function"==typeof o.brush&&(c=o.brush),l.forEach(e=>{const[t,s]=e,a=r.getUniformInt(1,3),n=c(t,s,a,!0);i=i.concat(n)}),i}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=n(s(2)),i=s(7),l=s(1),c=s(8)("bitn:System"),h=i.EventPool.getPool();t.SystemBase=class{static addSkillsExp(e,t,s=1){if(e.has("Skills")){const a=new o.SkillsExp;a.setSkill(t),a.setPoints(s),e.add(a)}}static addCompToEntAfterHit(e,t,s){const a=e.clone();if(a.hasOwnProperty("duration")){const e=a.rollDuration(),s=new o.Expiration;s.addEffect(a,e),t.add(s)}if(a.getSource){const e=a.getSource();r.default.isNullOrUndef([e])&&a.setSource(s)}t.add(a)}constructor(e,t,s){Array.isArray(t)||r.default.err("System.Base","new","2nd arg must be an array of component types"),this.type=e,this.compTypes=t,this.entities={},this.compTypesAny=!1,this.hasNotify=!0;for(let e=0;e<this.compTypes.length;e++)o.hasOwnProperty(this.compTypes[e])||r.default.err("System.Base","new",`Comp type ${this.compTypes[e]} not in Component`),s?s.listenEvent(this.compTypes[e],this):h.listenEvent(this.compTypes[e],this);this.debugEnabled=c.enabled,this.rng=l.Random.getRNG()}setRNG(e){this.rng=e}addEntity(e){this.entities[e.getID()]=e}removeEntity(e){delete this.entities[e.getID()]}notify(e,t){t.hasOwnProperty("add")?this.hasCompTypes(t.entity)&&this.addEntity(t.entity):t.hasOwnProperty("remove")&&(this.hasCompTypes(t.entity)||this.removeEntity(t.entity))}hasCompTypes(e){const t=this.compTypes;return!1===this.compTypesAny?e.hasAll(t):e.hasAny(t)}hasEntities(){return Object.keys(this.entities).length>0}update(){for(const e in this.entities)e&&this.updateEntity(this.entities[e])}updateEntity(e){r.default.err("SystemBase","updateEntity","Not implemented in the base class")}dbg(e){if(c.enabled){const t=Object.keys(this.entities).length;let s=`[System ${this.type.toString()}]`;c(`${s+=` nEntities: ${t}`} ${e}`)}}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(23),i=n(s(48)),l=n(s(13)),c=s(18);t.Element={};const h=/wall/,u=/(?:highrock|water|chasm|wall)/;t.Element.canJumpOver=(e=>!(h.test(e)||/highrock/.test(e)));class d extends(i.Typed(o.Entity)){constructor(e,t){let s=null,a=null;"object"==typeof e?(s=e.name,a=e.type):(s=e,a=t),a=a||s,super({propType:r.default.TYPE_ELEM,type:a}),r.default.elementsCreated+=1,this._name=s,this.msg={}}getName(){return this._name}setName(e){this._name=e}isWall(){return h.test(this.getType())}isObstacle(){return u.test(this.getType())}isPassable(){return!this.has("Impassable")}isPassableByAir(){return!this.has("Impassable")||this.get("Impassable").canFlyOver}isSpellPassable(){return!this.has("Impassable")||this.get("Impassable").spellPasses}lightPasses(){return!this.has("Opaque")}setMsg(e){this.msg=e}getMsg(e){return this.msg[e]}hasMsg(e){return this.msg.hasOwnProperty(e)}onSystemAdd(e){}onSystemRemove(e){}toJSON(){const e=c.compsToJSON(this),t={id:this.getID(),name:this.getName(),type:this.getType(),msg:this.msg};return e&&(t.components=e),t}}t.ElementBase=d,t.Element.Base=d,r.default.elementsCreated=0;class g extends d{constructor(e){super(e),this.add(new l.Opaque);const t=new l.Impassable;t.setAllImpassable(),this.add(t)}}t.ElementWall=g,t.Element.Wall=g;class p extends(i.Locatable(d)){constructor(e,t,s){super({name:e,type:"connection"}),this._srcLevel=t,this._targetLevel=s,this._targetStairs=null}isConnected(){return!r.default.isNullOrUndef([this._srcLevel,this._targetLevel,this._targetLevel])}setSrcLevel(e){r.default.isNullOrUndef([e])?r.default.err("Element.Stairs","setSrcLevel","Cannot set null/undefined level"):this._srcLevel=e}getSrcLevel(){return this._srcLevel}setTargetLevel(e){r.default.isNullOrUndef([e])?r.default.err("Element.Stairs","setTargetLevel","Cannot set null/undefined level."):this._targetLevel=e}getTargetLevel(){return this._targetLevel}setTargetStairs(e){if(r.default.isNullOrUndef([e]))r.default.err("Element.Stairs","setTargetStairs","Cannot set null/undefined stairs.");else{this._targetStairs=e;const t=e.getSrcLevel();r.default.isNullOrUndef([t])||this.setTargetLevel(t)}}getTargetStairs(){return this._targetStairs}getID(){const e=this.getX(),t=this.getY();return`${this._srcLevel.getID()},${e},${t}`}connect(e,t=0){Array.isArray(e)?(e.forEach(e=>{e.setTargetStairs(this),e.setTargetLevel(this.getSrcLevel())}),this.setTargetStairs(e[t]),this.setTargetLevel(e[t].getSrcLevel())):(this.setTargetStairs(e),e.setTargetStairs(this),this.setTargetLevel(e.getSrcLevel()),e.setTargetLevel(this.getSrcLevel()))}isDown(){return/stairsDown/.test(this.getName())}useStairs(e){if(!r.default.isNullOrUndef([this._targetStairs,this._targetLevel]))if(this._targetStairs instanceof p){const t=this._targetStairs.getX(),s=this._targetStairs.getY();if(this._srcLevel.removeActor(e)&&this._targetLevel.addActor(e,t,s))return!0}else r.default.err("ElementStairs","useStairs","Tried to use stairs without proper targetStairs");return!1}setConnObj(e){this._targetStairs=e.targetStairs,this._targetLevel=e.targetLevel}getConnObj(){const e=this.getTargetStairs();if(e instanceof p){const t=this.getTargetLevel();return{targetStairs:{x:e.getX(),y:e.getY()},targetLevel:t.getID()}}return{targetStairs:{x:e.x,y:e.y},targetLevel:this.getTargetLevel()}}toJSON(){const e={name:this.getName(),type:this.getType()};this._srcLevel&&(e.srcLevel=this.getSrcLevel().getID()),Number.isInteger(this._targetLevel)?e.targetLevel=this._targetLevel:this._targetLevel&&(e.targetLevel=this.getTargetLevel().getID());const t=this.getTargetStairs();return t&&(e.targetStairs=t instanceof p?{x:t.getX(),y:t.getY()}:t),e}}t.ElementStairs=p,t.Element.Stairs=p;class m extends(i.Locatable(d)){constructor(e){super("door"),this._closed=void 0===e||e,this._opaque=new l.Opaque;const t=new l.Impassable;t.setAllImpassable(),this._impassable=t,this._closed&&this.closeDoor()}canToggle(){return!0}isOpen(){return!this._closed}isClosed(){return this._closed}openDoor(){this._closed=!1,this.remove("Opaque"),this.remove("Impassable")}closeDoor(){this._closed=!0,this.add(this._opaque),this.add(this._impassable)}toJSON(){const e=super.toJSON();return e.closed=this._closed,e}}t.ElementDoor=m,t.Element.Door=m;class f extends m{constructor(e=!0){super(e),this.setType("leverdoor")}canToggle(){return!1}onUse(){this.isOpen()?this.closeDoor():this.openDoor()}toJSON(){const e=super.toJSON();return e.type="leverdoor",e}}t.ElementLeverDoor=f,t.Element.LeverDoor=f;class y extends(i.Locatable(d)){constructor(){super("lever"),this._targets=[]}getTargets(){return this._targets}addTarget(e){this._targets.push(e)}onUse(e){this._targets.forEach(t=>{t.onUse&&t.onUse(e)})}toJSON(){return{id:this.getID(),type:"lever",addTarget:this._targets.map(e=>r.default.getObjRef("entity",e))}}}t.ElementLever=y,t.Element.Lever=y;class _ extends(i.Locatable(d)){constructor(){super("shop"),this._shopkeeper=null,this._costFactorShopSells=1,this._costFactorShopBuys=.5,this._isAbandoned=!0}isAbandoned(){return this._isAbandoned}reclaim(e){this._shopkeeper=e,this._isAbandoned=!1}getItemPriceForBuying(e){if(e.has("Unpaid")){const t=e.getValue(),s=r.default.valueToGoldWeight(t);let a=r.default.getGoldInCoins(s);return a*=e.getCount(),0===(a=Math.ceil(this._costFactorShopSells*a))?1:a}return r.default.err("Element.Shop","getItemPriceForBuying","Item "+e.getName()+" is not Unpaid item"),0}getItemPriceForSelling(e,t){const s=e.getValue(),a=r.default.valueToGoldWeight(s);let n=r.default.getGoldInCoins(a);return n*=t||e.getCount(),n=Math.floor(this._costFactorShopBuys*n)}abandonShop(){this._shopkeeper=null,this._isAbandoned=!0}setShopkeeper(e){r.default.isNullOrUndef([e])?r.default.err("Element.Shop","setShopkeeper","Shopkeeper must be non-null and defined."):(this._shopkeeper=e,this._isAbandoned=!1)}getShopkeeper(){return this._shopkeeper}setCostFactor(e,t){r.default.isNullOrUndef([e,t])?r.default.err("Element.Shop","setCostFactor","Args buy/sell must be non-null and defined!"):(this._costFactorShopSells=t,this._costFactorShopBuys=e)}getCostFactorSell(){return this._costFactorShopSells}getCostFactorBuy(){return this._costFactorShopBuys}toJSON(){let e=null;this._shopkeeper&&(e=this._shopkeeper.getID());const t={type:"shop",isAbandoned:this._isAbandoned,costFactorSell:this._costFactorShopSells,costFactorBuy:this._costFactorShopBuys};return null!==e&&(t.shopkeeper=e),t}}t.ElementShop=_,t.Element.Shop=_;class E extends(i.Locatable(d)){constructor(){super("exploration"),this.exp=0}setData(e){this.data=e}addData(e,t){this.data[e]=t}getData(){return this.data}hasData(){return!!this.data}setExp(e){Number.isInteger(e)?this.exp=e:r.default.err("ElementExploration","setExp",`exp is not an integer: ${e}`)}getExp(){return this.exp}toJSON(){const e={type:this.getType(),setExp:this.getExp()};return this.hasData()&&(e.data=this.data),e}}t.ElementExploration=E,t.Element.Exploration=E;class S extends(i.Locatable(d)){constructor(e){super(e)}onSystemAdd(e){e.getSentientActors().forEach(e=>{e.add(new l.Entrapped)})}onSystemRemove(e){e.getSentientActors().forEach(e=>{e.remove("Entrapped")})}}t.ElementTrap=S;class v extends S{constructor(){super("web");const e=new l.Entrapping;e.setDestroyOnMove(!0),e.setDifficulty(20),this.add(e)}setDifficulty(e){this.get("Entrapping").setDifficulty(e)}}t.ElementWeb=v,t.Element.Web=v;class C extends S{constructor(){super("slime");const e=new l.Entrapping;e.setDestroyOnMove(!0),e.setDifficulty(30),this.add(e)}setDifficulty(e){this.get("Entrapping").setDifficulty(e)}}t.ElementSlime=C,t.Element.Slime=C;class b extends S{constructor(){super("hole");const e=new l.Entrapping;e.setDestroyOnMove(!1),e.setDifficulty(50),this.add(e)}setDifficulty(e){this.get("Entrapping").setDifficulty(e)}}t.ElementHole=b,t.Element.Hole=b;class T extends(i.Locatable(d)){constructor(){super("placeholder")}}t.ElementPlaceholder=T,t.Element.PlaceHolder=T;class A extends(i.Locatable(d)){constructor(e){super("marker"),this.char=e,this.tag="",this.className=!1}getClassName(){return this.className}setClassName(e){this.className=e}getChar(){return this.char}setChar(e){this.char=e}setTag(e){this.tag=e}getTag(){return this.tag}toJSON(){const e=super.toJSON();return e.char=this.char,e.tag=this.tag,e}}t.ElementMarker=A,t.Element.Marker=A,t.create=function(e,...s){e.capitalize();return t.Element.hasOwnProperty(e)?new t.Element[e](...s):null},t.Element.create=t.create},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(119),i=s(34),l=n(s(31)),c=n(s(19)),h=s(123),u=s(10),d=s(1),g=s(5),p=n(s(2)),m=s(16),f=s(70),y=s(124),_=d.Random.getRNG();t.ObjectShell={},t.Creator=function(e,t){this._db=e,this._dbNoRandom=t;const s={actors:{type:"setType",attack:{comp:"Combat",func:"setAttack"},defense:{comp:"Combat",func:"setDefense"},damage:{comp:"Combat",func:"setDamageDie"},speed:{comp:"Stats",func:"setSpeed"},strength:{comp:"Stats",func:"setStrength"},accuracy:{comp:"Stats",func:"setAccuracy"},agility:{comp:"Stats",func:"setAgility"},willpower:{comp:"Stats",func:"setWillpower"},perception:{comp:"Stats",func:"setPerception"},magic:{comp:"Stats",func:"setMagic"},fovrange:{comp:"Perception",func:"setFOVRange"},pp:{comp:"SpellPower",func:["setPP","setMaxPP"]},maxPP:{comp:"SpellPower",func:"setMaxPP"},hp:{comp:"Health",func:["setHP","setMaxHP"]},danger:{comp:"Experience",func:"setDanger"},brain:{func:"setBrain",factory:this.createBrain}},items:{type:"setType",value:"setValue",weight:{comp:"Physical",func:"setWeight"},damageType:"setDamageType",armour:{attack:"setAttack",defense:"setDefense",protection:"setProtection",armourType:"setArmourType"},weapon:{damage:"setDamageDie",attack:"setAttack",defense:"setDefense",weaponType:"setWeaponType",range:"setAttackRange"},missile:{damage:"setDamageDie",attack:"setAttack",range:"setAttackRange"},food:{energy:"setEnergy"}},elements:{type:"setType",msg:"setMsg"}};s.items.missileweapon=s.items.weapon,s.items.missileweapon.fireRate="setFireRate",s.items.ammo=s.items.missile,s.items.ammo.ammoType="setAmmoType",this.get=((e,t)=>this._dbNoRandom[e][t]?this._dbNoRandom[e][t]:this._db[e][t]),this.createComponent=((e,t)=>{switch(e){case"Combat":return new p.Combat;case"Experience":return new p.Experience;case"Health":return new p.Health(t);case"Stats":return new p.Stats;default:if(p.hasOwnProperty(e))return new p[e];r.default.err("Creator","createComponent","Component |"+e+"| does not exist.")}return null}),this.createActualObj=function(e,t){const a=this.get(e,t),n=s[e];a||r.default.err("Creator","createActualObj",`shell for ${t} is not found.`);const o=this.createNewObject(e,a);o||r.default.err("ObjectShell.creator","createActualObj",`Failed to create obj with ${JSON.stringify(a)}`),a.hasOwnProperty("addComp")&&this.addComponents(a,o);for(const e in a)if(n.hasOwnProperty(e)){const t=n[e];if("object"==typeof t){if(t.hasOwnProperty("comp"))this.addCompToObj(o,t,a[e]);else if(t.hasOwnProperty("factory")){if("brain"===e){const s=t.factory(o,a[e]);o[t.func](s)}}else for(const s in t)if(t.hasOwnProperty(s)){const n=t[s];o.hasOwnProperty(n)&&o[n](a[e])}}else o[t](a[e])}else if(a.hasOwnProperty("type")&&n.hasOwnProperty(a.type)){const t=n[a.type];if(t.hasOwnProperty(e)){const s=t[e];if("object"==typeof s){for(const t in s)if(s.hasOwnProperty(t)){const n=s[t];o.hasOwnProperty(n)&&o[s[t]](a[e])}}else o[s](a[e])}}return a.hasOwnProperty("use")&&this.addUseEffects(a,o),a.hasOwnProperty("equip")&&this.addEquippedItems(a,o),a.hasOwnProperty("inv")&&this.addInventoryItems(a,o),a.hasOwnProperty("loot")&&this.addLootComponents(a,o),a.hasOwnProperty("poison")&&this.addPoison(a,o),a.hasOwnProperty("enemies")&&this.addEnemies(a,o),a.hasOwnProperty("spells")&&this.addSpellbookAndSpells(a,o),a.hasOwnProperty("onHit")&&this.addOnHitProperties(a,o),a.hasOwnProperty("onAttackHit")&&this.addOnAttackHitProperties(a,o),a.hasOwnProperty("onEquip")&&this.addOnEquipProperties(a,o),o},this.addPoison=((e,t)=>{const s=e.poison,a=new p.Poison;a.setProb(s.prob),a.setSource(t),a.setDamageDie(m.Dice.create(s.damage));const n=m.Dice.create(s.duration);a.setDurationDie(n);const r=new p.AddOnHit;r.setComp(a),t.add(r)}),this.addOnHitProperties=((e,t)=>{e.onHit.forEach(e=>{this.processAddComp(e,t)})}),this.addOnAttackHitProperties=((e,t)=>{e.onAttackHit.forEach(e=>{const s=this.processAddComp(e,t);s.setOnDamage(!1),s.setOnAttackHit(!0)})}),this.addOnEquipProperties=((e,t)=>{e.onEquip.forEach(e=>{this.processAddComp(e,t,!0)})}),this.processAddComp=((e,t,s=!1)=>{if(e.addComp){const a=this.createComponent(e.addComp);a.setSource&&r.default.isActor(t)&&a.setSource(t),Array.isArray(e.func)&&e.func.forEach(e=>{if("function"==typeof a[e.setter])a[e.setter](e.value);else{const t=a.toJSON();r.default.err("ObjectShellParser","addOnHitProperties",`Not a func: ${e.setter} in comp ${t}`)}});const n=a;let o=null;if(o=s?new p.AddOnEquip:new p.AddOnHit,e.duration){const t=m.Dice.create(e.duration),s=new p.Duration;s.setDurationDie(t),s.setComp(n),o.setComp(s)}else o.setComp(n);return t.add(o),o}return null}),this.addEnemies=((e,t)=>{e.enemies.forEach(e=>{t.getBrain().addEnemyType(e)})}),this.addSpellbookAndSpells=((e,t)=>{t.setBook(new f.Spell.SpellBook(t)),e.spells.forEach(e=>{const s=this.getUsedObject(e);if(f.Spell[s])t.getBook().addSpell(new f.Spell[s]);else{const e=`Spell |${s}| does not exist.`;r.default.err("Creator","addSpellbookAndSpells",e)}})}),this.getUsedObject=(e=>"object"==typeof e&&e.random?_.arrayGetRand(e.random):e),this.createNewObject=((e,t)=>{switch(e){case r.default.TYPE_ACTOR:t.type;switch(t.actorType){case"BaseActor":return new l.BaseActor(t.name);default:return new l.SentientActor(t.name)}case r.default.TYPE_ITEM:const s=t.type;switch(s){case"armour":return new c.Armour(t.name);case"book":return new c.Book(t.name);case"food":return new c.Food(t.name);case"gold":return new c.Gold(t.name);case"goldcoin":return new c.GoldCoin(t.name);case"mineral":return new c.Mineral(t.name);case"missile":return new c.Missile(t.name);case"missileweapon":return new c.MissileWeapon(t.name);case"ammo":return new c.Ammo(t.name);case"potion":return new c.Potion(t.name);case"rune":return new c.Rune(t.name);case"spiritgem":return new c.SpiritGem(t.name);case"weapon":return new c.Weapon(t.name);default:{if(s){const e=new c.ItemBase(t.name);return e.setType(t.type),e}const e=`Null/undef type: ${s}, obj: ${JSON.stringify(t)}`;r.default.err("","createNewObject",e)}}break;case r.default.TYPE_ELEM:{const e=t.type||t.name;return new g.ElementBase(t.name,e)}}return null}),this.addCompToObj=function(e,t,s){if(t.hasOwnProperty("func"))if(Array.isArray(t.func))t.func.forEach(a=>{const n=t.comp;if(e.has(n))"function"==typeof e.get(n)[a]?e.get(n)[a](s):this.noFuncError(n,a,t);else{const r=this.createComponent(n);"function"==typeof r[a]?(r[a](s),e.add(r)):this.noFuncError(n,a,t)}});else{const a=t.func,n=t.comp;if(e.has(n)&&"string"==typeof a)e.get(n)[a](s);else{const o=this.createComponent(n);if(e.add(o),"function"==typeof o[a])o[a](s);else if("object"==typeof a){Object.keys(t.func).forEach(s=>{const a={func:s,comp:n},r=t.func[s];this.addCompToObj(e,a,r)})}else r.default.log(JSON.stringify(a)),r.default.err("ObjectShellParser","addCompToObj",`No function ${a} in ${n}`)}}else e.has(t.comp)?r.default.err("ObjectShellParser","xxx","Not implemented"):e.add(this.createComponent(t.comp,s))},this.noFuncError=((e,t,s)=>{const a="compData "+JSON.stringify(s);r.default.err("ObjectShellParser","addCompToObj",`Comp: ${e} no func ${t}, ${a}`)}),this.addComponents=((e,t)=>{if("string"==typeof e.addComp)a(e.addComp,t);else if(Array.isArray(e.addComp))e.addComp.forEach(e=>{let s=e;e.random&&(s=_.arrayGetRand(e.random)),"string"==typeof s?a(s,t):n(t,s)});else if("object"==typeof e.addComp){let s=e.addComp;e.addComp.random&&(s=_.arrayGetRand(e.addComp.random)),n(t,s)}else r.default.err("Creator","addComponents","Giving up. shell.addComp must be string, array or object.")});const a=(e,t)=>{try{const s=new p[e];t.add(s)}catch(t){let s=`shell.addComp |${e}|`;s+="Component names are capitalized.",r.default.err("Creator","_addCompFromString",`${t.message} - ${s}`)}},n=(e,t)=>{this.addCompToObj(e,t,null)};this.addInventoryItems=function(e,t){e.inv.forEach(e=>{const s=e.name||e,a=e.count||1,n=this.createActualObj(r.default.TYPE_ITEM,s);n?(n.setCount(a),t.getInvEq().addItem(n)):r.default.err("Creator","addInventoryItems",`itemObj for ${s} is null. Actor: ${t.getName()}`)})},this.addLootComponents=function(e,t){const s=e.loot,a=this.createActualObj(r.default.TYPE_ITEM,s),n=new p.Loot(a);t.add(n)},this.addEquippedItems=function(e,t){const s=e.equip;let a=!1;s.forEach(e=>{const s=e.name||e,n=e.count||1,o=this.createActualObj(r.default.TYPE_ITEM,s);o?(o.setCount(n),t.getInvEq().restoreEquipped(o)||(a=!0)):r.default.err("Creator","addEquippedItems",`itemObj for ${e} is null. Actor: ${t.getName()}`)}),a&&_.shuffle(e.equip)},this.addUseEffects=((e,t)=>{if(t.useFuncs=[],t.useItem=this._db.effects.use.func.bind(t),"object"==typeof e.use&&e.use.hasOwnProperty("length"))for(let s=0;s<e.use.length;s++)o(e,t,e.use[s]);else if("object"==typeof e.use)for(const s in e.use)e.use.hasOwnProperty(s)&&o(e,t,s);else o(e,t,e.use)});const o=(e,t,s)=>{const a=s;if(this._db.effects.hasOwnProperty(a)){const n=this._db.effects[a],o=n.func;if(t.useFuncs.push(o),n.hasOwnProperty("requires"))if(e.use.hasOwnProperty(s)){t.useArgs={};const a=n.requires;if("object"==typeof a)for(let n=0;n<a.length;n++)i(e.use[s],t,a[n]);else i(e.use[s],t,a)}else r.default.err("ObjectParser","addUseEffects","useEffect shell has 'requires'.\n                        Item shell 'use' must be an object.");if(n.hasOwnProperty("optional")){n.optional.forEach(a=>{e.use[s].hasOwnProperty(a)&&(t.useArgs[a]=e.use[s][a])})}}else r.default.err("ObjectParser","addUseEffects","Unknown effect: |"+a+"|")},i=(e,t,s)=>{e.hasOwnProperty(s)?t.useArgs[s]=e[s]:r.default.err("ObjectParser","_verifyAndAddReq",`Req |${s}| not specified in item shell. Item: ${t}`)};this.createFromShell=function(e,t){return t?this.createActualObj(e,t.name):(r.default.err("Creator","createFromShell","obj given must be defined."),null)}},t.ObjectShell.Creator=t.Creator,t.Creator.prototype.createBrain=function(e,t){if(u.Brain[t])return new u.Brain[t](e);const s=`ERROR. No brain type |${t}| found`;r.default.err("Creator","createBrain",s)},t.ProcGen=function(e,t,s){this._db=e,this._dbDanger=t,this._dbByName=s;const a={actorWeights:{}};this.dbGet=(e=>{const t=e.name,s=e.categ,a=e.danger;if(!r.default.isNullOrUndef([t]))return this._dbByName.hasOwnProperty(t)?this._dbByName[t]:[];if(!r.default.isNullOrUndef([a])){if(this._dbDanger.hasOwnProperty(a)){const e=this._dbDanger[a];return void 0!==s?e.hasOwnProperty(s)?e[s]:{}:this._dbDanger[a]}return{}}return!r.default.isNullOrUndef([s])&&this._db.hasOwnProperty(s)?this._db[s]:{}}),this.filterCategWithFunc=function(e,t){const s=this.dbGet({categ:e}),a=[],n=Object.keys(s);for(let e=0;e<n.length;e++){const r=s[n[e]];t(r)&&a.push(r)}return a},this.dbGetRand=function(e){const t=e.danger,s=e.categ;if(void 0!==t&&void 0!==s&&this._dbDanger.hasOwnProperty(t)){const e=this._dbDanger[t][s];return this.getRandFromObj(e)}return null},this.getRandomActor=function(e){if(e.hasOwnProperty("danger")){const t=e.danger,s=this.dbGetRand({danger:t,categ:r.default.TYPE_ACTOR});if(null!==s)return s}else if(e.hasOwnProperty("func")){const t=this.filterCategWithFunc(r.default.TYPE_ACTOR,e.func);return _.arrayGetRand(t)}return null},this.getRandomItem=function(e){if("function"==typeof e){const t=this.filterCategWithFunc(r.default.TYPE_ITEM,e);return _.arrayGetRand(t)}if(e.hasOwnProperty("func")){const t=this.filterCategWithFunc(r.default.TYPE_ITEM,e.func);return _.arrayGetRand(t)}return r.default.err("ProcGen","getRandomItem",`No function with func. obj arg: ${JSON.stringify(e)}`),null},this.getRandomActorWeighted=function(e,t){const s=e+","+t;a.actorWeights.hasOwnProperty(s)||(a.actorWeights[s]=r.default.getDangerProb(e,t));const n=_.getWeighted(a.actorWeights[s]);return this.getRandomActor({danger:n})},this.getRandFromObj=(e=>{const t=Object.keys(e);return e[t[_.randIndex(t)]]})},t.ObjectShell.ProcGen=t.ProcGen,t.Parser=function(){this._base={actors:{},effects:{},items:{},elements:{}},this._db={actors:{},effects:{},items:{},elements:{}},this._dbDanger={},this._dbByName={},this._dbNoRandom={actors:{},items:{},elements:{}},this._creator=new t.Creator(this._db,this._dbNoRandom),this._procgen=new t.ProcGen(this._db,this._dbDanger,this._dbByName),this.getCreator=function(){return this._creator},this.getProcGen=function(){return this._procgen},this.parseShellData=function(e){const t=Object.keys(e);for(let s=0;s<t.length;s++)this.parseShellCateg(t[s],e[t[s]])},this.parseShellCateg=function(e,t){for(let s=0;s<t.length;s++)this.parseObjShell(e,t[s])},this.parseObjShell=function(e,t){if(this.validShellGiven(t)){if(t.hasOwnProperty("base")){("string"==typeof t.base?[t.base]:t.base).forEach(s=>{this.baseExists(e,s)?t=this.extendObj(t,this.getBase(e,s)):r.default.err("ObjectParser","parseObjShell","Unknown base "+s+" specified for "+JSON.stringify(t))})}return e===r.default.TYPE_ACTOR&&this.addTypeIfUntyped(t),this.storeIntoDb(e,t),t}return null},this.validShellGiven=(e=>!!e.hasOwnProperty("name")||(r.default.err("Parser","validShellGiven",`shell doesn't have a name. shell: ${JSON.stringify(e)}`),!1)),this.addTypeIfUntyped=(e=>{e.hasOwnProperty("type")||(e.type=e.name)}),this.get=((e,t)=>this._db[e][t]),this.getBase=((e,t)=>this._base[e][t]),this.storeForUsingAsBase=((e,t)=>{this._base[e][t.name]=t}),this.storeIntoDb=function(e,t){if(this._db.hasOwnProperty(e)){if(this.storeForUsingAsBase(e,t),t.hasOwnProperty("noRandom"))this._dbNoRandom[e][t.name]=t;else if(!t.hasOwnProperty("dontCreate")){if(this._dbByName.hasOwnProperty(t.name))this._dbByName[t.name].push(t);else{const e=[];e.push(t),this._dbByName[t.name]=e}if(this._db[e][t.name]=t,t.hasOwnProperty("danger")){const s=t.danger;this._dbDanger.hasOwnProperty(s)||(this._dbDanger[s]={}),this._dbDanger[s].hasOwnProperty(e)||(this._dbDanger[s][e]={}),this._dbDanger[s][e][t.name]=t}}}else r.default.err("ObjectParser","storeIntoDb","Unknown category: "+e);this.storeRenderingInfo(e,t)},this.storeRenderingInfo=((e,t)=>{if(t.hasOwnProperty("color")){if(r.default.isNullOrUndef([t.color])){const e=JSON.stringify(t);r.default.err("Parser","storeRenderingInfo",`obj.color null/undef! obj: ${e}`)}let{fg:e,bg:s}=t.color;if(t.hasOwnProperty("colorfg")&&(e=t.colorfg),t.hasOwnProperty("colorbg")&&(s=t.colorbg),!e||!s){const e=JSON.stringify(t.color);r.default.err("Parser","storeRenderingInfo",`fg and bg must be given. ${t.name} Got: ${e}`)}t.className||(t.className=""),t.className+=" cell-fg-"+e.toLowerCase()+" cell-bg-"+s.toLowerCase()}t.hasOwnProperty("char")&&(t.hasOwnProperty("name")?(r.default.addCharStyle(e,t.name,t.char),t.dontCreate&&r.default.addCharStyle(e,t.type,t.char)):r.default.addCharStyle(e,t.type,t.char)),t.hasOwnProperty("className")&&(t.hasOwnProperty("name")?(r.default.addCellStyle(e,t.name,t.className),t.dontCreate&&r.default.addCellStyle(e,t.type,t.className)):r.default.addCellStyle(e,t.type,t.className))}),this.baseExists=((e,t)=>!!this._base.hasOwnProperty(e)&&this._base[e].hasOwnProperty(t)),this.extendObj=((e,t)=>{for(const s in t)e.hasOwnProperty(s)||"dontCreate"!==s&&(e[s]=t[s]);return e}),this.createEntity=function(e){return this.hasObj(r.default.TYPE_ITEM,e)?this.createItem(e):this.hasObj(r.default.TYPE_ACTOR,e)?this.createActor(e):null},this.createActor=function(e){return this.createActualObj(r.default.TYPE_ACTOR,e)},this.createItem=function(e){return this.createActualObj(r.default.TYPE_ITEM,e)},this.createElement=function(e){return this.createActualObj(r.default.TYPE_ELEM,e)},this.hasItem=function(e){return this.hasObj(r.default.TYPE_ITEM,e)},this.hasObj=function(e,t){return this.dbExists(e,t)},this.createActualObj=function(e,t){return this.dbExists(e,t)?this._creator.createActualObj(e,t):(r.default.err("Parser","createActualObj",`Categ: ${e} Name: ${t} doesn't exist.`),null)},this.createFromShell=((e,t)=>this._creator.createFromShell(e,t)),this.dbExists=((e,t)=>!(!this._db.hasOwnProperty(e)||!this._db[e].hasOwnProperty(t))||!!this._dbNoRandom[e][t]),this.dbGet=(e=>this._procgen.dbGet(e)),this.dbGetRand=(e=>this._procgen.dbGetRand(e)),this.filter=function(e,t){return this._procgen.filterCategWithFunc(e,t)},this.filterItems=function(e){return this._procgen.filterCategWithFunc(r.default.TYPE_ITEM,e)},this.dbGetNoRandom=(e=>{const t=e.name,s=e.categ,a=e.danger;if(s&&this._dbNoRandom[s]){if(!t)return Object.values(this._dbNoRandom[s]);{const e=this._dbNoRandom[s][t];if(e)return[e]}}else s&&a&&r.default.err("ProcGen","dbGetNoRandom","Query by danger not implemented yet");return[]}),this.createRandomActor=(e=>{const t=this._procgen.getRandomActor(e);return t?this._creator.createFromShell(r.default.TYPE_ACTOR,t):null}),this.createRandomActorWeighted=function(e,t,s){const a=this._procgen.getRandomActorWeighted(e,t);return a?this._creator.createFromShell(r.default.TYPE_ACTOR,a):r.default.isNullOrUndef([s])?null:this.createRandomActor(s)},this.createRandomItem=(e=>{const t=this._procgen.getRandomItem(e);return t?this._creator.createFromShell("items",t):null}),this.toJSON=function(){return{db:this._db}}},t.ObjectShell.Parser=t.Parser,t.createItem=function(e){const s=t.ObjectShell.getParser(),a=s.getCreator();return"string"==typeof e?a.createItem(e):(s.parseObjShell(r.default.TYPE_ITEM,e),a.createFromShell(r.default.TYPE_ITEM,e))},t.getParser=function(){if(!t.ObjectShell.parserInstance){const e=new t.Parser;e.parseShellData(h.Effects);const s=JSON.stringify(o.Objects),a=JSON.parse(s);i.adjustActorValues(a.actors),e.parseShellData(a),t.ObjectShell.parserInstance=e;const n=y.ActorGen.genActors(100);e.parseShellData({actors:n})}return t.ObjectShell.parserInstance},t.ObjectShell.getParser=t.getParser},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0));class r{constructor(){this._listeners={},this._nListeners=0,this._listenerID=0,this._lastEmitted=null,this._lastRemoved=null,this.pendingRemoves=[],this.notifyStackSize=0}static getPool(){return r.poolInstance||(r.poolInstance=new r),r.poolInstance}getNumListeners(){return this._nListeners}getNumEventsListened(){return Object.keys(this._listeners).length}emitEvent(e,t){if(n.default.isNullOrUndef([e]))n.default.nullOrUndefError("EventPool: emitEvent","Event name must be given.",e);else if(++this.notifyStackSize,this._listeners.hasOwnProperty(e)){this.cannotRemove=!0;const s=this._listeners[e];for(let a=0,n=s.length;a<n;a++)s[a].notify(e,t)}1===this.notifyStackSize&&(this.cannotRemove=!1,this.pendingRemoves.length>0&&(this.pendingRemoves.forEach(e=>{this.removeListener(e)}),this.pendingRemoves=[])),--this.notifyStackSize}listenEvent(e,t){if(n.default.isNullOrUndef([e]))n.default.err("EventPool","listenEvent","Event name not well defined.");else if(t.hasOwnProperty("notify")||t.hasNotify){if(this._listeners.hasOwnProperty(e)){-1===this._listeners[e].indexOf(t)&&this._listeners[e].push(t)}else this._listeners[e]=[],this._listeners[e].push(t);++this._nListeners,t.hasOwnProperty("listenerID")||(t.listenerID=this._listenerID++)}else{let s="evtName: "+e;s+="\nprototype: "+JSON.stringify(t),s+="\nCannot add object. Listener must implement notify()!",n.default.err("EventPool","listenEvent",s)}}isListener(e){let t=!1;return this.forEachEvent(e,e=>{t=!0}),t}forEachEvent(e,t){const s=e.listenerID;Object.keys(this._listeners).forEach(a=>{this._listeners[a].findIndex(e=>e.listenerID===s)>=0&&t(e,a)})}removeListener(e){if(e.hasOwnProperty("listenerID")){if(this.cannotRemove)return void this.pendingRemoves.push(e);let t=0;const s=e.listenerID;Object.keys(this._listeners).forEach(e=>{const a=this._listeners[e].findIndex(e=>e.listenerID===s);a>=0&&(this._listeners[e].splice(a,1),++t,--this._nListeners,0===this._listeners[e].length&&delete this._listeners[e])}),0===t&&n.default.warn("EventPool","removeListener",`ListenerID ${e.listenerID} not found`),delete e.listenerID}else{const t=JSON.stringify(e);n.default.err("EventPool","removeListener",`No prop listener ID from on object ${t}`)}}removeAll(){if(this.cannotRemove)n.default.err("EventPool","removeAll","Cannot remove listeners. cannotRemove is set");else{const e={};Object.keys(this._listeners).forEach(t=>{this._listeners[t].forEach(t=>{e[t.listenerID]=t})}),Object.values(e).forEach(e=>{this.removeListener(e)})}}getListeners(e){return this._listeners.hasOwnProperty(e)?this._listeners[e].slice():[]}printListeners(){Object.keys(this._listeners).forEach(e=>{n.default.diag(`Listeners for event ${String(e)}`),n.default.diag(this._listeners[e])})}}r.id=0,t.EventPool=r},function(e,t,s){(function(a){function n(){var e;try{e=t.storage.debug}catch(e){}return!e&&void 0!==a&&"env"in a&&(e=a.env.DEBUG),e}(t=e.exports=s(114)).log=function(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(e){var s=this.useColors;if(e[0]=(s?"%c":"")+this.namespace+(s?" %c":" ")+e[0]+(s?"%c ":" ")+"+"+t.humanize(this.diff),!s)return;var a="color: "+this.color;e.splice(1,0,a,"color: inherit");var n=0,r=0;e[0].replace(/%[a-zA-Z%]/g,function(e){"%%"!==e&&(n++,"%c"===e&&(r=n))}),e.splice(r,0,a)},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=n,t.useColors=function(){if("undefined"!=typeof window&&window.process&&"renderer"===window.process.type)return!0;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],t.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},t.enable(n())}).call(this,s(113))},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=s(6),n=s(5);t.ELEM={};const r=Object.freeze,o=a.ObjectShell.getParser();t.ELEM.BED=r(o.createElement("bed")),t.ELEM.BRIDGE=r(o.createElement("bridge")),t.ELEM.CHASM=r(o.createElement("chasm")),t.ELEM.GRASS=r(o.createElement("grass")),t.ELEM.GRASS_SNOW=r(o.createElement("snowy grass")),t.ELEM.HIGH_ROCK=r(o.createElement("highrock")),t.ELEM.LAVA=r(o.createElement("lava")),t.ELEM.PATH=r(o.createElement("path")),t.ELEM.ROAD=r(o.createElement("road")),t.ELEM.SKY=r(o.createElement("sky")),t.ELEM.SNOW=r(o.createElement("snow")),t.ELEM.SNOW_TRACKS=r(o.createElement("snow with tracks")),t.ELEM.SNOW_DEEP=r(o.createElement("deep snow")),t.ELEM.SNOW_DEEP_TRACKS=r(o.createElement("deep snow with tracks")),t.ELEM.SNOW_LIGHT=r(o.createElement("light snow")),t.ELEM.SNOW_LIGHT_TRACKS=r(o.createElement("light snow with tracks")),t.ELEM.STONE=r(o.createElement("stone")),t.ELEM.TREE=r(o.createElement("tree")),t.ELEM.TREE_SNOW=r(o.createElement("snow-covered tree")),t.ELEM.WINDOW=r(o.createElement("closed window")),t.ELEM.FLOOR=r(o.createElement("floor")),t.ELEM.FLOOR_CASTLE=r(o.createElement("floorcastle")),t.ELEM.FLOOR_CAVE=r(o.createElement("floorcave")),t.ELEM.FLOOR_CRYPT=r(o.createElement("floorcrypt")),t.ELEM.FLOOR_HOUSE=r(o.createElement("floorhouse")),t.ELEM.FLOOR_WOODEN=r(o.createElement("floorwooden")),t.ELEM.WALL=r(new n.ElementWall("wall")),t.ELEM.WALL_CASTLE=r(new n.ElementWall("wallcastle")),t.ELEM.WALL_CAVE=r(new n.ElementWall("wallcave")),t.ELEM.WALL_CRYPT=r(new n.ElementWall("wallcrypt")),t.ELEM.WALL_ICE=r(new n.ElementWall("wallice")),t.ELEM.WALL_WOODEN=r(new n.ElementWall("wallwooden")),t.ELEM.WALL_MOUNT=r(new n.ElementWall("wallmount")),t.ELEM.WATER=r(o.createElement("water")),t.ELEM.WATER_FROZEN=r(o.createElement("frozen water")),t.ELEM.FORT=r(o.createElement("fort")),t.ELEM_MAP={},t.ELEM_MAP.elemTypeToObj={},t.ELEM_MAP.elemTypeToIndex={},t.ELEM_MAP.elemIndexToType={},t.ELEM_MAP.elemIndexToElemObj={};let i=1;Object.keys(t.ELEM).forEach(e=>{const s=t.ELEM[e].getType();t.ELEM_MAP.elemTypeToObj[s]=t.ELEM[e],t.ELEM_MAP.elemTypeToIndex[s]=i,t.ELEM_MAP.elemIndexToType[i]=s,t.ELEM_MAP.elemIndexToElemObj[i]=t.ELEM[e],++i})},function(e,t,s){"use strict";function a(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}var n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0}),a(s(42)),a(s(30));const r=s(30);t.Brain=r.Brain,a(s(51)),a(s(50));const o=s(53);a(s(53));const i=s(33);a(s(33));const l=n(s(71));a(s(71)),r.Brain.Animal=l.BrainAnimal,r.Brain.Commander=l.BrainCommander,r.Brain.Explorer=l.BrainExplorer,r.Brain.GoalOriented=l.BrainGoalOriented,r.Brain.SpellCaster=l.BrainSpellCaster,r.Brain.Spirit=l.BrainSpirit,r.Brain.Thief=l.BrainThief,r.Brain.Flame=l.BrainFlame,r.Brain.Cloud=l.BrainCloud,r.Brain.Virtual=i.BrainVirtual,r.Brain.Weather=o.BrainWeather},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(23),i=s(13),l=s(18),c=s(1),h=s(7),u=s(9),d=n(s(13)),g=h.EventPool.getPool(),{TYPE_ACTOR:p,TYPE_ELEM:m,TYPE_ITEM:f}=r.default,y=c.Random.getRNG();t.LevelCallback=class{constructor(e){this.cbType=e}execute(){r.default.gameMsg(this.msg)}getCbType(){return this.cbType}toJSON(){return{cbType:this.getCbType(),msg:this.msg}}};t.Level=class extends o.Entity{static createLevelID(){return o.Entity.createEntityID()}constructor(){super(),this._map=null,this._parent=null,this._p={actors:[],elements:[],items:[]},this._levelNo=0,this._callbacks={},this._cbState={onFirstEnterDone:!1,onFirstExitDone:!1},this.add(new d.Lore)}setLevelNumber(e){this._levelNo=e}getLevelNumber(){return this._levelNo}getParent(){return this._parent}getParentZone(){const e=this.getParent();if(e){if(e.getParent)return e.getParent();r.default.err("Level","getParentZone",`No getParent() in ${JSON.stringify(e)}`)}return null}setParent(e){r.default.isNullOrUndef([e])?r.default.err("Map.Level","setParent","Parent is not defined."):this._parent=e}getActors(){return this._p.actors}getItems(){return this._p.items}getElements(){return this._p.elements}getStairs(){const e=[];return this._p.elements.forEach(t=>{this._isStairs(t)&&e.push(t)}),e}getPassages(){const e=[];return this._p.elements.forEach(t=>{if("passage"===t.getName()){const s=t;e.push(s)}}),e}getConnections(){const e=[];return this._p.elements.forEach(t=>{if("connection"===t.getType()){const s=t;e.push(s)}}),e}_isStairs(e){return/stairs(Down|Up)/.test(e.getName())}setMap(e){this._map=e}getMap(){return this._map}getStairsToLevel(e){r.default.isNullOrUndef([e])&&r.default.err("Map.Level","getStairs","arg |level| required.");const t=this.getStairs();for(let s=0;s<t.length;s++)if(t[s].getTargetLevel()===e)return t[s];return null}addStairs(e,t,s){if(r.default.isNullOrUndef([t,s]))r.default.err("Map.Level","addStairs","Cannot add stairs. x, y missing.");else{if(this._map.hasXY(t,s))return e.setSrcLevel(this),this._map.setBaseElemXY(t,s,u.ELEM.FLOOR),this._addPropToLevelXY(r.default.TYPE_ELEM,e,t,s);{const e=`x,y ${t},${s} out of map bounds.`;r.default.err("Map.Level","addStairs",`${e}: cols ${this._map.cols}, rows: ${this._map.rows}`)}}return!1}useStairs(e){const t=this._map.getCell(e.getX(),e.getY());if(t.hasConnection()){if(t.getConnection().useStairs(e))return!0;r.default.err("Level","useStairs","Failed to use connection.")}return!1}addElement(e,t,s){if("connection"===e.getType())return this.addStairs(e,t,s);if(!r.default.isNullOrUndef([t,s]))return this._addPropToLevelXY(r.default.TYPE_ELEM,e,t,s);const[a,n]=this._getFreeCellXY();return r.default.isNullOrUndef([a,n])&&(this.debugPrintInASCII(),r.default.err("Level","addElement","Cannot add prop to null xy-coord")),this._addPropToLevelXY(r.default.TYPE_ELEM,e,a,n)}removeElement(e,t,s){return this._removePropFromLevelXY(r.default.TYPE_ELEM,e,t,s)}addEntity(e,t,s){return r.default.isActor(e)?this.addActor(e,t,s):r.default.isItem(e)?this.addItem(e,t,s):r.default.isElement(e)?this.addElement(e,t,s):(r.default.err("Level","addEntity","No support for ents without getPropType"),!1)}addItem(e,t,s){if(!r.default.isNullOrUndef([t,s]))return this._addPropToLevelXY(r.default.TYPE_ITEM,e,t,s);const[a,n]=this._getFreeCellXY();return this._addPropToLevelXY(r.default.TYPE_ITEM,e,a,n)}removeItem(e,t,s){return this._removePropFromLevelXY(r.default.TYPE_ITEM,e,t,s)}pickupItem(e){const t=new i.Pickup;e.add(t)}moveActorTo(e,t,s){const a=e.getLevel(),[n,r]=[e.getX(),e.getY()],o=e.getPropType();return!!a._removePropFromLevelXY(o,e,n,r)&&this._addPropToLevelXY(o,e,t,s)}addActor(e,t,s){return r.default.debug(this,"addActor called with x,y "+t+", "+s),r.default.isNullOrUndef([t,s])?(r.default.nullOrUndefError("Level: addActor","arg |x|",t),r.default.nullOrUndefError("Level: addActor","arg |y|",s),!1):this._map.hasXY(t,s)?(this._addPropToLevelXY(r.default.TYPE_ACTOR,e,t,s),r.default.debug(this,"Added actor to map x: "+t+" y: "+s),!0):(r.default.err("Level","addActor","No coordinates "+t+", "+s+" in the map."),!1)}addActorToFreeCell(e){r.default.debug(this,"Adding actor to free slot");const t=this._map.getFree();if(t.length>0){const s=t[0].getX(),a=t[0].getY();if(this._addPropToLevelXY(r.default.TYPE_ACTOR,e,s,a))return r.default.debug(this,"Added actor to free cell in "+s+", "+a),!0}else r.default.err("Level","addActor","No free cells for the actor.");return!1}_addPropToLevelXY(e,t,s,a){return this._p.hasOwnProperty(e)?(this._p[e].push(t),t.isOwnable||(t.setXY(s,a),t.setLevel(this)),this._map.setProp(s,a,e,t),g.emitEvent(r.default.EVT_LEVEL_PROP_ADDED,{level:this,obj:t,propType:e}),!0):(r.default.err("Map.Level","_addPropToLevelXY",`No prop ${e} supported. Obj: ${JSON.stringify(t)}`),!1)}addVirtualProp(e,t){return this._p.hasOwnProperty(e)?(this._p[e].push(t),t.setLevel(this),g.emitEvent(r.default.EVT_LEVEL_PROP_ADDED,{level:this,obj:t,propType:e}),!0):(r.default.err("Map.Level","addVirtualProp",`No prop ${e} supported. Obj: ${JSON.stringify(t)}`),!1)}_removePropFromLevelXY(e,t,s,a){if(this._p.hasOwnProperty(e)){const n=this._p[e].indexOf(t);return n>=0?(this._p[e].splice(n,1),t.getOwner||(t.setXY(null,null),t.unsetLevel()),g.emitEvent(r.default.EVT_LEVEL_PROP_REMOVED,{level:this,obj:t,propType:e}),this._map.removeProp(s,a,e,t)):(r.default.err("Map.Level","_removePropFromLevelXY",`Obj index not found in list this._p[${e}]`),!1)}return r.default.err("Map.Level","_removePropFromLevelXY",`No prop ${e} supported. Obj: ${JSON.stringify(t)}`),!1}removeVirtualProp(e,t){if(this._p.hasOwnProperty(e)){const s=this._p[e].indexOf(t);if(s>=0)return this._p[e].splice(s,1),g.emitEvent(r.default.EVT_LEVEL_PROP_REMOVED,{level:this,obj:t,propType:e}),!0}return!1}removeActor(e){const t=this._p.actors.indexOf(e),s=e.getX(),a=e.getY();return!!this._map.removeProp(s,a,r.default.TYPE_ACTOR,e)&&(this._p.actors.splice(t,1),!0)}exploreCells(e){const t=this._map.getVisibleCells(e);for(let e=0;e<t.length;e++)t[e].setExplored();return t}getExploredCells(){return this._map.getExploredCells()}setExtras(e){this._extras=e}getExtras(){return this._extras||(this._extras={}),this._extras}hasExtras(){return!r.default.isNullOrUndef([this._extras])&&Object.keys(this._extras).length>0}addExtras(e,t){this._extras||(this._extras={}),this._extras[e]=t}getBbox(){return{ulx:0,uly:0,lrx:this.getMap().cols-1,lry:this.getMap().rows-1}}getColsRows(){return[this.getMap().cols,this.getMap().rows]}setOnEnter(e){this._callbacks.OnEnter=e}setOnFirstEnter(e){this._callbacks.OnFirstEnter=e}setOnExit(e){this._callbacks.OnExit=e}setOnFirstExit(e){this._callbacks.OnFirstExit=e}onEnter(){this._callbacks.hasOwnProperty("OnEnter")&&this._callbacks.OnEnter(this)}onFirstEnter(){this._cbState.onFirstEnterDone||(this._callbacks.hasOwnProperty("OnFirstEnter")&&this._callbacks.OnFirstEnter(this),this._cbState.onFirstEnterDone=!0)}onExit(){this._callbacks.hasOwnProperty("OnExit")&&this._callbacks.OnExit(this)}onFirstExit(){this._cbState.onFirstExitDone||(this._callbacks.hasOwnProperty("OnFirstExit")&&this._callbacks.OnFirstExit(this),this._cbState.onFirstExitDone=!0)}getFreeRandCell(){const e=this.getMap().getFree();return e.length>0?e[y.randIndex(e)]:null}getEmptyRandCell(){const e=this.getMap().getEmptyCells();return e.length>0?e[y.randIndex(e)]:null}_getFreeCellXY(){const e=this._map.getFree();return e.length>0?[e[0].getX(),e[0].getY()]:[null,null]}debugPrintInASCII(){this.getMap().debugPrintInASCII()}removeElements(e){this._p.elements.filter(e).forEach(e=>{const t=e.getX(),s=e.getY();this.removeElement(e,t,s)})}getCell(e,t){return this._map.getCell(e,t)}getPlayer(){return this._p.actors.find(e=>e.isPlayer&&e.isPlayer())}toJSON(){const e={isJSON:!0,id:this.getID(),levelNumber:this.getLevelNumber(),actors:[],items:[],elements:[],map:this.getMap().toJSON(),cbState:this._cbState};return this._parent&&(e.parent=this._parent.getName(),"string"!=typeof e.parent&&r.default.err("Map.Level","toJSON","Parent name not a string")),e.components=l.compsToJSON(this),[p,f,m].forEach(t=>{this._p[t].forEach(s=>{const a={x:s.getX(),y:s.getY(),obj:s.toJSON()};!t===r.default.TYPE_ACTOR?e[t].push(a):a.obj.isPlayer||e[t].push(a)})}),e}}},function(e,t,s){"use strict";s.r(t);var a={isSupported:function(){return!(!document.createElement("canvas").getContext||!Function.prototype.bind)},DEFAULT_WIDTH:80,DEFAULT_HEIGHT:25,DIRS:{4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95};a.Text={RE_COLORS:/%([bc]){([^}]*)}/g,TYPE_TEXT:0,TYPE_NEWLINE:1,TYPE_FG:2,TYPE_BG:3,measure:function(e,t){var s={width:0,height:1},a=this.tokenize(e,t),n=0;for(let e=0;e<a.length;e++){const t=a[e];switch(t.type){case this.TYPE_TEXT:n+=t.value.length;break;case this.TYPE_NEWLINE:s.height++,s.width=Math.max(s.width,n),n=0}}return s.width=Math.max(s.width,n),s},tokenize:function(e,t){var s=[],n=0;e.replace(this.RE_COLORS,function(t,r,o,i){var l=e.substring(n,i);return l.length&&s.push({type:a.Text.TYPE_TEXT,value:l}),s.push({type:"c"===r?a.Text.TYPE_FG:a.Text.TYPE_BG,value:o.trim()}),n=i+t.length,""});var r=e.substring(n);return r.length&&s.push({type:a.Text.TYPE_TEXT,value:r}),this._breakLines(s,t)},_breakLines:function(e,t){t||(t=1/0);for(var s=0,n=0,r=-1;s<e.length;){if((u=e[s]).type===a.Text.TYPE_NEWLINE&&(n=0,r=-1),u.type==a.Text.TYPE_TEXT){for(;0===n&&" "===u.value.charAt(0);)u.value=u.value.substring(1);var o=u.value.indexOf("\n");if(-1!=o){u.value=this._breakInsideToken(e,s,o,!0);for(var i=u.value.split("");i.length&&" "===i[i.length-1];)i.pop();u.value=i.join("")}if(u.value.length){if(n+u.value.length>t){for(o=-1;;){var l=u.value.indexOf(" ",o+1);if(-1===l)break;if(n+l>t)break;o=l}if(-1!=o)u.value=this._breakInsideToken(e,s,o,!0);else if(-1!=r){var c=(u=e[r]).value.lastIndexOf(" ");u.value=this._breakInsideToken(e,r,c,!0),s=r}else u.value=this._breakInsideToken(e,s,t-n,!1)}else n+=u.value.length,-1!=u.value.indexOf(" ")&&(r=s);s++}else e.splice(s,1)}else s++}e.push({type:a.Text.TYPE_NEWLINE});var h=null;for(s=0;s<e.length;s++){var u;switch((u=e[s]).type){case a.Text.TYPE_TEXT:h=u;break;case a.Text.TYPE_NEWLINE:if(h){for(i=h.value.split("");i.length&&" "===i[i.length-1];)i.pop();h.value=i.join("")}h=null}}return e.pop(),e},_breakInsideToken:function(e,t,s,n){var r={type:a.Text.TYPE_NEWLINE},o={type:a.Text.TYPE_TEXT,value:e[t].value.substring(s+(n?1:0))};return e.splice(t+1,0,r,o),e[t].value.substring(0,s)}},Array.prototype.random=Array.prototype.random||function(){return this.length?this[Math.floor(a.RNG.getUniform()*this.length)]:null},Array.prototype.randomize=Array.prototype.randomize||function(){for(var e=[];this.length;){var t=this.indexOf(this.random());e.push(this.splice(t,1)[0])}return e},Number.prototype.mod=Number.prototype.mod||function(e){return(this%e+e)%e},String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)},String.prototype.lpad=String.prototype.lpad||function(e,t){for(var s=e||"0",a=t||2,n="";n.length<a-this.length;)n+=s;return(n=n.substring(0,a-this.length))+this},String.prototype.rpad=String.prototype.rpad||function(e,t){for(var s=e||"0",a=t||2,n="";n.length<a-this.length;)n+=s;return this+(n=n.substring(0,a-this.length))},String.format=String.format||function(e){var t=String.format.map,s=Array.prototype.slice.call(arguments,1);return e.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,function(a,n,r,o){if("%"===e.charAt(o-1))return a.substring(1);if(!s.length)return a;var i=s[0],l=(n||r).split(","),c=l.shift(),h=t[c.toLowerCase()];if(!h)return a;var u=(i=s.shift())[h].apply(i,l),d=c.charAt(0);return d!=d.toLowerCase()&&(u=u.capitalize()),u})},String.format.map=String.format.map||{s:"toString"},String.prototype.format=String.prototype.format||function(){var e=Array.prototype.slice.call(arguments);return e.unshift(this),String.format.apply(String,e)},Object.create||(Object.create=function(e){var t=function(){};return t.prototype=e,new t}),Function.prototype.extend=Function.prototype.extend||function(e){return this.prototype=Object.create(e.prototype),this.prototype.constructor=this,this},"undefined"!=typeof window&&(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return setTimeout(e,1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(e){return clearTimeout(e)}),a.Display=function(e){var t=document.createElement("canvas");this._context=t.getContext("2d"),this._data={},this._dirty=!1,this._options={},this._backend=null;var s={width:a.DEFAULT_WIDTH,height:a.DEFAULT_HEIGHT,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1,termColor:"xterm"};for(var n in e)s[n]=e[n];this.setOptions(s),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),requestAnimationFrame(this._tick)},a.Display.prototype.DEBUG=function(e,t,s){var a=[this._options.bg,this._options.fg];this.draw(e,t,null,null,a[s%a.length])},a.Display.prototype.clear=function(){this._data={},this._dirty=!0},a.Display.prototype.setOptions=function(e){for(var t in e)this._options[t]=e[t];if(e.width||e.height||e.fontSize||e.fontFamily||e.spacing||e.layout){e.layout&&(this._backend=new(a.Display[e.layout.capitalize()])(this._context));var s=(this._options.fontStyle?this._options.fontStyle+" ":"")+this._options.fontSize+"px "+this._options.fontFamily;this._context.font=s,this._backend.compute(this._options),this._context.font=s,this._context.textAlign="center",this._context.textBaseline="middle",this._dirty=!0}return this},a.Display.prototype.getOptions=function(){return this._options},a.Display.prototype.getContainer=function(){return this._context.canvas},a.Display.prototype.computeSize=function(e,t){return this._backend.computeSize(e,t,this._options)},a.Display.prototype.computeFontSize=function(e,t){return this._backend.computeFontSize(e,t,this._options)},a.Display.prototype.eventToPosition=function(e){var t,s;e.touches?(t=e.touches[0].clientX,s=e.touches[0].clientY):(t=e.clientX,s=e.clientY);var a=this._context.canvas.getBoundingClientRect();return t-=a.left,s-=a.top,t*=this._context.canvas.width/this._context.canvas.clientWidth,s*=this._context.canvas.height/this._context.canvas.clientHeight,t<0||s<0||t>=this._context.canvas.width||s>=this._context.canvas.height?[-1,-1]:this._backend.eventToPosition(t,s)},a.Display.prototype.draw=function(e,t,s,a,n){a||(a=this._options.fg),n||(n=this._options.bg),this._data[e+","+t]=[e,t,s,a,n],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[e+","+t]=!0)},a.Display.prototype.drawText=function(e,t,s,n){var r=null,o=null,i=e,l=t,c=1;n||(n=this._options.width-e);for(var h=a.Text.tokenize(s,n);h.length;){var u=h.shift();switch(u.type){case a.Text.TYPE_TEXT:var d=!1,g=!1,p=!1,m=!1;for(let e=0;e<u.value.length;e++){var f=u.value.charCodeAt(e),y=u.value.charAt(e);p=f>255&&f<65377||f>65500&&f<65512&&f>65518,d=32===y.charCodeAt(0)||12288===y.charCodeAt(0),!m||p||d||i++,p&&!g&&i++,this.draw(i++,l,y,r,o),g=d,m=p}break;case a.Text.TYPE_FG:r=u.value||null;break;case a.Text.TYPE_BG:o=u.value||null;break;case a.Text.TYPE_NEWLINE:i=e,l++,c++}}return c},a.Display.prototype._tick=function(){if(requestAnimationFrame(this._tick),this._dirty){if(!0===this._dirty)for(var e in this._context.fillStyle=this._options.bg,this._context.fillRect(0,0,this._context.canvas.width,this._context.canvas.height),this._data)this._draw(e,!1);else for(var t in this._dirty)this._draw(t,!0);this._dirty=!1}},a.Display.prototype._draw=function(e,t){var s=this._data[e];s[4]!=this._options.bg&&(t=!0),this._backend.draw(s,t)},a.Display.Backend=function(e){this._context=e},a.Display.Backend.prototype.compute=function(e){},a.Display.Backend.prototype.draw=function(e,t){},a.Display.Backend.prototype.computeSize=function(e,t){},a.Display.Backend.prototype.computeFontSize=function(e,t){},a.Display.Backend.prototype.eventToPosition=function(e,t){},a.Display.Rect=function(e){a.Display.Backend.call(this,e),this._spacingX=0,this._spacingY=0,this._canvasCache={},this._options={}},a.Display.Rect.extend(a.Display.Backend),a.Display.Rect.cache=!1,a.Display.Rect.prototype.compute=function(e){this._canvasCache={},this._options=e;var t=Math.ceil(this._context.measureText("W").width);this._spacingX=Math.ceil(e.spacing*t),this._spacingY=Math.ceil(e.spacing*e.fontSize),this._options.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._context.canvas.width=e.width*this._spacingX,this._context.canvas.height=e.height*this._spacingY},a.Display.Rect.prototype.draw=function(e,t){this.constructor.cache?this._drawWithCache(e,t):this._drawNoCache(e,t)},a.Display.Rect.prototype._drawWithCache=function(e,t){var s,a=e[0],n=e[1],r=e[2],o=e[3],i=e[4],l=""+r+o+i;if(l in this._canvasCache)s=this._canvasCache[l];else{var c=this._options.border,h=(s=document.createElement("canvas")).getContext("2d");if(s.width=this._spacingX,s.height=this._spacingY,h.fillStyle=i,h.fillRect(c,c,s.width-c,s.height-c),r){h.fillStyle=o,h.font=this._context.font,h.textAlign="center",h.textBaseline="middle";var u=[].concat(r);for(let e=0;e<u.length;e++)h.fillText(u[e],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[l]=s}this._context.drawImage(s,a*this._spacingX,n*this._spacingY)},a.Display.Rect.prototype._drawNoCache=function(e,t){var s=e[0],a=e[1],n=e[2],r=e[3],o=e[4];if(t){var i=this._options.border;this._context.fillStyle=o,this._context.fillRect(s*this._spacingX+i,a*this._spacingY+i,this._spacingX-i,this._spacingY-i)}if(n){this._context.fillStyle=r;var l=[].concat(n);for(let e=0;e<l.length;e++)this._context.fillText(l[e],(s+.5)*this._spacingX,Math.ceil((a+.5)*this._spacingY))}},a.Display.Rect.prototype.computeSize=function(e,t){return[Math.floor(e/this._spacingX),Math.floor(t/this._spacingY)]},a.Display.Rect.prototype.computeFontSize=function(e,t){var s=Math.floor(e/this._options.width),a=Math.floor(t/this._options.height),n=this._context.font;this._context.font="100px "+this._options.fontFamily;var r=Math.ceil(this._context.measureText("W").width);this._context.font=n;var o=r/100*a/s;return o>1&&(a=Math.floor(a/o)),Math.floor(a/this._options.spacing)},a.Display.Rect.prototype.eventToPosition=function(e,t){return[Math.floor(e/this._spacingX),Math.floor(t/this._spacingY)]},a.Display.Hex=function(e){a.Display.Backend.call(this,e),this._spacingX=0,this._spacingY=0,this._hexSize=0,this._options={}},a.Display.Hex.extend(a.Display.Backend),a.Display.Hex.prototype.compute=function(e){this._options=e;var t,s,a=Math.ceil(this._context.measureText("W").width);this._hexSize=Math.floor(e.spacing*(e.fontSize+a/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,e.transpose?(t="height",s="width"):(t="width",s="height"),this._context.canvas[t]=Math.ceil((e.width+1)*this._spacingX),this._context.canvas[s]=Math.ceil((e.height-1)*this._spacingY+2*this._hexSize)},a.Display.Hex.prototype.draw=function(e,t){var s=e[0],a=e[1],n=e[2],r=e[3],o=e[4],i=[(s+1)*this._spacingX,a*this._spacingY+this._hexSize];if(this._options.transpose&&i.reverse(),t&&(this._context.fillStyle=o,this._fill(i[0],i[1])),n){this._context.fillStyle=r;var l=[].concat(n);for(let e=0;e<l.length;e++)this._context.fillText(l[e],i[0],Math.ceil(i[1]))}},a.Display.Hex.prototype.computeSize=function(e,t){return this._options.transpose&&(e+=t,e-=t=e-t),[Math.floor(e/this._spacingX)-1,Math.floor((t-2*this._hexSize)/this._spacingY+1)]},a.Display.Hex.prototype.computeFontSize=function(e,t){this._options.transpose&&(e+=t,e-=t=e-t);var s=2*e/((this._options.width+1)*Math.sqrt(3))-1,a=t/(2+1.5*(this._options.height-1)),n=Math.min(s,a),r=this._context.font;this._context.font="100px "+this._options.fontFamily;var o=Math.ceil(this._context.measureText("W").width);this._context.font=r;var i=o/100,l=2*(n=Math.floor(n)+1)/(this._options.spacing*(1+i/Math.sqrt(3)));return Math.ceil(l)-1},a.Display.Hex.prototype.eventToPosition=function(e,t){var s;this._options.transpose?(e+=t,e-=t=e-t,s=this._context.canvas.width):s=this._context.canvas.height;var a=s/this._options.height;return(t=Math.floor(t/a)).mod(2)?(e-=this._spacingX,e=1+2*Math.floor(e/(2*this._spacingX))):e=2*Math.floor(e/(2*this._spacingX)),[e,t]},a.Display.Hex.prototype._fill=function(e,t){var s=this._hexSize,a=this._options.border;this._context.beginPath(),this._options.transpose?(this._context.moveTo(e-s+a,t),this._context.lineTo(e-s/2+a,t+this._spacingX-a),this._context.lineTo(e+s/2-a,t+this._spacingX-a),this._context.lineTo(e+s-a,t),this._context.lineTo(e+s/2-a,t-this._spacingX+a),this._context.lineTo(e-s/2+a,t-this._spacingX+a),this._context.lineTo(e-s+a,t)):(this._context.moveTo(e,t-s+a),this._context.lineTo(e+this._spacingX-a,t-s/2+a),this._context.lineTo(e+this._spacingX-a,t+s/2-a),this._context.lineTo(e,t+s-a),this._context.lineTo(e-this._spacingX+a,t+s/2-a),this._context.lineTo(e-this._spacingX+a,t-s/2+a),this._context.lineTo(e,t-s+a)),this._context.fill()},a.Display.Tile=function(e){a.Display.Rect.call(this,e),this._options={},this._colorCanvas=document.createElement("canvas")},a.Display.Tile.extend(a.Display.Rect),a.Display.Tile.prototype.compute=function(e){this._options=e,this._context.canvas.width=e.width*e.tileWidth,this._context.canvas.height=e.height*e.tileHeight,this._colorCanvas.width=e.tileWidth,this._colorCanvas.height=e.tileHeight},a.Display.Tile.prototype.draw=function(e,t){var s=e[0],a=e[1],n=e[2],r=e[3],o=e[4],i=this._options.tileWidth,l=this._options.tileHeight;if(t&&(this._options.tileColorize?this._context.clearRect(s*i,a*l,i,l):(this._context.fillStyle=o,this._context.fillRect(s*i,a*l,i,l))),n){var c=[].concat(n);for(let e=0;e<c.length;e++){var h=this._options.tileMap[c[e]];if(!h)throw new Error("Char '"+c[e]+"' not found in tileMap");if(this._options.tileColorize){var u=this._colorCanvas,d=u.getContext("2d");d.clearRect(0,0,i,l),d.drawImage(this._options.tileSet,h[0],h[1],i,l,0,0,i,l),"transparent"!=r&&(d.fillStyle=r,d.globalCompositeOperation="source-atop",d.fillRect(0,0,i,l)),"transparent"!=o&&(d.fillStyle=o,d.globalCompositeOperation="destination-over",d.fillRect(0,0,i,l)),this._context.drawImage(u,s*i,a*l,i,l)}else this._context.drawImage(this._options.tileSet,h[0],h[1],i,l,s*i,a*l,i,l)}}},a.Display.Tile.prototype.computeSize=function(e,t){return[Math.floor(e/this._options.tileWidth),Math.floor(t/this._options.tileHeight)]},a.Display.Tile.prototype.computeFontSize=function(e,t){return[Math.floor(e/this._options.width),Math.floor(t/this._options.height)]},a.Display.Tile.prototype.eventToPosition=function(e,t){return[Math.floor(e/this._options.tileWidth),Math.floor(t/this._options.tileHeight)]},a.RNG={getSeed:function(){return this._seed},setSeed:function(e){return e=e<1?1/e:e,this._seed=e,this._s0=(e>>>0)*this._frac,e=69069*e+1>>>0,this._s1=e*this._frac,e=69069*e+1>>>0,this._s2=e*this._frac,this._c=1,this},getUniform:function(){var e=2091639*this._s0+this._c*this._frac;return this._s0=this._s1,this._s1=this._s2,this._c=0|e,this._s2=e-this._c,this._s2},getUniformInt:function(e,t){var s=Math.max(e,t),a=Math.min(e,t);return Math.floor(this.getUniform()*(s-a+1))+a},getNormal:function(e,t){var s;do{var a=2*this.getUniform()-1,n=2*this.getUniform()-1;s=a*a+n*n}while(s>1||0===s);return(e||0)+a*Math.sqrt(-2*Math.log(s)/s)*(t||1)},getPercentage:function(){return 1+Math.floor(100*this.getUniform())},getWeightedValue:function(e){var t=0;for(var s in e)t+=e[s];var a=this.getUniform()*t,n=0;for(var s in e)if(a<(n+=e[s]))return s;return s},getState:function(){return[this._s0,this._s1,this._s2,this._c]},setState:function(e){return this._s0=e[0],this._s1=e[1],this._s2=e[2],this._c=e[3],this},clone:function(){var e=Object.create(this);return e.setState(this.getState()),e},_s0:0,_s1:0,_s2:0,_c:0,_frac:2.3283064365386963e-10},a.RNG.setSeed(0),a.StringGenerator=function(e){for(var t in this._options={words:!1,order:3,prior:.001},e)this._options[t]=e[t];this._boundary=String.fromCharCode(0),this._suffix=this._boundary,this._prefix=[];for(let e=0;e<this._options.order;e++)this._prefix.push(this._boundary);this._priorValues={},this._priorValues[this._boundary]=this._options.prior,this._data={}},a.StringGenerator.prototype.clear=function(){this._data={},this._priorValues={}},a.StringGenerator.prototype.generate=function(){for(var e=[this._sample(this._prefix)];e[e.length-1]!=this._boundary;)e.push(this._sample(e));return this._join(e.slice(0,-1))},a.StringGenerator.prototype.observe=function(e){var t=this._split(e);for(let e=0;e<t.length;e++)this._priorValues[t[e]]=this._options.prior;for(t=this._prefix.concat(t).concat(this._suffix),i=this._options.order;i<t.length;i++){var s=t.slice(i-this._options.order,i),a=t[i];for(let e=0;e<s.length;e++){var n=s.slice(e);this._observeEvent(n,a)}}},a.StringGenerator.prototype.getStats=function(){var e=[],t=0;for(var s in this._priorValues)t++;t--,e.push("distinct samples: "+t);var a=0,n=0;for(var s in this._data)for(var r in a++,this._data[s])n++;return e.push("dictionary size (contexts): "+a),e.push("dictionary size (events): "+n),e.join(", ")},a.StringGenerator.prototype._split=function(e){return e.split(this._options.words?/\s+/:"")},a.StringGenerator.prototype._join=function(e){return e.join(this._options.words?" ":"")},a.StringGenerator.prototype._observeEvent=function(e,t){var s=this._join(e);s in this._data||(this._data[s]={});var a=this._data[s];t in a||(a[t]=0),a[t]++},a.StringGenerator.prototype._sample=function(e){e=this._backoff(e);var t=this._join(e),s=this._data[t],n={};if(this._options.prior){for(var r in this._priorValues)n[r]=this._priorValues[r];for(r in s)n[r]+=s[r]}else n=s;return a.RNG.getWeightedValue(n)},a.StringGenerator.prototype._backoff=function(e){for(e.length>this._options.order?e=e.slice(-this._options.order):e.length<this._options.order&&(e=this._prefix.slice(0,this._options.order-e.length).concat(e));!(this._join(e)in this._data)&&e.length>0;)e=e.slice(1);return e},a.EventQueue=function(){this._time=0,this._events=[],this._eventTimes=[]},a.EventQueue.prototype.getTime=function(){return this._time},a.EventQueue.prototype.clear=function(){return this._events=[],this._eventTimes=[],this};const n=function(e,t,s){let a=e.length;for(;a-- >=t;)e[a+1]=e[a];return e[t]=s,e};a.EventQueue.prototype.add=function(e,t){var s=this._events.length;for(let e=0;e<this._eventTimes.length;e++)if(this._eventTimes[e]>t){s=e;break}n(this._events,s,e),n(this._eventTimes,s,t)},a.EventQueue.prototype.get=function(){if(!this._events.length)return null;var e=this._eventTimes.shift();if(e>0){this._time+=e;for(let t=0;t<this._eventTimes.length;t++)this._eventTimes[t]-=e}return this._events.shift()},a.EventQueue.prototype.remove=function(e){var t=this._events.indexOf(e);return-1!==t&&(this._remove(t),!0)};const r=function(e,t){const s=e.length;if(s){for(;t<s;)e[t]=e[t+1],t++;e.length--}};a.EventQueue.prototype._remove=function(e){r(this._events,e),r(this._eventTimes,e)},a.Scheduler=function(){this._queue=new a.EventQueue,this._repeat=[],this._current=null},a.Scheduler.prototype.getTime=function(){return this._queue.getTime()},a.Scheduler.prototype.add=function(e,t){return t&&this._repeat.push(e),this},a.Scheduler.prototype.clear=function(){return this._queue.clear(),this._repeat=[],this._current=null,this},a.Scheduler.prototype.remove=function(e){var t=this._queue.remove(e),s=this._repeat.indexOf(e);return-1!=s&&this._repeat.splice(s,1),this._current===e&&(this._current=null),t},a.Scheduler.prototype.next=function(){return this._current=this._queue.get(),this._current},a.Scheduler.Simple=function(){a.Scheduler.call(this)},a.Scheduler.Simple.extend(a.Scheduler),a.Scheduler.Simple.prototype.add=function(e,t){return this._queue.add(e,0),a.Scheduler.prototype.add.call(this,e,t)},a.Scheduler.Simple.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),a.Scheduler.prototype.next.call(this)},a.Scheduler.Speed=function(){a.Scheduler.call(this)},a.Scheduler.Speed.extend(a.Scheduler),a.Scheduler.Speed.prototype.add=function(e,t){return this._queue.add(e,1/e.getSpeed()),a.Scheduler.prototype.add.call(this,e,t)},a.Scheduler.Speed.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed()),a.Scheduler.prototype.next.call(this)},a.Scheduler.Action=function(){a.Scheduler.call(this),this._defaultDuration=1,this._duration=this._defaultDuration},a.Scheduler.Action.extend(a.Scheduler),a.Scheduler.Action.prototype.add=function(e,t,s){return this._queue.add(e,s||this._defaultDuration),a.Scheduler.prototype.add.call(this,e,t)},a.Scheduler.Action.prototype.clear=function(){return this._duration=this._defaultDuration,a.Scheduler.prototype.clear.call(this)},a.Scheduler.Action.prototype.remove=function(e){return e===this._current&&(this._duration=this._defaultDuration),a.Scheduler.prototype.remove.call(this,e)},a.Scheduler.Action.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),a.Scheduler.prototype.next.call(this)},a.Scheduler.Action.prototype.setDuration=function(e){return this._current&&(this._duration=e),this},a.Engine=function(e){this._scheduler=e,this._lock=1},a.Engine.prototype.start=function(){return this.unlock()},a.Engine.prototype.lock=function(){return this._lock++,this},a.Engine.prototype.unlock=function(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){var e=this._scheduler.next();if(!e)return this.lock();var t=e.act();t&&t.then&&(this.lock(),t.then(this.unlock.bind(this)))}return this},a.Map=function(e,t){this._width=e||a.DEFAULT_WIDTH,this._height=t||a.DEFAULT_HEIGHT},a.Map.prototype.create=function(e){},a.Map.prototype._fillMap=function(e){var t=[];for(let s=0;s<this._width;s++){t.push([]);for(let a=0;a<this._height;a++)t[s].push(e)}return t},a.Map.prototype.getCols=function(){return this._width},a.Map.prototype.getRows=function(){return this._height},a.Map.prototype.getCenterXY=function(){return[Math.floor(this._width/2),Math.floor(this._height/2)]},a.Map.Arena=function(e,t){a.Map.call(this,e,t)},a.Map.Arena.extend(a.Map),a.Map.Arena.prototype.create=function(e){var t=this._width-1,s=this._height-1;for(let a=0;a<=t;a++)for(let n=0;n<=s;n++){e(a,n,a&&n&&a<t&&n<s?0:1)}return this},a.Map.DividedMaze=function(e,t){a.Map.call(this,e,t),this._stack=[]},a.Map.DividedMaze.extend(a.Map),a.Map.DividedMaze.prototype.create=function(e){var t=this._width,s=this._height;this._map=[];for(let e=0;e<t;e++){this._map.push([]);for(let n=0;n<s;n++){var a=0===e||0===n||e+1===t||n+1===s;this._map[e].push(a?1:0)}}this._stack=[[1,1,t-2,s-2]],this._process();for(let a=0;a<t;a++)for(let t=0;t<s;t++)e(a,t,this._map[a][t]);return this._map=null,this},a.Map.DividedMaze.prototype._process=function(){for(;this._stack.length;){var e=this._stack.shift();this._partitionRoom(e)}},a.Map.DividedMaze.prototype._partitionRoom=function(e){var t=[],s=[];for(let s=e[0]+1;s<e[2];s++){var a=this._map[s][e[1]-1],n=this._map[s][e[3]+1];!a||!n||s%2||t.push(s)}for(let t=e[1]+1;t<e[3];t++){var r=this._map[e[0]-1][t],o=this._map[e[2]+1][t];!r||!o||t%2||s.push(t)}if(t.length&&s.length){var i=t.random(),l=s.random();this._map[i][l]=1;var c=[],h=[];c.push(h);for(let t=e[0];t<i;t++)this._map[t][l]=1,h.push([t,l]);h=[];c.push(h);for(let t=i+1;t<=e[2];t++)this._map[t][l]=1,h.push([t,l]);h=[];c.push(h);for(let t=e[1];t<l;t++)this._map[i][t]=1,h.push([i,t]);h=[];c.push(h);for(let t=l+1;t<=e[3];t++)this._map[i][t]=1,h.push([i,t]);var u=c.random();for(let e=0;e<c.length;e++){if((h=c[e])!==u){var d=h.random();this._map[d[0]][d[1]]=0}}this._stack.push([e[0],e[1],i-1,l-1]),this._stack.push([i+1,e[1],e[2],l-1]),this._stack.push([e[0],l+1,i-1,e[3]]),this._stack.push([i+1,l+1,e[2],e[3]])}},a.Map.IceyMaze=function(e,t,s){a.Map.call(this,e,t),this._regularity=s||0},a.Map.IceyMaze.extend(a.Map),a.Map.IceyMaze.prototype.create=function(e){var t=this._width,s=this._height,n=this._fillMap(1);t-=t%2?1:2,s-=s%2?1:2;var r=0,o=0,i=0,l=0,c=0,h=!1,u=[[0,0],[0,0],[0,0],[0,0]];do{if(r=1+2*Math.floor(a.RNG.getUniform()*(t-1)/2),o=1+2*Math.floor(a.RNG.getUniform()*(s-1)/2),c||(n[r][o]=0),!n[r][o]){this._randomize(u);do{0===Math.floor(a.RNG.getUniform()*(this._regularity+1))&&this._randomize(u),h=!0;for(let e=0;e<4;e++)if(i=r+2*u[e][0],l=o+2*u[e][1],this._isFree(n,i,l,t,s)){n[i][l]=0,n[r+u[e][0]][o+u[e][1]]=0,r=i,o=l,h=!1,c++;break}}while(!h)}}while(c+1<t*s/4);for(let t=0;t<this._width;t++)for(let s=0;s<this._height;s++)e(t,s,n[t][s]);return this._map=null,this},a.Map.IceyMaze.prototype._randomize=function(e){for(let t=0;t<4;t++)e[t][0]=0,e[t][1]=0;switch(Math.floor(4*a.RNG.getUniform())){case 0:e[0][0]=-1,e[1][0]=1,e[2][1]=-1,e[3][1]=1;break;case 1:e[3][0]=-1,e[2][0]=1,e[1][1]=-1,e[0][1]=1;break;case 2:e[2][0]=-1,e[3][0]=1,e[0][1]=-1,e[1][1]=1;break;case 3:e[1][0]=-1,e[0][0]=1,e[3][1]=-1,e[2][1]=1}},a.Map.IceyMaze.prototype._isFree=function(e,t,s,a,n){return!(t<1||s<1||t>=a||s>=n)&&e[t][s]},a.Map.EllerMaze=function(e,t){a.Map.call(this,e,t)},a.Map.EllerMaze.extend(a.Map),a.Map.EllerMaze.prototype.create=function(e){var t=this._fillMap(1),s=Math.ceil((this._width-2)/2),n=[],r=[];for(let e=0;e<s;e++)n.push(e),r.push(e);n.push(s-1);let o=0;for(let e=1;e+3<this._height;e+=2){for(let o=0;o<s;o++){var i=e;t[l=2*o+1][i]=0,o!=n[o+1]&&a.RNG.getUniform()>.375&&(this._addToList(o,n,r),t[l+1][i]=0),o!=n[o]&&a.RNG.getUniform()>.375?this._removeFromList(o,n,r):t[l][i+1]=0}o=e}for(let e=0;e<s;e++){var l;i=o;t[l=2*e+1][i]=0,e!=n[e+1]&&(e===n[e]||a.RNG.getUniform()>.375)&&(this._addToList(e,n,r),t[l+1][i]=0),this._removeFromList(e,n,r)}for(let s=0;s<this._width;s++)for(let a=0;a<this._height;a++)e(s,a,t[s][a]);return this},a.Map.EllerMaze.prototype._removeFromList=function(e,t,s){s[t[e]]=s[e],t[s[e]]=t[e],s[e]=e,t[e]=e},a.Map.EllerMaze.prototype._addToList=function(e,t,s){s[t[e+1]]=s[e],t[s[e]]=t[e+1],s[e]=e+1,t[e+1]=e},a.Map.Cellular=function(e,t,s){a.Map.call(this,e,t),this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8},this.setOptions(s),this._dirs=a.DIRS[this._options.topology],this._map=this._fillMap(0)},a.Map.Cellular.extend(a.Map),a.Map.Cellular.prototype.randomize=function(e){for(let t=0;t<this._width;t++)for(let s=0;s<this._height;s++)this._map[t][s]=a.RNG.getUniform()<e?1:0;return this},a.Map.Cellular.prototype.setOptions=function(e){for(var t in e)this._options[t]=e[t]},a.Map.Cellular.prototype.set=function(e,t,s){this._map[e][t]=s},a.Map.Cellular.prototype.create=function(e){var t=this._fillMap(0),s=this._options.born,a=this._options.survive;for(let e=0;e<this._height;e++){var n=1,r=0;6===this._options.topology&&(n=2,r=e%2);for(let l=r;l<this._width;l+=n){var o=this._map[l][e],i=this._getNeighbors(l,e);o&&-1!=a.indexOf(i)?t[l][e]=1:o||-1==s.indexOf(i)||(t[l][e]=1)}}this._map=t,this.serviceCallback(e)},a.Map.Cellular.prototype.serviceCallback=function(e){if(e)for(let a=0;a<this._height;a++){var t=1,s=0;6===this._options.topology&&(t=2,s=a%2);for(let n=s;n<this._width;n+=t)e(n,a,this._map[n][a])}},a.Map.Cellular.prototype._getNeighbors=function(e,t){var s=0;for(let o=0;o<this._dirs.length;o++){var a=this._dirs[o],n=e+a[0],r=t+a[1];n<0||n>=this._width||n<0||r>=this._width||(s+=1===this._map[n][r]?1:0)}return s},a.Map.Cellular.prototype.connect=function(e,t,s){t||(t=0);var n=[],r={};for(let e=0;e<this._width;e++)for(let s=0;s<this._height;s++)if(this._freeSpace(e,s,t)){var o=[e,s];r[this._pointKey(o)]=o,n.push([e,s])}var i=n[a.RNG.getUniformInt(0,n.length-1)],l=this._pointKey(i),c={};for(c[l]=i,delete r[l],this._findConnected(c,r,[i],!1,t);Object.keys(r).length>0;){var h=(o=this._getFromTo(c,r))[0],u=o[1],d={};for(var g in d[this._pointKey(h)]=h,this._findConnected(d,r,[h],!0,t),this._tunnelToConnected(u,h,c,r,t,s),d){var p=d[g];this._map[p[0]][p[1]]=t,c[g]=p,delete r[g]}}this.serviceCallback(e)},a.Map.Cellular.prototype._getFromTo=function(e,t){var s,n,r=Object.keys(e),o=Object.keys(t);for(let l=0;l<5;l++){var i;if(r.length<o.length)n=e[(i=r)[a.RNG.getUniformInt(0,i.length-1)]],s=this._getClosest(n,t);else s=t[(i=o)[a.RNG.getUniformInt(0,i.length-1)]],n=this._getClosest(s,e);if((s[0]-n[0])*(s[0]-n[0])+(s[1]-n[1])*(s[1]-n[1])<64)break}return[s,n]},a.Map.Cellular.prototype._getClosest=function(e,t){var s=null,a=null;for(var n in t){var r=t[n],o=(r[0]-e[0])*(r[0]-e[0])+(r[1]-e[1])*(r[1]-e[1]);(null===a||o<a)&&(a=o,s=r)}return s},a.Map.Cellular.prototype._findConnected=function(e,t,s,a,n){for(;s.length>0;){var r=s.splice(0,1)[0],o=[[r[0]+1,r[1]],[r[0]-1,r[1]],[r[0],r[1]+1],[r[0],r[1]-1]];for(let r=0;r<o.length;r++){var i=this._pointKey(o[r]);null===e[i]&&this._freeSpace(o[r][0],o[r][1],n)&&(e[i]=o[r],a||delete t[i],s.push(o[r]))}}},a.Map.Cellular.prototype._tunnelToConnected=function(e,t,s,a,n,r){var o,i;this._pointKey(t);t[0]<e[0]?(o=t,i=e):(o=e,i=t);for(let e=o[0];e<=i[0];e++){this._map[e][o[1]]=n;var l=[e,o[1]];s[h=this._pointKey(l)]=l,delete a[h]}r&&o[0]<i[0]&&r(o,[i[0],o[1]]);var c=i[0];t[1]<e[1]?(o=t,i=e):(o=e,i=t);for(let e=o[1];e<i[1];e++){this._map[c][e]=n;var h;l=[c,e];s[h=this._pointKey(l)]=l,delete a[h]}r&&o[1]<i[1]&&r([i[0],o[1]],[i[0],i[1]])},a.Map.Cellular.prototype._freeSpace=function(e,t,s){return e>=0&&e<this._width&&t>=0&&t<this._height&&this._map[e][t]===s},a.Map.Cellular.prototype._pointKey=function(e){return e[0]+"."+e[1]},a.Map.Dungeon=function(e,t){a.Map.call(this,e,t),this._rooms=[],this._corridors=[]},a.Map.Dungeon.extend(a.Map),a.Map.Dungeon.prototype.getRooms=function(){return this._rooms},a.Map.Dungeon.prototype.getCorridors=function(){return this._corridors},a.Map.Digger=function(e,t,s){for(var n in a.Map.Dungeon.call(this,e,t),this._options={roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3},s)this._options[n]=s[n];this._features={Room:4,Corridor:4},this._featureAttempts=20,this._walls={},this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)},a.Map.Digger.extend(a.Map.Dungeon),a.Map.Digger.prototype.create=function(e){this._rooms=[],this._map=this._fillMap(1),this._walls={},this._dug=0,this._corridors=[];var t=(this._width-2)*(this._height-2);this._firstRoom();var s=Date.now();do{if(Date.now()-s>this._options.timeLimit)break;var a=this._findWall();if(!a)break;var n=a.split(","),r=parseInt(n[0]),o=parseInt(n[1]),i=this._getDiggingDirection(r,o);if(i){var l=0;do{if(l++,this._tryFeature(r,o,i[0],i[1])){this._removeSurroundingWalls(r,o),this._removeSurroundingWalls(r-i[0],o-i[1]);break}}while(l<this._featureAttempts);var c=0;for(var h in this._walls)this._walls[h]>1&&c++}}while(this._dug/t<this._options.dugPercentage||c);if(this._addDoors(),e)for(let t=0;t<this._width;t++)for(let s=0;s<this._height;s++)e(t,s,this._map[t][s]);return this._walls={},this._map=null,this},a.Map.Digger.prototype._digCallback=function(e,t,s){0===s||2===s?(this._map[e][t]=0,this._dug++):this._walls[e+","+t]=1},a.Map.Digger.prototype._isWallCallback=function(e,t){return!(e<0||t<0||e>=this._width||t>=this._height)&&1===this._map[e][t]},a.Map.Digger.prototype._canBeDugCallback=function(e,t){return!(e<1||t<1||e+1>=this._width||t+1>=this._height)&&1===this._map[e][t]},a.Map.Digger.prototype._priorityWallCallback=function(e,t){this._walls[e+","+t]=2},a.Map.Digger.prototype._firstRoom=function(){let e=this._startRoom;if(!e){var t=Math.floor(this._width/2),s=Math.floor(this._height/2);e=a.Map.Feature.Room.createRandomCenter(t,s,this._options)}this._rooms.push(e),e.create(this._digCallback),this._extraRooms&&this._extraRooms.forEach(e=>{this._rooms.push(e),e.create(this._digCallback)})},a.Map.Digger.prototype.startRoom=function(e){this._startRoom=e},a.Map.Digger.prototype.addRoom=function(e){this._startRoom?(this._extraRooms||(this._extraRooms=[]),this._extraRooms.push(e)):this._startRoom=e},a.Map.Digger.prototype._findWall=function(){var e=[],t=[];for(var s in this._walls){2===this._walls[s]?t.push(s):e.push(s)}var a=t.length?t:e;if(!a.length)return null;s=a.sort().random();return delete this._walls[s],s},a.Map.Digger.prototype._tryFeature=function(e,t,s,n){var r=a.RNG.getWeightedValue(this._features);return!!(r=a.Map.Feature[r].createRandomAt(e,t,s,n,this._options)).isValid(this._isWallCallback,this._canBeDugCallback)&&(r.create(this._digCallback),r instanceof a.Map.Feature.Room&&this._rooms.push(r),r instanceof a.Map.Feature.Corridor&&(r.createPriorityWalls(this._priorityWallCallback),this._corridors.push(r)),!0)},a.Map.Digger.prototype._removeSurroundingWalls=function(e,t){var s=a.DIRS[4];for(let a=0;a<s.length;a++){var n=s[a],r=e+n[0],o=t+n[1];delete this._walls[r+","+o];r=e+2*n[0],o=t+2*n[1];delete this._walls[r+","+o]}},a.Map.Digger.prototype._getDiggingDirection=function(e,t){if(e<=0||t<=0||e>=this._width-1||t>=this._height-1)return null;var s=null,n=a.DIRS[4];for(let a=0;a<n.length;a++){var r=n[a],o=e+r[0],i=t+r[1];if(!this._map[o][i]){if(s)return null;s=r}}return s?[-s[0],-s[1]]:null},a.Map.Digger.prototype._addDoors=function(){var e=this._map,t=function(t,s){return 1===e[t][s]};for(let e=0;e<this._rooms.length;e++){var s=this._rooms[e];s.clearDoors(),s.addDoors(t)}},a.Map.Uniform=function(e,t,s){for(var n in a.Map.Dungeon.call(this,e,t),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3},s)this._options[n]=s[n];this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)},a.Map.Uniform.extend(a.Map.Dungeon),a.Map.Uniform.prototype.create=function(e){for(var t=Date.now();;){if(Date.now()-t>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),this._startRoom&&(this._rooms.push(this._startRoom),this._startRoom.create(this._digCallback)),!(this._rooms.length<2)&&this._generateCorridors())break}if(e)for(let t=0;t<this._width;t++)for(let s=0;s<this._height;s++)e(t,s,this._map[t][s]);return this},a.Map.Uniform.prototype.startRoom=function(e){this._startRoom=e},a.Map.Uniform.prototype._generateRooms=function(){var e=this._width-2,t=this._height-2;do{var s=this._generateRoom();if(this._dug/(e*t)>this._options.roomDugPercentage)break}while(s)},a.Map.Uniform.prototype._generateRoom=function(){for(var e=0;e<this._roomAttempts;){e++;var t=a.Map.Feature.Room.createRandom(this._width,this._height,this._options);if(t.isValid(this._isWallCallback,this._canBeDugCallback))return t.create(this._digCallback),this._rooms.push(t),t}return null},a.Map.Uniform.prototype._generateCorridors=function(){for(var e=0;e<this._corridorAttempts;){e++,this._corridors=[],this._map=this._fillMap(1);for(let e=0;e<this._rooms.length;e++){var t=this._rooms[e];t.clearDoors(),t.create(this._digCallback)}for(this._unconnected=this._rooms.slice().randomize(),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){var s=this._connected.random(),a=this._closestRoom(this._unconnected,s),n=this._closestRoom(this._connected,a);if(!this._connectRooms(a,n))break;if(!this._unconnected.length)return!0}}return!1},a.Map.Uniform.prototype._closestRoom=function(e,t){var s=1/0,a=t.getCenter(),n=null;for(let t=0;t<e.length;t++){var r=e[t],o=r.getCenter(),i=o[0]-a[0],l=o[1]-a[1],c=i*i+l*l;c<s&&(s=c,n=r)}return n},a.Map.Uniform.prototype._connectRooms=function(e,t){var s=e.getCenter(),a=t.getCenter(),n=a[0]-s[0],r=a[1]-s[1];if(Math.abs(n)<Math.abs(r))var o=((h=r>0?2:0)+2)%4,i=t.getLeft(),l=t.getRight(),c=0;else{var h;o=((h=n>0?1:3)+2)%4,i=t.getTop(),l=t.getBottom(),c=1}var u=this._placeInWall(e,h);if(!u)return!1;if(u[c]>=i&&u[c]<=l){var d=u.slice(),g=null;switch(o){case 0:g=t.getTop()-1;break;case 1:g=t.getRight()+1;break;case 2:g=t.getBottom()+1;break;case 3:g=t.getLeft()-1}d[(c+1)%2]=g,this._digLine([u,d])}else if(u[c]<i-1||u[c]>l+1){var p=u[c]-a[c];switch(o){case 0:case 1:var m=p<0?3:1;break;case 2:case 3:m=p<0?1:3}if(o=(o+m)%4,!(d=this._placeInWall(t,o)))return!1;(y=[0,0])[c]=u[c],y[f=(c+1)%2]=d[f],this._digLine([u,y,d])}else{var f=(c+1)%2;if(!(d=this._placeInWall(t,o)))return!1;var y=Math.round((d[f]+u[f])/2),_=[0,0],E=[0,0];_[c]=u[c],_[f]=y,E[c]=d[c],E[f]=y,this._digLine([u,_,E,d])}return e.addDoor(u[0],u[1]),t.addDoor(d[0],d[1]),-1!=(c=this._unconnected.indexOf(e))&&(this._unconnected.splice(c,1),this._connected.push(e)),-1!=(c=this._unconnected.indexOf(t))&&(this._unconnected.splice(c,1),this._connected.push(t)),!0},a.Map.Uniform.prototype._placeInWall=function(e,t){var s=[0,0],a=[0,0],n=0;switch(t){case 0:a=[1,0],s=[e.getLeft(),e.getTop()-1],n=e.getRight()-e.getLeft()+1;break;case 1:a=[0,1],s=[e.getRight()+1,e.getTop()],n=e.getBottom()-e.getTop()+1;break;case 2:a=[1,0],s=[e.getLeft(),e.getBottom()+1],n=e.getRight()-e.getLeft()+1;break;case 3:a=[0,1],s=[e.getLeft()-1,e.getTop()],n=e.getBottom()-e.getTop()+1}var r=[],o=-2;for(let e=0;e<n;e++){var i=s[0]+e*a[0],l=s[1]+e*a[1];r.push(null),1===this._map[i][l]?o!=e-1&&(r[e]=[i,l]):(o=e,e&&(r[e-1]=null))}for(let e=r.length-1;e>=0;e--)r[e]||r.splice(e,1);return r.length?r.random():null},a.Map.Uniform.prototype._digLine=function(e){for(let r=1;r<e.length;r++){var t=e[r-1],s=e[r],n=new a.Map.Feature.Corridor(t[0],t[1],s[0],s[1]);n.create(this._digCallback),this._corridors.push(n)}},a.Map.Uniform.prototype._digCallback=function(e,t,s){this._map[e][t]=s,0===s&&this._dug++},a.Map.Uniform.prototype._isWallCallback=function(e,t){return!(e<0||t<0||e>=this._width||t>=this._height)&&1===this._map[e][t]},a.Map.Uniform.prototype._canBeDugCallback=function(e,t){return!(e<1||t<1||e+1>=this._width||t+1>=this._height)&&1===this._map[e][t]},a.Map.Rogue=function(e,t,s){for(var n in a.Map.call(this,e,t),this._options={cellWidth:3,cellHeight:3},s)this._options[n]=s[n];this._options.hasOwnProperty("roomWidth")||(this._options.roomWidth=this._calculateRoomSize(this._width,this._options.cellWidth)),this._options.hasOwnProperty("roomHeight")||(this._options.roomHeight=this._calculateRoomSize(this._height,this._options.cellHeight))},a.Map.Rogue.extend(a.Map),a.Map.Rogue.prototype.create=function(e){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),e)for(let t=0;t<this._width;t++)for(let s=0;s<this._height;s++)e(t,s,this.map[t][s]);return this},a.Map.Rogue.prototype._calculateRoomSize=function(e,t){var s=Math.floor(e/t*.8),a=Math.floor(e/t*.25);return a<2&&(a=2),s<2&&(s=2),[a,s]},a.Map.Rogue.prototype._initRooms=function(){for(let e=0;e<this._options.cellWidth;e++){this.rooms.push([]);for(let t=0;t<this._options.cellHeight;t++)this.rooms[e].push({x:0,y:0,width:0,height:0,connections:[],cellx:e,celly:t})}},a.Map.Rogue.prototype._connectRooms=function(){var e,t,s,n,r,o=a.RNG.getUniformInt(0,this._options.cellWidth-1),i=a.RNG.getUniformInt(0,this._options.cellHeight-1),l=!1;do{var c=[0,2,4,6];c=c.randomize();do{if(l=!1,e=c.pop(),t=o+a.DIRS[8][e][0],s=i+a.DIRS[8][e][1],!(t<0||t>=this._options.cellWidth||s<0||s>=this._options.cellHeight)){if((n=this.rooms[o][i]).connections.length>0&&n.connections[0][0]===t&&n.connections[0][1]===s)break;0===(r=this.rooms[t][s]).connections.length&&(r.connections.push([o,i]),this.connectedCells.push([t,s]),o=t,i=s,l=!0)}}while(c.length>0&&!1===l)}while(c.length>0)},a.Map.Rogue.prototype._connectUnconnectedRooms=function(){var e,t,s=this._options.cellWidth,n=this._options.cellHeight;this.connectedCells=this.connectedCells.randomize();for(let h=0;h<this._options.cellWidth;h++)for(let u=0;u<this._options.cellHeight;u++)if(0===(e=this.rooms[h][u]).connections.length){var r=[0,2,4,6];r=r.randomize();var o=!1;do{var i=r.pop(),l=h+a.DIRS[8][i][0],c=u+a.DIRS[8][i][1];if(!(l<0||l>=s||c<0||c>=n)){if(o=!0,0===(t=this.rooms[l][c]).connections.length)break;for(let e=0;e<t.connections.length;e++)if(t.connections[e][0]===h&&t.connections[e][1]===u){o=!1;break}if(o)break}}while(r.length);o?e.connections.push([t.cellx,t.celly]):console.log("-- Unable to connect room.")}},a.Map.Rogue.prototype._createRandomRoomConnections=function(e){},a.Map.Rogue.prototype._createRooms=function(){var e,t,s,n,r,o=this._width,i=this._height,l=this._options.cellWidth,c=this._options.cellHeight,h=Math.floor(this._width/l),u=Math.floor(this._height/c),d=this._options.roomWidth,g=this._options.roomHeight;for(let f=0;f<l;f++)for(let l=0;l<c;l++){if(0===(s=h*f)&&(s=1),0===(n=u*l)&&(n=1),e=a.RNG.getUniformInt(d[0],d[1]),t=a.RNG.getUniformInt(g[0],g[1]),l>0)for(r=this.rooms[f][l-1];n-(r.y+r.height)<3;)n++;if(f>0)for(r=this.rooms[f-1][l];s-(r.x+r.width)<3;)s++;for(var p=Math.round(a.RNG.getUniformInt(0,h-e)/2),m=Math.round(a.RNG.getUniformInt(0,u-t)/2);s+p+e>=o;)p?p--:e--;for(;n+m+t>=i;)m?m--:t--;s+=p,n+=m,this.rooms[f][l].x=s,this.rooms[f][l].y=n,this.rooms[f][l].width=e,this.rooms[f][l].height=t;for(let a=s;a<s+e;a++)for(let e=n;e<n+t;e++)this.map[a][e]=0}},a.Map.Rogue.prototype._getWallPosition=function(e,t){var s,n,r;return 1===t||3===t?(s=a.RNG.getUniformInt(e.x+1,e.x+e.width-2),r=1===t?(n=e.y-2)+1:(n=e.y+e.height+1)-1,this.map[s][r]=0):2!==t&&4!==t||(n=a.RNG.getUniformInt(e.y+1,e.y+e.height-2),r=2===t?(s=e.x+e.width+1)-1:(s=e.x-2)+1,this.map[r][n]=0),[s,n]},a.Map.Rogue.prototype._drawCorridore=function(e,t){var s,n,r,o,i=t[0]-e[0],l=t[1]-e[1],c=e[0],h=e[1],u=[],d=Math.abs(i),g=Math.abs(l),p=a.RNG.getUniform(),m=p,f=1-p;for(n=i>0?2:6,r=l>0?4:0,d<g?(s=Math.ceil(g*m),u.push([r,s]),u.push([n,d]),s=Math.floor(g*f),u.push([r,s])):(s=Math.ceil(d*m),u.push([n,s]),u.push([r,g]),s=Math.floor(d*f),u.push([n,s])),this.map[c][h]=0;u.length>0;)for(o=u.pop();o[1]>0;)c+=a.DIRS[8][o[0]][0],h+=a.DIRS[8][o[0]][1],this.map[c][h]=0,o[1]=o[1]-1},a.Map.Rogue.prototype._createCorridors=function(){var e,t,s,a,n,r=this._options.cellWidth,o=this._options.cellHeight;for(let i=0;i<r;i++)for(let r=0;r<o;r++){e=this.rooms[i][r];for(let r=0;r<e.connections.length;r++)t=e.connections[r],(s=this.rooms[t[0]][t[1]]).cellx>e.cellx?(a=2,n=4):s.cellx<e.cellx?(a=4,n=2):s.celly>e.celly?(a=3,n=1):s.celly<e.celly&&(a=1,n=3),this._drawCorridore(this._getWallPosition(e,a),this._getWallPosition(s,n))}},a.Map.Feature=function(){},a.Map.Feature.prototype.isValid=function(e){},a.Map.Feature.prototype.create=function(e){},a.Map.Feature.prototype.debug=function(){},a.Map.Feature.createRandomAt=function(e,t,s,a,n){},a.Map.Feature.Room=function(e,t,s,a,n,r){this._x1=e,this._y1=t,this._x2=s,this._y2=a,this._doors={},this._feats={},this._stairs={},arguments.length>4&&this.addDoor(n,r)},a.Map.Feature.Room.extend(a.Map.Feature),a.Map.Feature.Room.createRandomAt=function(e,t,s,n,r){var o,i,l=r.roomWidth[0],c=r.roomWidth[1],h=a.RNG.getUniformInt(l,c),u=(l=r.roomHeight[0],c=r.roomHeight[1],a.RNG.getUniformInt(l,c));if(1===s)return new this(e+1,o=t-Math.floor(a.RNG.getUniform()*u),e+h,o+u-1,e,t);if(-1===s)return new this(e-h,o=t-Math.floor(a.RNG.getUniform()*u),e-1,o+u-1,e,t);if(1===n)return new this(i=e-Math.floor(a.RNG.getUniform()*h),t+1,i+h-1,t+u,e,t);if(-1===n)return new this(i=e-Math.floor(a.RNG.getUniform()*h),t-u,i+h-1,t-1,e,t);throw new Error("dx or dy must be 1 or -1")},a.Map.Feature.Room.createRandomCenter=function(e,t,s){var n=s.roomWidth[0],r=s.roomWidth[1],o=a.RNG.getUniformInt(n,r),i=(n=s.roomHeight[0],r=s.roomHeight[1],a.RNG.getUniformInt(n,r)),l=e-Math.floor(a.RNG.getUniform()*o),c=t-Math.floor(a.RNG.getUniform()*i);return new this(l,c,l+o-1,c+i-1)},a.Map.Feature.Room.createCenter=function(e,t,s){var n=s.roomWidth[0],r=s.roomWidth[1],o=a.RNG.getUniformInt(n,r),i=(n=s.roomHeight[0],r=s.roomHeight[1],a.RNG.getUniformInt(n,r)),l=e-Math.floor(o/2),c=t-Math.floor(i/2);return new this(l,c,l+o-1,c+i-1)},a.Map.Feature.Room.createRandom=function(e,t,s){var n=s.roomWidth[0],r=s.roomWidth[1],o=a.RNG.getUniformInt(n,r),i=(n=s.roomHeight[0],r=s.roomHeight[1],a.RNG.getUniformInt(n,r)),l=e-o-1,c=t-i-1,h=1+Math.floor(a.RNG.getUniform()*l),u=1+Math.floor(a.RNG.getUniform()*c);return new this(h,u,h+o-1,u+i-1)},a.Map.Feature.Room.prototype.addDoor=function(e,t){return this._doors[e+","+t]=1,this},a.Map.Feature.Room.prototype.addStairs=function(e,t,s){return this._stairs[e+","+t]=s,this},a.Map.Feature.Room.prototype.hasStairs=function(e,t){return Object.keys(this._stairs).length>0},a.Map.Feature.Room.prototype.hasStairsUp=function(e,t){const s=Object.values(this._stairs);for(let e=0;e<s.length;e++)if(!1===s[e])return!0;return!1},a.Map.Feature.Room.add=function(e,t,s){this._feats[t+","+s]||(this._feats[t+","+s]=[]),this._feats[t+","+s].push(e)},a.Map.Feature.Room.prototype.getDoors=function(e){for(var t in this._doors){var s=t.split(",");e(parseInt(s[0]),parseInt(s[1]))}return this},a.Map.Feature.Room.prototype.clearDoors=function(){return this._doors={},this},a.Map.Feature.Room.prototype.addDoors=function(e){var t=this._x1-1,s=this._x2+1,a=this._y1-1,n=this._y2+1;for(let r=t;r<=s;r++)for(let o=a;o<=n;o++)r!=t&&r!=s&&o!=a&&o!=n||e(r,o)||this.addDoor(r,o);return this},a.Map.Feature.Room.prototype.debug=function(){console.log("room",this._x1,this._y1,this._x2,this._y2)},a.Map.Feature.Room.prototype.isValid=function(e,t){var s=this._x1-1,a=this._x2+1,n=this._y1-1,r=this._y2+1;for(let o=s;o<=a;o++)for(let i=n;i<=r;i++)if(o===s||o===a||i===n||i===r){if(!e(o,i))return!1}else if(!t(o,i))return!1;return!0},a.Map.Feature.Room.prototype.create=function(e){var t=this._x1-1,s=this._x2+1,a=this._y1-1,n=this._y2+1;for(let r=t;r<=s;r++)for(let o=a;o<=n;o++)e(r,o,r+","+o in this._doors?2:r===t||r===s||o===a||o===n?1:0)},a.Map.Feature.Room.prototype.getWidth=function(){return this._x2-this._x1},a.Map.Feature.Room.prototype.getHeight=function(){return this._y2-this._y1},a.Map.Feature.Room.prototype.getCorners=function(){return{nw:[this._x1,this._y1],ne:[this._x2,this._y1],sw:[this._x1,this._y2],se:[this._x2,this._y2]}},a.Map.Feature.Room.prototype.isTerm=function(){return 1===this.getDoors().length},a.Map.Feature.Room.prototype.getID=function(){return this._roomID},a.Map.Feature.Room.prototype.setID=function(e){this._roomID=e},a.Map.Feature.Room.prototype.getCenter=function(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]},a.Map.Feature.Room.prototype.getLeft=function(){return this._x1},a.Map.Feature.Room.prototype.getRight=function(){return this._x2},a.Map.Feature.Room.prototype.getTop=function(){return this._y1},a.Map.Feature.Room.prototype.getBottom=function(){return this._y2},a.Map.Feature.Room.prototype.getBbox=function(){return{ulx:this._x1,uly:this._y1,lrx:this._x2,lry:this._y2}},a.Map.Feature.Room.prototype.getOuterBbox=function(){return{ulx:this._x1-1,uly:this._y1-1,lrx:this._x2+1,lry:this._y2+1}},a.Map.Feature.prototype.getInnerBbox=function(e=1){const t=this._x1+e,s=this._x2-e;if(t>s)return{};const a=this._y1+e,n=this._y2-e;return a>n?{}:{ulx:t,uly:a,lrx:s,lry:n}},a.Map.Feature.Room.prototype.getAreaSize=function(){return(this._x2-this._x1)*(this._y2-this._y1)},a.Map.Feature.Corridor=function(e,t,s,a){this._startX=e,this._startY=t,this._endX=s,this._endY=a,this._endsWithAWall=!0},a.Map.Feature.Corridor.extend(a.Map.Feature),a.Map.Feature.Corridor.createRandomAt=function(e,t,s,n,r){var o=r.corridorLength[0],i=r.corridorLength[1],l=a.RNG.getUniformInt(o,i);return new this(e,t,e+s*l,t+n*l)},a.Map.Feature.Corridor.prototype.debug=function(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)},a.Map.Feature.Corridor.prototype.isValid=function(e,t){var s=this._startX,a=this._startY,n=this._endX-s,r=this._endY-a,o=1+Math.max(Math.abs(n),Math.abs(r));n&&(n/=Math.abs(n)),r&&(r/=Math.abs(r));var i=r,l=-n,c=!0;for(let d=0;d<o;d++){var h=s+d*n,u=a+d*r;if(t(h,u)||(c=!1),e(h+i,u+l)||(c=!1),e(h-i,u-l)||(c=!1),!c){o=d,this._endX=h-n,this._endY=u-r;break}}if(0===o)return!1;if(1===o&&e(this._endX+n,this._endY+r))return!1;var d=!e(this._endX+n+i,this._endY+r+l),g=!e(this._endX+n-i,this._endY+r-l);return this._endsWithAWall=e(this._endX+n,this._endY+r),!d&&!g||!this._endsWithAWall},a.Map.Feature.Corridor.prototype.create=function(e){var t=this._startX,s=this._startY,a=this._endX-t,n=this._endY-s,r=1+Math.max(Math.abs(a),Math.abs(n));a&&(a/=Math.abs(a)),n&&(n/=Math.abs(n));for(let o=0;o<r;o++){e(t+o*a,s+o*n,0)}return!0},a.Map.Feature.Corridor.prototype.createPriorityWalls=function(e){if(this._endsWithAWall){var t=this._startX,s=this._startY,a=this._endX-t,n=this._endY-s;a&&(a/=Math.abs(a)),n&&(n/=Math.abs(n));var r=n,o=-a;e(this._endX+a,this._endY+n),e(this._endX+r,this._endY+o),e(this._endX-r,this._endY-o)}},a.Noise=function(){},a.Noise.prototype.get=function(e,t){},a.Noise.Simplex=function(e){a.Noise.call(this),this._F2=.5*(Math.sqrt(3)-1),this._G2=(3-Math.sqrt(3))/6,this._gradients=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];var t=[],s=e||256;for(let e=0;e<s;e++)t.push(e);t=t.randomize(),this._perms=[],this._indexes=[];for(let e=0;e<2*s;e++)this._perms.push(t[e%s]),this._indexes.push(this._perms[e]%this._gradients.length)},a.Noise.Simplex.extend(a.Noise),a.Noise.Simplex.prototype.get=function(e,t){var s,a,n,r=this._perms,o=this._indexes,i=r.length/2,l=this._G2,c=0,h=0,u=0,d=(e+t)*this._F2,g=Math.floor(e+d),p=Math.floor(t+d),m=(g+p)*l,f=e-(g-m),y=t-(p-m);f>y?(a=1,n=0):(a=0,n=1);var _=f-a+l,E=y-n+l,S=f-1+2*l,v=y-1+2*l,C=g.mod(i),b=p.mod(i),T=.5-f*f-y*y;T>=0&&(T*=T,s=o[C+r[b]],c=T*T*((w=this._gradients[s])[0]*f+w[1]*y));var A=.5-_*_-E*E;A>=0&&(A*=A,s=o[C+a+r[b+n]],h=A*A*((w=this._gradients[s])[0]*_+w[1]*E));var w,O=.5-S*S-v*v;O>=0&&(O*=O,s=o[C+1+r[b+1]],u=O*O*((w=this._gradients[s])[0]*S+w[1]*v));return 70*(c+h+u)},a.FOV=function(e,t){for(var s in this._lightPasses=e,this._options={topology:8},t)this._options[s]=t[s]},a.FOV.prototype.compute=function(e,t,s,a){},a.FOV.prototype._getCircle=function(e,t,s){var n,r,o,i=[];switch(this._options.topology){case 4:r=1,o=[0,1],n=[a.DIRS[8][7],a.DIRS[8][1],a.DIRS[8][3],a.DIRS[8][5]];break;case 6:n=a.DIRS[6],r=1,o=[-1,1];break;case 8:n=a.DIRS[4],r=2,o=[-1,1]}var l=e+o[0]*s,c=t+o[1]*s;for(let e=0;e<n.length;e++)for(let t=0;t<s*r;t++)i.push([l,c]),l+=n[e][0],c+=n[e][1];return i},a.FOV.DiscreteShadowcasting=function(e,t){a.FOV.call(this,e,t)},a.FOV.DiscreteShadowcasting.extend(a.FOV),a.FOV.DiscreteShadowcasting.prototype.compute=function(e,t,s,a){this._coords,this._map;if(a(e,t,0,1),this._lightPasses(e,t)){var n,r,o,i,l,c=[];for(let d=1;d<=s;d++){var h=this._getCircle(e,t,d),u=360/h.length;for(let e=0;e<h.length;e++)if(o=h[e][0],i=h[e][1],r=(n=u*(e-.5))+u,l=!this._lightPasses(o,i),this._visibleCoords(Math.floor(n),Math.ceil(r),l,c)&&a(o,i,d,1),2===c.length&&0===c[0]&&360===c[1])return}}},a.FOV.DiscreteShadowcasting.prototype._visibleCoords=function(e,t,s,a){if(e<0){var n=arguments.callee(0,t,s,a),r=arguments.callee(360+e,360,s,a);return n||r}for(var o=0;o<a.length&&a[o]<e;)o++;if(o===a.length)return s&&a.push(e,t),!0;var i=0;if(o%2){for(;o<a.length&&a[o]<t;)o++,i++;return 0!==i&&(s&&(i%2?a.splice(o-i,i,t):a.splice(o-i,i)),!0)}for(;o<a.length&&a[o]<t;)o++,i++;return(e!==a[o-i]||1!==i)&&(s&&(i%2?a.splice(o-i,i,e):a.splice(o-i,i,e,t)),!0)},a.FOV.PreciseShadowcasting=function(e,t){a.FOV.call(this,e,t)},a.FOV.PreciseShadowcasting.extend(a.FOV),a.FOV.PreciseShadowcasting.prototype.compute=function(e,t,s,a){if(a(e,t,0,1),this._lightPasses(e,t)){var n,r,o,i,l,c,h=[];for(let g=1;g<=s;g++){var u=this._getCircle(e,t,g),d=u.length;for(let e=0;e<d;e++)if(n=u[e][0],r=u[e][1],i=[e?2*e-1:2*d-1,2*d],l=[2*e+1,2*d],o=!this._lightPasses(n,r),(c=this._checkVisibility(i,l,o,h))&&a(n,r,g,c),2===h.length&&0===h[0][0]&&h[1][0]===h[1][1])return}}},a.FOV.PreciseShadowcasting.prototype._checkVisibility=function(e,t,s,a){if(e[0]>t[0])return(this._checkVisibility(e,[e[1],e[1]],s,a)+this._checkVisibility([0,1],t,s,a))/2;for(var n=0,r=!1;n<a.length;){if((l=(c=a[n])[0]*e[1]-e[0]*c[1])>=0){0!==l||n%2||(r=!0);break}n++}for(var o=a.length,i=!1;o--;){var l,c=a[o];if((l=t[0]*c[1]-c[0]*t[1])>=0){0===l&&o%2&&(i=!0);break}}var h,u=!0;if(n===o&&(r||i)?u=!1:r&&i&&n+1===o&&o%2?u=!1:n>o&&n%2&&(u=!1),!u)return 0;var d=o-n+1;if(d%2)if(n%2){var g=a[n];h=(t[0]*g[1]-g[0]*t[1])/(g[1]*t[1]),s&&a.splice(n,d,t)}else{h=((g=a[o])[0]*e[1]-e[0]*g[1])/(e[1]*g[1]),s&&a.splice(n,d,e)}else{if(!(n%2))return s&&a.splice(n,d,e,t),1;var p=a[n],m=a[o];h=(m[0]*p[1]-p[0]*m[1])/(p[1]*m[1]),s&&a.splice(n,d)}return h/((t[0]*e[1]-e[0]*t[1])/(e[1]*t[1]))},a.FOV.RecursiveShadowcasting=function(e,t){a.FOV.call(this,e,t)},a.FOV.RecursiveShadowcasting.extend(a.FOV),a.FOV.RecursiveShadowcasting.OCTANTS=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]],a.FOV.RecursiveShadowcasting.prototype.compute=function(e,t,s,n){n(e,t,0,1);for(let r=0;r<a.FOV.RecursiveShadowcasting.OCTANTS.length;r++)this._renderOctant(e,t,a.FOV.RecursiveShadowcasting.OCTANTS[r],s,n)},a.FOV.RecursiveShadowcasting.prototype.compute180=function(e,t,s,n,r){r(e,t,0,1);var o=(n-1+8)%8,i=(n-2+8)%8,l=(n+1+8)%8;this._renderOctant(e,t,a.FOV.RecursiveShadowcasting.OCTANTS[i],s,r),this._renderOctant(e,t,a.FOV.RecursiveShadowcasting.OCTANTS[o],s,r),this._renderOctant(e,t,a.FOV.RecursiveShadowcasting.OCTANTS[n],s,r),this._renderOctant(e,t,a.FOV.RecursiveShadowcasting.OCTANTS[l],s,r)},a.FOV.RecursiveShadowcasting.prototype.compute90=function(e,t,s,n,r){r(e,t,0,1);var o=(n-1+8)%8;this._renderOctant(e,t,a.FOV.RecursiveShadowcasting.OCTANTS[n],s,r),this._renderOctant(e,t,a.FOV.RecursiveShadowcasting.OCTANTS[o],s,r)},a.FOV.RecursiveShadowcasting.prototype._renderOctant=function(e,t,s,a,n){this._castVisibility(e,t,1,1,0,a+1,s[0],s[1],s[2],s[3],n)},a.FOV.RecursiveShadowcasting.prototype._castVisibility=function(e,t,s,a,n,r,o,i,l,c,h){if(!(a<n))for(let E=s;E<=r;E++){for(var u=-E-1,d=-E,g=!1,p=0;u<=0;){var m=e+(u+=1)*o+d*i,f=t+u*l+d*c,y=(u-.5)/(d+.5),_=(u+.5)/(d-.5);if(!(_>a)){if(y<n)break;if(u*u+d*d<r*r&&h(m,f,E,1),g){if(!this._lightPasses(m,f)){p=_;continue}g=!1,a=p}else!this._lightPasses(m,f)&&E<r&&(g=!0,this._castVisibility(e,t,E+1,a,y,r,o,i,l,c,h),p=_)}}if(g)break}},a.Color={fromString:function(e){var t,s;if(e in this._cache)t=this._cache[e];else{if("#"===e.charAt(0)){var a=e.match(/[0-9a-f]/gi).map(function(e){return parseInt(e,16)});if(3===a.length)t=a.map(function(e){return 17*e});else{for(let e=0;e<3;e++)a[e+1]+=16*a[e],a.splice(e,1);t=a}}else t=(s=e.match(/rgb\(([0-9, ]+)\)/i))?s[1].split(/\s*,\s*/).map(function(e){return parseInt(e)}):[0,0,0];this._cache[e]=t}return t.slice()},add:function(e,t){var s=e.slice();for(let e=0;e<3;e++)for(let t=1;t<arguments.length;t++)s[e]+=arguments[t][e];return s},add_:function(e,t){for(let t=0;t<3;t++)for(let s=1;s<arguments.length;s++)e[t]+=arguments[s][t];return e},multiply:function(e,t){var s=e.slice();for(let e=0;e<3;e++){for(let t=1;t<arguments.length;t++)s[e]*=arguments[t][e]/255;s[e]=Math.round(s[e])}return s},multiply_:function(e,t){for(let t=0;t<3;t++){for(let s=1;s<arguments.length;s++)e[t]*=arguments[s][t]/255;e[t]=Math.round(e[t])}return e},interpolate:function(e,t,s){arguments.length<3&&(s=.5);var a=e.slice();for(let n=0;n<3;n++)a[n]=Math.round(a[n]+s*(t[n]-e[n]));return a},interpolateHSL:function(e,t,s){arguments.length<3&&(s=.5);var a=this.rgb2hsl(e),n=this.rgb2hsl(t);for(let e=0;e<3;e++)a[e]+=s*(n[e]-a[e]);return this.hsl2rgb(a)},randomize:function(e,t){t instanceof Array||(t=Math.round(a.RNG.getNormal(0,t)));var s=e.slice();for(let e=0;e<3;e++)s[e]+=t instanceof Array?Math.round(a.RNG.getNormal(0,t[e])):t;return s},rgb2hsl:function(e){var t,s,a=e[0]/255,n=e[1]/255,r=e[2]/255,o=Math.max(a,n,r),i=Math.min(a,n,r),l=(o+i)/2;if(o===i)t=s=0;else{var c=o-i;switch(s=l>.5?c/(2-o-i):c/(o+i),o){case a:t=(n-r)/c+(n<r?6:0);break;case n:t=(r-a)/c+2;break;case r:t=(a-n)/c+4}t/=6}return[t,s,l]},hsl2rgb:function(e){var t=e[2];if(0===e[1])return[t=Math.round(255*t),t,t];var s=function(e,t,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?e+6*(t-e)*s:s<.5?t:s<2/3?e+(t-e)*(2/3-s)*6:e},a=e[1],n=t<.5?t*(1+a):t+a-t*a,r=2*t-n,o=s(r,n,e[0]+1/3),i=s(r,n,e[0]),l=s(r,n,e[0]-1/3);return[Math.round(255*o),Math.round(255*i),Math.round(255*l)]},toRGB:function(e){return"rgb("+this._clamp(e[0])+","+this._clamp(e[1])+","+this._clamp(e[2])+")"},toHex:function(e){var t=[];for(let s=0;s<3;s++)t.push(this._clamp(e[s]).toString(16).lpad("0",2));return"#"+t.join("")},_clamp:function(e){return e<0?0:e>255?255:e},_cache:{black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]}},a.Lighting=function(e,t){this._reflectivityCallback=e,this._options={passes:1,emissionThreshold:100,range:10},this._fov=null,this._lights={},this._reflectivityCache={},this._fovCache={},this.setOptions(t)},a.Lighting.prototype.setOptions=function(e){for(var t in e)this._options[t]=e[t];return e&&e.range&&this.reset(),this},a.Lighting.prototype.setFOV=function(e){return this._fov=e,this._fovCache={},this},a.Lighting.prototype.setLight=function(e,t,s){var n=e+","+t;return s?this._lights[n]="string"==typeof s?a.Color.fromString(s):s:delete this._lights[n],this},a.Lighting.prototype.clearLights=function(){this._lights={}},a.Lighting.prototype.reset=function(){return this._reflectivityCache={},this._fovCache={},this},a.Lighting.prototype.compute=function(e){var t={},s={},n={};for(var r in this._lights){var o=this._lights[r];s[r]=[0,0,0],a.Color.add_(s[r],o)}for(let e=0;e<this._options.passes;e++)this._emitLight(s,n,t),e+1!==this._options.passes&&(s=this._computeEmitters(n,t));for(var i in n){var l=i.split(",");e(parseInt(l[0]),parseInt(l[1]),n[i])}return this},a.Lighting.prototype._emitLight=function(e,t,s){for(var a in e){var n=a.split(","),r=parseInt(n[0]),o=parseInt(n[1]);this._emitLightFromCell(r,o,e[a],t),s[a]=1}return this},a.Lighting.prototype._computeEmitters=function(e,t){var s={};for(var a in e)if(!(a in t)){var n=e[a];if(a in this._reflectivityCache)var r=this._reflectivityCache[a];else{var o=a.split(","),i=parseInt(o[0]),l=parseInt(o[1]);r=this._reflectivityCallback(i,l);this._reflectivityCache[a]=r}if(0!==r){var c=[],h=0;for(let e=0;e<3;e++){var u=Math.round(n[e]*r);c[e]=u,h+=u}h>this._options.emissionThreshold&&(s[a]=c)}}return s},a.Lighting.prototype._emitLightFromCell=function(e,t,s,a){var n=e+","+t;if(n in this._fovCache)var r=this._fovCache[n];else r=this._updateFOV(e,t);for(var o in r){var i=r[o];if(o in a)var l=a[o];else{l=[0,0,0];a[o]=l}for(let e=0;e<3;e++)l[e]+=Math.round(s[e]*i)}return this},a.Lighting.prototype._updateFOV=function(e,t){var s=e+","+t,a={};this._fovCache[s]=a;var n=this._options.range;return this._fov.compute(e,t,n,function(e,t,s,r){var o=r*(1-s/n);0!==o&&(a[e+","+t]=o)}.bind(this)),a},a.Path=function(e,t,s,n){for(var r in this._toX=e,this._toY=t,this._fromX=null,this._fromY=null,this._passableCallback=s,this._options={topology:8},n)this._options[r]=n[r];this._dirs=a.DIRS[this._options.topology],8===this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])},a.Path.prototype.compute=function(e,t,s){},a.Path.prototype._getNeighbors=function(e,t){var s=[];for(let o=0;o<this._dirs.length;o++){var a=this._dirs[o],n=e+a[0],r=t+a[1];this._passableCallback(n,r)&&s.push([n,r])}return s},a.Path.Dijkstra=function(e,t,s,n){a.Path.call(this,e,t,s,n),this._computed={},this._todo=[],this._add(e,t,null)},a.Path.Dijkstra.extend(a.Path),a.Path.Dijkstra.prototype.compute=function(e,t,s){var a=e+","+t;if(a in this._computed||this._compute(e,t),a in this._computed)for(var n=this._computed[a];n;)s(n.x,n.y),n=n.prev},a.Path.Dijkstra.prototype._compute=function(e,t){for(;this._todo.length;){var s=this._todo.shift();if(s.x===e&&s.y===t)return;var a=this._getNeighbors(s.x,s.y);for(let e=0,t=a.length;e<t;e++){var n=a[e][0],r=a[e][1],o=n+","+r;o in this._computed||this._add(o,n,r,s)}}},a.Path.Dijkstra.prototype._add=function(e,t,s,a){var n={x:t,y:s,prev:a};this._computed[e]=n,this._todo.push(n)},a.Path.AStar=function(e,t,s,n){a.Path.call(this,e,t,s,n),this._todo=[],this._done={},this._fromX=null,this._fromY=null},a.Path.AStar.extend(a.Path),a.Path.AStar.prototype.compute=function(e,t,s){if(this._todo=[],this._done={},this._fromX=e,this._fromY=t,this._add(this._toX,this._toY,null),0===this._getNeighbors(e,t).length)return;for(;this._todo.length;){const s=this._todo.shift();if(s.x===e&&s.y===t)break;const a=this._getNeighbors(s.x,s.y);for(let e=0;e<a.length;e++){const t=a[e],n=t[0],r=t[1];n+","+r in this._done||this._add(n,r,s)}}let a=this._done[e+","+t];if(a)for(;a;)s(a.x,a.y),a=a.prev},a.Path.AStar.prototype._add=function(e,t,s){var a=this._distance(e,t),r={x:e,y:t,prev:s,g:s?s.g+1:0,h:a};this._done[e+","+t]=r;var o=r.g+r.h;for(let e=0;e<this._todo.length;e++){var i=this._todo[e],l=i.g+i.h;if(o<l||o===l&&a<i.h)return void n(this._todo,e,r)}this._todo.push(r)},a.Path.AStar.prototype._distance=function(e,t){return Math.max(Math.abs(e-this._fromX),Math.abs(t-this._fromY))},t.default=a},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=n(s(48)),i=s(67),l=s(18),c=s(7),h=s(16),u=s(3),d=c.EventPool.getPool(),g=l.Component.DataComponent,p=l.Component.UniqueDataComponent,m=l.Component.UniqueDataComponent,f=l.Component.TransientDataComponent,y=l.Component.TransientTagComponent,_=l.Component.TagComponent,E=l.Component.UniqueTagComponent,S=l.ComponentBase.prototype,v=Object.freeze("");t.Action=m("Action",{energy:0,active:!1}),t.Action.prototype.addEnergy=function(e){this.energy+=e},t.Action.prototype.resetEnergy=function(){this.energy=0},t.Action.prototype.enable=function(){if(!1===this.active)d.emitEvent(r.default.EVT_ACT_COMP_ENABLED,{actor:this.getEntity()}),this.active=!0;else{this.getEntity().getName(),this.getEntity().getID()}},t.Action.prototype.disable=function(){!0===this.active&&(d.emitEvent(r.default.EVT_ACT_COMP_DISABLED,{actor:this.getEntity()}),this.active=!1)},t.Location=p("Location",{x:-1,y:-1,level:null}),t.Location.prototype.getXY=function(){return[this.x,this.y]},t.Location.prototype.setXY=function(e,t){this.x=e,this.y=t},t.Location.prototype.unsetLevel=function(){this.level?this.level=null:r.default.err("Location","unsetLevel","Trying to unset already null level.")},t.Location.prototype.isLocated=function(){return this.x>=0&&this.y>=0&&null!==this.level},t.Location.prototype.getCell=function(){return this.level?this.level.getMap().getCell(this.x,this.y):null},t.Location.prototype.toJSON=function(){const e={setType:this.getType(),setID:this.getID(),setX:this.x,setY:this.y};return this.level&&(e.setLevel=r.default.getObjRef("entity",this.level)),e},t.Typed=p("Typed",{objType:v,propType:v}),t.Typed.prototype._init=function(e,t){this.objType=e,this.propType=t},t.Item=p("Item",{value:1,damageType:r.default.DMG.BLUNT,count:1}),t.Item.prototype.incrCount=function(e){this.count+=e},t.Item.prototype.decrCount=function(e){this.count-=e},t.Hunger=p("Hunger",{energy:2e4,maxEnergy:2e4,minEnergy:-5e3}),t.Hunger.prototype.addEnergy=function(e){this.energy+=e,this.energy>this.maxEnergy&&(this.energy=this.maxEnergy)},t.Hunger.prototype.decrEnergy=function(e){this.energy-=e,this.energy<this.minEnergy&&(this.energy=this.minEnergy)},t.Hunger.prototype.isStarving=function(){return this.energy<=0},t.Hunger.prototype.isFull=function(){return this.energy===this.maxEnergy},t.Health=p("Health",{HP:10,maxHP:10}),t.Health.prototype.addHP=function(e){this.HP+=e,this.HP>this.maxHP&&(this.HP=this.maxHP)},t.Health.prototype.decrHP=function(e){this.HP-=e},t.Health.prototype.isAlive=function(){return this.HP>0},t.Health.prototype.isDead=function(){return this.HP<=0},t.Health.prototype.hpLost=function(){return this.maxHP-this.HP},t.Health.prototype._init=function(e){this.HP=e,this.maxHP=e},t.Dead=E("Dead"),t.Corporeal=E("Corporeal"),t.Damage=f("Damage",{damage:0,weapon:null,damageType:"",damageCateg:"",source:null,sourceActor:null}),t.Damage.prototype._init=function(e,t){this.damage=e,this.damageType=t},t.DirectDamage=g("DirectDamage",{damage:0,damageType:"",damageCateg:"",prob:1,source:null}),t.DirectDamage.prototype.toJSON=function(){const e=l.ComponentBase.prototype.toJSON.call(this);return this.source?e.setSource=r.default.getObjRef("entity",this.source):delete e.setSource,e},t.Damaged=p("Damaged",{damageLevel:0}),t.Broken=E("Broken"),t.Impassable=p("Impassable",{canFlyOver:!0,canJumpOver:!0,spellPasses:!0}),t.Impassable.prototype.setAllImpassable=function(){this.canFlyOver=!1,this.spellPasses=!1},t.Opaque=E("Opaque"),t.Experience=p("Experience",{exp:0,expLevel:1,danger:1}),t.ExpPoints=f("ExpPoints",{expPoints:null,skillPoints:null}),t.ExpPoints.prototype._init=function(e){this.expPoints=e,this.skills={}},t.ExpPoints.prototype.addSkillPoints=function(e,t){this.skills[e]=t},t.ExpPoints.prototype.addExpPoints=function(e){this.expPoints+=e},t.Combat=p("Combat",{attack:1,defense:1,protection:0,attackRange:1,damageDie:null}),t.Combat.prototype._init=function(){this.damageDie=h.Dice.create("1d4")},t.Combat.prototype.rollDamage=function(){return this.damageDie.roll()},t.Combat.prototype.setDamageDie=function(e){this.damageDie="string"==typeof e?h.Dice.create(e):e},t.Combat.prototype.copy=function(e){S.copy.call(this,e),this.damageDie=e.getDamageDie().clone()},t.Combat.prototype.toJSON=function(){const e=S.toJSON.call(this);return e.setDamageDie=this.damageDie.toString(),e},t.CombatMods=g("CombatMods",{attack:0,defense:0,protection:0,attackRange:0,damage:0,tag:""}),t.Stats=p("Stats",{accuracy:5,agility:5,strength:5,willpower:5,perception:5,magic:5,speed:100}),t.Stats.prototype.clearValues=function(){this.setAccuracy(0),this.setAgility(0),this.setStrength(0),this.setWillpower(0),this.setPerception(0),this.setSpeed(0),this.setMagic(0)},t.Stats.prototype.incrStat=function(e,t){const s="set"+e.capitalize(),a=this["get"+e.capitalize()]();this[s](a+t)},t.Stats.prototype.toString=function(){let e="";return r.default.GET_STATS.forEach((t,s)=>{const a=this[t]();0!==a&&(e+=r.default.STATS_ABBR[s]+": "+a)}),e},t.Stats.prototype.equals=function(e){let t=this.getType()===e.getType();return t=(t=(t=(t=(t=(t=(t=t&&this.getAccuracy()===e.getAccuracy())&&this.getAgility()===e.getAgility())&&this.getStrength()===e.getStrength())&&this.getWillpower()===e.getWillpower())&&this.getSpeed()===e.getSpeed())&&this.getPerception()===e.getPerception())&&this.getMagic()===e.getMagic()},t.StatsMods=g("StatsMods",{accuracy:0,agility:0,strength:0,willpower:0,perception:0,magic:0,speed:0,tag:""}),t.Perception=p("Perception",{FOVRange:r.default.NPC_FOV_RANGE}),t.Attack=f("Attack",{target:null}),t.Movement=f("Movement",{x:0,y:0,level:null}),t.Movement.prototype.setXY=function(e,t){this.x=e,this.y=t},t.Movement.prototype.getXY=function(){return[this.x,this.y]},t.Movement.prototype._init=function(e,t,s){this.x=e,this.y=t,this.level=s},t.Chat=f("Chat",{args:null}),t.Trainer=p("Trainer",{chatObj:null}),delete t.Trainer.prototype.setChatObj,t.Trainer.prototype._init=function(){this.chatObj=new i.ChatTrainer;this.addCallback("onAdd",()=>{this.chatObj.setTrainer(this.getEntity())})},t.Missile=f("Missile",{x:null,y:null,source:null,level:null,flying:!0,targetX:null,targetY:null,range:0,attack:0,damage:0,path:null}),t.Missile.prototype._init=function(e){this.source=e,this.x=e.getX(),this.y=e.getY(),this.level=e.getLevel(),this.path=[],this.pathIter=-1},t.Missile.prototype.hasRange=function(){return this.range>0},t.Missile.prototype.isFlying=function(){return this.flying},t.Missile.prototype.stopMissile=function(){this.flying=!1},t.Missile.prototype.setTargetXY=function(e,t){this.path=u.Geometry.getBresenham(this.x,this.y,e,t),this.targetX=e,this.targetY=t,this.path.length>0&&(this.pathIter=0)},t.Missile.prototype.inTarget=function(){return this.x===this.targetX&&this.y===this.targetY},t.Missile.prototype.iteratorValid=function(){return this.pathIter>=0&&this.pathIter<this.path.length},t.Missile.prototype.setValuesFromIterator=function(){const e=this.path[this.pathIter];this.x=e[0],this.y=e[1]},t.Missile.prototype.first=function(){return this.pathIter=0,this.setValuesFromIterator(),[this.x,this.y]},t.Missile.prototype.next=function(){return this.iteratorValid()?(--this.range,++this.pathIter,this.setValuesFromIterator(),!0):null},t.Missile.prototype.prev=function(){return this.iteratorValid()?(++this.range,--this.pathIter,this.setValuesFromIterator(),!0):null},t.Loot=function(e){l.ComponentBase.call(this,"Loot"),this._lootEntity=e},r.default.extend2(t.Loot,l.ComponentBase),l.Component.Loot=t.Loot,t.Loot.prototype.dropLoot=function(e){const t=this.getEntity().getLevel();if(this._lootEntity.getPropType){const s=this._lootEntity.getPropType();"elements"===s?this.setElemToCell(e):s===r.default.TYPE_ITEM?t.addItem(this._lootEntity,e.getX(),e.getY()):r.default.err("Component.Loot","dropLoot","Unsupported propType for entity: "+s)}else r.default.err("Loot","dropLoot","Loot has no propType!")},t.Loot.prototype.setElemToCell=function(e){const t=this.getEntity().getLevel();this._lootEntity.hasOwnProperty("useStairs")&&(r.default.debug(this,"Added stairs to "+e.getX()+", "+e.getY()),t.addStairs(this._lootEntity,e.getX(),e.getY()))},t.Loot.prototype.setLootEntity=function(e){this._lootEntity=e},t.Loot.prototype.toJSON=function(){const e=l.ComponentBase.prototype.toJSON.call(this),t=this._lootEntity.toJSON();return this._lootEntity.getPropType()===r.default.TYPE_ITEM?e.setLootEntity={createFunc:"createItem",value:t}:this._lootEntity.getPropType()===r.default.TYPE_ACTOR?e.setLootEntity={createFunc:"createActor",value:t}:r.default.err("Loot","toJSON","Only items/actors loot types are supported"),e},t.Communication=f("Communication",{msg:null}),t.Communication.prototype._init=function(){this.msg=[]},t.Communication.prototype.addMsg=function(e){this.msg.push(e)},t.Damaging=g("Damaging",{damage:1,damageType:""}),t.OneShot=E("OneShot"),t.Physical=p("Physical",{weight:1,size:1}),t.Ethereal=_("Ethereal",{description:"Ethereal beings cannot interact physically with others"}),t.Stun=g("Stun",{source:null}),t.Stun.prototype.toJSON=function(){const e=l.ComponentBase.prototype.toJSON.call(this);return r.default.isActorActive(this.source)&&(e.setSource=r.default.getObjRef("entity",this.source)),e},t.Stun.description="Stunning prevents some actions to be done",t.Paralysis=g("Paralysis",{source:null}),t.Paralysis.description="Paralysed actors cannot perform any actions",t.Paralysis.prototype.toJSON=function(){const e=l.ComponentBase.prototype.toJSON.call(this);return r.default.isActorActive(this.source)&&(e.setSource=r.default.getObjRef("entity",this.source)),e},t.Created=p("Created",{creator:null}),t.Created.prototype.toJSON=function(){const e=l.ComponentBase.prototype.toJSON.call(this);return e.setCreator=r.default.getObjRef("entity",this.creator),e},t.Named=p("Named",{name:"",uniqueName:""}),t.Named.prototype.prepend=function(e){this.name=e+this.name},t.Named.prototype.getBaseName=function(){return this.name},t.Named.prototype.getFullName=function(){return""!==this.uniqueName?`${this.uniqueName}, ${this.name}`:this.name};class C extends(o.DurationRoll(o.DamageRoll(l.ComponentBase))){constructor(){super("Poison"),this._src=null,this._prob=.05}getProb(){return this._prob}setProb(e){this._prob=e}getSource(){return this._src}setSource(e){this._src=e}copy(e){super.copy(e),this._prob=e.getProb(),this._src=e.getSource()}toJSON(){const e=super.toJSON();return e.setType=this.getType(),e.setProb=this._prob,r.default.isActorActive(this._src)&&(e.setSource=r.default.getObjRef("entity",this._src)),e}}t.Poison=C,C.description="Poison causes damage periodically until it stop",l.Component.Poison=C,t.Coldness=_("Coldness",{description:"Coldness will gradually freeze a non-resistant beings"}),t.Heat=_("Heat"),t.BodyTemp=p("BodyTemp",{temp:100,maxTemp:100,minTemp:-100}),t.BodyTemp.prototype.incr=function(){this.temp<this.maxTemp&&(this.temp+=1)},t.BodyTemp.prototype.decr=function(){this.temp>this.minTemp&&(this.temp-=1)},t.BodyTemp.prototype.isFreezing=function(){return this.temp<=0},t.BodyTemp.prototype.isFrozen=function(){return this.temp===this.minTemp},t.Owned=p("Owned",{owner:null}),t.Stolen=_("Stolen"),t.Unpaid=_("Unpaid"),t.Breakable=E("Breakable"),t.Indestructible=E("Indestructible"),t.Ammo=_("Ammo"),t.Flying=_("Flying",{description:"Flying beings can avoid difficult terrain and obstacles"}),t.Undead=_("Undead"),t.Summoned=_("Summoned"),t.Sharpener=_("Sharpener",{description:"You can sharpen weapons (once per weapoon"}),t.Sharpened=_("Sharpened"),t.Possessed=_("Possessed"),t.Flame=f("Flame",{damageType:"",damage:1,source:null}),t.Weakness=g("Weakness",{effect:"",level:r.default.WEAKNESS.MINOR},{description:"Weakness increases damage from attacks of that type"}),t.Resistance=g("Resistance",{effect:"",level:r.default.RESISTANCE.MINOR},{description:"Resistance reduces damage from attacks of that type"}),t.Magical=E("Magical"),t.NonSentient=E("NonSentient"),t.ActorClass=function(){l.ComponentBase.call(this,"ActorClass"),this._class=null,this._className=null,this.setClassName=(e=>{this._className=e}),this.getClassName=(()=>this._className),this.getClass=(()=>this._class),this.setActorClass=(e=>{this._class=e})},r.default.extend2(t.ActorClass,l.ComponentBase),l.Component.ActorClass=t.ActorClass,t.ActorClass.prototype.toJSON=function(){const e=S.toJSON.call(this);return e.setActorClass={createFunc:"createActorClass",value:{className:this._className,actorRef:r.default.getObjRef("entity",this.getEntity())}},e},t.Defender=E("Defender",{description:"Grants a minor defense (Def) bonus"}),t.Attacker=E("Attacker",{description:"Grants a minor attack (Att) bonus"}),t.BiDirStrike=E("BiDirStrike",{description:"You can attack to 2 opposite directions"}),t.CounterAttack=E("CounterAttack",{desciption:"You perform a counterattack when attacked by enemies"}),t.Ambidexterity=E("Ambidexterity"),t.LongReach=E("LongReach"),t.FirstStrike=E("FirstStrike",{description:"You can hit enemies first before they attack you"}),t.MasterEquipper=g("MasterEquipper",{factor:.5}),t.BypassProtection=g("BypassProtection",{chance:0}),t.Charm=g("Charm",{level:1,targetActor:r.default.NO_TARGET}),t.Climber=E("Climber"),t.Jumper=p("Jumper",{jumpRange:2}),t.Camouflage=E("Camouflage"),t.SnowWalk=E("SnowWalk"),t.Amphibious=E("Amphibious"),t.EagleEye=_("EagleEye",{description:"Grants bonus to missile range and visibility"}),t.StrongShot=_("StrongShot",{description:"Strength (Str) adds extra damage to missile attacks"}),t.ThroughShot=_("ThroughShot",{description:"You can shoot through enemies to hit another target"}),t.MixedShot=_("MixedShot",{description:"Allows mixing of ammo from different type of weapons"}),t.LongRangeShot=_("LongRangeShot",{description:"Doubles missile attack range"}),t.RangedEvasion=_("RangedEvasion",{description:"Grants 50% chance to evade missile/ranged spell attacks"}),t.CriticalShot=_("CriticalShot"),t.DoubleShot=_("DoubleShot"),t.SpellPower=p("SpellPower",{PP:10,maxPP:10}),t.SpellPower.prototype.addPP=function(e){this.PP+=e,this.PP>this.maxPP&&(this.PP=this.maxPP)},t.SpellPower.prototype.decrPP=function(e){this.PP-=e},t.SpellPower.prototype.hasPower=function(){return this.PP>0},t.SpellPower.prototype.canCast=function(e){return this.PP>=e},t.PowerDrain=g("PowerDrain",{drainDist:5}),t.PowerDrain.description="Counters any spell cast near you, gives you power and then disappears",t.SpellBase=function(e){l.ComponentBase.call(this,e);let t=null,s=null,a=null;this.getSpell=(()=>t),this.setSpell=(e=>{t=e}),this.getSource=(()=>s),this.setSource=(e=>{s=e}),this.getArgs=(()=>a),this.setArgs=(e=>{a=e})},r.default.extend2(t.SpellBase,l.ComponentBase),t.SpellCast=function(){t.SpellBase.call(this,"SpellCast")},r.default.extend2(t.SpellCast,t.SpellBase),t.SpellRay=function(){t.SpellBase.call(this,"SpellRay")},r.default.extend2(t.SpellRay,t.SpellBase),t.SpellMissile=function(){t.SpellBase.call(this,"SpellMissile")},r.default.extend2(t.SpellMissile,t.SpellBase),t.SpellCell=function(){t.SpellBase.call(this,"SpellCell")},r.default.extend2(t.SpellCell,t.SpellBase),t.SpellArea=function(){t.SpellBase.call(this,"SpellArea")},r.default.extend2(t.SpellArea,t.SpellBase),t.SpellSelf=function(){t.SpellBase.call(this,"SpellSelf")},r.default.extend2(t.SpellSelf,t.SpellBase),t.SpellStop=E("SpellStop"),t.NourishedOne=E("NourishedOne",{description:"You gain triple amount of energy from food"}),t.SpiritBind=f("SpiritBind",{binder:null,target:null}),t.GemBound=p("GemBound",{gem:null}),t.GemBound.prototype.toJSON=function(){return{setID:this.getID(),setType:"GemBound",setGem:{createFunc:"createItem",value:this.getGem().toJSON()}}},t.SpiritItemCrafter=E("SpiritItemCrafter",{description:"Grants ability to bind gems to items such as weapons/armour"}),t.Skills=function(){l.ComponentBase.call(this,"Skills"),this._isUnique=!0,this._skills={},this.hasSkill=(e=>this._skills.hasOwnProperty(e)),this.addSkill=(e=>{this._skills[e]={name:e,level:1,points:0}}),this.getLevel=(e=>this.hasSkill(e)?this._skills[e].level:0),this.setLevel=((e,t)=>{this._skills[e].level=t}),this.getPoints=(e=>this._skills[e].points),this.resetPoints=(e=>{this._skills[e].points=0}),this.addPoints=((e,t)=>{this.hasSkill(e)&&(this._skills[e].points+=t)}),this.getSkills=(()=>this._skills),this.setSkills=(e=>{this._skills=e}),this.toJSON=(()=>({setID:this.getID(),setType:this.getType(),setSkills:this._skills}))},r.default.extend2(t.Skills,l.ComponentBase),l.Component.Skills=t.Skills,t.SkillsExp=f("SkillsExp",{skill:"",points:0}),t.Shopkeeper=p("Shopkeeper",{levelID:-1,cells:null,doorXY:null}),t.Shopkeeper._init=function(){this.cells=[]},t.Transaction=f("Transaction",{args:null}),t.InBattle=function(){l.ComponentBase.call(this,"InBattle"),this._isUnique=!0;let e=null;this.setData=(t=>{e=t}),this.getData=(()=>e),this.updateData=(t=>{e=Object.assign(e||{},t)})},r.default.extend2(t.InBattle,l.ComponentBase),l.Component.InBattle=t.InBattle,t.BattleExp=function(){l.ComponentBase.call(this,"BattleExp");let e=null;this.setData=(t=>{e=t}),this.getData=(()=>e),this.updateData=(t=>{e=Object.assign(e||{},t)})},r.default.extend2(t.BattleExp,l.ComponentBase),l.Component.BattleExp=t.BattleExp,t.BattleOver=E("BattleOver"),t.BattleBadge=function(){l.ComponentBase.call(this,"BattleBadge");let e=null;this.setData=(t=>{e=t}),this.getData=(()=>e),this.updateData=(t=>{e=Object.assign(e,t)}),this.isWon=(()=>"Won"===e.status),this.isLost=(()=>"Lost"===e.status)},r.default.extend2(t.BattleBadge,l.ComponentBase),l.Component.BattleBadge=t.BattleBadge,t.BattleOrder=g("BattleOrder",{args:null}),t.Commander=_("Commander"),t.Reputation=function(){l.ComponentBase.call(this,"Reputation");let e=null;this.setData=(t=>{e=t}),this.getData=(()=>e),this.updateData=(t=>{e=Object.assign(e,t)}),this.addToFame=(t=>{e||(e={}),e.hasOwnProperty("fame")?e.fame+=t:e.fame=t})},r.default.extend2(t.Reputation,l.ComponentBase),l.Component.Reputation=t.Reputation,t.Event=f("Event",{args:null}),t.Event.prototype._init=function(e){this.args=e},t.Effects=f("Effects",{args:null,effectType:""}),t.Effects.prototype._init=function(e){this.args=e||{}},t.PlayerControlled=E("PlayerControlled"),t.Player=E("Player"),t.AddOnHit=g("AddOnHit",{comp:null,onDamage:!0,onAttackHit:!1}),t.AddOnHit.prototype.toJSON=function(){const e=this.comp.toJSON();return{setID:this.getID(),setType:this.getType(),setComp:{createComp:e},setOnDamage:this.onDamage,setOnAttackHit:this.onAttackHit}},t.Equip=f("Equip",{args:null,item:null,isRemove:!1}),t.AddOnEquip=g("AddOnEquip",{comp:null,addedToActor:!1}),t.AddOnEquip.prototype.toJSON=function(){const e={setID:this.getID(),setType:this.getType(),setAddedToActor:this.addedToActor};if(this.addedToActor)e.setComp={createComp:this.comp};else{const t=this.comp.toJSON();e.setComp={createComp:t}}return e},t.RegenEffect=g("RegenEffect",{PP:1,HP:1,waitPP:30,waitHP:30,maxWaitPP:60,maxWaitHP:60}),t.Telepathy=g("Telepathy",{target:null,source:null},{description:"Grants ability to see through eyes of another being"}),t.Telepathy.prototype.toJSON=function(){const e={setID:this.getID(),setType:this.getType()};return r.default.isActorActive(this.target)&&(e.setTarget=r.default.getObjRef("entity",this.target)),r.default.isActorActive(this.source)&&(e.setSource=r.default.getObjRef("entity",this.source)),e},t.Animation=f("Animation",{args:null}),t.Animation.prototype._init=function(e){this.args=e},t.addToExpirationComp=((e,s,a,n)=>{if(e.has("Expiration"))e.get("Expiration").addEffect(s,a,n);else{const r=new t.Expiration;r.addEffect(s,a,n),e.add(r)}e.has(s)||e.add(s)}),t.Give=f("Give",{giveTarget:null,item:null}),t.Jump=f("Jump",{x:-1,y:-1}),t.OpenDoor=f("OpenDoor",{door:null}),t.Pickup=y("Pickup"),t.Read=f("Read",{readTarget:null}),t.Rest=y("Rest"),t.UseElement=f("UseElement",{element:null,useType:""}),t.UseItem=f("UseItem",{item:null,useType:"",target:null,targetType:null,effect:null}),t.UseStairs=y("UseStairs"),t.GameInfo=p("GameInfo",{data:null}),t.GameInfo.prototype._init=function(){this.data={zones:{}}},t.GameInfo.prototype.updateData=function(e){const t=this.data;this.data=Object.assign(t,e)},t.GameInfo.prototype.addZone=function(e){this.data.zones[e]=!0},t.GameInfo.prototype.hasZone=function(e){return this.data.zones[e]},t.GameInfo.prototype.addZoneType=function(e){const t=this.data;t.zones.hasOwnProperty(e)?t.zones[e]+=1:t.zones[e]=1,this.data=t},t.Fading=g("Fading",{duration:0}),t.Fading.prototype.decrDuration=function(){this.duration-=1},t.Expiration=g("Expiration",{duration:null,expireMsg:null}),t.Expiration.prototype._init=function(){this.expireMsg={}},t.Expiration.prototype.addEffect=function(e,t,s){this.duration||(this.duration={});const a=e.getID();this.duration.hasOwnProperty(a)?this.duration[a]+=t:(this.duration[a]=t,e.addCallback("onRemove",()=>{this.removeEffect(e)})),s&&(this.expireMsg||(this.expireMsg={}),this.expireMsg[a]=s)},t.Expiration.prototype.decrDuration=function(){for(const e in this.duration){const t=parseInt(e,10);if(t>=0&&(this.duration[t]-=1,0===this.duration[t])){const e=this.getEntity();if(this.expireMsg&&this.expireMsg[t]){const s=this.expireMsg[t];r.default.gameMsg({cell:e.getCell(),msg:s})}else{const t="An effect wears of from "+e.getName();r.default.gameMsg({cell:e.getCell(),msg:t})}e.remove(t),delete this.duration[t]}}},t.Expiration.prototype.hasEffects=function(){return Object.keys(this.duration).length>0},t.Expiration.prototype.hasEffect=function(e){const t=e.getID();return this.duration.hasOwnProperty(t)},t.Expiration.prototype.removeEffect=function(e){const t=e.getID();this.duration.hasOwnProperty(t)&&delete this.duration[t],this.expireMsg&&this.expireMsg.hasOwnProperty(t)&&delete this.expireMsg[t]},t.Expiration.prototype.cleanup=function(){const e=this.getEntity();Object.keys(this.duration).forEach(t=>{e.remove(parseInt(t,10))})};class b extends(o.DurationRoll(l.ComponentBase)){constructor(){super("Duration"),this._comp=null,this._source=null,this._addedOnActor=!1}setSource(e){this._source=e}getSource(){return this._source}setComp(e){if(this._comp=e,!this._addedOnActor){const e=()=>{this.getEntity().add(this._comp),this._comp.setSource&&this._source&&this._comp.setSource(this._source),this._comp=this._comp.getID(),this._addedOnActor=!0,this.removeCallbacks("onAdd")};this.addCallback("onAdd",e)}this.addCallback("onRemove",()=>{this.getEntity().has(this._comp)&&this.getEntity().remove(this._comp)})}getComp(){return this._comp}copy(e){super.copy(e);const t=e.getComp().clone();this.setComp(t)}clone(){const e=super.clone();return e.copy(this),e}setAddedOnActor(e){this._addedOnActor=e}getAddedOnActor(){return this._addedOnActor}toJSON(){const e=super.toJSON();if(r.default.isActorActive(this._source)&&(e.setSource=r.default.getObjRef("entity",this._source)),this._addedOnActor)return Object.assign(e,{setAddedOnActor:!0,setComp:this._comp});{const t=this._comp.toJSON();return Object.assign(e,{setComp:{createComp:t}})}}}t.Duration=b,l.Component.Duration=b;t.QuestGiver=p("QuestGiver",{hasGivenQuest:!1,descr:"",questID:-1,danger:1,reward:-1,hasGivenReward:!1,questTargets:null}),t.QuestGiver.prototype._init=function(e){this.chatObj=new i.ChatQuest,this.descr=e,this.questID=this.getID(),this.questTargets=[];this.addCallback("onAdd",()=>{this.chatObj.setQuestGiver(this.getEntity())})},t.QuestGiver.prototype.hasReward=function(){return this.reward&&-1!==this.reward},t.QuestGiver.prototype.giveQuest=function(e){e?(this.questGivenTo=e,this.hasGivenQuest=!0):this.hasGivenQuest=!1},t.QuestGiver.prototype.addTarget=function(e,t){t||r.default.err("QuestGiver","addTarget",`No target given. Type ${e}`);const s=r.default.getName(t);if(r.default.isEmpty(s))r.default.err("QuestGiver","addTarget",`Empty name got for target ${JSON.stringify(t)}`);else{const a={id:t.getID(),name:s,targetType:e,subQuestID:-1},n=t.get("QuestTarget");-1!==n.getSubQuestID()&&(a.subQuestID=n.getSubQuestID()),this.questTargets.push(a)}},t.QuestGiver.prototype.toJSON=function(){const e=S.toJSON.call(this);return this.questGivenTo&&(e.giveQuest=r.default.getObjRef("entity",this.questGivenTo)),e},t.QuestGiver.prototype.getChatObj=function(){return this.chatObj},t.QuestTarget=g("QuestTarget",{targetType:"",target:null,isCompleted:!1,targetID:-1,questID:-1,subQuestID:-1}),t.QuestTarget.prototype.isKill=function(){return"kill"===this.targetType},t.QuestTarget.prototype.toString=function(){let e="";if(this.target.getName)e=this.target.getName();else if(this.target.getParent){const t=this.target.getParent();if(t&&(e=t.getName()),t.getParent){e+=" of "+t.getParent().getName()}}return`${this.targetType} ${e}`},t.QuestTarget.prototype.toJSON=function(){const e=S.toJSON.call(this);return e.setTargetType=this.targetType,this.target.$objID?e.setTarget=r.default.getObjRef("object",this.target):e.setTarget=r.default.getObjRef("entity",this.target),e},t.QuestEscortTarget=g("QuestEscortTarget",{escortTo:-1,question:"Can I help you safely somewhere?"}),t.QuestEscortTarget.prototype.toJSON=function(){const e=S.toJSON.call(this);return e.setEscortTo=r.default.getObjRef("entity",this.escortTo),e},t.Quest=g("Quest",{giver:null,questTargets:null,questID:-1,descr:""}),t.Quest.prototype._init=function(){this.questTargets=[]},t.Quest.prototype.addTarget=function(e){this.questTargets.push(e)},t.Quest.prototype.isInThisQuest=function(e){return this.getQuestID()===e.getQuestID()},t.Quest.prototype.getTargetsByType=function(e){return this.questTargets.filter(t=>t.targetType===e)},t.Quest.prototype.first=function(e){const t=this.questTargets.find(t=>t.targetType===e);return t||null},t.Quest.prototype.isCompleted=function(){return this.questTargets.reduce((e,t)=>e&&t.isCompleted,!0)},t.Quest.prototype.isTargetInQuest=function(e){const t=e.getTarget();for(let e=0;e<this.questTargets.length;e++){if(this.questTargets[e].id===t.getID())return!0}return!1},t.Quest.prototype.toString=function(){let e="";return this.questTargets.forEach((t,s)=>{s>0&&(e+=". "),"subquest"===t.targetType?e+="Talk to "+t.name:e+=t.targetType+" "+t.name}),e},t.QuestInfo=g("QuestInfo",{question:"",info:"",givenBy:-1}),t.QuestReport=g("QuestReport",{expectInfoFrom:-2}),t.QuestCompleted=f("QuestCompleted",{giver:null}),t.GiveQuest=f("GiveQuest",{target:null,giver:null}),t.QuestTargetEvent=f("QuestTargetEvent",{targetComp:null,args:null,eventType:""}),t.QuestTargetEvent.prototype.setTargetComp=function(e){r.default.assertType(e,"QuestTarget"),this.targetComp=e},t.Weather=g("Weather",{weatherType:"clear"}),t.WeatherEffect=f("WeatherEffect",{effectType:"clear"}),t.Indoor=E("Indoor"),t.Snowy=E("Snowy"),t.Entrapping=p("Entrapping",{difficulty:1,destroyOnMove:!1}),t.Entrapped=E("Entrapped"),t.Lore=p("Lore",{topics:null}),t.Lore.prototype.addTopic=function(e,t){this.topics[e]||(this.topics[e]=[]),this.topics[e].push(t)},t.Lore.prototype._init=function(){this.topics={}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=a(s(12)),i=s(27),l=s(15),c=s(75),h=s(35),u=s(76),d=s(77),g=s(45),p=s(125),m=s(3),f=s(9),y=s(1),_=s(127),E=s(128),S=s(129),v=s(130),C=n(s(5)),b=C.ElementMarker,T=y.Random.getRNG(),A=function(e,t,s){return e>=t&&e<=s},w=function(e,t,s,a,n){let r=!0;if(n.exclude){if(n.exclude.bbox){const{ulx:o,uly:i,lrx:l,lry:c}=n.exclude.bbox;A(e,o,l)&&A(t,i,c)&&(r=!1),A(s,o,l)&&A(a,i,c)&&(r=!1)}}else n.maxY&&(r=a<=n.maxY);return r};class O{static getAndSetRNG(e){if(e){if(e.rng)return e.rng;e.rng=T}return T}static addRandomSnow(e,t,s){const a=e.getFree().filter(e=>e.isOutdoors()),n=O.getAndSetRNG(s);for(let e=0;e<a.length;e++){const s=n.getUniform(),r=a[e];if(s<=t){const t=r.getBaseElem().getType();let s=O.snowElemMap.default;O.snowElemMap[t]&&(s=O.snowElemMap[t]),a[e].setBaseElem(s)}}}static fromAsciiMap(e,t){const s=e.length,a=e[0].length,n=new i.CellMap(s,a);for(let r=0;r<s;r++)for(let s=0;s<a;s++){const a=e[r][s];if("+"===a){const e=new C.ElementMarker("+");e.setTag("door"),n.setBaseElemXY(r,s,t["."]),n.setElemXY(r,s,e)}else if(t.hasOwnProperty(a)){const e=t[a];"function"!=typeof e?n.setBaseElemXY(r,s,e):e(n,r,s)}}return{map:n}}static getWallElem(e){switch(e){case"cave":case"wallcave":return f.ELEM.WALL_CAVE;case"castle":case"wallcastle":return f.ELEM.WALL_CASTLE;case"crypt":case"wallcrypt":return f.ELEM.WALL_CRYPT;case"ice":case"wallice":return f.ELEM.WALL_ICE;case"wooden":case"wallwooden":return f.ELEM.WALL_WOODEN;default:return f.ELEM.WALL}}static getFloorElem(e){switch(e){case"cave":case"floorcave":return f.ELEM.FLOOR_CAVE;case"castle":case"floorcastle":return f.ELEM.FLOOR_CASTLE;case"crypt":case"floorcrypt":return f.ELEM.FLOOR_CRYPT;case"ice":case"floorice":return f.ELEM.FLOOR_ICE;case"wooden":case"floorwooden":return f.ELEM.FLOOR_WOODEN;default:return f.ELEM.FLOOR}}static createSplashes(e,t,s){const a=s.elem||f.ELEM.WATER,n=new i.CellMap(e,t);return new _.MapForest(e,t,s).create((e,t,s)=>{n.setBaseElemXY(e,t,f.ELEM.FLOOR),1===s&&n.setBaseElemXY(e,t,a)}),{map:n}}static getOptions(e){return O.options[e]?Object.assign({},O.options[e]):(r.default.warn("MapGenerator","getOptions",`Unknown map type ${e}`),{})}constructor(){this.cols=r.default.LEVEL_MEDIUM_X,this.rows=r.default.LEVEL_MEDIUM_Y,this._mapGen=new o.default.Map.Arena(this.cols,this.rows),this._mapType=null,this._wall=1,this.defaultMapElem=f.ELEM.FLOOR}createEmptyMap(){return{map:new i.CellMap(this.cols,this.rows,this.defaultMapElem)}}getMap(e={}){const t={};if("function"==typeof this._mapGen)t.map=this._mapGen();else{const s=O.getWallElem(e.wallType),a=O.getFloorElem(e.floorType),n=new i.CellMap(this.cols,this.rows,this.defaultMapElem);this._mapGen.create((e,t,r)=>{r===this._wall?n.setBaseElemXY(e,t,s):n.setBaseElemXY(e,t,a)}),t.map=n,"uniform"!==this._mapType&&"digger"!==this._mapType||(t.rooms=this._mapGen.getRooms(),t.corridors=this._mapGen.getCorridors())}return t}createRuins(e,t,s={}){let a={born:[4,5,6,7,8],survive:[2,3,4,5],connected:!0};a=Object.assign(a,s);const n=new o.default.Map.Cellular(e,t,a);n.randomize(.9);for(let e=0;e<5;e++)n.create();return n.connect(null,1),this._wall=0,n}createCellular(e,t){const s=new o.default.Map.Cellular(e,t,{connected:!0});s.randomize(.52);for(let e=0;e<5;e++)s.create();return s.connect(null,1),this._wall=0,s}createRooms(e,t){return new o.default.Map.Digger(e,t,{roomWidth:[5,20],dugPercentage:.7})}createTownBSP(e,t,s){const a=s.maxHouseX||100,n=s.maxHouseY||100,r=O.getAndSetRNG(s),o=new c.BSP.BSPGen({rng:r}),l=e-2,h=t-2,u=new c.BSP.Container(0,0,l,h),d=o.splitContainer(u,7).getLeafs();d.forEach(e=>{e.x+=1,e.y+=1}),r.shuffle(d);const g=O.getFloorElem(s.floorType),m=new i.CellMap(e,t,g),f=[],y=[],_=new p.HouseGenerator;return d.forEach(r=>{const{w:o,h:i}=r;let l=o-1,c=i-1;if(l>a&&(l=Math.round(l/2)),c>n&&(c=Math.round(c/2)),1===r.x?(r.x+=1,r.w-=1,l-=1):r.x===e-1&&(r.x-=1,r.w-=1,l-=1),1===r.y?(r.y+=1,r.h-=1,c-=1):r.y===t-1&&(r.y-=1,r.h-=1,c-=1),l>=5&&c>=5){l>10&&l%2!=0&&(l-=1),c>10&&c%2!=0&&(c-=1);const e={cols:l,rows:c};e.addWindows=s.addWindows;const t=_.createHouse(e);t&&(this.placeHouse(t,m,r.x,r.y,s),y.push(t))}else f.push(r)}),{map:m,houses:y,unused:f}}placeHouse(e,t,s,a,n){const r=e.coord,o=Object.keys(r),i=O.getWallElem(n.wallType);o.forEach(e=>{"#"===e?r[e].forEach(e=>{const n=e[0]+s,r=e[1]+a;t.setBaseElemXY(n,r,i)}):"+"===e||(":"===e?r[e].forEach(e=>{const n=e[0]+s,r=e[1]+a;t.setBaseElemXY(n,r,f.ELEM.FLOOR_HOUSE)}):"windows"===e&&r[e].forEach(e=>{const n=e[0]+s,r=e[1]+a;t.setBaseElemXY(n,r,f.ELEM.WINDOW)}))}),e.adjustCoord(s,a)}createForest(e){const t=new i.CellMap(this.cols,this.rows,this.defaultMapElem);return this.addForestToMap(t,e),{map:t}}addForestToMap(e,t){const s=t.ratio,{freeOnly:a}=t,n=O.getAndSetRNG(t);this._mapGen=new _.MapForest(this.cols,this.rows,t),a?this._mapGen.create((t,a,r)=>{const o=n.getUniform()<=s;1===r&&o?e.getCell(t,a).isFree()&&e.setBaseElemXY(t,a,f.ELEM.TREE):1===r&&e.getCell(t,a).isFree()&&e.setBaseElemXY(t,a,f.ELEM.GRASS)}):this._mapGen.create((t,a,r)=>{const o=n.getUniform()<=s;1===r&&o?e.setBaseElemXY(t,a,f.ELEM.TREE):1===r&&e.setBaseElemXY(t,a,f.ELEM.GRASS)})}createLakes(e){const t=new i.CellMap(this.cols,this.rows,this.defaultMapElem);return this._mapGen=new _.MapForest(this.cols,this.rows,e),this.addLakesToMap(t,e),{map:t}}addLakesToMap(e,t){t.freeOnly?this._mapGen.create((t,s,a)=>{1===a&&e.getCell(t,s).isFree()&&e.setBaseElemXY(t,s,f.ELEM.WATER)}):this._mapGen.create((t,s,a)=>{e.setBaseElemXY(t,s,f.ELEM.FLOOR),1===a&&e.setBaseElemXY(t,s,f.ELEM.WATER)})}addLakes(e,t,s){const a=s.lrx-s.ulx,n=s.lry-s.uly;this.setGen("lakes",a,n);const o=this.createLakes(t).map;r.default.forEach2D(o._map,(a,n)=>{const r=a+s.ulx,i=n+s.uly;if(m.Geometry.isInBbox(r,i,s)&&e.hasXY(r,i)){const s=o.getBaseElemXY(a,n);if("water"===s.getType())if(t.skipTypes){const a=e.getBaseElemXY(r,i).getType();t.skipTypes.hasOwnProperty(a)||e.setBaseElemXY(r,i,s)}else e.setBaseElemXY(r,i,s)}})}createWall(e,t,s){const a=new i.CellMap(e,t,this.defaultMapElem),n=s.wallElem||f.ELEM.WALL;return this._mapGen=new v.MapWall(e,t,s),this._mapGen.create((e,t,s)=>{1===s&&a.setBaseElemXY(e,t,n)}),{map:a}}createMountain(e,t,s){const a=new i.CellMap(e,t,this.defaultMapElem);s||(s=O.getOptions("mountain"));const n=O.getAndSetRNG(s);this._mapGen=new S.MapMountain(this.cols,this.rows,s),this._mapGen.create((e,t,r)=>{if(r>s.highRockThr)a.setBaseElemXY(e,t,f.ELEM.HIGH_ROCK);else if(r>s.stoneThr)a.setBaseElemXY(e,t,f.ELEM.STONE);else if(r<s.chasmThr)a.setBaseElemXY(e,t,f.ELEM.CHASM);else{n.getUniform()<s.snowRatio?a.setBaseElemXY(e,t,f.ELEM.SNOW):a.setBaseElemXY(e,t,f.ELEM.FLOOR)}});let r=[];return s.nRoadTurns>0&&(r=this.createMountainPath(a,s)),{map:a,paths:r}}createMountainPath(e,t){const s=[],a=t.nRoadTurns||10;let n=Math.floor(e.rows/a);t.yPerTurn&&(n=t.yPerTurn),n<4&&(n=4);const r=[2,e.cols-3,Math.floor(e.cols/2)];let o=!0,i=-1,c=-1;const u=[(t,s)=>e.hasXY(t,s)&&e.getCell(t,s).isFree(),(t,s)=>e.hasXY(t,s)&&"highrock"!==e.getCell(t,s).getBaseElem().getType()],d=O.getAndSetRNG(t);for(let g=0;o&&g<a;g++){o=!1;let a=i,p=c;0===g&&(a=Number.isInteger(t.startX)?t.startX:d.arrayGetRand(r),p=t.startY?t.startY:0);const m=d.arrayGetRand(r),f=(g+1)*n+p;if(w(a,p,m,f,t)){const t=l.Path.getMinWeightOrShortest(e,a,p,m,f,u);if(t){const a=h.Builder.addPathToMap(e,t);a.length>0&&(o=!0),s.push(a),i=m,c=f}else o=!0}else o=!0}if(t.maxY&&s.length>0){const a=s[s.length-1];if(a.length>0){const n=a[a.length-1],[o,i]=[n.x,n.y];let c=d.arrayGetRand(r);const g=t.maxY;if(t.endX&&(c=t.endX),g>i&&w(o,i,c,g,t)){const t=l.Path.getMinWeightOrShortest(e,o,i,c,g,u);if(t){const a=h.Builder.addPathToMap(e,t);s.push(a)}}}}return s}createSummit(e,t,s){const a=new i.CellMap(e,t,f.ELEM.SKY),n=s.ratio||.3;let[r,o]=[Math.floor(e/2),Math.floor(t/2)];const l=e*t,c=[[r,o]];a.setBaseElemXY(r,o,f.ELEM.FLOOR);let h=1;const u=O.getAndSetRNG(s);let d=1e4;for(;h/l<n;){[r,o]=u.arrayGetRand(c);const[e,t]=u.getRandDir();if(r+=e,o+=t,a.hasXY(r,o)&&"sky"===a.getBaseElemXY(r,o).getType()&&(c.push([r,o]),++h,a.setBaseElemXY(r,o,f.ELEM.FLOOR)),--d<=0)break}return{map:a}}createCave(e,t,s){this._mapGen=new E.MapMiner(e,t,s);const a=new i.CellMap(e,t,this.defaultMapElem),n=s.wallElem||f.ELEM.WALL_CAVE,r=s.floorElem||f.ELEM.FLOOR_CAVE;return this._mapGen.create((e,t,s)=>{1===s?a.setBaseElemXY(e,t,n):a.setBaseElemXY(e,t,r)}),{map:a,mapGen:this._mapGen}}createCryptNew(e,t,s={}){const a=s.tilesX||12,n=s.tilesY||7,r=new u.TemplateLevel(a,n);r.use(d.Crypt);const o=s.genParams||[2,2,2,2],i=s.roomCount||40;r.setGenParams(o),r.setRoomCount(i),r.create();const l={"#":f.ELEM.WALL_CRYPT,".":f.ELEM.FLOOR_CRYPT},c=O.fromAsciiMap(r.map,l);return c.tiles=r.getPlacedData(),c}createCastle(e,t,s={}){const a=s.genParams||[1,1,1,1],n=5+a[0]+a[1],r=5+a[2]+a[3],o=s.tilesX||Math.ceil(e/n),i=s.tilesY||Math.ceil(t/r),l=new u.TemplateLevel(o,i);l.use(g.Castle),s.models||s.templates?"string"==typeof s.models?l.setTemplates(g.Castle.Models[s.models]):"string"==typeof s.templates?l.setTemplates(g.Castle.templates[s.templates]):l.setTemplates(s.models):l.setTemplates(g.Castle.Models.full),2===s.nGates?l.setStartRoomFunc(g.Castle.startFuncTwoGates):s.startRoomFunc&&l.setStartRoomFunc(s.startRoomFunc),s.constraintFunc&&l.setConstraintFunc(s.constraintFunc);const c=s.roomCount||40;return l.setGenParams(a),l.setRoomCount(c),s.callbacks&&Object.keys(s.callbacks).forEach(e=>{l.addCallback(e,s.callbacks[e])}),l.create(),this.createCastleMapObj(l,s)}createCastleWall(e,t,s={}){const a=s.tilesX||Math.ceil(e/7),n=s.tilesY||Math.ceil(t/7),r=new u.TemplateLevel(a,n);r.use(g.Castle),r.setTemplates(g.Castle.Models.outerWall),r.setFiller(g.Castle.tiles.fillerFloor),2===s.nGates?r.setStartRoomFunc(g.Castle.startFuncTwoGates):s.startRoomFunc&&r.setStartRoomFunc(s.startRoomFunc),s.constraintFunc&&r.setConstraintFunc(s.constraintFunc),r.create();const o={"#":O.getWallElem(s.wallType),".":O.getFloorElem(s.floorType)},i=O.fromAsciiMap(r.map,o);return i.tiles=r.getPlacedData(),i}createCastleMapObj(e,t){const s={"#":O.getWallElem(t.wallType),".":O.getFloorElem(t.floorType),"&":(e,s,a)=>{if(e.setBaseElemXY(s,a,O.getFloorElem(t.floorType)),t.preserveMarkers){const t=new b("&");t.setTag("lever"),e.getCell(s,a).setProp(r.default.TYPE_ELEM,t)}},"|":(e,s,a)=>{if(e.setBaseElemXY(s,a,O.getFloorElem(t.floorType)),t.preserveMarkers){const t=new b("|");t.setTag("leverdoor"),e.getCell(s,a).setProp(r.default.TYPE_ELEM,t)}},":":(e,s,a)=>{if(e.setBaseElemXY(s,a,f.ELEM.FLOOR_HOUSE),t.preserveMarkers){const t=new b(":");t.setTag("living_quarter"),e.getCell(s,a).setProp(r.default.TYPE_ELEM,t)}}},a=O.fromAsciiMap(e.map,s);return a.tiles=e.getPlacedData(),a}createTownWithWall(e,t,s={}){const a=Math.ceil(e/7),n=Math.ceil(t/7),r=this.createCastleWall(e,t,s);s.levelType="empty";const o=7*(a-2),i=7*(n-2),l=this.createTownBSP(o,i,s),c=r.map;m.Geometry.mergeMapBaseElems(c,l.map,7,7);const h=l.houses;h.forEach(e=>{e.moveHouse(7,7)});const u=l.unused;return u&&u.forEach(e=>{e.x+=7,e.y+=7}),{map:c,houses:h,unused:u,tiles:r.tiles}}createArctic(e,t,s={}){const a=s.snowRatio||1;this.setGen("empty",e,t);const n=new i.CellMap(e,t,this.defaultMapElem);return O.addRandomSnow(n,a),{map:n}}setGen(e,t,s){switch(this.cols=t,this.rows=s,e=e.toLowerCase(),this._mapType=e,e){case"arctic":this._mapGen=new o.default.Map.Dungeon(t,s);break;case"arena":this._mapGen=new o.default.Map.Arena(t,s);break;case"cave":this._mapGen=new E.MapMiner(t,s);break;case"cellular":this._mapGen=this.createCellular(t,s);break;case"castle":break;case"crypt":this._mapGen=new o.default.Map.Uniform(t,s);break;case"digger":this._mapGen=new o.default.Map.Digger(t,s);break;case"divided":this._mapGen=new o.default.Map.DividedMaze(t,s);break;case"dungeon":this._mapGen=new o.default.Map.Rogue(t,s);break;case"empty":this._mapGen=new o.default.Map.Dungeon(t,s);break;case"eller":this._mapGen=new o.default.Map.EllerMaze(t,s);break;case"forest":case"lakes":this._mapGen=new _.MapForest(t,s);break;case"labyrinth":this._mapGen=new o.default.Map.DividedMaze(t,s);break;case"miner":this._mapGen=new E.MapMiner(t,s);break;case"mountain":this._mapGen=new S.MapMountain(t,s);break;case"icey":this._mapGen=new o.default.Map.IceyMaze(t,s);break;case"rogue":this._mapGen=new o.default.Map.Rogue(t,s);break;case"uniform":this._mapGen=new o.default.Map.Uniform(t,s);break;case"ruins":this._mapGen=this.createRuins(t,s);break;case"rooms":this._mapGen=this.createRooms(t,s);break;case"town":this._mapGen=new o.default.Map.Arena(t,s);break;case"townwithwall":case"summit":break;case"wall":this._mapGen=new v.MapWall(t,s);break;default:r.default.err("MapGen","setGen","this._mapGen type "+e+" is unknown")}}}t.MapGenerator=O,O.options={},O.options.mountain=Object.freeze({noiseMult:1,noiseDivider:20,highRockThr:.75,stoneThr:.5,chasmThr:-.4,nRoadTurns:8,snowRatio:0}),O.snowElemMap={floor:f.ELEM.SNOW_LIGHT,"light snow":f.ELEM.SNOW,"light snow with tracks":f.ELEM.SNOW,snow:f.ELEM.SNOW_DEEP,"snow with tracks":f.ELEM.SNOW,tree:f.ELEM.TREE_SNOW,"snow-covered tree":f.ELEM.TREE_SNOW,water:f.ELEM.WATER_FROZEN,"frozen water":f.ELEM.WATER_FROZEN,grass:f.ELEM.GRASS_SNOW,"snowy grass":f.ELEM.GRASS_SNOW,"deep snow":f.ELEM.SNOW_DEEP,"deep snow with tracks":f.ELEM.SNOW_DEEP},O.snowMeltMap={"light snow":f.ELEM.FLOOR,"light snow with tracks":f.ELEM.FLOOR,snow:f.ELEM.SNOW_LIGHT,"snow with tracks":f.ELEM.SNOW_LIGHT,"snow-covered tree":f.ELEM.TREE,"frozen water":f.ELEM.WATER,"snowy grass":f.ELEM.GRASS,"deep snow":f.ELEM.SNOW,"deep snow with tracks":f.ELEM.SNOW}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(12));t.Path={};const r=Object.freeze([]);function o(e,t,s,a){for(let n=e-1;n<=e+1;n++)for(let e=t-1;e<=t+1;e++)if(s.hasXY(n,e)&&a(n,e))return!1;return!0}function i(e){e.length>1&&(e.shift(),e.pop())}t.Path.getShortestPath=function(e,t,s,a,r=(()=>!0)){const o=[],i=r;return new n.default.Path.AStar(s,a,i).compute(e,t,(e,t)=>{o.push({x:e,y:t})}),o},t.Path.getShortestSeenPath=function(e,t,s,a){const l=e.getBrain().getSeenCells(),c={};l.forEach(e=>{c[e.getKeyXY()]=e});const h=(e,n)=>!!c.hasOwnProperty(e+","+n)&&(t.isPassable(e,n)||e===u&&n===d||e===s&&n===a),[u,d]=e.getXY();if(o(u,d,t,h))return r;const g=[];return new n.default.Path.AStar(s,a,h).compute(u,d,(e,t)=>{g.push({x:e,y:t})}),i(g),g},t.Path.getShortestPassablePath=function(e,t,s,a,r){const o=[];return new n.default.Path.AStar(a,r,(t,s)=>e.isPassable(t,s)).compute(t,s,(e,t)=>{o.push({x:e,y:t})}),o},t.Path.getActorToActorPath=function(e,t,s,a,l){const c=[],h=(n,r)=>!!e.hasXY(n,r)&&(e.isPassable(n,r)||n===t&&r===s||n===a&&r===l);return o(t,s,e,h)?r:(new n.default.Path.AStar(a,l,h).compute(t,s,(e,t)=>{c.push({x:e,y:t})}),i(c),c)},t.Path.getShortestActorPath=function(e,t,s,a,i,l){const c=[],h=(a,n)=>!!e.hasXY(a,n)&&(l?l(a,n)||a===t&&n===s:e.isPassable(a,n)||a===t&&n===s);return o(t,s,e,h)?r:(new n.default.Path.AStar(a,i,h).compute(t,s,(e,t)=>{c.push({x:e,y:t})}),function(e){e.length>0&&e.shift()}(c),c)},t.Path.getShortestPassablePathWithDoors=function(e,t,s,a,r){const o=[];return new n.default.Path.AStar(a,r,(t,s)=>!!e.hasXY(t,s)&&(e.isPassable(t,s)||e.getCell(t,s).hasDoor())).compute(t,s,(e,t)=>{o.push({x:e,y:t})}),o},t.Path.shortestDist=function(e,s,a,n){return t.Path.getShortestPath(e,s,a,n).length-1},t.Path.getPathWeight=((e,t)=>{let s=0;return t.forEach(t=>{if(e.hasXY(t.x,t.y)){switch(e.getBaseElemXY(t.x,t.y).getType()){case"floor":s+=1;break;case"forest":case"stone":s+=2;break;case"water":case"highrock":s+=4;break;case"chasm":s+=5;break;case"wall":s+=20;break;default:s+=0}}}),s}),t.Path.getMinWeightPath=function(e,s,a,n,r,o){let i=[];i=o?o(e,s,a,n,r):t.Path.getShortestPassablePath(e,s,a,n,r);const l=t.Path.getShortestPath(s,a,n,r),c=t.Path.getPathWeight(e,i),h=t.Path.getPathWeight(e,l);let u=null;return u=0===i.length?l:c>=h?l:i},t.Path.getMinWeightOrShortest=function(e,s,a,n,r,o){const i=t.Path.getShortestPath(s,a,n,r),l=[];o.forEach(e=>{const o=t.Path.getShortestPath(s,a,n,r,e);o.length>0&&l.push(o)}),l.push(i);let c=null,h=-1;return l.forEach(s=>{const a=t.Path.getPathWeight(e,s);(-1===h||a<h)&&(h=a,c=s)}),c},t.Path.getWeightPathSegmented=function(e,s,a,n,r,o,i){const l=n-s,c=r-a,h=t.Path.getPathSeg(l,o),u=t.Path.getPathSeg(c,o);let d=[],[g,p]=[s,a];for(let s=0;s<o;s++){const[a,n]=[g+h[s],p+u[s]],r=t.Path.getMinWeightPath(e,g,p,a,n,i);[g,p]=[a,n],d=d.concat(r)}return d},t.Path.getPathSeg=function(e,t){let s=e;const a=[],n=Math.floor(e/t);for(let e=0;e<t-1;e++)a.push(n),s-=n;return a.push(s),a}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(1);class o{constructor(e,t,s){this._num=parseInt(e,10),this._dice=parseInt(t,10),this._mod=parseInt(s,10)}static create(e){const t=o.parseDieSpec(e);if(3===t.length)return new o(t[0],t[1],t[2]);n.default.err("Dice","create","Could not create dice properly")}static getValue(e){if("number"!=typeof e){if("string"==typeof e){const t=o.parseDieSpec(e);return new o(t[0],t[1],t[2]).roll()}return e.roll()}if(Number.isInteger(e))return e}static parseDieSpec(e){if("object"==typeof e){if(e.length>=3)return[e[0],e[1],e[2]]}else{const t=o.DIE_RE.exec(e);if(null!==t){let e=null;return[t[1],t[2],e=n.default.isNullOrUndef([t[3],t[4]])?"0":"+"===t[3]?t[4]:"-"+t[4]]}if(o.DIE_NUMBER.test(e))return[0,0,parseInt(e,10)];n.default.err("RG","parseDieSpec","Cannot parse: "+e)}return[]}getNum(){return this._num}setNum(e){this._num=e}getDice(){return this._dice}setDice(e){this._dice=e}getMod(){return this._mod}setMod(e){this._mod=e}roll(){let e=0;for(let t=0;t<this._num;t++)e+=o.RNG.getUniformInt(1,this._dice);return e+this._mod}toString(){let e="+ "+this._mod;return this._mod<0?e="- "+this._mod:0===this._mod&&(e=""),this._num+"d"+this._dice+" "+e}copy(e){this._num=e.getNum(),this._dice=e.getDice(),this._mod=e.getMod()}clone(){return new o(this._num,this._dice,this._mod)}equals(e){let t=this._num===e.getNum();return t=(t=t&&this._dice===e.getDice())&&this._mod===e.getMod()}toJSON(){return[this._num,this._dice,this._mod]}}o.DIE_RE=/\s*(\d+)d(\d+)\s*(\+|-)?\s*(\d+)?/,o.DIE_NUMBER=/^\s*(-?\d+)\s*$/,t.Dice=o,o.RNG=new r.Random((new Date).getTime())},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(14),i=s(11),l=s(5),c=n(s(20)),h=s(28);class u{static createLevel(e,t,s,a){return(new u).createLevel(e,t,s,a)}constructor(){this._verif=new c.Conf("FactoryLevel")}createLevel(e,t,s,a){const n=new o.MapGenerator;let l=null;const c=new i.Level;if(n.setGen(e,t,s),"empty"===e?l=n.createEmptyMap():"town"===e?(l=n.createTownBSP(t,s,a),c.setMap(l.map),this.createHouseElements(c,l),this.createShops(c,l,a),this.createTrainers(c,a)):"townwithwall"===e?(l=n.createTownWithWall(t,s,a),c.setMap(l.map),this.createHouseElements(c,l),this.createShops(c,l,a),this.createTrainers(c,a)):l="forest"===e?n.createForest(a):"lakes"===e?n.createLakes(a):"mountain"===e?n.createMountain(t,s,a):"summit"===e?n.createSummit(t,s,a):"crypt"===e?n.createCryptNew(t,s,a):"cave"===e?n.createCave(t,s,a):"castle"===e?n.createCastle(t,s,a):"wall"===e?n.createWall(t,s,a):"arctic"===e?n.createArctic(t,s,a):n.getMap(),l)c.setMap(l.map);else{const t=JSON.stringify(a);r.default.err("FactoryBase","createLevel",`mapObj is null. type: ${e}. ${t}`)}return this.setLevelExtras(c,l),c}setLevelExtras(e,t){const s={};["rooms","corridors","vaults","houses","paths"].forEach(e=>{t.hasOwnProperty(e)&&(s[e]=t[e])}),e.setExtras(s)}createHouseElements(e,t){if(!t.hasOwnProperty("houses"))return;const s=t.houses;for(let t=0;t<s.length;t++){const a=s[t].door,n=new l.ElementDoor(!0);e.addElement(n,a[0],a[1])}}createShops(e,t,s){this._verif.verifyConf("createShops",s,["nShops"]);const a=new h.DungeonPopulate;e.addExtras("houses",t.houses),a.createShops(e,s)}createTrainers(e,t){(new h.DungeonPopulate).createTrainers(e,t)}}t.FactoryLevel=u},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0));s(29),t.Component={},t.Component.createdCompDecls={},t.NO_SERIALISATION=(()=>null),t.Component.NO_SERIALISATION=t.NO_SERIALISATION;const r=new Set(["description"]);function o(e,t){r.forEach(s=>{t.hasOwnProperty(s)&&(e[s]=t[s])})}function i(e,s){t.Component.hasOwnProperty(e)?n.default.err("Component","addCompDecl",`Comp ${e} exists already!`):t.Component[e]=s}function l(e){t.Component.createdCompDecls[e]&&n.default.err("Component","Tag/DataComponent",`Duplicate decl: ${e}`)}function c(e){return t.Component.idCount=e}t.TagComponent=function(e,s={}){l(e);const a=function(){t.ComponentBase.call(this,e),Object.keys(s).forEach(e=>{r.has(e)||(this[e]=s[e])})};return n.default.extend2(a,t.ComponentBase),t.Component.createdCompDecls[e]=a,o(a,s),i(e,a),a},t.Component.TagComponent=t.TagComponent,t.DataComponent=((e,s,a={})=>{if(l(e),"string"!=typeof e){const t=JSON.stringify(e);n.default.err("component.base.js","DataComponent: NO TYPE GIVEN","First arg must be string! Got: |"+t+"|")}("object"!=typeof s||Array.isArray(s))&&n.default.err("component.base.js",`DataComponent: ${e}`,"Members must be given as key/value pairs.");const r=function(...n){t.ComponentBase.call(this,e),Object.keys(a).forEach(e=>{this[e]=a[e]}),Object.keys(s).forEach(e=>{n&&n[0]&&n[0].hasOwnProperty(e)?this[e]=n[0][e]:"object"==typeof s[e]?this[e]=JSON.parse(JSON.stringify(s[e])):this[e]=s[e]}),this._init&&"function"==typeof this._init&&this._init(...n)};return n.default.extend2(r,t.ComponentBase),Object.keys(s).forEach(s=>{t.ComponentBase.prototype.hasOwnProperty(s)&&n.default.err("component.js",`DataComponent: ${e}`,`${s} is reserved in Base`);const a=function(e){return"set"+e.capitalize()}(s);t.ComponentBase.prototype.hasOwnProperty(a)&&n.default.err("component.js",`DataComponent: ${e}`,`${a} is reserved in Base`),r.prototype[a]=function(e){this[s]=e};const o=function(e){return"get"+e.capitalize()}(s);t.ComponentBase.prototype.hasOwnProperty(a)&&n.default.err("component.js",`DataComponent: ${e}`,`${o} is reserved in Base`),r.prototype[o]=function(){return this[s]}}),a.objRefs&&(r.prototype.objRefs=Object.freeze(a.objRefs)),r.prototype.members=Object.freeze(s),o(r,a),t.Component.createdCompDecls[e]=r,i(e,r),r}),t.Component.DataComponent=t.DataComponent,t.UniqueTagComponent=((e,s={})=>t.TagComponent(e,Object.assign({_isUnique:!0},s))),t.Component.UniqueTagComponent=t.UniqueTagComponent,t.UniqueDataComponent=((e,s,a={})=>t.DataComponent(e,s,Object.assign({_isUnique:!0},a))),t.Component.UniqueDataComponent=t.UniqueDataComponent,t.TransientTagComponent=((e,s={})=>t.TagComponent(e,Object.assign({toJSON:t.NO_SERIALISATION},s))),t.Component.TransientTagComponent=t.TransientTagComponent,t.TransientDataComponent=((e,s,a={})=>t.DataComponent(e,s,Object.assign({toJSON:t.NO_SERIALISATION},a))),t.Component.TransientDataComponent=t.TransientDataComponent,t.UniqueTransientDataComponent=((e,s,a={})=>t.DataComponent(e,s,Object.assign({_isUnique:!0,toJSON:t.NO_SERIALISATION},a))),t.Component.UniqueTransientDataComponent=t.UniqueTransientDataComponent,t.compsToJSON=(e=>{const t={},s=e.getComponents();return Object.keys(s).forEach(e=>{const a=s[e].toJSON();a&&(t[e]=a)}),t}),t.Component.compsToJSON=t.compsToJSON,t.Component.idCount=0,t.getIDCount=function(){return t.Component.idCount},t.setIDCount=c,t.Component.setIDCount=c,t.ComponentBase=function(e){this._type=e,this._entity=null,this._id=t.Component.idCount++,this._isUnique=!1,this._onAddCallbacks=[],this._onRemoveCallbacks=[]},t.Component.ComponentBase=t.ComponentBase,t.ComponentBase.prototype.getID=function(){return this._id},t.ComponentBase.prototype.setID=function(e){this._id=e},t.ComponentBase.prototype.getEntity=function(){return this._entity},t.ComponentBase.prototype.setEntity=function(e){null===this._entity&&null!==e?this._entity=e:null===e?this._entity=null:n.default.err("Base","setEntity","Entity already set.")},t.ComponentBase.prototype.changeEntity=function(e){n.default.isNullOrUndef([this._entity])?n.default.err("Base","changeEntity","No entity set. Use setEntity() instead of changeEntity()"):(this._entity.remove(this.getID()),e.add(this))},t.ComponentBase.prototype.isUnique=function(){return this._isUnique},t.ComponentBase.prototype.getType=function(){return this._type},t.ComponentBase.prototype.setType=function(e){this._type=e},t.ComponentBase.prototype.entityAddCallback=function(e){this.setEntity(e);for(let e=0;e<this._onAddCallbacks.length;e++)this._onAddCallbacks[e]()},t.ComponentBase.prototype.entityRemoveCallback=function(){for(let e=0;e<this._onRemoveCallbacks.length;e++)this._onRemoveCallbacks[e]();this.setEntity(null)},t.ComponentBase.prototype.addCallback=function(e,t){"onAdd"===e?this._onAddCallbacks.push(t):"onRemove"===e?this._onRemoveCallbacks.push(t):n.default.err("Base","addCallback","CB name "+e+" must be onAdd/onRemove")},t.ComponentBase.prototype.removeCallbacks=function(e){"onAdd"===e?this._onAddCallbacks=[]:"onRemove"===e?this._onRemoveCallbacks=[]:(this._onAddCallbacks=[],this._onRemoveCallbacks=[])},t.ComponentBase.prototype.clone=function(){const e=this.getType();if(t.Component.hasOwnProperty(e)){const s=new t.Component[e];return s.copy(this),s}return n.default.err("Base","clone",`No type |${e}| in Component.`),null},t.ComponentBase.prototype.copy=function(e){for(const t in this)if(/^get/.test(t)){const s=t;if("getEntity"!==s&&"getID"!==s){const t=s.replace("get","set");if("function"==typeof e[s]&&"function"==typeof this[t]){const a=e[s]();this[t](a)}}}},t.ComponentBase.prototype.equals=function(e){return this.getType()===e.getType()},t.ComponentBase.prototype.toString=function(){return"Component: "+this.getType()},t.ComponentBase.prototype.toJSON=function(){const e={};for(const t in this)if(/^get/.test(t)){const s=t;if("getEntity"!==s&&"function"==typeof this[s]){const t=s.replace("get","set");"function"==typeof this[t]&&(e[t]=this[s]())}}return e},t.Component.Base=t.ComponentBase,t.create=function(e,...s){return t.Component[e]?new t.Component[e](...s):(n.default.err("Component","create",`Comp type |${e}| does not exist.`),null)},t.Component.create=t.create,t.defineComponent=function(e,s){if(!t.Component.hasOwnProperty(e)){return t.DataComponent(e,s)}return n.default.err("Component","defineComponent",`Component ${e} already defined`),null},t.Component.defineComponent=t.defineComponent,t.undefineComponent=function(e){delete t.Component.createdCompDecls[e],delete t.Component[e]},t.Component.undefineComponent=t.undefineComponent},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(18),i=n(s(13)),l=n(s(48)),c=s(23),h=s(7),u=s(16),d=h.EventPool.getPool();t.Item={};class g extends c.Entity{constructor(e){super(),this.isOwnable=!0,this._owner=null,this._name=e,this.isUsable=!1,this.add(new i.Typed(r.default.ITEM.BASE,r.default.TYPE_ITEM)),this.add(new i.Item),this.add(new i.Physical)}setOwner(e){r.default.isNullOrUndef([e])?r.default.err("ItemBase","setOwner","Owner cannot be null."):this._owner=e}getTopOwner(){let e=this._owner;for(;e.getOwner;)e=e.getOwner();return e}getOwner(){return this._owner}getX(){return this._owner?this._owner.getX():null}getY(){return this._owner?this._owner.getY():null}getXY(){return this._owner?this._owner.getXY():null}getLevel(){return this._owner?this._owner.getLevel():null}setName(e){this._name=e}getName(){return this._name}setWeight(e){this.get("Physical").setWeight(e)}getWeight(){return this.get("Physical").getWeight()}setValue(e){this.get("Item").setValue(e)}getValue(){return this.get("Item").getValue()}incrCount(e){this.get("Item").incrCount(e)}decrCount(e){this.get("Item").decrCount(e)}getCount(){return this.get("Item").getCount()}setCount(e){this.get("Item").setCount(e)}getType(){return this.get("Typed").getObjType()}setType(e){return this.get("Typed").setObjType(e)}getPropType(){return this.get("Typed").getPropType()}setPropType(e){return this.get("Typed").setPropType(e)}setDamageType(e){this.get("Item").setDamageType(e)}getDamageType(){return this.get("Item").getDamageType()}getNameWithCount(){return`${this.getName()} (x${this.getCount()})`}toString(){let e=this.getName()+", "+this.getType()+", ";return e+=(this.getWeight()*this.getCount()).toFixed(2)+"kg",e=this.getCount()+" x "+e,this.has("GemBound")&&(e+=" (Bound)"),this.has("Stats")&&(e+=" "+this.get("Stats").toString()),e}copy(e){this.setName(e.getName()),this.setType(e.getType()),this.setWeight(e.getWeight()),this.setValue(e.getValue()),e.useArgs&&(this.useArgs=e.useArgs),e.isUsable&&(this.useItem=e.useItem.bind(this)),Object.values(e.getComponents()).forEach(e=>{this.add(e.clone())})}useItem(e){return!1}clone(){const e=new g(this.getName());return e.copy(this),e}equals(e){if(this.getType()!==e.getType())return!1;if(this.getID()===e.getID())return!0;let t=this.getName()===e.getName();return t=(t=t&&this.getWeight()===e.getWeight())&&!(this.has("GemBound")||e.has("GemBound"))}toJSON(){const e={setID:this.getID(),setName:this.getName(),setType:this.getType(),isUsable:this.isUsable};return e.components=o.compsToJSON(this),e}}t.ItemBase=g,t.Item.Base=g;class p extends g{constructor(e){super(e),this.setType(r.default.ITEM.FOOD),this._energy=0,this.isUsable=!0}setEnergy(e){this._energy=e}getEnergy(){return this._energy}useItem(e){if(e.hasOwnProperty("target")){const t=e.target;if(t.hasActors()){const e=t.getProp("actors")[0];if(e.has("Hunger")){let t=this.getConsumedEnergy();if(e.has("NourishedOne")&&(t*=3),e.get("Hunger").addEnergy(t),1===this.getCount()){const t={item:this};d.emitEvent(r.default.EVT_DESTROY_ITEM,t),r.default.gameMsg(e.getName()+" consumes "+this.getName())}else this.decrCount(1);return!0}r.default.gameWarn(e.getName()+" is not interested in eating.")}else r.default.gameWarn("There's no one to give food to.")}else r.default.err("ItemFood","useItem","No target given in obj.");return!1}getConsumedEnergy(){return Math.round(this.getWeight()*this._energy/.1)}toJSON(){const e=super.toJSON();return e.setEnergy=this.getEnergy(),e}clone(){const e=new t.Item.Food(this.getName());return e.copy(this),e.setEnergy(this.getEnergy()),e}}t.Food=p,t.Item.Food=p;class m extends g{constructor(e){super(e),this.setType(r.default.ITEM.CORPSE)}setActorName(e){this.actorName=e}getActorName(){return this.actorName}}t.Corpse=m,t.Item.Corpse=m;class f extends(l.Damage(g)){constructor(e){super(e),this.setType(r.default.ITEM.WEAPON),this._weaponType=""}copy(e){super.copy(e),this._weaponType=e.getWeaponType()}clone(){const e=new f(this.getName());return e.copy(this),e}setWeaponType(e){this._weaponType=e}getWeaponType(){return this._weaponType}toJSON(){const e=super.toJSON();return e.setWeaponType=this._weaponType,e}}t.Weapon=f,t.Item.Weapon=f;class y extends f{constructor(e){super(e),this.setType(r.default.ITEM.MISSILE_WEAPON),this._fireRate=1}setFireRate(e){this._fireRate=e}getFireRate(){return this._fireRate}copy(e){super.copy(e),this.setFireRate(e.getFireRate())}clone(){const e=new y(this.getName());return e.copy(this),e}equals(e){return!!super.equals(e)&&this._fireRate===e.getFireRate()}toJSON(){const e=super.toJSON();return e.setFireRate=this._fireRate,e}}t.MissileWeapon=y,t.Item.MissileWeapon=y;class _ extends f{constructor(e){super(e),this.setType(r.default.ITEM.AMMUNITION),this.add(new i.Ammo),this._ammoType=""}setAmmoType(e){this._ammoType=e}getAmmoType(){return this._ammoType}copy(e){super.copy(e),this.setAmmoType(e.getAmmoType())}clone(){const e=new _(this.getName());return e.copy(this),e}equals(e){return!!super.equals(e)&&this._ammoType===e.getAmmoType()}toJSON(){const e=super.toJSON();return e.setAmmoType=this._ammoType,e}}t.Ammo=_,t.Item.Ammo=_;class E extends(l.Defense(g)){constructor(e){super(e),this.setType(r.default.ITEM.ARMOUR),this._armourType=null}setArmourType(e){this._armourType=e}getArmourType(){return this._armourType}copy(e){super.copy(e),this.setArmourType(e.getArmourType())}clone(){const e=new E(this.getName());return e.copy(this),e}equals(e){let t=super.equals(e);return t=t&&this._armourType===e.getArmourType()}toJSON(){const e=super.toJSON();return e.setArmourType=this.getArmourType(),e}}t.Armour=E,t.Item.Armour=E;class S extends g{constructor(e){super(e),this.setType(r.default.ITEM.POTION),this.isUsable=!0}useItem(e){if(e.hasOwnProperty("target")){const t=e.target;if(t.hasActors()){const e=t.getProp("actors")[0],s=new u.Dice(1,10,2).roll();if(e.has("Health")){e.get("Health").addHP(s);const t=this.getOwner().getOwner(),a=new i.UseItem;return a.setTarget(e),a.setItem(this),a.setUseType(r.default.USE.DRINK),t.add(a),!1}}else r.default.gameWarn("Cannot see anyone there for using the potion.")}else r.default.err("ItemPotion","useItem","No target given in obj.");return!1}clone(){const e=new t.Item.Potion(this.getName());return e.copy(this),e}}t.Potion=S,t.Item.Potion=S;class v extends g{constructor(e){super(e),this.setType(r.default.ITEM.RUNE),this._charges=1}getCharges(){return this._charges}setCharges(e){this._charges=e}clone(){const e=new v(this.getName());return e.copy(this),e}copy(e){super.copy(e),this.setCharges(e.getCharges())}equals(e){let t=super.equals(e);return!!e.getCharges&&(t=t&&this.getCharges()===e.getCharges())}toString(){let e=super.toString();return e+=` charges: ${this.getCharges()}`}toJSON(){const e=super.toJSON();return e.setCharges=this.getCharges(),e}}t.Rune=v,t.Item.Rune=v;class C extends f{constructor(e){super(e),this.setType(r.default.ITEM.MISSILE)}clone(){const e=new C(this.getName());return e.copy(this),e}}t.Missile=C,t.Item.Missile=C;class b extends g{constructor(e){super("container"),this.setOwner(e),this._items=[],this._iter=0,this._removedItem=null}_addItem(e){let t=!1;for(let s=0;s<this._items.length;s++)if(this._items[s].equals(e)){this._items[s].incrCount(e.getCount()),t=!0;break}t||(e.setOwner(this),this._items.push(e))}getWeight(){let e=0;for(let t=0;t<this._items.length;t++)e+=this._items[t].getWeight()*this._items[t].getCount();return e}addItem(e){if(e.getCount()<=0){const t=JSON.stringify(e);r.default.warn("Container","addItem",`Possible bug. Tried to add item with count 0: ${t}`)}"container"===e.getType()?this.getOwner()!==e?this._addItem(e):r.default.err("Item","addItem","Added item is container's owner. Impossible."):this._addItem(e)}getItems(){return this._items.slice()}hasItemRef(e){return-1!==this._items.indexOf(e)}hasItem(e){if(this.hasItemRef(e))return!0;return this._getMatchingItemIndex(e)>=0}removeItem(e){return this.hasItem(e)?this._removeItem(e):(this._removedItem=null,!1)}_getMatchingItemIndex(e){for(let t=0;t<this._items.length;t++)if(e.equals(this._items[t]))return t;return-1}_removeItem(e){const t=this._getMatchingItemIndex(e);return-1===t?(r.default.err("ItemContainer","_removeItem","Negative index found. Horribly wrong."),!1):(1===this._items[t].getCount()?(this._removedItem=e,this._items.splice(t,1)):(this._removedItem=r.default.removeStackedItems(this._items[t],1),0===this._items[t].getCount()&&this._items.splice(t,1)),!0)}getRemovedItem(){return this._removedItem}removeNItems(e,t){let s=0;for(;s<t&&this.removeItem(e);)++s;return null===this._removedItem?(r.default.err("ItemContainer","removeNItems","this._removedItem was null. It should be a valid item."),!1):(this._removedItem.setCount(s),s>0)}first(){return this._items.length>0?(this._iter=1,this._items[0]):null}next(){return this._iter<this._items.length?this._items[this._iter++]:null}last(){return this._items[this._items.length-1]}isEmpty(){return 0===this._items.length}toString(){let e="Container: "+this.getName()+"\n";const t=this.getItems();for(let s=0;s<t.length;s++)e+=t[s].toString()+"\n";return e}toJSON(){const e=[],t=this.getItems();for(let s=0;s<t.length;s++)e.push(t[s].toJSON());return e}}t.Container=b,t.Item.Container=b;class T extends g{constructor(e){super(e),this.setType(r.default.ITEM.GOLD),this._purity=1}getPurity(){return this._purity}setPurity(e){this._purity=e}toJSON(){const e=super.toJSON();return e.setType=this.getType(),e.setPurity=this._purity,e}}t.Gold=T,t.Item.Gold=T;class A extends T{constructor(e){super(e||r.default.GOLD_COIN_NAME),this.setType(r.default.ITEM.GOLD_COIN),this._purity=1,this.setWeight(.03)}}t.GoldCoin=A,t.Item.GoldCoin=A;class w extends g{constructor(e){super(e),this.setType(r.default.ITEM.SPIRITGEM),this._spirit=null,this._hasSpirit=!1}getArmourType(){return this.getType()}hasSpirit(){return this._hasSpirit}getSpirit(){return this._spirit}setSpirit(e){this._hasSpirit?r.default.err("Item.SpiritGem","setSpirit","Tried to overwrite spirit"):(this._hasSpirit=!0,this._spirit=e)}useItem(e){const t=this.getOwner().getOwner();if(t){const s=new i.SpiritBind;return s.setTarget(e.target),s.setBinder(t),this.add(s),!0}{const t=`binder is null. obj: ${JSON.stringify(e)}`;r.default.err("Item.SpiritGem","useItem",t)}return!1}clone(){const e=new w(this.getName());return e.copy(this),e}copy(e){super.copy(e),e.hasSpirit()&&this.setSpirit(e.getSpirit())}equals(e){let t=super.equals(e);return t=t&&this.getSpirit()===e.getSpirit()}toString(){let e=super.toString();if(this.hasSpirit()){const t=this.getSpirit().get("Stats");e+="("+this.getSpirit().getName()+")",e+=" Str: "+t.getStrength(),e+=" Agi: "+t.getAgility(),e+=" Acc: "+t.getAccuracy(),e+=" Wil: "+t.getWillpower()}else e+="(Empty)";return e}toJSON(){const e=super.toJSON();return e.hasSpirit=this.hasSpirit(),e.hasSpirit&&(e.setSpirit=this.getSpirit().toJSON()),e}}t.SpiritGem=w,t.Item.SpiritGem=w;for(let e=0;e<r.default.GET_STATS.length;e++)w.prototype[r.default.GET_STATS[e]]=function(){return(()=>{const t=r.default.GET_STATS[e];return this._hasSpirit?this._spirit.get("Stats")[t]():0})()};class O extends g{constructor(e){super(e),this.setType(r.default.ITEM.MINERAL)}}t.Mineral=O,t.Item.Mineral=O;class M extends g{constructor(e){super(e),this.setType(r.default.ITEM.BOOK),this.text=[],this.metaData={}}addMetaData(e,t){this.metaData.hasOwnProperty[e]||(this.metaData[e]=[]),this.metaData[e].push(t)}setMetaData(e){this.metaData=e}getMetaData(e){return this.metaData[e]}useItem(){const e=this.getTopOwner();if(e){const t=new i.Read;return t.setReadTarget(this),e.add(t),!0}return!1}getText(){return this.text}addText(e){this.text.push(e)}setText(e){this.text=e}clone(){const e=new M(this.getName());return e.copy(this),e}copy(e){super.copy(e);const t=e.getText().slice();this.setText(t),this.metaData=JSON.parse(JSON.stringify(e.metaData))}equals(e){return this.getID()===e.getID()}toJSON(){const e=super.toJSON();return e.setText=this.text,e.setMetaData=this.metaData,e}}t.Book=M,t.Item.Book=M},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0));t.verifyStairsConnections=function(e,t){e.getLevels().map(e=>e.getStairs()).forEach(e=>{e.forEach(e=>{if("function"!=typeof e.isConnected)n.default.err("verify.js","verifyStairsConnections","stairs not correct type: "+JSON.stringify(e));else if(!e.isConnected()){let s="|"+t+"| stairs: "+JSON.stringify(e);const a=e.getSrcLevel();s+=a?" srcLevel parent "+a.getParent()+",":" srcLevel missing,";const r=e.getTargetStairs();s+=r?" targetLevel parent: "+r.getParent():" targetLevel missing,",e.getTargetStairs()||(s+=" targetStairs missing"),n.default.err("verify.js","verifyConnections",s)}})})};t.Conf=class{constructor(e){this._name=e}verifyConf(e,t,s){let a=!0,r="";return s.forEach(e=>{this.verifyReq(t,e)?function(e,t){const s=t.split("|"),a=s.length>0;let r=!1;for(const t of s)e.hasOwnProperty(t)&&n.default.isNullOrUndef([e[t]])&&(r=!0);return!a&&r}(t,e)&&(a=!1,r+=` Undef/null value in: ${e}`):(a=!1,r+=` Missing: ${e}`)}),a||n.default.err(this._name,"verifyConf",`${e} ${r}`),a}verifyReq(e,t){const s=t.split("|");let a=!1;return s.forEach(s=>{if(e.hasOwnProperty(s))if(a){const s=JSON.stringify(e),a=`Req ${t} is mutex. Conf: ${s}`;n.default.err(this._name,"verifyReq",a)}else a=!0}),a}},t.verifySaveData=function(e,t=!0){o(e,t)};const r=[];function o(e,t,s=30){const a=[];for(const n in e)if(e.hasOwnProperty(n)){if(r.push(n),r.length<s)if("object"==typeof e[n])o(e[n]);else if("function"==typeof e[n]){let s=`Error. Func in ${JSON.stringify(r)}`;if(s+=`\n\tProp: ${n}`,s+=`\n\tValue: ${e[n].toString()}`,t)throw new Error(s);a.push(s)}else if("string"==typeof e[n]&&/function/.test(e[n])){let t=`function in string <<${e[n]}>>\n`;throw t+=`\tStack is ${r.join(".")}`,new Error(t)}r.pop()}if(a.length>0){const e=a.join("\n");throw new Error(e)}}t.traverseObj=o,t.verifyLevelCache=function(e){const t=e.getItems(),s=e.getMap().getCells(),a={};s.forEach(e=>{e.hasItems()&&e.getItems().forEach(e=>{a[e.getID()]=e})});const n={};t.forEach(e=>{n[e.getID()]=e});const r=Object.keys(a).length,o=Object.keys(n).length;if(o!==r){let e=`nCellItems: ${r}`;e+=`, nLevelItems: ${o}`,console.error("Mismatch in cell/level item length:",e)}const i=[];Object.keys(a).forEach(e=>{n.hasOwnProperty(e)?delete n[e]:i.push(a[e])});const l=[];Object.keys(n).forEach(e=>{a.hasOwnProperty(e)?delete a[e]:l.push(n[e])}),i.forEach(e=>{console.error("\tIn cells but NOT level: ",e.getName())}),l.forEach(e=>{console.error("\tIn level but NOT cells: ",e.getName())})}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(8)("bitn:world"),o=a(s(0)),i=n(s(5)),l=s(7),c=s(1),h=s(17),u=n(s(2)),d=s(23),g=l.EventPool.getPool(),p=i.ElementStairs;t.World={};const m=c.Random.getRNG(),f={east:"west",north:"south",south:"north",west:"east"};function y(e,t,s){const a=e.getMap().getCell(t,s);if(a.hasConnection()){const n=a.getConnection();r(`world.js Removing conn@${t},${s}`),e.removeElement(n,t,s)||o.default.err("world.ts","removeExistingConnection",`Failed to remove conn @ ${t}, ${s}`)}}function _(e,t,s){const a=t.find(t=>t.getName()===e);if(a){const t=a.getLevels();if(t.length>s)return t[s];{const a=`Name: ${e}`;o.default.err("world.js","findLevel",`${a} nLev ${s} out of bounds (${t.length-1})`)}}return null}function E(e){let t=e.getFreeRandCell();for(;t.hasConnection();)t=e.getFreeRandCell();return t}function S(e){const t=e.length,s=[],a=[];for(let n=0;n<t;n++){const r=e[n];let o=null;if(r.hasExtras()&&(o=r.getExtras()),n<t-1){const t=e[n+1],a=new p("stairsDown",r,t),i=E(r);let[l,c]=[i.getX(),i.getY()];o&&o.endPoint&&([l,c]=o.endPoint),r.addStairs(a,l,c),s.push(a)}if(n>0){const t=e[n-1],s=new p("stairsUp",r,t),i=E(r);let[l,c]=[i.getX(),i.getY()];o&&o.startPoint&&([l,c]=o.startPoint),r.addStairs(s,l,c),a.push(s)}}for(let e=0;e<t;e++)e<t-1&&s[e].connect(a[e])}function v(e,t,s){let a=t,n=s;return"string"==typeof t&&"string"==typeof s&&(a=e.find(e=>e.getName()===t),n=e.find(e=>e.getName()===s)),[a,n]}function C(e,t){if(null===t)return null;const{x:s,y:a}=t;return e[t.levelNumber].getMap().getCell(s,a).getStairs()}t.addExitsToEdge=((e,t="passage",s="any",a=!1)=>{const n=e.getMap(),r=n.cols,o=n.rows,i=[];for(let l=1;l<o-1;l++){if(("any"===s||"west"===s)&&(n.isPassable(0,l)||a)){const s=new p(t,e);y(e,0,l),a?e.addStairs(s,0,l):e.addElement(s,0,l),i.push(s)}if(("any"===s||"east"===s)&&(n.isPassable(r-1,l)||a)){const s=new p(t,e);y(e,r-1,l),a?e.addStairs(s,r-1,l):e.addElement(s,r-1,l),i.push(s)}}for(let l=1;l<r-1;l++){if(("any"===s||"north"===s)&&(n.isPassable(l,0)||a)){const s=new p(t,e);y(e,l,0),a?e.addStairs(s,l,0):e.addElement(s,l,0),i.push(s)}if(("any"===s||"south"===s)&&(n.isPassable(l,o-1)||a)){const s=new p(t,e);y(e,l,o-1),a?e.addStairs(s,l,o-1):e.addElement(s,l,o-1),i.push(s)}}return i}),t.edgeHasConnections=((e,t)=>{const s=e.getMap(),a=s.cols,n=s.rows;for(let e=1;e<n-1;e++){if(("any"===t||"west"===t)&&s.getCell(0,e).hasConnection())return!0;if(("any"===t||"east"===t)&&s.getCell(a-1,e).hasConnection())return!0}for(let e=1;e<a-1;e++){if(("any"===t||"north"===t)&&s.getCell(e,0).hasConnection())return!0;if(("any"===t||"south"===t)&&s.getCell(e,n-1).hasConnection())return!0}return!1}),t.World.connectLevelsLinear=S,t.World.addExitsToEdge=t.addExitsToEdge,t.World.edgeHasConnections=t.edgeHasConnections;class b extends d.Entity{constructor(e){super(),this.name=e,this.type="base",this.parent=null}getName(){return this.name}getHierName(){return this.hierName}setHierName(e){this.hierName=e}getType(){return this.type}setType(e){this.type=e}getParent(){return this.parent}setParent(e){this.parent=e}toJSON(){const e={hierName:this.hierName,id:this.getID(),name:this.name,type:this.type};return this.parent&&(e.parent=this.parent.getID()),e.components=u.compsToJSON(this),e}}t.WorldBase=b,t.World.Base=b;class T extends b{constructor(e){super(e),this._subZones=[]}getSubZoneArgs(e,t){return v(this._subZones,e,t)}setTileXY(e,t){this.tileX=e,this.tileY=t}getTileXY(){return[this.tileX,this.tileY]}addSubZone(e){return e.getID()===this.getID()&&o.default.err("ZoneBase","addSubZone","Tried to add itself as sub zone: "+this.getName()),!o.default.isNullOrUndef([e])&&(e.setParent(this),this._subZones.push(e),!0)}hasSubZone(e){return this._subZones.indexOf(e)>=0}getLevels(){let e=[];return this._subZones.forEach(t=>{e=e.concat(t.getLevels())}),e}getPlaceEntities(){let e=[this];return this._subZones.forEach(t=>{e.push(t)}),e}connectSubZones(e,t,s,a){!function(e,t,s,a,n){o.default.isNullOrUndef([a,n])&&o.default.err("World","connectSubZones",`l1 (${a}) and l2 (${n}) must be non-null and integers.`);const[r,i]=v(e,t,s);o.default.isNullOrUndef([r,i])&&o.default.err("World","connectSubZones","Cannot connect null subZones. Check the names/refs.");let l=!0;a>n&&(l=!1);const c=new p(l?"stairsDown":"stairsUp"),h=i.getLevels();if(n<h.length){const e=E(h[n]);h[n].addStairs(c,e.getX(),e.getY()),c.setSrcLevel(h[n]),r.connectLevelToStairs(a,c)}else o.default.err("World","connectSubZones","Level "+n+" doesn't exist in sub-zone "+i.getName())}(this._subZones,e,t,s,a)}findLevel(e,t){return _(e,this._subZones,t)}findSubZone(e){return function(e,t){return t.find(t=>t.getName()===e)}(e,this._subZones)}getEntrances(){const e=[];return this._subZones.forEach(t=>{const s=t.getEntrance();s&&e.push(s)}),e}removeListeners(){this._subZones.forEach(e=>{e.removeListeners()})}toJSON(){const e=super.toJSON();return e.x=this.tileX,e.y=this.tileY,e}getID2Place(){const e={[this.getID()]:this};return this._subZones.forEach(t=>{e[t.getID()]=t}),e}}t.ZoneBase=T,t.World.ZoneBase=T;class A extends b{constructor(e){super(e),this._levelFeatures=new Map,this._levels=[],this._levelCount=0}getEntrance(){return C(this._levels,this._entrance)}getLevelN(e){if(e<this._levels.length)return this._levels[e];{const t=this._levels.length;o.default.err("SubZoneBase","getLevels",`No nLevel ${e} found. Max: ${t}`)}return null}getLevels(){return this._levels.slice()}hasLevel(e){return this._levels.indexOf(e)>=0}connectLevelToStairs(e,t){(function(e,t,s){if(t<e.length){const a=e[t],n=s.getSrcLevel();if(!o.default.isNullOrUndef([n])){const e=!s.isDown(),t=new p(e?"stairsDown":"stairsUp",a,n),r=E(a);return a.addStairs(t,r.getX(),r.getY()),t.connect(s),!0}}else o.default.err("world.js","connectLevelToStairs",`nLevel: ${t} out of bounds (${e.length})`);return!1})(this._levels,e,t)||o.default.err("SubZoneBase","connectLevelToStairs","Stairs must be first connected to other level.")}getStairsOther(){return function(e,t){const s=[];return t.forEach(t=>{t.getStairs().forEach(t=>{const a=t.getTargetLevel();if(a&&a.getParent){const n=a.getParent();n&&n.getName()!==e&&s.push(t)}})}),s}(this.getName(),this._levels)}addLevelFeature(e){const t=e.getType();this._levelFeatures.has(t)||(this._levelFeatures[t]=[]),this._levelFeatures[t].push(e)}removeListeners(){}getLevel(e){if(e<this._levels.length)return this._levels[e];{const t=`${this.getType()}, ${this.getName()}`,s=`Has ${this._levels.length} levels`;o.default.err("SubZoneBase","getLevel",`${t}, nLevel: ${e}, ${s}`)}return null}addLevel(e){if(o.default.isNullOrUndef([e]))o.default.err("SubZoneBase","addLevel","Level is not defined.");else if(this.hasLevel(e)){let t="Trying to add existing level. ";t+=" ID: "+e.getID(),o.default.err("SubZoneBase","addLevel",t)}else e.setLevelNumber(this._levelCount++),this._levels.push(e),e.setParent(this)}toJSON(){const e=super.toJSON();return e.nLevels=this._levels.length,e.levels=this._levels.map(e=>e.getID()),e}}t.SubZoneBase=A,t.World.SubZoneBase=A;class w extends A{constructor(e){super(e),this.setType("branch"),this._entrance=null}addEntrance(e){const t=new p("stairsUp");this.setEntrance(t,e)}setEntrance(e,t){if(t<this._levels.length){const s=this._levels[t],a=E(s);let[n,r]=a.getXY();if(s.hasExtras()){const e=s.getExtras();e.startPoint&&([n,r]=e.startPoint)}s.addStairs(e,n,r),this._entrance={levelNumber:t,x:n,y:r}}else o.default.err("World.Branch","setEntrance",`Invalid level number. Must be < ${this._levels.length}`)}setEntranceLocation(e){o.default.isNullOrUndef([e])?o.default.err("World.Branch","setEntranceLocation","Arg entrance is not defined."):this._entrance=e}getEntrance(){return C(this._levels,this._entrance)}connectLevels(){S(this._levels)}toJSON(){const e=super.toJSON(),t={};return this._entrance&&(t.entrance=this._entrance),Object.assign(t,e)}}t.Branch=w,t.World.Branch=w;class O extends T{constructor(e){super(e),this.setType("dungeon"),this._entranceNames=[]}hasBranch(e){return this.hasSubZone(e)}getBranches(){return this._subZones}setEntrance(e){this._entranceNames="string"==typeof e?[e]:e}addBranch(e){return!this.hasBranch(e)&&(this._subZones.push(e),e.setParent(this),1===this._subZones.length&&this.setEntrance(e.getName()),!0)}getEntrances(){const e=[],t=this._subZones.length;for(let s=0;s<t;s++){const t=this._subZones[s];if(this._entranceNames.indexOf(t.getName())>=0){const s=t.getEntrance();o.default.isNullOrUndef([s])||e.push(s)}}return e}toJSON(){const e=super.toJSON(),t={branch:this._subZones.map(e=>e.toJSON()),entranceNames:this._entranceNames,nBranches:this._subZones.length};return Object.assign(t,e)}}t.Dungeon=O,t.World.Dungeon=O;class M{constructor(e,t,s){this._tileX=e,this._tileY=t,this._area=s,this.cols=null,this.rows=null,this._level=null,this.zones={Dungeon:[],Mountain:[],City:[],BattleZone:[]}}getLevel(){return this._level}getTileX(){return this._tileX}getTileY(){return this._tileY}isNorthEdge(){return 0===this._tileY}isSouthEdge(){return this._tileY===this._area.getSizeY()-1}isWestEdge(){return 0===this._tileX}isEastEdge(){return this._tileX===this._area.getSizeX()-1}isEdge(){return!!this.isNorthEdge()||(!!this.isSouthEdge()||(!!this.isWestEdge()||!!this.isEastEdge()))}setLevel(e){this._level=e,this.cols=this._level.getMap().cols,this.rows=this._level.getMap().rows}connect(e,t){const s=this.cols-1,a=this.rows-1;if(!o.default.isNullOrUndef([e])){const t=e.getLevel(),n=this._level.getMap(),r=t.getMap();for(let e=1;e<=a-1;e++){const a=n.getCell(s,e),o=r.getCell(0,e);if(a.isFree()&&o.isFree()){const a=new p("passage",this._level,t),n=new p("passage",t,this._level);a.setTargetStairs(n),n.setTargetStairs(a),this._level.addStairs(a,s,e),t.addStairs(n,0,e)}}}if(!o.default.isNullOrUndef([t])){const e=t.getLevel(),n=this._level.getMap(),r=e.getMap();for(let t=1;t<=s-1;t++){const s=n.getCell(t,a),o=r.getCell(t,0);if(s.isFree()&&o.isFree()){const s=new p("passage",this._level,e),n=new p("passage",e,this._level);s.setTargetStairs(n),n.setTargetStairs(s),this._level.addStairs(s,t,a),e.addStairs(n,t,0)}}}}addZone(e,t){o.default.isNullOrUndef([t.tileX,t.tileY])&&o.default.err("AreaTile","addZone","No tileX/tileY given!"),this.zones[e]||(this.zones[e]=[]),this.zones[e].push(t)}getZones(e){if(e)return this.zones[e];let t=[];return Object.keys(this.zones).forEach(e=>{t=t.concat(this.zones[e])}),t}getLevels(){let e=[this._level];if(Object.keys(this.zones).forEach(t=>{this.zones[t].forEach(t=>{e=e.concat(t.getLevels())})}),r.enabled){let t=this.toString();t=` Tile ${t} has ${e.length} levels from toJSON()`,1344===this._level.getID()&&(t+=`\tLevels: ${e.map(e=>e.getID())}`),console.error(t)}return e}getPlaceEntities(){let e=[];return Object.keys(this.zones).forEach(t=>{this.zones[t].forEach(t=>{e=e.concat(t.getPlaceEntities())})}),e}toString(){let e=`${this._tileX},${this._tileY}, ID: ${this._level.getID()}`;return e+=` nZones: ${this.getZones().length}`}toJSON(){return{x:this._tileX,y:this._tileY,level:this._level.getID(),levels:this.getLevels().map(e=>e.toJSON()),nDungeons:this.zones.Dungeon.length,dungeon:this.getZones("Dungeon").map(e=>e.toJSON()),nMountains:this.zones.Mountain.length,mountain:this.getZones("Mountain").map(e=>e.toJSON()),nCities:this.zones.City.length,city:this.getZones("City").map(e=>e.toJSON()),nBattleZones:this.zones.BattleZone.length,battlezone:this.getZones("BattleZone").map(e=>e.toJSON())}}removeListeners(){Object.values(this.zones).forEach(e=>{e.forEach(e=>{e.removeListeners()})})}}t.AreaTile=M,t.World.AreaTile=M;class P extends b{constructor(e,t,s,a,n,r){super(e),this.setType("area"),this._sizeX=parseInt(t,10),this._sizeY=parseInt(s,10),this._cols=a||30,this._rows=n||30,this._tiles=[],this._conf={},this.zonesCreated={},this.tilesLoaded=[],this._init(r)}getSizeX(){return this._sizeX}getSizeY(){return this._sizeY}isLoaded(e,t){return this.tilesLoaded[e][t]}setLoaded(e,t){this.tilesLoaded[e][t]=!0}setUnloaded(e,t){this.tilesLoaded[e][t]=!1}markAllZonesCreated(){Object.keys(this.zonesCreated).forEach(e=>{this.zonesCreated[e]=!0})}markTileZonesCreated(e,t){this.zonesCreated[e+","+t]=!0}tileHasZonesCreated(e,t){return this.zonesCreated[e+","+t]}getTiles(){return this._tiles}setTile(e,t,s){this._tiles[e][t]=s}setConf(e){this._conf=e}getConf(){return this._conf}_init(e){for(let t=0;t<this._sizeX;t++){const s=[];this.tilesLoaded.push([]);for(let a=0;a<this._sizeY;a++){this.zonesCreated[t+","+a]=!1;const n=new M(t,a,this),r=o.default.getForestConf(this._cols,this._rows);let i=null;if(e)i=e[t][a];else{i=(new h.FactoryLevel).createLevel("forest",this._cols,this._rows,r)}i!==o.default.LEVEL_NOT_LOADED?(this.tilesLoaded[t][a]=!0,i.setParent(this),n.setLevel(i),s.push(n)):(this.tilesLoaded[t][a]=!1,s.push(o.default.TILE_NOT_LOADED))}this._tiles.push(s)}e||this.connectTiles()}connectTiles(){!function(e,t,s){1!==t&&1!==s||o.default.err("world.js","connectTiles","sizeX or sizeY == 1 not implemented.");for(let a=0;a<t;a++)for(let n=0;n<s;n++)r(`Trying to connect tile ${a},${n} now`),a<t-1&&n<s-1?(r(`>> Connecting tile ${a},${n} now`),e[a][n].connect(e[a+1][n],e[a][n+1])):a<t-1?(r(`>> Connecting tile ${a},${n} now`),e[a][n].connect(e[a+1][n],null)):n<s-1&&(r(`>> Connecting tile ${a},${n} now`),e[a][n].connect(null,e[a][n+1]))}(this._tiles,this._sizeX,this._sizeY)}getLevels(){let e=[];for(let t=0;t<this._tiles.length;t++)for(let s=0;s<this._tiles[t].length;s++)this.tilesLoaded[t][s]&&(e=e.concat(this._tiles[t][s].getLevels()));return e}findTileXYById(e){for(let t=0;t<this._tiles.length;t++)for(let s=0;s<this._tiles[t].length;s++)if(this.tilesLoaded[t][s]){const a=this._tiles[t][s].getLevel().getID();try{if(a===e)return[t,s]}catch(e){let a=`Area ${this.getID()} ERROR`;throw a+=`\nFailed to call getLevel for tile ${t},${s}`,a+="Tile as JSON: ', this._tiles[x][y]",console.error(a),new Error(e)}}return this.printLevelIDs(),null}hasTileWithId(e){for(let t=0;t<this._tiles.length;t++)for(let s=0;s<this._tiles[t].length;s++)if(this.tilesLoaded[t][s]){if(this._tiles[t][s].getLevel().getID()===e)return!0}else if(this._tiles[t][s].level===e)return!0;return!1}hasTiles(e){let t=e.length>0;return e.forEach(e=>{if("function"==typeof e.getID)t=t&&this.hasTileWithId(e.getID());else if(Number.isInteger(e))t=t&&this.hasTileWithId(e);else{const t=JSON.stringify(e);o.default.err("Area","hasTiles",`Invalid level given ${t}. Must be Map.Level/ID`)}}),t}getTileXY(e,t){if(e>=0&&e<this.getSizeX()&&t>=0&&t<this.getSizeY())return this._tiles[e][t];{const s=this.getSizeX(),a=this.getSizeY();o.default.err("Area","getTileXY",`Tile x,y (${e}, ${t}) is out of bounds (${s}, ${a}).`)}return null}addZone(e,t){o.default.isNullOrUndef([t.tileX,t.tileY])&&o.default.err("Area","addZone","No tileX/tileY given!"),this._tiles[t.tileX][t.tileY].addZone(e,t),t.setParent(this)}getZones(e){let t=[];for(let s=0;s<this._tiles.length;s++)for(let a=0;a<this._tiles[s].length;a++)this.tilesLoaded[s][a]&&(t=t.concat(this._tiles[s][a].getZones(e)));return t}createAreaConfig(){return{name:this.getName(),maxX:this._sizeX,maxY:this._sizeY}}toJSON(){const e=super.toJSON(),t=[];this._tiles.forEach((e,s)=>{const a=e.map((e,t)=>this.tilesLoaded[s][t]?e.toJSON():e);t.push(a)});const s={isJSON:!0,conf:this.getConf(),maxX:this._sizeX,maxY:this._sizeY,cols:this._cols,rows:this._rows,tiles:t,tilesLoaded:this.tilesLoaded,zonesCreated:this.zonesCreated};return Object.assign(s,e)}forEachTileLoaded(e){for(let t=0;t<this._tiles.length;t++)for(let s=0;s<this._tiles[t].length;s++)this.tilesLoaded[t][s]&&e(t,s,this._tiles[t][s])}forEachTile(e){for(let t=0;t<this._tiles.length;t++)for(let s=0;s<this._tiles[t].length;s++)e(t,s,this._tiles[t][s])}getPlaceEntities(){let e=[this];return this.forEachTileLoaded((t,s,a)=>{e=e.concat(this._tiles[t][s].getPlaceEntities())}),e}printLevelIDs(){const e=[];this.forEachTile((t,s,a)=>{this.tilesLoaded[t][s]?e.push(this._tiles[t][s].getLevel().getID()):e.push(this._tiles[t][s].level)})}printDebugInfo(){const e=[],t=[],s=[];this.forEachTile((a,n,r)=>{r.isJSON?e.push([a,n]):this.tilesLoaded[a][n]?t.push([a,n]):s.push([a,n])});let a=`Area ID ${this.getID()} debug info:\n`;a+=`\t\nTiles as JSON: ${e.join(" | ")}`,a+=`\t\nTiles LOADED: ${t.join(" | ")}`,a+=`\t\nTiles OTHER: ${s.join(" | ")}`,this.printLevelIDs(),console.log("Tile[0][2]: ",this._tiles[0][2]),console.log(a)}}t.Area=P,t.World.Area=P;class N extends T{constructor(e){super(e),this.setType("mountain")}findLevel(e,t){const s=this.getFaces(),a=this.getSummits();let n=_(e,s,t);return n||(n=_(e,a,t)),n}addSummit(e){this.addSubZone(e)}addFace(e){this.addSubZone(e)}getFaces(){return this._subZones.filter(e=>"face"===e.getType())}getSummits(){return this._subZones.filter(e=>"summit"===e.getType())}connectFaceAndSummit(e,t,s,a){const[n,r]=this.getSubZoneArgs(e,t);if("summit"!==r.getType()){const e=r.getType();o.default.err("World.Mountain","connectFaceAndSummit",`Expected 2nd arg summit, got: ${e}`)}!function(e,t){const s=e.level,a=t.level;let n=Math.floor(s.getMap().cols/2),r=e.y();const o=s.getMap();let i=o.getCell(n,r);for(;i.hasConnection();)(n+=1)===o.cols&&(n=0,r>0&&--r),i=o.getCell(n,r);const l=E(a),[c,h]=[l.getX(),l.getY()],u=new p("stairsUp",s,a),d=new p("stairsDown",a,s);u.connect(d),s.addStairs(u,n,r),a.addStairs(d,c,h)}({y:()=>0,level:n.getLevelN(s)},{level:r.getLevelN(a)})}connectSubZones(e,t,s,a){const[n,r]=this.getSubZoneArgs(e,t);if("face"===n.getType()){if("summit"===r.getType())return void this.connectFaceAndSummit(n,r,s,a)}else if("summit"===n.getType()&&"face"===r.getType())return void this.connectFaceAndSummit(r,n,a,s);super.connectSubZones(e,t,s,a)}toJSON(){const e=super.toJSON(),t={nFaces:this.getFaces().length,face:this.getFaces().map(e=>e.toJSON()),nSummits:this.getSummits().length,summit:this.getSummits().map(e=>e.toJSON())};return Object.assign(t,e)}}t.Mountain=N,t.World.Mountain=N;class I extends A{constructor(e){super(e),this.setType("face"),this._entrance=null}setEntrance(e){this._entrance=e}setEntranceLocation(e){o.default.isNullOrUndef([e])?o.default.err("MountainFace","setEntranceLocation","Arg entrance is not defined."):this._entrance=e}getEntrance(){return C(this._levels,this._entrance)}toJSON(){const e=super.toJSON(),t={};return this._entrance&&(t.entrance=this._entrance),Object.assign(t,e)}addEntrance(e){if(null===this._entrance){const t=this._levels[e],s=new p("stairsDown",t),a=t.getMap(),n=Math.floor(a.cols/2);let r=n,o=a.rows-1;for(;!a.getCell(r,o).isFree();)0===r&&(r=n+1),r<=n&&--r,r>n&&++r,r===a.cols-1&&(r=n,--o);t.addStairs(s,r,o),this._entrance={levelNumber:e,x:r,y:o}}else o.default.err("MountainFace","addEntrance","Entrance already added.")}}t.MountainFace=I,t.World.MountainFace=I;class D extends A{constructor(e){super(e),this.setType("summit")}getEntrance(){return null}}t.MountainSummit=D,t.World.MountainSummit=D;class L extends T{constructor(e){super(e),this.setType("city")}getQuarters(){return this._subZones}addQuarter(e){this.addSubZone(e)||o.default.err("World.City","addQuarter",`City ${this.getName()} quarter not defined.`)}abutQuarters(e,s,a,n){return function(e,s,a,n,r){const o=m.arrayGetRand(["north","south","east","west"]),i=f[o],[l,c]=v(e,s,a),h=l.getLevel(n),u=c.getLevel(r),d=t.addExitsToEdge(h,"exit",o,!0),g=t.addExitsToEdge(u,"exit",i,!0);if(0===d.length||0===g.length)return!1;const p=d,y=g,_=p.length,E=y.length,S=_<=E?_:E;for(let e=0;e<S;e++)p[e].connect(y[e]);return!0}(this._subZones,e,s,a,n)}hasQuarter(e){return this.hasSubZone(e)}toJSON(){const e=super.toJSON(),t={nQuarters:this._subZones.length,quarter:this._subZones.map(e=>e.toJSON())};return Object.assign(t,e)}}t.City=L,t.World.City=L;class R extends A{constructor(e){super(e),this.setType("quarter"),this._entrance=null,this._shops=[]}removeListeners(){this._shops.forEach(e=>{e.isAbandoned()||g.removeListener(e)})}addShop(e){this._shops.push(e)}getShops(){return this._shops}setEntranceLocation(e){o.default.isNullOrUndef([e])?o.default.err("CityQuarter","setEntranceLocation","Arg entrance is not defined."):this._entrance=e}getEntrance(){return C(this._levels,this._entrance)}addEntrance(e){if(null===this._entrance){const t=this._levels[e],s=new p("stairsDown",t);t.addStairs(s,1,1),this._entrance={levelNumber:e,x:1,y:1}}else o.default.err("CityQuarter","addEntrance","Entrance already added.")}connectLevels(){S(this._levels)}toJSON(){const e=super.toJSON(),t={shops:this._shops.map(e=>e.toJSON())};return this._entrance&&(t.entrance=this._entrance),Object.assign(t,e)}}t.CityQuarter=R,t.World.CityQuarter=R;class x extends T{constructor(e){super(e),this.setType("battlezone"),this._levels=[]}addLevel(e){return this._levels.push(e)}getLevels(){return this._levels}toJSON(){const e=super.toJSON(),t=this._levels.length,s={nLevels:t,levels:this._levels.map(e=>e.getID())};return 0===t&&o.default.err("World.BattleZone","toJSON",`Bz ${this.getName()} called without levels`),Object.assign(s,e)}}t.BattleZone=x,t.World.BattleZone=x;class k extends b{constructor(e){super(e),this.setType("world"),this._areas=[],this.currAreaIndex=0,this._conf={}}getConf(){return this._conf}setConf(e){this._conf=e}addArea(e){e.setParent(this),this._areas.push(e)}getLevels(){let e=[];return this._areas.map(t=>{e=e.concat(t.getLevels())}),e}getAreas(){return this._areas}getZones(e){let t=[];return this._areas.forEach(s=>{t=t.concat(s.getZones(e))}),t}getStairs(){const e=[];return this.getZones().forEach(t=>t.getLevels().forEach(t=>t.getStairs().forEach(t=>e.push(t)))),e}getPlaceEntities(){let e=[this];return this._areas.map(t=>{e=e.concat(t.getPlaceEntities())}),e}getCurrentArea(){return this._areas[this.currAreaIndex]}toJSON(){const e=super.toJSON(),t=this._areas.map(e=>e.toJSON());let s=!0;this.getConf().hasOwnProperty("createAllZones")&&(s=this.getConf().createAllZones);const a={conf:this.getConf(),nAreas:this._areas.length,area:t,createAllZones:s};return a.conf.area||(a.conf.area=this.createAreaConfig()),Object.assign(a,e)}createAreaConfig(){const e=[];return this._areas.forEach(function(t){e.push(t.createAreaConfig())}),e}getID2Place(){let e={[this.getID()]:this};return this._areas.forEach(t=>{e[t.getID()]=t}),this.getZones().forEach(t=>{e[t.getID()]=t;const s=t.getID2Place();e=Object.assign(e,s)}),e}}t.WorldTop=k,t.World.WorldTop=k;class B{constructor(){this._shopkeeper=null,this._level=null,this._coord=[],this._isAbandoned=!1,this.hasNotify=!0}setLevel(e){this._level=e}setCoord(e){this._coord=e}isAbandoned(){return this._isAbandoned}notify(e,t){this._shopkeeper&&t.actor.getID()===this._shopkeeper.getID()&&(this.setShopAbandoned(),g.removeListener(this))}getLevel(){return this._level}getShopkeeper(){return this._shopkeeper}setShopkeeper(e){e?(this._shopkeeper=e,g.listenEvent(o.default.EVT_ACTOR_KILLED,this)):o.default.err("WorldShop","setShopkeeper","Tried to set null shopkeeper")}setShopAbandoned(){this._isAbandoned=!0,this._shopkeeper=null,this._coord.forEach(e=>{const t=this.getCell(e);t.getShop().abandonShop();const s=t.getItems();s&&s.forEach(e=>{e.has("Unpaid")&&e.remove("Unpaid")})})}getCell(e){return this._level.getMap().getCell(e[0],e[1])}reclaimShop(e){this._isAbandoned&&(this._isAbandoned=!1,this.setShopkeeper(e),this._coord.forEach(t=>{const s=this.getCell(t);s.getShop().reclaim(e);const a=s.getItems();a&&a.forEach(e=>{e.has("Unpaid")||e.add(new u.Unpaid)})}))}emptyCells(){const e=[];return this._coord.forEach(t=>{const s=this._level.getMap().getCell(t[0],t[1]);s.hasItems()||e.push(s)}),e}refreshShopItems(e){let t=0;this._coord.forEach(s=>{this._level.getMap().getCell(s[0],s[1]).hasItems()||t<e.length&&(e[t].add(new u.Unpaid),this._level.addItem(e[t],s[0],s[1]),++t)})}toJSON(){const e={isAbandoned:this._isAbandoned,level:this._level.getID(),coord:this._coord};return this._isAbandoned||(e.shopkeeper=this._shopkeeper.getID()),e}}t.WorldShop=B,t.World.WorldShop=B,t.World.isZone=function(e){if(e.getType){const t=e.getType();return/(city|battlezone|mountain|dungeon)/.test(t)}return!1}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(41),{KeyMap:o}=r.Keys;t.Menu={},t.Menu.EXIT_MENU=null,t.Menu.NO_ACTION="NO_ACTION",t.Menu.NEXT_STATE="NEXT_STATE";const i=function(e){const t={};return e.forEach((e,s)=>{const a=r.Keys.menuIndices[s];if(e.key){const s=e,a=r.Keys.codeToIndex(s.key);s.menu?t[a]=s.menu:s.func?t[a]=s.func:s.funcToCall&&(t[a]={funcToCall:s.funcToCall})}else if(2===e.length)t[a]=e;else{let e="Each item must have 2 values: menu msg and ret val";e+="\nItem can also be {key: , menu: } for nested menus",n.default.err("menu.js","createMenuTable",e)}}),t};t.Menu.isSelectionDone=function(e){return"function"==typeof e},t.Menu.isMenuItem=function(e){return e&&"object"==typeof e};class l{constructor(e=[]){this.table=i(e),this.msg="",this.pre=[],this.post=[],this._showMenu=!0,this.parent=null}setName(e){this.name=e}setMsg(e){this.msg=e}showMsg(){this.msg.length>0&&n.default.gameMsg(this.msg)}setParent(e){this.parent=e}getParent(){return this.parent}addItem(e,t){const s=r.Keys.codeToIndex(e);this.table[s]=t}showMenu(){return this._showMenu}setCallback(e){this.callback=e}getMenu(){const e={pre:[],post:[]};return Object.keys(this.table).forEach(t=>{const s=r.Keys.menuIndices[t];e[s]=this.table[t][0]}),e.pre=this.pre,e.post=this.post,e}addPost(e){Array.isArray(e)?this.post=this.post.concat(e):this.post.push(e)}addPre(e){Array.isArray(e)?this.pre=this.pre.concat(e):this.pre.push(e)}dbg(...e){console.log(`MENU ${this.name}`,...e)}select(e){const t=r.Keys.codeToIndex(e);if(this.table.hasOwnProperty(t)){const e=this.table[t];return 2===e.length?e[1]:e.funcToCall?e.funcToCall:e}}}t.MenuBase=l,t.Menu.Base=l;class c extends l{constructor(){super()}select(e){return 0===r.Keys.codeToIndex(e)?t.Menu.EXIT_MENU:this}getMenu(){return{0:"Back to game.",pre:this.pre,post:this.post}}}t.MenuInfoOnly=c,n.default.extend2(c,l),t.Menu.InfoOnly=c;class h extends l{constructor(e){super(e);const s=r.Keys.codeToIndex(r.Keys.KEY.QUIT_MENU);this.table[s]=["Quit menu",t.Menu.EXIT_MENU]}select(e){const s=r.Keys.codeToIndex(e);if(this.table.hasOwnProperty(s)){const e=this.table[s][1];return e===t.Menu.EXIT_MENU&&this.onQuit&&this.onQuit(),e}return this}}t.MenuWithQuit=h,t.Menu.WithQuit=h;class u extends l{constructor(e){super(e)}select(e){const t=r.Keys.codeToIndex(e);return this.table.hasOwnProperty(t)?this.table[t][1]:this}}t.MenuSelectRequired=u,t.Menu.SelectRequired=u;class d extends l{constructor(e=[]){super(e),this._enableSelectAll=!1,this._showMenu=!1}enableSelectAll(){this._enableSelectAll=!0}select(e){if(o.inMoveCodeMap(e))return this.callback(e),this;if(o.isSelect(e)){const t=r.Keys.codeToIndex(e),s=this.table[t];return s.funcToCall?s.funcToCall:s}return this._enableSelectAll&&o.isSelectAll(e)?(this.callback(e),this):t.Menu.EXIT_MENU}}t.MenuSelectCell=d,n.default.extend2(d,l),t.Menu.SelectCell=d;t.MenuSelectTarget=class extends d{constructor(e=[]){super(e),this.targetCallback=null}select(e){const s=d.prototype.select.call(this,e);if(s===t.Menu.EXIT_MENU){if(o.isNextTarget(e))return this.targetCallback&&this.targetCallback(e),this;if(o.isPrevTarget(e))return this.targetCallback&&this.targetCallback(e),this;if(e===o.KEY.TARGET){const t=r.Keys.codeToIndex(e),s=this.table[t];return s.funcToCall?s.funcToCall:s}return t.Menu.EXIT_MENU}return s}};class g extends l{constructor(e){super(e),this._showMenu=!1}select(e){if(o.inMoveCodeMap(e)){const t=r.Keys.KeyMap.getDir(e);return this.callback.bind(null,t)}return t.Menu.EXIT_MENU}}t.MenuSelectDir=g,t.Menu.SelectDir=g;t.PlayerMissileMenu=class extends d{constructor(e=[],t){super(e),this.actor=t,this._showMenu=!1;const s=this.actor.getBrain();if(s.selectCell){const e=s.selectCell.bind(s);this.setCallback(e)}else n.default.err("PlayerMissileMenu","constructor","brain does not have selectCell() function");s.startTargeting(),s.hasTargetSelected()?console.log("Brain has target selected"):(s.selectCell(),console.log("Brain no target selected. Using cell."))}select(e){const s=d.prototype.select.call(this,e);if(s!==t.Menu.EXIT_MENU)return s;switch(e){case r.Keys.KEY.NEXT:return this.actor.getBrain().nextTarget(),this;case r.Keys.KEY.PREV:return this.actor.getBrain().prevTarget(),this;case r.Keys.KEY.TARGET:{const t=r.Keys.codeToIndex(e);return this.table[t]}default:return t.Menu.EXIT_MENU}return t.Menu.EXIT_MENU}};class p extends h{constructor(e){super(e),this._showMenu=!0,this.keyToState={},this.stateToTable={},this.stateToPost={},this.stateToPre={},this.menuState=""}select(e){if(this.keyToState.hasOwnProperty(e))return this.menuState=this.keyToState[e],this;{const s=r.Keys.codeToIndex(e);if(this.table.hasOwnProperty(s)){const e=this.table[s][1];return e===t.Menu.EXIT_MENU&&this.onQuit&&this.onQuit(),e}const a=this.stateToTable[this.menuState];if(a.hasOwnProperty(s)){return a[s][1]}return this}}addState(e,t){this.stateToTable[e]=i(t)}addTransition(e,t){this.keyToState[t]=e}getMenu(){const e=h.prototype.getMenu.call(this),t=this.menuState,s=this.stateToTable[t];let a={pre:this.pre,post:this.post};return Object.keys(s).forEach(e=>{const t=r.Keys.menuIndices[e];a[t]=s[e][0]}),a=Object.assign(a,e),this.stateToPre[t]&&a.pre.push(this.stateToPre[t]),this.stateToPost[t]&&a.post.push(this.stateToPost[t]),a}addPreState(e,t){t?this.stateToPre[t]=e:h.prototype.addPre.call(this,e)}addPostState(e,t){t?this.stateToPost[t]=e:h.prototype.addPost.call(this,e)}}t.MenuWithState=p,t.Menu.WithState=p},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(49),o=s(7),i=function(e,t){const s=e.length;if(s){for(;t<s;)e[t]=e[t+1],t++;e.length--}};class l extends r.GameObject{static createEntityID(){return r.GameObject.createObjectID()}static setPool(e){l.POOL=e}static getIDCount(){return r.GameObject.ID}constructor(...e){super(),this.comps={},this.compsByType={}}remove(e){if(++l.num.remove,"object"==typeof e){const t=e.getID();if(this.comps.hasOwnProperty(t)){const e=this.comps[t],s=e.getType();e.entityRemoveCallback(this),delete this.comps[t];const a=this.compsByType[s].indexOf(e);i(this.compsByType[s],a),0===this.compsByType[s].length&&delete this.compsByType[s],l.POOL.emitEvent(s,{entity:this,remove:!0})}}else if(Number.isInteger(e)){const t=e;this.comps[t]&&this.remove(this.comps[t])}else{const t=this.get(e);if(t)this.remove(t);else{const t=parseInt(e,10);if(t)this.remove(t);else{const t=typeof e;n.default.warn("Entity","remove",`No comp found ->  |${e}|, type: ${t}`)}}}}equals(e){return this.getID()===e.getID()}get(e){return++l.num.get,this.compsByType[e]?this.compsByType[e][0]:null}getByID(e){return this.comps[e]}getList(e){return++l.num.getList,this.compsByType[e]?this.compsByType[e].slice():[]}add(e){"string"==typeof e&&n.default.err("Entity","add","No string support anymore"),++l.num.add;const t=e.getType();e.isUnique()&&this.has(t)&&this.removeAll(t),this.comps[e.getID()]=e,this.compsByType.hasOwnProperty(t)?this.compsByType[t].push(e):this.compsByType[t]=[e],e.entityAddCallback(this),l.POOL.emitEvent(t,{entity:this,add:!0})}has(e){return++l.num.has,!!this.compsByType.hasOwnProperty(e)||this.comps.hasOwnProperty(e)}hasAny(e){++l.num.hasAny;for(const t of e)if(this.compsByType.hasOwnProperty(t))return!0;return!1}hasNone(e){return!this.hasAny(e)}hasAll(e){for(const t of e)if(!this.compsByType.hasOwnProperty(t))return!1;return!0}removeAll(e){++l.num.removeAll;let t=e;if("object"==typeof e&&(t=e.getType()),this.has(t)){this.compsByType[t].slice().forEach(e=>{this.remove(e)})}}replace(e,t){this.removeAll(e),t?this.add(t):this.add(e)}getComponents(){return this.comps}copy(e){throw new Error("copy() not implemented in Entity")}clone(){throw new Error("clone() not implemented in Entity")}toJSON(){throw new Error("toJSON() not implemented in Entity")}}t.Entity=l,l.setPool(o.EventPool.getPool()),l.num={},l.num.add=0,l.num.get=0,l.num.getList=0,l.num.has=0,l.num.hasAny=0,l.num.hasAll=0,l.num.remove=0,l.num.removeAll=0},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(1).Random.getRNG();t.Placer={},t.Placer.addPropsToFreeCells=function(e,s,a){const n=e.getMap().getFree();t.Placer.addPropsToCells(e,n,s,a)},t.Placer.addPropsToCells=function(e,t,s,a){for(let o=0;o<s.length;o++)if(t.length>0){const i=r.randIndex(t),l=t[i];a===n.default.TYPE_ACTOR?e.addActor(s[o],l.getX(),l.getY()):a===n.default.TYPE_ITEM?e.addItem(s[o],l.getX(),l.getY()):n.default.err("Placer","addPropsToCells",`Type ${a} not supported`),t.splice(i,1)}},t.Placer.addPropsToRoom=function(e,s,a){Array.isArray(a)||n.default.err("Placer","addPropsToRoom",`props must be an array. Got: ${a}`);const r=s.getBbox(),o=a[0];n.default.isActor(o)?t.Placer.addActorsToBbox(e,r,a):n.default.isItem(o)?t.Placer.addItemsToBbox(e,r,a):n.default.err("Placer","addPropsToRoom",`Prop type not supported: ${o}`)},t.Placer.addActorsToBbox=function(e,s,a){const r=a.length,o=e.getMap().getFreeInBbox(s);o.length<r&&n.default.warn("Factory","addActorsToBbox","Not enough free cells"),t.Placer.addPropsToCells(e,o,a,n.default.TYPE_ACTOR)},t.Placer.addItemsToBbox=function(e,s,a){const r=e.getMap().getFreeInBbox(s);t.Placer.addPropsToCells(e,r,a,n.default.TYPE_ITEM)},t.Placer.addEntityToCellType=function(e,t,s){let a=!1;const o=t.getMap().getCells(s);if(0===o.length)return!1;const i=r.arrayGetRand(o),[l,c]=i.getXY();return n.default.isActor(e)?a=t.addActor(e,l,c):n.default.isItem(e)?a=t.addItem(e,l,c):n.default.isElement(e)&&(a=t.addElement(e,l,c)),a}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(1),i=s(24),l=s(6),c=n(s(2)),h=o.Random.getRNG();t.ItemRandomizer=function(){this.adjustItem=((e,t)=>{const s=e.getType();n.hasOwnProperty(s)&&n[s](e,t)});const e=r.default.getFoodWeightDistr(),t=e=>{const t=h.getUniformInt(5,15);e.setCount(t)},s=e=>{const t=h.getUniform();if((e=>e>=0&&e<=.02)(t)){const t=h.getUniformInt(1,5);switch(h.getUniformInt(0,4)){case 0:case 1:e.setAttack(e.getAttack()+t);break;case 2:case 3:e.setDefense(e.getDefense()+t);break;case 4:e.setProtection(e.getProtection()+t)}r.default.scaleItemValue("combat",t,e)}else if((e=>e>=.1&&e<=.12)(t)){const t=h.getUniformInt(1,3);let s=null;e.has("Stats")?s=e.get("Stats"):((s=new c.Stats).clearValues(),e.add(s));const a=(()=>h.arrayGetRand(r.default.STATS))(),n="get"+a;s["set"+a](s[n]()+t),r.default.scaleItemValue("stats",t,e)}},a=r.default.getRuneChargeDistr(),n={food:t=>{const s=h.getWeighted(e);t.setWeight(s)},goldcoin:(e,t)=>{if(r.default.isNullOrUndef([t]))r.default.err("ItemRandomizer","_adjustGoldCoin","nLevel is not defined.");else{const s=r.default.getGoldCoinCountDistr(t),a=h.getWeighted(s);e.setCount(parseInt(a,10))}},missile:t,weapon:s,armour:e=>{s(e)},ammo:t,rune:e=>{const t=h.getWeighted(a);e.setCharges(t)}}},t.FactoryItem=function(){this._itemRandomizer=new t.ItemRandomizer;const e=(e,t)=>{this._itemRandomizer.adjustItem(e,t)};this.createItem=function(e){return l.ObjectShell.getParser().createRandomItem(e)},this.addNRandItems=((t,s)=>{const a=this.generateItems(s),n=l.ObjectShell.getParser();if(s.food){const t=n.createRandomItem({func:e=>"food"===e.type});t?(e(t,s.maxValue),a.push(t)):r.default.warn("FactoryItem","addNRandItems","Item.Food was not created properly.")}return i.Placer.addPropsToFreeCells(t,a,r.default.TYPE_ITEM),a.length}),this.generateItems=function(t){const s=t.itemsPerLevel||t.nItems,a=[],n=l.ObjectShell.getParser();for(let r=0;r<s;r++){const s=n.createRandomItem({func:t.func});s&&(e(s,t.maxValue),a.push(s))}return a},this.generateGold=function(t){const s=t.goldPerLevel||t.nGold,a=l.ObjectShell.getParser(),n=[];for(let o=0;o<s;o++){const s=a.createActualObj(r.default.TYPE_ITEM,r.default.GOLD_COIN_NAME);e(s,t.nLevel),n.push(s)}return n},this.addRandomGold=((e,t,s)=>{const a=this.generateGold(s);i.Placer.addPropsToFreeCells(e,a,r.default.TYPE_ITEM)}),this.getShopItem=((t,s)=>{let a=null;return s.shopFunc?"function"==typeof s.shopFunc[t]?a=s.parser.createRandomItem({func:s.shopFunc[t]}):r.default.err("FactoryItem","createShop -> getShopItem","shopFunc must be a function."):a=Array.isArray(s.shopType)?s.parser.createRandomItem({func:e=>e.type===s.shopType[t]}):"string"==typeof s.shopType?s.parser.createRandomItem({func:e=>e.type===s.shopType}):s.parser.createRandomItem({func:e=>e.value<=50+100*t}),e(a,50+100*t),a}),this.addItemsToCells=function(e,t,s,a){a.maxValue||r.default.err("FactoryItem","addItemsToCells","conf is missing maxValue");const n=this.generateItems(a);i.Placer.addPropsToCells(e,s,n,r.default.TYPE_ITEM)}},t.FactoryItem.addItemsToActor=function(e,t){const s=l.ObjectShell.getParser();let a=null;t.forEach(t=>{"string"==typeof t?a=s.createItem(t):"object"==typeof t&&(a=s.createItem(t.name)),a&&e.getInvEq().addItem(a)})},t.FactoryItem.equipFullGearType=function(e,s){const a=l.ObjectShell.getParser(),n=new RegExp(s),r=a.filterItems(e=>"armour"===e.type&&n.test(e.name));return t.FactoryItem.equipItemsToActor(e,r)},t.FactoryItem.equipWeaponOfType=function(e,s){const a=l.ObjectShell.getParser(),n=new RegExp(s),r=a.filterItems(e=>"weapon"===e.type&&n.test(e.name)),o=h.arrayGetRand(r);return t.FactoryItem.equipItemsToActor(e,[o])},t.FactoryItem.equipItemsToActor=function(e,t){const s=l.ObjectShell.getParser();let a=null,n=!0;return t.forEach(t=>{if("string"==typeof t)a=s.createItem(t);else if("object"==typeof t){a=s.createItem(t.name);const e=t.count||1;a.setCount(e)}if(a){const t=a.getCount();e.getInvEq().addItem(a),n=n&&e.getInvEq().equipNItems(a,t)}}),n}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(43),o=s(116),i=s(1),l=s(10);r.Goal.Thief=o.GoalThief,t.Evaluator={},t.Evaluator.hist={},t.Evaluator.NOT_POSSIBLE=n.default.BIAS.NOT_POSSIBLE,t.Evaluator.ALWAYS=n.default.BIAS.ALWAYS;const c=i.Random.getRNG();class h{constructor(e){this.actorBias=e,this.type="Base"}calculateDesirability(e){throw new Error("Pure virtual function")}setActorGoal(e,...s){const a=e.getBrain().getGoal();if(r.Goal[this.type]){const n=new r.Goal[this.type](e,...s);a.addGoal(n),++t.Evaluator.hist[this.type]}else n.default.err("EvaluatorBase","setActorGoal",`No Goal.${this.type} found!`)}isOrder(){return!1}getType(){return this.type}setBias(e){this.actorBias=e}toJSON(){return{type:this.getType(),bias:this.actorBias}}setArgs(e){}}t.EvaluatorBase=h,t.Evaluator.Base=h;class u extends h{constructor(e){super(e),this.type="AttackActor"}calculateDesirability(e){const s=e.getBrain(),a=s.getSeenCells(),n=s.findEnemyCell(a);if(n){const e=1;return this.enemyActor=n.getActors()[0],this.actorBias*e*2}return t.Evaluator.NOT_POSSIBLE}setActorGoal(e){super.setActorGoal(e,this.enemyActor)}}t.EvaluatorAttackActor=u,t.Evaluator.AttackActor=u,t.Evaluator.hist.AttackActor=0;class d extends h{constructor(e){super(e),this.type="Explore"}calculateDesirability(){return this.actorBias}}t.EvaluatorExplore=d,t.Evaluator.Explore=d,t.Evaluator.hist.Explore=0;class g extends h{constructor(e){super(e),this.type="Flee"}calculateDesirability(e){const s=e.getBrain().getSeenEnemies();if(s.length>0){const t=e.get("Health"),a=t.getMaxHP(),n=t.getHP()/a;if(n<this.actorBias){let e=-1;this.enemyActor&&(e=s.findIndex(e=>e.getID()===this.enemyActor.getID())),-1===e&&(this.enemyActor=s[0]);const t=Math.pow(n,2);return this.actorBias*(1-n)/t}}return this.enemyActor=null,t.Evaluator.NOT_POSSIBLE}setActorGoal(e){if(this.enemyActor){const s=e.getBrain().getGoal(),a=new r.Goal.FleeFromActor(e,this.enemyActor);s.addGoal(a),++t.Evaluator.hist[this.type]}else n.default.err("EvaluatorFlee","setActorGoal","Enemy actor is null. Cannot flee.")}}t.EvaluatorFlee=g,t.Evaluator.Flee=g,t.Evaluator.hist.Flee=0;class p extends h{constructor(e,t=[]){super(e),this.type="Patrol",this.coords=t}setCoords(e){this.coords=e}calculateDesirability(){return this.actorBias}setActorGoal(e){const s=e.getBrain().getGoal(),a=this.coords;if(a.length>0){const n=new r.Goal.Patrol(e,a);s.addGoal(n),++t.Evaluator.hist[this.type]}else n.default.err("EvaluatorPatrol","setActorGoal","No guard points set with setCoords()")}setArgs(e){this.coords=e.coords}toJSON(){const e=super.toJSON();return e.args={coords:this.coords},e}}t.EvaluatorPatrol=p,t.Evaluator.Patrol=p,t.Evaluator.hist.Patrol=0;class m extends h{constructor(e,t){super(e),this.type="Guard",t&&this.setXY(t)}setXY(e){this.x=e[0],this.y=e[1]}setArgs(e){const{xy:t}=e;this.setXY(t)}calculateDesirability(){return this.actorBias}setActorGoal(e){const s=e.getBrain().getGoal(),a=new r.Goal.Guard(e,[this.x,this.y]);s.addGoal(a),++t.Evaluator.hist[this.type]}toJSON(){const e=super.toJSON();return e.args={xy:[this.x,this.y]},e}}t.EvaluatorGuard=m,t.Evaluator.Guard=m,t.Evaluator.hist.Guard=0;class f extends h{constructor(e){super(e),this.type="Orders",this.goal=null}setArgs(e){this.goal=e.goal,this.srcActor=e.srcActor}calculateDesirability(){let e=this.goal.getCategory()===r.Goal.Types.Kill?.5:1;return e*=this.actorBias,this.acceptsOrdersFromSource()?1*e:0}acceptsOrdersFromSource(){return!!this.srcActor.has("Commander")||!!this.srcActor.isPlayer()}setActorGoal(e){if(this.goal){e.getBrain().getGoal().addGoal(this.goal),++t.Evaluator.hist[this.type]}else n.default.err("EvaluatorOrder","setActorGoal","this.goal must not be null")}setSubEvaluator(e){this.subEval=e}isOrder(){return!0}}t.EvaluatorOrders=f,t.Evaluator.Orders=f,t.Evaluator.hist.Orders=0;class y extends h{constructor(e){super(e),this.type="CastSpell",this._castingProb=.2}setCastingProbability(e){this._castingProb=e}getCastingProbability(){return this._castingProb}calculateDesirability(e){return this.spell=this.getRandomSpell(e),this.spell&&this.canCastSpell(e)&&this.shouldCastSpell(e)?this.actorBias:0}setActorGoal(e){if(this.spell){const s=e.getBrain().getGoal(),a=new r.Goal.CastSpell(e,this.spell,this.spellArgs);s.addGoal(a),++t.Evaluator.hist[this.type]}else n.default.err("EvaluatorFlee","setActorGoal","Enemy actor is null. Cannot flee.")}getRandomSpell(e){const t=e.getBook();if(t&&t.getSpells().length>0){return c.arrayGetRand(t.getSpells())}return null}canCastSpell(e){if(e.has("SpellPower")){if(e.get("SpellPower").getPP()>=this.spell.getCastingPower()&&c.getUniform()<=this._castingProb)return!0}return!1}shouldCastSpell(e){const t=e.getBrain(),s=t.getSeenCells(),a=t.findEnemyCell(s),r={actor:e,actorCellsAround:l.Brain.getActorCellsAround(e)};if(a&&(r.enemy=a.getActors()[0]),this.spell.aiShouldCastSpell)return this.spell.aiShouldCastSpell(r,(e,t)=>{this.spellArgs=t});{let e=`Spell ${this.spell.getName()} cannot be cast by AI`;e+=" no aiShouldCastSpell() defined for the spell",n.default.warn("Evaluator.CastSpell","shouldCastSpell",e)}return!1}}t.EvaluatorCastSpell=y,t.Evaluator.CastSpell=y,t.Evaluator.hist.CastSpell=0;class _ extends h{constructor(e){super(e),this.type="Shopkeeper"}calculateDesirability(e){return e.has("Shopkeeper")?this.actorBias:(n.default.err("EvaluatorShopkeeper","calculateDesirability",`An actor is not shopkeeper: ${e}`),0)}setActorGoal(e){const s=e.getBrain().getGoal(),a=new r.Goal.Shopkeeper(e,this.x,this.y);s.addGoal(a),++t.Evaluator.hist[this.type]}setArgs(e){const{xy:t}=e;this.x=t[0],this.y=t[1]}toJSON(){const e=super.toJSON();return e.args={xy:[this.x,this.y]},e}}t.EvaluatorShopkeeper=_,t.Evaluator.Shopkeeper=_,t.Evaluator.hist.Shopkeeper=0;class E extends h{constructor(e){super(e),this.type="GoHome",this.timeToHomeSick=c.getUniformInt(20,40),this.timeToStay=0,this.maxDistHome=5}calculateDesirability(e){if(this.timeToHomeSick>0)return this.timeToHomeSick-=1,0;if(0===this.timeToHomeSick&&(this.timeToHomeSick=-1,this.timeToStay=c.getUniformInt(20,40)),this.timeToStay>0){const t=[this.x,this.y];return n.default.withinRange(this.maxDistHome,t,e)&&(this.timeToStay-=1),this.actorBias}return 0===this.timeToStay&&(this.timeToStay=-1,this.timeToHomeSick=c.getUniformInt(20,40)),0}setActorGoal(e){const s=e.getBrain().getGoal(),a=new r.Goal.GoHome(e,this.x,this.y,this.maxDistHome);s.addGoal(a),++t.Evaluator.hist[this.type]}setArgs(e){const{xy:t}=e;this.x=t[0],this.y=t[1],this.timeToHomeSick=e.timeToHomeSick}toJSON(){const e=super.toJSON();return e.args={xy:[this.x,this.y],timeToHomeSick:this.timeToHomeSick},e}}t.EvaluatorGoHome=E,t.Evaluator.GoHome=E,t.Evaluator.hist.GoHome=0;class S extends h{constructor(e){super(e),this.type="Thief"}calculateDesirability(){return this.actorBias}}t.EvaluatorThief=S,t.Evaluator.Thief=S,t.Evaluator.hist.Thief=0;class v extends h{constructor(e){super(e),this.type="Communicate"}calculateDesirability(e){if(this.willCommunicate(e))return this.actorBias}willCommunicate(e){const t=e.getBrain(),s=c.getUniform(),a=t.getSeenCells(),r=t.findFriendCell(a),o=t.getMemory();let i=null;return!n.default.isNullOrUndef([r])&&(i=r.getActors()[0],!o.hasCommunicatedWith(i)&&(!i.has("Communication")&&!(s<1-this.actorBias)))}}t.EvaluatorCommunicate=v,t.Evaluator.Communicate=v},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(12)),r=a(s(0)),o=s(74),i=s(5),l=s(9),c=new i.ElementBase("floor"),h=new i.ElementWall("wall");class u{static invertMap(e){for(let t=0;t<e.cols;t++)for(let s=0;s<e.rows;s++){const a=e._map[t][s].getBaseElem().getType();"wall"===a?e._map[t][s].setBaseElem(c):"floor"===a&&e._map[t][s].setBaseElem(h)}}static createWithoutCells(e,t){const s=new u(0,0);s._map=new Array(e);for(let a=0;a<e;a++)s._map[a]=new Array(t);return s.cols=e,s.rows=t,s}constructor(e,t,s=c){this._map=[],this.cols=e,this.rows=t,"number"==typeof this.cols&&"number"==typeof this.rows||r.default.err("Map.CellList","constructor","Map.CellList(rows, cols) expects 2 integers."),this._map=new Array(this.cols);for(let e=0;e<this.cols;e++){this._map[e]=new Array(this.rows);for(let t=0;t<this.rows;t++)this._map[e][t]=new o.Cell(e,t,s)}this.fov=new n.default.FOV.RecursiveShadowcasting(this.lightPasses.bind(this)),this.passableCallback=this.passableCallback.bind(this),this.passableCallbackFlying=this.passableCallbackFlying.bind(this)}hasXY(e,t){return e>=0&&e<this.cols&&t>=0&&t<this.rows}setProp(e,t,s,a){this._map[e][t].setProp(s,a)}removeProp(e,t,s,a){return this._map[e][t].removeProp(s,a)}moveProp(e,t,s,a){return!!this.removeProp(e[0],e[1],s,a)&&(this.setProp(t[0],t[1],s,a),!0)}setElemXY(e,t,s){this.setProp(e,t,r.default.TYPE_ELEM,s)}setBaseElemXY(e,t,s){this._map[e][t].setBaseElem(s)}getBaseElemXY(e,t){return this._map[e][t].getBaseElem()}getCell(e,t){return this._map[e][t]}isExplored(e,t){return this._map[e][t].isExplored()}getBaseElemRow(e){const t=[];for(let s=0;s<this.cols;++s)t.push(this._map[s][e].getBaseElem());return t}getCellRow(e){const t=[];for(let s=0;s<this.cols;++s)t.push(this._map[s][e]);return t}getFree(){const e=[];for(let t=0;t<this.cols;t++)for(let s=0;s<this.rows;s++)this._map[t][s].isFree()&&e.push(this._map[t][s]);return e}getFreeNotOnEdge(){return this.getFree().filter(e=>e._x>0&&e._x<this.cols-1&&e._y>0&&e._y<this.rows-1)}getFirstFreeFromRight(e=0,t=this.rows-1){for(let s=this.cols-1;s>=0;s--)for(let a=e;a<=t;a++)if(this._map[s][a].isFree())return this._map[s][a];return null}getFreeInBbox(e){const t=[];for(let s=e.ulx;s<=e.lrx;s++)for(let a=e.uly;a<e.lry;a++)this._map[s][a].isFree()&&t.push(this._map[s][a]);return t}getEmptyCells(){const e=[];for(let t=0;t<this.cols;t++)for(let s=0;s<this.rows;s++)this._map[t][s].hasProps()||e.push(this._map[t][s]);return e}lightPasses(e,t){return!!this.hasXY(e,t)&&this._map[e][t].lightPasses()}hasObstacle(e,t){return!!this.hasXY(e,t)&&this._map[e][t].hasObstacle()}isPassable(e,t){return!!this.hasXY(e,t)&&this._map[e][t].isPassable()}isPassableByAir(e,t){return!!this.hasXY(e,t)&&this._map[e][t].isPassableByAir()}getVisibleCells(e){const t=[],[s,a]=e.getXY(),n=e.getFOVRange();return e.isLocated()&&e.getLevel().getMap()===this&&this.fov.compute(s,a,n,(e,s,a,n)=>{n&&this.hasXY(e,s)&&t.push(this._map[e][s])}),t}getExploredCells(){const e=[];for(let t=0;t<this.cols;t++)for(let s=0;s<this.rows;s++)this._map[t][s].isExplored()&&e.push(this._map[t][s]);return e}exploreAll(e=!0){for(let t=0;t<this.cols;t++)for(let s=0;s<this.rows;s++)this._map[t][s]._explored=e}isBorderXY(e,t){return 0===e||(0===t||(e===this.cols-1||t===this.rows-1))}debugPrintInASCII(){let e="";for(let t=0;t<this.rows;t++){let s="";for(let e=0;e<this.cols;e++){const a=this._map[e][t],n=a.getBaseElem();if(!n){s+="X";continue}const r=n.getType();if(a.hasActors())a.getFirstActor().isPlayer()?s+="@":s+="A";else if(a.hasItems())s+="I";else if(null!==a.getStairs())s+=">";else if(a.hasConnection())s+="c";else if(a.hasElements()){const e=a.getElements()[0];if("marker"===e.getType()){s+=e.char}else"door"===e.getType()?s+="+":s+="E"}else/floor/.test(r)?s+=".":/water|chasm|lava/.test(r)?s+="~":/wall/.test(r)?s+="#":/tree/.test(r)?s+="T":/grass/.test(r)?s+='"':/highrock/.test(r)?s+="^":/road/.test(r)?s+="R":/arctic/.test(r)?s+=".":s+="?"}e+=s+"\n"}r.default.diag(e)}getCellRowFast(e){return this._isRowOptimized||this._optimizeForRowAccess(),this._rowMap[e]}findObj(e){let t=[];for(let s=0;s<this.cols;s++)for(let a=0;a<this.rows;a++)t=t.concat(this._map[s][a].findObj(e));return t}getCells(e=(e=>!0)){const t=[];for(let s=0;s<this.cols;s++)for(let a=0;a<this.rows;a++)e(this._map[s][a])&&t.push(this._map[s][a]);return t}getCellsWithCoord(e){const t=[];return e.forEach(e=>{this.hasXY(e[0],e[1])&&t.push(this._map[e[0]][e[1]])}),t}setBaseElems(e,t){e.forEach(e=>{this._map[e[0]][e[1]].setBaseElem(t)})}has(e,t){const[s,a]=e;if(this.hasXY(s,a)){const e=this.getCell(s,a);if("string"==typeof t){if(e.getBaseElem().getType()===t)return!0}}return!1}_optimizeForRowAccess(){this._rowMap=[];for(let e=0;e<this.rows;e++){this._rowMap[e]=[];for(let t=0;t<this.cols;t++)this._rowMap[e][t]=this._map[t][e]}this._isRowOptimized=!0}toJSON(){const e=new Array(this.cols),t={},s=[],a={};for(let n=0;n<this.cols;n++){e[n]=new Array(this.rows);for(let r=0;r<this.rows;r++){const o=this.getCell(n,r).toJSON();e[n][r]=o.t,a[o.t]=0,o.ex&&s.push([n,r]),o.elements&&(t[n+","+r]=t)}}return{cols:this.cols,rows:this.rows,cells:e,explored:s,elements:t,baseTypes:a}}toJSONEncoded(){const e=this.toJSON(),{cells:t,baseTypes:s}=e;for(let e=0;e<this.cols;e++)for(let a=0;a<this.rows;a++)s[t[e][a]]+=1;let a=-1,n=0;Object.keys(s).forEach(e=>{s[e]>n&&(n=s[e],a=parseInt(e,10))});const r={};for(let e=0;e<this.cols;e++)for(let s=0;s<this.rows;s++)t[e][s]!==a&&(r[e]||(r[e]=[]),r[e].push([s,t[e][s]]));return delete e.cells,e.defaultType=a,e.cellsXY=r,e.encoded=!0,e}getShortestPathTo(e,t,s){const[a,r]=e.getXY();let o=this.passableCallback.bind(null,a,r);e.has("Flying")&&(o=this.passableCallbackFlying.bind(null,a,r));const i=new n.default.Path.AStar(t,s,o),l=[];return i.compute(a,r,(e,t)=>{this.hasXY(e,t)&&l.push(this._map[e][t])}),l}getShortestPathCached(e,t,s){return[]}passableCallback(e,t,s,a){let n=this.isPassable(s,a);return n||(n=s===e&&a===t),n}passableCallbackFlying(e,t,s,a){let n=this.isPassableByAir(s,a);return n||(n=s===e&&a===t),n}moveCellUnsafe(e,t,s){s.setXY([e,t]),this._map[e][t]=s}}t.CellMap=u,u.fromJSON=function(e){if(e.encoded){const{defaultType:t}=e,s=l.ELEM_MAP.elemIndexToElemObj[t],a=new u(e.cols,e.rows,s);return Object.keys(e.cellsXY).forEach(t=>{const s=e.cellsXY[t],n=parseInt(t,10);s.forEach(e=>{const t=l.ELEM_MAP.elemIndexToElemObj[e[1]];a.setBaseElemXY(n,e[0],t)})}),e.explored.forEach(e=>{const[t,s]=e;a._map[t][s].setExplored()}),a}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(1),i=s(3),l=s(26),c=s(24),h=s(25),u=s(79),d=n(s(2)),g=s(21),p=n(s(19)),m=n(s(5)),f=s(6),y=2,_=o.Random.getRNG(),E=["NOTHING","LOOT","GOLD","GUARDIAN","ELEMENT","CORPSE","TIP"];t.DungeonPopulate=class{constructor(e={}){this.theme=e.theme||"",this.maxDanger=e.maxDanger||5,this.maxValue=e.maxValue||50,this._itemFact=new h.FactoryItem,this._actorFact=new u.FactoryActor}populateLevel(e){const t=e.getExtras(),s=this.maxDanger,a=this.maxValue;let n=!1;const r={};t.bigRooms&&t.bigRooms.forEach(t=>{const{room:o,type:i}=t,l=o.getBbox(),c=o.getAreaSize(),h={maxDanger:s,func:e=>e.danger<=s+2,nActors:0};if(/cross/.test(i)?(h.nActors=Math.floor(c/6),this.addActorsToBbox(e,l,h)):(h.nActors=Math.floor(c/3),this.addActorsToBbox(e,l,h)),!n){const t=o.getCenter();n=this.addMainLoot(e,t,a)}r[o.getID()]=!0}),t.terms&&t.terms.forEach(t=>{if(!t.hasStairsUp()){const s=t.getBbox();if(!n){const s=t.getCenter();n=this.addMainLoot(e,s,a)}const r=t.getAreaSize(),o=Math.ceil(r/10),l={maxValue:a,itemsPerLevel:o,func:e=>e.value<=a};this.addItemsToBbox(e,s,l),i.Geometry.getCoordBbox(s).forEach(t=>{const s=new m.ElementMarker("e");s.setTag("enemy"),e.addElement(s,t[0],t[1])})}r[t.getID()]=!0}),t.rooms&&t.rooms.forEach(t=>{const n=t.getBbox(),o=t.getAreaSize(),i={maxDanger:s,func:e=>e.danger<=s,nActors:Math.floor(o/6)};i.nActors<y&&(i.nActors=y),this.addActorsToBbox(e,n,i);const l=Math.ceil(o/20),c={maxValue:a,itemsPerLevel:l,func:e=>e.value<=a};this.addItemsToBbox(e,n,c),r[t.getID()]=!0}),t.endPoint&&this.addPointGuardian(e,t.endPoint,s)}setActorFunc(e){"function"==typeof e?this.actorFunc=e:r.default.err("DungeonPopulate","setActorFunc",`Tried to set non-function ${e} as actorFunc`)}addPointGuardian(e,t,s){const a=t;(r.default.isNullOrUndef([s])||s<1)&&r.default.err("DungeonPopulate","addPointGuardian",`maxDanger must be > 0. Got: |${s}|`);const n=this.getEndPointGuardian(s);if(n){if(n.getBrain().getGoal){const e=new l.Evaluator.Guard(r.default.BIAS.Guard,a);n.getBrain().getGoal().addEvaluator(e)}e.addActor(n,a[0],a[1])}else{const e=`Could not get guardian for endpoint: ${t}`;r.default.warn("DungeonPopulate","addPointGuardian",e)}}getEndPointGuardian(e){let t=e,s=null,a=e=>e.danger<=t;for(this.actorFunc&&(a=(e=>this.actorFunc(e)&&e.danger<=t));!s&&t>0;)s=this._actorFact.createRandomActor({func:a}),--t;return s}addMainLoot(e,t,s){const[a,n]=t,r=_.getUniformInt(2,3),o=r*s,i=(r-1)*s,l=this._itemFact.createItem({func:e=>e.value>=i&&e.value<=o});return!!l&&(e.addItem(l,a,n),!0)}populatePoint(e,t,s){const{maxDanger:a}=s;switch(_.arrayGetRand(E)){case"NOTHING":break;case"LOOT":this.addLootToPoint(e,t);break;case"GUARDIAN":this.addPointGuardian(e,t,a);break;case"ELEMENT":this.addElementToPoint(e,t,s);break;case"CORPSE":this.addCorpseToPoint(e,t,s);break;case"GOLD":this.addGoldToPoint(e,t);break;case"TIP":this.addTipToPoint(e,t,s)}}addElementToPoint(e,t,s){s.true}addCorpseToPoint(e,t,s){s.true}addLootToPoint(e,t){const s=this.maxValue,a=[r.default.ITEM_POTION,r.default.ITEM_SPIRITGEM,r.default.ITEM_AMMUNITION,r.default.ITEM_POTION,r.default.ITEM_RUNE],n=_.arrayGetRand(a),o=f.ObjectShell.getParser().createRandomItem({func:e=>e.type>=n&&e.value<=s});if(o){const[s,a]=t;return e.addItem(o,s,a),!0}return!1}addGoldToPoint(e,t){const s=this.maxValue,a=new p.GoldCoin;a.setCount(s);const[n,r]=t;e.addItem(a,n,r)}addTipToPoint(e,t,s){s.true}createShops(e,t){const s=e.getExtras(),a=[];if(s.hasOwnProperty("houses")){const n=s.houses,o=[];let i=0;s.shops=[];for(let c=0;c<t.nShops;c++){const h=new g.WorldShop;let u=_.randIndex(n);for(;o.indexOf(u)>=0;)u=_.randIndex(n),++i==2*n.length&&r.default.err("DungeonPopulate","createShops","WatchDog reached max houses");o.push(u);const p=s.houses[u];a.push(p);const f=p.floor,[y,E]=p.door,S=e.getMap().getCell(y,E);if(!S.hasDoor()){const t=new m.ElementDoor(!0);e.addElement(t,y,E)}const v=this.createShopkeeper(t),C=[];let b=!1;for(let s=0;s<f.length;s++){const a=f[s],n=new m.ElementShop;n.setShopkeeper(v),e.addElement(n,a[0],a[1]),0===s&&(b=!0,e.addActor(v,a[0],a[1]));const o=this._itemFact.getShopItem(c,t);if(o)o.add(new d.Unpaid),e.addItem(o,a[0],a[1]),C.push(a);else{const e="item null. "+`conf: ${JSON.stringify(t)}`;r.default.err("DungeonPopulate","createShop",`${e} shopFunc/type${c} not well defined.`)}}if(!b){const e=JSON.stringify(p);r.default.err("DungeonPopulate","createShops","Could not add keeper to "+e)}if(v.has("Shopkeeper")){const t=v.get("Shopkeeper");t.setCells(C),t.setLevelID(e.getID()),t.setDoorXY(S.getXY());const s=v.getType()+" shopkeeper";v.setName(s),r.default.addCellStyle(r.default.TYPE_ACTOR,s,"cell-actor-shopkeeper");const a=_.arrayGetRand(C);if(v.getBrain().getGoal){const e=new l.Evaluator.Shopkeeper(1.5);e.setArgs({xy:a}),v.getBrain().getGoal().addEvaluator(e)}}h.setShopkeeper(v),h.setLevel(e),h.setCoord(C),s.shops.push(h)}}else r.default.err("DungeonPopulate","createShops","No houses in extras.");return a}createShopkeeper(e){let t=null;if(e.parser)if(e.actor){if(!(t=e.parser.createRandomActor({func:e.actor}))){let t="conf.actor given but no actor found";"function"==typeof e.actor?t+=" conf.actor |\n"+e.actor.toString()+"|":t+=" conf.actor must be function",r.default.err("Factory","createShopkeeper",t)}}else t=e.parser.createActor("shopkeeper");else t=this._actorFact.createActor("shopkeeper",{brain:"Human"});t.add(new d.Shopkeeper);const s=new p.GoldCoin(r.default.GOLD_COIN_NAME);s.setCount(_.getUniformInt(50,200)),t.getInvEq().addItem(s);let a=10;return e.maxDanger>=6&&(a=2*e.maxDanger),r.default.levelUpActor(t,a),t}createTrainers(e,t){const s=e.getExtras().houses;if(r.default.isSuccess(r.default.TRAINER_PROB)){let a=null;if(t.parser)a=t.parser.createActor("trainer");else{const e={maxDanger:5,actorFunc:e=>r.default.ALL_RACES.findIndex(e.type)>=0};a=this.createActor(e)}const n=new d.Trainer;a.add(n);const o=e.getFreeRandCell();if(e.addActor(a,o.getX(),o.getY()),s){const e=_.arrayGetRand(s);if(a.getBrain().getGoal){const t=new l.Evaluator.GoHome(1.5),s=e.getCenter();return t.setArgs({xy:s}),a.getBrain().getGoal().addEvaluator(t),[e]}}}return[]}populateHouse(e,t,s){const a=t.numFloor;let n=Math.round(a/9);0===n&&(n=1);for(let a=0;a<n;a++){const a=this.createActor(s);if(a.getBrain().getGoal){const e=new l.Evaluator.GoHome(1.5),s=t.getCenter();e.setArgs({xy:s}),a.getBrain().getGoal().addEvaluator(e)}const n=_.arrayGetRand(t.floor);e.addActor(a,n[0],n[1])}}createActor(e){const t=f.ObjectShell.getParser(),s=e.maxDanger||this.maxDanger;let a=null;if(s>0){let n=e=>e.danger<=s;this.actorFunc?n=(e=>this.actorFunc(e)&&e.danger<=s):e.actorFunc&&(n=(t=>e.actorFunc(t)&&t.danger<=s)),a=t.createRandomActor({func:n})}else r.default.err("DungeonPopulate","createActor","maxDanger must be > 0");return a}addActorsToBbox(e,t,s){const a=s.nActors||4,{maxDanger:n,func:r}=s,o=this._actorFact.generateNActors(a,r,n);c.Placer.addActorsToBbox(e,t,o)}addItemsToBbox(e,t,s){const a=s.nItems||4,n=Object.assign({itemsPerLevel:a},s),r=this._itemFact.generateItems(n);c.Placer.addItemsToBbox(e,t,r)}}},function(e,t){String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=n(s(2)),i=s(3),l=s(42),c=s(50),h=s(1);t.ACTION_ALREADY_DONE=Object.freeze(()=>{}),t.NO_ACTION_TAKEN=Object.freeze(()=>{});const u=h.Random.getRNG();t.Brain={},t.Brain.getCellsAroundActor=((e,t=1)=>{const s=e.getLevel().getMap(),[a,n]=e.getXY(),r=[];for(let e=a-t;e<=a+t;e++)for(let o=n-t;o<=n+t;o++)s.hasXY(e,o)&&(e===a&&o===n||r.push(s.getCell(e,o)));return r}),t.Brain.getBoxOfFreeCellsAround=((e,t)=>{const s=e.getLevel().getMap(),[a,n]=e.getXY();let r=i.Geometry.getBoxAround(a,n,t),o=(r=r.filter(e=>s.hasXY(e[0],e[1]))).map(e=>s.getCell(e[0],e[1]));return o=o.filter(e=>e.isFree())}),t.Brain.findCellsWithActors=((e,t,s)=>{const a=[];for(let n=0,r=t.length;n<r;n++)if(t[n].hasProp("actors")){const r=t[n].getProp("actors");r[0].getID()!==e.getID()&&(s&&s(r),a.push(t[n]))}return a}),t.Brain.getActorsInCells=((e,t)=>{const s=[];for(let a=0,n=e.length;a<n;a++)if(e[a].hasProp("actors")){const n=e[a].getProp("actors");1===n.length?t?t(n[0])&&s.push(n[0]):s.push(n[0]):n.forEach(e=>{t?t(e)&&s.push(e):s.push(e)})}return s}),t.Brain.getSeenHostiles=(e=>{const s=e.getBrain().getSeenCells();return t.Brain.getActorsInCells(s,t=>t.isEnemy(e))}),t.Brain.findCellsWithFriends=((e,t)=>{const s=[];for(let a=0,n=t.length;a<n;a++)if(t[a].hasActors()){t[a].getSentientActors().forEach(n=>{n.getID()!==e.getID()&&(n.isEnemy(e)||s.push(t[a]))})}return s}),t.Brain.getActorCellsAround=(e=>{return t.Brain.getCellsAroundActor(e).filter(e=>e.hasActors())}),t.Brain.getActorsAround=(e=>{const s=t.Brain.getCellsAroundActor(e);let a=[];return s.forEach(e=>{e.hasActors()&&(a=a.concat(e.getActors()))}),a}),t.Brain.getEnemyCellsAround=(e=>{return t.Brain.getCellsAroundActor(e).filter(t=>t.hasActors()&&e.getBrain().getMemory().isEnemy(t.getActors()[0]))}),t.Brain.getFriendCellsAround=(e=>{return t.Brain.getCellsAroundActor(e).filter(t=>t.hasActors()&&e.getBrain().getMemory().isFriend(t.getActors()[0]))}),t.Brain.distToActor=((e,t)=>{const[s,a]=e.getXY(),[n,r]=t.getXY();return function(e,t,s,a){const n=i.Geometry.getBresenham(e,t,s,a).length-1;return n>0?n:0}(s,a,n,r)}),t.Brain.getTelepathyCells=function(e){const t=e.getLevel().getID(),s=e.getList("Telepathy");let a=[];return s.forEach(e=>{const s=e.getTarget(),n=s.getLevel();if(r.default.isActorActive(s)&&n.getID()===t){const e=n.getMap().getVisibleCells(s);a=a.concat(e)}}),a};class d extends l.BrainBase{constructor(e){super(e),this.setType("NonSentient")}decideNextAction(e){return t.NO_ACTION_TAKEN}}t.BrainNonSentient=d,t.Brain.NonSentient=d;class g extends l.BrainBase{constructor(e){super(e),this._explored={},this._type="Sentient",this._memory=new c.Memory,this._cache={seen:null}}getMemory(){return this._memory}addEnemy(e){this._memory.addEnemy(e)}addFriend(e){this._memory.addFriend(e)}addEnemyType(e){this._memory.addEnemyType(e)}decideNextAction(e){return this._cache.seen=null,r.default.err("BrainSentient","decideNextAction","Not implemented in this class"),null}getSeenCells(){if(this._cache.seen)return this._cache.seen;const e=this._actor.getLevel().getMap();if(this._cache.seen=e.getVisibleCells(this._actor),this._actor.has("Telepathy")){const e=t.Brain.getTelepathyCells(this._actor);this._cache.seen=this._cache.seen.concat(e)}return this._cache.seen}canMeleeAttack(e,t){const s=this._actor.get("Combat").getAttackRange(),[a,n]=r.default.dXdYAbs([e,t],this._actor);return a<=s&&n<=s}findSeenCell(e){return this.getSeenCells().filter(e)}canSeeActor(e){const s=this.getSeenCells(),a=t.Brain.findCellsWithActors(this._actor,s);let n=!1;return a.forEach(t=>{t.getActors().forEach(t=>{t.getID()===e.getID()&&(n=!0)})}),n}findEnemyCell(e){const s=[],a=t.Brain.findCellsWithActors(this._actor,e);for(let e=0;e<a.length;e++){const t=a[e].getSentientActors();for(let n=0;n<t.length;n++)if(this._memory.isEnemy(t[n])){if(this._memory.addEnemySeenCell(t[n]),this._memory.wasLastAttacked(t[n]))return a[e];s.push(a[e])}}return s.length>0?u.arrayGetRand(s):null}findFriendCell(e){const s=this.getMemory(),a=t.Brain.findCellsWithActors(this._actor,e);for(let e=0;e<a.length;e++){const t=a[e].getActors();if(!s.isEnemy(t[0]))return a[e]}return null}toJSON(){return{type:this.getType(),memory:this.getMemory().toJSON()}}canPickupItem(){const e=this._actor.getCell();if(e.hasItems()){const t=e.getItems()[0];return this._actor.getInvEq().canCarryItem(t)}return!1}pickupItem(){return()=>{const e=new o.Pickup;this._actor.add(e)}}actionTowardsEnemy(e){const t=this._actor.getLevel(),s=e.getX(),a=e.getY();return this.canMeleeAttack(s,a)?()=>{const e=t.getMap().getCell(s,a).getProp("actors")[0],n=new o.Attack({target:e});this._actor.add(n)}:this.tryToMoveTowardsCell(e)}tryToMoveTowardsCell(e){const s=this._actor.getLevel(),[a,n]=this._actor.getXY(),[r,i]=[e.getX(),e.getY()];let[l,c]=[r-a,i-n];l=0!==l?l/Math.abs(l):0,c=0!==c?c/Math.abs(c):0;const[h,u]=[a+l,n+c];if(s.getMap().getCell(h,u).isPassable())return()=>{const e=new o.Movement(h,u,s);this._actor.add(e)};const d=this.getShortestPathTo(e);if(d.length>1){const e=d[1].getX(),t=d[1].getY();return()=>{const a=new o.Movement(e,t,s);this._actor.add(a)}}return t.NO_ACTION_TAKEN}getSeenFriends(){const e=[],s=this.getMemory(),a=this.getSeenCells(),n=t.Brain.findCellsWithActors(this._actor,a);for(let t=0;t<n.length;t++){const a=n[t].getActors();s.isFriend(a[0])&&e.push(a[0])}return e}getSeenEnemies(){const e=this.getMemory(),s=this.getSeenCells();return t.Brain.getActorsInCells(s,t=>e.isEnemy(t))}exploreLevel(e){let s=-1,a=[];for(let t=0;t<e.length;t++)a.push(t);for(let n=0,r=(a=u.shuffle(a)).length;n<r;n++){const r=a[n],i=e[r];if(i.isFree()){const e=i.getX()+","+i.getY();if(!this._explored.hasOwnProperty(e)){this._explored[e]=!0,s=r;break}}else if(i.hasDoor()){const e=i.getPropType("door")[0];if(e.canToggle()){const s=new o.OpenDoor;return s.setDoor(e),this._actor.add(s),t.ACTION_ALREADY_DONE}}}return-1===s&&(s=u.randIndex(e)),this.tryToMoveTowardsCell(e[s])}getShortestPathTo(e){const[t,s]=e.getXY();return this._actor.getLevel().getMap().getShortestPathTo(this._actor,t,s)}fleeFromCell(e,t){const s=e.getX(),a=e.getY(),n=this._actor.getX(),r=this._actor.getY(),o=n-(s-n),i=r-(a-r);if(this._actor.getLevel().getMap().hasXY(o,i)){const e=this._actor.getLevel().getMap().getCell(o,i);if(e.isPassable())return this.tryToMoveTowardsCell(e);if(this._actor.has("Flying")&&e.isPassableByAir())return this.tryToMoveTowardsCell(e)}return this.exploreLevel(t)}getFreeCellsAround(){return t.Brain.getCellsAroundActor(this._actor).filter(e=>e.isFree())}getRandAdjacentFreeCell(){const e=this.getFreeCellsAround();return e.length>0?u.arrayGetRand(e):null}}t.BrainSentient=g,t.Brain.Sentient=g},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(23),i=n(s(13)),l=s(18),c=s(10),h=s(51),u=s(117),d=n(s(32));t.Actor={},t.ACTOR_NO_ACTION=Object.freeze(()=>{});Object.freeze({});const g=r.default.BASE_SPEED*r.default.ACTION_DUR;class p extends o.Entity{constructor(e){super({propType:r.default.TYPE_ACTOR,type:null});const t=new i.Named;t.setName(e),this.add(t),this.add(new i.Action),this.add(new i.Location),this.add(new i.Typed("BaseActor",r.default.TYPE_ACTOR))}getType(){return this.get("Typed").getObjType()}setType(e){return this.get("Typed").setObjType(e)}getPropType(){return this.get("Typed").getPropType()}setPropType(e){return this.get("Typed").setPropType(e)}getCell(){return this.get("Location").getCell()}isLocated(){return this.get("Location").isLocated()}unsetLevel(){this.get("Location").unsetLevel()}setLevel(e){return this.get("Location").setLevel(e)}getLevel(){return this.get("Location").getLevel()}getX(){return this.get("Location").getX()}getY(){return this.get("Location").getY()}getXY(){return this.get("Location").getXY()}setXY(e,t){this.get("Location").setXY(e,t)}isPlayer(){return this.has("Player")||this.has("PlayerControlled")}isEnemy(e){return!1}addEnemy(e){}addEnemyType(e){}setName(e){this.get("Named").setName(e)}getName(){return this.get("Named").getFullName()}getBrain(){return this._brain}setBrain(e){this._brain=e,this._brain.setActor(this)}getSpeed(){return r.default.BASE_SPEED}getEquipProtection(){return 0}nextAction(e){const s=this._brain.decideNextAction(e);let a=null;if(null!==s){const e=Math.round(g/this.getSpeed());a=new d.Action(e,s)}else a=new d.Action(0,t.ACTOR_NO_ACTION);if(this._brain.hasOwnProperty("energy")){const e=this._brain;a.energy=e.energy}return a.actor=this,a}toJSON(){let e=null;this.getLevel()&&(e=this.getLevel().getID());const t={id:this.getID(),type:this.getType(),levelID:e,brain:this._brain.toJSON(),new:"Base"};return t.components=l.compsToJSON(this),null===t.type&&r.default.err("Actor.Virtual","toJSON",`Type null for ${JSON.stringify(t)}`),t}}t.BaseActor=p,t.Actor.Base=p;class m extends p{constructor(e){super(e),this._brain=new c.BrainGoalOriented(this),this._brain.getMemory().addEnemyType("player"),this._invEq=new u.Inventory(this),this._maxWeight=10,this.add(new i.Experience),this.add(new i.Combat),this.add(new i.Stats),this.add(new i.Health(50)),this.add(new i.Corporeal);const t=new i.Perception;t.setFOVRange(r.default.NPC_FOV_RANGE),this.add(t)}getFOVRange(){let e=this.get("Perception").getFOVRange();return this.has("EagleEye")&&(e+=2),e}setFOVRange(e){this.get("Perception").setFOVRange(e)}addEnemyType(e){this._brain.getMemory().addEnemyType(e)}addEnemy(e){this._brain.addEnemy(e)}addFriend(e){this._brain.addFriend(e)}isEnemy(e){return this._brain.getMemory().isEnemy(e)}isFriend(e){return this._brain.getMemory().isFriend(e)}getInvEq(){return this._invEq}getWeapon(){return this._invEq.getWeapon()}getMissileWeapon(){return this._invEq.getMissileWeapon()}getMissile(){return this._invEq.getEquipment().getItem("missile")}getEquipAttack(){let e=this._invEq.getEquipment().getAttack();return this.has("Skills")&&(e+=this.get("Skills").getLevel("Melee")),e}getEquipDefense(){let e=this._invEq.getEquipment().getDefense();return this.has("Skills")&&(e+=this.get("Skills").getLevel("Shields")),e}getEquipProtection(){return this._invEq.getEquipment().getProtection()}getShieldDefense(){const e=this._invEq.getEquipment().getEquipped("shield");let t=0;if(e){t=e.getDefense(),this.has("Skills")&&(t+=this.get("Skills").getLevel("Shields"))}return t}setActorClass(e){this._actorClass=e}getActorClass(){return this._actorClass}setBook(e){this._spellbook=e}getBook(){return this._spellbook}getMaxWeight(){return 2*this.get("Stats").getStrength()+2*this._invEq.getEquipment().getStrength()+this._maxWeight}setIsPlayer(e){e?(this._brain=new h.BrainPlayer(this),y(this),this.add(new i.Player),this.has("SpellPower")||this.add(new i.SpellPower)):r.default.err("Actor.Sentient","setIsPlayer","Actor cannot be changed from player to mob.")}setPlayerCtrl(e){var t;e?(this.add(new i.PlayerControlled),this._actualBrain=this._brain,this._brain=new h.BrainPlayer(this),y(this),this.add(new i.Possessed)):(this.remove("PlayerControlled"),this.remove("Possessed"),t=this,f.forEach(e=>{let s=-1;if(t.has(e)){const a=t.getList(e);a.forEach(e=>{"brain-player"===e.getTag()&&(s=e.getID())})}-1!==s&&t.remove(s)}),this._brain=this._actualBrain,delete this._actualBrain)}getCell(){const e=this.getX(),t=this.getY(),s=this.getLevel();return s?s.getMap().getCell(e,t):null}isInLevel(e){return!!this.getLevel()&&this.getLevel().getID()===e.getID()}toJSON(){let e=null;this.getLevel()&&(e=this.getLevel().getID());const t={id:this.getID(),name:this.getName(),type:this.getType(),x:this.getX(),y:this.getY(),fovRange:this.getFOVRange(),levelID:e,inventory:this.getInvEq().getInventory().toJSON(),equipment:this.getInvEq().getEquipment().toJSON(),brain:this._brain.toJSON(),new:"Sentient",components:l.compsToJSON(this)};return null===t.type&&r.default.err("Actor.Sentient","toJSON",`Type null for ${JSON.stringify(t)}`),this._spellbook&&(t.spellbook=this._spellbook.toJSON()),this.has("Player")&&(t.isPlayer=!0),this._actualBrain&&(t.brain=this._actualBrain.toJSON()),t}getAttack(){let e=this.get("Combat").getAttack();return e+=this.getEquipAttack(),e+=this._addFromCompList("CombatMods","getAttack"),e+=r.default.accuracyToAttack(this.getAccuracy())}getDefense(){let e=this.get("Combat").getDefense();return e+=this.getEquipDefense(),e+=this._addFromCompList("CombatMods","getDefense"),e+=r.default.agilityToDefense(this.getAgility())}getProtection(){let e=this.get("Combat").getProtection();return e+=this.getEquipProtection(),e+=this._addFromCompList("CombatMods","getProtection")}getDamage(){let e=this.get("Combat").rollDamage();const t=this.getWeapon();if(t){const s=r.default.getItemDamage(t);s>e&&(e=s)}const s=this.getStrength();return e+=r.default.strengthToDamage(s),e+=this._addFromCompList("CombatMods","getDamage")}getCombatBonus(e){return this._addFromCompList("CombatMods",e)}_addFromCompList(e,t){const s=this.getList(e);return s.length>0?s.reduce((e,s)=>e+s[t](),0):0}getAccuracy(){let e=this.get("Stats").getAccuracy();return e+=this.getInvEq().getEquipment().getAccuracy(),e+=this._addFromCompList("StatsMods","getAccuracy")}getAgility(){let e=this.get("Stats").getAgility();return e+=this.getInvEq().getEquipment().getAgility(),e+=this._addFromCompList("StatsMods","getAgility")}getStrength(){let e=this.get("Stats").getStrength();return e+=this.getInvEq().getEquipment().getStrength(),e+=this._addFromCompList("StatsMods","getStrength")}getWillpower(){let e=this.get("Stats").getWillpower();return e+=this.getInvEq().getEquipment().getWillpower(),e+=this._addFromCompList("StatsMods","getWillpower")}getSpeed(){let e=this.get("Stats").getSpeed();return e+=this.getInvEq().getEquipment().getSpeed(),e+=this._addFromCompList("StatsMods","getSpeed")}getPerception(){let e=this.get("Stats").getPerception();return e+=this.getInvEq().getEquipment().getPerception(),e+=this._addFromCompList("StatsMods","getPerception")}getMagic(){let e=this.get("Stats").getMagic();return e+=this.getInvEq().getEquipment().getMagic(),e+=this._addFromCompList("StatsMods","getMagic")}getStatBonus(e){return this._addFromCompList("StatsMods",e)}}t.SentientActor=m;const f=["StatsMods","CombatMods"];function y(e){f.forEach(t=>{let s=!1;if(e.has(t)){e.getList(t).forEach(e=>{"brain-player"===e.getTag()&&(s=!0)})}if(!s){const s=new i[t];s.setTag("brain-player"),e.add(s)}})}t.Actor.Sentient=m,m.getFormattedStats=function(e){const t=e.getLevel().getLevelNumber(),s=r.default.formatLocationName(e.getLevel());let a=null;e.has("SpellPower")&&(a=e.get("SpellPower").getPP()+"/"+e.get("SpellPower").getMaxPP());const n={HP:e.get("Health").getHP()+"/"+e.get("Health").getMaxHP(),PP:a,Att:[e.getAttack(),e.getCombatBonus("getAttack")],Def:[e.getDefense(),e.getCombatBonus("getDefense")],Pro:[e.getProtection(),e.getCombatBonus("getProtection")],Str:[e.getStrength(),e.getStatBonus("getStrength")],Agi:[e.getAgility(),e.getStatBonus("getAgility")],Acc:[e.getAccuracy(),e.getStatBonus("getAccuracy")],Wil:[e.getWillpower(),e.getStatBonus("getWillpower")],Per:[e.getPerception(),e.getStatBonus("getPerception")],Mag:[e.getMagic(),e.getStatBonus("getMagic")],Speed:[e.getSpeed(),e.getStatBonus("getSpeed")],XP:e.get("Experience").getExp(),XL:e.get("Experience").getExpLevel(),DL:t,Loc:s};return e.has("Hunger")&&(n.E=e.get("Hunger").getEnergy()),n},t.isSentient=function(e){if(e)return"function"==typeof e.getBrain().getGoal}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(12)),r=a(s(0)),o=s(7).EventPool.getPool();t.Time={};class i{constructor(e,t){this._duration=e,this._cb=t,this._energy=0}setEnergy(e){this._energy=e}getEnergy(){return this._energy}getDuration(){return this._duration}doAction(){this._cb()}}t.Action=i,t.GameEvent=function(e,t,s,a){let n=s,r=a,o=null;this.isEvent=!0,this.isPlayer=(()=>!1),this.nextAction=(()=>new i(e,t)),this.getRepeat=(()=>n),this.setRepeat=(e=>{n=e}),this.getOffset=(()=>r),this.setOffset=(e=>{r=e}),this.setLevel=(e=>{o=e}),this.getLevel=(()=>o)},t.RegenEvent=function(e,s){this._dur=s;t.GameEvent.call(this,this._dur,()=>{e.get("Health").addHP(1)},!0)},r.default.extend2(t.RegenEvent,t.GameEvent),t.RegenPPEvent=function(e,s){this._dur=s;t.GameEvent.call(this,this._dur,()=>{e.get("SpellPower").addPP(1)},!0)},r.default.extend2(t.RegenPPEvent,t.GameEvent),t.OneShotEvent=function(e,s,a){t.GameEvent.call(this,0,()=>{r.default.isNullOrUndef([a])||r.default.gameMsg(a),e()},!1,s)},r.default.extend2(t.OneShotEvent,t.GameEvent),t.Scheduler=function(){this._scheduler=new n.default.Scheduler.Action,this._scheduler._defaultDuration=0,this._scheduler._duration=0,this._events=[],this._actors=[],this.hasNotify=!0,o.listenEvent(r.default.EVT_ACTOR_KILLED,this)},t.Scheduler.prototype.add=function(e,t,s){this._scheduler.add(e,t,s),e.hasOwnProperty("isEvent")?this._events.push(e):this._actors.push(e)},t.Scheduler.prototype.next=function(){return this._scheduler.next()},t.Scheduler.prototype.setAction=function(e){this._scheduler.setDuration(e.getDuration())},t.Scheduler.prototype.remove=function(e){if(e.hasOwnProperty("isEvent"))return this.removeEvent(e);{const t=this._actors.indexOf(e);-1!==t&&this._actors.splice(t,1)}return this._scheduler.remove(e)},t.Scheduler.prototype.removeEvent=function(e){let t=-1;return e.hasOwnProperty("isEvent")&&-1!==(t=this._events.indexOf(e))&&this._events.splice(t,1),this._scheduler.remove(e)},t.Scheduler.prototype.getTime=function(){return this._scheduler.getTime()},t.Scheduler.prototype.notify=function(e,t){e===r.default.EVT_ACTOR_KILLED&&t.hasOwnProperty("actor")&&this.remove(t.actor)}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(54),o=s(42),i=s(6),l=.1;class c extends o.BrainBase{constructor(e){super(e),this.setType("Virtual")}}t.BrainVirtual=c;t.BrainSpawner=class extends c{constructor(e){super(e),this.setType("Spawner"),this.constraint=null,this._constraintFunc=null}setConstraint(e){this.constraint=e,this._constraintFunc=(new r.Constraints).getConstraints(e)}decideNextAction(){return n.default.isSuccess(l)?()=>{const e=this.getActor().getLevel(),t=e.getFreeRandCell(),[s,a]=[t.getX(),t.getY()],r=i.ObjectShell.getParser().createRandomActor({func:this._constraintFunc});r&&(e.addActor(r,s,a),n.default.gameMsg(`You feel danger at ${s}, ${a}`))}:()=>{}}toJSON(){return{type:this.getType(),constraint:this.constraint}}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(55),o="GoalOriented";function i(e,t){return{comp:"Resistance",func:{setEffect:n.default.DMG[e.toUpperCase()],setLevel:n.default.RESISTANCE[t.toUpperCase()]}}}function l(e){return{comp:"BypassProtection",func:{setChance:e}}}t.ActorsData=[{name:"animal",dontCreate:!0,type:"animal",className:"cell-actor-animal",attack:1,defense:1,hp:5,protection:0,range:1,danger:1,speed:100,brain:"Animal",enemies:n.default.ACTOR_RACES},{name:"rat",char:"r",base:"animal"},{name:"cloud of insects",char:"i",base:"animal",color:r.color("Green","black"),damage:"1d1",defense:2,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1"}]},{name:"bat",char:"b",base:"animal",defense:2,addComp:"Flying"},{name:"giant ant",char:"a",base:"animal",defense:2,hp:7},{name:"badger",char:"c",base:"animal",attack:1,defense:4,damage:"1d4",hp:10,danger:2},{name:"coyote",char:"c",base:"animal",colorfg:"Yellow",attack:3,defense:3,damage:"1d4",hp:12,danger:2},{name:"lynx",char:"f",base:"animal",colorfg:"Orange",attack:5,defense:1,damage:"1d6",hp:12,danger:3},{name:"hawk",char:"H",base:"animal",attack:4,defense:1,damage:"1d5",hp:9,danger:3,addComp:"Flying"},{name:"wolf",char:"w",base:"animal",attack:4,defense:2,damage:"1d6",hp:15,danger:3},{name:"rattlesnake",char:"s",base:"animal",attack:2,defense:3,damage:"1d3",hp:10,danger:3,poison:{duration:"1d6",damage:"1d10",prob:"0.1"}},{name:"cave spider",char:"S",base:"animal",attack:2,defense:4,damage:"1d5",hp:15,danger:4,poison:{duration:"3d6",damage:"1d4 + 1",prob:"0.15"}},{name:"woolly spider",char:"S",base:"animal",attack:4,defense:4,damage:"1d6 + 2",hp:20,danger:4,poison:{duration:"3d6",damage:"1d4 + 1",prob:"0.15"},onHit:[{addComp:"Paralysis",duration:"1"}]},{name:"wolverine",char:"W",base:"animal",attack:4,defense:4,damage:"1d7",hp:20,danger:4},{name:"auroch",char:"A",base:"animal",attack:2,defense:4,protection:5,damage:"1d7",hp:23,danger:4},{name:"eagle",char:"E",base:"animal",attack:4,defense:4,damage:"1d7",hp:20,danger:4,addComp:"Flying"},{name:"dire wolf",char:"w",base:"animal",colorfg:"Gray",attack:6,defense:2,damage:"1d8 + 2",hp:23,danger:5},{name:"giant spider",char:"S",base:"animal",colorfg:"Green",attack:6,defense:3,damage:"1d8 + 2",hp:17,danger:5,poison:{duration:"4d6",damage:"1d4 + 2",prob:"0.20"}},{name:"black vulture",char:"V",base:"animal",attack:5,defense:5,damage:"1d7",hp:25,danger:5,addComp:"Flying"},{name:"giant scorpion",char:"S",base:"animal",attack:5,defense:5,damage:"1d6 + 1",hp:19,danger:5,brain:"SpellCaster",spells:["ScorpionsTail"],maxPP:1,pp:1,poison:{duration:"4d6",damage:"1d4 + 2",prob:"0.20"}},{name:"bear",char:"B",base:"animal",attack:5,defense:5,damage:"1d9",hp:30,danger:5},{name:"mountain lion",char:"f",base:"animal",attack:6,defense:3,damage:"2d4",hp:25,danger:5},{name:"sabretooth tiger",char:"f",base:"animal",attack:8,defense:3,damage:"3d3",colorfg:"Red",hp:25,danger:5,speed:110},{name:"dire bear",char:"B",base:"animal",colorfg:"Gray",attack:8,defense:5,damage:"4d4",hp:40,danger:6},{name:"griffin",char:"G",base:"animal",attack:7,defense:4,damage:"3d3",hp:35,danger:6,addComp:"Flying",speed:130},{name:"polar bear",char:"B",base:"animal",color:r.color("blue","white"),attack:10,defense:5,protection:7,damage:"4d4 + 5",hp:50,danger:8,onHit:[{addComp:"Stun",duration:"1d2 + 1"}],addComp:[i("ICE","HIGH")]},{name:"mammoth",char:"M",base:"animal",attack:4,defense:4,protection:7,damage:"1d9",strength:30,hp:40,danger:8,addComp:[i("ICE","MEDIUM")]},{name:"dire mammoth",char:"M",base:"animal",attack:4,defense:4,protection:10,damage:"1d15",strength:35,hp:50,danger:9,colorfg:"Gray",addComp:[i("ICE","MEDIUM")]},{name:"polar bear king",char:"B",base:"animal",color:r.color("cyan","white"),attack:15,defense:7,damage:"5d5 + 5",hp:75,danger:10,onHit:[{addComp:"Stun",duration:"1d2 + 1"}],addComp:[i("ICE","IMMUNITY")]},{name:"thunderbird",char:"G",base:"animal",attack:7,defense:7,damage:"2d8",hp:45,danger:10,addComp:"Flying",brain:"SpellCaster",spells:["LightningArrow"],maxPP:30,pp:30},{name:"manticore",char:"M",base:"animal",attack:7,defense:7,damage:"2d10",hp:50,danger:10,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1d4 + 1"}]},{name:"forest wurm",char:"W",base:"animal",color:r.color("Green","Brown"),attack:12,defense:7,protection:15,damage:"3d10",hp:70,danger:10},{name:"spider queen",char:"S",base:"animal",color:r.color("Purple","Green"),attack:7,defense:7,protection:7,damage:"2d8 + 7",hp:45,danger:11,brain:"SpellCaster",spells:["SummonSpiders","ArrowOfWebs"],maxPP:40,pp:40,poison:{duration:"10d6",damage:"1d5 + 3",prob:"0.20"}},{name:"ancient manticore",char:"M",base:"animal",color:r.color("Gray","Brown"),attack:15,defense:10,protection:10,damage:"2d10 + 10",hp:75,danger:15,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1d6 + 1"}],spells:["SummonKin"],maxPP:30,pp:30},{name:"BeastBase",type:"beast",dontCreate:!0,enemies:n.default.ACTOR_RACES},{name:"cave dweller",base:"BeastBase",char:"C",color:r.color("Black","Red"),attack:5,defense:5,protection:5,damage:"1d10 + 2",hp:30,danger:5,brain:"SpellCaster",spells:["SlimeBolt"],maxPP:18,pp:18},{name:"hezrou",base:"BeastBase",char:"B",className:"cell-actor-poison",attack:5,defense:5,protection:3,hp:50,danger:11,damage:"4d4",addComp:[i("POISON","IMMUNITY")],brain:"SpellCaster",spells:["PoisonCloud"],maxPP:40,pp:40},{name:"ConstructBase",type:"construct",dontCreate:!0,enemies:n.default.ACTOR_RACES},{name:"water elemental",base:"ConstructBase",char:"E",className:"cell-actor-water",attack:5,defense:5,protection:3,hp:38,danger:9,damage:"4d4",addComp:"Amphibious",brain:"SpellCaster",spells:["WaterBolt"],maxPP:40,pp:40},{name:"air elemental",base:"ConstructBase",char:"E",className:"cell-actor-air",attack:5,defense:5,protection:3,hp:38,danger:9,damage:"4d4",addComp:"Flying",brain:"SpellCaster",spells:["LightningBolt"],maxPP:40,pp:40},{name:"earth elemental",base:"ConstructBase",char:"E",className:"cell-actor-earth",attack:6,defense:3,protection:12,hp:47,danger:11,damage:"4d4",brain:"SpellCaster",spells:["RockStorm"],maxPP:70,pp:70},{name:"void elemental",base:"ConstructBase",color:r.color("Purple","Black"),char:"E",className:"cell-actor-void",attack:7,defense:7,protection:7,hp:60,danger:13,damage:"5d4",brain:"SpellCaster",spells:["PowerDrain"],addComp:["SpellStop",i("MAGIC","ABSORB"),i("VOID","IMMUNITY")],maxPP:70,pp:70},{name:"goblin",char:"g",type:"goblin",className:"cell-actor-goblin",attack:1,defense:1,damage:"1d6",range:1,hp:7,protection:1,danger:2,enemies:["human"],brain:o},{name:"goblin slinger",base:"goblin",attack:2,defense:1,hp:10,equip:[{name:"Rock",count:10}]},{name:"goblin fighter",base:"goblin",attack:2,defense:3,protection:1,hp:12,danger:2},{name:"goblin healer",base:"goblin",attack:2,defense:4,protection:2,hp:15,danger:3,brain:"SpellCaster",pp:18,maxPP:18,spells:["Heal"]},{name:"goblin sergeant",base:"goblin",damage:"1d7",attack:4,defense:4,protection:2,hp:21,danger:4},{name:"goblin summoner",base:"goblin",attack:2,defense:4,protection:2,hp:25,maxPP:20,pp:20,brain:"SpellCaster",spells:["SummonAnimal"],danger:5},{name:"goblin lord",base:"goblin",attack:5,defense:4,protection:3,hp:30,danger:7},{name:"goblin king",base:"goblin",attack:7,defense:7,protection:3,hp:40,danger:10},{name:"HyrmBase",char:"Y",type:"hyrm",color:r.color("Black","Purple"),dontCreate:!0,attack:1,defense:1,damage:"1d4",range:1,hp:10,danger:2,brain:o,enemies:["player"]},{name:"hyrm warrior",base:"HyrmBase",attack:3,defense:3,damage:"1d8",hp:15,danger:2},{name:"hyrm catapulter",base:"HyrmBase",attack:3,defense:3,damage:"1d8",hp:25,danger:4,equip:[{name:"Large rock",count:4}]},{name:"hyrm runemage",base:"HyrmBase",attack:3,defense:3,damage:"1d8",hp:25,danger:5,brain:"SpellCaster",spells:["SummonKin","StunningTouch"],maxPP:20,pp:20},{name:"hyrm hulk",base:"HyrmBase",attack:6,defense:3,damage:"2d8",hp:40,strength:15,speed:90,danger:7},{name:"humanoid",char:"h",type:"humanoid",attack:1,defense:1,damage:"1d4",range:1,hp:10,danger:2,brain:o,enemies:["human","player"]},{name:"dark warrior",char:"h",type:"humanoid",className:"cell-actor-void",attack:6,defense:4,protection:2,damage:"2d5 + 3",range:1,hp:25,enemies:n.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes"],maxPP:16,pp:16,danger:5},{name:"dark archer",char:"h",type:"humanoid",className:"cell-actor-void",attack:8,defense:3,protection:4,damage:"2d5",range:1,hp:30,enemies:n.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes"],maxPP:16,pp:16,danger:7,equip:["Iron bow",{name:"Steel arrow",count:8}],addComp:["LongRangeShot"]},{name:"dark assassin",char:"h",type:"humanoid",className:"cell-actor-void",attack:10,defense:5,protection:6,damage:"3d5 + 3",range:1,hp:50,enemies:n.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes"],maxPP:30,pp:30,danger:10,addComp:[i("POISON","IMMUNITY")],poison:{duration:"4d6",damage:"1d4 + 2",prob:"0.20"}},{name:"dark lord",char:"h",type:"humanoid",color:r.color("Yellow","Purple"),attack:12,defense:10,protection:8,damage:"4d5 + 5",range:1,hp:75,enemies:n.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes","PoisonArrow"],maxPP:60,pp:60,danger:15,addComp:[i("POISON","IMMUNITY")],poison:{duration:"4d6",damage:"2d4 + 2",prob:"0.25"}},{name:"AvianFolkBase",char:"A",className:"cell-actor-avianfolk",type:"avianfolk",dontCreate:!0,enemies:["player","human","catfolk","dogfolk","wolfclan"],brain:o,addComp:"Flying",attack:2,defense:2,damage:"1d6",range:1,protection:1,hp:15,danger:2},{name:"avian townsfolk",base:"AvianFolkBase",danger:1,attack:1,defense:1,damage:"1d4",hp:10},{name:"avian scout",base:"AvianFolkBase",danger:2,attack:3,defense:3,damage:"2d4",hp:20,speed:110,fovrange:6},{name:"avian fighter",base:"AvianFolkBase",danger:4,attack:6,defense:7,damage:"3d4",hp:30},{name:"avian arbalist",base:"AvianFolkBase",danger:5,attack:6,defense:7,damage:"3d4",hp:30,equip:["Wooden crossbow",{name:"Wooden bolt",count:10}]},{name:"avian duelist",base:"AvianFolkBase",danger:8,attack:7,defense:10,damage:"3d5",hp:40,addComp:["CounterAttack","Flying"]},{name:"avian judicator",base:"AvianFolkBase",danger:9,attack:7,defense:10,damage:"4d4",hp:45,addComp:["FirstStrike","Flying"]},{name:"avian archmage",base:"AvianFolkBase",danger:11,attack:5,defense:10,damage:"3d4",hp:45,brain:"SpellCaster",spells:["SummonAirElemental"],pp:40,maxPP:40},{name:"avian emperor",base:"AvianFolkBase",danger:16,attack:8,defense:14,damage:"5d5",hp:85,addComp:["Flying",l(.15)]},{name:"BearfolkBase",char:"B",className:"cell-actor-bearfolk",dontCreate:!0,type:"bearfolk",attack:1,defense:1,damage:"1d5 + 1",range:1,hp:10,danger:1,enemies:["goblin","dwarf","undead","demon"],brain:o},{name:"bearfolk thief",base:"BearfolkBase",color:r.color("Yellow","Black"),damage:"1d7",brain:"Thief",attack:1,defense:1,danger:2,hp:12},{name:"bearfolk fighter",base:"BearfolkBase",damage:"1d8",attack:2,defense:2,danger:2,hp:15},{name:"bearfolk archer",base:"BearfolkBase",damage:"1d6",attack:2,defense:2,danger:3,hp:13,equip:["Wooden bow",{name:"Wooden arrow",count:10}]},{name:"bearfolk mage",base:"BearfolkBase",damage:"1d6",attack:2,defense:2,danger:4,hp:15,equip:["Robe","Wooden staff"],brain:"SpellCaster",spells:["SummonKin"],pp:20,maxPP:20},{name:"bearfolk magistrate",base:"BearfolkBase",damage:"1d10 + 2",colorfg:"Purple",attack:4,defense:4,danger:5,hp:30,equip:["Leather armour"]},{name:"bearfolk elite",base:"BearfolkBase",damage:"2d6",attack:5,defense:5,hp:37,danger:6,onHit:[{addComp:"Stun",duration:"1d4 + 1"}]},{name:"bearfolk king",base:"BearfolkBase",damage:"3d6",strength:16,attack:7,defense:7,protection:5,danger:8,hp:75},{name:"UndeadBase",className:"cell-actor-undead",color:r.color("White","Black"),dontCreate:!0,addComp:"Undead",brain:"GoalOriented",attack:1,defense:1,protection:0,range:1,enemies:n.default.ACTOR_RACES,type:"undead"},{name:"skeletal dog",char:"d",base:"UndeadBase",damage:"1d6",danger:1,brain:"Animal",hp:6},{name:"skeletal spider",char:"S",base:"UndeadBase",attack:2,defense:1,damage:"1d4",danger:1,hp:5,brain:"Animal",poison:{duration:"2d10",damage:"1d2",prob:"0.2"}},{name:"necrocentipede",char:"w",base:"UndeadBase",attack:1,defense:1,damage:"1d7",danger:2,brain:"Animal",speed:125,hp:6},{name:"skeleton",char:"z",base:"UndeadBase",attack:2,defense:1,damage:"1d5",danger:1,hp:9},{name:"zombie",char:"z",base:"UndeadBase",colorfg:"Brown",attack:2,defense:2,damage:"1d6",danger:2,hp:12},{name:"skeleton archer",char:"z",base:"UndeadBase",colorfg:"Yellow",attack:4,defense:2,damage:"1d8",danger:4,hp:15,equip:["Wooden bow",{name:"Wooden arrow",count:5}]},{name:"skeleton warrior",char:"z",base:"UndeadBase",attack:3,defense:3,damage:"1d8 + 2",danger:4,hp:20},{name:"necrowurm",char:"W",base:"UndeadBase",attack:4,defense:4,damage:"1d9",danger:5,brain:"Animal",speed:115,hp:21},{name:"skeleton berserker",char:"z",base:"UndeadBase",colorfg:"Pink",attack:6,defense:1,damage:"1d10 + 4",danger:5,hp:15},{name:"ghoul",char:"z",base:"UndeadBase",colorfg:"LightGray",attack:3,defense:3,damage:"1d7 + 2",danger:5,hp:15,onHit:[{addComp:"Paralysis",duration:"1d4"}]},{name:"crypt zombie",char:"z",base:"UndeadBase",colorfg:"Yellow",attack:2,defense:2,protection:4,damage:"3d5",danger:6,hp:30},{name:"ghost",char:"G",base:"UndeadBase",attack:4,defense:4,damage:"2d5 + 2",danger:6,onHit:[{addComp:"StatsMods",func:[{setter:"setSpeed",value:-5}],duration:"3d10"}],hp:25},{name:"wraith",char:"Z",base:"UndeadBase",colorfg:"Cyan",attack:5,defense:5,damage:"2d5 + 2",danger:6,onHit:[{addComp:"StatsMods",func:[{setter:"setStrength",value:-1}],duration:"2d10"}],hp:25},{name:"specter",char:"Z",base:"UndeadBase",colorfg:"Blue",attack:6,defense:6,damage:"2d5 + 5",danger:7,onHit:[{addComp:"StatsMods",func:[{setter:"setMagic",value:-1}],duration:"10d10"}],hp:25,addComp:["Flying",i("ICE","HIGH")]},{name:"boneclaw",char:"B",base:"UndeadBase",attack:12,defense:4,damage:"2d7 + 2",danger:9,speed:100,onAttackHit:[{addComp:"DirectDamage",func:[{setter:"setDamage",value:2},{setter:"setDamageType",value:n.default.DMG.NECRO},{setter:"setDamageCateg",value:n.default.DMG.MELEE}],duration:"1d8 + 2"}],hp:35},{name:"ghost lord",char:"G",base:"UndeadBase",colorfg:"LightGray",attack:7,defense:7,damage:"2d5 + 2",danger:8,onHit:[{addComp:"StatsMods",func:[{setter:"setSpeed",value:-10}],duration:"3d10"}],hp:35},{name:"skeleton king",char:"Z",base:"UndeadBase",colorfg:"red",attack:6,defense:6,damage:"3d5 + 5",danger:9,hp:45,addComp:[i("PIERCE","HIGH"),i("SLASH","HIGH"),i("ICE","HIGH")]},{name:"vampire",char:"V",base:"UndeadBase",colorfg:"Purple",attack:6,defense:6,damage:"3d5 + 2",danger:9,speed:120,onHit:[{addComp:"StatsMods",func:[{setter:"setStrength",value:-2}],duration:"5d10"}],hp:40},{name:"undead unicorn",char:"U",base:"UndeadBase",colorfg:"GhostWhite",attack:7,defense:7,protection:7,damage:"2d5 + 5",danger:9,speed:102,hp:50,addComp:[l(.25)]},{name:"necrowyrm",char:"W",base:"UndeadBase",colorfg:"GhostWhite",attack:7,defense:7,protection:7,damage:"3d5",danger:10,brain:"Animal",speed:107,hp:50,addComp:["Flying"]},{name:"ghost king",char:"G",base:"UndeadBase",colorfg:"Yellow",attack:7,defense:7,damage:"3d5 + 2",danger:12,brain:"SpellCaster",onHit:[{addComp:"StatsMods",func:[{setter:"setSpeed",value:-15}],duration:"3d10"}],hp:50,addComp:[l(.2)]},{name:"lich",char:"L",base:"UndeadBase",attack:4,defense:8,protection:4,damage:"1d8 + 6",danger:12,hp:50,brain:"SpellCaster",spells:["GraspOfWinter","SummonDead"],maxPP:50,pp:50,addComp:[i("ICE","MEDIUM")]},{name:"lich king",char:"L",base:"UndeadBase",colorfg:"Yellow",attack:8,defense:8,protection:6,damage:"2d8 + 2",danger:17,hp:75,brain:"SpellCaster",spells:["SummonDead","AnimateDead"],maxPP:75,pp:75,onHit:[r.meleeHitDamage(4,"1d6","NECRO")],addComp:[i("ICE","MEDIUM"),i("POISON","IMMUNITY"),i("NECRO","IMMUNITY")]},{name:"WinterBeingBase",dontCreate:!0,enemies:n.default.ACTOR_RACES,color:r.color("Blue","White"),addComp:["SnowWalk",i("ICE","MEDIUM")]},{name:"Crevasse worm",char:"w",base:"WinterBeingBase",attack:1,defense:1,damage:"1d4",speed:110,danger:1,hp:5,type:"animal"},{name:"Ice bat",char:"b",base:"WinterBeingBase",attack:1,defense:1,damage:"1d6",speed:110,danger:2,hp:8,brain:"Animal",addComp:["Flying",i("ICE","MEDIUM")],type:"animal"},{name:"Arctic fox",char:"f",base:"WinterBeingBase",attack:4,defense:1,damage:"1d7 + 3",speed:105,danger:3,hp:12,brain:"Animal",type:"animal"},{name:"Frost goblin",char:"g",base:"WinterBeingBase",attack:3,defense:3,protection:1,damage:"1d7",hp:12,danger:3,type:"icebeing",brain:o},{name:"Frost viper",char:"s",base:"WinterBeingBase",attack:3,defense:3,protection:3,damage:"1d7",hp:18,danger:4,type:"animal",poison:{duration:"1d6 + 5",damage:"1d6",prob:"0.1"}},{name:"Arctic Wolf",char:"w",base:"WinterBeingBase",attack:4,defense:2,damage:"1d8",brain:"Animal",hp:21,danger:5,type:"animal"},{name:"Glacial shaman",char:"@",base:"WinterBeingBase",colorfg:"CadetBlue",attack:4,defense:4,protection:3,damage:"1d7 + 2",type:"icebeing",danger:5,hp:25,spells:["IcyPrison"],maxPP:22,pp:21,brain:"SpellCaster"},{name:"Glacial golem",char:"G",base:"WinterBeingBase",attack:4,defense:4,protection:3,damage:"2d4",speed:90,danger:5,hp:30,type:"construct"},{name:"Ice minion",base:"WinterBeingBase",char:"m",attack:4,defense:4,protection:2,damage:"2d4",hp:20,danger:5,type:"demon",onHit:[{addComp:"Coldness",duration:"10d10"}]},{name:"Mighty raven",base:"WinterBeingBase",char:"R",attack:4,defense:10,damage:"2d4 + 2",range:1,hp:20,danger:5,brain:"Animal",addComp:["Flying",i("ICE","MEDIUM")]},{name:"Snow leopard",base:"WinterBeingBase",char:"f",attack:8,defense:4,damage:"1d6 + 5",range:1,hp:25,danger:5,brain:"Animal",type:"animal",speed:120},{name:"Cryomancer",base:"WinterBeingBase",char:"@",type:"icebeing",attack:4,defense:4,damage:"1d6",range:1,hp:30,danger:5,spells:["FrostBolt"],maxPP:22,pp:21,brain:"SpellCaster"},{name:"Winter demon",type:"demon",char:"&",colorfg:"CadetBlue",attack:5,defense:5,protection:2,damage:"3d3",range:1,hp:30,danger:10,brain:"GoalOriented",base:"WinterBeingBase"},{name:"Harbinger of winter",type:"demon",char:"@",colorfg:"DarkBlue",attack:5,defense:5,protection:2,damage:"3d3",range:1,hp:35,danger:10,brain:"SpellCaster",base:"WinterBeingBase",spells:["GraspOfWinter"],maxPP:30,pp:30},{name:"Stormrider",type:"demon",char:"&",colorfg:"DarkBlue",attack:6,defense:6,protection:3,damage:"4d3",range:1,hp:40,danger:12,brain:"GoalOriented",base:"WinterBeingBase",equip:["Permaice short sword"]},{name:"Ice archon",type:"demon",char:"A",attack:6,defense:6,protection:3,damage:"4d3",range:1,hp:40,danger:12,base:"WinterBeingBase",brain:"SpellCaster",pp:30,maxPP:30,spells:["RingOfFrost"]},{name:"Ice djinn",type:"demon",char:"&",attack:7,defense:6,protection:6,damage:"3d5+5",range:1,hp:45,danger:14,brain:"GoalOriented",base:"WinterBeingBase"},{name:"Blizzard beast",type:"demon",char:"B",colorfg:"CadetBlue",attack:7,defense:6,protection:8,damage:"3d5+5",range:1,hp:50,danger:16,brain:"GoalOriented",base:"WinterBeingBase"},{name:"Ice behemoth",type:"demon",char:"B",colorfg:"DarkBlue",attack:10,defense:3,protection:8,damage:"4d5+5",range:2,hp:65,danger:16,brain:"GoalOriented",base:"WinterBeingBase",onHit:[{addComp:"Coldness"}]},{name:"Frost Titan",type:"giant",char:"H",attack:8,defense:7,protection:12,damage:"5d5",range:1,hp:80,danger:18,brain:"GoalOriented",base:"WinterBeingBase",onHit:[{addComp:"Stun",duration:"1d8"}]},{name:"Frostburn monarch",type:"demon",char:"M",attack:10,defense:10,protection:10,damage:"4d5",range:1,hp:70,danger:20,brain:"SpellCaster",base:"WinterBeingBase",onHit:[{addComp:"Coldness"}],spells:["FrostBolt","SummonIceMinion"],pp:50,maxPP:50},{name:"dwarf",char:"h",type:"dwarf",className:"cell-actor-dwarf",attack:2,defense:2,protection:1,damage:"1d4",range:1,hp:20,danger:3,enemies:["human","undead","demon"],brain:o},{name:"dwarven fighter",base:"dwarf",attack:4,defense:4,protection:2,damage:"1d7",range:1,hp:30,danger:4,equip:["Spear"]},{name:"dwarven axeman",base:"dwarf",attack:4,defense:4,protection:3,damage:"1d8",range:1,hp:40,danger:5,equip:["Battle axe","Chain armour"]},{name:"dwarven hammerer",base:"dwarf",attack:4,defense:6,protection:4,damage:"1d10",range:1,hp:45,danger:6,equip:["Dwarven pick-axe","Leather armour"]},{name:"dwarven bolter",base:"dwarf",attack:7,defense:3,damage:"1d8",range:1,hp:40,danger:7,fovrange:7,equip:["Steel crossbow",{name:"Steel bolt",count:7}]},{name:"dwarven rifleman",base:"dwarf",attack:4,defense:4,damage:"1d8",range:1,hp:40,danger:8,fovrange:7,equip:["Rifle",{name:"Steel bullet",count:10}]},{name:"dwarven elite",base:"dwarf",attack:5,defense:6,damage:"3d5 + 3",range:1,hp:50,danger:9,equip:["Battle axe","Steel armour"]},{name:"dwarven commander",base:"dwarf",attack:8,defense:8,protection:7,damage:"2d5",range:1,hp:60,danger:10,equip:["Great battle axe","Steel armour"]},{name:"dwarven king",base:"dwarf",colorfg:"red",attack:12,defense:12,protection:10,damage:"4d5 + 5",range:1,hp:75,danger:15,equip:["Mithril armour"]},{name:"human",char:"@",type:"human",className:"cell-actor-human",attack:2,defense:2,damage:"1d4",range:1,hp:20,danger:3,brain:o},{name:"townsfolk",base:"human",attack:1,defense:1,damage:"1d4",range:1,hp:10,danger:1},{name:"robber",base:"human",attack:2,defense:4,danger:3,enemies:["player"]},{name:"miner",base:"human",attack:4,danger:4,damage:"1d5",equip:["Pick-axe"]},{name:"fighter",base:"human",hp:25,attack:4,defense:4,damage:"1d8",danger:5},{name:"warlord",char:"W",base:"human",hp:35,attack:5,defense:6,damage:"3d3",danger:6},{name:"trainer",char:"@",base:"human",hp:50,attack:10,defense:10,protection:5,damage:"3d3",className:"cell-actor-trainer",noRandom:!0,danger:6,inv:[{name:"Gold coin",count:50}],addComp:"Trainer"},{name:"shopkeeper",char:"@",base:"human",hp:50,attack:10,defense:10,protection:5,damage:"3d3",className:"cell-actor-shopkeeper",noRandom:!0,danger:6,inv:[{name:"Gold coin",count:100}]},{name:"summoner",char:"@",base:"human",hp:50,attack:7,defense:7,protection:3,damage:"2d4",brain:"SpellCaster",spells:["SummonKin"],maxPP:30,pp:30,danger:10},{name:"wildling",char:"I",className:"cell-actor-wildling",type:"wildling",brain:o,attack:2,defense:1,damage:"1d6",range:1,hp:15,danger:3,enemies:["player","human"]},{name:"wildling hunter",base:"wildling",char:"I",attack:3,defense:3,damage:"1d6",hp:20,danger:3,equip:["Tomahawk"]},{name:"wildling archer",base:"wildling",char:"I",attack:3,defense:3,damage:"1d6",hp:20,danger:4,equip:["Wooden bow",{name:"Wooden arrow",count:10}],colorfg:"Yellow",brain:o},{name:"wildling fighter",base:"wildling",char:"I",attack:4,defense:3,damage:"1d9",hp:25,danger:5},{name:"wildling elite",base:"wildling",char:"I",attack:5,defense:3,damage:"1d10",hp:32,danger:6},{name:"wildling warlord",base:"wildling",char:"I",attack:6,defense:3,damage:"1d12",hp:40,danger:7,colorfg:"YellowGreen"},{name:"wildling king",base:"wildling",char:"I",attack:8,defense:5,damage:"1d15",hp:50,danger:10,colorfg:"Red"},{name:"CatfolkBase",char:"f",className:"cell-actor-catfolk",type:"catfolk",dontCreate:!0,attack:1,defense:1,protection:1,damage:"1d6",range:1,hp:10,danger:1,enemies:["player","human","dogfolk","wolfclan"],brain:o},{name:"catfolk townsfolk",base:"CatfolkBase",attack:1,defense:1,hp:10,danger:1},{name:"catfolk hunter",base:"CatfolkBase",attack:1,defense:4,damage:"3d2",hp:15,danger:2},{name:"catfolk darter",base:"CatfolkBase",attack:1,defense:4,damage:"3d2",hp:15,danger:3,brain:o,equip:[{name:"Iron dart",count:9}]},{name:"catfolk warrior",base:"CatfolkBase",attack:2,defense:5,damage:"4d2",hp:20,danger:4},{name:"catfolk elite",base:"CatfolkBase",attack:3,defense:7,damage:"5d2",hp:27,danger:5,addComp:"CounterAttack"},{name:"catfolk wizard",base:"CatfolkBase",attack:3,defense:6,damage:"4d2",hp:25,danger:6,brain:"SpellCaster",spells:["EnergyArrow"],maxPP:20,pp:20},{name:"catfolk warlord",base:"CatfolkBase",attack:4,defense:8,damage:"6d2",hp:35,danger:7},{name:"catfolk queen",base:"CatfolkBase",attack:6,defense:15,damage:"7d3",hp:45,danger:10,colorfg:"Purple",addComp:"FirstStrike"},{name:"catfolk king",base:"CatfolkBase",attack:10,defense:12,protection:6,damage:"7d3 + 5",hp:60,danger:13,colorfg:"Red"},{name:"WolfclanBase",dontCreate:!0,danger:1,attack:1,defense:1,damage:"1d4",range:1,protection:2,className:"cell-actor-wolfclan",char:"w",type:"wolfclan",enemies:["player","human","catfolk","dogfolk","bearfolk"],brain:o},{name:"wolfclan folk",base:"WolfclanBase",danger:1,hp:12,attack:2,defense:1,damage:"1d6",range:1},{name:"wolfclan brave",base:"WolfclanBase",danger:4,attack:4,defense:3,damage:"2d4",hp:25},{name:"wolfclan skirmisher",base:"WolfclanBase",danger:5,attack:5,defense:4,damage:"2d4+3",hp:30},{name:"wolfclan scourger",base:"WolfclanBase",danger:6,attack:7,defense:5,damage:"2d4+7",hp:35},{name:"wolfclan mage",base:"WolfclanBase",danger:7,attack:7,defense:5,damage:"2d4+7",hp:35,spells:["PowerDrain"],maxPP:30,pp:30,brain:"SpellCaster"},{name:"wolfclan elite",base:"WolfclanBase",danger:8,attack:8,defense:5,protection:5,damage:"2d4+10",hp:50,addComp:"CounterAttack"},{name:"wolfclan judicator",base:"WolfclanBase",danger:9,attack:8,defense:8,damage:"3d4+6",hp:55,addComp:"FirstStrike"},{name:"wolfclan commander",base:"WolfclanBase",danger:10,attack:10,defense:5,damage:"4d4+10",hp:60},{name:"wolfclan king",base:"WolfclanBase",danger:14,attack:10,defense:10,damage:"5d4+10",hp:75},{name:"DogfolkBase",dontCreate:!0,className:"cell-actor-dogfolk",char:"d",type:"dogfolk",protection:1,enemies:["player","catfolk","wolfclan"],brain:o},{name:"dogfolk gatherer",base:"DogfolkBase",attack:1,defense:3,damage:"1d4 + 1",hp:10,danger:1},{name:"dogfolk hunter",base:"DogfolkBase",attack:2,defense:3,damage:"6d1",hp:15,danger:2},{name:"dogfolk thrower",base:"DogfolkBase",attack:2,defense:3,damage:"6d1+1",hp:15,danger:3,equip:[{name:"Throwing axe",count:7}]},{name:"dogfolk warrior",base:"DogfolkBase",danger:4,attack:3,defense:3,damage:"7d1+3",hp:20},{name:"dogfolk skirmisher",base:"DogfolkBase",danger:5,attack:4,defense:3,damage:"9d1+3",hp:25},{name:"dogfolk elite",base:"DogfolkBase",danger:8,attack:6,defense:6,damage:"8d2+4",hp:35,addComp:"CounterAttack"},{name:"dogfolk commander",base:"DogfolkBase",danger:10,attack:8,defense:8,damage:"8d3+4",hp:50},{name:"dogfolk king",base:"DogfolkBase",danger:13,colorfg:"red",colorbg:"white",attack:12,defense:8,damage:"8d3+8",hp:65},{name:"SpiritBase",char:"Q",className:"cell-actor-spirit",type:"spirit",dontCreate:!0,addComp:["Ethereal"],brain:"Spirit"},{name:"Rat spirit",base:"SpiritBase",strength:0,accuracy:0,agility:1,willpower:0,power:1,danger:1},{name:"Wolf spirit",base:"SpiritBase",strength:1,accuracy:0,agility:1,willpower:0,power:2,danger:2},{name:"Bear spirit",base:"SpiritBase",strength:2,accuracy:0,agility:1,willpower:0,power:3,danger:3},{name:"Fighter spirit",base:"SpiritBase",strength:2,accuracy:2,agility:1,willpower:0,power:4,danger:4},{name:"Shaman spirit",base:"SpiritBase",strength:0,accuracy:0,agility:0,willpower:6,power:5,danger:5},{name:"Winter demon spirit",base:"SpiritBase",strength:3,accuracy:3,agility:3,willpower:3,power:7,danger:7},{name:"Monarch spirit",base:"SpiritBase",strength:6,accuracy:0,agility:1,willpower:6,power:10,danger:12},{name:"HyrkhianBase",dontCreate:!0,className:"cell-actor-hyrkh",char:"y",enemies:["undead","demon","beast","animal"],damage:"1d6",type:"hyrkhian",brain:o},{name:"Hyrkhian townsfolk",base:"HyrkhianBase",damage:"1d6",attack:1,defense:1,protection:1,hp:7,danger:1},{name:"Hyrkhian footman",base:"HyrkhianBase",attack:2,defense:2,protection:2,hp:15,danger:3,equip:["Longsword"]},{name:"Hyrkhian phalanx",base:"HyrkhianBase",attack:4,defense:4,protection:2,hp:25,danger:5,equip:["Chain armour","Spear"]},{name:"Hyrkhian archer",base:"HyrkhianBase",attack:4,defense:4,protection:2,damage:"1d8",hp:20,equip:["Steel bow",{name:"Steel arrow",count:15}],danger:6},{name:"Hyrkhian adept",base:"HyrkhianBase",attack:4,defense:4,protection:2,hp:25,danger:7,maxPP:30,pp:30,brain:"SpellCaster",spells:["Heal","MagicArmor"]},{name:"Hyrkhian elite",base:"HyrkhianBase",attack:6,defense:6,protection:3,hp:35,brain:o,strength:13,equip:["Mithril short sword","Chain armour","Chain helmet"],danger:8},{name:"Hyrkhian commander",base:"HyrkhianBase",attack:8,defense:8,protection:4,hp:50,brain:o,strength:15,equip:["Great battle axe","Steel armour","Steel helmet"],danger:10},{name:"SpecialBase",noRandom:!0,actorType:"BaseActor",dontCreate:!0},{name:"Fire",className:"cell-actor-fire",base:"SpecialBase",char:"*",type:"flame",brain:"Flame",addComp:["Ethereal","NonSentient",{comp:"Damaging",func:{setDamageType:n.default.DMG.FIRE}}]},{name:"Ice flame",className:"cell-actor-winter",base:"SpecialBase",char:"*",type:"flame",brain:"Flame",addComp:["Ethereal","NonSentient",{comp:"Damaging",func:{setDamageType:n.default.DMG.ICE}}],onHit:[{addComp:"Coldness",duration:"10d10"}]},{name:"Poison gas",className:"cell-actor-poison",base:"SpecialBase",char:"*",type:"flame",brain:"Cloud",color:r.color("Green","Gray"),addComp:["Ethereal","NonSentient",{comp:"Damaging",func:{setDamageType:n.default.DMG.POISON}}],poison:{duration:"1d10",damage:"1d10",prob:"0.1"}},{name:"Forcefield",className:"cell-actor-forcefield",base:"SpecialBase",char:"*",type:"forcefield",brain:"NonSentient",speed:1,hp:25,defense:0,addComp:["Health","NonSentient","Combat","SpellStop","Breakable",{comp:"Weakness",func:{setEffect:n.default.DMG.MAGIC,setLevel:n.default.WEAKNESS.FATAL}}]},{name:"flying eye",className:"cell-actor-void",base:"SpecialBase",char:"e",type:"eye",addComp:["Ethereal"],brain:"Explorer",hp:1,speed:130,fovrange:3,actorType:"Sentient"},{name:"UniqueBase",dontCreate:!0,className:"cell-actor-unique",noRandom:!0,unique:!0,addComp:["RegenEffect"],color:r.color("DarkViolet","Beige")},{name:"Thabba, Son of Ice",base:"UniqueBase",char:"@",danger:200,enemies:["human"],type:"finalboss",spells:["FrostBolt","RingOfFrost"],hp:266,pp:100,brain:"SpellCaster",damage:"4d5",strength:30,accuracy:15,agility:20,willpower:20,perception:15,magic:30,attack:30,defense:30,protection:10,equip:["Permaice katana","Permaice armour"],addComp:["SnowWalk",i("ICE","HIGH"),"RegenEffect"]},{name:"Zamoned, Son of Frost",base:"UniqueBase",char:"@",danger:200,enemies:["human"],type:"finalboss",hp:200,pp:100,brain:o,strength:20,accuracy:25,agility:35,willpower:15,perception:25,magic:10,attack:30,defense:30,protection:10,damage:"4d5",equip:["Permaice axe","Permaice armour","Bow of Defense",{name:"Runed arrow",count:100}],addComp:["SnowWalk",i("ICE","HIGH"),"RegenEffect"]},{name:"Hag of North",type:"wolfclan",base:"UniqueBase",char:"w",danger:100,damage:"4d4+5",hp:75,pp:50,brain:"SpellCaster",spells:["IcyPrison","FrostBolt"],strength:15,accuracy:15,agility:15,willpower:30,perception:25,magic:25,attack:15,defense:15,protection:5,equip:["Ruby glass armour","Ruby glass collar"],addComp:["SnowWalk",i("ICE","HIGH"),"RegenEffect"]},{name:"Aime Aeon en Nev, Mighty spellsinger",type:"dogfolk",base:"UniqueBase",char:"d",danger:100,damage:"5d5 + 5",hp:100,pp:75,brain:"SpellCaster",spells:["Paralysis","Flying","Heal","LightningArrow"],strength:18,accuracy:19,agility:18,willpower:28,perception:15,magic:25,attack:20,defense:15,protection:5,equip:["Runed armour","Runed collar"],onHit:[{addComp:"Stun",duration:"1d4 + 1"}],addComp:["RegenEffect"]},{name:"Aspelin Primoen, the Blacksmith",type:"dogfolk",base:"UniqueBase",char:"d",danger:75,damage:"3d7 + 3",hp:134,brain:o,strength:25,accuracy:20,agility:19,willpower:15,perception:19,magic:13,attack:25,defense:15,protection:10,equip:["Hammer of Void","Mithril armour"]},{name:"Elene Immolate Kinin, Queen of cats",type:"catfolk",base:"UniqueBase",char:"f",danger:100,damage:"10d3 + 3",hp:123,pp:50,brain:"SpellCaster",spells:["ScorpionsTail","EnergyArrow","SummonKin"],strength:15,accuracy:25,agility:25,willpower:17,perception:25,magic:17,attack:25,defense:15,protection:5,equip:["Steel armour","Runed collar"],addComp:["FirstStrike","RangedEvasion","RegenEffect"]},{name:"Tajun Eon en Lotus, lich lord",type:"undead",base:"UniqueBase",char:"L",danger:85,color:{fg:"Red",bg:"Black"},enemies:n.default.ACTOR_RACES,damage:"2d9 + 4",hp:90,pp:100,maxPP:100,brain:"SpellCaster",strength:14,accuracy:15,agility:14,willpower:25,perception:19,magic:30,attack:25,defense:15,protection:10,equip:["Runed robe"],onHit:[r.meleeHitDamage(4,"2d8 + 2","NECRO")],spells:["SummonDead","FrostBolt","GraspOfWinter"],addComp:["RegenEffect"]},{name:"Zargoth, undead sorcerer",type:"undead",base:"UniqueBase",char:"Z",danger:75,color:{fg:"DarkSalmon",bg:"Black"},enemies:n.default.ACTOR_RACES,damage:"2d9 + 4",hp:100,pp:75,maxPP:75,brain:"SpellCaster",strength:17,accuracy:20,agility:17,willpower:21,perception:19,magic:25,attack:25,defense:15,protection:10,fovrange:7,onHit:[r.meleeHitDamage(2,"1d8 + 2","NECRO")],spells:["SummonUndeadUnicorns","ShadowRay"],addComp:["RegenEffect"]},{name:"Emption Agana Sunkist, Emperor bear",type:"bearfolk",base:"UniqueBase",char:"B",danger:75,damage:"4d7 + 3",hp:123,brain:o,strength:35,accuracy:17,agility:17,willpower:17,perception:17,magic:10,attack:35,defense:35,protection:15,equip:["Mithril armour","Mithril shield"],onHit:[r.meleeHitDamage(8,"1d2","LIGHTNING"),{addComp:"Stun",duration:"1d4 + 1"}]},{name:"Dvaling, dwarven sharpshooter",type:"dwarf",base:"UniqueBase",char:"h",danger:70,damage:"4d7 + 3",hp:123,brain:o,strength:35,accuracy:17,agility:17,willpower:17,perception:30,magic:10,attack:35,defense:35,protection:5,fovrange:9,equip:["Chain armour","Chain helmet","Chain boots","Double crossbow",{name:"Void bolt",count:30}],addComp:["EagleEye","RangedEvasion","StrongShot","RegenEffect"]},{name:"Sierra Lilith Hupoith Zoic, the arcavian",type:"avianfolk",base:"UniqueBase",char:"A",danger:77,damage:"4d7 + 3",hp:123,brain:o,strength:20,accuracy:21,agility:21,willpower:17,perception:23,magic:22,attack:25,defense:25,protection:7,fovrange:7,equip:["Ruby glass armour","Mithril helmet","Mithril shield"],addComp:["Flying","RegenEffect","RangedEvasion"]}],t.Actors={},t.Actors.scaleValue=function(e,t,s){e.forEach(e=>{Number.isInteger(e[t])&&(e[t]=Math.round(s*e[t]))})},t.Actors.addValue=function(e,t,s){e.forEach(e=>{Number.isInteger(e[t])&&(e[t]+=s)})},t.Actors.scale={attack:2,danger:1,hp:1.5},t.Actors.add={attack:4},t.Actors.modToFunc={scale:"scaleValue",add:"addValue"},t.Actors.modOrder=["scale","add"],t.adjustActorValues=((e,s=t.Actors.modOrder)=>{s.forEach(s=>{const a=t.Actors.modToFunc[s];Object.keys(t.Actors[s]).forEach(n=>{t.Actors[a](e,n,t.Actors[s][n])})})}),t.resistance=i,t.BypassComp=l},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(9),o=s(27),i=s(11),l=s(17);t.Builder={},t.Builder.addPathToMap=function(e,t){const s=[];for(let a=0;a<t.length;a++){const n=t[a];if(e.hasXY(n.x,n.y)){const t=e.getBaseElemXY(n.x,n.y).getType();t.match(/(chasm|water)/)?e.setBaseElemXY(n.x,n.y,r.ELEM.BRIDGE):/stone|highrock/.test(t)?e.setBaseElemXY(n.x,n.y,r.ELEM.PATH):e.setBaseElemXY(n.x,n.y,r.ELEM.ROAD),s.push(n)}}return s},t.Builder.splitLevel=function(e,t){const s=[],a=e.getMap().cols/t.nLevelsX,r=e.getMap().rows/t.nLevelsY,c=e.getActors().slice(),h=e.getItems().slice(),u=c.length>0||h.length>0;for(let e=0;e<t.nLevelsX;e++){const e=[];for(let s=0;s<t.nLevelsY;s++){let t=null;if(u)t=(new l.FactoryLevel).createLevel("empty",a,r);else{t=new i.Level;const e=o.CellMap.createWithoutCells(a,r);t.setMap(e)}e.push(t)}s.push(e)}const d=(e,t)=>{const n=Math.floor(e/a),o=Math.floor(t/r);return s[n][o]},g=e=>e%a,p=e=>e%r,m=e.getMap();for(let e=0;e<m.cols;e++)for(let t=0;t<m.rows;t++){const s=d(e,t),a=g(e),n=p(t);u?s.getMap().setBaseElemXY(a,n,m.getBaseElemXY(e,t)):s.getMap().moveCellUnsafe(a,n,m.getCell(e,t))}return c.forEach(t=>{const s=t.getX(),a=t.getY();if(e.removeActor(t)){const e=d(s,a),n=g(s),r=p(a);e.addActor(t,n,r)}else n.default.warn("Geometry","splitLevel",`removeActor failed on ${JSON.stringify(t)}`)}),h.forEach(t=>{const s=t.getX(),a=t.getY();e.removeItem(t,s,a);const n=d(s,a),r=g(s),o=p(a);n.addItem(t,r,o)}),e.getStairs().length>0&&n.default.warn("Geometry","splitLevel","Function does not move stairs correctly (yet)."),s}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0));t.Template={},t.Template.$DEBUG=0;const r=/[A-Z]/,o=/\s*=\s*/,i=/\s*:\s*/,l=e=>{t.Template.$DEBUG&&console.log("[DEBUG "+e)};function c(e){const t=e.length,s={},a=[1];let n="",o="",i=0;for(let l=1;l<t;l++)o=e[l],r.test(o)?i>0?n===o?++i:(s[a.length]=i,a.push(i),i=1):++i:i>0?(s[a.length]=i,a.push(i),a.push(1),i=0):a.push(1),n=o;return i>0&&(s[a.length]=i,a.push(i)),{genPos:s,widths:a}}t.Template.createTemplate=function(e){const s=e.split("\n");let a=0,r=s[0];0===r.length&&(r=s[++a]);const h={},u={};for(;r&&r.length>0;){if(o.test(r)){const e=r.split(o);if(2===e.length){const t=e[0],s=e[1];t.length===s.length?h[e[0]]=e[1]:n.default.err("Template","createTemplate",`Key ${t}, val ${s} have different len`)}}else if(i.test(r)){const e=r.split(i);if(2===e.length){const t=e[0],s=e[1];u[t]=s}else n.default.warn("Template","createTemplate",`Prop must be key:val. Ignoring line ${r}`)}r=s[++a]}a===s.length&&n.default.err("Template","createTemplate","No empty line between header and template section."),++a;const d=[];for(;a<s.length;)d.push(s[a]),++a;let g=d[0].split("");const{genPos:p,widths:m}=c(g);l(JSON.stringify(p)),l(JSON.stringify(m));const f=[],y=[];let _=0;for(let e=0;e<d.length;e++){let t=0,s=0;y.push([]),g=d[e].split(""),l(JSON.stringify(`y: ${_} currLineArr: ${g}`)),f.push(g[0]);for(let e=0;e<m.length;e++){const a=m[e],n=g.slice(t,t+a);l(`x: ${t}, w: ${a}, elem: ${n}`),n&&(y[_][s]=n),t+=a,++s}++_}y.forEach((e,t)=>{l(`Row[${t}]: ${JSON.stringify(e)}`)}),l("firstCols is: "+JSON.stringify(f));const{genPos:E,widths:S}=c(f);l("@yGenPos: "+JSON.stringify(E)),l("@yWidths: "+JSON.stringify(S));const v={xGenPos:p,yGenPos:E,xWidths:m,yWidths:S,rows:y,elemMap:h},C=new t.ElemTemplate(v);return C.setProps(u),C},t.ElemTemplate=function(e){if(e&&(this.elemMap=e.elemMap,this.nMaps=Object.keys(this.elemMap).length,this.sizeX=e.xWidths.length,this.sizeY=e.rows.length,this.xWidths=e.xWidths,this.yWidths=e.yWidths,this.xGenPos=e.xGenPos,this.yGenPos=e.yGenPos),this.elemPropMap={},this.elemArr=[],this.hasGenRow={},e){for(let t=0;t<this.sizeX;t++){this.elemArr[t]=[];for(let s=0;s<this.sizeY;s++)this.elemArr[t][s]=e.rows[s][t].join("")}Object.keys(this.xGenPos).forEach(e=>{for(let t=0;t<this.sizeY;t++){const s=this.elemArr[e][t];this.elemArr[e][t]=new h(s)}})}this.setProps=function(e){this.elemPropMap=e},this.getProp=function(e){return this.elemPropMap[e]},this.getDir=function(){const e=this.getProp("dir");return e?e.split("").sort().join(""):""},this.setProp=function(e,t){this.elemPropMap[e]=t},this.getChars=function(e){if(e){if(Number.isInteger(e)){const t=e;e=[];for(let s=0;s<this.nMaps;s++)e.push(t)}}else{e=[];for(let t=0;t<this.nMaps;t++)e.push(1)}if(!(e.length>0&&e.length<this.nMaps)){let t=0,s=!1;const a=[];for(let n=0;n<this.sizeX;n++){a[n]=[];for(let r=0;r<this.sizeY;r++)if("object"==typeof this.elemArr[n][r]){const o=e[t];a[n][r]=this.elemArr[n][r].getChars(o),s=!0}else a[n][r]=this.elemArr[n][r];s&&(++t,s=!1)}this.substituteXMaps(a),l("X before split: "+JSON.stringify(a));const r=this.splitMultiElements(a);if(l("After-X, Before-Y: "+JSON.stringify(r)),Object.keys(this.yGenPos).length>0){const s=[];for(let e=0;e<this.sizeX;e++){s[e]=[];let t=0,n=0;this.yWidths.forEach(r=>{s[e][t]=a[e].slice(n,n+r),++t,n+=r})}l("y after widths "+JSON.stringify(s)),Object.keys(this.yGenPos).forEach(a=>{for(let n=0;n<this.sizeX;n++)s[n][a]=this.expandYGen(e[t],s[n][a]);++t});const r=n.default.flattenTo2D(s);l("y after flatten "+JSON.stringify(r));const o=this.splitMultiElements(r);return l("y after flatten "+JSON.stringify(o)),this.substituteYMaps(o),o}return l("X-Before subst: "+JSON.stringify(a)),l("X-After, split: "+JSON.stringify(r)),r}return n.default.err("ElemTemplate","getChars",`Input array length must be ${this.nMaps}.`),[]},this.expandYGen=((e,t)=>{l(`expandYGen ${e} -> ${t}`);const s=[];for(let a=0;a<e;a++)s.push(t);return s}),this.substituteXMaps=function(e){const t=e.length;Object.keys(this.elemMap).forEach(s=>{const a=new RegExp(s,"g");for(let n=0;n<t;n++)e[n][0]=e[n][0].replace(a,this.elemMap[s])})},this.substituteYMaps=function(e){let s=[];const a=e[0].length;for(let t=0;t<a;t++)s.push(e[0][t]);l("firstCol is now: "+JSON.stringify(s));let r=s.join("");Object.keys(this.elemMap).forEach(e=>{const t=new RegExp(e,"g");r=r.replace(t,this.elemMap[e])}),s=r.split(""),l("firstCol END: "+JSON.stringify(s)),t.Template.$DEBUG&&n.default.printMap(e);for(let t=0;t<a;t++)e[0][t]=s[t]},this.splitMultiElements=(e=>{const t=e.length,s=[];let a=0;for(let n=0;n<t;n++){const t=e[n],r=t[0].length;if(r>1){l(`Splitting ${r} nChars: ${t}`);for(let e=0;e<t.length;e++){const n=t[e];let r=a;n.split("").forEach(t=>{0===e?(s.push([t]),l("\tres push "+JSON.stringify(s))):(s[r++].push(t),l("\tres[x] push "+JSON.stringify(s)))})}a+=r}else++a,s.push(t)}return s}),this.clone=(()=>{const e=new t.ElemTemplate,s=JSON.parse(JSON.stringify(this));return Object.keys(s).forEach(t=>{e[t]=s[t]}),Object.keys(this.xGenPos).forEach(t=>{for(let s=0;s<this.sizeY;s++){const a=e.elemArr[t][s].genX;e.elemArr[t][s]=new h(a)}}),e})},t.Template.ElemTemplate=t.ElemTemplate;const h=function(e){const t=e.length;this.length=(()=>t),this.getChars=((t=1)=>e.repeat(t)),this.toJSON=(()=>({genX:e}))};t.Template.ElemGenX=h;const u={N:"E",E:"S",S:"W",W:"N"},d={rotate90:u,rotate180:u,rotate270:u};t.Template.rotateR90=function(e,t=u){const s=e.clone();p(s,t);const a=[];let n=Object.keys(s.xGenPos).length;n+=Object.keys(s.yGenPos).length;for(let e=0;e<n;e++)a.push(1);const r=s.getChars(a),o=r[0].length,i=new Array(o);for(let e=0;e<o;e++)i[e]=[];for(let e=0;e<r.length;e++)for(let t=0;t<o;t++)i[o-1-t].push(r[e][t]);s.yGenPos=Object.assign({},e.xGenPos);const l=i.length;return s.xGenPos={},Object.keys(e.yGenPos).forEach(t=>{const a=l-1-parseInt(t,10);s.xGenPos[a]=e.yGenPos[t]}),s.elemArr=i,Object.keys(s.xGenPos).forEach(e=>{for(let t=0;t<s.sizeY;t++)try{s.elemArr[e][t]=new h(s.elemArr[e][t])}catch(e){throw console.log("Template:",s.getProp("name")),console.log("xGenPos: ",s.xGenPos),new Error(e)}}),s},t.Template.rotateR180=function(e,s=u){const a=t.Template.rotateR90(e,s);return t.Template.rotateR90(a,s)},t.Template.rotateR270=function(e,s=u){const a=t.Template.rotateR180(e,s);return t.Template.rotateR90(a,s)};const g={E:"W",W:"E"};function p(e,t){const s=e.getProp("dir");if(s){const a=s.split("");a.forEach((e,s)=>{t.hasOwnProperty(e)&&(a[s]=t[e])}),e.setProp("dir",a.join(""))}}function m(e,t){let s=t.getProp("name");switch(e){case"rotateR90":s+="_r90";break;case"rotateR180":s+="_r180";break;case"rotateR270":s+="_r270";break;case"flipVer":s+="_flip"}t.setProp("name",s)}d.flipVer=g,t.Template.flipVer=function(e,t=g){const s=e.clone();p(s,t);const a=[];let n=Object.keys(s.xGenPos).length;n+=Object.keys(s.yGenPos).length;for(let e=0;e<n;e++)a.push(1);const r=s.sizeX,o=new Array(r);for(let e=0;e<r;e++)o[e]=[];const i=s.sizeY,l=s.getChars(a);for(let e=0;e<r;e++)for(let t=0;t<i;t++)o[r-1-e][t]=l[e][t];const c=o.length;return s.xGenPos={},Object.keys(e.xGenPos).forEach(t=>{if(parseInt(t,10)<c-1){const a=c-1-parseInt(t,10);s.xGenPos[a]=e.xGenPos[t]}else{const a=t;s.xGenPos[a]=e.xGenPos[t]}}),s.elemArr=o,Object.keys(s.xGenPos).forEach(e=>{for(let t=0;t<s.sizeY;t++)s.elemArr[e][t]=new h(s.elemArr[e][t])}),s},t.Template.transformList=function(e,s,a){n.default.isNullOrUndef([e])&&n.default.err("Template","transformList","Input list templates is null");let r=[];return s||(s={all:"*",flipVer:[],rotateR90:[],rotateR180:[],rotateR270:[]}),Object.keys(s).forEach(n=>{if("all"!==n){const o=[];let i=s[n];(i="*"===s.all?e.map(e=>e.getProp("name")):i.concat(s.all)).forEach(r=>{const i=e.find(e=>e.getProp("name")===r);if(i){const e=a?a[n]:d[n],l=t.Template[n](i,e);m(n,l),o.push(l),"flipVer"===n&&function(e,t){const s=[];return["rotateR90","rotateR180","rotateR270"].forEach(a=>{(e[a].indexOf(t)>=0||"*"===e.all)&&s.push(a)}),s}(s,r).forEach(e=>{const s=a?a[e]:d[e],n=t.Template[e](l,s);m(e,n),o.push(n)})}}),r=r.concat(o)}}),r}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(5);t.LevelGenerator=class{constructor(){this.shouldRemoveMarkers=!0}addStartAndEndPoint(e,t,s){if(t){const[s,a]=t,n=new r.ElementMarker("<");n.setTag("start_point"),e.addElement(n,s,a)}if(s){const[t,a]=s,n=new r.ElementMarker(">");n.setTag("end_point"),e.addElement(n,t,a)}}removeMarkers(e,t){let s=["start_point","end_point","critical_path"];t.markersPreserved?s=s.concat(t.markersPreserved):!1===t.markersPreserved&&(s=[]),n.default.isNullOrUndef([t.shouldRemoveMarkers])||(this.shouldRemoveMarkers=t.shouldRemoveMarkers),this.shouldRemoveMarkers&&e.removeElements(e=>{if(e.getTag){const t=e.getTag();if(s.indexOf(t)<0)return!0}return!1})}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(74),i=n(s(20)),l=s(24),c=s(79),h=s(25),u=s(17),d=s(7),g=s(1),p=n(s(5)),m=s(9),f=d.EventPool.getPool(),y=g.Random.getRNG(),_=function(e){["itemsPerLevel","maxValue","func"].forEach(t=>{if(t in e)this[t]=e[t];else{const e=`${t} must be given`;r.default.err("ItemConf","new",e)}})};t.Factory={},t.Factory.cityConfBase=(e=>{const t=e||{},s={nShops:1,shopFunc:[e=>e.type===y.arrayGetRand(r.default.SHOP_TYPES)],shopType:"",levelType:"arena"};return Object.assign(s,t)}),t.FactoryBase=function(){this._verif=new i.Conf("FactoryBase"),this._actorFact=new c.FactoryActor,this._itemFact=new h.FactoryItem,this._levelFact=new u.FactoryLevel,this.createDie=(e=>r.default.createDie(e)),this.createPlayer=((e,t)=>this._actorFact.createPlayer(e,t)),this.createActor=((e,t={})=>this._actorFact.createActor(e,t)),this.createBrain=((e,t)=>this._actorFact.createBrain(e,t)),this.createSpell=(e=>this._actorFact.createSpell(e)),this.createElement=(e=>{if(m.ELEM_MAP.elemTypeToObj[e])return m.ELEM_MAP.elemTypeToObj[e];switch(e){case"door":return new p.ElementDoor(!0);case"opendoor":return new p.ElementDoor(!1);default:return null}}),this.createFloorCell=((e,t)=>new o.Cell(e,t,new p.ElementBase("floor"))),this.createWallCell=((e,t)=>new o.Cell(e,t,new p.ElementWall("wall"))),this.createLevel=function(e,t,s,a){return this._levelFact.createLevel(e,t,s,a)},this.addNRandItems=((e,t,s)=>(this._verif.verifyConf("addNRandItems",s,["func","maxValue"]),this._itemFact.addNRandItems(e,t,s))),this.addNRandActors=((e,t,s)=>{this._verif.verifyConf("addNRandActors",s,["maxDanger","actorsPerLevel"]);const a=s.maxDanger,n=this.generateNActors(s.actorsPerLevel,s.func,a);return n?(l.Placer.addPropsToFreeCells(e,n,r.default.TYPE_ACTOR),n.length):0}),this.setParser=(e=>{this._parser=e}),this.generateNActors=((e,t,s)=>this._actorFact.generateNActors(e,t,s)),this.addRandomGold=((e,t,s)=>{this._itemFact.addRandomGold(e,t,s)}),this.createHumanArmy=((e,t)=>{for(let s=0;s<2;s++){for(let a=0;a<20;a++){const n=t.createActualObj("actors","fighter");e.addActor(n,a+1,4+s)}const a=t.createActualObj("actors","warlord");e.addActor(a,10,s+7)}}),this.createDemonArmy=((e,t)=>{for(let s=0;s<2;s++)for(let a=0;a<10;a++){const n=t.createActualObj("actors","Winter demon");e.addActor(n,a+10,14+s),f.emitEvent(r.default.EVT_ACTOR_CREATED,{actor:n,level:e,msg:"DemonSpawn"})}}),this.createBeastArmy=function(e,t){const s=e.getMap().cols/2,a=e.getMap().rows/2;for(let n=a;n<a+2;n++)for(let a=s;a<s+10;a++){const s=t.createActualObj("actors","Blizzard beast"),o=a+10,i=n+14;e.getMap().hasXY(o,i)?(e.addActor(s,o,i),f.emitEvent(r.default.EVT_ACTOR_CREATED,{actor:s,level:e,msg:"DemonSpawn"})):r.default.warn("FactoryBase","createBeastArmy",`Cannot put beast to ${o}, ${i}.`)}},this.addActorsToBbox=((e,t,s)=>{const a=s.nActors||4,{maxDanger:n,func:r}=s,o=this.generateNActors(a,r,n);l.Placer.addActorsToBbox(e,t,o)}),this.addItemsToBbox=((e,t,s)=>{const a=s.nItems||4;let n=Object.assign({itemsPerLevel:a},s);n=new _(n);const o=(new h.FactoryItem).generateItems(n),i=e.getMap().getFreeInBbox(t);l.Placer.addPropsToCells(e,i,o,r.default.TYPE_ITEM)})}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(139),i=s(54),l=s(8)("bitn:Factory.World"),c=n(s(20)),h=s(84),u=n(s(21)),d=s(38),g=s(83),p=s(6),m=s(147),f=s(148),y=s(62),_=s(149),E=s(61),S=s(150),v=n(s(5)).ElementStairs,C=["City","Mountain","Dungeon","BattleZone"],b={tile:{Small:{x:40,y:20},Medium:{x:60,y:30},Large:{x:80,y:40},Huge:{x:140,y:60}},mountain:{Small:{x:40,y:20},Medium:{x:60,y:30},Large:{x:80,y:40},Huge:{x:140,y:60}},dungeon:{Small:{x:r.default.LEVEL_SMALL_X,y:r.default.LEVEL_SMALL_Y},Medium:{x:r.default.LEVEL_MEDIUM_X,y:r.default.LEVEL_MEDIUM_Y},Large:{x:r.default.LEVEL_LARGE_X,y:r.default.LEVEL_LARGE_Y},Huge:{x:r.default.LEVEL_HUGE_X,y:r.default.LEVEL_HUGE_Y}},city:{Small:{x:40,y:20},Medium:{x:60,y:30},Large:{x:80,y:40},Huge:{x:140,y:60}}};function T(e,t,s){if("Iron hills"===e.name){r.default.diag(s+" Creating iron hills connection now");const e=t.getConnections().filter(e=>"mountain"===e.getName());if(r.default.diag("\t## Ex. conns: "+JSON.stringify(e)),e.length>0){const t=e[0].getTargetLevel();r.default.diag("\t## Parent: "+t.getParent().getName())}}}t.FactoryWorld=function(){this._verif=new c.Conf("FactoryWorld"),this.factZone=new g.FactoryZone,this.createAllZones=!0,this.worldElemByID={},this.presetLevels={},this._conf=new h.ConfStack,this.id2level={},this.id2levelSet=!1,this.id2entity={},this.setRNG=function(e){this.factZone.setRNG(e)},this.setPresetLevels=function(e){this.presetLevels=e,this.debug("PresetLevels were set.")},this.setId2Level=function(e){0===Object.keys(e).length&&r.default.warn("FactoryWorld","setId2Level","There are no levels/keys present in id2level map. Bug?"),this.id2level=e,this.id2levelSet=!0,this.debug("Id2Level was set OK.")},this.pushScope=function(e){this._conf.pushScope(e)},this.popScope=function(e){this._conf.popScope(e)},this.setGlobalConf=function(e={}){const t=e.levelSize||"Medium",s=e.sqrPerActor||r.default.ACTOR_MEDIUM_SQR,a={levelSize:t,dungeonX:b.dungeon[t].x,dungeonY:b.dungeon[t].y,sqrPerActor:s,sqrPerItem:e.sqrPerItem||r.default.LOOT_MEDIUM_SQR,set:!0};this._conf.setGlobalConf(a),this.debug("globalConf set to "+JSON.stringify(a))},this.getGlobalConf=function(){return this._conf.getGlobalConf()},this.getConf=function(e){return this._conf.getConf(e)},this.setOverWorld=function(e){this.overworld=e},this.getHierName=(()=>this._conf.getScope().join(".")),this.createWorld=function(e){this._verif.verifyConf("createWorld",e,["name","nAreas"]),this.getGlobalConf().set||this.setGlobalConf({}),e.hasOwnProperty("createAllZones")&&(this.createAllZones=e.createAllZones,this.debug("createAllZones set to "+this.createAllZones)),this.pushScope(e);const t=new u.WorldTop(e.name);t.setConf(e);for(let s=0;s<e.nAreas;s++){const a=e.area[s],n=this.createArea(a);a.zonesCreated&&this.restoreCreatedZones(t,n,a),t.addArea(n),this.addWorldID(a,n)}return this.popScope(e),this.addWorldID(e,t),t},this.createArea=function(e){this._verif.verifyConf("createArea",e,["name","maxX","maxY"]),this.pushScope(e);const t=this.getHierName();let s=null;this.id2levelSet?s=this.getAreaLevels(e):(s=this.getPresetLevels(t,e))&&0!==s.length||(s=null);const a=new u.Area(e.name,e.maxX,e.maxY,e.cols,e.rows,s);return a.setConf(e),a.setHierName(this.getHierName()),this.createAllZones?(this._createAllZones(a,e),a.markAllZonesCreated()):this.debug("Skipping the zone creating due to createZones=false"),this.popScope(e),a},this.restoreCreatedZones=((e,t,s)=>{Object.keys(s.zonesCreated).forEach(a=>{const[n,r]=a.split(","),[o,i]=[parseInt(n,10),parseInt(r,10)];s.zonesCreated[a]&&(this.debug(`\tRestoring created zones for tile ${o},${i}`),this.createZonesForTile(e,t,o,i))})}),this.createZonesForTile=((e,t,s,a)=>{if(t.tileHasZonesCreated(s,a))this.debug(`Area ${s},${a} zones already created`);else{this.debug(`Creating Area ${s},${a} zones (not created yet)`);const n=e.getConf();this.pushScope(n);const r=t.getConf();this.pushScope(r),this.populateAreaLevel(t,s,a),this._createAllZones(t,r,s,a),t.markTileZonesCreated(s,a),this.createQuests(e,t,s,a),this.popScope(r),this.popScope(n)}}),this.populateAreaLevel=((e,t,s)=>{const a=Math.floor(e.getSizeX()/2),n=e.getSizeY()-1,o=p.ObjectShell.getParser(),i=e.getTileXY(t,s).getLevel(),l=Math.abs(a-t),c=n-s,h=7+l+2*c,u=10*(c+1)+2*l+10,g=new d.FactoryBase;g.setParser(o);const m=r.default.getMaxValue(l,c),f=r.default.getMaxDanger(l,c),y={itemsPerLevel:h,item:e=>e.value<=m&&"food"!==e.type,actor:e=>e.danger<=f,gold:()=>!1,food:()=>!1,maxValue:m,actorsPerLevel:u,maxDanger:f};this.setAreaLevelConstraints(y,t,s),y.func=y.item,g.addNRandItems(i,o,y),y.func=y.actor,g.addNRandActors(i,o,y)}),this._createAllZones=((e,t,s=-1,a=-1)=>{if(this.debug(`_createAllZones ${s}, ${a}`),t.tiles)if(s<0||a<0)this.createZonesFromArea(e,t,s,a);else{const n=t.tiles[s][a];this.createZonesFromTile(e,n,s,a)}else this.createZonesFromArea(e,t,s,a)}),this.createZonesFromArea=((e,t,s=-1,a=-1)=>{this.debug(`createZonesFromArea ${s}, ${a}`),C.forEach(n=>{const r=n.toLowerCase(),o="create"+n;let i=0;Array.isArray(t[r])&&(i=t[r].length),this.debug(`\tnZones (${n}) is now ${i}`);for(let l=0;l<i;l++){const i=t[r][l],{x:c,y:h}=i;if(!(-1!==s&&s!==c||-1!==a&&a!==h)){const t=this[o](i);t.setTileXY(c,h),e.addZone(n,t),this.addWorldID(i,t),this.id2levelSet||this.createAreaZoneConnection(e,t,i)}}})}),this.createZonesFromTile=((e,t,s,a)=>{C.forEach(n=>{const r=n.toLowerCase();let o=0;Array.isArray(t[r])&&(o=t[r].length),this.debug(`\t[${s}][${a}]: nZones (${n}) is now ${o}`);for(let i=0;i<o;i++){const o=t[r][i],l="create"+n,{x:c,y:h}=o;if(!(-1!==s&&s!==c||-1!==a&&a!==h)){const t=this[l](o);t.setTileXY(c,h),e.addZone(n,t),this.addWorldID(o,t),this.id2levelSet||this.createAreaZoneConnection(e,t,o)}}})}),this.getAreaLevels=(e=>{const t=[];return e.tiles?e.tiles.forEach(e=>{const s=[];e.forEach(e=>{const t=this.id2level[e.level];t?s.push(t):r.default.err("FactoryWorld","getAreaLevels",`No level ID ${e.level} in id2level`)}),t.push(s)}):r.default.err("FactoryWorld","getAreaLevels","conf.tiles null/undefined, but id2levelSet true"),t}),this.createDungeon=function(e){this._verif.verifyConf("createDungeon",e,["name","nBranches"]),this.pushScope(e);const t=new u.Dungeon(e.name);if(t.setHierName(this.getHierName()),e.nBranches!==e.branch.length){const t=e.branch.length;r.default.err("Factory.World","createDungeon",`Branch number mismatch [] = ${t}, n: ${e.nBranches}`)}for(let s=0;s<e.nBranches;s++){const a=e.branch[s],n=this.createBranch(a);t.addBranch(n),this.addWorldID(a,n)}return e.entrance&&t.setEntrance(e.entrance),this.id2levelSet||e.nBranches>1&&(e.connectLevels?e.connectLevels.forEach(e=>{4===e.length?t.connectSubZones(...e):r.default.err("Factory.World","createDungeon","Each connection.length must be 4.")}):r.default.err("Factory.World","createDungeon","nBranches > 1, but no conf.connectLevels.")),this.popScope(e),t},this.createBranch=function(e){this._verif.verifyConf("createBranch",e,["name","nLevels"]),this.pushScope(e);const t=new u.Branch(e.name),s=this.getHierName();t.setHierName(s);const a=this.getPresetLevels(s,e);for(let s=0;s<e.nLevels;s++){const n=this.getConf("maxDanger"),r=this.getConf("maxValue"),o={x:this.getConf("dungeonX"),y:this.getConf("dungeonY"),sqrPerActor:this.getConf("sqrPerActor"),sqrPerItem:this.getConf("sqrPerItem"),maxValue:r?r+20*s:20*(s+1),maxDanger:n?n+s:2+s,nLevel:s},i=this.getConf("dungeonType");i&&(o.dungeonType=i),this.setLevelConstraints(o);let l=this.getFromPresetLevels(s,a);if(l)e.createPresetLevels&&e.create&&this.addFixedFeatures(s,l,t);else if(e.levels)l=this.id2level[e.levels[s]];else{const[a,n]=[o.x,o.y];if(o.markersPreserved=!1,/(crypt)/i.test(i)){l=(new _.CryptGenerator).create(a,n,o),this.factZone.addItemsAndActors(l,o),this.factZone.addExtraDungeonFeatures(l,o)}else if(/cave/.test(i)){l=(new f.CaveGenerator).create(a,n,o),this.factZone.addItemsAndActors(l,o),this.factZone.addExtraDungeonFeatures(l,o)}else if(/(fort|castle)/.test(i)){l=(new y.CastleGenerator).create(a,n,o)}else{l=(new m.DungeonGenerator).create(a,n,o)}this.addFixedFeatures(s,l,t);const r=new S.DungeonFeatures("dungeon");s===e.nLevels-1&&r.addLastLevelFeatures(s,l,o)}t.addLevel(l)}return this.id2levelSet?e.hasOwnProperty("entrance")&&t.setEntranceLocation(e.entrance):(t.connectLevels(),e.hasOwnProperty("entranceLevel")&&t.addEntrance(e.entranceLevel)),this.popScope(e),t},this.getFromPresetLevels=((e,t)=>{let s=null;if(t.length>0){const a=t.find(t=>t.nLevel===e);a&&(s=a.level)}return s});const e=e=>{"function"==typeof e&&r.default.err("Factory","_errorOnFunc",`Function constraint not supported anymore: ${e.toString()}`)};this.setLevelConstraints=function(t){const s=this.getConf("constraint"),a=new i.Constraints;if(s){const n=this.getHierName();if(s.actor){e(s.actor),t.actor=a.getConstraints(s.actor);const r=JSON.stringify(s.actor);this.debug(`Found actor constraint for ${n}: ${r}`)}if(s.item){e(s.item),t.item=a.getConstraints(s.item);const r=JSON.stringify(s.item);this.debug(`Found item constraint for ${n}: ${r}`)}if(s.food){e(s.food),t.food=a.getConstraints(s.food);const r=JSON.stringify(s.food);this.debug(`Found food constraint for ${n}: ${r}`)}if(s.gold){e(s.gold),t.gold=a.getConstraints(s.gold);const r=JSON.stringify(s.gold);this.debug(`Found gold constraint for ${n}: ${r}`)}if(s.shop){const e=[];s.shop.forEach(t=>{e.push(a.getConstraints(t))}),t.shopFunc=e;const r=JSON.stringify(s.shop);this.debug(`Found shop constraint for ${n}: ${r}`)}if(s.disposition){s.disposition;t.disposition=s.disposition}if(s.cellsAround){const{cellsAround:e}=s;t.cellsAround=e}}const n=this.getConf("groupType"),r=this.getConf("cityType"),o=this.getConf("quarterType"),l=this.getConf("alignment"),c=this.getConf("wallType"),h=this.getConf("floorType"),u=this.getConf("friendly");n&&(t.groupType=n),r&&(t.cityType=r),o&&(t.cityType=o),l&&(t.alignment=l),c&&(t.wallType=c),h&&(t.floorType=h),u&&(t.friendly=!0)},this._verifyConstraintKeys=function(e){const t=new Set(["actor","item","food","gold","shop","disposition"]);Object.keys(e).forEach(s=>{if(!t.has(s)){const t=JSON.stringify(e);r.default.err("Factory.World","_verifyConstraintKeys",`Unsupported key ${s} in ${t}`)}})},this.setAreaLevelConstraints=function(e,t,s){const a=t+","+s,n=this.getConf("constraint");if(n&&n.hasOwnProperty(a)){const t={name:"AreaLevel["+a+"]",constraint:n[a]};this.pushScope(t),this.setLevelConstraints(e),this.popScope(t)}},this.addFixedFeatures=function(e,t,s){const a=this.getConf("create");if(a&&a.actor){a.actor.forEach(a=>{if(a.nLevel===e){const e=a.name;a.hasOwnProperty("target")&&(s.getName(),a.target),this.factZone.addActorToLevel(e,t)}})}if(a&&a.stairs){a.stairs.forEach(s=>{if(s.nLevel===e){const{x:e,y:a,isDown:n}=s,r=new v(n?"stairsDown":"stairsUp",t);t.addStairs(r,e,a)}})}},this.getPresetLevels=function(e,t){const s=this.getConf("presetLevels");if(s){const t=Object.keys(s).find(t=>new RegExp(t+"$").test(e));if(t)return s[t]}const a=Object.keys(this.presetLevels).find(t=>new RegExp(t+"$").test(e));if(a)return this.presetLevels[a];if(t&&t.createPresetLevels){const{createPresetLevels:e}=t,s=new o.LevelFactory(this).create(e.new,e.args);if(!s){let e="Found createPresetLevels but no levels created";e+=" conf: "+JSON.stringify(t),r.default.err("Factory","getPresetLevels",e)}return s}return[]},this.createMountain=function(e){this._verif.verifyConf("createMountain",e,["name","nFaces","face"]),this.pushScope(e);const t=new u.Mountain(e.name);if(t.setHierName(this.getHierName()),e.nFaces!==e.face.length){const t=e.face.length;r.default.err("Factory.World","createMountain",`Face number mismatch [] = ${t}, n: ${e.nFaces}`)}for(let s=0;s<e.nFaces;s++){const a=e.face[s],n=this.createMountainFace(a);t.addSubZone(n),this.addWorldID(a,n)}for(let s=0;s<e.nSummits;s++){const a=e.summit[s],n=this.createSummit(a);t.addSubZone(n),this.addWorldID(a,n)}return this.id2levelSet||(e.nFaces>1||1===e.nFaces&&e.nSummits>0)&&(e.connectLevels&&e.connectLevels.length>0?e.connectLevels.forEach(e=>{4===e.length?t.connectSubZones(...e):r.default.err("Factory.World","createMountain","Each connection.length must be 4.")}):r.default.err("Factory.World","createMountain","nFaces > 1, but no conf.connectLevels.")),this.popScope(e),t},this.createMountainFace=function(e){this.id2levelSet?this._verif.verifyConf("createMountainFace",e,["name","nLevels"]):this._verif.verifyConf("createMountainFace",e,["name","nLevels","x","y"]);const t=e.name;this.pushScope(e);const s=new u.MountainFace(t),a={x:e.x,y:e.y};this.setLevelConstraints(a);for(let t=0;t<e.nLevels;t++){let n=null;if(this.id2levelSet){const s=e.levels[t];n=this.id2level[s]}else n=this.factZone.createMountainLevel(a);s.addLevel(n)}return this._addEntranceToSubZone(s,e),this.popScope(e),s},this.createSummit=function(e){this._verif.verifyConf("createSummit",e,["name","nLevels"]),this.pushScope(e);const t=new u.MountainSummit(e.name),s=Object.assign({},e);this.setLevelConstraints(s),this.addMaxDangerIfMissing(s);for(let a=0;a<e.nLevels;a++){let n=null;if(this.id2levelSet){const t=e.levels[a];n=this.id2level[t]}else{n=this.factZone.createSummitLevel(s);const t=new S.DungeonFeatures("mountain");a===e.nLevels-1&&t.addLastLevelFeatures(a,n,s)}t.addLevel(n)}return this._addEntranceToSubZone(t,e),this.popScope(e),t},this.addMaxDangerIfMissing=function(e){if(Number.isInteger(e.maxDanger)||(e.maxDanger=this.getConf("maxDanger")),!Number.isInteger(e.maxValue)){const t=this.getConf("maxValue");t&&(e.maxValue=t)}},this._addEntranceToSubZone=function(e,t){t.hasOwnProperty("entranceLevel")?e.addEntrance(t.entranceLevel):t.hasOwnProperty("entrance")&&e.setEntranceLocation(t.entrance)},this.createCity=function(e){this._verif.verifyConf("createCity",e,["name","nQuarters"]),this.pushScope(e);const t=new u.City(e.name);if(t.setHierName(this.getHierName()),e.nQuarters!==e.quarter.length){const t=e.quarter.length;r.default.err("Factory.World","createCity",`Quarter number mismatch [] = ${t}, n: ${e.nQuarters}`)}for(let s=0;s<e.nQuarters;s++){const a=e.quarter[s],n=this.createCityQuarter(a);t.addSubZone(n),this.addWorldID(a,n)}if(!this.id2levelSet&&e.nQuarters>1)if(e.connectLevels)e.connectLevels.forEach(e=>{4===e.length?t.abutQuarters(...e):r.default.err("Factory.World","createCity","Each connection.length must be 4.")});else{let t="nQuarters > 1, but no conf.connectLevels.";t+=`cityConf: ${JSON.stringify(e)}`,r.default.err("Factory.World","createCity",t)}return this.popScope(e),t},this.createCityQuarter=function(e){this._verif.verifyConf("createCityQuarter",e,["name","nLevels"]),this.pushScope(e);const t=new u.CityQuarter(e.name),s=this.getHierName();t.setHierName(s);const a=this.getPresetLevels(s,e),n={x:e.x||80,y:e.y||40,nShops:e.nShops||1,shopFunc:e.shop||[t=>t.value<=50+50*e.nLevels]};0===e.nShops&&(n.nShops=0),this.setLevelConstraints(n);for(let i=0;i<e.nLevels;i++){let c=this.getFromPresetLevels(i,a);if(c)if(c.stub){(c=new o.LevelFactory(this).create(c.new,c.args))||r.default.err("Factory","createCityQuarter","Stub found but cannot create level"),l.enabled&&this.debug("Creating level from stub "+JSON.stringify(c.stub))}else e.createPresetLevels&&e.create?this.addFixedFeatures(i,c,t):this.debug(`cityQuarter ${s} ${i} from preset level`);else if(this.id2levelSet){const t=e.levels[i];c=this.id2level[t]}else c=this.factZone.createCityLevel(i,n),this.addFixedFeatures(i,c,t);if(!this.id2levelSet&&c.hasExtras()){const e=c.getExtras();Array.isArray(e.shops)&&e.shops.forEach(e=>{t.addShop(e)})}t.addLevel(c)}return this.id2levelSet||t.connectLevels(),this._addEntranceToSubZone(t,e),e.hasOwnProperty("shops")&&e.shops.forEach(e=>{const s=new u.WorldShop;if(s.setLevel(this.id2level[e.level]),s.setCoord(e.coord),s._isAbandoned=e.isAbandoned,!e.isAbandoned){const t=this.id2entity[e.shopkeeper];if(t)s.setShopkeeper(t);else{const t=e.shopkeeper,s=`Possible IDs: ${Object.keys(this.id2entity)}`;r.default.err("Factory","createCityQuarter",`Cannot find shopkeeper ID ${t}. ${s}`)}}t.addShop(s)}),this.popScope(e),t},this.createBattleZone=(e=>{this.pushScope(e);const t=new u.BattleZone(e.name);this.id2levelSet||r.default.err("Factory","createBattleZone","Can create BattleZones only during restore");for(let s=0;s<e.nLevels;s++){const a=e.levels[s],n=this.id2level[a];n?t.addLevel(n):r.default.err("Factory","createBattleZone",`Cannot find level ID ${a} for BattleZone`)}return this.popScope(e),t}),this.getConnectionName=function(e,t,s){let a="";if("city"===t)a="town",e.groupType&&"fort"===e.groupType&&(a="cityfort");else if("mountain"===t)a="mountain";else if(Array.isArray(s)){a=!s[0].isDown()?"stairsDown":"stairsUp"}else{a=!s.isDown()?"stairsDown":"stairsUp"}return a},this.getTileStairsXY=((e,t)=>{let[s,a]=[t.levelX,t.levelY];if(r.default.isNullOrUndef([s,a])){const t=e.getEmptyRandCell();s=t.getX(),a=t.getY()}let n=e.getMap().getCell(s,a),o=r.default.WATCHDOG;for(;n.hasConnection();){const t=e.getEmptyRandCell();if(s=t.getX(),a=t.getY(),n=e.getMap().getCell(s,a),--o<=0)break}return[s,a]}),this.getEntryStairs=((e,t,s)=>{if(s.length>0){const a=t.getX(),n=t.getY();return e.getElements().indexOf(t)>=0&&(e.removeElement(t,a,n)||r.default.err("Factory.World","getEntryStairs","Cannot remove entryStairs")),s}return t}),this.processConnObject=((e,t,s)=>{const a=e.nLevel,n=e.levelX,o=e.levelY,i=e.name;this.debug(`Processing connection obj ${i}: ${n},${o}`);const l=t.findLevel(i,a);if(l){let a=e.stairs||null;if(a&&!r.default.isNullOrUndef([a.getStairs])){const e=a.getStairs;if(a=l.getStairs()[e])this.debug("conn found via getStairs connObject");else{let t=`zoneStairs null, index: ${e}`;t+=`\tPoss: ${JSON.stringify(l.getStairs())}`,r.default.err("Factory.World","processConnObject",t)}}if(a){if("function"!=typeof a.getSrcLevel){const e=JSON.stringify(a);r.default.err("Factory.World","processConnObject",`zoneStairs not a proper stairs object ${e}`)}}else a=this.createNewZoneConnects(t,l);let i="stairsDown";"city"===t.getType()?i="town":"mountain"===t.getType()&&(i="mountain");const c=new v(i,s,l);s.addStairs(c,n,o);try{c.connect(a)}catch(e){console.error(e);let t=`zoneLevel: ${JSON.stringify(l,null,1)}`;t+=`\n\tzoneStairs: ${JSON.stringify(a)}`,r.default.err("Factory.World","createAreaZoneConnection",t)}}else{let s=`connectToAreaXY: ${JSON.stringify(e)}`;s+=`zone: ${JSON.stringify(t)}`,r.default.err("Factory.World","createAreaZoneConnection",`No level found. ${s}`)}}),this.createNewZoneConnects=((e,t)=>{let s=null;return"dungeon"===e.getType()?s=this.createDungeonZoneConnect(e,t):"city"===e.getType()?s=this.createCityZoneConnect(e,t):"mountain"===e.getType()&&(this.debug("Creating new mountain south connection"),s=u.addExitsToEdge(t,"passage","south",!0)),s}),this.createDungeonZoneConnect=((e,t)=>{this.debug("Creating dungeon connection");let s=0,a=0;if(t.hasExtras()){const n=t.getExtras();if(n.startPoint)[s,a]=n.startPoint;else if(n.connectEdges)return this.createCityZoneConnect(e,t)}else{const e=t.getFreeRandCell();[s,a]=e.getXY()}const n=new v("stairsUp",t);return t.addStairs(n,s,a),n}),this.createCityZoneConnect=((e,t)=>{let s=null;this.debug("Creating new city edge connection");let a=[];if(r.default.CARDINAL_DIR.forEach(e=>{if(!u.edgeHasConnections(t,e)){const s=u.addExitsToEdge(t,"passage",e);s.length>0&&(a=a.concat(s))}}),0===(s=a).length){const e=t.getFreeRandCell(),a=e.getX(),n=e.getY();s=new v("stairsUp",t),t.addStairs(s,a,n),s=[s],this.debug("City edge connection failed. Added stairs")}return s}),this.debugPrintCityConns=((e,t)=>{if(l.enabled&&"city"===e){const e=t.getConnections();let s=JSON.stringify(e[0],null,1);e.length>1&&(s+=JSON.stringify(e[e.length-1],null,1)),this.debug(`First/last conn: ${s}`),this.debug(`conn length after: ${e.length}`)}}),this.addWorldID=function(e,t){r.default.isNullOrUndef([e.id])||t.setID(e.id),this.worldElemByID[t.getID()]=t},this.createQuests=function(e,t,s,a){(new E.QuestPopulate).createQuests(e,t,s,a)}},t.FactoryWorld.prototype.createAreaZoneConnection=function(e,t,s){this._verif.verifyConf("createAreaZoneConnection",s,["x","y"]),this.debug("Creating area-zone connections");const{x:a,y:n}=s,o=e.getTileXY(a,n).getLevel();T(s,o," CALL 1"),"function"!=typeof t.getEntrances&&r.default.err("Factory.World","createAreaZoneConnection","No getEntrances method for zone.");const i=t.getEntrances();if(i.length>0){let e=i[0];const a=e.getSrcLevel(),n=t.getType();this.debug("Connecting area-zone by entrance");let c=null;if(n.match(/(city|mountain)/)||s.connectEdges){l.enabled&&(c=a.getConnections(),this.debug(`conn length before: ${c.length}`));const s=this.createNewZoneConnects(t,a);e=this.getEntryStairs(a,e,s)}const h=this.getConnectionName(s,n,e);T(s,o," CALL 2");const u=new v(h,o,a),[d,g]=this.getTileStairsXY(o,s);try{o.addStairs(u,d,g),u.connect(e)}catch(e){throw r.default.log("Given conf: "+JSON.stringify(s)),e}this.debugPrintCityConns(n,a)}else if(!s.hasOwnProperty("connectToAreaXY")){const e=`No entrances in ${t.getHierName()}.`;r.default.err("Factory.World","createAreaZoneConnection",`${e}. Cannot connect to tile.`)}if(s.hasOwnProperty("connectToAreaXY")){s.connectToAreaXY.forEach(e=>{this.processConnObject(e,t,o)})}},t.FactoryWorld.prototype.debug=function(e){if(l.enabled){let t=this.getHierName();t||(t="EMPTY"),l(`|${t}| ${e}`)}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(6),i=s(4),l=n(s(2)),c=o.ObjectShell.getParser();function h(e){r.default.gameInfo(e)}t.SystemQuest=class extends i.SystemBase{static addQuestEvent(e,t,s,a={}){const n=new l.QuestTargetEvent;n.setArgs(a),n.setEventType(s),n.setTargetComp(t),e.add(n)}constructor(e,t){super(r.default.SYS.QUEST,e,t),this.compTypesAny=!0,this._eventTable={battle:this.onBattleEvent=this.onBattleEvent.bind(this),damage:this.onDamageEvent=this.onDamageEvent.bind(this),escort:this.onEscortEvent=this.onEscortEvent.bind(this),get:this.onGetEvent=this.onGetEvent.bind(this),give:this.onGiveEvent=this.onGiveEvent.bind(this),goto:this.onGotoEvent=this.onGotoEvent.bind(this),kill:this.onKillEvent=this.onKillEvent.bind(this),listen:this.onListenEvent=this.onListenEvent.bind(this),read:this.onReadEvent=this.onReadEvent.bind(this),report:this.onReportEvent=this.onReportEvent.bind(this)}}updateEntity(e){if(e.has("GiveQuest")){const t=e.get("GiveQuest");this.processGiveQuestComp(e,t),e.remove(t)}if(e.has("QuestCompleted")){const t=e.get("QuestCompleted");this.processComplComp(e,t),e.remove(t)}if(e.has("QuestTargetEvent")){const t=e.get("QuestTargetEvent");this.processQuestEvent(e,t),e.remove(t)}}processGiveQuestComp(e,t){const s=t.getGiver(),a=s.get("QuestGiver");if(a.getHasGivenQuest())return;const n=a.getQuestTargets(),o=new l.Quest;o.setQuestID(a.getQuestID()),0===n.length&&r.default.err("SystemQuest","processGiveQuestComp",`No keys in questData, giver: ${s.getName}`),n.forEach(e=>{const t=Object.assign({},e);t.isCompleted=!1,o.addTarget(t)}),a.giveQuest(e),o.setGiver({name:s.getName(),id:s.getID()}),o.setDescr(a.getDescr()),e.add(o),this.checkQuestMsgEmits(e,o)}checkQuestMsgEmits(e,t){const s=e.getLevel(),a=t.first("location");let n=`You accept the quest from ${t.getGiver().name}.`;a&&(s.getID()===a.id?(n+=" You are already in the first quest location",this.setTargetCompleted(a,t)):n+=" You should try to get to the first quest location"),h({cell:e.getCell(),msg:n})}processComplComp(e,t){const s=t.getGiver(),a=s.get("QuestGiver").getQuestID();if(e.getList("Quest").find(e=>e.getQuestID()===a).isCompleted()){const t=s.get("QuestGiver"),a=t.getQuestTargets().length,n=t.getDanger()*a,r=new l.ExpPoints(n);e.add(r),this.giveQuestReward(e,t)}else r.default.gameDanger({cell:e.getCell(),msg:"Quest is not completed!"})}giveQuestReward(e,t){if(t.hasReward())if(t.getHasGivenReward()){const t="Reward has already been given!";h({cell:e.getCell(),msg:t})}else{t.setHasGivenReward(!0);const s=t.getReward();if("item"===s.type){const t=s.name,a=c.createItem(t);if(a){let t=`${e.getName()} receives ${a.getName()} as`;t+=" a reward for completing the quest",h({cell:e.getCell(),msg:t}),e.getInvEq().getInventory().addItem(a)}}}}processQuestEvent(e,t){const s=t.getEventType(),a=e.getList("Quest");if("function"==typeof this._eventTable[s])a.forEach(a=>{(function(e,t){const s=e.getTargetComp();return t.isInThisQuest(s)})(t,a)&&this._eventTable[s](e,t,a)});else{const e=Object.keys(this._eventTable);r.default.err("SystemQuest","processQuestEvent",`No function for ${s} in eventTable. Found: ${e}`)}}onBattleEvent(e,t,s){const a=t.getArgs(),n=t.getTargetComp(),r=n.getTarget(),o=n.getTargetType(),i=function(e,t){return e.getQuestTargets().find(e=>e.id===t.getID())}(s,r);if("winbattle"===o){if(a.isWon){this.setTargetCompleted(i,s);let t=`${e.getName()} has won a battle as `;t+="as a quest objective!",h({cell:e.getCell(),msg:t})}}else if("finishbattle"===o){this.setTargetCompleted(i,s);let t=`${e.getName()} has finished a battle as `;t+="as a quest objective!",h({cell:e.getCell(),msg:t})}}onDamageEvent(e,t,s){const a=t.getTargetComp().getTarget(),n=s.getQuestTargets().find(e=>e.id===a.getID());this.setTargetCompleted(n,s);let r=`${e.getName()} has finished a quest objective `;r+=`to damage ${a.getDamage()}`,h({cell:e.getCell(),msg:r})}onEscortEvent(e,t,s){const a=t.getTargetComp().getTarget(),n=s.getQuestTargets().find(e=>e.id===a.getID());this.setTargetCompleted(n,s);let r="";const o=e.getLevel().getParentZone();o&&(r=" to "+o.getName());let i=`${e.getName()} has escorted ${a.getName()} `;i+=`safely back${r} as a quest objective!`,h({cell:e.getCell(),msg:i})}onGetEvent(e,t,s){const a=t.getTargetComp().getTarget(),n=s.getQuestTargets().find(e=>e.id===a.getID());this.setTargetCompleted(n,s);let r=`${e.getName()} has found ${a.getName()} `;r+="as a quest objective!",h({cell:e.getCell(),msg:r})}onGiveEvent(e,t,s){console.log("processing onGiveEvent");const a=t.getArgs(),{actor:n,item:r}=a,o=s.getQuestTargets().find(e=>e.id===n.getID());this.setTargetCompleted(o,s);let i=`${e.getName()} has given ${r.getName()} `;i+=`to ${n.getName()} as quest objective!`,h({cell:e.getCell(),msg:i})}onGotoEvent(e,t,s){const a=t.getTargetComp().getTarget(),n=s.getQuestTargets().find(e=>e.id===a.getID());this.setTargetCompleted(n,s);const r=`${e.getName()} has arrived to a quest target location!`;h({cell:e.getCell(),msg:r})}onKillEvent(e,t,s){const a=t.getArgs();if(a&&a.corpse){const n=t.getTargetComp().getTarget();this.moveQuestTargetComp(n,a.corpse);const r=s.getQuestTargets().find(e=>e.id===n.getID());this.setTargetCompleted(r,s);let o=`${e.getName()} has reached quest target of killing`;o+=` ${n.getName()}.`,h({cell:e.getCell(),msg:o})}else r.default.err("SystemQuest","onKillEvent",`Args must contain |corpse|. Got: ${JSON.stringify(a)}`)}onListenEvent(e,t,s){const a=t.getArgs();if(a&&a.info){const t=a.info.getInfo(),n=a.src;e.add(a.info.clone());const r=n.getID(),o=s.getQuestTargets().find(e=>e.id===r);this.setTargetCompleted(o,s),h({msg:`${n.getName()} tells about ${t}`,cell:e.getCell()})}else r.default.err("SystemQuest","onListenEvent",`Args must contain |info|. Got: ${JSON.stringify(a)}`)}onReadEvent(e,t,s){const a=t.getTargetComp().getTarget(),n=s.getQuestTargets(),r=n.find(e=>e.id===a.getID());this.setTargetCompleted(r,s);const o=a.getMetaData("place");if(o){const t=o[0];if(t.levelID===e.getLevel().getID()){const e=n.find(e=>e.id===t.levelID&&!e.isCompleted);this.setTargetCompleted(e,s)}else{let s=`${e.getName()} learns to travel to `;s+=`${t.placeName} as part of the quest.`,h({cell:e.getCell(),msg:s})}}}onReportEvent(e,t,s){const a=s.getQuestTargets(),n=t.getTargetComp(),r=n.getTarget(),o=r.getName();let i=!1;if(r.has("QuestReport")){const l=r.get("QuestReport"),c=t.getArgs().info;if(c)if(l.getExpectInfoFrom()===c.getGivenBy())i=!0;else{const t=`${o} is not interested in this info`;h({cell:e.getCell(),msg:t})}else s.isTargetInQuest(n)&&(i=a.filter(e=>e.id!==r.getID()).reduce((e,t)=>e&&t.isCompleted,!0))}if(i){const t=a.find(e=>e.id===r.getID()),n=`${e.getName()} reports info to ${o}`;h({cell:e.getCell(),msg:n}),this.setTargetCompleted(t,s)}}moveQuestTargetComp(e,t){try{const s=e.get("QuestTarget");s.changeEntity(t),s.setIsCompleted(!0),s.setTarget(t)}catch(t){console.log("srcEnt is",e),console.log(t.message)}}setTargetCompleted(e,t){const s=t.getEntity();if(!1===e.isCompleted)e.isCompleted=!0;else{let s="targetObj: "+JSON.stringify(e);s+="targetQuest: "+JSON.stringify(t),r.default.err("SystemQuest","setTargetCompleted","Tried to set completed quest to completed again: "+s)}if(t.isCompleted()){let e=`${s.getName()} has completed a quest!`;e+=" now it is time to go collect the reward.",h({cell:s.getCell(),msg:e}),this.checkSubQuestCompletion(s,t)}}checkSubQuestCompletion(e,t){const s=t.getQuestID();e.getList("Quest").forEach(e=>{e.getTargetsByType("subquest").forEach(e=>{e.subQuestID===s&&(e.isCompleted=!0)})})}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=a(s(12));t.Keys={},t.Keys.VK_a=r.default.VK_A+32,t.Keys.VK_b=r.default.VK_B+32,t.Keys.VK_c=r.default.VK_C+32,t.Keys.VK_d=r.default.VK_D+32,t.Keys.VK_e=r.default.VK_E+32,t.Keys.VK_f=r.default.VK_F+32,t.Keys.VK_g=r.default.VK_G+32,t.Keys.VK_h=r.default.VK_H+32,t.Keys.VK_i=r.default.VK_I+32,t.Keys.VK_j=r.default.VK_J+32,t.Keys.VK_k=r.default.VK_K+32,t.Keys.VK_l=r.default.VK_L+32,t.Keys.VK_m=r.default.VK_M+32,t.Keys.VK_n=r.default.VK_N+32,t.Keys.VK_o=r.default.VK_O+32,t.Keys.VK_p=r.default.VK_P+32,t.Keys.VK_q=r.default.VK_Q+32,t.Keys.VK_r=r.default.VK_R+32,t.Keys.VK_s=r.default.VK_S+32,t.Keys.VK_t=r.default.VK_T+32,t.Keys.VK_u=r.default.VK_U+32,t.Keys.VK_v=r.default.VK_V+32,t.Keys.VK_w=r.default.VK_W+32,t.Keys.VK_x=r.default.VK_X+32,t.Keys.VK_y=r.default.VK_Y+32,t.Keys.VK_z=r.default.VK_Z+32,t.Keys.VK_COMMA=44,t.Keys.VK_PERIOD=46,t.Keys.VK_LT=60,t.Keys.VK_GT=62,t.Keys.KeyMap={moveKeyMap:{},initMap(){this.moveKeyMap[t.Keys.KEY.MOVE_N]=0,this.moveKeyMap[t.Keys.KEY.MOVE_NE]=1,this.moveKeyMap[t.Keys.KEY.MOVE_E]=2,this.moveKeyMap[t.Keys.KEY.MOVE_SE]=3,this.moveKeyMap[t.Keys.KEY.MOVE_S]=4,this.moveKeyMap[t.Keys.KEY.MOVE_SW]=5,this.moveKeyMap[t.Keys.KEY.MOVE_W]=6,this.moveKeyMap[t.Keys.KEY.MOVE_NW]=7,this.moveKeyMap[r.default.VK_8]=0,this.moveKeyMap[r.default.VK_9]=1,this.moveKeyMap[r.default.VK_6]=2,this.moveKeyMap[r.default.VK_3]=3,this.moveKeyMap[r.default.VK_2]=4,this.moveKeyMap[r.default.VK_1]=5,this.moveKeyMap[r.default.VK_4]=6,this.moveKeyMap[r.default.VK_7]=7},inMoveCodeMap(e){return this.moveKeyMap.hasOwnProperty(e)},isRest:e=>e===t.Keys.VK_s||e===t.Keys.VK_PERIOD,isPickup:e=>e===t.Keys.KEY.PICKUP,isUseStairs:e=>e===t.Keys.KEY.USE_STAIRS_DOWN||e===t.Keys.KEY.USE_STAIRS_UP,isChat:e=>e===t.Keys.KEY.CHAT,isConfirmYes:e=>e===t.Keys.KEY.YES,isFightMode:e=>e===t.Keys.KEY.FIGHT,isGive:e=>e===t.Keys.KEY.GIVE,isGoto:e=>e===t.Keys.KEY.GOTO,isJump:e=>e===t.Keys.KEY.JUMP,isIssueOrder:e=>e===t.Keys.KEY.ORDER,isLook:e=>e===t.Keys.KEY.LOOK,isMark:e=>e===t.Keys.KEY.MARK,isNextItem:e=>e===t.Keys.KEY.NEXT_ITEM,isNextTarget:e=>e===t.Keys.KEY.NEXT,isPrevTarget:e=>e===t.Keys.KEY.PREV,isRead:e=>e===t.Keys.KEY.READ,isRunMode:e=>e===t.Keys.KEY.RUN,isSelect:e=>e===t.Keys.KEY.SELECT,isSelectAll:e=>e===t.Keys.KEY.SELECT_ALL,isTargetMode:e=>e===t.Keys.KEY.TARGET,isToggleDoor:e=>e===t.Keys.KEY.DOOR,isUsePower:e=>e===t.Keys.KEY.POWER,isUseAbility:e=>e===t.Keys.KEY.ABILITY,isMultiPurpose:e=>e===t.Keys.KEY.MULTI,getDiff(e,s,a){if(this.moveKeyMap.hasOwnProperty(e)){const t=r.default.DIRS[8][this.moveKeyMap[e]];return[s+t[0],a+t[1]]}return e===t.Keys.VK_s?[s,a]:null},getDir(e){return this.moveKeyMap.hasOwnProperty(e)?r.default.DIRS[8][this.moveKeyMap[e]]:this.isRest(e)?[0,0]:null},dirToKeyCode(e,s){let a=e,r=s;switch(Array.isArray(e)&&(a=e[0],r=e[1]),0!==a&&(a/=Math.abs(a)),0!==r&&(r/=Math.abs(r)),a){case-1:switch(r){case-1:return t.Keys.KEY.MOVE_NW;case 0:return t.Keys.KEY.MOVE_W;case 1:return t.Keys.KEY.MOVE_SW;default:n.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${a},${r} not supported`)}break;case 0:switch(r){case-1:return t.Keys.KEY.MOVE_N;case 0:return t.Keys.KEY.REST;case 1:return t.Keys.KEY.MOVE_S;default:n.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${a},${r} not supported`)}break;case 1:switch(r){case-1:return t.Keys.KEY.MOVE_NE;case 0:return t.Keys.KEY.MOVE_E;case 1:return t.Keys.KEY.MOVE_SE;default:n.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${a},${r} not supported`)}break;default:n.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${a},${r} not supported`)}return null},keyCodeToCardinalDir(e){switch(e){case t.Keys.KEY.MOVE_NW:return"NW";case t.Keys.KEY.MOVE_W:return"W";case t.Keys.KEY.MOVE_SW:return"SW";case t.Keys.KEY.MOVE_N:return"N";case t.Keys.KEY.REST:return"REST";case t.Keys.KEY.MOVE_S:return"S";case t.Keys.KEY.MOVE_NE:return"NE";case t.Keys.KEY.MOVE_E:return"E";case t.Keys.KEY.MOVE_SE:return"SE";default:return""}}},t.Keys.menuIndices=[0,1,2,3,4,5,6,7,8,9,"a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],t.Keys.EXIT_INDEX=t.Keys.menuIndices.indexOf("Q"),t.Keys.codeToMenuChar=(e=>{const s=t.Keys.codeToIndex(e);return t.Keys.menuIndices[s]});const o=/[a-z]/,i=/[A-Z]/;t.Keys.selectIndexToCode=(e=>{const s=t.Keys.menuIndices.findIndex(t=>t===e);if(s>=0){if(s>=0&&s<=9)return r.default.VK_0+s;if(o.test(e)){const e=s-t.Keys.menuIndices.indexOf("a");return t.Keys.VK_a+e}if(i.test(e)){const e=s-t.Keys.menuIndices.indexOf("A");return r.default.VK_A+e}}return n.default.err("RG","selectIndexToCode",`Inv. select index |${e}|`),-1}),t.Keys.codeToIndex=(e=>e>=r.default.VK_0&&e<=r.default.VK_9?e-r.default.VK_0:e>=t.Keys.VK_a&&e<=t.Keys.VK_z?e-t.Keys.VK_a+t.Keys.menuIndices.indexOf("a"):e>=r.default.VK_A&&e<=r.default.VK_Z?e-r.default.VK_A+t.Keys.menuIndices.indexOf("A"):-1),t.Keys.isNumeric=(e=>e>=r.default.VK_0&&e<=r.default.VK_9),t.Keys.KEY={},t.Keys.KEY.MOVE_N=r.default.VK_W+32,t.Keys.KEY.MOVE_NE=r.default.VK_E+32,t.Keys.KEY.MOVE_E=r.default.VK_D+32,t.Keys.KEY.MOVE_SE=r.default.VK_C+32,t.Keys.KEY.MOVE_S=r.default.VK_X+32,t.Keys.KEY.MOVE_SW=r.default.VK_Z+32,t.Keys.KEY.MOVE_W=r.default.VK_A+32,t.Keys.KEY.MOVE_NW=r.default.VK_Q+32,t.Keys.KEY.ABILITY=t.Keys.VK_k,t.Keys.KEY.CHAT=r.default.VK_C,t.Keys.KEY.DELETE=r.default.VK_D,t.Keys.KEY.DOOR=r.default.VK_O+32,t.Keys.KEY.FIGHT=r.default.VK_F+32,t.Keys.KEY.GIVE=r.default.VK_G,t.Keys.KEY.GOTO=t.Keys.VK_g,t.Keys.KEY.JUMP=t.Keys.VK_j,t.Keys.KEY.LOOK=r.default.VK_L+32,t.Keys.KEY.MARK=t.Keys.VK_b,t.Keys.KEY.MULTI=r.default.VK_SPACE,t.Keys.KEY.NEXT=t.Keys.VK_n,t.Keys.KEY.NEXT_ITEM=r.default.VK_H+32,t.Keys.KEY.ORDER=r.default.VK_O,t.Keys.KEY.PICKUP=t.Keys.VK_COMMA,t.Keys.KEY.POWER=r.default.VK_P+32,t.Keys.KEY.PREV=r.default.VK_P+32,t.Keys.KEY.QUIT_MENU=t.Keys.VK_q,t.Keys.KEY.READ=r.default.VK_R,t.Keys.KEY.REST=r.default.VK_S+32,t.Keys.KEY.RUN=r.default.VK_R+32,t.Keys.KEY.SELECT=t.Keys.VK_s,t.Keys.KEY.SELECT_ALL=r.default.VK_A,t.Keys.KEY.TARGET=t.Keys.VK_t,t.Keys.KEY.USE_ABILITY=t.Keys.VK_k,t.Keys.KEY.USE_STAIRS_DOWN=t.Keys.VK_GT,t.Keys.KEY.USE_STAIRS_UP=t.Keys.VK_LT,t.Keys.KEY.YES=r.default.VK_Y+32,t.Keys.KeyMap.initMap(),t.Keys.KEY.NO_ACTION=r.default.VK_CAPS_LOCK,t.Keys.GUI={},t.Keys.GUI.CharInfo=r.default.VK_I,t.Keys.GUI.Goto=t.Keys.KEY.GOTO,t.Keys.GUI.Help=r.default.VK_H,t.Keys.GUI.Inv=t.Keys.VK_i,t.Keys.GUI.Look=t.Keys.VK_l,t.Keys.GUI.Map=t.Keys.VK_m,t.Keys.GUI.OwMap=r.default.VK_M,t.Keys.GUI.Use=t.Keys.VK_u,t.Keys.isValidKey=(e=>{let s=!1;return Object.keys(t.Keys.KEY).forEach(a=>{s=s||t.Keys.KEY[a]===e}),s=s||t.Keys.KeyMap.inMoveCodeMap(e)}),t.Keys.getChar=(e=>"`"+String.fromCharCode(e)+"`")},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=null;t.BrainBase=class{constructor(e){n.default.isNullOrUndef([e])&&n.default.err("BrainSentient","constructor","Actor must not be null."),this._actor=e,this._type=null}setActor(e){this._actor=e}getActor(){return this._actor}getType(){return this._type}setType(e){this._type=e}getMemory(){return r}getSeenCells(){return[]}findEnemyCell(e){return null}findFriendCell(e){return null}canMeleeAttack(e,t){return!1}canSeeActor(e){return!1}getSeenFriends(){return[]}getSeenEnemies(){return[]}decideNextAction(e){return n.default.err("BrainBase","decideNextAction","Not implemented. Do in derived class"),null}toJSON(){return{type:this._type}}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(8)).default("bitn:Goal"),o=a(s(0)),i=n(s(2)),l=s(10),c=s(15),h=s(1).Random.getRNG();var u;t.Goal={},t.Goal.ACTOR_FILTER="",t.Goal.StatusStrings={1:"GOAL_ACTIVE",2:"GOAL_COMPLETED",3:"GOAL_INACTIVE",4:"GOAL_FAILED"},function(e){e[e.NORMAL=1]="NORMAL",e[e.MOVE=2]="MOVE",e[e.KILL=3]="KILL",e[e.FIND=4]="FIND",e[e.AGGRESSION=5]="AGGRESSION"}(u=t.GoalType||(t.GoalType={})),t.Goal.Types=u;const d=null;var g;!function(e){e[e.GOAL_ACTIVE=1]="GOAL_ACTIVE",e[e.GOAL_COMPLETED=2]="GOAL_COMPLETED",e[e.GOAL_INACTIVE=3]="GOAL_INACTIVE",e[e.GOAL_FAILED=4]="GOAL_FAILED"}(g=t.GoalStatus||(t.GoalStatus={}));let p=0;class m{constructor(e){this.subGoals=d,this.actor=e,this.status=g.GOAL_INACTIVE,this.type="",this.category=u.NORMAL,this.planBGoal=null}dbg(e){if(r.enabled){let s=!1;if(t.Goal.ACTOR_FILTER||(s=!0),!s){s=new RegExp(t.Goal.ACTOR_FILTER).test(this.actor.getName())}if(s){const s="  ".repeat(p),a=this.actor.getName(),n=function(e){return t.Goal.StatusString[e]}(this.status),r=`[${this.getType()}] ${n}`;console.log(`${s}${r} ${a} ${e}`)}}}setCategory(e){this.category=e}getCategory(){return this.category}setType(e){this.type=e}getType(){return this.type}hasPlanB(){return null!==this.planBGoal}getPlanB(){return this.planBGoal}activate(){throw new Error("Pure virtual method")}activateIfInactive(){this.isInactive()&&(this.dbg("Activating inactive"),this.activate())}reactivateIfFailed(){this.hasFailed()&&(this.dbg("Re-Activating failed"),this.status=g.GOAL_INACTIVE)}process(){if(Array.isArray(this.subGoals)){return this.subGoals[0].process()}return this.status}terminate(){this.dbg("Goal terminated!"),this.status=g.GOAL_COMPLETED}handleMsg(e){Array.isArray(this.subGoals)&&this.subGoals[this.subGoals.length-1].handleMsg(e)}processSubGoals(){++p;let e=g.GOAL_FAILED;if(this.dbg("Start processSubGoals()"),!Array.isArray(this.subGoals)){const e=this.actor.getName(),t=`Type: ${this.type}, actor: ${e}`;throw new Error(`${t} No subgoals in atomic goal`)}if(this.removeFinishedOrFailed(),this.subGoals.length>0){const t=this.subGoals[0];(e=t.process())===g.GOAL_COMPLETED&&this.subGoals.length>1?e=g.GOAL_ACTIVE:e===g.GOAL_FAILED&&t.hasPlanB()&&(this.subGoals[0]=t.getPlanB(),this.subGoals[0].setType(t.getType()),e=g.GOAL_ACTIVE)}else e=g.GOAL_COMPLETED;return--p,this.dbg(`End processSubGoals() with status ${e}`),r.enabled&&this.dbg(`  subGoals left: ${this.subGoals.map(e=>e.getType())}`),e}removeFinishedOrFailed(){this.subGoals=this.subGoals.filter(e=>!e.isCompleted()&&!e.hasFailed())}removeAllSubGoals(){Array.isArray(this.subGoals)&&(this.subGoals.forEach(e=>{e.terminate()}),this.subGoals=[]),this.dbg("Removed all subGoals")}removeSubGoalsOfType(e){let t=0;if(Array.isArray(this.subGoals)){let s=this.subGoals.findIndex(t=>t.type===e);for(;s>=0;)this.subGoals[s].terminate(),this.subGoals.splice(s,1),++t,s=this.subGoals.findIndex(t=>t.type===e)}return t}getSubGoals(){return this.subGoals}hasSubGoals(e){if(Array.isArray(this.subGoals)){if(e){return this.subGoals.findIndex(t=>t.type===e)>=0}return this.subGoals.length>0}return!1}addSubGoal(e){if(Array.isArray(this.subGoals)||(this.subGoals=[]),this.subGoals.unshift(e),r.enabled){this.dbg(`Added subGoal ${e.getType()}`);const t=this.subGoals.map(e=>e.getType());this.dbg(`   Subgoals are now: ${t}`)}}isInactive(){return this.status===g.GOAL_INACTIVE}isActive(){return this.status===g.GOAL_ACTIVE}hasFailed(){return this.status===g.GOAL_FAILED}isCompleted(){return this.status===g.GOAL_COMPLETED}isGoalPresent(e){if(Array.isArray(this.subGoals)){const t=this.subGoals.find(t=>t.getType()===e);if(t&&!t.hasFailed()&&!t.isCompleted())return r.enabled&&(this.dbg(`subGoal ${e} already present.`),this.dbg(`  SubGoal status: ${t.status}`)),!0}return!1}}t.GoalBase=m,t.Goal.Base=m;class f extends m{constructor(e,t){super(e),this.setType("GoalFollowPath"),this.path=[],this.xy=t}activate(){const[e,t]=this.xy,[s,a]=[this.actor.getX(),this.actor.getY()];this.dbg(`Calc path ${s},${a} -> ${e},${t}`);const n=this.actor.getLevel().getMap(),r=c.Path.getShortestActorPath(n,s,a,e,t);this.path=r,this.status=g.GOAL_ACTIVE,this.dbg(`activate() path length: ${this.path.length}`)}process(){return this.activateIfInactive(),this.path.length>0?this.followPath():(this.dbg("process() ret GoalStatus.GOAL_COMPLETED"),this.status=g.GOAL_COMPLETED,g.GOAL_COMPLETED)}followPath(){const e=this.actor.getLevel(),[t,s]=this.actor.getXY(),{x:a,y:n}=this.path[0],[r,o]=[a,n],l=this.path.length;if(this.dbg(`followPath() test move ${t},${s} -> ${a},${n}, path ${l} `),e.getMap().isPassable(r,o)){const c=Math.abs(t-a),h=Math.abs(s-n);if(c<=1&&h<=1){const t=new i.Movement(r,o,e);return this.actor.add(t),this.path.shift(),0===this.path.length?(this.dbg(`followPath() ret GOAL_COMPL, path ${l}`),this.status=g.GOAL_COMPLETED,g.GOAL_COMPLETED):(this.dbg(`followPath() ret GoalStatus.GOAL_ACTIVE, path ${l}`),this.status=g.GOAL_ACTIVE,g.GOAL_ACTIVE)}return this.dbg(`followPath() strayed, ret GoalStatus.GOAL_FAILED, path ${l}`),this.status=g.GOAL_FAILED,g.GOAL_FAILED}return this.dbg("followPathl() next NOT passable ret GoalStatus.GOAL_FAILED"),this.status=g.GOAL_FAILED,g.GOAL_FAILED}}t.GoalFollowPath=f,t.Goal.FollowPath=f;class y extends m{constructor(e,t){super(e),this.setType("GoalMoveUntilEnemy"),this.dir=t}activate(){this.timeout=100,this.status=g.GOAL_ACTIVE}process(){this.activateIfInactive();const e=this.actor.getBrain(),t=e.getSeenCells(),s=e.findEnemyCell(t),[a,n]=function(e,t){const[s,a]=e.getXY();return[s+t[0],a+t[1]]}(this.actor,this.dir),o=this.actor.getLevel().getMap();if(s){const[e,t]=[s.getX(),s.getY()];r.enabled&&this.dbg(`Has moved enough. Enemy found @${e},${t}`),this.status=g.GOAL_COMPLETED}else if(o.hasObstacle(a,n))this.status=g.GOAL_FAILED,r.enabled&&this.dbg("OBSTACLE ENCOUNTERED");else if(0===this.timeout)this.status=g.GOAL_FAILED,r.enabled&&this.dbg("TIMEOUT REACHED");else if(o.isPassable(a,n)){const e=this.actor.getLevel(),t=new i.Movement(a,n,e);this.actor.add(t);const s=this.actor.getName();r.enabled&&this.dbg(`Moving ${s} to ${a},${n}`)}return--this.timeout,this.status}}t.GoalMoveUntilEnemy=y,t.Goal.MoveUntilEnemy=y;class _ extends f{constructor(e,t){super(e,[0,0]),this.setType("GoalGotoActor"),this.xy=t.getXY(),this.targetActor=t,this.pathFunc=c.Path.getActorToActorPath}activate(){const e=this.getPath();this.dbg(`activate() path length: ${e.length}`),this.path=e,this.status=g.GOAL_ACTIVE,this.dbg(`activate() path length: ${this.path.length}`)}getPath(){const e=this.actor.getLevel().getMap(),[t,s]=this.xy,[a,n]=[this.actor.getX(),this.actor.getY()];return this.dbg(`${this.getType()} ${a},${n} -> ${t},${s}`),c.Path.getActorToActorPath(e,a,n,t,s)}process(){this.activateIfInactive();const[e,t]=[this.targetActor.getX(),this.targetActor.getY()],[s,a]=this.xy,n=Math.abs(e-s),r=Math.abs(t-a);return n>2||r>2?(this.followPath(),this.status=g.GOAL_FAILED,g.GOAL_FAILED):this.path.length>0?this.followPath():(this.dbg("process() ret GoalStatus.GOAL_COMPLETED"),this.status=g.GOAL_COMPLETED,g.GOAL_COMPLETED)}}t.GoalGotoActor=_,t.Goal.GotoActor=_;class E extends _{constructor(e,t){super(e,t),this.setType("GoalGotoSeenActor")}getPath(){const e=this.actor.getLevel().getMap(),[t,s]=this.xy;return c.Path.getShortestSeenPath(this.actor,e,t,s)}}t.GoalGotoSeenActor=E,t.Goal.GotoSeenActor=E;class S extends m{constructor(e,t,s=1){super(e),this.setType("GoalGuard"),this.dist=s,this.x=t[0],this.y=t[1],this.subGoals=[]}activate(){this.checkDistToGuardPoint()}process(){if(this.activateIfInactive(),this.status=this.processSubGoals(),this.subGoals.length>0){this.subGoals[0].hasFailed()&&this.checkDistToGuardPoint()}else this.checkDistToGuardPoint();return this.status}checkDistToGuardPoint(){const[e,t]=o.default.dXdYAbs([this.x,this.y],this.actor.getXY());(e>this.dist||t>this.dist)&&this.addSubGoal(new f(this.actor,[this.x,this.y]))}}t.GoalGuard=S,t.Goal.Guard=S;class v extends m{constructor(e,t){super(e),this.setType("GoalPatrol"),this.coords=t,this.coords.length<2&&o.default.err("GoalPatrol","constructor",`Provide >= 2 coords for patrolling. Got ${t}`),this.currIndex=0,this.currTarget=t[this.currIndex],this.patrolDist=3}activate(){this.dbg(`${this.getType()} activate()`),this.recomputePatrolPath()}process(){this.activateIfInactive(),this.status=this.processSubGoals(),this.dbg(`GoalPatrol process(), got subStatus: ${this.status}`);const e=this.subGoals[0];if(e.isCompleted())this.nextPatrolPoint();else if(e.hasFailed()){this.dbg(`${this.getType()} process() path failed`);const[e,t]=this.actor.getXY(),[s,a]=this.currTarget;c.Path.shortestDist(e,t,s,a)<=this.patrolDist?this.nextPatrolPoint():this.recomputePatrolPath()}else this.dbg(`${this.getType()} XXX NOT HERE!`);return this.status}nextPatrolPoint(){++this.currIndex,this.currIndex>=this.coords.length&&(this.currIndex=0),this.currTarget=this.coords[this.currIndex],this.addSubGoal(new f(this.actor,this.currTarget)),this.dbg(`${this.getType()} next patrol point ${this.currTarget}`),this.status=g.GOAL_ACTIVE}recomputePatrolPath(){this.addSubGoal(new f(this.actor,this.currTarget)),this.dbg(`${this.getType()} recompute to point ${this.currTarget}`),this.status=g.GOAL_ACTIVE}}t.GoalPatrol=v,t.Goal.Patrol=v;class C extends m{constructor(e,t){super(e),this.setType("GoalAttackActor"),this.targetActor=t}activate(){this.dbg("activate() called"),this.selectSubGoal(),this.isCompleted()||(this.status=g.GOAL_ACTIVE)}process(){this.activateIfInactive();const e=this.actor.getBrain(),t=e.getSeenCells(),s=e.findEnemyCell(t);if(s){const t=s.getActors()[0];if(this.targetActor.getID()!==t.getID()){if(this.print){const e=this.actor.getName(),s=this.targetActor.getName(),a=t.getName();o.default.log(`${e}:: Recomp target ${s} -> ${a}`)}this.targetActor=t,e.getMemory().setLastAttacked(t),this.selectSubGoal()}}else this.checkTargetStatus();return this.isCompleted()||this.hasFailed()||(this.status=this.processSubGoals()),this.status}terminate(){this.dbg("Terminating completed attack actor task"),this.status=g.GOAL_COMPLETED}canMissileAttack(){const[e,t]=this.targetActor.getXY(),[s,a]=this.actor.getXY(),n=this.actor.getInvEq().getEquipment().getItem("missile");if(n){const r=o.default.getMissileRange(this.actor,n);if(c.Path.shortestDist(e,t,s,a)<=r)return!0}return!1}selectSubGoal(){const e=this.actor.getBrain();if(this.checkTargetStatus(),!this.isCompleted()){const[t,s]=this.targetActor.getXY();if(e.canMeleeAttack(t,s)){this.removeAllSubGoals(),this.dbg("canMeleeAttack() OK");const e=new b(this.actor,this.targetActor);this.addSubGoal(e)}else if(this.canMissileAttack()){this.removeAllSubGoals(),this.dbg("canMissileAttack() OK");const e=new T(this.actor,this.targetActor);this.addSubGoal(e)}else if(e.canSeeActor(this.targetActor)){this.removeAllSubGoals(),this.dbg("canSeeActor subGoal GoalGotoActor");const e=new E(this.actor,this.targetActor);this.addSubGoal(e)}else{this.removeAllSubGoals(),this.dbg("Moving blind subGoal GoalGotoActor");const e=new _(this.actor,this.targetActor);this.addSubGoal(e)}}}checkTargetStatus(){const e=this.targetActor.get("Health");if(!e){const e=JSON.stringify(this.targetActor),t=JSON.stringify(this.actor);o.default.log("Attacker: "+t),o.default.err("GoalAttackActor","checkTargetStatus","target has no health: "+e)}e.isDead()?(this.removeAllSubGoals(),this.status=g.GOAL_COMPLETED,this.dbg("Enemy is dead. Goal completed")):o.default.inSameLevel(this.actor,this.targetActor)||(this.removeAllSubGoals(),this.status=g.GOAL_COMPLETED,this.dbg("Enemy not in this level. Goal completed"))}}t.GoalAttackActor=C,t.Goal.AttackActor=C;class b extends m{constructor(e,t){super(e),this.setType("GoalHitActor"),this.targetActor=t}activate(){const e=this.actor.getLevel(),[t,s]=this.targetActor.getXY(),a=e.getMap().getCell(t,s).getProp("actors")[0],n=new i.Attack({target:a});this.actor.add(n),this.dbg(`${this.getType()} added Attack comp`),this.status=g.GOAL_ACTIVE}process(){return this.activateIfInactive(),this.status=g.GOAL_COMPLETED,this.status}}t.GoalHitActor=b;class T extends m{constructor(e,t){super(e),this.setType("GoalShootActor"),this.targetActor=t}activate(){const e=this.actor.getInvEq().unequipAndGetItem("missile",1,0);if(!e)return;const[t,s]=this.targetActor.getXY(),a=new i.Missile(this.actor);a.setTargetXY(t,s),a.setDamage(o.default.getMissileDamage(this.actor,e)),a.setAttack(o.default.getMissileAttack(this.actor,e)),a.setRange(o.default.getMissileRange(this.actor,e)),e.add(a),this.dbg(`${this.getType()} added Missile comp`),this.status=g.GOAL_ACTIVE}process(){return this.activateIfInactive(),this.status=g.GOAL_COMPLETED,this.status}}t.GoalShootActor=T;class A extends m{constructor(e,t=-1){super(e),this.setType("GoalExplore"),this.dur=t}activate(){this.setNewPassableDir(),this.dbg(`activate Explore dX,dY: ${this.dX},${this.dY}`),this.status=g.GOAL_ACTIVE}setCallback(e){this.exploreCb=e}setNewPassableDir(){let e=5,[t,s]=h.getRandDir();for(;e>0&&!this.isDirPassable(t,s);)[t,s]=h.getRandDir(),--e;this.dX=t,this.dY=s}isDirPassable(e,t){const[s,a]=this.actor.getXY(),n=s+e,r=a+t;return this.actor.getLevel().getMap().isPassable(n,r)}shouldMoveTo(e,t,s){const a=e.getCell(t,s);return!!a.isPassable()&&!a.isDangerous()}process(){this.activateIfInactive(),this.checkChangeDir(),--this.dur;const[e,t]=this.actor.getXY(),s=e+this.dX,a=t+this.dY,n=this.actor.getLevel(),r=n.getMap();if(r.hasXY(s,a))if(this.shouldMoveTo(r,s,a)){const e=new i.Movement(s,a,n);this.actor.add(e)}else this.canOpenDoorAt(r,s,a)||this.setNewPassableDir();else this.setNewPassableDir();return 0===this.dur&&(this.status=g.GOAL_COMPLETED),this.exploreCb&&this.exploreCb(s,a),this.status}canOpenDoorAt(e,t,s){const a=e.getCell(t,s);if(a.hasDoor()){const e=a.getPropType("door")[0];if(e.canToggle()){const t=new i.OpenDoor;return t.setDoor(e),this.actor.add(t),!0}}return!1}checkChangeDir(){const e=h.getUniform();if(e<=.07){const e=this.changeDir(this.dX);this.isDirPassable(e,this.dY)&&(0===e&&0===this.dY||(this.dX=e))}else if(e<=.14){const e=this.changeDir(this.dY);this.isDirPassable(this.dX,e)&&(0===e&&0===this.dX||(this.dY=e))}}changeDir(e){switch(e){case 0:return h.arrayGetRand([-1,1]);case 1:case-1:return 0;default:return e}}terminate(){this.status=g.GOAL_COMPLETED}}t.GoalExplore=A,t.Goal.Explore=A;class w extends m{constructor(e,t){super(e),this.setType("GoalFleeFromActor"),this.targetActor=t}activate(){const e=this.actor.getBrain().getSeenCells(),s=l.Brain.findCellsWithActors(this.actor,e);let a=null;if(s.forEach(e=>{const t=e.getActors();t&&t.forEach(t=>{t.getID()===this.targetActor.getID()&&(a=e)})}),a){const e=this.actor.getX(),s=this.actor.getY(),a=o.default.dXdYUnit(this.actor,this.targetActor),n=e+a[0],r=s+a[1],l=this.actor.getLevel(),c=[[n,r],[e,r],[n,s]];h.shuffle(c);for(let e=0;e<3;e++){const[t,s]=c[e];if(l.getMap().isPassable(t,s)){const e=new i.Movement(t,s,l);this.dbg(`${this.getType()} movComp to ${t},${s}`),this.actor.add(e),this.status=g.GOAL_COMPLETED;break}}this.status!==g.GOAL_COMPLETED&&(this.status=g.GOAL_FAILED,this.planBGoal=new t.Goal.AttackActor(this.actor,this.targetActor))}else this.status=g.GOAL_FAILED}process(){return this.activateIfInactive(),this.status}}t.GoalFleeFromActor=w,t.Goal.FleeFromActor=w;class O extends m{constructor(e,t,s){super(e),this.setType("GoalCastSpell"),this.spell=t,this.spellArgs=s}activate(){this.spell.getCastFunc(this.actor,this.spellArgs)(),this.status=g.GOAL_COMPLETED}process(){return this.activateIfInactive(),this.status}}t.GoalCastSpell=O,t.Goal.CastSpell=O;class M extends m{constructor(e,t){super(e),this.setType("GoalFollow"),this.targetActor=t}activate(){this.actor.getBrain().canSeeActor(this.targetActor)&&(this.status=g.GOAL_ACTIVE)}process(){this.activateIfInactive();const e=this.actor.getBrain(),[t,s]=this.actor.getXY();if(e.canSeeActor(this.targetActor)){const[e,a]=o.default.dXdYUnit(this.targetActor,this.actor),[n,r]=o.default.dXdY(this.targetActor,this.actor);let l=t+e,h=s+a;const u=this.targetActor.getLevel(),d=u.getMap();if(Math.abs(n)<=1&&Math.abs(r)<=1)this.status=g.GOAL_ACTIVE;else if(d.isPassable(l,h)){const e=new i.Movement(l,h,u);this.actor.add(e)}else{const[e,a]=this.targetActor.getXY(),n=c.Path.getActorToActorPath(d,t,s,e,a);if(n.length>0)if([l,h]=[n[0].x,n[0].y],d.isPassable(l,h)){const e=new i.Movement(l,h,u);this.actor.add(e)}else this.status=g.GOAL_FAILED;else this.status=g.GOAL_FAILED}}else this.status=g.GOAL_FAILED;return this.status}}t.GoalFollow=M,t.Goal.Follow=M;class P extends m{constructor(e,t){super(e),this.setType("GoalGetItem"),this.targetItem=t}activate(){const e=this.targetItem.getID(),t=this.actor.getBrain().getSeenCells();let s=null;if(t.forEach(t=>{if(t.hasItems()){t.getItems().find(t=>t.getID()===e)&&(s=t)}}),s){const[e,t]=this.actor.getXY(),[a,n]=s.getXY();if(e===a&&t===n){const e=new i.Pickup;this.actor.add(e),this.status=g.GOAL_COMPLETED}else{const e=new f(this.actor,[a,n]);this.removeAllSubGoals(),this.addSubGoal(e),this.status=this.processSubGoals()}}else this.status=g.GOAL_FAILED}process(){return this.activateIfInactive(),this.hasSubGoals()&&(this.status=this.processSubGoals()),this.status}}t.GoalGetItem=P,t.Goal.GetItem=P;class N extends m{constructor(e){super(e),this.setType("GoalOrders")}activate(){this.status=g.GOAL_ACTIVE}process(){return this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}t.GoalOrders=N,t.Goal.Orders=N;class I extends m{constructor(e,t,s){super(e),this.setType("GoalShopkeeper"),this.x=t,this.y=s,this.hasShouted=!1,this.subGoals=[]}activate(){this.status=g.GOAL_ACTIVE;const e=this.actor.getCell();if(e.hasShop())if(o.default.isSuccess(.6))L(this.actor);else if(this.hasShouted)e.hasItems();else{const e=new i.Communication;e.addMsg({src:this.actor,type:"Shout",shout:"Hello traveller!"}),this.actor.add(e)}else{const e=new f(this.actor,[this.x,this.y]);this.addSubGoal(e),this.status=this.processSubGoals()}}process(){return this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}t.GoalShopkeeper=I,t.Goal.Shopkeeper=I;class D extends m{constructor(e,t,s,a){super(e),this.setType("GoalGoHome"),this.x=t,this.y=s,this.maxDist=a,this.subGoals=[],this.timeToFindPath=h.getUniformInt(100,200)}activate(){this.status=g.GOAL_ACTIVE;const e=this.actor.getCell();if(this.timeToFindPath--,"floorhouse"===e.getBaseElem().getType())if(o.default.isSuccess(.03)){const e=new i.Communication;e.addMsg({src:this.actor,type:"Shout",shout:"Home sweet home!"}),this.actor.add(e)}else L(this.actor);else if(o.default.withinRange(this.maxDist,[this.x,this.y],this.actor))L(this.actor);else if(this.timeToFindPath<=0){const e=new f(this.actor,[this.x,this.y]);this.addSubGoal(e),this.status=this.processSubGoals(),this.timeToFindPath=h.getUniformInt(100,200)}else L(this.actor)}process(){return this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}function L(e){const t=e.getLevel(),s=t.getMap();let a=h.getRandDir(),n=o.default.newXYFromDir(a,e),r=10;for(;!s.hasXY(n[0],n[1])&&(a=h.getRandDir(),n=o.default.newXYFromDir(a,e),0!=--r););if(r>0){const s=new i.Movement(n[0],n[1],t);e.add(s)}}t.GoalGoHome=D,t.Goal.GoHome=D,t.Goal.moveToRandomDir=L,t.Goal.moveActorTo=function(e,t){const s=t.getXY(),a=e.getLevel();if(a.getMap().isPassable(s[0],s[1])){const t=new i.Movement(s[0],s[1],a);e.add(t)}};class R{constructor(e){this.goal=e}}t.GoalMonitor=R,t.Goal.Monitor=R;class x extends m{constructor(e){super(e),this.setType("GoalCommunicate")}activate(){this.communicateEnemies()}process(){return this.activateIfInactive(),g.GOAL_COMPLETED}communicateEnemies(){const e=this.actor.getBrain(),t=e.getMemory(),s=t.getEnemyActors(),a=e.getSeenCells(),n=e.findFriendCell(a).getActors()[0],r=new i.Communication,o={type:"Enemies",enemies:s,src:this.actor};r.addMsg(o),n.add(r),t.addCommunicationWith(n)}}t.GoalCommunicate=x,t.Goal.Communicate=x},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(41),i=n(s(2)),l=s(1),c=s(16),h=s(6),u=s(10),d=s(3),g=s(15),p=s(22),m=l.Random.getRNG(),{KeyMap:f}=o.Keys,y=i.create;t.Spell={};t.Spell.addPoisonEffect=((e,t)=>{const s=t.get("Experience").getExpLevel(),a=new c.Dice(1,s,Math.ceil(s/2));let n=.07*s;n>=.5&&(n=.5);const r=new c.Dice(2,s+5,Math.ceil(s/2)).roll();_(e,t,r,a,n)});const _=(e,t,s,a,n)=>{const r=new i.Poison;r.setDamageDie(a);const o=new i.Expiration;o.addEffect(r,s),r.setSource(t),r.setProb(n),e.add(r),e.add(o)},E=(e,t,s)=>{const a=s.getCaster();a.getLevel().addActor(e,t.getX(),t.getY());const n=new i.Fading,r=s.getDuration();n.setDuration(r),e.add(n);const o=new i.Created;o.setCreator(a),e.add(o)};t.Spell.addFadingActorToCell=E;const S=(e,t,s)=>{const a=[t.getX()-e.getX(),t.getY()-e.getY()];s(e,{dir:a,src:e})};t.Spell.aiSpellCellDone=S;t.Spell.aiSpellCellEnemy=((e,t)=>{const{actor:s,actorCellsAround:a}=e;let n=null;return a.forEach(t=>{t.getActors().forEach(t=>{if(s.isEnemy(t)){const s=t.get("Health");n?e.compFunc?e.compFunc(n,t)&&(n=t):s.getMaxHP()>n.get("Health").getMaxHP()&&(n=t):n=t}})}),!!n&&(S(s,n,t),!0)});t.Spell.aiSpellCellFriend=((e,t)=>{const{actor:s,actorCellsAround:a}=e;let n=null;return a.forEach(t=>{t.getActors().forEach(t=>{if(s.isFriend(t))if(n)if(e.compFunc)e.compFunc(n,t)&&(n=t);else{const e=n.get("Health");t.get("Health").hpLost()>e.hpLost()&&(n=t)}else n=t})}),!!n&&(S(s,n,t),!0)});t.Spell.aiSpellCellSelf=((e,t)=>{const{actor:s}=e;let a=!0;return e.compFunc&&(a=!!e.compFunc(s)),a&&S(s,s,t),a}),t.Spell.getSelectionObjectSelf=((e,t)=>{return()=>{const s=new i.SpellCast;s.setSource(t),s.setSpell(e),s.setArgs({src:t}),t.add(s)}}),t.Spell.getSelectionObjectDir=((e,t,s)=>(r.default.gameMsg(s),{select:s=>{const a={dir:f.getDir(s)};return a.dir?(a.src=t,()=>{const s=new i.SpellCast;s.setSource(t),s.setSpell(e),s.setArgs(a),t.add(s)}):null},showMenu:()=>!1}));const v=function(e,t){return{from:t.src.getXY(),dir:t.dir,spell:e,src:t.src}};t.Spell.getDirSpellArgs=v;class C{constructor(e){this._actor=e,this._spells=[],r.default.isNullOrUndef([this._actor])&&r.default.err("Spell.SpellBook","new","actor must be given.")}getActor(){return this._actor}addSpell(e){this._spells.push(e),e.setCaster(this.getActor())}getSpells(){return this._spells}equals(e){const t=e.getSpells();let s=!0;return this._spells.forEach((e,a)=>{(s=s&&e.equals(t[a]))||console.log("Spell",e.getName()," caused error")}),s}getSelectionObject(){const e=this._spells;return{select:t=>{const s=o.Keys.codeToIndex(t);return s<e.length?e[s].getSelectionObject(this._actor):null},getMenu:()=>{r.default.gameMsg("Please select a spell to cast:");const t=o.Keys.menuIndices.slice(0,this._spells.length),s={pre:["You know the following spells:"]};return e.forEach((e,a)=>{s[t[a]]=e.toString()}),s},showMenu:()=>!0}}toJSON(){return{spells:this._spells.map(e=>e.toJSON())}}}function b(e,t,s){const{actor:a,enemy:n}=e;if(!n)return!1;if(u.Brain.distToActor(a,n)<=s.getRange()){return t(a,{target:n,src:a}),!0}return!1}t.SpellBook=C,t.Spell.SpellBook=C,t.SpellBase=function(e,t){this._name=e,this._power=t||5,this._caster=null,this._dice={},this._range=0,this.setName(e)},t.SpellBase.prototype.setCaster=function(e){this._caster=e},t.SpellBase.prototype.getCaster=function(){return this._caster},t.SpellBase.prototype.setName=function(e){const t=e.split(/\s+/),s=[];t.forEach(e=>{s.push(e.capitalize())}),this._new=s.join("")},t.SpellBase.prototype.getName=function(){return this._name},t.SpellBase.prototype.getPower=function(){return this._power},t.SpellBase.prototype.canCast=function(){return this._caster.get("SpellPower").getPP()>=this.getCastingPower()},t.SpellBase.prototype.getCastingPower=function(){let e=this._power;const t=this._caster.get("Experience").getExpLevel();if(e-=Math.ceil(t/3),this._caster.has("Skills")){const t=this._caster.get("Skills").getLevel("SpellCasting");e-=Math.ceil(t/2)}const s=Math.round(.5*this._power);return e<s?s:e},t.SpellBase.prototype.getRange=function(){return this._range},t.SpellBase.prototype.setRange=function(e){this._range=e},t.SpellBase.prototype.getDuration=function(e=1){let t=0;if(this._dice.duration&&(t=this._dice.duration.roll()),e>0){const s=this._caster.get("Experience").getExpLevel();t+=Math.round(s/e)}return t},t.SpellBase.prototype.getDamage=function(e=1){let t=0;this._dice.damage&&(t=this._dice.damage.roll());const s=this._caster.get("Experience").getExpLevel();return t+=Math.round(s/e)},t.SpellBase.prototype.setPower=function(e){this._power=e},t.SpellBase.prototype.getCastFunc=function(e,t){return t.dir||t.target||t.src?(t.src=e,()=>{const s=new i.SpellCast;s.setSource(e),s.setSpell(this),s.setArgs(t),e.add(s)}):null},t.SpellBase.prototype.toString=function(){const e=this.getCastingPower();let t=`${this.getName()} - ${e}PP`;return this._dice.damage&&(t+=` Dmg: ${this._dice.damage.toString()}`),this._dice.duration&&(t+=` Dur: ${this._dice.duration.toString()}`),this._range>0&&(t+=` R: ${this.getRange()}`),t},t.SpellBase.prototype.getCasterExpBonus=function(e){const t=this.getCaster().get("Experience").getExpLevel();return Math.round(t/e)},t.SpellBase.prototype.getCasterStatBonus=function(e,t){const s="get"+e.capitalize(),a=this.getCaster()[s]();return Math.round(a/t)},t.SpellBase.prototype.equals=function(e){let t=this.getName()===e.getName();return t=(t=t&&this.getPower()===e.getPower())&&this.getRange()===e.getRange(),Object.keys(this._dice).forEach(s=>{t=!!e._dice[s]&&(t&&this._dice[s].equals(e._dice[s]))}),t},t.SpellBase.prototype.setDice=function(e,t){"string"==typeof t?this._dice[e]=c.Dice.create(t):t.roll&&(this._dice[e]=t)},t.SpellBase.prototype.getDice=function(e){return this._dice[e]},t.SpellBase.prototype.hasDice=function(e){return!(!this._dice.hasOwnProperty(e)||!this._dice[e])},t.SpellBase.prototype.removeDice=function(e){this._dice[e]=null},t.SpellBase.prototype.rollDice=function(e){return this._dice[e]?this._dice[e].roll():(r.default.err("SpellBase","rollDice",`No dice with name ${e} found`),0)},t.SpellBase.prototype.aiShouldCastSpell=function(e,t){return!1},t.SpellBase.prototype.toJSON=function(){const e={};return Object.keys(this._dice).forEach(t=>{r.default.isNullOrUndef([this._dice[t]])||(e[t]=this._dice[t].toJSON())}),{name:this.getName(),new:this._new,power:this.getPower(),dice:e,range:this._range}},t.Spell.AddComponent=function(e,s){t.SpellBase.call(this,e,s),this._compName="",this._dice.duration=c.Dice.create("1d6 + 3")},r.default.extend2(t.Spell.AddComponent,t.SpellBase),t.Spell.AddComponent.prototype.setDuration=function(e){this._dice.duration=e},t.Spell.AddComponent.prototype.setCompName=function(e){this._compName=e},t.Spell.AddComponent.prototype.getCompName=function(){return this._compName},t.Spell.AddComponent.prototype.cast=function(e){const t=v(this,e),s=y(this._compName);if(s.setSource&&s.setSource(e.src),t.addComp={comp:s},this.hasDice("duration")){const e=this.rollDice("duration");t.addComp.duration=e}const a=new i.SpellCell;a.setArgs(t),e.src.add(a)},t.Spell.AddComponent.prototype.getSelectionObject=function(e){return t.Spell.getSelectionObjectDir(this,e,"Select a direction for the spell:")},t.Spell.RemoveComponent=function(e,s){t.SpellBase.call(this,e,s),this._compNames=[],this.setCompNames=(e=>{this._compNames="string"==typeof e?[e]:e}),this.getCompNames=(()=>this._compNames),this.cast=function(e){const t=v(this,e);t.removeComp=this._compNames;const s=new i.SpellCell;s.setArgs(t),e.src.add(s)},this.getSelectionObject=function(e){return t.Spell.getSelectionObjectDir(this,e,"Select a direction for the spell:")}},r.default.extend2(t.Spell.RemoveComponent,t.SpellBase),t.Spell.Ranged=function(e,s){t.SpellBase.call(this,e,s),this._dice.damage=c.Dice.create("4d4 + 4"),this._range=5},r.default.extend2(t.Spell.Ranged,t.SpellBase),t.Spell.BoltBase=function(e,s){t.Spell.Ranged.call(this,e,s),this.stopOnHit=!1,this.cast=function(e){const t=v(this,e);t.damageType=this.damageType,t.damage=this.rollDice("damage");const s=new i.SpellRay;s.setArgs(t),e.src.add(s)},this.getSelectionObject=function(e){return r.default.gameMsg("Select a direction for firing:"),{select:t=>{const s=f.getDir(t);return this.getCastFunc(e,{dir:s})},showMenu:()=>!1}},this.aiShouldCastSpell=((e,t)=>{const{actor:s,enemy:a}=e;if(!a)return!1;const[n,o]=[s.getX(),s.getY()],[i,l]=[a.getX(),a.getY()],c=d.Geometry.getStraightLine(n,o,i,l);if(c.length>1){const e={dir:[c[1][0]-c[0][0],c[1][1]-c[0][1]]};return"function"==typeof t?t(s,e):r.default.err("Spell.BoltBase","aiShouldCastSpell","No callback function given!"),!0}return!1})},r.default.extend2(t.Spell.BoltBase,t.Spell.Ranged),t.Spell.SummonBase=function(e,s){t.SpellBase.call(this,e,s),this.summonType="",this.nActors=1,this.summonFunc=null,this.setSummonType=(e=>{this.summonType=e}),this.cast=function(e){const t=v(this,e),s=c.Dice.getValue(this.nActors);t.callback=(t=>{if(1===s)t.isFree()&&this._createAndAddActor(t,e);else{const t=e.src,a=t.getLevel().getMap(),[n,o]=t.getXY(),i=d.Geometry.getBoxAround(n,o,2);let l=0,c=30;for(;l<s;){const[t,s]=m.arrayGetRand(i);if(a.hasXY(t,s)){const n=a.getCell(t,s);n.isFree()&&(this._createAndAddActor(n,e),++l)}if(0==--c)break}if(l<s){const e=`${t.getName()} has no space to summon`;r.default.gameMsg({cell:t.getCell(),msg:e})}}});const a=new i.SpellCell;a.setArgs(t),e.src.add(a)},this.getSelectionObject=function(e){return t.Spell.getSelectionObjectDir(this,e,"Select a free cell for summoning:")},this.aiShouldCastSpell=((e,t)=>{const{actor:s,enemy:a}=e;if(0===u.Brain.getFriendCellsAround(s).length)if("function"==typeof t){const a=s.getBrain().getRandAdjacentFreeCell();if(a)return e.dir=r.default.dXdY(a,s),t(s,e),!0}else r.default.err(`Spell.${this.getName()}`,"aiShouldCastSpell",`No callback function given! enemy: ${a}`);return!1}),this._createAndAddActor=((e,t)=>{const[s,a]=[e.getX(),e.getY()],n=t.src,o=n.getLevel(),i=h.ObjectShell.getParser();let l=null;if(""!==this.summonType?l=i.createActor(this.summonType):this.summonFunc&&(l=i.createRandomActor({func:this.summonFunc})),l){o.addActor(l,s,a),l.getBrain().getMemory().copyMemoryFrom(n),l.addFriend(n),n.addFriend(l);const i=`${n.getName()} summons ${l.getName()}!`;r.default.gameMsg({cell:e,msg:i}),"function"==typeof this.postSummonCallback&&this.postSummonCallback(e,t,l)}else{let e=`Failed to create summon type |${this.summonType}|`;if(this.summonFunc){e=`summonFunc ${this.summonFunc.toString()} gave no actors`}r.default.warn("Spell.SummonBase","_createAndActor",e)}})},r.default.extend2(t.Spell.SummonBase,t.SpellBase),t.Spell.Missile=function(e,s){t.Spell.Ranged.call(this,e,s),this.ammoName=""},r.default.extend2(t.Spell.Missile,t.Spell.Ranged),t.Spell.Missile.prototype.getAmmoName=function(){return this.ammoName},t.Spell.Missile.prototype.cast=function(e){const[t,s]=[e.src.getX(),e.src.getY()],a={from:[t,s],target:e.target,spell:this,src:e.src,to:[e.target.getX(),e.target.getY()]};a.damageType=this.damageType,a.damage=this.getDamage();const n=new i.SpellMissile;n.setArgs(a),e.src.add(n)},t.Spell.Missile.prototype.getSelectionObject=function(e){r.default.gameMsg("Press [n/p] for next/prev target. [t] to fire."),e.getBrain().startTargeting();const t=[{key:o.Keys.KEY.TARGET,func:()=>{const t=e.getBrain().getTarget();if(t){console.log("ZZZ Target is",t);const s=new i.SpellCast;s.setSource(e),s.setSpell(this),s.setArgs({src:e,target:t}),e.add(s),e.getBrain().cancelTargeting()}}}];return new p.PlayerMissileMenu(t,e)},t.Spell.Missile.prototype.aiShouldCastSpell=function(e,t){const{actor:s,enemy:a}=e;if(a){const[e,n]=a.getXY(),[r,o]=s.getXY();if(g.Path.shortestDist(e,n,r,o)<=this.getRange()){return t(s,{target:a,src:s}),!0}}return!1},t.Spell.AreaBase=function(e,s){t.Spell.Ranged.call(this,e,s),this.getSelectionObject=function(e){return t.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=((e,t)=>b(e,t,this)),this.cast=function(e){const t={src:e.src,range:this.getRange(),spell:this};t.damageType=this.damageType,t.damage=this.getDamage();const s=new i.SpellArea;s.setArgs(t),e.src.add(s);const a=e.src.getName(),n=`Huge ${this.getName()} emanates from ${a}`;r.default.gameMsg({msg:n,cell:e.src.getCell()})}},r.default.extend2(t.Spell.AreaBase,t.Spell.Ranged),t.Spell.RingBase=function(e,s){t.SpellBase.call(this,e,s),t.SpellBase.call(this,e,s),this._dice.duration=c.Dice.create("10d10"),this._range=2,this._createdActor="Fire",this.cast=function(e){const t=v(this,e);t.callback=this.castCallback.bind(this);const s=new i.SpellSelf;s.setArgs(t),e.src.add(s)},this.getSelectionObject=function(e){return t.Spell.getSelectionObjectSelf(this,e)},this.castCallback=(()=>{const e=h.ObjectShell.getParser(),t=this._caster;u.Brain.getCellsAroundActor(t,this._range).forEach(t=>{if(t.isPassable()||t.hasActors()){const s=e.createActor(this._createdActor);E(s,t,this)}})}),this.aiShouldCastSpell=((e,t)=>b(e,t,this))},r.default.extend2(t.Spell.RingBase,t.SpellBase),t.Spell.MultiSpell=function(e,s){t.SpellBase.call(this,e,s),this._spells=[]},r.default.extend2(t.Spell.MultiSpell,t.SpellBase),t.Spell.MultiSpell.prototype.addSpell=function(e){this._spells.push(e)},t.Spell.MultiSpell.prototype.removeSpells=function(){this._spells=[]},t.Spell.MultiSpell.prototype.canCast=function(){return this._caster.get("SpellPower").getPP()>=this.getCastingPower()},t.Spell.MultiSpell.prototype.cast=function(e){this._spells.forEach(t=>{t.cast(e)})},t.Spell.MultiSpell.prototype.getCastingPower=function(){return this._spells.map(e=>e.getCastingPower()).reduce((e,t)=>e+t,0)},t.Spell.MultiSpell.prototype.getPower=function(){return this._spells.map(e=>e.getPower()).reduce((e,t)=>e+t,0)},t.Spell.MultiSpell.prototype.aiShouldCastSpell=function(e,t){let s=!0;return this._spells.forEach(a=>{s=s&&a.aiShouldCastSpell(e,t)}),s},t.Spell.MultiSpell.prototype.equals=function(e){if(!e._spells)return!1;if(e._spells.length!==this._spells.length)return!1;let t=!0;return this._spells.forEach((s,a)=>{(t=t&&s.equals(e._spells[a]))||console.log("Spell",s.getName()," caused error")}),t},t.Spell.MultiSpell.prototype.toJSON=function(){const e=t.SpellBase.prototype.toJSON.call(this);return e.spells=this._spells.map(e=>e.toJSON()),e},t.Spell.MultiSpell.prototype.setCaster=function(e){this._spells.forEach(t=>{t.setCaster(e)})},t.Spell.defineSpell=function(e,s){const a=class extends s{constructor(...t){super(e,0),this._init&&"function"==typeof this._init&&this._init(...t)}};return t.Spell[e]=a,a},t.Spell.undefineSpell=function(e){delete t.Spell[e]}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=s(1),n=s(36),r=s(78),o=a.Random.getRNG();t.Castle={},t.Castle.corridorDoorThr=.2,t.Castle.tiles={},t.Castle.tiles.corner=["\ndir:NW\nname:corner_se\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n......#\nY.....#\n......#\n#######","\ndir:NW\nname:corner_se1\nX=#\nY=#\n\n#X#+#X#\nY.....#\n+.....#\n+...#.#\n+..####\nY...###\n#######","\ndir:NE\nname:corner_sw\nX=.\nY=#\n\n#X...X#\n#.....#\nY......\n#......\nY......\n#.....#\n#######","\ndir:SW\nname:corner_ne\nX=#\nY=.\n\n#X###X#\nY.....#\n......#\n......#\n......#\nY.....#\n#.....#","\ndir:SE\nname:corner_nw\nX=#\nY=#\n\n#X###X#\n#......\nY......\n#......\nY......\n#......\n#.....#"],t.Castle.tiles.term=["\ndir:N\nname:term_n\nX=#\nY=#\n\n#X#+#X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n#######","\ndir:S\nname:term_s\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n###+###","\ndir:E\nname:term_e\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n#.....+\nY.....#\n#.....#\n#######","\ndir:W\nname:term_w\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n+.....#\nY.....#\n#.....#\n#######"],t.Castle.tiles.entrance=["\ndir:NEW\nname:entrance_n\nX=.\nY=#\n\n#X...X#\n##...##\nY##.###\n..#+#..\n.......\nY.....#\n#######","\ndir:SEW\nname:entrance_s\nX=#\nY=#\n\n#X###X#\nY......\n..#.#..\n.##+##.\nY#...##\n#.....#\n##...##","\ndir:NSW\nname:entrance_w\nX=#\nY=#\n\n##X..X#\nY.##..#\n...##.#\n....+.#\n...##.#\nY.##..#\n###...#","\ndir:NSE\nname:entrance_e\nX=#\nY=#\n\n#.X.X##\nY.#..##\n#.##.#.\n#....+.\n#..#.#.\nY.##.##\n#.....#"],t.Castle.tiles.entranceWall=["\ndir:NEW\nname:entrance_n\nX=.\nY=#\n\n#X...X#\n##...##\nY##.###\n..#+#..\n.......\nY.....#\n##...##","\ndir:SEW\nname:entrance_s\nX=#\nY=#\n\n#X...X#\nY.....#\n..#.#..\n.##+##.\nY#...##\n#.....#\n#.....#","\ndir:NSW\nname:entrance_w\nX=#\nY=#\n\n##X..X#\nY.##..#\n...##.#\n....+.#\n...##.#\nY.##..#\n###...#","\ndir:NSE\nname:entrance_e\nX=.\nY=#\n\n#.#XX##\nY.##.##\n...#.#.\n.....+.\n...#.#.\nY.##.##\n#.....#"],t.Castle.tiles.corridor=["\ndir:NS\nname:corridor_east\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n#.....#","\ndir:NS\nname:corridor_west\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n#.....#","\ndir:EW\nname:corridor_north\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n.......\n#######","\ndir:EW\nname:corridor_south\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n.......\n#######"],t.Castle.tiles.corridorWithExit=["\ndir:NS\nname:corridor_east\nX=.\nY=#\n\n#X...X#\n#.....#\nY#....#\n......#\nY#....#\n#.....#\n#.....#","\ndir:NS\nname:corridor_west\nX=.\nY=#\n\n#X...X#\n#.....#\nY....##\n#......\nY....##\n#.....#\n#.....#","\ndir:EW\nname:corridor_north\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n..#.#..\n###.###","\ndir:EW\nname:corridor_south\nX=#\nY=.\n\n#X#.#X#\n..#.#..\nY......\n.......\nY......\n..#.#..\n#######"],t.Castle.tiles.branch=["\ndir:NSE\nname:corridor_nse\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n#.....+\nY.....#\n#.....#\n#.....#","\ndir:NSW\nname:corridor_nsw\nX=#\nY=#\n\n#X...X#\n#.....#\nY.....#\n+.....#\nY.....#\n#.....#\n##...##","\ndir:NEW\nname:corridor_new\nX=#\nY=.\n\n#X#+#X#\n.......\nY......\n.......\nY......\n.......\n#######","\ndir:SEW\nname:corridor_sew\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n.......\n###+###"],t.Castle.tiles.storerooms=["\ndir:S\nname:storeroom_s\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n#.....#\nY.....#\n###|###\n##..&##","\ndir:N\nname:storeroom_n\nX=#\nY=#\n\n#X&..X#\n###|###\nY.....#\n#.....#\nY.....#\n#######\n#######","\ndir:W\nname:storeroom_w\nX=#\nY=#\n\n##X#X##\nY#.#.##\n.#....#\n.|...##\n&#....#\nY#.#.##\n#######","\ndir:E\nname:storeroom_e\nX=#\nY=#\n\n##X#X##\nY#.#.##\n#....#&\n#....|.\n#....#.\nY..#.##\n#######"],t.Castle.tiles.residential=["\nname:living2x2\nX=#\nY=#\n\n#X+#+X#\n#::#::#\nY::#::#\n#######\nY::#::#\n#::#::#\n##+#+##","\nname:living2x2\ndir:NS\nX=#\nY=#\n\n#X#.#X#\n#:+.+:#\nY:#.#:#\n###.###\nY:#.#:#\n#:+.+:#\n###.###","\nname:living2x2\ndir:NS\nX=#\nY=#\n\n#X#.#X#\nY:#.#:#\n#:+.+:#\n###.###\n#:+.+:#\nY:#.#:#\n###.###","\nname:livingL2S\ndir:S\nX=#\nY=#\n\n#X###X#\n#:::::#\nY:::::#\n###+###\nY:#.#:#\n#:+.+:#\n###.###","\nname:livingL_corner\ndir:NE\nX=#\nY=#\n\n#X#..X#\n#:#+#..\nY:::##.\n#::::#.\nY::::##\n#:::::#\n#######","\nname:living_3dir\ndir:NSE\nX=#\nY=#\n\n#X#.X##\nY:#.#:#\n#:#.#+#\n#:#....\nY:#.###\n#:+.###\n###.###","\nname:living_corner\ndir:NE\nX=#\nY=#\n\n#X#.#X#\n#:#...#\nY:###.#\n#:::+..\nY:::###\n#:::+:#\n#######","\nname:living_corner2\ndir:NE\nX=#\nY=#\n\n#X#.#X#\n#:#...#\nY:###..\n#:::+#.\nY::::##\n#:::::#\n#######"],t.Castle.tiles.fillerFloor="\nname:FILLER\nX=.\nY=.\n\n.X...X.\nY......\n.......\n.......\n.......\nY......\n.......",t.Castle.tiles.fillerWall="\nname:FILLER\nX=#\nY=#\n\n#X###X#\nY######\n#######\n#######\n#######\nY######\n#######",t.Castle.startRoomFunc=function(){const e=Math.floor(this.tilesX/2);let t=null,s=0;return o.getUniform()<=.5?t=this.findTemplate({name:"entrance_n"}):(t=this.findTemplate({name:"entrance_s"}),s=this.tilesY-1),{x:e,y:s,room:t}},t.Castle.startRoomFuncNorth=function(){return{x:Math.floor(this.tilesX/2),y:0,room:this.findTemplate({name:"entrance_n"})}},t.Castle.startRoomFuncSouth=function(){const e=this.tilesY-1;return{x:Math.floor(this.tilesX/2),y:e,room:this.findTemplate({name:"entrance_s"})}},t.Castle.startRoomFuncWest=function(){return{x:0,y:Math.floor(this.tilesY/2),room:this.findTemplate({name:"entrance_w"})}},t.Castle.startRoomFuncEast=function(){const e=Math.floor(this.tilesY/2);return{x:this.tilesX-1,y:e,room:this.findTemplate({name:"entrance_e"})}},t.Castle.startFuncTwoGates=function(){const e=Math.floor(this.tilesX/2),t=this.findTemplate({name:"entrance_n"}),s=this.findTemplate({name:"entrance_s"});return this.addRoom(t,e,0),{x:e,y:this.tilesY-1,room:s}},t.Castle.startFuncFourGates=function(){const e=Math.floor(this.tilesX/2),t=Math.floor(this.tilesY/2),s=this.findTemplate({name:"entrance_n"}),a=this.findTemplate({name:"entrance_s"}),n=this.findTemplate({name:"entrance_e"}),r=this.findTemplate({name:"entrance_w"});return this.addRoom(s,e,0),this.addRoom(n,this.tilesX-1,t),this.addRoom(r,0,t),{x:e,y:this.tilesY-1,room:a}},t.Castle.constraintFunc=function(e,s,a){if(0===e&&0===s)return this.findTemplate({name:"corner_nw"});if(0===e&&s===this.tilesY-1)return this.findTemplate({name:"corner_sw"});if(e===this.tilesX-1&&0===s)return this.findTemplate({name:"corner_ne"});if(e===this.tilesX-1&&s===this.tilesY-1)return this.findTemplate({name:"corner_se"});if(0===s){const e=this.findTemplate({name:"corridor_north"}),s=this.findTemplate({name:"corridor_sew"});if(s){if("S"===a)return s;if(o.getUniform()<t.Castle.corridorDoorThr)return s}return e}if(s===this.tilesY-1){const e=this.findTemplate({name:"corridor_south"}),s=this.findTemplate({name:"corridor_new"});if(s){if("N"===a)return s;if(o.getUniform()<t.Castle.corridorDoorThr)return s}return e}if(0===e){const e=this.findTemplate({name:"corridor_west"}),s=this.findTemplate({name:"corridor_nse"});if(s){if("E"===a)return s;if(o.getUniform()<t.Castle.corridorDoorThr)return s}return e}if(e===this.tilesX-1){const e=this.findTemplate({name:"corridor_east"}),s=this.findTemplate({name:"corridor_nsw"});if(s){if("W"===a)return s;if(o.getUniform()<t.Castle.corridorDoorThr)return s}return e}return null},t.Castle.roomCount=-1,t.Castle.Models={},t.Castle.Models.full=[].concat(t.Castle.tiles.branch).concat(t.Castle.tiles.corner).concat(t.Castle.tiles.term).concat(t.Castle.tiles.entrance).concat(t.Castle.tiles.corridor).concat(t.Castle.tiles.storerooms).concat(r.Vault.tiles.vault).concat(r.Vault.tiles.corner),t.Castle.Models.residential=t.Castle.tiles.residential.concat(t.Castle.Models.full),t.Castle.Models.outerWall=[].concat(t.Castle.tiles.entranceWall).concat(t.Castle.tiles.corner).concat(t.Castle.tiles.corridor).concat(t.Castle.tiles.corridorWithExit),t.Castle.templates={},t.Castle.templates.all=t.Castle.Models.full.map(e=>n.Template.createTemplate(e));let i=n.Template.transformList(t.Castle.templates.all);t.Castle.templates.all=t.Castle.templates.all.concat(i),t.Castle.templates.livingOnly=t.Castle.tiles.residential.map(e=>n.Template.createTemplate(e)),i=n.Template.transformList(t.Castle.templates.livingOnly),t.Castle.templates.livingOnly=t.Castle.templates.livingOnly.concat(i),t.Castle.templates.residential=t.Castle.templates.livingOnly.concat(t.Castle.templates.all)},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Names={};const n=a(s(0)),r=s(1).Random.getRNG();t.Names.place={},t.Names.place.generic={branch:["Hand","Foot","Small","Large"],dungeon:["Crypt","Catacombs","Tombs","Dungeon","Cells","Cave","Grotto","Cavern","Lair","Labyrinth"],mountain:["Summit","Volcano","Tops","Peaks","Bluff","Highlands","Pinnacle","Rise","Needle","Hills","Slopes"],face:["Face","Buttress","Ridge","Shoulder","Crag","Crest","Brink","Cairn","Col","Pass","Crown","Scree","Watershed"],forest:["Grove","Wilds","Woodlands","Timberland","Forest","Covert","Woods","Thicket","Glade"],city:["Town","Village","Fort","City"],lake:["Basin","Cove","Reservoir","Depths","Gorge","Lagoon","Domain","Pond","Expanse","Lake","Shallows","Loch","Falls","Rapids"],quarter:["Market","Bazaar","Plaza","Row","Works","Side","Acre","Garden","Park","Temple","Necropolis","Cemetery","Library","Arcane","Royal","Slum","Living","Arena","Military","Barracks"],area:[]},t.Names.place.unique={city:{first:["Stag","Small","Mud","Ebon","Silk","Spirit","Basin","Shadow","Gold","Silver","Snow","Frost","Ice","Hound","Moon","Dire","Ever","Iron","Ruby","Star","Crystal","Glimmer","Winters","Raven","Pine","Ever","Never","Rune","Glace","Lumen","Confer","Flamen","Jotun","Troll","Winds","Oaken","Willow","Anvil","Ashen","Kosken","Storm"],second:["guard","point","fell","mire","shield","crest","yard","minster","swallow","grasp","cliff","cross","host","barrow","vein","view","home","gard","wall","heim","creek","gasp","mane","thorne","keep"]}},t.Names.place.unique.mountain={first:t.Names.place.unique.city.first,second:t.Names.place.generic.mountain.map(e=>" "+e.toLowerCase())},t.Names.place.unique.dungeon={first:t.Names.place.unique.city.first,second:t.Names.place.generic.dungeon.map(e=>" "+e.toLowerCase())},t.Names.actor={},t.Names.item={steal:{adjective:["emerald","exquisite","golden","silver","bronze","ruby","diamond"],substantive:["ring","amulet","plate","vase","goblet"],char:{ring:"=",amulet:"^",plate:"_",vase:"]",goblet:"]"}},gather:{adjective:[],substantive:[]}},t.Names.getItemToStealName=(()=>{const e=t.Names.item.steal,s=r.arrayGetRand(e.adjective),a=r.arrayGetRand(e.substantive);return s.capitalize()+" "+a}),t.Names.getItemToGather=(()=>{const e=t.Names.item.gather,s=r.arrayGetRand(e.adjective),a=r.arrayGetRand(e.substantive);return s.capitalize()+" "+a}),t.Names.getVillageType=(()=>r.arrayGetRand(["Village","Hamlet","Town","Township"])),t.Names.alreadyUsed=new Set([""]),t.Names.getUniqueName=(e=>{const s=t.Names.place.unique[e];if(s){let e="";for(;t.Names.alreadyUsed.has(e);){e=r.arrayGetRand(s.first)+r.arrayGetRand(s.second)}return e}return n.default.err("name-gen.js","Names.getUniqueName",`No unique names for type ${e}`),""}),t.Names.getGenericPlaceName=(e=>{const s=t.Names.place.generic[e];return r.arrayGetRand(s)}),t.Names.actorCount=0,t.Names.getActorName=(()=>{let e="RandActor"+t.Names.actorCount++;for(;t.Names.alreadyUsed.has(e);)e="RandActor"+t.Names.actorCount++;return e});const o=["old","ancient","dusty","worn","well-preserved","heavy","light","thick","thin"],i=["rune-covered","worm-ridden","leather","hard-cover","metal-plated","decorated","exquisite","engraved","plain","ordinary","aesthetic","ornamental","skeletal"],l=["tome","book","tract","codex","opus","handbook","volume","treatise","grimoire","rariora","compendium","epitome","manuscript"];t.Names.getBookName=(()=>{let e="";for(;t.Names.alreadyUsed.has(e);){let t=r.arrayGetRand(o);e=`${t=t.capitalize()} ${r.arrayGetRand(i)} ${r.arrayGetRand(l)}`}return e})},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0));t.OW={},t.OW.LL_WE="═",t.OW.LL_NS="║",t.OW.CC_NW="╔",t.OW.CC_NE="╗",t.OW.CC_SW="╚",t.OW.CC_SE="╝",t.OW.XX="╬",t.OW.EMPTY="e",t.OW.TT_W="╠",t.OW.TT_E="╣",t.OW.TT_N="╦",t.OW.TT_S="╩",t.OW.TERM=".",t.OW.WCAPITAL="♔",t.OW.BCAPITAL="♚",t.OW.BTOWER="♜",t.OW.WTOWER="♖",t.OW.WDUNGEON="☖",t.OW.MOUNTAIN="^",t.OW.BVILLAGE="▲",t.OW.WVILLAGE="△",t.OW.VTUNNEL="|",t.OW.HTUNNEL="-",t.OW.MFORT="⟎",t.OW.PROB_BVILLAGE=.25,t.OW.biomeTypeMap={arctic:0,alpine:1,tundra:2,taiga:3,forest:4,grassland:5};const r=n.default.cellStyles.elements;t.OW.classNames={[t.OW.TERM]:r.floor,[t.OW.MOUNTAIN]:r.highrock,[t.OW.LL_WE]:r.mountain,[t.OW.LL_NS]:r.mountain,[t.OW.CC_NW]:r.mountain,[t.OW.CC_NE]:r.mountain,[t.OW.CC_SW]:r.mountain,[t.OW.CC_SE]:r.mountain,[t.OW.XX]:r.mountain,[t.OW.TT_W]:r.mountain,[t.OW.TT_E]:r.mountain,[t.OW.TT_N]:r.mountain,[t.OW.TT_S]:r.mountain,default:"cell-element-ow"},t.OW.BIOME={},t.OW.BIOME.ALPINE="alpine",t.OW.BIOME.ARCTIC="arctic",t.OW.BIOME.TUNDRA="tundra",t.OW.BIOME.TAIGA="taiga",t.OW.ILLEGAL_POS=-1,t.OW.CELL_ANY="OW.CELL_ANY",t.OW.E_HAS_CONN=[t.OW.XX,t.OW.TT_W,t.OW.TT_N,t.OW.TT_S,t.OW.CC_NW,t.OW.CC_SW,t.OW.LL_WE],t.OW.W_HAS_CONN=[t.OW.XX,t.OW.TT_E,t.OW.TT_N,t.OW.TT_S,t.OW.CC_NE,t.OW.CC_SE,t.OW.LL_WE],t.OW.N_HAS_CONN=[t.OW.XX,t.OW.TT_S,t.OW.TT_W,t.OW.TT_E,t.OW.CC_SW,t.OW.CC_SE,t.OW.LL_NS],t.OW.S_HAS_CONN=[t.OW.XX,t.OW.TT_N,t.OW.TT_W,t.OW.TT_E,t.OW.CC_NW,t.OW.CC_NE,t.OW.LL_NS],t.OW.N_BORDER=[t.OW.LL_WE,t.OW.TT_N],t.OW.S_BORDER=[t.OW.LL_WE,t.OW.TT_S],t.OW.E_BORDER=[t.OW.LL_NS,t.OW.TT_E],t.OW.W_BORDER=[t.OW.LL_NS,t.OW.TT_W],t.OW.ALL_WALLS=[t.OW.XX,t.OW.TT_N,t.OW.TT_S,t.OW.TT_E,t.OW.TT_W,t.OW.CC_SW,t.OW.CC_NW,t.OW.CC_SE,t.OW.CC_NE,t.OW.LL_WE,t.OW.LL_NS],t.OW.ALL_WALLS_LUT={},t.OW.ALL_WALLS.forEach(e=>{t.OW.ALL_WALLS_LUT[e]=e}),t.OW.LINE_WE_WEIGHT={[t.OW.LL_WE]:10,[t.OW.TT_N]:3,[t.OW.TT_S]:3,[t.OW.XX]:1},t.OW.LINE_NS_WEIGHT={[t.OW.LL_NS]:10,[t.OW.TT_E]:3,[t.OW.TT_W]:3,[t.OW.XX]:1},t.OW.CAN_CONNECT={[t.OW.LL_WE]:{N:[],S:[],E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.LL_NS]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:[],W:[]},[t.OW.CC_NW]:{N:t.OW.N_HAS_CONN,S:[],E:[],W:t.OW.W_HAS_CONN},[t.OW.CC_NE]:{N:t.OW.N_HAS_CONN,S:[],E:t.OW.E_HAS_CONN,W:[]},[t.OW.CC_SW]:{N:[],S:t.OW.S_HAS_CONN,E:[],W:t.OW.W_HAS_CONN},[t.OW.CC_SE]:{N:[],S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:[]},[t.OW.XX]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.EMPTY]:{N:[],S:[],E:[],W:[]},[t.OW.TT_W]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:[],W:t.OW.W_HAS_CONN},[t.OW.TT_E]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:[]},[t.OW.TT_N]:{N:t.OW.N_HAS_CONN,S:[],E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.TT_S]:{N:[],S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.TERM]:{N:[],S:[],E:[],W:[]}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(16);t.Mixin={};class o{}t.Base=o,t.Mixin.Base=o,t.Typed=(e=>(class extends e{constructor(t){e&&super(t),this.type=t.type||"",this._propType=t.propType||""}getPropType(){return this._propType}getType(){return this.type}setPropType(e){n.default.PROP_TYPES.indexOf(e)>=0?this._propType=e:n.default.err("Object.Typed","setPropType","Unknown prop type: |"+e+"|")}setType(e){this.type=e,n.default.nullOrUndefError("Object.Typed: setType","arg |type|",e)}})),t.Locatable=(e=>(class extends e{constructor(e){super(e),this._x=null,this._y=null,this._level=null}setX(e){this._x=e}setY(e){this._y=e}getX(){return this._x}getY(){return this._y}isAtXY(e,t){return e===this._x&&t===this._y}getXY(){return[this._x,this._y]}setXY(e,t){this._x=e,this._y=t}getCell(){return this._level.getMap().getCell(this._x,this._y)}setLevel(e){this._level=e,n.default.nullOrUndefError("Mixin.Locatable: setLevel","arg |level|",e)}unsetLevel(){this._level?this._level=null:n.default.err("Mixin.Locatable","unsetLevel","Trying to unset already null level.")}getLevel(){return this._level}isLocated(){return null!==this._x&&null!==this._y&&null!==this._level}})),t.DamageRoll=(e=>(class extends e{constructor(e){super(e),this.damageDie=r.Dice.create("1d4")}rollDamage(){if(this.getEntity().hasOwnProperty("getWeapon")){const e=this.getEntity().getWeapon();if(null!==e)return e.rollDamage()}return this.damageDie.roll()}getDamageDie(){return this.damageDie}setDamageDie(e){this.damageDie="string"==typeof e?r.Dice.create(e):e}copy(e){super.copy(e),this.damageDie=e.getDamageDie().clone()}toJSON(){const e=super.toJSON();return e.setDamageDie=this.damageDie.toString(),e}})),t.DurationRoll=(e=>(class extends e{constructor(e){super(e)}rollDuration(){return this.duration.roll()}setDurationDie(e){this.duration="string"==typeof e?r.Dice.create(e):e}getDurationDie(){return this.duration}copy(e){super.copy(e),this.duration=e.getDurationDie().clone()}toJSON(){const e=super.toJSON();return e.setDurationDie=this.duration.toString(),e}})),t.Defense=(e=>(class extends e{constructor(e){super(e),this._attack=1,this._defense=1,this._protection=0}getAttack(){return this._attack}setAttack(e){this._attack=e}getDefense(){return this._defense}setDefense(e){this._defense=e}getProtection(){return this._protection}setProtection(e){this._protection=e}copy(e){super.copy(e),this.setAttack(e.getAttack()),this.setDefense(e.getDefense()),this.setProtection(e.getProtection())}equals(e){let t=super.equals(e);return t&&(t=this.getAttack()===e.getAttack()&&this.getDefense()===e.getDefense()&&this.getProtection()===e.getProtection()),t}toString(){let e=super.toString();return e+=` A: ${this.getAttack()}, D: ${this.getDefense()}, `,e+=` P: ${this.getProtection()}, `}toJSON(){const e=super.toJSON();return e.setAttack=this.getAttack(),e.setDefense=this.getDefense(),e.setProtection=this.getProtection(),e}})),t.Damage=(e=>(class extends(t.Defense(e)){constructor(e){super(e),this._damageDie=new r.Dice(1,4,0),this._range=1}setAttackRange(e){this._range=e}getAttackRange(){return this._range}rollDamage(){if(this.hasOwnProperty("getWeapon")){const e=this.getWeapon();if(!n.default.isNullOrUndef([e]))return e.rollDamage()}return this._damageDie.roll()}getDamageDie(){return this._damageDie}setDamageDie(e){"string"==typeof e?this._damageDie=r.Dice.create(e):"object"==typeof e&&(this._damageDie=e)}copy(e){super.copy(e),this.setAttackRange(e.getAttackRange());const t=e.getDamageDie().clone();this.setDamageDie(t)}equals(e){let t=super.equals(e);return t&&(t=(t=this.getDamageDie().equals(e.getDamageDie()))&&this.getAttackRange()===e.getAttackRange()),t}toString(){let e=super.toString();return e+="Dmg: "+this.getDamageDie().toString(),e+=", R:"+this.getAttackRange()}toJSON(){const e=super.toJSON();return e.setAttackRange=this.getAttackRange(),e.setDamageDie=this.getDamageDie().toString(),e}}))},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=null;class n{static deserialize(e,t,s={}){const a=new t[e.$proto];for(const r in e)if(e.hasOwnProperty(r)){const o=e[r];if(n.isPrimitive(o))a[r]=o;else if(Array.isArray(o)){const e=[];a.forEach(a=>{e.push(n.deserialize(a,t,s))}),a[r]=e}else o.$objID?s.hasOwnProperty(o.$objID)?a[r]=s[o.$objID]:a[r]=n.deserialize(o,t,s):a[r]=o}return delete a.$proto,a}static deref(e){return e?e.value:a}static createObjectID(){return n.ID++}static getProtoName(e){return Object.getPrototypeOf(e).constructor.name}static isPrimitive(e){return"object"!=typeof e}static serialize(e){if(n.isPrimitive(e))return e;if(Array.isArray(e)){const t=[];return e.forEach(e=>{t.push(n.serialize(e))}),t}return e.$objID?e.serialize():e.toJSON?e.toJSON():e.$objRef?{$objRef:e.value.getID()}:e}constructor(){this.$objID=n.ID++}getID(){return this.$objID}setID(e){this.$objID=e}getObjRef(){return{$objRef:{type:"object",id:this.$objID}}}getRefAndVal(){const e=this.getObjRef();return e.value=this,e}}t.GameObject=n,n.ID=1},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=[],o=null;t.Memory=class{constructor(){this._actors={},this._enemyTypes={},this._communications=[],this._lastAttackedID=o}addEnemyType(e){this._enemyTypes[e]=!0}removeEnemyType(e){this._enemyTypes[e]&&delete this._enemyTypes[e]}isEnemy(e){if(this._actors.hasOwnProperty("enemies")&&this._actors.enemies.indexOf(e)>=0)return!0;if(!this.isFriend(e)){if(this._enemyTypes[e.getType()])return!0;if(e.isPlayer())return this._enemyTypes.player}return!1}isFriend(e){return!!this._actors.hasOwnProperty("friends")&&this._actors.friends.indexOf(e)>=0}addFriend(e){this.isEnemy(e)&&this.removeEnemy(e),this._actors.hasOwnProperty("friends")||(this._actors.friends=[]),this.isFriend(e)||this._actors.friends.push(e)}addEnemySeenCell(e){this._actors.seen||(this._actors.seen={}),this._actors.seen[e.getID()]={x:e.getX(),y:e.getY(),level:e.getLevel().getID()}}hasSeen(e){return!(!this._actors.seen||!this._actors.seen[e])}getLastSeen(e){return this._actors.seen[e.getID()]?this._actors.seen[e.getID()]:null}addEnemy(e){if(!n.default.isActor(e)){const t=JSON.stringify(e);n.default.err("Memory","addEnemy","Only actors can be added. Got: "+t)}this.isEnemy(e)||(this.isFriend(e)&&this.removeFriend(e),this._actors.hasOwnProperty("enemies")||(this._actors.enemies=[]),this._actors.enemies.push(e),this._communications.length>0&&(this._communications=[]))}removeEnemy(e){if(this._actors.hasOwnProperty("enemies")){const t=this._actors.enemies.indexOf(e);t>=0&&this._actors.enemies.splice(t,1)}}removeFriend(e){if(this._actors.hasOwnProperty("friends")){const t=this._actors.friends.indexOf(e);t>=0&&this._actors.friends.splice(t,1)}}getEnemyActors(){return this._actors.enemies||r}getFriendActors(){return this._actors.friends||r}copyMemoryFrom(e){const t=e.getBrain().getMemory(),s=t.getEnemyActors().slice();this._actors.enemies=s;const a=t.getFriendActors().slice();this._actors.friends=a,this._enemyTypes=Object.assign({},t._enemyTypes)}addCommunicationWith(e){this.hasCommunicatedWith(e)||this._communications.push(e)}wasLastAttacked(e){return this._lastAttackedID===e.getID()}setLastAttacked(e){this._lastAttackedID=e?e.getID():o}hasCommunicatedWith(e){return-1!==this._communications.indexOf(e)}toJSON(){const e={enemyTypes:Object.keys(this._enemyTypes)};return this._actors.hasOwnProperty("enemies")&&(e.enemies=this._actors.enemies.map(e=>e.getID())),this._actors.hasOwnProperty("friends")&&(e.friends=this._actors.friends.map(e=>e.getID())),this._lastAttackedID>=0&&(e.lastAttackedID=this._lastAttackedID),this._actors.hasOwnProperty("seen")&&(e.seen=this._actors.seen),e}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(22),i=s(41),l=n(s(69)),c=n(s(118)),h=n(s(13)),u=s(1),d=s(3),g=s(30),p=s(50),m=u.Random.getRNG(),f=i.Keys.KeyMap,{ACTION_ALREADY_DONE:y,ACTION_ZERO_ENERGY:_}=c,E='Select a target (all with "A"), then press "s" to choose it',S='Select a target with movement keys, then press "s" to choose it',v=e=>{return r.default.gameMsg("Select direction for chatting:"),{select:t=>{const s={dir:f.getDir(t),src:null};return s.dir?(s.src=e,()=>{const t=new h.Chat;t.setArgs(s),e.add(t)}):null},showMenu:()=>!1}};class C extends p.Memory{constructor(e){super(),this._lastAttackedID=null,this._player=e}setLastAttacked(e){Number.isInteger(e)?this._lastAttackedID=e:e&&(this._lastAttackedID=e.getID())}getLastAttacked(){return this._lastAttackedID}wasLastAttacked(e){return this._lastAttackedID===e.getID()}isEnemy(e){return!e.isPlayer()&&(!e.has("NonSentient")&&e.getBrain().getMemory().isEnemy(this._player))}toJSON(){const e={};return r.default.isNullOrUndef([this._lastAttackedID])||(e.setLastAttacked=this._lastAttackedID),e}}t.MemoryPlayer=C;const b="S_IDLE",T="S_TARGETING",A="S_LOOKING",w=256,O=null;class M{constructor(e){this._brain=e,this._targetList=[],this.targetIndex=-1,this._state=b}getActor(){return this._brain._actor}isTargeting(){return this._state===T}isLooking(){return this._state===A}nextTarget(){this.hasTargets()&&(++this.targetIndex,this.targetIndex>=this._targetList.length&&(this.targetIndex=0),this.setSelectedCells(this._targetList[this.targetIndex]))}prevTarget(){this.hasTargets()&&(--this.targetIndex,this.targetIndex<0&&(this.targetIndex=this._targetList.length-1),this.setSelectedCells(this._targetList[this.targetIndex]))}startLooking(){this._state=A}stopLooking(){this._state=b,this.selectedCells=O}startTargeting(){this._state=T,this._targetList=this.getTargetList(),this.targetIndex=this.getCellIndexToTarget(this._targetList),this.setSelectedCells(this._targetList[this.targetIndex])}cancelTargeting(){this._targetList=[],this._state=b,this.selectedCells=O,this.targetIndex=-1}getTargetList(){const e={},t=this._brain.getSeenCells(),s=this._brain._actor;return r.default.findEnemyCellForActor(s,t).forEach(t=>{e[t.getX()+","+t.getY()]=t}),Object.values(e)}setSelectedCells(e){if(e)if(Array.isArray(e))this.selectedCells=e;else{const t=e;if(this.selectedCells=[t],this.isTargeting()){const e=this.getActor(),[s,a]=[t.getX(),t.getY()],[n,r]=[e.getX(),e.getY()],o=d.Geometry.getBresenham(n,r,s,a).map(t=>e.getLevel().getMap().getCell(t[0],t[1]));this.selectedCells=this.selectedCells.concat(o)}}}getSelectedCells(){return this.selectedCells}getTarget(){return(this.isLooking()||this.isTargeting())&&this.selectedCells&&this.selectedCells.length>0?this.selectedCells[0]:this.selectedCells}getTargetCell(){return this.selectedCells.length>0?this.selectedCells[0]:null}getCellIndexToTarget(e){const t=this._brain.getMemory().getLastAttacked();for(let s=0;s<e.length;s++){const a=e[s].getProp("actors");for(let e=0;e<a.length;e++)if(a[e].getID()===t)return s}return 0}selectCell(e){const t=this._brain._actor,s=this._brain.getSeenCells();if(r.default.isNullOrUndef([e]))this.setSelectedCells(t.getCell());else if(e===i.Keys.KEY.SELECT_ALL){const e=g.Brain.findCellsWithFriends(t,s);this.setSelectedCells(e)}else{const a=this.selectedCells[0],n=t.getLevel().getMap(),[o,i]=[a.getX(),a.getY()],[l,c]=f.getDiff(e,o,i);if(n.hasXY(l,c)&&this.setSelectedCells(n.getCell(l,c)),this.isLooking()){const e=this.getTarget(),t=s.indexOf(e);let a="You cannot see there.";if(t>=0){const t=e.getPropNames();a="",t.forEach(e=>{a+=`You see ${e}. `}),r.default.gameMsg(a)}else r.default.gameMsg(a)}}}hasTargetSelected(){return!!this.selectedCells||!!this._targetList&&this.hasTargets()}hasTargets(){return this._targetList.length>0}processKey(e){if(f.isTargetMode(e)){if(this.isTargeting()){const e=this.getTarget();return this.cancelTargeting(),e?this._brain.handleCommand({cmd:"missile",target:e}):(r.default.gameMsg("No valid targets to attack."),this._brain.noAction())}return this.startTargeting(),this._brain.noAction()}return this.isTargeting()?(f.isNextTarget(e)?this.nextTarget():f.isPrevTarget(e)?this.prevTarget():this.cancelTargeting(),this._brain.noAction()):w}isTargetInRange(){const e=this.getTarget(),t=this._brain._actor;if(e&&e.getX){const[s,a]=[e.getX(),e.getY()],[n,o]=[t.getX(),t.getY()],i=d.Geometry.getBresenham(n,o,s,a),l=t.getInvEq().getEquipped("missile");if(l){const e=r.default.getMissileRange(t,l);if(i.length-1<=e)return!0}}return!1}}class P{constructor(e){this._brain=e,this._actor=e._actor,this._marks={}}addMark(e){const[t,s]=this._actor.getXY(),a=this._actor.getLevel().getID(),n={id:a,x:t,y:s};e&&(n.tag=e),this._marks[a]||(this._marks[a]=[]),this.markExists(a,t,s)||(this._marks[a].push(n),r.default.gameMsg("Added a mark to the current location."))}getMenu(){const e=this._actor.getLevel().getID(),t=this._marks[e]||[],s=t.map(e=>{const{x:t,y:s}=e,a=this._brain._guiCallbacks.GOTO.bind(null,i.Keys.KEY.GOTO,t,s);return[this.getMarkListMsg(e),a]}),a=t.map(e=>{const{x:t,y:s}=e,a=e.id;return[this.getMarkListMsg(e),this.deleteMark.bind(this,a,t,s)]}),n=new o.Menu.WithState;return n.addItem(i.Keys.KEY.DELETE,["Delete mark",o.Menu.NEXT_STATE]),n.addState("",s),n.addState("DELETE",a),n.addTransition("DELETE",i.Keys.KEY.DELETE),n.addPre("Choose a mark to delete","DELETE"),n}deleteMark(e,t,s){if(this._marks[e]){const a=this._marks[e].findIndex(a=>a.id===e&&a.x===t&&a.y===s);a>=0&&this._marks[e].splice(a,1)}}getMark(e){const t=i.Keys.codeToIndex(e);return this._marks.length<=t?this._marks[t]:null}getMarkListMsg(e){const{x:t,y:s}=e;let a=`${t}, ${s}`;if(e.tag)a+=` ${e.tag}`;else{const e=this._actor.getLevel().getMap().getCell(t,s);if(e.hasElements()){if(a+=" "+e.getElements()[0].getName(),e.hasConnection()){const t=e.getConnection().getTargetLevel();if(t){const e=t.getParent();e&&(a+=" - "+e.getName())}}}else e.hasItems()&&(a+=" "+e.getItems()[0].getName())}return a}markExists(e,t,s){return this._marks[e].findIndex(e=>e.x===t&&e.y===s)>=0}toJSON(){return this._marks}fromJSON(e){this._marks=e}}const N=null;t.BrainPlayer=class extends g.BrainSentient{constructor(e){super(e),this._confirmCallback=null,this._guiCallbacks={},this._type="Player",this._memory=new C(e),this.energy=1,this._confirmCallback=null,this._wantConfirm=!1,this._confirmEnergy=1,this._wantSelection=!1,this._selectionObject=null,this._runModeEnabled=!1,this._fightMode=r.default.FMODE_NORMAL,this._fsm=new M(this),this._markList=new P(this),this._cache={seen:N},this._statBoosts={CombatMods:{setAttack:0,setDefense:0,setProtection:0},StatsMods:{setSpeed:0,setAccuracy:0,setWillpower:0,setStrength:0,setAgility:0,setMagic:0}}}getType(){return this._type}setType(e){}getActor(){return this._actor}setActor(e){this._actor=e}addGUICallback(e,t){this._guiCallbacks[e]=t}getMemory(){return this._memory}_restoreBaseSpeed(){this._runModeEnabled=!1,this._actor.has("StatsMods")&&this._actor.get("StatsMods").setSpeed(0)}isRunModeEnabled(){return this._runModeEnabled}cmdNotPossible(e){return this.energy=0,r.default.gameWarn(e),_}isMenuShown(){return!!this._selectionObject&&this._selectionObject.showMenu()}getMenu(){return this._selectionObject&&this._selectionObject.showMenu()?this._selectionObject.getMenu():null}noAction(){return this.energy=0,_}getFightMode(){return this._fightMode}toggleRunMode(){if(this._runModeEnabled)this._restoreBaseSpeed();else{this._runModeEnabled=!0;const e=this._actor.get("Stats").getSpeed(),t=Math.floor(.2*e);this._actor.get("StatsMods").setSpeed(t)}}toggleFightMode(){this._fightMode+=1,this._fightMode>=r.default.FMODES.length&&(this._fightMode=r.default.FMODE_NORMAL)}_createBuyConfirmCallback(e){const t=e.getProp("items")[0],s=e.getPropType("shop")[0],a=s.getItemPriceForBuying(t);this._confirmEnergy=0,this._wantConfirm=!0,this._confirmCallback=(()=>{const e=new h.Transaction;e.setArgs({item:t,buyer:this._actor,shop:s,seller:s.getShopkeeper()}),this._actor.add(e)}),r.default.gameMsg("Press 'y' to buy "+t.getName()+" for "+a+" gold coins")}_setAttackStats(){const e=this._actor.get("Stats"),t=this._actor.get("Combat");let s=0,a=0,n=0;this._fightMode===r.default.FMODE_FAST?(s=Math.round(.2*e.getSpeed()),a=(a=-Math.round(.2*t.getAttack()))<=0?-1:a,n=-1):this._fightMode===r.default.FMODE_SLOW&&(s=-Math.round(.2*e.getSpeed()),a=0===(a=Math.round(.2*t.getAttack()))?1:a,n=2),this._actor.get("StatsMods").setSpeed(s),this._actor.get("CombatMods").setAttack(a),this._actor.get("CombatMods").setDamage(n)}handleCommand(e){switch(this._restoreBaseSpeed(),e.cmd){case"attack":return new c.CmdAttack(this).execute(e);case"missile":return new c.CmdMissile(this).execute(e);case"use":return new c.CmdUseItem(this).execute(e);case"drop":return new c.CmdDropItem(this).execute(e);case"equip":return new c.CmdEquipItem(this).execute(e);case"unequip":return new c.CmdUnequipItem(this).execute(e);case"use-element":return new c.CmdUseElement(this).execute(e);default:return()=>{}}}resetBoosts(){this.energy=1;for(const e in this._statBoosts)if(e){const t=this._statBoosts[e];for(const s in t)if(s){const a=t[s];this._actor.has(e)&&this._actor.get(e)[s](a)}}}tryToToggleDoor(){const e=g.Brain.getCellsAroundActor(this._actor).filter(e=>e.hasDoor());if(1===e.length)return this.openDoorFromCell(e[0]);if(e.length>1){const t=m.arrayGetRand(e);return this.openDoorFromCell(t)}return this.cmdNotPossible("There are no doors to open or close")}openDoorFromCell(e){if(e){const t=e.getPropType("door")[0];if(t){const e=new h.OpenDoor;return e.setDoor(t),this._actor.add(e),y}}return this.cmdNotPossible("There are no doors to open or close")}getSeenCells(){if(this._cache.seen===N){let e=this._actor.getLevel().exploreCells(this._actor);if(this._actor.has("Telepathy")){const t=this._actor.getLevel().getID();this._actor.getList("Telepathy").forEach(s=>{const a=s.getTarget(),n=a.getLevel();if(r.default.isActorActive(a)&&n.getID()===t){const t=n.exploreCells(a);e=e.concat(t)}})}this._cache.seen=e}return this._cache.seen}getTargetActor(){const e=this.getTarget();if(Array.isArray(e)){const t=e;if(t.length>0)return t[0].getFirstActor()}else if(e.getFirstActor)return e.getFirstActor();return null}setSelectionObject(e){this._wantSelection=!0,this._selectionObject=e}selectionDone(){this._wantSelection=!1,this._selectionObject=null}decideNextAction(e){if(this._cache.seen=N,e.hasOwnProperty("cmd"))return this.resetBoosts(),this.handleCommand(e);const t=e.code;if(r.default.isNullOrUndef([t])&&r.default.err("Brain.Player","decideNextAction",`obj.code or obj.cmd must exist. Got obj: ${JSON.stringify(e)}`),this._wantConfirm&&null!==this._confirmCallback)return this.processConfirm(t);if(this._wantSelection)return this.processMenuSelection(t);const s=this._fsm.processKey(t);if(s!==w)return s;if(f.isMark(t))return this._markList.addMark(),this.noAction();if(f.isGoto(t))return this.setSelectionObject(this._markList.getMenu()),this.noAction();if(this._guiCallbacks.hasOwnProperty(t))return this._guiCallbacks[t](t);if(f.isRunMode(t))return this.toggleRunMode(),this.noAction();if(f.isFightMode(t))return this.toggleFightMode(),this.noAction();if(f.isIssueOrder(t))return this.issueOrderCmd(),this.noAction();if(f.isLook(t))return this.lookCmd(),this.noAction();if(f.isJump(t))return this.jumpCmd(),this.noAction();if(f.isUseAbility(t))return this.useAbility(),this.noAction();if(f.isGive(t))return this.giveCmd(),this.noAction();const a=this._actor.getLevel();let n=this._actor.getX(),o=this._actor.getY();const i=a.getMap(),l=i.getCell(n,o);if(f.isNextItem(t))return function(e){if(e.hasItems()){const t=e.getItems();let s=t[0].getName();if(t.length>1){const e=t.shift();t.push(e),s=t[0].getName(),r.default.gameMsg("You see now "+s+" on top of the heap.")}else r.default.gameMsg("You see only "+s+" here")}else r.default.gameMsg("There are no items here to look through")}(l),this.noAction();let c="NULL";if(f.inMoveCodeMap(t)){const e=f.getDiff(t,n,o);n=e[0],o=e[1],c="MOVE"}else this._restoreBaseSpeed();if("NULL"===c){if(this.resetBoosts(),f.isRest(t)&&(c="REST"),f.isPickup(t))return c="PICKUP",l.hasProp("items")?l.hasShop()?l.getShop().isAbandoned()?(this.energy=r.default.energy.PICKUP,()=>{const e=new h.Pickup;this._actor.add(e)}):(this._createBuyConfirmCallback(l),this.noAction()):(this.energy=r.default.energy.PICKUP,()=>{const e=new h.Pickup;this._actor.add(e)}):this.cmdNotPossible("There are no items to pick up.");if(f.isUseStairs(t))return c="STAIRS",l.hasConnection()?()=>{const e=new h.UseStairs;this._actor.add(e)}:this.cmdNotPossible("There are no stairs or passage here.");if(f.isToggleDoor(t))return this.tryToToggleDoor();if(f.isUsePower(t))return this.hasPowers()?(this._wantSelection=!0,this._selectionObject=this._actor.getBook().getSelectionObject(),r.default.gameMsg("Press 0-9 to make a selection.")):r.default.gameMsg("You have no powers to use."),this.noAction();if(f.isChat(t)&&(this._wantSelection=!0,this._selectionObject=v(this._actor)),f.isRead(t)){const e=new h.Read;return this._actor.add(e),y}}return"MOVE"===c?this.moveCmd(a,i,n,o):"REST"===c?(this.energy=r.default.energy.REST,this._actor.add(new h.Rest),y):this.noAction()}hasPowers(){return!!this._actor.getBook()}processConfirm(e){return this._wantConfirm=!1,f.isConfirmYes(e)?(this.energy=this._confirmEnergy,this._confirmCallback):(r.default.gameMsg("You cancel the action."),this.noAction())}processMenuSelection(e){if(o.Menu.isMenuItem(this._selectionObject)){this._selectionObject.showMsg&&this._selectionObject.showMsg();const t=this._selectionObject.select(e);if(o.Menu.isSelectionDone(t))return this.selectionDone(),t;if(o.Menu.isMenuItem(t)){this._selectionObject=t;const e=t;return e.funcToCall?(this.selectionDone(),e.funcToCall()):this.noAction()}}return this.selectionDone(),r.default.gameMsg("You cancel the action."),this.noAction()}moveCmd(e,t,s,a){if(!t.hasXY(s,a)){if(this._actor.getCell().hasPassage()){const e=()=>{const e=new h.UseStairs;this._actor.add(e)},t="Press 'y' to move to another area";return this.setWantConfirm(r.default.energy.MOVE,e,t),this.noAction()}{const e="You cannot move there.";return this.cmdNotPossible(e)}}if(t.isPassable(s,a))return this.moveToCell(s,a,e);if(t.getCell(s,a).hasClosedDoor())return this.tryToToggleDoor();if(t.getCell(s,a).hasActors()){this._restoreBaseSpeed();const e=function(e,t,s){const a=e.getCell(t,s).getProp("actors");for(let e=0;e<a.length;e++)if(!a[e].has("Ethereal"))return a[e];return null}(t,s,a);null===e&&r.default.err("Brain.Player","decideNextAction","Null target for attack x,y: "+s+","+a);const n=()=>{this._setAttackStats();const t=new h.Attack({target:e});this._actor.add(t)};if(e.isEnemy(this._actor))return this.energy=r.default.energy.ATTACK,n;{const t=`Press 'y' to attack non-hostile ${e.getName()}`;return this.setWantConfirm(r.default.energy.ATTACK,n,t),this.noAction()}}if(this._actor.has("Flying")&&t.isPassableByAir(s,a))return this._restoreBaseSpeed(),this.moveToCell(s,a,e);{const e=r.default.getImpassableMsg(this._actor,t.getCell(s,a),"You");return this.cmdNotPossible(e)}}moveToCell(e,t,s){return this._runModeEnabled?this.energy=r.default.energy.RUN:(this.resetBoosts(),this.energy=r.default.energy.MOVE),()=>{const a=new h.Movement(e,t,s);this._actor.add(a)}}setWantConfirm(e,t,s){this._confirmEnergy=e,this._wantConfirm=!0,this._confirmCallback=t,s&&r.default.gameMsg(s)}issueOrderCmd(){const e=[["Follow me",this.giveOrder.bind(this,"Follow")],["Attack enemy",this.giveOrder.bind(this,"Attack")],["Pickup an item",this.giveOrder.bind(this,"Pickup")],["Forget my orders",this.giveOrder.bind(this,"Forget")]],t=new o.Menu.WithQuit(e);t.onQuit=this.cancelTargeting.bind(this);const s=[{key:i.Keys.KEY.SELECT,menu:t}];r.default.gameMsg(E);const a=new o.Menu.SelectCell(s);a.enableSelectAll(),a.setCallback(this.selectCell.bind(this)),this.setSelectionObject(a),this.selectCell()}lookCmd(){const e=[{key:i.Keys.KEY.SELECT,funcToCall:this.showSelectedCellInfo.bind(this)}];r.default.gameMsg(S);const t=new o.Menu.SelectCell(e);t.setCallback(this.selectCell.bind(this)),this.setSelectionObject(t),this._fsm.startLooking(),this.selectCell()}giveCmd(){const e=new o.Menu.SelectDir;e.setCallback(this.giveCallback.bind(this)),this.setSelectionObject(e),r.default.gameMsg("Please select direction to giving an item:")}giveCallback(e){const[t,s]=r.default.newXYFromDir(e,this._actor),a=this._actor.getLevel().getMap().getCell(t,s);if(a.hasActors()){const e=a.getFirstActor(),t=this._actor.getInvEq().getInventory().getItems().map(t=>[t.toString(),this.giveItemToActor.bind(this,t,e)]),s=new o.Menu.WithQuit(t);s.addPre("Select an item to give:"),this.setSelectionObject(s)}else r.default.gameDanger("There is no one there")}giveItemToActor(e,t){const s=new h.Give;s.setGiveTarget(t),s.setItem(e),this._actor.add(s)}jumpCmd(){const e=new o.Menu.SelectDir;e.setCallback(this.jumpCallback.bind(this)),this.setSelectionObject(e),r.default.gameMsg("Please select direction to jump")}jumpCallback(e){this.energy=r.default.energy.JUMP;const[t,s]=e,a=new h.Jump;a.setX(t),a.setY(s),this._actor.add(a)}giveOrder(e){const t=this.getTarget();t.forEach(s=>{if(s.hasActors()){const t=s.getActors()[0],a=t.getBrain();if(t&&a.getGoal)switch(e){case"Follow":this.giveFollowOrder(t);break;case"Forget":this.forgetOrders(t);break;case"Attack":this.giveOrderAttack(t);break;case"Pickup":this.giveOrderPickup(t)}}else 1===t.length&&r.default.gameDanger("This cell has no valid targets")}),this.setSelectedCells(null)}giveFollowOrder(e){const t=e.getName(),s={bias:.7,src:this._actor};l.giveFollowOrder(e,s),r.default.gameMsg(`You tell ${t} to follow you`)}forgetOrders(e){const t={bias:.7,src:this._actor};l.giveClearOrders(e,t),r.default.gameMsg(`You tell ${name} to forget your orders`)}giveOrderAttack(e){const t=this.getSeenCells(),s=r.default.findEnemyCellForActor(this._actor,t);if(0===s.length)return void r.default.gameMsg("There are no enemies around.");const a=s[this.getCellIndexToTarget(s)];if(a){const t=e.getName(),s=a.getActors()[0],n=s.getName(),o={bias:this.getOrderBias(),enemy:s,src:this._actor};l.giveAttackOrder(e,o),r.default.gameMsg(`You tell ${t} to attack ${n}`)}else r.default.gameMsg("There are no enemies around.")}giveOrderPickup(e){const t=this.getItemInSight(),s=e.getName();if(t){const a=t.getName(),n={bias:this.getOrderBias(),item:t,src:this._actor};l.givePickupOrder(e,n),r.default.gameMsg(`You tell ${s} to pickup ${a}`)}else r.default.gameMsg(`There are no items for ${s} to pickup`)}getOrderBias(){return this._actor.has("Leader")?1:this._actor.has("Commander")?1.5:.7}useAbility(){if(this._actor.has("Abilities")){const e=this._actor.get("Abilities").createMenu();this.setSelectionObject(e)}else r.default.gameMsg("You have no abilities to use")}addMark(e){this._markList.addMark(e)}getItemInSight(){const e=this.getSeenCells().filter(e=>e.hasItems());return e.length>0?m.arrayGetRand(e).getItems()[0]:null}toJSON(){return{type:this.getType(),memory:this._memory.toJSON(),markList:this._markList.toJSON()}}addEnemy(){}addFriend(){}hasTargetSelected(){return this._fsm.hasTargetSelected()}startTargeting(){this._fsm.startTargeting()}nextTarget(){this._fsm.nextTarget()}getTargetList(){return this._fsm.getTargetList()}getSelectedCells(){return this._fsm.getSelectedCells()}prevTarget(){this._fsm.prevTarget()}getTarget(){return this._fsm.getTarget()}isTargetInRange(){return this._fsm.isTargetInRange()}cancelTargeting(){this._fsm.cancelTargeting()}isTargeting(){return this._fsm.isTargeting()}getCellIndexToTarget(e){return this._fsm.getCellIndexToTarget(e)}setSelectedCells(e){e?this._fsm.setSelectedCells(e):this.cancelTargeting()}selectCell(e){this._fsm.selectCell(e)}showSelectedCellInfo(){this._fsm.stopLooking()}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0));class r{constructor(e,t){this._type=e,this._item=null,this._hasItem=!1,this._unequipped=null,this._stacked=!1,n.default.isNullOrUndef([t])||(this._stacked=t)}isStacked(){return this._stacked}getUnequipped(){return this._unequipped}getItem(){return this._hasItem?this._item:null}hasItem(){return this._hasItem}equipItem(e){return!!this.canEquip(e)&&(this._stacked&&this._hasItem?n.default.addStackedItems(this._item,e)&&(this._hasItem=!0):(e.setOwner(this),this._item=e,this._hasItem=!0),this._hasItem)}unequipItem(e){if(this._hasItem){if(!this._stacked)return this._hasItem=!1,this._unequipped=this._item,!0;if(e>0)return 1===e&&1===this._item.getCount()?(this._hasItem=!1,this._unequipped=this._item):e===this._item.getCount()?(this._hasItem=!1,this._unequipped=this._item):this._unequipped=n.default.removeStackedItems(this._item,e),!0}return!1}canEquip(e){return!this._hasItem||!!this._stacked&&e.equals(this._item)}}t.EquipSlot=r;const o=["getDefense","getAttack","getProtection","getSpeed"].concat(n.default.GET_STATS);t.Equipment=class{constructor(e){this._actor=e,this._slots={chest:new r("chest"),feet:new r("feet"),hand:new r("hand"),head:new r("head"),missile:new r("missile",!0),missileweapon:new r("missileweapon"),neck:new r("neck"),shield:new r("shield"),spiritgem:new r("spiritgem")};for(let e=0;e<o.length;e++){const t=()=>()=>this.propertySum(o[e]);this[o[e]]=t()}}addSlot(e,t){if(this._hasSlot(e))if(Array.isArray(this._slots[e]))this._slots[e].push(t);else{const s=[this._slots[e]];s.push(t),this._slots[e]=s}else this._slots[e]=t}getWeight(){let e=0;const t=this.getEquippedItems();for(let s=0;s<t.length;s++)e+=t[s].getWeight()*t[s].getCount();return this._actor.has("MasterEquipper")&&(e*=this._actor.get("MasterEquipper").getFactor()),e}getNumSlots(e){return this._hasSlot(e)?Array.isArray(this._slots[e])?this._slots[e].length:1:0}getSlotTypes(){return Object.keys(this._slots)}getItems(e){return this._hasSlot(e)?Array.isArray(this._slots[e])?this._slots[e]:[this._slots[e]]:this.getEquippedItems()}getUnequipped(e,t){if(this._hasSlot(e)){const s=this._slots[e];return Array.isArray(s)?s[t].getUnequipped():this._slots[e].getUnequipped()}return n.default.err("Equipment","getUnequipped","No slot type: "+e),null}getItem(e){if(this._hasSlot(e)){const t=this._slots[e];return Array.isArray(t)?t.map(e=>e.getItem()):this._slots[e].getItem()}return null}equipItem(e){return e.getArmourType?this._equipToSlotType(e.getArmourType(),e):/^(missile|ammo)$/.test(e.getType())?!!this._slots.missile.equipItem(e):"missileweapon"===e.getType()?this._equipToSlotType("missileweapon",e):this._equipToSlotType("hand",e)}_equipToSlotType(e,t){const s=this._slots[e];if(Array.isArray(s)){for(let e=0;e<s.length;e++)if(s[e].equipItem(t))return!0}else if(s.equipItem(t))return!0;return!1}isEquipped(e){return-1!==this.getItems().indexOf(e)}getEquipped(e){return this.getItem(e)}getEquippedItems(){const e=[];return Object.values(this._slots).forEach(t=>{Array.isArray(t)?t.forEach(t=>{t.hasItem()&&e.push(t.getItem())}):t.hasItem()&&e.push(t.getItem())}),e}unequipItem(e,t,s){if(this._hasSlot(e)){const a=this._slots[e];if(!Array.isArray(a))return this._slots[e].unequipItem(t);if(s>=0){if(a[s].unequipItem(t))return!0}else for(let e=0;e<a.length;e++)if(a[e].unequipItem(t))return!0}else{const t="Non-existing slot type "+e;n.default.err("Equipment","unequipItem",t)}return!1}toJSON(){const e=[],t=this.getEquippedItems();for(let s=0;s<t.length;s++)e.push(t[s].toJSON());return e}propertySum(e){let t=0;return Object.keys(this._slots).forEach(s=>{let a=this._slots[s];Array.isArray(a)||(a=[a]),a.forEach(s=>{const a=s.getItem();t+=n.default.getItemStat(e,a)})}),t}_hasSlot(e){return this._slots.hasOwnProperty(e)}}},function(e,t,s){"use strict";var a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const n=s(30),r=s(42),o=a(s(13));t.BrainWeather=class extends r.BrainBase{constructor(e){super(e),this.setType("Weather"),this.updateFreq=10}decideNextAction(e){--this.updateFreq;const t=this._actor.getLevel();if(0===this.updateFreq&&t.has("Weather")){const e=t.get("Weather").getWeatherType(),s=new o.WeatherEffect;s.setEffectType(e),this._actor.add(s),this.updateFreq=10}return n.ACTION_ALREADY_DONE}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0));t.Constraints=class{getConstraints(e){if(Array.isArray(e)){const t=e.map(e=>this.getFunc(e.op,e.prop,e.value)),s=function(e){let s=!0;return t.forEach(t=>{s=s&&t(e)}),s};return s.constraint=e,s}if("object"==typeof e){const{op:t,prop:s,value:a}=e;return this.getFunc(t,s,a)}{const t=`Param must be array/object. Got: ${e}`;n.default.err("Constrains","getConstraints",t)}return null}getFunc(e,t,s){if(Array.isArray(s)){const a=s.map(s=>this.getFunc(e,t,s)),n=function(e){let t=!1;return a.forEach(s=>{t=t||s(e)}),t};return n.constraint={op:e,prop:t,value:s},n}{let a=()=>!1;switch(e){case"==":case"===":case"eq":a=(e=>e[t]===s);break;case"!=":case"!==":case"neq":a=(e=>e[t]!==s);break;case">=":case"gte":a=(e=>e[t]>=s);break;case"<=":case"lte":a=(e=>e[t]<=s);break;case">":case"gt":a=(e=>e[t]>s);break;case"<":case"lt":a=(e=>e[t]<s);break;case"match":a=(e=>new RegExp(s).test(e[t]));break;default:n.default.err("Constraints","getFunc",`Unsupported op ${e} given`)}return a.constraint={op:e,prop:t,value:s},a}}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0));t.meleeHitDamage=((e,t,s)=>({addComp:"DirectDamage",func:[{setter:"setDamage",value:e},{setter:"setDamageType",value:n.default.DMG[s]},{setter:"setDamageCateg",value:n.default.DMG.MELEE}],duration:t})),t.color=function(e,t){return{fg:e,bg:t}};const r=new Set(["addComp","spells","inv","equip"]),o=new Set(["hp","maxHP","pp","maxPP","defense","protection","attack","danger","speed"].concat(n.default.STATS_LC));function i(e,t,s,a){r.has(e)?s.hasOwnProperty(e)?s[e]=s[e].concat(t[e]):s[e]=t[e].slice():Array.isArray(t[e])?s[e]=t[e].slice():"object"==typeof t[e]?s[e]=JSON.parse(JSON.stringify(t[e])):o.has(e)?function(e,t,s){s.hasOwnProperty(e)?s[e]+=t[e]:s[e]=t[e]}(e,t,s):s[e]=t[e]}t.mixNewShell=function(e,t){const s={};return e.forEach(e=>{for(const a in e)e.hasOwnProperty(a)&&i(a,e,s,t)}),s}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(43),o=s(1),i=s(26),l=s(72),c=s(8)("bitn:goals-top"),{GOAL_COMPLETED:h,GOAL_INACTIVE:u,GOAL_FAILED:d}=r.GoalStatus,g=o.Random.getRNG();t.GoalsTop={};class p extends r.Goal.Base{constructor(e){super(e),this.setType("GoalTop"),this.evaluators=[]}removeEvaluators(){this.evaluators=[]}addEvaluator(e){this.evaluators.push(e)}activate(){this.arbitrate()}getEvaluator(e){return this.evaluators.find(t=>t.getType()===e)}arbitrate(){this.dbg("arbitrate() started"),0===this.evaluators.length&&n.default.err("GoalTop","arbitrate",`No evaluators in ${this.getType}, actor: ${this.actor}`);let e=0,t=null;this.evaluators.forEach(s=>{const a=s.calculateDesirability(this.actor);(e<a||null===t)&&(t=s,e=a)}),t?t.setActorGoal(this.actor):n.default.err("GoalTop","arbitrate","No next goal found"),this.dbg("arbitrate() finished")}process(){this.activateIfInactive();const e=this.processSubGoals();return e===h||e===d?u:(this.removeFinishedOrFailed(),this.dbg(`process() got status ${e}`),e)}setBias(e){Object.keys(e).forEach(t=>{const s=this.evaluators.find(e=>e.getType()===t);if(s)s.setBias(e[t]);else{const e=this.evaluators.map(e=>e.getType()),s=`Bias ${t} not matching any evaluator: ${e}`;n.default.warn("GoalTop","setBias",s)}})}toJSON(){const e=[];return this.evaluators.forEach(t=>{"Order"!==t.getType()&&e.push(t.toJSON())}),{type:this.getType(),evaluators:e}}}t.GoalTop=p,t.GoalsTop.Top=p;class m extends p{constructor(e){super(e),this.setType("ThinkBasic");const[t,s]=[.5,1.5];this.bias={attack:g.getUniformRange(t,s),explore:n.default.BIAS.Explore,flee:n.default.BIAS.Flee,order:n.default.BIAS.Order,patrol:n.default.BIAS.Patrol},this.updateEvaluators()}updateEvaluators(){this.removeEvaluators(),this.evaluators.push(new i.Evaluator.AttackActor(this.bias.attack)),this.evaluators.push(new i.Evaluator.Flee(this.bias.flee)),this.evaluators.push(new i.Evaluator.Explore(this.bias.explore))}giveOrders(e){this.dbg("Received an order!!",e),this.addEvaluator(e)}clearOrders(){this.evaluators.filter(e=>e.isOrder()).forEach(e=>{e.goal.isActive()&&e.goal.terminate();const t=this.evaluators.indexOf(e);this.evaluators.splice(t,1)})}addGoal(e){const t=e.getType();this.dbg(`addGoal() ${t}`),this.isGoalPresent(t)||(this.removeSubGoalsOfType(t),this.addSubGoal(e),c.enabled&&n.default.log("Actor subgoals are now: "+this.subGoals.map(e=>e.getType())))}}t.ThinkBasic=m,t.GoalsTop.ThinkBasic=m;class f extends m{constructor(e){super(e),this.setType("ThinkSpellcaster"),this.bias.castSpell=1,this.evaluators.push(new i.Evaluator.CastSpell(this.bias.castSpell))}}t.ThinkSpellcaster=f,t.GoalsTop.ThinkSpellcaster=f;class y extends m{constructor(e){super(e),this.setType("ThinkCommander"),this.bias.attack=.1,this.bias.winBattle=.8,this.bias.retreat=.3,this.updateEvaluators()}updateEvaluators(){super.updateEvaluators();const e=new l.EvaluatorsBattle.WinBattle(this.bias.winBattle);this.evaluators.push(e);const t=new l.EvaluatorsBattle.Retreat(this.bias.retreat);this.evaluators.push(t)}}t.ThinkCommander=y,t.GoalsTop.ThinkCommander=y},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(1),i=n(s(22)),l=n(s(13)),c=o.Random.getRNG();t.Ability={};class h{constructor(e){this.name=e}getName(){return this.name}getMenuItem(){return[this.getName(),this.activate.bind(this)]}activate(e){const t=this.getName();r.default.err("Ability.Base","activate",`${t} should implement activate()`)}}t.AbilityBase=h,t.Ability.Base=h;class u extends h{constructor(e){super("Self")}getMenuItem(){return[this.getName(),this.activate.bind(this)]}}t.Self=u,t.Ability.Self=u;class d extends h{constructor(e){super("Camouflage")}activate(){this.actor.add(new l.Camouflage)}}t.Camouflage=d,t.Ability.Camouflage=d,t.Direction=function(){t.Ability.Base.call(this,name)},r.default.extend2(t.Direction,t.Ability.Base),t.Area=function(){t.Ability.Base.call(this,name)},r.default.extend2(t.Area,t.Ability.Base);class g extends h{constructor(e){super(e)}activate(e){const t=JSON.stringify(e);r.default.err("Ability.Item","activate","Not impl. in base class. Called with: "+t)}getMenuItem(){const e=this.actor.getInvEq().getInventory().getItems().map(e=>[e.toString(),this.activate.bind(this,e)]),t=new i.MenuWithQuit(e);return t.addPre("Select an item to sharpen:"),[this.getName(),t]}}t.Item=g,t.Ability.Item=g;class p extends t.Ability.Item{constructor(){super("Sharpener")}activate(e){const t=e.getName();if(e.has("Sharpened"))r.default.gameMsg(`${t} has already been sharpened`);else if(e.getDamageDie){e.add(new l.Sharpened);const s=c.getUniformInt(1,3),a=e.getDamageDie();a.setMod(a.getMod()+s),e.setValue(e.getValue()+10*s),r.default.gameMsg(`You sharpen ${t}`)}else r.default.gameMsg(`It's useless to sharpen ${t}`)}}t.Sharpener=p,t.Ability.Sharpener=p;class m{constructor(e){this.actor=e,this.abilities={}}getMenu(){const e=Object.values(this.abilities).map(e=>e.getMenuItem()),t=new i.MenuWithQuit(e);return t.setName("MenuAbilities"),t.addPre("Select an ability to use:"),t}addAbility(e){this.abilities[e.getName()]=e,e.actor=this.actor}toJSON(){return Object.keys(this.abilities)}}t.Abilities=m,t.Ability.Abilities=m},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(22),i=n(s(2)),l=s(70),c=s(1),h=s(57),u=s(52),d=s(6),{Abilities:g}=h.Ability,p=c.Random.getRNG();t.ActorClass={},t.ActorClass.create=function(e,s){if(t.ActorClass.hasOwnProperty(e)){return new t.ActorClass[e](s)}return r.default.diag("Called with entity:"),r.default.diag(s),r.default.err("ActorClass","create",`No class ${e} in ActorClass`),null},t.ActorClass.getLevelUpObject=function(e,t){const s=new o.MenuInfoOnly,a=t.getActor(),n=t.getClassName(),r=t.getLevelUpMsg(e),i=`${a.getName()} is now level ${e} ${n}`;return s.addPre([`Congratulations! ${i}`]),s.addPre(r),s},t.ActorClass.addAbility=function(e,t){let s=null;if(s=t.has("Abilities")?t.get("Abilities").abilities:new g,h.Ability.hasOwnProperty(e)){const t=new h.Ability[e];s.addAbility(t)}else r.default.err("ActorClass","addAbility",`Cannot find Ability.${e} for new`)};t.ActorClass.startingItems={Alpinist:[{name:"Ration",count:1},{name:"rope",count:1},{func:e=>"mineral"===e.type,count:2}],Adventurer:[{name:"Ration",count:2},{name:"firemaking kit",count:1},{func:e=>"potion"===e.type,count:1}],Cryomancer:[{name:"Ration",count:1},{name:"Potion of power",count:1}],Marksman:[{name:"Ration",count:1}],Blademaster:[{name:"Ration",count:1}],Spiritcrafter:[{name:"Ration",count:1},{name:"Ordinary spirit gem"},{name:"Potion of spirit form"}],Spellsinger:[{name:"Ration",count:1},{name:"Potion of eagle",count:1}]};t.ActorClass.equipment={Alpinist:[{name:"Piolet",count:1},{name:"Spiked boots",count:1}],Adventurer:[{name:"Short sword",count:1},{name:"Leather armour",count:1}],Cryomancer:[{name:"Robe",count:1},{name:"Wooden staff",count:1}],Marksman:[{name:"Leather armour",count:1},{name:"Wooden bow",count:1},{name:"Wooden arrow",count:15}],Blademaster:[{name:"Longsword",count:1},{name:"Chain helmet",count:1},{name:"Chain armour",count:1}],Spiritcrafter:[{name:"Robe",count:1},{name:"Mace",count:1}],Spellsinger:[{name:"Iron staff",count:1},{name:"Leather armour",count:1}]},t.ActorClass.getEquipment=function(e){return b(t.ActorClass.equipment[e])},t.ActorClass.getStartingItems=function(e){return b(t.ActorClass.startingItems[e])};class m{constructor(e,t){this._actor=e,e.setActorClass(this),this._className=t}getActor(){return this._actor}getClassName(){return this._className}getLevelUpMsg(e){let t="";return this._messages.hasOwnProperty(e)&&(t+=this._messages[e]),t+=`\n${this._lastStateIncr}`}advanceLevel(){const e=this._actor.get("Experience").getExpLevel();if(this._messages.hasOwnProperty(e)){const t=this._actor.getCell();t&&r.default.gameMsg({cell:t,msg:this._messages[e]})}this._advances.hasOwnProperty(e)&&this._advances[e](),this.incrStats(e)}incrStats(e){const t=this._actor;this._lastStateIncr="";const s=t.get("Health"),a=Math.ceil(t.getStrength()/2);if(s.setMaxHP(s.getMaxHP()+a),s.setHP(s.getHP()+a),t.has("SpellPower")){const e=Math.ceil(t.getMagic()/2),s=t.get("SpellPower");s.setMaxPP(s.getMaxPP()+e),s.addPP(e)}const n=p.arrayGetRand(r.default.STATS);this._lastStateIncr=`${n} was increased`,t.get("Stats").incrStat(n,1),r.default.levelUpCombatStats(t,e)}}t.ActorClassBase=m;class f extends m{constructor(e){super(e,"Alpinist");const s=e.getName();this._messages={4:`${s} can climb on difficult terrain now`,8:`${s} can jump over obstacles such as chasms now`,12:`${s} can now hide from enemies using terrain`},this._advances={1:()=>{},4:()=>{this._actor.add(new i.Climber)},8:()=>{this._actor.add(new i.Jumper)},12:()=>{t.ActorClass.addAbility("Camouflage",this._actor)},16:()=>{},20:()=>{},24:()=>{},28:()=>{},32:()=>{}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("perception",3),e.incrStat("agility",3),e.incrStat("magic",-2)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("perception",1),this._lastStateIncr+="\nPerception was increased."),e%3!=1&&(t.incrStat("agility",1),this._lastStateIncr+="\nAgility was increased.")}}t.Alpinist=f,t.ActorClass.Alpinist=f;class y extends m{constructor(e){super(e,"Adventurer");const t=e.getName();this._messages={4:`Food is now more nourishing for ${t}`},this._advances={1:()=>{const e=new l.Spell.SpellBook(this._actor);this._actor.setBook(e)},4:()=>{this._actor.add(new i.NourishedOne)}}}advanceLevel(){super.advanceLevel();const e=this._actor.get("Experience").getExpLevel();if(e%4==0&&!this._advances.hasOwnProperty(e)){const s=p.arrayGetRand(t.ACTOR_CLASSES_NO_ADV),a=new t.ActorClass[s](this.getActor());a.advanceLevel(),this._messages[e]=a._messages[e]}}setStartingStats(){const e=this._actor.get("Stats");for(let t=0;t<3;t++){let t=p.arrayGetRand(r.default.STATS);t=t.toLowerCase(),e.incrStat(t,p.getUniformInt(1,3))}}incrStats(e){super.incrStats(e);const t=p.arrayGetRand(r.default.STATS);this._lastStateIncr+=`\n${t} was increased.`,this._actor.get("Stats").incrStat(t,1)}}t.Adventurer=y,t.ActorClass.Adventurer=y;class _ extends m{constructor(e){super(e,"Blademaster");const s=e.getName();this._messages={4:`${s} knows now how to defend more skillfully`,8:`${s} knows now how to hit enemies more accurately`,12:`${s} knows now how to handle equipment better`,16:`${s} can now strike in two directions`,20:`${s} can now keep the weapons sharp`,24:`${s} can now wield two blades at once`,28:`${s} can now strike back immediately when attacked`,32:`${s} has become a True Blademaster`},this._advances={1:()=>{},4:()=>{this._actor.add(new i.Defender)},8:()=>{this._actor.add(new i.Attacker)},12:()=>{this._actor.add(new i.MasterEquipper)},16:()=>{this._actor.add(new i.BiDirStrike)},20:()=>{this._actor.add(new i.Sharpener),t.ActorClass.addAbility("Sharpener",this._actor)},24:()=>{this._actor.add(new i.Ambidexterity)},28:()=>{this._actor.add(new i.CounterAttack)},32:()=>{this._actor.get("Combat").setAttackRange(2),this._actor.add(new i.LongReach)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("strength",3),e.incrStat("magic",-3)}getLevelUpMsg(e){return super.getLevelUpMsg(e)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("strength",1),this._lastStateIncr+="\nStrength was increased."),e%3==0&&(t.incrStat("accuracy",1),this._lastStateIncr+="\nAccuracy was increased.")}}t.Blademaster=_,t.ActorClass.Blademaster=_;class E extends m{constructor(e){super(e,"Cryomancer");const t=e.getName();this._messages={4:`${t} learns a protection spell`,8:`${t} learns a spell to attack enemies from distance`,12:`${t} can freeze enemies on their tracks`,16:`${t} can summon an ice companion now`,20:`${t} can drain power from other spellcasters`,24:`${t} can fire ice arrows towards enemies`,28:`${t} can control their enemies now`,32:`${t} has become a True Cryomancer, Harbinger of Blizzard`},this._advances={1:()=>{const e=new l.Spell.SpellBook(this._actor),t=new l.Spell.GraspOfWinter;e.addSpell(t),this._actor.setBook(e)},4:()=>{this._actor.getBook().addSpell(new l.Spell.IceShield)},8:()=>{this._actor.getBook().addSpell(new l.Spell.FrostBolt)},12:()=>{this._actor.getBook().addSpell(new l.Spell.IcyPrison)},16:()=>{this._actor.getBook().addSpell(new l.Spell.SummonIceMinion)},20:()=>{this._actor.getBook().addSpell(new l.Spell.PowerDrain)},24:()=>{this._actor.getBook().addSpell(new l.Spell.IceArrow)},28:()=>{this._actor.getBook().addSpell(new l.Spell.MindControl)},32:()=>{this._actor.getBook().addSpell(new l.Spell.Blizzard)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("strength",-2),e.incrStat("magic",3)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("magic",1),this._lastStateIncr+="\nMagic was increased."),e%3==0&&(t.incrStat("willpower",1),this._lastStateIncr+="\nWillpower was increased.")}}t.Cryomancer=E,t.ActorClass.Cryomancer=E;class S extends m{constructor(e){super(e,"Marksman");const t=e.getName();this._messages={4:`${t} can now see and shoot further`,8:`${t} deals now more damage with each shot`,12:`${t} can bypass enemies with ranged attacks`,16:`${t} can use arrows/bolts interchangeably`,20:`${t} can shoot even further`,24:`${t} can evade ranged attacks`,28:`${t} can shoot enemies critically`,32:`${t} has become a True Marksman`},this._advances={1:()=>{},4:()=>{this._actor.add(new i.EagleEye)},8:()=>{this._actor.add(new i.StrongShot)},12:()=>{this._actor.add(new i.ThroughShot)},16:()=>{this._actor.add(new i.MixedShot)},20:()=>{this._actor.add(new i.LongRangeShot)},24:()=>{this._actor.add(new i.RangedEvasion)},28:()=>{this._actor.add(new i.CriticalShot)},32:()=>{this._actor.add(new i.DoubleShot)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("accuracy",3),e.incrStat("perception",2),e.incrStat("magic",-3)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("accuracy",1),this._lastStateIncr+="\nAccuracy was increased."),e%3==0&&(t.incrStat("perception",1),this._lastStateIncr+="\nPerception was increased."),e%3==1&&(t.incrStat("agility",1),this._lastStateIncr+="\nAgility was increased.")}}t.Marksman=S,t.ActorClass.Marksman=S;class v extends m{constructor(e){super(e,"Spellsinger");const t=e.getName();this._messages={4:`${t} can now summon animals`,8:`${t} can heal wounds`,12:`${t} can fly like an eagle`,16:`${t} can now paralyse enemies`,20:`${t} can summon lightning on enemies`,24:`${t} controls powers of the sky`,28:`${t} can attack enemies in multiple directions`,32:`${t} has become a Mighty Spellsinger`},this._advances={1:()=>{const e=new l.Spell.SpellBook(this._actor);this._actor.setBook(e),this._actor.getBook().addSpell(new l.Spell.MagicArmor)},4:()=>{this._actor.getBook().addSpell(new l.Spell.SummonAnimal)},8:()=>{this._actor.getBook().addSpell(new l.Spell.Heal)},12:()=>{this._actor.getBook().addSpell(new l.Spell.Flying)},16:()=>{this._actor.getBook().addSpell(new l.Spell.Paralysis)},20:()=>{this._actor.getBook().addSpell(new l.Spell.LightningArrow)},24:()=>{const e=new l.Spell.SummonAirElemental;this._actor.getBook().addSpell(e)},28:()=>{this._actor.getBook().addSpell(new l.Spell.CrossBolt)},32:()=>{this._actor.getBook().addSpell(new l.Spell.RockStorm)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("perception",2),e.incrStat("magic",2)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("magic",1),this._lastStateIncr+="\nMagic was increased."),e%3==0&&(t.incrStat("perception",1),this._lastStateIncr+="\nPerception was increased.")}}t.Spellsinger=v,t.ActorClass.Spellsinger=v;class C extends m{constructor(e){super(e,"Spiritcrafter");const t=e.getName();this._messages={4:`${t} can now equip 2 spirit gems`,8:`${t} learns to project small amounts of energy`,12:`${t} learns to create protective forcefields`,16:`${t} can now equip 3 spirit gems`,20:`${t} can now bind spirit gems to items`,24:`${t} can take a spirit form now`,28:`${t} gains new skill`,32:`${t} has become a Mighty Spiritcrafter`},this._advances={1:()=>{const e=new l.Spell.SpellBook(this._actor);this._actor.setBook(e)},4:()=>{this.getActor().getInvEq().getEquipment().addSlot("spiritgem",new u.EquipSlot("spiritgem"))},8:()=>{this._actor.getBook().addSpell(new l.Spell.EnergyArrow)},12:()=>{this._actor.getBook().addSpell(new l.Spell.ForceField)},16:()=>{this.getActor().getInvEq().getEquipment().addSlot("spiritgem",new u.EquipSlot("spiritgem"))},20:()=>{this._actor.add(new i.SpiritItemCrafter)},24:()=>{this._actor.getBook().addSpell(new l.Spell.SpiritForm)},28:()=>{this._actor.getBook().addSpell(new l.Spell.EnergyStorm)},32:()=>{this.getActor().getInvEq().getEquipment().addSlot("spiritgem",new u.EquipSlot("spiritgem")),this._actor.getBook().addSpell(new l.Spell.RingOfEnergy)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("willpower",4),e.incrStat("magic",2)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("willpower",1),this._lastStateIncr+="\nWillpower was increased."),e%3==0&&(t.incrStat("magic",1),this._lastStateIncr+="\nMagic was increased.")}}function b(e){const t=d.ObjectShell.getParser(),s=[];return e.forEach(e=>{if("function"==typeof e){const a=t.createRandomItem(e);s.push({name:a.getName(),count:1})}else if(e.func){const a=t.createRandomItem(e.func);e.count?s.push({name:a.getName(),count:e.count}):s.push({name:a.getName(),count:1})}else s.push(e)}),s}t.Spiritcrafter=C,t.ActorClass.Spiritcrafter=C,t.ACTOR_CLASSES=["Cryomancer","Blademaster","Marksman","Spiritcrafter","Adventurer","Alpinist","Spellsinger"],t.ACTOR_CLASSES_NO_ADV=t.ACTOR_CLASSES.filter(e=>"Adventurer"!==e)},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(7),o=s(9),i=s(8)("bitn:game.battle"),l=r.EventPool.getPool();t.Army=class{constructor(e){this._name=e,this._actors=[],this._battle=null,this._casualties=0,this._defeatThreshold=0,this.hasNotify=!0,l.listenEvent(n.default.EVT_ACTOR_KILLED,this)}getName(){return this._name}setDefeatThreshold(e){this._defeatThreshold=e}isDefeated(){return this._actors.length<=this._defeatThreshold}setBattle(e){this._battle=e}getBattle(){return this._battle}getCasualties(){return this._casualties}getActors(){return this._actors.slice()}hasActor(e){const t=e.getID();return this._actors.findIndex(e=>e.getID()===t)>=0}addActor(e){return this.hasActor(e)?(n.default.err("Game.Army","addActor","Actor already in army "+this.getName()),!1):(this._actors.push(e),!0)}removeActor(e){const t=this._actors.findIndex(t=>t.getID()===e.getID());return t>=0&&(this._actors.splice(t,1),!0)}removeAllActors(){this._actors=[]}notify(e,t){if(e===n.default.EVT_ACTOR_KILLED){i(`${this._name} got EVT_ACTOR_KILLED`);const e=t.actor;if(this.hasActor(e))if(this.removeActor(e)){++this._casualties;let t=`Battle: ${this.getBattle().getName()}, Army ${this._name}`;t+=` Actor: ${e.getID()}`,i(`\tCasualties: ${this._casualties} ${t}`);const s={type:"Actor killed",army:this};i(`${this._name} emit EVT_ARMY_EVENT`),l.emitEvent(n.default.EVT_ARMY_EVENT,s),0===this._actors.length&&(i("<>Army<> "+this._name+" decimated"),i(`\tCasualties: ${this._casualties}`),l.removeListener(this))}else{let t="Battle: "+this.getBattle().getName();t+="Couldn't remove the actor "+e.getName(),n.default.err("Game.Army","notify",t)}}}toJSON(){return{name:this._name,actors:this._actors.map(e=>e.getID()),defeatThreshold:this._defeatThreshold}}};t.Battle=class{constructor(e){this._name=e,this._armies=[],this._level=null,this.finished=!1,this._stats={duration:0,casualties:0,survivors:0},this.hasNotify=!0,l.listenEvent(n.default.EVT_ARMY_EVENT,this)}getType(){return"battle"}getArmies(){return this._armies.slice()}setArmies(e){this._armies=e,this._armies.forEach(e=>{e.setBattle(this)})}getName(){return this._name}setLevel(e){this._level=e,this._level.setParent(this)}getLevel(){return this._level}getStats(){return this._stats}setStats(e){this._stats=e}addArmy(e,t,s,a){const r=!!a.horizontal,o=a.numRows>0?a.numRows:1;if(n.default.isNullOrUndef([this._level]))n.default.err("Game.Battle","addArmy","Level must exist before adding army.");else{this._armies.push(e);const a=e.getActors(),n=Math.ceil(a.length/o);if(r){let e=0;for(let r=0;r<o;r++)for(let o=0;o<n;o++)e<a.length&&this.addActor(a[e++],t+o,s+r)}else{let e=0;for(let r=0;r<o;r++)for(let o=0;o<n;o++)e<a.length&&this.addActor(a[e++],t+r,s+o)}}e.setBattle(this)}addActor(e,t,s){const a=this._level.getMap().getCell(t,s);a.isPassable()||a.setBaseElem(o.ELEM.FLOOR),this._level.addActor(e,t,s)||n.default.err("Game.Battle","addActor",`Cannot add ${e} to ${t},${s}`)}armyInThisBattle(e){return this._armies.indexOf(e)>=0}isOver(){if(this._armies.length>1){let e=0;if(this._armies.forEach(t=>{t.isDefeated()||++e}),e<=1)return!0}else n.default.err("Game.Battle","isOver","Battle should have >= 2 armies.");return!1}notify(e,t){if(e===n.default.EVT_ARMY_EVENT){const e=this.getName();i(`${e} got EVT_ARMY_EVENT`);const{type:s,army:a}=t;if(this.armyInThisBattle(a)&&"Actor killed"===s&&!this.finished&&this.isOver()){i(`Battle |${e}| is over!`),i("\tRemoving all event listeners"),l.removeListener(this);const t={battle:this};i(`${e} emit EVT_BATTLE_OVER`),l.emitEvent(n.default.EVT_BATTLE_OVER,t),this.finished=!0}}}toJSON(){return{isJSON:!0,name:this._name,level:this._level.getID(),armies:this._armies.map(e=>e.toJSON()),stats:this._stats,finished:this.finished}}removeListeners(){this._armies.forEach(e=>{l.removeListener(e)}),l.removeListener(this)}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=s(37),n=s(14),r=s(28),o=s(1),i=s(11),l=s(9),c=s(5),h=o.Random.getRNG();class u extends a.LevelGenerator{constructor(){super(),this.addDoors=!0,this.shouldRemoveMarkers=!0}create(e,t,s){const a=this.createLevel(e,t,s);return this.populateCityLevel(a,s),a}createLevel(e,t,s){const a=new n.MapGenerator;let r=null;r=s.hasWall?a.createTownWithWall(e,t,s):a.createTownBSP(e,t,s);const o=new i.Level;return o.setMap(r.map),o.addExtras("houses",r.houses),this.createHouseElements(o),this.fillUnusedAreas(o,r.unused),o}createHouseElements(e){const t=e.getExtras().houses;for(let s=0;s<t.length;s++){const a=t[s].door,n=new c.ElementDoor(!0);e.addElement(n,a[0],a[1])}}fillUnusedAreas(e,t){const s=e.getMap(),a=[l.ELEM.GRASS,l.ELEM.TREE,l.ELEM.WATER];t.forEach(e=>{const t=h.arrayGetRand(a);let{w:n,h:r}=e;const{x:o,y:i}=e;n-=2,r-=2;for(let e=o;e<=o+n;e++)for(let a=i;a<=i+r;a++)s.setBaseElemXY(e,a,t)})}populateCityLevel(e,t){let s=e.getExtras().houses;const a=new r.DungeonPopulate(t),n=a.createShops(e,t);s=s.filter(e=>n.indexOf(e)<0);const o=a.createTrainers(e,t);s=s.filter(e=>o.indexOf(e)<0),e.addExtras("houses",s),this.createTownsfolk(e,t)}createTownsfolk(e,t){const s=new r.DungeonPopulate(t);e.getExtras().houses.forEach(a=>{s.populateHouse(e,a,t)})}}t.CityGenerator=u,u.options={village:{actorsPerLevel:30,maxDanger:3,itemsPerLevels:6},capital:{},stronghold:{},fort:{}}},function(e,t,s){"use strict";function a(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}Object.defineProperty(t,"__esModule",{value:!0}),a(s(80)),a(s(81)),a(s(82)),a(s(137))},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=a(s(12)),i=n(s(5)),l=s(37),c=s(14),h=s(11),u=s(28),d=s(45),g=s(142),p=s(25),m=s(24),f=s(1),y=s(3),_=f.Random.getRNG(),E=o.default.Map.Feature.Room;class S extends l.LevelGenerator{static getOptions(){return{addItems:!0,roomCount:-1,cellsAround:{N:"wallmount",S:"tree",E:"grass",W:"snow",NW:"water",SE:"water"},surroundX:10,surroundY:10,maxValue:100,preserveMarkers:!1}}constructor(){super(),this.addDoors=!0,this.shouldRemoveMarkers=!0,this.nItemsAdded=0}create(e,t,s){let a=this.createLevel(e,t,s);return s.preserveMarkers=!1,this.removeMarkers(a,s),s.addItems&&(this.nItemsAdded=this.addItemsToCastle(a,s)),s.cellsAround&&(a=this.createCastleSurroundings(a,s)),a}createLevel(e,t,s){const a=Object.assign({dungeonType:"castle",preserveMarkers:!0,wallType:"wallcastle"},s),n=new c.MapGenerator,r=function(e){if(e.cellsAround){const{cellsAround:t}=e;if(!T(t.N))return d.Castle.startRoomFuncNorth;if(!T(t.S))return d.Castle.startRoomFuncSouth;if(!T(t.E))return d.Castle.startRoomFuncEast;if(!T(t.W))return d.Castle.startRoomFuncWest}return null}(s);r&&(a.startRoomFunc=r);const o=n.createCastle(e,t,a),i=new h.Level;return i.setMap(o.map),this.addMarkersFromTiles(i,o.tiles),this.createDoorsAndLevers(i),i}addItemsToCastle(e,t){let s=0;const a=e.getExtras(),n=a.storeroom,{maxValue:o}=t,i={func:e=>e.value<=2*o&&e.value>=o,maxValue:o,nItems:1},l=new p.FactoryItem;if(n.forEach(t=>{const a=l.generateItems(i);m.Placer.addPropsToRoom(e,t,a),s+=a.length}),r.default.isSuccess(v)){const t=_.arrayGetRand(n),a=_.getUniformInt(1,6),r=l.generateGold({nGold:5,nLevel:a});m.Placer.addPropsToRoom(e,t,r),s+=r.length}const c=a.room;return i.nItems=c.length,l.generateItems(i).forEach(t=>{const a=_.arrayGetRand(c);m.Placer.addPropsToRoom(e,a,[t]),s+=1}),s}addMarkersFromTiles(e,t){e.setExtras({corridor:[],entrance:[],room:[],storeroom:[],vault:[]}),Object.values(t).forEach(t=>{C.storeroom.test(t.name)?this.addToExtras(e,t,"storeroom"):C.vault.test(t.name)?this.addToExtras(e,t,"vault"):C.entrance.test(t.name)?this.addToExtras(e,t,"entrance"):C.corridor.test(t.name)?this.addToExtras(e,t,"corridor"):this.addToExtras(e,t,"room")})}addToExtras(e,t,s){const a=y.Geometry.convertBbox(t);e.getMap().getFreeInBbox(a).forEach(t=>{const[a,n]=t.getXY(),r=new i.ElementMarker(b[s]);r.setTag(s),e.addElement(r,a,n)});const n=new E(a.ulx,a.uly,a.lrx,a.lry);e.getExtras()[s].push(n)}createDoorsAndLevers(e){const t=e.getMap(),s=t.getCells(),a={},n=[];s.forEach(s=>{if(s.hasElements()){const[o,l]=s.getXY();if(s.hasMarker("leverdoor")){const n=new i.ElementLeverDoor;t.getCell(o,l).removeProps(r.default.TYPE_ELEM),e.addElement(n,o,l),a[s.getKeyXY()]=n}else if(s.hasMarker("lever")){const s=new i.ElementLever;t.getCell(o,l).removeProps(r.default.TYPE_ELEM),e.addElement(s,o,l),n.push(s)}else if(s.hasMarker("door")){const s=new i.ElementDoor(!0);t.getCell(o,l).removeProps(r.default.TYPE_ELEM),e.addElement(s,o,l)}}}),n.forEach(e=>{const[s,n]=e.getXY();y.Geometry.getBoxAround(s,n,1).forEach(o=>{const i=o[0]+","+o[1];if(a[i]){let a=t.getCell(o[0],o[1]).getPropType("leverdoor");a?a=a[0]:r.default.err("CastleGenerator","createDoorsAndLevers",`No door found for lever@${s},${n}`),e.addTarget(a)}})})}populateStoreRooms(e,t){const s=new u.DungeonPopulate;t.actorFunc&&s.setActorFunc(t.actorFunc);const a=t.maxDanger,n=e.getExtras();if(n.storeroom){n.storeroom.forEach(t=>{const n=t.getCenter();s.addPointGuardian(e,n,a)})}}createCastleSurroundings(e,t){return(new g.LevelSurroundings).surround(e,t)}}t.CastleGenerator=S,r.default.extend2(S,l.LevelGenerator);const v=.1,C={corridor:/(corridor|corner)/,entrance:/entrance/,storeroom:/storeroom/,vault:/vault/},b={corridor:"C",room:"R",entrance:"E",storeroom:"S",vault:"V"};function T(e){switch(e){case"wallmount":case"water":return!0;default:return!1}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(1),o=s(46),i=r.Random.getRNG(),l={seed:0,difficulty:"Medium",items:"Medium",monsters:"Medium",worldSize:"Medium",areaSize:"Medium",climate:"Medium",elevation:"Medium",mountainSize:"Medium",excavation:"Medium",dungeonSize:"Medium",forestation:"Medium",population:"Medium",citySize:"Medium",size:"Medium",water:"Sparse"},c={Small:1,Medium:2,Large:4,Huge:8},h={Small:.7,Medium:1,High:1.3,Huge:1.7},u={Small:{x:3,y:3},Medium:{x:5,y:5},Large:{x:5,y:7},Huge:{x:7,y:9}};t.WorldConf={},t.WorldConf.featCoeff=.3;const d=(e,t)=>i.getUniformInt(e,t);t.WorldConf.getBaseConf=(e=>{let s=null;switch(e){case"branch":s=t.WorldConf.createSingleBranchConf();break;case"city":s={name:"city",nQuarters:1,quarter:[t.WorldConf.createSingleQuarterConf()]};break;case"dungeon":s={name:"dungeon",nBranches:1,branch:[t.WorldConf.createSingleBranchConf()]};break;case"face":s=t.WorldConf.createSingleFaceConf();break;case"mountain":s={name:"mountain",nFaces:1,face:[t.WorldConf.createSingleFaceConf()]};break;case"quarter":s=t.WorldConf.createSingleQuarterConf();break;default:console.log("No legal featureType given")}return s}),t.WorldConf.createQuarterConnections=(e=>{if(1===e.length)return null;const t=[];for(let s=1;s<e.length;s++){const a=e[s-1],r=e[s];let o=i.getWeightedLinear(a.nLevels-1);const l=0;n.default.isNullOrUndef([o])&&(o=a.nLevels-1);const c=[a.name,r.name,o,l];t.push(c)}return t}),t.WorldConf.createFaceConnections=((e,t)=>{if(1===t.length)return null;const s=[];for(let e=1;e<t.length;e++){const a=t[e-1],r=t[e];let o=i.getWeightedLinear(a.nLevels-1);const l=0;n.default.isNullOrUndef([o])&&(o=a.nLevels-1);const c=[a.name,r.name,o,l];s.push(c)}return s}),t.WorldConf.createBranchConnections=((e,t)=>{if(1===t.length)return null;const s=[];for(let e=1;e<t.length;e++){const a=t[e-1],r=t[e];let o=i.getWeightedLinear(a.nLevels-1);const l=0;n.default.isNullOrUndef([o])&&(o=a.nLevels-1);const c=[a.name,r.name,o,l];s.push(c)}return s}),t.WorldConf.setDistFromStart=((e,t)=>{const s=Math.floor(t.maxX/2),a=t.maxY;e.distX=Math.abs(e.x-s),e.distY=Math.abs(e.y-a),e.distSqr=Math.sqrt(Math.pow(e.distX,2)+Math.pow(e.distY,2))}),t.WorldConf.getPlayerStart=((e,t)=>{const s=e.maxY-1,a=Math.floor(e.maxX/2);return{place:t.name,x:a,y:s}}),t.WorldConf.getXYInArea=(e=>({x:d(0,e.maxX-1),y:d(0,e.maxY-1)})),t.WorldConf.getNumBranches=((e,t)=>{switch(t.dungeonSize){case"Small":return 1;case"Medium":return d(1,2);case"Large":return d(1,3);case"Huge":return d(1,4);default:return 1}}),t.WorldConf.getNumQuarters=((e,t)=>{switch(t.citySize){case"Small":return 1;case"Medium":return d(1,2);case"Large":return d(1,3);case"Huge":return d(1,4);default:return 1}}),t.WorldConf.getNumFaces=((e,t)=>{switch(t.mountainSize){case"Small":return 1;case"Medium":return d(1,2);case"Large":return d(1,3);case"Huge":return d(1,4);default:return 1}}),t.WorldConf.getNumLevels=(e=>{switch(e){case"dungeon":return d(1,10);case"city":case"mountain":return d(1,3);default:return 1}}),t.WorldConf.scaleNumFeatures=((e,t)=>{switch(e){case"dungeon":return h[t.excavation];case"mountain":return h[t.elevation];case"city":return h[t.population];default:n.default.err("Creator","scaleNumFeatures",`Unknown feat type ${e}`)}return 1}),t.WorldConf.getNumFeatures=((e,s,a)=>{let n=(s.maxX+1)*(s.maxY+1);return n=Math.ceil(n*t.WorldConf.scaleNumFeatures(e,a)),n=i.getNormal(n,t.WorldConf.featCoeff*n)}),t.WorldConf.createDungeonsConf=((e,s)=>{const a=t.WorldConf.getNumFeatures("dungeon",e,s),n=[];for(let r=0;r<a;r++){const a=t.WorldConf.createSingleDungeonConf(e,s);n.push(a)}return n}),t.WorldConf.createSingleDungeonConf=((e,s)=>{const a=t.WorldConf.getXYInArea(e),n=Object.assign({},e);n.x=a.x,n.y=a.y,t.WorldConf.setDistFromStart(n,e);const r=t.WorldConf.createBranchesConf(n,s),i=t.WorldConf.createBranchConnections("branch",r),l={name:o.Names.getGenericPlaceName("dungeon"),x:a.x,y:a.y,nBranches:r.length,branch:r};return i&&(l.connectLevels=i),l}),t.WorldConf.createBranchesConf=((e,s)=>{const a=t.WorldConf.getNumBranches(e,s),n=[];for(let e=0;e<a;e++){const s=t.WorldConf.createSingleBranchConf();n.push(s),0===e&&(s.entranceLevel=0)}return n}),t.WorldConf.createSingleBranchConf=(()=>{const e=t.WorldConf.getNumLevels("dungeon");return{dungeonX:80,dungeonY:28,sqrPerItem:40,sqrPerActor:40,maxDanger:2,maxValue:100,dungeonType:"digger",name:o.Names.getGenericPlaceName("branch"),nLevels:e}}),t.WorldConf.createSingleQuarterConf=(()=>{return{nLevels:t.WorldConf.getNumLevels("city"),name:o.Names.getGenericPlaceName("quarter")}}),t.WorldConf.createSingleFaceConf=(()=>{const e=t.WorldConf.getNumLevels("mountain");return{x:100,y:200,name:o.Names.getGenericPlaceName("face"),nLevels:e}});class g{constructor(){this.nCreated={}}createWorldConf(e){e.name||n.default.err("Creator","createWorldConf","conf.name must be specified."),Object.keys(l).forEach(t=>{e.hasOwnProperty(t)||(e[t]=l[t])}),this.rand=new r.Random,this.rand.setSeed(e.seed);const s=this.createAreasConf(e),a=t.WorldConf.getPlayerStart(s[0],e);return{name:e.name,nAreas:s.length,area:s,playerStart:a}}createAreasConf(e){const t=c[e.worldSize],s=[];for(let a=0;a<t;a++){const t=this.createSingleAreaConf(a,e);s.push(t)}return s}createSingleAreaConf(e,s){const a=u[s.areaSize],n=s.maxX||a.x,r=s.maxY||a.y,o={maxX:n,maxY:r,areaNum:e},i=t.WorldConf.createDungeonsConf(o,s),l=this.createCitiesConf(o,s),c=this.createMountainsConf(o,s);return{name:this.getName("area"),maxX:n,maxY:r,nDungeons:i.length,nCities:l.length,nMountains:c.length,dungeon:i,city:l,mountain:c}}createCitiesConf(e,s){const a=t.WorldConf.getNumFeatures("city",e,s),n=[];for(let t=0;t<a;t++){const t=this.createSingleCityConf(e,s);n.push(t)}return n}createSingleCityConf(e,s){const a=t.WorldConf.getXYInArea(e),n=Object.assign({},e);n.x=a.x,n.y=a.y,t.WorldConf.setDistFromStart(n,e);const r=this.createQuartersConf(n,s),o=t.WorldConf.createQuarterConnections(r),i={name:"",x:a.x,y:a.y,nQuarters:r.length,quarter:r};return o&&(i.connectLevels=o),i}createQuartersConf(e,s){const a=t.WorldConf.getNumQuarters(e,s),n=[];for(let e=0;e<a;e++){const s=t.WorldConf.createSingleQuarterConf();0===e&&(s.entranceLevel=0),n.push(s)}return n}createMountainsConf(e,s){const a=t.WorldConf.getNumFeatures("mountain",e,s),n=[];for(let t=0;t<a;t++){const t=this.createSingleMountainConf(e,s);n.push(t)}return n}createSingleMountainConf(e,s){const a=t.WorldConf.getXYInArea(e),n=Object.assign({},e);n.x=a.x,n.y=a.y,t.WorldConf.setDistFromStart(n,e);const r=this.createFacesConf(n,s),o=t.WorldConf.createFaceConnections("mountain",r),i={name:"",x:a.x,y:a.y,nFaces:r.length,face:r};return o&&(i.connectLevels=o),i}createFacesConf(e,s){const a=t.WorldConf.getNumFaces(e,s),n=[];for(let e=0;e<a;e++){const s=t.WorldConf.createSingleFaceConf();n.push(s),0===e&&(s.entranceLevel=0)}return n}getName(e){return this.nCreated.hasOwnProperty(e)||(this.nCreated[e]=0),this.nCreated[e]+=1,`${e} ${this.nCreated[e]}`}}t.WorldCreator=g,t.WorldConf.Creator=g},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(8)("bitn:OW"),r=a(s(0)),o=s(27),i=s(3),l=s(47),c=s(1),h=s(86),u=s(87),d=s(5),g=c.Random.getRNG;class p{constructor(){this._baseMap=[],this._explored={},this._subLevels=[],this._hWalls=[],this._vWalls=[],this._features={},this._featureData={},this._featuresByXY={},this._biomeMap={},this._terrMap=null}getSizeXY(){return[this.getSizeX(),this.getSizeY()]}getCenterX(){return Math.round(this.getSizeX()/2)}getCenterY(){return Math.round(this.getSizeY()/2)}isWallTile(e,t){const s=this._baseMap[e][t];return l.OW.ALL_WALLS_LUT.hasOwnProperty(s)}numTiles(e){let t=0;const[s,a]=this.getSizeXY();for(let n=0;n<s;n++)for(let s=0;s<a;s++)this._baseMap[n][s]===e&&++t;return t}numWallTiles(){let e=0;const[t,s]=this.getSizeXY();for(let a=0;a<t;a++)for(let t=0;t<s;t++)this.isWallTile(a,t)&&++e;return e}getBiomeMap(){return this._biomeMap}getBiome(e,t){const s=e+","+t;return this._biomeMap.hasOwnProperty(s)?this._biomeMap[e+","+t]:(r.default.err("OWMap","getBiome",`No biome set for x,y ${e},${t}`),"")}getMap(){return this._baseMap}getCell(e){return this._baseMap[e[0]][e[1]]}numHWalls(){return this._hWalls.length}numVWalls(){return this._vWalls.length}getHWalls(){return this._hWalls}getVWalls(){return this._vWalls}setMap(e){const t=e.length;this._baseMap=e;for(let e=0;e<t;e++)this._subLevels[e]=[]}setTerrMap(e){this._terrMap=e}getTerrMap(){return this._terrMap}addBiome(e,t,s){const a=e+","+t;this._biomeMap[a]=s}addVWall(e){e.type="vertical",this._vWalls.push(e)}addHWall(e){e.type="horizontal",this._hWalls.push(e)}addFeature(e,t){const s=e[0]+","+e[1];this._features.hasOwnProperty(t)||(this._features[t]=[]),this._featuresByXY.hasOwnProperty(s)||(this._featuresByXY[s]=[]),this._features[t].push(e),this._featuresByXY[s].push(t)}addFeatureData(e,t){const s=e[0]+","+e[1];this._featureData.hasOwnProperty(s)||(this._featureData[s]=[]),this._featureData[s].push(t)}getFeaturesByType(e){return this._features.hasOwnProperty(e)?this._features[e]:[]}getFeaturesByXY(e){const t=e[0]+","+e[1];return this._featuresByXY[t]}addSubLevel(e,t){this._subLevels[e[0]][e[1]]=t}getSubLevel(e){return this._subLevels[e[0]][e[1]]}clearSubLevels(){this._subLevels=[]}getSubLevelsWithFeature(e){return this.getFeaturesByType(e).map(e=>this.getSubLevel(e))}getAreaXY(){return this.getSizeX()*this.getSizeY()}getSizeX(){return this._baseMap.length}getSizeY(){return this._baseMap[0].length>0?this._baseMap[0].length:(r.default.warn("OWMap","getSizeY","Y-size requested but returning zero value"),0)}setExplored(e){this._explored[e[0]+","+e[1]]=!0}isExplored(e){return this._explored[e[0]+","+e[1]]}toJSON(){const e={baseMap:this._baseMap,biomeMap:this._biomeMap,features:this._features,featuresByXY:this._featuresByXY,vWalls:this._vWalls,hWalls:this._hWalls,explored:this._explored};return this.coordMap&&(e.coordMap=this.coordMap.toJSON()),this._terrMap&&(e.terrMap=this._terrMap.toJSON()),e}getOWMap(e=!1){const t=JSON.parse(JSON.stringify(this._baseMap)),s=t[0].length,a=t.length;if(Object.keys(this._features).forEach(e=>{this._features[e].forEach(s=>{t[s[0]][s[1]]=e})}),e)for(let e=0;e<a;e++)for(let a=0;a<s;a++)this._explored[e+","+a]||(t[e][a]="?");return t}getCellList(){const e=this.getOWMap(),t=e[0].length,s=e.length,a=new o.CellMap(s,t);for(let n=0;n<s;n++)for(let s=0;s<t;s++){const t=new d.ElementMarker(e[n][s]);l.OW.classNames[e[n][s]]?t.setClassName(l.OW.classNames[e[n][s]]):t.setClassName(l.OW.classNames.default),a.setProp(n,s,r.default.TYPE_ELEM,t)}return a}mapToString(e=!1){const t=this.getOWMap(e),s=t[0].length,a=t.length,n=[];for(let e=0;e<s;e++){const s=[];for(let n=0;n<a;n++)s.push(t[n][e]);n.push(s)}return n.map(e=>e.join(""))}biomeMapToString(){const e=this.getSizeX()-1,t=this.getSizeY()-1,s=Object.keys(l.OW.biomeTypeMap),a={},n=s.map((e,t)=>(a[e]=""+t,`${t} - ${e}`));let r="";for(let s=0;s<t;s++){let t="";for(let n=0;n<e;n++){const e=n+","+s;t+=","+a[this._biomeMap[e]]}r+=t+="\n"}return r+="\n"+n.join("\n")}}function m(e,t,s,a=!1){const n=s.length;let r=!1;const o={y:t,x:[1]};s[0][t]=l.OW.TT_W,a||(s[n-1][t]=l.OW.TT_E);for(let e=1;e<n-1;e++)r||(s[e][t]!==l.OW.EMPTY?a?(r=!0,s[e][t]=l.OW.TT_E,o.x.push(e)):s[e][t]=l.OW.XX:s[e][t]=g().getWeighted(l.OW.LINE_WE_WEIGHT));r||(a&&(s[n-1][t]=l.OW.TT_E),o.x.push(n-1)),e.addHWall(o)}function f(e,t,s,a=!1){const n=s[0].length;let r=!1;const o={x:t,y:[1]};s[t][0]=l.OW.TT_N,a||(s[t][n-1]=l.OW.TT_S);for(let e=1;e<n-1;e++)r||(s[t][e]!==l.OW.EMPTY?a?(r=!0,s[t][e]=l.OW.TT_S,o.y.push(e)):s[t][e]=l.OW.XX:s[t][e]=g().getWeighted(l.OW.LINE_NS_WEIGHT));r||(a&&(s[t][n-1]=l.OW.TT_S),o.y.push(n-1)),e.addVWall(o)}function y(e,t,s){if(s[e][t]===l.OW.EMPTY){const a=function(e,t,s){const a=s[0].length,n=s.length,r=[];if(t>0){const a=l.OW.CAN_CONNECT[s[e][t-1]].N;r.push([s[e][t-1],a])}if(t<a-1){const a=l.OW.CAN_CONNECT[s[e][t+1]].S;r.push([s[e][t+1],a])}if(e<n-1){const a=l.OW.CAN_CONNECT[s[e+1][t]].E;r.push([s[e+1][t],a])}if(e>0){const a=l.OW.CAN_CONNECT[s[e-1][t]].W;r.push([s[e-1][t],a])}return r}(e,t,s).filter(e=>e[0]!==l.OW.EMPTY&&e[0]!==l.OW.TERM);1===a.length&&a[0][1].length>0?s[e][t]=g().arrayGetRand(a[0][1]):s[e][t]=l.OW.TERM}}function _(e,t){const s=e.getSizeX()*e.getSizeY(),a=e.numTiles(l.OW.TERM),n=e.numWallTiles(),o=t.nDungeonsSouth||Math.floor(n/12),c=t.nDungeonsCenter||Math.floor(n/24),u=t.nDungeonsNorth||Math.floor(n/24),d=t.nMountainsNorth||Math.floor(s/40),g=t.nMountainsMiddle||Math.floor(s/60),p=t.nMountainsSouth||Math.floor(s/80);!function(e,t,s,a){const n=e.getMap(),o=n[0].length,i=n.length;let c=O(t,s,i,o),h=1e3;for(;n[c[0]][c[1]]!==l.OW.TERM;){if(c=O(t,s,i,o),0===h){r.default.warn("OverWorld","addFeature","No empty cell to add "+a+", "+t);break}--h}e.addFeature(c,a)}(e,"NE",.5,l.OW.BTOWER);const m=e.numHWalls();if(m>1&&(E(e,e._hWalls[1],l.OW.WCAPITAL),E(e,e._hWalls[0],l.OW.WTOWER)),m>2)for(let t=2;t<m;t++)E(e,e._hWalls[t],l.OW.VTUNNEL);const f=e.numVWalls();f>0&&(E(e,e._vWalls[f-1],l.OW.BTOWER),E(e,e._vWalls[f-1],l.OW.BCAPITAL));const y={y:{start:["wall",0],end:["wall",1]}},_={y:{start:"N",end:"wall"}},A={y:{start:["wall",1],end:"S"}};S(e,_,l.OW.BIOME.ALPINE),S(e,{x:{start:["wall",0],end:"E"}},l.OW.BIOME.ARCTIC),S(e,y,l.OW.BIOME.TUNDRA),S(e,A,l.OW.BIOME.TAIGA),v(e,o,A),v(e,c,y),v(e,u,_);const w=Math.floor(.5*a/80),M=Math.floor(.2*a/100),P=Math.floor(.2*a/80);C(e,p,A),C(e,g,y),C(e,d,_),t.createTerritory?(function(e,t){const{playerRace:s,playerX:a,playerY:n}=t,r=h.TerritoryMap.create(e,s,[a,n]);e.setTerrMap(r)}(e,t),function(e){const t=e.getTerrMap(),s=t.getMap();r.default.forEach2D(s,(s,a)=>{const n=[s,a],o=t.getRival(n);if(t.hasRival(n))if(r.default.isSuccess(.13)){T(e,n);const t=o+"_city";e.addFeatureData(n,{type:t})}else{const t=i.Geometry.getBoxAround(s,a,1);let n=!1;t.forEach(t=>{if(!n&&e.isWallTile(t[0],t[1])&&r.default.isSuccess(.09)){e.addFeature(t,l.OW.MFORT);const s=o+"_fort";e.addFeatureData(t,{type:s}),n=!0}})}})}(e)):(b(e,w,A),b(e,M,y),b(e,P,_))}function E(e,t,s){const a=e.getMap();let r=null;if("horizontal"===t.type){const e=t.x[0],s=t.x[t.x.length-1];r=w(a,M(e,t.y,s,t.y),l.OW.LL_WE)}if("vertical"===t.type){const e=t.y[0],s=t.y[t.y.length-1];r=w(a,M(t.x,e,t.x,s),l.OW.LL_NS)}n(`Placed feature ${s} to ${r}`),e.addFeature(r,s)}function S(e,t,s){const a=P(e,t);for(let t=a.ulx;t<=a.lrx;t++)for(let n=a.uly;n<=a.lry;n++)e.addBiome(t,n,s)}function v(e,t,s){const a=P(e,s);for(let s=0;s<t;s++){const t=w(e.getMap(),a,l.OW.ALL_WALLS);e.addFeature(t,l.OW.WDUNGEON)}}function C(e,t,s){const a=P(e,s);for(let s=0;s<t;s++){const t=w(e.getMap(),a,[l.OW.TERM]);e.addFeature(t,l.OW.MOUNTAIN)}}function b(e,t,s){const a=P(e,s);for(let s=0;s<t;s++){const t=w(e.getMap(),a,[l.OW.TERM]);T(e,t)}}function T(e,t){r.default.isSuccess(l.OW.PROB_BVILLAGE)?e.addFeature(t,l.OW.BVILLAGE):e.addFeature(t,l.OW.WVILLAGE)}function A(e,t){let s=t;return"string"==typeof t&&(s=[t]),s.indexOf(l.OW.CELL_ANY)>=0||s.indexOf(e)>=0}function w(e,t,s){const{ulx:a,uly:n,lrx:o,lry:i}=t;let l=a===o?a:g().getUniformInt(a,o),c=i===n?i:g().getUniformInt(n,i),h=100*(o-a+1)*(i-n+1),u=A(e[l][c],s);for(;!u;){if(l=a===o?a:g().getUniformInt(a,o),c=i===n?i:g().getUniformInt(n,i),u=A(e[l][c],s),0===h){const e=`(${a},${i}) -> (${o},${n})`;r.default.warn("OverWorld","findCellRandXYInBox",`No cells of type ${s} in ${e}`);break}--h}return[l,c]}function O(e,t,s,a){let n=0,r=0,o=0,i=0;return e.match(/N/)&&(i=0,r=Math.floor(.25*t*a)),e.match(/S/)&&(r=a-1,i=.75*a,i=Math.floor(i+(1-t)*(r-i))),e.match(/E/)&&(o=s-1,n=.75*s,n=Math.floor(n+(1-t)*(o-n))),e.match(/W/)&&(n=0,o=Math.floor(.25*t*s)),[g().getUniformInt(n,o),g().getUniformInt(i,r)]}function M(e,t,s,a){return r.default.isNullOrUndef([e,t,s,a])&&r.default.err("overworld.map.js","bBox",`bBox coord(s) undef/null: ${e},${t},${s},${a}`),{isBox:!0,ulx:e,lry:t,lrx:s,uly:a}}function P(e,t){if(t.isBox)return t;let s=0,a=e.getSizeX()-1,n=0,r=e.getSizeY()-1;if(t.x){const n=t.x.start,r=t.x.end;if("W"===n)s=0;else if("wall"===n){const t=e.getVWalls();t.length>0&&(s=t[0].x)}else if(Array.isArray(n)&&"wall"===n[0]){const t=e.getVWalls();t.length>n[1]&&(s=t[n[1]].x)}if("E"===r)a=e.getSizeX()-1;else if("wall"===r){const t=e.getVWalls();t.length>0&&(a=t[0].x)}else if(Array.isArray(r)&&"wall"===r[0]){const t=e.getVWalls();t.length>r[1]&&(a=t[r[1]].x)}}if(t.y){const s=t.y.start,a=t.y.end;if("N"===s)n=0;else if("wall"===s){const t=e.getHWalls();t.length>0&&(n=t[0].y)}else if(Array.isArray(s)&&"wall"===s[0]){const t=e.getHWalls();t.length>s[1]&&(n=t[s[1]].y)}if("S"===a)r=e.getSizeY()-1;else if("wall"===a){const t=e.getHWalls();t.length>0&&(r=t[0].y)}else if(Array.isArray(a)&&"wall"===a[0]){const t=e.getHWalls();t.length>a[1]&&(r=t[a[1]].y)}}return{ulx:s,lrx:a,uly:n,lry:r}}t.OWMap=p,p.createOverWorld=function(e={}){const t=void 0===e.yFirst||e.yFirst,s=void 0===e.topToBottom||e.topToBottom,a=void 0!==e.printResult&&e.printResult,n=e.owTilesX||40,o=e.owTilesY||20,i=new p,c=function(e,t){const s=[];for(let a=0;a<e;a++){s[a]=[];for(let e=0;e<t;e++)s[a][e]=l.OW.EMPTY}return s}(n,o);return function(e){const t=e[0].length,s=e.length;e[0][0]=l.OW.CC_NW,e[0][t-1]=l.OW.CC_SW,e[s-1][t-1]=l.OW.CC_SE,e[s-1][0]=l.OW.CC_NE;for(let t=1;t<s-1;t++)e[t][0]=g().arrayGetRand(l.OW.N_BORDER);for(let a=1;a<s-1;a++)e[a][t-1]=g().arrayGetRand(l.OW.S_BORDER);for(let a=1;a<t-1;a++)e[s-1][a]=g().arrayGetRand(l.OW.E_BORDER);for(let s=1;s<t-1;s++)e[0][s]=g().arrayGetRand(l.OW.W_BORDER)}(c),function(e,t,s){const a=t[0].length,n=t.length;let r=void 0!==s.nHWalls?s.nHWalls:[.3,.5],o=void 0!==s.nVWalls?s.nVWalls:[];const i=void 0!==s.stopOnWall&&s.stopOnWall;if(Number.isInteger(s.nHWalls)){r=[];for(let e=0;e<s.nHWalls;e++){const e=g().getUniformInt(1,19);r.push(.05*e)}r=r.sort()}if(Number.isInteger(s.nVWalls)){o=[];for(let e=0;e<s.nVWalls;e++){const e=g().getUniformInt(1,19);o.push(.05*e)}o=r.sort()}for(let s=0;s<r.length;s++){let n=i;"random"===i&&(n=g().getUniform()>=.5),m(e,Math.floor(a*r[s]),t,n)}for(let s=0;s<o.length;s++){let a=i;"random"===i&&(a=g().getUniform()>=.5),f(e,Math.floor(n*o[s]),t,a)}}(i,c,e),function(e,t,s){const a=t[0].length,n=t.length,r=s.innerWallRatio||.05,o=Math.floor(n*a*r);for(let e=0;e<o;e++){const e=g().getUniformInt(2,n-2),s=g().getUniformInt(2,a-2);t[e][s]===l.OW.EMPTY&&(t[e][s]=g().arrayGetRand(l.OW.ALL_WALLS))}}(0,c,e),s?function(e,t=!0){const s=e[0].length,a=e.length;if(t)for(let t=0;t<a;t++)for(let a=0;a<s;a++)y(t,a,e);else for(let t=0;t<s;t++)for(let s=0;s<a;s++)y(s,t,e)}(c,t):function(e,t=!0){const s=e[0].length,a=e.length;if(t)for(let t=0;t<a;t++)for(let a=s-1;a>=0;a--)y(t,a,e);else for(let t=s-1;t>=0;t--)for(let s=0;s<a;s++)y(s,t,e)}(c,t),e.printResult&&r.default.printMap(c),i.setMap(c),_(i,e),a&&r.default.log("\n",i.mapToString().join("\n")),i},p.fromJSON=function(e){const t=new p;return t.setMap(e.baseMap),t._features=e.features,t._featuresByXY=e.featuresByXY,t._vWalls=e.vWalls,t._hWalls=e.hWalls,t._biomeMap=e.biomeMap,t._explored=e.explored,e.terrMap&&(t._terrMap=u.Territory.fromJSON(e.terrMap)),t}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(46),o=s(153),i=s(15),l=s(35),c=s(14),h=s(64),u=s(47),d=s(9),g=s(1),p=s(17),m=s(3),f=s(8)("bitn:overworld");t.OverWorld={};const y=/(capital|city|abandoned fort|fort|village)/,_=/(dwarven city|abandoned fort|capital)/,E=d.ELEM.WALL_MOUNT.getType(),S=111,v=1,C=1,b=!1;let T=!1;const A=g.Random.getRNG;t.OverWorld.TILE_SIZE_X=100,t.OverWorld.TILE_SIZE_Y=100;const{TILE_SIZE_X:w,TILE_SIZE_Y:O}=t.OverWorld;class M{constructor(e){this.type=e,this.coord=[]}addWallCoord(e){this.coord.push(e)}getCoordAt(e){return this.coord[e]}getWallPos(){return"vertical"===this.type?this.coord[0][0][0]:"horizontal"===this.type?this.coord[0][0][1]:u.OW.ILLEGAL_POS}getWallStart(){return"vertical"===this.type?this.coord[0][0][1]:"horizontal"===this.type?this.coord[0][0][0]:u.OW.ILLEGAL_POS}getWallEnd(){const e=this.coord.length-1;return"vertical"===this.type?this.coord[e][0][1]:"horizontal"===this.type?this.coord[e][0][0]:-1}toString(){let e=`type: ${this.type} `;return e+=`Length: ${this.coord.length}\n`,e+=`Start: ${this.getWallStart()} End: ${this.getWallEnd()}\n`,e+=`Tiles: ${JSON.stringify(this.coord)}`}}t.OWWall=M;class P{constructor(e,t){this.type=e,this.coord=t,this.cellsAround=null,Array.isArray(t)?0===t.length?n.default.err("OWSubFeature","new","coord len is 0."):Array.isArray(t[0])||n.default.err("OWSubFeature","new","Each coord must be [x, y] pair."):n.default.err("OWSubFeature","new","coord must be an array.")}getLastCoord(){return this.coord.length>0?this.coord[this.coord.length-1]:[-1,-1]}}t.OWSubFeature=P;class N{constructor(e){this._level=e,this._hWalls=[],this._vWalls=[],this._subX=e.getMap().rows,this._subY=e.getMap().cols,this._features={},this._featuresByXY={}}getFeatures(){return this._features}getSubX(){return this._subX}getSubY(){return this._subY}addWall(e){"vertical"===e.type?this._vWalls.push(e):"horizontal"===e.type&&this._hWalls.push(e)}getWall(){const e=this._hWalls.length,t=this._vWalls.length;return 0===e&&0===t?null:0===e?this._vWalls[0]:0===t?this._hWalls[0]:(n.default.warn("OWSubLevel","getWall",`Return hor wall. Too many walls: vLen: ${t}, hLen: ${e}`),this._hWalls[0])}addFeature(e){const t=e.type;this._features.hasOwnProperty(t)||(this._features[t]=[]),this._features[t].push(e),e.coord.forEach(e=>{const s=e[0]+","+e[1];this._featuresByXY[s]=t})}getFeaturesByType(e){return this._features.hasOwnProperty(e)?this._features[e]:[]}}t.OWSubLevel=N;class I{constructor(e={}){this.worldCols=e.worldCols||0,this.worldRows=e.worldRows||0,this.nTilesX=e.nTilesX||0,this.nTilesY=e.nTilesY||0,this.xMap=e.xMap||0,this.yMap=e.yMap||0}setXYMap(e,t){this.xMap=e,this.yMap=t}getAreaLevelCols(){return this.worldCols/this.nTilesX}getAreaLevelRows(){return this.worldRows/this.nTilesY}toOwLevelXY(e,t){return[e[0]*this.xMap+t[0],e[1]*this.xMap+t[1]]}toOWTileXY(e,t){const s=this.getOWTileBboxFromAreaTileXY(e[0],e[1]);return[s.ulx+Math.floor(t[0]/this.xMap),s.uly+Math.floor(t[1]/this.yMap)]}getAreaXYFromOWTileXY(e,t){return[Math.floor(e/this.xMap),Math.floor(t/this.yMap)]}getOWTileBboxFromAreaTileXY(e,t){return Number.isInteger(e)&&Number.isInteger(t)?{ulx:e*w/this.xMap,uly:t*O/this.yMap,lrx:(e+1)*w/this.xMap-1,lry:(t+1)*O/this.yMap-1}:(n.default.err("OverWorld.CoordMap","getOWTileBboxFromAreaTileXY",`Args (x,y) must be ints. Got ${e}, ${t}`),null)}toJSON(){return{worldCols:this.worldCols,worldRows:this.worldRows,nTilesX:this.nTilesX,nTilesY:this.nTilesY,xMap:this.xMap,yMap:this.yMap}}}function D(e,t,s,a,r){const o=e.getMap()[t][s],i=e.getBiome(t,s),l=a,h=r,g=(new p.FactoryLevel).createLevel(n.default.LEVEL_EMPTY,l,h);!function(e,t){const s=t.getMap().cols,a=t.getMap().rows,n=A().getUniform();if("arctic"===e)c.MapGenerator.addRandomSnow(t.getMap(),1);else if("alpine"===e){if(c.MapGenerator.addRandomSnow(t.getMap(),.5),n<.1){const e=new c.MapGenerator;e.setGen("lakes",s,a);const n={ratio:.15,freeOnly:!0};e.addLakesToMap(t.getMap(),n)}}else if("tundra"===e){if(c.MapGenerator.addRandomSnow(t.getMap(),.1),n<.2){const e=new c.MapGenerator;e.setGen("lakes",s,a);const n={ratio:.3,freeOnly:!0};e.addLakesToMap(t.getMap(),n)}}else if("taiga"===e||"forest"===e){const e={ratio:.6,freeOnly:!0},r=new c.MapGenerator;if(r.setGen("forest",s,a),r.addForestToMap(t.getMap(),e),n<.3){r.setGen("lakes",s,a);const e={ratio:.4,freeOnly:!0};r.addLakesToMap(t.getMap(),e)}}else if("grassland"===e){const e={ratio:.1},n=new c.MapGenerator;n.setGen("forest",s,a),n.addForestToMap(t.getMap(),e)}}(i,g);const y=new N(g);return e.addSubLevel([t,s],y),function(e,t,s){const a=s.getMap(),n=u.OW.N_HAS_CONN.findIndex(t=>t===e)>=0,r=u.OW.S_HAS_CONN.findIndex(t=>t===e)>=0,o=u.OW.E_HAS_CONN.findIndex(t=>t===e)>=0,i=u.OW.W_HAS_CONN.findIndex(t=>t===e)>=0,l=a.cols,c=a.rows,h=Math.floor(l/2),g=Math.floor(c/2);let p=null,m=-1,f=-1;n&&r?(m=0,f=c-1):n?(m=0,f=g-1):r&&(m=g,f=c-1);let y=R(f+1,5,3,l,3);if(n||r){const e=new M("vertical");for(let t=m;t<=f;t++){p=y[t-m];const s=[];1===p&&(p=5);for(let e=h-(p-1);e<=h+(p-1);e++)a.setBaseElemXY(e,t,d.ELEM.WALL_MOUNT),s.push([e,t]);e.addWallCoord(s)}t.addWall(e)}let _=-1,E=-1;o&&i?(_=0,E=l-1):o?(_=h,E=l-1):i&&(_=0,E=h-1);if(y=R(E+1,5,3,l,3),o||i){const e=new M("horizontal");for(let t=_;t<=E;t++){p=y[t-_];const s=[];1===p&&(p=5);for(let e=g-(p-1);e<=g+(p-1);e++)a.setBaseElemXY(t,e,d.ELEM.WALL_MOUNT),s.push([t,e]);e.addWallCoord(s)}t.addWall(e)}}(o,y,g),function(e,t,s,a){const r=[t,s],o=e.getSubLevel(r),i=e.getFeaturesByXY(r),l=e.getCell(r);if(!i)return;let c=0;i.forEach(e=>{e===u.OW.WCAPITAL?k(e,o,a):function(e,t){return!(e!==u.OW.LL_WE&&e!==u.OW.LL_NS||t!==u.OW.BTOWER&&t!==u.OW.WTOWER)}(l,e)?k(e,o,a):e===u.OW.BTOWER||e===u.OW.WTOWER?function(e,t,s){let a=!1;const n=s.getMap().getFree().map(e=>e.getXY());let r=[],o=S;for(;9!==r.length&&(m.Geometry.getFreeArea(n,3,3,r)&&(a=!0),r.length<9&&(f("addTowerToSubLevel. Too few coords. Retrying."),a=!1,r=[]),!(--o<=0)););const i=e===u.OW.BTOWER?"blacktower":"whitetower";if(a){f("addTowerToSubLevel feat placed with "+JSON.stringify(r)),s.getMap().setBaseElems(r,d.ELEM.FORT);const a=new P(i,r);a.alignment=B(e),t.addFeature(a)}}(e,o,a):e===u.OW.WDUNGEON?function(e,t){const s=G(t);if(s&&s.length>0){const t=new P("dungeon",s);e.addFeature(t)}}(o,a):e===u.OW.WVILLAGE?function(e,t,s){const a=s.getMap().getFreeNotOnEdge();if(a.length>0){const s=a.map(e=>e.getXY()),n=A().arrayGetRand(s),r=new P("village",[n]);r.alignment=B(e),t.addFeature(r)}else n.default.err("overworld.js","addVillageToSubLevel","No free cells found in the level.")}(e,o,a):e===u.OW.MOUNTAIN?function(e,t){let s=!1;const a=t.getMap().getFreeNotOnEdge().map(e=>[e.getX(),e.getY()]);if(0===a.length)return;let n=[],r=10*S;for(;!s;){const e=A().arrayGetRand(a);if(n=[e],s=!0,--r<=0)break}if(s){const t=new P("mountain",n);e.addFeature(t)}}(o,a):e===u.OW.VTUNNEL?function(e,t){const s=t.getMap(),a=s.cols,n=A().getUniformInt(0,a-1);for(let e=0;e<s.rows;e++)s.setBaseElemXY(n,e,d.ELEM.FLOOR)}(0,a):e===u.OW.MFORT?function(e,t){const s=G(t,!1);if(s&&s.length>0){const[a,r]=s[0],o=m.Geometry.getBoxAround(a,r,1),i=t.getMap(),l=i.getCellsWithCoord(o),c=new P("fort",s),h={};l.forEach(e=>{const t=n.default.dXdYUnit(e,s[0]),a=n.default.dXdYToDir(t);h[a]=e.getBaseElem().getType()}),c.cellsAround=h,e.addFeature(c)}}(o,a):(f("addSubLevelFeat Skipped: "+`Base: ${l}, ${e}`),++c)}),c>0&&f(`Skipped ${c} features in addSubLevelFeatures`)}(e,t,s,g),g}function L(e,t,s){let a=Math.floor(A().getNormal(e,t));return a>s/2?a=s/2-1:a<1&&(a=1),a}function R(e,t,s,a,n){const r=[];for(let n=0;n<e;n++)r.push(L(t,s,a));const o=[];for(let e=0;e<n;e++)o.push(r[e]);for(let t=n;t<e-n;t++){const e=x(r,t,n);o.push(e)}for(let t=e-n;t<e;t++)o.length<r.length&&o.push(r[t]);return o}function x(e,t,s){const a=2*s+1;let n=0;for(let a=t-s;a<=t+s;a++)n+=e[a];return Math.floor(n/a)}function k(e,t,s){const a=t.getWall(),r=a.getWallStart(),o=a.getWallEnd(),i=A().getUniformInt(r,o),l=a.getCoordAt(i);let c=null;switch(e){case u.OW.WTOWER:c="dwarven city";break;case u.OW.BTOWER:c="abandoned fort";break;case u.OW.WCAPITAL:c="capital";break;case u.OW.BCAPITAL:c="dark city";break;default:n.default.err("overworld.js","addMountainFortToSubLevel",`Type ${e} not supported`)}s.getMap().setBaseElems(l,d.ELEM.FORT);const h=new P(c,l);h.alignment=B(e),t.addFeature(h)}function B(e){switch(e){case u.OW.BCAPITAL:case u.OW.BTOWER:case u.OW.BVILLAGE:return n.default.ALIGN_EVIL;case u.OW.WCAPITAL:case u.OW.WTOWER:case u.OW.WVILLAGE:return n.default.ALIGN_GOOD;default:return n.default.ALIGN_NEUTRAL}}function G(e,t=!0){let s=!1;const a=e.getMap();let r=a.getFree().map(e=>e.getXY());if(!t){const{cols:e,rows:t}=a;r=r.filter(s=>0!==s[0]&&s[0]!==e-1&&0!==s[1]&&s[1]!==t-1)}if(0===r.length)return null;let o=[],i=10*S;for(;!s;){const e=A().arrayGetRand(r);let l=[];try{l=m.Geometry.getBoxAround(e[0],e[1],1)}catch(e){n.default.diag(e),n.default.diag(r),a.debugPrintInASCII()}if(!t){const{cols:e,rows:t}=a;l=l.filter(s=>0!==s[0]&&s[0]!==e-1&&0!==s[1]&&s[1]!==t-1)}if(l.forEach(e=>{if(!s&&a.hasXY(e[0],e[1])){a.getBaseElemXY(e[0],e[1]).getType()===E&&(o=[e],s=!0,a.setBaseElemXY(e[0],e[1],d.ELEM.FLOOR))}}),--i<=0)break}return o}function W(e,t,s){const{x:a,y:r}=s,o=Math.abs(e-a),i=Math.abs(t-r);s.maxDanger=n.default.getMaxDanger(o,i),s.maxValue=n.default.getMaxValue(o,i),A().getUniform()<=n.default.EPIC_PROB&&(s.isEpic=!0,s.maxDanger*=2,s.maxValue*=3)}function F(e,t,s){if(Number.isInteger(e)){const a=e+t*s;return a>=w&&console.warn(`WARNING mapX: ${a}, ${e}, ${t}, ${s}`),a}return n.default.err("overworld.js","mapX",`x must be an integer. Got: ${e}`),null}function Y(e,t,s){return Number.isInteger(e)?e+t*s:(n.default.err("overworld.js","mapY",`y must be an integer. Got: ${e}`),null)}function X(e,t,s){const a={name:"Blashyrkh",nQuarters:1,quarter:[{name:"Capital cave",nLevels:1}],owX:t.x,owY:t.y,presetLevels:{"Blashyrkh.Capital cave":[{nLevel:0,level:{stub:!0,new:"Capital",args:[200,500,{}]}}]}};U(e,t,a);const n={name:"Capital cave",levelX:a.levelX,levelY:a.levelY,nLevel:0,stairs:{getStairs:1}};a.connectToAreaXY[0].stairs={getStairs:0},a.connectToAreaXY.push(n),s.nCities+=1,s.city.push(a)}function $(e,t,s){const a={stub:!0,new:"DwarvenCity",args:[300,250,{}]},n={name:"Dwarven City",nQuarters:1,quarter:[{name:"Fort main level",nLevels:1}],owX:t.x,owY:t.y};n.presetLevels={"Dwarven City.Fort main level":[{nLevel:0,level:a}]},U(e,t,n);const r={name:"Fort main level",levelX:n.levelX,levelY:n.levelY,nLevel:0,stairs:{getStairs:1}};n.connectToAreaXY[0].stairs={getStairs:0},n.connectToAreaXY.push(r),s.nCities+=1,s.city.push(n)}function j(e,t,s){const a={stub:!0,new:"AbandonedFort",args:[500,200,{}]},n={name:"Abandoned fort",nQuarters:1,quarter:[{name:"Fort ground level",nLevels:1}],owX:t.x,owY:t.y};n.presetLevels={"Abandoned fort.Fort ground level":[{nLevel:0,level:a}]},U(e,t,n,!1);const r={name:"Fort ground level",levelX:n.levelX,levelY:n.levelY,nLevel:0,stairs:{getStairs:0}};n.connectToAreaXY[0].stairs={getStairs:1},n.connectToAreaXY.push(r),s.nCities+=1,s.city.push(n)}function V(e,t,s){e.coord;const a=r.Names.getUniqueName("city"),i=o.LevelGen.getCityConf(a,e);i.owX=t.x,i.owY=t.y,i.groupType=e.type,U(e,t,i),i.alignment=e.alignment||A().arrayGetRand(n.default.ALIGNMENTS),e.cellsAround&&(i.constraint||(i.constraint={}),i.constraint.cellsAround=e.cellsAround),s.nCities+=1,s.city.push(i)}function U(e,t,s,a=!0){const{slX:n,slY:r,aX:o,aY:i,subX:l,subY:c}=t,h=e.coord,u=h.length-1;let d=F(h[u][0],n,l),g=Y(h[u][1],r,c);if(a||(d=F(h[0][0],n,l)-1,g=Y(h[0][1],r,c)),g>=O&&(g-=1),_.test(e.type)){let e=F(h[0][0],n,l),t=Y(h[0][1],r,c);a||(e=F(h[u][0],n,l)+1,t=Y(h[u][1],r,c));const o=s.nQuarters-1;s.connectToAreaXY=[{name:s.quarter[o].name,levelX:e,levelY:t,nLevel:0}]}s.x=o,s.y=i,s.levelX=d,s.levelY=g,f(`Feat: ${e.type}, ${o},${i} : ${d},${g}`)}function K(e,t,s){const{slX:a,slY:r,aX:i,aY:l,subX:c,subY:h}=t,u=e.coord[7];if(n.default.isNullOrUndef([u])){const t="xy null/undef. feat: "+JSON.stringify(e);n.default.err("overworld.js","addBlackTowerConfToArea",t)}const d=F(u[0],a,c),g=Y(u[1],r,h),p=o.LevelGen.getDungeonConf("Elder raventhrone");b?(f("BlackTower: Placing to player position."),function(e,t){const[s,a]=H(t);Object.assign(e,{x:s,y:a,levelX:v,levelY:C}),console.log("BlackTower was added to tile",s,a),console.log("BlackTower was added to level X,Y",v,C)}(p,t)):Object.assign(p,{x:i,y:l,levelX:d,levelY:g}),f(`BlackTower: ${i},${l}, x,y ${d},${g}`),p.connectEdges=!0,p.branch[0].entranceLevel=0,p.branch[0].nLevels=5;const m=p.branch[0].nLevels-1;p.branch[0].createPresetLevels={new:"BlackTower",args:[180,90]},p.branch[0].create={actor:[{name:"Thabba, Son of Ice",nLevel:m},{name:"Zamoned, Son of Frost",nLevel:m}]},s.nDungeons+=1,s.dungeon.push(p)}function H(e){const{xMap:t,yMap:s,nSubLevelsX:a,nSubLevelsY:n}=e;return[Math.floor(a/t/2),n/s-1]}function q(e,t,s,a){const n=e*s,r=t*a;return[n,r+a-1,n+s-1,r]}function J(e){let[t,s]=e;return 0===t&&(t=1),t===w-1&&(t-=1),0===s&&(s=1),s===O-1&&(s-=1),[t,s]}t.CoordMap=I,t.OverWorld.CoordMap=I,t.OverWorld.createOverWorld=((e={})=>{const s=h.OWMap.createOverWorld(e);return t.OverWorld.createOverWorldLevel(s,e)}),t.OverWorld.createOverWorldLevel=((e,s)=>{const a=new I;return a.worldCols=s.worldX||400,a.worldRows=s.worldY||400,a.nTilesX=s.nTilesX||a.worldCols/w,a.nTilesY=s.nTilesY||a.worldRows/O,a.xMap=Math.floor(a.worldCols/e.getSizeX()),a.yMap=Math.floor(a.worldRows/e.getSizeY()),e.coordMap=a,T=s.addMainRoads||T,function(e,s){const{worldCols:a,worldRows:r,xMap:o,yMap:c,nTilesX:h,nTilesY:d}=s,g=e.getSizeX(),f=e.getSizeY(),y=(new p.FactoryLevel).createLevel(n.default.LEVEL_EMPTY,a,r);for(let t=0;t<g;t++)for(let s=0;s<f;s++){const a=D(e,t,s,o,c),n=t*o,r=s*c;m.Geometry.mergeLevels(y,a,n,r)}const _=t.OverWorld.createWorldConf(e,g,f,h,d);return function(e,t,s,a){const[r,o]=function(e,t){const s=Math.floor(e.getSizeX()/2-1)*w,a=t.worldRows-Math.floor(O/2);return[s,a]}(e,a),c=e.getFeaturesByType(u.OW.WCAPITAL)[0],h=e.getSubLevel(c).getFeaturesByType("capital")[0],d=h.getLastCoord(),[g,p]=a.toOwLevelXY(c,d);if(T){const e=i.Path.getWeightPathSegmented(t.getMap(),r,o,g,p,5);0===e.length&&n.default.err("overworld.js","addGlobalFeatures","No path from player to capital."),l.Builder.addPathToMap(t.getMap(),e)}const m=h.coord[0],f=a.toOwLevelXY(c,m),y=e.getFeaturesByType(u.OW.WTOWER)[0],_=e.getSubLevel(y).getFeaturesByType("dwarven city")[0].getLastCoord(),E=a.toOwLevelXY(y,_);if(T){const e=i.Path.getWeightPathSegmented(t.getMap(),f[0],f[1],E[0],E[1],5);l.Builder.addPathToMap(t.getMap(),e)}}(e,y,0,s),[y,_]}(e,a)}),t.OverWorld.createWorldConf=function(e,t,s,a,i){const l={name:"The North",nAreas:1,area:[{name:"The Northern Realm",maxX:a,maxY:i,biome:{},dungeon:[],mountain:[],city:[],nDungeons:0,nMountains:0,nCities:0}]},c=l.area[0];if(!t||!s){const e=`levels in X: ${t}, Y: ${s}`;n.default.err("OverWorld","createWorldConf",`Illegal num of sublevels: ${e}`)}const h=t/a,u=s/i;f(`nSubLevelsX: ${t}, nTilesX: ${a}`),f(`nSubLevelsY: ${s}, nTilesY: ${i}`),f(`MapX: ${h} levels to one tile`),f(`MapY: ${u} levels to one tile`),Number.isInteger(h)||n.default.err("OverWorld","createWorldConf",`xMap not int: ${h}, `+`sub X :${t}, nTilesX: ${a}`),Number.isInteger(u)||n.default.err("OverWorld","createWorldConf",`yMap not int: ${u}, `+`sub Y :${s}, nTilesY: ${i}`);for(let a=0;a<t;a++)for(let i=0;i<s;i++){const l=a%h,d=i%u,g=Math.floor(a/h),p=Math.floor(i/u),m=e.getSubLevel([a,i]),_=m.getSubX(),E=m.getSubY(),S={xMap:h,yMap:u,nSubLevelsX:t,nSubLevelsY:s,x:a,y:i,slX:l,slY:d,aX:g,aY:p,subLevel:m,subX:_,subY:E},[v,C]=H(S),b=m.getFeatures();Object.keys(b).forEach(e=>{b[e].forEach(e=>{if(e.coord||n.default.err("OverWorld","createWorldConf",`coord must exist. feat: ${JSON.stringify(e)}`),"capital"===e.type)X(e,S,c);else if("dwarven city"===e.type)$(e,S,c);else if("abandoned fort"===e.type)j(e,S,c);else if("dark city"===e.type)V(e,S,c);else if(y.test(e.type))V(e,S,c);else if("dungeon"===e.type){const t=e.coord;let s=F(t[0][0],l,_),n=Y(t[0][1],d,E);[s,n]=J([s,n]);const h=r.Names.getGenericPlaceName("dungeon"),u=o.LevelGen.getDungeonConf(h);Object.assign(u,{x:g,y:p,levelX:s,levelY:n,owX:a,owY:i}),c.nDungeons+=1,W(v,C,u),c.dungeon.push(u)}else if("mountain"===e.type){const t=e.coord,s=F(t[0][0],l,_),n=Y(t[0][1],d,E),h=r.Names.getUniqueName("mountain"),u=o.LevelGen.getMountainConf(h);Object.assign(u,{x:g,y:p,levelX:s,levelY:n,owX:a,owY:i}),W(v,C,u),c.nMountains+=1,c.mountain.push(u)}else"blacktower"===e.type&&(f("Adding final blacktower now"),K(e,S,c))})})}return function(e,t){const s=e.getSizeX(),a=e.getSizeY(),n=s/t.maxX,r=a/t.maxY;for(let s=0;s<t.maxX;s++)for(let a=0;a<t.maxY;a++){const o=q(s,a,n,r),i=s+","+a,l=e.getBiome(o[0],o[3]);t.biome[i]=l}}(e,c),l}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(4),i=s(16),l=n(s(2)),c=s(9),h=s(6),u=s(5),d={AddComp:!0,ModifyCompValue:!0,AddEntity:!0,AddElement:!0,RemoveElement:!0,ChangeElement:!0,RemoveComp:!0};let g=Object.keys(d);class p extends o.SystemBase{static addEffect(e,t){if(!d.hasOwnProperty(e)){const s="handle"+e.capitalize();return p.prototype[s]=t,d[e]=!0,g=Object.keys(d),!0}return r.default.err("SystemEffects","addEffect",`Effect ${e} already exists.`),!1}static getEffectTarget(e){const t=e.target;if(!t){const e="Possibly missing args for useItem().";r.default.err("system.effects.js","getEffectTarget",`Given object was null/undefined. ${e}`)}return p.getTargetFromObj(t,e.targetType)}static getTargetFromObj(e,t){if(!e.hasOwnProperty("target"))return e;{const s=e.target;let a=t;a||(a=["actors","items","elements","baseElem"]),Array.isArray(a)||(a=[a]);for(let e=0;e<a.length;e++){if(s.hasProp(a[e]))return s.getProp(a[e])[0];if(/base/.test(a[e]))return s.getBaseElem()}}return null}constructor(e,t){super(r.default.SYS.EFFECTS,e,t),this._dtable={},Object.keys(d).forEach(e=>{if(d[e]){const t="handle"+e.capitalize();this._dtable[e]=this[t].bind(this)}})}updateEntity(e){e.getList("Effects").forEach(t=>{const s=t.getEffectType();if(s&&""!==s)if(this._dtable.hasOwnProperty(s)){this._checkStartMsgEmits(e,t);const a=this._dtable[s](e,t);this._checkEndMsgEmits(e,t,a)}else r.default.err("SystemEffects","updateEntity",`Effect |${s}| not in handler list: ${g}`);else r.default.err("SystemEffects","updateEntity","No effect type in Effects comp");e.remove(t)})}_checkStartMsgEmits(e,t){const s=t.getArgs();s.startMsg&&r.default.gameMsg({cell:e.getCell(),msg:s.startMsg})}_checkEndMsgEmits(e,t,s){const a=t.getArgs();a.endMsg&&r.default.gameMsg({cell:e.getCell(),msg:a.endMsg}),s&&a.successMsg&&r.default.gameMsg({cell:e.getCell(),msg:a.successMsg}),!s&&a.failureMsg&&r.default.gameWarn({cell:e.getCell(),msg:a.failureMsg})}handleAddComp(e,t){const s=t.getArgs(),a=p.getEffectTarget(s),n=m(s,a);let o=null;if(l.hasOwnProperty(n)&&(o=new l[n]),s.setters){const e=s.setters;Object.keys(e).forEach(t=>{if("function"==typeof o[t]){const s=e[t],a=f(s);o[t](a)}else{const e=JSON.stringify(o);r.default.err("useEffect","addComp",`No ${t} in comp ${e}`)}})}o&&o.setSource&&o.setSource(e);const c=i.Dice.getValue(s.duration),h=s.expireMsg;return l.addToExpirationComp(a,o,c,h),!0}handleAddElement(e,t){const s=t.getArgs(),a=y(s);s.elementName||r.default.err("System.Effects","handleAddElement","No elementName found in useArgs: "+JSON.stringify(s));let n=u.Element.create(s.elementName);if(!n){n=h.ObjectShell.getParser().createEntity(s.elementName)}if(n){const[t,r]=[a.getX(),a.getY()],o=e.getLevel(),i=a.getPropType(n.getType());return(!i||i.length<s.numAllowed)&&(o.addElement(n,t,r)?("function"==typeof n.onSystemAdd&&n.onSystemAdd(a),!0):(console.error("Failed to add element "+s.elementName),!1))}{const e="Failed to create elem: "+JSON.stringify(s);r.default.err("System.Effects","handleAddElement",e)}return!1}handleRemoveElement(e,t){const s=t.getArgs(),a=y(s);s.elementName||r.default.err("System.Effects","handleRemoveElement","No elementName found in useArgs: "+JSON.stringify(s));const n=a.getPropType(s.elementName);if(n.length>0){const t=n[0],[s,r]=[a.getX(),a.getY()];if(e.getLevel().removeElement(t,s,r))return"function"==typeof t.onSystemRemove&&t.onSystemRemove(a),!0}return!1}handleModifyCompValue(e,t){const s=t.getArgs(),a=p.getEffectTarget(s),n=m(s,a);if(a&&a.has(n)){const e=a.get(n),t=e[s.get](),r=s.value,o=f(r);return e[s.set](t+o),!0}return!1}handleAddEntity(e,t){const s=t.getArgs(),a=y(s),n=h.ObjectShell.getParser().createEntity(s.entityName);if(n){const[t,r]=[a.getX(),a.getY()];if(e.getLevel().addEntity(n,t,r)){if(s.duration){const e=new l.Fading,{duration:t}=s;e.setDuration(t),n.add(e)}const t=new l.Created;return t.setCreator(e),n.add(t),!0}}return!1}handleChangeElement(e,t){const s=t.getArgs(),a=y(s),n=s.fromType,r=s.toType||c.ELEM.FLOOR;return a.getBaseElem().getType()===n&&(a.setBaseElem(r),!0)}handleRemoveComp(e,t){const s=t.getArgs(),a=p.getEffectTarget(s),n=m(s,a);return!!a.has(n)&&(s.all?a.removeAll(n):a.remove(n),!0)}}function m(e,t){const s=e.name;if(!s){let s="Unknown comp value. useArgs: "+JSON.stringify(e);t&&(s+=" targetEnt "+JSON.stringify(t)),r.default.err("SystemEffects","handleModifyCompValue",s)}return s.capitalize()}t.SystemEffects=p,p.handlerTable=d;const f=function(e){if(Number.isInteger(e))return e;if("string"==typeof e){const t=Number.parseFloat(e);if(!Number.isNaN(t))return t}return e};function y(e){if(e.target){const t=e.target;if(t.target)return t.target}const t=JSON.stringify(e);return r.default.err("system.effects.js","getTargetCellOrFail","Prop target must exist in useArgs "+t),null}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(41),i=n(s(22)),l=n(s(19)),c=n(s(13));t.Chat={};const h=r.default.STATS,u=i.Menu.EXIT_MENU,d={name:"Say goodbye",option:u};t.Chat.tradeGoldWeightFromTo=((e,t,s)=>{const a=r.default.getGoldInCoins(e),n=new l.GoldCoin,o=r.default.removeNCoins(t,a);n.setCount(o),s.getInvEq().addItem(n)});class g{constructor(){this.options=[],this.parent=null}add({name:e,option:t}){this.options.push({name:e,option:t}),t&&t.setParent&&t.setParent(this)}clearOptions(){this.options=[]}setParent(e){this.parent=e}getParent(){return this.parent}getSelectionObject(){return{showMenu:()=>!0,getMenu:()=>{const e={pre:[],post:[]};return this.options.forEach((t,s)=>{e[o.Keys.menuIndices[s]]=t.name}),this.pre&&(e.pre=this.pre),this.post&&(e.post=this.post),e.Q=d.name,e},select:e=>{const t=o.Keys.codeToIndex(e);if(t<this.options.length){const e=this.options[t].option;return e!==u&&e.getSelectionObject?e.getSelectionObject():e}return u}}}}t.ChatBase=g,t.Chat.ChatBase=g;class p extends g{constructor(){super();const e={name:"Accept the quest",option:this.questCallback.bind(this)},t={name:"Refuse the quest",option:u};this.add(e),this.add(t)}setQuestGiver(e){this.questGiver=e}setTarget(e){const t=this.questGiver;this.chatter=e;const s=this.questGiver.get("QuestGiver");if(s.getHasGivenQuest()){this.pre=[`${t.getName()} has already given this quest:`,`${s.getDescr()}`,"What do you want to do?"],this.clearOptions();const e={name:"Claim the reward",option:this.rewardCallback.bind(this)};this.add(e)}else this.pre=[`${t.getName()} wants to offer a lengthy quest:`,`${s.getDescr()}`,"What do you want to do?"]}questCallback(){r.default.isNullOrUndef([this.chatter,this.questGiver])&&r.default.err("ChatQuest","questCallback","target and questGiver must be defined");const e=new c.GiveQuest;e.setTarget(this.chatter),e.setGiver(this.questGiver),this.chatter.add(e)}rewardCallback(){const e=new c.QuestCompleted;e.setGiver(this.questGiver),this.chatter.add(e)}}t.ChatQuest=p,t.Chat.Quest=p;class m extends g{constructor(){super(),this.selectionObject={showMenu:()=>!0,pre:["Please select a stat to train:"],getMenu:()=>{const e=o.Keys.menuIndices.slice(0,6),t={};return h.forEach((s,a)=>{t[e[a]]=h[a],t[e[a]]+=` (${this.costs[a]} gold)`}),t},select:e=>{const t=o.Keys.codeToIndex(e);if(t<h.length){const e=h[t],s=this.costs[t];return this.trainCallback(e,s)}return null}},this.trainCallback=this.trainCallback.bind(this)}setTrainer(e){this.trainer=e}setTarget(e){this.chatter=e,this.costs=[],h.forEach(t=>{const s="get"+t;this.costs.push(100*e.get("Stats")[s]())})}getSelectionObject(){return this.selectionObject}trainCallback(e,s){return()=>{const a=r.default.valueToGoldWeight(s),n=this.chatter.getName();if(!r.default.hasEnoughGold(this.chatter,a)){const e=`${n} does not have enough gold.`;return void r.default.gameMsg({cell:this.chatter.getCell(),msg:e})}t.Chat.tradeGoldWeightFromTo(a,this.chatter,this.trainer);const o=this.chatter.get("Stats"),i=this.trainer.get("Stats"),l="get"+e,c="set"+e,h=o[l](),u=i[l](),d=this.trainer.getName();if(h<u){const t=h+1;o[c](t);const s=`${d} trains ${e} of ${n}`;r.default.gameMsg({cell:this.chatter.getCell(),msg:s})}else{const e=`${d} doesn't have skill to train that stat`;r.default.gameMsg({cell:this.chatter.getCell(),msg:e})}}}}t.ChatTrainer=m,t.Chat.Trainer=m;class f extends g{constructor(){super(),this.costs={0:10,1:45,2:50},this.selectionObject={showMenu:()=>!0,getMenu:()=>{r.default.gameMsg("Please select a magical service to buy:");const e=this.wizard.get("SpellPower").getPP(),t={};e>=10&&(t[0]="Restore 10pp - 10 gold coins"),e>=50&&(t[1]="Restore 50pp - 45 gold coins"),e>=25&&(t[2]="Add one charge to rune - 50 gold coins")},select:e=>{const t=o.Keys.codeToIndex(e);return this.wizardCallback(t)}},this.wizardCallback=this.wizardCallback.bind(this)}setWizard(e){this.wizard=e}getSelectionObject(){return this.selectionObject}wizardCallback(e){const t=this.costs[e];return()=>{if(r.default.hasEnoughGold(this.chatter,t))switch(e){case 0:this.restorePP(10);break;case 1:this.restorePP(50);break;case 2:this.setRuneSelectionObject()}}}restorePP(e){this.wizard.get("SpellPower").decrPP(e),this.chatter.get("SpellPower").addPP(e)}setRuneSelectionObject(){this.chatter.getBrain().setSelectionObject({})}}t.ChatWizard=f,t.Chat.Wizard=f},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(18),o=s(10);t.MindControl=function(){r.ComponentBase.call(this,"MindControl");let e=null,t=null;this.getSource=(()=>e),this.setSource=(t=>{e=t});this.addCallback("onAdd",()=>{const e=this.getEntity();t=e.getBrain(),this.getSource().isPlayer()?e.setPlayerCtrl(!0):e.setBrain(new o.BrainMindControl(e))}),this.addCallback("onRemove",()=>{this.getSource().isPlayer()&&this.getEntity().setPlayerCtrl(!1),this.getEntity().setBrain(t)})},n.default.extend2(t.MindControl,r.ComponentBase),t.MindControl.prototype.toJSON=function(){const e=r.ComponentBase.prototype.toJSON.call(this);return n.default.isActorActive(this.getSource())&&(e.setSource=n.default.getObjRef("entity",this.getSource())),e}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(43),i=s(26),l=s(31),c=n(s(2)),{GOAL_ACTIVE:h,GOAL_COMPLETED:u}=o.GoalStatus;t.GoalsBattle={},t.orderWithGoal=((e,t)=>{const{bias:s}=t,a=new i.Evaluator.Orders(s);if(a.setArgs({srcActor:t.src,goal:t.goal}),e.isPlayer()){const s=new c.BattleOrder,a={srcActor:t.src};s.setArgs(a),e.add(s)}else{const t=e.getBrain();if("function"==typeof t.getGoal){const e=t.getGoal();e.clearOrders(),e.giveOrders(a)}else{const t="Actor without getGoal: "+JSON.stringify(e);r.default.warn("goals-battle.js","orderWithGoal",t)}}}),t.GoalsBattle.orderWithGoal=t.orderWithGoal,t.injectOrderEval=((e,t,s)=>{if(l.isSentient(e)){const a=new i.Evaluator.Orders(s.bias);a.setArgs({srcActor:s.src,goal:t});const n=e.getBrain().getGoal();n.clearOrders(),n.giveOrders(a)}}),t.giveFollowOrder=((e,s)=>{if(l.isSentient(e)){const a=new o.Goal.Follow(e,s.src);t.injectOrderEval(e,a,s)}}),t.GoalsBattle.giveFollowOrder=t.giveFollowOrder,t.giveAttackOrder=((e,s)=>{if(l.isSentient(e)){const a=new o.Goal.AttackActor(e,s.enemy);t.injectOrderEval(e,a,s)}}),t.GoalsBattle.giveAttackOrder=t.giveAttackOrder,t.givePickupOrder=((e,s)=>{if(l.isSentient(e)){const a=new o.Goal.GetItem(e,s.item);t.injectOrderEval(e,a,s)}}),t.GoalsBattle.givePickupOrder=t.givePickupOrder,t.giveClearOrders=((e,t)=>{if(l.isSentient(e)){const{src:s}=t;if(!e.isEnemy(s)){e.getBrain().getGoal().clearOrders()}}}),t.GoalsBattle.giveClearOrders=t.giveClearOrders;class d extends o.GoalBase{constructor(e){super(e),this.setType("GoalWinBattle")}activate(){const e=this.actor.getBrain(),t=e.getSeenCells();e.findEnemyCell(t)?(this.addSubGoal(new f(this.actor)),this.dbg("Activated goal. Added EngageEnemy")):(this.addSubGoal(new m(this.actor)),this.dbg("Activated goal. Added FindEnemyArmy")),this.status=h}process(){return this.dbg("process() begin"),this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}t.GoalWinBattle=d,t.GoalsBattle.WinBattle=d;class g extends o.GoalBase{constructor(e){super(e),this.setType("GoalFollowArmy")}activate(){}process(){return this.activateIfInactive(),this.status=u,this.status}}t.GoalFollowArmy=g,t.GoalsBattle.FollowArmy=g;class p{constructor(e,t,s){const a=e.getMap(),[n,r]=[a.cols,a.rows];let o=Math.floor(n/t),i=Math.floor(r/s);n%t!=0&&++o,r%s!=0&&++i,this.grid=[];for(let e=0;e<o;e++){this.grid[e]=[];for(let t=0;t<i;t++)this.grid[e][t]={data:[e,t]}}this.gridCols=o,this.gridRows=i,this.xMap=t,this.yMap=s,this.xMapHalf=Math.floor(t/2),this.yMapHalf=Math.floor(s/2)}getCenterLevelXY(e){const[t,s]=e;return[t*this.xMap+this.xMapHalf,s*this.yMap+this.yMapHalf]}getGridXY(e){const[t,s]=e;return[Math.floor(t/this.xMap),Math.floor(s/this.yMap)]}setDataLevelXY(e,t,s){const[a,n]=this.getGridXY(e);this.grid[a][n][t]=s}setDataGridXY(e,t,s){const[a,n]=e;this.grid[a][n][t]=s}isTrue(e,t){const[s,a]=e;return!0===this.grid[s][a][t]}hasProp(e,t){const[s,a]=e;return this.grid[s][a].hasOwnProperty(t)}getDataGridXY(e){const[t,s]=e;return this.grid[t][s]}getDataLevelXY(e){const[t,s]=this.getGridXY(e);return this.grid[t][s]}debugPrint(){for(let e=0;e<this.gridRows;e++){let t="||";for(let s=0;s<this.gridCols;s++)t+=JSON.stringify(this.grid[s][e])+" ||";r.default.diag(t),r.default.diag("=".repeat(t.length))}}}t.LevelGrid=p;class m extends o.GoalBase{constructor(e){super(e),this.setType("GoalFindEnemyArmy");const t=e.getLevel();this.gridSeen=new p(t,10,10);const[s,a]=this.actor.getXY();this.gridSeen.setDataLevelXY([s,a],"seen",!0),this.adjustRate=50}activate(){this.selectDirToMove(),this.status=h}process(){return this.activateIfInactive(),this.adjustRate>0?--this.adjustRate:(this.selectDirToMove(),this.adjustRate=50),this.status=this.processSubGoals(),this.status}selectDirToMove(){const e=this.actor.getBrain(),s=[0,0],a=this.actor.getLevel(),[n,r]=this.actor.getXY(),i=a.getMap().cols/2,l=a.getMap().rows/2;n<i?s[0]=1:n>i&&(s[0]=-1),r<l?s[1]=1:r>l&&(s[1]=-1),this.dbg(`Cmd army to move to dir ${s}`);const c=e.getSeenFriends();this.dbg(`${c.length} friends found for command`),c.forEach(e=>{const a=new o.Goal.MoveUntilEnemy(e,s);t.orderWithGoal(e,{src:this.actor,bias:1,goal:a})}),this.dbg("Issued Move order to "+c.length+" actors");const h=new o.Goal.MoveUntilEnemy(this.actor,s);this.removeAllSubGoals(),this.addSubGoal(h)}}t.GoalFindEnemyArmy=m,t.GoalsBattle.FindEnemyArmy=m;class f extends o.GoalBase{constructor(e){super(e),this.setType("GoalEngageEnemy")}activate(){this.dbg("ATTACK ENEMY activate()");const e=this.actor.getBrain(),s=e.getSeenEnemies();if(0===s.length)return;e.getSeenFriends().forEach(e=>{const a=new o.Goal.AttackActor(e,s[0]);t.orderWithGoal(e,{src:this.actor,bias:2,goal:a})}),this.enemy=s[0];const a=new o.Goal.AttackActor(this.actor,s[0]);this.addSubGoal(a),this.status=h}process(){return this.activateIfInactive(),this.dbg("ATTACK ENEMY process()"),this.status=this.processSubGoals(),this.status}}t.GoalEngageEnemy=f,t.GoalsBattle.EngageEnemy=f;class y extends o.GoalBase{constructor(e){super(e),this.setType("GoalHoldPosition")}}t.GoalHoldPosition=y,t.GoalsBattle.HoldPosition=y;class _ extends o.GoalBase{constructor(e){super(e),this.setType("GoalRetreat")}}t.GoalRetreat=_,t.GoalsBattle.Retreat=_},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(44);t.Spell=o.Spell;const i=n(s(2)),l=s(16),c=s(6),h=s(10),u=s(1),d=n(s(5)),g=u.Random.getRNG(),{getDirSpellArgs:p,aiSpellCellEnemy:m,aiSpellCellFriend:f,aiSpellCellSelf:y,addPoisonEffect:_,addFadingActorToCell:E,aiSpellCellDone:S}=o.Spell;o.Spell.DispelMagic=function(){o.Spell.RemoveComponent.call(this,"DispelMagic",8),this.setCompNames("Duration")},r.default.extend2(o.Spell.DispelMagic,o.Spell.RemoveComponent),o.Spell.Charm=function(){o.SpellBase.call(this,"Charm"),this._dice.duration=l.Dice.create("10d6 + 5")},r.default.extend2(o.Spell.Charm,o.SpellBase),o.Spell.Charm.prototype.cast=function(e){const t=p(this,e),s=new i.SpellCell;t.callback=this.charmCallback.bind(this),s.setArgs(t),e.src.add(s)},o.Spell.Charm.prototype.charmCallback=function(e){const t=e.getSentientActors();if(t&&t.length>0){const e=t[0];let s=1+this.getCasterExpBonus(3);s+=this.getCasterStatBonus("willpower",3);const a=new i.Charm;a.setTargetActor(e.getID()),a.setLevel(s);const n=this.getDuration();i.addToExpirationComp(this.getCaster(),a,n);const o=this.getCaster(),l=`${o.getName()} charms ${e.getName()}`;r.default.gameMsg({cell:o.getCell(),msg:l})}},o.Spell.Charm.prototype.getSelectionObject=function(e){return o.Spell.getSelectionObjectDir(this,e,"Select a direction for charming:")},o.Spell.Charm.prototype.aiShouldCastSpell=function(e,t){return m(e,t)},o.Spell.GraspOfWinter=function(){o.SpellBase.call(this,"Grasp of winter"),this._dice.damage=l.Dice.create("4d4 + 4")},r.default.extend2(o.Spell.GraspOfWinter,o.SpellBase),o.Spell.GraspOfWinter.prototype.cast=function(e){const t=p(this,e);t.damageType=r.default.DMG.ICE,t.damage=this.getDamage();const s=new i.SpellCell;s.setArgs(t),e.src.add(s)},o.Spell.GraspOfWinter.prototype.getSelectionObject=function(e){return o.Spell.getSelectionObjectDir(this,e,"Select a direction for grasping:")},o.Spell.GraspOfWinter.prototype.aiShouldCastSpell=function(e,t){return m(e,t)},o.Spell.AnimateDead=function(){o.Spell.AddComponent.call(this,"AnimateDead",5),this.setCompName("Undead"),delete this._dice.duration},r.default.extend2(o.Spell.AnimateDead,o.Spell.AddComponent),o.Spell.AnimateDead.prototype.cast=function(e){o.Spell.AddComponent.prototype.cast.call(this,e);const{src:t}=e;t.get("SpellCell").getArgs().callback=this.animateCallback.bind(this)},o.Spell.AnimateDead.prototype.animateCallback=function(e){const t=["Named","Stats","Combat","Experience"],s=this.getCaster();if(!e.hasItems())return;const a=e.getItems().find(e=>/corpse/.test(e.getName()));if(a.has("Undead")){const e=`${s.getName()} fails to reanimate undead remains`;r.default.gameMsg({cell:s.getCell(),msg:e})}else if(a){const e=c.ObjectShell.getParser().createActor(a.getActorName());e.add(new i.Undead),t.forEach(t=>{const s=a.get(t);e.remove(t),s.changeEntity(e)}),e.get("Named").prepend("undead "),r.default.addCellStyle(r.default.TYPE_ACTOR,e.get("Named").getName(),"cell-actor-undead");const[n,o]=a.getXY(),l=s.getLevel(),h=new i.Created;h.setCreator(s),e.add(h),e.add(new i.Undead),l.removeItem(a,n,o)&&(l.addActor(e,n,o),e.addFriend(s))}},o.Spell.AnimateDead.prototype.aiShouldCastSpell=((e,t)=>{const s=e.actor,a=h.Brain.getCellsAroundActor(s).filter(e=>e.hasItems()&&e.getItems().find(e=>"corpse"===e.getType()));if(0===a.length)return!1;const n=g.arrayGetRand(a);return S(s,n,t),!0}),o.Spell.Flying=function(){o.Spell.AddComponent.call(this,"Flying",5),this.setCompName("Flying"),this._dice.duration=l.Dice.create("10d5 + 5"),this.aiShouldCastSpell=((e,t)=>f(e,t))},r.default.extend2(o.Spell.Flying,o.Spell.AddComponent),o.Spell.Telepathy=function(){o.Spell.AddComponent.call(this,"Telepathy",5),this.setCompName("Telepathy"),this._dice.duration=l.Dice.create("10d10 + 10"),this.aiShouldCastSpell=((e,t)=>{let s=f(e,t);return s||(s=m(e,t)),s})},r.default.extend2(o.Spell.Telepathy,o.Spell.AddComponent),o.Spell.Telepathy.prototype.cast=function(e){o.Spell.AddComponent.prototype.cast.call(this,e);const{src:t}=e;if(t){const s=t.get("SpellCell").getArgs(),{addComp:a}=s,n=a.comp;if("Telepathy"===n.getType()){const{duration:r}=a,o=n.clone();let l={dir:[0,0],src:this._caster,spell:null};(l=p(this,l)).addComp={comp:o,duration:r},s.postCallback=(e=>{n.setSource(t),n.setTarget(e.getSentientActors()[0])}),l.postCallback=(()=>{o.setSource(n.getSource()),o.setTarget(n.getTarget())});const c=new i.SpellCell;c.setArgs(l),e.src.add(c)}}else{const t=JSON.stringify(e);r.default.err("Spell.Telepathy","cast","No src found in args: "+t)}},o.Spell.Paralysis=function(){o.Spell.AddComponent.call(this,"Paralysis",7),this.setCompName("Paralysis"),this.setDuration(l.Dice.create("1d6 + 2")),this.aiShouldCastSpell=((e,t)=>m(e,t))},r.default.extend2(o.Spell.Paralysis,o.Spell.AddComponent),o.Spell.StunningTouch=function(){o.Spell.AddComponent.call(this,"StunningTouch",7),this.setCompName("Stun"),this.setDuration(l.Dice.create("1d6 + 2")),this.aiShouldCastSpell=((e,t)=>m(e,t))},r.default.extend2(o.Spell.StunningTouch,o.Spell.AddComponent),o.Spell.SpiritForm=function(){o.Spell.AddComponent.call(this,"SpiritForm",10),this.setCompName("Ethereal"),this.setDuration(l.Dice.create("1d6 + 4")),this.aiShouldCastSpell=((e,t)=>f(e,t))},r.default.extend2(o.Spell.SpiritForm,o.Spell.AddComponent),o.Spell.FrostBolt=function(){o.Spell.BoltBase.call(this,"Frost bolt",5),this.setDice("damage",l.Dice.create("4d4 + 4")),this.setRange(5),this.damageType=r.default.DMG.ICE},r.default.extend2(o.Spell.FrostBolt,o.Spell.BoltBase),o.Spell.LightningBolt=function(){o.Spell.BoltBase.call(this,"Lightning bolt",8),this.damageType=r.default.DMG.LIGHTNING,this.setRange(6),this.setDice("damage",l.Dice.create("6d3 + 3"))},r.default.extend2(o.Spell.LightningBolt,o.Spell.BoltBase),o.Spell.ScorpionsTail=function(){o.Spell.BoltBase.call(this,"Scorpions tail",1),this.damageType=r.default.DMG.MELEE,this.setRange(2),this.setDice("damage",l.Dice.create("2d4 + 2"))},r.default.extend2(o.Spell.ScorpionsTail,o.Spell.BoltBase),o.Spell.ScorpionsTail.prototype.onHit=function(e,t){_(e,t)},o.Spell.ShadowRay=function(){o.Spell.BoltBase.call(this,"Shadow ray",8),this.setDice("damage",l.Dice.create("6d4 + 4")),this.setRange(8),this.damageType=r.default.DMG.NECRO},r.default.extend2(o.Spell.ShadowRay,o.Spell.BoltBase),o.Spell.CrossBolt=function(){o.Spell.BoltBase.call(this,"Cross bolt",20),this.damageType=r.default.DMG.LIGHTNING,this.setRange(6),this.setDice("damage",l.Dice.create("6d3 + 3")),this.cast=function(e){const t=e.dir;let s=r.default.DIR_NSEW;0!==t[0]&&0!==t[1]&&(s=r.default.DIR_DIAG),s.forEach(t=>{const s=Object.assign({},e);s.dir=t;const a=p(this,s);a.damageType=this.damageType,a.damage=this.rollDice("damage");const n=new i.SpellRay;n.setArgs(a),e.src.add(n)})}},r.default.extend2(o.Spell.CrossBolt,o.Spell.BoltBase),o.Spell.PoisonBreath=function(){o.Spell.BoltBase.call(this,"PoisonBreath",8),this.setDice("damage",l.Dice.create("6d4 + 4")),this.setRange(8),this.damageType=r.default.DMG.POISON,this.nActors=2,this.stopOnHit=!0,this._createdActor="Poison gas",this._dice.duration=l.Dice.create("5d5 + 5")},r.default.extend2(o.Spell.PoisonBreath,o.Spell.BoltBase),o.Spell.PoisonBreath.prototype.onHit=function(e,t){_(e,t);const s=c.ObjectShell.getParser(),a=h.Brain.getCellsAroundActor(e,1);for(let e=0;e<this.nActors;e++){const e=g.arrayGetRand(a);if(e.isPassable()||e.hasActors()){const t=s.createActor(this._createdActor);E(t,e,this)}}const n=`Poison clouds spread from poison breath of ${t.getName()}`;r.default.gameSuccess({cell:e.getCell(),msg:n})},o.Spell.WaterBolt=function(){o.Spell.BoltBase.call(this,"WaterBolt",10),this.setDice("damage",l.Dice.create("4d4 + 4")),this.setRange(5),this.damageType=r.default.DMG.WATER},r.default.extend2(o.Spell.WaterBolt,o.Spell.BoltBase),o.Spell.SlimeBolt=function(){o.Spell.BoltBase.call(this,"SlimeBolt",10),this.setDice("damage",l.Dice.create("4d4 + 4")),this.setRange(5),this.damageType=r.default.DMG.SLIME,this.stopOnHit=!0},r.default.extend2(o.Spell.SlimeBolt,o.Spell.BoltBase),o.Spell.SlimeBolt.prototype.onHit=function(e,t){const s=e.getLevel();h.Brain.getCellsAroundActor(e,1).forEach(e=>{if(e.isPassable()||e.hasActors()){const t=new d.ElementSlime;s.addElement(t,e.getX(),e.getY())}}),e.add(new i.Entrapped);const a=`Slime is spread around by ${t.getName()}`;r.default.gameSuccess({cell:e.getCell(),msg:a})},o.Spell.IceShield=function(){o.SpellBase.call(this,"Ice shield",6),this._dice.duration=l.Dice.create("5d5 + 15"),this._dice.defense=l.Dice.create("1d6 + 3"),this.cast=(e=>{const t=e.src,s=this.getDuration(),a=new i.CombatMods;a.setDefense(this.rollDice("defense")),i.addToExpirationComp(t,a,s),r.default.gameMsg({cell:t.getCell(),msg:`${t.getName()} is surrounded by defensive aura`})}),this.getSelectionObject=function(e){return o.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=((e,t)=>f(e,t))},r.default.extend2(o.Spell.IceShield,o.SpellBase),o.Spell.IceShield.prototype.toString=function(){let e=o.SpellBase.prototype.toString.call(this);return e+=` Def: ${this._dice.defense.toString()}`},o.Spell.MagicArmor=function(){o.SpellBase.call(this,"MagicArmor",5),this._dice.duration=l.Dice.create("6d5 + 15"),this._dice.protection=l.Dice.create("2d6 + 2"),this.cast=(e=>{const t=e.src,s=t.getName(),a={target:t,name:"CombatMods",setters:{setProtection:this.rollDice("protection")},duration:this._dice.duration,startMsg:`${s} is surrounded by a protective aura`,expireMsg:`Protective aura disappears from ${s}`},n=new i.Effects(a);n.setEffectType("AddComp"),t.add(n)}),this.getSelectionObject=function(e){return o.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=((e,t)=>f(e,t))},r.default.extend2(o.Spell.MagicArmor,o.SpellBase),o.Spell.MagicArmor.prototype.toString=function(){let e=o.SpellBase.prototype.toString.call(this);return e+=` Pro: ${this._dice.protection.toString()}`},o.Spell.IcyPrison=function(){o.SpellBase.call(this,"Icy prison",10),this._dice.duration=l.Dice.create("1d8 + 1"),this.cast=function(e){const t=p(this,e),s=this.getDuration(),a=new i.Paralysis;a.setSource(e.src),t.addComp={comp:a,duration:s};const n=new i.SpellCell;n.setArgs(t),e.src.add(n)},this.getSelectionObject=function(e){return o.Spell.getSelectionObjectDir(this,e,"Select a direction for casting:")},this.aiShouldCastSpell=((e,t)=>m(e,t))},r.default.extend2(o.Spell.IcyPrison,o.SpellBase),o.Spell.SummonIceMinion=function(){o.Spell.SummonBase.call(this,"SummonIceMinion",14),this.summonType="Ice minion"},r.default.extend2(o.Spell.SummonIceMinion,o.Spell.SummonBase),o.Spell.SummonAirElemental=function(){o.Spell.SummonBase.call(this,"SummonAirElemental",20),this.summonFunc=(e=>"air elemental"===e.name)},r.default.extend2(o.Spell.SummonAirElemental,o.Spell.SummonBase),o.Spell.SummonUndeadUnicorns=function(){o.Spell.SummonBase.call(this,"SummonUndeadUnicorns",15),this.nActors="1d4 + 1",this.summonFunc=(e=>"undead unicorn"===e.name)},r.default.extend2(o.Spell.SummonUndeadUnicorns,o.Spell.SummonBase),o.Spell.SummonAnimal=function(){o.Spell.SummonBase.call(this,"SummonAnimal",10),this.summonFunc=(e=>{const t=this.getCaster().get("Experience").getExpLevel();let s=Math.round(t/3)||1;s>10&&(s=10);const a=Math.round(t/2);return"animal"===e.type&&e.danger>=s&&e.danger<=a})},r.default.extend2(o.Spell.SummonAnimal,o.Spell.SummonBase),o.Spell.SummonDead=function(){o.Spell.SummonBase.call(this,"SummonDead",15),this.nActors=4,this.summonFunc=(e=>"undead"===e.type&&e.name!==this.getCaster().getName())},r.default.extend2(o.Spell.SummonDead,o.Spell.SummonBase),o.Spell.SummonSpiders=function(){o.Spell.SummonBase.call(this,"SummonSpiders",10),this.nActors="1d4 + 1",this.summonFunc=(e=>{const t=this.getCaster().get("Experience"),s=t.getDanger(),a=t.getExpLevel(),n=s+Math.round(a/2);return/spider/.test(e.name)&&e.danger<=n})},r.default.extend2(o.Spell.SummonSpiders,o.Spell.SummonBase),o.Spell.SummonKin=function(){o.Spell.SummonBase.call(this,"SummonKin",10),this.summonFunc=(e=>{const t=this.getCaster().getType(),s=this.getCaster().get("Experience"),a=s.getDanger(),n=s.getExpLevel(),r=a+Math.round(n/2);return e.type===t&&e.danger<=r})},r.default.extend2(o.Spell.SummonKin,o.Spell.SummonBase),o.Spell.SummonFlyingEyes=function(){o.Spell.SummonBase.call(this,"SummonFlyingEyes",4),this.summonType="flying eye",this.nActors="1d6 + 1",this._dice.duration=l.Dice.create("10d5 + 10"),this.postSummonCallback=((e,t,s)=>{const a=new i.Fading,n=this.getDuration();a.setDuration(n),s.add(a);const r=new i.Telepathy;r.setTarget(s),r.setSource(this._caster);const o=r.clone();i.addToExpirationComp(s,r,n),i.addToExpirationComp(this._caster,o,n)}),this.aiShouldCastSpell=((e,t)=>{const{actor:s}=e;return!s.has("Telepathy")&&(e.dir=[0,0],t(s,e),!0)})},r.default.extend2(o.Spell.SummonFlyingEyes,o.Spell.SummonBase),o.Spell.PowerDrain=function(){o.SpellBase.call(this,"PowerDrain",15),this._dice.duration=l.Dice.create("20d5 + 10"),this.cast=(e=>{const t=e.src,s=this.getDuration(),a=new i.PowerDrain;i.addToExpirationComp(t,a,s),r.default.gameMsg({cell:t.getCell(),msg:`${t.getName()} is surrounded by purple aura`})}),this.getSelectionObject=function(e){return o.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=((e,t)=>(this.compFuncArgs={enemy:e.enemy},e.compFunc=this.aiCompFunc.bind(this),y(e,t))),this.aiCompFunc=(e=>{const{enemy:t}=this.compFuncArgs;return!!t&&!(e.has("PowerDrain")||!t.has("SpellPower"))})},r.default.extend2(o.Spell.PowerDrain,o.SpellBase),o.Spell.IceArrow=function(){o.Spell.Missile.call(this,"IceArrow",16),this.setRange(9),this.damageType=r.default.DMG.ICE,this.ammoName="Ice arrow"},r.default.extend2(o.Spell.IceArrow,o.Spell.Missile),o.Spell.LightningArrow=function(){o.Spell.Missile.call(this,"LightningArrow",14),this.setRange(8),this.damageType=r.default.DMG.LIGHTNING,this.ammoName="Lightning arrow"},r.default.extend2(o.Spell.LightningArrow,o.Spell.Missile),o.Spell.EnergyArrow=function(){o.Spell.Missile.call(this,"EnergyArrow",2),this.setRange(5),this.setDice("damage",l.Dice.create("1d4 + 1")),this.damageType=r.default.DMG.ENERGY,this.ammoName="Energy arrow"},r.default.extend2(o.Spell.EnergyArrow,o.Spell.Missile),o.Spell.PoisonArrow=function(){o.Spell.Missile.call(this,"PoisonArrow",20),this.setRange(10),this.setDice("damage",l.Dice.create("1d6 + 2")),this.damageType=r.default.DMG.POISON,this.ammoName="Poison arrow"},r.default.extend2(o.Spell.PoisonArrow,o.Spell.Missile),o.Spell.PoisonArrow.prototype.cast=function(e){o.Spell.Missile.prototype.cast.call(this,e),e.src.get("SpellMissile").onHit=this.onHit.bind(this)},o.Spell.PoisonArrow.prototype.onHit=function(e){const t=this._caster;_(e,t)},o.Spell.ArrowOfWebs=function(){o.Spell.Missile.call(this,"ArrowOfWebs",10),this.setRange(7),this.setDice("damage",l.Dice.create("1d6 + 2")),this.damageType=r.default.DMG.PIERCE,this.ammoName="Arrow of webs"},r.default.extend2(o.Spell.ArrowOfWebs,o.Spell.Missile),o.Spell.ArrowOfWebs.prototype.cast=function(e){o.Spell.Missile.prototype.cast.call(this,e),e.src.get("SpellMissile").onHit=this.onHit.bind(this)},o.Spell.ArrowOfWebs.prototype.onHit=function(e){const t=this._caster,s={target:{target:e.getCell()},targetType:["cell"],elementName:"Web",effectType:"AddElement",numAllowed:1},a=new i.Effects(s);t.add(a)},o.Spell.RockStorm=function(){o.Spell.Missile.call(this,"RockStorm",35),this.setRange(4),this.setDice("damage",l.Dice.create("5d4 + 1")),this.damageType=r.default.DMG.MELEE,this.ammoName="Huge rock",this.cast=function(e){const[t,s]=[e.src.getX(),e.src.getY()];Object.values(r.default.DIR).forEach(a=>{const n=t+this.getRange()*a[0],r=s+this.getRange()*a[1],o={from:[t,s],spell:this,src:e.src,to:[n,r]};o.damageType=this.damageType,o.damage=this.getDamage(),o.destroyItem=!1;const l=new i.SpellMissile;l.setArgs(o),e.src.add(l)})},this.getSelectionObject=function(e){return o.Spell.getSelectionObjectSelf(this,e)}},r.default.extend2(o.Spell.RockStorm,o.Spell.Missile),o.Spell.MindControl=function(){o.SpellBase.call(this,"MindControl",25),this._dice.duration=l.Dice.create("1d6 + 3"),this.cast=function(e){const t=p(this,e),s=this.getDuration(),a=new i.MindControl;a.setSource(e.src),t.addComp={comp:a,duration:s};const n=new i.SpellCell;n.setArgs(t),e.src.add(n)},this.getSelectionObject=function(e){return o.Spell.getSelectionObjectDir(this,e,"Select an actor to control:")},this.aiShouldCastSpell=((e,t)=>m(e,t))},r.default.extend2(o.Spell.MindControl,o.SpellBase),o.Spell.Blizzard=function(){o.Spell.AreaBase.call(this,"Blizzard",35),this.setDice("damage",l.Dice.create("5d5 + 5")),this.damageType=r.default.DMG.ICE,this.setRange(6)},r.default.extend2(o.Spell.Blizzard,o.Spell.AreaBase),o.Spell.Blizzard.prototype.onHit=function(e){e.add(new i.Coldness)},o.Spell.EnergyStorm=function(){o.Spell.AreaBase.call(this,"EnergyStorm",20),this.setDice("damage",l.Dice.create("3d4 + 3")),this.damageType=r.default.DMG.ENERGY},r.default.extend2(o.Spell.EnergyStorm,o.Spell.AreaBase),o.Spell.Heal=function(){o.SpellBase.call(this,"Heal",6),this._dice.healing=l.Dice.create("2d4"),this.cast=function(e){const t=p(this,e);t.targetComp="Health",t.set="addHP",t.value=this._dice.healing.roll();const s=new i.SpellCell;s.setArgs(t),e.src.add(s)},this.getSelectionObject=function(e){return o.Spell.getSelectionObjectDir(this,e,"Select a direction for healing:")},this.aiShouldCastSpell=((e,t)=>f(e,t))},r.default.extend2(o.Spell.Heal,o.SpellBase),o.Spell.RingOfFire=function(){o.Spell.RingBase.call(this,"RingOfFire",10),this._dice.duration=l.Dice.create("10d10"),this._range=2,this._createdActor="Fire"},r.default.extend2(o.Spell.RingOfFire,o.Spell.RingBase),o.Spell.RingOfFrost=function(){o.Spell.RingBase.call(this,"RingOfFrost",10),this._dice.duration=l.Dice.create("10d10"),this._range=2,this._createdActor="Ice flame"},r.default.extend2(o.Spell.RingOfFrost,o.Spell.RingBase),o.Spell.RingOfEnergy=function(){o.Spell.RingBase.call(this,"RingOfEnergy",10),this._dice.duration=l.Dice.create("10d10"),this._range=3,this._createdActor="Forcefield"},r.default.extend2(o.Spell.RingOfEnergy,o.Spell.RingBase),o.Spell.PoisonCloud=function(){o.Spell.RingBase.call(this,"PoisonCloud",15),this._dice.duration=l.Dice.create("10d10"),this._range=1,this._createdActor="Poison gas"},r.default.extend2(o.Spell.PoisonCloud,o.Spell.RingBase),o.Spell.ForceField=function(){o.SpellBase.call(this,"ForceField",5),this._dice.duration=l.Dice.create("10d10"),this.cast=function(e){const t=p(this,e);t.callback=this.castCallback.bind(this,e);const s=new i.SpellSelf;s.setArgs(t),e.src.add(s)},this.getSelectionObject=function(e){return o.Spell.getSelectionObjectDir(this,e,"Select a direction for the forcefield:")},this.castCallback=(e=>{const t=c.ObjectShell.getParser(),s=this._caster.getLevel(),{dir:a}=e,[n,r]=this._caster.getXY(),[o,l]=[n+a[0],r+a[1]];this.getThreeCells(s.getMap(),a,o,l).forEach(e=>{if(e.isPassable()||!e.hasActors()){const a=t.createActor("Forcefield");s.addActor(a,e.getX(),e.getY());const n=new i.Fading,r=this.getDuration();n.setDuration(r),a.add(n)}})}),this.getThreeCells=function(e,t,s,a){return 0===t[0]?[e.getCell(s-1,a),e.getCell(s,a),e.getCell(s+1,a)]:0===t[1]?[e.getCell(s,a-1),e.getCell(s,a),e.getCell(s,a+1)]:-1===t[0]?[e.getCell(s+1,a),e.getCell(s,a),e.getCell(s,a-t[1])]:[e.getCell(s-1,a),e.getCell(s,a),e.getCell(s,a-t[1])]}},r.default.extend2(o.Spell.ForceField,o.SpellBase);o.Spell.IcyTouch=class extends o.Spell.MultiSpell{constructor(){super("IcyTouch",5),this._spells.push(new o.Spell.GraspOfWinter),this._spells.push(new o.Spell.RingOfFrost)}getSelectionObject(e){return o.Spell.getSelectionObjectDir(this,e,"Select a direction for touching:")}},o.Spell.addAllSpells=(e=>{e.addSpell(new o.Spell.AnimateDead),e.addSpell(new o.Spell.ArrowOfWebs),e.addSpell(new o.Spell.Blizzard),e.addSpell(new o.Spell.Charm),e.addSpell(new o.Spell.CrossBolt),e.addSpell(new o.Spell.DispelMagic),e.addSpell(new o.Spell.EnergyArrow),e.addSpell(new o.Spell.Flying),e.addSpell(new o.Spell.ForceField),e.addSpell(new o.Spell.FrostBolt),e.addSpell(new o.Spell.GraspOfWinter),e.addSpell(new o.Spell.Heal),e.addSpell(new o.Spell.IceArrow),e.addSpell(new o.Spell.IceShield),e.addSpell(new o.Spell.IcyPrison),e.addSpell(new o.Spell.IcyTouch),e.addSpell(new o.Spell.LightningArrow),e.addSpell(new o.Spell.LightningBolt),e.addSpell(new o.Spell.MagicArmor),e.addSpell(new o.Spell.MindControl),e.addSpell(new o.Spell.Paralysis),e.addSpell(new o.Spell.PoisonArrow),e.addSpell(new o.Spell.PoisonBreath),e.addSpell(new o.Spell.PoisonCloud),e.addSpell(new o.Spell.PowerDrain),e.addSpell(new o.Spell.RingOfEnergy),e.addSpell(new o.Spell.RingOfFire),e.addSpell(new o.Spell.RingOfFrost),e.addSpell(new o.Spell.RockStorm),e.addSpell(new o.Spell.SlimeBolt),e.addSpell(new o.Spell.SpiritForm),e.addSpell(new o.Spell.SummonAirElemental),e.addSpell(new o.Spell.SummonAnimal),e.addSpell(new o.Spell.SummonDead),e.addSpell(new o.Spell.SummonFlyingEyes),e.addSpell(new o.Spell.SummonIceMinion),e.addSpell(new o.Spell.SummonKin),e.addSpell(new o.Spell.SummonUndeadUnicorns),e.addSpell(new o.Spell.Telepathy)})},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=n(s(56)),i=s(30),l=s(26),c=n(s(13)),h=s(1).Random.getRNG(),u={};class d extends i.BrainSentient{constructor(e){super(e),this.setType("GoalOriented"),this.goal=new o.ThinkBasic(e)}getGoal(){return this.goal}setGoal(e){this.goal=e}decideNextAction(){return this._cache.seen=null,this.goal.process(),this._cache.seen=null,i.ACTION_ALREADY_DONE}toJSON(){const e=super.toJSON();return e.goal=this.goal.toJSON(),e}}t.BrainGoalOriented=d,u.GoalOriented=d;class g extends d{constructor(e){super(e),this.setType("SpellCaster"),this.goal=new o.ThinkSpellcaster(e),this.goal.setBias({CastSpell:2,AttackActor:.7}),this.goal.getEvaluator("CastSpell").setCastingProbability(.8)}}t.BrainSpellCaster=g,u.SpellCaster=g;class p extends d{constructor(e){super(e),this.setType("Explorer"),this.goal.removeEvaluators(),this.goal.addEvaluator(new l.Evaluator.Explore)}}t.BrainExplorer=p,u.Explorer=p;class m extends d{constructor(e){super(e),this.setType("Spirit"),this.goal.removeEvaluators(),this.goal.addEvaluator(new l.Evaluator.Explore)}}t.BrainSpirit=m,u.Spirit=m;class f extends d{constructor(e){super(e),this.setType("Thief"),this.goal.addEvaluator(new l.Evaluator.Thief(1.2)),this.goal.setBias({Thief:1.2,AttackActor:.7})}}t.BrainThief=f,u.Thief=f;class y extends d{constructor(e){super(e),this.setType("Animal"),this.goal=new o.ThinkBasic(e),this._memory.addEnemyType("player"),this._memory.addEnemyType("human"),this.getGoal=(()=>this.goal),this.setGoal=(e=>{this.goal=e})}decideNextAction(){return this._cache.seen=null,this.goal.process(),this._cache.seen=null,i.ACTION_ALREADY_DONE}}t.BrainAnimal=y,u.Animal=y;class _ extends d{constructor(e){super(e),this.setType("Commander"),this.goal=new o.ThinkCommander(e)}decideNextAction(){return this._cache.seen=null,this.goal.process(),this._cache.seen=null,i.ACTION_ALREADY_DONE}}t.BrainCommander=_,u.Commander=_;class E extends i.BrainSentient{constructor(e){super(e),this.setType("Flame")}decideNextAction(){return this._actor.getCell().getActors().forEach(e=>{const t=this.getActor().get("Damaging");if(t){const s=new c.Flame;s.setSource(this._actor),s.setDamageType(t.getDamageType()),e.add(s)}}),i.ACTION_ALREADY_DONE}}t.BrainFlame=E,u.Flame=E;class S extends E{constructor(e){super(e),this.setType("Cloud"),this.chanceToMove=.2}decideNextAction(){if(h.getUniform()<=this.chanceToMove){const e=h.getRandDir(),[t,s]=r.default.newXYFromDir(e,this._actor),a=this._actor.getLevel();if(a.getMap().hasXY(t,s)){const e=new c.Movement(t,s,a);this._actor.add(e)}}return super.decideNextAction.call(this)}}t.BrainCloud=S,u.Cloud=S;class v extends d{constructor(e){super(e),this.setType("MindControl"),this.goal=new o.ThinkBasic(e),this.getGoal=(()=>this.goal),this.setGoal=(e=>{this.goal=e})}decideNextAction(){return i.ACTION_ALREADY_DONE}}t.BrainMindControl=v,u.MindControl=v},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=s(69),n=s(26);t.EvaluatorsBattle={};class r extends n.Evaluator.Base{constructor(e){super(e),this.type="WinBattle"}calculateDesirability(e){return e.has("InBattle")?this.actorBias:n.Evaluator.NOT_POSSIBLE}setActorGoal(e){const t=e.getBrain().getGoal(),s=new a.GoalsBattle.WinBattle(e);t.addGoal(s)}}t.EvaluatorWinBattle=r,t.EvaluatorsBattle.WinBattle=r;class o extends n.Evaluator.Base{constructor(e){super(e),this.cooldown=5,this.type="Retreat"}calculateDesirability(){return 0===this.cooldown?this.actorBias:(--this.cooldown,0)}setActorGoal(e){const t=e.getBrain().getGoal(),s=new a.GoalsBattle.Retreat(e);t.addGoal(s)}}t.EvaluatorRetreat=o,t.EvaluatorsBattle.Retreat=o},function(e,t,s){"use strict";var a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(57)),r=s(18),o=r.Component.UniqueDataComponent;t.Abilities=o("Abilities",{}),t.Abilities.prototype._init=function(){this.addCallback("onAdd",()=>{const e=new n.Abilities(this.getEntity());Array.isArray(this.abilities)&&this.abilities.forEach(t=>{const s=new n[t];e.addAbility(s)}),this.abilities=e,this.removeCallbacks("onAdd")})},t.Abilities.prototype.setAbilities=function(e){this.abilities=e},t.Abilities.prototype.createMenu=function(){return this.abilities.getMenu()},t.Abilities.prototype.addAbility=function(e){this.abilities.addAbility(e)},t.Abilities.prototype.toJSON=function(){const e=r.ComponentBase.prototype.toJSON.call(this);return e.setAbilities=this.abilities.toJSON(),e}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(9),{TYPE_ACTOR:o,TYPE_ITEM:i,TYPE_ELEM:l}=n.default;t.Cell=class{constructor(e,t,s){this._baseElem=s,this._x=e,this._y=t,this._explored=!1,this._p={},this._lightPasses=!s||s.lightPasses(),this._isPassable=!s||s.isPassable()}getX(){return this._x}getY(){return this._y}getXY(){return[this._x,this._y]}setX(e){this._x=e}setY(e){this._y=e}setXY(e){this._x=e[0],this._y=e[1]}isAtXY(e,t){return e===this._x&&t===this._y}getKeyXY(){return this._x+","+this._y}setBaseElem(e){this._baseElem=e,this._lightPasses=e.lightPasses(),this._isPassable=e.isPassable()}getBaseElem(){return this._baseElem}hasProp(e){return this._p.hasOwnProperty(e)}getProp(e){return this._p.hasOwnProperty(e)?this._p[e]:null}hasElements(){return this.hasProp(l)}getElements(){return this.getProp(l)}hasActors(){return this.hasProp(o)}getActors(){return this.getProp(o)}getFirstActor(){const e=this.getProp(o);return e&&e.length>0?e[0]:null}getSentientActors(){const e=this.getActors();return e?e.filter(e=>!e.has("NonSentient")):[]}hasItems(){return this.hasProp(i)}getItems(){return this.getProp(i)}hasMarker(e){if(this.hasElements()){const t=this.getElements();for(let s=0;s<t.length;s++)if("marker"===t[s].getType()&&t[s].getTag()===e)return!0}return!1}hasProps(){return Object.keys(this._p).length>0}hasStairs(){const e=this.getConnection();if(e){const t=e.getName();return/stairs(Up|Down)/.test(t)}return!1}hasPassage(){const e=this.getConnection();return!!e&&"passage"===e.getName()}hasShop(){return this.hasPropType("shop")}getShop(){return this.getPropType("shop")[0]}hasDoor(){return this.hasPropType("door")}hasClosedDoor(){if(this.hasDoor())return this.getPropType("door")[0].isClosed()}hasConnection(){return this.hasPropType("connection")}hasHouse(){return"floorhouse"===this._baseElem.getType()}hasConnectionType(e){return!!this.hasConnection()&&this.getConnection().getName()===e}hasTown(){return this.hasConnectionType("town")}hasBattle(){return this.hasConnectionType("battle")}hasMountain(){return this.hasConnectionType("mountain")}getStairs(){return this.hasStairs()?this.getConnection():null}getConnection(){return this.hasPropType("connection")?this.getPropType("connection")[0]:null}getPassage(){return this.hasPassage()?this.getConnection():null}lightPasses(){if(!this._lightPasses)return!1;const e=this._p[l];if(e)if(1===e.length){if(e[0].has("Opaque"))return!1}else for(let t=0;t<e.length;t++)if(e[t].has("Opaque"))return!1;return!0}isPassable(){return this.isFree()}isPassableByAir(){return this._baseElem.isPassableByAir()}isDangerous(){if(this._p[o]){const e=this.getProp(o);if(e)return e[0].has("Damaging")}return!1}hasObstacle(){return this._baseElem.isObstacle()}isSpellPassable(){return this._baseElem.isSpellPassable()}setExplored(){this._explored=!0}isExplored(){return this._explored}isFree(e=!1){if(!e&&!this._isPassable)return!1;if(this.hasProp(o)){for(let e=0;e<this._p.actors.length;e++)if(!this._p.actors[e].has("Ethereal"))return!1;return!0}if(this.hasProp(l)){if(this.hasPropType("door"))return this.getDoor().isOpen();if(this.hasPropType("leverdoor"))return this.getLeverDoor().isOpen()}return!e||this._baseElem.isPassableByAir()}getDoor(){return this.hasPropType("door")?this.getPropType("door")[0]:null}getLeverDoor(){return this.hasPropType("leverdoor")?this.getPropType("leverdoor")[0]:null}setProp(e,t){if("connection"===t.getType()&&this.hasConnection()){let e=`${this._x},${this._y}`;e+=`\nExisting: ${JSON.stringify(this.getConnection())}`,e+=`\nTried to add: ${JSON.stringify(t)}`,n.default.err("Cell","setProp",`Tried to add 2nd connection: ${e}`)}this._p.hasOwnProperty(e)?e===o?t.has("NonSentient")||t.has("Ethereal")?this._p[e].push(t):this._p[e].unshift(t):this._p[e].push(t):(this._p[e]=[],this._p[e].push(t)),t.isOwnable&&t.setOwner(this)}removeProps(e){delete this._p[e]}removeProp(e,t){if(this.hasProp(e)){const s=this._p[e].indexOf(t);return-1!==s&&(this._p[e].splice(s,1),0===this._p[e].length&&delete this._p[e],!0)}return!1}toString(){let e="Map.Cell "+this._x+", "+this._y;return e+=" explored: "+this._explored,e+=" passes light: "+this.lightPasses(),Object.keys(this._p).forEach(t=>{const s=this._p[t];for(let t=0;t<s.length;t++)s[t].hasOwnProperty("toString")?e+=s[t].toString():s[t].hasOwnProperty("toJSON")&&(e+=JSON.stringify(s[t].toJSON()))}),e}hasUsable(){const e=this.getProp(n.default.TYPE_ELEM);if(e)for(let t=0;t<e.length;t++)if(e[t].onUse)return!0;return!1}toJSON(){const e={t:r.ELEM_MAP.elemTypeToIndex[this._baseElem.getType()]};return this._explored&&(e.ex=1),e}getPropNames(){const e=[this._baseElem.getType()];return Object.keys(this._p).forEach(t=>{this.getProp(t).forEach(t=>{e.push(t.getName())})}),e}hasPropType(e){if(this._baseElem.getType()===e)return!0;const t=Object.keys(this._p);for(let s=0;s<t.length;s++){const a=t[s],n=this._p[a];for(let t=0;t<n.length;t++)if(n[t].getType()===e)return!0}return!1}getPropType(e){const t=[];return this._baseElem.getType()===e?[this._baseElem]:(Object.keys(this._p).forEach(s=>{const a=this._p[s];for(let s=0;s<a.length;s++)a[s].getType()===e&&t.push(a[s])}),t)}findObj(e){const t=[];return Object.keys(this._p).forEach(s=>{this._p[s].forEach(s=>{e(s)&&t.push(s)})}),t}isOutdoors(){return!this._baseElem.has("Indoor")}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(12));t.BSP={};const r={discardByRatio:!0,hRatio:.35,wRatio:.35,vertSplit:.5,minSplitW:8,minSplitH:8,discardBySize:!0,minRoomW:3,minRoomH:2};class o{constructor(e){this.leaf=e,this.lchild=null,this.rchild=null}getLeafs(){return null===this.lchild&&null===this.rchild?[this.leaf]:[].concat(this.lchild.getLeafs(),this.rchild.getLeafs())}getLevel(e,t){return t||(t=[]),1===e?t.push(this):(null!==this.lchild&&this.lchild.getLevel(e-1,t),null!==this.rchild&&this.rchild.getLevel(e-1,t)),t}}t.Tree=o,t.BSP.Tree=o;const i=function(e,t){this.x=e,this.y=t},l=function(e,t,s,a){this.x=e,this.y=t,this.w=s,this.h=a,this.center=new i(this.x+Math.floor(this.w/2),this.y+Math.floor(this.h/2))};t.BSP.Container=l;class c{constructor(e){return this.x=e.x+c.rng.getUniformInt(1,Math.floor(e.w/3)),this.y=e.y+c.rng.getUniformInt(1,Math.floor(e.h/3)),this.w=e.w-(this.x-e.x)-1,this.h=e.h-(this.y-e.y)-1,this.w-=c.rng.getUniformInt(0,this.w/3),this.h-=c.rng.getUniformInt(0,this.h/3),this.w<r.minRoomW&&(this.w=r.minRoomW),this.h<r.minRoomH&&(this.h=r.minRoomH),this}getCoord(){const e=[],t=this.x,s=t+(this.w-1),a=this.y,n=a+(this.h-1);for(let r=t;r<=s;r++)for(let t=a;t<=n;t++)e.push([r,t]);return e}getOuterBorder(){const[e,t]=[this.x-1,this.y-1],[s,a]=[this.x+this.w+1,this.y+this.h+1];return h(e,t,s,a)}getInnerBorder(){const[e,t]=[this.x,this.y],[s,a]=[this.x+this.w-1,this.y+this.h-1];return h(e,t,s,a)}}function h(e,t,s,a){const n=[];for(let r=e;r<=s;r++)for(let o=t;o<=a;o++)o!==t&&o!==a&&r!==e&&r!==s||n.push([r,o]);return n}t.Room=c,c.rng=n.default.RNG,t.BSP.Room=c;class u{constructor(e={}){this._opts=r,Object.keys(e).forEach(t=>{this._opts.hasOwnProperty(t)&&(this._opts[t]=e)}),this.rng=this._opts.rng||n.default.RNG}createPath(e,t){const s=[],a=e.center,n=t.center;if(a.x===n.x){const e=a.y>n.y?n.y:a.y,t=a.y<n.y?n.y:a.y;for(let n=e;n<=t;n++)s.push([a.x,n])}else{const e=a.x>n.x?n.x:a.x,t=a.x<n.x?n.x:a.x;for(let n=e;n<=t;n++)s.push([n,a.y])}return s}splitContainer(e,t){const s=new o(e);if(this.isLargeEnough(e)&&0!==t){const a=this.randomSplit(e);s.lchild=this.splitContainer(a[0],t-1),s.rchild=this.splitContainer(a[1],t-1)}return s}isLargeEnough(e){return!this._opts.discardBySize||e.w>=this._opts.minSplitW&&e.h>=this._opts.minSplitH}randomSplit(e){let t,s;if(this.rng.getUniform()<=this._opts.vertSplit){if(t=new l(e.x,e.y,this.rng.getUniformInt(1,e.w),e.h),s=new l(e.x+t.w,e.y,e.w-t.w,e.h),this._opts.discardByRatio&&this.isVRatioTooSmall(t,s))return this.randomSplit(e)}else if(t=new l(e.x,e.y,e.w,this.rng.getUniformInt(1,e.h)),s=new l(e.x,e.y+t.h,e.w,e.h-t.h),this._opts.discardByRatio&&this.isHRatioTooSmall(t,s))return this.randomSplit(e);return[t,s]}isVRatioTooSmall(e,t){const s=e.w/e.h,a=t.w/t.h;return s<this._opts.wRatio||a<this._opts.wRatio}isHRatioTooSmall(e,t){const s=e.h/e.w,a=t.h/t.w;return s<this._opts.hRatio||a<this._opts.hRatio}createWithRooms(e,t,s=5){const a=new l(0,0,e,t),n=this.splitContainer(a,s),r=n.getLeafs(),o=[];return r.forEach(e=>{o.push(new c(e))}),this.generated={tree:n,rooms:o},[n,o]}createWithRoomsAndPaths(e,t,s=5){const a=new l(0,0,e,t),n=this.splitContainer(a,s),r=n.getLeafs(),o=[];r.forEach(e=>{o.push(new c(e))});const i=[];return this.createPaths(n,i),this.generated={tree:n,rooms:o,paths:i},[n,o,i]}createPaths(e,t){if(null===e.lchild||null===e.rchild)return[];const s=this.createPath(e.lchild.leaf,e.rchild.leaf);return s.length>0&&t.push(s),this.createPaths(e.lchild,t),this.createPaths(e.rchild,t),t}get(e){return this.generated.hasOwnProperty(e)?this.generated[e]:null}}t.BSPGen=u,t.BSP.BSPGen=u},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(1),o=s(36),i=s(77);s(29);const l=s(8)("bitn:TemplateLevel"),c=i.Crypt.tiles.filler,h=r.Random.getRNG(),u=()=>{},d=20;t.TemplateLevel=class{constructor(e,t){this.tilesX=e,this.tilesY=t,this.genParams=[1,1,1,1],this.roomCount=40,this.callbacks={afterInit:u},this.filler=o.Template.createTemplate(c),this.templates=[],this.tryToMatchAllExits=!0,this.missingExitIsError=!1,this._ind=0,this._unusedExits=[],this._freeExits={},this._possibleDirections=["N","S","E","W"],this._sortedByExit={N:[],S:[],E:[],W:[]},this._sortedWithAllExits={}}setFiller(e){"string"==typeof e?(this.filler=o.Template.createTemplate(e),this.filler.setProp("name","FILLER")):(this.filler=e.clone(),this.filler.setProp("name","FILLER"))}setTemplates(e){this.templates=[],"string"==typeof e[0]?this.templates=e.map(e=>o.Template.createTemplate(e)):this.templates=e}addTemplate(e){"string"==typeof e?this.templates.push(o.Template.createTemplate(e)):e instanceof o.Template.ElemTemplate&&this.templates.push(e)}setGenParams(e){this.genParams=e}setRoomCount(e){this.roomCount=e}setConstraintFunc(e){this.constraintFunc=e.bind(this)}setStartRoomFunc(e){this.startRoomFunc=e.bind(this)}addCallback(e,t){this.callbacks.hasOwnProperty(e)?"function"==typeof t?this.callbacks[e]=t:n.default.err("TemplateLevel","setCallback",`Tried setting non-function as cb: ${t}`):n.default.err("TemplateLevel","setCallback",`No callback for ${e}`)}use(e){["constraintFunc","startRoomFunc","roomCount","genParams"].forEach(t=>{e.hasOwnProperty(t)&&this["set"+t.capitalize()](e[t])}),e.tiles&&e.tiles.filler&&this.setFiller(e.tiles.filler),e.Models&&e.Models.default&&this.setTemplates(e.Models.default)}create(){0===this.templates.length&&n.default.err("TemplateLevel","create","No templates set. Use setTemplates() before create()"),this._sortDataIntoListsByLocation(),this._initMapWithFillerCells();let e=!0,t=10;for(;e;){++this._ind,this.dbg(`Dungeon not ready. Tries left  ${t}/10`),this._placeStartRoom();let s=0;const a=this.roomCount;let r=0,o=!0;for(;r<1e3&&o;){const t=this._getRoomWithUnusedExits();if(null===t){o=!1;break}const{x:i,y:l}=t;this.dbg(`Current room in ${i},${l}`);const c=this._getFreeExits(t);this.dbg(`It has free exits: ${c}`);const u=h.arrayGetRand(c);this.dbg(`Chose exit: ${u} for next room`);const d=this.getMatchingExit(u),g=this._getNewX(i,d),p=this._getNewY(l,d);if(g===i&&p===l){let e=`Illegal ${i},${l} -> ${g},${p}`;e+=` Exits: Chosen ${u} -> ${d}`,n.default.err("TemplateLevel","create",e)}const m=this._getNextTemplate(g,p,d);if(this._isRoomLegal(g,p)&&(this._placeRoom(i,l,u,g,p,d,m),++s,this.dbg("Room count incremented to "+s)),++r,-1!==a&&s>=a){e=!1;break}}if(s>=a||-1===a)e=!1;else{if(0==--t){n.default.warn("Level.Template","create","Max tries reached. No valid level created");break}this._cleanupAndTryAgain()}--this._ind}this.expandTemplates()}_sortDataIntoListsByLocation(){const e=this._possibleDirections.map(e=>new RegExp(e));this.templates.forEach(t=>{const s=t.getProp("dir");if(s){this._possibleDirections.forEach((a,n)=>{e[n].test(s)&&this._sortedByExit[a].push(t)});const a=s.split("").sort().join("");this._sortedWithAllExits[a]||(this._sortedWithAllExits[a]=[]),this._sortedWithAllExits[a].push(t)}})}expandTemplates(){this.genParamsX=[],this.genParamsY=[];for(let e=0;e<this.tilesX;e++)if(this.genParams.x)this.genParamsX.push(this.genParams.x);else{const e=[this.genParams[0],this.genParams[1]];this.genParamsX.push(e)}for(let e=0;e<this.tilesY;e++)if(this.genParams.y)this.genParamsY.push(this.genParams.y);else{const e=[this.genParams[2],this.genParams[3]];this.genParamsY.push(e)}this.mapExpanded=[];for(let e=0;e<this.tilesX;e++){this.mapExpanded[e]=[];for(let t=0;t<this.tilesY;t++){const s=this.genParamsX[e].concat(this.genParamsY[t]);this.mapExpanded[e][t]=this.templMap[e][t].getChars(s)}}this.map=[],this.placedTileData={};let e=0,t=0;for(let s=0;s<this.tilesX;s++){const a=this.mapExpanded[s][0].length;t=e+a-1;for(let n=0;n<a;n++){let a=0,r=0,o=[];for(let i=0;i<this.tilesY;i++){const l=this.mapExpanded[s][i][n],c=l.length;a=r+c-1,o=o.concat(l),this.placedTileData[s+","+i]={name:this.templMap[s][i].getProp("name"),type:this.templMap[s][i].getProp("type"),llx:e,urx:t,ury:r,lly:a,tileX:s,tileY:i},r+=c}this.map.push(o)}e+=a}}getPlacedData(){return this.placedTileData}getMap(){return this.map||n.default.warn("TemplateLevel","getMap","Not not generated. Call create() first"),this.map}findTemplate(e){const t=[];return Object.keys(e).forEach(s=>{this.templates.forEach(a=>{a.getProp(s)===e[s]&&t.push(a)})}),t.length>0?h.arrayGetRand(t):null}removeTemplate(e){const t=Object.keys(e)[0],s=this.templates.findIndex(s=>s.getProp(t)===e[t]);s>=0&&this.templates.splice(s,1)}addRoom(e,t,s){const a={x:t,y:s,room:e};this._addRoomData(a),this._removeExitsOfAbuttingRooms(a),this._removeBorderExits(a),this.templMap[t][s]=e}_getNextTemplate(e,t,s){++this._ind;let a=null;if("function"==typeof this.constraintFunc&&(a=this.constraintFunc(e,t,s)),!a&&this.tryToMatchAllExits){this.dbg(`Compute required exits for ${e},${t}`);const s=this.getAllRequiredExits(e,t),a=this._getMatchWithExits(s);if(a.length>0)return this._getRandTemplate(a);let r=`x,y: ${e},${t}`;if(r+=`Required: ${s[1]}, Excl: ${s[2]}`,n.default.warn("TemplateLevel","_getNextTemplate",`Not all exits match. ${r}`),this.missingExitIsError){this.expandTemplates(),n.default.printMap(this.map);const a=`${e},${t} exitReqd: ${JSON.stringify(s)}`;throw new Error(a)}}if(!a){const e=this._sortedByExit[s];return h.arrayGetRand(e)}return--this._ind,a}_getRandTemplate(e){if(!this.weights)return h.arrayGetRand(e);const t={},s=e.map(e=>e.getProp("name")),a={};s.forEach((e,s)=>{a[e]=s,this.weights.hasOwnProperty(e)?t[e]=this.weights[e]:t[e]=1});const n=h.getWeighted(t);return e[a[n]]}_getRoomWithUnusedExits(){return this._unusedExits.length>0?h.arrayGetRand(this._unusedExits):null}_getFreeExits(e){const{x:t,y:s}=e,a=t+","+s;return this._freeExits[a]?this._freeExits[a]:(n.default.err("TemplateLevel","_getFreeExits",`No ${a}, Room: ${JSON.stringify(e)}`),null)}_removeChosenExit(e,t,s){const a=e+","+t,r=this._freeExits[a];this.dbg(JSON.stringify(this._freeExits)),this.dbg(`${e},${t} removeChosenExit ${s}`),this.dbg(`nExits: ${r.length}`);const o=r.indexOf(s);if(o>=0){if(this._freeExits[a].splice(o,1),0===this._freeExits[a].length){const s=this._unusedExits.findIndex(s=>s.x===e&&s.y===t);s>=0?(this._unusedExits.splice(s,1),delete this._freeExits[a],this.dbg(`${e},${t} has no unused exits anymore.`)):n.default.err("TemplateLevel","_removeChosenExit",`Cannot find ${e},${t} in unusedExits to remove.`)}this._freeExits[a]&&this.dbg(`_freeExits [${a}] After remove: `+JSON.stringify(this._freeExits[a]))}else{const a=JSON.stringify(this.templMap[e][t]);n.default.err("TemplateLevel","_removeChosenExit",`${e},${t} dir: ${s} not found. Templ: ${a}`)}}_isRoomLegal(e,t){return e>=0&&e<this.tilesX&&t>=0&&t<this.tilesY}_placeStartRoom(){++this._ind;let e=null;if("function"==typeof this.startRoomFunc)e=this.startRoomFunc(),["x","y","room"].forEach(t=>{if(!e.hasOwnProperty(t)){const e="room must have {x, y, room}.";n.default.err("TemplateLevel","_placeStartRoom",`Prop ${t} null/undef. ${e}.`)}});else{const t=h.getUniformInt(1,this.tilesX-2),s=h.getUniformInt(1,this.tilesY-2);e={x:t,y:s,room:this.getRandomTemplate()}}this.dbg("Start room: "+JSON.stringify(e)),this.templMap[e.x][e.y]=e.room,null!==e?(this._addRoomData(e),this._removeBorderExits(e)):n.default.err("TemplateLevel","_placeStartRoom","Starting room was null. Oh no!"),--this._ind}_placeRoom(e,t,s,a,n,r,o){this._removeChosenExit(e,t,s);const i={x:a,y:n,room:o};this._addRoomData(i),this._removeChosenExit(a,n,r),this._removeExitsOfAbuttingRooms(i),this._removeBorderExits(i),this.templMap[a][n]=o}_addRoomData(e){const t=e.room.getProp("dir");if(t){this._unusedExits.push(e);const s=t.split(""),a=e.x+","+e.y;this._freeExits[a]=s,this.dbg("Added room "+JSON.stringify(e),20)}}getMatchingExit(e){if(this.matchMap&&this.matchMap.hasOwnProperty(e))return this.matchMap[e];switch(e){case"N":return"S";case"S":return"N";case"E":return"W";case"W":return"E";default:return"N"}}_getNewX(e,t){let s=t;return this.dir2NSEWRemap&&this.dir2NSEWRemap[t]&&(s=this.dir2NSEWRemap[t]),"E"===s?e-1:"W"===s?e+1:e}_getNewY(e,t){let s=t;return this.dir2NSEWRemap&&this.dir2NSEWRemap[t]&&(s=this.dir2NSEWRemap[t]),"N"===s?e+1:"S"===s?e-1:e}getRandomTemplate(){return h.arrayGetRand(this.templates)}_removeBorderExits(e){const{x:t,y:s}=e;0===t&&(this._hasExit("W",t,s)&&this._removeChosenExit(t,s,"W"),this.nsew2DirRemap&&this._removeExitsRemapped(t,s,"W")),t===this.tilesX-1&&(this._hasExit("E",t,s)&&this._removeChosenExit(t,s,"E"),this.nsew2DirRemap&&this._removeExitsRemapped(t,s,"E")),0===s&&(this._hasExit("N",t,s)&&this._removeChosenExit(t,s,"N"),this.nsew2DirRemap&&this._removeExitsRemapped(t,s,"N")),s===this.tilesY-1&&(this._hasExit("S",t,s)&&this._removeChosenExit(t,s,"S"),this.nsew2DirRemap&&this._removeExitsRemapped(t,s,"S"))}_removeExitsRemapped(e,t,s){const a=this.nsew2DirRemap[s];this._hasExit(a,e,t)&&this._removeChosenExit(e,t,a)}_removeExitsOfAbuttingRooms(e){const{x:t,y:s}=e;if(this.dbg(`CheckAbut ${t},${s}`),t>0){const e=t-1;this._isFiller(e,s)||(this._removeExitByXY("W",t,s),this._removeExitByXY("E",e,s),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.W,t,s),this._removeExitByXY(this.nsew2DirRemap.E,e,s)))}if(t<this.tilesX-1){const e=t+1;this._isFiller(e,s)||(this._removeExitByXY("E",t,s),this._removeExitByXY("W",e,s),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.E,t,s),this._removeExitByXY(this.nsew2DirRemap.W,e,s)))}if(s>0){const e=s-1;this._isFiller(t,e)||(this._removeExitByXY("N",t,s),this._removeExitByXY("S",t,e),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.N,t,s),this._removeExitByXY(this.nsew2DirRemap.S,t,e)))}if(s<this.tilesY-1){const e=s+1;this._isFiller(t,e)||(this._removeExitByXY("S",t,s),this._removeExitByXY("N",t,e),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.S,t,s),this._removeExitByXY(this.nsew2DirRemap.N,t,e)))}}_isFiller(e,t){const s="FILLER"===this.templMap[e][t].getProp("name");return this.dbg(`isFiller x,y ${e},${t}: ${s}`),s}_removeExitByXY(e,t,s){this._hasExit(e,t,s)&&this._removeChosenExit(t,s,e)}_hasExit(e,t,s){const a=t+","+s;return!!this._freeExits[a]&&this._freeExits[a].indexOf(e)>=0}_cleanupAndTryAgain(){this._initMapWithFillerCells(),this._freeExits={},this._unusedExits=[]}_initMapWithFillerCells(){this.templMap=[];for(let e=0;e<this.tilesX;e++){this.templMap[e]=[];for(let t=0;t<this.tilesY;t++)this.templMap[e][t]=this.filler}this.callbacks.afterInit&&this.callbacks.afterInit(this)}setExitMap(e,t){this._possibleDirections=Object.keys(e),this._sortedByExit={},this._possibleDirections.forEach(e=>{this._sortedByExit[e]=[]}),this.matchMap=e,this.nsew2DirRemap=t;const s={};Object.keys(this.nsew2DirRemap).forEach(e=>{const t=this.nsew2DirRemap[e];s[t]=e}),this.dir2NSEWRemap=s}getAllRequiredExits(e,t){++this._ind;const s=[],a=[],n=[];let r=null,o=null;const i=t-1;this.nsew2DirRemap&&(r=this.nsew2DirRemap.N,o=this.matchMap[r]),i>=0?(this._isFiller(e,i)?s.push("N"):this._hasExit("S",e,i)?a.push("N"):n.push("N"),r&&(this._isFiller(e,i)?s.push(r):this._hasExit(o,e,i)?a.push(r):n.push(r))):(n.push("N"),r&&n.push(r));const l=t+1;this.nsew2DirRemap&&(r=this.nsew2DirRemap.S,o=this.matchMap[r]),l<this.tilesY?(this._isFiller(e,l)?s.push("S"):this._hasExit("N",e,l)?a.push("S"):n.push("S"),r&&(this._isFiller(e,l)?s.push(r):this._hasExit(o,e,l)?a.push(r):n.push(r))):(n.push("S"),r&&n.push(r));const c=e+1;this.nsew2DirRemap&&(r=this.nsew2DirRemap.E,o=this.matchMap[r]),c<this.tilesX?(this._isFiller(c,t)?s.push("E"):this._hasExit("W",c,t)?a.push("E"):n.push("E"),r&&(this._isFiller(c,t)?s.push(r):this._hasExit(o,c,t)?a.push(r):n.push(r))):(n.push("E"),r&&n.push(r));const h=e-1;return this.nsew2DirRemap&&(r=this.nsew2DirRemap.W,o=this.matchMap[r]),h>=0?(this._isFiller(h,t)?s.push("W"):this._hasExit("E",h,t)?a.push("W"):n.push("W"),r&&(this._isFiller(h,t)?s.push(r):this._hasExit(o,h,t)?a.push(r):n.push(r))):(n.push("W"),r&&n.push(r)),this.dbg("getAllRequired "+a),--this._ind,[s,a,n]}_getMatchWithExits(e){const[t,s,a]=e;this.dbg(`GOT: any:${t}, req:${s}, excl:${a}`);let n=Object.keys(this._sortedWithAllExits);a.forEach(e=>{n=n.filter(t=>!new RegExp(e).test(t))});let r=n.map(e=>e.split(""));r=r.filter(e=>this._arrayContainsArray(e,s)),n=r.map(e=>e.join(""));let o=[];return n.forEach(e=>{o=o.concat(this._sortedWithAllExits[e])}),o}_arrayContainsArray(e,t){return t.every(t=>e.indexOf(t)>=0)}dbg(e,t=10){if(l.enabled&&d>=t){const t=" ".repeat(this._ind);console.log(t+e)}}printTile(e,t){if(4===e&&3===t){const s=this.templMap[e][t];console.log(`Tile @{x},${t}`),console.log(`Has exits: ${s.getDir()}`),console.log(JSON.stringify(s,null,2))}}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=s(36),n=s(1).Random.getRNG();t.Crypt={Models:{default:[]},templates:{all:[]}},t.Crypt.tiles={},t.Crypt.tiles.filler="\nname:FILLER\nX=#\nY=#\n\n#X###X#\nY######\n#######\n#######\n#######\nY######\n#######",t.Crypt.tiles.start=["\ndir:NSEW\nname:start_nsew\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n+.###.+\n#.#.#.#\nY.....#\n###+###","\ndir:SEW\nname:start_sew\nX=#\nY=#\n\n#X###X#\nY.....#\n#.#.#.#\n+.###.+\n#.#.#.#\nY.....#\n###+###","\ndir:NEW\nname:start_new\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n+.###.+\n#.#.#.#\nY.....#\n#######","\ndir:NSE\nname:start_nse\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n#..#..+\n#.#.#.#\nY.....#\n###+###","\ndir:NSW\nname:start_nsw\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n+..#..#\n#.#.#.#\nY.....#\n###+###"],t.Crypt.tiles.omni=["\ndir:NSEW\nname:omni\nX=#\nY=#\n\n#X#.#X#\nY.....#\n#.....#\n...#...\n#.....#\nY.....#\n###.###","\ndir:NSEW\nname:omni\nX=#\nY=#\n\n#X#.#X#\nY.....#\n#.#.#.#\n...#...\n#.#.#.#\nY.....#\n###.###","\ndir:NSEW\nname:omni\nX=#\nY=#\n\n#.X.X.#\nY.....#\n#..#..#\n..###..\n#..#..#\nY.....#\n###.###","\nname:omni\ndir:NSEW\nX=#\nY=#\n\n#X...X#\n.......\nY..#..#\n..###..\nY..#..#\n.......\n##...##","\nname:omni\ndir:NSEW\nX=.\nY=.\n\n..X.X..\n.##.##.\nY#...#.\n...#...\nY#...#.\n.##.##.\n.......","\nname:omni\ndir:NSEW\nX=.\nY=.\n\n#.X.X.#\n###.###\nY#...#.\n...#...\nY#...#.\n###.###\n#.....#","\nname:omni\ndir:NSEW\nX=.\nY=.\n\n..X.X..\n.##.##.\nY##.##.\n.......\nY##.##.\n.##.##.\n.......","\ndir:NSEW\nname:omni\nX=.\nY=.\n\n..X.X..\n.##.##.\nY#...#.\n.#...#.\nY#...#.\n.##.##.\n......."],t.Crypt.tiles.term=["\ndir:N\nname:term\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.#.#.#\n###.###\nY.....#\n#.....#\n#######","\ndir:N\nname:term\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.#.#.#\n###.###\nY##.###\n##...##\n#######","\ndir:S\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY.#.#.#\n###.###\nY.#.#.#\n#.....#\n##...##","\ndir:S\nname:term\nX=#\nY=#\n\n#X###X#\n#######\nY######\n###.###\nY.....#\n#.....#\n##...##","\ndir:W\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY.#.#.#\n...####\nY.#.#.#\n#.....#\n#######","\ndir:W\nname:term\nX=#\nY=#\n\n#X###X#\n#.#...#\nY.#.###\n..#...#\nY.###.#\n#.....#\n#######","\ndir:E\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY..#..#\n#..#...\nY.###.#\n#.....#\n#######","\ndir:E\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY...###\n#...#..\nY.###.#\n#.....#\n#######"],t.Crypt.tiles.corridor=["\ndir:NS\nname:corridor\nX=#\nY=#\n\n#X...X#\n##...##\nY#...##\n##...##\nY#...##\n##...##\n##...##","\ndir:NS\nname:corridor\nX=#\nY=#\n\n#X...X#\n#.....#\nY#...##\n#.....#\nY#...##\n#.....#\n##...##","\ndir:EW\nname:corridor\nX=#\nY=#\n\n#X###X#\n#######\nY......\n.......\nY......\n#######\n#######","\ndir:EW\nname:corridor\nX=#\nY=#\n\n#X###X#\n#.#.#.#\nY.....#\n.......\nY.....#\n#.#.#.#\n#######"],t.Crypt.tiles.corner=["\ndir:NW\nname:corner\nX=#\nY=#\n\n#X...X#\n###.###\nY....##\n.....##\nY....##\n#######\n#######","\ndir:NW\nname:corner\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.....#\n......#\nY.###.#\n#.....#\n#######","\ndir:NE\nname:corner\nX=.\nY=#\n\n#X...X#\n###.###\nY#...#.\n##.....\nY#...#.\n#######\n#######","\ndir:NE\nname:corner\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.###.#\n#......\nY.....#\n#.....#\n#######","\ndir:SE\nname:corner\nX=#\nY=#\n\n#X###X#\n###.###\nY#...#.\n##.....\nY#...#.\n###.###\n###.###","\ndir:SE\nname:corner\nX=#\nY=#\n\n#X###X#\n#.#.#.#\nY#...##\n#......\nY#...##\n#.#.#.#\n###.###","\ndir:SW\nname:corner\nX=#\nY=.\n\n#X###X#\n###.###\nY#...##\n......#\nY#...##\n###.###\n###.###"],t.Crypt.tiles.misc=["\ndir:SEW\nname:threeway\nX=#\nY=.\n\n#X###X#\n###.###\nY#...#.\n.......\nY#...#.\n###.###\n###.###","\ndir:SEW\nname:threeway\nX=#\nY=#\n\n#X###X#\n#.....#\nY.#.#.#\n..#.#..\nY##.###\n#.....#\n#.....#","\ndir:NEW\nname:threeway\nX=#\nY=.\n\n#X...X#\n###.###\nY#...#.\n.......\nY#...#.\n#######\n#######","\ndir:NSW\nname:threeway\nX=#\nY=#\n\n#X...X#\n###.###\nY#...##\n......#\nY#...##\n###.###\n###.###","\ndir:NSE\nname:threeway\nX=#\nY=#\n\n#X...X#\n###.###\nY#...##\n##.....\nY#...##\n###.###\n###.###"],t.Crypt.templates.start=t.Crypt.tiles.start.map(e=>a.Template.createTemplate(e)),t.Crypt.startRoomFunc=function(){const e=n.arrayGetRand(t.Crypt.templates.start);let s=n.getUniformInt(0,this.tilesX-1),a=n.getUniformInt(0,this.tilesY-1);switch(e.getProp("name")){case"start_nsew":s=Math.floor(this.tilesX/2),a=Math.floor(this.tilesY/2);break;case"start_sew":a=0,0===s&&(s+=1),s===this.tilesX-1&&(s-=1);break;case"start_new":a=this.tilesY-1,0===s&&(s+=1),s===this.tilesX-1&&(s-=1);break;case"start_nse":s=0,0===a&&(a+=1),a===this.tilesY-1&&(a-=1);break;case"start_nsw":s=this.tilesX-1,0===a&&(a+=1),a===this.tilesY-1&&(a-=1)}return{x:s,y:a,room:e}},t.Crypt.Models.default=[].concat(t.Crypt.tiles.corner).concat(t.Crypt.tiles.corridor).concat(t.Crypt.tiles.omni).concat(t.Crypt.tiles.term).concat(t.Crypt.tiles.misc),t.Crypt.templates.all=t.Crypt.Models.default.map(e=>a.Template.createTemplate(e));const r=a.Template.transformList(t.Crypt.templates.all);t.Crypt.templates.all=t.Crypt.templates.all.concat(r)},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(36);t.Vault={},t.Vault.tiles={},t.Vault.tiles.vault=["\nname:vault_small_s\nX=#\nY=#\n\n#X###X#\n#..?..#\nY.....#\n#.....#\n#.....#\nY.....#\n###.###","\nname:vault_small_n\nX=#\nY=#\n\n#X#.#X#\nY.....#\n#.....#\n#.....#\nY.....#\n#..?..#\n#######","\nname:vault_small_e\nX=#\nY=#\n\n##X##X#\nY.....#\n#.....#\n#?.....\n#.....#\nY.....#\n#######","\nname:vault_small_w\nX=#\nY=#\n\n#X##X##\nY.....#\n#.....#\n.....?#\n#.....#\nY.....#\n#######","\nname:vault_medium_s\nX=#\nY=#\n\n#X...X#\nY.....#\n#.....#\n#.....#\n#.....#\nY.....#\n###.###","\nname:vault_medium_n\nX=#\nY=#\n\n#X###X#\n#..?..#\nY.....#\n#.....#\n#.....#\nY..#..#\n##...##"],t.Vault.tiles.corner=["\nname:vault_nw_corner\nX=#\nY=#\n\n#X###X#\nY......\n#......\n#......\n#......\nY......\n#......","\nname:vault_ne_corner\nX=#\nY=.\n\n#X###X#\nY.....#\n......#\n......#\n......#\nY.....#\n......#","\nname:vault_sw_corner\nX=.\nY=#\n\n#X...X.\nY......\n#......\n#......\n#......\nY......\n###.###","\nname:vault_se_corner\nX=.\nY=.\n\n.X...X#\nY.....#\n......#\n......#\n......#\nY.....#\n#######"],t.Vault.tiles.wall=["\nname:vault_n_wall\nX=#\nY=.\n\n#X###X#\nY......\n.......\n.......\n.......\nY......\n.......","\nname:vault_e_wall\nX=.\nY=.\n\n.X...X#\nY.....#\n......#\n......#\n......#\nY.....#\n......#","\nname:vault_w_wall\nX=.\nY=#\n\n#X...X.\nY......\n#......\n#......\n#......\nY......\n#......","\nname:vault_s_wall\nX=.\nY=.\n\n.X...X.\nY......\n.......\n.......\n.......\nY......\n##...##"],t.Vault.tiles.center=["\nname:vault_center1\nX=.\nY=.\n\n.X...X.\nY......\n.......\n.......\n.......\nY......\n.......","\nname:vault_center2\nX=.\nY=.\n\n.X...X.\nY..#...\n...#...\n.#####.\n...#...\nY..#...\n.......","\nname:vault_center3\nX=#\nY=#\n\n.X...X.\nY..#..#\n...#...\n.#####.\n...#...\nY..#..#\n.#...#."],t.Vault.func={},t.Vault.func.createMediumVault=((e,t,s,a)=>{const n=s.findTemplate({name:"vault_medium_n"}),r=s.findTemplate({name:"vault_medium_s"});s.addRoom(n,e,t),s.addRoom(r,e,t+1),a&&s.addRoom(a,e,t+2)}),t.Vault.func.createLargeVault=((e,t,s,a)=>{const n=s.findTemplate({name:"vault_nw_corner"}),r=s.findTemplate({name:"vault_ne_corner"}),o=s.findTemplate({name:"vault_sw_corner"}),i=s.findTemplate({name:"vault_se_corner"});s.addRoom(n,e,t),s.addRoom(r,e+1,t),s.addRoom(o,e,t+1),s.addRoom(i,e+1,t+1),a&&s.addRoom(a,e,t+2)}),t.Vault.func.createHugeVault=((e,t,s,a,r)=>{const o=s.findTemplate({name:"vault_nw_corner"}),i=s.findTemplate({name:"vault_ne_corner"}),l=s.findTemplate({name:"vault_sw_corner"}),c=s.findTemplate({name:"vault_se_corner"});n.default.isNullOrUndef([o,i,l,c])&&n.default.err("Vault.func","createHugeVault","Corner templates cannot be null. Check they are loaded"),s.addRoom(o,e,t),s.addRoom(i,e+2,t),s.addRoom(l,e,t+2),s.addRoom(c,e+2,t+2);const h=s.findTemplate({name:a});s.addRoom(h,e+1,t+1);const u=s.findTemplate({name:"vault_n_wall"}),d=s.findTemplate({name:"vault_e_wall"}),g=s.findTemplate({name:"vault_w_wall"}),p=s.findTemplate({name:"vault_s_wall"});if(s.addRoom(u,e+1,t),s.addRoom(d,e+2,t+1),s.addRoom(g,e,t+1),s.addRoom(p,e+1,t+2),r){let a=r;"string"==typeof r&&(a=s.findTemplate({name:r})),s.addRoom(a,e+1,t+3)}}),t.Vault.Models={},t.Vault.Models.default=[].concat(t.Vault.tiles.center).concat(t.Vault.tiles.corner).concat(t.Vault.tiles.wall).concat(t.Vault.tiles.vault),t.Vault.templates={},t.Vault.templates.all=t.Vault.Models.default.map(e=>r.Template.createTemplate(e));const o=r.Template.transformList(t.Vault.templates.all);t.Vault.templates.all=t.Vault.templates.all.concat(o)},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=n(s(31)),i=n(s(10)),l=n(s(6)),c=s(131),h=s(44),u=n(s(2)),d=s(8)("bitn:FactoryActor"),g=(e,t)=>{const{hp:s,att:a,def:n,prot:o}=t;if(!r.default.isNullOrUndef([s])){const t=e.get("Health");t.setHP(s),t.setMaxHP(s)}let i=null;e.has("Combat")?i=e.get("Combat"):(i=new u.Combat,e.add(i)),r.default.isNullOrUndef([a])||i.setAttack(a),r.default.isNullOrUndef([n])||i.setDefense(n),r.default.isNullOrUndef([o])||i.setProtection(o)};t.ActorRandomizer=function(){},t.ActorRandomizer.prototype.adjustActor=function(e){const t=e.getType();if(c.ActorMods.hasOwnProperty(t)){const{stats:s}=c.ActorMods[t];Object.keys(s).forEach(t=>{const a=r.default.formatSetterName(t),n=r.default.formatSetterName(t),o=e.get("Stats")[n]+s[t];e.get("Stats")[a](o)})}},t.FactoryActor=function(){this._randomizer=new t.ActorRandomizer,this.dbg=function(...e){d.enabled&&d(...e)},this.createPlayer=((e,t)=>{const s=new o.SentientActor(e);return s.setIsPlayer(!0),g(s,t),this._randomizer.adjustActor(s),s}),this.createRandomActor=function(e){return l.getParser().createRandomActor(e)},this.createActor=function(e,t={}){const s=new o.SentientActor(e);s.setType(e);const a=t.brain;if(g(s,t),this._randomizer.adjustActor(s),!r.default.isNullOrUndef([a]))if("object"==typeof a)s.setBrain(a);else{const e=this.createBrain(s,a);s.setBrain(e)}return s},this.createBrain=((e,t)=>{switch(t){case"Flame":return new i.BrainFlame(e);case"GoalOriented":return new i.BrainGoalOriented(e);case"NonSentient":return new i.BrainNonSentient(e);case"SpellCaster":return new i.BrainSpellCaster(e);case"Spirit":return new i.BrainSpirit(e);default:if(i[t])return new i[t](e);if(t&&""!==t){let e=`Warning. No brain type ${t} found`;e+="Using the default Brain.BrainSentient instead.",console.warn(e)}return new i.BrainSentient(e)}})},t.FactoryActor.prototype.createSpell=function(e){if(h.Spell.hasOwnProperty(e))return new h.Spell[e];{const t=Object.keys(h.Spell).join("\n\t");r.default.err("FactoryActor","createSpell",`No spell ${e} found in Spell: \n\t${t}`)}return null},t.FactoryActor.prototype.generateNActors=function(e,t,s){(!Number.isInteger(s)||s<=0)&&r.default.err("Factory.Actor","generateNActors","maxDanger (> 0) must be given. Got: "+s),s<3&&(s=3);const a=l.getParser(),n=[],o={func:e=>e.danger<=s};for(let i=0;i<e;i++){let e=null;if(e=t?a.createRandomActor({func:e=>t(e)&&e.danger<=s}):a.createRandomActorWeighted(1,s,o)){const t=a.dbGet(r.default.TYPE_ACTOR,e.getName()),o=s-t.danger;o>1&&r.default.levelUpActor(e,o),n.push(e)}else{let e="Factory Could not meet constraints for actor.";if(e+=" maxDanger: "+s,r.default.diag(e),t.constraint){const e=JSON.stringify(t.constraint);r.default.diag("Used constraints were: "+e)}else t||r.default.diag("No func was given, so used randomWeighted")}}return n}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0));class r{constructor(e){this.stepType="Task",this.name="",this.taskType=e}isTask(){return!0}isQuest(){return!1}getName(){return this.name}getTaskType(){return this.taskType}}t.Task=r;t.Quest=class{constructor(e,t){e&&"string"!=typeof e&&n.default.err("Quest","new","Quest must have a name!"),this.name=e,this.steps=[],this.stepType="Quest",this.motive="",this.terms=[],Array.isArray(t)&&t.forEach(e=>{if(e.isQuest)this.addStep(e);else if(e.isTask)this.addStep(e);else{const t=new r(e);this.addStep(t)}})}setName(e){this.name=e}getName(){return this.name}setMotive(e){this.motive=e}getMotive(){return this.motive}isTask(){return!1}isQuest(){return!0}addTerm(e){this.terms.push(e)}getTasks(){return this.steps.filter(e=>e.isTask())}addStep(e){Array.isArray(e)?this.steps=this.steps.concat(e):this.steps.push(e)}numQuests(){let e=1;return this.steps.forEach(t=>{t.isQuest&&t.isQuest()&&(e+=1)}),e}numTasks(){const e=this.numQuests()-1;return this.steps.length-e}getSteps(){return this.steps.slice()}numSteps(){return this.steps.length}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0));class r{constructor(){this._stacks={},this.path=[],this._ptr={}}addTarget(e,t){if(!n.default.isEntity(t)&&!t.createTarget){const e=JSON.stringify(t);n.default.err("QuestData","addTarget",`Only entities can be added. Got: ${e}`)}if(r.mapStepToType[e])this._stacks[e]||(this._stacks[e]=[]),this._stacks[e].push(t),this.path.push({type:e,target:t});else{const t=JSON.stringify(r.mapStepToType);n.default.err("QuestData","add",`Step type ${e} not supported. See:\n${t}`)}}replaceTarget(e,t,s){const a=this._stacks[e];let r=a.indexOf(t);if(r>=0){if(a.splice(r,1,s),(r=this.path.findIndex(e=>e.target===t))>=0){const e={target:s,type:this.path[r].type};this.path.splice(r,1,e)}else n.default.err("QuestData","replaceTarget","Could not replace target on path");return!0}return!1}numSteps(){return this.path.length}keys(){return Object.keys(this._stacks)}getPathTypes(){return this.path.map(e=>e.type)}getPathTargets(){return this.path.map(e=>e.target)}pop(e){return this._stacks[e]?this._stacks[e].pop():null}resetIter(){this.keys().forEach(e=>{this._ptr[e]=0})}next(e){if(this._stacks[e]){this._ptr.hasOwnProperty(e)||(this._ptr[e]=0);const t=this._ptr[e];if(t<this._stacks[e].length)return++this._ptr[e],this._stacks[e][t]}return null}getCurrent(e){if(this._stacks[e]){const t=this._stacks[e];return t[t.length-1]}return null}getCurrentLocation(){const e=this.getCurrent("location");if(e)return e;n.default.err("QuestGen","getCurrentLocation","No location found")}getDescr(){let e="";return this.path.forEach(t=>{const s=t.type,a=t.target,r=n.default.getName(a);e+=s+" "+r+". "}),e}toJSON(){const e=[];return this.path.forEach(t=>{const s=r.mapStepToType[t.type];if(s)if(t.target.getID){const a={type:t.type,target:n.default.getObjRef(s,t.target)};e.push(a)}else{const s={type:t.type,target:t.target};e.push(s)}else console.error("Used step is",t),n.default.err("QuestData","toJSON",`No refType for step type ${t.type}`)}),e.$objRefArray=!0,{createFunc:"createQuestData",value:{path:e}}}}t.QuestData=r,r.mapStepToType={capture:"entity",escort:"entity",exchange:"item",experiment:"item",explore:"element",damage:"entity",defend:"entity",get:"item",give:"entity",kill:"entity",listen:"entity",location:"place",finishbattle:"place",read:"item",repair:"element",report:"entity",reportListen:"entity",rescue:"entity",spy:"entity",steal:"item",take:"item",subquest:"entity",use:"item",winbattle:"place"}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=s(8)("bitn:quest-gen"),n=s(1),r=s(135),o=s(80),i=s(136).QuestGrammar.grammar,l=n.Random.getRNG();class c{static parse(e){const t=r.parse(e),s={};return t.productions.forEach(e=>{s[e.lhs.text]=e.rhs.map(function(e,t){return t[e]}.bind(null,"terms"))}),s}constructor(e){this._init(),this.rng=e||l}_init(){this.stack=[],this.currQuest=null,this.ruleHist={},this.startRule="QUEST"}genQuestWithMotive(e={}){const{motive:t}=e,s=e.rules||c.rules,[a]=this.chooseRandomRule(s[t]),n=a.text;console.log("questType is",n);const r=Object.assign({},e);r.rules=s,r.startRule=n;const o=this.genQuestWithConf({startRule:n,rules:s});return o.setName(n),o.setMotive(t),o}genQuestWithConf(e={}){e.debug&&(a.enabled=!0);const t=e.rules||c.rules,s=e.startRule||"QUEST";let n=!1,r=e.maxTries||20,o=[];for(;!n;)if(this._init(),this.startRule=s,a("=== Generating new quest now ==="),o=this.generateQuest(t,s).split("|"),(n=this._questMeetsReqs(o,e))||a("QUEST DISCARDED"),0==--r){console.warn("Could not find a matching quest.");break}return this.currQuest}genQuestWithName(e){const t=new o.Quest(e),s=new o.Task("<goto>already_there");t.addStep(s);const a=new o.Task("<kill>kill");return t.addStep(a),t}_questMeetsReqs(e,t){let s=!0;const n=t.minLength||1,r=t.maxLength||-1;return(e.length<=r||-1===r)&&e.length>=n?(s=!0,a("MATCHING QUEST FOUND")):s=!1,t.minQuests&&(s=s&&this.currQuest.numQuests()>=t.minQuests),t.maxQuests&&(s=s&&this.currQuest.numQuests()<=t.maxQuests),s}generateQuest(e,t){if(this.ruleHist[t]?this.ruleHist[t]+=1:this.ruleHist[t]=1,a(`generateQuest with rule |${t}|`),t===this.startRule||"QUEST"===t){a("New (sub)-quest will be generated");const e="";this.currQuest=new o.Quest(e),this.stack.push(this.currQuest)}a(`Choosing randRule ${t} from ${JSON.stringify(e[t])}`);const s=this.chooseRandomRule(e[t]);if(Array.isArray(s)){const a=s.map(this.generateTerm.bind(this,e));return this._checkIfQuestOver(t),a.join("|")}return a(`generateQuest end reached, return |${s}|`),this._checkIfQuestOver(t),s}generateTerm(e,t){if(!t.text){const t=JSON.stringify(e);throw new Error(`Null/undef term.text with rules| ${t}|`)}return"terminal"===t.type?this.currQuest.addTerm(t.text):this.currQuest.addTerm("<<"+t.text+">>"),"terminal"===t.type?(this.currQuest.addStep(new o.Task(t.text)),t.text):(a(`genTerm: term.type ${t.type} text: ${t.text}`),a(`calling generate() with term.text |${t.text}|`),this.generateQuest(e,t.text))}_checkIfQuestOver(e){if(e===this.startRule||"QUEST"===e){if(a("Finishing current quest"),this.stack.length>1){const e=this.stack.pop();this.currQuest=this.stack[this.stack.length-1],this.currQuest.addStep(e)}}}chooseRandomRule(e){if(Array.isArray(e)){const t=this.rng.arrayGetRand(e);return a("chose next rule at RANDOM:",t),t}return a(`chooseRandomRule() not an ARRAY: |${e}`),null}}t.QuestGen=c,c.rules=c.parse(i),c.defaultConfig={rules:c.rules,startRule:"QUEST",maxTries:20,debug:!1,minQuests:1,maxQuests:-1,minLength:1,maxLength:-1}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(8)("bitn:FactoryZone"),i=n(s(20)),l=s(38),c=s(25),h=s(143),u=s(60),d=s(62),g=s(1),p=s(6),m=n(s(5)),f=g.Random.getRNG();t.FactoryZone=function(){l.FactoryBase.call(this),this._verif=new i.Conf("FactoryZone"),this._parser=p.ObjectShell.getParser(),this.rng=f,this.getRandLevelType=(()=>{const e=["uniform","rooms","rogue","digger"];return e[this.rng.randIndex(e)]}),this.setRNG=(e=>{this.rng=e}),this.addItemsAndActors=function(e,t){this._verif.verifyConf("addItemsAndActors",t,["nLevel","sqrPerItem","sqrPerActor","maxValue"]);const s=e.getMap().getFree().length,a=Math.round(s/t.sqrPerActor),n=Math.round(s/t.sqrPerItem),i=n;o(`Adding ${a} monsters and items `+`${n} to the level`);const l=(e,t)=>s=>s.value>=e&&s.value<=t,c={nLevel:t.nLevel,itemsPerLevel:n,func:l(0,t.maxValue),maxValue:t.maxValue,food:!0,gold:!0};t.hasOwnProperty("food")&&(c.food=t.food),t.hasOwnProperty("gold")&&(c.gold=t.gold),t.item?(c.func=t.item,o(`Set itemConf.func to ${t.item.toString()}`)):t.minValue&&(c.func=l(t.minValue,t.maxValue)),this.addNRandItems(e,this._parser,c);const h={actorsPerLevel:t.actorsPerLevel||a,maxDanger:t.maxDanger||t.nLevel+1};if(t.actor&&("function"==typeof t.actor?h.func=t.actor:r.default.err("FactoryZone","addItemsAndActors","conf.actor must be a function")),this.addNRandActors(e,this._parser,h),c.gold){const s={goldPerLevel:i,nLevel:t.nLevel+1};this.addRandomGold(e,this._parser,s)}},this.createDungeonLevel=function(e){this._verif.verifyConf("createDungeonLevel",e,["x","y"]);let t=null,s=this.getRandLevelType();return e.dungeonType&&""!==e.dungeonType&&(s=e.dungeonType),o(`dungeonLevel: ${s}, ${JSON.stringify(e)}`),t=this.createLevel(s,e.x,e.y,e),this.addItemsAndActors(t,e),this.addExtraDungeonFeatures(t,e),t},this.createMountainLevel=function(e){let t=Object.assign(h.MountainGenerator.getFaceOptions(),{maxValue:100,sqrPerActor:50,sqrPerItem:200,nLevel:4});t=Object.assign(t,e),o(`Creating mountain level with ${e}`);const s=(new h.MountainGenerator).createFace(e.x,e.y,t);return this.addItemsAndActors(s,t),s},this.createSummitLevel=function(e){this._verif.verifyConf("createSummitLevel",e,["cols","rows"]);let t={maxValue:100,sqrPerActor:20,sqrPerItem:200,nLevel:4};t=Object.assign(t,e);const s=(new h.MountainGenerator).createSummit(e.cols,e.rows,t);return o(`Creating summit level with ${e}`),this.addItemsAndActors(s,t),e.maxValue||(e.maxValue=t.maxValue),s},this.createCityLevel=function(e,t){const s=l.Factory.cityConfBase(t);s.parser=this._parser;let a=null;const{x:n,y:r}=t;if(s.groupType)switch(s.groupType){case"village":a=this.createVillageLevel(n,r,s);break;case"capital":a=this.createCapitalLevel(e,n,r,s);break;case"stronghold":a=this.createStrongholdLevel(n,r,s);break;case"fort":a=this.createFortLevel(n,r,s)}if(null===a&&(a=this.createLevel("town",n,r,s),this.populateCityLevel(a,s)),t.friendly){a.getActors().forEach(e=>{e.has("NonSentient")||e.getBrain().getMemory().removeEnemyType("player")})}if(t.disposition){const{disposition:e}=t;a.getActors().forEach(t=>{Object.keys(e).forEach(s=>{"enemy"===e[s]&&t.getBrain().getMemory().addEnemyType(s)})})}return a},this.createVillageLevel=function(e,t,s){s.levelType="empty",s.wallType="wooden",s.actorsPerLevel||(s.actorsPerLevel=30),s.maxDanger||(s.maxDanger=3),s.itemsPerLevel||(s.itemsPerLevel=2*s.maxDanger);const a=(new u.CityGenerator).create(e,t,s);return this.populateCityLevel(a,s),this.addItemsToCityLevel(a,s),a},this.createFortLevel=function(e,t,s){const a=new d.CastleGenerator;s.roomCount=-1;const n=a.create(100,84,s);return this.populateCityLevel(n,s),n},this.createCapitalLevel=function(e,t,s,a){a.levelType="miner";let n=null;return 0===e?(a.levelType="townwithwall",n=this.createLevel("townwithwall",200,84,a)):n=this.createLevel("town",100,84,a),this.populateCityLevel(n,a),n},this.createStrongholdLevel=function(e,t,s){s.levelType="miner";const a=this.createLevel("town",100,84,s);return this.populateCityLevel(a,s),a},this.populateCityLevel=function(e,t){let s=t.alignment;s||(s=this.rng.arrayGetRand(r.default.ALIGNMENTS)),t.actor?this.populateWithActors(e,t):s===r.default.ALIGN_GOOD?this.populateWithHumans(e,t):s===r.default.ALIGN_EVIL?this.populateWithEvil(e,t):this.populateWithNeutral(e,t)},this.addItemsToCityLevel=function(e,t){const s=e.getMap().getCells(e=>"floorhouse"===e.getBaseElem().getType()),a=new c.FactoryItem,n=p.ObjectShell.getParser(),o={func:e=>e.value<=10*t.maxDanger,maxValue:50*t.maxDanger};r.default.isNullOrUndef([t.itemsPerLevel])||(o.itemsPerLevel=t.itemsPerLevel),a.addItemsToCells(e,n,s,o)},this.populateWithActors=function(e,t){const s={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,func:t.actor};if(0===this.addNRandActors(e,this._parser,s)){const t=e.getParent();let a="No actors added to level.";a+="\nUsed conf was "+JSON.stringify(s),t&&(a+="\nLevel parent: "+t.getName()),r.default.err("FactoryZone","populateWithActors",a)}},this.populateWithHumans=function(e,t){const s={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,func:e=>"human"===e.type&&"shopkeeper"!==e.name};t.func&&(s.func=t.func),this.addNRandActors(e,this._parser,s)},this.populateWithEvil=function(e,t){let s=!1;for(;!s;){const a=this.rng.arrayGetRand(r.default.EVIL_RACES),n={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,func:e=>e.type===a};t.func&&(n.func=t.func),s=this.addNRandActors(e,this._parser,n)}},this.populateWithNeutral=function(e,t){const s=this.rng.arrayGetRand(r.default.NEUTRAL_RACES),a={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,func:e=>e.type===s};t.func&&(a.func=t.func),this.addNRandActors(e,this._parser,a)},this.addActorToLevel=((e,t)=>{const s=this._parser.createActor(e),a=t.getFreeRandCell();t.addActor(s,a.getX(),a.getY())}),this.addExtraDungeonFeatures=((e,t)=>{const s=e.getExtras();if(s.rooms){s.rooms.forEach(t=>{t.getDoors((t,s)=>{e.addElement(new m.ElementDoor(!0),t,s)})});const a=this.rng.arrayGetRand(s.rooms).getBbox();this.addActorsToBbox(e,a,t)}})},r.default.extend2(t.FactoryZone,l.FactoryBase)},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(8)("bitn:ConfStack");t.ConfStack=function(){this.globalConf={},this.scope=[],this.confStack=[],this.setGlobalConf=function(e){this.globalConf=e},this.getGlobalConf=function(){return this.globalConf},this.getScope=function(){return this.scope},this.pushScope=function(e){this.scope.push(e.name),this.confStack.push(e),this.dbg("Pushed scope: "+e.name)},this.popScope=function(e){const t=e.name,s=this.scope.pop();if(s!==t)n.default.err("Factory.ConfStack","popScope",`Popped: ${s}, Expected: ${t}`);else{const e=this.confStack.pop();this.dbg("Popped scope: "+e.name)}},this.getConf=function(e){for(let t=this.confStack.length-1;t>=0;t--)if(this.dbg(`[${t}] looking for |${e}|`),this.confStack[t].hasOwnProperty(e))return this.dbg(`  >> [${t}] Found key |${e}|`),this.confStack[t][e];return this.globalConf.hasOwnProperty(e)?this.globalConf[e]:null},this.dbg=function(e){r.enabled&&n.default.diag(e)}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(8)("bitn:Game.FromJSON"),o=a(s(0)),i=s(64),l=s(59),c=s(56),h=s(26),u=s(72),d=s(49),g=s(61),p=s(154),m=s(11),f=s(58),y=s(7),_=s(16),E=s(44),S=s(9),v=s(6),C=s(2),b=s(19),T=s(31),A=s(27),w=n(s(5)),O=s(39),M=n(s(21)),P=s(1),N=s(65),I=n(s(32)),D=s(88),L=s(10),R=s(51),x=s(33),k=y.EventPool.getPool(),B=T.Actor.Sentient;L.Brain.Player=R.BrainPlayer,L.Brain.Spawner=x.BrainSpawner;const G=Symbol();t.FromJSON=function(){this._dungeonLevel=1,this._parser=v.ObjectShell.getParser(),this.id2level={},this.id2entity={},this.id2EntityJson={},this.id2Object={},this.id2Place={},this.actorsKilled={},this.id2Component={},this.id2CompJSON={},this.compsWithMissingRefs={},this.stairsInfo={},this.IND=0},t.FromJSON.prototype.reset=function(){this.id2level={},this.id2entity={},this.id2EntityJson={},this.id2Object={},this.id2Component={},this.id2CompJSON={},this.id2Place={},this.stairsInfo={},this.compsWithMissingRefs={}},t.FromJSON.prototype.setChunkMode=function(e){this.chunkMode=e},t.FromJSON.prototype.getDungeonLevel=function(){return this._dungeonLevel},t.FromJSON.prototype.addObjRef=function(e,t,s){const a=t.getID();Number.isInteger(a)||o.default.err("FromJSON","addObjRef",`ID must be integer. Got: |${a}|`),this.id2entity[a]=t,this.id2Object[a]=t,s&&(this.id2EntityJson[a]=s),"level"===e?(this.id2level[a]=t,this.id2Place[a]=t):"element"===e||"entity"===e||o.default.err("FromJSON","addObjRef",`Unsupported type ${e} give`)},t.FromJSON.prototype.getObjByRef=function(e){let t=null;if("entity"===(t=e.$objRef?e.$objRef:e).type){const e=this.id2entity[t.id];if(!e){if(this.actorsKilled[t.id])return G;o.default.err("FromJSON","getObjRef",`No ID ${t.id} found`)}return e}return"level"===t.type?this.id2level[t.id]:"object"===t.type?this.id2Object[t.id]:"component"===t.type?this.id2Component[t.id]:"place"===t.type?this.id2Place[t.id]:null},t.FromJSON.prototype.createGame=function(e,t){"string"==typeof t&&o.default.err("Game.FromJSON","createGame","An object must be given instead of string"),this.dbg("createGame: Restoring now full game"),this.IND=1,this.setGlobalConfAndObjects(e,t),t.chunkManager&&this.setChunkMode(!0),C.Component.setIDCount(t.lastComponentID);const s=[];if(this.getLevelsToRestore(t).forEach(t=>{const a=this.restoreLevel(t);s.push(a),t.parent||(this.dbg(">> No parent. Adding directly "+a.getID()),e.addLevel(a))}),t.places&&Object.keys(t.places).forEach(s=>{const a=t.places[s],n=this.restorePlace(a);e.addPlace(n)}),t.overworld){const s=this.restoreOverWorld(t.overworld);e.setOverWorld(s)}if(t.worldSim&&e.setWorldSim(this.restoreWorldSim(t.worldSim)),this.connectGameLevels(s),t.player){const s=this.restorePlayer(t.player);this.addRestoredPlayerToGame(s,e,t)}this.restoreEntityData(),this.restoreComponentData();const a=this.restoreGameMaster(e,t.gameMaster);if(e.setGameMaster(a),this.restoreChunkManager(e,t),this.checkNumOfLevels(e,t),d.GameObject.ID=t.gameObjectID,r.enabled&&this.dbg(`Restored GameObject ID count to ${d.GameObject.ID}`),t.rng){const s=new P.Random(t.rng.seed);s.setState(t.rng.state),e.setRNG(s)}if(t.diceRng){const e=new P.Random(t.diceRng.seed);e.setState(t.diceRng.state),_.Dice.RNG=e}return this.IND=0,e},t.FromJSON.prototype.restorePlayer=function(e){const t=new B(e.name);return t.setIsPlayer(!0),t.remove("StatsMods"),t.remove("CombatMods"),t.setType(e.type),t.setID(e.id),this._dungeonLevel=e.dungeonLevel,this.addObjRef("entity",t,e),o.default.addCellStyle(o.default.TYPE_ACTOR,e.name,"cell-actor-player"),t},t.FromJSON.prototype.restorePlayerBrain=function(e,t){const s=e.getBrain(),a=s.getMemory(),n=t.memory;Object.keys(n).forEach(e=>{a[e](n[e])}),t.markList&&s._markList.fromJSON(t.markList)},t.FromJSON.prototype.addRestoredPlayerToGame=function(e,t,s){this._addRegenEvents(t,e);const a=s.player.levelID,n=t.getLevels().find(e=>e.getID()===a);if(n){const a=s.player.x,r=s.player.y;n.addActor(e,a,r),t.addPlayer(e)}else{const e=`IDs available: ${t.getLevels().map(e=>e.getID())}`;o.default.err("Game.FromJSON","addRestoredPlayerToGame",`Cannot find player level object with level ID ${a}. ${e}`)}},t.FromJSON.prototype.restoreEntity=function(e,t){return o.default.isActor(t)?(this.createBrain(e.brain,t),this._addEntityFeatures(e,t)):o.default.isElement(t)?this.restoreElementEntity(e,t):this.restoreLevelEntity(e,t),t},t.FromJSON.prototype._addEntityFeatures=function(e,t){this.addCompsToEntity(t,e.components),this.createInventoryItems(e,t),this.createEquippedItems(e,t),e.fovRange&&t.setFOVRange(e.fovRange),e.spellbook&&this.createSpells(e,t)},t.FromJSON.prototype.restoreElementEntity=function(e,t){"lever"===t.getType()&&e.addTarget.forEach(e=>{const s=e.$objRef,a=this.id2entity[s.id];a&&t.addTarget(a)})},t.FromJSON.prototype.restoreLevelEntity=function(e,t){this.addCompsToEntity(t,e.components)},t.FromJSON.prototype.addCompsToEntity=function(e,t){for(const s in t)if(s){const a=t[s],n=a.setType;if(!n){const e='No "name" in component: ';o.default.err("Game.FromJSON","addCompsToEntity",e+": "+JSON.stringify(a))}const r=this.createComponent(n,a);e.add(r)}},t.FromJSON.prototype.createComponent=function(e,t){if(!C.Component.hasOwnProperty(e)){let s=`No |${e}| in Component.`;s+=` compJSON: ${JSON.stringify(t)}`,o.default.err("Game.FromJSON","createComponent",s)}const s=new C.Component[e];for(const a in t)if("function"==typeof s[a]){const e=t[a],n=this.getCompValue(s,t,a,e);s[a](n)}else{const s=JSON.stringify(t);o.default.err("FromJSON","createComponent",`${a} not function in ${e}. Comp: ${s}`)}const a=s.getID();return this.id2Component[a]=s,this.id2CompJSON[a]=t,s},t.FromJSON.prototype.getCompValue=function(e,t,s,a){if(o.default.isNullOrUndef([a])){const e=JSON.stringify(t);let n=`valueToSet |${a}|. setFunc |${s}|`;n+=`Comp |${t.setType}|, json: ${e}`,o.default.err("FromJSON","addCompsToEntity",n)}else{if(Array.isArray(a)){if(a.$objRefArray)return this.compsWithMissingRefs[t.setID]=e,a;const n=[];return a.forEach(a=>{const r=this.getCompValue(e,t,s,a);n.push(r)}),n}if(a.createFunc){return this[a.createFunc](a.value)}if(a.createComp){const e=a.createComp.setType;return this.createComponent(e,a.createComp)}if(!a.$objRef)return a;if("component"===a.$objRef.type)return this.compsWithMissingRefs[t.setID]=e,a;{const e=this.getObjByRef(a.$objRef);if(e)return e;{let e=`Null obj for objRef ${JSON.stringify(a.$objRef)}`;e+=` compJSON: ${JSON.stringify(t)}`,o.default.err("FromJSON","getCompValue",e)}}}return null},t.FromJSON.prototype.createActorClass=function(e){const{className:t,actorRef:s}=e,a=this.getObjByRef(s);return a?f.ActorClass.create(t,a):(o.default.err("FromJSON","createActorClass",`No actor for class ${t} found`),null)},t.FromJSON.prototype.createQuestData=function(e){const t=new g.QuestData;return e.path.forEach(e=>{let s=null;if((s=e.target.$objRef?this.getObjByRef(e.target.$objRef):e.target)===G)s={msg:"Quest target missing/killed"};else if(!s){const t=`Missing objRef: ${JSON.stringify(e.target)}`;o.default.err("FromJSON","createQuest",t)}t.addTarget(e.type,s)}),t},t.FromJSON.prototype.createBrain=function(e,t){const s=e.type;if(L.Brain[s]){const a=new L.Brain[s](t);if(t.setBrain(a),"Player"===s)return void this.restorePlayerBrain(t,e);e.constraint&&a.setConstraint(e.constraint);const n=a.getMemory(),r=e.memory;if(r){if(r.enemyTypes.forEach(e=>{a.addEnemyType(e)}),r.lastAttackedID){const e=this.id2entity[r.lastAttackedID];n.setLastAttacked(e)}if(r.enemies&&r.enemies.forEach(e=>{const t=this.id2entity[e];t&&n.addEnemy(t)}),r.friends&&r.friends.forEach(e=>{const t=this.id2entity[e];t&&n.addFriend(t)}),r.seen&&(n._actors.seen=r.seen),e.goal){const s=this.createTopGoal(e.goal,t);a.setGoal(s)}}else"Rogue"===s&&a.getMemory().addEnemyType("player")}else o.default.err("FromJSON","createBrain",`Cannot find Brain.${s}, JSON: ${e}`)},t.FromJSON.prototype.createTopGoal=function(e,t){const s=new c.GoalsTop[e.type](t);return s.removeEvaluators(),e.evaluators.forEach(e=>{let a=null;if(h.Evaluator[e.type])a=new h.Evaluator[e.type](e.bias);else if(u.EvaluatorsBattle[e.type])a=new u.EvaluatorsBattle[e.type](e.bias);else{const s=`Entity: ${JSON.stringify(t)}`;o.default.err("FromJSON","createTopGoal",`Evaluator ${e.type} not found. ${s}`)}e.args&&a.setArgs(e.args),s.addEvaluator(a)}),s},t.FromJSON.prototype.createSpells=function(e,t){return t._spellbook=new E.Spell.SpellBook(t),e.spellbook.spells.forEach(e=>{if(E.Spell.hasOwnProperty(e.new)){const s=this.restoreSpell(e,t);t._spellbook.addSpell(s)}else o.default.err("FromJSON","createSpells",`No spell ${e.new} found in Spell`)}),t._spellbook},t.FromJSON.prototype.restoreSpell=function(e,t){const s=new E.Spell[e.new];if(s.setPower(e.power),e.range&&s.setRange(e.range),e.dice){const t={};Object.keys(e.dice).forEach(s=>{const a=e.dice[s];t[s]=_.Dice.create(a)}),s._dice=t}return e.spells&&(s.removeSpells(),e.spells.forEach(e=>{const a=this.restoreSpell(e,t);s.addSpell(a)})),s},t.FromJSON.prototype.createItem=function(e){const t=e;let s=null;if(this._parser.hasItem(e.setName))s=this._parser.createItem(e.setName);else{const a=this.getItemObjectType(t);if(b.Item[a])s=new b.Item[a];else{let t=`No RG.Item[${a}] found for new()`;t+=` JSON: ${JSON.stringify(e)}`,o.default.err("FromJSON","createItem",t)}}for(const e in t)if("setSpirit"===e){const a=t[e],n=this.createActor(a);this._addEntityFeatures(a,n),s[e](n)}else if("function"==typeof s[e])s[e](t[e]);else if("components"!==e&&"isUsable"!==e){const t=JSON.stringify(s);o.default.err("Game.FromJSON","createItem",`${e} not func in ${t}`)}return this.addEntityInfo(s,e),t.components&&this.addCompsToEntity(s,e.components),s},t.FromJSON.prototype.createInventoryItems=function(e,t){if(e.hasOwnProperty("inventory")){const s=e.inventory;for(let e=0;e<s.length;e++){const a=this.createItem(s[e]);t.getInvEq().addItem(a)}}},t.FromJSON.prototype.createEquippedItems=function(e,t){if(e.hasOwnProperty("equipment")){const s=e.equipment;for(let e=0;e<s.length;e++){const a=this.createItem(s[e]);t.getInvEq().restoreEquipped(a)}}},t.FromJSON.prototype.getItemObjectType=function(e){if("spiritgem"===e.setType)return"SpiritGem";if("goldcoin"===e.setType)return"GoldCoin";if("missileweapon"===e.setType)return"MissileWeapon";if(o.default.isNullOrUndef([e]))o.default.err("Game.Save","getItemObjectType","item is undefined");else{if(!o.default.isNullOrUndef([e.setType]))return e.setType.capitalize();{const t=JSON.stringify(e);o.default.err("Game.Save","getItemObjectType","item.setType is undefined. item: "+t)}}return null},t.FromJSON.prototype.restoreLevel=function(e){const t=new m.Level;t.setID(e.id),t.setLevelNumber(e.levelNumber);const s=this.createCellMap(e.map);return t.setMap(s),e.actors.forEach(e=>{const s=this.createActor(e.obj);null!==s?this.isVirtual(e)?t.addVirtualProp(o.default.TYPE_ACTOR,s):t.addActor(s,e.x,e.y):o.default.err("FromJSON","restoreLevel",`Actor ${JSON.stringify(e)} returned null`)}),e.elements.forEach(e=>{const s=this.createElement(e);null!==s?t.addElement(s,e.x,e.y):o.default.err("FromJSON","restoreLevel",`createElement ${JSON.stringify(e)} returned null`)}),e.items.forEach(e=>{const s=this.createItem(e.obj);null!==s?t.addItem(s,e.x,e.y):o.default.err("FromJSON","restoreLevel",`Actor ${JSON.stringify(e)} returned null`)}),this.addLevels([t],"restoreLevel",[e]),t},t.FromJSON.prototype.isVirtual=function(e){return-1===e.x&&-1===e.y},t.FromJSON.prototype.createElement=function(e){const t=e.obj,s=t.type;let a=null;if("connection"===s)a=this.createUnconnectedStairs(e);else if("shop"===s){const e=new w.ElementShop;let s=null;o.default.isNullOrUndef([t.shopkeeper])||((s=this.id2entity[t.shopkeeper])?e.setShopkeeper(s):o.default.err("Game.FromJSON","createElement",`Shopkeeper with ID ${t.shopkeeper} not found`)),e.setCostFactor(t.costFactorBuy,t.costFactorSell),t.isAbandoned&&e.abandonShop(),a=e}else if("door"===s)a=new w.ElementDoor(t.closed);else if("leverdoor"===s)a=new w.ElementLeverDoor(t.closed);else if("lever"===s)a=new w.ElementLever;else if("marker"===s)(a=new w.ElementMarker(t.char)).setTag(t.tag);else if("exploration"===s){const e=new w.ElementExploration;e.setExp(t.setExp),t.data&&e.setData(t.data),a=e}else"web"===s?a=new w.ElementWeb:"slime"===s?a=new w.ElementSlime:"hole"===s&&(a=new w.ElementHole);if(t.msg&&a.setMsg(t.msg),a){const e=t.id;Number.isInteger(e)&&(a.setID(e),this.addObjRef("element",a,t))}return a},t.FromJSON.prototype.createActor=function(e){null===e.type&&o.default.err("FromJSON","createActor",`json.type null, json: ${JSON.stringify(e)}`);let t=null;if(e.new&&T.Actor[e.new])t=new T.Actor[e.new](e.name);else{let t="";const s=JSON.stringify(e);if(e.new){const a=Object.keys(T.Actor);t=`${e.new} not in RG.Actor: ${a}. JSON obj: `+s}else t="No json.new given. JSON obj: "+s;o.default.err("Game.FromJSON","createActor",t)}return t.setType(e.type),t.setID(e.id),this.addEntityInfo(t,e),t},t.FromJSON.prototype.addEntityInfo=function(e,t){this.addObjRef("entity",e,t)},t.FromJSON.prototype.createUnconnectedStairs=function(e){const{x:t,y:s}=e,a=`${e.obj.srcLevel},${t},${s}`,n=e.obj,r=new w.ElementStairs(n.name);return this.stairsInfo[a]={targetLevel:n.targetLevel,targetStairs:n.targetStairs},r},t.FromJSON.prototype.createCellMap=function(e){if(e.encoded)return A.CellMap.fromJSON(e);const t=new A.CellMap(e.cols,e.rows);return e.cells.forEach((e,s)=>{e.forEach((e,a)=>{const n=this.createBaseElem(e);t.setBaseElemXY(s,a,n)})}),e.explored.forEach(e=>{t.getCell(e[0],e[1]).setExplored()}),t},t.FromJSON.prototype.createBaseElem=function(e){const t=S.ELEM_MAP.elemIndexToType[e];return S.ELEM_MAP.elemTypeToObj[t]?S.ELEM_MAP.elemTypeToObj[t]:(o.default.err("Game.fromJSON","createBaseElem",`Unknown type ${t}`),null)},t.FromJSON.prototype.setGlobalConfAndObjects=function(e,t){t.globalConf&&(this.dbg("Setting globalConf for game: "+JSON.stringify(t.globalConf,null,1)),e.setGlobalConf(t.globalConf)),t.cellStyles&&(o.default.cellStyles=t.cellStyles),t.charStyles&&(o.default.charStyles=t.charStyles),t.actorsKilled&&(this.actorsKilled=t.actorsKilled,e.actorsKilled=t.actorsKilled)},t.FromJSON.prototype.connectGameLevels=function(e){e.forEach(e=>{e.getConnections().forEach(t=>{const s=this.stairsInfo[t.getID()],a=this.id2level[s.targetLevel];if(!a&&this.chunkMode)return void t.setConnObj(s);const n=s.targetStairs;n||(o.default.diag(JSON.stringify(e,null,1)),o.default.diag(s),o.default.diag("Parent: "+e.getParent().getName()),o.default.diag(JSON.stringify(t)));const r=n.x,i=n.y;if(a){t.setTargetLevel(a);const e=a.getMap().getCell(r,i).getConnection();e?t.connect(e):o.default.err("Game.FromJSON","connectGameLevels","Target stairs was null. Cannot connect.")}else{const e=s.targetLevel;o.default.err("Game.FromJSON","connectGameLevels",`Target level ${e} null. Cannot connect.`)}})})},t.FromJSON.prototype.restoreGameMaster=function(e,t){++this.IND;const s=e.getGameMaster(),a={};return Object.keys(t.battles).forEach(e=>{t.battles[e].forEach(t=>{if(a[e]=[],this.id2level[e]){this.dbg(`FromJSON Restoring Battle ${e}`);const s=this.restoreBattle(t);a[e].push(s)}else this.dbg(`FromJSON Battle ${e} not created`),this.dbg(JSON.stringify(t)),a[e].push(t)})}),s.setBattles(a),t.battlesDone&&(s.battlesDone=t.battlesDone),--this.IND,s},t.FromJSON.prototype.restoreBattle=function(e){const t=this.getLevelOrFatal(e.level,"restoreBattle");if(t){++this.IND,this.dbg(`\trestoreBattle found level ID ${e.level}`);const s=new l.Battle(e.name);s.setLevel(t),s.setStats(e.stats),s.finished=e.finished;const a=[];return e.armies.forEach(e=>{a.push(this.restoreArmy(e))}),s.setArmies(a),s.finished&&(r(`${e.name} finished. rm listeners`),k.removeListener(s),a.forEach(e=>{k.removeListener(e)})),--this.IND,s}return o.default.err("Game.FromJSON","restoreBattle",`No level for battle ID's ${e.level}`),null},t.FromJSON.prototype.restoreArmy=function(e){const t=new l.Army(e.name);return e.actors.forEach(e=>{this.id2entity[e]&&t.addActor(this.id2entity[e])}),t.setDefeatThreshold(e.defeatThreshold),t},t.FromJSON.prototype.restorePlace=function(e){const t=new p.WorldFromJSON(this.id2level,this.id2entity).createPlace(e);return this.id2Place=Object.assign(this.id2Place,t.getID2Place()),t},t.FromJSON.prototype.restoreOverWorld=function(e){const t=i.OWMap.fromJSON(e),s=new N.OverWorld.CoordMap;for(const t in e.coordMap)e.coordMap.hasOwnProperty(t)&&(s[t]=e.coordMap[t]);return t.coordMap=s,t},t.FromJSON.prototype.restoreWorldSim=function(e){return D.WorldSimulation.fromJSON(e)},t.FromJSON.prototype.restoreEntityData=function(){Object.keys(this.id2EntityJson).forEach(e=>{const t=this.id2EntityJson[e],s=this.id2entity[e];if(t&&s)this.restoreEntity(t,s);else{let a=t?"":"|JSON is null/undef|";a+=s?"":"|entity is null/undef|",o.default.err("FromJSON","restoreEntityData",`ID: ${e} ${a}`)}})},t.FromJSON.prototype.restoreComponentData=function(){Object.keys(this.compsWithMissingRefs).forEach(e=>{const t=this.compsWithMissingRefs[e],s=this.id2CompJSON[e];this.restoreComponent(s,t)})},t.FromJSON.prototype.restoreComponent=function(e,t){Object.keys(e).forEach(s=>{const a=e[s];if(Array.isArray(a)){if(a.$objRefArray){const e=[];a.forEach(t=>{if(t.$objRef)e.push(this.getObjByRef(t.$objRef));else{const e=JSON.stringify(a);o.default.err("FromJSON","restoreComponent",`$objRefArray found but no $objRefs inside: ${e}`)}}),t[s](e)}}else a.$objRef&&"component"===a.$objRef.type&&t[s](this.getObjByRef(a.$objRef))})},t.FromJSON.prototype.reportMissingLevel=function(e){let t=`connObj: ${JSON.stringify(e)}`;Object.keys(this.id2level).forEach(e=>{t+=`\n\t${e}`}),console.warn(t+"\n")},t.FromJSON.prototype._addRegenEvents=function(e,t){const s=new I.RegenEvent(t,20*o.default.ACTION_DUR);if(e.addEvent(s),t.has("SpellPower")){const s=new I.RegenPPEvent(t,30*o.default.ACTION_DUR);e.addEvent(s)}},t.FromJSON.prototype.dbg=function(e){if(r.enabled){const t=">".repeat(this.IND);r(`${t} ${e}`)}},t.FromJSON.prototype.getLevelsToRestore=function(e){let t=[],s=0;return e.levels?e.levels:e.places?(Object.keys(e.places).forEach(a=>{const n=e.places[a];n.area&&n.area.forEach(e=>{e.tiles.forEach((a,n)=>{a.forEach((a,r)=>{e.tilesLoaded[n][r]&&(s+=a.levels.length,t=t.concat(a.levels))})})})}),this.dbg(`Restoring ${t.length} out of ${s}`),t):t},t.FromJSON.prototype.createTiles=function(e,t){const s=e.getLevels();this.addLevels(s,"createTiles");let a=[];t.forEach(e=>{a=a.concat(e.levels)});const n=[];a.forEach(e=>{const t=this.restoreLevel(e);n.push(t),s.push(t)}),this.connectGameLevels(n),this.restoreEntityData(),this.restoreComponentData();const r=e.getCurrentWorld().getCurrentArea(),o=new O.FactoryWorld;o.setId2Level(this.id2level),o.id2entity=this.id2entity,t.forEach(t=>{const[s,a]=[t.x,t.y],n=new M.AreaTile(s,a,r),i=this.id2level[t.level];n.setLevel(i),e.addLevel(i);const l=JSON.parse(JSON.stringify(t));r.setTile(s,a,n),i.setParent(r),o.createZonesFromTile(r,l,s,a),this.restoreSerializedBattles(e,n)})},t.FromJSON.prototype.restoreSerializedBattles=function(e,t){const s=t.getLevel().getID(),a=e.getGameMaster();if(a.battles[s]){const e=a.battles[s];a.battles[s]=[],e.forEach(e=>{const t=this.restoreBattle(e);a.battles[s].push(t)})}},t.FromJSON.prototype.addLevels=function(e,t="",s=[]){e.forEach((e,a)=>{const n=e.getID();if(this.id2level.hasOwnProperty(n))o.default.log(e),o.default.err("Game.FromJSON",`addLevels - ${t}`,`Duplicate level ID detected ${n}`);else{let r=null;a<s.length&&(r=s[a]),this.addObjRef("level",e,r),this.dbg(`Added level ${n} to this.id2level ${t}`)}})},t.FromJSON.prototype.connectTileLevels=function(e,t){t.forEach(e=>{const t=e.getID(),s=e.getTargetLevel();this.stairsInfo[t]={targetLevel:s,targetStairs:e.getTargetStairs()}}),this.addLevels(e,"connectTileLevels"),this.connectConnections(t)},t.FromJSON.prototype.connectConnections=function(e){e.forEach(e=>{const t=this.stairsInfo[e.getID()],s=this.id2level[t.targetLevel],a=t.targetStairs,{x:n,y:r}=a;if(s){e.setTargetLevel(s);const t=s.getMap().getCell(n,r).getConnection();t?e.connect(t):o.default.err("Game.FromJSON","connectConnections","Target stairs was null. Cannot connect.")}else{const e=t.targetLevel;o.default.err("Game.FromJSON","connectConnections",`Target level ${e} null. Cannot connect.`)}})},t.FromJSON.prototype.restoreChunkManager=function(e,t){t.chunkManager&&e.setEnableChunkUnload(!0)},t.FromJSON.prototype.checkNumOfLevels=function(e,t){const s=e.getLevels().length;if(t.levels&&s!==t.levels.length){const e=t.levels.length;o.default.err("Game.FromJSON","checkNumOfLevels",`Exp. ${e} levels, after restore ${s}`)}},t.FromJSON.prototype.getLevelOrFatal=function(e,t){if(!Number.isInteger(e)){const s=`ID must be number. Got ${e}`;o.default.err("Game.FromJSON",t,s)}if(this.id2level.hasOwnProperty(e))return this.id2level[e];let s=`No level with ID ${e}.`;return s+=` Available: ${Object.keys(this.id2level)}`,o.default.err("Game.FromJSON",t,s),null}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=s(87),n=s(47),r=s(1),o=s(65),i=r.Random.getRNG();t.TerritoryMap=function(){},t.TerritoryMap.create=function(e,t,s){const[r,l]=s,c=e.getFeaturesByType(n.OW.WCAPITAL)[0],h=e.getFeaturesByType(n.OW.WTOWER)[0],u=e.getFeaturesByType(n.OW.BTOWER)[0],d=e.getFeaturesByType(n.OW.BCAPITAL)[0],g=e.getOWMap(),p=new a.Territory(e.getSizeX(),e.getSizeY(),{startSize:2,maxNumPos:2});p.useMap(g,{[n.OW.TERM]:!0,[n.OW.MOUNTAIN]:!0,[n.OW.BVILLAGE]:!0,[n.OW.WVILLAGE]:!0,[n.OW.WCAPITAL]:!0,[n.OW.BCAPITAL]:!0,[n.OW.WTOWER]:!0,[n.OW.BTOWER]:!0});p.addRival({name:"avianfolk",char:"A"}),p.addRival({name:"wildling",char:"I"}),p.addRival({name:"bearfolk",char:"B"}),p.addRival({name:"wolfclan",char:"w"}),p.addRival({name:"catfolk",char:"f"}),p.addRival({name:"dogfolk",char:"d"}),p.addRival({name:"human",char:"@"});const m={name:"undead",char:"z",numPos:3,startX:[e.getCenterX()],startY:[e.getSizeY()-5]};p.addRival(m),p.addRival({name:"goblin",char:"g",numPos:8}),p.addRival({name:"dwarf",char:"h",startX:h[0],startY:h[1]}),p.addRival({name:"hyrkhian",char:"y",startX:c[0],startY:c[1]});const f={name:"winterbeing",char:"W",startX:[u[0],d[0]],startY:[u[1],d[1]]};p.addRival(f);const y=new o.OverWorld.CoordMap;y.xMap=10,y.yMap=10;const _=y.getOWTileBboxFromAreaTileXY(r,l),E=p.getRivalData(t);E.numPos+=1;const S=i.getUniformInt(_.ulx,_.lrx),v=i.getUniformInt(_.uly,_.lry);return E.startX.push(S),E.startY.push(v),p.generate(),p}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(3),o=s(1).Random.getRNG(),i=".",l="#",c=-1;class h{static fromJSON(e){const t=new h(0,0,{});return Object.keys(e).forEach(s=>{t[s]=e[s]}),t}constructor(e,t,s={}){this.map=new Array(e),this.cols=e,this.rows=t,this.rivals=[],this.currRivals=[],this.empty={},this.occupied={},this.occupiedBy={},this.numEmpty=0,this.numCells=e*t,this.terrData={},this.rng=o,this.doPostProcess=!0,this.maxNumPos=1,this.startSize=1,this.maxFillRatio=1,this.dirs=n.default.DIR_NSEW.concat(n.default.DIR_DIAG);["maxNumPos","startSize","dirs","doPostProcess","maxFillRatio","rng"].forEach(e=>{s.hasOwnProperty(e)&&(this[e]=s[e])});for(let s=0;s<e;s++){this.map[s]=new Array(t);for(let e=0;e<t;e++)this._markEmpty(s,e)}}setRNG(e){this.rng=e}getMap(){return this.map}getData(){return this.terrData}getRivalData(e){return this.terrData[e]?this.terrData[e]:null}_markEmpty(e,t){this.map[e][t]=i,this.empty[e+","+t]=[e,t],++this.numEmpty}hasRival(e){return!this.isEmpty(e)&&!this.isFull(e)}getRival(e){const[t,s]=e,a=this.map[t][s];return this.getName(a)}useMap(e,t){this.numEmpty=0;for(let s=0;s<e.length;s++)for(let a=0;a<e[0].length;a++)t[e[s][a]]?this._markEmpty(s,a):(this.map[s][a]=l,delete this.empty[s+","+a])}addRival(e){this._initRival(e)}generate(e=c){this.currRivals=this.rivals.slice(),this.rng.shuffle(this.currRivals);let t=0;for(;this._hasTurnsLeftToProcess(t,e);){const e=this.currRivals.shift(),{name:s}=e,a=this.terrData[s],{open:n,currPos:r,maxNumPos:o}=a;if(r<o){const t=this._getStartPosition(s);this._addStartPosition(s,t),this.currRivals.push(e)}else if(Object.keys(n).length>0){const t=this.getRandOpenXY(s),a=this.getEmptyAdjacentXY(t);a?(this._addOccupied(s,a),this.currRivals.push(e)):(this._closeCell(s,t),Object.keys(n).length>0&&this.currRivals.push(e))}++t}this.doPostProcess&&this.postProcessData()}update(){this.currRivals=this.rivals.slice(),this.rng.shuffle(this.currRivals),this.currRivals.forEach(e=>{const{name:t}=e,s=this.getRandOpenXY(t),a=this.getEmptyAdjacentXY(s);a?this._addOccupied(t,a):this._closeCell(t,s)}),this.currRivals=[]}getName(e){const t=this.rivals.find(t=>t.char===e);return t?t.name:null}getFillRatio(){return(this.numCells-this.numEmpty)/this.numCells}_hasTurnsLeftToProcess(e,t){return this.hasEmpty()&&this.currRivals.length>0&&e!==t&&this.getFillRatio()<this.maxFillRatio}_getStartPosition(e){const t=this.terrData[e],{currPos:s}=t,a=this.getRandEmptyXY();t.startX.length>s?a[0]=t.startX[s]:t.startX.push(a[0]),t.startY.length>s?a[1]=t.startY[s]:t.startY.push(a[1]);const r=u(a);return this.empty.hasOwnProperty(r)||this.map[a[0]][a[1]]!==l&&n.default.warn("Territory","_getStartPosition",`${e} overriding another position @ ${a}`),t.currPos+=1,a}_addOccupied(e,t){const s=u(t);this.occupied[s]=t,this.occupiedBy[e].push(t),this.terrData[e].open[s]=t,this.terrData[e].occupied[s]=t,this.map[t[0]][t[1]]=this.terrData[e].char,this.empty[s]&&(--this.numEmpty,delete this.empty[s])}_addStartPosition(e,t){const s=this.getRivalData(e).startSize-1,a=r.Geometry.getBoxAround(t[0],t[1],s,!0);a.forEach(t=>{this.isEmpty(t)&&this._addOccupied(e,t)}),0===a.length&&n.default.err("Territory","_addStartPosition","No startCoord found!")}getRandEmptyXY(){return this.rng.arrayGetRand(Object.values(this.empty))}isFull(e){const[t,s]=e;return this.map[t][s]===l}isEmpty(e){const t=u(e);return this.empty.hasOwnProperty(t)}getRandOpenXY(e){const{open:t}=this.terrData[e];return this.rng.arrayGetRand(Object.values(t))}getEmptyAdjacentXY(e){const t=this.dirs.slice();for(this.rng.shuffle(t);t.length>0;){const s=t.shift(),[a,r]=n.default.newXYFromDir(s,e);if(this.hasXY(a,r)&&this.map[a][r]===i)return[a,r]}return null}hasXY(e,t){return e>=0&&t>=0&&e<this.map.length&&t<this.map[0].length}_closeCell(e,t){const s=u(t);this.terrData[e].closed[s]=t,delete this.terrData[e].open[s]}hasEmpty(){return this.numEmpty>0}mapToString(){const e=this.map[0].length,t=this.map.length,s=[];for(let a=0;a<e;a++){const e=[];for(let s=0;s<t;s++)e.push(this.map[s][a]);s.push(e)}return s.map(e=>e.join(""))}getAreaProportions(){const e={};return Object.keys(this.occupiedBy).forEach(t=>{e[t]=this.occupiedBy[t].length}),e}_initRival(e){this.rivals.push(e);const{name:t,char:s}=e;this.terrData[t]={currPos:0,maxNumPos:this.maxNumPos,char:s,occupied:{},closed:{},open:{},startX:[],startY:[],startSize:this.startSize},Array.isArray(e.startX)?this.terrData[t].startX=e.startX:e.startX>=0&&(this.terrData[t].startX=[e.startX]),Array.isArray(e.startY)?this.terrData[t].startY=e.startY:e.startY>=0&&(this.terrData[t].startY=[e.startY]),e.numPos?this.terrData[t].maxNumPos=e.numPos:e.maxNumPos&&(this.terrData[t].maxNumPos=e.maxNumPos),e.startSize&&(this.terrData[t].startSize=e.startSize),this.occupiedBy[t]=[]}postProcessData(){const e=this.dirs.length>4;Object.keys(this.terrData).forEach(t=>{const s=this.terrData[t],{startX:a,startY:n,char:o}=s;s.numOccupied=Object.keys(s.occupied).length,s.areas={},a.forEach((t,a)=>{const i=[t,n[a]],l=r.Geometry.floodfill2D(this.map,i,o,{},e);s.areas[u(i)]=l})})}toJSON(){return{terrData:this.terrData,map:this.map,cols:this.cols,rows:this.rows,currRivals:this.currRivals,empty:this.empty,occupied:this.occupied,occupiedBy:this.occupiedBy,numEmpty:this.numEmpty,dirs:this.dirs}}}function u(e){return e[0]+","+e[1]}t.Territory=h},function(e,t,s){"use strict";var a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const n=s(155),r=s(156),o=a(s(13));class i{constructor(e){this.dayMan=new r.DayManager(e),this.seasonMan=new n.SeasonManager(e)}setLevel(e){this.currLevel=e}setOwPos(e){this.seasonMan.setOwPos(e)}update(){if(this.dayMan.update(),this.dayMan.phaseChanged()&&this.seasonMan.changeWeather(),this.dayMan.dayChanged()&&(this.seasonMan.update(),this.seasonMan.monthChanged()&&this.seasonMan.seasonChanged()&&this.seasonMan.yearChanged()),this.changed("weather")){const e=this.seasonMan.getWeather();if(this.currLevel){this.currLevel.removeAll("Weather");const t=new o.Weather;t.setWeatherType(e),this.currLevel.add(t)}}}getSeason(){return this.seasonMan.getSeason()}getWeather(){return this.seasonMan.getWeather()}setUpdateRates(e){this.dayMan.setUpdateRate(e)}changed(e){switch(e){case"day":return this.dayMan.dayChanged();case"month":return this.seasonMan.monthChanged();case"season":return this.seasonMan.seasonChanged();case"year":return this.seasonMan.yearChanged();case"weather":return this.seasonMan.weatherChanged();default:throw new Error("No change for "+e)}return!1}setPool(e){this.dayMan.setPool(e),this.seasonMan.setPool(e)}setOverWorld(e){this.seasonMan.setBiomeMap(e.getBiomeMap())}toJSON(){return{dayManager:this.dayMan.toJSON(),seasonManager:this.seasonMan.toJSON()}}}t.WorldSimulation=i,i.fromJSON=function(e){const t=new i;return t.dayMan=r.DayManager.fromJSON(e.dayManager),t.seasonMan=n.SeasonManager.fromJSON(e.seasonManager),t}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(4),o=s(3),i=s(7),l=s(162),c=i.EventPool.getPool();t.SystemAnimation=class extends r.SystemBase{constructor(e,t){super(n.default.SYS.ANIMATION,e,t),this._enabled=!0,this.currAnim=null}enableAnimations(){this._enabled=!0}disableAnimations(){this._enabled=!1}missileAnimation(e,t){const s=t.missile,a=t.to[0],r=t.to[1],o=s.first();let i=o[0],l=o[1];const c=t.item,h=n.default.getChar(n.default.TYPE_ITEM,c.getName()),u=n.default.getCssClass(n.default.TYPE_ITEM,c.getName()),d=this._createAnimation(t);for(;i!==a||l!==r;){const e={},t=i+","+l;if(e[t]={},e[t].char=h,e[t].className=u,d.addFrame(e),!s.next())break;i=s.getX(),l=s.getY()}this._setCurrAnim(d)}lineAnimation(e,t){let s=t.from[0],a=t.from[1];const r=t.dir[0],o=t.dir[1];let i=t.range,l=n.default.dirToChar(t.dir);t.lineChar&&(l={args:t});const c=this._createAnimation(t),h={};if(t.ray)for(;i>0;){h[(s+=r)+","+(a+=o)]={char:l||"*",className:t.className||"cell-ray"};let e={};e=Object.assign(e,h),c.addFrame(e),--i}this._setCurrAnim(c)}cellAnimation(e,t){const s=this._createAnimation(t),a={};s.slowDown=10,t.coord.forEach(e=>{a[e[0]+","+e[1]]={char:t.cellChar||"*",className:t.className||"cell-animation"}}),s.addFrame(a),this._setCurrAnim(s)}areaAnimation(e,t){const s=this._createAnimation(t),a=t.range,[n,r]=[t.cX,t.cY];for(let e=1;e<=a;e++){const a={};o.Geometry.getBoxAround(n,r,e).forEach(e=>{a[e[0]+","+e[1]]={char:t.cellChar||"*",className:t.className||"cell-animation"}}),s.addFrame(a)}this._setCurrAnim(s)}_createAnimation(e){const t=new l.Animation;return t.setLevel(e.level),t}updateEntity(e){this._enabled&&e.getList("Animation").forEach(t=>{const s=t.getArgs();s.dir?this.lineAnimation(e,s):s.missile?this.missileAnimation(e,s):s.cell?this.cellAnimation(e,s):n.default.isNullOrUndef([s.range,s.cX,s.cY])||this.areaAnimation(e,s)}),e.removeAll("Animation"),this.hasEntities()||(c.emitEvent(n.default.EVT_ANIMATION,{animation:this.currAnim}),this.currAnim=null)}_setCurrAnim(e){this.currAnim?this.currAnim.combine(e):this.currAnim=e}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(4),i=n(s(2)),l=s(3);t.SystemAreaEffects=class extends o.SystemBase{constructor(e,t){super(r.default.SYS.AREA_EFFECTS,e,t),this.radRange=1}updateEntity(e){const t=e.getList("Flame");let s=!1,a=!1;e.has("Health")?t.forEach(t=>{const n=t.getDamageType(),o=new i.Damage(t.getDamage(),n),l=t.getSource();if(o.setSource(l),l.has("Created")){const e=l.get("Created").getCreator();o.setSourceActor(e)}e.add(o),e.remove(t),n===r.default.DMG.FIRE?s=!0:n===r.default.DMG.ICE&&(a=!0)}):e.removeAll("Flame"),s?this._createRadiationComps(e,"Heat","Fire"):a&&this._createRadiationComps(e,"Coldness","Ice flame")}_createRadiationComps(e,t,s){const a=e.getLevel().getMap(),n=e.getCell(),[r,o]=n.getXY();l.Geometry.getBoxAround(r,o,this.radRange).forEach(e=>{if(a.hasXY(e[0],e[1])){const n=a.getCell(e[0],e[1]);n.hasActors()&&n.getActors().forEach(e=>{e.getName()!==s&&e.add(new i[t])})}})}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(4),i=n(s(2)),l=s(10);t.SystemAttack=class extends o.SystemBase{constructor(e,t){super(r.default.SYS.ATTACK,e,t)}updateEntity(e){e.getList("Attack").forEach(t=>{this.processAttackComp(e,t),e.remove(t)})}processAttackComp(e,t){const s=e,a=t.getTarget(),n=s.getName(),o=a.getName();if(a.has("Ethereal"))r.default.gameMsg({cell:s.getCell(),msg:"Attack of "+n+" passes through "+o});else{if(a.has("FirstStrike")){const e=`${o} seems to strike first.`;r.default.gameMsg({cell:a.getCell(),msg:e}),this.performAttack(a,s,o,n)}if(this.performAttack(s,a,n,o),a.has("CounterAttack")){const e=`${o} seems to counter attack.`;r.default.gameMsg({cell:a.getCell(),msg:e}),this.performAttack(a,s,o,n)}if(s.has("BiDirStrike")){const e=this.getBiDirTarget(s,a);if(e){const t=`${n} tries to hit double strike.`;r.default.gameMsg({msg:t,cell:s.getCell()});const a=e.getName();if(this.performAttack(s,e,n,a),e.has("CounterAttack")){const t=`${a} seems to counter attack.`;r.default.gameMsg({cell:e.getCell(),msg:t}),this.performAttack(e,s,a,n)}}}s.getBrain().getMemory().setLastAttacked(a)}}addAttackerBonus(e){return l.Brain.getEnemyCellsAround(e).length}addDefenderBonus(e){return l.Brain.getEnemyCellsAround(e).length}performAttack(e,t,s,a){if(t.has("Charm")&&this.attIsCharmed(e,t)){let s=`${e.getName()} is charmed by ${t.getName()} `;return s+=", and does not attack",void r.default.gameMsg({cell:e.getCell(),msg:s})}let n=r.default.getMeleeAttack(e);e.has("Attacker")&&(n+=this.addAttackerBonus(e));const l=this.getEntityDefense(t),c=n/(n+l),h=this.rng.getUniform();if(this.dbg(`hitChance is ${c}, threshold ${h}`),c>=h){const n=e.getDamage();n>0?(this.doDamage(e,t,n),t.has("Experience")&&o.SystemBase.addSkillsExp(e,"Melee",1)):r.default.gameMsg({cell:e.getCell,msg:s+" fails to hurt "+a}),this._applyAddOnHitComp(e,t)}else this.checkForShieldSkill(h,n,l,t),r.default.gameMsg({cell:e.getCell(),msg:s+" misses "+a});if(t.addEnemy(e),e.isPlayer()||t.isPlayer()){const s=new i.Event;s.setArgs({type:r.default.EVT_ACTOR_ATTACKED,cause:e}),t.add(s)}}getEntityDefense(e){if(e.has("Paralysis"))return 0;let t=0;return e.getDefense&&(t=e.getDefense(),e.has("Defender")&&(t+=this.addDefenderBonus(e))),t}doDamage(e,t,s){const a=new i.Damage(s,r.default.DMG.MELEE);a.setSource(e),t.add(a),r.default.gameWarn({cell:e.getCell(),msg:e.getName()+" hits "+t.getName()})}getBiDirTarget(e,t){const[s,a]=[e.getX(),e.getY()],[n,r]=[t.getX(),t.getY()],o=s+-1*(n-s),i=a+-1*(r-a),l=e.getLevel().getMap();if(l.hasXY(o,i)){const t=l.getCell(o,i);if(t.hasActors()){const s=t.getActors();for(let t=0;t<s.length;t++)if(e.isEnemy(s[t]))return s[t]}}return null}checkForShieldSkill(e,t,s,a){a.has("Skills")&&t/(t+(s-a.getShieldDefense()))>e&&o.SystemBase.addSkillsExp(a,"Shields",1)}attIsCharmed(e,t){const s=t.getList("Charm");let a=!1;return s.forEach(t=>{const s=t.getTargetActor(),n=t.getLevel(),o=e.getWillpower();let i=n/(n+o);s!==r.default.NO_TARGET&&s===e.getID()&&(i=n/(n+o)*2)>.8&&(i=.8),r.default.isSuccess(i)&&(a=!0)}),a}_applyAddOnHitComp(e,t){const s=e.getWeapon();if(s&&s.has){if(s.has("AddOnHit")){const a=s.get("AddOnHit");if(a.getOnAttackHit()){const s=a.getComp();o.SystemBase.addCompToEntAfterHit(s,t,e)}}}else if(s&&s.onAttackHit){const a=e;s.onAttackHit(t,a)}else{const s=e;if(s&&s.has("AddOnHit")){const e=s.get("AddOnHit");if(e.getOnAttackHit()){const a=e.getComp();o.SystemBase.addCompToEntAfterHit(a,t,s)}}}}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=n(s(22)),i=s(4),l=s(7),c=s(66),h=s(40),u=n(s(2)),d=s(10),g=l.EventPool.getPool(),p=["Pickup","UseStairs","OpenDoor","UseItem","UseElement","Jump","Read","Rest","Give"];t.SystemBaseAction=class extends i.SystemBase{constructor(e,t){super(r.default.SYS.BASE_ACTION,e,t),this.compTypesAny=!0,this._dtable={Give:this._handleGive.bind(this),Jump:this._handleJump.bind(this),OpenDoor:this._handleOpenDoor.bind(this),Pickup:this._handlePickup.bind(this),Read:this._handleRead.bind(this),UseElement:this._handleUseElement.bind(this),UseItem:this._handleUseItem.bind(this),UseStairs:this._handleUseStairs.bind(this),Rest:this._handleRest.bind(this)}}updateEntity(e){p.forEach(t=>{e.has(t)&&(this._dtable[t](e),e.remove(t))})}_handleGive(e){const t=e.get("Give"),s=t.getGiveTarget(),a=t.getItem();if(s.isEnemy(e)){let t=`${s.getName()} refuses to take `;t+=`${a.getName()} from ${e.getName()}`,r.default.gameMsg({cell:e.getCell(),msg:t})}else if(e.getInvEq().removeItem(a)){const t=e.getInvEq().getRemovedItem();if(s.getInvEq().addItem(t),t.has("QuestTarget")&&s.has("QuestTarget")){const a={actor:s,item:t},n=t.get("QuestTarget");h.SystemQuest.addQuestEvent(e,n,"give",a)}let n=`${e.getName()} gives `;n+=`${a.getName()} to ${s.getName()}`,r.default.gameMsg({cell:e.getCell(),msg:n})}}_handlePickup(e){const[t,s]=[e.getX(),e.getY()],a=e.getLevel(),n=a.getMap().getCell(t,s);if(n.hasProp(r.default.TYPE_ITEM)){const o=n.getProp(r.default.TYPE_ITEM)[0];if(e.getInvEq().canCarryItem(o)){e.getInvEq().addItem(o);try{a.removeItem(o,t,s)}catch(t){let s=`Unable to remove item ${JSON.stringify(o)}\n`;s+=`Actor for pickup: ${e.getName()}`,r.default.err("System.BaseAction","handlePickup",s)}let i=o.getName();o.getCount()>1&&(i+=" x"+o.getCount());const l={msg:e.getName()+" picked up "+i,cell:n};if(r.default.gameMsg(l),this._checkForAutoEquip(e,o),o.has("QuestTarget")){const t=o.get("QuestTarget");h.SystemQuest.addQuestEvent(e,t,"get")}}else{const t={msg:e.getName()+" cannot carry more weight",cell:n};r.default.gameMsg(t)}}const o={type:r.default.EVT_ITEM_PICKED_UP};this._createEventComp(e,o)}_checkForAutoEquip(e,t){const s=e.getInvEq().getMissile();if(s&&s.equals(t)&&e.getInvEq().equipNItems(t,t.getCount())){const s=t.getNameWithCount();r.default.gameMsg({cell:e.getCell(),msg:`${e.getName()} equips ${s}`})}}_handleUseStairs(e){const t=e.getLevel(),s=e.getCell(),a=d.Brain.getActorsAround(e);if(t.useStairs(e)){e.isPlayer()&&e.getBrain().addMark();const n=e.getLevel();if(n.has("QuestTarget")){const t=new u.QuestTargetEvent;t.setEventType("goto"),t.setTargetComp(n.get("QuestTarget")),e.add(t)}if(g.emitEvent(r.default.EVT_LEVEL_CHANGED,{target:n,src:t,actor:e}),g.emitEvent(r.default.EVT_LEVEL_ENTERED,{actor:e,target:n}),a.length>0){const s=d.Brain.getBoxOfFreeCellsAround(e,1);for(;a.length>0&&s.length>0;){const o=a.pop(),i=s.pop();if(t.removeActor(o)){const[t,s]=[i.getX(),i.getY()];n.addActor(o,t,s);const a=o.getName();r.default.gameMsg(`${a} follows ${e.getName()}`)}else{const e=JSON.stringify(o);r.default.warn("System.BaseAction","_handleUseStairs","Could not remove the actor: "+e)}}}const o={type:r.default.EVT_ACTOR_USED_STAIRS,cell:s};this._createEventComp(e,o)}}_handleOpenDoor(e){const t=e.get("OpenDoor").getDoor(),[s,a]=t.getXY(),n=e.getLevel().getCell(s,a);let o="";const i=e.getName();t.has("Broken")?o="Door is broken and does not move at all!":t.canToggle()?n.hasItems()?o="Door is blocked by an item":n.hasActors()?o="Door is blocked by someone":t.isOpen()?(t.closeDoor(),o=`${i} closes a door.`):(t.openDoor(),o=`${i} opens a door.`):o=`${i} cannot toggle the door.`,""!==o&&r.default.gameMsg({cell:n,msg:o})}_handleUseItem(e){const t=e.get("UseItem"),s=t.getItem();if(s.has("Broken")){const t=`${s.getName()} cannot be used because it is broken`;return void r.default.gameMsg({cell:e.getCell(),msg:t})}if(s.has("OneShot"))if(1===s.getCount()){const e={item:s};g.emitEvent(r.default.EVT_DESTROY_ITEM,e)}else s.decrCount(1);else s.getCharges&&s.getCharges()>0&&s.setCharges(s.getCharges()-1);this._checkUseItemMsgEmit(e,t);const a=t.getEffect();if(a){const t=new u.Effects(a);e.add(t)}}_handleUseElement(e){const t=e.get("UseElement"),s=t.getElement();s.has("Broken")||s.onUse&&s.onUse(e),this._checkUseElementMsgEmit(e,t)}_handleJump(e){const t=e.get("Jump"),[s,a]=[t.getX(),t.getY()];let n=2;e.has("Jumper")&&(n=e.get("Jumper").getJumpRange());const o=e.getLevel().getMap(),[i,l]=e.getXY(),c=i+s*n,h=l+a*n;if(r.default.Path.getShortestActorPath(o,i,l,c,h,(e,t)=>{const s=o.getCell(e,t);if(s.hasActors()){const e=s.getActors();for(let t=0;t<e.length;t++)if(!e[t].has("Ethereal"))return!1}return r.default.Element.canJumpOver(s.getBaseElem().getType())}).length===n){const t=new u.Movement(c,h,e.getLevel());e.add(t)}}_handleRead(e){let t=e.get("Read").getReadTarget();if(!t){const s=e.getCell();if(s.hasItems()){const e=s.getItems().find(e=>"book"===e.getType());e&&(t=e)}}if(t){const s=t.getText(),a=new o.MenuInfoOnly;a.addPre(s);const n=t.getName();r.default.gameInfo(`The book "${n}" reads:`),e.getBrain().setSelectionObject&&e.getBrain().setSelectionObject(a)}else{const t=`${e.getName()} finds nothing interesting to read.`;r.default.gameMsg({cell:e.getCell(),msg:t})}if(t.has("QuestTarget")){const s=new u.QuestTargetEvent;s.setEventType("read"),s.setTargetComp(t.get("QuestTarget")),e.add(s)}}_handleRest(e){const t=e.getCell();if("bed"===t.getBaseElem().getType())if(0===d.Brain.getSeenHostiles(e).length){e.get("Health").addHP(1);const s=`${e.getName()} rests for a while in bed`;r.default.gameMsg({cell:t,msg:s})}else{const s=`${e.getName()} cannot rest with enemies around`;r.default.gameMsg({cell:t,msg:s})}}_createEventComp(e,t){const s=new u.Event;s.setArgs(t),e.add(s)}_checkUseItemMsgEmit(e,t){if(t.getUseType()===r.default.USE.DRINK){const e=t.getItem(),s=function(e,t){return e.target?c.SystemEffects.getTargetFromObj(e,t):e.getCell?e:null}(t.getTarget(),t.getTargetType()),a=s.getCell(),n=s.getName()+" drinks "+e.getName();r.default.gameMsg({cell:a,msg:n})}}_checkUseElementMsgEmit(e,t){const s=t.getElement(),a=s.getName(),n=e.getCell();let o="";s.has("Broken")?o=`${a} is broken, and cannot be used.`:t.getUseType()===r.default.USE.LEVER&&(o=`${e.getName()} toggles the lever`),o&&r.default.gameMsg({cell:n,msg:o})}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(4),i=s(40),l=n(s(2));t.SystemBattle=class extends o.SystemBase{constructor(e,t){super(r.default.SYS.BATTLE,e,t),this.compTypesAny=!0}updateEntity(e){if(e.has("BattleOver")){const t=e.get("BattleOver");if(e.has("BattleExp")){const t=e.get("BattleExp").getData(),s=t.name,a=this._getBadgeForBattle(s,e);if(t.kill>0)if(o.SystemBase.addSkillsExp(e,"Battle",t.kill),a)a.updateData({kill:t.kill});else{const e="No badge found for battle";r.default.err("System.Battle","updateEntity",e)}if(a.isWon()){let t=null;e.has("Reputation")?t=e.get("Reputation"):(t=new l.Reputation,e.add(t)),t.addToFame(1)}e.remove("BattleExp");const n=e.getLevel();if(e.has("Quest")&&n.has("QuestTarget")){const t=e.get("QuestTarget"),s={isWon:a.isWon()};i.SystemQuest.addQuestEvent(e,t,"battle",s)}}e.remove(t)}else if(e.has("BattleOrder")){const t=e.get("BattleOrder");this._emitMsg(e,t),e.remove(t)}}_getBadgeForBattle(e,t){return t.getList("BattleBadge").find(t=>t.getData().name===e)}_emitMsg(e,t){const s=t.getArgs().srcActor.getName(),a=e.getCell(),n=`${s} shouts a command into your direction.`;r.default.gameMsg({msg:n,cell:a})}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(4),o=s(67),i=s(40),l=Object.freeze([]);function c(e){return{quests:"Is anyone looking for help here?",places:"Do you know what places are nearby?",shops:"Is there a place for trading?",people:"What can you tell me about people here?",world:"Do you have any rumors from faraway lands?"}[e]}t.SystemChat=class extends r.SystemBase{constructor(e,t){super(n.default.SYS.CHAT,e,t)}updateEntity(e){const t=e.get("Chat").getArgs().dir,s=this.getActorsInDirection(e,t);let a=null;if(s.forEach(t=>{if(t.has("Trainer"))a=this.getChatObject(e,t,"Trainer");else if(t.has("QuestGiver"))a=this.getChatObject(e,t,"QuestGiver");else{a=this.getGenericChatObject(e,t);const s=`You chat with ${t.getName()} for a while.`;n.default.gameMsg({cell:e.getCell(),msg:s})}t.has("QuestTarget")&&this.addQuestTargetItems(e,t,a),this.addQuestSpecificItems(e,t,a),e.getLevel().has("Lore")&&(console.log("Level has some lore"),this.addLoreItems(e,t,a))}),a){const t=e.getBrain(),s=a.getSelectionObject();t.setSelectionObject(s)}e.remove("Chat")}getActorsInDirection(e,t){const[s,a]=[t[0],t[1]],r=e.getX()+s,o=e.getY()+a,i=e.getLevel().getMap();if(i.hasXY(r,o)){const e=i.getCell(r,o);if(e.hasActors())return e.getActors();{const t="There is no one to talk to.";n.default.gameMsg({cell:e,msg:t})}}else{const t="There is no one to talk to.";n.default.gameMsg({cell:e.getCell(),msg:t})}return l}getChatObject(e,t,s){const a=t.get(s).getChatObj();if(a.setTarget(e),a.getSelectionObject())return a;{const e=t.getName();n.default.err("SystemChat","setChatObject",`Null/undef selectObj with type ${s}, src: ${e}`)}return null}getGenericChatObject(e,t){const s=new o.Chat.ChatBase,a=t.getName();return s.pre=`${a} greets you. What do you say?`,s}addQuestTargetItems(e,t,s){const a=t.get("QuestTarget");if("escort"===a.getTargetType()){const n=t.get("QuestEscortTarget");n.getEscortTo().getID()!==e.getLevel().getID()?s.add({name:n.getQuestion(),option:()=>{}}):s.add({name:"I have escorted you safely to correct place now",option:()=>{const s={src:t};i.SystemQuest.addQuestEvent(e,a,"escort",s)}})}}addQuestSpecificItems(e,t,s){if(e.has("Quest")){if(e.get("Quest").getQuestTargets().forEach(e=>{this.addQuestTargetToChat(e,t,s)}),t.has("QuestInfo")){const a=t.get("QuestInfo"),n=t.get("QuestTarget");s.add({name:a.getQuestion(),option:()=>{const s={info:a,src:t};i.SystemQuest.addQuestEvent(e,n,"listen",s)}})}if(e.has("QuestInfo")&&t.has("QuestTarget")){const a=t.get("QuestTarget"),n=e.getList("QuestInfo"),r=t=>{i.SystemQuest.addQuestEvent(e,a,"report",{info:t})};n.forEach(e=>{s.add({name:"Tell about "+e.getInfo(),option:r.bind(null,e)})})}t.has("QuestReport")&&s.add({name:"Tell about quest being completed",option:()=>{i.SystemQuest.addQuestEvent(e,t.get("QuestTarget"),"report")}})}}addQuestTargetToChat(e,t,s){const a=t.getName(),r=e.name;let o=null;const i=e.id,l=t.getBrain().getMemory();if(l.hasSeen(i)){o=s.getSelectionObject();const{x:e,y:c}=l.getLastSeen(i),h=n.default.getTextualDxDy(t,[e,c]);let u=`${a} says: I know where ${r} is.`;u+=` I saw ${r} ${h} from here.`,n.default.gameInfo(u)}""!==r&&(o||(o=(()=>{const e=`${a} says: I know not where ${r} is`;n.default.gameInfo(e)})),s.add({name:`Do you know where is ${r}`,option:o}))}addLoreItems(e,t,s){const a=t.getLevel().get("Lore").getTopics();Object.keys(a).forEach(t=>{s.add({name:c(t),option:()=>{const s=this.rng.arrayGetRand(a[t]);n.default.gameInfo({cell:e.getCell(),msg:s})}})})}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(4);t.SystemCommunication=class extends r.SystemBase{constructor(e,t){super("Communication",e,t),this._msgFunc={Enemies:this.processEnemies.bind(this),Shout:this.processShout.bind(this)}}updateEntity(e){const t=e.get("Communication").getMsg();for(let s=0;s<t.length;s++)this.processMessage(e,t[s]);e.remove("Communication")}processMessage(e,t){this._msgFunc.hasOwnProperty(t.type)?this._msgFunc[t.type](e,t):n.default.err("CommunicationSystem","processMessage","No function for msg type |"+t.type+"| in dtable.")}processEnemies(e,t){const s=t.enemies,a=t.src.getName();for(let t=0;t<s.length;t++)e.addEnemy(s[t]);const r={cell:e.getCell(),msg:`${a} seems to communicate with ${e.getName()}`};n.default.gameInfo(r)}processShout(e,t){const s=t.shout,a=t.src.getName(),r={cell:t.src.getCell(),msg:`${a} shouts ${s}`};n.default.gameInfo(r)}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(4),i=s(7),l=n(s(2)),c=n(s(19)),h=i.EventPool.getPool(),u=r.default.NO_DAMAGE_SRC;t.SystemDamage=class extends o.SystemBase{constructor(e,t){super(r.default.SYS.DAMAGE,e,t)}processDamageComp(e,t){const s=e.get("Health");if(s){let a=this._getDamageModified(e,t);if(a<=0){a=0;const t="Attack doesn't penetrate protection of "+e.getName();r.default.gameMsg({msg:t,cell:e.getCell()})}else if(this._applyAddOnHitComp(e,t),s.decrHP(a),this.debugEnabled){const t=s.getMaxHP(),n=`(${a}),(${s.getHP()}/${t})`;r.default.gameDanger({msg:n,cell:e.getCell()})}const n=this._getUltimateDmgSource(t);if(n&&e.getID()!==n.getID()&&r.default.isActor(n)&&e.addEnemy(n),s.isDead()&&!e.has("Dead")){if(e.has("Loot")){const t=e.getCell();e.get("Loot").dropLoot(t)}this._dropInvAndEq(e),this._killActor(n,e,t)}if(n&&(n.isPlayer()||e.isPlayer())&&!r.default.isNullOrUndef([n,e])){const t=new l.Event;t.setArgs({type:r.default.EVT_ACTOR_DAMAGED,cause:n}),e.add(t),e.has("QuestTarget")&&this.checkForDamagedQuestEvent(e,n)}}}checkForDamagedQuestEvent(e,t){if("damage"===e.get("QuestTarget").getTargetType()){const s=new l.QuestTargetEvent;s.setEventType("damage"),s.setArgs({target:e}),s.setTargetComp(e.get("QuestTarget")),t.add(s)}}_getUltimateDmgSource(e){let t=e.getSourceActor();return t||(t=e.getSource()),t&&t.has&&t.has("Created")?t=t.get("Created").getCreator():t&&!t.has&&(console.log("Warning. No damageSrc.has():",t),r.default.err("System.Damage","_getUltimateDmgSource","No damageSrc.has()")),t}_getDamageModified(e,t){const s=t.getDamageType();let a=t.getSourceActor();a||(a=t.getSource());const n=this._getDmgAfterWeaknessAndResistance(e,t),o=e.getCell();if(s===r.default.DMG.POISON){const t="Poison is gnawing inside "+e.getName();return r.default.gameDanger({cell:o,msg:t}),n}if(s===r.default.DMG.HUNGER)return n;if(s===r.default.DMG.FIRE){const t=`Fire is burning ${e.getName()}.`;return r.default.gameDanger({cell:o,msg:t}),n}if(s===r.default.DMG.ICE){const t=`Ice is freezing ${e.getName()}.`;return r.default.gameDanger({cell:o,msg:t}),n}if(s===r.default.DMG.COLD){const t=`${e.getName()} is extremely hypothermic`;return r.default.gameInfo({cell:o,msg:t}),n}if(this.isProtectionBypassed(e,a)){const t=`${a.getName()} hits ${e.getName()} through armor.`;return r.default.gameDanger({cell:o,msg:t}),n}return t.getDamageCateg()===r.default.DMG.MAGIC?n:n-(e.getEquipProtection()+e.get("Combat").getProtection())}_getDmgAfterWeaknessAndResistance(e,t){const s=e.getName();let a=t.getDamage();if(e.has("Weakness")&&e.getList("Weakness").forEach(s=>{if(this.effectMatches(t,s))switch(s.getLevel()){case r.default.WEAKNESS.MINOR:a=Math.round(1.25*a);break;case r.default.WEAKNESS.MEDIUM:a=Math.round(1.5*a);break;case r.default.WEAKNESS.SEVERE:a*=2;break;case r.default.WEAKNESS.FATAL:a=e.get("Health").getMaxHP()}}),e.has("Resistance")){let n="";e.getList("Resistance").forEach(s=>{if(this.effectMatches(t,s))switch(s.getLevel()){case r.default.RESISTANCE.MINOR:a=Math.round(a/1.25),n+=" resists the attack slighty";break;case r.default.RESISTANCE.MEDIUM:a=Math.round(a/1.5),n+=" resists the attack";break;case r.default.RESISTANCE.STRONG:a=Math.round(a/2),n+=" resists the attack strongly";break;case r.default.RESISTANCE.IMMUNITY:a=0,n+=" is immune against the attack";break;case r.default.RESISTANCE.ABSORB:e.get("Health").addHP(a),n+=" absorbs the power of the attack"}}),""!==n&&(n=s+" "+n,r.default.gameMsg({msg:n,cell:e.getCell()}))}return a}effectMatches(e,t){const s=t.getEffect(),a=e.getDamageType(),n=e.getDamageCateg();return s===a||s===n}isProtectionBypassed(e,t){const s=this.rng.getUniform();return t&&!t.has&&(console.log("src is not entity:",t),console.log("With entity:",e),r.default.err("System.Damage","isProtectionBypassed","No src.has()")),t&&t.has("BypassProtection")?s<=t.get("BypassProtection").getChance():s<=r.default.PROT_BYPASS_CHANCE}_applyAddOnHitComp(e,t){const s=t.getWeapon();if(s&&s.has){if(s.has("AddOnHit")){const a=s.get("AddOnHit").getComp();o.SystemBase.addCompToEntAfterHit(a,e,t.getSource())}}else if(s&&s.onHit){const a=t.getSource();s.onHit&&s.onHit(e,a)}else{const s=t.getSource();if(s&&s.has("AddOnHit")){const t=s.get("AddOnHit").getComp();o.SystemBase.addCompToEntAfterHit(t,e,s)}}}_dropInvAndEq(e){const[t,s]=e.getXY();if(!e.getInvEq)return;const a=e.getInvEq(),n=a.getInventory().getItems(),r=e.getLevel();n.forEach(e=>{if(a.removeNItems(e,e.getCount())){const e=a.getRemovedItem();r.addItem(e,t,s)}}),a.getEquipment().getItems().forEach(e=>{r.addItem(e,t,s)})}_killActor(e,t,s){const a=t.getLevel(),n=t.getCell(),[o,i]=t.getXY();if(t.add(new l.Dead),a.removeActor(t)){const d=t.getName();t.has("Experience")&&this._giveExpToSource(e,t),"poison"===s.getDamageType()&&r.default.gameDanger({cell:n,msg:d+" dies horribly of poisoning!"});let g="killed";t.has("NonSentient")&&(g="destroyed");let p=d+" was "+g;e!==u&&(p+=" by "+e.getName()),r.default.gameDanger({cell:n,msg:p}),h.emitEvent(r.default.EVT_ACTOR_KILLED,{actor:t});const m=new l.Event;if(m.setArgs({type:r.default.EVT_ACTOR_KILLED,cause:e}),t.add(m),t.has("Corporeal")){const s=new c.Corpse(d+" corpse");s.setActorName(t.get("Named").getBaseName()),this._cloneComponentsToCorpse(t,s);const n=r.default.getCssClass(r.default.TYPE_ACTOR,d);if(r.default.addCellStyle(r.default.TYPE_ITEM,s.getName(),n),a.addItem(s,o,i),t.has("QuestTarget")){const a=new l.QuestTargetEvent;a.setEventType("kill"),a.setArgs({corpse:s}),a.setTargetComp(t.get("QuestTarget")),e.add(a)}}this._cleanUpComponents(t)}else r.default.err("System.Damage","killActor","Couldn't remove actor")}_giveExpToSource(e,t){if(e!==u&&!e.has("Dead")){const s=t.get("Experience").getExpLevel(),a=t.get("Experience").getDanger(),n=new l.ExpPoints(s+a);e.add(n),e.has("InBattle")&&this._giveBattleExpToSource(e)}}_giveBattleExpToSource(e){if(!e.has("BattleExp")){const t=e.get("InBattle").getData();if(t){const s=t.name,a=new l.BattleExp;a.setData({kill:0,name:s}),e.add(a)}else{const t=`Actor: ${JSON.stringify(e)}`;r.default.err("System.Damage","_giveBattleExpToSource",`InBattle data is null. Actor: ${t}`)}}e.get("BattleExp").getData().kill+=1}_cleanUpComponents(e){["Coldness","Expiration","Fading"].forEach(t=>{e.getList(t).forEach(t=>{"function"==typeof t.cleanup&&t.cleanup(),e.remove(t)})})}_cloneComponentsToCorpse(e,t){["Named","Health","Stats","Combat","Experience"].forEach(s=>{const a=e.get(s).clone();t.add(a)});const s=["Undead"];e.hasAny(s)&&s.forEach(s=>{if(e.has(s)){const a=e.get(s).clone();t.add(a)}})}updateEntity(e){e.getList("Damage").forEach(t=>{this.processDamageComp(e,t),e.remove(t)})}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(4),i=n(s(2)),l={Entrapped:{Attack:"cannot attack while trapped",Movement:"cannot move while trapped",SpellCast:"cannot cast spells while trapped"},Paralysis:{Attack:"cannot attack under paralysis",Movement:"cannot move under paralysis",SpellCast:"cannot cast spells under paralysis"},Stun:{Attack:"is too stunned to attack",Movement:"is stunned, and stumbles",SpellCast:"is too stunned to cast spells"}};t.SystemDisability=class extends o.SystemBase{constructor(e,t){super(r.default.SYS.DISABILITY,e,t),this.compTypesAny=!0,this._dispatchTable={Entrapped:{Attack:e=>{e.remove("Attack"),this._emitMsg("Paralysis","Attack",e)},Movement:e=>{this._handleEntrapped(e)},SpellCast:e=>{e.remove("SpellCast"),this._emitMsg("Entrapped","SpellCast",e)},UseStairs:e=>{e.remove("UseStairs"),this._emitMsg("Entrapped","UseStairs",e)}},Fear:{Attack:e=>{this._handleFear(e,"Attack")},Movement:e=>{this._handleFear(e,"Movement")}},Paralysis:{Attack:e=>{e.remove("Attack"),this._emitMsg("Paralysis","Attack",e)},Movement:e=>{e.remove("Movement"),this._emitMsg("Paralysis","Movement",e)},SpellCast:e=>{e.remove("SpellCast"),this._emitMsg("Paralysis","SpellCast",e)},UseStairs:e=>{e.remove("UseStairs"),this._emitMsg("Paralysis","Movement",e)}},Stun:{Attack:e=>{e.remove("Attack"),this._emitMsg("Stun","Attack",e)},Movement:e=>{const t=this.rng.getRandDir(),[s,a]=r.default.newXYFromDir(t,e);if(e.remove("Movement"),e.getLevel().getMap().hasXY(s,a)){const t=new i.Movement(s,a,e.getLevel());e.add(t)}this._emitMsg("Stun","Movement",e)},SpellCast:e=>{e.remove("SpellCast"),this._emitMsg("Stun","SpellCast",e)},UseStairs:e=>{r.default.isSuccess(.5)&&(e.remove("UseStairs"),this._emitMsg("Stun","Movement",e))}}},this._compOrder=["Paralysis","Entrapped","Stun"],this._actComp=["Attack","Movement","SpellCast"]}updateEntity(e){this._compOrder.forEach(t=>{e.has(t)&&this._actComp.forEach(s=>{e.has(s)&&this._dispatchTable[t][s](e)})})}_emitMsg(e,t,s){const a=s.getCell(),n=`${s.getName()} ${l[e][t]}`;r.default.gameMsg({cell:a,msg:n})}_handleEntrapped(e){const t=e.getCell(),s=t.getElements();if(!s)return void e.removeAll("Entrapped");const a=s.filter(e=>e.has("Entrapping"));let n=0;a.forEach(e=>{n+=e.get("Entrapping").getDifficulty()});const o=e.getStrength(),i=e.getAgility(),l=(o+i)/(o+i+n);if(r.default.isSuccess(l)){const s=e.getLevel();a.forEach(e=>{e.get("Entrapping").getDestroyOnMove()&&s.removeElement(e,e.getX(),e.getY())}),e.removeAll("Entrapped");const n=`${e.getName()} breaks free from traps!`;r.default.gameMsg({cell:t,msg:n})}else{e.remove("Movement");const s=`${e.getName()} is trapped and cannot move!`;r.default.gameMsg({cell:t,msg:s})}}_handleFear(e,t){const s=e.getList("Fear"),a=e.getBrain().getSeenEnemies();let n=0,o=null;if(s.forEach(e=>{const t=e.getTarget(),s=e.getFearLevel(),r=a.find(e=>e.getID()===t);r&&n<s&&(n=s,o=r)}),o){const s=e.getWillpower(),a=n/(s+n);if(r.default.isSuccess(a)){e.remove(t);const s=r.default.dXdY(o.getXY(),e.getXY()),[a,n]=r.default.newXYFromDir(s,e.getXY());if(e.getLevel().getMap().isPassable()){const t=new i.Movement(a,n,e.getLevel());e.add(t);const s=`${e.getName} panics, and runs away from ${o.getName()}`;r.default.gameMsg({cell:e.getCell(),msg:s})}else{const t=`${e.getName} is paralysed by fear!`;r.default.gameMsg({cell:e.getCell(),msg:t})}}}}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(4);t.SystemEquip=class extends r.SystemBase{constructor(e,t){super(n.default.SYS.EQUIP,e,t)}updateEntity(e){const t=e.get("Equip");t.getIsRemove()?this.unequipItem(e,t.getArgs()):this.equipItem(e,t.getArgs()),e.remove(t)}unequipItem(e,t){const s=t.slot,a=t.slotNumber,n=e.getInvEq();let r=!1,o=`Failed to remove item from slot ${s}.`;"missile"===s?null!==n.getEquipment().getItem("missile")&&n.unequipItem(s,t.count)&&(r=!0):n.unequipItem(s,1,a)&&(r=!0),t.hasOwnProperty("callback")&&(r&&(o=`Unequipping from ${s} succeeded!`),t.callback({msg:o,result:r}));const i=n.getEquipment().getUnequipped(s,a);r&&i.has("AddOnEquip")&&i.getList("AddOnEquip").forEach(t=>{this.handleAddOnEquip(e,t,!1)})}equipItem(e,t){const s=e.getInvEq(),a=t.item;let n=!1,r=`Failed to equip ${a.getName()}`;a.getType().match(/^(missile|ammo)$/)?s.equipNItems(a,t.count)&&(n=!0):s.equipItem(a)&&(n=!0),t.hasOwnProperty("callback")&&(n&&(r=`Equipping ${a.getName()} succeeded!`),t.callback({msg:r,result:n})),n&&a.has("AddOnEquip")&&a.getList("AddOnEquip").forEach(t=>{this.handleAddOnEquip(e,t)})}handleAddOnEquip(e,t,s=!0){if(s){const s=t.getComp();e.add(s),t.setAddedToActor(!0)}else{const s=t.getComp();if("number"==typeof s){const a=e.get(s);e.remove(s),t.setComp(a),t.setAddedToActor(!1)}else n.default.err("System.Equip","handleAddOnEquip","Expected comp ID number. Got: "+s)}}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(4),o=s(3);t.SystemEvents=class extends r.SystemBase{constructor(e,t){super(n.default.SYS.EVENTS,e,t),this.eventRadiusPerID={},this.eventRadius=10,this._dtable={[n.default.EVT_ACTOR_KILLED]:this._handleActorKilled.bind(this),[n.default.EVT_ITEM_PICKED_UP]:this._handleItemPickedUp.bind(this),[n.default.EVT_ACTOR_DAMAGED]:this._handleActorDamaged.bind(this),[n.default.EVT_ACTOR_ATTACKED]:this._handleActorAttacked.bind(this),[n.default.EVT_ACTOR_USED_STAIRS]:this._handleActorUsedStairs.bind(this)}}updateEntity(e){e.getList("Event").forEach(t=>{const s=t.getArgs(),{type:a}=s;let n=e.getCell();s.cell&&(n=s.cell);const r=this._getEventRadius(e),[i,l]=[n.getX(),n.getY()],c=o.Geometry.getBoxAround(i,l,r,!0);e.getLevel().getMap().getCellsWithCoord(c).forEach(s=>{const n=s.getActors();n&&n.forEach(s=>{!s.isPlayer()&&s.has("Perception")&&s.getBrain().getSeenCells().find(e=>e.getX()===i&&e.getY()===l)&&this._dtable[a](e,t,s)})}),e.remove(t)})}addLevel(e,t){this.eventRadiusPerID[e.getID()]=t}removeLevel(e){delete this.eventRadiusPerID[e.getID()]}_getEventRadius(e){const t=e.getLevel().getID();return this.eventRadiusPerID.hasOwnProperty(t)?this.eventRadiusPerID[t]:this.eventRadius}_handleActorKilled(e,t,s){if(e.isPlayer()){const a=t.getArgs().cause;if(a){const t=s.getName(),r=e.getName(),o=`${t} saw ${a.getName()} killing ${r}`;n.default.gameMsg({cell:e.getCell,msg:o})}}}_handleItemPickedUp(e,t,s){if(s.getID()!==e.getID()&&!s.isEnemy(e)){const t=e.getCell(),a=`${s.getName()} saw ${e.getName()} picking up an item.`;n.default.gameMsg({msg:a,cell:t})}}_handleActorDamaged(e,t,s){if(e.getID()!==s.getID()){const a=t.getArgs(),{cause:n}=a;this._addActorAsEnemy(n,e,s)}}_handleActorAttacked(e,t,s){if(e.getID()!==s.getID()){const a=t.getArgs(),{cause:n}=a;this._addActorAsEnemy(n,e,s)}}_handleActorUsedStairs(e,t,s){n.default.gameMsg(`${s.getName()} saw ${e.getName()} using stairs.`)}_addActorAsEnemy(e,t,s){e.getID()!==t.getID()&&(t.getType()===s.getType()?s.isEnemy(t)||t.isEnemy(s)||(s.isFriend(e)?(this._emitMsg("seems to dislike action",e,t,s),s.getBrain().getMemory().removeFriend(e)):(this._emitMsg("shows hatred against action",e,t,s),s.addEnemy(e))):s.isFriend(t)&&(this._emitMsg("shows hatred against action",e,t,s),s.addEnemy(e)))}_emitMsg(e,t,s,a){const r=t.getName(),o=s.getCell();let i=`${a.getName()} ${e} of ${r} `;i+=` towards ${s.getName()}`,n.default.gameMsg({cell:o,msg:i})}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(4),o=s(58);t.SystemExpPoints=class extends r.SystemBase{constructor(e,t){super(n.default.SYS.EXP_POINTS,e,t)}updateEntity(e){e.getList("ExpPoints").forEach(t=>{const s=e.get("Experience");let a=!0,r=s.getExp();for(r+=t.getExpPoints(),s.setExp(r);a;){const t=s.getExpLevel()+1;if(r>=n.default.getExpRequired(t)){n.default.levelUpActor(e,t);const s=e.getName();if(e.isPlayer()&&e.has("ActorClass")){const s=e.get("ActorClass").getClass(),a=o.ActorClass.getLevelUpObject(t,s);e.getBrain().setSelectionObject(a)}else{const t=`${s} is more experienced now.`;n.default.gameSuccess({msg:t,cell:e.getCell()})}a=!0}else a=!1}e.remove(t)})}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(4),i=n(s(2));t.SystemHunger=class extends o.SystemBase{constructor(e,t){super(r.default.SYS.HUNGER,e,t)}updateEntity(e){const t=e.get("Hunger"),s=e.get("Action");if(t.decrEnergy(s.getEnergy()),s.resetEnergy(),t.isStarving()&&e.has("Health")&&r.default.isSuccess(r.default.HUNGER_PROB)){const t=new i.Damage(r.default.HUNGER_DMG,r.default.DMG.HUNGER);e.add(t),r.default.gameWarn(e.getName()+" is starving!")}}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(4),i=n(s(2));t.SystemMissile=class extends o.SystemBase{constructor(e,t){super(r.default.SYS.MISSILE,e,t),this.criticalShot=r.default.MISSILE_CRITICAL_SHOT}updateEntity(e){const t=e.get("Missile"),s=t.getSource(),a=t.getLevel().getMap(),n=t.getTargetX(),i=t.getTargetY();let l=null;a.hasXY(n,i)&&(l=a.getCell(n,i));const c=this._formatFiredMsg(e,s);if(l&&l.hasProp("actors")){const e=l.getSentientActors()[0];s.getBrain().getMemory().setLastAttacked(e)}for(;t.isFlying()&&!t.inTarget()&&t.hasRange();){t.next();const n=t.getX(),i=t.getY();let l=null;a.hasXY(n,i)&&(l=a.getCell(n,i));let h="";if(l)if(l.hasActors()||l.isPassableByAir())if(l.hasProp("actors")){const a=l.getActors()[0];if(this.targetWasHit(e,a,t)){this.finishMissileFlight(e,t,l),"function"==typeof t.onHit&&t.onHit(a);const n=this._addDamageToActor(a,t);r.default.debug(this,"Hit an actor"),h=`${c} ${n} ${a.getName()}`,a.has("Experience")&&("missile"===e.getType()?o.SystemBase.addSkillsExp(s,"Throwing",1):"ammo"===e.getType()&&o.SystemBase.addSkillsExp(s,"Archery",1)),r.default.gameWarn({cell:l,msg:h}),h=""}else if(t.inTarget()){this.finishMissileFlight(e,t,l),r.default.debug(this,"In target cell, and missed an entity");const s=l.getFirstActor();h=s?c+" misses "+s.getName():c+" misses the target"}else t.hasRange()||(this.finishMissileFlight(e,t,l),r.default.debug(this,"Missile out of range. Missed entity."),h=e.getName()+" does not reach the target")}else t.inTarget()?(this.finishMissileFlight(e,t,l),r.default.debug(this,"In target cell but no hits"),h=e.getName()+" doesn't hit anything"):t.hasRange()||(this.finishMissileFlight(e,t,l),r.default.debug(this,"Missile out of range. Hit nothing."),h=e.getName()+" doesn't hit anything");else{t.prev();const s=t.getX(),n=t.getY(),o=a.getCell(s,n);this.finishMissileFlight(e,t,o),r.default.debug(this,"Stopped missile to wall"),h=c+" thuds to an obstacle"}else{t.prev();const s=t.getX(),n=t.getY(),r=a.getCell(s,n);this.finishMissileFlight(e,t,r),h=c+" disappears"}h.length>0&&r.default.gameMsg({cell:l,msg:h})}}_addDamageToActor(e,t){let s="hits";const a=t.getDamage(),n=new i.Damage(a,r.default.DMG.MISSILE),o=t.getSource();n.setSource(o);let l=t.getDamage();return o.has("CriticalShot")&&r.default.isSuccess(this.criticalShot)&&(l*=2,s="critically hits"),n.setDamage(l),e.add(n),s}finishMissileFlight(e,t,s){t.stopMissile(),e.remove(t);const a=t.getLevel();let n=!0;if(t.destroyItem||(n=!1,e.has("Indestructible")||(t.destroyItem=this._isItemDestroyed(e))),t.destroyItem){if(!n){const t=`${e.getName()} is destroyed!`;r.default.gameMsg({cell:s,msg:t})}}else{let t=!1;s.hasItems()&&s.getItems().forEach(s=>{t||(t=r.default.addStackedItems(s,e))}),t||a.addItem(e,s.getX(),s.getY())}const o={missile:t,item:e,to:[s.getX(),s.getY()],level:a},l=new i.Animation(o);e.add(l)}_isItemDestroyed(e){const t=e.getName(),s=this.rng.getUniform();return e.has("Ammo")?/(magic|ruby|permaice)/i.test(t)?s>.95:/(iron|steel)/i.test(t)?s>.9:s>.85:/rock/i.test(t)?s>.95:/(magic|ruby|permaice)/i.test(t)?s>.97:s>.95}_formatFiredMsg(e,t){let s="thrown";return e.has("Ammo")&&(s="shot"),`${e.getName()} ${s} by ${t.getName()}`}targetWasHit(e,t,s){if(t.has("Ethereal"))return!1;const a=s.getSource();if(a.has("ThroughShot")&&!s.inTarget())return!1;const n="missile"===e.getType();let i=s.getAttack();a.has("Skills")&&(i+=n?a.get("Skills").getLevel("Throwing"):a.get("Skills").getLevel("Archery"));let l=t.getDefense();t.has("Skills")&&(l+=t.get("Skills").getLevel("Dodge"));const c=i/(i+l);return r.default.isSuccess(c)?!t.has("RangedEvasion")||r.default.isSuccess(.5):(o.SystemBase.addSkillsExp(t,"Dodge",1),!1)}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(4),i=n(s(2)),l=s(9),c=s(8)("bitn:System.Movement"),{addSkillsExp:h}=o.SystemBase,u={"light snow":l.ELEM.SNOW_LIGHT_TRACKS,snow:l.ELEM.SNOW_TRACKS,"deep snow":l.ELEM.SNOW_DEEP_TRACKS},d={"deep snow":"snow","deep snow with tracks":"snow","light snow":"snow","light snow with tracks":"snow","snow with tracks":"snow"};t.SystemMovement=class extends o.SystemBase{constructor(e,t){super(r.default.SYS.MOVEMENT,e,t),this.somethingSpecial=["QuestTarget","Named"],this.climbRe=/highrock/,this._bonuses={water:{dontApplyTo:["Flying","Amphibious"],mods:[this.speedPenalty(.5),this.defensePenalty(.5),{value:-5,srcComp:"Combat",srcFunc:"getAttack",targetComp:"CombatMods",targetFunc:"setAttack"}]},grass:{mods:[this.speedPenalty(.1)]},bridge:{mods:[this.defensePenalty(.5)]},stone:{mods:[this.speedPenalty(.25)]},snow:{dontApplyTo:["Flying","SnowWalk"],mods:[this.speedPenalty(.25)]}}}speedPenalty(e){return{value:-e,srcComp:"Stats",srcFunc:"getSpeed",targetComp:"StatsMods",targetFunc:"setSpeed"}}defensePenalty(e){return{value:-e,srcComp:"Combat",srcFunc:"getDefense",targetComp:"CombatMods",targetFunc:"setDefense"}}checkMessageEmits(e,t){if(t.hasProp(r.default.TYPE_ELEM)){if(t.hasStairs()){const e=t.getStairs().getTargetLevel();let s="You see stairs here";e.getParent()&&(s+=`. They seem to be leading to ${r.default.formatLocationName(e)}`),r.default.gameMsg(s)}else if(t.hasPassage()){const e=t.getPassage().getTargetLevel();let s=`You see a passage to ${r.default.getCardinalDirection(e,t)} here.`;e.getParent()&&(s+=`. It seems to be leading to ${r.default.formatLocationName(e)}`),r.default.gameMsg(s)}else if(t.hasConnection()){const e=t.getConnection().getTargetLevel();let s="You see an entrance here";e.getParent()&&(s+=`. It seems to be leading to ${r.default.formatLocationName(e)}`),r.default.gameMsg(s)}t.hasPropType("lever")&&r.default.gameMsg("There is a lever on the floor"),!e.hasShop()&&t.hasShop()?t.getShop().isAbandoned()?r.default.gameMsg("This shop seems to be abandoned"):r.default.gameMsg("You have entered a shop."):t.hasShop()&&(t.getShop().isAbandoned()||r.default.gameMsg("You can drop items to sell them here."))}if(t.hasItems()){const e=t.getItems(),s=e[0];let a=s.getName();s.getCount()>1&&(a=`${a} (x${s.getCount()})`),e.length>1?r.default.gameMsg("There are several items here. "+`You see ${a} on top`):r.default.gameMsg(`You see ${a}`+" on the floor"),s.has("Unpaid")&&(s.getCount()>1?r.default.gameMsg("They are for sale"):r.default.gameMsg("It is for sale"));for(let t=0;t<e.length;t++)if(e[t].hasAny(this.somethingSpecial)){const s=e[t].getName();r.default.gameMsg(`There is something special about ${s}`)}}const s=t.getBaseElem();s.hasMsg("onEnter")&&r.default.gameMsg(s.getMsg("onEnter"))}updateEntity(e){const t=e.get("Movement"),[s,a]=t.getXY(),n=t.getLevel().getMap();if(!n.hasXY(s,a)){let t=`Tried to move to ${s},${a}.`;t+=" Entity: "+e.getName(),r.default.warn("System.Movement","updateEntity",t)}const o=n.getCell(s,a),i=e.getCell();let l=o.isFree(e.has("Flying"));if(l||(l=this._checkSpecialMovement(e,o)),l){const t=e.getXY();c.enabled&&r.default.debug(this,`Trying to move ent from ${t}`);const l=e.getPropType();if(n.moveProp(t,[s,a],l,e)){e.setXY(s,a),this.checkForStatsMods(e,i,o),e.isPlayer&&e.isPlayer()&&this.checkMessageEmits(i,o),o.hasElements()&&(e.isPlayer&&e.isPlayer()&&o.hasPropType("exploration")&&this._processExploreElem(e,o),this._checkEntrapment(e,o));const t=o.getBaseElem();if(t.has("Snowy")){const e=t.getType();u[e]&&o.setBaseElem(u[e])}}else this._moveError(e)}else r.default.debug(this,"Cell wasn't free at "+s+", "+a);e.remove(t)}checkForStatsMods(e,t,s){let[a,n]=[t.getBaseElem().getType(),s.getBaseElem().getType()];if(d[a]&&(a=d[a]),d[n]&&(n=d[n]),a!==n){if(this._bonuses.hasOwnProperty(n)){const t=this._bonuses[n];let s=!0;t.dontApplyTo&&t.dontApplyTo.forEach(t=>{e.has(t)&&(s=!1)}),s&&t.mods.forEach(t=>{if(Number.isInteger(t.value)){const s=i.create(t.targetComp);s[t.targetFunc](t.value),s.setTag(n),e.add(s)}else{const s=e.get(t.srcComp);if(s){let a=s[t.srcFunc]();a=Math.round(t.value*a);const r=i.create(t.targetComp);r[t.targetFunc](a),r.setTag(n),e.add(r)}}})}if(this._bonuses.hasOwnProperty(a)){const t=e.getList("StatsMods"),s=e.getList("CombatMods");t.forEach(t=>{t.getTag()===a&&e.remove(t)}),s.forEach(t=>{t.getTag()===a&&e.remove(t)})}}}_checkSpecialMovement(e,t){const s=t.getBaseElem().getType();if(this.climbRe.test(s)&&e.has("Climber")){const s=`${e.getName()} climbs the rocky terrain`;return r.default.gameMsg({cell:t,msg:s}),!0}return!1}_processExploreElem(e,t){const s=e.getLevel(),[a,n]=[t.getX(),t.getY()],o=t.getPropType("exploration")[0];if(s.removeElement(o,a,n)){const a=o.getExp(),n=new i.ExpPoints(a);if(e.add(n),h(e,"Exploration",1),o.hasData()){const t=o.getData();t.zoneType&&e.get("GameInfo").addZoneType(t.zoneType)}const l=s.getParent();l&&e.get("GameInfo").addZone(l.getID());let c=o.getMsg("onEnter");c&&0!==c.length||(c=`${e.getName()} has explored zone thoroughly.`),r.default.gameInfo({cell:t,msg:c}),e.isPlayer()&&e.getBrain().addMark()}}_checkEntrapment(e,t){const s=t.getElements();s&&s.forEach(s=>{if(s.has("Entrapping")&&!e.has("Entrapped")){const a=s.get("Entrapping").getDifficulty(),n=e.getStrength(),o=e.getAgility(),l=(n+o)/(n+o+a);if(r.default.isSuccess(l)){let a=`${e.getName()} avoids getting trapped`;a+=` by ${s.getName()}!`,r.default.gameMsg({cell:t,msg:a})}else{e.add(new i.Entrapped);let a=`${e.getName()} becomes trapped`;a+=` by ${s.getName()}!`,r.default.gameMsg({cell:t,msg:a})}}})}_moveError(e){const[t,s]=e.getXY(),a=e.getLevel(),n=a.getMap(),o=t+", "+s;r.default.diag("\n\nSystem.Movement list of actors:"),r.default.printObjList(a.getActors(),["getID","getName","getX","getY"]),this._diagnoseRemovePropError(t,s,n,e),r.default.err("MovementSystem","moveActorTo","Couldn't remove ent |"+e.getName()+"| @ "+o)}_diagnoseRemovePropError(e,t,s,a){const n=a.getPropType();let o=-1,i=-1;for(let e=0;e<s.cols;e++)for(let t=0;t<s.rows;t++)s.removeProp(e,t,n,a)&&(o=e,i=t);const l=s.getCell(e,t);r.default.diag(`Cell at ${e},${t}:`),r.default.diag(l);const c=a.getCell();r.default.diag("Cell of the entity:"),r.default.diag(c),r.default.diag("System.Movement: diagnoseRemovePropError:");const h=a.getName();if(o>=0&&i>=0){const s=`\tEnt |${h}| found from |${`${o},${i} instead of ${e},${t}.`}|`;r.default.diag(s)}else{const e=`\tNo ent |${h}| found on entire map.`;r.default.diag(e)}r.default.diag("map.Find list of objects: ");const u=s.findObj(e=>e.getName&&e.getName().match(/keeper/));r.default.diag(u)}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(4),i=n(s(19)),l=n(s(2)),{addSkillsExp:c}=o.SystemBase;t.SystemShop=class extends o.SystemBase{constructor(e,t){super(r.default.SYS.SHOP,e,t)}updateEntity(e){const t=e.get("Transaction"),s=t.getArgs(),{buyer:a}=s;this._checkTransArgsOK(e,s),a.getID()===e.getID()?this.buyItem(s):this.sellItem(s),e.remove(t)}_checkTransArgsOK(e,t){const{item:s,buyer:a,shop:n,seller:o}=t;let i="";s||(i+="Item is null/undef. "),a||(i+="Buyer is null/undef. "),o||(i+="Seller is null/undef. "),n||(i+="Shop (element) is null/undef. "),""!==i&&(i+="Entity: "+e.getName(),r.default.err("System.Shop","_checkTransArgsOK",i))}buyItem(e){const{item:t,buyer:s,shop:a,seller:n}=e,o=s.getCell(),l=t.getValue()*a.getCostFactorSell(),h=r.default.valueToGoldWeight(l),u=r.default.getGoldInCoins(h);if(r.default.hasEnoughGold(s,h)){const e=new i.GoldCoin(r.default.GOLD_COIN_NAME),l=r.default.removeNCoins(s,u);if(e.setCount(l),!s.getInvEq().canCarryItem(t))return s.getInvEq().addItem(e),void r.default.gameMsg(s.getName()+" cannot carry more weight");n.getInvEq().addItem(e),n.getLevel().removeItem(t,a.getX(),a.getY())?(s.getInvEq().addItem(t),t.remove("Unpaid"),r.default.gameMsg({cell:o,msg:s.getName()+" bought "+t.getName()+" for "+u+" coins."}),c(n,"Trading",1)):r.default.err("System.Shop","buyItem","Could not remove item from level")}else r.default.gameMsg({cell:o,msg:s.getName()+" doesn't have enough money to buy "+t.getName()+" for "+u+" coins."})}sellItem(e){const{item:t,buyer:s,seller:a,shop:n}=e;if(a||r.default.err("System.Shop","sellItem","Seller is null or undefined."),!this.willingToBuyItem(t,s)){t.getName();const n=`${s.getName()} is not interested in ${t.getName()}.`;return r.default.gameMsg({cell:a.getCell(),msg:n}),void(e.callback&&e.callback({msg:n,result:!1}))}const o=e.count||1,h=a.getCell(),u=o*t.getValue()*n.getCostFactorBuy(),d=r.default.valueToGoldWeight(u),g=r.default.getGoldInCoins(d);if(r.default.hasEnoughGold(s,d)){if(a.getInvEq().dropNItems(t,o)){const n=new i.GoldCoin(r.default.GOLD_COIN_NAME),o=r.default.removeNCoins(s,g);n.setCount(o),a.getInvEq().addItem(n);const u=a.getCell().getItems(),d=u[u.length-1];d.add(new l.Unpaid);const p=d.getName();if(r.default.gameMsg({cell:h,msg:a.getName()+" sold "+p+" for "+g+" coins."}),e.callback){const s=`${t.getName()} was sold.`;e.callback({msg:s,result:!0})}c(a,"Trading",1)}}else{const a=s.getName();if(r.default.gameMsg({cell:s.getCell(),msg:"Buyer "+a+" doesn't have enough gold to buy it."}),e.callback){const s=`Cannot sell ${t.getName()}.`;e.callback({msg:s,result:!1})}}}willingToBuyItem(e,t){return e.getName()!==r.default.GOLD_COIN_NAME}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(4),i=n(s(2));t.SystemSkills=class extends o.SystemBase{constructor(e,t){super(r.default.SYS.SKILLS,e,t)}updateEntity(e){const t=e.getList("SkillsExp"),s=e.get("Skills"),a=e.getCell();t.forEach(t=>{const n=t.getSkill();s.hasSkill(n)||(s.addSkill(n),r.default.gameSuccess({cell:a,msg:`${e.getName()} learns a skill ${n}`}));const o=t.getPoints();s.addPoints(n,o);const l=s.getPoints(n),c=s.getLevel(n);if(l>=10*c){const t=e.getName();s.setLevel(n,c+1),s.resetPoints(n),r.default.gameSuccess({cell:a,msg:`${t} advances a skill ${n}`});const o=new i.ExpPoints(10*c);e.add(o),r.default.gameSuccess({cell:a,msg:`${t} gains experience from skill ${n}`})}e.remove(t)})}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(4),o=s(15),{addSkillsExp:i}=r.SystemBase;t.SystemSpellCast=class extends r.SystemBase{constructor(e,t){super(n.default.SYS.SPELL_CAST,e,t),this.compTypesAny=!0}updateEntity(e){const t=e.getName(),s=e.getCell();if(e.has("SpellPower")&&e.has("SpellCast")){const a=e.get("SpellCast"),r=e.get("SpellPower"),o=a.getSpell();if(o.getCastingPower()<=r.getPP()){const t=Object.values(this.entities).filter(e=>e.has("PowerDrain")),l=a.getArgs();if(r.decrPP(o.getCastingPower()),0===t.length)o.cast(l),i(e,"SpellCasting",1);else if(this._checkPowerDrain(o,l,t)){let e=`Spell ${o.getName()} was canceled by power drain of`;e+=` ${this._drainerName}`,n.default.gameMsg({cell:s,msg:e})}else o.cast(l),i(e,"SpellCasting",1)}else{const e=`${t} has no enough power to cast spell`;n.default.gameMsg({cell:s,msg:e})}e.remove("SpellCast")}}_checkPowerDrain(e,t,s){let a=!1;const n=t.src.getX(),r=t.src.getY();return this._drainerName="",s.forEach(s=>{if(s.getLevel().getID()===t.src.getLevel().getID()){const i=s.getX(),l=s.getY(),c=o.Path.shortestDist(n,r,i,l);if(s.getID()!==t.src.getID()&&c<=s.get("PowerDrain").drainDist){if(s.remove("PowerDrain"),a=!0,this._drainerName=s.getName(),s.has("SpellPower")){const t=e.getCastingPower();s.get("SpellPower").addPP(t)}return}}}),a}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(4),i=n(s(2)),l=s(6),c=s(3),{addSkillsExp:h}=o.SystemBase,u=["SpellRay","SpellCell","SpellMissile","SpellArea","SpellSelf"];function d(e,t,s){let a=r.default.getDmgClassName(t.damageType);a||(a=r.default.getDmgClassName(r.default.DMG.MAGIC));const n={cell:!0,coord:[s],className:a,level:e.getLevel()},o=new i.Animation(n);e.add(o)}t.SystemSpellEffect=class extends o.SystemBase{constructor(e,t){super(r.default.SYS.SPELL_EFFECT,e,t),this.compTypesAny=!0,this._dtable={SpellRay:this.processSpellRay.bind(this),SpellCell:this.processSpellCell.bind(this),SpellMissile:this.processSpellMissile.bind(this),SpellArea:this.processSpellArea.bind(this),SpellSelf:this.processSpellSelf.bind(this)}}updateEntity(e){u.forEach(t=>{e.has(t)&&e.getList(t).forEach(s=>{this._dtable[t](e,s),e.remove(s)})})}processSpellRay(e,t){const s=t.getArgs(),a=e.getLevel().getMap(),n=s.spell,o=n.getName();let[l,c]=s.from;const[h,u]=s.dir;let d=n.getRange(),g=0;for(;d>0;)if(l+=h,c+=u,a.hasXY(l,c)){const e=a.getCell(l,c);if(n.onCellCallback&&n.onCellCallback(e),e.hasActors()){const t=e.getActors()[0],a=t.getName(),i=t.has("SpellStop");i||this.rayHitsActor(t,d)?(this._addDamageToActor(t,s),i?(d=0,r.default.gameMsg({cell:e,msg:`${o} is stopped by ${a}`})):n.stopOnHit&&(d=0),r.default.gameMsg({cell:e,msg:`${o} hits ${a}`})):r.default.gameMsg({cell:e,msg:`${o} misses ${a}`})}e.isSpellPassable()?++g:d=0,--d}else d=0;const p={dir:s.dir,ray:!0,from:s.from,range:g,className:r.default.getDmgClassName(s.damageType),level:e.getLevel()},m=new i.Animation(p);e.add(m)}rayHitsActor(e,t){if(!e.has("Health"))return!1;let s=e.get("Stats").getAgility();e.has("Skills")&&(s+=e.get("Skills").getLevel("Dodge")),(s-=t)<0&&(s=0);const a=(100-s)/100;return r.default.isSuccess(a)?!e.has("RangedEvasion")||r.default.isSuccess(.5):(h(e,"Dodge",1),!1)}processSpellCell(e,t){const s=t.getArgs(),a=e.getLevel().getMap(),n=s.spell.getName(),o=s.dir[0],l=s.dir[1],c=s.from[0]+o,h=s.from[1]+l;if(a.hasXY(c,h)){const t=a.getCell(c,h);if(s.preCallback&&s.preCallback(t),s.callback)s.callback(t);else if(t.hasActors()){const e=t.getActors()[0];if(s.targetComp){const a=s.set,o=s.get;if(e.has(s.targetComp)){const i=e.get(s.targetComp),l=e.getName();o?i[a](i[o()]+s.value):i[a](s.value),r.default.gameMsg({cell:t,msg:`Spell ${n} is cast on ${l}`})}}else if(s.addComp){const t=s.addComp.comp;if(t)if(s.addComp.duration){const a=s.addComp.duration;if(e.has("Expiration"))e.get("Expiration").addEffect(t,a);else{const s=new i.Expiration;s.addEffect(t,a),e.add(s)}e.add(t)}else e.add(t);else{const e=JSON.stringify(s);r.default.err("SystemSpellEffect","processSpellCell",`args.addComp.comp must be defined. Args: ${e}`)}const a=t.getType(),n=`${e.getName()} seems to have ${a}`;r.default.gameMsg({cell:e.getCell(),msg:n})}else s.removeComp?s.removeComp.forEach(t=>{e.has(t)&&e.removeAll(t)}):(this._addDamageToActor(e,s),r.default.gameMsg({cell:t,msg:`${n} hits ${e.getName()}`}))}s.postCallback&&s.postCallback(t),d(e,s,[c,h])}}processSpellMissile(e,t){const s=t.getArgs(),a=s.spell,n=l.ObjectShell.getParser(),o=a.getAmmoName();o||r.default.err("System.SpellEffect","processSpellMissile",`No |ammoName| set for spell ${a.getName()}`);const c=n.createItem(o),h=new i.Missile(s.src);h.setTargetXY(s.to[0],s.to[1]),h.destroyItem=!0,s.hasOwnProperty("destroyItem")&&(h.destroyItem=s.destroyItem),h.setDamage(s.damage),h.setAttack(100),h.setRange(a.getRange()),s.onHit&&!t.onHit?h.onHit=s.onHit:t.onHit&&!s.onHit?h.onHit=t.onHit:t.onHit&&s.onHit&&r.default.err("SystemSpellEffect","processSpellMissile","onHit given in both SpellMissile and its args"),c.add(h)}processSpellArea(e,t){const s=t.getArgs(),a=s.spell,n=a.getRange(),[o,l]=[s.src.getX(),s.src.getY()],h=s.src.getLevel().getMap();c.Geometry.getBoxAround(o,l,n).forEach(e=>{if(h.hasXY(e[0],e[1])){const t=h.getCell(e[0],e[1]);if(t.hasActors()){const e=t.getActors();for(let n=0;n<e.length;n++){this._addDamageToActor(e[n],s),a.onCellCallback&&a.onCellCallback(t);const o=e[n].getName();r.default.gameMsg({cell:e[n].getCell(),msg:`${o} is hit by ${a.getName()}`})}}}});const u={range:n,cX:o,cY:l,className:r.default.getDmgClassName(s.damageType),level:e.getLevel()},d=new i.Animation(u);e.add(d)}processSpellSelf(e,t){const s=t.getArgs();if("function"==typeof s.callback)s.callback();else{let e="args.callback must be a function. ";e+="Got args: "+JSON.stringify(s),r.default.err("SystemSpellEffect","processSpellSelf",e)}d(e,s,e.getXY())}_addDamageToActor(e,t){const s=new i.Damage;s.setSource(t.src),s.setDamageType(t.damageType),s.setDamage(t.damage),s.setDamageCateg(r.default.DMG.MAGIC),s.setWeapon(t.spell),e.add(s)}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(4),i=n(s(2));t.SystemSpiritBind=class extends o.SystemBase{constructor(e,t){super(r.default.SYS.SPIRIT,e,t),this.compTypesAny=!0}updateEntity(e){e.has("SpiritBind")&&this._doSpiritBind(e)}_doSpiritBind(e){const t=e.get("SpiritBind"),s=t.getBinder(),a=s.getName(),n=t.getTarget();if(e.hasSpirit()){if(n.hasItems())if(s.has("SpiritItemCrafter")){const t=n.getItems()[0],o=t.getName();if(t.has("GemBound")){const e=`${o} has already a gem bound to it.`;r.default.gameMsg({cell:n,msg:e})}else{const l=new i.GemBound,c=s.getInvEq().removeAndGetItem(e);l.setGem(c),t.add(l);const h=`${e.getName()} was bound to ${o} by ${a}`;r.default.gameMsg({cell:n,msg:h})}}else{const e=`${a} cannot bind gems to items.`;r.default.gameMsg({cell:n,msg:e})}}else{const t=n.getPropType("spirit");if(t.length>0){const s=t[0];s.get("Action").disable(),s.getLevel().removeActor(s),e.setSpirit(s);const o=`${s.getName()} was bound to gem by ${a}`;r.default.gameMsg({cell:n,msg:o})}else{const e="There are no spirits to capture there!";r.default.gameMsg({cell:n,msg:e})}}e.remove("SpiritBind")}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(4),i=s(7),l=n(s(2)),c=i.EventPool.getPool();t.SystemTimeEffects=class extends o.SystemBase{constructor(e,t){super(r.default.SYS.TIME_EFFECTS,e,t),this.compTypesAny=!0,this._dtable={},this._expiredEffects=[],this._dtable.Poison=this._applyPoison.bind(this),this._dtable.Fading=this._applyFading.bind(this),this._dtable.Heat=this._applyHeat.bind(this),this._dtable.Coldness=this._applyColdness.bind(this),this._dtable.DirectDamage=this._applyDirectDamage.bind(this),this._dtable.RegenEffect=this._applyRegenEffect.bind(this)}update(){for(const e in this.entities){if(!e)continue;const t=this.entities[e];for(let e=0;e<this.compTypes.length;e++)"Expiration"!==this.compTypes[e]&&t.has(this.compTypes[e])&&this._dtable[this.compTypes[e]](t);t.has("Expiration")&&this._decreaseDuration(t)}for(let e=0;e<this._expiredEffects.length;e++){const t=this._expiredEffects[e][0];this._expiredEffects[e][1].remove(t)}this._expiredEffects=[]}_decreaseDuration(e){e.getList("Expiration").forEach(t=>{t.decrDuration(),t.hasEffects()||this._expiredEffects.push([t.getID(),e])})}_applyPoison(e){e.getList("Poison").forEach(t=>{if(e.get("Health").isDead()){if(this._expiredEffects.push([t.getID(),e]),e.has("Expiration")){const s=e.get("Expiration");s.hasEffect(t)&&s.removeEffect(t)}}else if(r.default.isSuccess(t.getProb())){const s=t.rollDamage(),a=new l.Damage(s,r.default.DMG.POISON);a.setSource(t.getSource()),e.add(a)}})}_applyDirectDamage(e){e.getList("DirectDamage").forEach(t=>{if(e.get("Health").isDead()){if(this._expiredEffects.push([t.getID(),e]),e.has("Expiration")){const s=e.get("Expiration");s.hasEffect(t)&&s.removeEffect(t)}}else if(r.default.isSuccess(t.getProb())){const s=t.getDamage(),a=new l.Damage(s,t.getDamageType());a.setDamageCateg(t.getDamageCateg()),a.setSource(t.getSource()),e.add(a)}})}_applyFading(e){const t=e.get("Fading");if(t.decrDuration(),t.getDuration()<=0){if(r.default.isActor(e)){const t=e.getCell();if(e.getLevel().removeActor(e)){c.emitEvent(r.default.EVT_ACTOR_KILLED,{actor:e});const s=`${e.getName()} disappears.`;r.default.gameMsg({cell:t,msg:s})}else{const t=JSON.stringify(e);r.default.err("System.TimeEffects","_applyFading",`Could not remove actor from level: ${t}`)}}else r.default.err("System.TimeEffects","_applyFading","Fading not handled for non-actors yet.");e.remove(t)}}_applyHeat(e){if(e.has("Coldness")){const t=e.getCell();e.removeAll("Coldness");const s=`Thanks to heat, ${e.getName()} stops shivering`;r.default.gameMsg({cell:t,msg:s})}e.removeAll("Heat")}_applyColdness(e){if(e.has("BodyTemp")){const t=e.get("BodyTemp");if(t.decr(),t.isFrozen()){const t=new l.Damage(1,r.default.DMG.COLD);e.add(t)}}}_applyRegenEffect(e){e.getList("RegenEffect").forEach(t=>{let s=!0;if(t.getHP()>0){const a=t.getWaitHP();if(0===a){const a=e.get("Health");a&&(a.addHP(t.getHP()),a.getHP()<a.getMaxHP()&&(s=!1)),t.setWaitHP(t.getMaxWaitHP())}else t.setWaitHP(a-1)}if(t.getPP()>0){const a=t.getWaitPP();if(0===a){const a=e.get("SpellPower");a&&(a.addPP(t.getPP()),a.getPP()<a.getMaxPP()&&(s=!1)),t.setWaitPP(t.getMaxWaitPP())}else t.setWaitPP(a-1)}s&&e.remove(t)})}printMatchedType(e){for(let t=0;t<this.compTypes.length;t++)e.has(this.compTypes[t])&&r.default.debug(this.compTypes[t],"Has component")}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(4),o=s(14),i=s(1).Random.getRNG();t.SystemWeather=class extends r.SystemBase{constructor(e,t){super(n.default.SYS.WEATHER,e,t),this._effTable={snowStorm:this.handleSnowStorm=this.handleSnowStorm.bind(this),warm:this.handleMeltSnow=this.handleMeltSnow.bind(this)}}updateEntity(e){if(e.has("WeatherEffect")){const t=e.get("WeatherEffect"),s=t.getEffectType();this._effTable[s]&&this._effTable[s](e,t),e.removeAll("WeatherEffect")}}handleSnowStorm(e,t){const s=e.getLevel().getMap();o.MapGenerator.addRandomSnow(s,.1)}handleMeltSnow(e,t){e.getLevel().getMap().getFree().filter(e=>e.getBaseElem().has("Snowy")).forEach(e=>{if(i.getUniform()<.1){const t=e.getBaseElem().getType(),s=o.MapGenerator.snowMeltMap[t];e.setBaseElem(s)}})}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=s(112),n=s(20),r=self;function o(e){const t={type:0,progress:e};r.postMessage(t)}r.addEventListener("message",function(e){try{const t=e.data[0],s=new a.FactoryGame;s.setCallback("progress",o);const i=s.createNewGame(t).toJSON();n.verifySaveData(i);const l={type:1,ready:!0,data:JSON.stringify(i)};r.postMessage(l)}catch(e){const t={type:2,error:e.message};r.postMessage(t)}})},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=n(s(2)),i=n(s(32)),l=n(s(20)),c=n(s(21)),h=s(58),u=s(34),d=s(132),g=s(152),p=s(23),m=s(7),f=s(38),y=s(25),_=s(39),E=s(85),S=s(157),v=s(3),C=s(35),b=s(64),T=s(6),A=s(65),w=s(1),O=s(86),M=s(63),P=s(11),N=m.EventPool.getPool(),I=w.Random.getRNG(),D={Weak:{att:1,def:1,prot:1,hp:15},Medium:{att:2,def:4,prot:2,hp:25},Strong:{att:5,def:6,prot:3,hp:40},Inhuman:{att:10,def:10,prot:4,hp:80}};t.FactoryGame=function(){f.FactoryBase.call(this),this._verif=new l.Conf("Factory.Game"),this._parser=T.ObjectShell.getParser(),this.presetLevels={},this.callbacks={}},r.default.extend2(t.FactoryGame,f.FactoryBase),t.FactoryGame.prototype.restoreGame=function(e){const t=new E.FromJSON,s=new S.GameMain;return t.createGame(s,e)},t.FactoryGame.prototype.createNewGame=function(e){this._verif.verifyConf("createNewGame",e,["sqrPerItem","sqrPerActor","playMode"]);const t=new S.GameMain;if(Number.isInteger(e.seed)){const s=new w.Random(e.seed);t.setRNG(s)}const s=this.createPlayerUnlessLoaded(e);switch(this.createPlayerRegenEvents(t,s),e.playMode){case"Arena":return this.createArenaDebugGame(e,t,s);case"Battle":return this.createDebugBattle(e,t,s);case"Creator":return this.createWorldWithCreator(e,t,s);case"World":return this.createFullWorld(e,t,s);case"OverWorld":return this.createOverWorldGame(e,t,s);case"Quests":return this.createQuestsDebugGame(e,t,s);default:return this.createEmptyGame(e,t,s)}},t.FactoryGame.prototype.createEmptyGame=function(e,t,s){return e.levels&&(e.levels.forEach(e=>{const a=e.getExtras();if(t.addLevel(e),a.startPoint){const[t,n]=a.startPoint;e.addActor(s,t,n)}}),t.addPlayer(s)),t},t.FactoryGame.prototype.createPlayerUnlessLoaded=function(e){let t=e.loadedPlayer;if(r.default.isNullOrUndef([t])){this._verif.verifyConf("createPlayerUnlessLoaded",e,["playerLevel","playerRace","playerName"]);const s=e.playerLevel,a=D[s];(t=this.createPlayer(e.playerName,{att:a.att,def:a.def,prot:a.prot})).setType(e.playerRace),t.add(new o.Health(a.hp)),this.addActorClass(e,t),t.add(new o.Skills),t.add(new o.GameInfo),t.add(new o.BodyTemp),t.add(new o.Abilities)}if(t.has("Hunger")){const e=t.get("Hunger");t.remove("Hunger"),t.add(e)}else{const e=new o.Hunger(2e4);t.add(e)}return r.default.addCellStyle(r.default.TYPE_ACTOR,t.getName(),"cell-actor-player"),"Emilia"===e.playerName?r.default.addCharStyle(r.default.TYPE_ACTOR,t.getName(),"E"):"Oliver"===e.playerName&&r.default.addCharStyle(r.default.TYPE_ACTOR,t.getName(),"O"),t},t.FactoryGame.prototype.createPlayerRegenEvents=function(e,t){const s=new i.RegenEvent(t,r.default.PLAYER_HP_REGEN_PERIOD*r.default.ACTION_DUR);if(e.addEvent(s),t.has("SpellPower")){const s=new i.RegenPPEvent(t,r.default.PLAYER_PP_REGEN_PERIOD*r.default.ACTION_DUR);e.addEvent(s)}},t.FactoryGame.prototype.addActorClass=function(e,t){if(e.playerClass)if(h.ActorClass.hasOwnProperty(e.playerClass)){const s=new o.ActorClass,a=h.ActorClass.create(e.playerClass,t);s.setClassName(e.playerClass),s.setActorClass(a),t.add(s);const n=e.playerClass,r=h.ActorClass.getStartingItems(n),i=h.ActorClass.getEquipment(n);y.FactoryItem.addItemsToActor(t,r),y.FactoryItem.equipItemsToActor(t,i),a.setStartingStats(),a.advanceLevel()}else r.default.err("Factory.Game","addActorClass",`${e.playerClass} not found in ActorClass.`)},t.FactoryGame.prototype.setCallback=function(e,t){this.callbacks[e]=t},t.FactoryGame.prototype.createOverWorldGame=function(e,s,a){const n=t.FactoryGame.getOwConf(1,e),o=Math.floor(n.nLevelsX/2),i=n.nLevelsY-1;n.playerX=o,n.playerY=i,n.playerRace=e.playerRace,n.createTerritory=!0;const l=(new Date).getTime();this.progress("Creating Overworld Tile Map...");const h=b.OWMap.createOverWorld(n);if(this.progress("DONE"),!h._terrMap){this.progress("Generating territory for clans/races...");const t=this.createTerritoryMap(h,e.playerRace,o,i);h.setTerrMap(t),this.progress("DONE")}this.progress("Creating Overworld Level Map...");const u=A.OverWorld.createOverWorldLevel(h,n),[d,g]=u;this.progress("DONE"),this.progress("Mapping settlements into territory areas.."),this.mapZonesToTerritoryMap(h.getTerrMap(),g),this.progress("DONE"),this.progress("Splitting Overworld Level Map into AreaTiles...");const p=C.Builder.splitLevel(d,n);this.progress("DONE"),this.progress("Creating and connectting World.Area tiles..."),new c.Area("Ravendark",n.nLevelsX,n.nLevelsY,100,100,p).connectTiles(),this.progress("DONE");const m=new _.FactoryWorld;m.setOverWorld(h),m.setGlobalConf(e),s.setGlobalConf(e),m.setPresetLevels({Realm:p}),g.createAllZones=!1,this.progress("Creating places and local zones...");const f=p[o][i];this.createPlayerHome(g,a,f,o,i),this.createAreaLevelConstraints(g,h.getTerrMap());const y=m.createWorld(g);s.addPlace(y),h.clearSubLevels(),s.setOverWorld(h),s.setEnableChunkUnload(!0),this.progress("DONE"),this.progress("Adding player to the game..."),this.placePlayer(a,f),N.emitEvent(r.default.EVT_TILE_CHANGED,{actor:a,target:f}),a.setFOVRange(r.default.PLAYER_FOV_RANGE),s.addPlayer(a),this.progress("DONE");const E=(new Date).getTime()-l;return this.progress("World generation took "+E+" ms."),s},t.FactoryGame.prototype.progress=function(e){const t=(new Date).getTime();let s=0;this.timePrev&&(s=(t-this.timePrev)/1e3),this.timePrev=t,this.callbacks.progress&&this.callbacks.progress(e),"DONE"===e&&r.default.log(`${this.prevMsg} - Time: ${s} sec`),this.prevMsg=e},t.FactoryGame.prototype.placePlayer=function(e,t){const s=t.getMap().getFree(),a={};s.forEach(e=>{a[e.getKeyXY()]=!0});let n=null,o=!1,i=1e3;const l=Math.pow(5,2)-1;for(;!o;){n=I.arrayGetRand(s);const[e,t]=n.getXY(),c=v.Geometry.getBoxAround(e,t,2);c.length===l&&(o=!0);for(let e=0;e<c.length;e++){const[t,s]=c[e];o=o&&a[t+","+s]}if(--i<=0){r.default.log("Timeout reached");break}}o?t.addActor(e,n.getX(),n.getY()):t.addActorToFreeCell(e)},t.FactoryGame.prototype.createTerritoryMap=function(e,t,s,a){return O.TerritoryMap.create(e,t,[s,a])},t.FactoryGame.prototype.mapZonesToTerritoryMap=function(e,t){const s=u.ActorsData.filter(e=>"UniqueBase"===e.base),a={};let n=0;const o=this.getDisposition(),i=e.getMap();t.area[0].city.forEach(t=>{const{owX:l,owY:c}=t,h=i[l][c];let u=e.getName(h),d=null;if(u){if(d=[{op:"eq",prop:"type",value:[u]},{op:"neq",prop:"base",value:["WinterBeingBase"]}],"winterbeing"===u&&(d={op:"eq",prop:"base",value:["WinterBeingBase"]}),r.default.isSuccess(.07)){const e=s.filter(e=>e.type===u);if(e.length>0){const s=I.arrayGetRand(e);if(!a.hasOwnProperty(s.name)){const e={name:s.name,nLevel:0};let r=t.quarter[0].create;r||(r={}),r.actor||(r.actor=[]),r.actor.push(e),a[s.name]=s,t.quarter[0].create=r,console.log("Added UNIQ",s.name,"to",t),++n}}}}else{const[t,s]=this.getAreaXYFromOWTileXY(l,c),a=this.getConstrWeightsForAreaXY(t,s,e),n=Object.keys(a);if(a.hasOwnProperty("winterbeing"))d={op:"eq",prop:"base",value:["WinterBeingBase"]};else if(n.length>0)u=I.getWeighted(a),d=[{op:"eq",prop:"type",value:[u]},{op:"neq",prop:"base",value:["WinterBeingBase"]}];else if(0===n.length){r.default.log("factory.game.js",e.mapToString());const a=`owX: ${l}, owY: ${c}`;r.default.err("FactoryGame","mapZonesToTerritoryMap",`No values for AreaTile ${t},${s}, ${a} found`)}}t.constraint||(t.constraint={}),t.constraint.actor=d,t.constraint.disposition=o[u],t.quarter.forEach(e=>{e.constraint||(e.constraint={}),e.constraint.actor=d,e.constraint.disposition=o[u],t.constraint.cellsAround&&(e.constraint.cellsAround=t.constraint.cellsAround)})}),console.log("Factory.Game uniques added",n)},t.FactoryGame.prototype.getDisposition=function(){const e=new g.Disposition(r.default.ALL_RACES);return e.randomize(),e.getTable()},t.FactoryGame.prototype.getAreaXYFromOWTileXY=function(e,t){return new A.OverWorld.CoordMap({xMap:10,yMap:10}).getAreaXYFromOWTileXY(e,t)},t.FactoryGame.prototype.createPlayerHome=function(e,t,s,a,n){let r=s.getFreeRandCell();for(;r.hasConnection();)r=s.getFreeRandCell();const o={name:"Home town of "+t.getName(),x:a,y:n,levelX:r.getX(),levelY:r.getY(),nQuarters:1,groupType:"village",friendly:!0,constraint:{actor:[{op:"eq",prop:"type",value:[t.getType()]},{op:"neq",prop:"base",value:["WinterBeingBase"]}],shop:[{op:"<=",prop:"value",value:50}]},quarter:[{name:"Square",nLevels:1,entranceLevel:0,nShops:1}]};console.log("Hometown located @ ",r.getX(),r.getY()),e.area[0].city.push(o)},t.FactoryGame.prototype.createAreaLevelConstraints=function(e,t){const s=e.area[0],a={};for(let e=0;e<s.maxX;e++)for(let n=0;n<s.maxY;n++){const s=this.getConstrWeightsForAreaXY(e,n,t),r=Object.keys(s);r.push("animal"),a[e+","+n]={actor:{op:"eq",prop:"type",value:r}},s.hasOwnProperty("winterbeing")&&(a[e+","+n].actor={op:"eq",prop:"base",value:"WinterBeingBase"})}s.constraint=a},t.FactoryGame.prototype.getConstrWeightsForAreaXY=function(e,t,s){const a=s.getMap(),n=new A.CoordMap({xMap:10,yMap:10}).getOWTileBboxFromAreaTileXY(e,t),r=v.Geometry.getCellsInBbox(a,n),o=v.Geometry.histArrayVals(r);let i=Object.keys(o);i=i.filter(e=>"#"!==e&&"."!==e);const l={};return i.forEach(e=>{const t=s.getName(e);l[t]=o[e]}),l},t.FactoryGame.prototype.createWorldWithCreator=function(e,t,s){new M.WorldConf;return e.world=M.WorldConf.createWorldConf({name:"World",worldSize:"Small",areaSize:"Small"}),this.createFullWorld(e,t,s)},t.FactoryGame.prototype.createFullWorld=function(e,t,s){const a=e.world;if(this.processPresetLevels(a),!a)return r.default.err("Factory","createFullWorld","obj.world must exist!"),null;a.levelSize=e.levelSize;const n=new _.FactoryWorld;n.setGlobalConf(e),n.setPresetLevels(this.presetLevels);const o=n.createWorld(a),i=o.getLevels();let l={place:a.name,x:0,y:0};return a.playerStart&&(l=a.playerStart),i.length>0?(t.addPlace(o),t.addPlayer(s,l),t):(r.default.err("Factory","createFullWorld","There are no levels in the world!"),null)},t.FactoryGame.prototype.processPresetLevels=function(e){if(this.presetLevels={},e.hasOwnProperty("presetLevels")){Object.keys(e.presetLevels).forEach(t=>{this.presetLevels[t]=this.createPresetLevels(e.presetLevels[t]),e.presetLevels[t]=this.presetLevels[t]})}},t.FactoryGame.prototype.createPresetLevels=function(e){const t=new E.FromJSON;return e.map(e=>{if("function"==typeof e.level.getID)return e;const s=t.restoreLevel(e.level);return s.getID()<r.default.LEVEL_ID_ADD&&s.setID(P.Level.createLevelID()),s.getActors().forEach(e=>{e.getID()<r.default.ENTITY_ID_ADD&&e.setID(p.Entity.createEntityID())}),s.getItems().forEach(e=>{e.getID()<r.default.ENTITY_ID_ADD&&e.setID(p.Entity.createEntityID())}),r.default.setAllExplored(s,!1),{nLevel:e.nLevel,level:s}})},t.FactoryGame.prototype.createArenaDebugGame=function(e,t,s){return new d.DebugGame(this,this._parser).createArena(e,t,s)},t.FactoryGame.prototype.createQuestsDebugGame=function(e,t,s){return new d.DebugGame(this,this._parser).createQuestsDebug(e,t,s)},t.FactoryGame.prototype.createDebugBattle=function(e,t,s){return new d.DebugGame(this,this._parser).createDebugBattle(e,t,s)},t.FactoryGame.prototype.createOneDungeonAndBoss=function(e,t,s){return new d.DebugGame(this,this._parser).createOneDungeonAndBoss(e,t,s)},t.FactoryGame.getOwConf=function(e=1,t={}){const s=t.xMult||1,a=t.yMult||1;return{yFirst:!1,topToBottom:!1,stopOnWall:!0,nVWalls:[.8],owTilesX:s*e*40,owTilesY:a*e*40,worldX:s*e*400,worldY:a*e*400,nLevelsX:s*e*4,nLevelsY:a*e*4,nTilesX:s*e*4,nTilesY:a*e*4}}},function(e,t){var s,a,n=e.exports={};function r(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function i(e){if(s===setTimeout)return setTimeout(e,0);if((s===r||!s)&&setTimeout)return s=setTimeout,setTimeout(e,0);try{return s(e,0)}catch(t){try{return s.call(null,e,0)}catch(t){return s.call(this,e,0)}}}!function(){try{s="function"==typeof setTimeout?setTimeout:r}catch(e){s=r}try{a="function"==typeof clearTimeout?clearTimeout:o}catch(e){a=o}}();var l,c=[],h=!1,u=-1;function d(){h&&l&&(h=!1,l.length?c=l.concat(c):u=-1,c.length&&g())}function g(){if(!h){var e=i(d);h=!0;for(var t=c.length;t;){for(l=c,c=[];++u<t;)l&&l[u].run();u=-1,t=c.length}l=null,h=!1,function(e){if(a===clearTimeout)return clearTimeout(e);if((a===o||!a)&&clearTimeout)return a=clearTimeout,clearTimeout(e);try{a(e)}catch(t){try{return a.call(null,e)}catch(t){return a.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function m(){}n.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var s=1;s<arguments.length;s++)t[s-1]=arguments[s];c.push(new p(e,t)),1!==c.length||h||i(g)},p.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=m,n.addListener=m,n.once=m,n.off=m,n.removeListener=m,n.removeAllListeners=m,n.emit=m,n.prependListener=m,n.prependOnceListener=m,n.listeners=function(e){return[]},n.binding=function(e){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(e){throw new Error("process.chdir is not supported")},n.umask=function(){return 0}},function(e,t,s){var a;function n(e){function s(){if(s.enabled){var e=s,n=+new Date,r=n-(a||n);e.diff=r,e.prev=a,e.curr=n,a=n;for(var o=new Array(arguments.length),i=0;i<o.length;i++)o[i]=arguments[i];o[0]=t.coerce(o[0]),"string"!=typeof o[0]&&o.unshift("%O");var l=0;o[0]=o[0].replace(/%([a-zA-Z%])/g,function(s,a){if("%%"===s)return s;l++;var n=t.formatters[a];if("function"==typeof n){var r=o[l];s=n.call(e,r),o.splice(l,1),l--}return s}),t.formatArgs.call(e,o),(s.log||t.log||console.log.bind(console)).apply(e,o)}}return s.namespace=e,s.enabled=t.enabled(e),s.useColors=t.useColors(),s.color=function(e){var s,a=0;for(s in e)a=(a<<5)-a+e.charCodeAt(s),a|=0;return t.colors[Math.abs(a)%t.colors.length]}(e),"function"==typeof t.init&&t.init(s),s}(t=e.exports=n.debug=n.default=n).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){t.save(e),t.names=[],t.skips=[];for(var s=("string"==typeof e?e:"").split(/[\s,]+/),a=s.length,n=0;n<a;n++)s[n]&&("-"===(e=s[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){var s,a;for(s=0,a=t.skips.length;s<a;s++)if(t.skips[s].test(e))return!1;for(s=0,a=t.names.length;s<a;s++)if(t.names[s].test(e))return!0;return!1},t.humanize=s(115),t.names=[],t.skips=[],t.formatters={}},function(e,t){var s=1e3,a=60*s,n=60*a,r=24*n,o=365.25*r;function i(e,t,s){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+s:Math.ceil(e/t)+" "+s+"s"}e.exports=function(e,t){t=t||{};var l,c=typeof e;if("string"===c&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var i=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return i*o;case"days":case"day":case"d":return i*r;case"hours":case"hour":case"hrs":case"hr":case"h":return i*n;case"minutes":case"minute":case"mins":case"min":case"m":return i*a;case"seconds":case"second":case"secs":case"sec":case"s":return i*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:return}}(e);if("number"===c&&!1===isNaN(e))return t.long?i(l=e,r,"day")||i(l,n,"hour")||i(l,a,"minute")||i(l,s,"second")||l+" ms":function(e){if(e>=r)return Math.round(e/r)+"d";if(e>=n)return Math.round(e/n)+"h";if(e>=a)return Math.round(e/a)+"m";if(e>=s)return Math.round(e/s)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(43),i=s(1),l=s(10),c=n(s(2)),{GOAL_ACTIVE:h,GOAL_COMPLETED:u}=o.GoalStatus,d=i.Random.getRNG();class g extends o.Goal.Base{constructor(e){super(e),this.setType("GoalSearchHouse");const t=e.getCell();t.hasDoor()&&(this.door=t.getXY()),this.subGoals=[],this.searchTime=d.getUniformInt(20,40)}activate(){this.status=h;const e=this.actor.getBrain().getSeenCells();this.floorCells&&0!==this.floorCells.length||(this.floorCells=e.filter(e=>"floorhouse"===e.getBaseElem().getType()));let t=m(this.actor,e);if(!t&&this.floorCells.length>0){const e=d.arrayGetRand(this.floorCells);t=new o.Goal.FollowPath(this.actor,e.getXY())}if(this.searchTime<=0){const e=this.actor.getCell();if(e.hasDoor()){const e=l.Brain.getCellsAroundActor(this.actor);let t=null;e.forEach(e=>{"floorhouse"!==e.getBaseElem().getType()&&e.isPassable()&&(t=e)}),t?(o.Goal.moveActorTo(this.actor,t),this.status=u):r.default.warn("Goal.SearcHouse","activate","Could not move out of the house")}else t=o.Goal.FollowPath(this.actor,e.getXY())}t&&this.addSubGoal(t)}process(){return this.activateIfInactive(),--this.searchTime,this.hasSubGoals()?this.status=this.processSubGoals():(this.activate(),this.status!==u&&(this.status=this.processSubGoals())),this.status}}t.GoalSearchHouse=g;class p extends o.Goal.Base{constructor(e){super(e),this.setType("GoalThief"),this.subGoals=[],this.shopCooldown=20,this.doorCooldown=25,this.visitedDoors={},this.shops={}}activate(){this.status=h,this.chooseThiefTask()}process(){return this.activateIfInactive(),--this.shopCooldown,--this.doorCooldown,this.isCompleted()?u:(this.hasSubGoals()?this.status=this.processSubGoals():(this.chooseThiefTask(),this.hasSubGoals()?this.status=this.processSubGoals():this.status=u),this.status)}isInActiveShop(){const e=this.actor.getCell();if(e.hasShop()){if(!e.getShop().isAbandoned())return this.shops[e.getKeyXY()]=e,!0}return!1}tryToSellItem(){const e=this.actor.getInvEq().getInventory(),t=d.arrayGetRand(e.getItems()),s=this.actor.getCell();if(t){const e=s.getPropType("shop")[0],a=new c.Transaction;a.setArgs({item:t,seller:this.actor,shop:e,buyer:e.getShopkeeper(),count:t.getCount()}),this.actor.add(a)}else r.default.err("Goal.Thief","tryToSellItem",`Null item for sale. Inv: ${JSON.stringify(e)}`)}tryToGoToShopCell(){let e=null;const t=Object.values(this.shops);if(t.length>0){const e=r.default.arrayGetRand(t);return new o.Goal.FollowPath(this.actor,e.getXY())}const s=this.actor.getBrain().getSeenCells();for(let t=0;t<s.length;t++){const a=s[t];a.hasShop()&&(e=new o.Goal.FollowPath(this.actor,a.getXY()))}return e||(this.shopCooldown=20),e}chooseThiefTask(){const e=!this.actor.getInvEq().getInventory().isEmpty();let t=null;const s=this.actor.getCell();if(e&&this.isInActiveShop())this.tryToSellItem(),this.status=u;else if(e&&this.shopCooldown<=0)t=this.tryToGoToShopCell();else{const e=this.actor.getBrain().getSeenCells(),a={};!(t=m(this.actor,e,a,e=>e.hasElements()))&&!s.hasDoor()&&this.doorCooldown<=0?Object.values(a).forEach(e=>{if(e.hasDoor()){const s=e.getXY(),a=e.getKeyXY();if(!this.visitedDoors.hasOwnProperty(a))return this.doorCooldown=25,void(t=new o.Goal.FollowPath(this.actor,s))}}):s.hasDoor()&&(this.visitedDoors[s.getKeyXY()]=s.getXY(),this.thiefSeesHouse()&&(t=new g(this.actor))),t||(t=new o.Goal.Explore(this.actor,30)).setCallback(this.exploreCallback.bind(this))}t&&this.addSubGoal(t)}exploreCallback(e,t){const s=this.actor.getLevel().getMap();if(s.hasXY(e,t)){const a=s.getCell(e,t);a.hasShop()&&(this.shops[a.getKeyXY()]=a)}}thiefSeesHouse(){return this.actor.getBrain().getSeenCells().filter(e=>"floorhouse"===e.getBaseElem().getType()).length>0}}function m(e,t,s,a){let n=null;for(let r=0;r<t.length;r++){const i=t[r];if(i.hasItems()){const t=i.getItems()[0];if(!t.has("Unpaid")){n=new o.Goal.GetItem(e,t);break}}s&&a(t[r])&&(s[i.getKeyXY()]=i)}return n}t.GoalThief=p,o.Goal.Thief=p},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=n(s(19)),i=s(52);t.Inventory=class{static equipAnyItem(e,t){const s=e.getInvEq();s.hasItem(t)||s.addItem(t),s.equipItem(t)}constructor(e){this._actor=e,this._inv=new o.Container(e),this._eq=new i.Equipment(e)}addItem(e){this._inv.addItem(e)}hasItem(e){return this._inv.hasItem(e)}removeItem(e){return this._inv.removeItem(e)}removeNItems(e,t){return this._inv.removeNItems(e,t)}getRemovedItem(){return this._inv.getRemovedItem()}useItem(e,t){if(this._inv.hasItem(e)){if(e.useItem)return e.useItem(t),!0}else r.default.err("Inv.Inventory","useItem","Not in inventory, cannot use!");return!1}canCarryItem(e){return!(this._eq.getWeight()+this._inv.getWeight()+e.getWeight()>this._actor.getMaxWeight())}dropItem(e){if(this._inv.removeItem(e)){const e=this._actor.getLevel(),t=this.getRemovedItem(),[s,a]=this._actor.getXY();if(e.addItem(t,s,a))return!0;this._inv.addItem(t)}return!1}dropNItems(e,t){if(this.removeNItems(e,t)){const e=this._actor.getLevel(),t=this.getRemovedItem(),[s,a]=this._actor.getXY();if(e.addItem(t,s,a))return!0;this._inv.addItem(t)}return!1}removeAndGetItem(e){return this._inv.removeItem(e)?this.getRemovedItem():null}getInventory(){return this._inv}getEquipment(){return this._eq}equipItem(e){if(this._inv.hasItem(e)){const t=this._getItemToEquip(e);if(r.default.isNullOrUndef([t]))return r.default.err("Inv.Inventory","equipItem","equippedItem is null. Should not happen"),!1;if(this._eq.equipItem(t))return!0;this._inv.addItem(t)}else r.default.err("Inv.Inventory","equipItem","Cannot equip. Not in inventory.");return!1}_getItemToEquip(e){return this._inv.removeItem(e)?this._inv.getRemovedItem():null}equipNItems(e,t){if(this._inv.hasItem(e)&&this._inv.removeNItems(e,t)){const e=this._inv.getRemovedItem();if(this._eq.equipItem(e))return!0;this._inv.addItem(e)}return!1}unequipItem(e,t,s){if(r.default.isNullOrUndef([e])){let a="Some params null/undef: ";a+=`type: |${e}| n: |${t}| number: |${s}|`,r.default.err("InvInventory","unequipItem",a)}const a=this._eq.getItem(e);if(!r.default.isNullOrUndef([a])&&this._eq.unequipItem(e,t,s)){const t=this._eq.getUnequipped(e,s);if(null!==t)return this.addItem(t),!0}return!1}unequipAndGetItem(e,t,s){const a=this._eq.getItem(e);return!r.default.isNullOrUndef([a])&&this._eq.unequipItem(e,t)?this._eq.getUnequipped(e,s):null}getWeapon(){const e=this._eq.getItem("hand");return r.default.isNullOrUndef([e])?null:e}getMissileWeapon(){const e=this._eq.getItem("missileweapon");return r.default.isNullOrUndef([e])?null:e}getMissile(){const e=this._eq.getItem("missile");return e||null}getEquipped(e){return this._eq.getItem(e)}restoreEquipped(e){return this._eq.equipItem(e)}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(15),i=n(s(13));t.Cmd={},t.ACTION_ALREADY_DONE=(()=>{}),t.ACTION_ZERO_ENERGY=null,t.Cmd.ACTION_ALREADY_DONE=t.ACTION_ALREADY_DONE,t.Cmd.ACTION_ZERO_ENERGY=t.ACTION_ZERO_ENERGY;class l{constructor(e){this._actor=e.getActor(),this.brain=e}}t.CmdBase=l;class c extends l{execute(e){let s=e.target;if(s.hasActors&&e.target.hasActors()&&(s=e.target.getSentientActors()[0]),s){const[e,a]=this._actor.getXY(),[n,l]=s.getXY();if(o.Path.shortestDist(e,a,n,l)<=r.default.getMeleeAttackRange(this._actor)){const e=new i.Attack({target:s});return this._actor.add(e),t.ACTION_ALREADY_DONE}return this.brain.cmdNotPossible("Target not within attack range")}return this.brain.cmdNotPossible("No valid targets for attack")}}t.CmdAttack=c,t.Cmd.Attack=c;class h extends l{execute(e){const s=this._actor.getInvEq();let a=1;this._actor.has("DoubleShot")&&(a=2);for(let t=0;t<a;t++){const t=s.unequipAndGetItem("missile",1,0);if(r.default.isNullOrUndef([t]))return this.brain.cmdNotPossible("No missile equipped.");if(t.has("Ammo")){const e=s.getEquipment().getEquipped("missileweapon");if(null===e){const e="No missile weapon equipped.";return this.brain.cmdNotPossible(e)}{const s=t.getAmmoType(),a=e.getWeaponType();if(this._actor.has("MixedShot")){const e=/bow/;if(!(e.test(s)&&e.test(a)||s===a)){const e="Ammo/weapon not compatible.";return this.brain.cmdNotPossible(e)}}else if(s!==a){const e="Ammo/weapon not compatible.";return this.brain.cmdNotPossible(e)}}}if(r.default.isNullOrUndef([e.target]))r.default.err("Brain.Player","handleCommand","No x,y given for missile.");else{const[s,a]=e.target.getXY(),n=new i.Missile(this._actor);n.setTargetXY(s,a),n.setDamage(r.default.getMissileDamage(this._actor,t)),n.setAttack(r.default.getMissileAttack(this._actor,t)),n.setRange(r.default.getMissileRange(this._actor,t)),t.add(n),this.brain.energy=r.default.energy.MISSILE}}return t.ACTION_ALREADY_DONE}}t.CmdMissile=h,t.Cmd.Missile=h;class u extends l{execute(e){if(e.hasOwnProperty("item")){const t=e.item;let s=!1,a=`You failed to use ${t.getName()}.`;if("function"==typeof t.useItem&&(this.brain.energy=r.default.energy.USE,t.useItem({target:e.target}),s=!0),e.hasOwnProperty("callback"))s&&(a=`You used ${t.getName()}!`),e.callback({msg:a,result:s});else if(s)r.default.gameMsg(`You used ${t.getName()}!`);else{const s=new i.UseItem;s.setItem(t),s.setTarget(e.target),this._actor.add(s)}}else r.default.err("Brain.Player","handleCommand","obj has no item");return t.ACTION_ALREADY_DONE}}t.CmdUseItem=u,t.Cmd.UseItem=u;class d extends l{execute(e){const s=e.target.getElements(),a=new i.UseElement;return s.forEach(e=>{e.onUse&&a.setElement(e)}),this._actor.add(a),t.ACTION_ALREADY_DONE}}t.CmdUseElement=d,t.Cmd.UseElement=d;class g extends l{execute(e){const s=this._actor.getInvEq(),a=this._actor.getCell();let n=!1,r=`Failed to drop ${e.item.getName()}`;const o=e.count<=e.item.getCount()?e.count:e.item.getCount();let l=!1;if(a.hasShop()){l=!a.getShop().isAbandoned()}if(l){const t=a.getPropType("shop")[0],s=()=>{const s=new i.Transaction;s.setArgs({item:e.item,seller:this._actor,shop:t,callback:e.callback,buyer:t.getShopkeeper(),count:o}),this._actor.add(s)};r=`Press y to sell item for ${t.getItemPriceForSelling(e.item,o)} gold coins.`,this.brain.setWantConfirm(this.brain.energy,s,r),e.hasOwnProperty("callback")&&e.callback({msg:r,result:n})}else s.dropNItems(e.item,o)&&(n=!0,r="Item dropped!");return e.hasOwnProperty("callback")&&e.callback({msg:r,result:n}),t.ACTION_ALREADY_DONE}}t.CmdDropItem=g,t.Cmd.DropItem=g;class p extends l{execute(e){const s=new i.Equip;return s.setArgs(e),s.setIsRemove(!1),this._actor.add(s),t.ACTION_ALREADY_DONE}}t.CmdEquipItem=p,t.Cmd.EquipItem=p;class m extends l{execute(e){const s=new i.Equip;return s.setArgs(e),s.setIsRemove(!0),this._actor.add(s),t.ACTION_ALREADY_DONE}}t.CmdUnequipItem=m,t.Cmd.UnequipItem=m},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(120)),r=s(34),o=a(s(122));t.Objects={actors:r.ActorsData,items:n.default,elements:o.default}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(121),o=s(55),i=1;function l(e,t){let s=0;if("string"==typeof e)switch(e){case"leather":case"chain":case"steel":s=1*t;break;case"permaice":case"ruby":case"magic":s=1.5*t;break;case"void":s=1.75*t;break;case"gem":s=1*t;break;default:s=t}else Number.isInteger(e)&&(s=e);return Math.floor(i*s)}const c=[{name:"Gold coin",className:"cell-item-gold-coin",char:"$",material:"gold",type:"goldcoin",value:l(10),weight:.03},{name:"MeleeWeaponBase",className:"cell-item-melee-weapon",char:"(",material:["iron","wood"],type:"weapon",range:1,attack:0,defense:0,dontCreate:!0},{name:"Dagger",base:"MeleeWeaponBase",material:"iron",damage:"1d4",weaponType:"dagger",weight:.2,value:l(5)},{name:"Bayonette",base:"MeleeWeaponBase",material:"iron",damage:"1d5",weaponType:"dagger",weight:.1,value:l(10)},{name:"Short sword",base:"MeleeWeaponBase",material:"iron",damage:"1d6",weaponType:"sword",weight:.5,value:l(20)},{name:"Wooden staff",base:"MeleeWeaponBase",material:"wood",damage:"1d6",weaponType:"staff",defense:1,weight:1,value:l(30)},{name:"Whip",base:"MeleeWeaponBase",material:"leather",damage:"1d6",range:2,attack:-1,weight:.2,value:l(10)},{name:"Tomahawk",base:"MeleeWeaponBase",material:["wood","stone","leather"],damage:"1d7",attack:1,defense:1,weaponType:"axe",weight:.7,value:l(35)},{name:"Iron staff",base:"MeleeWeaponBase",material:"iron",damage:"1d8",weaponType:"staff",defense:2,weight:1.9,value:l(40)},{name:"Piolet",base:"MeleeWeaponBase",damage:"1d8",attack:1,defense:1,weaponType:"axe",weight:.7,value:l(50)},{name:"Pick-axe",base:"MeleeWeaponBase",damage:"1d8",attack:1,defense:2,weaponType:"axe",weight:2.3,value:l(50),use:"digger"},{name:"Saber",base:"MeleeWeaponBase",material:"iron",damage:"2d4 + 1",attack:2,defense:1,weaponType:"sword",weight:.6,value:l(30)},{name:"Mace",base:"MeleeWeaponBase",material:"iron",damage:"2d4 + 2",attack:2,defense:0,weaponType:"mace",weight:.8,value:l(35)},{name:"Spear",base:"MeleeWeaponBase",damage:"1d8",attack:1,defense:3,weaponType:"spear",weight:1.2,value:l(50)},{name:"Iron axe",base:"MeleeWeaponBase",damage:"1d8",attack:3,defense:1,weaponType:"axe",weight:1.5,value:l(60)},{name:"Longsword",base:"MeleeWeaponBase",material:"steel",damage:"1d8",attack:2,defense:2,weaponType:"sword",weight:.8,value:l(75)},{name:"Morningstar",base:"MeleeWeaponBase",material:["wood","iron"],damage:"1d9 + 2",attack:2,defense:3,weaponType:"mace",weight:.7,value:l(75)},{name:"Battle axe",base:"MeleeWeaponBase",material:"iron",damage:"2d6 + 2",attack:2,defense:1,weaponType:"axe",weight:2.5,value:l(85)},{name:"Warhammer",base:"MeleeWeaponBase",material:"iron",damage:"2d6 + 5",attack:3,defense:1,weaponType:"hammer",weight:4.5,value:l(100)},{name:"Dwarven pick-axe",base:"MeleeWeaponBase",damage:"1d12",attack:2,defense:2,color:r.Colors.race.dwarven,weaponType:"axe",weight:3.5,value:l(120),use:"digger"},{name:"Great battle axe",base:"MeleeWeaponBase",material:"steel",damage:"2d8 + 4",attack:3,defense:0,weaponType:"axe",weight:4.5,value:l(130)},{name:"MithrilWeaponBase",base:"MeleeWeaponBase",className:"cell-item-mithril",material:"mithril",dontCreate:!0,attack:1},{name:"Mithril dagger",base:"MithrilWeaponBase",attack:2,damage:"1d7 + 3",weaponType:"dagger",weight:.15,value:l(50)},{name:"Mithril short sword",base:"MithrilWeaponBase",attack:3,damage:"1d9 + 4",defense:2,weight:.35,value:l(100),weaponType:"sword"},{name:"Mithril mace",base:"MithrilWeaponBase",damage:"1d11 + 5",weaponType:"mace",attack:3,defense:2,weight:2.5,value:l(150)},{name:"Mithril staff",base:"MithrilWeaponBase",damage:"1d12 + 2",weaponType:"staff",defense:6,weight:1.5,value:l(170)},{name:"Mithril axe",base:"MithrilWeaponBase",attack:4,damage:"1d15 + 2",defense:3,weaponType:"axe",weight:1.2,value:l(200)},{name:"Mithril hammer",base:"MithrilWeaponBase",attack:5,damage:"1d15 + 6",defense:1,weaponType:"axe",weight:2.4,value:l(250)},{name:"Mithril long sword",base:"MithrilWeaponBase",attack:5,damage:"1d15 + 4",defense:4,weight:.6,value:l(300),weaponType:"sword"},{name:"Mithril spear",base:"MithrilWeaponBase",attack:5,damage:"1d12 + 4",defense:8,weight:.9,value:l(350),weaponType:"spear"},{name:"IceWeaponBase",base:"MeleeWeaponBase",className:"cell-item-ice",material:"permaice",dontCreate:!0,attack:1},{name:"Permaice dagger",base:"IceWeaponBase",damage:"1d4 + 9",defense:6,weight:.6,value:l(150),weaponType:"dagger"},{name:"Permaice short sword",base:"IceWeaponBase",damage:"2d5 + 6",defense:6,weight:1.5,value:l(300),weaponType:"sword"},{name:"Permaice mace",base:"IceWeaponBase",damage:"2d7 + 6",weaponType:"mace",defense:6,weight:2.5,value:l(300)},{name:"Permaice staff",base:"IceWeaponBase",damage:"3d5",weaponType:"staff",defense:7,weight:3.8,value:l(300)},{name:"Permaice axe",base:"IceWeaponBase",damage:"3d6 + 6",defense:7,weaponType:"axe",weight:4.5,value:l(400)},{name:"Permaice hammer",base:"IceWeaponBase",damage:"3d6 + 10",defense:7,weaponType:"hammer",weight:6.5,value:l(440)},{name:"Permaice long sword",base:"IceWeaponBase",damage:"4d5 + 6",defense:8,weight:3,value:l(500),weaponType:"sword"},{name:"Permaice spear",base:"IceWeaponBase",damage:"4d5 + 6",defense:12,weight:3.5,value:l(550),weaponType:"spear"},{name:"Permaice katana",base:"IceWeaponBase",damage:"10d3 + 6",defense:10,weight:4,value:l(750),weaponType:"sword"},{name:"RubyWeaponBase",base:"MeleeWeaponBase",className:"cell-item-ruby-glass",material:"ruby glass",dontCreate:!0},{name:"Ruby glass dagger",base:"RubyWeaponBase",damage:"2d5 + 2",attack:4,defense:1,weight:.1,value:l(110),weaponType:"dagger"},{name:"Ruby glass short sword",base:"RubyWeaponBase",damage:"3d5 + 2",attack:3,defense:2,weight:.2,value:l(200),weaponType:"sword"},{name:"Ruby glass mace",base:"RubyWeaponBase",damage:"3d6 + 2",attack:3,defense:3,weight:.3,value:l(250),weaponType:"mace"},{name:"Ruby glass hammer",base:"RubyWeaponBase",damage:"3d6 + 4",attack:4,defense:2,weight:.6,value:l(250),weaponType:"hammer"},{name:"Ruby glass staff",base:"RubyWeaponBase",damage:"3d5",weaponType:"staff",attack:4,defense:5,weight:.4,value:l(300)},{name:"Ruby glass sword",base:"RubyWeaponBase",damage:"4d5 + 2",attack:5,defense:2,weight:.3,value:l(350),weaponType:"sword"},{name:"Ruby glass spear",base:"RubyWeaponBase",damage:"3d5 + 2",attack:3,defense:6,weight:.4,value:l(400),weaponType:"spear"},{name:"Ruby glass battle axe",base:"RubyWeaponBase",damage:"4d6 + 3",attack:6,defense:2,weight:.7,value:l(800),weaponType:"axe"},{name:"RunedWeaponBase",base:"MeleeWeaponBase",className:"cell-item-magic",material:"forium",dontCreate:!0},{name:"Runed dagger",base:"RunedWeaponBase",damage:"2d5 + 2",attack:2,defense:1,weight:.2,value:l(100),weaponType:"dagger"},{name:"Runed short sword",base:"RunedWeaponBase",damage:"3d5 + 2",attack:3,defense:2,weight:.5,value:l(300),weaponType:"sword"},{name:"Runed mace",base:"RunedWeaponBase",damage:"3d6 + 2",attack:3,defense:2,weight:1,value:l(340),weaponType:"mace"},{name:"Runed axe",base:"RunedWeaponBase",damage:"4d5 + 2",attack:4,defense:2,weight:1.5,value:l(400),weaponType:"axe"},{name:"Runed hammer",base:"RunedWeaponBase",damage:"4d5 + 4",attack:5,defense:1,weight:2.7,value:l(400),weaponType:"hammer"},{name:"Runed staff",base:"RunedWeaponBase",damage:"4d5",weaponType:"staff",attack:2,defense:9,weight:2,value:l(400)},{name:"Runed sword",base:"RunedWeaponBase",damage:"5d5 + 2",attack:5,defense:2,weight:1,value:l(500),weaponType:"sword"},{name:"Runed spear",base:"RunedWeaponBase",damage:"4d5 + 4",attack:4,defense:8,weight:1.4,value:l(600),weaponType:"spear"},{name:"Runed runesword",base:"RunedWeaponBase",damage:"3d10 + 2",attack:5,defense:5,weight:.8,value:l(750),weaponType:"sword"},{name:"Wintersbane",base:"RunedWeaponBase",damage:"3d8 + 4",attack:6,defense:3,weight:1,value:l(1e3),weaponType:"sword"},{name:"VoidWeaponBase",base:"MeleeWeaponBase",className:"cell-item-void",material:"netherium",dontCreate:!0,onAttackHit:[o.meleeHitDamage(2,"1d8 + 1","VOID")]},{name:"Void dagger",base:"VoidWeaponBase",damage:"2d5 + 1",attack:2,defense:1,weight:.3,value:l(200),weaponType:"dagger"},{name:"Void short sword",base:"VoidWeaponBase",damage:"3d5 + 1",attack:3,defense:2,weight:.7,value:l(300),weaponType:"sword"},{name:"Void mace",base:"VoidWeaponBase",damage:"3d6 + 1",attack:3,defense:2,weight:1.4,value:l(390),weaponType:"mace"},{name:"Void axe",base:"VoidWeaponBase",damage:"4d5 + 1",attack:4,defense:2,weight:1.9,value:l(450),weaponType:"axe"},{name:"Void staff",base:"VoidWeaponBase",damage:"3d6",weaponType:"staff",attack:2,defense:9,weight:2,value:l(450)},{name:"Void longsword",base:"VoidWeaponBase",damage:"5d5 + 1",attack:5,defense:2,weight:1.4,value:l(550),weaponType:"sword"},{name:"Void spear",base:"VoidWeaponBase",damage:"4d5 + 2",attack:4,defense:8,weight:1.8,value:l(650),weaponType:"spear"},{name:"Hammer of Void",base:"VoidWeaponBase",damage:"5d5 + 4",attack:8,defense:8,weight:3.7,value:l(850),weaponType:"hammer",onAttackHit:[o.meleeHitDamage(2,"2d8 + 4","VOID")]},{name:"ArmourBase",type:"armour",className:"cell-item-armour",char:"[",dontCreate:!0,attack:0,defense:0,protection:0},{name:"Robe",base:"ArmourBase",className:"cell-item-cloth",weight:1,defense:1,armourType:"chest",value:l(15)},{name:"Spiked boots",base:"ArmourBase",weight:.4,defense:1,protection:1,armourType:"feet",value:l(35)},{name:"Robe of defense",base:"ArmourBase",className:"cell-item-cloth",weight:.9,defense:4,armourType:"chest",value:l(200)},{name:"Robe of protection",base:"ArmourBase",className:"cell-item-cloth",weight:.8,protection:4,armourType:"chest",value:l(200)},{name:"Runed robe",base:"ArmourBase",className:"cell-item-cloth",weight:.7,defense:4,protection:4,armourType:"chest",value:l(350)},{name:"Boots of flying",base:"ArmourBase",weight:.4,defense:1,protection:1,armourType:"feet",value:l(35),onEquip:[{addComp:"Flying"}]},{name:"Snow shoes",base:"ArmourBase",weight:.4,defense:-1,protection:0,armourType:"feet",value:l(75),onEquip:[{addComp:"SnowWalk"}],noRandom:!0},{name:"LeatherArmourBase",base:"ArmourBase",dontCreate:!0,material:"leather",className:"cell-item-leather"},{name:"Leather helmet",base:"LeatherArmourBase",weight:.3,defense:1,armourType:"head",value:l(15)},{name:"Leather collar",base:"LeatherArmourBase",weight:.2,protection:1,armourType:"neck",value:l(15)},{name:"Leather boots",base:"LeatherArmourBase",weight:.5,defense:1,armourType:"feet",value:l(15)},{name:"Leather armour",base:"LeatherArmourBase",weight:2,defense:2,protection:2,armourType:"chest",value:l(30)},{name:"Leather shield",base:"LeatherArmourBase",weight:1,defense:2,attack:-1,armourType:"shield",value:l(15)},{name:"ChainArmourBase",base:"ArmourBase",dontCreate:!0,material:"iron",className:"cell-item-iron"},{name:"Chain helmet",base:"ChainArmourBase",weight:.6,defense:1,protection:1,armourType:"head",value:l(45)},{name:"Chain collar",base:"ChainArmourBase",weight:.4,protection:2,armourType:"neck",value:l(45)},{name:"Chain boots",base:"ChainArmourBase",weight:1.2,defense:1,protection:1,armourType:"feet",value:l(45)},{name:"Chain armour",base:"ChainArmourBase",weight:4,defense:1,protection:3,armourType:"chest",value:l(90)},{name:"Chain shield",base:"ChainArmourBase",weight:2,defense:3,attack:-2,armourType:"shield",value:l(40)},{name:"SteelArmourBase",base:"ArmourBase",dontCreate:!0,material:"steel",className:"cell-item-steel"},{name:"Steel helmet",base:"SteelArmourBase",weight:1.1,defense:1,protection:2,armourType:"head",value:l(75)},{name:"Steel collar",base:"SteelArmourBase",weight:.8,protection:3,armourType:"neck",value:l(75)},{name:"Steel boots",base:"SteelArmourBase",weight:2,defense:1,protection:2,armourType:"feet",value:l(75)},{name:"Steel armour",base:"SteelArmourBase",weight:8,defense:0,protection:5,armourType:"chest",value:l(150)},{name:"Steel shield",base:"SteelArmourBase",weight:3,defense:4,attack:-2,armourType:"shield",value:l(80)},{name:"MithrilArmourBase",base:"ArmourBase",dontCreate:!0,material:"mithril",className:"cell-item-mithril"},{name:"Mithril helmet",base:"MithrilArmourBase",weight:.8,defense:1,protection:2,armourType:"head",value:l(120)},{name:"Mithril collar",base:"MithrilArmourBase",weight:.6,protection:3,armourType:"neck",value:l(110)},{name:"Mithril boots",base:"MithrilArmourBase",weight:1.6,defense:1,protection:2,armourType:"feet",value:l(120)},{name:"Mithril armour",base:"MithrilArmourBase",weight:6,defense:0,protection:7,armourType:"chest",value:l(200)},{name:"Mithril shield",base:"MithrilArmourBase",weight:2.2,defense:5,attack:-1,armourType:"shield",value:l(120)},{name:"IceArmourBase",base:"ArmourBase",dontCreate:!0,material:"permaice",className:"cell-item-ice"},{name:"Permaice helmet",base:"IceArmourBase",weight:1.8,defense:0,protection:4,armourType:"head",value:l(200)},{name:"Permaice collar",base:"IceArmourBase",weight:1.8,defense:0,protection:4,armourType:"neck",value:l(200)},{name:"Permaice boots",base:"IceArmourBase",weight:3.6,defense:0,protection:3,armourType:"feet",value:l(200)},{name:"Permaice armour",base:"IceArmourBase",weight:12,defense:0,protection:12,armourType:"chest",value:l(400)},{name:"Permaice shield",base:"IceArmourBase",weight:6,defense:4,attack:-3,protection:2,armourType:"shield",value:l(120)},{name:"RubyArmourBase",base:"ArmourBase",dontCreate:!0,material:"ruby glass",className:"cell-item-ruby-glass"},{name:"Ruby glass helmet",base:"RubyArmourBase",weight:.1,defense:2,protection:2,armourType:"head",value:l("ruby",100)},{name:"Ruby glass collar",base:"RubyArmourBase",weight:.1,defense:2,protection:2,armourType:"neck",value:l("ruby",100)},{name:"Ruby glass boots",base:"RubyArmourBase",weight:.2,defense:3,protection:2,armourType:"feet",value:l("ruby",200)},{name:"Ruby glass armour",base:"RubyArmourBase",weight:1,defense:6,protection:6,armourType:"chest",value:l("ruby",500)},{name:"Ruby glass shield",base:"RubyArmourBase",weight:.4,defense:5,armourType:"shield",value:l("ruby",250)},{name:"RunedArmourBase",base:"ArmourBase",dontCreate:!0,material:"forium",className:"cell-item-magic"},{name:"Runed helmet",base:"RunedArmourBase",weight:.6,defense:3,protection:4,armourType:"head",value:l("magic",200)},{name:"Runed collar",base:"RunedArmourBase",weight:.4,defense:3,protection:2,armourType:"neck",value:l("magic",200)},{name:"Runed boots",base:"RunedArmourBase",weight:1.2,defense:3,protection:2,armourType:"feet",value:l("magic",200)},{name:"Runed armour",base:"RunedArmourBase",weight:4,defense:10,protection:7,armourType:"chest",value:l("magic",500)},{name:"Runed shield",base:"RunedArmourBase",weight:2,defense:5,attack:-2,armourType:"shield",value:l("magic",200)},{name:"MissileBase",className:"cell-item-missile",char:"/",type:"missile",dontCreate:!0,attack:1,damage:"1d1",range:2,weight:.1},{name:"Rock",base:"MissileBase",className:"cell-item-rock",char:"*",damage:"1d4",range:5,value:l(10),weight:.2},{name:"Large rock",base:"MissileBase",className:"cell-item-rock",char:"*",damage:"2d4 + 2",range:2,value:l(20),weight:1},{name:"Huge rock",base:"MissileBase",className:"cell-item-rock",char:"*",damage:"5d4 + 2",range:1,value:l(40),weight:20},{name:"Shuriken",base:"MissileBase",className:"cell-item-iron",char:"*",damage:"1d6",range:3,value:l(20),weaponType:"shuriken"},{name:"Iron dart",base:"MissileBase",className:"cell-item-iron",damage:"1d6 + 1",range:4,value:l(40),weaponType:"dart"},{name:"Steel dart",base:"MissileBase",className:"cell-item-steel",damage:"1d6 + 3",range:4,value:l(50),weaponType:"dart"},{name:"Throwing spear",base:"MissileBase",className:"cell-item-iron",attack:2,damage:"1d7 + 1",range:3,value:l(55),weight:.4,weaponType:"spear"},{name:"Throwing axe",base:"MissileBase",className:"cell-item-iron",attack:2,damage:"1d8 + 1",range:3,value:l(60),weight:.3,weaponType:"axe"},{name:"Ruby glass throwing knife",base:"MissileBase",className:"cell-item-ruby-glass",attack:3,damage:"1d10",range:5,value:l(80),weight:.1,weaponType:"dagger",material:"ruby glass"},{name:"Runed Shuriken",base:"MissileBase",attack:3,className:"cell-item-magic",char:"*",material:"forium",damage:"3d4 + 2",range:5,value:l(100),weight:.1,weaponType:"shuriken"},{name:"Throwing axe of death",base:"MissileBase",className:"cell-item-magic",attack:5,damage:"2d10 + 3",range:3,value:l(200),weight:.5,addComp:"Indestructible",weaponType:"axe"},{name:"MissileWeaponBase",dontCreate:!0,type:"missileweapon",fireRate:1,className:"cell-item-missileweapon",attack:0,defense:0,char:"{"},{name:"Wooden bow",base:"MissileWeaponBase",className:"cell-item-wooden",attack:1,range:4,value:l(75),weaponType:"bow",weight:1},{name:"Wooden crossbow",base:"MissileWeaponBase",className:"cell-item-wooden",attack:3,range:6,value:l(150),weaponType:"crossbow",weight:2},{name:"Iron bow",base:"MissileWeaponBase",className:"cell-item-iron",attack:1,range:5,value:l(110),weaponType:"bow",weight:1.5},{name:"Steel bow",base:"MissileWeaponBase",className:"cell-item-steel",attack:2,range:5,value:l(150),weaponType:"bow",weight:2},{name:"Steel crossbow",base:"MissileWeaponBase",className:"cell-item-steel",attack:4,range:7,value:l(250),weaponType:"crossbow",weight:3},{name:"Ruby glass bow",base:"MissileWeaponBase",className:"cell-item-ruby-glass",attack:6,range:6,value:l("ruby",300),weaponType:"bow",weight:.3},{name:"Double crossbow",base:"MissileWeaponBase",className:"cell-item-steel",attack:0,range:5,value:l(400),fireRate:2,weaponType:"crossbow",weight:4},{name:"Bow of Defense",base:"MissileWeaponBase",className:"cell-item-magic",attack:1,range:4,defense:6,value:l("magic",500),weaponType:"bow",weight:1},{name:"Rifle",base:"MissileWeaponBase",className:"cell-item-steel",attack:4,range:7,value:l(350),weaponType:"rifle",weight:4.5},{name:"Dwarven rifle",base:"MissileWeaponBase",className:"cell-item-steel",attack:4,range:8,damage:"1d6",value:l(500),weaponType:"rifle",weight:5.5},{name:"Wooden arrow",base:"MissileBase",className:"cell-item-wooden",type:"ammo",range:1,weight:.1,ammoType:"bow",attack:0,damage:"1d6",value:l(10)},{name:"Wooden bolt",base:"MissileBase",className:"cell-item-wooden",type:"ammo",range:1,weight:.1,ammoType:"crossbow",attack:1,damage:"1d8",value:l(15)},{name:"Steel arrow",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.1,ammoType:"bow",attack:0,damage:"1d6 + 2",value:l("steel",20)},{name:"Steel bolt",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.1,ammoType:"crossbow",attack:1,damage:"1d8",value:l("steel",25)},{name:"Stone bullet",base:"MissileBase",className:"cell-item-rock",type:"ammo",range:1,weight:.1,ammoType:"rifle",attack:-1,damage:"2d4",value:l(30)},{name:"Arrow of targeting",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.1,ammoType:"bow",attack:10,damage:"1d6 + 3",value:l("steel",40)},{name:"Runed arrow",base:"MissileBase",className:"cell-item-magic",type:"ammo",range:1,weight:.2,ammoType:"bow",attack:4,damage:"2d7",value:l("magic",50)},{name:"Ruby glass bolt",base:"MissileBase",className:"cell-item-ruby-glass",type:"ammo",range:2,weight:.05,ammoType:"crossbow",attack:3,damage:"2d8",value:l("ruby",60)},{name:"Steel bullet",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.05,ammoType:"rifle",attack:1,damage:"3d4",value:l(50)},{name:"Void bolt",base:"MissileBase",className:"cell-item-void",type:"ammo",range:1,weight:.1,ammoType:"crossbow",attack:5,damage:"4d4 + 4",value:l(100)},{name:"PotionBase",className:"cell-item-potion",char:"!",type:"potion",dontCreate:!0,weight:.1,addComp:"OneShot"},{name:"Healing potion",base:"PotionBase",use:{heal:{hp:"3d4"}},value:l(10)},{name:"Potion of venom",base:"PotionBase",use:{poison:{duration:"4d4 + 5",damage:"1d6",prob:"0.1"}},value:l(30)},{name:"Potion of stunning",base:"PotionBase",use:{stun:{duration:"2d4 + 1"}},value:l(50)},{name:"Potion of power",base:"PotionBase",use:{modifyCompValue:{name:"SpellPower",set:"setPP",get:"getPP",value:"1d10 + 2"}},value:l(50)},{name:"Potion of nourishment",base:"PotionBase",use:{modifyCompValue:{name:"Hunger",set:"setEnergy",get:"getEnergy",value:"10000"}},value:l(50)},{name:"Potion of cure poison",base:"PotionBase",use:{cure:{effect:"poison"}},value:l(80)},{name:"Potion of eagle",base:"PotionBase",use:{addComp:{name:"Flying",duration:"10d10 + 10"}},value:l(80)},{name:"Potion of paralysis",base:"PotionBase",use:{addComp:{name:"Paralysis",duration:"2d5"}},value:l(80)},{name:"Potion of frost poison",base:"PotionBase",use:{poison:{duration:"5d20",damage:"1d6 + 1",prob:"0.2"}},value:l(100)},{name:"Healing elixir",base:"PotionBase",use:{heal:{hp:"10d5"}},value:l(100)},{name:"Potion of spirit form",base:"PotionBase",use:{addComp:{name:"Ethereal",duration:"2d10"}},value:l(100)},{name:"Potion of mana",base:"PotionBase",use:{modifyCompValue:{name:"SpellPower",set:"setPP",get:"getPP",value:"6d5 + 5"}},value:l(150)},{name:"Potion of quickness",base:"PotionBase",use:{modifyStat:{value:2,statName:"speed"}},value:l(150)},{name:"Potion of willpower",base:"PotionBase",use:{modifyStat:{value:1,statName:"willpower"}},value:l(200)},{name:"Potion of strength",base:"PotionBase",use:{modifyStat:{value:1,statName:"strength"}},value:l(200)},{name:"Potion of agility",base:"PotionBase",use:{modifyStat:{value:1,statName:"agility"}},value:l(200)},{name:"Potion of accuracy",base:"PotionBase",use:{modifyStat:{value:1,statName:"accuracy"}},value:l(200)},{name:"Potion of magic",base:"PotionBase",use:{modifyStat:{value:1,statName:"magic"}},value:l(200)},{name:"FoodBase",className:"cell-item-food",char:"%",weight:.1,type:"food",dontCreate:!0,addComp:"OneShot"},{name:"Carrots",base:"FoodBase",energy:500,value:l(10)},{name:"Cabbage",base:"FoodBase",energy:700,value:l(10),color:o.color("green","black")},{name:"Berries",base:"FoodBase",energy:1700,value:l(30),color:o.color("white","blue")},{name:"Potatoes",base:"FoodBase",energy:1200,value:l(20)},{name:"Dried meat",base:"FoodBase",energy:1300,value:l(20)},{name:"Corn",base:"FoodBase",energy:1600,value:l(30)},{name:"Chunk of meat",base:"FoodBase",energy:1e3,value:l(20),weight:.4,color:o.color("white","red")},{name:"Rye bread",base:"FoodBase",energy:2e3,value:l(30)},{name:"Oats",base:"FoodBase",energy:2800,value:l(30)},{name:"Ration",base:"FoodBase",energy:2e3,value:l(40),weight:1},{name:"Dried fruit",base:"FoodBase",energy:3500,value:l(50)},{name:"Ghost pepper",base:"FoodBase",energy:100,value:l(50),use:{stun:{duration:"3d3"}}},{name:"Whale fat",base:"FoodBase",energy:8e3,value:l(100)},{name:"tool",type:"tool",uses:10,className:"cell-item-tool",char:"]",dontCreate:!0},{name:"shovel",base:"tool",use:{addElement:{elementName:"Hole",numAllowed:1,successMsg:"You dig a hole to the ground",failureMsg:"You fail to dig a hole there"}}},{name:"machete",base:"tool",char:"(",use:{removeElement:{elementName:"web",successMsg:"You remove the webs using machete",failureMsg:"You do not manage to remove any webs"}}},{name:"trapmaking kit",base:"tool"},{name:"firemaking kit",base:"tool",use:{addEntity:{entityName:"Fire",duration:20}}},{name:"repair tool kit",base:"tool",use:{removeComp:{name:"Broken"}},noRandom:!0},{name:"rope",base:"tool"},{name:"piece of wood",base:"tool",className:"cell-item-wooden"},{name:"SpiritGemBase",className:"cell-item-spiritgem",char:"*",weight:.1,type:"spiritgem",dontCreate:!0},{name:"Lesser spirit gem",base:"SpiritGemBase",value:l("gem",30),weight:4},{name:"Ordinary spirit gem",base:"SpiritGemBase",value:l("gem",60),weight:2.5},{name:"Greater spirit gem",base:"SpiritGemBase",value:l("gem",100),weight:1.5},{name:"Mystical spirit gem",base:"SpiritGemBase",value:l("gem",300),weight:.5},{name:"Mythic spirit gem",base:"SpiritGemBase",value:l("gem",500),weight:.2},{name:"RuneBase",dontCreate:!0,type:"rune",char:"*",className:"cell-item-rune",weight:1},{name:"rune of healing",base:"RuneBase",use:{heal:{hp:"4d4"}},value:l("rune",100)},{name:"rune of protection",base:"RuneBase",use:{addComp:{name:"CombatMods",duration:"10d5 + 10",setters:{setProtection:"2d5"}}},value:l("rune",100)},{name:"rune of defense",base:"RuneBase",use:{addComp:{name:"CombatMods",duration:"10d5 + 10",setters:{setProtection:"2d5"}}},value:l("rune",100)},{name:"rune of attack",base:"RuneBase",use:{addComp:{name:"CombatMods",duration:"10d5 + 10",setters:{setAttack:"2d5"}}},value:l("rune",100)},{name:"rune of webs",base:"RuneBase",use:{addElement:{elementName:"Web",numAllowed:1}},value:l("rune",100)},{name:"rune of cold",base:"RuneBase",use:{addComp:{name:"Coldness",duration:"100d5 + 50"}},value:l("rune",100)},{name:"rune of fire",base:"RuneBase",use:{addEntity:{entityName:"Fire",duration:50}},value:l("rune",100)},{name:"rune of force",base:"RuneBase",use:{addEntity:{entityName:"Forcefield"}},value:l("rune",100)},{name:"rune of skies",base:"RuneBase",use:{addComp:{name:"Flying",duration:"5d10 + 5"}},value:l("rune",100)},{name:"rune of ice flames",base:"RuneBase",use:{addEntity:{entityName:"Ice flame",duration:100}},value:l("rune",150)},{name:"rune of tunneling",base:"RuneBase",use:"digger",value:l("rune",150)},{name:"rune of traps",base:"RuneBase",use:{addElement:{elementName:"Hole",numAllowed:1}},value:l("rune",150)},{name:"rune of poison clouds",base:"RuneBase",use:{addEntity:{entityName:"Poison gas",duration:30}},value:l("rune",150)},{name:"rune of venom",base:"RuneBase",use:{poison:{duration:"4d6 + 5",damage:"1d8 + 2",prob:"0.2"}},value:l("rune",150)},{name:"rune of control",base:"RuneBase",use:{addComp:{name:"MindControl",duration:"1d4 + 2"}},value:l("rune",250)},{name:"MineralBase",dontCreate:!0,type:"mineral",char:"]"},{name:"iron ore",base:"MineralBase",weight:.3,value:l("mineral",20),className:"cell-item-iron"},{name:"ruby glass ore",base:"MineralBase",weight:.1,value:l("mineral",100),className:"cell-item-ruby-glass"},{name:"emerald",base:"MineralBase",weight:.15,value:l("mineral",150),char:"*",color:{fg:"Green",bg:"Black"}},{name:"permaice ore",base:"MineralBase",weight:.4,value:l("mineral",100),className:"cell-item-ice"},{name:"sapphire",base:"MineralBase",weight:.15,value:l("mineral",150),char:"*",color:{fg:"Blue",bg:"White"}},{name:"forium ore",base:"MineralBase",weight:.2,value:l("mineral",150),className:"cell-item-magic"},{name:"netherium ore",base:"MineralBase",weight:.3,value:l("mineral",200),className:"cell-item-void"},{name:"ruby",base:"MineralBase",weight:.2,value:l("mineral",250),char:"*",className:"cell-item-ruby-glass"},{name:"ice diamond",base:"MineralBase",weight:.3,value:l("mineral",400),char:"*",className:"cell-item-ice"},{name:"MagicalArrowBase",noRandom:!0,type:"ammo",char:"/",addComp:"Magical"},{name:"Ice arrow",base:"MagicalArrowBase",className:"cell-item-ice"},{name:"Lightning arrow",base:"MagicalArrowBase",className:"cell-item-lightning"},{name:"Energy arrow",base:"MagicalArrowBase",className:"cell-item-energy"},{name:"Poison arrow",base:"MagicalArrowBase",className:"cell-item-poison"},{name:"Arrow of webs",base:"MagicalArrowBase",className:"cell-item-energy"}],h={sword:n.default.DMG.SLASH,spear:n.default.DMG.PIERCE,dagger:n.default.DMG.SLASH,axe:n.default.DMG.SLASH,dart:n.default.DMG.PIERCE,shuriken:n.default.DMG.SLASH,bow:n.default.DMG.PIERCE,crossbow:n.default.DMG.PIERCE,rifle:n.default.DMG.PIERCE};c.forEach(e=>{e.weaponType?h.hasOwnProperty(e.weaponType)&&(e.damageType=h[e.weaponType]):e.ammoType&&h.hasOwnProperty(e.ammoType)&&(e.damageType=h[e.ammoType])}),t.default=c},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Colors={},t.Colors.race={},t.Colors.race.animal={bg:"Brown"},t.Colors.race.avianfolk={bg:"GreenYellow"},t.Colors.race.bearfolk={bg:"GreenYellow"},t.Colors.race.catfolk={bg:"GreenYellow"},t.Colors.race.dark={bg:"Brown"},t.Colors.race.dogfolk={bg:"GreenYellow"},t.Colors.race.dwarven={fg:"White",bg:"Brown"},t.Colors.race.goblin={bg:"GreenYellow"},t.Colors.race.human={bg:"Brown"},t.Colors.race.hyrkhian={bg:"Brown"},t.Colors.race.hyrm={bg:"Brown"},t.Colors.race.spirit={bg:"White"},t.Colors.race.undead={bg:"Black"},t.Colors.race.wildling={bg:"Brown"},t.Colors.race.wolfclan={bg:"Brown"},t.Colors.role={},t.Colors.role.archer="Yellow",t.Colors.role.berserker="Pink",t.Colors.role.commander="Yellow",t.Colors.role.elite="Cyan",t.Colors.role.fighter="Blue",t.Colors.role.king="Red",t.Colors.role.mage="Purple",t.Colors.role.slinger="Purple"},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=[{name:"bed",className:"cell-element-bed",char:"=",msg:{onEnter:"There is a bed here for resting"},addComp:["Indoor"]},{name:"bridge",className:"cell-element-bridge",char:"=",msg:{onEnter:"You are standing on a bridge."}},{name:"chasm",className:"cell-element-chasm",char:"~",addComp:["Impassable"]},{name:"grass",className:"cell-element-grass",char:'"',msg:{onEnter:"You see some grass."}},{name:"snowy grass",className:"cell-element-snowy-grass",char:'"',addComp:["Snowy"],msg:{onEnter:"You see some snow-covered grass."}},{name:"highrock",className:"cell-element-highrock",char:"^",addComp:["Impassable","Opaque"]},{name:"floor",className:"cell-element-floor",char:"."},{name:"floorcastle",className:"cell-element-floor-castle",char:".",addComp:["Indoor"]},{name:"floorcave",className:"cell-element-floor-cave",char:".",addComp:["Indoor"]},{name:"floorcrypt",className:"cell-element-floor-crypt",char:".",addComp:["Indoor"]},{name:"floorhouse",className:"cell-element-floor-house",char:".",addComp:["Indoor"]},{name:"floorwooden",className:"cell-element-floor-wooden",char:".",addComp:["Indoor"]},{name:"fort",className:"cell-element-fort",char:"#",addComp:["Impassable"]},{name:"lava",className:"cell-element-lava",char:"~",addComp:["Impassable"]},{name:"path",className:"cell-element-path",char:"."},{name:"road",className:"cell-element-road",char:".",msg:{onEnter:"You tread lightly on the road."}},{name:"sky",className:"cell-element-sky",char:"~",addComp:["Impassable"]},{name:"light snow",className:"cell-element-light-snow",char:".",addComp:["Snowy"],msg:{onEnter:"A thin layer of snow is on the ground"}},{name:"light snow with tracks",className:"cell-element-light-snow-tracks",char:".",addComp:["Snowy"],msg:{onEnter:"Someone has traversed this thin crust of snow"}},{name:"snow",className:"cell-element-snow",char:".",addComp:["Snowy"],msg:{onEnter:"Ground is covered with snow."}},{name:"snow with tracks",className:"cell-element-snow-tracks",char:".",addComp:["Snowy"],msg:{onEnter:"Someone has left their tracks on snow"}},{name:"deep snow",className:"cell-element-deep-snow",char:".",addComp:["Snowy"],msg:{onEnter:"Snow is deep and difficult to traverse here"}},{name:"deep snow with tracks",className:"cell-element-deep-snow-tracks",char:".",addComp:["Snowy"],msg:{onEnter:"Snow is deep, but there are some tracks here"}},{name:"stone",className:"cell-element-stone",char:"^"},{name:"tree",className:"cell-element-tree",char:"T",addComp:["Opaque"],msg:{onEnter:"There is a tree here."}},{name:"snow-covered tree",className:"cell-element-snow-tree",char:"T",addComp:["Opaque","Snowy"],msg:{onEnter:"There is a snow-covered tree here."}},{name:"water",className:"cell-element-water",char:"~",msg:{onEnter:"Water slows you down"}},{name:"frozen water",className:"cell-element-frozen-water",char:"~",addComp:["Snowy"],msg:{onEnter:"There is some ice here"}},{name:"closed window",className:"cell-element-window",char:"+",addComp:["Impassable"]},{dontCreate:!0,name:"web",char:"|",className:"cell-element-web"},{dontCreate:!0,name:"slime",char:"|",className:"cell-element-slime"},{dontCreate:!0,name:"hole",char:"^",className:"cell-element-hole"},{dontCreate:!0,name:"mountain",char:"^",className:"cell-element-mountain"},{dontCreate:!0,name:"town",char:"o",className:"cell-element-town"},{dontCreate:!0,name:"battle",char:"X",className:"cell-element-battle"},{dontCreate:!0,name:"cityfort",char:"o",className:"cell-element-fort"},{dontCreate:!0,name:"wallcastle",char:"#",className:"cell-element-castle"}]},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(16),i=n(s(2)),l=["actors","items","elements"],c=e=>{if(!e){const e="Possibly missing args for useItem().";r.default.err("effects.js","getTargetActor",`Given object was null/undefined. ${e}`)}if(e.hasOwnProperty("target")){const t=e.target;if(t.hasActors())return t.getProp("actors")[0]}return null},h=(e,t,s)=>{const a=new i.UseItem;a.setTarget(t),a.setItem(e),s&&a.setEffect(s);const n=r.default.getItemUseType(e,t);a.setUseType(n),e.getTopOwner().add(a)};t.Effects={effects:[{name:"use",func(e){if(this.getCharges&&0===this.getCharges()){const e=this.getName();return r.default.gameMsg(`${e} does not have any charges left`),!1}for(let t=0;t<this.useFuncs.length;t++)if(this.useFuncs[t].call(this,e))return!0;return!1}},{name:"addComp",requires:["name","duration"],optional:["setters"],func(e){const t={duration:this.useArgs.duration,effectType:"AddComp",name:this.useArgs.name,target:e,targetType:["actors","items"]};return this.useArgs.setters&&(t.setters=this.useArgs.setters),h(this,e,t),!0}},{name:"removeComp",requires:["name"],optional:["all"],func(e){const t={all:this.useArgs.all,effectType:"RemoveComp",name:this.useArgs.name,target:e,targetType:l};return h(this,e,t),!0}},{name:"modifyCompValue",requires:["name","set","get","value"],optional:["op"],func(e){const t={target:e,targetType:l,name:this.useArgs.name,set:this.useArgs.set,get:this.useArgs.get,value:this.useArgs.value,effectType:"ModifyCompValue"};return h(this,e,t),!0}},{name:"cure",requires:["effect"],func(e){const t=c(e);if(t){const e=this.useArgs.effect.capitalize();return t.has(e)?(t.remove(e),r.default.gameMsg(t.getName()+" seems to be cured of "+e)):r.default.gameMsg(this.getName()+" was wasted"),h(this,t),!0}return!1}},{name:"digger",func(e){const t=`${this.getTopOwner().getName()} digs through stone with ${this.getName()}`;return h(this,e,{effectType:"ChangeElement",fromType:"wall",target:e,startMsg:t,targetType:["elements"]}),!0}},{name:"heal",requires:["hp"],func(e){const t=c(e);if(t){const e=o.Dice.create(this.useArgs.hp).roll();if(t.has("Health"))return t.get("Health").addHP(e),h(this,t),r.default.gameMsg(t.getName()+" drinks "+this.getName()),!0}else r.default.gameWarn("Cannot see anyone there for using the potion.");return!1}},{name:"poison",requires:["duration","damage","prob"],func(e){const t=o.Dice.parseDieSpec(this.useArgs.damage),s=new o.Dice(t[0],t[1],t[2]),a={target:e,targetType:["actors","items"],name:"Poison",duration:this.useArgs.duration,effectType:"AddComp",setters:{setDamageDie:s,setProb:this.useArgs.prob,setSource:this.getTopOwner()}};return h(this,e,a),!0}},{name:"stun",requires:["duration"],func(e){const t=c(e);if(t){const e=function(e){const t=o.Dice.parseDieSpec(e);return new o.Dice(t[0],t[1],t[2]).roll()}(this.useArgs.duration),s=new i.Stun,a=new i.Expiration;a.addEffect(s,e);const n=this.getTopOwner();return s.setSource(n),t.add(s),t.add(a),h(this,t),r.default.gameMsg(t.getName()+" is stunned by "+this.getName()),!0}return!1}},{name:"modifyStat",requires:["statName","value"],func(e){const t={target:e,targetType:["actors"],name:"Stats",set:"set"+this.useArgs.statName.capitalize(),get:"get"+this.useArgs.statName.capitalize(),value:this.useArgs.value,effectType:"ModifyCompValue"};return h(this,e,t),!0}},{name:"addEntity",requires:["entityName"],optional:["duration"],func(e){const t={target:e,targetType:["cell"],entityName:this.useArgs.entityName,effectType:"AddEntity",duration:this.useArgs.duration};return h(this,e,t),!0}},{name:"addElement",requires:["elementName"],optional:["duration","numAllowed"],func(e){const t={target:e,targetType:["cell"],elementName:this.useArgs.elementName,effectType:"AddElement",duration:this.useArgs.duration,numAllowed:this.useArgs.numAllowed||1,successMsg:this.useArgs.successMsg,failureMsg:this.useArgs.failureMsg};return h(this,e,t),!0}},{name:"removeElement",requires:["elementName"],optional:["successMsg","failureMsg"],func(e){const t={target:e,targetType:["cell"],elementName:this.useArgs.elementName,effectType:"RemoveElement",successMsg:this.useArgs.successMsg,failureMsg:this.useArgs.failureMsg};return h(this,e,t),!0}}]}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(1),o=s(55),i=s(34);t.ActorGen={};const l=new r.Random,c={races:{},ranks:{},roles:{},roleBases:{}},h={range:1,danger:1,speed:100,brain:"GoalOriented",damage:"1d6",attack:1,defense:1,hp:5,protection:0,enemies:n.default.ACTOR_RACES,accuracy:5,agility:5,strength:5,magic:5,perception:5,willpower:5};c.races={arborean:{strength:3,willpower:5,type:"arborean",prefix:"arborean",char:"a",colorbg:"white"},elf:{strength:-1,agility:4,accuracy:4,magic:3,type:"elf",prefix:"elven",char:"e",colorbg:"green"},fae:{type:"fae",prefix:"fae",char:"f",colorbg:"purple",speed:10,strength:-2,magic:3,addComp:["Flying"]},gnome:{strength:-1,magic:3,perception:5,type:"gnome",prefix:"gnomish",char:"n",colorbg:"beige"},ogre:{strength:4,magic:-3,willpower:-3,type:"ogre",prefix:"ogre",char:"O",colorbg:"darkseagreen"},orc:{strength:2,magic:-2,willpower:-2,type:"orc",prefix:"orc",char:"o",colorg:"darkseagreen"},ratling:{agility:2,perception:4,type:"ratling",prefix:"ratling",char:"r",colorbg:"grey"},vachefolk:{strength:2,type:"vachefolk",prefix:"vachefolk",char:"v",colorbg:"brown"},valkyr:{strength:3,type:"valkyr",prefix:"valkyr",char:"V",colorbg:"darkblue",addComp:[i.resistance("ICE","MEDIUM")]}};const u=Object.keys(c.races);c.ranks={commoner:{danger:1,hp:5},adventurer:{danger:2,hp:10},sergeant:{danger:3,strength:1,hp:15},commander:{danger:5,strength:5,hp:20,equip:["Great battle axe","Steel armour","Steel helmet"]},steward:{danger:5,hp:20},lord:{danger:5,strength:7,hp:20},warlord:{danger:7,hp:25},captain:{danger:7,hp:25,strength:7,agility:3,accuracy:3},prince:{danger:5,hp:20},princess:{danger:5,agility:5,magic:5,hp:20},queen:{colorfg:"yellow",danger:10,hp:30,addComp:["FirstStrike"]},king:{colorfg:"red",strength:7,attack:7,defense:7,danger:12,hp:40},emperor:{colorfg:"purple",danger:15,strength:10,attack:10,defense:10,hp:50,addComp:[i.BypassComp(.15)]},empress:{colorfg:"palevioletred",danger:17,accuracy:10,agility:10,attack:10,defense:10,hp:45,addComp:[i.BypassComp(.25),"Charm"]},overlord:{danger:10,hp:35,addComp:[i.BypassComp(.1)]}};const d=Object.keys(c.ranks);c.roleBases={melee:{attack:2,defense:2,protection:2,danger:1},magic:{magic:3,willpower:2,danger:2,brain:"SpellCaster",maxPP:10,PP:10,addComp:["RegenEffect"]},ranged:{accuracy:3,agility:1,danger:2,addComp:[{random:["EagleEye","StrongShot","ThroughShot","LongRangeShot","RangedEvasion","CriticalShot"]}]},stealth:{defense:2,agility:3,perception:2,danger:1}},c.roles={melee:{axeman:{danger:2,hp:10},brave:{danger:2,hp:7,strength:2},duelist:{danger:3,hp:13,agility:3,strength:2},elite:{danger:5,hp:23,strength:4,addComp:["CounterAttack"]},fighter:{danger:2,hp:12,agility:1,strength:1},footman:{danger:1,equip:["Longsword"]},knight:{danger:4,hp:15,strength:4},phalanx:{danger:1,hp:10,defense:4,equip:["Spear"]},scourger:{danger:4,hp:20,attack:4,defense:4,strength:6},judicator:{danger:5,hp:30,attack:5,defense:5,strength:7,addComp:["FirstStrike"]},skirmisher:{danger:3,hp:15,attack:3,defense:3},hunter:{danger:2,hp:10,attack:3,defense:3},warrior:{danger:2,hp:10,attack:3,defense:3}},magic:{adept:{danger:1,pp:3,maxPP:3,hp:5,spells:["EnergyArrow"]},archmage:{danger:15,pp:40,maxPP:40,hp:30,spells:["PowerDrain",{random:["WaterBolt","SlimeBolt","FrostBolt"]},{random:["Heal","MagicArmor","Charm"]},{random:["IceArrow","PoisonArrow","ArrowOfWebs"]}]},bard:{danger:3,magic:5,pp:7,maxPP:7,hp:7,spells:["SummonAnimal"]},cleric:{danger:1,magic:2,willpower:3,pp:7,maxPP:7,spells:["Heal"]},healer:{danger:1,magic:2,pp:7,maxPP:7,spells:["Heal"]},mage:{danger:5,magic:5,willpower:5,hp:13,spells:[{random:["RingOfFire","RingOfFrost"]}]},telepath:{danger:4,pp:12,maxPP:12,hp:12,magic:4,willpower:4,spells:["SummonFlyingEyes","Telepathy"]},necromancer:{danger:5,pp:10,maxPP:10,hp:15,spells:["AnimateDead"]},runemage:{danger:3,pp:15,maxPP:15,hp:15,spells:["StunningTouch"]},shaman:{danger:3,pp:15,maxPP:15,hp:10,spells:["IcyPrison"]},summoner:{danger:7,pp:15,maxPP:15,hp:15,spells:[{random:["SummonKin","SummonAirElemental"]}]},wizard:{danger:10,maxPP:30,pp:30,hp:15,magic:7,willpower:7,spells:[{random:["CrossBolt","FrostBolt","LightningBolt"]},{random:["Heal","MagicArmor","Paralysis"]}]}},ranged:{arbalist:{danger:3,hp:10,equip:["Wooden crossbow",{name:"Wooden bolt",count:10}]},archer:{danger:3,hp:5,equip:["Wooden bow",{name:"Wooden arrow",count:10},"Steel bow",{name:"Steel arrow",count:15}]},bolter:{danger:4,hp:5,equip:["Steel crossbow",{name:"Steel bolt",count:7}]},rifleman:{danger:6,hp:15,equip:["Rifle",{name:"Steel bullet",count:7}]},darter:{danger:2,hp:5,speed:5,equip:[{name:"Iron dart",count:9}]},thrower:{danger:1,equip:[{name:"Throwing axe",count:7}]},catapulter:{danger:2,hp:15,strength:5,speed:-5,equip:[{name:"Large rock",count:4}]},sharpshooter:{danger:8,hp:20,accuracy:5,agility:5,equip:["Rifle",{name:"Steel bullet",count:10}],fovrange:7},slinger:{danger:1,hp:3,equip:[{name:"Rock",count:10}]}},stealth:{assassin:{danger:3,addComp:[i.resistance("POISON","MEDIUM")]},acrobat:{danger:2,brain:"Thief",speed:20},rogue:{},scout:{danger:2,speed:10,fovrange:7},thief:{danger:2,brain:"Thief"}}};const g=Object.keys(c.roles);t.ActorGen.genRandShell=function(){const e=l.getUniformInt(1,2),t=l.arrayGetRand(u),s=c.races[t],a=l.arrayGetRand(d),n=c.ranks[a],r=l.getUniqueItems(g,e),i=r.map(e=>c.roleBases[e]);let p="";const m=[],f=r.map(e=>{const t=c.roles[e],s=l.arrayGetRand(Object.keys(t));return p+=" "+s,m.push(s),t[s]}),y=[h,s,n].concat(i).concat(f),_=o.mixNewShell(y);return _.name="commoner"!==a?s.prefix+p+" "+a:s.prefix+p,_.roleTypes=r,_.roles=m,_},t.ActorGen.genActors=function(e){const s=[];for(let a=0;a<e;a++)s.push(t.ActorGen.genRandShell());return s}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(76),o=s(126),i=s(1),l=s(3),c=i.Random.getRNG(),h="#",u=":",d="+";class g{constructor(e){this.coord={},this.map=n.default.copy2D(e),this.trimEmpty(),this.x=0,this.y=0,this.w=e.length,this.h=e[0].length;let t=0,s=0;n.default.forEach2D(e,(e,a,n)=>{this.coord[n]||(this.coord[n]=[]),this.coord[n].push([e,a]),n===u?(t+=e,s+=a):n===d&&(this.door=[e,a])}),this.floor=this.coord[u],this.walls=this.coord[h];const a=Object.values(this.coord[h]).length;this.cX=Math.round(t/a),this.cY=Math.round(s/a),this.numFloor=a}getCenter(){return[this.cX,this.cY]}getBbox(){return{ulx:this.x,uly:this.y,lrx:this.x+this.w-1,lry:this.y+this.h-1}}trimEmpty(){}adjustCoord(e,t){const s=e-this.x,a=t-this.y;this.moveHouse(s,a)}moveHouse(e,t){this.x+=e,this.y+=t,Object.keys(this.coord).forEach(s=>{this.coord[s].forEach(s=>{s[0]+=e,s[1]+=t})}),this.cX+=e,this.cY+=t,this.door=[this.door[0]+e,this.door[1]+t]}addWindows(e){this.coord.windows=[];const t=this.coord[h].slice();let s=0;c.shuffle(t);const a={};t.forEach(e=>{a[e[0]+","+e[1]]=!0}),this.coord[d].forEach(e=>{a[e[0]+","+e[1]]=!1});for(let n=0;n<t.length&&s!==e;n++){const r=t[n],o=[];l.Geometry.getBoxAround(r[0],r[1],1).forEach(e=>{a[e[0]+","+e[1]]&&o.push(e)}),2===o.length&&(s<e||-1===e)&&this.windowPosOk(r,o)&&(this.coord.windows.push(r),a[r[0]+","+r[1]]=!1,++s)}return this.coord.windows.forEach(e=>{const t=this.walls.findIndex(t=>t[0]===e[0]&&t[1]===e[1]);this.walls.splice(t,1)}),s}windowPosOk(e,t){const[s,a]=e,[n,r]=t[0],[o,i]=t[1];return s===n?2===Math.abs(r-i):a===r&&2===Math.abs(n-o)}}t.House=g;t.HouseGenerator=class{constructor(){this.baseSizeX=3,this.baseSizeY=3}createHouse(e){const{cols:t,rows:s}=e,{fullHouse:a}=e,n=this.getGenParams(t,s),{genParamsX:i,genParamsY:l}=n;let{tilesX:h,tilesY:u}=n;if(!Number.isInteger(h)||!Number.isInteger(u)){if(!(h>1))return null;if(h=Math.floor(h),!(u>1))return null;u=Math.floor(u)}const d=new r.TemplateLevel(h,u);d.setFiller(o.Houses5x5.tiles.filler),d.setTemplates(o.Houses5x5.templates.all),d.setGenParams({x:i,y:l}),d.roomCount=-1,a&&(d.roomCount=h*u,d.roomCount-=1),d.setStartRoomFunc(o.Houses5x5.startRoomFunc),d.create();const p=new g(d.map);if(e.addWindows){const e=h*u;p.addWindows(c.getUniformInt(1,e))}return p}getGenParams(e,t){const s=this.baseSizeX,a=this.baseSizeY;let r=c.getUniformInt(1,3),o=c.getUniformInt(1,3),i=s+r+o,l=n.default.WATCHDOG;for(;e%i!=0&&(i=s+(r=c.getUniformInt(1,3))+(o=c.getUniformInt(1,3)),0!=--l););const h=e/i,u=[r,1,o];let d=c.getUniformInt(1,3),g=c.getUniformInt(1,3),p=a+d+g,m=n.default.WATCHDOG;for(;t%p!=0&&(p=a+(d=c.getUniformInt(1,3))+(g=c.getUniformInt(1,3)),0!=--m););return{tilesX:h,tilesY:t/p,genParamsX:u,genParamsY:[d,1,g]}}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(36),o=s(1);t.Houses5x5={tiles:{},templates:{},Models:{}};const i=o.Random.getRNG();t.Houses5x5.tiles.start1x1=["\nname:start1x1_A\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##","\nname:start1x1_B\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n.ABC.\nD#:##\nE:::#\nF:::#\n##+##","\nname:start1x1_C\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n.ABC.\nD#:#.\nE::##\nF:::#\n##+##","\nname:start1x1_D\nA=.\nB=.\nC=.\nD=#\nE=#\nF=#\n\n.ABC.\nD###.\nE::##\nF:::#\n##+##"],t.Houses5x5.tiles.start1xN=["\ndir:N\nstartY:max\nstartX:first\nname:start1xN_A\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##","\ndir:N\nstartY:max\nstartX:first\nname:start1xN_B\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD#:##\nE:::#\nF:::#\n##+##","\ndir:N\nstartY:max\nstartX:first\nname:start1xN_C\nA=:\nB=:\nC=:\nD=#\nE=#\nF=.\n\n#ABC#\nD:::#\nE#:##\nF#:#.\n.#+#.","\ndir:N\nstartY:max\nstartX:first\nname:start1xD_C\nA=#\nB=:\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##"],t.Houses5x5.tiles.start2xN=["\ndir:NE\nstartX:first\nstartY:max\nname:start2xN_A\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE::::\nF:::#\n##+##","\ndir:NW\nstartX:max\nstartY:max\nname:start2xN_B\nA=#\nB=:\nC=#\nD=#\nE=:\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##"],t.Houses5x5.tiles.start2xN=t.Houses5x5.tiles.start2xN.concat(t.Houses5x5.tiles.start1xN),t.Houses5x5.tiles.start=["\ndir:NEW\nname:entrance2\nA=:\nB=:\nC=:\nD=#\nE=:\nF=#\n\n#ABC#\nD:::#\nE::::\nF:::#\n##+##","\ndir:NW\nname:entrance3\nA=#\nB=:\nC=#\nD=#\nE=:\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##"],t.Houses5x5.tiles.corners=["\ndir:SE\nname:corner1\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD::::\nE::::\nF:::#\n#::##","\ndir:SEW\nname:corner2\nA=#\nB=#\nC=#\nD=:\nE=:\nF=#\n\n#ABC#\nD::::\nE::::\nF:::#\n##:##","\ndir:SE\nname:corner3\nA=.\nB=.\nC=.\nD=#\nE=#\nF=#\n\n.ABC#\nD####\nE::::\nF:::#\n##:##","\ndir:NSEW\nname:corner4\nA=:\nB=:\nC=:\nD=:\nE=:\nF=:\n\n#ABC#\nD::::\nE::::\nF::::\n#:::#"],t.Houses5x5.tiles.body=["\ndir:NS\nname:corridor\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n#:::#","\ndir:NSEW\nname:body1\nA=:\nB=:\nC=:\nD=:\nE=:\nF=:\n\n#ABC#\nD::::\nE:#::\nF::::\n#:::#","\ndir:NSEW\nname:body_cross\nA=:\nB=:\nC=:\nD=:\nE=:\nF=:\n\n#ABC#\nD:#::\nE###:\nF:#::\n#:::#"],t.Houses5x5.tiles.terms=["\ndir:S\nname:term3x1\nA=.\nB=.\nC=.\nD=.\nE=.\nF=#\n\n.ABC.\nD....\nE....\nF####\n#:::#","\ndir:S\nname:term3x2\nA=.\nB=.\nC=.\nD=.\nE=#\nF=#\n\n.ABC.\nD....\nE####\nF:::#\n#:::#","\ndir:S\nname:term3x3\nA=.\nB=.\nC=.\nD=#\nE=#\nF=#\n\n.ABC.\nD####\nE:::#\nF:::#\n#:::#","\ndir:S\nname:term3x4\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n#:::#"],t.Houses5x5.tiles.blocker="\nname:BLOCKER\nA=.\nB=.\nC=.\nD=.\nE=.\nF=.\n\n.ABC.\nD....\nE....\nF....\n.....",t.Houses5x5.tiles.filler="\nname:FILLER\nA=.\nB=.\nC=.\nD=.\nE=.\nF=.\n\n.ABC.\nD....\nE....\nF....\n.....",t.Houses5x5.startRoomFunc=function(){if(1===this.tilesX&&1===this.tilesY)return{x:0,y:0,room:i.arrayGetRand(t.Houses5x5.templates.start1x1)};if(1===this.tilesX){const e=t.Houses5x5.templates.start1xN.filter(e=>!/(R90|R270)/i.test(e.getProp("name"))),s=i.arrayGetRand(e);let a=this.tilesY-1;return/R180/i.test(s.getProp("name"))&&(a=0),{x:0,y:a,room:s}}if(1===this.tilesY){const e=t.Houses5x5.templates.start1xN.filter(e=>/(R90|R270)/i.test(e.getProp("name"))),s=i.arrayGetRand(e);let a=0;return/R270/i.test(s.getProp("name"))&&(a=this.tilesX-1),{x:a,y:0,room:s}}if(2===this.tilesX||2===this.tilesY){const e=t.Houses5x5.templates.start2xN,s=i.arrayGetRand(e);let a=0,n=0;return"max"===s.getProp("startX")&&(a=this.tilesX-1),"max"===s.getProp("startY")&&(n=this.tilesY-1),{x:a,y:n,room:s}}const e=Math.floor(this.tilesX/2),s=Math.floor(this.tilesY/2),a=i.arrayGetRand(t.Houses5x5.tiles.start),n=r.Template.createTemplate(t.Houses5x5.tiles.blocker);for(let t=s;t<this.tilesY;t++)this.addRoom(n,e,t);return{x:e,y:s,room:r.Template.createTemplate(a)}},t.Houses5x5.Models.default=[].concat(t.Houses5x5.tiles.terms).concat(t.Houses5x5.tiles.body).concat(t.Houses5x5.tiles.corners),t.Houses5x5.tiles.all=t.Houses5x5.Models.default;function l(e){const t=e.getProp("startX"),s=e.getProp("startY");n.default.isNullOrUndef([t])||e.setProp("startY",t),"max"===s?e.setProp("startX","first"):"first"===s&&e.setProp("startX","max")}["all","start1x1","start1xN","start2xN"].forEach(e=>{t.Houses5x5.templates[e]=t.Houses5x5.tiles[e].map(e=>r.Template.createTemplate(e));const s=r.Template.transformList(t.Houses5x5.templates[e]);t.Houses5x5.templates[e]=t.Houses5x5.templates[e].concat(s)}),t.Houses5x5.templates.start2xN.forEach(e=>{const t=e.getProp("name");/_flip/.test(t)&&function(e){const t=e.getProp("startX");"max"===t?e.setProp("startX","first"):"first"===t&&e.setProp("startX","max")}(e),/R90/i.test(t)?l(e):/R180/i.test(t)?(l(e),l(e)):/R270/i.test(t)&&(l(e),l(e),l(e))})},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(12));s(29),t.MapForest=function(e,t,s){n.default.Map.call(this,e,t),this._options={nForests:5,forestSize:100,factor:6,rng:n.default.RNG};for(const e in s)this._options.hasOwnProperty(e)&&(this._options[e]=s[e])},t.MapForest.extend(n.default.Map),t.MapForest.prototype.create=function(e){const t=this._options.rng;this.map=this._fillMap(0);for(let e=0;e<this._options.nForests;e++){const e=t.getUniformInt(0,this._width-1),s=t.getUniformInt(0,this._height-1);this.drawForest(e,s,this._options.forestSize)}if(e)for(let t=0;t<this._height;t++)for(let s=0;s<this._width;s++)e(s,t,this.map[s][t])},t.MapForest.prototype.inBounds=function(e,t){return e>=0&&e<this._width&&t>=0&&t<this._height},t.MapForest.prototype.drawForest=function(e,t,s){let a=e,n=t;const r=this._options.rng;for(let e=1;e<=s;e++){const e=r.getUniformInt(0,this._options.factor),t=r.getUniformInt(0,this._options.factor),s=r.getUniformInt(0,this._options.factor),o=r.getUniformInt(0,this._options.factor);1===e&&(a-=1,this.inBounds(a,n)&&(this.map[a][n]=1)),1===s&&(a+=1,this.inBounds(a,n)&&(this.map[a][n]=1)),1===t&&(n+=1,this.inBounds(a,n)&&(this.map[a][n]=1)),1===o&&(n-=1,this.inBounds(a,n)&&(this.map[a][n]=1))}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(12)),r=a(s(0)),o=s(3),i=s(15);s(29);const l=s(8)("bitn:Map.Miner");t.MapMiner=function(e,t,s={}){n.default.Map.call(this,e,t,{});const a=e>t?t:e,r=Math.floor(e*t/a),o=Math.round(this._width/2),i=Math.round(this._height/2);if(this._options={addMiners:[],dontDig:!1,maxMinersCreated:r,minerSpawnProb:.07,smooth:!0,rng:n.default.RNG,startX:o,startY:i,nSmooth:2,dirWeights:{N:1,NE:1,E:1,SE:1,S:1,SW:1,W:1,NW:1}},!s.dirWeights){const s=e>t?t:e;Object.keys(this._options.dirWeights).forEach(a=>{this._options.dirWeights[a]*="W"===a||"E"===a?6*e:"S"===a||"N"===a?t:s})}for(const e in s)this._options.hasOwnProperty(e)&&(this._options[e]=s[e]);if(s.maxMinersOp){let e=this._options.maxMinersCreated;const{op:t,value:a}=s.maxMinersOp;switch(t){case"+":e+=a;break;case"-":e-=a;break;case"/":e/=a;break;case"*":e*=a;break;default:console.warn(`Op ${t} illegal`)}this._options.maxMinersCreated=Math.round(e)}this._hist={minerDir:{}},this._verifyRngFunctions()},t.MapMiner.extend(n.default.Map),t.MapMiner.prototype.dbg=function(e,...t){l.enabled&&console.log(e,...t)};t.MapMiner.prototype.create=function(e){const t=this._options.rng;this._map=this._fillMap(1);const s=this._options.maxMinersCreated,a=this._options.minerSpawnProb;let n=[{id:0,x:this._options.startX,y:this._options.startY,dirWeights:this._options.dirWeights}];this.minerID=1,Array.isArray(this._options.addMiners)&&this._options.addMiners.forEach(e=>{if(this.inBounds(e.x,e.y)){const t=Object.assign({},e);t.id=this.minerID++,t.dirWeights||(t.dirWeights=this._options.dirWeights),n.push(t)}else console.error(e,"out of level mining bounds. Not added")}),n.forEach(e=>{r.default.isNullOrUndef([e.x,e.y])?r.default.err("Map.Miner","create",`miner.x,y must exist. ${e}`):this._markAsDug(e.x,e.y)});let o=0,i=0,c=0,h=[],u=[],d=0;for(;i<s&&(l.enabled&&this.printMap(),this.dbg("Active miners: "+n.length),n.forEach(e=>{const[s,r]=this._getXYToDig(e);if(0===this._map[s][r]&&n.length>1)h.push(e);else if(this.inBounds(s,r)){if(t.getUniform()<=a){const t=this._tryToAddNew(e,s,r);t&&(u.push(t),++o),++i}this._markAsDug(s,r,e),e.x=s,e.y=r}else h.push(e)}),h.forEach(e=>{const t=n.findIndex(t=>e.id===t.id);if(n.length>1){const{id:s,x:a,y:r}=e;this.dbg(`remove miner ${s} at ${a}, ${r}`),++c,n.splice(t,1)}}),n=n.concat(u),u=[],h=[],!(d>100*this._width*this._height))&&0!==n.length;)++d;if(this._options.smooth&&this.smoothWalls(2),this.connect(),e)for(let t=0;t<this._height;t++)for(let s=0;s<this._width;s++)e(s,t,this._map[s][t]);this._hist.minersSpawned=i,this._hist.minersAdded=o,this._hist.minersRemoved=c},t.MapMiner.prototype._tryToAddNew=function(e,t,s){let[a,r]=this._getXYToDig({x:t,y:s,dirWeights:e.dirWeights}),o=null;const i=this._options.rng;if(1===this._map[t][s]&&this.inBounds(a,r))o={id:this.minerID++,x:a,y:r},e.dugCallback&&(o.dugCallback=e.dugCallback),this._markAsDug(a,r,o),this.dbg(e,"spawned new miner:",o);else{const t=i.getUniformInt(0,7),s=n.default.DIRS[8][t];a+=s[0],r+=s[1],this.inBounds(a,r)&&(o={id:this.minerID++,x:a,y:r},e.dugCallback&&(o.dugCallback=e.dugCallback),this._markAsDug(a,r,o),this.dbg(e,"(else) spawned new miner:",o))}return o&&(o.dirWeights=e.dirWeights),o},t.MapMiner.prototype.printMap=function(){for(let e=0;e<this._height;e++){let t="";for(let s=0;s<this._width;s++)t+=1===this._map[s][e]?"#":".";console.log(t)}},t.MapMiner.prototype._getXYToDig=function(e){const t=this._options.rng,s=o.Geometry.getBoxAround(e.x,e.y,1).filter(e=>1===this._map[e[0]][e[1]]&&this.inBounds(e[0],e[1]));if(0===s.length)return this.dbg("No wall cells around "+e.x+", "+e.y),[e.x,e.y];this.dbg("UndugXY is now "+s);const a=s.map(t=>{const s=[t[0]-e.x,t[1]-e.y];return r.default.dXdYToDir(s)}),n=e.dirWeights,i={};if(a.forEach(e=>{n[e]&&(i[e]=n[e])}),0===Object.keys(i).length)return[e.x,e.y];l.enabled&&this.dbg("dirsLeft: "+JSON.stringify(i));let c=t.getWeightedValue(i),h=r.default.dirTodXdY(c),[u,d]=[e.x+h[0],e.y+h[1]];for(this.dbg(`dir: ${c}, COMP: dXdY: ${h}, x,y: ${u},${d}`),this._hist.minerDir[c]||(this._hist.minerDir[c]=0),this._hist.minerDir[c]+=1;0===this._map[u][d]&&(delete i[c],0!==Object.keys(i).length);)c=t.getWeightedValue(i),h=r.default.dirTodXdY(c),[u,d]=[e.x+h[0],e.y+h[1]],this.dbg(`dir: ${c}, COMP: dXdY: ${h}, x,y: ${u},${d}`),this._hist.minerDir[c]||(this._hist.minerDir[c]=0),this._hist.minerDir[c]+=1;return this.dbg(`Next x,y to dig is ${u},${d}`),[u,d]},t.MapMiner.prototype.inBounds=function(e,t){if(this._options.dontDig)if(this._options.dontDig.ulx){const{ulx:s,uly:a,lrx:n,lry:r}=this._options.dontDig;if(e>=s&&e<=n&&t>=a&&t<=r)return!1}else if(this._options.dontDig[e+","+t])return!1;return e>=1&&e<this._width-1&&t>=1&&t<this._height-1},t.MapMiner.prototype.connect=function(){const{addMiners:e}=this._options;let t=!0;const s={},a={};if(e.length>0){const n=e.map(e=>[e.x,e.y]);n.push([this._options.startX,this._options.startY]);let r=-1;n.forEach(e=>{const n={},i=o.Geometry.floodfill2D(this._map,e,0,n,!0);if(0===i.length){throw new Error(`Floodfill from: ${e} returned 0 cells`)}const l=e[0]+","+e[1];s[l]=i,a[l]=n,-1===r?r=i.length:r!==i.length&&(t=!1)})}t?this._regions=[]:this.connectFilledRegions(s,a)},t.MapMiner.prototype.connectFilledRegions=function(e,t){const s={};let a=0,n=null;const r=this._options.rng;Object.keys(e).forEach(t=>{const r=e[t];s[t]=o.Geometry.getMassCenter(r),r.length>a&&(a=r.length,n=t)});const i=[];this._regions=[],this._regions.push([e[n]]),Object.keys(s).forEach(s=>{if(s!==n){t[s][n]||(i.push(s),this._regions.push([e[s]]))}});const[l,c]=s[n];this._paths=[],i.forEach(e=>{const[t,a]=s[e],n=this._getPath(l,c,t,a);n.forEach(e=>{let t=r.getUniformInt(1,3);this._options.connWidth&&(t=this._options.connWidth),o.Geometry.getCrossCaveConn(e.x,e.y,t,!0).forEach(e=>{const[t,s]=e;this.inBounds(t,s)&&(this._map[t][s]=0)})}),this._paths.push(n)})},t.MapMiner.prototype.getMapData=function(){const e=this._options.addMiners,t=e.map(e=>[e.x,e.y]);return t.push([this._options.startX,this._options.startY]),{nRegions:1+e.length,regions:this._regions,startPoints:t,paths:this._paths}},t.MapMiner.prototype._getPath=function(e,t,s,a){return i.Path.getShortestPath(e,t,s,a)},t.MapMiner.prototype.smoothWalls=function(e){for(let t=0;t<e;t++)for(let e=1;e<this._width-1;e++)for(let t=1;t<this._height-1;t++)if(1===this._map[e][t]){const s=o.Geometry.getCrossAround(e,t,1);let a=0;s.forEach(e=>{this.inBounds(e[0],e[1])&&this._map[e[0]][e[1]]&&++a}),this.inBounds(e,t)&&a<this._options.nSmooth&&this._markAsDug(e,t)}},t.MapMiner.prototype._markAsDug=function(e,t,s){e<this._minX&&(this._minX=e),e>this._maxX&&(this._maxX=e),t<this._minY&&(this._minY=t),t>this._maxY&&(this._maxY=t),this._map[e][t]=0,this._options.dugCallback&&this._options.dugCallback(e,t,s),s&&s.dugCallback&&s.dugCallback(e,t,s)},t.MapMiner.prototype._verifyRngFunctions=function(){const{rng:e}=this._options,t=["getUniform","getUniformInt","getWeightedValue"];t.forEach(s=>{if("function"!=typeof e[s]){let e=`RNG must have functions: ${t}.`;throw new Error(e+="See ROT.RNG for example (you can use it)")}})}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(12)),r=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];t.MapMountain=function(e,t,s){if(n.default.Map.call(this,e,t),this._options={gradients:r,noiseMult:1,noiseDivider:20,rng:n.default.RNG},s)for(const e in this._options)this._options.hasOwnProperty(e)&&s.hasOwnProperty(e)&&(this._options[e]=s[e]);this.noise=new n.default.Noise.Simplex},t.MapMountain.extend(n.default.Map),t.MapMountain.prototype.create=function(e){const t=this._fillMap(0);for(let e=0;e<this._width;e++)for(let s=0;s<this._height;s++){const a=this.noise.get(e/this._options.noiseDivider,s/this._options.noiseDivider)*this._options.noiseMult;t[e][s]=a}for(let s=0;s<this._width;s++)for(let a=0;a<this._height;a++)e(s,a,t[s][a])},t.MapMountain.gradients=r},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(12));function r(e,t,s){const a=2*s+1;let n=0;for(let a=t-s;a<=t+s;a++)a>=0&&a<e.length&&(n+=e[a]);return Math.floor(n/a)}s(29),t.MapWall=function(e,t,s){if(n.default.Map.call(this,e,t),this._options={north:!1,south:!1,east:!0,west:!0,alignVertical:"center",alignHorizontal:"center",meanWx:5,meanWy:5,stdDev:3,filterW:3,rng:n.default.RNG},s)for(const e in this._options)this._options.hasOwnProperty(e)&&s.hasOwnProperty(e)&&(this._options[e]=s[e])},t.MapWall.extend(n.default.Map),t.MapWall.prototype.create=function(e){const t=this._fillMap(0),s=this._options.north,a=this._options.south,n=this._options.east,r=this._options.west,{alignVertical:o,alignHorizontal:i}=this._options,l=this._width,c=this._height,h=Math.floor(l/2),u=Math.floor(c/2),d=this._options.meanWx,g=this._options.meanWy,p=this._options.stdDev,m=this._options.filterW;let f=null,y=-1,_=-1;s&&a?(y=0,_=c-1):s?(y=0,_=u-1):a&&(y=u,_=c-1),this._wallNS=[];let E=this.getWidthMovingAvg(_+1,d,p,l,m);if(s||a)for(let e=y;e<=_;e++){const s=[];1===(f=E[e-y])&&(f=d);let a=h-(f-1),n=h+(f-1);"center"===i||("left"===i?n=(a=0)+(f-1):"right"===i&&(a=this._width-(f-1),n=this._width-1));for(let r=a;r<=n;r++)t[r][e]=1,s.push([r,e]);this._wallNS.push(s)}let S=-1,v=-1;if(n&&r?(S=0,v=l-1):n?(S=h,v=l-1):r&&(S=0,v=h-1),this._wallEW=[],E=this.getWidthMovingAvg(v+1,g,p,c,m),n||r)for(let e=S;e<=v;e++){const s=[];1===(f=E[e-S])&&(f=g);let a=u-(f-1),n=u+(f-1);"center"===o||("top"===o?n=(a=0)+(f-1):"bottom"===o&&(a=this._height-(f-1),n=this._height-1));for(let r=a;r<=n;r++)t[e][r]=1,s.push([e,r]);this._wallEW.push(s)}for(let s=0;s<this._width;s++)for(let a=0;a<this._height;a++)e(s,a,t[s][a])},t.MapWall.prototype.getWidthMovingAvg=function(e,t,s,a,n){const o=[];for(let n=0;n<e;n++)o.push(this.getWallWidth(t,s,a));let i=[];for(let e=0;e<n;e++)i.push(o[e]);for(let t=n;t<e-n;t++){const e=r(o,t,n);i.push(e)}for(let t=e-n;t<e;t++)i.length<o.length&&i.push(o[t]);return i=i.map(e=>Math.round(e))},t.MapWall.prototype.getWallWidth=function(e,t,s){const a=this._options.rng;let n=Math.floor(a.getNormal(e,t));return n>s/2?n=s/2-1:n<1&&(n=1),n}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ActorMods={},t.ActorMods.bearfolk={description:"",stats:{agility:-2,strength:3},player:{}},t.ActorMods.catfolk={stats:{agility:3,perception:2,strength:-2},player:{}},t.ActorMods.dogfolk={stats:{agility:2,perception:3},player:{}},t.ActorMods.dwarf={stats:{agility:-1,strength:2,willpower:1},player:{}},t.ActorMods.goblin={stats:{accuracy:1,agility:2},player:{}},t.ActorMods.human={stats:{accuracy:3,magic:1,willpower:1},player:{}},t.ActorMods.hyrkhian={stats:{magic:2,willpower:2},player:{}},t.ActorMods.wildling={stats:{accuracy:1,agility:1,perception:4},player:{}},t.ActorMods.wolfclan={stats:{strength:1,magic:2,willpower:2},player:{}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=n(s(2)),i=n(s(5)),l=n(s(19)),c=n(s(32)),h=s(57),u=s(34),d=s(33),g=s(59),p=s(60),m=s(52),f=s(25),y=s(14),_=s(1),E=s(44),S=s(133),v=s(134),C=s(9),b=s(61),T=s(7),A=s(38),w=s(17),O=s(39),M=s(21),P=s(63),N=s(151),I=s(75),D=T.EventPool.getPool(),L=_.Random.getRNG(),R=i.ElementStairs;t.DebugGame=function(e,t){this._fact=e,this._parser=t},t.DebugGame.prototype.createArena=function(e,t,s){I.Room.rng=L;const a=this._parser,n=e.sqrPerItem;e.cols=100,e.rows=100;const[c,g]=[50,50],p=this.createLastBattle(t,e);p.addActor(s,c,g);const y=new M.World.CityQuarter("Debug quarter");y.addLevel(p),p.getExtras().shops.forEach(e=>{y.addShop(e)});const _=new M.World.City("Wrapper city for Debug quarter");_.addQuarter(y),_.tileX=0,_.tileY=0;const S=new M.World.Area("Wrapper area",2,2,10,10);S.addZone("City",_);const T=new M.World.WorldTop("Wrapper world");T.addArea(S),t.addPlace(T);const A=this._parser.createActor("Wolf spirit");A.get("Stats").setStrength(500),p.addActor(A,2,1);const w=new l.SpiritGem("Lesser gem");p.addItem(w);const O=this._parser.createActualObj("items","Pick-axe");p.addItem(O,2,2);const P=this._parser.createActualObj("items","Potion of frost poison");P.setCount(5),p.addItem(P,2,2);const D=this._parser.createActualObj("items","Potion of cure poison");p.addItem(D,3,2);const R=this._parser.createActualObj("items","Rifle"),x=this._parser.createActualObj("items","Steel bullet");x.setCount(100),p.addItem(R,1,1),p.addItem(x,1,1);const k=this._parser.createActualObj("actors","shopkeeper"),B=new l.GoldCoin;B.setCount(50),k.getInvEq().addItem(B),p.addActor(k,2,2);const G=p.getMap().getFree().length,W={itemsPerLevel:Math.round(G/n),func:e=>e.value<=2500,maxValue:2500,food:()=>!0,gold:()=>!1};this._fact.addNRandItems(p,this._parser,W);const F=p.getMap().cols,Y=p.getMap().rows,X=this._parser.createActor("Thabba, Son of Ice");p.addActor(X,F-2,Y-2);const $=this._parser.createActor("Cryomancer");p.addActor($,1,Y-2);const j=this._parser.createActualObj("items","Potion of spirit form");s.getInvEq().addItem(j);const V=this._parser.createItem("Potion of strength");s.getInvEq().addItem(V),s.add(new o.Attacker),s.add(new o.Defender),s.add(new o.MasterEquipper),s.add(new o.BiDirStrike),s.add(new o.BiDirStrike),s.add(new o.ThroughShot),new N.WinCondition("Kill a keeper",t.getPool()).addActorKilled(k),t.addPlayer(s),s.getInvEq().getEquipment().addSlot("spiritgem",new m.EquipSlot("spiritgem"));const U=this._parser.createItem("Lesser spirit gem"),K=this._parser.createItem("Greater spirit gem");s.getInvEq().addItem(U),s.getInvEq().addItem(K),s.add(new o.SpiritItemCrafter);const H=new i.ElementExploration;H.setExp(100),p.addElement(H,1,20);const q=this.createTrainer();p.addActor(q,1,2);const J=new l.GoldCoin;J.setCount(600),s.getInvEq().addItem(J);const Q=new E.Spell.SpellBook(s);s.setBook(Q),E.Spell.addAllSpells(Q),s.add(new o.SpellPower),s.get("SpellPower").setPP(100);const z=new v.VirtualActor("spawner"),Z=new d.BrainSpawner(z);Z.setConstraint({op:"lt",prop:"danger",value:10}),z.setBrain(Z),p.addVirtualProp(r.default.TYPE_ACTOR,z);const ee=this._parser.createActor("Fire"),te=new o.Fading;te.setDuration(20),ee.add(te),p.addActor(ee,7,1);const se=this._parser.createActor("thunderbird");p.addActor(se,20,1);const ae=a.createEntity("firemaking kit");s.getInvEq().addItem(ae),s.get("SpellPower").setPP(100),s.get("SpellPower").setMaxPP(100);const ne=new f.ItemRandomizer,re=a.createItem("rune of protection");ne.adjustItem(re,100),s.getInvEq().addItem(re);const oe=a.createItem("rune of tunneling");ne.adjustItem(oe,100),s.getInvEq().addItem(oe);const ie=a.createItem("rune of force");ne.adjustItem(ie,100),s.getInvEq().addItem(ie);const le=new i.ElementLever;p.addElement(le,2,1);for(let e=0;e<3;e++){const t=new i.ElementLeverDoor;le.addTarget(t),p.addElement(t,3+e,1)}const ce=s.get("Abilities"),he=new h.Ability.Camouflage;ce.addAbility(he);const ue=new h.Ability.Sharpener;ce.addAbility(ue),this.addGoblinWithLoot(p);const de=a.createItem("rune of control");ne.adjustItem(de,250),s.getInvEq().addItem(de);const ge=a.createItem("rune of venom");ne.adjustItem(ge,150),s.getInvEq().addItem(ge);const pe=a.createItem("rune of poison clouds");ne.adjustItem(pe,150),s.getInvEq().addItem(pe);const me=a.createItem("Void dagger");s.getInvEq().addItem(me),s.getInvEq().unequipItem("hand",1,0),s.getInvEq().equipItem(me);const fe=a.createItem("shovel");s.getInvEq().addItem(fe);const ye=a.createItem("machete");s.getInvEq().addItem(ye);const _e=a.createItem("rune of webs");s.getInvEq().addItem(_e);const Ee=a.createActor("bearfolk thief");p.addActor(Ee,c+1,g+1),s.getInvEq().addItem(a.createItem("Boots of flying"));const Se=new o.RegenEffect;Se.setPP(2),Se.setWaitPP(0),Se.setMaxWaitPP(0),s.add(Se),p.getMap().setBaseElemXY(c-1,g-1,C.ELEM.WATER),u.ActorsData.filter(e=>"UniqueBase"===e.base).forEach(e=>{const{name:t}=e,s=a.createActor(t);s?p.addActorToFreeCell(s):r.default.warn("DebugGame","creating uniques","Failed to create unique actor: "+t)});const ve=new b.QuestPopulate,Ce=new l.Book("Book of shadows");Ce.addText("In the land of mordor where shadows lie..."),s.getInvEq().addItem(Ce);const be=new b.Quest("Report info to actor",["<goto>already_there","<report>listen","<goto>already_there","report"]);ve.mapQuestToResources(be,_,null),ve.addQuestComponents(_);const Te=p.getActors(),Ae=Te.find(e=>e.has("QuestGiver"));Ae.get("QuestGiver").setReward({type:"item",name:"Ruby glass mace"}),p.moveActorTo(Ae,c+1,g),Te.filter(e=>e.has("QuestTarget")).forEach((e,t)=>{p.moveActorTo(e,c,g+1+t),e.get("Stats").setSpeed(10)});const we=new o.Weather;we.setWeatherType("snowStorm"),p.add(we);const Oe=new v.WeatherActor("Weather actor");p.addVirtualProp(r.default.TYPE_ACTOR,Oe);const Me=p.getMap().getCells(e=>e.isFree());for(let e=0;e<200;e++){const e=L.arrayGetRand(Me),[t,s]=e.getXY();p.addElement(new i.ElementWeb,t,s),p.getMap().hasXY(t+1,s+1)&&p.addElement(new i.ElementSlime,t+1,s+1)}const Pe=p.getMap().getCells(e=>e.hasPropType("floorhouse"));for(let e=0;e<40;e++){L.arrayGetRand(Pe).setBaseElem(C.ELEM.BED)}const Ne=new o.Charm({level:10});s.add(Ne);const Ie=new o.Lore({});Ie.addTopic("quests",Ae.getName()+" is looking for someone."),p.add(Ie);const De=a.createActor("necrowurm");return p.addActor(De,s.getX()-1,s.getY()),t},t.DebugGame.prototype.createQuestsDebug=function(e,t,s){const a={name:"Quest test world",nAreas:1,area:[(new P.WorldCreator).createSingleAreaConf(0,{maxX:2,maxY:2})]},n=(new O.FactoryWorld).createWorld(a),r=n.getZones("City")[0].getLevels()[0],o=Math.floor(r.getMap().cols/2),i=Math.floor(r.getMap().rows/2);return r.addActor(s,o,i),t.addPlace(n),t.addPlayer(s),t},t.DebugGame.prototype.createTrainer=function(){const e=this._parser.createActor("fighter");e.setName("Old trainer");const t=new o.Trainer;return t.getChatObj().setTrainer(e),e.add(t),e},t.DebugGame.prototype.addGoblinWithLoot=function(e){const t=this._parser.createActor("goblin");t.setName("goblin with loot");const s=new o.Loot(new l.Weapon("sword"));t.add(s),e.addActor(t,2,10)},t.DebugGame.prototype.createDebugBattle=function(e,t,s){const a=new g.Battle("Battle of ice kingdoms"),n=new g.Army("Blue army"),r=new g.Army("Red army");this.addActorsToArmy(n,10,"warlord"),this.addActorsToArmy(r,10,"Winter demon");const o=(new w.FactoryLevel).createLevel("arena",60,30);return a.setLevel(o),a.addArmy(n,1,1,{}),a.addArmy(r,1,2,{}),t.addBattle(a),t.addPlayer(s),t},t.DebugGame.prototype.addActorsToArmy=((e,t,s)=>{for(let a=0;a<t;a++){const t=this._parser.createActualObj("actors",s);t.setFOVRange(10),e.addActor(t)}}),t.DebugGame.prototype.createOneDungeonAndBoss=function(e,t,s){const{cols:a,rows:n,nLevels:r,sqrPerActor:i,sqrPerItem:c}=e;let h=1;const u=["rooms","rogue","digger"],d=[],g=[],p=new M.World.Branch("StartBranch"),m=e=>t=>t.value<=e;for(let e=0;e<r;e++){let t=u[L.randIndex(u)];0===e&&(t="ruins");const s=this._fact.createLevel(t,a,n);p.addLevel(s);const r=s.getMap().getFree().length,o=Math.round(r/i),h=Math.round(r/c),d=new l.Potion("Healing potion");s.addItem(d);const f=this._parser.createActualObj("items","Shuriken");f.setCount(20),s.addItem(f);const y=20*(e+1),_={itemsPerLevel:h,func:m(y),maxValue:y,food:()=>!0};this._fact.addNRandItems(s,this._parser,_);const E={actorsPerLevel:o,maxDanger:e+1};this._fact.addNRandActors(s,this._parser,E),g.push(s)}const f=g.slice(-1)[0],y=f.getFreeRandCell(),_=this._fact.createActor("Summoner",{hp:100,att:10,def:10});_.setType("summoner"),_.get("Experience").setExpLevel(10),f.addActor(_,y.getX(),y.getY());const E=this.createLastBattle(t,{cols:80,rows:60});t.addLevel(E),E.setLevelNumber(h++),p.connectLevels(),t.addPlace(p);const S=new R(!0,g[r-1],E),v=new o.Loot(S);_.add(v),d.push(S);const C=d.slice(-1)[0],b=new R(!1,E,f),T=E.getFreeRandCell();E.addStairs(b,T.getX(),T.getY()),b.setTargetStairs(C),C.setTargetStairs(b);for(let e=0;e<10;e++){const e="Townsman",t=this._fact.createActor(e,{brain:"Human"});t.setType("human");const s=E.getFreeRandCell();E.addActor(t,s.getX(),s.getY())}if(null!==e.loadedLevel){const t=e.loadedLevel;t<=r?g[t-1].addActorToFreeCell(s):g[0].addActorToFreeCell(s)}return t.addPlayer(s,{place:"StartBranch"}),t},t.DebugGame.prototype.createLastBattle=function(e,t){const s=A.Factory.cityConfBase({});s.parser=this._parser,s.nShops=5;const a=e=>e.type===L.arrayGetRand(r.default.SHOP_TYPES);for(let e=0;e<s.nShops-1;e++)s.shopFunc.push(a);s.actorFunc=(e=>"bearfolk"===e.type),s.hasWall=!1;const n=(new p.CityGenerator).create(t.cols,t.rows,s);return this._listener=new x(this,e,n),this._fact.createHumanArmy(n,this._parser),n.setOnFirstEnter(()=>{const t=new c.OneShotEvent(this._fact.createDemonArmy.bind(this._fact,n,this._parser),2e3,"Demon hordes are unleashed from the unsilent abyss!");e.addEvent(t)}),n.setOnEnter(()=>{this._savedPlayerFOV=e.getPlayer().getFOVRange(),e.getPlayer().setFOVRange(20)}),n.setOnExit(()=>{e.getPlayer().setFOVRange(this._savedPlayerFOV)}),n};const x=function(e,t,s){this._game=t,this._level=s,this._maxBeasts=0,this._maxDemons=0,this._beastsKilled=0,this._demonsKilled=0,this.hasNotify=!0,this.notify=function(e,t){if(e===r.default.EVT_ACTOR_CREATED){if(t.hasOwnProperty("msg")&&"DemonSpawn"===t.msg){const e=t.actor;"Winter demon"===e.getName()&&++this._maxDemons,"Blizzard beast"===e.getName()&&++this._maxBeasts}}else if(e===r.default.EVT_ACTOR_KILLED){const e=t.actor;"Winter demon"===e.getName()?(++this._demonsKilled,this._demonsKilled===this._maxDemons&&this.allDemonsKilled(),r.default.debug(this,"A winter demon was slain! #"+this._demonsKilled),r.default.debug(this,"Max demons: "+this._maxDemons)):"Blizzard beast"===e.getName()&&(++this._beastsKilled,this._beastsKilled===this._maxBeasts&&this.allBeastsKilled())}},D.listenEvent(r.default.EVT_ACTOR_CREATED,this),D.listenEvent(r.default.EVT_ACTOR_KILLED,this),this.addSnow=((e,t)=>{const s=e.getMap();y.MapGenerator.addRandomSnow(s,t)}),this.allDemonsKilled=(()=>{r.default.gameMsg("Humans have vanquished all demons! But it's not over..");const t=new c.OneShotEvent(this.addSnow.bind(this,this._level,.2),2e3,"Winds are blowing stronger. You feel it's getting colder");this._game.addEvent(t);const s=new c.OneShotEvent(()=>{},3500,S.Texts.battle.eyeOfStorm);this._game.addEvent(s);const a=new c.OneShotEvent(e.createBeastArmy.bind(e,this._level,this._parser),5e3,"Winter spread by Blizzard Beasts! Hell seems to freeze.");this._game.addEvent(a)}),this.allBeastsKilled=(()=>{r.default.gameMsg(S.Texts.battle.beastsSlain);const e=new c.OneShotEvent(()=>{},1e3,S.Texts.battle.enemiesDead);this._game.addEvent(e);const t=new c.OneShotEvent(()=>{},2e3,"Battles in the North will continue soon in larger scale...");this._game.addEvent(t)})}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Texts={},t.Texts.intro={},t.Texts.intro.chapter1="\nWelcome to the wintry realms!\nWinds are ever-blowing. Blowing off the\nglaciers.\nAre you ready to face the challenges of the\nicy north? Hunger, coldness, ravenous\nbeasts, glacial chasms and forthcoming\neternal winter are waiting for you in the\ndarkness.\n",t.Texts.intro.chapter2="\nYou have come a long way from your homelands\nseeking\nthe thrill of the adventure. Now, you must\nfight freezing battles in\nthe north against hordes of winter demons\nand blizzard beasts. Will you bring back the\npeace\nto the grim and frostbitten kingdoms. Or\nwill you\nbring the Winter of Ages upon its lands,\nreigning\nyour kingdom cold for all eternity? Or will\nyou\nperish\nnameless and forgotten on the icy wastes?\n",t.Texts.battle={},t.Texts.battle.eyeOfStorm="You see an eye of the storm approaching. Brace yourself now..",t.Texts.battle.beastsSlain="All beasts have been slain. The blizzard seems to calm down",t.Texts.battle.enemiesDead="All enemies are dead! You emerge victorious. Congratulations!"},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=s(31),n=s(33),r=s(53);t.VirtualActor=class extends a.BaseActor{constructor(e){super(e),this._brain=new n.BrainVirtual(this)}};t.WeatherActor=class extends a.BaseActor{constructor(e){super(e),this._brain=new r.BrainWeather(this)}}},function(e,t,s){!function(e){"use strict";function t(t){var s=this!==e?this:{};s.input=t,s.pos=0,s.line=1,s.linePos=0}e.version="0.1.2",e.parse=function(e){return new t(e).grammar()},e.stringify=function e(t){switch(t.type){case"terminal":return'"'+a(t.text)+'"';case"nonterminal":return"<"+a(t.text)+">";case"expression":return t.terms.map(e).join(" ");case"production":return e(t.lhs)+" ::= "+t.rhs.map(e).join(" | ")+";";case"grammar":return t.productions.map(e).join("\n")+"\n"}throw new Error("Unknown node type: "+t.type)},e.Parser=t;var s=t.EOF=-1;function a(e){return e.replace(/\\/g,"\\\\").replace(/\"/g,'\\"').replace(/\n/g,"\\n").replace(/\t/g,"\\t")}t.prototype.error=function(e){throw new SyntaxError(e+" at "+this.line+":"+this.linePos)},t.prototype.peek=function(){return this.pos>=this.input.length?s:this.input[this.pos]},t.prototype.eat=function(e){var t=this.peek();return void 0!==e&&e!==t&&this.error("Expected "+e+", got"+t),t===s?s:(this.pos++,this.linePos++,t)},t.prototype.ws=function(){for(var e,t="";" \n\t".indexOf(e=this.peek())>=0;)"\n"===e&&(this.line++,this.linePos=0),t+=this.eat();return t},t.prototype.escaped=function(){this.eat("\\");var e=this.peek();switch(e){case"n":return this.eat(),"\n";case"t":return this.eat(),"\t";case'"':return this.eat(),'"';case"\\":return this.eat(),"\\"}this.error("Invalid escape sequence: \\"+e)},t.prototype.isChar=function(){var e=this.peek();return e!==s&&(/[a-zA-Z0-9\-_|:=; \/\(\)]/.test(e)||"\\"===e)},t.prototype.text=function(){for(var e="";this.isChar();)"\\"===this.peek()?e+=this.escaped():e+=this.eat();return e},t.prototype.terminal_text=function(){for(var e="",t=this.peek();this.isChar()||"<"===t||">"===t;)e+="\\"===t?this.escaped():this.eat(),t=this.peek();return e},t.prototype.terminal=function(){this.eat('"');var e=this.terminal_text();return this.eat('"'),{type:"terminal",text:e}},t.prototype.nonterminal=function(){this.eat("<");var e=this.text();return this.eat(">"),{type:"nonterminal",text:e}},t.prototype.term=function(){return"<"===this.peek()?this.nonterminal():this.terminal()},t.prototype.expression=function(){var e=[this.term()];for(this.ws();'<"'.indexOf(this.peek())>=0;)e.push(this.term()),this.ws();return{type:"expression",terms:e}},t.prototype.expressions=function(){for(var e=[this.expression()];"|"===this.peek();)this.eat("|"),this.ws(),e.push(this.expression());return e},t.prototype.production=function(){var e=this.nonterminal();this.ws(),this.eat(":"),this.eat(":"),this.eat("="),this.ws();var t=this.expressions();return this.eat(";"),{type:"production",lhs:e,rhs:t}},t.prototype.grammar=function(){var e=[this.production()];for(this.ws();"<"===this.peek();)e.push(this.production()),this.ws();return{type:"grammar",productions:e}}}(t)},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=s(1).Random.getRNG();t.QuestGrammar={};const n="<Knowledge> ::= <Deliver_item_for_study> |\n <Spy> |\n <Interview_NPC> |\n <Use_an_item_in_the_field> ;\n\n<Comfort> ::= <Obtain_luxuries> |\n <Kill_pests>;\n\n<Reputation> ::= <Obtain_rare_items> |\n <Kill_enemies> |\n <Visit_a_dangerous_place>;\n\n<Serenity> ::= <Revenge_Justice> |\n <Capture_Criminal1> |\n <Capture_Criminal2> |\n <Check_on_NPC1> |\n <Check_on_NPC2> |\n <Recover_lost_or_stolen_item> |\n <Rescue_captured_NPC>;\n\n<Protection> ::= <Attack_threatening_entities> |\n <Treat_or_repair_1> |\n <Treat_or_repair_2> |\n <Create_Diversion_1> |\n <Create_Diversion_2> |\n <Assemble_fortification> |\n <Guard_Entity>;\n\n<Conquest> ::= <Attack_enemy> |\n <Steal_stuff>;\n\n<Wealth> ::= <Gather_raw_materials> |\n <Steal_valuables_for_resale> |\n <Make_valuables_for_resale>;\n\n<Ability> ::= <Assemble_tool_for_new_skill> |\n <Obtain_training_materials> |\n <Use_existing_tools> |\n <Practice_combat> |\n <Practice_skill> |\n <Research_a_skill1> |\n <Research_a_skill2>;\n\n<Equipment> ::= <Assemble> |\n    <Deliver_supplies> |\n    <Steal_supplies> |\n    <Trade_for_supplies>;\n\n<Strategy> ::= <Win_a_battle> |\n    <Survive_a_battle>;",r=`<QUEST> ::= <Knowledge> | <Comfort> |\n <Reputation> | <Serenity> |\n <Protection> | <Conquest> |\n <Wealth> | <Ability> | <Equipment> | <Strategy>;\n\n${n}\n\n<Deliver_item_for_study> ::= <get> <goto> "give";\n<Spy> ::= <spy>;\n<Interview_NPC> ::= <goto> "<report>listen" <goto> "report";\n<Use_an_item_in_the_field> ::= <get> <goto> "use" <goto> "give";\n\n<Obtain_luxuries> ::= <get> <goto> "give";\n<Kill_pests> ::= <goto> "damage" <goto> "report";\n\n<Obtain_rare_items> ::= <get> <goto> "give";\n<Kill_enemies> ::= <goto> <kill> <goto> "report";\n<Visit_a_dangerous_place> ::= <goto> <goto> "report";\n\n<Revenge_Justice> ::= <goto> "damage";\n<Capture_Criminal1> ::= <get> <goto> "use" <goto> "give";\n<Capture_Criminal2> ::= <get> <goto> "use" "capture" <goto> "give";\n<Check_on_NPC1> ::= <goto> "<report>listen" <goto> "report";\n<Check_on_NPC2> ::= <goto> "take" <goto> "give";\n<Recover_lost_or_stolen_item> ::= <get> <goto> "give";\n<Rescue_captured_NPC> ::= <goto> "damage" "escort" <goto_new_place> "report";\n\n<Attack_threatening_entities> ::=<goto> "damage" <goto> "report";\n<Treat_or_repair_1> ::= <get> <goto> "use";\n<Treat_or_repair_2> ::= <goto> "repair";\n<Create_Diversion_1> ::= <get> <goto> "use";\n<Create_Diversion_2> ::= <goto> "damage";\n<Assemble_fortification> ::= <goto> "repair";\n<Guard_Entity> ::= <goto> "defend";\n\n<Attack_enemy> ::= <goto> "damage";\n<Steal_stuff> ::= <goto> <steal> <goto> "give";\n\n<Gather_raw_materials> ::= <goto> <get>;\n<Steal_valuables_for_resale> ::= <goto> <steal>;\n<Make_valuables_for_resale> ::= "repair";\n\n<Assemble_tool_for_new_skill> ::="repair" "use";\n<Obtain_training_materials> ::= <get> "use";\n<Use_existing_tools> ::= "use";\n<Practice_combat> ::= "damage";\n<Practice_skill> ::= "use";\n<Research_a_skill1> ::= <get> "use";\n<Research_a_skill2> ::= <get> "experiment";\n\n<Assemble> ::= "repair";\n<Deliver_supplies> ::= <get> <goto> "give";\n<Steal_supplies> ::= <steal>;\n<Trade_for_supplies> ::= <goto> "<get>exchange";\n\n<Win_a_battle> ::= <goto> "winbattle";\n<Survive_a_battle> ::= <goto> "finishbattle";\n\n<subquest> ::= <goto> |\n    <goto> <QUEST> "<subquest>goto";\n\n<goto> ::= "<goto>already_there" | "<goto>explore" | <learn> "<goto>goto";\n\n<goto_new_place> ::= "<goto>explore" | <learn> "<goto>goto";\n\n<learn> ::= "<learn>already_know_it" |\n    <goto> <subquest> "listen" |\n    <goto> <get> "<learn>read" |\n    <get> <subquest> "give" "listen";\n\n<get> ::= "<get>already_have_it" |\n    <steal> |\n    <goto> "<get>gather" |\n    <goto> <get> <goto> <subquest> "<get>exchange";\n\n<steal> ::= <goto> "<steal>stealth" "<steal>take" |\n    <goto> <kill> "<steal>take";\n\n<spy> ::= <goto> "<spy>spy" <goto> "report";\n<capture> ::= <get> <goto> "capture";\n<kill> ::= <goto> "<kill>kill";`,o=/<(\w+)>\s*::=/;const i={Knowledge:180,Comfort:20,Reputation:70,Serenity:140,Protection:180,Conquest:200,Wealth:20,Ability:10,Equipment:180,Strategy:40};t.QuestGrammar.motiveWeights=i;const l=function(e){const t=[];return e.split("\n").forEach(e=>{const s=e.match(o);s&&s.length>1&&t.push(s[1])}),t}(n);t.QuestGrammar.setWeight=function(e,t,s=!1){s&&Object.keys(i).forEach(e=>{i[e]=0}),i[e]=t},t.QuestGrammar.getRandMotive=function(){a.getWeighted(i)},t.QuestGrammar.grammar=r,t.QuestGrammar.actorMotivations=l},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(8)("bitn:quest-gen"),o=a(s(0)),i=s(138),l=s(1),c=s(24),h=s(6),u=s(46),d=s(7),g=n(s(19)),p=n(s(2)),m=s(81),f=s(82),y=l.Random.getRNG(),_=d.EventPool.getPool();class E{constructor(e){this.resetData(),this.questList=[],this.conf={maxLength:10,minLength:1,minQuests:1,maxQuests:2,numQuestsPerZone:1},this.maxTriesPerZone=5,this.questTargetCallback={escort:this.handleEscort=this.handleEscort.bind(this),repair:this.handleRepair=this.handleRepair.bind(this),listen:this.handleListen=this.handleListen.bind(this),reportListen:this.handleListen=this.handleListen.bind(this),report:this.handleReport=this.handleReport.bind(this),subquest:this.handleSubQuest=this.handleSubQuest.bind(this)},this.checkImplemented=!0,this.IND=0,this.debug=r.enabled,this.rng=y,e&&e.rng&&(this.rng=e.rng),this.pool=_}resetData(){this.questData={quests:[]},this.questList=[],this._cleanup=[],this.flags={alreadyKnowIt:!1,escort:!1,listen:!1,read:!1,report:!1},this.listOfAllTasks=[],this.currQuest=null,this._data=new Map,this._questCrossRefs=new Map,this.questGivers=new Map}setDebug(e){this.debug=e,r.enabled=e}getParentQuestData(){const e=this.questData.quests.indexOf(this.currQuest);return e>0?this.questData.quests[e-1]:null}initQuestPopulDataForQuest(e){this._data.set(e,{actor:[],element:[],escort:[],item:[],listen:[],place:[],read:[],reportListen:[],return:[],zone:[]})}addQuestPopulData(e,t){if(this._data.has(this.currQuest)||this.initQuestPopulDataForQuest(this.currQuest),this._data.get(this.currQuest).hasOwnProperty(e))this._data.get(this.currQuest)[e].push(t);else{const t=Object.keys(this._data.get(this.currQuest)).join(",");o.default.err("QuestPopulate","addQuestPopulData",`Key ${e} not present. Choices: ${t}`)}}getQuestPopulData(e,t=!1){if(this._data.has(this.currQuest)){const s=this._data.get(this.currQuest);if(s.hasOwnProperty(e)&&s[e].length>0){const t=s[e].length;return s[e][t-1]}if(t){const t=this.getParentQuestData();if(t){const s=this._data.get(t);if(s.hasOwnProperty(e)){const t=s[e].length;return s[e][t-1]}}o.default.err("QuestPopulate","getQuestPopulData",`No data for type ${e}. Searched parent also`)}else{const t=Object.keys(s);o.default.err("QuestPopulate","getQuestPopulData",`No data for type ${e}. Keys: ${t}`)}}else o.default.err("QuestPopulate","getQuestPopulData","No data for currQuest exists");return null}createQuests(e,t,s,a){const n=t.getTileXY(s,a),r=n.getZones("City");let o=0;return r.forEach(e=>{o+=this.createQuestsForZone(e,n)}),o}createQuestsForZone(e,t){const s=this.conf.numQuestsPerZone||1;let a=0;for(let n=0;n<s;n++)for(let s=0;s<this.maxTriesPerZone;s++){const s=(new f.QuestGen).genQuestWithConf(this.conf);if(this.resetData(),this.mapQuestToResources(s,e,t)){this.addQuestComponents(e),++a;break}}return a}mapQuestToResources(e,t,s){++this.IND,this.currTile=s;const a=new m.QuestData;this.dbg("*** New quest started ****"),e.isQuest()&&(this.dbg("  Quest has "+e.numTasks()+" tasks"),this.dbg("  Quest has "+(e.numQuests()-1)+" sub-quests"));let n=null;if(this.currQuest){const e={createTarget:"createSubQuestTarget",subQuest:a,args:[]};this.dbg("Adding |subquest| target for current quest"),this.currQuest.addTarget("subquest",e),n=this.currQuest.getCurrentLocation()}n&&this.addQuestPopulData("return",n),this.currQuest=a,this.questData.quests.push(this.currQuest);const r=this.rng.arrayGetRand(t.getLevels());this.currQuest.addTarget("location",r);let o=!0;if(e.getSteps().forEach(t=>{const a=this.currQuest.getCurrentLocation();if(t.isQuest()){const e=a.getParentZone();o=o&&this.mapQuestToResources(t,e,s)}else{const n=a.getParentZone();o=o&&this.mapTask(e,t,n,s)}}),!(o=o&&this._checkQuestFlags()))return this.cleanUpFailedQuest(),--this.IND,!1;if(this.dbg("Created quest: "+this.currQuest.getDescr()),this.questData.quests.length>1){this.questList.unshift(this.questData.quests.pop());const e=this.questData.quests.length-1;this.currQuest=this.questData.quests[e]}else this.questList.unshift(this.currQuest);return--this.IND,!0}pushQuestCrossRef(e,t){const s=this.currTaskType;e||o.default.err("QuestPopulate","pushQuestCrossRef",`${s}: Undefined KEY with data ${t}`),t||o.default.err("QuestPopulate","pushQuestCrossRef",`${s}: Undefined DATA with key ${e}`),this._questCrossRefs.has(e)||this._questCrossRefs.set(e,[]),this._questCrossRefs.get(e).push(t)}popQuestCrossRef(e){if(this._questCrossRefs.has(e)){const t=this._questCrossRefs.get(e);if(t.length>0){const s=this._questCrossRefs.get(e).pop();return 0===t.length&&this._questCrossRefs.delete(e),s}}return null}mapTask(e,t,s,a){++this.IND;const n=t.getTaskType();let r=!1;if(this.checkImplemented&&!S.has(n))return console.log(`TaskType |${n}| not implemented. Bailing out...`),!1;switch(this.dbg("Processing taskType |"+n+"|"),this.listOfAllTasks.push(n),this.currTaskType=n,n){case"capture":{const e=this.getActorToCapture();e&&(this.currQuest.addTarget("capture",e),r=!0);break}case"damage":{const e=this.getEntityToDamage();e&&(this.currQuest.addTarget("damage",e),r=!0);break}case"defend":{const e=this.getEntityToDefend();e&&(this.currQuest.addTarget("defend",e),r=!0);break}case"escort":{const e=this.getActorToEscort(a);e&&(this.currQuest.addTarget("escort",e),r=!0,this.addQuestPopulData("escort",e),this.flags.escort=!0);break}case"experiment":{const e=this.getQuestPopulData("item");e&&(this.currQuest.addTarget("experiment",e),r=!0);break}case"<get>already_have_it":{const e=this.getAlreadyOwnedItem();e&&(this.currQuest.addTarget("get",e),r=!0,this.addQuestPopulData("item",e));break}case"<get>gather":{const e=this.getItemToGather();e&&(this.currQuest.addTarget("get",e),r=!0,this.addQuestPopulData("item",e));break}case"<get>exchange":{const e=this.getItemToExchange();e&&(this.currQuest.addTarget("exchange",e),r=!0,this.addQuestPopulData("item",e));break}case"give":{const e=this.currQuest.getCurrentLocation(),t=this.getActorForQuests(e.getActors());t&&(this.currQuest.addTarget("give",t),r=!0);break}case"<goto>already_there":r=!0,this.flags.escort&&(r=!1);break;case"<goto>explore":{const e=this.getNewExploreLocation(s,a);this.currQuest.addTarget("location",e);const t=this.getExploreTarget();if(t&&(this.currQuest.addTarget("explore",t),r=!0,this.flags.read&&(this.flags.read=!1,this.pushQuestCrossRef(this.getQuestPopulData("read"),e)),this.flags.escort)){this.flags.escort=!1;const t=this.getQuestPopulData("escort",!0);this.pushQuestCrossRef(t,e)}break}case"<goto>goto":{const e=this.getNewLocation(s,a);if(this.currQuest.addTarget("location",e),r=!0,this.flags.read&&(this.flags.read=!1,this.pushQuestCrossRef(this.getQuestPopulData("read"),e)),this.flags.listen&&(this.flags.listen=!1,this.pushQuestCrossRef(this.getQuestPopulData("listen"),e)),this.flags.escort){this.flags.escort=!1;const t=this.getQuestPopulData("escort",!0);this.pushQuestCrossRef(t,e)}break}case"<kill>kill":{const e=this.getActorToKill();e&&(this.currQuest.addTarget("kill",e),r=!0);break}case"<learn>already_know_it":this.flags.alreadyKnowIt=!0,r=!0;break;case"listen":{const e=this.getActorToListen();e&&(this.currQuest.addTarget("listen",e),this.flags.listen=!0,this.addQuestPopulData("listen",e),r=!0);break}case"finishbattle":this.currQuest.addTarget("finishbattle",{createTarget:"createBattle",args:[s,a]}),r=!0;break;case"<learn>read":{const e=this.getReadTarget(s,a);e&&(this.addQuestPopulData("read",e),this.flags.read=!0,this.currQuest.addTarget("read",e),r=!0);break}case"repair":{const e=this.getRepairTarget();e&&(this.currQuest.addTarget("repair",e),r=!0);break}case"<report>listen":{const e=this.getActorToListen();e&&(this.currQuest.addTarget("reportListen",e),this.flags.report=!0,this.addQuestPopulData("reportListen",e),r=!0);break}case"report":{const e=this.getActorForReport();if(e&&(this.currQuest.addTarget("report",e),r=!0,this.flags.report)){const t=this.getQuestPopulData("reportListen");this.pushQuestCrossRef(e,t),this.flags.report=!1}break}case"<spy>spy":{const e=this.getActorToSpy();e&&(this.currQuest.addTarget("spy",e),r=!0);break}case"<steal>stealth":r=!0;break;case"<subquest>goto":{const e=this.getQuestPopulData("return");if(e&&(this.currQuest.addTarget("location",e),r=!0,this.flags.escort)){this.flags.escort=!1;const t=this.getQuestPopulData("escort",!0);this.pushQuestCrossRef(t,e)}break}case"<steal>take":case"take":{const e=this.getItemToSteal();e&&(this.currQuest.addTarget("get",e),this.addQuestPopulData("item",e),r=!0);break}case"use":{const e=this.getItemToUse();e&&(this.currQuest.addTarget("use",e),r=!0);break}case"winbattle":this.currQuest.addTarget("winbattle",{createTarget:"createBattle",args:[s,a]}),r=!0;break;default:o.default.err("QuestPopulate","mapTask",`Task type ${t.taskType} not supported yet`)}return r||console.warn("QuestPopulate","mapTask",`Failed to map ${t.getTaskType()}, ${JSON.stringify(t)}`),--this.IND,r}getActorForQuests(e){let t=this.rng.arrayGetRand(e),s=20,a=!1;for(;!v(t);)if(t=this.rng.arrayGetRand(e),0==--s){a=!0;break}return t}getActorToKill(){let e=this.currQuest.getCurrentLocation().getActors();return e=e.filter(e=>!e.isPlayer()&&e.hasNone(["QuestGiver","QuestTarget"])),this.rng.arrayGetRand(e)}getActorForReport(){const e=this.currQuest.getCurrentLocation().getActors();return this.getActorForQuests(e)}getActorToSpy(){const e=this.currQuest.getCurrentLocation().getActors();return this.getActorForQuests(e)}getActorToListen(){const e=this.currQuest.getCurrentLocation();return this.getActorForQuests(e.getActors())}getActorToEscort(e){const t=this.currQuest.getCurrentLocation();return this.getActorForQuests(t.getActors())}dbg(e){if(this.debug){const t="==".repeat(this.IND);r(t+e)}}getAlreadyOwnedItem(){const e=this.currQuest.getCurrentLocation().getPlayer();if(e){const t=e.getInvEq().getInventory().getItems();return this.rng.arrayGetRand(t)}return null}getItemToSteal(){const e=this.currQuest.getCurrentLocation(),t=new g.ItemBase(u.Names.getItemToStealName());let s=c.Placer.addEntityToCellType(t,e,e=>e.hasHouse());return s||(s=c.Placer.addEntityToCellType(t,e,e=>e.isFree())),s?(this._cleanup.push({location:e,item:t,tag:"getItemToSteal"}),t):null}getItemToGather(){const e=this.currQuest.getCurrentLocation(),t=new g.ItemBase("Quest item to gather");return c.Placer.addEntityToCellType(t,e,e=>e.isPassable())?(this._cleanup.push({location:e,item:t,tag:"getItemToGather"}),t):null}getReadTarget(e,t){return{createTarget:"createBook",args:[this.currQuest.getCurrentLocation(),e,t]}}getItemToUse(){const e=this.currQuest.getCurrentLocation(),t=e.getItems().filter(e=>e.hasOwnProperty("useItem"));if(t.length>0)return this.rng.arrayGetRand(t);const s=h.ObjectShell.getParser().createRandomItem(e=>e.use);return c.Placer.addEntityToCellType(s,e,e=>e.isPassable())&&s?(this._cleanup.push({location:e,item:s,tag:"getItemToUse"}),s):null}getRepairTarget(){const e=this.currQuest.getCurrentLocation().getElements().filter(e=>"door"===e.getType()||"leverdoor"===e.getType()||"lever"===e.getType());if(e.length>0){return this.rng.arrayGetRand(e)}return null}getEntityToDamage(){const e=this.currQuest.getCurrentLocation(),t=e.getElements().filter(e=>"door"===e.getType());if(t){return this.rng.arrayGetRand(t)}const s=e.getActors();return s.length>0?this.rng.arrayGetRand(s):null}getEntityToDefend(){const e=this.currQuest.getCurrentLocation().getActors();return e.length>0?this.rng.arrayGetRand(e):null}getActorToCapture(){const e=this.currQuest.getCurrentLocation().getActors();return this.getActorForQuests(e)}getItemToExchange(){const e=this.currQuest.getCurrentLocation().getElements().filter(e=>"shop"===e.getType());for(this.rng.shuffle(e);e.length>0;){const t=e[0].getCell();if(t.hasItems()){const e=t.getItems().filter(e=>e.has("Unpaid"));if(e.length>0)return e[0]}e.shift()}return null}getNewLocation(e,t){this.flags.alreadyKnowIt&&(this.flags.alreadyKnowIt=!1);let s=t.getZones();s=s.filter(e=>"battlezone"!==e.getType());let a=this.rng.arrayGetRand(s);if(s.length>1)for(;a.getID()===e.getID();)a=this.rng.arrayGetRand(s);return this.addQuestPopulData("zone",a),this.rng.arrayGetRand(a.getLevels())}getNewExploreLocation(e,t){const s=t.getZones("Dungeon"),a=t.getZones("Mountain"),n=s.concat(a),r=new i.RandomCyclic(n);if(n.length>0){let t=r.next(),s=20;for(;t.getID()===e.getID()&&(t=r.next(),0!=--s););return this.addQuestPopulData("zone",t),t.getLevels()[0]}return null}getExploreTarget(){const e=this.getQuestPopulData("zone").getLevels();let t=null;return e.forEach(e=>{if(!t){const s=e.getElements();t=s.find(e=>"exploration"===e.getType())}}),t}addQuestComponents(e){for(let t=this.questList.length-1;t>=0;t--){const s=this.questList[t];s.resetIter(),s.keys().forEach(e=>{if(E.supportedKeys.has(e)){let t=s.next(e);for(;t;){if(o.default.isEntity(t))this.setAsQuestTarget(e,t);else if(t.createTarget){const{createTarget:a,args:n}=t;"function"!=typeof this[a]&&o.default.err("QuestPopulate","addQuestComponents",`${a} not a func in QuestPopulate`);const r=this[a](t,...n);this.setAsQuestTarget(e,r),s.replaceTarget(e,t,r)||o.default.err("QuestPopulate","addQuestComponents","Failed to repl obj for "+a)}t=s.next(e)}}else o.default.err("QuestPopulate","addQuestComponents",`Unsupported key |${e}| found`)});const a=this.rng.arrayGetRand(e.getLevels()),n=this.getActorForQuests(a.getActors()),r=new p.QuestGiver(s.getDescr());this.addTargetsToGiver(r,s),n.add(r),this.addUniqueName(n),a.get("Lore").addTopic("quests",n.getName()+" could have some work for you");const i=n;this.questGivers.set(s,i)}}addTargetsToGiver(e,t){const s=e.getQuestID();this.dbg("addTargetsToGiver now, ID "+s),++this.IND,t.getPathTargets().forEach(t=>{this._checkTargetValidity(t);const a=t.get("QuestTarget");if(a){const[t,n]=[a.getTarget(),a.getTargetType()];e.addTarget(n,t),a.setQuestID(s)}else{const e=JSON.stringify(t);o.default.err("QuestPopulate","addTargetsToGiver",`No QuestTarget found from target ${e}`)}}),--this.IND}_checkTargetValidity(e){if(!o.default.isEntity(e)){const t="Non-Entity given: "+JSON.stringify(e);o.default.err("QuestPopulate","_checkTargetValidity",t)}}setAsQuestTarget(e,t){if(!t){const t=`Null/undef target with key |${e}|`;o.default.err("QuestPopulate","setAsQuestTarget",t)}if("function"!=typeof t.getID){let s=`questTarget without getID() given with key ${e}:`;s+=` ${JSON.stringify(t)}`,o.default.err("QuestPopulate","setAsQuestTarget",s)}const s=p.create("QuestTarget");s.setTargetType(e),s.setTarget(t),s.setTargetID(t.getID()),t.add(s),(o.default.isActor(t)||o.default.isItem(t))&&this.addUniqueName(t),this.questTargetCallback[e]&&this.questTargetCallback[e](t)}handleEscort(e){const t=this.popQuestCrossRef(e);if(t){const s=p.create("QuestEscortTarget");s.setEscortTo(t),e.add(s)}else this.dumpInternalData("handleEscort"),this.errorQuestHandle(e,"handleEscort")}handleRepair(e){e.add(p.create("Broken"))}handleListen(e){const t=p.create("QuestInfo");t.setQuestion("Can you tell me something to report?"),t.setInfo("Generate something to report"),t.setGivenBy(e.getID()),e.add(t)}handleReport(e){const t=p.create("QuestReport"),s=this.popQuestCrossRef(e);s&&t.setExpectInfoFrom(s.getID()),e.add(t)}handleSubQuest(e){const t=e.get("QuestTarget"),s=e.get("QuestGiver");if(t&&s)t.setSubQuestID(s.getQuestID());else{const t=JSON.stringify(e);o.default.err("QuestPopulate","handleSubQuest","Target must have QuestTarget + Giver comps: "+t)}}addUniqueName(e){if(!e.has("Named")){const t=p.create("Named");e.getName&&t.setName(e.getName()),e.add(t)}const t=e.get("Named");if(o.default.isActor(e))t.setUniqueName(u.Names.getActorName());else if(o.default.isItem(e)){const e="Quest item "+this.rng.getUniformInt(0,1e6);console.log("addUniqueName rand item name "+e),t.setUniqueName(e)}}createBattle(e,t,s){const a=s.getZones("BattleZone");if(a.length>0){return this.rng.arrayGetRand(a).getLevels()[0]}{const e={areaTile:s,zone:t};if(this.pool.emitEvent(o.default.EVT_CREATE_BATTLE,e),e.response){console.log("createBattle return eventArgs.response.level");const{battle:t}=e.response;if(t)return t.getLevel()}else o.default.err("QuestPopulate","createBattle","No response in eventArgs for EVT_CREATE_BATTLE")}return null}createBook(e,t){const s=new g.Book(u.Names.getBookName()),a=this.popQuestCrossRef(e);if(a){t.addItem(s);const e=o.default.formatLocationName(a),n=["Quest hint where to go:"];return n.push("You should go to place called "+e),s.setText(n),s.addMetaData("place",{levelID:a.getID(),name:e}),s}{const e=JSON.stringify(this._questCrossRefs);o.default.err("QuestPopulate","createBook",`No cross-refs set for book. refs: ${e}`)}return null}createSubQuestTarget(e){const{subQuest:t}=e;return this.questGivers.get(t)}_checkQuestFlags(){let e=!0;return Object.keys(this.flags).forEach(t=>{!1!==this.flags[t]&&(e=!1,console.log("Flag ",t,"still true!"))}),e}cleanUpFailedQuest(){let e=0;this._cleanup.forEach(t=>{const{location:s}=t;let a=!1,n=null;if(t.item){const[e,r]=t.item.getXY();n=t.item;try{a=s.removeItem(t.item,e,r)}catch(a){const{tag:n}=t,i=t.item.getName(),l=s.getItems().map(e=>e.toString());let c=`Failed to cleanup item ${i} @ ${e},${r}`;n&&(c+="\nTag specified: |"+n+"|"),c+="\n"+a.message,c+="\nItems at loc: "+l,o.default.err("QuestPopulate","cleanUpFailedQuest",c)}}else if(t.actor){const[e,r]=t.actor.getXY();a=s.removeActor(t.actor),n=t.actor}else if(t.element){const[e,r]=t.element.getXY();a=s.removeElement(t.element,e,r),n=t.element}a&&++e}),e!==this._cleanup.length&&o.default.warn("QuestPopulate","cleanUpFailedQuest","Did not remove all quest items for failed quest"),this._cleanup=[]}errorQuestHandle(e,t){let s="Failed to get location for escort: ";s+="\n\ttarget: "+e.getName(),s+="\n\tcrossRefs: "+JSON.stringify(Object.values(this._questCrossRefs.entries())),o.default.err("QuestPopulate",t,s)}dumpInternalData(e){"undefined"!=typeof window&&(window.QUEST_GEN=this)}}t.QuestPopulate=E;const S=new Set(["damage","escort","<get>gather","give","<kill>kill","<goto>already_there","<goto>explore","<goto>goto","<learn>already_know_it","<learn>read","listen","<report>listen","report","<steal>stealth","<steal>take","take","<subquest>goto","finishbattle","winbattle"]);function v(e){return e.has("Corporeal")&&o.default.ALL_RACES.indexOf(e.getType())>=0&&!(e.isPlayer()||e.has("QuestTarget")||e.has("QuestGiver"))}E.supportedKeys=new Set(["defend","capture","explore","kill","location","listen","give","report","reportListen","get","steal","use","repair","damage","winbattle","finishbattle","escort","spy","exchange","read","experiment","subquest"])},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(1).Random.getRNG();t.RandomCyclic=class{constructor(e){e&&0!==e.length||n.default.err("RandomCyclic","new","array with length > 0 must be given"),this.arr=e,this.reset(),this.length=e.length}reset(){this.indicesLeft=[],this.arr.forEach((e,t)=>{this.indicesLeft.push(t)}),this._prevValue=null,this._currValue=null}prev(){return this._prevValue}next(){0===this.indicesLeft.length&&this.reset();const e=r.arrayGetRand(this.indicesLeft);return this.indicesLeft=this.indicesLeft.filter(t=>t!==e),this._prevValue=this._currValue,this._currValue=this.arr[e],this._currValue}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(140),r=s(141),o=s(144),i=s(145),l=a(s(0));class c{constructor(e){this.fact=e,this.createFunc={}}addFunction(e,t){this.createFunc[e]=t}create(e,t){return c.levels.hasOwnProperty(e)?c.levels[e](...t):this.createFunc.hasOwnProperty(e)?this.createFunc[e](...t):this.fact?this.fact.createLevel(e,...t):(l.default.err("LevelFactory","create","No factory/factory function given. Name: "+e),null)}}t.LevelFactory=c,c.levels={Capital:(...e)=>new o.Capital(...e).getLevel(),DwarvenCity:(...e)=>new i.DwarvenCity(...e).getLevel(),AbandonedFort:(...e)=>new n.AbandonedFort(...e).getLevel(),BlackTower:(...e)=>new r.BlackTower(...e).getLevels()}},function(e,t,s){"use strict";var a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const n=s(38),r=s(25),o=s(17),i=s(6),l=s(15),c=s(35),h=a(s(5)),u=s(45),d=s(14),g=s(3),p=7;t.abandonedFortConf={outerColsRatio:.4,outerRowsRatio:.4,outerStartXRatio:.4,mountainWallRatio:.3,castleRowsRatio:.6,castleColsRatio:.6};t.AbandonedFort=class{constructor(e,s,a){a||(a=t.abandonedFortConf);const o=a.outerColsRatio||.4,l=a.outerRowsRatio||.4,c=a.outerStartXRatio||.4,m=a.mountainWallRatio||.3,f={meanWx:Math.floor(m*e),stdDev:10,filterW:7,north:!0,south:!0,east:!1,west:!1,alignHorizontal:"right"},y=this.createLevel("mountain",e,s,{nRoadTurns:0,snowRatio:.3}),_=y.getMap(),E=new d.MapGenerator,S={startRoomFunc:u.Castle.startRoomFuncWest},v=Math.round(o*e),C=Math.round(l*s),b=E.createCastleWall(v,C,S),T=Math.round(c*e),A=Math.round(s/2-b.map.rows/2);g.Geometry.mergeMapBaseElems(_,b.map,T,A);const w=Math.floor(e/2),O=this.createLevel("wall",w,s,f),M=e-O.getMap().cols;d.MapGenerator.addRandomSnow(O.getMap(),.3),g.Geometry.mergeLevels(y,O,M,0);const P=this.getCastleLevel(s,e,a),N=e-P.getMap().cols,I=Math.round((s-P.getMap().rows)/2);g.Geometry.mergeLevels(y,P,N,I);const D=Math.floor(s/2),L=new h.ElementStairs("stairsUp",y);y.addStairs(L,0,D);const R=P.getMap().rows,x=P.getMap().cols;let k=I,B=I+(R-1);k+=p,B-=p;const G=_.getFirstFreeFromRight(k,B),[W,F]=[G.getX(),G.getY()],Y=new h.ElementStairs("stairsDown",y);y.addStairs(Y,W,F);const X={ulx:N,uly:I,lrx:N+x-1,lry:I+R-1},$=i.ObjectShell.getParser(),j=new r.FactoryItem,V=_.getFreeInBbox(X);j.addItemsToCells(y,$,V,{itemsPerLevel:50,nLevel:0,func:e=>e.value>=100&&e.value<=200,maxValue:500});const U={"Mighty raven":!0,"Winter demon":!0,Cryomancer:!0,"Ice djinn":!0,Stormrider:!0,"Snow leopard":!0},K={actorsPerLevel:500,func:e=>U.hasOwnProperty(e.name),maxDanger:10};(new n.FactoryBase).addNRandActors(y,$,K),this.createPathToFort(y,N),this.level=y}getCastleLevel(e,t,s){const a=s.castleRowsRatio||.6,n=s.castleColsRatio||.6,r=Math.floor(a*e),o=Math.floor(n*t),i={tilesX:Math.round(o/7),tilesY:Math.round(r/7),roomCount:200,startRoomFunc:u.Castle.startRoomFuncWest};return this.createLevel("castle",o,r,i)}createLevel(e,t,s,a){return(new o.FactoryLevel).createLevel(e,t,s,a)}createPathToFort(e,t){const s=e.getMap(),a=t+1,n=Math.floor(s.rows/2),r=Math.floor(s.rows/2);this.createVariedPath(s,{x0:0,x1:a,y0:n,y1:r})}createVariedPath(e,t){const{x0:s,y0:a,x1:n,y1:r}=t;let o=[];for(let t=s;t<n;t+=20){let s=t+20;s>n&&(s=n);const i=l.Path.getMinWeightPath(e,t,a,s,r);o=o.concat(i)}c.Builder.addPathToMap(e,o)}getLevel(){return this.level}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(78),o=s(62),i=s(83),l=s(3),c=s(17),h=9;t.BlackTower=class{constructor(e,t,s={}){this.nLevels=s.nLevels||5,this.cols=e||100,this.rows=t||50,this.tilesX=Math.round(this.cols/h),this.tilesY=Math.round(this.rows/h),this.conf=s}getLevels(){const e=new o.CastleGenerator,t={wallType:"wallice",genParams:[2,2,2,2],nGates:2,roomCount:-1,tilesX:this.tilesX,tilesY:this.tilesY},s=[e.createLevel(this.cols,this.rows,t)];delete t.nGates;for(let a=0;a<this.nLevels-2;a++)s.push(e.createLevel(this.cols,this.rows,t));const[a,n]=[Math.round(this.tilesX/2),Math.round(this.tilesY/2)];t.callbacks={},t.callbacks.afterInit=(e=>{r.Vault.templates.all.forEach(t=>{e.addTemplate(t)}),r.Vault.func.createHugeVault(a-1,n-2,e,"vault_center1","entrance_n")});const i=e.createLevel(this.cols,this.rows,t);return s.push(i),this.generateYard(s),this.addProps(s),s.forEach((t,s)=>{e.removeMarkers(t,{markersPreserved:!1,shouldRemoveMarkers:!0});const a={maxDanger:this.getDanger(s)+5,actorFunc:e=>"WinterBeingBase"===e.base};e.populateStoreRooms(t,a)}),s.map((e,t)=>({nLevel:t,level:e}))}getDanger(e){return 7+3*e}addProps(e){const t=new i.FactoryZone;e.forEach((e,s)=>{const a=this.getDanger(s),r={nLevel:s,minValue:50+10*s,maxValue:65+20*(s+1),sqrPerItem:200,sqrPerActor:40-2*s,maxDanger:a,actor:e=>"WinterBeingBase"===e.base};t.addItemsAndActors(e,r),e.getActors().forEach(e=>{const t=e.get("Experience");if(t){const s=t.getDanger(),r=a-s,o=t.getExpLevel(),i=o+r;i>o&&n.default.levelUpActor(e,i)}})})}generateYard(e){const t=e[0],[s,a]=t.getColsRows(),n=Math.round(1.4*a),r=Math.round(1.4*s),o=(new c.FactoryLevel).createLevel("arctic",r,n),i=Math.round((r-s)/2),h=Math.round((n-a)/2);l.Geometry.mergeLevels(o,t,i,h),o.getExtras().connectEdges=!0,e[0]=o}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(3),o=s(1),i=s(11),l=s(14),c=s(9),h=o.Random.getRNG();t.LevelSurroundings=class{surround(e,t){if(t.cellsAround)return this.surroundWithCellsAround(e,t);const s=JSON.stringify(t);return n.default.err("LevelSurroundings","surround",`No conf given for surround. Got: ${s}`),null}surroundWithCellsAround(e,t){const s=2*t.surroundX||20,a=2*t.surroundY||20,{cols:n,rows:o}=e.getMap(),u=n+s,d=o+a,{cellsAround:g}=t,p={};"wallmount"===g.N?p.alignVertical="top":"wallmount"===g.S&&(p.alignVertical="bottom"),"wallmount"===g.E?(p.alignHorizontal="left",p.north=!0,p.south=!0):"wallmount"===g.W&&(p.alignHorizontal="right",p.north=!0,p.south=!0),p.meanWx=h.getUniformInt(5,s),p.meanWy=h.getUniformInt(5,a),p.wallElem=c.ELEM.WALL_MOUNT;const m=new l.MapGenerator,f=m.createWall(u,d,p),y=new i.Level;return y.setMap(f.map),Object.keys(g).forEach(e=>{if("water"===g[e]){const t={ratio:.6,skipTypes:{wallmount:!0},forestSize:300,nForests:10},s=r.Geometry.dirToBbox(u,d,e);m.addLakes(y.getMap(),t,s)}}),r.Geometry.mergeLevels(y,e,s/2,a/2),y}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=s(14),n=s(11),r=s(3),o=s(15),i=s(28),l=s(1),c=s(9),h=l.Random.getRNG();class u{static getSummitOptions(){return u.options.summit}static getFaceOptions(){const e=a.MapGenerator.getOptions("mountain"),t=Object.assign({},e,u.options.face);return t.maxDanger=5,t.maxValue=100,t}createFace(e,t,s){const r=new a.MapGenerator,o=new n.Level;r.setGen("mountain",e,t),s.nRoadTurns=0;const i=r.createMountain(e,t,s);return o.setMap(i.map),this.createCrux(o,s),o}createSummit(e,t,s){const r=new a.MapGenerator,o=new n.Level;r.setGen("mountain",e,t);const i=r.createSummit(e,t,s);return o.setMap(i.map),o.setExtras({}),o}createCrux(e,t){const s=e.getMap(),n=s.cols,o=Math.round(s.rows/6),l={wallElem:c.ELEM.HIGH_ROCK,meanWy:Math.round(o/2.5)},u=new a.MapGenerator;u.setGen("wall",n,o);const d=u.createWall(n,o,l).map,g=h.getUniformInt(0,n-1),p=h.getUniformInt(0,n-1),m=this.carvePath(d,g,0,p,o-1),f=Math.round(s.rows/5);r.Geometry.mergeMaps(s,d,0,f,(e,t)=>{const s=t.getBaseElem();return!/(floor)/.test(s.getType())});const y={startX:0,startY:0,maxY:f,yPerTurn:Math.round(f/4),endX:g};let _=u.createMountainPath(s,y);y.startY=f+o,y.maxY=s.rows-1,y.startX=p,y.yPerTurn=0,_=_.concat(u.createMountainPath(s,y)),e.addExtras("paths",_),m.forEach(e=>{e[1]+=f});const E=new i.DungeonPopulate(t);for(let s=0;s<3;s++){const s=h.arrayGetRand(m);E.addPointGuardian(e,s,t.maxDanger)}}carvePath(e,t,s,a,n){const i=[];return o.Path.getShortestPath(t,s,a,n).forEach(t=>{r.Geometry.getCrossAround(t.x,t.y,2,!0).forEach(t=>{const[s,a]=t;e.hasXY(s,a)&&(i.push(t),e.setBaseElemXY(s,a,c.ELEM.STONE))})}),i}}t.MountainGenerator=u,u.options={},u.options.face={},u.options.summit={ratio:.3}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(24),i=s(15),l=s(35),c=s(6),h=n(s(5)),u=s(17),d=s(3),g=s(60);t.Capital=class{constructor(e,t,s={}){r.default.isNullOrUndef([e,t])&&r.default.err("Capital","constructor","Use new Capital(cols, rows, conf?)");const a={meanWy:Math.floor(.9*t/2),stdDev:10,filterW:7};s.transpose&&(a.north=!0,a.south=!0,a.east=!1,a.west=!1,a.meanWx=Math.floor(.9*e/2));const n=(new u.FactoryLevel).createLevel("wall",e,t,a),p=n.getMap(),m=[.03,.2,.75,.95],f=[.5,.8,.6],y=c.ObjectShell.getParser(),_=e=>"Hyrkhian townsfolk"===e.name,E=[{actorFunc:_,nShops:2,parser:y,nGates:2,hasWall:!0},{actorFunc:_,nShops:5,parser:y,nGates:2,hasWall:!0},{actorFunc:_,nShops:2,parser:y,nGates:2,hasWall:!0}],S=[];for(let a=0;a<m.length-1;a++){const n=Math.floor(t*m[a]);let r=Math.floor(t*m[a+1])-n,o=Math.floor(f[a]*e);if(s.transpose){const s=Math.floor(e*m[a]);o=Math.floor(e*m[a+1])-s,r=Math.floor(f[a]*t)}E[a].nHouses=Math.floor(o*r/500),E[a].floorType="cave",E[a].wallType="castle",E[a].addWindows=!0;const i=(new g.CityGenerator).create(o,r,E[a]);S.push(i)}const v={x:0,y:Math.floor(m[0]*e),centerX:!0};if(s.transpose&&(v.centerY=!0,v.centerX=!1,v.y=0,v.x=Math.floor(m[0]*t)),d.Geometry.tileLevels(n,S,v),s.transpose){const s=Math.floor(t/2),a=new h.ElementStairs("stairsUp",n);n.addStairs(a,0,s);const r=new h.ElementStairs("stairsUp",n);n.addStairs(r,e-1,s);const o=i.Path.getMinWeightPath(p,0,s,e-1,s);l.Builder.addPathToMap(p,o)}else{const s=Math.floor(e/2),a=new h.ElementStairs("stairsUp",n);n.addStairs(a,s,0);const r=new h.ElementStairs("stairsUp",n);n.addStairs(r,s,t-1);const o=i.Path.getMinWeightPath(p,s,0,s,t-1,i.Path.getShortestPassablePathWithDoors);l.Builder.addPathToMap(p,o)}const C={footman:100,archer:50,elite:25,commander:5},b=[];Object.keys(C).forEach(e=>{const t=`Hyrkhian ${e}`,s=C[e];for(let e=0;e<s;e++){const e=y.createActor(t);b.push(e)}});for(let e=0;e<3;e++){const e=y.createActor("trainer");b.push(e)}o.Placer.addPropsToFreeCells(n,b,r.default.TYPE_ACTOR);const T=[y.createItem("Longsword")];o.Placer.addPropsToFreeCells(n,T,r.default.TYPE_ITEM),this.level=n}setConfig(){}getLevel(){return this.level}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(17),o=s(45),i=s(24),l=s(11),c=s(5),h=s(14),u=s(3),d=s(9),g=s(6),p=s(146),m={outerColsRatio:.45,outerRowsRatio:.4,outerStartXRatio:.3,cols:300,rows:250};t.dwarvenCityConf=m;const f=7;t.DwarvenCity=class{constructor(e,t,s=m){const a={meanWy:Math.floor(.85*t/2),stdDev:10,filterW:7},n=new r.FactoryLevel,o=n.createLevel("wall",e,t,a),i=s.outerColsRatio||.35,l=s.outerRowsRatio||.35;let c=Math.round(i*e),h=Math.round(l*t);c=this.adjustToTileSize(c),h=this.adjustToTileSize(h);const d=this.createEntryFortLevel(c,h),g=c+14,p=h+14,f=this.createMainFortLevel(g,p),y=p+h,_=Math.ceil((e-f.getMap().cols)/2),E=e-_,S={centerY:!1,centerX:!0,y:10,x:0},v=[f,d,n.createLevel("empty",14,50)];u.Geometry.tileLevels(o,v,S);const C={ulx:_,uly:10,lrx:E,lry:y};this.addItemsAndActors(o,C),this.addStairsToLevel(e,t,o),this.level=o}adjustToTileSize(e){for(;e%f!=0;)++e;return e%(2*f)==0&&(e+=f),e}createMainFortLevel(e,t){const s={startRoomFunc:o.Castle.startFuncFourGates},a=new h.MapGenerator,n=a.createCastleWall(e,t,s),r=e-42,i=t-28,c=a.createCastle(r,i,{roomCount:-1,nGates:2});(new l.Level).setMap(c.map),u.Geometry.mergeMapBaseElems(n.map,c.map,21,14);const g=new l.Level;g.setMap(n.map);const m=a.createCastle(49,35,{startRoomFunc:o.Castle.startRoomFuncEast,roomCount:-1,genParams:[1,1,1,1]}),f=a.createCastle(49,35,{startRoomFunc:o.Castle.startRoomFuncWest,roomCount:-1,genParams:[1,1,1,1]}),y=new l.Level;y.setMap(m.map);const _=new l.Level;_.setMap(f.map);const E=[y,g,_],S={centerY:!0,baseElem:d.ELEM.WALL};return p.LevelUtils.wrapAsLevel(E,S)}createEntryFortLevel(e,t){const s=new h.MapGenerator,a={startRoomFunc:o.Castle.startFuncFourGates},n=s.createCastleWall(e,t,a),r=e-42,i=t-42,c=s.createCastle(r,i,{nGates:2,roomCount:-1});(new l.Level).setMap(c.map),u.Geometry.mergeMapBaseElems(n.map,c.map,21,21);const g=s.createCastleWall(21,21,{startRoomFunc:o.Castle.startRoomFuncEast}),m=s.createCastleWall(21,21,{startRoomFunc:o.Castle.startRoomFuncWest}),f=new l.Level;f.setMap(n.map);const y=new l.Level;y.setMap(g.map);const _=new l.Level;_.setMap(m.map);const E=[y,f,_],S={centerY:!0,baseElem:d.ELEM.WALL};return p.LevelUtils.wrapAsLevel(E,S)}addItemsAndActors(e,t){const s=g.ObjectShell.getParser(),a=e.getMap().getFreeInBbox(t),r={fighter:200,axeman:100,elite:50,rifleman:50,commander:20},o=[];Object.keys(r).forEach(e=>{const t=`dwarven ${e}`,a=r[e];for(let e=0;e<a;e++){const e=s.createActor(t);o.push(e)}}),i.Placer.addPropsToCells(e,a,o,n.default.TYPE_ACTOR)}getLevel(){return this.level}addStairsToLevel(e,t,s){const a=Math.floor(e/2),n=new c.ElementStairs("stairsUp",s);s.addStairs(n,a,0);const r=new c.ElementStairs("stairsUp",s);s.addStairs(r,a,t-1)}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=s(11),n=s(27),r=s(9),o=s(3);t.LevelUtils={},t.LevelUtils.wrapAsLevel=function(e,t){const s=(e,t)=>Math.max(e,t),i=e.map(e=>e.getMap().cols),l=e.map(e=>e.getMap().rows),c=new a.Level;let h=null;const u=t.baseElem||r.ELEM.FLOOR;if(t.centerY){const t=l.reduce(s),a=i.reduce((e,t)=>e+t,0);h=new n.CellMap(a,t,u),c.setMap(h),o.Geometry.tileLevels(c,e,{centerY:!0,x:0,y:0})}else if(t.centerX){const t=l.reduce((e,t)=>e+t,0),a=i.reduce(s);h=new n.CellMap(a,t,u),c.setMap(h),o.Geometry.tileLevels(c,e,{centerX:!0,x:0,y:0})}return c}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=a(s(12)),o=s(37),i=s(27),l=s(11),c=s(3),h=s(14),u=s(15),d=s(28),g=s(1),p=s(9),m=s(6),f=s(5),y=1,_=g.Random.getRNG(),E=u.Path.getShortestPath,S=10,v={chasm:{elem:p.ELEM.CHASM},water:{elem:p.ELEM.WATER},forest:{elem:p.ELEM.TREE},fire:{elem:p.ELEM.LAVA}},C=.75,b={BIG_VAULT:.07,BIG_ROOM:.2,bigRoomWeights:{cross:1,corridor:1,vault:1,center:1}},T={cross:{special:["splashes"]},"small vault":{},"large vault":{},"large corridor":{special:["splashes"]},center:{}},A=function(e,t){this.room=t,this.type=e};class w extends o.LevelGenerator{static getOptions(e="digger"){const t={levelType:e,nBigRooms:1,bigRoomX:["cen"],bigRoomY:["cen"],bigRoomWidth:[10],bigRoomHeight:[10],maxDanger:5,maxValue:100,minNumRooms:3},s={options:O[e]};return Object.assign(t,s)}constructor(){super(),this.addDoors=!0,this.shouldRemoveMarkers=!0}create(e,t,s){const a=this._createLevel(e,t,s);return this.addSpecialFeatures(a),this.addStairsLocations(a),this.addCriticalPath(a),new d.DungeonPopulate({theme:""}).populateLevel(a),(s.rerunOnFailure||s.errorOnFailure)&&(this.verifyLevel(a,s)||this.create(e,t,s)),this.removeMarkers(a,s),a}_createLevel(e,t,s){e||(e=_.getUniformInt(80,120)),t||(t=_.getUniformInt(28,56));const a=s.minNumRooms||3;let n=null,r=null;const o=(e,t,s)=>{s===y&&r.setBaseElemXY(e,t,p.ELEM.WALL)};let c=10;for(;(!n||n.getRooms().length<a)&&(n=this.getMapGen(e,t,s),r=new i.CellMap(e,t),n.create(o),0!=--c););const h=new l.Level;h.setMap(r);const u={rooms:n.getRooms(),corridors:n.getCorridors()};return n.bigRooms&&(u.bigRooms=n.bigRooms),h.setExtras(u),h}getMapGen(e,t,s){let a=M();s.dungeonType&&""!==s.dungeonType&&(a=s.dungeonType);const n=s.options||O[a],o=new r.default.Map.Digger(e,t,n),i=this.addBigRooms(o,s);return i.length>0&&(o.bigRooms=i),o}addBigRooms(e,t){let s=[];if(t.nBigRooms>0&&(s=this.addCustomBigRooms(e,t)),_.getUniform()<=b.BIG_ROOM&&0===t.nBigRooms){const t=this.getBigRoomType();/center/.test(t)&&(s=this.addBigCenterRoom(e)),/large corridor/.test(t)&&(s=this.addLargeCorridorRoom(e)),/cross/.test(t)&&(s=this.addLargeCross(e)),/vault/.test(t)&&(s=this.addVault(e))}return s}getBigRoomType(){return _.arrayGetRand(Object.keys(T))}addCustomBigRooms(e,t){const[s,a]=e.getCenterXY(),[n,o]=[e.getCols(),e.getRows()],i=t.nBigRooms||0,l=[];for(let c=0;c<i;c++){let i=Math.floor(n/4);t.bigRoomWidth&&t.bigRoomWidth[c]&&(i=t.bigRoomWidth[c]);let h=Math.floor(o/4);t.bigRoomHeight&&t.bigRoomHeight[c]&&(h=t.bigRoomHeight[c]);const u=n-2-i;let d=_.getUniformInt(1,u),g="";t.bigRoomX&&(g=t.bigRoomX[c]),/cen/.test(g)&&(d=s-Math.floor(i/2));const p=o-2-h;let m=_.getUniformInt(1,p),f="";t.bigRoomY&&(f=t.bigRoomY[c]),/cen/.test(f)&&(m=a-Math.floor(h/2));const y=d+(i-1),E=m+(h-1),S=new r.default.Map.Feature.Room(d,m,y,E);e._options.dugPercentage+=.1,e.addRoom(S),l.push(new A("custom",S))}return l}addBigCenterRoom(e){const[t,s]=[e.getCols(),e.getRows()],[a,n]=e.getCenterXY(),o=_.getUniformInt(2,5),i=_.getUniformInt(2,6),l={roomWidth:[Math.floor(t/(i+1)),Math.floor(t/i)],roomHeight:[Math.floor(s/o),Math.floor(s/o)]},c=r.default.Map.Feature.Room.createCenter(a,n,l);return e._options.dugPercentage+=.2,e.addRoom(c),[new A("center",c)]}addLargeCorridorRoom(e){const[t,s]=[e.getCols(),e.getRows()],a=_.getCardinalDirLetter(),o="large corridor "+a;let i=null;if("E"===a){const e=_.getUniformInt(2,6),a=Math.floor(t/e);i=new r.default.Map.Feature.Room(1,1,a,s-2)}if("W"===a){const e=_.getUniformInt(2,6),a=t-2-Math.floor(t/e);i=new r.default.Map.Feature.Room(a,1,t-2,s-2)}if("N"===a){const e=_.getUniformInt(2,5),a=Math.floor(s/e);i=new r.default.Map.Feature.Room(1,1,t-2,a)}if("S"===a){const e=_.getUniformInt(2,5),a=s-2-Math.floor(s/e);i=new r.default.Map.Feature.Room(1,a,t-2,s-2)}return i||n.default.err("DungeonGenerator","addLargeCorridorRoom","room null something went wrong"),e._options.dugPercentage+=.2,e.addRoom(i),[new A(o,i)]}addLargeCross(e){const[t,s]=[e.getCols(),e.getRows()],[a,n]=e.getCenterXY(),o=_.getUniformInt(3,8),i=Math.floor(t/o),l=Math.floor(s/o),c={roomWidth:[t-2,t-2],roomHeight:[l,l]},h={roomHeight:[s-2,s-2],roomWidth:[i,i]},u=r.default.Map.Feature.Room.createCenter(a,n,c),d=r.default.Map.Feature.Room.createCenter(a,n,h);e.addRoom(u),e.addRoom(d);const g=(u.getAreaSize()+d.getAreaSize())/(t*s);return e._options.dugPercentage+=1.6*g,e._options.dugPercentage>=C&&(e._options.dugPercentage=C),[new A("crossHor",u),new A("crossVer",d)]}addVault(e){const[t,s]=[e.getCols(),e.getRows()],a=_.getUniform()<=b.BIG_VAULT;let n=Math.floor(t/2),o=Math.floor(s/2),i=["NE","NW","SW","SE"],l="small vault";a&&(_.getUniform()<=.5?(i=["NE","NW"],n=Math.floor(t/2),o=s-2):(i=["NW","SW"],n=t-2,o=Math.floor(s/2)),e._options.dugPercentage+=.25,l="large vault");const[c,h]=this.getRandCorner(n,o,t,s,i),u=c+n-1,d=h+o-1,g=new r.default.Map.Feature.Room(c,h,u,d);return e._options.dugPercentage+=.2,e.addRoom(g),[new A(l,g)]}getRandCorner(e,t,s,a,n){const r=_.arrayGetRand(n);let[o,i]=[1,1];switch(r){case"NW":o=1,i=1;break;case"NE":o=s-2-e,i=1;break;case"SW":o=1,i=a-2-t;break;case"SE":o=s-2-e,i=a-2-t}return[o,i]}addSpecialFeatures(e){const t=e.getExtras(),s=e.getMap();if(t.bigRooms){const s=t.bigRooms[0];let a={};if(Object.keys(T).forEach(e=>{new RegExp(e).test(s.type)&&(a=T[e])}),a.special){const s=_.arrayGetRand(a.special);this.addBigRoomSpecialFeat(e,s,t.bigRooms)}}if(t.rooms){const a=_.arrayGetRand(t.rooms),n=[];this.addFireToRoom(e,a),t.rooms.forEach((t,a)=>{t.setID(a);let r=0;const o=t.getOuterBbox();c.Geometry.getBorderForBbox(o).forEach(t=>{if(s.has(t,"floor"))++r;else{const s=new f.ElementMarker("w");s.setTag("room wall"),e.addElement(s,t[0],t[1])}}),this.addDoorsForRoom(e,t),1===r&&n.push(t)}),n.forEach(t=>{const s=t.getInnerBbox();c.Geometry.getCoordBbox(s).forEach(t=>{const s=new f.ElementMarker("t");s.setTag("term"),e.addElement(s,t[0],t[1])})}),t.terms=n}}addBigRoomSpecialFeat(e,t,s){s.forEach(s=>{const a=s.room;switch(a||n.default.err("DungeonGenerator","addBigRoomSpecialFeat","room is null for "+JSON.stringify(s)),t){case"splashes":this.addElemSplashes(e,a)}})}addDoorsForRoom(e,t){this.addDoors&&t.getDoors((t,s)=>{if(!e.getMap().getCell(t,s).hasDoor()){const a=new f.ElementDoor(!0);e.addElement(a,t,s)}})}addElemSplashes(e,t){const s=_.arrayGetRand(Object.keys(v)),a=v[s],n=a.elem;e.getExtras().theme=a;const r=t.getLeft()+1,o=t.getTop()+1,i=t.getWidth(),l=t.getHeight(),{map:u}=h.MapGenerator.createSplashes(i,l,{nForests:10,elem:n});c.Geometry.mergeMapBaseElems(e.getMap(),u,r,o)}addFireToRoom(e,t){const s=m.ObjectShell.getParser();Object.values(t.getCorners()).forEach(t=>{const a=s.createActor("Fire");e.addActor(a,t[0],t[1])})}addStairsLocations(e){const t=e.getExtras();let s=n.default.WATCHDOG;if(t.rooms){let[a,n]=_.getUniqueItems(t.rooms,2),r=null,o=null,i=0,l=0;const c=Math.floor(e.getMap().cols/2)+Math.floor(e.getMap().rows/2);for(;i<c&&([a,n]=_.getUniqueItems(t.rooms,2),(i=P(e,a,n))>l&&(l=i,r=a,o=n),0!=--s););a=r,n=o;const[h,u]=a.getCenter(),[d,g]=n.getCenter();t.startPoint=[d,g],t.endPoint=[h,u];const{startPoint:p,endPoint:m}=t;this.addStartAndEndPoint(e,p,m),a.addStairs(h,u,!0),n.addStairs(d,g,!1)}else{const e="rooms must be set as level extras";n.default.err("DungeonGenerator","addStairsLocations","Not enough rooms to add stairs. "+e)}}addCriticalPath(e){const t=e.getExtras(),[s,a]=t.startPoint,[r,o]=t.endPoint,i=e.getMap(),l=(e,t)=>i.isPassable(e,t)||i.getCell(e,t).hasDoor();let c=u.Path.getShortestPath(s,a,r,o,l);if(0===c.length){const e=(e,t)=>!/wall/.test(i.getCell(e,t).getBaseElem().getType());0===(c=u.Path.getShortestPath(s,a,r,o,e))?n.default.err("DungeonGenerator","addCriticalPath","No path found between stairs"):c.forEach(e=>{const{x:t,y:s}=e;i.isPassable(t,s)||i.setBaseElemXY(t,s,p.ELEM.BRIDGE)})}const h=(e,t)=>l(e,t)&&!i.getCell(e,t).hasMarker("path broken");let d=c;for(;c.length<50;){if(!this._breakPath(e,c))break;if(0===(c=E(s,a,r,o,h)).length){this.restorePath(e,d),c=d;break}d=c}this._addWallsToBrokenPath(e),c.forEach(t=>{const s=new f.ElementMarker("*");s.setTag("critical_path"),e.addElement(s,t.x,t.y)}),t.criticalPath=c}_breakPath(e,t){for(let s=0;s<t.length;s++){const{x:a,y:n}=t[s];if(e.getMap().getCell(a,n).hasDoor()){const t=new f.ElementMarker("X");return t.setTag("path broken"),e.addElement(t,a,n),!0}}return!1}_addWallsToBrokenPath(e){e.getElements().filter(e=>"marker"===e.getType()&&"path broken"===e.getTag()).forEach(t=>{const[s,a]=t.getXY();e.getMap().setBaseElemXY(s,a,p.ELEM.WALL)})}restorePath(e,t){for(let s=0;s<t.length;s++){const{x:a,y:n}=t[s];if(e.getMap().getCell(a,n).hasMarker("path broken")){e.getElements().filter(e=>e.isAtXY(a,n)).forEach(t=>{"marker"===t.getType()&&"path broken"===t.getTag()&&e.removeElement(t,a,n)})}}}verifyLevel(e,t){const s=e.getMap(),a=e=>e.isPassable()||e.hasDoor(),r=s.getCells(a),o=r[0],i=c.Geometry.floodfill(s,o,a),l=r.length,h=i.length;if(h!==l){const s=l-h;if(s>S){if(t.errorOnFailure){e.debugPrintInASCII();const t=`Max: ${S}, got: ${s}`;n.default.err("DungeonGenerator","verifyLevel","floodfill cannot reach all cells! "+t)}return!1}}return!0}}t.DungeonGenerator=w,w.mapOptions={digger:{roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2},uniform:{roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1}};const O=w.mapOptions,M=()=>_.arrayGetRand(["uniform","digger"]);function P(e,t,s){const a=e.getMap(),[n,r]=t.getCenter(),[o,i]=s.getCenter();return u.Path.getShortestPassablePathWithDoors(a,n,r,o,i).length}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(14),i=s(11),l=s(28),c=s(37),h=s(15),u=s(3),d=s(1),g=s(9),p=n(s(5)),m=d.Random.getRNG(),f=p.ElementMarker;function y(e,t,s=1){const a=Math.round(e/2),n=Math.round(t/2),r=e-1-s,o=t-1-s;return{N:{x:a,y:1,dirWeights:{E:1,W:1,S:5,SE:5,SW:5},dugCallback:(e,t,s)=>{t===o&&(s.dirWeights={})}},S:{x:a,y:o,dirWeights:{E:1,W:1,N:5,NE:5,NW:5},dugCallback:(e,t,s)=>{1===t&&(s.dirWeights={})}},E:{x:r,y:n,dirWeights:{N:1,S:1,NW:5,W:5,SW:5}},W:{x:1,y:n,dirWeights:{N:1,S:1,NE:5,E:5,SE:5}},NE:{x:r,y:1,dirWeights:{NW:1,W:10,SW:5,S:10}},NW:{x:1,y:1,dirWeights:{NE:1,E:10,SE:5,S:10}},SE:{x:r,y:o,dirWeights:{SW:1,W:10,NW:5,N:10}},SW:{x:1,y:o,dirWeights:{SE:1,E:10,NE:5,N:10}},C:{x:a,y:n,dirWeights:{N:1,S:1,E:2,W:2,NE:1,SE:1,NW:1,SW:1}}}}function _(e){const t=e[0],s={startX:t.x,startY:t.y,dirWeights:t.dirWeights},a=[];for(let t=1;t<e.length;t++)a.push(e[t]);return s.addMiners=a,s}t.CaveGenerator=class extends c.LevelGenerator{static getOptions(){return{dungeonType:"Lair",maxDanger:5,maxValue:100,isCollapsed:!1}}constructor(){super(),this.shouldRemoveMarkers=!0}create(e,t,s){r.default.isNullOrUndef([e,t])&&r.default.err("CaveGenerator","create",`cols or rows not defined: cols: ${e} / rows: ${t}`);const a=this._createLevel(e,t,s);return this.addStairsLocations(a),this._addSpecialFeatures(a),this._addEncounters(a,s),s.preserveMarkers=!1,this.removeMarkers(a,s),a}_createLevel(e,t,s){const a=this._createMapOptions(e,t,s),n=new o.MapGenerator,r=new i.Level;n.setGen("cave",e,t);const l=n.createCave(e,t,a);return r.setMap(l.map),this.setLevelExtras(r,l.mapGen),a.isCollapsed&&(r.getExtras().isCollapsed=!0),r}setLevelExtras(e,t){const s=t.getMapData();s.startPoints=r.default.uniquifyCoord(s.startPoints),e.setExtras(s)}_createMapOptions(e,s,a){let{dungeonType:n}=a,r={};const o=y(e,s);switch(n=n.capitalize()){case"Cave":r=t.Miners.getRandOpts(e,s,1,3);break;case"Grotto":r=t.Miners.getRandOpts(e,s,2,4);break;case"Lair":{const a=t.Miners.getMinersAndExclude(e,s,["C"]),n=[m.arrayGetRand(a),o.C];r=t.Miners.getOptsWithMiners(n);break}case"Cavern":r=t.Miners.getRandOpts(e,s,3,9);break;default:r=t.Miners.getRandOpts(e,s)}let i=m.getUniform()<=.1;return!1===a.isCollapsed&&(i=!1),(i||a.isCollapsed)&&(r.floorElem=g.ELEM.CHASM,r.isCollapsed=!0),r}addStairsLocations(e){const t=e.getExtras(),{startPoints:s}=t;let a=null,n=null;s.length>1?[a,n]=m.getUniqueItems(s,2):(a=s[0],n=this.getEndPointFromMap(e,a)),this.addStartAndEndPoint(e,a,n),t.startPoint=a,n&&(t.endPoint=n);const r=s.slice();t.points=[],r.splice(r.indexOf(a),1),r.splice(r.indexOf(n),1),r.forEach(s=>{const[a,n]=s,r=new f(">");r.setTag("end_point"),e.addElement(r,a,n),t.points.push(s)})}_addSpecialFeatures(e){e.getExtras().isCollapsed&&this._createCollapsedLevel(e)}getEndPointFromMap(e,t){const s=e.getMap(),a=this.getMapOfNonWallCells(e);return this.getRandomEndPoint(s,t,a)}getMapOfNonWallCells(e){const t=e.getMap().getCells(e=>!e.getBaseElem().isWall()),s={};return t.forEach(e=>{s[e.getKeyXY()]=e}),s}_createCollapsedLevel(e){const t=e.getExtras(),s=e.getMap();let{endPoint:a}=t;const{startPoint:n}=t,r=this.getMapOfNonWallCells(e);a||(a=this.getRandomEndPoint(s,n,r)),n&&a&&this.createPath(s,n,a).forEach(e=>{delete r[e[0]+","+e[1]]});const o=[n,a];t.points&&t.points.forEach(e=>{const t=m.arrayGetRand(o);this.createPath(s,e,t).forEach(e=>{delete r[e[0]+","+e[1]]}),o.push(e)});const i=m.getUniformInt(1,10);for(let e=0;e<i;e++){const e=this.getRandomPoint(s,n,r);if(e){const t=m.arrayGetRand(o);this.createPath(s,e,t).forEach(e=>{delete r[e[0]+","+e[1]]}),o.push(e)}}}createPath(e,t,s){const[a,n]=t,[r,o]=s,i=h.Path.getShortestPath(a,n,r,o,(t,s)=>e.hasXY(t,s)&&!e.getBaseElemXY(t,s).getType().match(/wall/)),l=[];return i.forEach(t=>{const{x:s,y:a}=t;u.Geometry.getCrossAround(s,a,1,!0).forEach(t=>{const[s,a]=t;"chasm"===e.getCell(s,a).getBaseElem().getType()&&(e.setBaseElemXY(s,a,g.ELEM.FLOOR_CAVE),l.push([s,a]))})}),l}getRandomEndPoint(e,t,s){const a=(t,s)=>e.hasXY(t,s)&&!e.getBaseElemXY(t,s).getType().match(/wall/),[n,r]=t;let o=null;const i=e.cols>e.rows?e.rows:e.cols;let l=0,c=10;const u=Object.values(s);let d=null;for(;l<i;){const e=m.arrayGetRand(u),[t,s]=e.getXY();if(o=[t,s],l=(d=h.Path.getShortestPath(t,s,n,r,a)).length,0===c)break;--c}return o&&d&&d.forEach(e=>{const t=e.x+","+e.y;delete s[t]}),o}getRandomPoint(e,t,s){const[a,n]=t,r=Object.values(s),o=m.arrayGetRand(r),[i,l]=o.getXY(),c=[i,l],u=h.Path.getShortestPath(i,l,a,n,(t,s)=>e.hasXY(t,s)&&!e.getBaseElemXY(t,s).getType().match(/wall/));return c&&u&&u.forEach(e=>{const t=e.x+","+e.y;delete s[t]}),c}_addEncounters(e,t){const{dungeonType:s}=t;"Lair"===s&&this._addLairBoss(e,t),this.populatePoints(e,t)}_addLairBoss(e,t){const{maxDanger:s,maxValue:a}=t,n=e.getExtras().endPoint;if(n){const t=new l.DungeonPopulate({});e.getExtras().isCollapsed&&t.setActorFunc(e=>e.flying),t.addPointGuardian(e,n,s+4),t.addMainLoot(e,n,a)}else{const t=JSON.stringify(e.getExtras());r.default.err("CaveGenerator","_addLairBoss","No endPoint in extras: "+t)}}populatePoints(e,t){const s=e.getExtras(),{points:a}=s,n=new l.DungeonPopulate({});a.forEach(s=>{n.populatePoint(e,s,t)})}},t.Miners={},t.Miners.getMiners=y,t.Miners.getMinersAndExclude=function(e,t,s){const a=y(e,t);return s.forEach(e=>{delete a[e]}),Object.values(a)},t.Miners.getOptsWithMiners=_,t.Miners.getRandOpts=function(e,t,s=1,a=9){const n=y(e,t),r=Object.values(n),o=m.getUniformInt(s,a),i=[];for(let e=0;e<o;e++){const e=m.arrayGetRand(r);i.push(e)}return _(i)},t.Miners.getMinersCorners=function(e,t,s){return s||(s=y(e,t)),{cols:e,rows:t,dirWeights:s.NW.dirWeights,addMiners:[s.SW,s.NE,s.SE],startX:s.NW.x,startY:s.NW.y}},t.Miners.getMinersNSEW=function(e,t,s){return s||(s=y(e,t)),{cols:100,rows:100,maxMinersCreated:100,startX:s.N.x,startY:s.N.y,dirWeights:s.N.dirWeights,addMiners:[s.S,s.E,s.W]}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const a=s(37),n=s(14),r=s(11);t.CryptGenerator=class extends a.LevelGenerator{static getOptions(){return{preserveMarkers:!0,tilesX:12,tilesY:7,genParams:[2,2,2,2],roomCount:40,maxDanger:1,maxValue:50}}constructor(){super(),this.shouldRemoveMarkers=!0}create(e,t,s){return this.createLevel(e,t,s)}createLevel(e,t,s){const a=new n.MapGenerator,o=new r.Level;a.setGen("crypt",e,t);const i=a.createCryptNew(e,t,s);return o.setMap(i.map),o}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=n(s(20)),i=s(5),l=s(1),c=s(6),h=s(10),u=l.Random.getRNG();t.DungeonFeatures=function(e){this._verif=new o.Conf("DungeonFeatures"),this._zoneType=e,this.addLastLevelFeatures=function(e,t,s){this._verif.verifyConf("addLastLevelFeatures",s,["maxDanger","maxValue"]);const a=new i.ElementExploration,n=10*(e+1)*s.maxDanger;Number.isInteger(n)||r.default.err("DungeonFeatures","addLastLevelFeatures",`expPoints NaN. nLevel: ${e}, dang: ${s.maxDanger}`),a.setExp(n),a.setData({zoneType:this._zoneType});const o=t.getParent();o&&o.getName&&a.addData("zoneName",o.getName());const l=t.getExtras();if(l&&l.endPoint){const[e,s]=l.endPoint;t.addElement(a,e,s)}else t.addElement(a);const c=this.generateBoss(e,t,s);if(c)this.addMinions(c,e,t,s);else{let s=`Failed to created boss. nLevel: ${e}`;s+=` Level parent: ${t.getParent()}`,r.default.debug({},s)}},this.generateBoss=((e,t,s)=>{this._verif.verifyConf("generateBoss",s,["maxDanger","maxValue"]);const a=c.ObjectShell.getParser(),n=s.maxDanger+2,o=a.createRandomActor({func:e=>e.danger<=n&&e.danger>=s.maxDanger});if(o){t.addActorToFreeCell(o);const e=2*s.maxValue,n=a.createRandomItem({func:t=>t.value<=e});if(n)o.getInvEq().addItem(n);else{const t=`Value: ${e}`;r.default.err("DungeonFeatures","generateBoss","Failed to create prize item: "+t)}}return o}),this.addMinions=((e,t,s,a)=>{const n=c.ObjectShell.getParser(),r=e.getType(),o=u.getUniform()<=.5;let i=t+1,l=a.maxDanger;o&&(i*=2,l-=1);const d=Math.round(Math.sqrt(i))+1,g=h.Brain.getBoxOfFreeCellsAround(e,d);u.shuffle(g);const p=e=>e.danger<=l&&e.type===r;for(;g.length>0&&i>0;){const e=g.pop();--i;const t=n.createRandomActor({func:p});if(t){const[a,n]=[e.getX(),e.getY()];s.addActor(t,a,n)}}})}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0));t.WinCondition=class{constructor(e,t){this._name=e,this.description="",this._condIncomplete={},this._condFilled={},this.pool=t,this._isTrue=!1,this.hasNotify=!0,this._notifyCallbacks={[n.default.EVT_ACTOR_KILLED]:this.actorKilledCallback.bind(this)}}getName(){return this._name}setPool(e){e!==this.pool&&this.pool.isListener(this)&&this.pool.removeListener(this),this.pool=e}isTrue(){return this._isTrue}addNotifyCallback(e,t){this._notifyCallbacks[e]=t}notify(e,t){this._notifyCallbacks.hasOwnProperty(e)&&this._notifyCallbacks[e](t),this._isTrue||0===Object.keys(this._condIncomplete).length&&(this._isTrue=!0,this.onTrue())}_addEvent(e){this.pool.listenEvent(e,this)}addActorKilled(e){this._addEvent(n.default.EVT_ACTOR_KILLED),this._condIncomplete[n.default.EVT_ACTOR_KILLED]=[e.getID()]}onTrue(){let e=`Condition: ${this._name}, Description: ${this.description}.`;e+="Congratulations. You have won!",n.default.gameSuccess(e),this.pool.emitEvent(n.default.EVT_WIN_COND_TRUE,{name:this._name})}actorKilledCallback(e){const t=e.actor,s=this._condIncomplete[n.default.EVT_ACTOR_KILLED];if(s){const e=s.indexOf(t.getID());e>=0&&(s.splice(e,1),0===s.length&&delete this._condIncomplete[n.default.EVT_ACTOR_KILLED])}}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(1).Random.getRNG();t.Disposition=function(e,t){this.rivals=e,this.conf=Object.assign({},t),this.weights={default:{ally:20,neutral:50,enemy:30}}},t.Disposition.prototype.setWeights=function(e){this.weights=e},t.Disposition.prototype.addWeight=function(e,t){this.weights[e]=t},t.Disposition.prototype.getTable=function(){return this.dispTable},t.Disposition.prototype._initTable=function(){this.dispTable={},this.rivals.forEach(e=>{this.dispTable[e]={}})},t.Disposition.prototype.randomize=function(){this._initTable(),this.rivals.forEach(e=>{this.rivals.forEach(t=>{if(!this.pairDone(e,t)){const s=this.getWeights(e,t),a=r.getWeighted(s);this.dispTable[e][t]=a,this.dispTable[t][e]=a}})})},t.Disposition.prototype.getWeights=function(e,t){return this.weights.hasOwnProperty(e)?this.weights[e]:this.weights.hasOwnProperty(t)?this.weights[t]:this.weights.default},t.Disposition.prototype.pairDone=function(e,t){return e===t||!!this.dispTable[e][t]&&(this.dispTable[t][e]||n.default.err("Disposition","pairDone","Something went wrong. No [r2][r1] but [r1][r2] exists"),!0)},t.Disposition.prototype.toString=function(){}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(46),o=s(63);t.LevelGen={};t.LevelGen.getDungeonConf=(e=>{let t=function(e){switch(e){case"Grotto":case"Cavern":case"Lair":return"Cave";case"Catacombs":case"Tombs":return"Crypt";case"Cells":return"Dungeon";default:return e}}(e);const s=function(e){switch(e){case"Cave":return 1;case"Crypt":return 2;case"Dungeon":return 3;case"Labyrinth":return 1;default:return 3}}(t),a=function(e){switch(e){case"Cave":return{actor:{op:"eq",prop:"type",value:["animal","goblin","beast"]}};case"Crypt":return{actor:{op:"eq",prop:"type",value:"undead"}};default:return null}}(t),[r,o]=function(e){const t=[n.default.LEVEL_MEDIUM_X,n.default.LEVEL_MEDIUM_Y];switch(e){case"Cave":return[80,50];case"Cavern":return[200,200];case"Grotto":return[120,60];case"Lair":return[200,150];case"Cells":case"Dungeon":return[100,50];case"Labyrinth":return[100,100];case"Crypt":return t;case"Tombs":return[100,100];case"Catacombs":return[n.default.LEVEL_HUGE_X,n.default.LEVEL_HUGE_Y];default:return t}}(e),i={name:e,dungeonX:r,dungeonY:o,dungeonType:t=t.toLowerCase(),nBranches:1,branch:[{name:e,nLevels:s,entranceLevel:0}]};return a&&(i.constraint=a),i}),t.LevelGen.getMountainConf=(e=>{const[t,s]=[80,240];return{name:e,nFaces:1,face:[{name:e,nLevels:1,entranceLevel:0,x:t,y:s}],nSummits:1,summit:[{name:"Summit",nLevels:1,cols:80,rows:50}],connectLevels:[[e,"Summit",0,0]]}});const i=()=>n.default.RAND.arrayGetRand(n.default.SHOP_TYPES),l=(e,t)=>{const s=t.maxValue||100,a=t.shopType||"random",r=t.name;if("Market"===r||"Bazaar"===r){const t=n.default.RAND.getUniformInt(1,3);e.nShops=t,e.constraint.shop=[];for(let n=0;n<t;n++){let t=i();"random"!==a&&0===n&&(t=a);const r=[{op:"eq",prop:"type",value:t},{op:"lte",prop:"value",value:s}];e.constraint.shop.push(r)}}else e.nShops=1};t.LevelGen.getCityConf=((e,t)=>{let s=r.Names.getGenericPlaceName("city");"fort"===t.type?s="Fort":t.capital?s="Capital":"stronghold"===t.type?s="Stronghold":"village"===t.type&&(s=r.Names.getVillageType());const a=(e=>{switch(e){case"Hamlet":case"Village":return 1;case"Town":return 2;case"Fort":return 1;case"Stronghold":return n.default.RAND.getUniformInt(2,4);case"Capital":return n.default.RAND.getUniformInt(3,5);default:return 1}})(s),i=((e,t)=>{const s=[];for(let a=0;a<e;a++){const e={name:r.Names.getGenericPlaceName("quarter"),nLevels:1,constraint:{}};0===a&&(e.entranceLevel=0),l(e,t),s.push(e)}return s})(a,t),c=o.WorldConf.createQuarterConnections(i),h={name:e,nQuarters:a,quarter:i};return c&&(h.connectLevels=c),h})},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(84),i=s(39),l=n(s(20)),c=s(8)("bitn:WorldFromJSON"),h=n(s(21));t.WorldFromJSON=class{constructor(e,t){this.id2level=e,this.id2entity=t,this._conf=new o.ConfStack,this._verif=new l.Conf("WorldFromJSON"),this.worldElemByID={},this.createAllZones=!0,this._IND=0}createPlace(e){switch(e.type){case"world":return this.createWorld(e);case"quarter":{const t=new r.default.Factory.World;return t.setId2Level(this.id2level),t.createCityQuarter(e)}default:r.default.err("WorldFromJSON","createPlace",`No place ${e.type} implemented yet`)}return null}createWorld(e){let t=null;if(e.conf)this.dbg("Creating a restored world now"),t=this.createRestoredWorld(e);else{r.default.err("WorldFromJSON","Should not be called at all.","ERROR"),this.dbg("Creating world using Factory.World fully");const s=new i.FactoryWorld;s.setId2Level(this.id2level),t=s.createWorld(e)}return t}createRestoredWorld(e){e.conf||r.default.err("WorldFromJSON","createRestoredWorld","No worldJSON.conf. Does not look like restored world.");const t=this.createWorldFromJSON(e);t.setConf(e.conf);const s=t.getAreas();if(s.length>0){const t=`${Object.keys(e.conf)}`;e.conf.hasOwnProperty("area")||r.default.err("WorldFromJSON","createRestoredWorld",`No prop 'area' in ${e.conf}. Props ${t}`)}return s.forEach((t,s)=>{t.setConf(e.conf.area[s])}),t}pushScope(e){this._conf.pushScope(e),this.fact.pushScope(e),++this._IND}popScope(e){this._conf.popScope(e),this.fact.popScope(e),--this._IND}getHierName(){return this._conf.getScope().join(".")}createWorldFromJSON(e){const t=new i.FactoryWorld;t.setId2Level(this.id2level),t.id2entity=this.id2entity,this.fact=t,this.verify("createWorld",e,["name","nAreas"]),e.hasOwnProperty("createAllZones")&&(this.createAllZones=e.createAllZones,this.dbg("createAllZones set to "+this.createAllZones),t.createAllZones=this.createAllZones),this.pushScope(e);const s=new h.WorldTop(e.name);s.setConf(e);for(let t=0;t<e.nAreas;t++){const a=e.area[t];c.enabled&&this.printKeys("areaJSON keys",a);const n=this.restoreAreaFromJSON(a);a.zonesCreated&&this.restoreCreatedZones(s,n),s.addArea(n),this.addWorldID(a,n)}return this.popScope(e),this.addWorldID(e,s),s}restoreAreaFromJSON(e){this.verify("restoreAreaFromJSON",e,["name","maxX","maxY"]),this.pushScope(e);const t=this.getAreaLevels(e),{name:s,maxX:a,maxY:n,cols:r,rows:o}=e,i=new h.Area(s,a,n,r,o,t);return i.setConf(e),i.setHierName(this.getHierName()),i.tilesLoaded=e.tilesLoaded,i.zonesCreated=e.zonesCreated,this.setTileJSONForUnloadedTiles(i,e),this.createAllZones?(this.fact._createAllZones(i,e),i.markAllZonesCreated()):this.dbg("Skipping the zone creating due to createZones=false"),this.popScope(e),i}restoreCreatedZones(e,t){Object.keys(t.zonesCreated).forEach(s=>{const[a,n]=s.split(","),[r,o]=[parseInt(a,10),parseInt(n,10)];t.zonesCreated[s]&&t.tilesLoaded[r][o]&&(this.dbg(`\tRestoring created zones for tile ${r},${o}`),this.restoreZonesForTile(e,t,r,o))})}restoreZonesForTile(e,t,s,a){const n=e.getConf();this.pushScope(n);const r=t.getConf();this.pushScope(r),this.fact._createAllZones(t,r,s,a),this.popScope(r),this.popScope(n)}getAreaLevels(e){this.verify("getAreaLevels",e,["tilesLoaded"]),++this._IND;const t=[];return e.tiles?e.tiles.forEach((s,a)=>{const n=[];s.forEach((t,s)=>{if(e.tilesLoaded[a][s]){this.dbg(`Tile ${a},${s} is loaded`);const e=this.id2level[t.level];e?n.push(e):r.default.err("WorldFromJSON","getAreaLevels",`No level ID ${t.level} in id2level`)}else this.dbg(`Will NOT load Tile ${a},${s}`),n.push(r.default.LEVEL_NOT_LOADED)}),t.push(n)}):r.default.err("WorldFromJSON","getAreaLevels","areaJSON.tiles cannot be null/undefined"),--this._IND,t}setTileJSONForUnloadedTiles(e,t){const s=e.getTiles();s.forEach((e,a)=>{e.forEach((e,n)=>{s[a][n]===r.default.TILE_NOT_LOADED&&(s[a][n]=t.tiles[a][n])})})}addWorldID(e,t){r.default.isNullOrUndef([e.id])||t.setID(e.id),this.worldElemByID[t.getID()]=t}dbg(e){if(c.enabled){const t=" ".repeat(this._IND);r.default.diag(t+"WorldFromJSON: "+e)}}verify(e,t,s){this._verif.verifyConf(e,t,s)}printKeys(e,t){r.default.diag(e),r.default.diag(Object.keys(t))}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(1).Random.getRNG(),o=["sunny","cloudy"],i=.1,l=.5,c=32;t.seasonConfig={AUTUMN:{dur:2,temp:[0,15],weather:[],index:0},AUTUMN_WINTER:{dur:1,temp:[-10,10],weather:["snowFall","coldRain"],index:1},WINTER:{dur:4,temp:[-35,3],weather:["snowFall","snowStorm","hailStorm"],index:2},WINTER_SPRING:{dur:1,temp:[-10,10],weather:["snowFall"],index:3},SPRING:{dur:1,temp:[7,15],weather:[],index:4},SPRING_SUMMER:{dur:1,temp:[10,20],weather:[],index:5},SUMMER:{dur:1,temp:[15,25],weather:[],index:6},SUMMER_AUTUMN:{dur:1,temp:[10,20],weather:["rain"],index:7}},t.biomePossibleSeasons={arctic:["WINTER"],alpine:["WINTER","WINTER_SPRING"],tundra:["AUTUMN_WINTER","WINTER","WINTER_SPRING"],taiga:["all"],forest:["all"],grassland:["all"]},t.getSeasonDist=function(e,s){const a=t.seasonConfig[e].index,n=t.seasonConfig[s].index;return Math.abs(a-n)};class h{constructor(e){this._currSeason=n.default.SEASON.AUTUMN,this._monthLeft=c,this._seasonLeft=t.seasonConfig[this._currSeason].dur,this._currWeather="sunny",this._seasonChanged=!1,this._weatherChanged=!1,this._monthChanged=!1,this._yearChanged=!1,this.pool=e}setOwPos(e){this._owPos=e}setBiomeMap(e){this._biomeMap=e}seasonChanged(){return this._seasonChanged}monthChanged(){return this._monthChanged}yearChanged(){return this._yearChanged}weatherChanged(){return this._weatherChanged}update(){--this._monthLeft,this._seasonChanged=!1,this._monthChanged=!1,this._yearChanged=!1,0===this._monthLeft&&(this._seasonLeft-=1,this._monthLeft=c,this._monthChanged=!0),this._seasonLeft<=0&&(this.nextSeason(),this._seasonChanged=!0,this._checkMsgEmits())}nextSeason(){const e=Object.keys(t.seasonConfig);let s=e.indexOf(this._currSeason)+1;s>=e.length&&(s=0,this._yearChanged=!0,this.pool.emitEvent(n.default.EVT_YEAR_CHANGED,{prevSeason:this._currSeason,nextSeason:e[s]})),this.pool.emitEvent(n.default.EVT_SEASON_CHANGED,{prevSeason:this._currSeason,nextSeason:e[s]}),this._currSeason=e[s]}getWeather(){return this._currWeather}changeWeather(){if(this._weatherChanged=!1,n.default.isSuccess(l))return this._currWeather;const e=this.getSeasonModified();let s=this._currWeather;if(n.default.isSuccess(i)){const a=t.seasonConfig[e].weather;a.length>0&&(s=r.arrayGetRand(a))}else s=r.arrayGetRand(o);return s!==this._currWeather&&(this._weatherChanged=!0),this.pool.emitEvent(n.default.EVT_WEATHER_CHANGED,{prevWeather:this._currWeather,nextWeather:s}),this._currWeather=s,this._currWeather}getSeason(){return this._currSeason}getSeasonModified(){if(!this._biomeMap)return this._currSeason;if(!this._owPos)return this._currSeason;const e=this._owPos[0]+","+this._owPos[1],s=this._biomeMap[e],a=t.biomePossibleSeasons[s];if("all"===a[0])return this._currSeason;return a.indexOf(this._currSeason)>=0?this._currSeason:a[0]}setPool(e){this.pool=e}toJSON(){return{currSeason:this._currSeason,currWeather:this._currWeather,monthLeft:this._monthLeft,seasonLeft:this._seasonLeft,seasonChanged:this._seasonChanged,weatherChanged:this._weatherChanged,monthChanged:this._monthChanged,yearChanged:this._yearChanged,owPos:this._owPos,biomeMap:this._biomeMap}}_checkMsgEmits(){this.seasonChanged()&&(this._currSeason===n.default.SEASON.AUTUMN_WINTER?n.default.gameMsg("Winter is approaching quickly!"):this._currSeason===n.default.SEASON.WINTER&&n.default.gameMsg("The call of Winter has arrived!"))}}t.SeasonManager=h,h.fromJSON=function(e){const t=new h;return t._currSeason=e.currSeason,t._currWeather=e.currWeather,t._monthLeft=e.monthLeft,t._seasonLeft=e.seasonLeft,t._seasonChanged=e.seasonChanged,t._weatherChanged=e.weatherChanged,t._monthChanged=e.monthChanged,t._yearChanged=e.yearChanged,t._owPos=e.owPos,t._biomeMap=e.biomeMap,t}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r={DAWN:{dur:1,visibility:-1},MORNING:{dur:3},NOON:{dur:3},AFTERNOON:{dur:3},EVENING:{dur:3,visibility:-1},DUSK:{dur:1,visibility:-2},NIGHT:{dur:7,visibility:-3}};class o{constructor(e){this._currPhase=n.default.DAY.MORNING,this._currPhaseLeft=r[this._currPhase].dur,this._updateRate=.05,this._dayChanged=!1,this._phaseChanged=!1,this.pool=e}setUpdateRate(e){this._updateRate=e}update(){this._dayChanged=!1,this._phaseChanged=!1,this._currPhaseLeft-=this._updateRate,this._currPhaseLeft<=0&&(this.nextPhase(),this._phaseChanged=!0)}dayChanged(){return this._dayChanged}phaseChanged(){return this._phaseChanged}getCurrPhase(){return this._currPhase}nextPhase(){const e=Object.keys(r);let t=e.indexOf(this._currPhase)+1;t>=e.length&&(t=0,this.pool.emitEvent(n.default.EVT_DAY_CHANGED,{prevPhase:this._currPhase,nextPhase:e[t]}),this._dayChanged=!0),this.pool.emitEvent(n.default.EVT_DAY_PHASE_CHANGED,{prevPhase:this._currPhase,nextPhase:e[t]}),this._currPhase=e[t],this._currPhaseLeft=r[this._currPhase].dur}toJSON(){return{currPhase:this._currPhase,currPhaseLeft:this._currPhaseLeft,updateRate:this._updateRate,dayChanged:this._dayChanged,phaseChanged:this._phaseChanged}}setPool(e){this.pool=e}}t.DayManager=o,o.fromJSON=function(e){const t=new o;return t._currPhase=e.currPhase,t._currPhaseLeft=e.currPhaseLef,t._updateRate=e.updateRate,t._dayChanged=e.dayChanged,t._phaseChanged=e.phaseChanged,t}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(23),i=s(158),l=s(7),c=s(159),h=s(164),u=s(49),d=s(39),g=s(1),p=s(3),m=s(88),f=n(s(2)),y=n(s(21)),_=s(16),E=l.EventPool.getPool();t.Game={},t.GameMain=function(){this._players=[],this._places={},this._shownLevel=null,this._gameOver=!1,this.actorsKilled={},this._enableChunkUnload=!1,this._chunkManager=null,this._eventPool=E,E.removeAll(),this.currPlaceIndex=0,this._rng=new g.Random,this._engine=new c.Engine(this._eventPool),this._master=new h.GameMaster(this,this._eventPool),this._worldSim=new m.WorldSimulation(this._eventPool),this._engine.addRegularUpdate(this._worldSim),this.globalConf={},this.setGlobalConf=(e=>{this.globalConf=e}),this.getGlobalConf=(()=>this.globalConf),this.shownLevel=(()=>this._shownLevel),this.setShownLevel=(e=>{this._shownLevel=e}),this.getPool=(()=>this._eventPool),this.setGUICallbacks=((e,t)=>{this._engine.isGUICommand=e,this._engine.doGUICommand=t;const s=this.getPlayer();s&&s.getBrain().addGUICallback("GOTO",t)}),this.setRNG=(e=>{this._rng=e,g.Random.setRNG(this._rng)}),this.playerCommandCallback=(e=>{this.visibleCells=e.getBrain().getSeenCells(),this._engine.setVisibleArea(this.shownLevel(),this.visibleCells)}),this._engine.playerCommandCallback=this.playerCommandCallback.bind(this),this.isGameOver=(()=>this._gameOver),this._engine.isGameOver=this.isGameOver,this.getLevels=(()=>this._engine.getLevels()),this.getComponents=(()=>this._engine.getComponents()),this.getPlaces=(()=>this._places),this.setEnableChunkUnload=((e=!0)=>{if(this._enableChunkUnload=e,e&&this.getArea(0)){const e=this.getArea(0);this._chunkManager=new i.ChunkManager(this,e)}}),this.getPlayer=(()=>this._engine.getPlayer()),this.addPlayer=((s,a)=>{let n=!1;return this._master.setPlayer(s),(n=!r.default.isNullOrUndef([s.getLevel()])||(r.default.isNullOrUndef([a])?e(s,this.getLevels()):t(s,a)))&&(this._engine.nextActor=s,this._engine.setPlayer(s),null===this._shownLevel&&(this._shownLevel=s.getLevel()),this._players.push(s),this._engine.addActiveLevel(s.getLevel()),s.getLevel().onEnter(),s.getLevel().onFirstEnter()),n&&this._gameOver&&(this._gameOver=!1),n}),this.useAsPlayer=(e=>{let t=e;Number.isInteger(e)&&(t=r.default.ent(e)),t||(t=r.default.CLICKED_ACTOR),t.setIsPlayer(!0),t.add(new f.Player),this.addPlayer(t)}),this.movePlayer=((e,t,s=0,a=0)=>{const n=this.getPlayer(),o=this.getCurrentWorld().getAreas()[0];let i=null;this._enableChunkUnload?this._chunkManager.isLoaded(e,t)?i=o.getTileXY(e,t):(this._chunkManager.setPlayerTile(e,t),i=o.getTileXY(e,t)):i=o.getTileXY(e,t);const l=i.getLevel(),c=n.getLevel(),[h,u]=[n.getX(),n.getY()];c.removeActor(n)?l.addActor(n,s,a)?(E.emitEvent(r.default.EVT_LEVEL_CHANGED,{target:l,src:c,actor:n}),E.emitEvent(r.default.EVT_LEVEL_ENTERED,{actor:n,target:l})):l.addActorToFreeCell(n)?(E.emitEvent(r.default.EVT_LEVEL_CHANGED,{target:l,src:c,actor:n}),E.emitEvent(r.default.EVT_LEVEL_ENTERED,{actor:n,target:l})):c.addActor(n,h,u):console.error("Could not remove player from level")});const e=(e,t)=>{let s=!1;return t.length>0?(s=t[0].addActorToFreeCell(e))?this.checkIfTileChanged({actor:e,src:null,target:t[0]}):r.default.err("Game","addPlayer","Failed to add the player."):r.default.err("Game","addPlayer","No levels exist. Cannot add player."),s},t=(t,s)=>{if(s.hasOwnProperty("place")){const a=s.place;if(this._places.hasOwnProperty(a)){if(s.hasOwnProperty("x")&&s.hasOwnProperty("y")){const n=[this._places[a].getAreas()[0].getTileXY(s.x,s.y).getLevel()];return e(t,n)}{const s=this._places[a].getLevels();return e(t,s)}}r.default.err("GameMain","_addPlayerToPlace","No place |"+a+"| found.")}else r.default.err("GameMain","_addPlayerToPlace","obj.place must exist.");return!1};this.checkIfTileChanged=(e=>{const{actor:t,src:s,target:a}=e,n=[a];r.default.isNullOrUndef([s])||n.push(s);const o=this.getArea(0);o&&2===n.length&&o.hasTiles(n)&&E.emitEvent(r.default.EVT_TILE_CHANGED,{actor:t,target:a,src:s})}),this.isTileLevel=(e=>{return this.getArea(0).hasTiles([e])}),this.checkIfExploredZoneLeft=(e=>{const{actor:t,src:s,target:a}=e;let n=!1;if(t.has("GameInfo")&&s&&a){const e=s.getParent();if(e)if(e.getID){const s=e.getID();t.get("GameInfo").hasZone(s)&&(n=this.isTileLevel(a))}else r.default.warn("GameMain","checkIfExploredZoneLeft","No getID: "+JSON.stringify(e))}n&&E.emitEvent(r.default.EVT_EXPLORED_ZONE_LEFT,{actor:t,target:a,src:s})}),this.getMessages=(()=>this._engine.getMessages()),this.clearMessages=(()=>{this._engine.clearMessages()}),this.hasNewMessages=(()=>this._engine.hasNewMessages()),this.addActor=(e=>{this._engine.addActor(e)}),this.removeActor=(e=>{this._engine.removeActor(e)}),this.addEvent=(e=>{this._engine.addEvent(e)}),this.addActiveLevel=(e=>{this._engine.addActiveLevel(e)}),this.addLevel=(e=>{this._engine.hasLevel(e)?this.errorDuplicateLevel("addLevel",e):this._engine.addLevel(e)}),this.addLevelUnlessExists=(e=>{this._engine.hasLevel(e)||this._engine.addLevel(e)}),this.removeLevels=(e=>{this._engine.removeLevels(e)}),this.addPlace=(e=>{if("function"==typeof e.getLevels){const t=e.getName();if(this._places.hasOwnProperty(t))r.default.err("GameMain","addPlace","A place |"+t+"| exists.");else{const s=e.getLevels();if(s.length>0)for(const e of s)this.addLevel(e);else r.default.err("GameMain","addPlace",`Place ${t} has no levels!`);if(this._places[t]=e,this.getArea(0)){const e=this.getCurrentWorld().getCurrentArea();this._enableChunkUnload&&!this._chunkManager&&(this._chunkManager=new i.ChunkManager(this,e))}}}else r.default.err("GameMain","addPlace","Added place must have getLevels()")}),this.hasPlaces=(()=>Object.keys(this._places).length>0),this.getVisibleMap=(()=>{return this.getPlayer().getLevel().getMap()}),this.simulate=((e=1)=>{this._engine.simulateGame(e)}),this.simulateGame=((e=1)=>{this._engine.simulateGame(e)}),this.update=(e=>{this._engine.update(e)}),this.getArea=(e=>{const t=this.getCurrentWorld();return t&&"function"==typeof t.getAreas?t.getAreas()[e]:null}),this.hasNotify=!0,this.notify=((e,t)=>{if(e===r.default.EVT_ACTOR_KILLED){if(this.actorsKilled[t.actor.getID()]=!0,t.actor.isPlayer()){const{actor:e}=t,s=this._players.indexOf(e);s>=0&&(1===this._players.length&&(this._gameOver=!0,console.log("PLAYER DIED!!"),r.default.gameMsg("GAME OVER!")),this._players.splice(s,1))}}else if(e===r.default.EVT_LEVEL_CHANGED){const{actor:e}=t;e.isPlayer()&&(this._shownLevel=e.getLevel(),this._worldSim.setLevel(this._shownLevel),this._overworld&&this._worldSim.setOwPos(this.getPlayerOwPos()),this.checkIfTileChanged(t),this.checkIfExploredZoneLeft(t))}else if(e===r.default.EVT_TILE_CHANGED){const{actor:e,target:s}=t;if(e.isPlayer()){const e=s.getID(),a=this.getCurrentWorld();if(a&&a.getAreas){const s=a.getAreas()[0],[n,r]=s.findTileXYById(e),o=new d.FactoryWorld;o.setGlobalConf(this.getGlobalConf());let i=null,l=null;if(t.src){const e=s.findTileXYById(t.src.getID());e&&([i,l]=e)}this._enableChunkUnload&&this._chunkManager.setPlayerTile(n,r,i,l),o.createZonesForTile(a,s,n,r),a.getLevels().forEach(e=>{this.addLevelUnlessExists(e)})}}}}),this._eventPool.listenEvent(r.default.EVT_ACTOR_KILLED,this),this._eventPool.listenEvent(r.default.EVT_LEVEL_CHANGED,this),this._eventPool.listenEvent(r.default.EVT_TILE_CHANGED,this),this.addBattle=((e,t=-1,s=!1)=>{const a=e.getLevel();this.addLevel(a),s&&this._engine.addActiveLevel(a),this.hasPlaces()&&t>-1&&this._addBattleZoneToArea(e,t)}),this._addBattleZoneToArea=((e,t)=>{const s=e.getLevel(),a="Zone of "+e.getName(),n=new y.BattleZone(a);n.addLevel(s);const o=this.getCurrentWorld().getAreas()[0],i=o.findTileXYById(t);i?(n.setTileXY(i[0],i[1]),o.addZone("BattleZone",n)):r.default.err("GameMain","_addBattleZoneToArea",`ID ${t} not found in area.`)}),this.getChunkManager=(()=>this._chunkManager),this.getGameMaster=(()=>this._master),this.setGameMaster=(e=>{this._master=e,this._master.setPlayer(this.getPlayer());const t=Object.values(this._places)[0];this._master.setWorld(t),this._master.setGame(this)}),this.getOverWorld=(()=>this._overworld),this.setOverWorld=(e=>{this._overworld=e,this._worldSim.setOverWorld(e)}),this.setWorldSim=(e=>{e.setPool(this._eventPool),this._worldSim=e}),this.toJSON=(()=>{const e={engine:{},gameMaster:this._master.toJSON(),gameObjectID:u.GameObject.ID,lastComponentID:f.getIDCount(),globalConf:this.globalConf,rng:this._rng.toJSON(),diceRng:_.Dice.RNG.toJSON(),charStyles:r.default.charStyles,cellStyles:r.default.cellStyles,actorsKilled:this.actorsKilled,enableChunkUnload:this._enableChunkUnload};if(this.hasPlaces()){const t={};Object.keys(this._places).forEach(e=>{const s=this._places[e];t[e]=s.toJSON()}),e.places=t}else{const t=[];this._engine.getLevels().forEach(e=>{t.push(e.toJSON())}),e.levels=t,e.places={}}const t=this.getPlayer();return t&&(e.player=t.toJSON()),this._overworld&&(e.overworld=this._overworld.toJSON()),this._chunkManager&&(e.chunkManager=this._chunkManager.toJSON()),this._worldSim&&(e.worldSim=this._worldSim.toJSON()),e}),this.isMenuShown=(()=>{const e=this.getPlayer();return!!e&&e.getBrain().isMenuShown()}),this.getMenu=(()=>{const e=this.getPlayer();return e?e.getBrain().getMenu():null}),this.setAnimationCallback=(e=>{"function"==typeof e?this._engine.animationCallback=e:r.default.warn("GameMain","setAnimationCallback","Callback must be a function.")}),this.hasAnimation=(()=>this._engine.hasAnimation()),this.finishAnimation=(()=>this._engine.finishAnimation()),this.getAnimationFrame=(()=>this._engine.animation.nextFrame()),this.enableAnimations=(()=>{this._engine.enableAnimations()}),this.disableAnimations=(()=>{this._engine.disableAnimations()}),this.getPlayerOwPos=(()=>{const e=this.getPlayer();if(!this._overworld||!e)return[];const t=this._overworld;let s=this.getCurrentWorld().getAreas()[0].findTileXYById(e.getLevel().getID());if(!s&&!(s=this.tryToGetTileXY()))return null;const{xMap:a,yMap:n}=t.coordMap,r=100*s[0]+e.getX(),o=100*s[1]+e.getY();return[Math.floor(r/a),Math.floor(o/n)]}),this.tryToGetTileXY=(()=>{let e=this.getPlayer().getLevel().getParent();for(;e;)if((e=e.getParent?e.getParent():null)&&e.getTileXY)return e.getTileXY();return null}),this.setOverWorldExplored=(e=>{p.Geometry.getBoxAround(e[0],e[1],1,!0).forEach(e=>{this._overworld.setExplored(e)})}),this.getCurrentWorld=(()=>{const e=Object.values(this.getPlaces());return e.length>this.currPlaceIndex?e[this.currPlaceIndex]:null}),this.find=((e,t=-1,s="find")=>{const a=this._engine.getLevels();if(-1===t){return this.getPlayer().getLevel().getActors()[s](e)}if(Number.isInteger(t)){const n=a.find(e=>e.getID()===t);if(n)return n.getActors()[s](e)}else for(const t of a){const a=t.getActors()[s](e);if(a)return a}return null}),this.errorDuplicateLevel=((e,t)=>{const s=t.getParent(),a=t.toJSON();delete a.elements,delete a.map.cells;let n="";if(s){n=`Parent: ${r.default.formatLocationName(t)}| `}n+="Duplicate level ID "+t.getID(),n+=" JSON: "+JSON.stringify(a,null,1),r.default.err("GameMain",e,n)}),this.entityPrint=(()=>{r.default.diag(o.Entity.num)})}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(85),o=s(11),i=s(8)("bitn:ChunkManager"),l=Object.freeze({EMPTY:"EMPTY",LOADED:"LOADED",JSON:"JSON",ON_DISK:"ON_DISK",LOADED2JSON:"LOADED2JSON"}),c=Object.freeze({EMPTY:"EMPTY",CREATED:"CREATED",POPULATED:"POPULATED"});class h{constructor(e,t){const[s,a]=[t.getSizeX(),t.getSizeY()];this.sizeX=s,this.sizeY=a,this.area=t,this.game=e,this.state=[];for(let e=0;e<s;e++){this.state[e]=[];for(let s=0;s<a;s++)if(t.isLoaded(e,s)){const t={loadState:l.LOADED};this.state[e].push(t)}else{const t={loadState:l.JSON};this.state[e].push(t)}}this.loadDistX=1,this.loadDistY=1,this.onDiskDistX=s,this.onDiskDistY=a}setPlayerTile(e,t,s,a){const n=this.getMoveDir(e,t,s,a);i.enabled&&(i(`## setPlayerTile START ${s},${a}->${e},${t}`),this.debugPrint());const r=[];for(let s=0;s<this.sizeX;s++)for(let a=0;a<this.sizeY;a++)this.inLoadRange(e,t,s,a)?this.isLoaded(s,a)||r.push([s,a]):this.isLoaded(s,a)&&this.unloadTile(e,t,s,a,n);r.length>0&&this.loadTiles(e,t,r,n),i.enabled&&(i(`## setPlayerTile END ${s},${a}->${e},${t}`),this.debugPrint())}isLoaded(e,t){return this.state[e][t].loadState===l.LOADED}inLoadRange(e,t,s,a){for(let n=e-this.loadDistX;n<=e+this.loadDistX;n++)for(let e=t-this.loadDistY;e<=t+this.loadDistY;e++)if(s===n&&a===e)return!0;return!1}loadAllTiles(){this.setLoadStateAll(l.LOADED)}getNumInState(e){let t=0;for(let s=0;s<this.sizeX;s++)for(let a=0;a<this.sizeY;a++)this.state[s][a].loadState===e&&++t;return t}loadTiles(e,t,s,a){const n=this.area.getTiles();i("loadTiles: "+JSON.stringify(s));const r=s.map(e=>n[e[0]][e[1]]);this.createTiles(r),s.forEach(s=>{i(`ChunkManager load now tile ${s}`);const[r,o]=s;if(this.state[r][o].loadState=l.LOADED,this.area.setLoaded(r,o),""===a&&(i(`Rm adjacent conns to ${r},${o}`),this.removeAdjacentConnections(n,e,t,r,o)),0===s[0]&&2===s[1]){this.area.getTiles()}})}removeAdjacentConnections(e,t,s,a,n){this.inLoadRange(t,s,a,n-1)||n-1>=0&&(i(`Rm NORTH conns from ${a},${n}`),this.removeConnections("NORTH",e[a][n])),this.inLoadRange(t,s,a,n+1)||n+1<this.area.getSizeY()&&(i(`Rm SOUTH conns from ${a},${n}`),this.removeConnections("SOUTH",e[a][n])),this.inLoadRange(t,s,a+1,n)||a+1<this.area.getSizeX()&&(i(`Rm EAST conns from ${a},${n}`),this.removeConnections("EAST",e[a][n])),this.inLoadRange(t,s,a-1,n)||a-1>=0&&(i(`Rm WEST conns from ${a},${n}`),this.removeConnections("WEST",e[a][n]))}unloadTile(e,t,s,a,n){i(`Unloading tile ${s},${a}`);const r=this.area.getTiles();this.state[s][a].loadState=l.LOADED2JSON,this.area.setUnloaded(s,a);const o=r[s][a].getLevels();this.game.removeLevels(o);const c=r[s][a].getLevel();if(i(`\tUnloading battles @ ${s},${a}, id: ${c.getID()}`),this.game.getGameMaster().unloadBattles(c),i.enabled){const e=r[s][a].getLevels().map(e=>e.getID());i(`\t-- Unloading levels ${e}`)}if(r[s][a].removeListeners(),r[s][a]=r[s][a].toJSON(),"WEST"===n){const e=s-1;i(`Removing connections from tile ${s-1},${a}`),e<this.area.getSizeX()&&this.removeConnections("EAST",r[s-1][a])}else if("EAST"===n){const e=s+1;i(`Removing connections from tile ${s+1},${a}`),e<this.area.getSizeX()&&this.removeConnections("WEST",r[s+1][a])}else if("NORTH"===n){const e=a-1;i(`Removing connections from tile ${s},${a-1}`),e>=0&&this.removeConnections("SOUTH",r[s][a-1])}else if("SOUTH"===n){const e=a+1;i(`Removing connections from tile ${s},${a+1}`),e<this.area.getSizeY()&&this.removeConnections("NORTH",r[s][a+1])}else this.inLoadRange(e,t,s,a-1)&&a-1>=0&&this.isLoaded(s,a-1)&&(i(`Rm SOUTH conns from ${s},${a-1}`),this.removeConnections("SOUTH",r[s][a-1])),this.inLoadRange(e,t,s,a+1)&&a+1<this.area.getSizeY()&&this.isLoaded(s,a+1)&&(i(`Rm NORTH conns from ${s},${a+1}`),this.removeConnections("NORTH",r[s][a+1])),this.inLoadRange(e,t,s+1,a)&&s+1<this.area.getSizeX()&&this.isLoaded(s+1,a)&&(i(`Rm WEST conns from ${s+1},${a}`),this.removeConnections("WEST",r[s+1][a])),this.inLoadRange(e,t,s-1,a)&&s-1>=0&&this.isLoaded(s-1,a)&&(i(`Rm EAST conns from ${s-1},${a}`),this.removeConnections("EAST",r[s-1][a]));this.state[s][a].loadState=l.JSON}getLoadState(e,t){return this.state[e][t].loadState}toJSON(){return{state:this.state}}setLoadStateAll(e){this.state.forEach((t,s)=>{t.forEach((t,a)=>{this.state[s][a].loadState=e})})}createTiles(e){const t=e.length;i(`Creating ${t} AreaTiles with FromJSON`);const s=new r.FromJSON;s.setChunkMode(!0),s.createTiles(this.game,e)}addConnections(e,t,s){const a=this.getOpposite(e),n=this.getReplacedConnections(e,t),o=this.getReplacedConnections(a,s),i=new r.FromJSON,l=n.concat(o),c=[t.getLevel(),s.getLevel()];i.connectTileLevels(c,l)}removeConnections(e,t){this.getReplacedConnections(e,t).forEach(e=>{const t=e.getTargetStairs(),s=e.getTargetLevel();if(s instanceof o.Level){const a={targetLevel:s.getID(),targetStairs:{x:t.getX(),y:t.getY()}};e.setConnObj(a)}})}getReplacedConnections(e,t){const s=t.getLevel().getConnections();0===s.length&&n.default.err("ChunkManager","getReplacedConnections","No connections found.");let a=[];return"SOUTH"===e?a=s.filter(e=>e.getY()===t.rows-1):"NORTH"===e?a=s.filter(e=>0===e.getY()):"EAST"===e?a=s.filter(e=>e.getX()===t.cols-1):"WEST"===e&&(a=s.filter(e=>0===e.getX())),a}getOpposite(e){switch(e){case"NORTH":return"SOUTH";case"SOUTH":return"NORTH";case"EAST":return"WEST";case"WEST":return"EAST";default:n.default.err("ChunkManager","getOpposite",`Illegal dir ${e} given.`)}return""}getMoveDir(e,t,s,a){let[r,o]=[0,0],i="";if(!n.default.isNullOrUndef([s,a])){if(o=t-a,0!==(r=e-s)&&0!==o){const r=`MOVE: ${s},${a} -> ${e},${t}`;n.default.err("ChunkManager","getMoveDir",`Diagonal move not supported: ${r}`)}r>0?i="EAST":r<0&&(i="WEST"),o>0?i="SOUTH":o<0&&(i="NORTH")}return i}debugPrint(){let e="";for(let t=0;t<this.sizeY;t++){for(let s=0;s<this.sizeX;s++)e+=" "+this.stateToChar(this.state[s][t]);e+=` - ${t} \n`}e+="\n\tNum loaded: "+this.getNumInState(l.LOADED),e+="\n\tNum serialized: "+this.getNumInState(l.JSON),e+="\n\tNum on disk: "+this.getNumInState(l.ON_DISK),e+="\n";for(let t=0;t<this.area.getSizeY();t++){for(let s=0;s<this.area.getSizeX();s++){e+=`${s},${t}: `+(this.area.zonesCreated[s+","+t]?" X ":" - ")+"|"}e+="\n"}n.default.diag(e)}stateToChar(e){switch(e.loadState){case l.LOADED:return"L";case l.JSON:return"J";case l.ON_DISK:return"D";case l.EMPTY:return"E";case l.LOADED2JSON:return"*";default:return""}}}t.ChunkManager=h,t.Chunk={},t.Chunk.printTileConnections=function(e,t,s=-1){n.default.diag(e),"function"==typeof t.getLevel?t.getLevel().getID()!==s&&-1!==s||t.getLevel().getConnections().forEach(e=>{const t=e.getTargetLevel();Number.isInteger(t)?console.log(`\tTarget ID ${t} found`):console.log(`\tLevel ${t.getID()} found`)}):console.log("Skipping printTileConnections due to json input")},t.Chunk.LOAD=l,t.Chunk.CREATE=c,t.Chunk.ChunkManager=h},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=n(s(32)),i=s(160),l=s(163);t.Engine=class{constructor(e){this.isGUICommand=(()=>!1),this.doGUICommand=null,this.nextActor=null,this.animation=null,this.animationCallback=null,this._levelMap={},this._activeLevels=[],this._scheduler=new o.Scheduler,this._msg=new l.MessageHandler(e),this._eventPool=e,this.visibleCells=[],this._cache={visibleCoord:{},visibleValid:!1},this.sysMan=new i.SystemManager(this,e),this.hasNotify=!0,this._eventPool.listenEvent(r.default.EVT_DESTROY_ITEM,this),this._eventPool.listenEvent(r.default.EVT_ACT_COMP_ADDED,this),this._eventPool.listenEvent(r.default.EVT_ACT_COMP_REMOVED,this),this._eventPool.listenEvent(r.default.EVT_ACT_COMP_ENABLED,this),this._eventPool.listenEvent(r.default.EVT_ACT_COMP_DISABLED,this),this._eventPool.listenEvent(r.default.EVT_LEVEL_PROP_ADDED,this),this._eventPool.listenEvent(r.default.EVT_LEVEL_CHANGED,this),this._eventPool.listenEvent(r.default.EVT_ANIMATION,this)}getMessages(){return this._msg.getMessages()}hasNewMessages(){return this._msg.hasNew()}clearMessages(){this._msg.clear()}isMenuShown(){return!!this.nextActor.isPlayer()&&this.nextActor.getBrain().isMenuShown()}getPlayer(){return this.currPlayer}setPlayer(e){this.currPlayer=e}numActiveLevels(){return this._activeLevels.length}hasLevel(e){return this._levelMap.hasOwnProperty(e.getID())}getLevels(){return Object.values(this._levelMap)}isGameOver(){return!1}isActiveLevel(e){return this._activeLevels.indexOf(e.getID())>=0}hasAnimation(){return null!==this.animation&&this.animation.hasFrames()}finishAnimation(){this.animation=null}setVisibleArea(e,t){this.visibleLevelID=e.getID(),this.visibleCells=t,this._cache.visibleCoord={},this._cache.visibleValid=!1}canPlayerSeeAnimation(e){return e.levelID===this.visibleLevelID&&(this._cache.visibleValid||(this.visibleCells.forEach(e=>{this._cache.visibleCoord[e.getKeyXY()]=!0}),this._cache.visibleValid=!0),e.hasCoord(this._cache.visibleCoord))}enableAnimations(){this.sysMan.get("Animation").enableAnimations()}disableAnimations(){this.sysMan.get("Animation").disableAnimations()}addTimeSystem(e,t){const s=new o.GameEvent(100,t.update.bind(t),!0,0);this.addEvent(s)}addRegularUpdate(e,t=100){const s=new o.GameEvent(t,e.update.bind(e),!0,0);this.addEvent(s)}getComponents(){const e=this.getEntities();let t=[];return e.forEach(e=>{const s=Object.keys(e.getComponents());t=t.concat(s.map(e=>parseInt(e,10)))}),t}getEntities(){const e=this.getLevels();let t=[];return e.forEach(e=>{t=(t=(t=t.concat(e.getActors())).concat(e.getItems())).concat(e.getElements())}),t}updateGameLoop(e){for(this.playerCommand(e),this.currPlayer=this.nextActor,this.nextActor=this.getNextActor(),this.sysMan.updateLoopSystems();!this.nextActor.isPlayer()&&!this.isGameOver();){const e=this.nextActor.nextAction();if(this.doAction(e),this.sysMan.updateSystems(),this.nextActor=this.getNextActor(),r.default.isNullOrUndef([this.nextActor])){r.default.err("Game.Engine","updateGameLoop","Game loop out of events! Fatal!");break}}this.isGameOver()||this.setPlayer(this.nextActor)}updateLoopSystems(){this.sysMan.updateLoopSystems()}playerCommand(e){if(!1===this.nextActor.isPlayer()){let e="";e=this.nextActor.hasOwnProperty("isEvent")?"Expected player, got an event: ":"Expected player, got: "+this.nextActor.getName(),e+="\n"+JSON.stringify(this.nextActor),r.default.err("Engine","playerCommand",e)}const t=this.nextActor.nextAction(e);this.doAction(t),this.sysMan.updateSystems(),this.playerCommandCallback(this.nextActor)}simulateGame(e=1){for(let t=0;t<e;t++)if(this.nextActor=this.getNextActor(),this.nextActor.isPlayer())r.default.err("Engine","simulateGame","Doesn't work with player.");else{const e=this.nextActor.nextAction();this.doAction(e),this.sysMan.updateSystems()}}addLevel(e){const t=e.getID();this._levelMap.hasOwnProperty(t)?r.default.err("Game.Engine","addLevel","Level ID "+t+" already exists!"):this._levelMap[e.getID()]=e}removeLevels(e){e.forEach(e=>{const t=e.getID();if(this._levelMap.hasOwnProperty(t)){const e=this._activeLevels.indexOf(t);if(e>=0){this._activeLevels.splice(e,1);const s=this._levelMap[t];if(s){const e=s.getActors();for(let t=0;t<e.length;t++)e[t].get("Action").disable()}}delete this._levelMap[t]}else r.default.err("Game.Engine","removeLevels",`No level with ID ${t}`)})}addActiveLevel(e){const t=e.getID(),s=this._activeLevels.indexOf(t);if(this._activeLevels.length===r.default.MAX_ACTIVE_LEVELS)if(-1===s){const e=this._activeLevels.pop(),t=this._levelMap[e];if(t){const e=t.getActors();for(let t=0;t<e.length;t++){const s=e[t].get("Action");s&&s.disable()}r.default.debug(this,"Removed active level to make space...")}else{const t=Object.keys(this._levelMap).join(", ");r.default.err("Game.Engine","addActiveLevel",`Failed to remove level ID ${e}.\n                        IDs: ${t}`)}}else this._activeLevels.splice(s,1),this._activeLevels.unshift(t),r.default.debug(this,"Moved level to the front of active levels.");if(-1===s){this._activeLevels.unshift(t);const s=e.getActors();for(let e=0;e<s.length;e++){const t=s[e].get("Action");t&&t.enable()}}}notify(e,t){if(e===r.default.EVT_DESTROY_ITEM){const e=t.item;e.getOwner().getOwner().getInvEq().removeItem(e)||r.default.err("Game.Engine","notify - DESTROY_ITEM","Failed to remove item from inventory.")}else if(e===r.default.EVT_ACT_COMP_ADDED)t.hasOwnProperty("actor")?this.addActor(t.actor):r.default.err("Game.Engine","notify - ACT_COMP_ADDED","No actor specified for the event.");else if(e===r.default.EVT_ACT_COMP_REMOVED)t.hasOwnProperty("actor")?this.removeActor(t.actor):r.default.err("Game.Engine","notify - ACT_COMP_REMOVED","No actor specified for the event.");else if(e===r.default.EVT_ACT_COMP_ENABLED)t.hasOwnProperty("actor")?this.addActor(t.actor):r.default.err("Game.Engine","notify - ACT_COMP_ENABLED","No actor specified for the event.");else if(e===r.default.EVT_ACT_COMP_DISABLED)t.hasOwnProperty("actor")?this.removeActor(t.actor):r.default.err("Game","notify - ACT_COMP_DISABLED","No actor specified for the event.");else if(e===r.default.EVT_LEVEL_PROP_ADDED)"actors"===t.propType&&this.isActiveLevel(t.level)&&t.obj.get("Action").enable();else if(e===r.default.EVT_LEVEL_CHANGED){const e=t.actor;e.isPlayer()&&(this.addActiveLevel(e.getLevel()),t.src.onExit(),t.src.onFirstExit(),t.target.onEnter(),t.target.onFirstEnter())}else e===r.default.EVT_ANIMATION&&this.canPlayerSeeAnimation(t.animation)&&this.animationCallback&&(this.animation?this.animation.combine(t.animation):this.animation=t.animation,this.animationCallback(this.animation))}update(e){if(this.isGameOver())this.clearMessages(),this._eventPool.emitEvent(r.default.EVT_MSG,{msg:"GAME OVER!"}),this.simulateGame(100);else if(this.clearMessages(),null!==this.nextActor)if(e.hasOwnProperty("code")){const t=e.code;!this.isMenuShown()&&this.isGUICommand(t)?(this.doGUICommand(t),this.playerCommandCallback(this.nextActor)):this.updateGameLoop({code:t})}else this.updateGameLoop(e)}getNextActor(){return this._scheduler.next()}addActor(e){this._scheduler.add(e,!0,0)}removeActor(e){this._scheduler.remove(e)}addEvent(e){const t=e.getRepeat(),s=e.getOffset();this._scheduler.add(e,t,s)}doAction(e){if(this._scheduler.setAction(e),e.doAction(),e.hasOwnProperty("energy")&&e.hasOwnProperty("actor")){const t=e.actor;t.has("Action")&&t.get("Action").addEnergy(e.energy)}}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0)),r=s(161);class o{static addSystemBefore(e,t){const s=o.systemOrder.indexOf(t);s>=0&&o.insertSystemAt(s,e)}static addSystemAfter(e,t){const s=o.systemOrder.indexOf(t);s>=0&&o.insertSystemAt(s+1,e)}static removeSystem(e){delete o.systems[e];const t=o.systemOrder.indexOf(e);t>=0&&o.systemOrder.splice(t,1)}static insertSystemAt(e,t){o.systemOrder.splice(e,0,t.name),"function"==typeof t.create?t.name?o.systems[t.name]=t:n.default.err("SystemManager","insertSystemAt","No system.name given"):n.default.err("SystemManager","insertSystemAt","Object must specify system.create")}constructor(e,t){this._engine=e,this.systemOrder=o.systemOrder;const s={};Object.keys(o.systems).forEach(e=>{const a=o.systems[e];if(a.create){const n=a;s[e]=n.create(n.comps,t)}else Array.isArray(a)&&(r.System[e]?s[e]=new r.System[e](a,t):n.default.err("SystemManager","new",`System[${e}] not found for new`))}),this.systems=s,this.loopSystemOrder=["Hunger"],this.loopSystems={},this.loopSystems.Hunger=new r.System.Hunger(["Action","Hunger"],t),this.timeSystems={};const a=new r.System.TimeEffects(["Expiration","Poison","Fading","Heat","Coldness","DirectDamage","RegenEffect"],t);this.timeSystems.TimeEffects=a,this._engine.addTimeSystem("TimeEffects",a)}get(e){return this.systems.hasOwnProperty(e)?this.systems[e]:null}updateSystems(){for(let e=0;e<this.systemOrder.length;e++){const t=this.systemOrder[e];this.systems[t].update()}}updateLoopSystems(){for(let e=0;e<this.loopSystemOrder.length;e++){const t=this.loopSystemOrder[e];this.loopSystems[t].update()}}setRNG(e){Object.values(this.systems).forEach(t=>{t.setRNG(e)})}}t.SystemManager=o,o.systemOrder=["AreaEffects","Disability","SpiritBind","BaseAction","Equip","Attack","Chat","Shop","SpellCast","SpellEffect","Missile","Movement","Effects","Animation","Damage","Battle","Skills","Quest","ExpPoints","Communication","Events","Weather"],o.systems={Disability:["Stun","Entrapped","Paralysis"],SpiritBind:["SpiritBind"],BaseAction:["Pickup","UseStairs","OpenDoor","UseItem","UseElement","Jump","Read","Rest","Give"],Chat:["Chat"],Shop:["Transaction"],Attack:["Attack"],Missile:["Missile"],Movement:["Movement"],Damage:["Damage","Health"],Battle:["BattleOver","BattleOrder"],Skills:["SkillsExp"],Events:["Event"],AreaEffects:["Flame"],Equip:["Equip"],SpellCast:["SpellCast","PowerDrain"],SpellEffect:["SpellRay","SpellCell","SpellMissile","SpellArea","SpellSelf"],Effects:["Effects"],Animation:["Animation"],ExpPoints:["ExpPoints","Experience"],Communication:["Communication"],Quest:["GiveQuest","QuestCompleted","QuestTargetEvent"],Weather:["WeatherEffect"]}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0));t.System={};const r=s(4);var o=s(4);t.SystemBase=o.SystemBase,t.System.Base=r.SystemBase;const i=s(89);var l=s(89);t.SystemAnimation=l.SystemAnimation,t.System.Animation=i.SystemAnimation;const c=s(90);var h=s(90);t.SystemAreaEffects=h.SystemAreaEffects,t.System.AreaEffects=c.SystemAreaEffects;const u=s(91);var d=s(91);t.SystemAttack=d.SystemAttack,t.System.Attack=u.SystemAttack;const g=s(92);var p=s(92);t.SystemBaseAction=p.SystemBaseAction,t.System.BaseAction=g.SystemBaseAction;const m=s(93);var f=s(93);t.SystemBattle=f.SystemBattle,t.System.Battle=m.SystemBattle;const y=s(94);var _=s(94);t.SystemChat=_.SystemChat,t.System.Chat=y.SystemChat;const E=s(95);var S=s(95);t.SystemCommunication=S.SystemCommunication,t.System.Communication=E.SystemCommunication;const v=s(96);var C=s(96);t.SystemDamage=C.SystemDamage,t.System.Damage=v.SystemDamage;const b=s(97);var T=s(97);t.SystemDisability=T.SystemDisability,t.System.Disability=b.SystemDisability;const A=s(66);var w=s(66);t.SystemEffects=w.SystemEffects,t.System.Effects=A.SystemEffects;const O=s(98);var M=s(98);t.SystemEquip=M.SystemEquip,t.System.Equip=O.SystemEquip;const P=s(99);var N=s(99);t.SystemEvents=N.SystemEvents,t.System.Events=P.SystemEvents;const I=s(100);var D=s(100);t.SystemExpPoints=D.SystemExpPoints,t.System.ExpPoints=I.SystemExpPoints;const L=s(101);var R=s(101);t.SystemHunger=R.SystemHunger,t.System.Hunger=L.SystemHunger;const x=s(102);var k=s(102);t.SystemMissile=k.SystemMissile,t.System.Missile=x.SystemMissile;const B=s(103);var G=s(103);t.SystemMovement=G.SystemMovement,t.System.Movement=B.SystemMovement;const W=s(40);var F=s(40);t.SystemQuest=F.SystemQuest,t.System.Quest=W.SystemQuest;const Y=s(104);var X=s(104);t.SystemShop=X.SystemShop,t.System.Shop=Y.SystemShop;const $=s(105);var j=s(105);t.SystemSkills=j.SystemSkills,t.System.Skills=$.SystemSkills;const V=s(106);var U=s(106);t.SystemSpellCast=U.SystemSpellCast,t.System.SpellCast=V.SystemSpellCast;const K=s(107);var H=s(107);t.SystemSpellEffect=H.SystemSpellEffect,t.System.SpellEffect=K.SystemSpellEffect;const q=s(108);var J=s(108);t.SystemSpiritBind=J.SystemSpiritBind,t.System.SpiritBind=q.SystemSpiritBind;const Q=s(109);var z=s(109);t.SystemTimeEffects=z.SystemTimeEffects,t.System.TimeEffects=Q.SystemTimeEffects;const Z=s(110);var ee=s(110);t.SystemWeather=ee.SystemWeather,t.System.Weather=Z.SystemWeather,t.System.defineSystem=function(e){const s=e.toUpperCase();n.default.SYS[s]=Symbol();const a=class extends r.SystemBase{constructor(e,...t){super(n.default.SYS[s],e),this._init&&"function"==typeof this._init&&this._init(e,...t)}};return t.System[e]=a,a},t.System.undefineSystem=function(e){const s=e.toUpperCase();delete n.default.SYS[s],delete t.System[e]}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.Animation=class{constructor(){this.levelID=-1,this.numFrames=0,this.currFrame=0,this.slowDown=2,this.frames=[]}setLevel(e){this.levelID=e.getID()}addFrame(e){for(let t=0;t<this.slowDown;t++)++this.numFrames,this.frames.push(e)}nextFrame(){return this.frames[this.currFrame++]}hasFrames(){return this.currFrame<this.frames.length}combine(e){let t=0;for(;e.hasFrames();){const s=e.nextFrame();if(t<this.frames.length){const e=Object.keys(s);for(let a=0;a<e.length;a++){const n=e[a];this.frames[t][n]=s[n]}}else this.frames.push(s);++t}}hasCoord(e){const t=this.frames.length;for(let s=0;s<t;s++){const t=this.frames[s];for(const s in t)if(e[s])return!0}return!1}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=a(s(0));t.MessageHandler=class{constructor(e){this._lastMsg=null,this._messages=[],this._prevMessages=[],this._hasNew=!1,this.hasNotify=!0,e.listenEvent(n.default.EVT_MSG,this)}notify(e,t){if(e===n.default.EVT_MSG&&t.hasOwnProperty("msg")){const e={msg:t.msg,style:"prim",count:1};t.hasOwnProperty("cell")&&(e.cell=t.cell),t.hasOwnProperty("style")&&(e.style=t.style),this._lastMsg&&this._lastMsg.msg===e.msg?this._lastMsg.count+=1:(this._lastMsg=e,this._messages.push(e)),this._hasNew=!0}}hasNew(){return this._hasNew}getMessages(){return this._hasNew=!1,this._messages.length>0?this._messages:this._prevMessages.length>0?this._prevMessages:[]}clear(){this._messages.length>0&&(this._prevMessages=this._messages.slice()),this._messages=[]}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=a(s(0)),o=s(165),i=s(47),l=s(22),c=s(1),h=s(7),u=n(s(2)),d=s(8)("bitn:GameMaster"),g=h.EventPool.getPool(),p=c.Random.getRNG();t.GameMaster=class{constructor(e,t=g){this.player=null,this.game=e,this.fact=new o.FactoryBattle,this.pool=t,this.battles={},this.battlesDone={},this.hasNotify=!0,this.pool.listenEvent(r.default.EVT_LEVEL_CHANGED,this),this.pool.listenEvent(r.default.EVT_TILE_CHANGED,this),this.pool.listenEvent(r.default.EVT_BATTLE_OVER,this),this.pool.listenEvent(r.default.EVT_CREATE_BATTLE,this)}setBattles(e){this.battles=e}setPool(e){this.pool=e}setGame(e){this.game=e}setPlayer(e){this.player=e}setWorld(e){this.world=e}notify(e,t){if(e===r.default.EVT_LEVEL_CHANGED){d("EVT_LEVEL_CHANGED");const{actor:e}=t;e.isPlayer()&&(e.has("InBattle")?this.removePlayerFromBattle(t):this.tryToAddPlayerToBattle(t))}else if(e===r.default.EVT_CREATE_BATTLE){d("EVT_CREATE_BATTLE");const{areaTile:e}=t;t.response&&r.default.err("GameMaster","notify<EVT_CREATE_BATTLE>",`Args has response already: ${JSON.stringify(t)}`);const s=e.getLevel(),a=this.createBattleIntoAreaTileLevel(s);a&&(t.response={battle:a})}else if(e===r.default.EVT_TILE_CHANGED){if(d("EVT_TILE_CHANGED"),!this.player)return void d("\tBut player is NULL for the moment");d("\tPlayer not null. Creating battle");const e=this.player.getLevel();this.createBattleIntoAreaTileLevel(e)}else if(e===r.default.EVT_EXPLORED_ZONE_LEFT)r.default.diag("Explored zone left");else if(e===r.default.EVT_BATTLE_OVER){const{battle:e}=t;d(`EVT_BATTLE_OVER: ${e.getName()}`);const s=e.getLevel().getID();if(d(`1. battlesDone for ${s}: ${this.battlesDone[s]}`),!this.battlesDone[s]&&e){d(`2. battlesDone for ${s}: ${this.battlesDone[s]}`),this.battlesDone[s]=!0,d(`3. battlesDone for ${s}: ${this.battlesDone[s]}`),this.addBadgesForActors(e),this.moveActorsOutOfBattle(e);const t=e.getName();r.default.gameMsg(`Battle ${t} is over!`)}else{const e=JSON.stringify(t);r.default.err("Game.Master","notify",`Args ${e} does not contain "battle"`)}d("GameMaster registered battle over")}}getLevelBbox(e,t,s,a,n){const[r,o]=[e.getSizeX(),e.getSizeY()],[i,l]=a,[c,h]=[t.getSizeX(),t.getSizeY()],[u,d]=n.getColsRows(),g=c*u/r,p=h*d/o,m=i%(r/c),f=l%(o/h);return{ulx:m*g,uly:f*p,lrx:(m+1)*g-1,lry:(f+1)*p-1}}tryToAddPlayerToBattle(e){const{actor:t,target:s,src:a}=e,n=a.getID();if(this.battles.hasOwnProperty(n)){const e=this.getBattle(n);if(e.isJSON)return;const a=e;if(a.getLevel().getID()===s.getID())if(this.actorCanEnter(t,a)){const e=new u.InBattle;e.setData({name:a.getName()}),t.add(e);const s=this.getSelArmyObject(t,a);t.getBrain().setSelectionObject(s)}else a.isOver()?r.default.gameMsg("Looks like the battle is already fought.."):r.default.gameMsg("You cannot join the fight anymore, deserter.")}}addBattle(e,t){this.battles[e].push(t)}getBattle(e){return this.battles[e][0]}getBattles(e){return this.battles[e]}actorCanEnter(e,t){return!t.isOver()&&!this.actorDesertedBattle(e,t)}removePlayerFromBattle(e){const{actor:t,target:s,src:a}=e,n=s.getID(),o=a.getID(),i=this.getBattle(n),l=i.getLevel().getID(),c=t.get("InBattle").getData();if(o!==l){const e=`Level ID mismatch: ${o} !== ${l}`;r.default.err("GameMaster","removePlayerFromBattle",e)}if(!i.isOver()&&c.army){const e=new u.BattleBadge;e.setData({status:"Fled",name:i.getName(),army:c.army}),t.add(e),t.remove("InBattle"),t.add(new u.BattleOver)}else i.isOver()||c.army||t.remove("InBattle")}addBadgesForActors(e){e.getArmies().forEach(t=>{const s=t.getActors(),a=s.map(e=>e.getID());s.forEach(s=>{if(!this.actorDesertedBattle(s,e)){const n=new u.BattleBadge,r={name:e.getName(),army:t.getName(),allies:a,status:t.isDefeated()?"Lost":"Won"};n.setData(r),s.add(n),s.remove("InBattle"),s.add(new u.BattleOver)}})})}actorDesertedBattle(e,t){return!!e.getList("BattleBadge").find(e=>e.getData().name===t.getName())}moveActorsOutOfBattle(e){const t=e.getLevel(),s=t.getConnections();s&&0!==s.length||r.default.err("Game.Master","moveActorsOutOfBattle","No exit connnection in level");const a=s[0].getTargetLevel();e.getArmies().forEach(e=>{e.getActors().forEach(e=>{if(e.isInLevel(t))if(e.isPlayer()){const s=this.getSelLeaveBattle(e,t);e.getBrain().setSelectionObject(s)}else if(t.removeActor(e))a.addActorToFreeCell(e);else{const t=JSON.stringify(e.toJSON());r.default.err("Game.Master","moveActorsOutOfBattle",`level.removeActor failed for actor ${t}`)}})})}getSelArmyObject(e,t){const s=t.getArmies(),a=a=>{const n=s[a],o=t.getLevel();let i=n.getActors();const l=i.length,c=i[p.getUniformInt(0,l-1)],[h,u]=c.getXY();c.get("Action").disable(),n.removeActor(c),o.removeActor(c),i=n.getActors(),n.addActor(e),e.get("InBattle").updateData({army:n.getName}),i.forEach(t=>{t.addFriend(e)}),s.forEach(t=>{t!==n&&t.getActors().forEach(t=>{t.addEnemy(e)})}),o.moveActorTo(e,h,u)||r.default.err("GameMaster","getSelArmyObject",`Could not move player to ${h},${u}`)},n=s.map((e,t)=>[" Army "+e.getName(),a.bind(this,t)]);n.push(["Take no side",l.Menu.EXIT_MENU]);const o=new l.Menu.SelectRequired(n);return o.addPre("Please select an army to join:"),o}getSelLeaveBattle(e,t){const s=[["Leave immediately",()=>{if(t.getConnections()[0].useStairs(e)){const t=e.getName();r.default.gameMsg(`${t} leaves the battlefield`)}else r.default.err("GameMaster","moveActorsOutOfBattle","Cannot move player via useStairs")}],["Stay behind to scavenge the bodies of the dead.",l.Menu.EXIT_MENU]],a=new l.Menu.SelectRequired(s);return a.addPre("Battle is over! Do you want to leave battle?"),a}toJSON(){const e=Object.keys(this.battles),t={};return e.forEach(e=>{this.getBattles(e).forEach(s=>{t.hasOwnProperty(e)?r.default.warn("Game.Master","toJSON",`Battle for ID ${e} exists already`):t[e]=[],"function"==typeof s.toJSON?t[e].push(s.toJSON()):s.name?t[e].push(s):r.default.err("GameMaster","toJSON","Does not look like proper battle object.")})}),{battles:t,battlesDone:this.battlesDone}}unloadBattles(e){const t=e.getID();if(this.battles.hasOwnProperty(t)){const e=this.getBattles(t);this.battles[t]=[],e.forEach(e=>{if("function"==typeof e.toJSON){const s=e;s.isOver()||s.removeListeners(),this.battles[t].push(s.toJSON())}else r.default.err("GameMaster","unloadBattle",`Unload for level ${t} failed`)})}}biomeToLevelType(e){switch(e){case i.OW.BIOME.ARCTIC:case i.OW.BIOME.TUNDRA:return"arctic";case i.OW.BIOME.ALPINE:return"mountain";case i.OW.BIOME.TAIGA:default:return"forest"}}getBattleLevels(){const e=[];return Object.values(this.battles).forEach(t=>{t.forEach(t=>{t.isJSON||e.push(t.getLevel())})}),e}createBattleIntoAreaTileLevel(e){e||r.default.err("GameMaster","createBattleIntoAreaTileLevel","Parent level is null");const t=e.getID(),s=this.game.getOverWorld();let a=4,n=20;const o={};let i="forest",l=e.getBbox();if(s){const r=this.game.getCurrentWorld().getAreas()[0],o=r.findTileXYById(t),c=2,h=r.getSizeY()-1,u=Math.abs(c-o[0]),g=Math.abs(h-o[1]);d(`${`dx,dy: ${u},${g} armySize ${n+=20*g+10*u}`} , danger: ${a+=u+g}`);const p=this.game.getPlayerOwPos();if(p&&p.length>1){const t=s.getBiome(p[0],p[1]);i=this.biomeToLevelType(t),d("Creating battle on tile "+o),l=this.getLevelBbox(s,r,o,p,e)}}if(o.maxDanger=a,o.armySize=n,o.levelType=i,o.bbox=l,!this.battles.hasOwnProperty(t)){this.battles[t]=[];const s=this.fact.createBattle(e,o);return this.addBattle(t,s),this.game.addBattle(this.getBattle(t),t),s}return null}}},function(e,t,s){"use strict";var a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});const r=s(54),o=a(s(0)),i=s(21),l=s(59),c=s(1),h=s(17),u=s(6),d=n(s(10)),g=n(s(2)),p=n(s(56)),m=n(s(5)).ElementStairs,f=c.Random.getRNG(),y=["avianfolk","human","dwarf","dogfolk","wolfclan","goblin","catfolk","bearfolk","wildling","undead"];t.FactoryBattle=class{constructor(){this.minCommDanger=5}createBattle(e,t={}){const s=t.cols||80,a=t.rows||40,n=e?e.getID():0,r=t.name||"Battle of level "+n,c=new l.Battle(r),h=this.createBattleLevel(s,a,t);c.setLevel(h);const[u,d]=this.getFactions(t);let g=t.numRows||2;const p=t.armySize||20,y=t.numArmies||2,_=t.armies||[u,d];let E=Math.ceil(p/g);for(;E>s;)++g,E=Math.ceil(p/g);const S=[];for(let e=0;e<y;e++){const n=this.createArmy(c,_[e],t);let r=f.getUniformInt(0,s-1),i=f.getUniformInt(0,a-1);r+E>s-1&&(r=s-E),i+g>a-1&&(i=a-1-g),t.centerX&&(r=Math.floor(s/2),r-=Math.floor(p/g/2)),t.centerY&&(i=Math.floor(a/2),i-=e*(g+2)),(r>s-1||r<0)&&o.default.err("FactoryBattle","createBattle",`armyX ${r} out of bounds 0-${s-1}`),(i>a-1||i<0)&&o.default.err("FactoryBattle","createBattle",`armyY ${i} out of bounds 0-${a-1}`);const l={horizontal:!0,numRows:g};c.addArmy(n,r,i,l),S.push(n)}if(this.makeArmiesAsEnemies(S),e){const s=new m("battle",e),a=e.getMap();if(t.bbox){const{bbox:n}=t;let r=f.getRandInBbox(n),i=a.getCell(r[0],r[1]),l=o.default.WATCHDOG;for(;i.hasProps()&&(r=f.getRandInBbox(n),i=a.getCell(r[0],r[1]),0!=--l););e.addStairs(s,r[0],r[1])}else e.addStairs(s,4,4);i.World.addExitsToEdge(h);const n=h.getConnections();s.connect(n[0]);for(let t=1;t<n.length;t++)n[t].setTargetLevel(e),n[t].setTargetStairs(s)}return c}getFactions(e){let t=null,s=null;if(e.factions)[t,s]=e.factions;else for(t=f.arrayGetRand(y),s=f.arrayGetRand(y);t===s;)s=f.arrayGetRand(y);return[t,s]}createArmy(e,t,s){const a=u.ObjectShell.getParser(),n=s.armySize||20,i=s.danger||5,c=new l.Army(t),h=[{op:"eq",prop:"type",value:t},{op:"lte",prop:"danger",value:i}],d=(new r.Constraints).getConstraints(h);for(let t=0;t<n-1;t++){const t=a.createRandomActor({func:d});if(t){const s=new g.InBattle;s.setData({name:e.getName(),army:c.getName()}),t.add(s),c.addActor(t)}}const p=a.createRandomActor({func:e=>e.type===t&&e.danger>=this.minCommDanger});if(p){this.addCommanderAbilities(p);const t=new g.InBattle;t.setData({name:e.getName(),army:c.getName()}),p.add(t),c.addActor(p)}else o.default.warn("FactoryBattle","createArmy","No commander for army generated");return c.setDefeatThreshold(Math.round(.1*n)),c}makeArmiesAsEnemies(e){e.forEach(t=>{e.forEach(e=>{t.getName()!==e.getName()&&t.getActors().forEach(t=>{e.getActors().forEach(e=>{t.addEnemy(e),e.addEnemy(t)})})}),t.getActors().forEach(e=>{t.getActors().forEach(t=>{e.getID()!==t.getID()&&(e.addFriend(t),t.addFriend(e))})})})}createBattleLevel(e,t,s){const a=s.levelType||"forest",n=o.default.getForestConf(e,t);return h.FactoryLevel.createLevel(a,e,t,n)}addCommanderAbilities(e){const t=new d.BrainGoalOriented(e),s=new p.ThinkCommander(e);e.setBrain(t),t.setGoal(s),e.add(new g.Commander),e.setFOVRange(10)}}}]);
!function(e){var t={};function s(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(n,r,function(t){return e[t]}.bind(null,r));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/build/",s(s.s=257)}([function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});s(67);const n=s(1),r=s(12);const a=new class{constructor(){this.gameTitle="Battles in the North (BitN)",this.suppressErrorMessages=!1,this.suppressLogs=!1,this.suppressWarningMessages=!1,this.suppressDiagnosticMessages=!1,this.cellRenderVisible=["actors","items","elements"],this.cellRenderAlways=["items","elements"],this.ACTOR_MEDIUM_SQR=40,this.LOOT_MEDIUM_SQR=200,this.LEVEL_MEDIUM_X=80,this.LEVEL_MEDIUM_Y=40,this.debugZoneEvents=!1,this.POOL=r.EventPool.getPool(),this.charStyles={elements:{default:".",exit:".",exploration:"?",lever:"&",leverdoor:{isClosed:"+",default:"/"},marker:{getChar:"",default:"X"},passage:".",placeholder:"?",shop:".",stairsDown:">",stairsUp:"<",wall:"#",wallcave:"#",wallcrypt:"#",wallice:"#",wallwooden:"#",wallmount:"^",door:{isClosed:"+",default:"/"}},actors:{default:"@"},items:{default:"?",corpse:"§"}},this.cellStyles={elements:{default:"cell-element-default",door:"cell-element-door",exit:"cell-element-exit",exploration:"cell-element-exploration",marker:{getClassName:"",default:"cell-element-marker"},lever:"cell-element-door",leverdoor:"cell-element-door",passage:"cell-element-passage",placeholder:"cell-element-placeholder",shop:"cell-element-shop",stairsDown:"cell-element-stairs",stairsUp:"cell-element-stairs",wall:"cell-element-wall",wallcave:"cell-element-wall-cave",wallcrypt:"cell-element-wall-crypt",wallice:"cell-element-wall-ice",wallwooden:"cell-element-wall-wooden",wallmount:"cell-element-wall-mount"},actors:{default:"cell-actor-default",player:"cell-actor-player",spirit:"cell-actor-spirit"},items:{potion:"cell-item-potion",spiritgem:"cell-item-spiritgem",default:"cell-item-default"}},this.VERB={NONE:10,LOW:20,MEDIUM:30,HIGH:40,FULL:50,DEBUG:100},this.PLAYER_FOV_RANGE=10,this.NPC_FOV_RANGE=5,this.ACTION_DUR=100,this.BASE_SPEED=100,this.DEFAULT_HP=50,this.ACTION_OK=1,this.ACTION_FAILED=-1,this.MAX_ACTIVE_LEVELS=3,this.EVT={},this.EVT_ACTOR_CREATED="EVT_ACTOR_CREATED",this.EVT_ACTOR_KILLED="EVT_ACTOR_KILLED",this.EVT_PLAYER_KILLED="EVT_PLAYER_KILLED",this.EVT_DESTROY_ITEM="EVT_DESTROY_ITEM",this.EVT_MSG="EVT_MSG",this.EVT_LEVEL_CHANGED="EVT_LEVEL_CHANGED",this.EVT_LEVEL_ENTERED="EVT_LEVEL_ENTERED",this.EVT_TILE_CHANGED="EVT_TILE_CHANGED",this.EVT_TILE_ENTERED="EVT_TILE_ENTERED",this.EVT_TILE_LEFT="EVT_TILE_LEFT",this.EVT_EXPLORED_ZONE_LEFT="EVT_EXPLORED_ZONE_LEFT",this.EVT_LEVEL_PROP_ADDED="EVT_LEVEL_PROP_ADDED",this.EVT_LEVEL_PROP_REMOVED="EVT_LEVEL_PROP_REMOVED",this.EVT_ACT_COMP_ENABLED="EVT_ACT_COMP_ENABLED",this.EVT_ACT_COMP_DISABLED="EVT_ACT_COMP_DISABLED",this.EVT_ON_ADD_COMP="OnAddComponent",this.EVT_ON_REMOVE_COMP="OnRemoveComponent",this.EVT_WIN_COND_TRUE="EVT_WIN_COND_TRUE",this.EVT_ANIMATION="EVT_ANIMATION",this.EVT_CREATE_BATTLE="EVT_CREATE_BATTLE",this.EVT_BATTLE_OVER="EVT_BATTLE_OVER",this.EVT_ARMY_EVENT="EVT_ARMY_EVENT",this.EVT_ITEM_PICKED_UP="EVT_ITEM_PICKED_UP",this.EVT_ACTOR_DAMAGED="EVT_ACTOR_DAMAGED",this.EVT_ACTOR_ATTACKED="EVT_ACTOR_ATTACKED",this.EVT_ACTOR_USED_STAIRS="EVT_ACTOR_USED_STAIRS",this.EVT_WEATHER_CHANGED="EVT_WEATHER_CHANGED",this.EVT_DAY_PHASE_CHANGED="EVT_DAY_PHASE_CHANGED",this.EVT_DAY_CHANGED="EVT_DAY_CHANGED",this.EVT_MONTH_CHANGED="EVT_MONTH_CHANGED",this.EVT_SEASON_CHANGED="EVT_SEASON_CHANGED",this.EVT_YEAR_CHANGED="EVT_YEAR_CHANGED",this.TYPE_ACTOR="actors",this.TYPE_ELEM="elements",this.TYPE_ITEM="items",this.ITEM={},this.ITEM.BASE="base",this.ITEM.FOOD="food",this.ITEM.BOOK="book",this.ITEM.CORPSE="corpse",this.ITEM.WEAPON="weapon",this.ITEM.ARMOUR="armour",this.ITEM.SPIRITGEM="spiritgem",this.ITEM.GOLD="gold",this.ITEM.MINERAL="mineral",this.ITEM.MISSILE="missile",this.ITEM.MISSILE_WEAPON="missileweapon",this.ITEM.AMMUNITION="ammo",this.ITEM.POTION="potion",this.ITEM.RUNE="rune",this.ITEM.GOLD_COIN="goldcoin",this.SHOP_TYPES=["ammo","armour","food","mineral","missile","missileweapon","potion","rune","spiritgem","weapon"],this.USE={DRINK:"DRINK",DIG:"DIG",LEVER:"LEVER",SKILL:"SKILL",DEFAULT:""},this.LEVEL_ID_ADD=1e9,this.ENTITY_ID_ADD=1e9,this.WATCHDOG=100,this.NO_TARGET=-1,this.LEVEL_EMPTY="empty",this.LEVEL_FOREST="forest",this.LEVEL_MOUNTAIN="mountain",this.energy={ATTACK:15,DEFAULT:5,JUMP:50,MISSILE:10,MOVE:10,PICKUP:5,REST:5,RUN:20,USE:5,SPELL:15},this.BIAS={ALWAYS:10,NOT_POSSIBLE:-10,Explore:.2,Flee:.2,Guard:1.1,Order:.7,Patrol:1},this.FMODE_NORMAL=0,this.FMODE_FAST=1,this.FMODE_SLOW=2,this.ITEM_SUFFIX_CHANCE=.1,this.ITEM_PREFIX_CHANCE=.1,this.PROT_BYPASS_CHANCE=.05,this.MISSILE_CRITICAL_SHOT=.1,this.DANGER_ADJ_FACTOR=1.4,this.PLAYER_HP_REGEN_PERIOD=40,this.PLAYER_PP_REGEN_PERIOD=40,this.MIN_VALUE=30,this.MIN_DANGER=4,this.TRAINER_PROB=.2,this.EPIC_PROB=.05,this.GOLD_COIN_WEIGHT=.001,this.GOLD_COIN_NAME="Gold coin",this.GOLD_WEIGHT_ADJUST=600,this.HUNGER_PROB=.1,this.HUNGER_DMG=1,this.ALIGN_GOOD="ALIGN_GOOD",this.ALIGN_EVIL="ALIGN_EVIL",this.ALIGN_NEUTRAL="ALIGN_NEUTRAL",this.EVIL_RACES=["catfolk","dogfolk","wolfclan","wildling","undead","goblin"],this.NEUTRAL_RACES=["dwarf","bearfolk","animal"],this.ACTOR_RACES=["catfolk","dogfolk","wolfclan","wildling","goblin","bearfolk","dwarf","human","hyrkhian"],this.ACTOR_RACES=this.ACTOR_RACES.sort(),this.ALL_RACES=["avianfolk"].concat(this.ACTOR_RACES),this.CARDINAL_DIR=["north","south","east","west"],this.CARDINAL_DIR_ABBR=["N","S","E","W"],this.DIR={N:[0,-1],S:[0,1],E:[1,0],W:[-1,0],NE:[1,-1],SE:[1,1],NW:[-1,-1],SW:[-1,1]},this.DIR_NSEW=[this.DIR.N,this.DIR.S,this.DIR.E,this.DIR.W],this.DIR_DIAG=[this.DIR.NE,this.DIR.SE,this.DIR.NW,this.DIR.SW],this.SEASON={AUTUMN:"AUTUMN",AUTUMN_WINTER:"AUTUMN_WINTER",WINTER:"WINTER",WINTER_SPRING:"WINTER_SPRING",SPRING:"SPRING",SPRING_SUMMER:"SPRING_SUMMER",SUMMER:"SUMMER",SUMMER_AUTUMN:"SUMMER_AUTUMN"},this.DAY={DAWN:"DAWN",MORNING:"MORNING",NOON:"NOON",AFTERNOON:"AFTERNOON",EVENING:"EVENING",DUSK:"DUSK",NIGHT:"NIGHT"},this.AREA_LEVEL_COLS=100,this.AREA_LEVEL_ROWS=100,this.LETTERS=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],this.LETTERS_UC=this.LETTERS.map(e=>e.toUpperCase()),this.DMG={ACID:"ACID",BLUNT:"BLUNT",COLD:"COLD",DIRECT:"DIRECT",ENERGY:"ENERGY",EFFECT:"EFFECT",FIRE:"FIRE",HUNGER:"HUNGER",ICE:"ICE",LIGHTNING:"LIGHTNING",MAGIC:"MAGIC",MELEE:"MELEE",MISSILE:"MISSILE",NECRO:"NECRO",PIERCE:"PIERCE",POISON:"POISON",SLASH:"SLASH",SLIME:"SLIME",VOID:"VOID",WATER:"WATER"},this.EQUIP={HEAD:"head",NECK:"neck",CLOAK:"cloak",CHEST:"chest",HAND:"hand",SHIELD:"shield",LEGS:"legs",FEET:"feet",MISSILE:"missile",MISSILEWEAPON:"missileweapon",SPIRITGEM:"spiritgem"},this.classNameDMG={ACID:"cell-damage-ACID",BLUNT:"cell-damage-BLUNT",COLD:"cell-damage-COLD",ENERGY:"cell-damage-ENERGY",FIRE:"cell-damage-FIRE",HUNGER:"cell-damage-HUNGER",ICE:"cell-damage-ICE",LIGHTNING:"cell-damage-LIGHTNING",MAGIC:"cell-damage-MAGIC",MELEE:"cell-damage-MELEE",MISSILE:"cell-damage-MISSILE",NECRO:"cell-damage-NECRO",PIERCE:"cell-damage-PIERCE",POISON:"cell-damage-POISON",SLASH:"cell-damage-SLASH",WATER:"cell-damage-WATER",VOID:"cell-damage-VOID"},this.STATS=["Accuracy","Agility","Magic","Perception","Strength","Willpower","Spirituality"];this.ZONE_EVT={BATTLE_OVER:"BATTLE_OVER",ZONE_EXPLORED:"ZONE_EXPLORED",QUEST_COMPLETED:"QUEST_COMPLETED",CITY_WIPED:"CITY_WIPED",MOUNTAIN_CLIMBED:"MOUNTAIN_CLIMBED",UNIQUE_KILLED:"UNIQUE_KILLED"},this.WEAKNESS={},this.WEAKNESS.MINOR=1,this.WEAKNESS.MEDIUM=3,this.WEAKNESS.SEVERE=7,this.WEAKNESS.FATAL=10,this.RESISTANCE={},this.RESISTANCE.MINOR=1,this.RESISTANCE.MEDIUM=3,this.RESISTANCE.STRONG=6,this.RESISTANCE.IMMUNITY=10,this.RESISTANCE.ABSORB=15,this.SYS={},this.SYS.ANIMATION=Symbol("ANIMATION"),this.SYS.AREA_EFFECTS=Symbol("AREA_EFFECTS"),this.SYS.ATTACK=Symbol("ATTACK"),this.SYS.ATTACK_RANGED=Symbol("ATTACK_RANGED"),this.SYS.BATTLE=Symbol("BATTLE"),this.SYS.BASE_ACTION=Symbol("BASE_ACTION"),this.SYS.CHAT=Symbol("CHAT"),this.SYS.COMMUNICATION=Symbol("COMMUNICATION"),this.SYS.CRAFTING=Symbol("CRAFTING"),this.SYS.DAMAGE=Symbol("DAMAGE"),this.SYS.DEATH=Symbol("DEATH"),this.SYS.DISABILITY=Symbol("DISABILITY"),this.SYS.DRAIN_STATS=Symbol("DRAIN_STATS"),this.SYS.EQUIP=Symbol("EQUIP"),this.SYS.EVENTS=Symbol("EVENTS"),this.SYS.EXP_POINTS=Symbol("EXP_POINTS"),this.SYS.FARMING=Symbol("FARMING"),this.SYS.HUNGER=Symbol("HUNGER"),this.SYS.MISSILE=Symbol("MISSILE"),this.SYS.MOVEMENT=Symbol("MOVEMENT"),this.SYS.QUEST=Symbol("QUEST"),this.SYS.SHOP=Symbol("SHOP"),this.SYS.SKILLS=Symbol("SKILLS"),this.SYS.SPELL_CAST=Symbol("SPELL_CAST"),this.SYS.SPELL_EFFECT=Symbol("SPELL_EFFECT"),this.SYS.SPIRIT=Symbol("SPIRIT"),this.SYS.TIME_EFFECTS=Symbol("TIME_EFFECTS"),this.SYS.ZONE_EVENTS=Symbol("ZONE_EVENTS"),this.SYS.WEATHER=Symbol("WEATHER"),this.SYS.ON_CBS=Symbol("ON_CBS"),this.SYS.MINING=Symbol("MINING"),this.NO_DAMAGE_SRC=null,this.initStats(this.STATS),this.LEVEL_NOT_LOADED="LEVEL_NOT_LOADED",this.TILE_NOT_LOADED="TILE_NOT_LOADED",this.cellRenderArray=this.cellRenderVisible,this.PROP_TYPES=[this.TYPE_ACTOR,this.TYPE_ELEM,this.TYPE_ITEM],this.FMODES=[this.FMODE_NORMAL,this.FMODE_FAST,this.FMODE_SLOW],this.ALIGNMENTS=[this.ALIGN_GOOD,this.ALIGN_NEUTRAL,this.ALIGN_EVIL],this.cellRenderArray=this.cellRenderVisible,this.ONE_SHOT_ITEMS=["potion"],this.WORLD_ENTITY="WorldEntity",this.MAX_DRENCHED=10}getCssClassForCell(e,t){this.cellRenderArray=t?this.cellRenderVisible:this.cellRenderAlways;const s=this.getStyleClassForCell(e);return this.cellRenderArray=this.cellRenderVisible,s}getTopEntityNameForCell(e,t){this.cellRenderArray=t?this.cellRenderVisible:this.cellRenderAlways;const s=this.getTopEntityName(e);return this.cellRenderArray=this.cellRenderVisible,s}getCssClassFullMap(e){if(this.cellRenderArray=this.cellRenderVisible,!e.hasProps()){const t=e.getBaseElem().getType();return this.cellStyles.elements[t]}for(let t=0;t<3;t++){const s=this.cellRenderVisible[t];if(e.hasProp(s)){const t=e.getProp(s),n=this.cellStyles[s];return this.getPropClassOrChar(n,t[0])}}return null}getCharForCell(e,t){this.cellRenderArray=t?this.cellRenderVisible:this.cellRenderAlways;const s=this.getCellChar(e);return this.cellRenderArray=this.cellRenderVisible,s}getCharFullMap(e){if(this.cellRenderArray=this.cellRenderVisible,!e.hasProps()){const t=e.getBaseElem().getType();return this.charStyles.elements[t]}for(let t=0;t<3;t++)if(e.hasProp(this.cellRenderVisible[t])){const s=e.getProp(this.cellRenderVisible[t]),n=this.charStyles[this.cellRenderVisible[t]];return this.getPropClassOrChar(n,s[0])}return null}getStyleClassForCell(e){if(!e.isExplored())return"cell-not-explored";for(let t=0;t<this.cellRenderArray.length;t++){const s=this.cellRenderArray[t];if(e.hasProp(s)){const t=e.getProp(s),n=this.cellStyles[s],r=t[0];if(!r.has("DontRender"))return this.getPropClassOrChar(n,r)}}const t=e.getBaseElem().getType();return this.cellStyles.elements[t]}getPropClassOrChar(e,t){let s=null;if(t.getName?(s=t.getName(),e.hasOwnProperty(s)||(s=t.getType())):s=t.getType(),e.hasOwnProperty(s)){if("object"==typeof e[s]){const n=e[s];for(const e in n)if("default"!==e){const s=t[e]();if(!0===s)return n[e];if(!1!==s)return s}return n.default}return e[s]}return e.default}getCellChar(e){if(!e.isExplored())return"X";for(let t=0;t<this.cellRenderArray.length;t++)if(e.hasProp(this.cellRenderArray[t])){const s=e.getProp(this.cellRenderArray[t]),n=this.charStyles[this.cellRenderArray[t]],r=s[0];return this.getPropClassOrChar(n,r)}const t=e.getBaseElem().getType();return this.charStyles.elements[t]}getTopEntityName(e){if(!e.isExplored())return"Unexplored";for(let t=0;t<this.cellRenderArray.length;t++)if(e.hasProp(this.cellRenderArray[t])){const s=e.getProp(this.cellRenderArray[t])[0];let n=null;return n=s.getName?s.getName():s.getType(),n}return""}addCellStyle(e,t,s){this.cellStyles.hasOwnProperty(e)?this.cellStyles[e][t]=s:this.err("RG","addCellStyle","Unknown prop type: "+e)}removeCellStyle(e,t){this.cellStyles.hasOwnProperty(e)&&delete this.cellStyles[e][t]}addCharStyle(e,t,s){this.charStyles.hasOwnProperty(e)?this.charStyles[e][t]=s:this.err("RG","addCharStyle","Unknown prop type: "+e)}removeCharStyle(e,t){this.charStyles.hasOwnProperty(e)&&delete this.charStyles[e][t]}getChar(e,t,s=null){if(this.charStyles.hasOwnProperty(e)){if(s){return this.charStyles[e][t][s]}return this.charStyles[e][t]}return"X"}getCssClass(e,t,s=null){if(this.cellStyles.hasOwnProperty(e)){if(s){return this.cellStyles[e][t][s]}if(this.cellStyles[e].hasOwnProperty(t))return this.cellStyles[e][t]}return""}debug(e,t){0}err(e,t,s){if(!this.suppressErrorMessages){const n=`[ERROR]: ${e} ${t} -> |${s}|`;throw console.error(n),new Error(n)}}warn(e,t,s){if(!this.suppressWarningMessages){const n=`[WARN]: ${e} ${t} -> |${s}|`;console.error(n)}}diag(e){if(!this.suppressDiagnosticMessages){const t=(new Error).stack.split("at ");if(t.length>3){const e=t[3].trim();console.info(e)}console.info(e)}}log(...e){this.suppressLogs||console.log("[INFO]:",...e)}assertType(e,t){e.getType?e.getType()!==t&&this.err("RG","assertType",`Exp: ${t}, Got: ${e.getType()}`):this.err("RG","assertType",`object ${e} has no getType()`)}extend2(e,t){this.isNullOrUndef([e])&&this.err("RG","extend2","Child not defined. Parent: "+t),this.isNullOrUndef([t])&&this.err("RG","extend2","Parent not defined. Child: "+e);const s=t.prototype,n=e.prototype;for(const e in s)n.hasOwnProperty(e)||(n[e]=s[e]);if(n.hasOwnProperty("uber")){const e=[n.uber];e.push(s),n.uber=e}else n.uber=[],n.uber.push(s)}nullOrUndefError(e,t,s){if(this.isNullOrUndef([s])){const s=`nullOrUndef ${e} ${t}`;throw console.error(s),new Error(s)}}isNullOrUndef(e){for(let t=0;t<e.length;t++)if(null===e[t]||void 0===e[t]||void 0===e)return!0;return!1}addStackedItems(e,t){if(e.equals(t)){const s=t.getCount();return e.incrCount(s),!0}return!1}removeStackedItems(e,t){if(t>0){let s=null;return 1===t&&1===e.getCount()?e:t<e.getCount()?(e.decrCount(t),s=e.clone(),s.setCount(t),s):e}return null}getFOVRange(e){let t=e.getFOVRange();if(e.has("Location")){const s=e.get("Location").getLevel();if(s&&s.has("Weather")){t+=s.get("Weather").getVisibility()}}return t<1&&(t=1),t}getItemDamage(e){if(e.rollDamage)return e.rollDamage();{const t=e.getWeight();return Math.ceil(t/1.1)}}getMeleeAttack(e){let t=e.getAttack();const s=e.getInvEq().getMissile(),n=e.getInvEq().getMissileWeapon();return s&&(t-=s.getAttack()),n&&(t-=n.getAttack()),t}getMeleeAttackRange(e){const t=e.get("Combat").getAttackRange(),s=e.getWeapon();if(s&&s.getAttackRange){const e=s.getAttackRange();return e>t?e:t}return t}getMeleeDamageAdded(e){let t=e.getCombatBonus("getDamage");return t+=this.strengthToDamage(e.getStatVal("Strength")),t}getMeleeAttackInfo(e){let t="Att: "+this.getMeleeAttack(e);const s=e.getWeapon();return s&&s.getDamageDie?t+=" D: "+s.getDamageDie().toString():t+=" D: "+e.get("Combat").getDamageDie().toString(),t+=" + "+this.getMeleeDamageAdded(e),t}getMissileAgilityDmg(e){return Math.round(e/3)}getMissileDamageAdded(e,t){let s=this.getMissileAgilityDmg(e.get("Stats").getAgility());if(t.has("Ammo")){const t=e.getMissileWeapon();t&&(s+=t.rollDamage())}return e.has("StrongShot")&&(s+=this.strengthToDamage(e.getStatVal("Strength"))),s}getMissileDamage(e,t){if(this.isAmmoOrMissile(t)){let s=t.rollDamage();return s+=this.getMissileDamageAdded(e,t),s}return Math.round(t.getWeight()/1.5)}getMissileAttack(e){let t=e.get("Combat").getAttack();t+=e.getInvEq().getEquipment().getAttack(),t+=e.get("Stats").getAccuracy()/2,t+=e.getInvEq().getEquipment().getAccuracy()/2;const s=e.getWeapon();return s&&s.getAttack&&(t-=s.getAttack()),t}getMissileAttackInfo(e){const t=e.getMissileWeapon(),s=e.getInvEq().getMissile();if(!s)return"No missile equipped";let n="Att: "+this.getMissileAttack(e);if(n+=" D: "+s.getDamageDie().toString(),t){n+=" + "+t.getDamageDie().toString()+" (wpn)"}return n+=" + "+this.getMissileDamageAdded(e,s),n+=" R: "+this.getMissileRange(e,s),n}getMissileRange(e,t){if(!this.isAmmoOrMissile(t))return 2;let s=t.getAttackRange();if(t.has("Ammo")){const t=e.getMissileWeapon();if(!t)return 0;s+=t.getAttackRange()}return e.has("LongRangeShot")&&(s*=2),e.has("EagleEye")&&(s+=2),e.has("Skills")&&(t.has("Ammo")?s+=e.get("Skills").getLevel("Archery"):s+=e.get("Skills").getLevel("Throwing")),s}isAmmoOrMissile(e){return!!e.getAttackRange}strengthToDamage(e){return Math.round(e/4)}accuracyToAttack(e){return Math.floor(e/2)}agilityToDefense(e){return Math.floor(e/2)}findEnemyCellForActor(e,t){const s=[];return t.filter(e=>e.hasActors()).forEach(t=>{const n=t.getActors();let r=!1;for(let t=0;t<n.length;t++)e!==n[t]&&"function"==typeof n[t].isEnemy&&n[t].isEnemy(e)&&(r=!0);r&&s.push(t)}),s}initVars(){}dirTodXdY(e){if(Array.isArray(e))return e;if(this.DIR.hasOwnProperty(e)){const t=e.toUpperCase();return this.DIR[t]}return this.err("RG","dirTodXdY","Arg must be array/string (N,S,E,W..). Got: "+e),null}dXdYToDir(e){const[t,s]=e;let n="";return 1===s?n+="S":-1===s&&(n+="N"),1===t?n+="E":-1===t&&(n+="W"),0===t&&0===s&&this.warn("RG","dXdYToDir","dXdY 0,0 passed in"),n}dirToChar(e){const[t,s]=e;return 0!==t?0===s?"-":1===t&&1===s?"\\":-1===t&&1===s?"/":-1===t&&-1===s?"\\":"/":"|"}formatGetterName(e){return"get"+e.capitalize()}formatSetterName(e){return"set"+e.capitalize()}initStats(e){this.STATS_LC=e.map(e=>e.toLowerCase()),this.STATS_DEFAULTS=this.STATS_LC.reduce((e,t)=>(e[t]=5,e),{}),this.STATS_DEFAULTS.speed=100,this.STATS_ABBR=e.map(e=>e.substr(0,3)),this.GET_STATS=e.map(e=>this.formatGetterName(e)),this.SET_STATS=e.map(e=>this.formatSetterName(e)),this.STATS_ABBR2STAT=e.reduce((e,t)=>(e[t.substr(0,3)]=t,e),{})}createStatsObj(e,t=!0){const s={speed:e};return t?this.STATS_LC.forEach(t=>{s[t]=e}):this.STATS.forEach(t=>{s[t]=e}),s}getDmgClassName(e){return this.classNameDMG[e]}key2Num(e){const[t,s]=e.split(",");return[parseInt(t,10),parseInt(s,10)]}isEmpty(e){return!!this.isNullOrUndef([e])||("string"==typeof e?""===e:!!Array.isArray(e)&&0===e.length)}getName(e){if(e.getName)return e.getName();if(e.getParentZone){return this.formatLocationName(e)}if(e.getParent){return e.getParent().getName()}return""}getNameForQuest(e){const t=this.getName(e);return"exploration"===t?this.getName(e.getLevel()):t}getObjRefArray(e,t){const s=t.map(t=>this.getObjRef(e,t));return s.$objRefArray=!0,s}getObjRef(e,t){if("entity"===e){if(this.isItem(t)){const e=" Got: |"+t.getName()+"|";this.err("RG","getObjRef","objRefs to items not supported."+e)}return{$objRef:{type:e,id:t.getID()}}}if("object"===e){if(t.$objID)return t.getObjRef();if(t.$objRef)return{$objRef:{type:"object",id:t.$objRef}}}else{if("component"===e)return{$objRef:{type:"component",id:t.getID()}};if("place"===e)return{$objRef:{type:"place",id:t.getID()}};if("item"===e)return{$objRef:{type:"item",id:t.getID()}};if("element"===e)return{$objRef:{type:"element",id:t.getID()}}}return this.err("RG","getObjRef",`Type ${e} not supported. Obj: ${t}`),null}getForestConf(e,t){const s=e/this.LEVEL_MEDIUM_X*(t/this.LEVEL_MEDIUM_Y);return{ratio:.5,nForests:Math.floor(30*s),forestSize:100}}getDangerProb(e,t){if(e>t)return console.error("this.getDangerProb param order is min < max"),console.error(`\tGot min: ${e}, max: ${t}`),{};const s=t+1,n=[];for(let t=e;t<=s;t++)n.push(t);const r=n[n.length-1],a=r%2==0?r/2:(r+1)/2,o={};return n.forEach(e=>{const t=Math.abs(e-a);let s=r-Math.floor(this.DANGER_ADJ_FACTOR*t);s=0===s?s+1:s,o[e]=s}),o}getMaxDanger(e,t){let s=Math.round(2.5*t)+e+3;return s<this.MIN_DANGER&&(s=this.MIN_DANGER),s}getMaxValue(e,t){let s=25*t+10*e;return s<=this.MIN_VALUE&&(s=this.MIN_VALUE),s}getFoodWeightDistr(){return{.1:20,.2:10,.3:5,.4:3,.5:1}}getGoldCoinCountDistr(e){const t=e+1,s={};for(let n=1;n<=t;n++)s[n]=e;return s}getRuneChargeDistr(){return{0:2,1:10,2:30,3:10,4:5,5:2,6:1}}valueToGoldWeight(e){return 1===e?a.GOLD_COIN_WEIGHT:e/a.GOLD_WEIGHT_ADJUST}scaleItemValue(e,t,s){const n=s.getValue();let r=1;switch(e){case"combat":r*=1+.1*t;break;case"stats":r*=1+.2*t;break;default:r=1}const a=Math.floor(n*r);s.setValue(a)}hasEnoughGold(e,t){const s=this.getGoldInCoins(t),n=e.getInvEq().getInventory().getItems();for(let e=0;e<n.length;e++)if("goldcoin"===n[e].getType()&&n[e].getCount()>=s)return!0;return!1}removeNCoins(e,t){let s=0;const n=e.getInvEq().getInventory().getItems();let r=null;for(let e=0;e<n.length;e++)"goldcoin"===n[e].getType()&&(n[e].getCount()>t?(s=t,n[e].decrCount(t)):(r=n[e],s=r.getCount(),r.setCount(0)));return null!==r&&e.getInvEq().removeItem(r),s}getItemStat(e,t){if(!t)return 0;let s=0;if("function"==typeof t[e]&&(s+=t[e]()),t.has("Stats")){const n=t.get("Stats");"function"==typeof n[e]&&(s+=n[e]())}if(t.has("GemBound")){const n=t.get("GemBound").getGem();"function"==typeof n[e]&&(s+=n[e]())}return s}getExpRequired(e){let t=0;for(let s=1;s<=e;s++)t+=10*(s-1);return t}newXYFromDir(e,t){let[s,n]=[0,0];return Array.isArray(t)?[s,n]=t:t.getXY?[s,n]=t.getXY():this.err("RG","newXYFromDir","src must be TCoord or have getXY function. Got "+t),[s+e[0],n+e[1]]}dXdY(e,t){let[s,n,r,a]=[0,0,0,0];return Array.isArray(e)?(s=e[0],n=e[1]):e.getX&&(s=e.getX(),n=e.getY()),Array.isArray(t)?(r=t[0],a=t[1]):t.getX&&(r=t.getX(),a=t.getY()),[s-r,n-a]}dXdYAbs(e,t){const[s,n]=this.dXdY(e,t);return[Math.abs(s),Math.abs(n)]}dXdYUnit(e,t){const[s,n]=this.dXdY(e,t);return[0===s?0:s/Math.abs(s),0===n?0:n/Math.abs(n)]}withinRange(e,t,s){const[n,r]=this.dXdYAbs(t,s);return n<=e&&r<=e}levelUpActor(e,t){if(e.has("Experience")){let s=e.get("Experience").getExpLevel();if(s<t)for(;s<t;){const t=s+1;if(++s,e.get("Experience").setExpLevel(t),e.has("ActorClass"))e.get("ActorClass").getClass().advanceLevel();else if(this.levelUpStats(e,t),this.levelUpCombatStats(e,t),e.has("Health")){const t=e.get("Health");let s=2;e.isPlayer()&&(s=5),t.setMaxHP(t.getMaxHP()+s),t.setHP(t.getHP()+s)}}else{let e=`Curr: ${s}, New: ${t}`;e+=" New level must be > current level.",this.err("RG","levelUpActor",e)}}else this.err("RG","levelUpActor","No exp. component found.")}levelUpStats(e,t){const s=n.Random.getRNG().arrayGetRand(this.STATS_LC);e.get("Stats").incrStat(s,1)}levelUpCombatStats(e,t){if(e.has("Combat")){const s=e.get("Combat"),n=1;s.setAttack(s.getAttack()+n);const r=1;if(s.setDefense(s.getDefense()+r),t%3==0){const e=s.getProtection();s.setProtection(e+1)}const a=s.getDamageDie();a.setDice(a.getDice()+1),t%3==0&&a.setMod(a.getMod()+1)}}printObj(e,t,s){const n=(e,t)=>{"object"==typeof e?(console.debug("\t## "+t+s),console.debug(e+s)):console.debug("\t## "+t+" -> "+e+s)};if(t){if(Array.isArray(t))t.forEach(s=>{if("function"==typeof e[s]){const t=e[s]();n(t,s)}else{const s=JSON.stringify(e);this.err("RG","printObj",`No func ${t} in object ${s}`)}});else if("string"==typeof t)if("function"==typeof e[t]){const s=e[t]();n(s,t)}else this.err("RG","printObj",`No func ${t} in object ${JSON.stringify(e)}`)}else console.debug(e+s)}printObjList(e,t,s){const n=e.length;console.log(`List has ${n} objects`),e.forEach((e,n)=>{"function"==typeof s?s(e)&&(console.log(`Object [${n}]: `),this.printObj(e,t,"")):(console.log(`Object [${n}]: `),this.printObj(e,t,""))})}getUseCmd(e,t){return{cmd:"use",item:e,target:t}}getDropCmd(e,t){return{cmd:"drop",item:e,count:t}}getEquipCmd(e,t){return{cmd:"equip",item:e,count:t}}getUnequipCmd(e,t,s){return{cmd:"unequip",slot:e,slotNumber:t,count:s}}getCraftCmd(e,t){return{cmd:"craft",item:e,count:t}}isOneShotItem(e){const t=e.getType();return this.ONE_SHOT_ITEMS.indexOf(t)>=0}isActor(e){return!(!e||!e.getPropType)&&e.getPropType()===this.TYPE_ACTOR}toActor(e){return this.isActor(e)||this.err("RG","toActor","Given entity not an actor: "+JSON.stringify(e)),e}isElement(e){return!(!e||!e.getPropType)&&e.getPropType()===this.TYPE_ELEM}isItem(e){return!(!e||!e.getPropType)&&e.getPropType()===this.TYPE_ITEM}isEntity(e){return!!(e.comps&&e.compsByType&&e.add&&e.get)}isSentient(e){if(e){return"function"==typeof e.getBrain().getGoal}return!1}isBattleZone(e){return!(!e||!e.setBattle||"battlezone"!==e.getType())}isActorActive(e){return e&&!e.has("Dead")}getEffectUseType(e,t){let s=t;if(t.target){if(s=t.target,s.getActors){const e=s;e.hasActors()&&(s=e.getFirstActor())}}const n=e.getType();if(a.isActor(e))return this.USE.SKILL;switch(n){case"potion":if(this.isActor(s))return this.USE.DRINK;break;default:return this.USE.DEFAULT}return this.USE.DEFAULT}getGoldInCoins(e){return Math.round(e/this.GOLD_COIN_WEIGHT)}getCardinalDirection(e,t){const s=e.getMap().cols,n=e.getMap().rows,r=t.getX(),a=t.getY();return 0===a?"north":a===n-1?"south":r===s-1?"east":0===r?"west":"somewhere"}getTextualDir(e,t,s=10){let n="";const[r,a]=this.dXdY(e,t),o=r/s,i=a/s;return i>0?n+="south":i<0&&(n+="north"),o>0?n+="east":o<0&&(n+="west"),""===n&&(n="nearby"),n}printMap(e){let t=null;if(Array.isArray(e)?t=this.colsToRows(e):Array.isArray(e._map)&&(t=this.colsToRows(e._map)),t){const e=t.length;for(let s=0;s<e;s++)console.log(t[s].join(""))}}forEach2D(e,t){for(let s=0;s<e.length;s++)for(let n=0;n<e[s].length;n++)t(s,n,e[s][n])}map2D(e,t){const s=[];return this.forEach2D(e,(e,n,r)=>{s.push(t(e,n,r))}),s}copy2D(e){const t=new Array(e.length);for(let s=0;s<e.length;s++){t[s]=new Array(e[s].length);for(let n=0;n<e[s].length;n++)t[s][n]=e[s][n]}return t}colsToRows(e){const t=[],s=e[0].length,n=e.length;for(let r=0;r<s;r++){t[r]=[];for(let s=0;s<n;s++)t[r][s]=e[s][r]}return t}flattenTo2D(e){const t=e.length,s=[];for(let r=0;r<t;r++){let t=e[r];t=n(t),s.push(t)}function n(e){let t=[];return e.forEach(e=>{Array.isArray(e)?t=t.concat(n(e)):t.push(e)}),t}return s}uniquifyCoord(e){const t={},s=[];for(let n=0;n<e.length;n++){const[r,a]=e[n],o=r+","+a;t[o]||(t[o]=!0,s.push(e[n]))}return s}setAllExplored(e){const t=e.getMap();for(let e=0;e<t.cols;e++)for(let s=0;s<t.rows;s++){t._map[e][s].setExplored()}}inSameLevel(e,t){return e.getLevel().getID()===t.getLevel().getID()}getImpassableMsg(e,t,s){return`${s} ${"cannot venture beyond "+t.getBaseElem().getType()}`}formatLocationName(e){const t=e.getParent();if(!t)return"";switch(t.getType()){case"branch":case"face":case"quarter":{const e=t.getParent();if(e){const s=t.getName(),n=e.getName();return s===n?s:""+n}this.err("RG","formatLocationName","parent is null")}default:return t.getName()}}isSuccess(e){return n.Random.getRNG().getUniform()<=e}ent(e){if(window.PLAYER){const t=window.PLAYER.getLevel();if(Number.isInteger(e)){const s=t.getActors().find(t=>t.getID()===e);if(s){const t=s.getName();return this.diag(`this.ent: Found ${t} with ID ${e}`),this.diag(JSON.stringify(s)),s}const n=t.getItems().find(t=>t.getID()===e);if(n){const t=n.getName();return this.diag(`RG.ent: Item Found ${t} with ID ${e}`),this.diag(JSON.stringify(n)),n}}}return null}comp(e,t=-1){let s=null;if(t>=0&&(s=this.ent(t)),s){const t=s.getComponents();if(t[e]){const s=t[e],n=s.getType();console.log(`this.comp: Found ${n} with ID ${e}`);const r=s.toJSON();return r?this.diag(JSON.stringify(r)):(this.diag("Not serialisable"),this.diag(s)),s}}return null}while(e,t,s=-1){let n=s;for(;e();)if(t(),0==--n)return!1;return!0}gameMsg(e){this.emitMsgEvent("prim",e)}gameInfo(e){this.emitMsgEvent("info",e)}gameDescr(e){this.emitMsgEvent("descr",e)}gameSuccess(e){this.emitMsgEvent("success",e)}gameWarn(e){this.emitMsgEvent("warn",e)}gameDanger(e){this.emitMsgEvent("danger",e)}gameIntError(e){this.emitMsgEvent("bg-danger text-white",e)}emitMsgEvent(e,t){let s="";if("object"==typeof t){const n=t,r=n.cell;s=n.msg,s=s[0].toUpperCase()+s.substring(1);const a={cell:r,msg:s,style:e};this.POOL.emitEvent(this.EVT_MSG,a)}else s=t[0].toUpperCase()+t.substring(1),this.POOL.emitEvent(this.EVT_MSG,{msg:s,style:e})}destroyItemIfNeeded(e){if(this.isOneShotItem(e))if(1===e.getCount()){const t={item:e};this.POOL.emitEvent(this.EVT_DESTROY_ITEM,t)}else e.decrCount(1)}getEntName(e){return e.has("Named")?e.get("Named").getFullName():""}getLevel(e){return e.has("Location")?e.get("Location").getLevel():null}toKey(e){let t=e[0]+","+e[1];return e.length>2&&(t+=","+e[2]),t}fromKey3D(e){const t=e.split(",");return[parseInt(t[0],10),parseInt(t[1],10),parseInt(t[2],10)]}fromKey(e){const t=e.split(",");return[parseInt(t[0],10),parseInt(t[1],10)]}pluralize(e){return e+"s"}};a.COLORS=["AliceBlue","AntiqueWhite","Aqua","Aquamarine","Azure","Beige","Bisque","Black","BlanchedAlmond","Blue","BlueViolet","Brown","BurlyWood","CadetBlue","Chartreuse","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","DarkBlue","DarkCyan","DarkGoldenRod","DarkGray","DarkGrey","DarkGreen","DarkKhaki","DarkMagenta","DarkOliveGreen","Darkorange","DarkOrchid","DarkRed","DarkSalmon","DarkSeaGreen","DarkSlateBlue","DarkSlateGray","DarkSlateGrey","DarkTurquoise","DarkViolet","DeepPink","DeepSkyBlue","DimGray","DimGrey","DodgerBlue","FireBrick","FloralWhite","ForestGreen","Fuchsia","Gainsboro","GhostWhite","Gold","GoldenRod","Gray","Grey","Green","GreenYellow","HoneyDew","HotPink","IndianRed","Indigo","Ivory","Khaki","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenRodYellow","LightGray","LightGrey","LightGreen","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSlateGrey","LightSteelBlue","LightYellow","Lime","LimeGreen","Linen","Magenta","Maroon","MediumAquaMarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MidnightBlue","MintCream","MistyRose","Moccasin","NavajoWhite","Navy","OldLace","Olive","OliveDrab","Orange","OrangeRed","Orchid","PaleGoldenRod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","Pink","Plum","PowderBlue","Purple","Red","RosyBrown","RoyalBlue","SaddleBrown","Salmon","SandyBrown","SeaGreen","SeaShell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","SlateGrey","Snow","SpringGreen","SteelBlue","Tan","Teal","Thistle","Tomato","Turquoise","Violet","Wheat","White","WhiteSmoke","Yellow","YellowGreen"],t.default=a},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Random=void 0;const r=n(s(0)),a=n(s(14)),o=[-1,0,1],i=[-1,1];class l{constructor(e=0){this.seed=e,this.rng=a.default.clone(),this.rng.setSeed(this.seed)}static setRNG(e){l.instance=e}static getRNG(e){return e?(l.rngMap[e]||(l.rngMap[e]=new l(0)),l.rngMap[e]):(l.instance||(l.instance=new l(0)),l.instance)}static reseed(e){a.default.setSeed(e);l.getRNG().setSeed(e)}setSeed(e){this.seed=e,this.rng.setSeed(e)}setState(e){this.rng.setState(e)}randProp(e){const t=Object.keys(e);return e[t[this.randIndex(t)]]}arrayGetRand(e){return e[this.randIndex(e)]}getUniqueItems(e,t=2){if(e.length<=t)return e.slice();const s={},n=[];for(;n.length<t;){const t=this.randIndex(e);s[t]||(s[t]=!0,n.push(e[t]))}return n}getUniformInt(e,t){return this.rng.getUniformInt(e,t)}randIndex(e){return Math.floor(this.rng.getUniform()*e.length)}getUniform(){return this.rng.getUniform()}getUniformRange(e,t){return e+(t-e)*this.getUniform()}getNormal(e,t){return this.rng.getNormal(e,t)}getWeighted(e){return this.rng.getWeightedValue(e)}getWeightedLinear(e){const t={};if(0===e)return 0;for(let s=0;s<e;s++)t[s]=s+1;return parseInt(this.rng.getWeightedValue(t),10)}toJSON(){return{seed:this.seed,state:this.rng.getState()}}getRandDir(){const e=this.arrayGetRand(o);let t=this.arrayGetRand(o);return 0===e&&(t=this.arrayGetRand(i)),[e,t]}getCardinalDir(){return this.arrayGetRand(r.default.CARDINAL_DIR)}getCardinalDirLetter(){return this.arrayGetRand(r.default.CARDINAL_DIR_ABBR)}getRandInBbox(e){const{ulx:t,uly:s,lrx:n,lry:r}=e;return[this.getUniformInt(t,n),this.getUniformInt(s,r)]}shiftCoord(e){const t=this.arrayGetRand(o),s=this.arrayGetRand(o);return[e[0]+t,e[1]+s]}shuffle(e){if(e.length<=1)return e;let t,s=e.length-1,n=0;for(;0!==s;)n=this.getUniformInt(0,s),s-=1,t=e[s],e[s]=e[n],e[n]=t;return e}}t.Random=l},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||n(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0});const a=s(16);r(s(16),t),r(s(13),t);const o=s(143);r(s(143),t);const i=s(154);r(s(154),t);const l=s(155);r(s(155),t),r(s(107),t);const c=s(102);r(s(102),t),a.Component.MindControl=o.MindControl,a.Component.Abilities=i.Abilities,a.Component.Trainer=l.Trainer,a.Component.OnAddCb=c.OnAddCb,a.Component.OnRemoveCb=c.OnRemoveCb},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemBase=void 0;const i=o(s(0)),l=a(s(2)),c=s(12),u=s(1),h=s(5)("bitn:System");c.EventPool.getPool();t.SystemBase=class{constructor(e,t,s){Array.isArray(t)||i.default.err("System.Base","new","2nd arg must be an array of component types"),this.type=e,this.compTypes=t,this.entities={},this.compTypesAny=!1,this.hasNotify=!0,this.enabled=!0,this.legalArgs=[],this.pool=s;for(let e=0;e<this.compTypes.length;e++)l.hasOwnProperty(this.compTypes[e])||i.default.err("System.Base","new",`Comp type |${this.compTypes[e]}| not in Component`),this.pool.listenEvent(this.compTypes[e],this);this.traceID=686,this.traceIDs={},this.debugEnabled=h.enabled,this.rng=new u.Random(0)}static addSkillsExp(e,t,s=1){if(e.has("Skills")){const n=new l.SkillsExp;n.setSkill(t),n.setPoints(s),e.add(n)}}static addCompToEntAfterHit(e,t,s){const n=e.clone();if(n.hasOwnProperty("duration")){const e=n.rollDuration(),s=new l.Expiration;s.addEffect(n,e),t.add(s)}if(n.getSource){const e=n.getSource();i.default.isNullOrUndef([e])&&n.setSource(s)}t.add(n)}setRNG(e){this.rng=e}setArgs(e){this.legalArgs.forEach(t=>{e.hasOwnProperty(t)&&(this[t]=e[t])})}numEntities(){return Object.keys(this.entities).length}addEntity(e){this.entities[e.getID()]=e}removeEntity(e){delete this.entities[e.getID()]}notify(e,t){t.hasOwnProperty("add")?this.hasCompTypes(t.entity)&&(this.addEntity(t.entity),this.debugEnabled&&this._emitDbgMsg("ADD",t.entity)):t.hasOwnProperty("remove")&&(this.hasCompTypes(t.entity)||(this.removeEntity(t.entity),this.debugEnabled&&this._emitDbgMsg("RMV",t.entity)))}hasCompTypes(e){const t=this.compTypes;return!1===this.compTypesAny?e.hasAll(t):e.hasAny(t)}hasEntities(){return Object.keys(this.entities).length>0}update(){if(this.enabled)for(const e in this.entities)e&&this.updateEntity(this.entities[e])}updateEntity(e){i.default.err("SystemBase","updateEntity","Not implemented in the base class")}dbg(e){if(this.debugEnabled){const t=this.numEntities();let s=`[System ${this.type.toString()}]`;s+=" nEnt: "+t,h.enabled?h(`${s} ${e}`):console.log(`${s} ${e}`)}}_emitDbgMsg(e,t){let s="<UNNAMED>";t.getName&&(s=t.getName());const n=t.getID();if(-1===this.traceID||this.traceIDs[n]){const t=`|${e}| Ent: ${s}, ID: ${n}`;this.dbg(t)}}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Geometry=void 0;const r=n(s(0)),a=s(1),o=s(18),i=a.Random.getRNG();class l{static getBoxAround(e,t,s,n=!1){c([e,t]);const r=[];for(let n=e-s;n<=e+s;n++)for(let a=t-s;a<=t+s;a++)n===e&&a===t||r.push([n,a]);return n&&r.push([e,t]),r}static getCrossAround(e,t,s,n=!1){c([e,t,s]);const r=[];for(let n=e-s;n<=e+s;n++)for(let a=t-s;a<=t+s;a++)n!==e&&a!==t||n===e&&a===t||r.push([n,a]);return n&&r.push([e,t]),r}static getDiagCross(e,t,s,n=!1){c([e,t,s]);const r=[];for(let n=e-s;n<=e+s;n++)for(let a=t-s;a<=t+s;a++){const s=a-t;0!==n-e&&0!==s&&r.push([n,a])}return n&&r.push([e,t]),r}static getCrossCaveConn(e,t,s,n=!1){c([e,t,s]);const r=[];for(let n=e-s;n<=e+s;n++)for(let a=t-s;a<=t+s;a++)n!==e&&a!==t||n===e&&a===t||r.push([n,a]);return n&&r.push([e,t]),r}static getBox(e,t,s,n){c([e,t,s,n]);const r=[];for(let a=e;a<=s;a++)for(let e=t;e<=n;e++)r.push([a,e]);return r}static convertBbox(e){return e.hasOwnProperty("llx")?o.BBox.fromBBox({ulx:e.llx,uly:e.ury,lrx:e.urx,lry:e.lly}):o.BBox.fromBBox(e)}static getCoordBbox(e){const{ulx:t,uly:s,lrx:n,lry:r}=e;return this.getBox(t,s,n,r)}static getBorderForBbox(e){const{ulx:t,uly:s,lrx:n,lry:r}=e;return this.getHollowBox(t,s,n,r)}static getCellsInBbox(e,t){const s=this.getCoordBbox(t),n=[];return s.forEach(t=>{n.push(e[t[0]][t[1]])}),n}static isInBbox(e,t,s){const{ulx:n,uly:r,lrx:a,lry:o}=s;return e>=n&&e<=a&&t>=r&&t<=o}static isValidBbox(e){if(!e)return!1;const{ulx:t,uly:s,lrx:n,lry:a}=e;return!r.default.isNullOrUndef([t,s,n,a])}static dirToBbox(e,t,s){const n=Math.round(e/3),a=Math.round(t/3),i=n,l=a,c=2*n-1,u=2*a-1,h=r.default.dirTodXdY(s);return h?o.BBox.fromBBox({ulx:i+h[0]*n,uly:l+h[1]*a,lrx:c+h[0]*n,lry:u+h[1]*a}):(r.default.err("Geometry","dirToBbox",`Invalid dir ${s} given.`),null)}static combineAdjacent(e){let t=!1;const s=[],n={},r=e.sort((e,t)=>e.uly<=t.uly?1:-1);r.forEach((e,t)=>{n[t]=e});for(let e=0;e<r.length;e++)for(let a=0;a<r.length;a++)if(e!==a&&n[e]&&n[a]){const o=r[e].combine(r[a]);o&&(t=!0,s.push(o),delete n[e],delete n[a])}return t?(Object.values(n).forEach(e=>{s.push(e)}),l.combineAdjacent(s)):e.slice()}static coordToDirMap(e,t){const s={};return t.forEach(t=>{if(t[0]===e[0]&&t[1]===e[1])return;const n=r.default.dXdYUnit(t,e),a=r.default.dXdYToDir(n);s[a]||(s[a]=[]),s[a].push(t)}),s}static getBoxCornersForCells(e,t){const[s,n]=[e.getX(),e.getY()],[r,a]=[t.getX(),t.getY()],i=s<=r?s:r,l=r>s?r:s,c=n<=a?n:a,u=a>n?a:n;return o.BBox.fromBBox({ulx:i,uly:c,lrx:l,lry:u})}static getHollowBox(e,t,s,n){c([e,t,s,n]);const r=[];for(let a=e;a<=s;a++)for(let o=t;o<=n;o++)o!==t&&o!==n&&a!==e&&a!==s||r.push([a,o]);return r}static getHollowDiamond(e,t,s){c([e,t,s]);const n=e+2*s,r=e+s,a=t+s,o=t-s,i=[[e,t]],l={N:[r,a],S:[r,o],E:[n,t],W:[e,t],coord:[]};for(let s=e+1;s<=r;s++){for(let e=t+1;e<=a;e++)i.push([s,e]);for(let e=t-1;e>=o;e--)i.push([s,e])}for(let e=r+1;e<=n;e++){for(let s=t+1;s<=a;s++)i.push([e,s]);for(let s=t-1;s>=o;s--)i.push([e,s])}return l.coord=i,l}static isCorner(e,t,s,n,r,a){return(e===s||e===r)&&(t===n||t===a)}static removeMatching(e,t){let s=0;return Array.isArray(e)?t.forEach(t=>{const n=e.findIndex(e=>e[0]===t[0]&&e[1]===t[1]);n>=0&&(e.splice(n,1),++s)}):t.forEach(t=>{const n=t[0]+","+t[1];e.hasOwnProperty(n)&&(delete e[n],++s)}),s}static getCellsAround(e,t){const s=t.getXY(),n=this.getBoxAround(s[0],s[1],1),a=e.getCellsWithCoord(n),o={};return a.forEach(e=>{const t=r.default.dXdYUnit(e,s),n=r.default.dXdYToDir(t);o[n]=e.getBaseElem().getType()}),o}static tileLevels(e,t,s){const{x:n,y:r}=s;let a=n,o=r;if(s.alignLeft)t.forEach(t=>{this.mergeLevels(e,t,a,o),o+=t.getMap().rows});else if(s.centerX){const s=Math.round(e.getMap().cols/2);t.forEach(t=>{a=s-Math.round(t.getMap().cols/2),this.mergeLevels(e,t,a,o),o+=t.getMap().rows})}else if(s.centerY){const s=Math.round(e.getMap().rows/2);t.forEach(t=>{o=s-Math.round(t.getMap().rows/2),this.mergeLevels(e,t,a,o),a+=t.getMap().cols})}}static mergeLevels(e,t,s,n){const a=e.getMap(),o=t.getMap(),i=e.getActors().length+t.getActors().length,l=t.getActors().slice(),c=t.getItems().slice(),u=t.getElements().slice(),h=e=>[e.getX()+s,e.getY()+n];l.forEach(s=>{const[n,r]=h(s);a.hasXY(n,r)&&t.removeActor(s)&&e.addActor(s,n,r)}),c.forEach(s=>{const[n,r]=[s.getX(),s.getY()],[o,i]=h(s);a.hasXY(o,i)&&t.removeItem(s,n,r)&&e.addItem(s,o,i)}),u.forEach(s=>{const[n,r]=[s.getX(),s.getY()],[o,i]=h(s);a.hasXY(o,i)&&t.removeElement(s,n,r)&&e.addElement(s,o,i)}),this.mergeMapBaseElems(a,o,s,n);const d=e.getActors().length;d!==i&&r.default.err("Geometry","mergeLevels",`Num actors new: ${d}, exp: ${i}`)}static mergeMapBaseElems(e,t,s,n){if(e.cols<t.cols){const s=`m1: ${e.cols} m2: ${t.cols}`;r.default.err("Geometry","mergeMapBaseElems","Cols: m2 cols must be smaller/equal: "+s)}if(e.rows<t.rows){const s=`m1: ${e.rows} m2: ${t.rows}`;r.default.err("Geometry","mergeMapBaseElems","Rows: m2 rows must be smaller/equal: "+s)}const a=s+t.cols-1,o=n+t.rows-1;for(let r=s;r<=a;r++)for(let a=n;a<=o;a++)if(e.hasXY(r,a)){const o=t.getCell(r-s,a-n);e._map[r][a].setBaseElem(o.getBaseElem())}}static copyBaseElems(e,t,s,n){const r=e.getMap(),a=t.getMap(),o=s+a.cols-1,i=n+a.rows-1;for(let e=s;e<=o;e++)for(let t=n;t<=i;t++){const o=r._map[e][t].getBaseElem();a._map[e-s][t-n].setBaseElem(o)}}static mergeMapCellsUnsafe(e,t,s,n){const a=s+t.cols-1,o=n+t.rows-1;for(let i=s;i<=a;i++)for(let a=n;a<=o;a++)if(e.hasXY(i,a)){const o=t.getCell(i-s,a-n);o||r.default.err("Geometry","mergeMapCellsUnsafe",`Null cell: ${s},${n}, [${i}][${a}]`),e.moveCellUnsafe(i,a,o)}}static mergeMaps(e,t,s,n,r=((e,t)=>!0)){const a=s+t.cols-1,o=n+t.rows-1;for(let i=s;i<=a;i++)for(let a=n;a<=o;a++)if(e.hasXY(i,a)){const o=t.getCell(i-s,a-n),l=e._map[i][a];r(l,o)&&l.setBaseElem(o.getBaseElem())}}static iterateMapWithBBox(e,t,s){for(let n=t.ulx;n<=t.lrx;n++)for(let r=t.uly;r<=t.lry;r++)e.hasXY(n,r)&&s(n,r)}static insertEntity(e,t,s,n){switch(t){case r.default.TYPE_ACTOR:this.insertActors(e,t,s,n);break;case r.default.TYPE_ITEM:this.insertItems(e,t,s,n);break;case r.default.TYPE_ELEM:this.insertElements(e,t,s,n);break;default:r.default.err("Geometry","insertEntity",`No type ${t} supported`)}}static insertElements(e,t,s,n){const r=e.getMap();this.iterateMapWithBBox(r,s,(s,a)=>{const o=n(t);o.getX&&o.getY?(console.log("Geometry.insertElements, added to",s,a),e.addElement(o,s,a)):r._map[s][a].setBaseElem(o)})}static insertActors(e,t,s,n){const a=e.getMap();this.iterateMapWithBBox(a,s,(s,o)=>{if(a.getCell(s,o).isFree()){const a=n.createActualObj(r.default.TYPE_ACTOR,t);e.addActor(a,s,o)}})}static insertItems(e,t,s,n){const a=e.getMap();this.iterateMapWithBBox(a,s,(s,o)=>{if(a.getCell(s,o).isFree()){const a=n.createActualObj(r.default.TYPE_ITEM,t);e.addItem(a,s,o)}})}static getFreeArea(e,t,s,n){let r=!1;const a=e.slice(),o={};for(e.forEach(e=>{o[e[0]+","+e[1]]=e});!r&&a.length>0;){const e=i.getUniformInt(0,a.length-1),l=a[e][0],c=a[e][1];let u=!0;for(let e=l;e<l+t;e++)for(let t=c;t<c+s;t++)o[e+","+t]?n.push([e,t]):u=!1;r=u,r||(n=[],a.splice(e))}return r}static isLine(e,t,s,n){return e===s||t===n||Math.abs(s-e)===Math.abs(n-t)}static xyInLine(e){for(let t=1;t<e.length;t++){const[s,n]=[e[t],e[t-1]],[r,a]=s,[o,i]=n;if(!this.isLine(r,a,o,i))return!1}return!0}static sameXOrY(e){for(let t=1;t<e.length;t++){const[s,n]=[e[t],e[t-1]],[r,a]=s,[o,i]=n;if(r!==o&&a!==i)return!1}return!0}static getStraightLine(e,t,s,n,r=!0){if(this.isLine(e,t,s,n)){const a=[],o=s===e?0:(s-e)/Math.abs(s-e),i=n===t?0:(n-t)/Math.abs(n-t);for(r&&a.push([e,t]);e!==s||t!==n;)e!==s&&(e+=o),t!==n&&(t+=i),e===s&&t===n?r&&a.push([e,t]):a.push([e,t]);return a}return[]}static getBresenham(e,t,s,n){let[r,a,o,i]=[0,0,0,0],[l,c,u,h]=[0,0,0,0],[d,f]=[0,0];const g=[];if(r=s-e,a=n-t,r<0&&(r=-r),a<0&&(a=-a),l=1,s<e&&(l=-1),c=1,n<t&&(c=-1),d=e,f=t,g.push([d,f]),r>a)for(i=2*a-r,u=2*(a-r),h=2*a,o=0;o<r;o++)i>=0?(f+=c,i+=u):i+=h,d+=l,g.push([d,f]);else for(i=2*r-a,u=2*(r-a),h=2*r,o=0;o<a;o++)i>=0?(d+=l,i+=u):i+=h,f+=c,g.push([d,f]);return g}static getMissilePath(e,t,s,n,r=!0){let a=[];if(this.isLine(e,t,s,n))a=this.getStraightLine(e,t,s,n,r);else{r&&a.push([e,t]);const o=s-e,i=n-t,l=Math.abs(o),c=Math.abs(i),u=o/l,h=i/c;let d=l,f=c,g=e,p=t;if(l>c){for(;f>=0&&d%f!=0;)g+=u,p+=h,a.push([g,p]),d-=1,f-=1;if(0===f)for(;g!==s;)g+=u,a.push([g,p]);else{const e=d/f;for(;g!==s&&p!==n;){p!==n&&(p+=h);for(let t=0;t<e;t++)g!==s&&(g+=u,a.push([g,p]))}}}else if(c>l){for(;d>=0&&f%d!=0;)g+=u,p+=h,a.push([g,p]),d-=1,f-=1;if(0===d)for(;p!==n;)p+=h,a.push([g,p]);else{const e=f/d;for(;g!==s&&p!==n;){g!==s&&(g+=u);for(let t=0;t<e;t++)p!==n&&(p+=h,a.push([g,p]))}}}}return a}static distance3D(e,t){const s=t[0]-e[0],n=t[1]-e[1],r=t[2]-e[2];return Math.sqrt(Math.pow(s,2)+Math.pow(n,2)+Math.pow(r,2))}static distance3DSquared(e,t){const s=t[0]-e[0],n=t[1]-e[1],r=t[2]-e[2];return Math.pow(s,2)+Math.pow(n,2)+Math.pow(r,2)}static lineFunc3D(e,t,s,n=!0){let[r,a,o]=e.map(e=>e+.5);const i=l.distance3D(e,t),c=Math.floor(i),u=(t[0]-r)/i,h=(t[1]-a)/i,d=(t[2]-o)/i;n&&s(Math.floor(r),Math.floor(a),Math.floor(o));for(let e=0;e<c;e++)r+=u,a+=h,o+=d,s(Math.floor(r),Math.floor(a),Math.floor(o));n&&s(t[0],t[1],t[2])}static lineFuncUnique3D(e,t,s=!0){const n=r.default.toKey(e)+","+r.default.toKey(t)+s;return l._cache.lineFuncUnique3D.hasOwnProperty(n)||(l._cache.lineFuncUnique3D[n]=l.bresenham3D(...e,...t)),l._cache.lineFuncUnique3D[n]}static getBresenham3D(e,t){return l.bresenham3D(...e,...t)}static bresenham3D(e,t,s,n,r,a){let o=0,i=0,l=0;const c=[-1,-1,-1];c[0]=e,c[1]=t,c[2]=s;const u=n-e,h=r-t,d=a-s,f=u<0?-1:1,g=Math.abs(u),p=h<0?-1:1,m=Math.abs(h),y=d<0?-1:1,_=Math.abs(d),b=g<<1,v=m<<1,E=_<<1,S=[];if(g>=m&&g>=_)for(i=v-g,l=E-g,o=0;o<g;o++)S.push([c[0],c[1],c[2]]),i>0&&(c[1]+=p,i-=b),l>0&&(c[2]+=y,l-=b),i+=v,l+=E,c[0]+=f;else if(m>=g&&m>=_)for(i=b-m,l=E-m,o=0;o<m;o++)S.push([c[0],c[1],c[2]]),i>0&&(c[0]+=f,i-=v),l>0&&(c[2]+=y,l-=v),i+=b,l+=E,c[1]+=p;else for(i=v-_,l=b-_,o=0;o<_;o++)S.push([c[0],c[1],c[2]]),i>0&&(c[1]+=p,i-=E),l>0&&(c[0]+=f,l-=E),i+=v,l+=b,c[2]+=y;return S.push([c[0],c[1],c[2]]),S}}function c(e){e.forEach(t=>{if(!Number.isInteger(t)){const t=JSON.stringify(e);r.default.err("Geometry","verifyInt","Value not an Int. Arr: "+t)}})}t.Geometry=l,l.floodfill=function(e,t,s,n=!1){let r=s;if("string"==typeof s&&(r=e=>e.getBaseElem().getType()===s),!r(t))return[];let a=t;const o=[],i=[t],l={};l[t.getKeyXY()]=!0;const c=function(t,s){if(e.hasXY(t,s)&&!l[t+","+s]){const n=e.getCell(t,s);r(n)&&(l[n.getKeyXY()]=!0,i.push(n),o.push(n))}};for(;a;){const[e,t]=a.getXY(),s=e-1;c(s,t);const r=e+1;c(r,t);const i=t-1;c(e,i);const l=t+1;c(e,l),n&&(c(s,i),c(r,i),c(s,l),c(r,l)),a=o.shift()}return i},l.floodfillPassable=function(e,t=!1){const s=e=>!e.hasObstacle()||e.hasDoor(),n=e.getCells(s)[0];return l.floodfill(e,n,s,t)},l.floodfillRegions=function(e,t=!1){const s=[],n=e=>!e.hasObstacle()||e.hasDoor(),r=e.getCells(n).map(e=>e.getXY());for(;r.length>0;){const t=r[0],[a,o]=t,i=l.floodfill(e,e.getCell(a,o),n,!0).map(e=>e.getXY());l.removeMatching(r,i),s.push(i)}return s},l.floodfill2D=function(e,t,s,n=!1,r=!1){const[a,o]=t;if(e[a][o]!==s)return[];let i=t;const l=[],c=[i],u={};u[a+","+o]=!0;const h=function(t,r){if(t>=0&&t<e.length&&r>=0&&r<e[0].length&&!u[t+","+r]){e[t][r]===s&&(u[t+","+r]=!0,c.push([t,r]),n&&(n[t+","+r]=!0),l.push([t,r]))}};for(;i;){const[e,t]=i,s=e-1;h(s,t);const n=e+1;h(n,t);const a=t-1;h(e,a);const o=t+1;h(e,o),r&&(h(s,a),h(n,a),h(s,o),h(n,o)),i=l.shift()}return c},l.getMassCenter=function(e){let t=0,s=0;for(let n=0;n<e.length;n++)t+=e[n][0],s+=e[n][1];return[Math.round(t/e.length),Math.round(s/e.length)]},l.squareFill=function(e,t,s,n){const[a,o]=t.getXY(),[i,l]=n;0!==i&&0!==l||r.default.err("Geometry","squareFill","dx,dy must be -1 or 1. Got "+n);let c=!1,u=[t],h=t;for(;!c;){const t=[],[n,r]=h.getXY(),[d,f]=[n+i,r+l];if(e.hasXY(d,f)){const n=e.getCell(d,f);if(n.getBaseElem().getType()!==s){c=!0;break}t.push(n);let r=d;do{r+=-i;const n=e.getCell(r,f);if(n.getBaseElem().getType()!==s){c=!0;break}t.push(n)}while(r!==a);let g=f;do{g+=-l;const n=e.getCell(d,g);if(n.getBaseElem().getType()!==s){c=!0;break}t.push(n)}while(g!==o);c||(u=u.concat(t)),h=n}}return u},l.histArrayVals=function(e){const t={};return e.forEach(e=>{t[e]?t[e]+=1:t[e]=1}),t},l.tesselateLine=function(e,t,s,n,r,a){const o=Math.abs(e-s),c=Math.abs(t-n),u=e<s?e:s,h=e>s?e:s,d=t<n?t:n,f=t>n?t:n;if(o>=r&&c>=r){const o=i.getUniformInt(u,h),c=i.getUniformInt(d,f);l.tesselateLine(e,t,o,c,r,a),l.tesselateLine(o,c,s,n,r,a)}else{l.getBresenham(e,t,s,n).forEach(e=>{a.push(e)})}},l.getCaveConnLine=function(e,t,s,n,r){let a=[];const o=[];l.tesselateLine(e,t,s,n,4,o);let c=l.getCrossCaveConn;return r&&"function"==typeof r.brush&&(c=r.brush),o.forEach(e=>{const[t,s]=e,n=i.getUniformInt(1,3),r=c(t,s,n,!0);a=a.concat(r)}),a},l._cache={lineFuncUnique3D:{}}},function(e,t,s){(function(n){t.log=function(...e){return"object"==typeof console&&console.log&&console.log(...e)},t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const s="color: "+this.color;t.splice(1,0,s,"color: inherit");let n=0,r=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(n++,"%c"===e&&(r=n))}),t.splice(r,0,s)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&void 0!==n&&"env"in n&&(e=n.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.exports=s(262)(t);const{formatters:r}=e.exports;r.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}).call(this,s(31))},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.restoreParser=t.getParser=t.createItem=t.Parser=t.ProcGen=t.Creator=t.ObjectShell=void 0;const i=o(s(0)),l=a(s(56)),c=a(s(2)),u=a(s(26)),h=s(15),d=s(272),f=s(7),g=s(23),p=s(273),m=s(1),y=s(148),_=s(58),b=s(71),v=s(147),E=s(17),S=s(72),w=m.Random.getRNG();t.ObjectShell={};class C{constructor(e,t){this._db=e,this._dbNoRandom=t,this._compGen=new b.ObjectShellComps,this._propToCall={actors:{type:"setType",attackRange:{comp:"Combat",func:"setAttackRange"},attack:{comp:"Combat",func:"setAttack"},defense:{comp:"Combat",func:"setDefense"},damage:{comp:"Combat",func:"setDamageDie"},numHits:{comp:"Combat",func:"setNumHits"},speed:{comp:"Stats",func:"setSpeed"},strength:{comp:"Stats",func:"setStrength"},accuracy:{comp:"Stats",func:"setAccuracy"},agility:{comp:"Stats",func:"setAgility"},willpower:{comp:"Stats",func:"setWillpower"},perception:{comp:"Stats",func:"setPerception"},magic:{comp:"Stats",func:"setMagic"},spirituality:{comp:"Stats",func:"setSpirituality"},fovrange:{comp:"Perception",func:"setFOVRange"},pp:{comp:"SpellPower",func:["setPP","setMaxPP"]},maxPP:{comp:"SpellPower",func:"setMaxPP"},hp:{comp:"Health",func:["setHP","setMaxHP"]},danger:{comp:"Experience",func:"setDanger"},brain:{func:"setBrain",factory:this.createBrain}},items:{type:"setType",value:"setValue",weight:{comp:"Physical",func:"setWeight"},damageType:"setDamageType",speed:{comp:"Stats",func:"setSpeed"},strength:{comp:"Stats",func:"setStrength"},accuracy:{comp:"Stats",func:"setAccuracy"},agility:{comp:"Stats",func:"setAgility"},willpower:{comp:"Stats",func:"setWillpower"},perception:{comp:"Stats",func:"setPerception"},magic:{comp:"Stats",func:"setMagic"},spirituality:{comp:"Stats",func:"setSpirituality"},armour:{attack:"setAttack",defense:"setDefense",protection:"setProtection",armourType:"setArmourType"},weapon:{damage:"setDamageDie",attack:"setAttack",defense:"setDefense",weaponType:"setWeaponType",range:"setAttackRange"},missile:{damage:"setDamageDie",attack:"setAttack",range:"setAttackRange"},food:{energy:"setEnergy"}},elements:{z:"setZ",type:"setType",msg:"setMsg"},effects:{}},this._propToCall.items.missileweapon=this._propToCall.items.weapon,this._propToCall.items.missileweapon.fireRate="setFireRate",this._propToCall.items.ammo=this._propToCall.items.missile,this._propToCall.items.ammo.ammoType="setAmmoType"}get(e,t){return this._dbNoRandom[e][t]?this._dbNoRandom[e][t]:this._db[e][t]}createActualObj(e,t){const s=this.get(e,t),n=this._propToCall[e];if(!s)return i.default.err("Creator","createActualObj",`shell for ${t} is not found.`),null;const r=this.createNewObject(e,s);if(!r)return i.default.err("ObjectShell.creator","createActualObj","Failed to create obj with "+JSON.stringify(s)),null;s&&s.hasOwnProperty("addComp")&&this._compGen.addComponents(s,r);for(const e in s)if(n.hasOwnProperty(e)){const t=this.getShellValue(s[e]),a=n[e];if("object"==typeof a){if(a.hasOwnProperty("comp"))this._compGen.addCompToObj(r,a,t);else if(a.hasOwnProperty("factory")){if("brain"===e){const e=a.factory(r,t);r[a.func](e)}}else for(const e in a)if(a.hasOwnProperty(e)){const s=a[e];r.hasOwnProperty(s)&&r[s](t)}}else r[a](t)}else if(s.hasOwnProperty("type")){const t=this.getShellValue(s[e]);if(n.hasOwnProperty(s.type)){const a=n[s.type];if(a.hasOwnProperty(e)){const s=a[e];if("object"==typeof s){for(const e in s)if(s.hasOwnProperty(e)){const n=s[e];r.hasOwnProperty(n)&&r[s[e]](t)}}else r[s](t)}}}return s.hasOwnProperty("use")&&this.addUseEffects(s,r),s.hasOwnProperty("equip")&&this.addEquippedItems(s,r),s.hasOwnProperty("inv")&&i.default.isActor(r)&&i.default.isSentient(r)&&this.addInventoryItems(s,r),s.hasOwnProperty("loot")&&this.addLootComponents(s,r),s.hasOwnProperty("poison")&&this._compGen.addPoison(s,r),s.hasOwnProperty("enemies")&&this.addEnemies(s,r),s.hasOwnProperty("spells")&&this.addSpellbookAndSpells(s,r),s.hasOwnProperty("onHit")&&this._compGen.addOnHitProperties(s,r),s.hasOwnProperty("onAttackHit")&&this._compGen.addOnAttackHitProperties(s,r),s.hasOwnProperty("onEquip")&&this._compGen.addOnEquipProperties(s,r),s.hasOwnProperty("goals")&&this.addGoalsToObject(s,r),s.hasOwnProperty("ability")&&this.addAbilityEffects(s,r),s.hasOwnProperty("callbacks")&&this._compGen.addCallbacks(s,r),r}getShellValue(e){if("object"==typeof e){if(e.hasOwnProperty("$$dice")){console.log("$$dice: ",e.$$dice);const t=E.Dice.getValue(e.$$dice);return console.log("Rolled $$dice: ",t),t}return e.hasOwnProperty("$$select")?this.getShellValue(w.arrayGetRand(e.$$select)):e}return e}addEnemies(e,t){e.enemies.forEach(e=>{t.getBrain().addEnemyType(e)}),0===e.enemies.length&&t.getBrain().getMemory().removeEnemyTypes()}addSpellbookAndSpells(e,t){t.setBook(new y.Spell.SpellBook(t)),e.spells.forEach(e=>{const s=this.getUsedObject(e);if(y.Spell[s])t.getBook().addSpell(new y.Spell[s]);else{const e=`Spell |${s}| does not exist.`;i.default.err("Creator","addSpellbookAndSpells",e)}})}addGoalsToObject(e,t){if(i.default.isActor(t)){const{goals:s}=e;s.forEach(e=>{const{name:s,bias:n}=e,r=new g.Evaluator[s](n);Object.keys(e).forEach(t=>{"name"!==t&&"bias"!==t&&r[t](e[t])});t.getBrain().getGoal().addEvaluator(r)})}}getUsedObject(e){return"object"==typeof e&&e.random?w.arrayGetRand(e.random):e}createNewObject(e,t){switch(e){case i.default.TYPE_ACTOR:t.type;switch(t.actorType){case"BaseActor":return new l.BaseActor(t.name);default:return new l.SentientActor(t.name)}case i.default.TYPE_ITEM:const e=t.type;switch(e){case"armour":return new u.Armour(t.name);case"book":return new u.Book(t.name);case"food":return new u.Food(t.name);case"gold":return new u.Gold(t.name);case"goldcoin":return new u.GoldCoin(t.name);case"mineral":return new u.Mineral(t.name);case"missile":return new u.Missile(t.name);case"missileweapon":return new u.MissileWeapon(t.name);case"ammo":return new u.Ammo(t.name);case"potion":return new u.Potion(t.name);case"rune":return new u.Rune(t.name);case"spiritgem":return new u.SpiritGem(t.name);case"weapon":return new u.Weapon(t.name);default:{if(e){const e=new u.ItemBase(t.name);return e.setType(t.type),e}const s=`Null/undef type: ${e}, obj: ${JSON.stringify(t)}`;i.default.err("","createNewObject",s)}}break;case i.default.TYPE_ELEM:{const e=t.type||t.name;return new f.ElementBase(t.name,e)}}return null}addInventoryItems(e,t){e.inv.forEach(e=>{const s=e.name||e,n=e.count||1,r=this.createActualObj(i.default.TYPE_ITEM,s);r?(r.setCount(n),t.getInvEq().addItem(r)):i.default.err("Creator","addInventoryItems",`itemObj for ${s} is null. Actor: ${t.getName()}`)})}addLootComponents(e,t){const s=e.loot,n=this.createActualObj(i.default.TYPE_ITEM,s),r=new c.Loot(n);t.add(r)}addEquippedItems(e,t){const s=e.equip;let n=!1;s.forEach(e=>{const s=e.name||e,r=e.count||1,a=this.createActualObj(i.default.TYPE_ITEM,s);a?(a.setCount(r),t.getInvEq().restoreEquipped(a)||(n=!0)):i.default.err("Creator","addEquippedItems",`itemObj for ${e} is null. Actor: ${t.getName()}`)}),n&&w.shuffle(e.equip)}addUseEffects(e,t){if(t.useFuncs=[],i.default.isItem(t))t.useItem=this._db.effects.use.func.bind(t);else if(i.default.isActor(t)){t.useSkill=this._db.effects.use.func.bind(t);const e=t.getBrain();e.getGoal&&(e.getGoal().hasEvalType("UseSkill")||e.getGoal().addEvalByName("UseSkill",1))}if(Array.isArray(e.use))for(let s=0;s<e.use.length;s++)this._addUseEffectToEntity(e,t,e.use[s]);else if("object"==typeof e.use)for(const s in e.use)e.use.hasOwnProperty(s)&&this._addUseEffectToEntity(e,t,s);else this._addUseEffectToEntity(e,t,e.use)}_addUseEffectToEntity(e,t,s){const n=s;if(this._db.effects.hasOwnProperty(n)){const r=this._db.effects[n],a=r.func;if(t.useFuncs.push(a),t.has("UseEffects")){const n={[s]:e.use[s]};t.get("UseEffects").hasEffect(s)||t.get("UseEffects").addEffect(n)}if(r.hasOwnProperty("requires"))if(e.use.hasOwnProperty(s)){t.useArgs={};const n=r.requires;if("object"==typeof n)for(let r=0;r<n.length;r++)this._verifyAndAddReq(e.use[s],t,n[r]);else this._verifyAndAddReq(e.use[s],t,n)}else i.default.err("ObjectCreator","addUseEffects","useEffect shell has 'requires'.\n                        newObj shell 'use' must be an object.");if(r.hasOwnProperty("optional")){r.optional.forEach(n=>{e.use[s].hasOwnProperty(n)&&(t.useArgs[n]=e.use[s][n])})}}else i.default.err("ObjectCreator","addUseEffects","Unknown effect: |"+n+"|")}addAbilityEffects(e,t){e.use||(e.use=e.ability),t.has("UseEffects")||t.add(new c.UseEffects),this.addUseEffects(e,t)}_verifyAndAddReq(e,t,s){e.hasOwnProperty(s)?t.useArgs[s]=e[s]:i.default.err("ObjectCreator","_verifyAndAddReq",`Req |${s}| not specified in item shell. Item: ${t}`)}createFromShell(e,t){return t?this.createActualObj(e,t.name):(i.default.err("Creator","createFromShell","obj given must be defined."),null)}createBrain(e,t){if(h.Brain[t])return new h.Brain[t](e);const s=`ERROR. No brain type |${t}| found`;i.default.err("Creator","createBrain",s)}}t.Creator=C,t.ObjectShell.Creator=C;class T{constructor(e,t){this._db=e,this._dbDanger=t,this._cache={actorWeights:{}}}dbGet(e){const t=e.name,s=e.categ,n=e.danger;if(!i.default.isNullOrUndef([t]))return s||i.default.err("ProcGen","dbGet","Both name and categ must be given!"),this._db[s][t];if(!i.default.isNullOrUndef([n])){if(this._dbDanger.hasOwnProperty(n)){const e=this._dbDanger[n];return void 0!==s?e.hasOwnProperty(s)?e[s]:{}:this._dbDanger[n]}return{}}return!i.default.isNullOrUndef([s])&&this._db.hasOwnProperty(s)?this._db[s]:{}}filterCategWithFunc(e,t){const s=this.dbGet({categ:e}),n=[],r=Object.keys(s);for(let e=0;e<r.length;e++){const a=s[r[e]];t(a)&&n.push(a)}return n}dbGetRand(e){const t=e.danger,s=e.categ;if(void 0!==t&&void 0!==s&&this._dbDanger.hasOwnProperty(t)){const e=this._dbDanger[t][s];return this.getRandFromObj(e)}return null}getRandomActor(e){if(e.hasOwnProperty("danger")){const t=e.danger,s=this.dbGetRand({danger:t,categ:i.default.TYPE_ACTOR});if(null!==s)return s}else if(e.hasOwnProperty("func")){const t=this.filterCategWithFunc(i.default.TYPE_ACTOR,e.func);return w.arrayGetRand(t)}return null}getRandomItem(e){if("function"==typeof e){const t=this.filterCategWithFunc(i.default.TYPE_ITEM,e);return w.arrayGetRand(t)}if(e.hasOwnProperty("func")){const t=this.filterCategWithFunc(i.default.TYPE_ITEM,e.func);return w.arrayGetRand(t)}return i.default.err("ProcGen","getRandomItem","No function with func. obj arg: "+JSON.stringify(e)),null}getRandomActorWeighted(e,t){const s=e+","+t;this._cache.actorWeights.hasOwnProperty(s)||(this._cache.actorWeights[s]=i.default.getDangerProb(e,t));const n=w.getWeighted(this._cache.actorWeights[s]);return this.getRandomActor({danger:parseInt(n,10)})}getRandFromObj(e){const t=Object.keys(e);return e[t[w.randIndex(t)]]}}t.ProcGen=T,t.ObjectShell.ProcGen=T;class O{constructor(){this._base={actors:{},effects:{},items:{},elements:{}},this._db={actors:{},effects:{},items:{},elements:{}},this._dbDanger={},this._dbNoRandom={actors:{},items:{},elements:{}},this._creator=new C(this._db,this._dbNoRandom),this._procgen=new T(this._db,this._dbDanger),this.adjustColorsWhenNeeded=!0}getCreator(){return this._creator}getProcGen(){return this._procgen}parseShellData(e){const t=Object.keys(e);for(let s=0;s<t.length;s++){const n=e[t[s]];Array.isArray(n)?this.parseShellCateg(t[s],n):i.default.err("ObjectShell.Parser","parseShellData",t[s]+" is not an array of shells!")}}parseShellCateg(e,t){for(let s=0;s<t.length;s++)this.parseObjShell(e,t[s])}parseObjShell(e,t){if(this.validShellGiven(t)){if(t.hasOwnProperty("base")){("string"==typeof t.base?[t.base]:t.base).forEach(s=>{this.baseExists(e,s)?t=this.extendObj(t,this.getBase(e,s)):i.default.err("ObjectParser","parseObjShell","Unknown base "+s+" specified for "+JSON.stringify(t))})}return e===i.default.TYPE_ACTOR&&this.addTypeIfUntyped(t),this.storeIntoDb(e,t),t}return null}validShellGiven(e){return!!e.hasOwnProperty("name")||(i.default.err("Parser","validShellGiven","shell doesn't have a name. shell: "+JSON.stringify(e)),!1)}addTypeIfUntyped(e){e.hasOwnProperty("type")||(e.type=e.name)}get(e,t){return this._db[e][t]}getBase(e,t){return this._base[e][t]}storeForUsingAsBase(e,t){this._base[e][t.name]=t}storeIntoDb(e,t){if(this._db.hasOwnProperty(e)){if(this.storeForUsingAsBase(e,t),t.hasOwnProperty("noRandom"))this._dbNoRandom[e][t.name]=t;else if(!t.hasOwnProperty("dontCreate")&&(this._db[e][t.name]=t,t.hasOwnProperty("danger"))){const s=t.danger;this._dbDanger.hasOwnProperty(s)||(this._dbDanger[s]={}),this._dbDanger[s].hasOwnProperty(e)||(this._dbDanger[s][e]={}),this._dbDanger[s][e][t.name]=t}}else i.default.err("ObjectParser","storeIntoDb","Unknown category: "+e);"effects"!==e&&this.storeRenderingInfo(e,t)}storeRenderingInfo(e,t){let s="",n="";if(t.hasOwnProperty("color")){if(i.default.isNullOrUndef([t.color])){const e=JSON.stringify(t);i.default.err("Parser","storeRenderingInfo","obj.color null/undef! obj: "+e)}s=this._creator.getShellValue(t.color.fg),n=this._creator.getShellValue(t.color.bg)}t.hasOwnProperty("colorfg")&&(s=this._creator.getShellValue(t.colorfg)),t.hasOwnProperty("colorbg")&&(n=this._creator.getShellValue(t.colorbg)),"random"===s&&(s=w.arrayGetRand(i.default.COLORS)),"random"===n&&(n=w.arrayGetRand(i.default.COLORS)),this.adjustColorsWhenNeeded&&""!==s&&""!==n&&v.colorsTooClose(s,n)&&(s=v.getNewFgColor(s,n)),""===s&&""===n||(t.className||(t.className=""),t.className+=" cell-fg-"+s.toLowerCase()+" cell-bg-"+n.toLowerCase()),t.hasOwnProperty("char")&&(t.hasOwnProperty("name")?(i.default.addCharStyle(e,t.name,t.char),t.dontCreate&&i.default.addCharStyle(e,t.type,t.char)):i.default.addCharStyle(e,t.type,t.char)),t.hasOwnProperty("className")&&(t.hasOwnProperty("name")?(i.default.addCellStyle(e,t.name,t.className),t.dontCreate&&i.default.addCellStyle(e,t.type,t.className)):i.default.addCellStyle(e,t.type,t.className))}baseExists(e,t){return!!this._base.hasOwnProperty(e)&&this._base[e].hasOwnProperty(t)}extendObj(e,t){for(const s in t)e.hasOwnProperty(s)||"dontCreate"!==s&&(e[s]=t[s]);return e}createEntity(e){return this.hasObj(i.default.TYPE_ITEM,e)?this.createItem(e):this.hasObj(i.default.TYPE_ACTOR,e)?this.createActor(e):null}createActor(e){return this.createActualObj(i.default.TYPE_ACTOR,e)}createItem(e){return this.createActualObj(i.default.TYPE_ITEM,e)}createElement(e){return this.createActualObj(i.default.TYPE_ELEM,e)}hasItem(e){return this.hasObj(i.default.TYPE_ITEM,e)}hasObj(e,t){return this.dbExists(e,t)}createActualObj(e,t){return this.dbExists(e,t)?this._creator.createActualObj(e,t):(i.default.err("Parser","createActualObj",`Categ: ${e} Name: ${t} doesn't exist.`),null)}createFromShell(e,t){return this.dbExists(e,t.name)||this.parseObjShell(e,t),this._creator.createFromShell(e,t)}dbExists(e,t){return!(!this._db.hasOwnProperty(e)||!this._db[e].hasOwnProperty(t))||!!this._dbNoRandom[e][t]}dbGet(e){return this._procgen.dbGet(e)}dbGetActor(e){const t={name:e.name,categ:i.default.TYPE_ACTOR};return this._procgen.dbGet(t)}dbGetItem(e){const t={name:e.name,categ:i.default.TYPE_ITEM};return this._procgen.dbGet(t)}dbGetRand(e){return this._procgen.dbGetRand(e)}filter(e,t){return this._procgen.filterCategWithFunc(e,t)}filterItems(e){return this._procgen.filterCategWithFunc(i.default.TYPE_ITEM,e)}dbGetNoRandom(e){const t=e.name,s=e.categ,n=e.danger;if(s&&this._dbNoRandom[s]){if(!t)return Object.values(this._dbNoRandom[s]);{const e=this._dbNoRandom[s][t];if(e)return[e]}}else s&&n&&i.default.err("ProcGen","dbGetNoRandom","Query by danger not implemented yet");return[]}createRandomActor(e){const t=this._procgen.getRandomActor(e);return t?this._creator.createFromShell(i.default.TYPE_ACTOR,t):null}createRandomActorWeighted(e,t,s){const n=this._procgen.getRandomActorWeighted(e,t);return n?this._creator.createFromShell(i.default.TYPE_ACTOR,n):i.default.isNullOrUndef([s])?null:this.createRandomActor(s)}createRandomItem(e){const t=this._procgen.getRandomItem(e);return t?this._creator.createFromShell("items",t):null}toJSON(){const e={_base:{},_db:{},_dbDanger:this._dbDanger,_dbNoRandom:this._dbNoRandom};return["actors","items","elements"].forEach(t=>{e._base[t]=this._base[t],e._db[t]=this._db[t]}),e}restoreFromDb(e){["_base","_db","_dbDanger","_dbNoRandom"].forEach(t=>{Object.keys(e[t]).forEach(s=>{this[t][s]=e[t][s]})})}}t.Parser=O,t.ObjectShell.Parser=O,t.createItem=function(e){const s=t.ObjectShell.getParser(),n=s.getCreator();return"string"==typeof e?n.createItem(e):(s.parseObjShell(i.default.TYPE_ITEM,e),n.createFromShell(i.default.TYPE_ITEM,e))},t.getParser=function(){if(!t.ObjectShell.parserInstance){const e=new O;e.parseShellData(d.Effects);const s=JSON.stringify(p.Objects),n=JSON.parse(s);_.adjustActorValues(n.actors),e.parseShellData(n),t.ObjectShell.parserInstance=e;const r=S.ActorGen.genActors(500);e.parseShellData({actors:r})}return t.ObjectShell.parserInstance},t.ObjectShell.getParser=t.getParser,t.restoreParser=function(e){const s=new O;s.restoreFromDb(e),s.parseShellData(d.Effects),t.ObjectShell.parserInstance=s},t.ObjectShell.restoreParser=t.restoreParser},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.create=t.ElementMarker=t.ElementPlantedSoil=t.ElementTilledSoil=t.ElementPlaceholder=t.ElementHole=t.ElementSlime=t.ElementWeb=t.ElementTrap=t.ElementExploration=t.ElementShop=t.ElementLever=t.ElementLeverDoor=t.ElementDoor=t.ElementStairs=t.ElementXY=t.ElementWall=t.ElementBase=t.Element=void 0;const i=o(s(0)),l=s(25),c=a(s(97)),u=a(s(13)),h=s(16);t.Element={};const d=/wall/,f=/(?:highrock|chasm|wall)/;t.Element.canJumpOver=e=>!(d.test(e)||/highrock/.test(e));class g extends(c.Typed(l.Entity)){constructor(e,t){let s=null,n=null;"object"==typeof e?(s=e.name,n=e.type):(s=e,n=t),n=n||s,super({propType:i.default.TYPE_ELEM,type:n}),this._name=s,this.msg={},this.z=0}getName(){return this._name}setName(e){this._name=e}getZ(){return this.z}setZ(e){this.z=e}isWall(){return d.test(this.getType())}isObstacle(){return f.test(this.getType())}isPassable(){return!this.has("Impassable")}isPassableByAir(){return!this.has("Impassable")||this.get("Impassable").canFlyOver}isSpellPassable(){return!this.has("Impassable")||this.get("Impassable").spellPasses}lightPasses(){return!this.has("Opaque")}setMsg(e){this.msg=e}getMsg(e){return this.msg[e]}hasMsg(e){return this.msg.hasOwnProperty(e)}onSystemAdd(e){}onSystemRemove(e){}toJSON(){const e=h.compsToJSON(this),t={id:this.getID(),name:this.getName(),type:this.getType(),msg:this.msg};return e&&(t.components=e),t}}t.ElementBase=g,t.Element.Base=g;class p extends g{constructor(e){super(e),this.add(new u.Opaque);const t=new u.Impassable;t.setAllImpassable(),this.add(t)}}t.ElementWall=p,t.Element.Wall=p;class m extends(c.Locatable(g)){constructor(e,t){super(e,t)}}t.ElementXY=m;class y extends m{constructor(e,t,s){super({name:e,type:"connection"}),this._srcLevel=t,this._targetLevel=s,this._targetStairs=null}isConnected(){return!i.default.isNullOrUndef([this._srcLevel,this._targetLevel,this._targetLevel])}setSrcLevel(e){i.default.isNullOrUndef([e])?i.default.err("Element.Stairs","setSrcLevel","Cannot set null/undefined level"):this._srcLevel=e}getSrcLevel(){return this._srcLevel}setTargetLevel(e){i.default.isNullOrUndef([e])?i.default.err("Element.Stairs","setTargetLevel","Cannot set null/undefined level."):this._targetLevel=e}getTargetLevel(){return this._targetLevel}setTargetStairs(e){if(i.default.isNullOrUndef([e]))i.default.err("Element.Stairs","setTargetStairs","Cannot set null/undefined stairs.");else{this._targetStairs=e;const t=e.getSrcLevel();i.default.isNullOrUndef([t])||this.setTargetLevel(t)}}getTargetStairs(){return this._targetStairs}getConnID(){const e=this.getX(),t=this.getY();this._srcLevel||i.default.err("Stairs","getID","_srcLevel is not defined");return`${this._srcLevel.getID()},${e},${t}`}connect(e,t=0){const s=this.getSrcLevel();if(s||i.default.err("Stairs","connect","Cannot connect. srcLevel is not defined!"),Array.isArray(e)){e.forEach(e=>{e.setTargetStairs(this),e.setTargetLevel(s)}),this.setTargetStairs(e[t]);const n=e[t].getSrcLevel();n?this.setTargetLevel(n):i.default.err("Stairs","connect","Tried to set undefined target level")}else{this.setTargetStairs(e),e.setTargetStairs(this);const t=e.getSrcLevel();t?this.setTargetLevel(t):i.default.err("Stairs","connect","Tried to set undefined target level"),e.setTargetLevel(s)}}isDown(){return/stairsDown/.test(this.getName())}useStairs(e){if(!i.default.isNullOrUndef([this._targetStairs,this._targetLevel]))if(this._targetStairs instanceof y){const t=this._targetStairs.getX(),s=this._targetStairs.getY(),n=this._srcLevel;if(n&&n.removeActor(e)){if(this._targetLevel.addActor(e,t,s))return!0}else i.default.err("Stairs","useStairs","Tried to use stairs without srcLevel")}else i.default.err("ElementStairs","useStairs","Tried to use stairs without proper targetStairs");return!1}setConnObj(e){this._targetStairs=e.targetStairs,this._targetLevel=e.targetLevel}getConnObj(){const e=this.getTargetStairs();if(e instanceof y){const t=this.getTargetLevel();return{targetStairs:{x:e.getX(),y:e.getY()},targetLevel:t.getID()}}return e?{targetStairs:{x:e.x,y:e.y},targetLevel:this.getTargetLevel()}:(i.default.err("ElementStairs","getConnObj","targetStairs is null. Cannot create the connObj!"),null)}toJSON(){const e={name:this.getName(),type:this.getType()};this._srcLevel&&(e.srcLevel=this.getSrcLevel().getID()),Number.isInteger(this._targetLevel)?e.targetLevel=this._targetLevel:this._targetLevel&&(e.targetLevel=this.getTargetLevel().getID());const t=this.getTargetStairs();return t&&(e.targetStairs=t instanceof y?{x:t.getX(),y:t.getY()}:t),e}}t.ElementStairs=y,t.Element.Stairs=y;class _ extends m{constructor(e){super("door"),this._closed=void 0===e||e,this._opaque=new u.Opaque;const t=new u.Impassable;t.setAllImpassable(),this._impassable=t,this._closed&&this.closeDoor()}canToggle(){return!0}isOpen(){return!this._closed}isClosed(){return this._closed}openDoor(){this._closed=!1,this.remove("Opaque"),this.remove("Impassable")}closeDoor(){this._closed=!0,this.add(this._opaque),this.add(this._impassable)}toJSON(){const e=super.toJSON();return e.closed=this._closed,e}}t.ElementDoor=_,t.Element.Door=_;class b extends _{constructor(e=!0){super(e),this.setType("leverdoor")}canToggle(){return!1}onUse(){this.isOpen()?this.closeDoor():this.openDoor()}toJSON(){const e=super.toJSON();return e.type="leverdoor",e}}t.ElementLeverDoor=b,t.Element.LeverDoor=b;class v extends m{constructor(){super("lever"),this._targets=[]}getTargets(){return this._targets}addTarget(e){this._targets.push(e)}onUse(e){this._targets.forEach(t=>{t.onUse&&t.onUse(e)})}toJSON(){const e=super.toJSON();return e.id=this.getID(),e.type="lever",e.addTarget=this._targets.map(e=>i.default.getObjRef("entity",e)),e}}t.ElementLever=v,t.Element.Lever=v;class E extends m{constructor(){super("shop"),this._shopkeeper=null,this._costFactorShopSells=1,this._costFactorShopBuys=.5,this._isAbandoned=!0}isAbandoned(){return this._isAbandoned}reclaim(e){this._shopkeeper=e,this._isAbandoned=!1}getItemPriceForBuying(e){if(e.has("Unpaid")){const t=e.getValue(),s=i.default.valueToGoldWeight(t);let n=i.default.getGoldInCoins(s);return n*=e.getCount(),n=Math.ceil(this._costFactorShopSells*n),0===n?1:n}return i.default.err("Element.Shop","getItemPriceForBuying","Item "+e.getName()+" is not Unpaid item"),0}getItemPriceForSelling(e,t){const s=e.getValue(),n=i.default.valueToGoldWeight(s);let r=i.default.getGoldInCoins(n);return r*=t||e.getCount(),r=Math.floor(this._costFactorShopBuys*r),r}abandonShop(){this._shopkeeper=null,this._isAbandoned=!0}setShopkeeper(e){i.default.isNullOrUndef([e])?i.default.err("Element.Shop","setShopkeeper","Shopkeeper must be non-null and defined."):(this._shopkeeper=e,this._isAbandoned=!1)}getShopkeeper(){return this._shopkeeper}setCostFactor(e,t){i.default.isNullOrUndef([e,t])?i.default.err("Element.Shop","setCostFactor","Args buy/sell must be non-null and defined!"):(this._costFactorShopSells=t,this._costFactorShopBuys=e)}getCostFactorSell(){return this._costFactorShopSells}getCostFactorBuy(){return this._costFactorShopBuys}toJSON(){let e=null;this._shopkeeper&&(e=this._shopkeeper.getID());const t={type:"shop",isAbandoned:this._isAbandoned,costFactorSell:this._costFactorShopSells,costFactorBuy:this._costFactorShopBuys};return null!==e&&(t.shopkeeper=e),t}}t.ElementShop=E,t.Element.Shop=E;class S extends m{constructor(){super("exploration"),this.exp=0}setData(e){this.data=e}addData(e,t){this.data[e]=t}getData(){return this.data}hasData(){return!!this.data}setExp(e){Number.isInteger(e)?this.exp=e:i.default.err("ElementExploration","setExp","exp is not an integer: "+e)}getExp(){return this.exp}toJSON(){const e={type:this.getType(),setExp:this.getExp()};return this.hasData()&&(e.data=this.data),e}}t.ElementExploration=S,t.Element.Exploration=S;class w extends m{constructor(e){super(e)}onSystemAdd(e){e.getSentientActors().forEach(e=>{e.add(new u.Entrapped)})}onSystemRemove(e){e.getSentientActors().forEach(e=>{e.remove("Entrapped")})}}t.ElementTrap=w;class C extends m{constructor(){super("web");const e=new u.Entrapping;e.setDestroyOnMove(!0),e.setDifficulty(20),this.add(e)}setDifficulty(e){this.get("Entrapping").setDifficulty(e)}}t.ElementWeb=C,t.Element.Web=C;class T extends w{constructor(){super("slime");const e=new u.Entrapping;e.setDestroyOnMove(!0),e.setDifficulty(30),this.add(e)}setDifficulty(e){this.get("Entrapping").setDifficulty(e)}}t.ElementSlime=T,t.Element.Slime=T;class O extends w{constructor(){super("hole");const e=new u.Entrapping;e.setDestroyOnMove(!1),e.setDifficulty(50),this.add(e)}setDifficulty(e){this.get("Entrapping").setDifficulty(e)}}t.ElementHole=O,t.Element.Hole=O;class A extends m{constructor(){super("placeholder")}}t.ElementPlaceholder=A,t.Element.PlaceHolder=A;class M extends m{constructor(){super("tilled soil"),this.add(new u.TilledSoil)}}t.ElementTilledSoil=M,t.Element.TilledSoil=M;class N extends m{constructor(){super("planted soil"),this.add(new u.PlantedSoil)}}t.ElementPlantedSoil=N,t.Element.PlantedSoil=N;class P extends m{constructor(e){super("marker"),this.char=e,this.char=e,this.tag="",this.className=!1}getClassName(){return this.className}setClassName(e){this.className=e}getChar(){return this.char}setChar(e){this.char=e}setTag(e){this.tag=e}getTag(){return this.tag}toJSON(){const e=super.toJSON();return e.char=this.char,e.tag=this.tag,e}}t.ElementMarker=P,t.Element.Marker=P,t.create=function(e,...s){return t.Element.hasOwnProperty(e)?new t.Element[e](...s):null},t.Element.create=t.create},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.snowMeltMap=t.snowElemMap=t.getElem=t.ELEM_MAP=t.ELEMS=t.ELEM=void 0;const n=s(6),r=s(7);t.ELEM={},t.ELEMS={};const a=Object.freeze,o=n.ObjectShell.getParser();t.ELEM.BED=a(o.createElement("bed")),t.ELEM.BRIDGE=a(o.createElement("bridge")),t.ELEM.SHALLOW_CHASM=a(o.createElement("shallow chasm")),t.ELEM.CHASM=a(o.createElement("chasm")),t.ELEM.DEEP_CHASM=a(o.createElement("deep chasm")),t.ELEMS.CHASMS=[t.ELEM.SHALLOW_CHASM,t.ELEM.CHASM,t.ELEM.DEEP_CHASM],t.ELEM.GRASS=a(o.createElement("grass")),t.ELEM.GRASS_SNOW=a(o.createElement("snowy grass")),t.ELEM.HIGH_ROCK=a(o.createElement("highrock")),t.ELEM.LAVA=a(o.createElement("lava")),t.ELEM.PATH=a(o.createElement("path")),t.ELEM.ROAD=a(o.createElement("road")),t.ELEM.SKY=a(o.createElement("sky")),t.ELEM.SNOW=a(o.createElement("snow")),t.ELEM.SNOW_TRACKS=a(o.createElement("snow with tracks")),t.ELEM.SNOW_DEEP=a(o.createElement("deep snow")),t.ELEM.SNOW_DEEP_TRACKS=a(o.createElement("deep snow with tracks")),t.ELEM.SNOW_LIGHT=a(o.createElement("light snow")),t.ELEM.SNOW_LIGHT_TRACKS=a(o.createElement("light snow with tracks")),t.ELEM.CLIFF=a(o.createElement("cliff")),t.ELEM.STONE=a(o.createElement("stone")),t.ELEM.STEEP_CLIFF=a(o.createElement("steep cliff")),t.ELEM.SNOWY_CLIFF=a(o.createElement("snowy cliff")),t.ELEM.STONE_SNOW=a(o.createElement("snow-covered stone")),t.ELEM.FROZEN_STEEP_CLIFF=a(o.createElement("frozen steep cliff")),t.ELEM.TREE=a(o.createElement("tree")),t.ELEM.TREE_LARGE=a(o.createElement("large tree")),t.ELEM.TREE_SNOW=a(o.createElement("snow-covered tree")),t.ELEM.TREE_LARGE_SNOW=a(o.createElement("large frozen tree")),t.ELEM.WINDOW=a(o.createElement("closed window")),t.ELEM.FLOOR=a(o.createElement("floor")),t.ELEM.FLOOR_CASTLE=a(o.createElement("floorcastle")),t.ELEM.FLOOR_CAVE=a(o.createElement("floorcave")),t.ELEM.FLOOR_CRYPT=a(o.createElement("floorcrypt")),t.ELEM.FLOOR_HOUSE=a(o.createElement("floorhouse")),t.ELEM.FLOOR_WOODEN=a(o.createElement("floorwooden")),t.ELEM.WALL=a(new r.ElementWall("wall")),t.ELEM.WALL_DUNGEON=a(o.createElement("walldungeon")),t.ELEM.WALL_CASTLE=a(o.createElement("wallcastle")),t.ELEM.WALL_CAVE=a(o.createElement("wallcave")),t.ELEM.WALL_CRYPT=a(o.createElement("wallcrypt")),t.ELEM.WALL_ICE=a(o.createElement("wallice")),t.ELEM.WALL_WOODEN=a(o.createElement("wallwooden")),t.ELEM.WALL_MOUNT=a(new r.ElementWall("wallmount")),t.ELEM.WALL_RUBY=a(o.createElement("wallruby")),t.ELEM.WALL_VOID=a(o.createElement("wallvoid")),t.ELEM.WALL_FORIUM=a(o.createElement("wallforium")),t.ELEM.SHALLOW_WATER=a(o.createElement("shallow water")),t.ELEM.WATER=a(o.createElement("water")),t.ELEM.DEEP_WATER=a(o.createElement("deep water")),t.ELEMS.WATER=[t.ELEM.SHALLOW_WATER,t.ELEM.WATER,t.ELEM.DEEP_WATER],t.ELEM.SHALLOW_FROZEN_WATER=a(o.createElement("frozen shallow water")),t.ELEM.WATER_FROZEN=a(o.createElement("frozen water")),t.ELEM.DEEP_FROZEN_WATER=a(o.createElement("frozen deep water")),t.ELEM.FORT=a(o.createElement("fort")),t.ELEM_MAP={},t.ELEM_MAP.elemTypeToObj={},t.ELEM_MAP.elemTypeToIndex={},t.ELEM_MAP.elemIndexToType={},t.ELEM_MAP.elemIndexToElemObj={};let i=1;Object.keys(t.ELEM).forEach(e=>{const s=t.ELEM[e].getType();t.ELEM_MAP.elemTypeToObj[s]=t.ELEM[e],t.ELEM_MAP.elemTypeToIndex[s]=i,t.ELEM_MAP.elemIndexToType[i]=s,t.ELEM_MAP.elemIndexToElemObj[i]=t.ELEM[e],++i}),t.getElem=function(e){return"string"==typeof e?t.ELEM_MAP.elemTypeToObj[e]:e},t.snowElemMap={floor:t.ELEM.SNOW_LIGHT,"light snow":t.ELEM.SNOW,"light snow with tracks":t.ELEM.SNOW,snow:t.ELEM.SNOW_DEEP,"snow with tracks":t.ELEM.SNOW,tree:t.ELEM.TREE_SNOW,"snow-covered tree":t.ELEM.TREE_SNOW,"shallow water":t.ELEM.SHALLOW_FROZEN_WATER,water:t.ELEM.WATER_FROZEN,"deep water":t.ELEM.DEEP_FROZEN_WATER,grass:t.ELEM.GRASS_SNOW,"snowy grass":t.ELEM.GRASS_SNOW,"deep snow with tracks":t.ELEM.SNOW_DEEP,cliff:t.ELEM.SNOWY_CLIFF,stone:t.ELEM.STONE_SNOW,"steep cliff":t.ELEM.FROZEN_STEEP_CLIFF},t.snowMeltMap={"light snow":t.ELEM.FLOOR,"light snow with tracks":t.ELEM.FLOOR,snow:t.ELEM.SNOW_LIGHT,"snow with tracks":t.ELEM.SNOW_LIGHT,"snow-covered tree":t.ELEM.TREE,"frozen shallow water":t.ELEM.SHALLOW_WATER,"frozen water":t.ELEM.WATER,"frozen deep water":t.ELEM.DEEP_WATER,"snowy grass":t.ELEM.GRASS,"deep snow":t.ELEM.SNOW,"deep snow with tracks":t.ELEM.SNOW,"snowy cliff":t.ELEM.CLIFF,"snow-covered stone":t.ELEM.STONE,"frozen steep cliff":t.ELEM.STEEP_CLIFF}},function(e,t){var s=Array.isArray;e.exports=s},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Path=t.PathAlgoXY=void 0;const r=n(s(260)),a=n(s(0)),o=s(261),i=Object.freeze([]),l=(e,t,s,n)=>!0;class c{constructor(e,t,s){this.tx=e,this.ty=t,this.passCb=s}compute(e,t,s){const n=[];let r=e,o=t;for(;r!==this.tx||o!==this.ty;){const e=this.tx-r,t=this.ty-o,s=e/Math.abs(e),i=t/Math.abs(t);if(r===this.tx){if(o===this.ty)break;1!==Math.abs(t)&&(r+=this.passCb(r+1,o,r,o)&&a.default.isSuccess(.33)?1:this.passCb(r-1,o,r,o)&&a.default.isSuccess(.33)?-1:0),o+=i}else if(o===this.ty){if(r===this.tx)break;r+=s,1!==Math.abs(e)&&(o+=this.passCb(r,o+1,r,o)&&a.default.isSuccess(.33)?1:this.passCb(r,o-1,r,o)&&a.default.isSuccess(.33)?-1:0)}else r+=s,o+=i;if(!this.passCb(r,o,r-s,o-i))break;n.push([r,o])}n.forEach(e=>{s(e[0],e[1])})}}t.PathAlgoXY=c;class u{}function h(e,t,s,n){for(let r=e-1;r<=e+1;r++)for(let a=t-1;a<=t+1;a++)if(s.hasXY(r,a)&&n(r,a,e,t))return!1;return!0}function d(e){e.length>1&&(e.shift(),e.pop())}t.Path=u,u.getPossiblePath=function(e,t,s,n,r=l){const a=[];return new c(s,n,r).compute(e,t,(e,t)=>{a.push({x:e,y:t})}),a},u.getShortestPath=function(e,t,s,n,a=l){const o=[],i=a;return new r.default(s,n,i).compute(e,t,(e,t)=>{o.push({x:e,y:t})}),o},u.getShortestSeenPath=function(e,t,s,n){const r=e.getBrain().getSeenCells(),a={};r.forEach(e=>{a[e.getKeyXY()]=e});const l=(e,r,o,i)=>!!a.hasOwnProperty(e+","+r)&&(t.isPassable(e,r,o,i)||e===c&&r===u||e===s&&r===n),[c,u]=e.getXY();if(h(c,u,t,l))return i;const f=[];return new o.AStar3D(s,n,t,l).compute(c,u,(e,t)=>{f.push({x:e,y:t})}),d(f),f},u.getShortestPassablePath=function(e,t,s,n,r){const a=[];return new o.AStar3D(n,r,e,(t,s,n,r)=>e.isPassable(t,s,n,r)).compute(t,s,(e,t)=>{a.push({x:e,y:t})}),a},u.getActorToActorPath=function(e,t,s,n,r){const a=[],l=(a,o,i,l)=>!!e.hasXY(a,o)&&(e.isPassable(a,o,i,l)||a===t&&o===s&&e.getElemDzAbs(a,o,i,l)<=1||a===n&&o===r&&e.getElemDzAbs(a,o,i,l)<=1);if(h(t,s,e,l))return i;return new o.AStar3D(n,r,e,l).compute(t,s,(e,t)=>{a.push({x:e,y:t})}),d(a),a},u.getShortestActorPath=function(e,t,s,n,r,a){const l=[],c=(n,r,o,i)=>{if(e.hasXY(n,r)){if(a)return a(n,r,o,i)||n===t&&r===s&&e.getElemDzAbs(n,r,o,i)<=1;let l=e.isPassable(n,r,o,i);if(!l){const a=e.getElemDzAbs(n,r,o,i);l=n===t&&r===s&&a<=1}return l}return!1};if(h(t,s,e,c))return i;return new o.AStar3D(n,r,e,c).compute(t,s,(e,t)=>{l.push({x:e,y:t})}),function(e){e.length>0&&e.shift()}(l),l},u.getShortestPassablePathWithDoors=function(e,t,s,n,r){const a=[];return new o.AStar3D(n,r,e,(t,s,n,r)=>!!e.hasXY(t,s)&&(e.isPassable(t,s,n,r)||e.getCell(t,s).hasDoor())).compute(t,s,(e,t)=>{a.push({x:e,y:t})}),a},u.shortestDist=function(e,t,s,n){return u.getShortestPath(e,t,s,n).length-1},u.getPathWeight=(e,t)=>{let s=0;return t.forEach(t=>{if(e.hasXY(t.x,t.y)){switch(e.getBaseElemXY(t.x,t.y).getType()){case"floor":s+=1;break;case"forest":case"stone":s+=2;break;case"water":case"highrock":s+=4;break;case"chasm":s+=5;break;case"wall":s+=20;break;default:s+=0}}}),s},u.getMinWeightPath=function(e,t,s,n,r,a){let o=[];o=a?a(e,t,s,n,r):u.getShortestPassablePath(e,t,s,n,r);const i=u.getShortestPath(t,s,n,r),l=u.getPathWeight(e,o),c=u.getPathWeight(e,i);let h=null;return h=0===o.length||l>=c?i:o,h},u.getMinWeightOrShortest=function(e,t,s,n,r,a){const o=u.getShortestPath(t,s,n,r),i=[];a.forEach(e=>{const a=u.getShortestPath(t,s,n,r,e);a.length>0&&i.push(a)}),i.push(o);let l=[],c=-1;return i.forEach(t=>{const s=u.getPathWeight(e,t);(-1===c||s<c)&&(c=s,l=t)}),l},u.getWeightPathSegmented=function(e,t,s,n,r,a,o){const i=n-t,l=r-s,c=u.getPathSeg(i,a),h=u.getPathSeg(l,a);let d=[],[f,g]=[t,s];for(let t=0;t<a;t++){const[s,n]=[f+c[t],g+h[t]],r=u.getMinWeightPath(e,f,g,s,n,o);[f,g]=[s,n],d=d.concat(r)}return d},u.getPathSeg=function(e,t){let s=e;const n=[],r=Math.floor(e/t);for(let e=0;e<t-1;e++)n.push(r),s-=r;return n.push(s),n},u.getPathFromEdgeToCell=function(e,t){const s=e.getFreeEdgeCells()[0],n=e.getCellWithElem(t);if(!n||!s)return[];const r=e.getMap(),[a,o]=s.getXY(),[i,l]=n.getXY();return u.getShortestPath(a,o,i,l,(e,t)=>r.hasXY(e,t)&&!/wall/.test(r.getCell(e,t).getBaseElem().getType()))}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Level=t.LevelCallback=void 0;const i=o(s(0)),l=s(25),c=s(13),u=s(16),h=s(1),d=s(12),f=s(27),g=s(8),p=a(s(13)),m=s(18),y=d.EventPool.getPool(),{TYPE_ACTOR:_,TYPE_ELEM:b,TYPE_ITEM:v}=i.default,E=h.Random.getRNG();t.LevelCallback=class{constructor(e){this.cbType=e}execute(){i.default.gameMsg(this.msg)}getCbType(){return this.cbType}toJSON(){return{cbType:this.getCbType(),msg:this.msg}}};class S extends l.Entity{constructor(e){super(),this._map=e,this._parent=null,this._p={actors:[],elements:[],items:[]},this._levelNo=0,this._callbacks={},this._cbState={onFirstEnterDone:!1,onFirstExitDone:!1},this.add(new p.Lore),this.add(new p.Place),this.actorWarnLimit=1e3}static createLevelID(){return l.Entity.createEntityID()}setLevelNumber(e){this._levelNo=e}getLevelNumber(){return this._levelNo}getSizeXY(){return[this._map.cols,this._map.rows]}getParent(){return this._parent}getParentZone(){const e=this.getParent();if(e){if(e.getParent)return e.getParent();i.default.err("Level","getParentZone","No getParent() in "+JSON.stringify(e))}return null}setParent(e){i.default.isNullOrUndef([e])?i.default.err("Map.Level","setParent","Parent is not defined."):this._parent=e}getActors(){return this._p.actors}getItems(){return this._p.items}getElements(){return this._p.elements}getStairs(){const e=[];return this._p.elements.forEach(t=>{this._isStairs(t)&&e.push(t)}),e}getPassages(){const e=[];return this._p.elements.forEach(t=>{if("passage"===t.getName()){const s=t;e.push(s)}}),e}getConnections(){const e=[];return this._p.elements.forEach(t=>{if("connection"===t.getType()){const s=t;e.push(s)}}),e}_isStairs(e){return/stairs(Down|Up)/.test(e.getName())}setMap(e,t){this._map=e,t&&(t.elements&&(this._p.elements=t.elements),this._p.elements.forEach(e=>{e.setLevel(this)}))}getMap(){return this._map}getStairsToLevel(e){i.default.isNullOrUndef([e])&&i.default.err("Map.Level","getStairs","arg |level| required.");const t=this.getStairs();for(let s=0;s<t.length;s++)if(t[s].getTargetLevel()===e)return t[s];return null}addStairs(e,t,s){if(i.default.isNullOrUndef([t,s]))i.default.err("Map.Level","addStairs","Cannot add stairs. x, y missing.");else{if(this._map.hasXY(t,s)){e.setSrcLevel(this);const n=this._map.getBaseElemXY(t,s);return(n.has("Impassable")||0===n.getZ())&&this._map.setBaseElemXY(t,s,g.ELEM.FLOOR),this._addPropToLevelXY(i.default.TYPE_ELEM,e,t,s)}{const e=`x,y ${t},${s} out of map bounds.`;i.default.err("Map.Level","addStairs",`${e}: cols ${this._map.cols}, rows: ${this._map.rows}`)}}return!1}useStairs(e){const t=this._map.getCell(e.getX(),e.getY());if(t.hasConnection()){if(t.getConnection().useStairs(e))return!0;i.default.err("Level","useStairs","Failed to use connection.")}return!1}addElement(e,t,s){if("connection"===e.getType()){const n=e;return this.addStairs(n,t,s)}if(!i.default.isNullOrUndef([t,s]))return this._addPropToLevelXY(i.default.TYPE_ELEM,e,t,s);const n=this._getFreeCell();if(!n)return this.debugPrintInASCII(),i.default.err("Level","addElement","Cannot add prop to null xy-coord"),!1;const[r,a]=n.getXY();return this._addPropToLevelXY(i.default.TYPE_ELEM,e,r,a)}removeElement(e,t,s){return this._removePropFromLevelXY(i.default.TYPE_ELEM,e,t,s)}addEntity(e,t,s){return i.default.isActor(e)?this.addActor(e,t,s):i.default.isItem(e)?this.addItem(e,t,s):i.default.isElement(e)?this.addElement(e,t,s):(i.default.err("Level","addEntity","No support for ents without getPropType"),!1)}addItem(e,t,s){if(!i.default.isNullOrUndef([t,s]))return this._addPropToLevelXY(i.default.TYPE_ITEM,e,t,s);const n=this._getFreeCell();if(n){const[t,s]=n.getXY();return this._addPropToLevelXY(i.default.TYPE_ITEM,e,t,s)}return!1}removeItem(e,t,s){return this._removePropFromLevelXY(i.default.TYPE_ITEM,e,t,s)}pickupItem(e){const t=new c.Pickup;e.add(t)}moveActorTo(e,t,s){const n=e.getLevel(),[r,a]=[e.getX(),e.getY()],o=e.getPropType();return!!n._removePropFromLevelXY(o,e,r,a)&&this._addPropToLevelXY(o,e,t,s)}addActor(e,t,s){return i.default.debug(this,"addActor called with x,y "+t+", "+s),i.default.isNullOrUndef([t,s])?(i.default.nullOrUndefError("Level: addActor","arg |x|",t),i.default.nullOrUndefError("Level: addActor","arg |y|",s),!1):this._map&&this._map.hasXY(t,s)?(this._addPropToLevelXY(i.default.TYPE_ACTOR,e,t,s),i.default.debug(this,"Added actor to map x: "+t+" y: "+s),this._p.actors.length>this.actorWarnLimit&&i.default.warn("Level","addActor",`Over ${this.actorWarnLimit} actors. Last added: ${e.getName()}`),!0):(i.default.err("Level","addActor","No coordinates "+t+", "+s+" in the map."),!1)}addActorToFreeCell(e){i.default.debug(this,"Adding actor to free slot");const t=this._map.getFree();if(t.length>0){const s=t[0].getX(),n=t[0].getY();if(this._addPropToLevelXY(i.default.TYPE_ACTOR,e,s,n))return i.default.debug(this,"Added actor to free cell in "+s+", "+n),!0}else i.default.err("Level","addActor","No free cells for the actor.");return!1}_addPropToLevelXY(e,t,s,n){return this._p.hasOwnProperty(e)?(this._p[e].push(t),t.isOwnable||(t.setXY(s,n),t.setLevel(this)),this._map.setProp(s,n,e,t),y.emitEvent(i.default.EVT_LEVEL_PROP_ADDED,{level:this,obj:t,propType:e}),!0):(i.default.err("Map.Level","_addPropToLevelXY",`No prop ${e} supported. Obj: ${JSON.stringify(t)}`),!1)}addVirtualProp(e,t){if(this._p.hasOwnProperty(e)){if(i.default.isActor(t))return this._p[e].push(t),t.setLevel(this),y.emitEvent(i.default.EVT_LEVEL_PROP_ADDED,{level:this,obj:t,propType:e}),!0;i.default.err("Level","addVirtualProp","Only virtual actors are supported. Got "+e)}else i.default.err("Map.Level","addVirtualProp",`No prop ${e} supported. Obj: ${JSON.stringify(t)}`);return!1}_removePropFromLevelXY(e,t,s,n){if(this._p.hasOwnProperty(e)){const r=this._p[e].indexOf(t);return r>=0?(this._p[e].splice(r,1),i.default.isItem(t)||(t.setXY(null,null),t.unsetLevel()),y.emitEvent(i.default.EVT_LEVEL_PROP_REMOVED,{level:this,obj:t,propType:e}),this._map.removeProp(s,n,e,t)):(i.default.err("Map.Level","_removePropFromLevelXY",`Obj index not found in list this._p[${e}]`),!1)}return i.default.err("Map.Level","_removePropFromLevelXY",`No prop ${e} supported. Obj: ${JSON.stringify(t)}`),!1}removeVirtualProp(e,t){if(this._p.hasOwnProperty(e)){const s=this._p[e].indexOf(t);if(s>=0)return this._p[e].splice(s,1),y.emitEvent(i.default.EVT_LEVEL_PROP_REMOVED,{level:this,obj:t,propType:e}),!0}return!1}removeActor(e){const t=this._p.actors.indexOf(e),s=e.getX(),n=e.getY();return!!this._map.removeProp(s,n,i.default.TYPE_ACTOR,e)&&(this._p.actors.splice(t,1),!0)}exploreCells(e){const t=this._map.getCellsInFOV(e);for(let e=0;e<t.length;e++)t[e].setExplored();return t}getExploredCells(){return this._map.getExploredCells()}setExtras(e){this._extras=e}getExtras(){return this._extras||(this._extras={}),this._extras}hasExtras(){return!i.default.isNullOrUndef([this._extras])&&Object.keys(this._extras).length>0}addExtras(e,t){this._extras||(this._extras={}),this._extras[e]=t}getBbox(){return m.BBox.fromBBox({ulx:0,uly:0,lrx:this.getMap().cols-1,lry:this.getMap().rows-1})}getColsRows(){return[this.getMap().cols,this.getMap().rows]}setOnEnter(e){this._callbacks.OnEnter=e}setOnFirstEnter(e){this._callbacks.OnFirstEnter=e}setOnExit(e){this._callbacks.OnExit=e}setOnFirstExit(e){this._callbacks.OnFirstExit=e}onEnter(){this._callbacks.hasOwnProperty("OnEnter")&&this._callbacks.OnEnter(this)}onFirstEnter(){this._cbState.onFirstEnterDone||(this._callbacks.hasOwnProperty("OnFirstEnter")&&this._callbacks.OnFirstEnter(this),this._cbState.onFirstEnterDone=!0)}onExit(){this._callbacks.hasOwnProperty("OnExit")&&this._callbacks.OnExit(this)}onFirstExit(){this._cbState.onFirstExitDone||(this._callbacks.hasOwnProperty("OnFirstExit")&&this._callbacks.OnFirstExit(this),this._cbState.onFirstExitDone=!0)}getFreeRandCell(){const e=this.getMap().getFree();if(e.length>0){return e[E.randIndex(e)]}return null}getEmptyRandCell(){const e=this.getMap().getEmptyCells();if(e.length>0){return e[E.randIndex(e)]}return null}_getFreeCell(){const e=this._map.getFree();return e.length>0?e[0]:null}debugPrintInASCII(){this.getMap().debugPrintInASCII()}removeElements(e){this._p.elements.filter(e).forEach(e=>{const[t,s]=e.getXY();this.removeElement(e,t,s)})}getCell(e,t){return this._map.getCell(e,t)}getPlayer(){return this._p.actors.find(e=>e.isPlayer&&e.isPlayer())}getFreeEdgeCells(){const e=this.getMap();return this.getMap().getCells(t=>(0===t.getX()||0===t.getY()||t.getX()===e.cols-1||t.getY()===e.rows-1)&&!t.getBaseElem().has("Impassable"))}getCellWithElem(e){return this.getElements().filter(t=>t.getType()===e)[0]}updateLevelFromMap(){this.getMap().getCells().forEach(e=>{if(e.hasProps()){e.getProps().forEach(t=>{const s=t.getPropType();this._p[s].push(t),t.setXY&&(t.setXY(e.getX(),e.getY()),t.setLevel(this))})}})}toJSON(){const e={isJSON:!0,id:this.getID(),levelNumber:this.getLevelNumber(),actors:[],items:[],elements:[],map:this.getMap().toJSON(),cbState:this._cbState};this._parent&&(e.parent=this._parent.getName(),"string"!=typeof e.parent&&i.default.err("Map.Level","toJSON","Parent name not a string")),e.components=u.compsToJSON(this);return[_,v,b].forEach(t=>{this._p[t].forEach(s=>{const n={x:s.getX(),y:s.getY(),obj:s.toJSON()};t!==i.default.TYPE_ACTOR?e[t].push(n):n.obj.isPlayer||e[t].push(n)})}),e}verifyLevelCache(){f.verifyLevelCache(this)}}t.Level=S},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.EventPool=void 0;const r=n(s(0));class a{constructor(){this.reset()}static getPool(){return a.poolInstance||(a.poolInstance=new a),a.poolInstance}getNumListeners(){return this._nListeners}getNumEventsListened(){return Object.keys(this._listeners).length}emitEvent(e,t){if(r.default.isNullOrUndef([e]))r.default.nullOrUndefError("EventPool: emitEvent","Event name must be given.",e);else if(++this.notifyStackSize,this._listeners.hasOwnProperty(e)){this.cannotRemove=!0;const s=this._listeners[e];for(let n=0,r=s.length;n<r;n++)s[n].notify(e,t)}1===this.notifyStackSize&&(this.cannotRemove=!1,this.pendingRemoves.length>0&&(this.pendingRemoves.forEach(e=>{this.removeListener(e)}),this.pendingRemoves=[])),--this.notifyStackSize}listenEvent(e,t){if(r.default.isNullOrUndef([e]))r.default.err("EventPool","listenEvent","Event name not well defined.");else if(t.hasOwnProperty("notify")||t.hasNotify){if(this._listeners.hasOwnProperty(e)){-1===this._listeners[e].indexOf(t)&&this._listeners[e].push(t)}else this._listeners[e]=[],this._listeners[e].push(t);++this._nListeners,t.hasOwnProperty("listenerID")||(t.listenerID=this._listenerID++)}else{let s="evtName: "+e;s+="\nprototype: "+JSON.stringify(t),s+="\nCannot add object. Listener must implement notify()!",r.default.err("EventPool","listenEvent",s)}}isListener(e){let t=!1;return this.forEachEvent(e,e=>{t=!0}),t}forEachEvent(e,t){const s=e.listenerID;Object.keys(this._listeners).forEach(n=>{this._listeners[n].findIndex(e=>e.listenerID===s)>=0&&t(e,n)})}removeListener(e){if(e.hasOwnProperty("listenerID")){if(this.cannotRemove)return void this.pendingRemoves.push(e);let t=0;const s=e.listenerID;Object.keys(this._listeners).forEach(e=>{const n=this._listeners[e].findIndex(e=>e.listenerID===s);n>=0&&(this._listeners[e].splice(n,1),++t,--this._nListeners,0===this._listeners[e].length&&delete this._listeners[e])}),0===t&&r.default.warn("EventPool","removeListener",`ListenerID ${e.listenerID} not found`),delete e.listenerID}else{const t=JSON.stringify(e);r.default.err("EventPool","removeListener","No prop listener ID from on object "+t)}}removeAll(){if(this.cannotRemove)r.default.err("EventPool","removeAll","Cannot remove listeners. cannotRemove is set");else{const e={};Object.keys(this._listeners).forEach(t=>{this._listeners[t].forEach(t=>{e[t.listenerID]=t})}),Object.values(e).forEach(e=>{this.removeListener(e)})}}reset(){this._listeners={},this._nListeners=0,this._listenerID=0,this._lastEmitted=null,this._lastRemoved=null,this.pendingRemoves=[],this.notifyStackSize=0}getListeners(e){return this._listeners.hasOwnProperty(e)?this._listeners[e].slice():[]}printListeners(){Object.keys(this._listeners).forEach(e=>{r.default.diag("Listeners for event "+String(e)),r.default.diag(this._listeners[e])})}}t.EventPool=a,a.id=0},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Lore=t.Place=t.DrainStat=t.Entrapped=t.Entrapping=t.Snowy=t.Indoor=t.ZoneEvent=t.WorldSimEvent=t.WeatherEffect=t.Weather=t.Duration=t.Expiration=t.Fading=t.GameInfo=t.Callbacks=t.UseStairs=t.UseItem=t.UseElement=t.Rest=t.Read=t.Pickup=t.OpenDoor=t.Jump=t.Give=t.Farming=t.Crafting=t.Mining=t.PlantedSoil=t.TilledSoil=t.Tillable=t.Unpickable=t.DontRender=t.addToExpirationComp=t.Animation=t.Telepathy=t.RegenEffect=t.AddOnEquip=t.Equip=t.AddOnHit=t.Player=t.PlayerControlled=t.Effects=t.Event=t.Reputation=t.Commander=t.BattleOrder=t.BattleBadge=t.BattleOver=t.BattleExp=t.InBattle=t.BattleEvent=t.Groups=t.UseEffects=t.Transaction=t.Shopkeeper=t.SkillsExp=t.Skills=t.SpiritItemCrafter=t.GemBound=t.SpiritBind=t.NourishedOne=t.SpellStop=t.SpellSelf=t.SpellArea=t.SpellCell=t.SpellMissile=t.SpellRay=t.SpellCast=t.PowerDrain=t.SpellPower=t.Deflection=t.DoubleShot=t.CriticalShot=t.RangedEvasion=t.LongRangeShot=t.MixedShot=t.ThroughShot=t.StrongShot=t.EagleEye=t.Amphibious=t.SnowWalk=t.Camouflage=t.Jumper=t.Climber=t.Charm=t.BypassProtection=t.MasterEquipper=t.FirstStrike=t.LongReach=t.Ambidexterity=t.CounterAttack=t.BiDirStrike=t.Attacker=t.Defender=t.ActorClass=t.NonSentient=t.Magical=t.Resistance=t.Weakness=t.Flame=t.Possessed=t.Sharpened=t.Sharpener=t.Summoned=t.Undead=t.Flying=t.Ammo=t.Indestructible=t.Breakable=t.Drowning=t.Unpaid=t.Stolen=t.Owned=t.BodyTemp=t.Heat=t.Coldness=t.Drenched=t.Poison=t.Named=t.Created=t.Paralysis=t.Stun=t.Ethereal=t.Physical=t.OneShot=t.Damaging=t.Communication=t.Loot=t.Missile=t.Chat=t.Movement=t.AttackRanged=t.Attack=t.Perception=t.StatsMods=t.Stats=t.CombatMods=t.Combat=t.ExpPoints=t.Experience=t.Terrain=t.Opaque=t.Impassable=t.Broken=t.Damaged=t.DirectDamage=t.Damage=t.Corporeal=t.DeathEvent=t.Dead=t.Health=t.Hunger=t.Item=t.Typed=t.Location=t.Action=t.ImpossibleCmd=void 0;const i=o(s(0)),l=a(s(97)),c=s(16),u=s(12),h=s(17),d=s(4),f=u.EventPool.getPool(),g=c.Component.DataComponent,p=c.Component.UniqueDataComponent,m=c.Component.UniqueTransientDataComponent,y=c.Component.TransientDataComponent,_=c.Component.TransientTagComponent,b=c.Component.TagComponent,v=c.Component.UniqueTagComponent,E=c.ComponentBase.prototype,S=Object.freeze("");t.ImpossibleCmd=v("ImpossibleCmd"),t.Action=m("Action",{energy:0,active:!1,msg:"",status:0}),t.Action.prototype.addEnergy=function(e){this.energy+=e},t.Action.prototype.resetEnergy=function(){this.energy=0},t.Action.prototype.enable=function(){!1===this.active&&(f.emitEvent(i.default.EVT_ACT_COMP_ENABLED,{actor:this.getEntity()}),this.active=!0)},t.Action.prototype.disable=function(){!0===this.active&&(f.emitEvent(i.default.EVT_ACT_COMP_DISABLED,{actor:this.getEntity()}),this.active=!1)},t.Action.prototype.statusOk=function(){return this.getStatus()!==i.default.ACTION_FAILED},t.Location=p("Location",{x:-1,y:-1,level:null}),t.Location.prototype.getXY=function(){return[this.x,this.y]},t.Location.prototype.setXY=function(e,t){this.x=e,this.y=t},t.Location.prototype.isValid=function(){return this.level,this.x>=0&&this.y>=0},t.Location.prototype.unsetLevel=function(){this.level?this.level=null:i.default.err("Location","unsetLevel","Trying to unset already null level.")},t.Location.prototype.isLocated=function(){return this.x>=0&&this.y>=0&&null!==this.level},t.Location.prototype.getCell=function(){return this.level?this.level.getMap().getCell(this.x,this.y):null},t.Location.prototype.toJSON=function(){const e={setType:this.getType(),setID:this.getID(),setX:this.x,setY:this.y};return this.level&&(e.setLevel=i.default.getObjRef("entity",this.level)),e},t.Typed=p("Typed",{objType:S,propType:S}),t.Typed.prototype._init=function(e,t){this.objType=e,this.propType=t},t.Item=p("Item",{value:1,damageType:i.default.DMG.BLUNT,count:1}),t.Item.prototype.incrCount=function(e){this.count+=e},t.Item.prototype.decrCount=function(e){this.count-=e},t.Hunger=p("Hunger",{energy:2e4,maxEnergy:2e4,minEnergy:-5e3}),t.Hunger.prototype.addEnergy=function(e){this.energy+=e,this.energy>this.maxEnergy&&(this.energy=this.maxEnergy)},t.Hunger.prototype.decrEnergy=function(e){this.energy-=e,this.energy<this.minEnergy&&(this.energy=this.minEnergy)},t.Hunger.prototype.isStarving=function(){return this.energy<=0},t.Hunger.prototype.isFull=function(){return this.energy===this.maxEnergy},t.Health=p("Health",{HP:10,maxHP:10}),t.Health.prototype.addHP=function(e){this.HP+=e,this.HP>this.maxHP&&(this.HP=this.maxHP)},t.Health.prototype.propLeft=function(){return this.HP/this.maxHP},t.Health.prototype.decrHP=function(e){this.HP-=e},t.Health.prototype.isAlive=function(){return this.HP>0},t.Health.prototype.isDead=function(){return this.HP<=0},t.Health.prototype.hpLost=function(){return this.maxHP-this.HP},t.Health.prototype._init=function(e){this.HP=e,this.maxHP=e},t.Dead=v("Dead"),t.DeathEvent=m("DeathEvent",{msg:"",source:null}),t.Corporeal=v("Corporeal"),t.Damage=y("Damage",{damage:0,weapon:null,damageType:"",damageCateg:"",source:null,sourceActor:null}),t.Damage.prototype._init=function(e,t){this.damage=e,this.damageType=t},t.Damage.prototype.isType=function(e){return this.damageType===e},t.DirectDamage=g("DirectDamage",{damage:0,damageType:"",damageCateg:"",prob:1,source:null,msg:""}),t.DirectDamage.prototype.rollDamage=function(){return this.damage.roll()},t.DirectDamage.prototype.setDamage=function(e){this.damage="number"==typeof e?new h.Dice(0,0,e):"object"==typeof e?e.clone():h.Dice.create(e)},t.DirectDamage.prototype.toJSON=function(){const e=c.ComponentBase.prototype.toJSON.call(this);return this.source?e.setSource=i.default.getObjRef("entity",this.source):delete e.setSource,e.setDamage=this.damage.toString(),e},t.Damaged=p("Damaged",{damageLevel:0}),t.Broken=v("Broken"),t.Impassable=p("Impassable",{canFlyOver:!0,canJumpOver:!0,spellPasses:!0}),t.Impassable.prototype.setAllImpassable=function(){this.canFlyOver=!1,this.spellPasses=!1,this.canJumpOver=!1},t.Opaque=v("Opaque"),t.Terrain=p("Terrain",{mods:null}),t.Terrain.prototype._init=function(){this.mods=[]},t.Experience=p("Experience",{exp:0,expLevel:1,danger:1,numKilled:0}),t.Experience.prototype.incrNumKilled=function(){this.numKilled+=1},t.ExpPoints=y("ExpPoints",{expPoints:null,skillPoints:null}),t.ExpPoints.prototype._init=function(e){this.expPoints=e,this.skills={}},t.ExpPoints.prototype.addSkillPoints=function(e,t){this.skills[e]=t},t.ExpPoints.prototype.addExpPoints=function(e){this.expPoints+=e},t.Combat=p("Combat",{attack:1,defense:1,protection:0,attackRange:1,damageDie:null,numHits:1}),t.Combat.prototype._init=function(){this.damageDie=h.Dice.create("1d4")},t.Combat.prototype.rollDamage=function(){return this.damageDie.roll()},t.Combat.prototype.setDamageDie=function(e){this.damageDie="string"==typeof e?h.Dice.create(e):e},t.Combat.prototype.copy=function(e){E.copy.call(this,e),this.damageDie=e.getDamageDie().clone()},t.Combat.prototype.toJSON=function(){const e=E.toJSON.call(this);return e.setDamageDie=this.damageDie.toString(),e},t.CombatMods=g("CombatMods",{attack:0,defense:0,protection:0,attackRange:0,damage:0,tag:""}),t.Stats=p("Stats",i.default.STATS_DEFAULTS),t.Stats.prototype.clearValues=function(){i.default.SET_STATS.forEach(e=>{this[e](0)})},t.Stats.prototype.incrStat=function(e,t){const s="set"+e.capitalize(),n=this["get"+e.capitalize()]();this[s](n+t)},t.Stats.prototype.toString=function(){let e="";return i.default.GET_STATS.forEach((t,s)=>{const n=this[t]();0!==n&&(e+=i.default.STATS_ABBR[s]+": "+n)}),e},t.Stats.prototype.equals=function(e){let t=this.getType()===e.getType();return i.default.GET_STATS.forEach(s=>{t=t&&this[s]()===e[s]()}),t};const w=i.default.createStatsObj(0);t.StatsMods=g("StatsMods",Object.assign({tag:""},w)),t.Perception=p("Perception",{FOVRange:i.default.NPC_FOV_RANGE}),t.Attack=y("Attack",{target:null}),t.AttackRanged=y("AttackRanged",{target:null,attacker:null}),t.Movement=y("Movement",{x:0,y:0,level:null}),t.Movement.prototype.setXY=function(e,t){this.x=e,this.y=t},t.Movement.prototype.getXY=function(){return[this.x,this.y]},t.Movement.prototype._init=function(e,t,s){this.x=e,this.y=t,this.level=s},t.Chat=y("Chat",{args:null}),t.Missile=y("Missile",{x:null,y:null,z:null,source:null,level:null,flying:!0,targetX:null,targetY:null,range:0,attack:0,damage:0,path:null}),t.Missile.prototype._init=function(e){this.source=e,this.x=e.getX(),this.y=e.getY(),this.z=e.getZ(),this.level=e.getLevel(),this.path=[],this.pathIter=-1},t.Missile.prototype.hasRange=function(){return this.range>0},t.Missile.prototype.isFlying=function(){return this.flying},t.Missile.prototype.stopMissile=function(){this.flying=!1},t.Missile.prototype.setTargetXYZ=function(e,t,s){const n=[this.x,this.y,this.z],r=[e,t,s];i.default.isNullOrUndef([s])&&i.default.err("Component.Missile","setTargetXYZ","z is undefined"),this.path=d.Geometry.getBresenham3D(n,r),this.targetX=e,this.targetY=t,this.targetZ=s,this.path.length>0&&(this.pathIter=0)},t.Missile.prototype.inTarget=function(){return this.x===this.targetX&&this.y===this.targetY&&this.z===this.targetZ},t.Missile.prototype.iteratorValid=function(){return this.pathIter>=0&&this.pathIter<this.path.length},t.Missile.prototype.setValuesFromIterator=function(){const e=this.path[this.pathIter];this.x=e[0],this.y=e[1],this.z=e[2]},t.Missile.prototype.first=function(){return this.pathIter=0,this.setValuesFromIterator(),[this.x,this.y,this.z]},t.Missile.prototype.next=function(){return this.iteratorValid()?(--this.range,++this.pathIter,this.setValuesFromIterator(),!0):null},t.Missile.prototype.prev=function(){return this.iteratorValid()?(++this.range,--this.pathIter,this.setValuesFromIterator(),!0):null},t.Loot=function(e){c.ComponentBase.call(this,"Loot"),this._lootEntity=e},i.default.extend2(t.Loot,c.ComponentBase),c.Component.Loot=t.Loot,t.Loot.prototype.dropLoot=function(e){const t=this.getEntity().getLevel();if(this._lootEntity.getPropType){const s=this._lootEntity.getPropType();"elements"===s?this.setElemToCell(e):s===i.default.TYPE_ITEM?t.addItem(this._lootEntity,e.getX(),e.getY()):i.default.err("Component.Loot","dropLoot","Unsupported propType for entity: "+s)}else i.default.err("Loot","dropLoot","Loot has no propType!")},t.Loot.prototype.setElemToCell=function(e){const t=this.getEntity().getLevel();this._lootEntity.hasOwnProperty("useStairs")&&(i.default.debug(this,"Added stairs to "+e.getX()+", "+e.getY()),t.addStairs(this._lootEntity,e.getX(),e.getY()))},t.Loot.prototype.setLootEntity=function(e){this._lootEntity=e},t.Loot.prototype.toJSON=function(){const e=c.ComponentBase.prototype.toJSON.call(this),t=this._lootEntity.toJSON();return this._lootEntity.getPropType()===i.default.TYPE_ITEM?e.setLootEntity={createFunc:"createItem",value:t}:this._lootEntity.getPropType()===i.default.TYPE_ACTOR?e.setLootEntity={createFunc:"createActor",value:t}:i.default.err("Loot","toJSON","Only items/actors loot types are supported"),e},t.Communication=y("Communication",{msg:null}),t.Communication.prototype._init=function(){this.msg=[]},t.Communication.prototype.addMsg=function(e){this.msg.push(e)},t.Damaging=g("Damaging",{damage:1,damageType:""}),t.OneShot=v("OneShot"),t.OneShot.description="Destroyed automatically after one use",t.Physical=p("Physical",{weight:1,size:1}),t.Ethereal=b("Ethereal",{description:"Ethereal beings cannot interact physically with others"}),t.Stun=g("Stun",{source:null}),t.Stun.prototype.toJSON=function(){const e=c.ComponentBase.prototype.toJSON.call(this);return i.default.isActorActive(this.source)?e.setSource=i.default.getObjRef("entity",this.source):delete e.setSource,e},t.Stun.description="Stunning prevents some actions to be done",t.Paralysis=g("Paralysis",{source:null}),t.Paralysis.description="Paralysed actors cannot perform any actions",t.Paralysis.prototype.toJSON=function(){const e=c.ComponentBase.prototype.toJSON.call(this);return i.default.isActorActive(this.source)?e.setSource=i.default.getObjRef("entity",this.source):delete e.setSource,e},t.Created=p("Created",{creator:null}),t.Created.prototype.toJSON=function(){const e=c.ComponentBase.prototype.toJSON.call(this);return e.setCreator=i.default.getObjRef("entity",this.creator),e},t.Named=p("Named",{name:"",uniqueName:""}),t.Named.prototype.prepend=function(e){this.name=e+this.name},t.Named.prototype.getBaseName=function(){return this.name},t.Named.prototype.getFullName=function(){return""!==this.uniqueName?`${this.uniqueName}, ${this.name}`:this.name};class C extends(l.DurationRoll(l.DamageRoll(c.ComponentBase))){constructor(){super("Poison"),this._src=null,this._prob=.05}getProb(){return this._prob}setProb(e){this._prob=e}getSource(){return this._src}setSource(e){this._src=e}copy(e){super.copy(e),this._prob=e.getProb(),this._src=e.getSource()}toJSON(){const e=super.toJSON();return e.setType=this.getType(),e.setProb=this._prob,i.default.isActorActive(this._src)&&(e.setSource=i.default.getObjRef("entity",this._src)),e}}t.Poison=C,C.description="Poison causes damage periodically until it stop",c.Component.Poison=C,t.Drenched=p("Drenched",{level:0},{description:"Indicates the soakness of entity"}),t.Drenched.prototype.incrLevel=function(e=1){this.level+=e,this.level>i.default.MAX_DRENCHED&&(this.level=i.default.MAX_DRENCHED)},t.Drenched.prototype.decrLevel=function(e=1){this.level-=e,this.level<0&&(this.level=0)},t.Drenched.prototype.isDry=function(){return 0===this.level},t.Coldness=b("Coldness",{description:"Coldness will gradually freeze a non-resistant beings"}),t.Heat=g("Heat",{level:1}),t.BodyTemp=p("BodyTemp",{temp:100,maxTemp:100,minTemp:-100}),t.BodyTemp.prototype.incr=function(e=1){this.temp<this.maxTemp&&(this.temp+=e)},t.BodyTemp.prototype.decr=function(e=1){this.temp>this.minTemp&&(this.temp-=e)},t.BodyTemp.prototype.isFreezing=function(){return this.temp<=0},t.BodyTemp.prototype.isFrozen=function(){return this.temp===this.minTemp},t.Owned=p("Owned",{owner:null}),t.Stolen=b("Stolen"),t.Unpaid=b("Unpaid"),t.Drowning=v("Drowning"),t.Breakable=v("Breakable"),t.Indestructible=v("Indestructible"),t.Ammo=b("Ammo"),t.Flying=b("Flying",{description:"Flying beings can avoid difficult terrain and obstacles"}),t.Undead=b("Undead"),t.Summoned=b("Summoned"),t.Sharpener=b("Sharpener",{description:"You can sharpen weapons (once per weapoon"}),t.Sharpened=b("Sharpened"),t.Possessed=b("Possessed"),t.Flame=y("Flame",{damageType:"",damage:1,source:null}),t.Weakness=g("Weakness",{effect:"",level:i.default.WEAKNESS.MINOR},{description:"Weakness increases damage from attacks of that type"}),t.Resistance=g("Resistance",{effect:"",level:i.default.RESISTANCE.MINOR},{description:"Resistance reduces damage from attacks of that type"}),t.Magical=v("Magical"),t.NonSentient=v("NonSentient"),t.ActorClass=function(){c.ComponentBase.call(this,"ActorClass"),this._class=null,this._className=null,this.setClassName=e=>{this._className=e},this.getClassName=()=>this._className,this.getClass=()=>this._class,this.setActorClass=e=>{this._class=e}},i.default.extend2(t.ActorClass,c.ComponentBase),c.Component.ActorClass=t.ActorClass,t.ActorClass.prototype.toJSON=function(){const e=E.toJSON.call(this);return e.setActorClass={createFunc:"createActorClass",value:{className:this._className,actorRef:i.default.getObjRef("entity",this.getEntity())}},e},t.Defender=v("Defender",{description:"Grants a minor defense (Def) bonus"}),t.Attacker=v("Attacker",{description:"Grants a minor attack (Att) bonus"}),t.BiDirStrike=v("BiDirStrike",{description:"You can attack to 2 opposite directions"}),t.CounterAttack=v("CounterAttack",{desciption:"You perform a counterattack when attacked by enemies"}),t.Ambidexterity=v("Ambidexterity"),t.LongReach=v("LongReach"),t.FirstStrike=v("FirstStrike",{description:"You can hit enemies first before they attack you"}),t.MasterEquipper=g("MasterEquipper",{factor:.5}),t.BypassProtection=g("BypassProtection",{chance:0}),t.Charm=g("Charm",{level:1,targetActor:i.default.NO_TARGET}),t.Climber=v("Climber"),t.Jumper=p("Jumper",{jumpRange:2}),t.Camouflage=v("Camouflage"),t.SnowWalk=v("SnowWalk"),t.Amphibious=v("Amphibious"),t.EagleEye=b("EagleEye",{description:"Grants bonus to missile range and visibility"}),t.StrongShot=b("StrongShot",{description:"Strength (Str) adds extra damage to missile attacks"}),t.ThroughShot=b("ThroughShot",{description:"You can shoot through enemies to hit another target"}),t.MixedShot=b("MixedShot",{description:"Allows mixing of ammo from different type of weapons"}),t.LongRangeShot=b("LongRangeShot",{description:"Doubles missile attack range"}),t.RangedEvasion=b("RangedEvasion",{description:"Grants 50% chance to evade missile/ranged spell attacks"}),t.CriticalShot=b("CriticalShot"),t.DoubleShot=b("DoubleShot"),t.Deflection=b("Deflection",{description:"Grants ability to deflect missile attacks"}),t.SpellPower=p("SpellPower",{PP:10,maxPP:10}),t.SpellPower.prototype.addPP=function(e){this.PP+=e,this.PP>this.maxPP&&(this.PP=this.maxPP)},t.SpellPower.prototype.decrPP=function(e){this.PP-=e},t.SpellPower.prototype.propLeft=function(){return this.PP/this.maxPP},t.SpellPower.prototype.hasPower=function(){return this.PP>0},t.SpellPower.prototype.canCast=function(e){return this.PP>=e},t.PowerDrain=g("PowerDrain",{drainDist:5}),t.PowerDrain.description="Counters any spell cast near you, gives you power and then disappears";const T={spell:null,source:null,args:null};t.SpellCast=y("SpellCast",T),t.SpellRay=y("SpellRay",T),t.SpellMissile=y("SpellMissile",T),t.SpellCell=y("SpellCell",T),t.SpellArea=y("SpellArea",T),t.SpellSelf=y("SpellSelf",T),t.SpellStop=v("SpellStop"),t.NourishedOne=v("NourishedOne",{description:"You gain triple amount of energy from food"}),t.SpiritBind=y("SpiritBind",{binder:null,target:null}),t.GemBound=p("GemBound",{gem:null}),t.GemBound.prototype.toJSON=function(){return{setID:this.getID(),setType:"GemBound",setGem:{createFunc:"createItem",value:this.getGem().toJSON()}}},t.SpiritItemCrafter=v("SpiritItemCrafter",{description:"Grants ability to bind gems to items such as weapons/armour"}),t.Skills=p("Skills",{skills:null}),t.Skills.prototype._init=function(){this.skills={}},t.Skills.prototype.hasSkill=function(e){return this.skills.hasOwnProperty(e)},t.Skills.prototype.addSkill=function(e){this.skills[e]={name:e,level:1,points:0}},t.Skills.prototype.getLevel=function(e){return this.hasSkill(e)?this.skills[e].level:0},t.Skills.prototype.setLevel=function(e,t){this.skills[e].level=t},t.Skills.prototype.getPoints=function(e){return this.skills[e].points},t.Skills.prototype.resetPoints=function(e){this.skills[e].points=0},t.Skills.prototype.addPoints=function(e,t){this.hasSkill(e)&&(this.skills[e].points+=t)},t.Skills.prototype.toJSON=function(){return{setID:this.getID(),setType:this.getType(),setSkills:this.skills}},t.SkillsExp=y("SkillsExp",{skill:"",points:0}),t.Shopkeeper=p("Shopkeeper",{levelID:-1,cells:null,doorXY:null}),t.Shopkeeper._init=function(){this.cells=[]},t.Transaction=y("Transaction",{args:null}),t.UseEffects=p("UseEffects",{effects:null}),t.UseEffects.prototype._init=function(){this.effects=[]},t.UseEffects.prototype.addEffect=function(e){this.effects.push(e)},t.UseEffects.prototype.hasEffect=function(e){return this.effects.findIndex(t=>t.hasOwnProperty(e))>=0},t.Groups=p("Groups",{groups:null}),t.Groups.prototype._init=function(){this.groups=[]},t.Groups.prototype.addGroup=function(e){this.groups.indexOf(e)<0&&this.groups.push(e)},t.Groups.prototype.hasGroupId=function(e){for(let t=0;t<e.length;t++)if(this.groups.indexOf(e[t])>=0)return!0;return!1},t.BattleEvent=y("BattleEvent",{battle:null,eventType:""}),t.InBattle=p("InBattle",{data:null}),t.InBattle.prototype._init=function(){this.data={}},t.InBattle.prototype.updateData=function(e){Object.keys(e).forEach(t=>{this.data[t]=e[t]})},t.BattleExp=g("BattleExp",{data:null}),t.BattleExp.prototype._init=function(){this.data={}},t.BattleExp.prototype.updateData=function(e){Object.keys(e).forEach(t=>{this.data[t]=e[t]})},t.BattleOver=v("BattleOver"),t.BattleBadge=g("BattleBadge",{data:null}),t.BattleBadge.prototype._init=function(){this.data={}},t.BattleBadge.prototype.updateData=function(e){Object.keys(e).forEach(t=>{this.data[t]=e[t]})},t.BattleBadge.prototype.isWon=function(){return"Won"===this.data.status},t.BattleBadge.prototype.isLost=function(){return"Lost"===this.data.status},t.BattleBadge.prototype.isTraitor=function(){return"Traitor"===this.data.status},t.BattleBadge.prototype.isTied=function(){return"Tied"===this.data.status},t.BattleBadge.prototype.isEscaped=function(){return"Fled"===this.data.status},t.BattleOrder=g("BattleOrder",{args:null}),t.Commander=b("Commander"),t.Reputation=p("Reputation",{data:null}),t.Reputation.prototype._init=function(){this.data={fame:0,numFriendsAttacked:0}},t.Reputation.prototype.updateData=function(e){this.data=Object.assign(this.data,e)},t.Reputation.prototype.addToFame=function(e){this.data.fame+=e},t.Event=y("Event",{args:null}),t.Event.prototype._init=function(e){this.args=e},t.Effects=y("Effects",{args:null,effectType:""}),t.Effects.prototype._init=function(e){this.args=e||{}},t.PlayerControlled=v("PlayerControlled"),t.Player=v("Player"),t.AddOnHit=g("AddOnHit",{comp:null,onDamage:!0,onAttackHit:!1}),t.AddOnHit.prototype.getCompToAdd=function(){return this.comp.toJSON?this.comp:c.Component.createFromObj(this.comp.transientComp,this.comp.func)},t.AddOnHit.prototype.toJSON=function(){const e={setID:this.getID(),setType:this.getType(),setComp:this.comp,setOnDamage:this.onDamage,setOnAttackHit:this.onAttackHit};return this.comp.toJSON&&(e.setComp={createComp:this.comp.toJSON()}),e},t.Equip=y("Equip",{args:null,item:null,isRemove:!1}),t.AddOnEquip=g("AddOnEquip",{comp:null,addedToActor:!1}),t.AddOnEquip.prototype.toJSON=function(){const e={setID:this.getID(),setType:this.getType(),setAddedToActor:this.addedToActor};if(this.addedToActor)e.setComp={createComp:this.comp};else{const t=this.comp.toJSON();e.setComp={createComp:t}}return e},t.RegenEffect=g("RegenEffect",{PP:1,HP:1,waitPP:30,waitHP:30,maxWaitPP:60,maxWaitHP:60}),t.Telepathy=g("Telepathy",{target:null,source:null},{description:"Grants ability to see through eyes of another being"}),t.Telepathy.prototype.toJSON=function(){const e={setID:this.getID(),setType:this.getType()};return i.default.isActorActive(this.target)&&(e.setTarget=i.default.getObjRef("entity",this.target)),i.default.isActorActive(this.source)&&(e.setSource=i.default.getObjRef("entity",this.source)),e},t.Animation=y("Animation",{args:null}),t.Animation.prototype._init=function(e){this.args=e},t.addToExpirationComp=(e,s,n,r)=>{if(e.has("Expiration"))e.get("Expiration").addEffect(s,n,r);else{const a=new t.Expiration;a.addEffect(s,n,r),e.add(a)}e.has(s)||e.add(s)},t.DontRender=v("DontRender"),t.Unpickable=v("Unpickable"),t.Tillable=v("Tillable"),t.TilledSoil=v("TilledSoil"),t.PlantedSoil=p("PlantedSoil",{growsInto:"",timeLeftToGrow:1}),t.Mining=y("Mining",{target:null}),t.Crafting=y("Crafting",{args:null,item:"",count:1}),t.Farming=y("Farming",{action:"",args:null}),t.Give=y("Give",{giveTarget:null,item:null}),t.Jump=y("Jump",{x:-1,y:-1}),t.OpenDoor=y("OpenDoor",{door:null}),t.Pickup=_("Pickup"),t.Read=y("Read",{readTarget:null}),t.Rest=_("Rest"),t.UseElement=y("UseElement",{element:null,useType:""}),t.UseItem=y("UseItem",{item:null,useType:"",target:null,targetType:null,effect:null}),t.UseStairs=_("UseStairs"),t.Callbacks=g("Callbacks",{cbs:null}),t.Callbacks.prototype._init=function(){this.cbs={}},t.Callbacks.prototype.addCb=function(e,t){"function"==typeof t&&i.default.err("Component.Callbacks","addCb","Callback must be object, not func."),this.cbs[e]=t},t.Callbacks.prototype.hasCb=function(e){return this.cbs.hasOwnProperty(e)},t.Callbacks.prototype.cb=function(e){return this.cbs[e]},t.GameInfo=p("GameInfo",{data:null}),t.GameInfo.prototype._init=function(){this.data={zones:{}}},t.GameInfo.prototype.updateData=function(e){const t=this.data;this.data=Object.assign(t,e)},t.GameInfo.prototype.addZone=function(e){this.data.zones[e]=!0},t.GameInfo.prototype.hasZone=function(e){return this.data.zones[e]},t.GameInfo.prototype.addZoneType=function(e){const t=this.data;t.zones.hasOwnProperty(e)?t.zones[e]+=1:t.zones[e]=1,this.data=t},t.Fading=g("Fading",{duration:0}),t.Fading.prototype.decrDuration=function(){this.duration-=1},t.Expiration=g("Expiration",{duration:null,expireMsg:null}),t.Expiration.prototype._init=function(){this.expireMsg={}},t.Expiration.prototype.addEffect=function(e,t,s){this.duration||(this.duration={});const n=e.getID();this.duration.hasOwnProperty(n)?this.duration[n]+=t:(this.duration[n]=t,e.addCallback("onRemove",()=>{this.removeEffect(e)})),s&&(this.expireMsg||(this.expireMsg={}),this.expireMsg[n]=s)},t.Expiration.prototype.decrDuration=function(){for(const e in this.duration)if(this.duration[e]){const t=parseInt(e,10);if(t>=0&&(this.duration[t]-=1,0===this.duration[t])){const e=this.getEntity();if(this.expireMsg&&this.expireMsg[t]){const s=this.expireMsg[t];i.default.gameMsg({cell:e.getCell(),msg:s})}else{const t="An effect wears of from "+e.getName();i.default.gameMsg({cell:e.getCell(),msg:t})}e.remove(t),delete this.duration[t]}}},t.Expiration.prototype.hasEffects=function(){return Object.keys(this.duration).length>0},t.Expiration.prototype.hasEffect=function(e){const t=e.getID();return this.duration.hasOwnProperty(t)},t.Expiration.prototype.removeEffect=function(e){const t=e.getID();this.duration.hasOwnProperty(t)&&delete this.duration[t],this.expireMsg&&this.expireMsg.hasOwnProperty(t)&&delete this.expireMsg[t]},t.Expiration.prototype.cleanup=function(){const e=this.getEntity();Object.keys(this.duration).forEach(t=>{e.remove(parseInt(t,10))})};class O extends(l.DurationRoll(c.ComponentBase)){constructor(){super("Duration"),this._comp=null,this._source=null,this._addedOnActor=!1,this._expireMsg=""}setSource(e){this._source=e}setExpireMsg(e){this._expireMsg=e}getExpireMsg(){return this._expireMsg}getSource(){return this._source}setComp(e){if(this._comp=e,!this._addedOnActor){const e=()=>{this.getEntity().add(this._comp),this._comp.setSource&&this._source&&this._comp.setSource(this._source),this._comp=this._comp.getID(),this._addedOnActor=!0,this.removeCallbacks("onAdd")};this.addCallback("onAdd",e)}this.addCallback("onRemove",()=>{this.getEntity().has(this._comp)&&this.getEntity().remove(this._comp)})}getComp(){return this._comp}copy(e){super.copy(e);const t=e.getComp().clone();this.setComp(t)}clone(){const e=super.clone();return e.copy(this),e}setAddedOnActor(e){this._addedOnActor=e}getAddedOnActor(){return this._addedOnActor}toJSON(){const e=super.toJSON();if(i.default.isActorActive(this._source)&&(e.setSource=i.default.getObjRef("entity",this._source)),this._addedOnActor)return Object.assign(e,{setAddedOnActor:!0,setComp:this._comp});{const t=this._comp.toJSON();return Object.assign(e,{setComp:{createComp:t}})}}}t.Duration=O,c.Component.Duration=O,t.Weather=g("Weather",{weatherType:"clear",temperature:0,visibility:0}),t.WeatherEffect=y("WeatherEffect",{effectType:"clear",temperature:0}),t.WorldSimEvent=y("WorldSimEvent",{eventType:"",eventData:null}),t.ZoneEvent=y("ZoneEvent",{eventType:"",eventData:null}),t.Indoor=v("Indoor"),t.Snowy=v("Snowy"),t.Entrapping=p("Entrapping",{difficulty:1,destroyOnMove:!1}),t.Entrapped=v("Entrapped"),t.DrainStat=y("DrainStat",{drainAmount:1,sourceComp:"",sourceGetter:"",sourceSetter:"",targetComp:"",targetGetter:"",targetSetter:"",source:null,drainMsg:""}),t.DrainStat.prototype.applyComp=function(){const e=this.getEntity().get(this.sourceComp);if(e){const t=e[this.sourceGetter]();e[this.sourceSetter](t-this.drainAmount);const s=this.source.get(this.targetComp);if(s){const e=s[this.targetGetter]();return s[this.targetSetter](e+this.drainAmount),!0}}return!1},t.Place=p("Place",{depth:0,danger:1});const A=s(259);Object.defineProperty(t,"Lore",{enumerable:!0,get:function(){return A.Lore}}),c.Component.Lore=A.Lore},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RNG=void 0;const n=2.3283064365386963e-10;class r{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(e){return e=e<1?1/e:e,this._seed=e,this._s0=(e>>>0)*n,e=69069*e+1>>>0,this._s1=e*n,e=69069*e+1>>>0,this._s2=e*n,this._c=1,this}getUniform(){const e=2091639*this._s0+this._c*n;return this._s0=this._s1,this._s1=this._s2,this._c=0|e,this._s2=e-this._c,this._s2}getUniformInt(e,t){const s=Math.max(e,t),n=Math.min(e,t);return Math.floor(this.getUniform()*(s-n+1))+n}getNormal(e=0,t=1){let s,n,r;do{s=2*this.getUniform()-1,n=2*this.getUniform()-1,r=s*s+n*n}while(r>1||0===r);return e+s*Math.sqrt(-2*Math.log(r)/r)*t}getPercentage(){return 1+Math.floor(100*this.getUniform())}getItem(e){return e.length?e[Math.floor(this.getUniform()*e.length)]:null}shuffle(e){const t=[],s=e.slice();for(;s.length;){const e=s.indexOf(this.getItem(s));t.push(s.splice(e,1)[0])}return t}getWeightedValue(e){let t=0;for(const s in e)t+=e[s];const s=this.getUniform()*t;let n="",r=0;for(n in e)if(r+=e[n],s<r)return n;return n}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(e){return this._s0=e[0],this._s1=e[1],this._s2=e[2],this._c=e[3],this}clone(){return(new r).setState(this.getState())}}t.RNG=r,t.default=(new r).setSeed(0)},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||n(t,e,s)},o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Brain=void 0,a(s(68),t),a(s(46),t);const i=s(46);Object.defineProperty(t,"Brain",{enumerable:!0,get:function(){return i.Brain}}),a(s(99),t),a(s(98),t);const l=s(100);a(s(100),t);const c=s(55);a(s(55),t);const u=o(s(149));a(s(149),t);const h=s(151);a(s(151),t),i.Brain.Animal=u.BrainAnimal,i.Brain.Commander=u.BrainCommander,i.Brain.Explorer=u.BrainExplorer,i.Brain.GoalOriented=u.BrainGoalOriented,i.Brain.SpellCaster=u.BrainSpellCaster,i.Brain.Spirit=u.BrainSpirit,i.Brain.Thief=u.BrainThief,i.Brain.Flame=u.BrainFlame,i.Brain.Cloud=u.BrainCloud,i.Brain.Virtual=c.BrainVirtual,i.Brain.Weather=l.BrainWeather,i.Brain.NeedDriven=h.BrainNeedDriven},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.undefineComponent=t.defineComponent=t.create=t.createFromObj=t.ComponentBase=t.setIDCount=t.getIDCount=t.compsToJSON=t.SharedComponent=t.UniqueTransientDataComponent=t.TransientDataComponent=t.TransientTagComponent=t.UniqueDataComponent=t.UniqueTagComponent=t.DataComponent=t.TagComponent=t.NO_SERIALISATION=t.Component=t.C=void 0;const r=n(s(0));t.C={ID:{},ID2TYPE:{}},t.Component={},t.Component.createdCompDecls={},t.NO_SERIALISATION=()=>null,t.Component.NO_SERIALISATION=t.NO_SERIALISATION;const a=new Set(["description","_isUnique","_isShared"]);let o=1;function i(e,t){a.forEach(s=>{t.hasOwnProperty(s)&&(e[s]=t[s])})}function l(e,s){t.Component.hasOwnProperty(e)?r.default.err("Component","addCompDecl",`Comp ${e} exists already!`):(t.Component[e]=s,t.C.ID[e]=o++,t.C.ID2TYPE[t.C.ID[e]]=e)}function c(e){t.Component.createdCompDecls[e]&&r.default.err("Component","Tag/DataComponent","Duplicate decl: "+e)}function u(e){return t.Component.idCount=e}t.TagComponent=function(e,s={}){c(e);const n=function(){t.ComponentBase.call(this,e),Object.keys(s).forEach(e=>{a.has(e)||(this[e]=s[e])})};return r.default.extend2(n,t.ComponentBase),t.Component.createdCompDecls[e]=n,i(n,s),l(e,n),n},t.Component.TagComponent=t.TagComponent,t.DataComponent=(e,s,n={})=>{if(c(e),"string"!=typeof e){const t=JSON.stringify(e);r.default.err("component.base.js","DataComponent: NO TYPE GIVEN","First arg must be string! Got: |"+t+"|")}("object"!=typeof s||Array.isArray(s))&&r.default.err("component.base.js","DataComponent: "+e,"Members must be given as key/value pairs.");const a=function(...r){t.ComponentBase.call(this,e),Object.keys(n).forEach(e=>{this[e]=n[e]}),Object.keys(s).forEach(e=>{r&&r[0]&&r[0].hasOwnProperty(e)?this[e]=r[0][e]:"object"==typeof s[e]?this[e]=JSON.parse(JSON.stringify(s[e])):this[e]=s[e]}),this._init&&"function"==typeof this._init&&this._init(...r)};return r.default.extend2(a,t.ComponentBase),Object.keys(s).forEach(s=>{t.ComponentBase.prototype.hasOwnProperty(s)&&r.default.err("component.js","DataComponent: "+e,s+" is reserved in Base");const n=r.default.formatSetterName(s);t.ComponentBase.prototype.hasOwnProperty(n)&&r.default.err("component.js","DataComponent: "+e,n+" is reserved in Base"),a.prototype[n]=function(e){this[s]=e};const o=r.default.formatGetterName(s);t.ComponentBase.prototype.hasOwnProperty(n)&&r.default.err("component.js","DataComponent: "+e,o+" is reserved in Base"),a.prototype[o]=function(){return this[s]}}),n.objRefs&&(a.prototype.objRefs=Object.freeze(n.objRefs)),a.prototype.members=Object.freeze(s),i(a,n),t.Component.createdCompDecls[e]=a,l(e,a),a},t.Component.DataComponent=t.DataComponent,t.UniqueTagComponent=(e,s={})=>t.TagComponent(e,Object.assign({_isUnique:!0},s)),t.Component.UniqueTagComponent=t.UniqueTagComponent,t.UniqueDataComponent=(e,s,n={})=>t.DataComponent(e,s,Object.assign({_isUnique:!0},n)),t.Component.UniqueDataComponent=t.UniqueDataComponent,t.TransientTagComponent=(e,s={})=>t.TagComponent(e,Object.assign({toJSON:t.NO_SERIALISATION},s)),t.Component.TransientTagComponent=t.TransientTagComponent,t.TransientDataComponent=(e,s,n={})=>t.DataComponent(e,s,Object.assign({toJSON:t.NO_SERIALISATION},n)),t.Component.TransientDataComponent=t.TransientDataComponent,t.UniqueTransientDataComponent=(e,s,n={})=>t.DataComponent(e,s,Object.assign({_isUnique:!0,toJSON:t.NO_SERIALISATION},n)),t.Component.UniqueTransientDataComponent=t.UniqueTransientDataComponent,t.SharedComponent=(e,s,n={})=>{const r=t.DataComponent(e,s,Object.assign({_isUnique:!0,toJSON:t.NO_SERIALISATION,_isShared:!0},n));return r.prototype.setEntity=()=>{},r.prototype.getEntity=()=>null,r},t.Component.SharedComponent=t.SharedComponent,t.compsToJSON=e=>{const t={},s=e.getComponents();return Object.keys(s).forEach(e=>{const n=s[e].toJSON();n&&(t[e]=n)}),t},t.Component.compsToJSON=t.compsToJSON,t.Component.idCount=0,t.getIDCount=function(){return t.Component.idCount},t.setIDCount=u,t.Component.setIDCount=u,t.ComponentBase=function(e){this._type=e,this._entity=null,this._id=t.Component.idCount++},t.Component.ComponentBase=t.ComponentBase,t.ComponentBase.prototype.getID=function(){return this._id},t.ComponentBase.prototype.setID=function(e){this._id=e},t.ComponentBase.prototype.getEntity=function(){return this._entity},t.ComponentBase.prototype.setEntity=function(e){null===this._entity&&null!==e?this._entity=e:null===e?this._entity=null:r.default.err("Base","setEntity","Entity already set.")},t.ComponentBase.prototype.changeEntity=function(e){r.default.isNullOrUndef([this._entity])?r.default.err("Base","changeEntity","No entity set. Use setEntity() instead of changeEntity()"):(this._entity.remove(this.getID()),e.add(this))},t.ComponentBase.prototype.isUnique=function(){return!!t.Component[this._type]._isUnique},t.ComponentBase.prototype.getType=function(){return this._type},t.ComponentBase.prototype.setType=function(e){this._type=e},t.ComponentBase.prototype.entityAddCallback=function(e){if(this.setEntity(e),this._onAddCallbacks)for(let e=0;e<this._onAddCallbacks.length;e++)this._onAddCallbacks[e]()},t.ComponentBase.prototype.entityRemoveCallback=function(){if(this._onRemoveCallbacks)for(let e=0;e<this._onRemoveCallbacks.length;e++)this._onRemoveCallbacks[e]();this.setEntity(null)},t.ComponentBase.prototype.addCallback=function(e,t){"onAdd"===e?(this._onAddCallbacks||(this._onAddCallbacks=[]),this._onAddCallbacks.push(t)):"onRemove"===e?(this._onRemoveCallbacks||(this._onRemoveCallbacks=[]),this._onRemoveCallbacks.push(t)):r.default.err("Base","addCallback","CB name "+e+" must be onAdd/onRemove")},t.ComponentBase.prototype.removeCallbacks=function(e){"onAdd"===e?this._onAddCallbacks=[]:("onRemove"===e||(this._onAddCallbacks=[]),this._onRemoveCallbacks=[])},t.ComponentBase.prototype.clone=function(){const e=this.getType();if(t.Component.hasOwnProperty(e)){const s=new t.Component[e];return s.copy(this),s}return r.default.err("Base","clone",`No type |${e}| in Component.`),null},t.ComponentBase.prototype.copy=function(e){for(const t in this)if(/^get/.test(t)){const s=t;if("getEntity"!==s&&"getID"!==s){const t=s.replace("get","set");if("function"==typeof e[s]&&"function"==typeof this[t]){const n=e[s]();this[t](n)}}}},t.ComponentBase.prototype.equals=function(e){return this.getType()===e.getType()},t.ComponentBase.prototype.is=function(e){return t.Component[e]||r.default.err("ComponentBase","is","Unknown type: "+e),this._type===e},t.ComponentBase.prototype.toString=function(){return"Component: "+this.getType()};const h=/^get/,d={};t.ComponentBase.prototype.toJSON=function(){const e={},t=this.getType();if(d[t])d[t].forEach(t=>{const s=t[0],n=t[1];e[n]=this[s]()});else{d[t]=[];for(const s in this)if(h.test(s)){const n=s;if("getEntity"!==n&&"function"==typeof this[n]){const s=n.replace("get","set");"function"==typeof this[s]&&(e[s]=this[n](),d[t].push([n,s]))}}}return e},t.Component.Base=t.ComponentBase,t.createFromObj=function(e,s){if(t.Component[e]){const n=new t.Component[e];return s.forEach(e=>{e.setter&&e.value?n[e.setter](e.value):Object.keys(e).forEach(t=>{const s=e[t];n[t](s)})}),n}return r.default.err("Component","createFromObj",`Comp type |${e}| does not exist. Args: ${s}`),null},t.Component.createFromObj=t.createFromObj,t.create=function(e,...s){return t.Component[e]?new t.Component[e](...s):(r.default.err("Component","create",`Comp type |${e}| does not exist.`),null)},t.Component.create=t.create,t.defineComponent=function(e,s){if(!t.Component.hasOwnProperty(e)){return t.DataComponent(e,s)}return r.default.err("Component","defineComponent",`Component ${e} already defined`),null},t.Component.defineComponent=t.defineComponent,t.undefineComponent=function(e){delete t.Component.createdCompDecls[e],delete t.Component[e]},t.Component.undefineComponent=t.undefineComponent},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Dice=void 0;const r=n(s(0)),a=s(1);class o{constructor(e,t,s){this._num=parseInt(e,10),this._dice=parseInt(t,10),this._mod=parseInt(s,10)}static create(e){const t=o.parseDieSpec(e);if(3===t.length)return new o(t[0],t[1],t[2]);r.default.err("Dice","create","Could not create dice properly")}static getDice(e){return"object"==typeof e?e:o.create(e)}static getValue(e){if("number"==typeof e){if(Number.isInteger(e))return e}else if("string"==typeof e){const t=o.parseDieSpec(e);return new o(t[0],t[1],t[2]).roll()}return e.roll()}static parseDieSpec(e){if("number"==typeof e)return[0,0,e];if("object"==typeof e){if(e.length>=3)return[e[0],e[1],e[2]]}else{const t=o.DIE_RE.exec(e);if(null!==t){const e=t[1],s=t[2];let n=null;return n=r.default.isNullOrUndef([t[3],t[4]])?"0":"+"===t[3]?t[4]:"-"+t[4],[e,s,n]}if(o.DIE_NUMBER.test(e))return[0,0,parseInt(e,10)];r.default.err("RG","parseDieSpec","Cannot parse: "+e)}return[]}static combine(e,t){const s=e.getNum()+t.getNum();let n=e.getNum()*e.getDice()+t.getNum()*t.getDice();n=Math.round(n/s);const r=e.getMod()+t.getMod();return new o(s,n,r)}static addDice(e,t){const s=e.getNum()+t.getNum(),n=e.getDice()+t.getDice(),r=e.getMod()+t.getMod();return new o(s,n,r)}getNum(){return this._num}setNum(e){this._num=e}getDice(){return this._dice}setDice(e){this._dice=e}getMod(){return this._mod}setMod(e){this._mod=e}roll(){let e=0;for(let t=0;t<this._num;t++)e+=o.RNG.getUniformInt(1,this._dice);return e+this._mod}toString(){let e="+ "+this._mod;return this._mod<0?e="- "+Math.abs(this._mod):0===this._mod&&(e=""),this._num+"d"+this._dice+" "+e}copy(e){this._num=e.getNum(),this._dice=e.getDice(),this._mod=e.getMod()}clone(){return new o(this._num,this._dice,this._mod)}equals(e){let t=this._num===e.getNum();return t=t&&this._dice===e.getDice(),t=t&&this._mod===e.getMod(),t}toJSON(){return[this._num,this._dice,this._mod]}}t.Dice=o,o.DIE_RE=/\s*(\d+)d(\d+)\s*(\+|-)?\s*(\d+)?/,o.DIE_NUMBER=/^\s*(-?\d+)\s*$/,o.RNG=new a.Random((new Date).getTime())},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BBox=void 0;const r=n(s(0)),a=s(1).Random.getRNG();class o{constructor(e,t,s,n){this.ulx=e,this.uly=t,this.lrx=s,this.lry=n,(e>s||t>n)&&r.default.err("BBox","constructor",`Illegal bbox: ${e},${t} -> ${s},${n}`)}static fromBBox(e){return new o(e.ulx,e.uly,e.lrx,e.lry)}getDist(e){const[t,s]=e;if(this.hasXY(t,s))return[0,0];return[this.getDistX(t),this.getDistY(s)]}getDistX(e){return e<this.ulx?this.ulx-e:e-this.lrx}getDistY(e){return e<this.uly?this.uly-e:e-this.lry}getArea(){return this.getSizeX()*this.getSizeY()}getSizeX(){return this.lrx-this.ulx+1}getSizeY(){return this.lry-this.uly+1}hasXY(e,t){return e>=this.ulx&&e<=this.lrx&&t>=this.uly&&t<=this.lry}getRandXY(){return[a.getUniformInt(this.ulx,this.lrx),a.getUniformInt(this.uly,this.lry)]}overlaps(e){return!!this.overlapsX(e)&&this.overlapsY(e)}overlapsX(e){return e.ulx>=this.ulx&&e.ulx<=this.lrx||e.lrx>=this.ulx&&e.lrx<=this.lrx}overlapsY(e){return e.uly>=this.uly&&e.uly<=this.lry||e.lry>=this.uly&&e.lry<=this.lry}getBorderXY(e,t=0){const s=[];let n=t||0;if(/N/.test(e))for(let e=this.ulx;e<=this.lrx;++e)s.push([e,this.uly+n]);if(/S/.test(e))for(let e=this.ulx;e<=this.lrx;++e)n>0&&(n=-n),s.push([e,this.lry+n]);if(/E/.test(e))for(let e=this.uly;e<=this.lry;++e)n>0&&(n=-n),s.push([this.lrx+n,e]);if(/W/.test(e))for(let e=this.uly;e<=this.lry;++e)s.push([this.ulx+n,e]);return s}getSides(){return[[[this.ulx,this.uly],[this.lrx,this.uly]],[[this.ulx,this.uly],[this.ulx,this.lry]],[[this.lrx,this.uly],[this.lrx,this.lry]],[[this.ulx,this.lry],[this.lrx,this.lry]]]}getMatchingSide(e){const t=this.getSides(),s=e.getSides();for(let e=0;e<t.length;e++){const n=t[e];for(let t=0;t<s.length;t++){if(i(n,s[t]))return[e,n]}}return null}combine(e){const t=this.getMatchingSide(e);if(t){const[s,n]=t;return 0===s||1===s?new o(e.ulx,e.uly,this.lrx,this.lry):new o(this.ulx,this.uly,e.lrx,e.lry)}return null}getCoord(){const e=[];for(let t=this.ulx;t<=this.lrx;t++)for(let s=this.uly;s<=this.lry;s++)e.push([t,s]);return e}withOffsetXY(e,t){return new o(this.ulx+e,this.uly+t,this.lrx+e,this.lry+t)}getCenter(){const e=this.getSizeX(),t=this.getSizeY();return[this.ulx+Math.round(e/2),this.uly+Math.round(t/2)]}}function i(e,t){const[s,n]=e,[r,a]=t;return s[0]===r[0]&&s[1]===r[1]&&n[0]===a[0]&&n[1]===a[1]}t.BBox=o},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryLevel=void 0;const i=o(s(0)),l=s(21),c=s(11),u=s(7),h=a(s(27)),d=s(53);class f{constructor(){this._verif=new h.Conf("FactoryLevel")}static createLevel(e,t,s,n){return(new f).createLevel(e,t,s,n)}createLevel(e,t,s,n){const r=new l.MapGenerator;let a=null,o=null;if(r.setGen(e,t,s),"empty"===e?a=r.createEmptyMap():"town"===e?(a=r.createTownBSP(t,s,n),o=new c.Level(a.map),this.createHouseElements(o,a),this.createShops(o,a,n),this.createTrainers(o,n)):"townwithwall"===e?(a=r.createTownWithWall(t,s,n),o=new c.Level(a.map),this.createHouseElements(o,a),this.createShops(o,a,n),this.createTrainers(o,n)):a="forest"===e?r.createForest(n):"lakes"===e?r.createLakes(n):"mountain"===e?r.createMountain(t,s,n):"summit"===e?r.createSummit(t,s,n):"crypt"===e?r.createCryptNew(t,s,n):"cave"===e?r.createCave(t,s,n):"castle"===e?r.createCastle(t,s,n):"wall"===e?r.createWall(t,s,n):"arctic"===e?r.createArctic(t,s,n):r.getMap(),null===o)if(a)o=new c.Level(a.map);else{const t=JSON.stringify(n);i.default.err("FactoryBase","createLevel",`mapObj is null. type: ${e}. ${t}`)}return this.setLevelExtras(o,a),o}setLevelExtras(e,t){const s={};["rooms","corridors","vaults","houses","paths"].forEach(e=>{t.hasOwnProperty(e)&&(s[e]=t[e])}),e.setExtras(s)}createHouseElements(e,t){if(t.houses){const s=t.houses;for(let t=0;t<s.length;t++){const n=s[t].door,r=new u.ElementDoor(!0);e.addElement(r,n[0],n[1])}}}createShops(e,t,s){this._verif.verifyConf("createShops",s,["nShops"]);const n=new d.DungeonPopulate;e.addExtras("houses",t.houses),n.createShops(e,s)}createTrainers(e,t){(new d.DungeonPopulate).createTrainers(e,t)}}t.FactoryLevel=f},function(e,t,s){var n;try{n={clone:s(281),constant:s(173),each:s(339),filter:s(345),has:s(368),isArray:s(9),isEmpty:s(370),isFunction:s(76),isUndefined:s(371),keys:s(41),map:s(372),reduce:s(374),size:s(377),transform:s(383),union:s(384),values:s(403)}}catch(e){}n||(n=window._),e.exports=n},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||n(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),r(s(278),t),r(s(469),t),r(s(470),t),r(s(471),t),r(s(472),t),r(s(473),t),r(s(212),t),r(s(33),t),r(s(474),t),r(s(135),t),r(s(34),t)},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(36);t.default=class{constructor(e=n.DEFAULT_WIDTH,t=n.DEFAULT_HEIGHT){this._width=e,this._height=t}_fillMap(e){const t=[];for(let s=0;s<this._width;s++){t.push([]);for(let n=0;n<this._height;n++)t[s].push(e)}return t}getCols(){return this._width}getRows(){return this._height}getCenterXY(){return[Math.floor(this._width/2),Math.floor(this._height/2)]}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createEval=t.EvaluatorGeneric=t.EvaluatorFollowPath=t.EvaluatorFindAmmo=t.EvaluatorFindWeapon=t.EvaluatorRest=t.EvaluatorTreasureHunter=t.EvaluatorUseSkill=t.EvaluatorCommunicate=t.EvaluatorThief=t.EvaluatorGoHome=t.EvaluatorShopkeeper=t.EvaluatorCastSpell=t.EvaluatorOrders=t.EvaluatorGuardArea=t.EvaluatorGuard=t.EvaluatorPatrol=t.EvaluatorFlee=t.EvaluatorExplore=t.EvaluatorAttackActor=t.EvaluatorBase=t.Evaluator=void 0;const r=n(s(0)),a=s(54),o=s(264),i=s(265),l=s(1),c=s(15),u=s(18);a.Goal.Thief=o.GoalThief,a.Goal.TreasureHunter=i.GoalTreasureHunter,t.Evaluator={},t.Evaluator.hist={},t.Evaluator.NOT_POSSIBLE=r.default.BIAS.NOT_POSSIBLE,t.Evaluator.ALWAYS=r.default.BIAS.ALWAYS;const h=l.Random.getRNG();class d{constructor(e){this.actorBias=e,this.type="Base",this.evalCount=0,this.evalMaxCount=1,this.isOneShot=!1,this.wasLastChosen=!1}calculateDesirability(e){throw new Error("Pure virtual function")}setActorGoal(e,...s){const n=e.getBrain().getGoal();if(a.Goal[this.type]){const r=new a.Goal[this.type](e,...s);n.addGoal(r),++t.Evaluator.hist[this.type]}else r.default.err(`EvaluatorBase (${this.type})`,"setActorGoal",`No Goal.${this.type} found!`)}isOrder(){return!1}getType(){return this.type}setBias(e){this.actorBias=e}toJSON(){return{type:this.getType(),bias:this.actorBias}}setArgs(e){}}t.EvaluatorBase=d,t.Evaluator.Base=d;class f extends d{constructor(e){super(e),this.type="AttackActor"}calculateDesirability(e){const s=e.getBrain().findEnemyCellFast();if(s){const e=1;return this.enemyActor=s.getActors()[0],this.actorBias*e*2}return t.Evaluator.NOT_POSSIBLE}setActorGoal(e){super.setActorGoal(e,this.enemyActor)}}t.EvaluatorAttackActor=f,t.Evaluator.AttackActor=f,t.Evaluator.hist.AttackActor=0;class g extends d{constructor(e){super(e),this.type="Explore"}calculateDesirability(){return this.actorBias}}t.EvaluatorExplore=g,t.Evaluator.Explore=g,t.Evaluator.hist.Explore=0;class p extends d{constructor(e){super(e),this.type="Flee"}calculateDesirability(e){const s=e.get("Health").propLeft();if(s<this.actorBias){const t=e.getBrain().getSeenEnemies();if(t.length>0){let e=-1;this.enemyActor&&(e=t.findIndex(e=>e.getID()===this.enemyActor.getID())),-1===e&&(this.enemyActor=t[0]);const n=Math.pow(s,2);return this.actorBias*(1-s)/n}}return this.enemyActor=null,t.Evaluator.NOT_POSSIBLE}setActorGoal(e){if(this.enemyActor){const s=e.getBrain().getGoal(),n=new a.Goal.FleeFromActor(e,this.enemyActor);s.addGoal(n),++t.Evaluator.hist[this.type]}else r.default.err("EvaluatorFlee","setActorGoal","Enemy actor is null. Cannot flee.")}}t.EvaluatorFlee=p,t.Evaluator.Flee=p,t.Evaluator.hist.Flee=0;class m extends d{constructor(e,t=[]){super(e),this.type="Patrol",this.coords=t}setCoords(e){this.coords=e}calculateDesirability(){return this.actorBias}setActorGoal(e){const s=e.getBrain().getGoal(),n=this.coords;if(n.length>0){const r=new a.Goal.Patrol(e,n);s.addGoal(r),++t.Evaluator.hist[this.type]}else r.default.err("EvaluatorPatrol","setActorGoal","No guard points set with setCoords()")}setArgs(e){this.coords=e.coords}toJSON(){const e=super.toJSON();return e.args={coords:this.coords},e}}t.EvaluatorPatrol=m,t.Evaluator.Patrol=m,t.Evaluator.hist.Patrol=0;class y extends d{constructor(e,t){super(e),this.type="Guard",t&&this.setXY(t)}setXY(e){this.x=e[0],this.y=e[1]}setArgs(e){const{xy:t}=e;this.setXY(t)}calculateDesirability(){return this.actorBias}setActorGoal(e){const s=e.getBrain().getGoal(),n=new a.Goal.Guard(e,[this.x,this.y]);s.addGoal(n),++t.Evaluator.hist[this.type]}toJSON(){const e=super.toJSON();return e.args={xy:[this.x,this.y]},e}}t.EvaluatorGuard=y,t.Evaluator.Guard=y,t.Evaluator.hist.Guard=0;class _ extends d{constructor(e,t){super(e),this.type="GuardArea",this.setBBox(t)}setBBox(e){this.bbox=e}setArgs(e){const{bbox:t}=e;this.setBBox(u.BBox.fromBBox(t))}calculateDesirability(e){return this.bbox.hasXY(e.getX(),e.getY())?t.Evaluator.NOT_POSSIBLE:this.actorBias}setActorGoal(e){const s=e.getBrain().getGoal(),n=new a.Goal.GuardArea(e,this.bbox);s.addGoal(n),++t.Evaluator.hist[this.type]}toJSON(){const e=super.toJSON();return e.args={bbox:this.bbox},e}}t.EvaluatorGuardArea=_,t.Evaluator.GuardArea=_,t.Evaluator.hist.GuardArea=0;class b extends d{constructor(e){super(e),this.type="Orders",this.goal=null}setArgs(e){this.goal=e.goal,this.srcActor=e.srcActor}calculateDesirability(){let e=this.goal.getCategory()===a.Goal.Types.Kill?.5:1;return e*=this.actorBias,this.acceptsOrdersFromSource()?1*e:0}acceptsOrdersFromSource(){return!!this.srcActor.has("Commander")||!!this.srcActor.isPlayer()}setActorGoal(e){if(this.goal){e.getBrain().getGoal().addGoal(this.goal),++t.Evaluator.hist[this.type]}else r.default.err("EvaluatorOrder","setActorGoal","this.goal must not be null")}isOrder(){return!0}}t.EvaluatorOrders=b,t.Evaluator.Orders=b,t.Evaluator.hist.Orders=0;class v extends d{constructor(e){super(e),this.type="CastSpell",this._castingProb=.2}setCastingProbability(e){this._castingProb=e}getCastingProbability(){return this._castingProb}calculateDesirability(e){return this.spell=this.getRandomSpell(e),this.spell&&this.canCastSpell(e)&&this.shouldCastSpell(e)?this.actorBias:0}setActorGoal(e){if(this.spell){const s=e.getBrain().getGoal(),n=new a.Goal.CastSpell(e,this.spell,this.spellArgs);s.addGoal(n),++t.Evaluator.hist[this.type]}else r.default.err("EvaluatorFlee","setActorGoal","Enemy actor is null. Cannot flee.")}getRandomSpell(e){const t=e.getBook();if(t&&t.getSpells().length>0){return h.arrayGetRand(t.getSpells())}return null}canCastSpell(e){if(e.has("SpellPower")){if(e.get("SpellPower").getPP()>=this.spell.getCastingPower()&&h.getUniform()<=this._castingProb)return!0}return!1}shouldCastSpell(e){const t=e.getBrain().findEnemyCellFast(),s={actor:e,actorCellsAround:c.Brain.getActorCellsAround(e)};if(t&&(s.enemy=t.getActors()[0]),this.spell.aiShouldCastSpell)return this.spell.aiShouldCastSpell(s,(e,t)=>{this.spellArgs=t});{let e=`Spell ${this.spell.getName()} cannot be cast by AI`;e+=" no aiShouldCastSpell() defined for the spell",r.default.warn("Evaluator.CastSpell","shouldCastSpell",e)}return!1}}t.EvaluatorCastSpell=v,t.Evaluator.CastSpell=v,t.Evaluator.hist.CastSpell=0;class E extends d{constructor(e){super(e),this.type="Shopkeeper"}calculateDesirability(e){return e.has("Shopkeeper")?this.actorBias:(r.default.err("EvaluatorShopkeeper","calculateDesirability","An actor is not shopkeeper: "+e),0)}setActorGoal(e){const s=e.getBrain().getGoal(),n=new a.Goal.Shopkeeper(e,this.x,this.y);s.addGoal(n),++t.Evaluator.hist[this.type]}setArgs(e){const{xy:t}=e;this.x=t[0],this.y=t[1]}toJSON(){const e=super.toJSON();return e.args={xy:[this.x,this.y]},e}}t.EvaluatorShopkeeper=E,t.Evaluator.Shopkeeper=E,t.Evaluator.hist.Shopkeeper=0;class S extends d{constructor(e){super(e),this.type="GoHome",this.timeToHomeSick=h.getUniformInt(20,40),this.timeToStay=0,this.maxDistHome=5,this.x=-1,this.y=-1}calculateDesirability(e){if(this.timeToHomeSick>0)return this.timeToHomeSick-=1,0;if(0===this.timeToHomeSick&&(this.timeToHomeSick=-1,this.timeToStay=h.getUniformInt(20,40)),this.timeToStay>0){const t=[this.x,this.y];return r.default.withinRange(this.maxDistHome,t,e)&&(this.timeToStay-=1),this.actorBias}return 0===this.timeToStay&&(this.timeToStay=-1,this.timeToHomeSick=h.getUniformInt(20,40)),0}setActorGoal(e){const s=e.getBrain().getGoal(),n=new a.Goal.GoHome(e,this.x,this.y,this.maxDistHome);s.addGoal(n),++t.Evaluator.hist[this.type]}setArgs(e){const{xy:t}=e;this.x=t[0],this.y=t[1],this.timeToHomeSick=e.timeToHomeSick}toJSON(){const e=super.toJSON();return e.args={xy:[this.x,this.y],timeToHomeSick:this.timeToHomeSick},e}}t.EvaluatorGoHome=S,t.Evaluator.GoHome=S,t.Evaluator.hist.GoHome=0;class w extends d{constructor(e){super(e),this.type="Thief"}calculateDesirability(){return this.actorBias}}t.EvaluatorThief=w,t.Evaluator.Thief=w,t.Evaluator.hist.Thief=0;class C extends d{constructor(e){super(e),this.type="Communicate"}calculateDesirability(e){if(this.willCommunicate(e))return this.actorBias}willCommunicate(e){if(h.getUniform()<1-this.actorBias)return!1;const t=e.getBrain(),s=t.getSeenCells(),n=t.findFriendCell(s),a=t.getMemory();let o=null;return!r.default.isNullOrUndef([n])&&(o=n.getActors()[0],!a.hasCommunicatedWith(o)&&!o.has("Communication"))}}t.EvaluatorCommunicate=C,t.Evaluator.Communicate=C;class T extends d{constructor(e){super(e),this.type="UseSkill",this.maxCooldown=100,this.cooldown=h.getUniformInt(10,2*this.maxCooldown),this.aiType="aiCell"}calculateDesirability(e){return function(e,t){if("aiFreeCell"===e.aiType){return t.getBrain().getFreeCellsAround().length>0}return!1}(this,e)?0===this.cooldown?(this.cooldown=h.getUniformInt(10,2*this.maxCooldown),console.log("EvalUseSkill cooldown at 0."),this.actorBias):(this.cooldown-=1,r.default.BIAS.NOT_POSSIBLE):r.default.BIAS.NOT_POSSIBLE}setArgs(e){this.cooldown=e.cooldown,this.maxCooldown=e.maxCooldown,this.aiType=e.aiType}toJSON(){const e=super.toJSON();return e.args={cooldown:this.cooldown,maxCooldown:this.maxCooldown,aiType:this.aiType},e}}t.EvaluatorUseSkill=T,t.Evaluator.UseSkill=T;class O extends d{constructor(e){super(e),this.type="TreasureHunter"}calculateDesirability(){return this.actorBias}}t.EvaluatorTreasureHunter=O,t.Evaluator.TreasureHunter=O;class A extends d{constructor(e){super(e),this.type="Rest"}calculateDesirability(){return this.actorBias}}t.EvaluatorRest=A,t.Evaluator.Rest=A;class M extends d{constructor(e){super(e),this.type="FindWeapon"}calculateDesirability(){return this.actorBias}}t.EvaluatorFindWeapon=M,t.Evaluator.FindWeapon=M;class N extends d{constructor(e){super(e),this.type="FindAmmo",this.ammoType="bow"}calculateDesirability(){return this.actorBias}setActorGoal(e){super.setActorGoal(e,this.ammoType)}}t.EvaluatorFindAmmo=N,t.Evaluator.FindAmmo=N;class P extends d{constructor(e){super(e),this.type="FollowPath"}calculateDesirability(){return this.actorBias}setActorGoal(e){super.setActorGoal(e,this.xy)}}t.EvaluatorFollowPath=P,t.Evaluator.FollowPath=P;class D extends d{constructor(e,t){super(e),this.type=t}calculateDesirability(){return this.actorBias}setActorGoal(e){this.args?super.setActorGoal(e,...this.args):super.setActorGoal(e)}}function I(e,t){return new D(t,e)}t.EvaluatorGeneric=D,t.Evaluator.Generic=D,t.createEval=I,t.Evaluator.create=I},function(e,t,s){var n=s(156),r="object"==typeof self&&self&&self.Object===Object&&self,a=n||r||Function("return this")();e.exports=a},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Entity=void 0;const r=n(s(0)),a=s(101),o=s(12),i=s(102),l={OnAddCb:!0,OnRemoveCb:!0,Movement:!0};class c extends a.GameObject{constructor(...e){super(),this.comps={},this.compsByType={}}static createEntityID(){return a.GameObject.createObjectID()}static getPool(){return c.POOL}static setPool(e){c.POOL=e}static getIDCount(){return a.GameObject.ID}remove(e){if(++c.num.remove,"object"==typeof e){const t=e.getID();if(this.comps.hasOwnProperty(t)){const e=this.comps[t],s=e.getType();if(e.entityRemoveCallback(this),c.enableOnAddRemoveCbsFor[s]){const t=new i.OnRemoveCb;t.setCompName(s),t.setComp(e),this.add(t)}delete this.comps[t];const n=this.compsByType[s].indexOf(e);!function(e,t){const s=e.length;if(s){for(;t<s;)e[t]=e[t+1],t++;e.length--}}(this.compsByType[s],n),0===this.compsByType[s].length&&(l[s]||delete this.compsByType[s]),c.POOL.emitEvent(s,{entity:this,remove:!0})}}else if(Number.isInteger(e)){const t=e;this.comps[t]&&this.remove(this.comps[t])}else{const t=this.get(e);if(t)this.remove(t);else{const t=parseInt(e,10);if(t)this.remove(t);else{const t=typeof e;r.default.warn("Entity","remove",`No comp found ->  |${e}|, type: ${t}`)}}}}equals(e){return this.getID()===e.getID()}get(e){return++c.num.get,this.compsByType[e]?this.compsByType[e][0]:null}getByID(e){return this.comps[e]}getList(e){return++c.num.getList,this.compsByType[e]?this.compsByType[e].slice():[]}add(e){++c.num.add;const t=e.getType();if(e.isUnique()&&this.has(t)&&this.removeAll(t),this.comps[e.getID()]=e,this.compsByType.hasOwnProperty(t)?this.compsByType[t].push(e):this.compsByType[t]=[e],e.entityAddCallback(this),c.POOL.emitEvent(t,{entity:this,add:!0}),c.enableOnAddRemoveCbsFor[t]){const s=new i.OnAddCb;s.setCompName(t),s.setComp(e),this.add(s)}}has(e){return++c.num.has,this.compsByType.hasOwnProperty(e)?this.compsByType[e].length>0:this.comps.hasOwnProperty(e)}hasAny(e){++c.num.hasAny;for(const t of e)if(this.compsByType.hasOwnProperty(t)&&this.compsByType[t].length>0)return!0;return!1}hasNone(e){return!this.hasAny(e)}hasAll(e){for(const t of e){if(!this.compsByType.hasOwnProperty(t))return!1;if(0===this.compsByType[t].length)return!1}return!0}removeAll(e){++c.num.removeAll;let t=e;if("object"==typeof e&&(t=e.getType()),this.has(t)){this.compsByType[t].slice().forEach(e=>{this.remove(e)})}}getComponents(){return this.comps}getCompList(){return Object.keys(this.compsByType)}copy(e){throw new Error("copy() not implemented in Entity")}clone(){throw new Error("clone() not implemented in Entity")}toJSON(){throw new Error("toJSON() not implemented in Entity")}}t.Entity=c,c.setPool(o.EventPool.getPool()),c.enableOnAddRemoveCbsFor={Paralysis:!0,Flying:!0},c.num={},c.num.add=0,c.num.get=0,c.num.getList=0,c.num.has=0,c.num.hasAny=0,c.num.hasAll=0,c.num.remove=0,c.num.removeAll=0},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Book=t.Mineral=t.SpiritGem=t.GoldCoin=t.Gold=t.Container=t.Missile=t.Rune=t.Potion=t.Armour=t.Ammo=t.MissileWeapon=t.Weapon=t.Corpse=t.Food=t.ItemBase=t.Item=void 0;const i=o(s(0)),l=s(16),c=a(s(13)),u=a(s(97)),h=s(25),d=s(12),f=s(17),g=d.EventPool.getPool();t.Item={};class p extends h.Entity{constructor(e){super(),this.isOwnable=!0,this._owner=null,this.isUsable=!1,this.add(new c.Typed(i.default.ITEM.BASE,i.default.TYPE_ITEM)),this.add(new c.Item),this.add(new c.Physical);const t=new c.Named;t.setName(e),this.add(t)}setOwner(e){i.default.isNullOrUndef([e])?i.default.err("ItemBase","setOwner","Owner cannot be null."):this._owner=e}getTopOwner(){let e=this._owner;for(;e.getOwner;)e=e.getOwner();return e}getOwner(){return this._owner}getX(){return this._owner?this._owner.getX():null}getY(){return this._owner?this._owner.getY():null}getXY(){return this._owner?this._owner.getXY():null}setName(e){this.get("Named").setName(e)}getName(){return this.get("Named").getFullName()}setWeight(e){this.get("Physical").setWeight(e)}getWeight(){return this.get("Physical").getWeight()}setValue(e){this.get("Item").setValue(e)}getValue(){return this.get("Item").getValue()}incrCount(e){this.get("Item").incrCount(e)}decrCount(e){this.get("Item").decrCount(e)}getCount(){return this.get("Item").getCount()}setCount(e){this.get("Item").setCount(e)}getType(){return this.get("Typed").getObjType()}setType(e){return this.get("Typed").setObjType(e)}getPropType(){return this.get("Typed").getPropType()}setPropType(e){return this.get("Typed").setPropType(e)}setDamageType(e){this.get("Item").setDamageType(e)}getDamageType(){return this.get("Item").getDamageType()}getNameWithCount(){return`${this.getName()} (x${this.getCount()})`}toString(){let e=this.getName()+", "+this.getType()+", ";return e+=(this.getWeight()*this.getCount()).toFixed(2)+"kg",e=this.getCount()+" x "+e,this.has("GemBound")&&(e+=" (Bound)"),this.has("Stats")&&(e+=" "+this.get("Stats").toString()),e}copy(e){this.setName(e.getName()),this.setType(e.getType()),this.setWeight(e.getWeight()),this.setValue(e.getValue()),e.useArgs&&(this.useArgs=e.useArgs),e.isUsable&&(this.useItem=e.useItem.bind(this));Object.values(e.getComponents()).forEach(e=>{this.add(e.clone())})}useItem(e){return!1}clone(){const e=new p(this.getName());return e.copy(this),e}equals(e){if(this.getType()!==e.getType())return!1;if(this.getID()===e.getID())return!0;let t=this.getName()===e.getName();return t=t&&this.getWeight()===e.getWeight(),t=t&&!(this.has("GemBound")||e.has("GemBound")),t}toJSON(){const e={setID:this.getID(),setName:this.getName(),setType:this.getType(),isUsable:this.isUsable};return e.components=l.compsToJSON(this),e}}t.ItemBase=p,t.Item.Base=p;class m extends p{constructor(e){super(e),this.setType(i.default.ITEM.FOOD),this._energy=0,this.isUsable=!0}setEnergy(e){this._energy=e}getEnergy(){return this._energy}useItem(e){if(e.hasOwnProperty("target")){const t=e.target;if(t.hasActors()){const e=t.getProp("actors")[0];if(e.has("Hunger")){let t=this.getConsumedEnergy();if(e.has("NourishedOne")&&(t*=3),e.get("Hunger").addEnergy(t),1===this.getCount()){const t={item:this};g.emitEvent(i.default.EVT_DESTROY_ITEM,t),i.default.gameMsg(e.getName()+" consumes "+this.getName())}else this.decrCount(1);return!0}i.default.gameWarn(e.getName()+" is not interested in eating.")}else i.default.gameWarn("There's no one to give food to.")}else i.default.err("ItemFood","useItem","No target given in obj.");return!1}getConsumedEnergy(){return Math.round(this.getWeight()*this._energy/.1)}toJSON(){const e=super.toJSON();return e.setEnergy=this.getEnergy(),e}clone(){const e=new t.Item.Food(this.getName());return e.copy(this),e.setEnergy(this.getEnergy()),e}}t.Food=m,t.Item.Food=m;class y extends p{constructor(e){super(e),this.setType(i.default.ITEM.CORPSE)}setActorName(e){this.actorName=e}getActorName(){return this.actorName}}t.Corpse=y,t.Item.Corpse=y;class _ extends(u.Damage(p)){constructor(e){super(e),this.setType(i.default.ITEM.WEAPON),this._weaponType=""}copy(e){super.copy(e),this._weaponType=e.getWeaponType()}clone(){const e=new _(this.getName());return e.copy(this),e}setWeaponType(e){this._weaponType=e}getWeaponType(){return this._weaponType}toJSON(){const e=super.toJSON();return e.setWeaponType=this._weaponType,e}}t.Weapon=_,t.Item.Weapon=_;class b extends _{constructor(e){super(e),this.setType(i.default.ITEM.MISSILE_WEAPON),this._fireRate=1}setFireRate(e){this._fireRate=e}getFireRate(){return this._fireRate}copy(e){super.copy(e),this.setFireRate(e.getFireRate())}clone(){const e=new b(this.getName());return e.copy(this),e}equals(e){return!!super.equals(e)&&this._fireRate===e.getFireRate()}toJSON(){const e=super.toJSON();return e.setFireRate=this._fireRate,e}}t.MissileWeapon=b,t.Item.MissileWeapon=b;class v extends _{constructor(e){super(e),this.setType(i.default.ITEM.AMMUNITION),this.add(new c.Ammo),this._ammoType=""}setAmmoType(e){this._ammoType=e}getAmmoType(){return this._ammoType}copy(e){super.copy(e),this.setAmmoType(e.getAmmoType())}clone(){const e=new v(this.getName());return e.copy(this),e}equals(e){return!!super.equals(e)&&this._ammoType===e.getAmmoType()}toJSON(){const e=super.toJSON();return e.setAmmoType=this._ammoType,e}}t.Ammo=v,t.Item.Ammo=v;class E extends(u.Defense(p)){constructor(e){super(e),this.setType(i.default.ITEM.ARMOUR),this._armourType=""}setArmourType(e){this._armourType=e}getArmourType(){return this._armourType}copy(e){super.copy(e),this.setArmourType(e.getArmourType())}clone(){const e=new E(this.getName());return e.copy(this),e}equals(e){let t=super.equals(e);return t=t&&this._armourType===e.getArmourType(),t}toJSON(){const e=super.toJSON();return e.setArmourType=this.getArmourType(),e}}t.Armour=E,t.Item.Armour=E;class S extends p{constructor(e){super(e),this.setType(i.default.ITEM.POTION),this.isUsable=!0}useItem(e){if(e.hasOwnProperty("target")){const t=e.target;if(t.hasActors()){const e=t.getProp("actors")[0],s=new f.Dice(1,10,2).roll();if(e.has("Health")){e.get("Health").addHP(s);const t=this.getOwner().getOwner();if(i.default.isActor(t)){const s=new c.UseItem;return s.setTarget(e),s.setItem(this),s.setUseType(i.default.USE.DRINK),t.add(s),!1}i.default.err("Item.Potion","useItem","Non-actor user encountered: "+t)}}else i.default.gameWarn("Cannot see anyone there for using the potion.")}else i.default.err("ItemPotion","useItem","No target given in obj.");return!1}clone(){const e=new t.Item.Potion(this.getName());return e.copy(this),e}}t.Potion=S,t.Item.Potion=S;class w extends p{constructor(e){super(e),this.setType(i.default.ITEM.RUNE),this._charges=1}getCharges(){return this._charges}setCharges(e){this._charges=e}clone(){const e=new w(this.getName());return e.copy(this),e}copy(e){super.copy(e),this.setCharges(e.getCharges())}equals(e){let t=super.equals(e);return!!e.getCharges&&(t=t&&this.getCharges()===e.getCharges(),t)}toString(){let e=super.toString();return e+=" charges: "+this.getCharges(),e}toJSON(){const e=super.toJSON();return e.setCharges=this.getCharges(),e}}t.Rune=w,t.Item.Rune=w;class C extends _{constructor(e){super(e),this.setType(i.default.ITEM.MISSILE)}clone(){const e=new C(this.getName());return e.copy(this),e}}t.Missile=C,t.Item.Missile=C;class T extends p{constructor(e){super("container"),this.setOwner(e),this._items=[],this._iter=0,this._removedItem=null}_addItem(e){let t=!1;for(let s=0;s<this._items.length;s++)if(this._items[s].equals(e)){this._items[s].incrCount(e.getCount()),t=!0;break}t||(e.setOwner(this),this._items.push(e))}getWeight(){let e=0;for(let t=0;t<this._items.length;t++)e+=this._items[t].getWeight()*this._items[t].getCount();return e}addItem(e){if(e.getCount()<=0){const t=JSON.stringify(e);i.default.warn("Container","addItem","Possible bug. Tried to add item with count 0: "+t)}"container"===e.getType()?this.getOwner()!==e?this._addItem(e):i.default.err("Item","addItem","Added item is container's owner. Impossible."):this._addItem(e)}getItems(){return this._items.slice()}hasItemRef(e){return-1!==this._items.indexOf(e)}hasItem(e){if(this.hasItemRef(e))return!0;return this._getMatchingItemIndex(e)>=0}hasItemWith(e){return this._items.findIndex(e)>=0}getItemsWith(e){return this._items.filter(e)}removeItem(e){return this.hasItem(e)?this._removeItem(e):(this._removedItem=null,!1)}_getMatchingItemIndex(e){for(let t=0;t<this._items.length;t++)if(e.equals(this._items[t]))return t;return-1}_removeItem(e){const t=this._getMatchingItemIndex(e);return-1===t?(i.default.err("ItemContainer","_removeItem","Negative index found. Horribly wrong."),!1):(1===this._items[t].getCount()?(this._removedItem=e,this._items.splice(t,1)):(this._removedItem=i.default.removeStackedItems(this._items[t],1),0===this._items[t].getCount()&&this._items.splice(t,1)),!0)}getRemovedItem(){return this._removedItem}removeNItems(e,t){let s=0;for(;s<t&&this.removeItem(e);)++s;return null===this._removedItem?(i.default.err("ItemContainer","removeNItems","this._removedItem was null. It should be a valid item."),!1):(this._removedItem.setCount(s),s>0)}first(){return this._items.length>0?(this._iter=1,this._items[0]):null}next(){return this._iter<this._items.length?this._items[this._iter++]:null}last(){return this._items[this._items.length-1]}isEmpty(){return 0===this._items.length}toString(){let e="Container: "+this.getName()+"\n";const t=this.getItems();for(let s=0;s<t.length;s++)e+=t[s].toString()+"\n";return e}toJSON(){const e=[],t=this.getItems();for(let s=0;s<t.length;s++)e.push(t[s].toJSON());return e}}t.Container=T,t.Item.Container=T;class O extends p{constructor(e){super(e),this.setType(i.default.ITEM.GOLD),this._purity=1}getPurity(){return this._purity}setPurity(e){this._purity=e}toJSON(){const e=super.toJSON();return e.setType=this.getType(),e.setPurity=this._purity,e}}t.Gold=O,t.Item.Gold=O;class A extends O{constructor(e){super(e||i.default.GOLD_COIN_NAME),this.setType(i.default.ITEM.GOLD_COIN),this._purity=1,this.setWeight(i.default.GOLD_COIN_WEIGHT)}}t.GoldCoin=A,t.Item.GoldCoin=A;class M extends p{constructor(e){super(e),this.setType(i.default.ITEM.SPIRITGEM),this._spirit=null,this._hasSpirit=!1}getArmourType(){return this.getType()}hasSpirit(){return this._hasSpirit}getSpirit(){return this._spirit}setSpirit(e){this._hasSpirit?i.default.err("Item.SpiritGem","setSpirit","Tried to overwrite spirit"):(this._hasSpirit=!0,this._spirit=e)}useItem(e){const t=this.getOwner().getOwner();if(t){const s=new c.SpiritBind;return s.setTarget(e.target),s.setBinder(t),this.add(s),!0}{const t="binder is null. obj: "+JSON.stringify(e);i.default.err("Item.SpiritGem","useItem",t)}return!1}clone(){const e=new M(this.getName());return e.copy(this),e}copy(e){super.copy(e),e.hasSpirit()&&this.setSpirit(e.getSpirit())}equals(e){let t=super.equals(e);return t=t&&this.getSpirit()===e.getSpirit(),t}toString(){let e=super.toString();if(this.hasSpirit()){const t=this.getSpirit().get("Stats");e+="("+this.getSpirit().getName()+")",e+=" Str: "+t.getStrength(),e+=" Agi: "+t.getAgility(),e+=" Acc: "+t.getAccuracy(),e+=" Wil: "+t.getWillpower()}else e+="(Empty)";return e}toJSON(){const e=super.toJSON();return e.hasSpirit=this.hasSpirit(),e.hasSpirit&&(e.setSpirit=this.getSpirit().toJSON()),e}}t.SpiritGem=M,t.Item.SpiritGem=M;for(let e=0;e<i.default.GET_STATS.length;e++)M.prototype[i.default.GET_STATS[e]]=function(){return(()=>{const t=i.default.GET_STATS[e];return this._hasSpirit?this._spirit.get("Stats")[t]():0})()};class N extends p{constructor(e){super(e),this.setType(i.default.ITEM.MINERAL)}}t.Mineral=N,t.Item.Mineral=N;class P extends p{constructor(e){super(e),this.setType(i.default.ITEM.BOOK),this.text=[],this.metaData={}}addMetaData(e,t){this.metaData.hasOwnProperty[e]||(this.metaData[e]=[]),this.metaData[e].push(t)}setMetaData(e){this.metaData=e}getMetaData(e){return this.metaData[e]}useItem(){const e=this.getTopOwner();if(i.default.isActor(e)){const t=new c.Read;return t.setReadTarget(this),e.add(t),!0}return!1}getText(){return this.text}addText(e){this.text.push(e)}setText(e){this.text=e}clone(){const e=new P(this.getName());return e.copy(this),e}copy(e){super.copy(e);const t=e.getText().slice();this.setText(t),this.metaData=JSON.parse(JSON.stringify(e.metaData))}equals(e){return this.getID()===e.getID()}toJSON(){const e=super.toJSON();return e.setText=this.text,e.setMetaData=this.metaData,e}}t.Book=P,t.Item.Book=P},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.verifyLevelCache=t.traverseObj=t.verifySaveData=t.Conf=t.verifyStairsConnections=void 0;const r=n(s(0));t.verifyStairsConnections=function(e,t){e.getLevels().map(e=>e.getStairs()).forEach(e=>{e.forEach(e=>{if("function"!=typeof e.isConnected)r.default.err("verify.js","verifyStairsConnections","stairs not correct type: "+JSON.stringify(e));else if(!e.isConnected()){let s="|"+t+"| stairs: "+JSON.stringify(e);const n=e.getSrcLevel();s+=n?" srcLevel parent "+n.getParent()+",":" srcLevel missing,";const a=e.getTargetStairs();s+=a?" targetLevel parent: "+a.getParent():" targetLevel missing,",e.getTargetStairs()||(s+=" targetStairs missing"),r.default.err("verify.js","verifyConnections",s)}})})};t.Conf=class{constructor(e){this._name=e}verifyConf(e,t,s){let n=!0,a="";return s.forEach(e=>{this.verifyReq(t,e)?function(e,t){const s=t.split("|"),n=s.length>0;let a=!1;for(const t of s)e.hasOwnProperty(t)&&r.default.isNullOrUndef([e[t]])&&(a=!0);return!n&&a}(t,e)&&(n=!1,a+=" Undef/null value in: "+e):(n=!1,a+=" Missing: "+e)}),n||r.default.err(this._name,"verifyConf",`${e} ${a}`),n}verifyReq(e,t){const s=t.split("|");let n=!1;return s.forEach(s=>{if(e.hasOwnProperty(s))if(n){const s=JSON.stringify(e),n=`Req ${t} is mutex. Conf: ${s}`;r.default.err(this._name,"verifyReq",n)}else n=!0}),n}},t.verifySaveData=function(e,t=!0){o(e,t)};const a=[];function o(e,t,s=30){const n=[];for(const r in e)if(e.hasOwnProperty(r)){if(a.push(r),a.length<s)if("object"==typeof e[r])o(e[r]);else if("function"==typeof e[r]){let s="Error. Func in "+JSON.stringify(a);if(s+="\n\tProp: "+r,s+="\n\tValue: "+e[r].toString(),t)throw new Error(s);n.push(s)}else if("string"==typeof e[r]&&/function/.test(e[r])){let t=`function in string <<${e[r]}>>\n`;throw t+="\tStack is "+a.join("."),new Error(t)}a.pop()}if(n.length>0){const e=n.join("\n");throw new Error(e)}}t.traverseObj=o,t.verifyLevelCache=function(e){const t=e.getItems(),s=e.getMap().getCells(),n={};s.forEach(e=>{if(e.hasItems()){e.getItems().forEach(e=>{n[e.getID()]=e})}});const r={};t.forEach(e=>{r[e.getID()]=e});const a=Object.keys(n).length,o=Object.keys(r).length;if(o!==a){let e="nCellItems: "+a;e+=", nLevelItems: "+o,console.error("Mismatch in cell/level item length:",e)}const i=[];Object.keys(n).forEach(e=>{r.hasOwnProperty(e)?delete r[e]:i.push(n[e])});const l=[];Object.keys(r).forEach(e=>{n.hasOwnProperty(e)?delete n[e]:l.push(r[e])}),i.forEach(e=>{console.error("\tIn cells but NOT level: ",e.getName())}),l.forEach(e=>{console.error("\tIn level but NOT cells: ",e.getName())})}},function(e,t){var s;s=function(){return this}();try{s=s||new Function("return this")()}catch(e){"object"==typeof window&&(s=window)}e.exports=s},function(e,t){e.exports=function(e){return null!=e&&"object"==typeof e}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Placer=void 0;const r=n(s(0)),a=s(1),o=s(18),i=a.Random.getRNG();class l{static addPropsToFreeCells(e,t){const s=e.getMap().getFree();return l.addPropsToCells(e,s,t)}static addPropsToCells(e,t,s){let n=s.length>0&&t.length>0;for(let a=0;a<s.length;a++)if(t.length>0){const o=i.randIndex(t),l=t[o];r.default.isActor(s[a])?n=n&&e.addActor(s[a],l.getX(),l.getY()):r.default.isItem(s[a])?n=n&&e.addItem(s[a],l.getX(),l.getY()):r.default.isElement(s[a])?n=n&&e.addElement(s[a],l.getX(),l.getY()):r.default.err("Placer","addPropsToCells",`Type ${s[a].getPropType()} not supported`),t.splice(o,1)}return n}static addPropsToRoom(e,t,s){Array.isArray(s)||r.default.err("Placer","addPropsToRoom","props must be an array. Got: "+s);const n=o.BBox.fromBBox(t.getBbox()),a=s[0];return r.default.isActor(a)?l.addActorsToBbox(e,n,s):r.default.isItem(a)?l.addItemsToBbox(e,n,s):(r.default.err("Placer","addPropsToRoom","Prop type not supported: "+a),!1)}static addActorsToBbox(e,t,s){let n=s.length;const a=e.getMap().getFreeInBbox(t);return a.length<n&&r.default.warn("Placer","addActorsToBbox",`No ${n} free cells. Placing only ${a.length} actors`),n=a.length,l.addPropsToCells(e,a,s)}static addActorsToCoord(e,t,s){let n=s.length;const a=e.getMap().getCellsWithCoord(t);return a.length<n&&r.default.warn("Placer","addActorsToBbox",`No ${n} free cells. Placing only ${a.length} actors`),n=a.length,l.addPropsToCells(e,a,s)}static addItemsToBbox(e,t,s){const n=e.getMap().getFreeInBbox(t);return l.addPropsToCells(e,n,s)}static addEntityToCellType(e,t,s){let n=!1;const a=t.getMap().getCells(s);if(0===a.length)return!1;const o=i.arrayGetRand(a),[l,c]=o.getXY();return r.default.isActor(e)?n=t.addActor(e,l,c):r.default.isItem(e)?n=t.addItem(e,l,c):r.default.isElement(e)&&(n=t.addElement(e,l,c)),n}static findCellArea(e,t,s,n,r=0){const{cols:a,rows:i}=e;let[l,c]=[r,r];const u=[],h={},d=(o,l,c)=>{for(let u=o;u<o+t;u++){if(!(u<a-r))return!1;for(let t=l;t<l+s;t++){if(!(t<i-r))return!1;if(h[u+","+t])return!1;if(!n(e.getCell(u,t)))return!1;c.push([u,t])}}return c.forEach(e=>{h[e[0]+","+e[1]]=!0}),!0};let f=!1,g=[];for(;!f;){if(g=[],f=d(l,c,g),f){const e=new o.BBox(l,c,l+t-1,c+s-1);u.push(e)}if(u.length<5&&(f=!1),!f&&(++l,l===a-r&&(l=r,++c),c===i-r))break}return u}}t.Placer=l},function(e,t){var s,n,r=e.exports={};function a(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function i(e){if(s===setTimeout)return setTimeout(e,0);if((s===a||!s)&&setTimeout)return s=setTimeout,setTimeout(e,0);try{return s(e,0)}catch(t){try{return s.call(null,e,0)}catch(t){return s.call(this,e,0)}}}!function(){try{s="function"==typeof setTimeout?setTimeout:a}catch(e){s=a}try{n="function"==typeof clearTimeout?clearTimeout:o}catch(e){n=o}}();var l,c=[],u=!1,h=-1;function d(){u&&l&&(u=!1,l.length?c=l.concat(c):h=-1,c.length&&f())}function f(){if(!u){var e=i(d);u=!0;for(var t=c.length;t;){for(l=c,c=[];++h<t;)l&&l[h].run();h=-1,t=c.length}l=null,u=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===o||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function g(e,t){this.fun=e,this.array=t}function p(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var s=1;s<arguments.length;s++)t[s-1]=arguments[s];c.push(new g(e,t)),1!==c.length||u||i(f)},g.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=p,r.addListener=p,r.once=p,r.off=p,r.removeListener=p,r.removeAllListeners=p,r.emit=p,r.prependListener=p,r.prependOnceListener=p,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorldShop=t.WorldTop=t.BattleZone=t.CityQuarter=t.City=t.MountainSummit=t.MountainFace=t.Mountain=t.Area=t.AreaTile=t.Dungeon=t.Branch=t.SubZoneBase=t.ZoneBase=t.WorldBase=t.edgeHasConnections=t.addExitsToEdge=t.World=void 0;const i=s(5)("bitn:world"),l=o(s(0)),c=a(s(7)),u=s(12),h=s(1),d=s(19),f=a(s(2)),g=s(92),p=s(25),m=u.EventPool.getPool(),y=c.ElementStairs;t.World={};const _=h.Random.getRNG(),b={east:"west",north:"south",south:"north",west:"east"};function v(e,t,s){const n=e.getMap().getCell(t,s);if(n.hasConnection()){const r=n.getConnection();i(`world.js Removing conn@${t},${s}`),e.removeElement(r,t,s)||l.default.err("world.ts","removeExistingConnection",`Failed to remove conn @ ${t}, ${s}`)}}function E(e,t,s){const n=t.find(t=>t.getName()===e);if(n){const t=n.getLevels();if(t.length>s)return t[s];{const n="Name: "+e;l.default.err("world.js","findLevel",`${n} nLev ${s} out of bounds (${t.length-1})`)}}return null}function S(e){let t=e.getFreeRandCell();for(;t.hasConnection();)t=e.getFreeRandCell();return t}function w(e){const t=e.length,s=[],n=[];for(let r=0;r<t;r++){const a=e[r];let o=null;if(a.hasExtras()&&(o=a.getExtras()),r<t-1){const t=e[r+1],n=new y("stairsDown",a,t),i=S(a);let[l,c]=[i.getX(),i.getY()];o&&o.endPoint&&([l,c]=o.endPoint),a.addStairs(n,l,c),s.push(n)}if(r>0){const t=e[r-1],s=new y("stairsUp",a,t),i=S(a);let[l,c]=[i.getX(),i.getY()];o&&o.startPoint&&([l,c]=o.startPoint),a.addStairs(s,l,c),n.push(s)}}for(let e=0;e<t;e++)e<t-1&&s[e].connect(n[e])}function C(e,t,s){let n=t,r=s;if("string"==typeof t&&"string"==typeof s){const a=e.find(e=>e.getName()===t),o=e.find(e=>e.getName()===s);a&&o?(n=a,r=o):l.default.err("world.ts","getSubZoneArgs",`No sub-zones found for ${t} and ${s}`)}return[n,r]}t.addExitsToEdge=(e,t="passage",s="any",n=!1)=>{const r=e.getMap(),a=r.cols,o=r.rows,i=[];for(let l=1;l<o-1;l++){if(("any"===s||"west"===s)&&(r.isPassable(0,l,1,l)||n)){const s=new y(t,e);v(e,0,l),n?e.addStairs(s,0,l):e.addElement(s,0,l),i.push(s)}if(("any"===s||"east"===s)&&(r.isPassable(a-1,l,a-2,l)||n)){const s=new y(t,e);v(e,a-1,l),n?e.addStairs(s,a-1,l):e.addElement(s,a-1,l),i.push(s)}}for(let l=1;l<a-1;l++){if(("any"===s||"north"===s)&&(r.isPassable(l,0,l,1)||n)){const s=new y(t,e);v(e,l,0),n?e.addStairs(s,l,0):e.addElement(s,l,0),i.push(s)}if(("any"===s||"south"===s)&&(r.isPassable(l,o-1,l,o-2)||n)){const s=new y(t,e);v(e,l,o-1),n?e.addStairs(s,l,o-1):e.addElement(s,l,o-1),i.push(s)}}return i},t.edgeHasConnections=(e,t)=>{const s=e.getMap(),n=s.cols,r=s.rows;for(let e=1;e<r-1;e++){if(("any"===t||"west"===t)&&s.getCell(0,e).hasConnection())return!0;if(("any"===t||"east"===t)&&s.getCell(n-1,e).hasConnection())return!0}for(let e=1;e<n-1;e++){if(("any"===t||"north"===t)&&s.getCell(e,0).hasConnection())return!0;if(("any"===t||"south"===t)&&s.getCell(e,r-1).hasConnection())return!0}return!1},t.World.connectLevelsLinear=w,t.World.addExitsToEdge=t.addExitsToEdge,t.World.edgeHasConnections=t.edgeHasConnections;class T extends p.Entity{constructor(e){super(),this.name=e,this.type="base",this.parent=null}getName(){return this.name}getHierName(){return this.hierName}setHierName(e){this.hierName=e}getType(){return this.type}setType(e){this.type=e}getParent(){return this.parent}setParent(e){this.parent=e}toJSON(){const e={hierName:this.hierName,id:this.getID(),name:this.name,type:this.type};return this.parent&&(e.parent=this.parent.getID()),e.components=f.compsToJSON(this),e}}t.WorldBase=T,t.World.Base=T;class O extends T{constructor(e){super(e),this._subZones=[]}getSubZoneArgs(e,t){return C(this._subZones,e,t)}setTileXY(e,t){this.tileX=e,this.tileY=t}getTileXY(){return[this.tileX,this.tileY]}addSubZone(e){return e.getID()===this.getID()&&l.default.err("ZoneBase","addSubZone","Tried to add itself as sub zone: "+this.getName()),!l.default.isNullOrUndef([e])&&(e.setParent(this),this._subZones.push(e),!0)}hasSubZone(e){return this._subZones.indexOf(e)>=0}getLevels(){let e=[];return this._subZones.forEach(t=>{e=e.concat(t.getLevels())}),e}getPlaceEntities(){const e=[this];return this._subZones.forEach(t=>{e.push(t)}),e}connectSubZones(e,t,s,n){!function(e,t,s,n,r){l.default.isNullOrUndef([n,r])&&l.default.err("World","connectSubZones",`l1 (${n}) and l2 (${r}) must be non-null and integers.`);const[a,o]=C(e,t,s);l.default.isNullOrUndef([a,o])&&l.default.err("World","connectSubZones","Cannot connect null subZones. Check the names/refs.");let i=!0;n>r&&(i=!1);const c=new y(i?"stairsDown":"stairsUp"),u=o.getLevels();if(r<u.length){const e=S(u[r]);u[r].addStairs(c,e.getX(),e.getY()),c.setSrcLevel(u[r]),a.connectLevelToStairs(n,c)}else l.default.err("World","connectSubZones","Level "+r+" doesn't exist in sub-zone "+o.getName())}(this._subZones,e,t,s,n)}findLevel(e,t){return E(e,this._subZones,t)}findSubZone(e){return function(e,t){return t.find(t=>t.getName()===e)}(e,this._subZones)}getEntrances(){const e=[];return this._subZones.forEach(t=>{const s=t.getEntrance();s&&e.push(s)}),e}removeListeners(){this._subZones.forEach(e=>{e.removeListeners()})}toJSON(){const e=super.toJSON();return e.x=this.tileX,e.y=this.tileY,e}getID2Place(){const e={[this.getID()]:this};return this._subZones.forEach(t=>{e[t.getID()]=t}),e}}t.ZoneBase=O,t.World.ZoneBase=O;class A extends T{constructor(e){super(e),this._levelFeatures=new Map,this._levels=[],this._levelCount=0,this._entrance=null}getEntrance(){return function(e,t){if(null===t)return null;const{x:s,y:n}=t;return e[t.levelNumber].getMap().getCell(s,n).getStairs()}(this._levels,this._entrance)}setEntranceLocation(e){l.default.isNullOrUndef([e])?l.default.err("SubZoneBase","setEntranceLocation","Arg |entrance| is null/undef."):this._entrance=e}getLevelN(e){if(e<this._levels.length)return this._levels[e];{const t=this._levels.length;l.default.err("SubZoneBase","getLevels",`No nLevel ${e} found. Max: ${t}`)}return null}getLevels(){return this._levels.slice()}hasLevel(e){return this._levels.indexOf(e)>=0}connectLevelToStairs(e,t){(function(e,t,s){if(t<e.length){const n=e[t],r=s.getSrcLevel();if(!l.default.isNullOrUndef([r])){const e=!s.isDown(),t=new y(e?"stairsDown":"stairsUp",n,r),a=S(n);return n.addStairs(t,a.getX(),a.getY()),t.connect(s),!0}}else l.default.err("world.js","connectLevelToStairs",`nLevel: ${t} out of bounds (${e.length})`);return!1})(this._levels,e,t)||l.default.err("SubZoneBase","connectLevelToStairs","Stairs must be first connected to other level.")}getStairsOther(){return function(e,t){const s=[];return t.forEach(t=>{t.getStairs().forEach(t=>{const n=t.getTargetLevel();if(n&&n.getParent){const r=n.getParent();r&&r.getName()!==e&&s.push(t)}})}),s}(this.getName(),this._levels)}addLevelFeature(e){const t=e.getType();this._levelFeatures.has(t)||(this._levelFeatures[t]=[]),this._levelFeatures[t].push(e)}removeListeners(){}getLevel(e){if(e<this._levels.length)return this._levels[e];{const t=`${this.getType()}, ${this.getName()}`,s=`Has ${this._levels.length} levels`;l.default.err("SubZoneBase","getLevel",`${t}, nLevel: ${e}, ${s}`)}return null}addLevel(e){if(l.default.isNullOrUndef([e]))l.default.err("SubZoneBase","addLevel","Level is not defined.");else if(this.hasLevel(e)){let t="Trying to add existing level. ";t+=" ID: "+e.getID(),l.default.err("SubZoneBase","addLevel",t)}else e.setLevelNumber(this._levelCount++),this._levels.push(e),e.setParent(this)}toJSON(){const e=super.toJSON();return e.nLevels=this._levels.length,e.levels=this._levels.map(e=>e.getID()),this._entrance&&(e.entrance=this._entrance),e}}t.SubZoneBase=A,t.World.SubZoneBase=A;class M extends A{constructor(e){super(e),this.setType("branch")}addEntrance(e){const t=new y("stairsUp");this.setEntrance(t,e)}setEntrance(e,t){if(t<this._levels.length){const s=this._levels[t],n=S(s);let[r,a]=n.getXY();if(s.hasExtras()){const e=s.getExtras();if(e.startPoint){[r,a]=e.startPoint;if(s.getMap().getCell(r,a).hasConnection()){let t=`@${r},${a} already has connection. `;t+=`start: ${e.startPoint} end: ${e.endPoint}`,l.default.err("Branch","setEntrance",t)}}}s.addStairs(e,r,a),this._entrance={levelNumber:t,x:r,y:a}}else l.default.err("World.Branch","setEntrance","Invalid level number. Must be < "+this._levels.length)}connectLevels(){w(this._levels)}}t.Branch=M,t.World.Branch=M;class N extends O{constructor(e){super(e),this.setType("dungeon"),this._entranceNames=[]}hasBranch(e){return this.hasSubZone(e)}getBranches(){return this._subZones}setEntrance(e){this._entranceNames="string"==typeof e?[e]:e}addBranch(e){return!this.hasBranch(e)&&(this._subZones.push(e),e.setParent(this),1===this._subZones.length&&this.setEntrance(e.getName()),!0)}getEntrances(){const e=[],t=this._subZones.length;for(let s=0;s<t;s++){const t=this._subZones[s];if(this._entranceNames.indexOf(t.getName())>=0){const s=t.getEntrance();l.default.isNullOrUndef([s])||e.push(s)}}return e}toJSON(){const e=super.toJSON(),t={branch:this._subZones.map(e=>e.toJSON()),entranceNames:this._entranceNames,nBranches:this._subZones.length};return Object.assign(t,e)}}t.Dungeon=N,t.World.Dungeon=N;class P{constructor(e,t,s){this._tileX=e,this._tileY=t,this._area=s,this.cols=null,this.rows=null,this._level=null,this.zones={Dungeon:[],Mountain:[],City:[],BattleZone:[]}}getLevel(){return this._level}getTileX(){return this._tileX}getTileY(){return this._tileY}isNorthEdge(){return 0===this._tileY}isSouthEdge(){return this._tileY===this._area.getSizeY()-1}isWestEdge(){return 0===this._tileX}isEastEdge(){return this._tileX===this._area.getSizeX()-1}isEdge(){return!!this.isNorthEdge()||(!!this.isSouthEdge()||(!!this.isWestEdge()||!!this.isEastEdge()))}setLevel(e){this._level=e,this.cols=this._level.getMap().cols,this.rows=this._level.getMap().rows}connect(e,t){const s=this.cols-1,n=this.rows-1;if(e){const t=e.getLevel(),r=this._level.getMap(),a=t.getMap();for(let e=1;e<=n-1;e++){const n=r.getCell(s,e),o=a.getCell(0,e);if(n.isFree()&&o.isFree()){const n=new y("passage",this._level,t),r=new y("passage",t,this._level);n.setTargetStairs(r),r.setTargetStairs(n),this._level.addStairs(n,s,e),t.addStairs(r,0,e)}}}if(t){const e=t.getLevel(),r=this._level.getMap(),a=e.getMap();for(let t=1;t<=s-1;t++){const s=r.getCell(t,n),o=a.getCell(t,0);if(s.isFree()&&o.isFree()){const s=new y("passage",this._level,e),r=new y("passage",e,this._level);s.setTargetStairs(r),r.setTargetStairs(s),this._level.addStairs(s,t,n),e.addStairs(r,t,0)}}}}addZone(e,t){l.default.isNullOrUndef([t.tileX,t.tileY])&&l.default.err("AreaTile","addZone","No tileX/tileY given!"),this.zones[e]||(this.zones[e]=[]),this.zones[e].push(t)}getZones(e){if(e)return this.zones[e];let t=[];return Object.keys(this.zones).forEach(e=>{t=t.concat(this.zones[e])}),t}getLevels(){let e=[this._level];if(Object.keys(this.zones).forEach(t=>{this.zones[t].forEach(t=>{e=e.concat(t.getLevels())})}),i.enabled){let t=this.toString();t=` Tile ${t} has ${e.length} levels from toJSON()`,1344===this._level.getID()&&(t+="\tLevels: "+e.map(e=>e.getID())),console.error(t)}return e}getPlaceEntities(){let e=[];return Object.keys(this.zones).forEach(t=>{this.zones[t].forEach(t=>{e=e.concat(t.getPlaceEntities())})}),e}toString(){let e=`${this._tileX},${this._tileY}, ID: ${this._level.getID()}`;return e+=" nZones: "+this.getZones().length,e}toJSON(){return{isJSON:!0,x:this._tileX,y:this._tileY,level:this._level.getID(),levels:this.getLevels().map(e=>e.toJSON()),nDungeons:this.zones.Dungeon.length,dungeon:this.getZones("Dungeon").map(e=>e.toJSON()),nMountains:this.zones.Mountain.length,mountain:this.getZones("Mountain").map(e=>e.toJSON()),nCities:this.zones.City.length,city:this.getZones("City").map(e=>e.toJSON()),nBattleZones:this.zones.BattleZone.length,battlezone:this.getZones("BattleZone").map(e=>e.toJSON())}}removeListeners(){Object.values(this.zones).forEach(e=>{e.forEach(e=>{e.removeListeners()})})}}t.AreaTile=P,t.World.AreaTile=P;class D extends T{constructor(e,t,s,n,r,a){super(e),this.setType("area"),this._sizeX=parseInt(t,10),this._sizeY=parseInt(s,10),this._cols=n||30,this._rows=r||30,this._tiles=[],this._conf=this.createAreaConfig(),this.zonesCreated={},this.tileStatus=[],this._init(a)}getSizeX(){return this._sizeX}getSizeY(){return this._sizeY}isLoaded(e,t){return this.tileStatus[e][t]===g.LoadStat.LOADED}isJSON(e,t){return this.tileStatus[e][t]===g.LoadStat.JSON}isOnDisk(e,t){return this.tileStatus[e][t]===g.LoadStat.ON_DISK}setLoaded(e,t){this.tileStatus[e][t]=g.LoadStat.LOADED}setUnloaded2JSON(e,t){this.tileStatus[e][t]=g.LoadStat.JSON}setOnDisk(e,t,s){this.setTile(e,t,s),this.tileStatus[e][t]=g.LoadStat.ON_DISK}markAllZonesCreated(){Object.keys(this.zonesCreated).forEach(e=>{this.zonesCreated[e]=!0})}markTileZonesCreated(e,t){this.zonesCreated[e+","+t]=!0}tileHasZonesCreated(e,t){return this.zonesCreated[e+","+t]}getTiles(){return this._tiles}setTile(e,t,s){this._tiles[e][t]=s}setConf(e){e?this._conf=e:l.default.err("World.Area","setConf","Null/undef conf was set")}getConf(){return this._conf}_init(e){for(let t=0;t<this._sizeX;t++){const s=[];this.tileStatus.push([]);for(let n=0;n<this._sizeY;n++){this.zonesCreated[t+","+n]=!1;const r=new P(t,n,this),a=l.default.getForestConf(this._cols,this._rows);let o=null;if(e)o=e[t][n];else{o=(new d.FactoryLevel).createLevel("forest",this._cols,this._rows,a)}o!==l.default.LEVEL_NOT_LOADED?(this.tileStatus[t][n]=g.LoadStat.LOADED,o.setParent(this),r.setLevel(o),s.push(r)):(this.tileStatus[t][n]=g.LoadStat.JSON,s.push(l.default.TILE_NOT_LOADED))}this._tiles.push(s)}e||this.connectTiles()}connectTiles(){!function(e,t,s){1!==t&&1!==s||l.default.err("world.js","connectTiles","sizeX or sizeY == 1 not implemented.");for(let n=0;n<t;n++)for(let r=0;r<s;r++)i(`Trying to connect tile ${n},${r} now`),n<t-1&&r<s-1?(i(`>> Connecting tile ${n},${r} now`),e[n][r].connect(e[n+1][r],e[n][r+1])):n<t-1?(i(`>> Connecting tile ${n},${r} now`),e[n][r].connect(e[n+1][r],null)):r<s-1&&(i(`>> Connecting tile ${n},${r} now`),e[n][r].connect(null,e[n][r+1]))}(this._tiles,this._sizeX,this._sizeY)}getLevels(){let e=[];for(let t=0;t<this._tiles.length;t++)for(let s=0;s<this._tiles[t].length;s++)this.isLoaded(t,s)&&(e=e.concat(this._tiles[t][s].getLevels()));return e}findTileXYById(e){for(let t=0;t<this._tiles.length;t++)for(let s=0;s<this._tiles[t].length;s++)if(this.isLoaded(t,s)){const n=this._tiles[t][s].getLevel().getID();try{if(n===e)return[t,s]}catch(e){let n=`Area ${this.getID()} ERROR`;throw n+=`\nFailed to call getLevel for tile ${t},${s}`,n+="Tile as JSON: ', this._tiles[x][y]",console.error(n),new Error(e)}}return this.printLevelIDs(),null}hasTileWithId(e){for(let t=0;t<this._tiles.length;t++)for(let s=0;s<this._tiles[t].length;s++)if(this.isLoaded(t,s)){if(this._tiles[t][s].getLevel().getID()===e)return!0}else if(this.isJSON(t,s)){if(this._tiles[t][s].level===e)return!0}else if(this._tiles[t][s].level===e)return!0;return!1}hasTiles(e){let t=e.length>0;return e.forEach(e=>{if("function"==typeof e.getID)t=t&&this.hasTileWithId(e.getID());else if(Number.isInteger(e))t=t&&this.hasTileWithId(e);else{const t=JSON.stringify(e);l.default.err("Area","hasTiles",`Invalid level given ${t}. Must be Map.Level/ID`)}}),t}getTileXY(e,t){if(e>=0&&e<this.getSizeX()&&t>=0&&t<this.getSizeY())return this._tiles[e][t];{const s=this.getSizeX(),n=this.getSizeY();l.default.err("Area","getTileXY",`Tile x,y (${e}, ${t}) is out of bounds (${s}, ${n}).`)}return null}addZone(e,t){if(l.default.isNullOrUndef([t.tileX,t.tileY])&&l.default.err("Area","addZone","No tileX/tileY given!"),this.isLoaded(t.tileX,t.tileY))this._tiles[t.tileX][t.tileY].addZone(e,t),t.setParent(this);else{const[e,s]=[t.tileX,t.tileY];l.default.err("Area","addZone",`Tried to add zone@${e},${s} to unloaded/onDisk tile`)}}getZones(e){let t=[];for(let s=0;s<this._tiles.length;s++)for(let n=0;n<this._tiles[s].length;n++)if(this.isLoaded(s,n)){const r=this._tiles[s][n];t=t.concat(r.getZones(e))}return t}createAreaConfig(){return{name:this.getName(),maxX:this._sizeX,maxY:this._sizeY,cols:this._cols,rows:this._rows,city:[],dungeon:[],mountain:[]}}toJSON(){const e=super.toJSON(),t=[];this._tiles.forEach((e,s)=>{const n=e.map((e,t)=>this.isLoaded(s,t)?e.toJSON():e);t.push(n)});const s={isJSON:!0,conf:this.getConf(),maxX:this._sizeX,maxY:this._sizeY,cols:this._cols,rows:this._rows,tiles:t,tileStatus:this.tileStatus,zonesCreated:this.zonesCreated};return s.conf||l.default.err("World.Area","toJSON","Null conf in Area"),Object.assign(s,e)}forEachTileLoaded(e){for(let t=0;t<this._tiles.length;t++)for(let s=0;s<this._tiles[t].length;s++)this.isLoaded(t,s)&&e(t,s,this._tiles[t][s])}forEachTile(e){for(let t=0;t<this._tiles.length;t++)for(let s=0;s<this._tiles[t].length;s++)e(t,s,this._tiles[t][s])}getPlaceEntities(){let e=[this];return this.forEachTileLoaded((t,s,n)=>{e=e.concat(n.getPlaceEntities())}),e}printLevelIDs(){const e=[];this.forEachTile((t,s,n)=>{if(this.isLoaded(t,s)){const n=this._tiles[t][s];e.push(n.getLevel().getID())}else if(this.isJSON(t,s)){const n=this._tiles[t][s];e.push(n.level)}})}printDebugInfo(){const e=[],t=[],s=[];this.forEachTile((n,r,a)=>{a.isJSON?e.push([n,r]):this.isLoaded(n,r)?t.push([n,r]):s.push([n,r])});let n=`Area ID ${this.getID()} debug info:\n`;n+="\t\nTiles as JSON: "+e.join(" | "),n+="\t\nTiles LOADED: "+t.join(" | "),n+="\t\nTiles OTHER: "+s.join(" | "),this.printLevelIDs(),console.log(n)}}t.Area=D,t.World.Area=D;class I extends O{constructor(e){super(e),this.setType("mountain")}findLevel(e,t){const s=this.getFaces(),n=this.getSummits();let r=E(e,s,t);return r||(r=E(e,n,t)),r}addSummit(e){this.addSubZone(e)}addFace(e){this.addSubZone(e)}getFaces(){return this._subZones.filter(e=>"face"===e.getType())}getSummits(){return this._subZones.filter(e=>"summit"===e.getType())}connectFaceAndSummit(e,t,s,n){const[r,a]=this.getSubZoneArgs(e,t);if("summit"!==a.getType()){const e=a.getType();l.default.err("World.Mountain","connectFaceAndSummit","Expected 2nd arg summit, got: "+e)}!function(e,t){const s=e.level,n=t.level;let r=Math.floor(s.getMap().cols/2),a=e.y();const o=s.getMap();let i=o.getCell(r,a);for(;i.hasConnection();)r+=1,r===o.cols&&(r=0,a>0&&--a),i=o.getCell(r,a);const l=S(n),[c,u]=[l.getX(),l.getY()],h=new y("stairsUp",s,n),d=new y("stairsDown",n,s);h.connect(d),s.addStairs(h,r,a),n.addStairs(d,c,u)}({y:()=>0,level:r.getLevelN(s)},{level:a.getLevelN(n)})}connectSubZones(e,t,s,n){const[r,a]=this.getSubZoneArgs(e,t);if("face"===r.getType()){if("summit"===a.getType())return void this.connectFaceAndSummit(r,a,s,n)}else if("summit"===r.getType()&&"face"===a.getType())return void this.connectFaceAndSummit(a,r,n,s);super.connectSubZones(e,t,s,n)}toJSON(){const e=super.toJSON(),t={nFaces:this.getFaces().length,face:this.getFaces().map(e=>e.toJSON()),nSummits:this.getSummits().length,summit:this.getSummits().map(e=>e.toJSON())};return Object.assign(t,e)}}t.Mountain=I,t.World.Mountain=I;class L extends A{constructor(e){super(e),this.setType("face")}setEntrance(e){this._entrance=e}addEntrance(e){if(null===this._entrance){const t=this._levels[e],s=new y("stairsDown",t),n=t.getMap(),r=Math.floor(n.cols/2);let a=r,o=n.rows-1;for(;!n.getCell(a,o).isFree();)0===a&&(a=r+1),a<=r&&--a,a>r&&++a,a===n.cols-1&&(a=r,--o);t.addStairs(s,a,o),this._entrance={levelNumber:e,x:a,y:o}}else l.default.err("MountainFace","addEntrance","Entrance already added.")}}t.MountainFace=L,t.World.MountainFace=L;class x extends A{constructor(e){super(e),this.setType("summit")}getEntrance(){return null}addEntrance(e){if(null===this._entrance){const t=this._levels[e],s=new y("stairsDown",t),n=t.getMap(),r=Math.floor(n.cols/2),a=n.rows-1;t.addStairs(s,r,a)&&(this._entrance={levelNumber:e,x:r,y:a})}}}t.MountainSummit=x,t.World.MountainSummit=x;class k extends O{constructor(e){super(e),this.setType("city")}getQuarters(){return this._subZones}abutQuarters(e,s,n,r){return function(e,s,n,r,a){const o=_.arrayGetRand(["north","south","east","west"]),i=b[o],[c,u]=C(e,s,n);l.default.isNullOrUndef([r,a])&&l.default.err("World","connectSubZonesEdges",`l1 (${r}) and l2 (${a}) must be non-null and integers.`);const h=c.getLevel(r),d=u.getLevel(a);h||l.default.err("world.ts","connectSubZoneEdges",`No level |${r}| in subzone ${JSON.stringify(c)}`),d||l.default.err("world.ts","connectSubZoneEdges",`No level |${a}| in subzone ${JSON.stringify(u)}`);const f=t.addExitsToEdge(h,"exit",o,!0),g=t.addExitsToEdge(d,"exit",i,!0);if(0===f.length||0===g.length)return!1;const p=f,m=g,y=p.length,v=m.length,E=y<=v?y:v;for(let e=0;e<E;e++)p[e].connect(m[e]);return!0}(this._subZones,e,s,n,r)}toJSON(){const e=super.toJSON(),t={nQuarters:this._subZones.length,quarter:this._subZones.map(e=>e.toJSON())};return Object.assign(t,e)}}t.City=k,t.World.City=k;class R extends A{constructor(e){super(e),this.setType("quarter"),this._shops=[]}removeListeners(){this._shops.forEach(e=>{e.isAbandoned()||m.removeListener(e)})}addShop(e){this._shops.push(e)}getShops(){return this._shops}addEntrance(e){if(null===this._entrance){const t=this._levels[e],s=new y("stairsDown",t);t.addStairs(s,1,1),this._entrance={levelNumber:e,x:1,y:1}}else l.default.err("CityQuarter","addEntrance","Entrance already added.")}connectLevels(){w(this._levels)}toJSON(){const e=super.toJSON(),t={shops:this._shops.map(e=>e.toJSON())};return Object.assign(t,e)}}t.CityQuarter=R,t.World.CityQuarter=R;class B extends O{constructor(e){super(e),this.setType("battlezone"),this._levels=[]}setBattle(e){this._battle=e,e.setParent(this)}getBattle(){return this._battle}addLevel(e){this._levels.push(e)}getLevels(){return this._levels}toJSON(){const e=super.toJSON(),t=this._levels.length,s={nLevels:t,levels:this._levels.map(e=>e.getID())};return 0===t&&l.default.err("World.BattleZone","toJSON",`Bz ${this.getName()} called without levels`),Object.assign(s,e)}}t.BattleZone=B,t.World.BattleZone=B;class F extends T{constructor(e){super(e),this.setType("world"),this._areas=[],this.currAreaIndex=0,this._conf={name:e,area:[],nAreas:0}}getConf(){return this._conf}setConf(e){this._conf=e}addArea(e){e.setParent(this),this._areas.push(e)}getLevels(){let e=[];return this._areas.map(t=>{e=e.concat(t.getLevels())}),e}getAreas(){return this._areas}getZones(e){let t=[];return this._areas.forEach(s=>{t=t.concat(s.getZones(e))}),t}findZone(e){return this.getZones().filter(e)}getStairs(){const e=[];return this.getZones().forEach(t=>t.getLevels().forEach(t=>t.getStairs().forEach(t=>e.push(t)))),e}getPlaceEntities(){let e=[this];return this._areas.map(t=>{e=e.concat(t.getPlaceEntities())}),e}getCurrentArea(){return this._areas[this.currAreaIndex]}toJSON(){const e=super.toJSON(),t=this._areas.map(e=>e.toJSON());let s=!0;this.getConf().hasOwnProperty("createAllZones")&&(s=!!this.getConf().createAllZones);const n={conf:this.getConf(),nAreas:this._areas.length,area:t,createAllZones:s};return n.conf.area||(n.conf.area=this.createAreaConfig()),Object.assign(n,e)}createAreaConfig(){const e=[];return this._areas.forEach(t=>{e.push(t.createAreaConfig())}),e}getID2Place(){let e={[this.getID()]:this};this._areas.forEach(t=>{e[t.getID()]=t});return this.getZones().forEach(t=>{e[t.getID()]=t;const s=t.getID2Place();e=Object.assign(e,s)}),e}}t.WorldTop=F,t.World.WorldTop=F;class G{constructor(){this._shopkeeper=null,this._level=null,this._coord=[],this._isAbandoned=!1,this.hasNotify=!0}setLevel(e){this._level=e}setCoord(e){this._coord=e}isAbandoned(){return this._isAbandoned}notify(e,t){this._shopkeeper&&t.actor.getID()===this._shopkeeper.getID()&&(this.setShopAbandoned(),m.removeListener(this))}getLevel(){return this._level}getShopkeeper(){return this._shopkeeper}setShopkeeper(e){e?(this._shopkeeper=e,m.listenEvent(l.default.EVT_ACTOR_KILLED,this)):l.default.err("WorldShop","setShopkeeper","Tried to set null shopkeeper")}setShopAbandoned(){this._isAbandoned=!0,this._shopkeeper=null,this._coord.forEach(e=>{const t=this.getCell(e);t.getShop().abandonShop();const s=t.getItems();s&&s.forEach(e=>{e.has("Unpaid")&&e.remove("Unpaid")})})}getCell(e){return this._level.getMap().getCell(e[0],e[1])}reclaimShop(e){this._isAbandoned&&(this._isAbandoned=!1,this.setShopkeeper(e),this._coord.forEach(t=>{const s=this.getCell(t);s.getShop().reclaim(e);const n=s.getItems();n&&n.forEach(e=>{e.has("Unpaid")||e.add(new f.Unpaid)})}))}emptyCells(){const e=[];return this._coord.forEach(t=>{const s=this._level.getMap().getCell(t[0],t[1]);s.hasItems()||e.push(s)}),e}refreshShopItems(e){let t=0;this._coord.forEach(s=>{this._level.getMap().getCell(s[0],s[1]).hasItems()||t<e.length&&(e[t].add(new f.Unpaid),this._level.addItem(e[t],s[0],s[1]),++t)})}toJSON(){const e={isAbandoned:this._isAbandoned,level:this._level.getID(),coord:this._coord};return this._isAbandoned||(e.shopkeeper=this._shopkeeper.getID()),e}}t.WorldShop=G,t.World.WorldShop=G,t.World.isZone=function(e){if(e.getType){const t=e.getType();return/(city|battlezone|mountain|dungeon)/.test(t)}return!1}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LevelGenerator=void 0;const r=n(s(0)),a=s(7);t.LevelGenerator=class{constructor(){this.shouldRemoveMarkers=!0,this._debug=!1}static getOptions(){return{addActors:!1,actorFunc:e=>e.danger<=5,addItems:!0,cellsAround:{N:"wallmount",S:"tree",E:"grass",W:"snow",NW:"water",SE:"water"},surroundX:10,surroundY:10,maxValue:100,maxDanger:5,shouldRemoveMarkers:!0,preserveMarkers:!1}}addStartAndEndPointMarker(e,t,s){if(t){const[s,n]=t,r=new a.ElementMarker("<");r.setTag("start_point"),e.addElement(r,s,n)}else r.default.err("LevelGenerator","addStartAndEndPointMarker","start point coord not defined");if(s){const[t,n]=s,r=new a.ElementMarker(">");r.setTag("end_point"),e.addElement(r,t,n)}}markersToDoor(e){const t=e.getMap(),s=t.getCells(e=>e.hasElements()),n=[];return s.forEach(s=>{if(s.hasMarker("door")){const[o,i]=s.getXY(),l=new a.ElementDoor(!0);t.getCell(o,i).removeProps(r.default.TYPE_ELEM),e.addElement(l,o,i),n.push([o,i])}}),n}removeOneMarkerType(e,t,s){const n=e.getMap().getCells(e=>e.hasElements()),r=[];return n.forEach(n=>{if(n.hasMarker(s)){n.getMarkers().forEach(s=>{if(s.getChar()===t){const[t,n]=s.getXY();e.removeElement(s,t,n),r.push([t,n])}})}}),r}removeMarkers(e,t){let s=0,n=["start_point","end_point","critical_path"];return t.markersPreserved?n=n.concat(t.markersPreserved):!1===t.markersPreserved&&(n=[]),r.default.isNullOrUndef([t.shouldRemoveMarkers])||(this.shouldRemoveMarkers=t.shouldRemoveMarkers),this.shouldRemoveMarkers&&e.removeElements(e=>{if(e.getTag){const t=e.getTag();if(n.indexOf(t)<0)return++s,!0}return!1}),s}}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MapGenerator=void 0;const i=o(s(0)),l=o(s(416)),c=s(35),u=s(10),h=s(62),d=s(4),f=a(s(7)),g=s(210),p=s(1),m=s(212),y=s(211),_=s(90),b=s(460),v=s(8),E=s(461),S=(l.default,f.ElementMarker),w=p.Random.getRNG(),C=function(e,t,s){return e>=t&&e<=s},T=function(e,t,s,n,r){let a=!0;if(r.exclude){if(r.exclude.bbox){const{ulx:o,uly:i,lrx:l,lry:c}=r.exclude.bbox;C(e,o,l)&&C(t,i,c)&&(a=!1),C(s,o,l)&&C(n,i,c)&&(a=!1)}}else r.maxY&&(a=n<=r.maxY);return a};class O{constructor(){this.cols=i.default.LEVEL_MEDIUM_X,this.rows=i.default.LEVEL_MEDIUM_Y,this._mapGen=new l.default.Arena(this.cols,this.rows),this._mapType=null,this._wallID=1,this.defaultMapElem=v.ELEM.FLOOR}static getAndSetRNG(e){if(e){if(e.rng)return e.rng;e.rng=w}return w}static addRandomSnow(e,t,s){const n=e.getFree().filter(e=>e.isOutdoors()),r=O.getAndSetRNG(s);let a=0;for(let e=0;e<n.length;e++){const s=r.getUniform(),o=n[e];if(s<=t){const t=o.getBaseElem().getType();if(v.snowElemMap[t]){const s=v.snowElemMap[t];++a,n[e].setBaseElem(s)}}}return a}static fromAsciiMap(e,t){const s=e.length,n=e[0].length,r=new c.CellMap(s,n);for(let a=0;a<s;a++)for(let s=0;s<n;s++){const n=e[a][s];if(t.hasOwnProperty(n)){const e=t[n];"function"!=typeof e?r.setBaseElemXY(a,s,e):e(r,a,s)}else if("+"===n){const e=new S("+");e.setTag("door"),r.setBaseElemXY(a,s,t["."]),r.setElemXY(a,s,e)}else if("?"===n){const e=new S("?");e.setTag("loot"),r.setElemXY(a,s,e)}}return{map:r}}static getWallElem(e){switch(e){case"cave":case"wallcave":return v.ELEM.WALL_CAVE;case"castle":case"wallcastle":return v.ELEM.WALL_CASTLE;case"crypt":case"wallcrypt":return v.ELEM.WALL_CRYPT;case"ice":case"wallice":return v.ELEM.WALL_ICE;case"wooden":case"wallwooden":return v.ELEM.WALL_WOODEN;default:return v.ELEM.WALL}}static getFloorElem(e){switch(e){case"cave":case"floorcave":return v.ELEM.FLOOR_CAVE;case"castle":case"floorcastle":return v.ELEM.FLOOR_CASTLE;case"crypt":case"floorcrypt":return v.ELEM.FLOOR_CRYPT;case"ice":case"floorice":return v.ELEM.FLOOR_ICE;case"wooden":case"floorwooden":return v.ELEM.FLOOR_WOODEN;default:return v.ELEM.FLOOR}}static createSplashes(e,t,s){const n=s.elem||v.ELEM.WATER,r=new c.CellMap(e,t);return new E.MapForest(e,t,s).create((e,t,s)=>{r.setBaseElemXY(e,t,v.ELEM.FLOOR),1===s&&r.setBaseElemXY(e,t,n)}),{map:r}}static getOptions(e){return O.options[e]?Object.assign({},O.options[e]):(i.default.warn("MapGenerator","getOptions","Unknown map type "+e),{})}createEmptyMap(){return{map:new c.CellMap(this.cols,this.rows,this.defaultMapElem)}}getMap(e={}){const t={};if("function"==typeof this._mapGen)t.map=this._mapGen();else{const s=O.getWallElem(e.wallType),n=O.getFloorElem(e.floorType),r=new c.CellMap(this.cols,this.rows,this.defaultMapElem);this._mapGen.create((e,t,a)=>{a===this._wallID?r.setBaseElemXY(e,t,s):r.setBaseElemXY(e,t,n)}),t.map=r,"uniform"!==this._mapType&&"digger"!==this._mapType||(t.rooms=this._mapGen.getRooms(),t.corridors=this._mapGen.getCorridors())}return t}createRuins(e,t,s={}){let n={born:[4,5,6,7,8],survive:[2,3,4,5],connected:!0};n=Object.assign(n,s);const r=new l.default.Cellular(e,t,n);r.randomize(.9);for(let e=0;e<5;e++)r.create();return r.connect(null,1),this._wallID=0,r}createCellular(e,t){const s=new l.default.Cellular(e,t,{});s.randomize(.52);for(let e=0;e<5;e++)s.create();return s.connect(null,1),this._wallID=0,s}createRooms(e,t){return new l.default.Digger(e,t,{roomWidth:[5,20],dugPercentage:.7})}createTownBSP(e,t,s){const n=s.maxHouseX||100,r=s.maxHouseY||100,a=O.getAndSetRNG(s),o=new E.BSP.BSPGen({rng:a}),i=e-2,l=t-2,u=new E.BSP.Container(0,0,i,l),h=o.splitContainer(u,7).getLeafs();h.forEach(e=>{e.x+=1,e.y+=1}),a.shuffle(h);const d=O.getFloorElem(s.floorType),f=new c.CellMap(e,t,d),g=[],p=[],y=new m.HouseGenerator;return h.forEach(a=>{const{w:o,h:i}=a;let l=o-1,c=i-1;if(l>n&&(l=Math.round(l/2)),c>r&&(c=Math.round(c/2)),1===a.x?(a.x+=1,a.w-=1,l-=1):a.x===e-1&&(a.x-=1,a.w-=1,l-=1),1===a.y?(a.y+=1,a.h-=1,c-=1):a.y===t-1&&(a.y-=1,a.h-=1,c-=1),l>=5&&c>=5){l>10&&l%2!=0&&(l-=1),c>10&&c%2!=0&&(c-=1);const e={cols:l,rows:c};e.addWindows=s.addWindows;const t=y.createHouse(e);t&&(this.placeHouse(t,f,a.x,a.y,s),p.push(t))}else g.push(a)}),{map:f,houses:p,unused:g}}placeHouse(e,t,s,n,r){const a=e.coord,o=Object.keys(a),i=O.getWallElem(r.wallType);o.forEach(e=>{"#"===e?a[e].forEach(e=>{const r=e[0]+s,a=e[1]+n;t.setBaseElemXY(r,a,i)}):"+"===e||(":"===e?a[e].forEach(e=>{const r=e[0]+s,a=e[1]+n;t.setBaseElemXY(r,a,v.ELEM.FLOOR_HOUSE)}):"windows"===e&&a[e].forEach(e=>{const r=e[0]+s,a=e[1]+n;t.setBaseElemXY(r,a,v.ELEM.WINDOW)}))}),e.adjustCoord(s,n)}createForest(e){const t=new c.CellMap(this.cols,this.rows,this.defaultMapElem);return this.addForestToMap(t,e),{map:t}}addForestToMap(e,t){const s=t.ratio,{freeOnly:n}=t,r=O.getAndSetRNG(t);this._mapGen=new E.MapForest(this.cols,this.rows,t),n?this._mapGen.create((t,n,a)=>{const o=r.getUniform()<=s;1===a&&o?e.getCell(t,n).isFree()&&e.setBaseElemXY(t,n,v.ELEM.TREE):1===a&&e.getCell(t,n).isFree()&&e.setBaseElemXY(t,n,v.ELEM.GRASS)}):this._mapGen.create((t,n,a)=>{const o=r.getUniform()<=s;1===a&&o?e.setBaseElemXY(t,n,v.ELEM.TREE):1===a&&e.setBaseElemXY(t,n,v.ELEM.GRASS)})}createLakes(e){const t=new c.CellMap(this.cols,this.rows,this.defaultMapElem);return this._mapGen=new E.MapForest(this.cols,this.rows,e),this.addLakesToMap(t,e),{map:t}}addLakesToMap(e,t){t.freeOnly?this._mapGen.create((t,s,n)=>{1===n&&e.getCell(t,s).isFree()&&e.setBaseElemXY(t,s,v.ELEM.WATER)}):this._mapGen.create((t,s,n)=>{e.setBaseElemXY(t,s,v.ELEM.FLOOR),1===n&&e.setBaseElemXY(t,s,v.ELEM.WATER)})}addLakes(e,t,s){const n=s.lrx-s.ulx,r=s.lry-s.uly;this.setGen("lakes",n,r);const a=this.createLakes(t).map;this.addElementsToMap(e,a,"water",t,s)}addForest(e,t,s){this.cols=s.lrx-s.ulx,this.rows=s.lry-s.uly;const n=this.createForest(t).map;this.addElementsToMap(e,n,"tree",t,s)}addCliffs(e,t,s){const n=e.cols,r=e.rows,a=this.createMountain(n,r,t).map;["cliff","stone","steep cliff"].forEach(n=>{this.addElementsToMap(e,a,n,t,s)})}addElementsToMap(e,t,s,n,r){i.default.forEach2D(t._map,(a,o)=>{const i=a+r.ulx,l=o+r.uly;if(d.Geometry.isInBbox(i,l,r)&&e.hasXY(i,l)){const r=t.getBaseElemXY(a,o);if(r.getType()===s)if(n.skipTypes){const t=e.getBaseElemXY(i,l).getType();n.skipTypes.hasOwnProperty(t)||e.setBaseElemXY(i,l,r)}else e.setBaseElemXY(i,l,r)}})}createWall(e,t,s){const n=new c.CellMap(e,t,this.defaultMapElem),r=s.wallElem||v.ELEM.WALL;return this._mapGen=new E.MapWall(e,t,s),this._mapGen.create((e,t,s)=>{1===s&&n.setBaseElemXY(e,t,r)}),{map:n}}createMountain(e,t,s){const n=new c.CellMap(e,t,this.defaultMapElem);s||(s=O.getOptions("mountain"));const r=(s.highRockThr-s.stoneThr)/3,a=O.getAndSetRNG(s);this._mapGen=new E.MapMountain(this.cols,this.rows,s),this._mapGen.create((e,t,o)=>{if(o>s.highRockThr)n.setBaseElemXY(e,t,v.ELEM.HIGH_ROCK);else if(o>s.stoneThr)o<s.stoneThr+r?n.setBaseElemXY(e,t,v.ELEM.CLIFF):o<s.stoneThr+2*r?n.setBaseElemXY(e,t,v.ELEM.STONE):n.setBaseElemXY(e,t,v.ELEM.STEEP_CLIFF);else if(o<s.chasmThr)o<s.chasmThr-.4?n.setBaseElemXY(e,t,v.ELEM.DEEP_CHASM):o<s.chasmThr-.2?n.setBaseElemXY(e,t,v.ELEM.CHASM):n.setBaseElemXY(e,t,v.ELEM.SHALLOW_CHASM);else{a.getUniform()<s.snowRatio?n.setBaseElemXY(e,t,v.ELEM.SNOW):n.setBaseElemXY(e,t,v.ELEM.FLOOR)}});let o=[];return s.nRoadTurns>0&&(o=this.createMountainPath(n,s)),{map:n,paths:o}}createMountainPath(e,t){const s=[],n=t.nRoadTurns||10;let r=Math.floor(e.rows/n);t.yPerTurn&&(r=t.yPerTurn),r<4&&(r=4);const a=[2,e.cols-3,Math.floor(e.cols/2)];let o=!0,i=-1,l=-1;const c=[(t,s)=>e.hasXY(t,s)&&e.getCell(t,s).isFree(),(t,s)=>e.hasXY(t,s)&&e.getCell(t,s).getBaseElem().getZ()<=1],d=O.getAndSetRNG(t);for(let f=0;o&&f<n;f++){o=!1;let n=i,g=l;0===f&&(n=Number.isInteger(t.startX)?t.startX:d.arrayGetRand(a),g=t.startY?t.startY:0);const p=d.arrayGetRand(a),m=(f+1)*r+g;if(T(n,g,p,m,t)){const t=u.Path.getMinWeightOrShortest(e,n,g,p,m,c);if(t){const n=h.Builder.addPathToMap(e,t);n.length>0&&(o=!0),s.push(n),i=p,l=m}else o=!0}else o=!0}if(t.maxY&&s.length>0){const n=s[s.length-1];if(n.length>0){const r=n[n.length-1],[o,i]=[r.x,r.y];let l=d.arrayGetRand(a);const f=t.maxY;if(t.endX&&(l=t.endX),f>i&&T(o,i,l,f,t)){const t=u.Path.getMinWeightOrShortest(e,o,i,l,f,c);if(t){const n=h.Builder.addPathToMap(e,t);s.push(n)}}}}return s}createSummit(e,t,s){const n=new c.CellMap(e,t,v.ELEM.SKY),r=s.ratio||.3;let[a,o]=[Math.floor(e/2),Math.floor(t/2)];const i=e*t,l=[[a,o]];n.setBaseElemXY(a,o,v.ELEM.FLOOR);let u=1;const h=O.getAndSetRNG(s);let d=1e4;for(;u/i<r;){[a,o]=h.arrayGetRand(l);const[e,t]=h.getRandDir();if(a+=e,o+=t,n.hasXY(a,o)&&"sky"===n.getBaseElemXY(a,o).getType()&&(l.push([a,o]),++u,n.setBaseElemXY(a,o,v.ELEM.FLOOR)),--d,d<=0)break}const f=O.getOptions("mountain");f.nRoadTurns=0,f.chasmThr=-10,f.stoneThr=.35,f.snowRatio=w.getUniformRange(.1,.4);const g=this.createMountain(e,t,f);for(let s=0;s<e;s++)for(let e=0;e<t;e++)n._map[s][e].getBaseElem()!==v.ELEM.SKY&&n._map[s][e].setBaseElem(g.map._map[s][e].getBaseElem());return{map:n}}createCave(e,t,s){this._mapGen=new E.MapMiner(e,t,s);const n=new c.CellMap(e,t,this.defaultMapElem),r=s.wallElem||v.ELEM.WALL_CAVE,a=s.floorElem||v.ELEM.FLOOR_CAVE;return this._mapGen.create((e,t,s)=>{1===s?n.setBaseElemXY(e,t,r):n.setBaseElemXY(e,t,a)}),{map:n,mapGen:this._mapGen}}createCryptNew(e,t,s={}){const n=s.tilesX||12,r=s.tilesY||7,a=new g.TemplateLevel(n,r);a.use(y.Crypt);const o=s.genParams||[2,2,2,2],i=s.roomCount||40;a.setGenParams(o),a.setRoomCount(i),a.create();const l={"#":v.ELEM.WALL_CRYPT,".":v.ELEM.FLOOR_CRYPT},c=O.fromAsciiMap(a.map,l);return c.tiles=a.getPlacedData(),c}createNest(e,t,s={}){const n=s.tilesX||12,r=s.tilesY||7,a=new g.TemplateLevel(n,r),o=s.genParams||[1,1,1,1,1,1];a.weights=b.Nests.weights,a.customMatchFilter=b.Nests.matchFilter,a.setStartRoomFunc(b.Nests.startRoomFuncNx3),a.setTemplates(b.Nests.templates),a.setGenParams(o),a.setRoomCount(-1),a.create();let l=v.ELEM.WALL,c=v.ELEM.FLOOR;s.wallType&&(l=O.getWallElem(s.wallType)),s.floorType&&(c=O.getFloorElem(s.floorType));const u={"#":l,".":c,"?":(e,t,s)=>{const n=new S("?");n.setXY(t,s),n.setTag("nest_loot"),e.getCell(t,s).setProp(i.default.TYPE_ELEM,n)}},h=O.fromAsciiMap(a.map,u);return h.tiles=a.getPlacedData(),h}createCastle(e,t,s={}){const n=s.genParams||[1,1,1,1];let r=5,a=5;Array.isArray(n)?n.forEach((e,t)=>{t<n.length/2?r+=e:a+=e}):i.default.err("MapGenerator","createCastle","GenParamsXY {x: [...], y: [...]} not supported yet!");const o=s.tilesX||Math.ceil(e/r),l=s.tilesY||Math.ceil(t/a),c=new g.TemplateLevel(o,l);c.use(_.Castle),s.models||s.templates?"string"==typeof s.models?c.setTemplates(_.Castle.Models[s.models]):"string"==typeof s.templates?c.setTemplates(_.Castle.templates[s.templates]):c.setTemplates(s.models):c.setTemplates(_.Castle.Models.full),2===s.nGates?c.setStartRoomFunc(_.Castle.startFuncTwoGates):s.startRoomFunc&&c.setStartRoomFunc(s.startRoomFunc),s.constraintFunc&&c.setConstraintFunc(s.constraintFunc);const u=s.roomCount||40;c.setGenParams(n),c.setRoomCount(u),c.tryToMatchAllExits=!0,s.callbacks&&Object.keys(s.callbacks).forEach(e=>{c.addCallback(e,s.callbacks[e])}),c.create();return this.createCastleMapObj(c,s)}createCastleWall(e,t,s={}){const n=s.tilesX||Math.ceil(e/7),r=s.tilesY||Math.ceil(t/7),a=new g.TemplateLevel(n,r);a.use(_.Castle),a.setTemplates(_.Castle.Models.outerWall),a.setFiller(_.Castle.tiles.fillerFloor),2===s.nGates?a.setStartRoomFunc(_.Castle.startFuncTwoGates):s.startRoomFunc&&a.setStartRoomFunc(s.startRoomFunc),s.constraintFunc&&a.setConstraintFunc(s.constraintFunc),a.create();const o={"#":O.getWallElem(s.wallType),".":O.getFloorElem(s.floorType)},i=O.fromAsciiMap(a.map,o);return i.tiles=a.getPlacedData(),i}createCastleMapObj(e,t){const s=[],n={"#":O.getWallElem(t.wallType),".":O.getFloorElem(t.floorType),"&":(e,n,r)=>{if(e.setBaseElemXY(n,r,O.getFloorElem(t.floorType)),t.preserveMarkers){const t=new S("&");t.setTag("lever"),e.getCell(n,r).setProp(i.default.TYPE_ELEM,t),t.setXY(n,r),s.push(t)}},"|":(e,n,r)=>{if(e.setBaseElemXY(n,r,O.getFloorElem(t.floorType)),t.preserveMarkers){const t=new S("|");t.setTag("leverdoor"),e.getCell(n,r).setProp(i.default.TYPE_ELEM,t),t.setXY(n,r),s.push(t)}},":":(e,n,r)=>{if(e.setBaseElemXY(n,r,v.ELEM.FLOOR_HOUSE),t.preserveMarkers){const t=new S(":");t.setTag("living_quarter"),e.getCell(n,r).setProp(i.default.TYPE_ELEM,t),t.setXY(n,r),s.push(t)}},"+":(e,n,r)=>{if(e.setBaseElemXY(n,r,O.getFloorElem(t.floorType)),t.preserveMarkers){const t=new S("+");t.setTag("door"),e.getCell(n,r).setProp(i.default.TYPE_ELEM,t),t.setXY(n,r),s.push(t)}}},r=O.fromAsciiMap(e.map,n);return r.tiles=e.getPlacedData(),r.elements=s,r}createTownWithWall(e,t,s={}){const n=Math.ceil(e/7),r=Math.ceil(t/7),a=this.createCastleWall(e,t,s);s.levelType="empty";const o=7*(n-2),i=7*(r-2),l=this.createTownBSP(o,i,s),c=a.map;d.Geometry.mergeMapBaseElems(c,l.map,7,7);const u=l.houses;u.forEach(e=>{e.moveHouse(7,7)});const h=l.unused;return h&&h.forEach(e=>{e.x+=7,e.y+=7}),{map:c,houses:u,unused:h,tiles:a.tiles}}createArctic(e,t,s={}){const n=s.snowRatio||1;this.setGen("empty",e,t);const r=new c.CellMap(e,t,this.defaultMapElem);return O.addRandomSnow(r,n),{map:r}}setGen(e,t,s,n={}){switch(this.cols=t,this.rows=s,e=e.toLowerCase(),this._mapType=e,e){case"arctic":this._mapGen=this.createEmptyFunc("arctic",t,s);break;case"arena":this._mapGen=new l.default.Arena(t,s);break;case"cave":this._mapGen=new E.MapMiner(t,s);break;case"cellular":this._mapGen=this.createCellular(t,s);break;case"castle":break;case"crypt":this._mapGen=new l.default.Uniform(t,s,n);break;case"digger":this._mapGen=new l.default.Digger(t,s);break;case"divided":this._mapGen=new l.default.DividedMaze(t,s);break;case"dungeon":this._mapGen=new l.default.Rogue(t,s,n);break;case"empty":this._mapGen=this.createEmptyFunc("empty",t,s);break;case"eller":this._mapGen=new l.default.EllerMaze(t,s);break;case"forest":case"lakes":this._mapGen=new E.MapForest(t,s);break;case"labyrinth":this._mapGen=new l.default.DividedMaze(t,s);break;case"miner":this._mapGen=new E.MapMiner(t,s);break;case"mountain":this._mapGen=new E.MapMountain(t,s);break;case"icey":this._mapGen=new l.default.IceyMaze(t,s);break;case"rogue":this._mapGen=new l.default.Rogue(t,s,n);break;case"uniform":this._mapGen=new l.default.Uniform(t,s,n);break;case"ruins":this._mapGen=this.createRuins(t,s);break;case"rooms":this._mapGen=this.createRooms(t,s);break;case"town":this._mapGen=new l.default.Arena(t,s);break;case"townwithwall":case"summit":break;case"wall":this._mapGen=new E.MapWall(t,s);break;default:i.default.err("MapGen","setGen","this._mapGen type "+e+" is unknown")}}createEmptyFunc(e,t,s){return"empty"===e&&(this.defaultMapElem=v.ELEM.FLOOR),()=>this.createEmptyMap().map}}t.MapGenerator=O,O.options={},O.options.mountain=Object.freeze({noiseMult:1,noiseDivider:20,highRockThr:.75,stoneThr:.5,chasmThr:-.4,nRoadTurns:8,snowRatio:0})},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CellMap=void 0;const r=n(s(0)),a=s(209),o=s(7),i=s(8),l=s(458),c=new o.ElementBase("floor"),u=new o.ElementWall("wall");class h{constructor(e,t,s=c){this._map=[],this.cols=e,this.rows=t,this._isRowOptimized=!1,"number"==typeof this.cols&&"number"==typeof this.rows||r.default.err("Map.CellList","constructor","Map.CellList(rows, cols) expects 2 integers."),this._map=new Array(this.cols);for(let e=0;e<this.cols;e++){this._map[e]=new Array(this.rows);for(let t=0;t<this.rows;t++)this._map[e][t]=new a.Cell(e,t,s)}this.fov=new l.Fov3D(this,this.lightPasses.bind(this)),this.passableCallback=this.passableCallback.bind(this),this.passableCallbackFlying=this.passableCallbackFlying.bind(this),this.debugShowAll=!1}static invertMap(e){for(let t=0;t<e.cols;t++)for(let s=0;s<e.rows;s++){const n=e._map[t][s].getBaseElem().getType();"wall"===n?e._map[t][s].setBaseElem(c):"floor"===n&&e._map[t][s].setBaseElem(u)}}static createWithoutCells(e,t){const s=new h(0,0);s._map=new Array(e);for(let n=0;n<e;n++)s._map[n]=new Array(t);return s.cols=e,s.rows=t,s}static multiplyMap(e,t,s){const n=new h(t*e.cols,s*e.rows);for(let r=0;r<n.cols;r++)for(let a=0;a<n.rows;a++){const o=Math.floor(r/t),i=Math.floor(a/s);n.setBaseElemXY(r,a,e.getBaseElemXY(o,i))}return n}setDebugShowAll(){this.debugShowAll=!0,this.exploreAll()}hasXY(e,t){return e>=0&&e<this.cols&&t>=0&&t<this.rows}setProp(e,t,s,n){this._map[e][t].setProp(s,n)}removeProp(e,t,s,n){return this._map[e][t].removeProp(s,n)}moveProp(e,t,s,n){return!!this.removeProp(e[0],e[1],s,n)&&(this.setProp(t[0],t[1],s,n),!0)}setElemXY(e,t,s){this.setProp(e,t,r.default.TYPE_ELEM,s)}setBaseElemXY(e,t,s){this._map[e][t].setBaseElem(s)}getBaseElemXY(e,t){return this._map[e][t].getBaseElem()}getCell(e,t){return this._map[e][t]}isExplored(e,t){return this._map[e][t].isExplored()}getBaseElemRow(e){const t=[];for(let s=0;s<this.cols;++s)t.push(this._map[s][e].getBaseElem());return t}getCellRow(e){const t=[];for(let s=0;s<this.cols;++s)t.push(this._map[s][e]);return t}getFree(){const e=[];for(let t=0;t<this.cols;t++)for(let s=0;s<this.rows;s++)this._map[t][s].isFree()&&e.push(this._map[t][s]);return e}getFreeNotOnEdge(){return this.getFree().filter(e=>e.getX()>0&&e.getX()<this.cols-1&&e.getY()>0&&e.getY()<this.rows-1)}getFirstFreeFromRight(e=0,t=this.rows-1){for(let s=this.cols-1;s>=0;s--)for(let n=e;n<=t;n++)if(this._map[s][n].isFree())return this._map[s][n];return null}getFreeInBbox(e){const t=[];for(let s=e.ulx;s<=e.lrx;s++)for(let n=e.uly;n<e.lry;n++)this._map[s][n].isFree()&&t.push(this._map[s][n]);return t}getEmptyCells(){const e=[];for(let t=0;t<this.cols;t++)for(let s=0;s<this.rows;s++)this._map[t][s].hasProps()||e.push(this._map[t][s]);return e}lightPasses(e,t,s){if(this.hasXY(e,t)){if(s>=this.getZ(e,t))return this._map[e][t].lightPasses()}return!1}hasObstacle(e,t){return!!this.hasXY(e,t)&&this._map[e][t].hasObstacle()}isPassable(e,t,s,n){if(this.hasXY(e,t)&&this._map[e][t].isPassable()&&void 0!==s&&void 0!==n){if(this.hasXY(s,n)){return this.getElemDzAbs(e,t,s,n)<=1}return!0}return!1}getZ(e,t){return this._map[e][t].getBaseElem().getZ()}getElemDzAbs(e,t,s,n){const r=this.getZ(e,t),a=this.getZ(s,n);return Math.abs(r-a)}isPassableByAir(e,t){return!!this.hasXY(e,t)&&this._map[e][t].isPassableByAir()}getCellsInFOV(e){const t=[];if(e.has("Blindness"))return t;if(e.isLocated()&&e.getLevel().getMap()===this){const[s,n,a]=e.getXYZ(),o=r.default.getFOVRange(e);this.fov.compute(s,n,a,o,(e,s,n,r)=>{r&&this.hasXY(e,s)&&t.push(this._map[e][s])})}return t}canSeeCell(e,t){const s=r.default.getFOVRange(e);return this.fov.canSeeCell(e.getXYZ(),s,t.getXYZ())}getCellsInFOVPlus(e,t){const s=[],n=[],[r,a,o]=e.getXYZ(),i=e.getFOVRange(),l=i+t;return e.isLocated()&&e.getLevel().getMap()===this&&this.fov.compute(r,a,o,l,(e,t,r,a)=>{a&&this.hasXY(e,t)&&(r<=i?s.push(this._map[e][t]):n.push(this._map[e][t]))}),[s,n]}getExploredCells(){const e=[];for(let t=0;t<this.cols;t++)for(let s=0;s<this.rows;s++)this._map[t][s].isExplored()&&e.push(this._map[t][s]);return e}exploreAll(){for(let e=0;e<this.cols;e++)for(let t=0;t<this.rows;t++)this._map[e][t].setExplored()}isBorderXY(e,t){return 0===e||(0===t||(e===this.cols-1||t===this.rows-1))}debugPrintInASCII(){let e="";for(let t=0;t<this.rows;t++){let s="";for(let e=0;e<this.cols;e++){const n=this._map[e][t],r=n.getBaseElem();if(!r){s+="X";continue}const a=r.getType();if(n.hasActors())n.getFirstActor().isPlayer()?s+="@":s+="A";else if(n.hasItems())s+="I";else if(null!==n.getStairs())s+=">";else if(n.hasConnection())s+="c";else if(n.hasElements()){const e=n.getElements()[0];if("marker"===e.getType()){s+=e.char}else"door"===e.getType()?s+="+":s+="E"}else/floor/.test(a)?s+=".":/water|chasm|lava/.test(a)?s+="~":/wall/.test(a)?s+="#":/tree/.test(a)?s+="T":/grass/.test(a)?s+='"':/highrock/.test(a)?s+="^":/stone/.test(a)?s+=":":/steep cliff/.test(a)?s+="⋮":/cliff/.test(a)?s+="⦁":/road/.test(a)?s+="R":/arctic/.test(a)||n.isFree()?s+=".":s+="?"}e+=s+"\n"}r.default.diag(e)}getCellRowFast(e){return this._isRowOptimized||this._optimizeForRowAccess(),this._rowMap[e]}findObj(e){let t=[];for(let s=0;s<this.cols;s++)for(let n=0;n<this.rows;n++)t=t.concat(this._map[s][n].findObj(e));return t}getCells(e=(e=>!0)){const t=[];for(let s=0;s<this.cols;s++)for(let n=0;n<this.rows;n++)e(this._map[s][n])&&t.push(this._map[s][n]);return t}getCellsWithCoord(e){const t=[];return e.forEach(e=>{this.hasXY(e[0],e[1])&&t.push(this._map[e[0]][e[1]])}),t}setBaseElems(e,t){e.forEach(e=>{this._map[e[0]][e[1]].setBaseElem(t)})}has(e,t){const[s,n]=e;if(this.hasXY(s,n)){const e=this.getCell(s,n);if("string"==typeof t){if(e.getBaseElem().getType()===t)return!0}}return!1}_optimizeForRowAccess(){this._rowMap=[];for(let e=0;e<this.rows;e++){this._rowMap[e]=[];for(let t=0;t<this.cols;t++)this._rowMap[e][t]=this._map[t][e]}this._isRowOptimized=!0}toJSON(){const e=new Array(this.cols),t={},s=[],n={};for(let r=0;r<this.cols;r++){e[r]=new Array(this.rows);for(let a=0;a<this.rows;a++){const o=this.getCell(r,a).toJSON();e[r][a]=o.t,n[o.t]=0,o.ex&&s.push([r,a]),o.elements&&(t[r+","+a]=t)}}return{cols:this.cols,rows:this.rows,cells:e,explored:s,elements:t,baseTypes:n}}toJSONEncoded(){const e=this.toJSON(),{cells:t,baseTypes:s}=e;for(let e=0;e<this.cols;e++)for(let n=0;n<this.rows;n++)s[t[e][n]]+=1;let n=-1,r=0;Object.keys(s).forEach(e=>{s[e]>r&&(r=s[e],n=parseInt(e,10))});const a={};for(let e=0;e<this.cols;e++)for(let s=0;s<this.rows;s++)t[e][s]!==n&&(a[e]||(a[e]=[]),a[e].push([s,t[e][s]]));return delete e.cells,e.defaultType=n,e.cellsXY=a,e.encoded=!0,e}passableCallback(e,t,s,n,r,a){let o=this.isPassable(s,n,r,a);return o||(o=s===e&&n===t),o}passableCallbackFlying(e,t,s,n){let r=this.isPassableByAir(s,n);return r||(r=s===e&&n===t),r}moveCellUnsafe(e,t,s){s.setXY([e,t]),this._map[e][t]=s}}t.CellMap=h,h.fromJSON=function(e){if(e.encoded){const{defaultType:t}=e,s=i.ELEM_MAP.elemIndexToElemObj[t],n=new h(e.cols,e.rows,s);return Object.keys(e.cellsXY).forEach(t=>{const s=e.cellsXY[t],r=parseInt(t,10);s.forEach(e=>{const t=i.ELEM_MAP.elemIndexToElemObj[e[1]];n.setBaseElemXY(r,e[0],t)})}),e.explored.forEach(e=>{const[t,s]=e;n._map[t][s].setExplored()}),n}return null}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KEYS=t.DIRS=t.DEFAULT_HEIGHT=t.DEFAULT_WIDTH=void 0,t.DEFAULT_WIDTH=80,t.DEFAULT_HEIGHT=25,t.DIRS={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},t.KEYS={VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MenuWithState=t.PlayerMissileMenu=t.MenuConfirm=t.MenuSelectDir=t.MenuSelectTarget=t.MenuSelectCell=t.MenuSelectRequired=t.MenuWithQuit=t.MenuInfoOnly=t.MenuBase=t.Menu=void 0;const r=n(s(0)),a=s(69),{KeyMap:o}=a.Keys;t.Menu={},t.Menu.EXIT_MENU=null,t.Menu.NO_ACTION="NO_ACTION",t.Menu.NEXT_STATE="NEXT_STATE";const i=function(e){const t={};return e.forEach((e,s)=>{const n=a.Keys.menuIndices[s];if(e.key){const s=e,n=a.Keys.codeToIndex(s.key);s.menu?t[n]=s.menu:s.func?t[n]=s.func:s.funcToCall&&(t[n]={funcToCall:s.funcToCall})}else if(2===e.length)t[n]=e;else{let e="Each item must have 2 values: menu msg and ret val";e+="\nItem can also be {key: , menu: } for nested menus",r.default.err("menu.js","createMenuTable",e)}}),t};t.Menu.isSelectionDone=function(e){return"function"==typeof e},t.Menu.isMenuItem=function(e){return e&&"object"==typeof e};class l{constructor(e=[]){this.table=i(e),this.msg="",this.pre=[],this.post=[],this._showMenu=!0,this.parent=null}createTable(e){this.table=i(e)}setName(e){this.name=e}setMsg(e){this.msg=e}showMsg(){this.msg.length>0&&r.default.gameMsg(this.msg)}setParent(e){this.parent=e}getParent(){return this.parent}addItem(e,t){const s=a.Keys.codeToIndex(e);this.table[s]=t}showMenu(){return this._showMenu}setCallback(e){this.callback=e}getMenu(){const e={pre:[],post:[]};return Object.keys(this.table).forEach(t=>{const s=a.Keys.menuIndices[t];e[s]=this.table[t][0]}),e.pre=this.pre,e.post=this.post,e}addPost(e){Array.isArray(e)?this.post=this.post.concat(e):this.post.push(e)}addPre(e){Array.isArray(e)?this.pre=this.pre.concat(e):this.pre.push(e)}dbg(...e){console.log("MENU "+this.name,...e)}select(e){const s=a.Keys.codeToIndex(e);if(this.table.hasOwnProperty(s)){const e=this.table[s];return 2===e.length?e[1]:e.funcToCall?e.funcToCall:e}return t.Menu.EXIT_MENU}onSelectCallback(e){console.log("onSelectCallback in menu",this.name)}}t.MenuBase=l,t.Menu.Base=l;class c extends l{constructor(){super()}select(e){return 0===a.Keys.codeToIndex(e)?t.Menu.EXIT_MENU:this}getMenu(){return{0:"Back to game.",pre:this.pre,post:this.post}}}t.MenuInfoOnly=c,t.Menu.InfoOnly=c;class u extends l{constructor(e=[]){super(e);const s=a.Keys.codeToIndex(a.Keys.KEY.QUIT_MENU);this.table[s]=["Quit menu",t.Menu.EXIT_MENU]}select(e){const s=a.Keys.codeToIndex(e);if(this.table.hasOwnProperty(s)){const e=this.table[s][1];return e===t.Menu.EXIT_MENU&&this.onQuit&&this.onQuit(),e}return this}}t.MenuWithQuit=u,t.Menu.WithQuit=u;class h extends l{constructor(e=[]){super(e)}select(e){const t=a.Keys.codeToIndex(e);return this.table.hasOwnProperty(t)?this.table[t][1]:this}}t.MenuSelectRequired=h,t.Menu.SelectRequired=h;class d extends l{constructor(e=[]){super(e),this._enableSelectAll=!1,this._showMenu=!1}enableSelectAll(){this._enableSelectAll=!0}select(e){if(o.inMoveCodeMap(e))return this.callback(e),this;if(o.isSelect(e)){const t=a.Keys.codeToIndex(e),s=this.table[t];return s.funcToCall?s.funcToCall:s}return this._enableSelectAll&&o.isSelectAll(e)?(this.callback(e),this):t.Menu.EXIT_MENU}}t.MenuSelectCell=d,t.Menu.SelectCell=d;class f extends d{constructor(e=[]){super(e),this.targetCallback=null}select(e){const s=super.select(e);if(s===t.Menu.EXIT_MENU){if(o.isNextTarget(e))return this.targetCallback&&this.targetCallback(e),this;if(o.isPrevTarget(e))return this.targetCallback&&this.targetCallback(e),this;if(e===a.Keys.KEY.TARGET){const t=a.Keys.codeToIndex(e),s=this.table[t];return s.funcToCall?s.funcToCall:s}return t.Menu.EXIT_MENU}return s}}t.MenuSelectTarget=f,t.Menu.SelectTarget=f;class g extends l{constructor(e=[]){super(e),this._showMenu=!1}select(e){if(o.inMoveCodeMap(e)){const t=a.Keys.KeyMap.getDir(e);if(this.callback)return this.callback.bind(null,t);if(this.returnMenu)return this.returnMenu.onSelectCallback(t),this.returnMenu}return t.Menu.EXIT_MENU}}t.MenuSelectDir=g,t.Menu.SelectDir=g;class p extends l{constructor(e=[]){super(e),this._showMenu=!1,this.msg="Do you want to confirm the action [y/n]?"}select(e){return o.isConfirmYes(e)?this.callback?this.callback:this.returnMenu?(this.returnMenu.onSelectCallback(),this.returnMenu):t.Menu.EXIT_MENU:o.isConfirmNo(e)?t.Menu.EXIT_MENU:this}}t.MenuConfirm=p,t.Menu.Confirm=p;t.PlayerMissileMenu=class extends d{constructor(e=[],t){super(e),this.actor=t,this._showMenu=!1;const s=this.actor.getBrain();if(s.selectCell){const e=s.selectCell.bind(s);this.setCallback(e)}else r.default.err("PlayerMissileMenu","constructor","brain does not have selectCell() function");s.startTargeting(),s.hasTargetSelected()?console.log("Brain has target selected"):(s.selectCell(),console.log("Brain no target selected. Using cell."))}select(e){const s=super.select(e);if(s!==t.Menu.EXIT_MENU)return s;switch(e){case a.Keys.KEY.NEXT:return this.actor.getBrain().nextTarget(),this;case a.Keys.KEY.PREV:return this.actor.getBrain().prevTarget(),this;case a.Keys.KEY.TARGET:{const t=a.Keys.codeToIndex(e);return this.table[t]}default:return t.Menu.EXIT_MENU}}};class m extends u{constructor(e){super(e),this._showMenu=!0,this.keyToState={},this.stateToTable={},this.stateToPost={},this.stateToPre={},this.menuState=""}select(e){if(this.keyToState.hasOwnProperty(e))return this.menuState=this.keyToState[e],this;{const s=a.Keys.codeToIndex(e);if(this.table.hasOwnProperty(s)){const e=this.table[s][1];return e===t.Menu.EXIT_MENU&&this.onQuit&&this.onQuit(),e}const n=this.stateToTable[this.menuState];if(n.hasOwnProperty(s)){return n[s][1]}return this}}addState(e,t){this.stateToTable[e]=i(t)}addTransition(e,t){this.keyToState[t]=e}getMenu(){const e=u.prototype.getMenu.call(this),t=this.menuState,s=this.stateToTable[t];let n={pre:this.pre,post:this.post};return Object.keys(s).forEach(e=>{const t=a.Keys.menuIndices[e];n[t]=s[e][0]}),n=Object.assign(n,e),this.stateToPre[t]&&n.pre.push(this.stateToPre[t]),this.stateToPost[t]&&n.post.push(this.stateToPost[t]),n}addPreState(e,t){t?this.stateToPre[t]=e:u.prototype.addPre.call(this,e)}addPostState(e,t){t?this.stateToPost[t]=e:u.prototype.addPost.call(this,e)}}t.MenuWithState=m,t.Menu.WithState=m},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Constraints=void 0;const r=n(s(0));function a(e,t,s){const n=t.split(".");let r=e;return n.forEach(e=>{r=r[e](...s)}),r}t.Constraints=class{static toJSON(e){const t=e.constraint,s={op:t.op,value:t.value};return t.comp&&(s.comp=t.comp),t.func&&(s.func=t.func),t.prop&&(s.prop=t.prop),t.args&&(s.args=t.args),s}getConstraints(e){if(Array.isArray(e)){const t=e.map(e=>{const{op:t,prop:s,func:n,value:r,args:a,comp:o}=e;return s?this.getFunc(t,s,r):n?this.getFuncWithGetter(t,n,r,a):o?this.getFuncWithComp(t,o,r,a):void 0}),s=function(e){let s=!0;return t.forEach(t=>{s=s&&t(e)}),s};return s.constraint=e,s}if("object"==typeof e){const{op:t,prop:s,func:n,value:r,args:a,comp:o}=e;if(s)return this.getFunc(t,s,r);if(n)return this.getFuncWithGetter(t,n,r,a);if(o)return this.getFuncWithComp(t,o,r,a)}else{const t="Param must be array/object. Got: "+e;r.default.err("Constrains","getConstraints",t)}return null}getFunc(e,t,s){if(Array.isArray(s)){const n=s.map(s=>this.getFunc(e,t,s)),r=function(e){let t=!1;return n.forEach(s=>{t=t||s(e)}),t};return r.constraint={op:e,prop:t,value:s},r}{let n=()=>!1;switch(e){case"==":case"===":case"eq":n=e=>e[t]===s;break;case"!=":case"!==":case"neq":n=e=>e[t]!==s;break;case">=":case"gte":n=e=>e[t]>=s;break;case"<=":case"lte":n=e=>e[t]<=s;break;case">":case"gt":n=e=>e[t]>s;break;case"<":case"lt":n=e=>e[t]<s;break;case"match":n=e=>new RegExp(s).test(e[t]);break;default:r.default.err("Constraints","getFunc",`Unsupported op ${e} given`)}return n.constraint={op:e,prop:t,value:s},n}}getFuncWithGetter(e,t,s,n=[]){if(Array.isArray(s)){const r=s.map(s=>this.getFuncWithGetter(e,t,s,n)),a=function(e){let t=!1;return r.forEach(s=>{t=t||s(e)}),t};return a.constraint={op:e,func:t,value:s,args:n},a}{let o=()=>!1;switch(e){case"==":case"===":case"eq":o=e=>a(e,t,n)===s;break;case"!=":case"!==":case"neq":o=e=>a(e,t,n)!==s;break;case">=":case"gte":o=e=>a(e,t,n)>=s;break;case"<=":case"lte":o=e=>a(e,t,n)<=s;break;case">":case"gt":o=e=>a(e,t,n)>s;break;case"<":case"lt":o=e=>a(e,t,n)<s;break;case"match":o=e=>new RegExp(s).test(a(e,t,n));break;default:r.default.err("Constraints","getFunc",`Unsupported op ${e} given`)}return o.constraint={op:e,func:t,value:s,args:n},o}}getFuncWithComp(e,t,s,n=[]){if(Array.isArray(s)){const r=s.map(s=>this.getFuncWithComp(e,t,s,n)),a=function(e){let t=!1;return r.forEach(s=>{t=t||s(e)}),t};return a.constraint={op:e,comp:t,value:s,args:n},a}{if(!Array.isArray(t)||t.length<=1){const e=JSON.stringify(t);r.default.err("Constraints","getFuncWithComp","comp must be an array [CompName, getterName]. Got: "+e)}const[a,o]=t;let i=()=>!1;switch(e){case"==":case"===":case"eq":i=e=>e.get(a)[o](...n)===s;break;case"!=":case"!==":case"neq":i=e=>e.get(a)[o](...n)!==s;break;case">=":case"gte":i=e=>e.get(a)[o](...n)>=s;break;case"<=":case"lte":i=e=>e.get(a)[o](...n)<=s;break;case">":case"gt":i=e=>e.get(a)[o](...n)>s;break;case"<":case"lt":i=e=>e.get(a)[o](...n)<s;break;case"m/":case"match":i=e=>new RegExp(s).test(e.get(a)[o](...n));break;default:r.default.err("Constraints","getFunc",`Unsupported op ${e} given`)}return i.constraint={op:e,comp:t,value:s,args:n},i}}}},function(e,t,s){var n=s(293),r=s(298);e.exports=function(e,t){var s=r(e,t);return n(s)?s:void 0}},function(e,t){e.exports=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}},function(e,t,s){var n=s(161),r=s(118),a=s(42);e.exports=function(e){return a(e)?n(e):r(e)}},function(e,t,s){var n=s(76),r=s(115);e.exports=function(e){return null!=e&&r(e.length)&&!n(e)}},function(e,t){"function"==typeof Object.create?e.exports=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:e.exports=function(e,t){e.super_=t;var s=function(){};s.prototype=t.prototype,e.prototype=new s,e.prototype.constructor=e}},function(e,t,s){"use strict";var n=s(87),r=Object.keys||function(e){var t=[];for(var s in e)t.push(s);return t};e.exports=h;var a=s(61);a.inherits=s(43);var o=s(199),i=s(131);a.inherits(h,o);for(var l=r(i.prototype),c=0;c<l.length;c++){var u=l[c];h.prototype[u]||(h.prototype[u]=i.prototype[u])}function h(e){if(!(this instanceof h))return new h(e);o.call(this,e),i.call(this,e),e&&!1===e.readable&&(this.readable=!1),e&&!1===e.writable&&(this.writable=!1),this.allowHalfOpen=!0,e&&!1===e.allowHalfOpen&&(this.allowHalfOpen=!1),this.once("end",d)}function d(){this.allowHalfOpen||this._writableState.ended||n.nextTick(f,this)}function f(e){e.end()}Object.defineProperty(h.prototype,"destroyed",{get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed&&this._writableState.destroyed)},set:function(e){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=e,this._writableState.destroyed=e)}}),h.prototype._destroy=function(e,t){this.push(null),this.end(),n.nextTick(t,e)}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryItem=t.ItemRandomizer=void 0;const i=o(s(0)),l=s(1),c=s(30),u=s(6),h=s(17),d=a(s(2)),f=l.Random.getRNG();class g{constructor(){this._foodWeights=i.default.getFoodWeightDistr(),this._runeWeights=i.default.getRuneChargeDistr(),this._adjustFunctions={food:this._adjustFoodItem.bind(this),goldcoin:this._adjustGoldCoin.bind(this),missile:this._adjustMissile.bind(this),weapon:this._adjustWeapon.bind(this),armour:this._adjustArmour.bind(this),ammo:this._adjustMissile.bind(this),rune:this._adjustRune.bind(this)}}adjustItem(e,t){const s=e.getType();this._adjustFunctions.hasOwnProperty(s)&&this._adjustFunctions[s](e,t)}_adjustFoodItem(e){const t=f.getWeighted(this._foodWeights);e.setWeight(parseInt(t,10))}_adjustGoldCoin(e,t){if(i.default.isNullOrUndef([t]))i.default.err("ItemRandomizer","_adjustGoldCoin","nLevel is not defined.");else{const s=i.default.getGoldCoinCountDistr(t),n=f.getWeighted(s);e.setCount(parseInt(n,10))}}_adjustMissile(e){const t=f.getUniformInt(5,15);e.setCount(t)}_isCombatMod(e){return e>=0&&e<=.02}_isStatsMod(e){return e>=.1&&e<=.12}_getRandStat(){return f.arrayGetRand(i.default.STATS)}_adjustWeapon(e){const t=f.getUniform();if(this._isCombatMod(t)){const t=f.getUniformInt(1,5);switch(f.getUniformInt(0,4)){case 0:case 1:e.setAttack(e.getAttack()+t);break;case 2:case 3:e.setDefense(e.getDefense()+t);break;case 4:e.setProtection(e.getProtection()+t)}i.default.scaleItemValue("combat",t,e)}else if(this._isStatsMod(t)){const t=f.getUniformInt(1,3);let s=null;e.has("Stats")?s=e.get("Stats"):(s=new d.Stats,s.clearValues(),e.add(s));const n=this._getRandStat(),r="get"+n;s["set"+n](s[r]()+t),i.default.scaleItemValue("stats",t,e)}}_adjustArmour(e){this._adjustWeapon(e)}_adjustRune(e){const t=f.getWeighted(this._runeWeights);e.setCharges(t)}}t.ItemRandomizer=g;class p{constructor(){this._itemRandomizer=new g}static addItemsToActor(e,t){let s=null;t.forEach(t=>{s=p.createItemFromConstr(t),s&&e.getInvEq().addItem(s)})}static equipFullGearType(e,t){const s=u.ObjectShell.getParser(),n=new RegExp(t),r=s.filterItems(e=>"armour"===e.type&&n.test(e.name));return p.equipItemsToActor(e,r)}static equipWeaponOfType(e,t){const s=u.ObjectShell.getParser(),n=new RegExp(t),r=s.filterItems(e=>"weapon"===e.type&&n.test(e.name)),a=f.arrayGetRand(r);return p.equipItemsToActor(e,[a])}static equipItemsToActor(e,t){let s=null,n=!0;return t.forEach(t=>{if(s=p.createItemFromConstr(t),s){const t=s.getCount();e.getInvEq().addItem(s),n=n&&e.getInvEq().equipNItems(s,t)}}),n}static createItemFromConstr(e){const t=u.ObjectShell.getParser();let s=null;return"string"==typeof e?s=t.createItem(e):"object"==typeof e&&(e.func?s=t.createRandomItem({func:e.func}):e.name&&(s=t.createItem(e.name)),s&&e.count&&s.setCount(h.Dice.getValue(e.count))),s}_doItemSpecificAdjustments(e,t){this._itemRandomizer.adjustItem(e,t)}createItem(e){return u.ObjectShell.getParser().createRandomItem(e)}addNRandItems(e,t){const s=this.generateItems(t),n=u.ObjectShell.getParser();if(t.food){const e=n.createRandomItem({func:e=>"food"===e.type});e?(this._doItemSpecificAdjustments(e,t.maxValue),s.push(e)):i.default.warn("FactoryItem","addNRandItems","Item.Food was not created properly.")}return c.Placer.addPropsToFreeCells(e,s),s.length}generateItems(e){const t=e.itemsPerLevel||e.nItems,s=[];if(!t)return s;const n=u.ObjectShell.getParser();for(let r=0;r<t;r++){const t=n.createRandomItem({func:e.item});t&&(this._doItemSpecificAdjustments(t,e.maxValue),s.push(t))}return s}generateGold(e){const t=e.goldPerLevel||e.nGold,s=u.ObjectShell.getParser(),n=[];if(!t)return n;for(let r=0;r<t;r++){const t=s.createItem(i.default.GOLD_COIN_NAME);i.default.isNullOrUndef([e.nLevel])?i.default.warn("FactoryItem","generateGold","nLevel null/undef in conf "+JSON.stringify(e)):this._doItemSpecificAdjustments(t,e.nLevel),n.push(t)}return n}addRandomGold(e,t,s){const n=this.generateGold(s);c.Placer.addPropsToFreeCells(e,n)}getShopItem(e,t){let s=null;return t.shopFunc?"function"==typeof t.shopFunc[e]?s=t.parser.createRandomItem({func:t.shopFunc[e]}):i.default.err("FactoryItem","createShop -> getShopItem","shopFunc must be a function."):Array.isArray(t.shopType)?t.shopType.length<e?s=t.parser.createRandomItem({func:s=>s.type===t.shopType[e]}):i.default.err("FactoryItem","getShopItem",`${e} out of bounds in conf. ${JSON.stringify(t.shopType)}`):s="string"==typeof t.shopType?t.parser.createRandomItem({func:e=>e.type===t.shopType}):t.parser.createRandomItem({func:t=>t.value<=50+100*e&&"goldcoin"!==t.type}),s&&this._doItemSpecificAdjustments(s,50+100*e),s}addItemsToCells(e,t,s,n){n.maxValue||i.default.err("FactoryItem","addItemsToCells","conf is missing maxValue");const r=this.generateItems(n);c.Placer.addPropsToCells(e,s,r)}}t.FactoryItem=p},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BrainSentient=t.BrainNonSentient=t.Brain=t.NO_ACTION_TAKEN=t.ACTION_ALREADY_DONE=void 0;const i=o(s(0)),l=a(s(2)),c=s(4),u=s(68),h=s(98),d=s(1),f=s(10);t.ACTION_ALREADY_DONE=Object.freeze(()=>{}),t.NO_ACTION_TAKEN=Object.freeze(()=>{});const g=d.Random.getRNG();t.Brain={},t.Brain.getCellsAroundActor=(e,t=1)=>{const s=e.getLevel().getMap(),[n,r]=e.getXY(),a=[];for(let e=n-t;e<=n+t;e++)for(let o=r-t;o<=r+t;o++)s.hasXY(e,o)&&(e===n&&o===r||a.push(s.getCell(e,o)));return a},t.Brain.getBoxOfFreeCellsAround=(e,t)=>{const s=e.getLevel().getMap(),[n,r]=e.getXY();let a=c.Geometry.getBoxAround(n,r,t);a=a.filter(e=>s.hasXY(e[0],e[1]));let o=a.map(e=>s.getCell(e[0],e[1]));return o=o.filter(e=>e.isFree()),o},t.Brain.findCellsWithActors=(e,t,s)=>{const n=[];for(let r=0,a=t.length;r<a;r++)if(t[r].hasActors()){const a=t[r].getActors();a[0].getID()!==e.getID()&&(s&&s(a)?n.push(t[r]):s||n.push(t[r]))}return n},t.Brain.getActorsInCells=(e,t)=>{const s=[];for(let n=0,r=e.length;n<r;n++)if(e[n].hasActors()){const r=e[n].getActors();1===r.length?t?t(r[0])&&s.push(r[0]):s.push(r[0]):r.forEach(e=>{t?t(e)&&s.push(e):s.push(e)})}return s},t.Brain.getSeenHostiles=e=>{const s=e.getBrain().getSeenCells();return t.Brain.getActorsInCells(s,t=>t.isEnemy(e))},t.Brain.findCellsWithFriends=(e,t)=>{const s=[];for(let n=0,r=t.length;n<r;n++)if(t[n].hasActors()){t[n].getSentientActors().forEach(r=>{r.getID()!==e.getID()&&(r.isEnemy(e)||s.push(t[n]))})}return s},t.Brain.getActorCellsAround=e=>t.Brain.getCellsAroundActor(e).filter(e=>e.hasActors()),t.Brain.getActorsAround=e=>{const s=t.Brain.getCellsAroundActor(e);let n=[];return s.forEach(e=>{e.hasActors()&&(n=n.concat(e.getActors()))}),n},t.Brain.getEnemyCellsAround=e=>t.Brain.getCellsAroundActor(e).filter(t=>t.hasActors()&&e.getBrain().getMemory().isEnemy(t.getActors()[0])),t.Brain.getFriendCellsAround=e=>t.Brain.getCellsAroundActor(e).filter(t=>t.hasActors()&&e.getBrain().getMemory().isFriend(t.getActors()[0])),t.Brain.distToActor=(e,t)=>{const[s,n]=e.getXY(),[r,a]=t.getXY();return function(e,t,s,n){const r=c.Geometry.getBresenham(e,t,s,n).length-1;return r>0?r:0}(s,n,r,a)},t.Brain.getTelepathyCells=function(e){const t=e.getLevel().getID(),s=e.getList("Telepathy");let n=[];return s.forEach(e=>{const s=e.getTarget(),r=s.getLevel();if(i.default.isActorActive(s)&&r.getID()===t){const e=r.getMap().getCellsInFOV(s);n=n.concat(e)}}),n};class p extends u.BrainBase{constructor(e){super(e),this.setType("NonSentient")}decideNextAction(e){return t.NO_ACTION_TAKEN}}t.BrainNonSentient=p,t.Brain.NonSentient=p;class m extends u.BrainBase{constructor(e){super(e),this._explored={},this._type="Sentient",this._memory=new h.Memory,this._cache={seen:[]}}getMemory(){return this._memory}addEnemy(e){this._memory.addEnemy(e)}addFriend(e){this._memory.addFriend(e)}addEnemyType(e){this._memory.addEnemyType(e)}decideNextAction(e){return this._cache.seen=[],i.default.err("BrainSentient","decideNextAction","Not implemented in this class"),null}getSeenCells(){if(this._cache.seen)return this._cache.seen;const e=this._actor.getLevel().getMap();if(i.default.isSentient(this._actor)){if(this._cache.seen=e.getCellsInFOV(this._actor),this._actor.has("Telepathy")){const e=t.Brain.getTelepathyCells(this._actor);this._cache.seen=this._cache.seen.concat(e)}return this._cache.seen}return i.default.warn("Brain","Sentient","Called with non-sentient actor "+this._actor.getName()),[]}canSeeCell(e){if(this._cache.seen)return this._cache.seen.indexOf(e)>=0;const t=this._actor.getLevel().getMap();return!!i.default.isSentient(this._actor)&&t.canSeeCell(this._actor,e)}canMeleeAttack(e,t){const s=this._actor.get("Combat").getAttackRange(),[n,r]=i.default.dXdYAbs([e,t],this._actor);return n<=s&&r<=s}findSeenCell(e){return this.getSeenCells().filter(e)}canSeeActor(e){const s=this.getSeenCells(),n=t.Brain.findCellsWithActors(this._actor,s);let r=!1;return n.forEach(t=>{const s=t.getActors();s&&s.forEach(t=>{t.getID()===e.getID()&&(r=!0)})}),r}findEnemyCell(e){const s=[],n=t.Brain.findCellsWithActors(this._actor,e);for(let e=0;e<n.length;e++){const t=n[e].getSentientActors();for(let r=0;r<t.length;r++)if(this._memory.isEnemy(t[r])){if(this._memory.addEnemySeenCell(t[r]),this._memory.wasLastAttacked(t[r]))return n[e];s.push(n[e])}}return s.length>0?g.arrayGetRand(s):null}findEnemyCellFast(){const[e,t]=this._actor.getXY(),s=i.default.getFOVRange(this._actor),n=c.Geometry.getBoxAround(e,t,s);let r=null;const a=this._actor.getLevel().getMap();for(let e=0;e<n.length;e++){const[t,s]=n[e];if(null!==r)break;if(a.hasXY(t,s)){const e=a.getCell(t,s);if(e.hasActors()){const t=e.getFirstActor();if(this._actor.isEnemy(t)&&(r=e,this._memory.wasLastAttacked(t)))return r}}}if(null===r)return r;const o=this.getSeenCells();return this.findEnemyCell(o)}findFriendCell(e){const s=this.getMemory(),n=t.Brain.findCellsWithActors(this._actor,e);for(let e=0;e<n.length;e++){const t=n[e].getActors();if(!s.isEnemy(t[0]))return n[e]}return null}toJSON(){return{type:this.getType(),memory:this.getMemory().toJSON()}}canPickupItem(){const e=this._actor.getCell();if(e&&e.hasItems()){const t=e.getItems()[0];return this._actor.getInvEq().canCarryItem(t)}return!1}pickupItem(){return()=>{const e=new l.Pickup;this._actor.add(e)}}tryToMoveTowardsCell(e){const s=this._actor.getLevel(),[n,r]=this._actor.getXY(),[a,o]=[e.getX(),e.getY()];let[i,c]=[a-n,o-r];i=0!==i?i/Math.abs(i):0,c=0!==c?c/Math.abs(c):0;const[u,h]=[n+i,r+c];if(s.getMap().getCell(u,h).isPassable())return()=>{const e=new l.Movement(u,h,s);this._actor.add(e)};const d=this.getShortestPathTo(e);if(d.length>1){const e=d[1].getX(),t=d[1].getY();return()=>{const n=new l.Movement(e,t,s);this._actor.add(n)}}return t.NO_ACTION_TAKEN}getSeenFriends(){const e=[],s=this.getMemory(),n=this.getSeenCells(),r=t.Brain.findCellsWithActors(this._actor,n);for(let t=0;t<r.length;t++){const n=r[t].getActors();s.isFriend(n[0])&&e.push(n[0])}return e}getSeenEnemies(){const e=this.getMemory(),s=this.getSeenCells();return t.Brain.getActorsInCells(s,t=>e.isEnemy(t))}getShortestPathTo(e){const[t,s]=e.getXY(),[n,r]=this._actor.getXY(),a=this._actor.getLevel().getMap();return f.Path.getShortestActorPath(a,n,r,t,s).map(e=>a.getCell(e.x,e.y))}getFreeCellsAround(){return t.Brain.getCellsAroundActor(this._actor).filter(e=>e.isFree())}getRandAdjacentFreeCell(){const e=this.getFreeCellsAround();return e.length>0?g.arrayGetRand(e):null}}t.BrainSentient=m,t.Brain.Sentient=m},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.mixNewShell=t.color=t.attackPenalty=t.defensePenalty=t.combatPenalty=t.speedPenalty=t.statsPenalty=t.resistance=t.directDamage=t.meleeHitDamage=void 0;const r=n(s(0)),a=s(17);function o(e,t,s){const n={value:-t,srcComp:"Stats",srcFunc:r.default.formatGetterName(e.toLowerCase()),targetComp:"StatsMods",targetFunc:r.default.formatSetterName(e.toLowerCase())};return s&&(n.dontApplyTo=s.slice()),n}function i(e,t,s){const n={value:-t,srcComp:"Combat",srcFunc:r.default.formatGetterName(e.toLowerCase()),targetComp:"CombatMods",targetFunc:r.default.formatSetterName(e.toLowerCase())};return s&&(n.dontApplyTo=s.slice()),n}t.meleeHitDamage=(e,t,s,n)=>{const a={addComp:"DirectDamage",func:[{setter:"setDamage",value:e},{setter:"setDamageType",value:r.default.DMG[s]},{setter:"setDamageCateg",value:r.default.DMG.MELEE}],duration:t};return n&&(a.expireMsg=n),a},t.directDamage=(e,s,n,a,o)=>{const i=t.meleeHitDamage(e,s,n),l=i.func;return l[2].value=r.default.DMG.DIRECT,a&&l.push({setter:"setProb",value:a}),o&&(i.expireMsg=o),i},t.resistance=function(e,t){const s=e.toUpperCase(),n=t.toUpperCase();return r.default.DMG.hasOwnProperty(s)||r.default.err("actors.ts","resistance",`No dmg type |${s}| in ${Object.keys(r.default.DMG)}`),r.default.RESISTANCE.hasOwnProperty(n)||r.default.err("actors.ts","resistance",`No dmg type |${n}| in ${Object.keys(r.default.RESISTANCE)}`),{comp:"Resistance",func:{setEffect:r.default.DMG[s],setLevel:r.default.RESISTANCE[n]}}},t.statsPenalty=o,t.speedPenalty=function(e,t){return o("speed",e,t)},t.combatPenalty=i,t.defensePenalty=function(e,t){return i("defense",e,t)},t.attackPenalty=function(e,t){return i("attack",e,t)},t.color=function(e,t){return{fg:e,bg:t}};const l=new Set(["addComp","spells","inv","equip","onAttackHit"]),c=new Set(["hp","maxHP","pp","maxPP","defense","protection","attack","danger","speed","rarity"].concat(r.default.STATS_LC)),u={damage:function(e,t,s){const n=t[e];if(s[e]){const t=s[e],r=a.Dice.create(n),o=a.Dice.create(t),i=a.Dice.combine(r,o);s[e]=i.toString()}else s[e]=n},addDamage:function(e,t,s){const n=t[e];if(s.damage){const e=a.Dice.create(n),t=a.Dice.create(s.damage),r=a.Dice.addDice(e,t);s.damage=r.toString()}}},h=new Set(["weight","value","rarity"]);function d(e,t,s,n){l.has(e)?s.hasOwnProperty(e)?s[e]=s[e].concat(t[e]):s[e]=t[e].slice():Array.isArray(t[e])?s[e]=t[e].slice():"object"==typeof t[e]?s[e]=JSON.parse(JSON.stringify(t[e])):c.has(e)?function(e,t,s){"number"==typeof t[e]?s.hasOwnProperty(e)?s[e]+=t[e]:s[e]=t[e]:p(e,t,s)}(e,t,s):h.has(e)?function(e,t,s){"number"==typeof t[e]?s.hasOwnProperty(e)?s[e]=s[e]*t[e]:s[e]=t[e]:p(e,t,s)}(e,t,s):u.hasOwnProperty(e)?u[e](e,t,s):s[e]=t[e]}t.mixNewShell=function(e,t){const s={};return e.forEach(e=>{for(const n in e)e.hasOwnProperty(n)&&d(n,e,s,t)}),s};const f=/(\*|\/)\s*(\d+(.\d+)?)/,g=/(\+|-)\s*(\d+(.\d+)?)/;function p(e,t,s){const n=function(e){let t=f.exec(e);if(t)return[t[1],parseFloat(t[2])];if(t=g.exec(e),t)return[t[1],parseFloat(t[2])];return null}(t[e]);if(!n)return void r.default.err("shell-utils.ts","checkStringExpression",`Not legal expression |${t[e]}|`);const[a,o]=n;s.hasOwnProperty(e)?"+"===a?s[e]+=o:"-"===a?s[e]-=o:"*"===a?s[e]=Math.round(s[e]*o):"/"===a?s[e]=Math.round(s[e]/o):r.default.err("shell-utils.ts","incrShellProp",`Prop ${e} value illegal: ${t[e]}`):s[e]=o}},function(e,t,s){var n=s(49),r=s(294),a=s(295),o=n?n.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":o&&o in Object(e)?r(e):a(e)}},function(e,t,s){var n=s(24).Symbol;e.exports=n},function(e,t,s){var n=s(325),r=s(111),a=s(326),o=s(170),i=s(327),l=s(48),c=s(157),u=c(n),h=c(r),d=c(a),f=c(o),g=c(i),p=l;(n&&"[object DataView]"!=p(new n(new ArrayBuffer(1)))||r&&"[object Map]"!=p(new r)||a&&"[object Promise]"!=p(a.resolve())||o&&"[object Set]"!=p(new o)||i&&"[object WeakMap]"!=p(new i))&&(p=function(e){var t=l(e),s="[object Object]"==t?e.constructor:void 0,n=s?c(s):"";if(n)switch(n){case u:return"[object DataView]";case h:return"[object Map]";case d:return"[object Promise]";case f:return"[object Set]";case g:return"[object WeakMap]"}return t}),e.exports=p},function(e,t,s){"use strict";(function(e){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <http://feross.org>
 * @license  MIT
 */
var n=s(421),r=s(422),a=s(423);function o(){return l.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function i(e,t){if(o()<t)throw new RangeError("Invalid typed array length");return l.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=l.prototype:(null===e&&(e=new l(t)),e.length=t),e}function l(e,t,s){if(!(l.TYPED_ARRAY_SUPPORT||this instanceof l))return new l(e,t,s);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return h(this,e)}return c(this,e,t,s)}function c(e,t,s,n){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,s,n){if(t.byteLength,s<0||t.byteLength<s)throw new RangeError("'offset' is out of bounds");if(t.byteLength<s+(n||0))throw new RangeError("'length' is out of bounds");t=void 0===s&&void 0===n?new Uint8Array(t):void 0===n?new Uint8Array(t,s):new Uint8Array(t,s,n);l.TYPED_ARRAY_SUPPORT?(e=t).__proto__=l.prototype:e=d(e,t);return e}(e,t,s,n):"string"==typeof t?function(e,t,s){"string"==typeof s&&""!==s||(s="utf8");if(!l.isEncoding(s))throw new TypeError('"encoding" must be a valid string encoding');var n=0|g(t,s),r=(e=i(e,n)).write(t,s);r!==n&&(e=e.slice(0,r));return e}(e,t,s):function(e,t){if(l.isBuffer(t)){var s=0|f(t.length);return 0===(e=i(e,s)).length||t.copy(e,0,0,s),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(n=t.length)!=n?i(e,0):d(e,t);if("Buffer"===t.type&&a(t.data))return d(e,t.data)}var n;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function u(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function h(e,t){if(u(t),e=i(e,t<0?0:0|f(t)),!l.TYPED_ARRAY_SUPPORT)for(var s=0;s<t;++s)e[s]=0;return e}function d(e,t){var s=t.length<0?0:0|f(t.length);e=i(e,s);for(var n=0;n<s;n+=1)e[n]=255&t[n];return e}function f(e){if(e>=o())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o().toString(16)+" bytes");return 0|e}function g(e,t){if(l.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var s=e.length;if(0===s)return 0;for(var n=!1;;)switch(t){case"ascii":case"latin1":case"binary":return s;case"utf8":case"utf-8":case void 0:return W(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*s;case"hex":return s>>>1;case"base64":return Y(e).length;default:if(n)return W(e).length;t=(""+t).toLowerCase(),n=!0}}function p(e,t,s){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===s||s>this.length)&&(s=this.length),s<=0)return"";if((s>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return N(this,t,s);case"utf8":case"utf-8":return O(this,t,s);case"ascii":return A(this,t,s);case"latin1":case"binary":return M(this,t,s);case"base64":return T(this,t,s);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return P(this,t,s);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function m(e,t,s){var n=e[t];e[t]=e[s],e[s]=n}function y(e,t,s,n,r){if(0===e.length)return-1;if("string"==typeof s?(n=s,s=0):s>2147483647?s=2147483647:s<-2147483648&&(s=-2147483648),s=+s,isNaN(s)&&(s=r?0:e.length-1),s<0&&(s=e.length+s),s>=e.length){if(r)return-1;s=e.length-1}else if(s<0){if(!r)return-1;s=0}if("string"==typeof t&&(t=l.from(t,n)),l.isBuffer(t))return 0===t.length?-1:_(e,t,s,n,r);if("number"==typeof t)return t&=255,l.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?r?Uint8Array.prototype.indexOf.call(e,t,s):Uint8Array.prototype.lastIndexOf.call(e,t,s):_(e,[t],s,n,r);throw new TypeError("val must be string, number or Buffer")}function _(e,t,s,n,r){var a,o=1,i=e.length,l=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;o=2,i/=2,l/=2,s/=2}function c(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(r){var u=-1;for(a=s;a<i;a++)if(c(e,a)===c(t,-1===u?0:a-u)){if(-1===u&&(u=a),a-u+1===l)return u*o}else-1!==u&&(a-=a-u),u=-1}else for(s+l>i&&(s=i-l),a=s;a>=0;a--){for(var h=!0,d=0;d<l;d++)if(c(e,a+d)!==c(t,d)){h=!1;break}if(h)return a}return-1}function b(e,t,s,n){s=Number(s)||0;var r=e.length-s;n?(n=Number(n))>r&&(n=r):n=r;var a=t.length;if(a%2!=0)throw new TypeError("Invalid hex string");n>a/2&&(n=a/2);for(var o=0;o<n;++o){var i=parseInt(t.substr(2*o,2),16);if(isNaN(i))return o;e[s+o]=i}return o}function v(e,t,s,n){return j(W(t,e.length-s),e,s,n)}function E(e,t,s,n){return j(function(e){for(var t=[],s=0;s<e.length;++s)t.push(255&e.charCodeAt(s));return t}(t),e,s,n)}function S(e,t,s,n){return E(e,t,s,n)}function w(e,t,s,n){return j(Y(t),e,s,n)}function C(e,t,s,n){return j(function(e,t){for(var s,n,r,a=[],o=0;o<e.length&&!((t-=2)<0);++o)s=e.charCodeAt(o),n=s>>8,r=s%256,a.push(r),a.push(n);return a}(t,e.length-s),e,s,n)}function T(e,t,s){return 0===t&&s===e.length?n.fromByteArray(e):n.fromByteArray(e.slice(t,s))}function O(e,t,s){s=Math.min(e.length,s);for(var n=[],r=t;r<s;){var a,o,i,l,c=e[r],u=null,h=c>239?4:c>223?3:c>191?2:1;if(r+h<=s)switch(h){case 1:c<128&&(u=c);break;case 2:128==(192&(a=e[r+1]))&&(l=(31&c)<<6|63&a)>127&&(u=l);break;case 3:a=e[r+1],o=e[r+2],128==(192&a)&&128==(192&o)&&(l=(15&c)<<12|(63&a)<<6|63&o)>2047&&(l<55296||l>57343)&&(u=l);break;case 4:a=e[r+1],o=e[r+2],i=e[r+3],128==(192&a)&&128==(192&o)&&128==(192&i)&&(l=(15&c)<<18|(63&a)<<12|(63&o)<<6|63&i)>65535&&l<1114112&&(u=l)}null===u?(u=65533,h=1):u>65535&&(u-=65536,n.push(u>>>10&1023|55296),u=56320|1023&u),n.push(u),r+=h}return function(e){var t=e.length;if(t<=4096)return String.fromCharCode.apply(String,e);var s="",n=0;for(;n<t;)s+=String.fromCharCode.apply(String,e.slice(n,n+=4096));return s}(n)}t.Buffer=l,t.SlowBuffer=function(e){+e!=e&&(e=0);return l.alloc(+e)},t.INSPECT_MAX_BYTES=50,l.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=o(),l.poolSize=8192,l._augment=function(e){return e.__proto__=l.prototype,e},l.from=function(e,t,s){return c(null,e,t,s)},l.TYPED_ARRAY_SUPPORT&&(l.prototype.__proto__=Uint8Array.prototype,l.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&l[Symbol.species]===l&&Object.defineProperty(l,Symbol.species,{value:null,configurable:!0})),l.alloc=function(e,t,s){return function(e,t,s,n){return u(t),t<=0?i(e,t):void 0!==s?"string"==typeof n?i(e,t).fill(s,n):i(e,t).fill(s):i(e,t)}(null,e,t,s)},l.allocUnsafe=function(e){return h(null,e)},l.allocUnsafeSlow=function(e){return h(null,e)},l.isBuffer=function(e){return!(null==e||!e._isBuffer)},l.compare=function(e,t){if(!l.isBuffer(e)||!l.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var s=e.length,n=t.length,r=0,a=Math.min(s,n);r<a;++r)if(e[r]!==t[r]){s=e[r],n=t[r];break}return s<n?-1:n<s?1:0},l.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},l.concat=function(e,t){if(!a(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return l.alloc(0);var s;if(void 0===t)for(t=0,s=0;s<e.length;++s)t+=e[s].length;var n=l.allocUnsafe(t),r=0;for(s=0;s<e.length;++s){var o=e[s];if(!l.isBuffer(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(n,r),r+=o.length}return n},l.byteLength=g,l.prototype._isBuffer=!0,l.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)m(this,t,t+1);return this},l.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)m(this,t,t+3),m(this,t+1,t+2);return this},l.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)m(this,t,t+7),m(this,t+1,t+6),m(this,t+2,t+5),m(this,t+3,t+4);return this},l.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?O(this,0,e):p.apply(this,arguments)},l.prototype.equals=function(e){if(!l.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===l.compare(this,e)},l.prototype.inspect=function(){var e="",s=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,s).match(/.{2}/g).join(" "),this.length>s&&(e+=" ... ")),"<Buffer "+e+">"},l.prototype.compare=function(e,t,s,n,r){if(!l.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===s&&(s=e?e.length:0),void 0===n&&(n=0),void 0===r&&(r=this.length),t<0||s>e.length||n<0||r>this.length)throw new RangeError("out of range index");if(n>=r&&t>=s)return 0;if(n>=r)return-1;if(t>=s)return 1;if(this===e)return 0;for(var a=(r>>>=0)-(n>>>=0),o=(s>>>=0)-(t>>>=0),i=Math.min(a,o),c=this.slice(n,r),u=e.slice(t,s),h=0;h<i;++h)if(c[h]!==u[h]){a=c[h],o=u[h];break}return a<o?-1:o<a?1:0},l.prototype.includes=function(e,t,s){return-1!==this.indexOf(e,t,s)},l.prototype.indexOf=function(e,t,s){return y(this,e,t,s,!0)},l.prototype.lastIndexOf=function(e,t,s){return y(this,e,t,s,!1)},l.prototype.write=function(e,t,s,n){if(void 0===t)n="utf8",s=this.length,t=0;else if(void 0===s&&"string"==typeof t)n=t,s=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(s)?(s|=0,void 0===n&&(n="utf8")):(n=s,s=void 0)}var r=this.length-t;if((void 0===s||s>r)&&(s=r),e.length>0&&(s<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var a=!1;;)switch(n){case"hex":return b(this,e,t,s);case"utf8":case"utf-8":return v(this,e,t,s);case"ascii":return E(this,e,t,s);case"latin1":case"binary":return S(this,e,t,s);case"base64":return w(this,e,t,s);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,e,t,s);default:if(a)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),a=!0}},l.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function A(e,t,s){var n="";s=Math.min(e.length,s);for(var r=t;r<s;++r)n+=String.fromCharCode(127&e[r]);return n}function M(e,t,s){var n="";s=Math.min(e.length,s);for(var r=t;r<s;++r)n+=String.fromCharCode(e[r]);return n}function N(e,t,s){var n=e.length;(!t||t<0)&&(t=0),(!s||s<0||s>n)&&(s=n);for(var r="",a=t;a<s;++a)r+=G(e[a]);return r}function P(e,t,s){for(var n=e.slice(t,s),r="",a=0;a<n.length;a+=2)r+=String.fromCharCode(n[a]+256*n[a+1]);return r}function D(e,t,s){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>s)throw new RangeError("Trying to access beyond buffer length")}function I(e,t,s,n,r,a){if(!l.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>r||t<a)throw new RangeError('"value" argument is out of bounds');if(s+n>e.length)throw new RangeError("Index out of range")}function L(e,t,s,n){t<0&&(t=65535+t+1);for(var r=0,a=Math.min(e.length-s,2);r<a;++r)e[s+r]=(t&255<<8*(n?r:1-r))>>>8*(n?r:1-r)}function x(e,t,s,n){t<0&&(t=4294967295+t+1);for(var r=0,a=Math.min(e.length-s,4);r<a;++r)e[s+r]=t>>>8*(n?r:3-r)&255}function k(e,t,s,n,r,a){if(s+n>e.length)throw new RangeError("Index out of range");if(s<0)throw new RangeError("Index out of range")}function R(e,t,s,n,a){return a||k(e,0,s,4),r.write(e,t,s,n,23,4),s+4}function B(e,t,s,n,a){return a||k(e,0,s,8),r.write(e,t,s,n,52,8),s+8}l.prototype.slice=function(e,t){var s,n=this.length;if((e=~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),(t=void 0===t?n:~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),t<e&&(t=e),l.TYPED_ARRAY_SUPPORT)(s=this.subarray(e,t)).__proto__=l.prototype;else{var r=t-e;s=new l(r,void 0);for(var a=0;a<r;++a)s[a]=this[a+e]}return s},l.prototype.readUIntLE=function(e,t,s){e|=0,t|=0,s||D(e,t,this.length);for(var n=this[e],r=1,a=0;++a<t&&(r*=256);)n+=this[e+a]*r;return n},l.prototype.readUIntBE=function(e,t,s){e|=0,t|=0,s||D(e,t,this.length);for(var n=this[e+--t],r=1;t>0&&(r*=256);)n+=this[e+--t]*r;return n},l.prototype.readUInt8=function(e,t){return t||D(e,1,this.length),this[e]},l.prototype.readUInt16LE=function(e,t){return t||D(e,2,this.length),this[e]|this[e+1]<<8},l.prototype.readUInt16BE=function(e,t){return t||D(e,2,this.length),this[e]<<8|this[e+1]},l.prototype.readUInt32LE=function(e,t){return t||D(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},l.prototype.readUInt32BE=function(e,t){return t||D(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},l.prototype.readIntLE=function(e,t,s){e|=0,t|=0,s||D(e,t,this.length);for(var n=this[e],r=1,a=0;++a<t&&(r*=256);)n+=this[e+a]*r;return n>=(r*=128)&&(n-=Math.pow(2,8*t)),n},l.prototype.readIntBE=function(e,t,s){e|=0,t|=0,s||D(e,t,this.length);for(var n=t,r=1,a=this[e+--n];n>0&&(r*=256);)a+=this[e+--n]*r;return a>=(r*=128)&&(a-=Math.pow(2,8*t)),a},l.prototype.readInt8=function(e,t){return t||D(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},l.prototype.readInt16LE=function(e,t){t||D(e,2,this.length);var s=this[e]|this[e+1]<<8;return 32768&s?4294901760|s:s},l.prototype.readInt16BE=function(e,t){t||D(e,2,this.length);var s=this[e+1]|this[e]<<8;return 32768&s?4294901760|s:s},l.prototype.readInt32LE=function(e,t){return t||D(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},l.prototype.readInt32BE=function(e,t){return t||D(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},l.prototype.readFloatLE=function(e,t){return t||D(e,4,this.length),r.read(this,e,!0,23,4)},l.prototype.readFloatBE=function(e,t){return t||D(e,4,this.length),r.read(this,e,!1,23,4)},l.prototype.readDoubleLE=function(e,t){return t||D(e,8,this.length),r.read(this,e,!0,52,8)},l.prototype.readDoubleBE=function(e,t){return t||D(e,8,this.length),r.read(this,e,!1,52,8)},l.prototype.writeUIntLE=function(e,t,s,n){(e=+e,t|=0,s|=0,n)||I(this,e,t,s,Math.pow(2,8*s)-1,0);var r=1,a=0;for(this[t]=255&e;++a<s&&(r*=256);)this[t+a]=e/r&255;return t+s},l.prototype.writeUIntBE=function(e,t,s,n){(e=+e,t|=0,s|=0,n)||I(this,e,t,s,Math.pow(2,8*s)-1,0);var r=s-1,a=1;for(this[t+r]=255&e;--r>=0&&(a*=256);)this[t+r]=e/a&255;return t+s},l.prototype.writeUInt8=function(e,t,s){return e=+e,t|=0,s||I(this,e,t,1,255,0),l.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},l.prototype.writeUInt16LE=function(e,t,s){return e=+e,t|=0,s||I(this,e,t,2,65535,0),l.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):L(this,e,t,!0),t+2},l.prototype.writeUInt16BE=function(e,t,s){return e=+e,t|=0,s||I(this,e,t,2,65535,0),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):L(this,e,t,!1),t+2},l.prototype.writeUInt32LE=function(e,t,s){return e=+e,t|=0,s||I(this,e,t,4,4294967295,0),l.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):x(this,e,t,!0),t+4},l.prototype.writeUInt32BE=function(e,t,s){return e=+e,t|=0,s||I(this,e,t,4,4294967295,0),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):x(this,e,t,!1),t+4},l.prototype.writeIntLE=function(e,t,s,n){if(e=+e,t|=0,!n){var r=Math.pow(2,8*s-1);I(this,e,t,s,r-1,-r)}var a=0,o=1,i=0;for(this[t]=255&e;++a<s&&(o*=256);)e<0&&0===i&&0!==this[t+a-1]&&(i=1),this[t+a]=(e/o>>0)-i&255;return t+s},l.prototype.writeIntBE=function(e,t,s,n){if(e=+e,t|=0,!n){var r=Math.pow(2,8*s-1);I(this,e,t,s,r-1,-r)}var a=s-1,o=1,i=0;for(this[t+a]=255&e;--a>=0&&(o*=256);)e<0&&0===i&&0!==this[t+a+1]&&(i=1),this[t+a]=(e/o>>0)-i&255;return t+s},l.prototype.writeInt8=function(e,t,s){return e=+e,t|=0,s||I(this,e,t,1,127,-128),l.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},l.prototype.writeInt16LE=function(e,t,s){return e=+e,t|=0,s||I(this,e,t,2,32767,-32768),l.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):L(this,e,t,!0),t+2},l.prototype.writeInt16BE=function(e,t,s){return e=+e,t|=0,s||I(this,e,t,2,32767,-32768),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):L(this,e,t,!1),t+2},l.prototype.writeInt32LE=function(e,t,s){return e=+e,t|=0,s||I(this,e,t,4,2147483647,-2147483648),l.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):x(this,e,t,!0),t+4},l.prototype.writeInt32BE=function(e,t,s){return e=+e,t|=0,s||I(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):x(this,e,t,!1),t+4},l.prototype.writeFloatLE=function(e,t,s){return R(this,e,t,!0,s)},l.prototype.writeFloatBE=function(e,t,s){return R(this,e,t,!1,s)},l.prototype.writeDoubleLE=function(e,t,s){return B(this,e,t,!0,s)},l.prototype.writeDoubleBE=function(e,t,s){return B(this,e,t,!1,s)},l.prototype.copy=function(e,t,s,n){if(s||(s=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<s&&(n=s),n===s)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(s<0||s>=this.length)throw new RangeError("sourceStart out of bounds");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-s&&(n=e.length-t+s);var r,a=n-s;if(this===e&&s<t&&t<n)for(r=a-1;r>=0;--r)e[r+t]=this[r+s];else if(a<1e3||!l.TYPED_ARRAY_SUPPORT)for(r=0;r<a;++r)e[r+t]=this[r+s];else Uint8Array.prototype.set.call(e,this.subarray(s,s+a),t);return a},l.prototype.fill=function(e,t,s,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,s=this.length):"string"==typeof s&&(n=s,s=this.length),1===e.length){var r=e.charCodeAt(0);r<256&&(e=r)}if(void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!l.isEncoding(n))throw new TypeError("Unknown encoding: "+n)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<s)throw new RangeError("Out of range index");if(s<=t)return this;var a;if(t>>>=0,s=void 0===s?this.length:s>>>0,e||(e=0),"number"==typeof e)for(a=t;a<s;++a)this[a]=e;else{var o=l.isBuffer(e)?e:W(new l(e,n).toString()),i=o.length;for(a=0;a<s-t;++a)this[a+t]=o[a%i]}return this};var F=/[^+\/0-9A-Za-z-_]/g;function G(e){return e<16?"0"+e.toString(16):e.toString(16)}function W(e,t){var s;t=t||1/0;for(var n=e.length,r=null,a=[],o=0;o<n;++o){if((s=e.charCodeAt(o))>55295&&s<57344){if(!r){if(s>56319){(t-=3)>-1&&a.push(239,191,189);continue}if(o+1===n){(t-=3)>-1&&a.push(239,191,189);continue}r=s;continue}if(s<56320){(t-=3)>-1&&a.push(239,191,189),r=s;continue}s=65536+(r-55296<<10|s-56320)}else r&&(t-=3)>-1&&a.push(239,191,189);if(r=null,s<128){if((t-=1)<0)break;a.push(s)}else if(s<2048){if((t-=2)<0)break;a.push(s>>6|192,63&s|128)}else if(s<65536){if((t-=3)<0)break;a.push(s>>12|224,s>>6&63|128,63&s|128)}else{if(!(s<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;a.push(s>>18|240,s>>12&63|128,s>>6&63|128,63&s|128)}}return a}function Y(e){return n.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(F,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function j(e,t,s,n){for(var r=0;r<n&&!(r+s>=t.length||r>=e.length);++r)t[r+s]=e[r];return r}}).call(this,s(28))},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.verifyDirs=t.verifyTiles=t.ElemTemplate=t.Template=void 0;const r=n(s(0));t.Template={},t.Template.$DEBUG=0;const a=/[A-Z]/,o=/\s*=\s*/,i=/\s*:\s*/,l=e=>{t.Template.$DEBUG&&console.log("[DEBUG "+e)};function c(e){const t=e.length,s={},n=[1];let r="",o="",i=0;for(let l=1;l<t;l++)o=e[l],a.test(o)?i>0?r===o?++i:(s[n.length]=i,n.push(i),i=1):++i:i>0?(s[n.length]=i,n.push(i),n.push(1),i=0):n.push(1),r=o;return i>0&&(s[n.length]=i,n.push(i)),{genPos:s,widths:n}}t.Template.createTemplate=function(e){const s=e.split("\n");let n=0,a=s[0];0===a.length&&(a=s[++n]);const u={},h={};for(;a&&a.length>0;){if(o.test(a)){const e=a.split(o);if(2===e.length){const t=e[0],s=e[1];t.length===s.length?u[e[0]]=e[1]:r.default.err("Template","createTemplate",`Key ${t}, val ${s} have different len`)}}else if(i.test(a)){const e=a.split(i);if(2===e.length){const t=e[0],s=e[1];h[t]=s}else r.default.warn("Template","createTemplate","Prop must be key:val. Ignoring line "+a)}++n,a=s[n]}n===s.length&&r.default.err("Template","createTemplate","No empty line between header and template section."),++n;const d=[];for(;n<s.length;)d.push(s[n]),++n;let f=d[0].split("");const{genPos:g,widths:p}=c(f);l(JSON.stringify(g)),l(JSON.stringify(p));const m=[],y=[];let _=0;for(let e=0;e<d.length;e++){let t=0,s=0;y.push([]),f=d[e].split(""),l(JSON.stringify(`y: ${_} currLineArr: ${f}`)),m.push(f[0]);for(let e=0;e<p.length;e++){const n=p[e],r=f.slice(t,t+n);l(`x: ${t}, w: ${n}, elem: ${r}`),r&&(y[_][s]=r),t+=n,++s}++_}y.forEach((e,t)=>{l(`Row[${t}]: ${JSON.stringify(e)}`)}),l("firstCols is: "+JSON.stringify(m));const{genPos:b,widths:v}=c(m);l("@yGenPos: "+JSON.stringify(b)),l("@yWidths: "+JSON.stringify(v));const E={xGenPos:g,yGenPos:b,xWidths:p,yWidths:v,rows:y,elemMap:u},S=new t.ElemTemplate(E);return S.setProps(h),S},t.ElemTemplate=function(e){if(e&&(this.elemMap=e.elemMap,this.nMaps=Object.keys(this.elemMap).length,this.sizeX=e.xWidths.length,this.sizeY=e.rows.length,this.xWidths=e.xWidths,this.yWidths=e.yWidths,this.xGenPos=e.xGenPos,this.yGenPos=e.yGenPos),this.elemPropMap={},this.elemArr=[],this.hasGenRow={},e){for(let t=0;t<this.sizeX;t++){this.elemArr[t]=[];for(let s=0;s<this.sizeY;s++)this.elemArr[t][s]=e.rows[s][t].join("")}Object.keys(this.xGenPos).forEach(e=>{for(let t=0;t<this.sizeY;t++){const s=this.elemArr[e][t];this.elemArr[e][t]=new u(s)}})}this.setProps=function(e){this.elemPropMap=e},this.getProp=function(e){return this.elemPropMap[e]},this.getDir=function(){const e=this.getProp("dir");return e?e.split("").sort().join(""):""},this.setProp=function(e,t){this.elemPropMap[e]=t},this.getChars=function(e){if(e){if(Number.isInteger(e)){const t=e;e=[];for(let s=0;s<this.nMaps;s++)e.push(t)}}else{e=[];for(let t=0;t<this.nMaps;t++)e.push(1)}if(!(e.length>0&&e.length<this.nMaps)){let t=0,s=!1;const n=[];for(let r=0;r<this.sizeX;r++){n[r]=[];for(let a=0;a<this.sizeY;a++)if("object"==typeof this.elemArr[r][a]){const o=e[t];n[r][a]=this.elemArr[r][a].getChars(o),s=!0}else n[r][a]=this.elemArr[r][a];s&&(++t,s=!1)}this.substituteXMaps(n),l("X before split: "+JSON.stringify(n));const a=this.splitMultiElements(n);if(l("After-X, Before-Y: "+JSON.stringify(a)),Object.keys(this.yGenPos).length>0){const s=[];for(let e=0;e<this.sizeX;e++){s[e]=[];let t=0,r=0;this.yWidths.forEach(a=>{s[e][t]=n[e].slice(r,r+a),++t,r+=a})}l("y after widths "+JSON.stringify(s)),Object.keys(this.yGenPos).forEach(n=>{for(let r=0;r<this.sizeX;r++)s[r][n]=this.expandYGen(e[t],s[r][n]);++t});const a=r.default.flattenTo2D(s);l("y after flatten "+JSON.stringify(a));const o=this.splitMultiElements(a);return l("y after flatten "+JSON.stringify(o)),this.substituteYMaps(o),o}return l("X-Before subst: "+JSON.stringify(n)),l("X-After, split: "+JSON.stringify(a)),a}return r.default.err("ElemTemplate","getChars",`Input array length must be ${this.nMaps}.`),[]},this.expandYGen=(e,t)=>{l(`expandYGen ${e} -> ${t}`);const s=[];for(let n=0;n<e;n++)s.push(t);return s},this.substituteXMaps=function(e){const t=e.length;Object.keys(this.elemMap).forEach(s=>{const n=new RegExp(s,"g");for(let r=0;r<t;r++)e[r][0]=e[r][0].replace(n,this.elemMap[s])})},this.substituteYMaps=function(e){let s=[];const n=e[0].length;for(let t=0;t<n;t++)s.push(e[0][t]);l("firstCol is now: "+JSON.stringify(s));let a=s.join("");Object.keys(this.elemMap).forEach(e=>{const t=new RegExp(e,"g");a=a.replace(t,this.elemMap[e])}),s=a.split(""),l("firstCol END: "+JSON.stringify(s)),t.Template.$DEBUG&&r.default.printMap(e);for(let t=0;t<n;t++)e[0][t]=s[t]},this.splitMultiElements=e=>{const t=e.length,s=[];let n=0;for(let r=0;r<t;r++){const t=e[r],a=t[0].length;if(a>1){l(`Splitting ${a} nChars: ${t}`);for(let e=0;e<t.length;e++){const r=t[e];let a=n;r.split("").forEach(t=>{0===e?(s.push([t]),l("\tres push "+JSON.stringify(s))):(s[a++].push(t),l("\tres[x] push "+JSON.stringify(s)))})}n+=a}else++n,s.push(t)}return s},this.clone=()=>{const e=new t.ElemTemplate,s=JSON.parse(JSON.stringify(this));return Object.keys(s).forEach(t=>{e[t]=s[t]}),Object.keys(this.xGenPos).forEach(t=>{for(let s=0;s<this.sizeY;s++){const n=e.elemArr[t][s].genX;e.elemArr[t][s]=new u(n)}}),e}},t.Template.ElemTemplate=t.ElemTemplate;class u{constructor(e){this.str=e,this.len=e.length,this.str=e}length(){return this.len}getChars(e=1){return this.str.repeat(e)}toJSON(){return{genX:this.str}}}t.Template.ElemGenX=u;const h=/(\.|\+)/;function d(e,t){const s=e.getDir();if(""===s)return!0;const n=e.getChars(t),a=r.default.colsToRows(n);let o=!1;return/N/.test(s)&&a[0].forEach(e=>{let t=e;"string"!=typeof t&&(t=e.getChars()),h.test(t)&&(o=!0)}),/S/.test(s)&&(o=!1,a[a.length-1].forEach(e=>{let t=e;"string"!=typeof t&&(t=e.getChars()),h.test(t)&&(o=!0)})),/W/.test(s)&&n[0].forEach(e=>{let t=e;"string"!=typeof t&&(t=e.getChars()),h.test(t)&&(o=!0)}),/E/.test(s)&&(o=!1,n[n.length-1].forEach(e=>{let t=e;"string"!=typeof t&&(t=e.getChars()),h.test(t)&&(o=!0)})),o}t.verifyTiles=function(e,t,s,n=[1,1,1,1]){s.forEach(s=>{if(!d(s,n)){const a=JSON.stringify(s),o=s.getProp("name"),i=s.getChars(n);r.default.printMap(i),r.default.err(e,t,`Tile ${o} failed the checks: ${a}`)}})},t.verifyDirs=d;const f={N:"E",E:"S",S:"W",W:"N"},g={rotate90:f,rotate180:f,rotate270:f};t.Template.rotateR90=function(e,t=f){const s=e.clone();m(s,t);const n=[];let r=Object.keys(s.xGenPos).length;r+=Object.keys(s.yGenPos).length;for(let e=0;e<r;e++)n.push(1);const a=s.getChars(n),o=a[0].length,i=new Array(o);for(let e=0;e<o;e++)i[e]=[];for(let e=0;e<a.length;e++)for(let t=0;t<o;t++)i[o-1-t].push(a[e][t]);s.yGenPos=Object.assign({},e.xGenPos);const l=i.length;return s.xGenPos={},Object.keys(e.yGenPos).forEach(t=>{const n=l-1-parseInt(t,10);s.xGenPos[n]=e.yGenPos[t]}),s.elemArr=i,Object.keys(s.xGenPos).forEach(e=>{for(let t=0;t<s.sizeY;t++)try{s.elemArr[e][t]=new u(s.elemArr[e][t])}catch(e){throw console.log("Template:",s.getProp("name")),console.log("xGenPos: ",s.xGenPos),new Error(e)}}),s},t.Template.rotateR180=function(e,s=f){const n=t.Template.rotateR90(e,s);return t.Template.rotateR90(n,s)},t.Template.rotateR270=function(e,s=f){const n=t.Template.rotateR180(e,s);return t.Template.rotateR90(n,s)};const p={E:"W",W:"E"};function m(e,t){const s=e.getProp("dir");if(s){const n=s.split("");n.forEach((e,s)=>{t.hasOwnProperty(e)&&(n[s]=t[e])}),e.setProp("dir",n.join(""))}}function y(e,t){let s=t.getProp("name");switch(e){case"rotateR90":s+="_r90";break;case"rotateR180":s+="_r180";break;case"rotateR270":s+="_r270";break;case"flipVer":s+="_flip"}t.setProp("name",s)}g.flipVer=p,t.Template.flipVer=function(e,t=p){const s=e.clone();m(s,t);const n=[];let r=Object.keys(s.xGenPos).length;r+=Object.keys(s.yGenPos).length;for(let e=0;e<r;e++)n.push(1);const a=s.sizeX,o=new Array(a);for(let e=0;e<a;e++)o[e]=[];const i=s.sizeY,l=s.getChars(n);for(let e=0;e<a;e++)for(let t=0;t<i;t++)o[a-1-e][t]=l[e][t];const c=o.length;return s.xGenPos={},Object.keys(e.xGenPos).forEach(t=>{if(parseInt(t,10)<c-1){const n=c-1-parseInt(t,10);s.xGenPos[n]=e.xGenPos[t]}else{const n=t;s.xGenPos[n]=e.xGenPos[t]}}),s.elemArr=o,Object.keys(s.xGenPos).forEach(e=>{for(let t=0;t<s.sizeY;t++)s.elemArr[e][t]=new u(s.elemArr[e][t])}),s},t.Template.transformList=function(e,s,n){r.default.isNullOrUndef([e])&&r.default.err("Template","transformList","Input list templates is null");let a=[];return s||(s={all:"*",flipVer:[],rotateR90:[],rotateR180:[],rotateR270:[]}),Object.keys(s).forEach(r=>{if("all"!==r){const o=[];let i=s[r];i="*"===s.all?e.map(e=>e.getProp("name")):i.concat(s.all),i.forEach(a=>{const i=e.find(e=>e.getProp("name")===a);if(i){const e=n?n[r]:g[r],l=t.Template[r](i,e);if(y(r,l),o.push(l),"flipVer"===r){(function(e,t){const s=[];return["rotateR90","rotateR180","rotateR270"].forEach(n=>{(e[n].indexOf(t)>=0||"*"===e.all)&&s.push(n)}),s})(s,a).forEach(e=>{const s=n?n[e]:g[e],r=t.Template[e](l,s);y(e,r),o.push(r)})}}}),a=a.concat(o)}}),a}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DungeonPopulate=void 0;const i=o(s(0)),l=s(1),c=s(4),u=s(23),h=s(30),d=s(45),f=s(91),g=a(s(2)),p=s(32),m=a(s(26)),y=a(s(7)),_=s(6),b=s(133),v=s(72),E=s(63),S=s(18),w=l.Random.getRNG(),C=["NOTHING","LOOT","GOLD","GUARDIAN","ELEMENT","CORPSE","TIP"];t.DungeonPopulate=class{constructor(e={}){this.theme=e.theme||"",this.maxDanger=e.maxDanger||5,this.maxValue=e.maxValue||50,this._itemFact=new d.FactoryItem,this._actorFact=new f.FactoryActor,e.actorFunc?this.actorFunc=e.actorFunc:this.actorFunc=e=>!!e&&!0}populateLevel(e){const t=e.getExtras(),s=this.maxDanger,n=this.maxValue;let r=!1;const a={};t.bigRooms&&t.bigRooms.forEach(t=>{const{room:o,type:l}=t,c=S.BBox.fromBBox(o.getBbox()),u=o.getAreaSize(),h={maxDanger:s,actor:e=>e.danger<=s+2,nActors:0};let d=!1;if(/cross/.test(l)?(h.nActors=Math.floor(u/6),d=this.addActorsToBbox(e,c,h)):(h.nActors=Math.floor(u/3),d=this.addActorsToBbox(e,c,h)),!d){const e="Failed to add actors to bbox ";i.default.warn("DungeonPopulate","populateLevel",e+JSON.stringify(c))}if(!r){const t=o.getCenter();r=this.addMainLoot(e,t,n)}a[o.getID()]=!0}),t.terms&&t.terms.forEach(t=>{if(!t.hasStairsUp()){const s=t.getBbox();if(!r){const s=t.getCenter();r=this.addMainLoot(e,s,n)}const a=t.getAreaSize(),o=Math.ceil(a/10),i={maxValue:n,itemsPerLevel:o,item:e=>e.value<=n};this.addItemsToBbox(e,s,i);c.Geometry.getCoordBbox(s).forEach(t=>{const s=new y.ElementMarker("e");s.setTag("enemy"),e.addElement(s,t[0],t[1])})}a[t.getID()]=!0}),t.rooms&&t.rooms.forEach(t=>{const r=t.getBbox(),o=t.getAreaSize(),i={maxDanger:s,actor:e=>e.danger<=s,nActors:Math.floor(o/6)};i.nActors<2&&(i.nActors=2),this.addActorsToBbox(e,r,i);const l=Math.ceil(o/20),c={maxValue:n,itemsPerLevel:l,item:e=>e.value<=n};this.addItemsToBbox(e,r,c),a[t.getID()]=!0}),t.endPoint&&this.addPointGuardian(e,t.endPoint,s)}setActorFunc(e){"function"==typeof e?this.actorFunc=e:i.default.err("DungeonPopulate","setActorFunc",`Tried to set non-function ${e} as actorFunc`)}addPointGuardian(e,t,s){const n=t;(i.default.isNullOrUndef([s])||s<1)&&i.default.err("DungeonPopulate","addPointGuardian",`maxDanger must be > 0. Got: |${s}|`);const r=this.getEndPointGuardian(s);if(r){const t=r.getBrain();if(t.getGoal){const e=new u.Evaluator.Guard(i.default.BIAS.Guard,n);t.getGoal().addEvaluator(e)}return e.addActor(r,n[0],n[1])}{const e="Could not get guardian for endpoint: "+t;i.default.warn("DungeonPopulate","addPointGuardian",e)}return!1}getEndPointGuardian(e){let t=e,s=null,n=t=>s=>s.danger<=e&&s.danger>=t;for(this.actorFunc&&(n=e=>s=>this.actorFunc(s)&&s.danger<=t&&s.danger>=e);!s&&t>0;)s=this._actorFact.createRandomActor({func:n(t)}),--t;return s}addMainLoot(e,t,s){const[n,r]=t,a=w.getUniformInt(2,3),o=a*s,l=(a-1)*s,c=e=>e.value>=l&&e.value<=o;let u=null;if(i.default.isSuccess(.5)){const e=_.ObjectShell.getParser(),t=b.ItemGen.genRandShellWith(c);u=e.createFromShell(i.default.TYPE_ITEM,t)}else u=this._itemFact.createItem({func:c});return!!u&&(e.addItem(u,n,r),!0)}populatePoint(e,t,s){const{maxDanger:n}=s;switch(w.arrayGetRand(C)){case"NOTHING":break;case"LOOT":this.addLootToPoint(e,t);break;case"GUARDIAN":this.addPointGuardian(e,t,n);break;case"ELEMENT":this.addElementToPoint(e,t,s);break;case"CORPSE":this.addCorpseToPoint(e,t,s);break;case"GOLD":this.addGoldToPoint(e,t);break;case"TIP":this.addTipToPoint(e,t,s)}}addElementToPoint(e,t,s){s.true}addCorpseToPoint(e,t,s){s.true}addLootToPoint(e,t){const s=this.maxValue,n=[i.default.ITEM.POTION,i.default.ITEM.SPIRITGEM,i.default.ITEM.AMMUNITION,i.default.ITEM.POTION,i.default.ITEM.RUNE],r=w.arrayGetRand(n),a=_.ObjectShell.getParser().createRandomItem({func:e=>e.type>=r&&e.value<=s});if(a){const[s,n]=t;return e.addItem(a,s,n),!0}return!1}addGoldToPoint(e,t){const s=this.maxValue,n=new m.GoldCoin;n.setCount(s);const[r,a]=t;return e.addItem(n,r,a)}addTipToPoint(e,t,s){s.true}createShops(e,t){const s=e.getExtras(),n=[];if(!s.hasOwnProperty("houses"))return i.default.err("DungeonPopulate","createShops","No houses in extras."),n;const r=s.houses,a=[];let o=0;s.shops=[];for(let l=0;l<t.nShops;l++){const c=new p.WorldShop;let h=w.randIndex(r);for(;a.indexOf(h)>=0;)h=w.randIndex(r),++o,o===2*r.length&&i.default.err("DungeonPopulate","createShops","WatchDog reached max houses");a.push(h);const d=s.houses[h];n.push(d);const f=d.floor,[m,b]=d.door,v=e.getMap().getCell(m,b);if(!v.hasDoor()){const t=new y.ElementDoor(!0);e.addElement(t,m,b)}const E=this.createShopkeeper(t),S=[];let C=!1;for(let s=0;s<f.length;s++){const n=f[s],r=new y.ElementShop;r.setShopkeeper(E),e.addElement(r,n[0],n[1]),0===s&&(C=!0,e.addActor(E,n[0],n[1])),t.parser||(t.parser=_.ObjectShell.getParser());const a=this._itemFact.getShopItem(l,t);if(a)a.add(new g.Unpaid),e.addItem(a,n[0],n[1]),S.push(n);else{const e="item null. conf: "+JSON.stringify(t);i.default.err("DungeonPopulate","createShop",`${e} shopFunc/type${l} not well defined.`)}}if(!C){const e=JSON.stringify(d);i.default.err("DungeonPopulate","createShops","Could not add keeper to "+e)}if(E.has("Shopkeeper")){const t=E.get("Shopkeeper");t.setCells(S),t.setLevelID(e.getID()),t.setDoorXY(v.getXY());const s=E.getType()+" shopkeeper";E.setName(s),i.default.addCellStyle(i.default.TYPE_ACTOR,s,"cell-actor-shopkeeper");const n=w.arrayGetRand(S);if(E.getBrain().getGoal){const e=new u.Evaluator.Shopkeeper(1.5);e.setArgs({xy:n}),E.getBrain().getGoal().addEvaluator(e)}}this.addShopLoreItem(e,E),c.setShopkeeper(E),c.setLevel(e),c.setCoord(S),s.shops.push(c)}return n}createShopkeeper(e){let t=null;if(e.parser)if(e.actor){if(t=e.parser.createRandomActor({func:e.actor}),!t){let t="conf.actor given but no actor found";"function"==typeof e.actor?t+=" conf.actor |\n"+e.actor.toString()+"|":t+=" conf.actor must be function",i.default.err("Factory","createShopkeeper",t)}const s=t.getType()+" shopkeeper";t.setName(s),i.default.addCellStyle(i.default.TYPE_ACTOR,s,"cell-actor-shopkeeper")}else t=e.parser.createActor("shopkeeper");else t=this._actorFact.createActor("shopkeeper",{brain:"Human"});t.add(new g.Shopkeeper);const s=new m.GoldCoin(i.default.GOLD_COIN_NAME);s.setCount(w.getUniformInt(50,200)),t.getInvEq().addItem(s);t.get("Named").setUniqueName(E.Names.getActorName());let n=10;return e.maxDanger>=6&&(n=2*e.maxDanger),i.default.levelUpActor(t,n),t}addShopLoreItem(e,t){const s=t.get("Named"),n=e.get("Lore"),r=t.get("Shopkeeper"),a={name:s.getFullName(),xy:r.getDoorXY()};n.addTopic("shops",a)}createTrainers(e,t){const s=e.getExtras().houses;if(i.default.isSuccess(i.default.TRAINER_PROB)){let n=null;if(t.parser)n=t.parser.createActor("trainer");else{const e={maxDanger:5,actorFunc:e=>i.default.ALL_RACES.indexOf(e.type)>=0};n=this.createActor(e)}const r=new g.Trainer;n.add(r);const a=e.getFreeRandCell();if(e.addActor(n,a.getX(),a.getY()),s){const e=w.arrayGetRand(s);if(n.getBrain().getGoal){const t=new u.Evaluator.GoHome(1.5),s=e.getCenter();return t.setArgs({xy:s}),n.getBrain().getGoal().addEvaluator(t),[e]}}}return[]}populateHouse(e,t,s){const n=t.numFloor;let r=Math.round(n/9);0===r&&(r=1);for(let n=0;n<r;n++){const n=this.createActor(s),r=n.getBrain();if(r.getGoal){const s=new u.Evaluator.GoHome(1.5),n=t.getFloorCenter();s.setArgs({xy:n}),r.getGoal().addEvaluator(s);const a=new y.ElementMarker("H");a.setTag("home"),e.addElement(a,n[0],n[1])}const a=w.arrayGetRand(t.floor);e.addActor(n,a[0],a[1])}}createActor(e){const t=_.ObjectShell.getParser(),s=e.maxDanger||this.maxDanger;let n=null;if(s>0){let r=e=>e.danger<=s;this.actorFunc?r=e=>this.actorFunc(e)&&e.danger<=s:e.actorFunc&&(r=t=>e.actorFunc(t)&&t.danger<=s),n=t.createRandomActor({func:r})}else i.default.err("DungeonPopulate","createActor","maxDanger must be > 0");return n}addActorsToBbox(e,t,s){const n=s.nActors||4,{maxDanger:r}=s,a=s.actor;let o=s.actors;return o||(o=this._actorFact.generateNActors(n,a,r)),h.Placer.addActorsToBbox(e,t,o)}addItemsToBbox(e,t,s){const n=s.nItems||4,r=Object.assign({itemsPerLevel:n},s),a=this._itemFact.generateItems(r);return h.Placer.addItemsToBbox(e,t,a)}addToughAdventurer(e,t,s){const{maxDanger:n}=s.maxDanger,r=n-1,a=v.ActorGen.genRandShellWith(e=>e.danger<=n+4&&e.danger>=r);if(a){const[s,n]=t,r=_.ObjectShell.getParser().createFromShell(i.default.TYPE_ACTOR,a);if(r&&e.addActor(r,s,n))return!0}return!1}}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.statusToString=t.GoalRest=t.GoalChangeLevel=t.GoalEquip=t.GoalUseSkill=t.GoalCommunicate=t.GoalMonitor=t.GoalGoHome=t.GoalShopkeeper=t.GoalOrders=t.GoalFindMissile=t.GoalFindAmmo=t.GoalFindGold=t.GoalFindFood=t.GoalFindWeapon=t.GoalFindItem=t.GoalGetItem=t.GoalFollow=t.GoalCastSpell=t.GoalFleeFromActor=t.GoalExplore=t.GoalShootActor=t.GoalHitActor=t.GoalAttackActor=t.GoalPatrol=t.GoalGuardArea=t.GoalGuard=t.GoalGotoSeenActor=t.GoalGotoActor=t.GoalMoveUntilEnemy=t.GoalFollowPath=t.GoalBase=t.GoalStatus=t.GoalType=t.Goal=void 0;const i=o(s(5)).default("bitn:Goal"),l=o(s(0)),c=a(s(2)),u=s(15),h=s(10),d=s(1),f=s(38),g=d.Random.getRNG();var p;t.Goal={},t.Goal.ACTOR_FILTER="",t.Goal.StatusStrings={1:"GOAL_ACTIVE",2:"GOAL_COMPLETED",3:"GOAL_INACTIVE",4:"GOAL_FAILED"},function(e){e[e.NORMAL=1]="NORMAL",e[e.MOVE=2]="MOVE",e[e.KILL=3]="KILL",e[e.FIND=4]="FIND",e[e.AGGRESSION=5]="AGGRESSION"}(p=t.GoalType||(t.GoalType={})),t.Goal.Types=p;var m;!function(e){e[e.GOAL_ACTIVE=1]="GOAL_ACTIVE",e[e.GOAL_COMPLETED=2]="GOAL_COMPLETED",e[e.GOAL_INACTIVE=3]="GOAL_INACTIVE",e[e.GOAL_FAILED=4]="GOAL_FAILED"}(m=t.GoalStatus||(t.GoalStatus={}));let y=0;class _{constructor(e){this.subGoals=null,this.actor=e,this.status=m.GOAL_INACTIVE,this.type="",this.category=p.NORMAL,this.planBGoal=null,this._debug=!1}setDebug(e){this._debug=e}dbg(e){if(i.enabled||this._debug){let s=!1;if(t.Goal.ACTOR_FILTER||(s=!0),!s){s=new RegExp(t.Goal.ACTOR_FILTER).test(this.actor.getName())}if(s){const t="  ".repeat(y),s=this.actor.getName(),n=J(this.status),r=`[${this.getType()}] st: ${n}`;console.log(`${t}${r} ${s} ${e}`)}}}setCategory(e){this.category=e}getCategory(){return this.category}setType(e){this.type=e}getType(){return this.type}hasPlanB(){return null!==this.planBGoal}getPlanB(){return this.planBGoal}activate(){throw new Error("Pure virtual method")}activateIfInactive(){this.isInactive()&&(this.dbg("Activating inactive"),this.activate())}reactivateIfFailed(){this.hasFailed()&&(this.dbg("Re-Activating failed"),this.status=m.GOAL_INACTIVE)}process(){if(Array.isArray(this.subGoals)){return this.subGoals[0].process()}return this.status}terminate(){this.dbg("Goal terminated!"),this.status=m.GOAL_COMPLETED}handleMsg(e){Array.isArray(this.subGoals)&&this.subGoals[this.subGoals.length-1].handleMsg(e)}processSubGoals(){++y;let e=m.GOAL_FAILED;if(this.dbg("Start processSubGoals()"),!Array.isArray(this.subGoals)){const e=this.actor.getName(),t=`Type: ${this.type}, actor: ${e}`;throw new Error(t+" No subgoals in non-terminal goal")}if(this.removeFinishedOrFailed(),this.subGoals.length>0){const t=this.subGoals[0];e=t.process(),e===m.GOAL_COMPLETED&&this.subGoals.length>1?e=m.GOAL_ACTIVE:e===m.GOAL_FAILED&&t.hasPlanB()&&(this.subGoals[0]=t.getPlanB(),this.subGoals[0].setType(t.getType()),e=m.GOAL_ACTIVE)}else e=m.GOAL_COMPLETED;return--y,this.dbg("End processSubGoals() with status "+J(e)),i.enabled&&this.dbg("  subGoals left: "+this.subGoals.map(e=>e.getType())),e}removeFinishedOrFailed(){this.subGoals=this.subGoals.filter(e=>!e.isCompleted()&&!e.hasFailed())}removeAllSubGoals(){Array.isArray(this.subGoals)&&(this.subGoals.forEach(e=>{e.terminate()}),this.subGoals=[]),this.dbg("Removed all subGoals")}removeSubGoalsOfType(e){let t=0;if(Array.isArray(this.subGoals)){let s=this.subGoals.findIndex(t=>t.type===e);for(;s>=0;)this.subGoals[s].terminate(),this.subGoals.splice(s,1),++t,s=this.subGoals.findIndex(t=>t.type===e)}return t}getSubGoals(){return this.subGoals}hasSubGoals(e){if(Array.isArray(this.subGoals)){if(e){return this.subGoals.findIndex(t=>t.type===e)>=0}return this.subGoals.length>0}return!1}addSubGoal(e){if(Array.isArray(this.subGoals)||(this.subGoals=[]),this.subGoals.unshift(e),i.enabled){this.dbg("Added subGoal "+e.getType());const t=this.subGoals.map(e=>e.getType());this.dbg("   Subgoals are now: "+t)}this._debug&&(e._debug=!0)}isInactive(){return this.status===m.GOAL_INACTIVE}isActive(){return this.status===m.GOAL_ACTIVE}hasFailed(){return this.status===m.GOAL_FAILED}isCompleted(){return this.status===m.GOAL_COMPLETED}isGoalPresent(e){if(Array.isArray(this.subGoals)){const t=this.subGoals.find(t=>t.getType()===e);if(t&&!t.hasFailed()&&!t.isCompleted())return i.enabled&&(this.dbg(`subGoal ${e} already present.`),this.dbg("  SubGoal status: "+t.status)),!0}return!1}}t.GoalBase=_,t.Goal.Base=_;class b extends _{constructor(e,t){super(e),this.setType("GoalFollowPath"),this.path=[],this.xy=t}activate(){const[e,t]=this.xy,[s,n]=[this.actor.getX(),this.actor.getY()];this.dbg(`Calc path ${s},${n} -> ${e},${t}`);const r=this.actor.getLevel().getMap(),a=h.Path.getShortestActorPath(r,s,n,e,t);this.path=a,this.status=m.GOAL_ACTIVE,this.dbg("activate() path length: "+this.path.length)}process(){return this.activateIfInactive(),this.path.length>0?(this.status=this.followPath(),this.status):(this.dbg("process() ret GoalStatus.GOAL_COMPLETED"),this.status=m.GOAL_COMPLETED,this.status)}followPath(){const e=this.actor.getLevel(),[t,s]=this.actor.getXY(),{x:n,y:r}=this.path[0],[a,o]=[n,r],i=this.path.length;if(this.dbg(`followPath() test move ${t},${s} -> ${n},${r}, path ${i} `),e.getMap().isPassable(a,o,t,s)){const l=Math.abs(t-n),u=Math.abs(s-r);if(l<=1&&u<=1){const t=new c.Movement(a,o,e);return this.actor.add(t),this.path.shift(),0===this.path.length?(this.dbg("followPath() ret GOAL_COMPL, path "+i),this.status=m.GOAL_COMPLETED,m.GOAL_COMPLETED):(this.dbg("followPath() ret GoalStatus.GOAL_ACTIVE, path "+i),this.status=m.GOAL_ACTIVE,m.GOAL_ACTIVE)}return this.dbg("followPath() strayed, ret GoalStatus.GOAL_FAILED, path "+i),this.status=m.GOAL_FAILED,m.GOAL_FAILED}return this.dbg("followPathl() next NOT passable ret GoalStatus.GOAL_FAILED"),this.status=m.GOAL_FAILED,m.GOAL_FAILED}}t.GoalFollowPath=b,t.Goal.FollowPath=b;class v extends _{constructor(e,t){super(e),this.setType("GoalMoveUntilEnemy"),this.dir=t}activate(){this.timeout=100,this.status=m.GOAL_ACTIVE}process(){this.activateIfInactive();const e=this.actor.getBrain(),t=e.getSeenCells(),s=e.findEnemyCell(t),[n,r]=this.actor.getXY(),[a,o]=function(e,t){const[s,n]=e.getXY();return[s+t[0],n+t[1]]}(this.actor,this.dir),l=this.actor.getLevel().getMap();if(s){const[e,t]=[s.getX(),s.getY()];i.enabled&&this.dbg(`Has moved enough. Enemy found @${e},${t}`),this.status=m.GOAL_COMPLETED}else if(l.hasObstacle(a,o))this.status=m.GOAL_FAILED,i.enabled&&this.dbg("OBSTACLE ENCOUNTERED");else if(0===this.timeout)this.status=m.GOAL_FAILED,i.enabled&&this.dbg("TIMEOUT REACHED");else if(l.isPassable(a,o,n,r)){const e=this.actor.getLevel(),t=new c.Movement(a,o,e);this.actor.add(t);const s=this.actor.getName();i.enabled&&this.dbg(`Moving ${s} to ${a},${o}`)}return--this.timeout,this.status}}t.GoalMoveUntilEnemy=v,t.Goal.MoveUntilEnemy=v;class E extends b{constructor(e,t){super(e,[0,0]),this.setType("GoalGotoActor"),this.xy=t.getXY(),this.targetActor=t,this.pathFunc=h.Path.getActorToActorPath}activate(){const e=this.getPath();this.dbg("activate() path length: "+e.length),this.path=e,this.status=m.GOAL_ACTIVE,this.dbg("activate() path length: "+this.path.length)}getPath(){const e=this.actor.getLevel().getMap(),[t,s]=this.xy,[n,r]=[this.actor.getX(),this.actor.getY()];return this.dbg(`${this.getType()} ${n},${r} -> ${t},${s}`),h.Path.getActorToActorPath(e,n,r,t,s)}process(){this.activateIfInactive();const[e,t]=[this.targetActor.getX(),this.targetActor.getY()],[s,n]=this.xy,r=Math.abs(e-s),a=Math.abs(t-n);return r>2||a>2?(this.followPath(),this.status=m.GOAL_FAILED,m.GOAL_FAILED):this.path.length>0?this.followPath():(this.dbg("process() ret GoalStatus.GOAL_COMPLETED"),this.status=m.GOAL_COMPLETED,m.GOAL_COMPLETED)}}t.GoalGotoActor=E,t.Goal.GotoActor=E;class S extends E{constructor(e,t){super(e,t),this.setType("GoalGotoSeenActor")}getPath(){const e=this.actor.getLevel().getMap(),[t,s]=this.xy;return h.Path.getShortestSeenPath(this.actor,e,t,s)}}t.GoalGotoSeenActor=S,t.Goal.GotoSeenActor=S;class w extends _{constructor(e,t,s=1){super(e),this.setType("GoalGuard"),this.dist=s,this.x=t[0],this.y=t[1],this.subGoals=[]}activate(){this.checkDistToGuardPoint()}process(){if(this.activateIfInactive(),this.status=this.processSubGoals(),this.subGoals.length>0){this.subGoals[0].hasFailed()&&this.checkDistToGuardPoint()}else this.checkDistToGuardPoint();return this.status}checkDistToGuardPoint(){const[e,t]=l.default.dXdYAbs([this.x,this.y],this.actor.getXY());(e>this.dist||t>this.dist)&&this.addSubGoal(new b(this.actor,[this.x,this.y]))}}t.GoalGuard=w,t.Goal.Guard=w;class C extends _{constructor(e,t,s=1){super(e),this.setType("GoalGuardArea"),this.dist=s,this.bbox=t,this.subGoals=[]}activate(){this.checkDistToGuardArea()}process(){if(this.activateIfInactive(),this.status=this.processSubGoals(),this.subGoals.length>0){this.subGoals[0].hasFailed()&&this.checkDistToGuardArea()}else this.checkDistToGuardArea();return this.status}checkDistToGuardArea(){const[e,t]=this.actor.getXY();if(!this.bbox.hasXY(e,t)){const[e,t]=this.bbox.getDist(this.actor.getXY());if(e>this.dist||t>this.dist){const[e,t]=this.bbox.getRandXY();this.addSubGoal(new b(this.actor,[e,t]))}}}}t.GoalGuardArea=C,t.Goal.GuardArea=C;class T extends _{constructor(e,t){super(e),this.setType("GoalPatrol"),this.coords=t,this.coords.length<2&&l.default.err("GoalPatrol","constructor","Provide >= 2 coords for patrolling. Got "+t),this.currIndex=0,this.currTarget=t[this.currIndex],this.patrolDist=3}activate(){this.dbg(this.getType()+" activate()"),this.recomputePatrolPath()}process(){this.activateIfInactive(),this.status=this.processSubGoals(),this.dbg("GoalPatrol process(), got subStatus: "+J(this.status));const e=this.subGoals[0];if(e.isCompleted())this.nextPatrolPoint();else if(e.hasFailed()){this.dbg(this.getType()+" process() path failed");const[e,t]=this.actor.getXY(),[s,n]=this.currTarget;h.Path.shortestDist(e,t,s,n)<=this.patrolDist?this.nextPatrolPoint():this.recomputePatrolPath()}else this.dbg(this.getType()+" XXX NOT HERE!");return this.status}nextPatrolPoint(){++this.currIndex,this.currIndex>=this.coords.length&&(this.currIndex=0),this.currTarget=this.coords[this.currIndex],this.addSubGoal(new b(this.actor,this.currTarget)),this.dbg(`${this.getType()} next patrol point ${this.currTarget}`),this.status=m.GOAL_ACTIVE}recomputePatrolPath(){this.addSubGoal(new b(this.actor,this.currTarget)),this.dbg(`${this.getType()} recompute to point ${this.currTarget}`),this.status=m.GOAL_ACTIVE}}t.GoalPatrol=T,t.Goal.Patrol=T;class O extends _{constructor(e,t){super(e),this.setType("GoalAttackActor"),this.targetActor=t}activate(){this.dbg("activate() called"),this.selectSubGoal(),this.isCompleted()||(this.status=m.GOAL_ACTIVE)}process(){this.activateIfInactive();const e=this.actor.getBrain(),t=e.getSeenCells(),s=e.findEnemyCell(t);if(s){const t=s.getActors()[0];if(this.targetActor.getID()!==t.getID()){if(this.print){const e=this.actor.getName(),s=this.targetActor.getName(),n=t.getName();l.default.log(`${e}:: Recomp target ${s} -> ${n}`)}this.targetActor=t,e.getMemory().setLastAttacked(t),this.selectSubGoal()}}else this.checkTargetStatus();return this.isCompleted()||this.hasFailed()||(this.status=this.processSubGoals()),this.status}terminate(){this.dbg("Terminating completed attack actor task"),this.status=m.GOAL_COMPLETED}canMissileAttack(){const[e,t]=this.targetActor.getXY(),[s,n]=this.actor.getXY(),r=this.actor.getInvEq().getMissile();if(r){const a=l.default.getMissileRange(this.actor,r);if(h.Path.shortestDist(e,t,s,n)<=a)return!0}return!1}selectSubGoal(){const e=this.actor.getBrain();if(this.checkTargetStatus(),!this.isCompleted()){const[t,s]=this.targetActor.getXY();if(e.canMeleeAttack(t,s)){this.removeAllSubGoals(),this.dbg("canMeleeAttack() OK");const e=new A(this.actor,this.targetActor);this.addSubGoal(e)}else if(this.canMissileAttack()){this.removeAllSubGoals(),this.dbg("canMissileAttack() OK");const e=new M(this.actor,this.targetActor);this.addSubGoal(e)}else if(e.canSeeActor(this.targetActor)){this.removeAllSubGoals(),this.dbg("canSeeActor subGoal GoalGotoActor");const e=new S(this.actor,this.targetActor);this.addSubGoal(e)}else{this.removeAllSubGoals(),this.dbg("Moving blind subGoal GoalGotoActor");const e=new E(this.actor,this.targetActor);this.addSubGoal(e)}}}checkTargetStatus(){const e=this.targetActor.get("Health");if(!e){const e=JSON.stringify(this.targetActor),t=JSON.stringify(this.actor);l.default.log("Attacker: "+t),l.default.err("GoalAttackActor","checkTargetStatus","target has no health: "+e)}e.isDead()?(this.removeAllSubGoals(),this.status=m.GOAL_COMPLETED,this.dbg("Enemy is dead. Goal completed")):l.default.inSameLevel(this.actor,this.targetActor)||(this.removeAllSubGoals(),this.status=m.GOAL_COMPLETED,this.dbg("Enemy not in this level. Goal completed"))}}t.GoalAttackActor=O,t.Goal.AttackActor=O;class A extends _{constructor(e,t){super(e),this.setType("GoalHitActor"),this.targetActor=t}activate(){const e=this.actor.getLevel(),[t,s]=this.targetActor.getXY(),n=e.getMap().getCell(t,s).getProp("actors")[0],r=new c.Attack({target:n});this.actor.add(r),this.dbg(this.getType()+" added Attack comp"),this.status=m.GOAL_ACTIVE}process(){return this.activateIfInactive(),this.status=m.GOAL_COMPLETED,this.status}}t.GoalHitActor=A;class M extends _{constructor(e,t){super(e),this.setType("GoalShootActor"),this.targetActor=t}activate(){const e=new c.AttackRanged;e.setAttacker(this.actor),e.setTarget(this.targetActor),this.actor.add(e),this.dbg(this.getType()+" added Missile comp"),this.status=m.GOAL_ACTIVE}process(){return this.activateIfInactive(),this.status=m.GOAL_COMPLETED,this.status}}t.GoalShootActor=M;class N extends _{constructor(e,t=-1){super(e),this.setType("GoalExplore"),this.dur=t}activate(){this.setNewPassableDir(),this.dbg(`activate Explore dX,dY: ${this.dX},${this.dY}`),this.status=m.GOAL_ACTIVE}setCallback(e){this.exploreCb=e}setNewPassableDir(){let e=5,[t,s]=g.getRandDir();for(;e>0&&!this.isDirPassable(t,s);)[t,s]=g.getRandDir(),--e;this.dX=t,this.dY=s}isDirPassable(e,t){const[s,n]=this.actor.getXY(),r=s+e,a=n+t;return this.actor.getLevel().getMap().isPassable(r,a,s,n)}shouldMoveTo(e,t,s){const[n,r]=this.actor.getXY();let a=e.isPassable(t,s,n,r);if(this.actor.has("Flying")&&(a=e.isPassableByAir(t,s)),a){return!e.getCell(t,s).isDangerous()}return!1}process(){this.activateIfInactive(),this.checkChangeDir(),--this.dur;const[e,t]=this.actor.getXY(),s=e+this.dX,n=t+this.dY,r=this.actor.getLevel(),a=r.getMap();if(a.hasXY(s,n))if(this.shouldMoveTo(a,s,n)){const e=new c.Movement(s,n,r);this.actor.add(e)}else this.canOpenDoorAt(a,s,n)||this.setNewPassableDir();else this.setNewPassableDir();return 0===this.dur&&(this.status=m.GOAL_COMPLETED),this.exploreCb&&this.exploreCb(s,n),this.status}canOpenDoorAt(e,t,s){const n=e.getCell(t,s);if(n.hasDoor()){const e=n.getPropType("door")[0];if(e.canToggle()){const t=new c.OpenDoor;return t.setDoor(e),this.actor.add(t),!0}}return!1}checkChangeDir(){const e=g.getUniform();if(e<=.07){const e=this.changeDir(this.dX);this.isDirPassable(e,this.dY)&&(0===e&&0===this.dY||(this.dX=e))}else if(e<=.14){const e=this.changeDir(this.dY);this.isDirPassable(this.dX,e)&&(0===e&&0===this.dX||(this.dY=e))}}changeDir(e){switch(e){case 0:return g.arrayGetRand([-1,1]);case 1:case-1:return 0;default:return e}}terminate(){this.status=m.GOAL_COMPLETED}}t.GoalExplore=N,t.Goal.Explore=N;class P extends _{constructor(e,t){super(e),this.setType("GoalFleeFromActor"),this.targetActor=t}activate(){const e=this.actor.getBrain().getSeenCells(),s=u.Brain.findCellsWithActors(this.actor,e);let n=null;if(s.forEach(e=>{const t=e.getActors();t&&t.forEach(t=>{t.getID()===this.targetActor.getID()&&(n=e)})}),n){const e=this.actor.getX(),s=this.actor.getY(),n=l.default.dXdYUnit(this.actor,this.targetActor);this.dbg("Got dXdY "+n);const r=e+n[0],a=s+n[1],o=[[r,a],[e,a],[r,s]];if(this.tryFleeOptions(o),this.status!==m.GOAL_COMPLETED){const e=u.Brain.getBoxOfFreeCellsAround(this.actor,1).map(e=>e.getXY());this.tryFleeOptions(e)}this.status!==m.GOAL_COMPLETED&&(this.status=m.GOAL_FAILED,this.planBGoal=new t.Goal.AttackActor(this.actor,this.targetActor))}else this.status=m.GOAL_FAILED;this.status===m.GOAL_FAILED&&this.dbg(`Goal failed. foundCell |${n}|`)}process(){return this.activateIfInactive(),this.status}tryFleeOptions(e){const t=this.actor.getLevel(),[s,n]=this.actor.getXY();g.shuffle(e);for(let r=0;r<e.length;r++){const[a,o]=e[r];if(t.getMap().isPassable(a,o,s,n)){const e=new c.Movement(a,o,t);this.dbg(`${this.getType()} movComp to ${a},${o}`),this.actor.add(e),this.status=m.GOAL_COMPLETED;break}this.dbg(`Cell ${a},${o} not passable`)}}}t.GoalFleeFromActor=P,t.Goal.FleeFromActor=P;class D extends _{constructor(e,t,s){super(e),this.setType("GoalCastSpell"),this.spell=t,this.spellArgs=s}activate(){this.spell.getCastFunc(this.actor,this.spellArgs)(),this.status=m.GOAL_COMPLETED}process(){return this.activateIfInactive(),this.status}}t.GoalCastSpell=D,t.Goal.CastSpell=D;class I extends _{constructor(e,t){super(e),this.setType("GoalFollow"),this.targetActor=t}activate(){this.actor.getBrain().canSeeActor(this.targetActor)&&(this.status=m.GOAL_ACTIVE)}process(){this.activateIfInactive();const e=this.actor.getBrain(),[t,s]=this.actor.getXY();if(e.canSeeActor(this.targetActor)){const[e,n]=l.default.dXdYUnit(this.targetActor,this.actor),[r,a]=l.default.dXdY(this.targetActor,this.actor);let o=t+e,i=s+n;const u=this.targetActor.getLevel(),d=u.getMap();if(Math.abs(r)<=1&&Math.abs(a)<=1)this.status=m.GOAL_ACTIVE;else if(d.isPassable(o,i,t,s)){const e=new c.Movement(o,i,u);this.actor.add(e)}else{const[e,n]=this.targetActor.getXY(),r=h.Path.getActorToActorPath(d,t,s,e,n);if(r.length>0)if([o,i]=[r[0].x,r[0].y],d.isPassable(o,i,t,s)){const e=new c.Movement(o,i,u);this.actor.add(e)}else this.status=m.GOAL_FAILED;else this.status=m.GOAL_FAILED}}else this.status=m.GOAL_FAILED;return this.status}}t.GoalFollow=I,t.Goal.Follow=I;class L extends _{constructor(e,t){super(e),this.setType("GoalGetItem"),this.targetItem=t}activate(){this.status=m.GOAL_ACTIVE;const e=this.targetItem.getID(),t=this.actor.getBrain().getSeenCells();let s=null;if(t.forEach(t=>{if(t.hasItems()){t.getItems().find(t=>t.getID()===e)&&(s=t)}}),s){const[e,t]=this.actor.getXY(),[n,r]=s.getXY();if(e===n&&t===r)this.pickupItem();else{const e=new b(this.actor,[n,r]);this.removeAllSubGoals(),this.addSubGoal(e)}}else this.status=m.GOAL_FAILED}process(){return this.activateIfInactive(),this.hasSubGoals()?(this.status=this.processSubGoals(),this.status===m.GOAL_COMPLETED&&(this.status=m.GOAL_ACTIVE)):this.isActive()&&this.pickupItem(),this.status}pickupItem(){const e=new c.Pickup;this.actor.add(e),this.status=m.GOAL_COMPLETED}}t.GoalGetItem=L,t.Goal.GetItem=L;class x extends _{constructor(e,t,s){super(e),this.setType("GoalFindItem"),this.constraint=t,this._foundItem=null,this._cbFound=s}activate(){this.status=m.GOAL_ACTIVE}process(){return this.activateIfInactive(),this.checkForItems(),this.hasSubGoals()&&(this.status=this.processSubGoals()),this.status}checkForItems(){if(this._foundItem)return;let e;this.actor.getBrain().getSeenCells().forEach(t=>{!e&&t.hasItems()&&(e=t)});let t=null;if(e){const s=new f.Constraints,n=e.getItems(),r=s.getConstraints(this.constraint);let a=!1;n.forEach(e=>{!a&&r(e)&&(a=!0,this._foundItem=e,t=new L(this.actor,e),this.removeAllSubGoals(),this.addSubGoal(t))})}if(!this.hasSubGoals()){const e=100;t=new N(this.actor,e),this.removeAllSubGoals(),this.addSubGoal(t)}}}t.GoalFindItem=x,t.Goal.FindItem=x;const k=()=>!0;class R extends x{constructor(e){super(e,{op:"eq",func:"getType",value:"weapon"},k)}}t.GoalFindWeapon=R,t.Goal.FindWeapon=R;class B extends x{constructor(e){super(e,{op:"eq",func:"getType",value:"food"},k)}}t.GoalFindFood=B,t.Goal.FindFood=B;class F extends x{constructor(e){super(e,{op:"eq",func:"getType",value:"gold"},k)}}t.GoalFindGold=F,t.Goal.FindGold=F;class G extends x{constructor(e,t){super(e,{op:"eq",func:"getAmmoType",value:t},k)}}t.GoalFindAmmo=G,t.Goal.FindAmmo=G;class W extends x{constructor(e){super(e,{op:"eq",func:"getType",value:"missile"},k)}}t.GoalFindMissile=W,t.Goal.FindMissile=W;class Y extends _{constructor(e){super(e),this.setType("GoalOrders")}activate(){this.status=m.GOAL_ACTIVE}process(){return this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}t.GoalOrders=Y,t.Goal.Orders=Y;class j extends _{constructor(e,t,s){super(e),this.setType("GoalShopkeeper"),this.x=t,this.y=s,this.hasShouted=!1,this.subGoals=[]}activate(){this.status=m.GOAL_ACTIVE;const e=this.actor.getCell();if(e.hasShop())if(l.default.isSuccess(.6))U(this.actor);else if(this.hasShouted)e.hasItems();else{const e=new c.Communication;e.addMsg({src:this.actor,type:"Shout",shout:"Hello traveller!"}),this.actor.add(e)}else{this.dbg(`${this.x},${this.y} has shop`);const e=new b(this.actor,[this.x,this.y]);this.addSubGoal(e),this.status=this.processSubGoals()}}process(){return this.dbg(`process(), x,y is ${this.x},${this.y}`),this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}t.GoalShopkeeper=j,t.Goal.Shopkeeper=j;class X extends _{constructor(e,t,s,n){super(e),this.setType("GoalGoHome"),this.x=t,this.y=s,this.maxDist=n,this.subGoals=[],this.timeToFindPath=g.getUniformInt(100,200)}activate(){this.status=m.GOAL_ACTIVE;const e=this.actor.getCell();if(this.timeToFindPath--,"floorhouse"===e.getBaseElem().getType())if(l.default.isSuccess(.03)){const e=new c.Communication;e.addMsg({src:this.actor,type:"Shout",shout:"Home sweet home!"}),this.actor.add(e)}else U(this.actor);else if(l.default.withinRange(this.maxDist,[this.x,this.y],this.actor))U(this.actor);else if(this.timeToFindPath<=0){const e=new b(this.actor,[this.x,this.y]);this.addSubGoal(e),this.status=this.processSubGoals(),this.timeToFindPath=g.getUniformInt(100,200)}else U(this.actor)}process(){return this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}function U(e){const t=e.getLevel(),s=t.getMap();let n=g.getRandDir(),r=l.default.newXYFromDir(n,e),a=10;for(;!s.hasXY(r[0],r[1])&&(n=g.getRandDir(),r=l.default.newXYFromDir(n,e),0!=--a););if(a>0){const s=new c.Movement(r[0],r[1],t);e.add(s)}}t.GoalGoHome=X,t.Goal.GoHome=X,t.Goal.moveToRandomDir=U,t.Goal.moveActorTo=function(e,t){const[s,n]=e.getXY(),r=t.getXY(),a=e.getLevel();if(a.getMap().isPassable(r[0],r[1],s,n)){const t=new c.Movement(r[0],r[1],a);e.add(t)}};class ${constructor(e){this.goal=e}}t.GoalMonitor=$,t.Goal.Monitor=$;class V extends _{constructor(e){super(e),this.setType("GoalCommunicate")}activate(){this.communicateEnemies()}process(){return this.activateIfInactive(),this.status=m.GOAL_COMPLETED,this.status}communicateEnemies(){const e=this.actor.getBrain(),t=e.getMemory(),s=t.getEnemyActors(),n=e.getSeenCells(),r=e.findFriendCell(n);if(!r)return;const a=r.getActors()[0],o=new c.Communication,i={type:"Enemies",enemies:s,src:this.actor};o.addMsg(i),a.add(o),t.addCommunicationWith(a)}}t.GoalCommunicate=V,t.Goal.Communicate=V;class H extends _{constructor(e){super(e),this.setType("GoalUseSkill")}activate(){this.useActorSkill()}process(){return this.activateIfInactive(),this.status=m.GOAL_COMPLETED,this.status}useActorSkill(){const e=u.Brain.getCellsAroundActor(this.actor),t={target:g.arrayGetRand(e)};this.actor.useSkill?this.actor.useSkill(t,0):l.default.err("GoalUseSkill","useActorSkill","Tried to use a skill but no actor.useSkill() found")}}t.GoalUseSkill=H,t.Goal.UseSkill=H;class q extends _{constructor(e){super(e),this.setType("GoalEquip")}activate(){this.equipSomething()}process(){return this.activateIfInactive(),this.status=m.GOAL_COMPLETED,this.status}equipSomething(){const e=this.actor.getInvEq().getInventory().getItems(),t=g.arrayGetRand(e);if(t){const e=new c.Equip;e.setIsRemove(!1),e.setArgs({item:t}),this.actor.add(e)}else{const e=JSON.stringify(this.actor);l.default.err("GoalEquip","equipSomething","GoalEquip issued although no items to equip "+e)}}}t.GoalEquip=q,t.Goal.Equip=q;class K extends _{constructor(e,t){super(e),this.setType("GoalChangeLevel"),this.coord=t}activate(){this.status=m.GOAL_ACTIVE,this.tryToFindStairs()}process(){return this.status=m.GOAL_ACTIVE,this.tryToFindStairs(),this.hasSubGoals()?(this.status=this.processSubGoals(),this.status===m.GOAL_COMPLETED&&(this.status=m.GOAL_ACTIVE)):this.isActive()&&this.useStairs(),this.status}tryToFindStairs(){if(this.coord){const[e,s]=this.actor.getXY(),[n,r]=this.coord;if(e===n&&s===r)console.log("Found stairs @",n,r),this.useStairs();else if(!this.hasSubGoals()){const e=new t.Goal.FollowPath(this.actor,this.coord);this.removeAllSubGoals(),this.addSubGoal(e)}}else if(!this.hasSubGoals()){const e=new t.Goal.Explore(this.actor,100);e.setCallback(this.exploreCallback.bind(this)),this.removeAllSubGoals(),this.addSubGoal(e)}}useStairs(){const e=new c.UseStairs;this.actor.add(e),this.removeAllSubGoals(),this.status=m.GOAL_COMPLETED}exploreCallback(e,t){const s=this.actor.getLevel().getMap();if(s.hasXY(e,t)){s.getCell(e,t).hasConnection()&&(this.coord=[e,t])}}}t.GoalChangeLevel=K,t.Goal.ChangeLevel=K;class z extends _{constructor(e){super(e),this.setType("GoalRest")}activate(){this.rest()}process(){return this.activateIfInactive(),this.status=m.GOAL_COMPLETED,this.status}rest(){this.actor.add(new c.Rest)}}function J(e){return t.Goal.StatusStrings[e]}t.GoalRest=z,t.Goal.Rest=z,t.statusToString=J},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BrainSpawner=t.BrainVirtual=void 0;const r=n(s(0)),a=s(38),o=s(68),i=s(6),l=s(1),c=l.Random.getRNG(),u=()=>{};class h extends o.BrainBase{constructor(e){super(e),this.setType("Virtual")}}t.BrainVirtual=h;t.BrainSpawner=class extends h{constructor(e){super(e),this.setType("Spawner"),this.constraint=null,this._constraintFunc=null,this.placeConstraint=null,this._placeConstraintFunc=null,this.spawnProb=.05,this.spawnLeft=100}setConstraint(e){Array.isArray(e)?this.constraint=e:this.constraint=[e],this._constraintFunc=(new a.Constraints).getConstraints(e)}setPlaceConstraint(e){Array.isArray(e)?this.placeConstraint=e:this.placeConstraint=[e],this._placeConstraintFunc=(new a.Constraints).getConstraints(e)}decideNextAction(){return 0!==this.spawnLeft&&r.default.isSuccess(this.spawnProb)?()=>{const e=this.getActor().getLevel();let t=null;if(this.placeConstraint){let s=100;const n=e.getMap().getFree();for(t=c.arrayGetRand(n);!this._placeConstraintFunc(t)&&(t=c.arrayGetRand(n),0!=--s););}else t=e.getFreeRandCell();if(t){const[s,n]=t.getXY(),r=i.ObjectShell.getParser().createRandomActor({func:this._constraintFunc});r&&e.addActor(r,s,n)&&(--this.spawnLeft,this.emitSpawnMsg(r))}}:u}emitSpawnMsg(e){const t=e.getLevel(),s=e.getCell(),n=r.default.getCardinalDirection(t,s),a=`${e.getName()} appears from path coming from ${n}`;r.default.gameMsg({cell:s,msg:a})}toJSON(){const e={type:this.getType(),constraint:this.constraint,spawnProb:this.spawnProb,spawnLeft:this.spawnLeft};return this.placeConstraint&&(e.placeConstraint=this.placeConstraint),e}}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SentientActor=t.BaseActor=t.ACTOR_NO_ACTION=t.Actor=void 0;const i=o(s(0)),l=s(25),c=a(s(13)),u=s(16),h=s(15),d=s(99),f=s(146),g=a(s(57));t.Actor={},t.ACTOR_NO_ACTION=Object.freeze(()=>{});Object.freeze({});const p=i.default.BASE_SPEED*i.default.ACTION_DUR;class m extends l.Entity{constructor(e,t=!0){super(),this.add(new c.Action);const s=new c.Named;s.setName(e),this.add(s),t&&this.build()}build(){this.add(new c.Location),this.add(new c.Typed("BaseActor",i.default.TYPE_ACTOR))}getType(){return this.get("Typed").getObjType()}setType(e){return this.get("Typed").setObjType(e)}getPropType(){return this.get("Typed").getPropType()}setPropType(e){return this.get("Typed").setPropType(e)}getCell(){return this.get("Location").getCell()}isLocated(){return this.get("Location").isLocated()}unsetLevel(){this.get("Location").unsetLevel()}setLevel(e){return this.get("Location").setLevel(e)}getLevel(){return this.get("Location").getLevel()}getX(){return this.get("Location").getX()}getY(){return this.get("Location").getY()}getXY(){return this.get("Location").getXY()}setXY(e,t){this.get("Location").setXY(e,t)}getZ(){return this.getCell().getZ()}getXYZ(){const[e,t]=this.getXY();return[e,t,this.getCell().getBaseElem().getZ()]}isPlayer(){return this.has("Player")||this.has("PlayerControlled")}isEnemy(e){return!1}addEnemy(e){}addEnemyType(e){}setName(e){this.get("Named").setName(e)}getName(){return this.get("Named").getFullName()}getBrain(){return this._brain}setBrain(e){this._brain=e,this._brain.setActor(this)}getSpeed(){return i.default.BASE_SPEED}getEquipProtection(){return 0}nextAction(e){const s=this._brain.decideNextAction(e);let n=null;if(null!==s){const e=Math.round(p/this.getSpeed());if(n=new g.Action(e,s),this._brain.hasOwnProperty("energy")){const e=this._brain;n.energy=e.energy}}else n=new g.Action(0,t.ACTOR_NO_ACTION);return n.actor=this,n}toJSON(){let e=null;this.getLevel()&&(e=this.getLevel().getID());const t={id:this.getID(),type:this.getType(),levelID:e,brain:this._brain.toJSON(),new:"Base"};return t.components=u.compsToJSON(this),null===t.type&&i.default.err("Actor.Virtual","toJSON","Type null for "+JSON.stringify(t)),t}}t.BaseActor=m,t.Actor.Base=m;class y extends m{constructor(e,t=!0){super(e,t)}build(){super.build(),this._brain=new h.BrainGoalOriented(this),this._invEq=new f.Inventory(this),this._maxWeight=17,this.add(new c.Experience),this.add(new c.Combat),this.add(new c.Stats),this.add(new c.Health(50)),this.add(new c.Corporeal);const e=new c.Perception;e.setFOVRange(i.default.NPC_FOV_RANGE),this.add(e)}getFOVRange(){let e=this.get("Perception").getFOVRange();return this.has("EagleEye")&&(e+=2),e}setFOVRange(e){this.get("Perception").setFOVRange(e)}addEnemyType(e){this._brain.getMemory().addEnemyType(e)}addEnemy(e){this._brain.addEnemy(e)}addFriend(e){this._brain.addFriend(e)}isEnemy(e){return this._brain.getMemory().isEnemy(e)}isFriend(e){return this._brain.getMemory().isFriend(e)}getInvEq(){return this._invEq}getWeapon(){return this._invEq.getWeapon()}getMissileWeapon(){return this._invEq.getMissileWeapon()}getMissile(){return this._invEq.getEquipment().getItem("missile")}getEquipAttack(){let e=this._invEq.getEquipment().getAttack();return this.has("Skills")&&(e+=this.get("Skills").getLevel("Melee")),e}getEquipDefense(){let e=this._invEq.getEquipment().getDefense();return this.has("Skills")&&(e+=this.get("Skills").getLevel("Shields")),e}getEquipProtection(){return this._invEq.getEquipment().getProtection()}getShieldDefense(){const e=this._invEq.getEquipment().getEquipped("shield");let t=0;if(e){t=e.getDefense(),this.has("Skills")&&(t+=this.get("Skills").getLevel("Shields"))}return t}setActorClass(e){this._actorClass=e}getActorClass(){return this._actorClass}setBook(e){this._spellbook=e}getBook(){return this._spellbook}getMaxWeight(){return 2*this.get("Stats").getStrength()+2*this._invEq.getEquipment().getStrength()+this._maxWeight}setIsPlayer(e){e?(this._brain=new d.BrainPlayer(this),b(this),this.add(new c.Player),this.has("SpellPower")||this.add(new c.SpellPower)):i.default.err("Actor.Sentient","setIsPlayer","Actor cannot be changed from player to mob.")}setPlayerCtrl(e){var t;e?(this.add(new c.PlayerControlled),this._actualBrain=this._brain,this._brain=new d.BrainPlayer(this),b(this),this.add(new c.Possessed)):(this.remove("PlayerControlled"),this.remove("Possessed"),t=this,_.forEach(e=>{let s=-1;t.has(e)&&t.getList(e).forEach(e=>{"brain-player"===e.getTag()&&(s=e.getID())}),-1!==s&&t.remove(s)}),this._brain=this._actualBrain,delete this._actualBrain)}getCell(){const e=this.getX(),t=this.getY(),s=this.getLevel();return s?s.getMap().getCell(e,t):null}isInLevel(e){return!!this.getLevel()&&this.getLevel().getID()===e.getID()}toJSON(){let e=null;this.getLevel()&&(e=this.getLevel().getID());const t={id:this.getID(),name:this.getName(),type:this.getType(),brain:this._brain.toJSON(),new:"Sentient",components:u.compsToJSON(this)},s=this.getInvEq().getInventory().toJSON();s.length>0&&(t.inventory=s);const n=this.getInvEq().getEquipment().toJSON();return n.length>0&&(t.equipment=n),null===t.type&&i.default.err("Actor.Sentient","toJSON","Type null for "+JSON.stringify(t)),this._spellbook&&(t.spellbook=this._spellbook.toJSON()),this.has("Player")&&(t.isPlayer=!0,t.x=this.getX(),t.y=this.getY(),t.levelID=e),this._actualBrain&&(t.brain=this._actualBrain.toJSON()),t}getAttack(){let e=this.get("Combat").getAttack();return e+=this.getEquipAttack(),e+=this._addFromCompList("CombatMods","getAttack"),e+=i.default.accuracyToAttack(this.getStatVal("Accuracy")),e}getDefense(){let e=this.get("Combat").getDefense();return e+=this.getEquipDefense(),e+=this._addFromCompList("CombatMods","getDefense"),e+=i.default.agilityToDefense(this.getStatVal("Agility")),e}getProtection(){let e=this.get("Combat").getProtection();return e+=this.getEquipProtection(),e+=this._addFromCompList("CombatMods","getProtection"),e}getDamage(){let e=this.get("Combat").rollDamage();const t=this.getWeapon();if(t){const s=i.default.getItemDamage(t);s>e&&(e=s)}const s=this.getStatVal("Strength");return e+=i.default.strengthToDamage(s),e+=this._addFromCompList("CombatMods","getDamage"),e}getCombatBonus(e){return this._addFromCompList("CombatMods",e)}_addFromCompList(e,t){const s=this.getList(e);return s.length>0?s.reduce((e,s)=>e+s[t](),0):0}getSpeed(){return this.getStatVal("Speed")}getStatVal(e){const t=i.default.formatGetterName(e);let s=this.get("Stats")[t]();return s+=this.getInvEq().getEquipment()[t](),s+=this._addFromCompList("StatsMods",t),s}getStatBonus(e){return this._addFromCompList("StatsMods",e)}}t.SentientActor=y,i.default.STATS.forEach(e=>{y.prototype[i.default.formatGetterName(e)]=function(){return this.getStatVal(e)}});const _=["StatsMods","CombatMods"];function b(e){_.forEach(t=>{let s=!1;if(e.has(t)){e.getList(t).forEach(e=>{"brain-player"===e.getTag()&&(s=!0)})}if(!s){const s=new c[t];s.setTag("brain-player"),e.add(s)}})}t.Actor.Sentient=y,y.getFormattedStats=function(e){const t=e.getLevel().getLevelNumber(),s=i.default.formatLocationName(e.getLevel());let n=null;e.has("SpellPower")&&(n=e.get("SpellPower").getPP()+"/"+e.get("SpellPower").getMaxPP());let r={HP:e.get("Health").getHP()+"/"+e.get("Health").getMaxHP(),PP:n,Att:[e.getAttack(),e.getCombatBonus("getAttack")],Def:[e.getDefense(),e.getCombatBonus("getDefense")],Pro:[e.getProtection(),e.getCombatBonus("getProtection")]};return Object.keys(i.default.STATS_ABBR2STAT).forEach(t=>{const s=i.default.STATS_ABBR2STAT[t],n=i.default.formatGetterName(s);r[t]=[e[n](),e.getStatBonus(n)]}),r=Object.assign(r,{Speed:[e.getSpeed(),e.getStatBonus("getSpeed")],XP:e.get("Experience").getExp(),XL:e.get("Experience").getExpLevel(),DL:t,Loc:s}),e.has("Hunger")&&(r.E=e.get("Hunger").getEnergy()),r}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Scheduler=t.OneShotEvent=t.RegenPPEvent=t.RegenEvent=t.GameEvent=t.Action=void 0;const r=n(s(267)),a=n(s(0)),o=r.default.Action;class i{constructor(e,t){this._duration=e,this._cb=t,this._energy=0}setEnergy(e){this._energy=e}getEnergy(){return this._energy}getDuration(){return this._duration}doAction(){this._cb()}}t.Action=i;class l{constructor(e,t,s,n){this.isEvent=!0,this.dur=e,this.cb=t,this._repeat=s,this._offset=n,this._level=null}isPlayer(){return!1}nextAction(){return new i(this.dur,this.cb)}getRepeat(){return this._repeat}setRepeat(e){this._repeat=e}getOffset(){return this._offset}setOffset(e){this._offset=e}setLevel(e){this._level=e}getLevel(){return this._level}}t.GameEvent=l;t.RegenEvent=class extends l{constructor(e,t){super(t,()=>{e.get("Health").addHP(1)},!0,0)}};t.RegenPPEvent=class extends l{constructor(e,t){super(t,()=>{e.get("SpellPower").addPP(1)},!0,0)}};t.OneShotEvent=class extends l{constructor(e,t,s){super(0,()=>{a.default.isNullOrUndef([s])||a.default.gameMsg(s),e()},!1,t)}};t.Scheduler=class{constructor(){this._scheduler=new o,this._scheduler._defaultDuration=0,this._scheduler._duration=0,this._events=[],this._actors=[]}add(e,t,s){if(this._scheduler.add(e,t,s),e.hasOwnProperty("isEvent"))this._events.push(e);else{this._actors.indexOf(e)<0?this._actors.push(e):a.default.err("Scheduler","add","Tried to add actor second time: "+JSON.stringify(e))}}next(){return this._scheduler.next()}setAction(e){this._scheduler.setDuration(e.getDuration())}remove(e){if(e.hasOwnProperty("isEvent"))return this.removeEvent(e);{const t=this._actors.indexOf(e);-1!==t&&this._actors.splice(t,1)}return this._scheduler.remove(e)}removeEvent(e){let t=-1;return e.hasOwnProperty("isEvent")&&(t=this._events.indexOf(e),-1!==t&&this._events.splice(t,1)),this._scheduler.remove(e)}getTime(){return this._scheduler.getTime()}printIDs(){this._actors.forEach(e=>{})}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BypassComp=t.adjustActorValues=t.Actors=t.ActorsData=void 0;const r=n(s(0)),a=s(47),o="GoalOriented";function i(e){return{comp:"BypassProtection",func:{setChance:e}}}t.ActorsData=[{name:"animal",dontCreate:!0,type:"animal",className:"cell-actor-animal",attack:1,defense:1,hp:5,protection:0,range:1,danger:1,speed:100,brain:"Animal",enemies:r.default.ACTOR_RACES},{name:"chicken",char:"c",base:"animal",color:a.color("Red","White"),damage:"1d1",hp:1,noRandom:!0,enemies:[],ability:{addEntity:{entityName:"Chicken egg",endMsg:"Chicken lays an egg onto the ground!"}}},{name:"rat",char:"r",base:"animal"},{name:"cloud of insects",char:"i",base:"animal",color:a.color("Green","black"),damage:"1d1",defense:2,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1"}]},{name:"bat",char:"b",base:"animal",defense:2,addComp:"Flying"},{name:"giant ant",char:"a",base:"animal",defense:2,hp:7},{name:"badger",char:"c",base:"animal",attack:1,defense:4,damage:"1d4",hp:10,danger:2},{name:"coyote",char:"c",base:"animal",colorfg:"Yellow",attack:3,defense:3,damage:"1d4",hp:12,danger:2},{name:"lynx",char:"f",base:"animal",colorfg:"Orange",attack:5,defense:1,damage:"1d6",hp:12,danger:3},{name:"hawk",char:"H",base:"animal",attack:4,defense:1,damage:"1d5",hp:9,danger:3,addComp:"Flying"},{name:"cloud of horseflies",char:"i",base:"animal",color:a.color("Orange","black"),damage:"1d3",speed:115,defense:10,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1"}],danger:3},{name:"wolf",char:"w",base:"animal",attack:4,defense:2,damage:"1d6",hp:15,danger:3},{name:"rattlesnake",char:"s",base:"animal",attack:2,defense:3,damage:"1d3",hp:10,danger:3,poison:{duration:"1d6",damage:"1d10",prob:"0.1"}},{name:"cave spider",char:"S",base:"animal",attack:2,defense:4,damage:"1d5",hp:15,danger:4,poison:{duration:"3d6",damage:"1d4 + 1",prob:"0.15"}},{name:"woolly spider",char:"S",base:"animal",attack:4,defense:4,damage:"1d6 + 2",hp:20,danger:4,poison:{duration:"3d6",damage:"1d4 + 1",prob:"0.15"},onHit:[{addComp:"Paralysis",duration:"1"}]},{name:"wolverine",char:"W",base:"animal",attack:4,defense:4,damage:"1d7",hp:20,danger:4},{name:"auroch",char:"A",base:"animal",attack:2,defense:4,protection:5,damage:"1d7",hp:23,danger:4},{name:"eagle",char:"E",base:"animal",attack:4,defense:4,damage:"1d7",hp:20,danger:4,addComp:"Flying"},{name:"dire wolf",char:"w",base:"animal",colorfg:"Gray",attack:6,defense:2,damage:"1d8 + 2",hp:23,danger:5},{name:"giant spider",char:"S",base:"animal",colorfg:"Green",attack:6,defense:3,damage:"1d8 + 2",hp:17,danger:5,poison:{duration:"4d6",damage:"1d4 + 2",prob:"0.20"}},{name:"black vulture",char:"V",base:"animal",attack:5,defense:5,damage:"1d7",hp:25,danger:5,addComp:"Flying"},{name:"giant scorpion",char:"S",base:"animal",attack:5,defense:5,damage:"1d6 + 1",hp:19,danger:5,brain:"SpellCaster",spells:["ScorpionsTail"],maxPP:1,pp:1,poison:{duration:"4d6",damage:"1d4 + 2",prob:"0.20"}},{name:"bear",char:"B",base:"animal",attack:5,defense:5,damage:"1d9",hp:30,danger:5},{name:"mountain lion",char:"f",base:"animal",attack:6,defense:3,damage:"2d4",hp:25,danger:5},{name:"sabretooth tiger",char:"f",base:"animal",attack:8,defense:3,damage:"3d3",colorfg:"Red",hp:25,danger:5,speed:110},{name:"dire bear",char:"B",base:"animal",colorfg:"Gray",attack:8,defense:5,damage:"4d4",hp:40,danger:6},{name:"griffin",char:"G",base:"animal",attack:7,defense:7,damage:"3d3 + 3",hp:35,danger:7,addComp:"Flying",speed:130},{name:"polar bear",char:"B",base:"animal",color:a.color("blue","white"),attack:10,defense:5,protection:7,damage:"4d4 + 5",hp:50,danger:8,onHit:[{addComp:"Stun",duration:"1d2 + 1"}],addComp:[a.resistance("ICE","STRONG")]},{name:"giant horsefly",char:"I",base:"animal",color:a.color("Orange","black"),attack:10,defense:15,damage:"3d3",hp:25,speed:110,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1"}],danger:8},{name:"mammoth",char:"M",base:"animal",attack:4,defense:4,protection:7,damage:"1d9",strength:30,hp:40,danger:8,addComp:[a.resistance("ICE","MEDIUM")]},{name:"dire mammoth",char:"M",base:"animal",attack:4,defense:4,protection:10,damage:"1d15",strength:35,hp:50,danger:9,colorfg:"Gray",addComp:[a.resistance("ICE","MEDIUM")]},{name:"polar bear king",char:"B",base:"animal",color:a.color("cyan","white"),attack:15,defense:7,damage:"5d5 + 5",hp:75,danger:10,onHit:[{addComp:"Stun",duration:"1d2 + 1"}],addComp:[a.resistance("ICE","IMMUNITY")]},{name:"thunderbird",char:"G",base:"animal",attack:7,defense:7,damage:"2d8",hp:45,danger:10,addComp:"Flying",brain:"SpellCaster",spells:["LightningArrow"],maxPP:30,pp:30},{name:"manticore",char:"M",base:"animal",attack:7,defense:7,damage:"2d10",hp:50,danger:10,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1d4 + 1"}]},{name:"forest wurm",char:"W",base:"animal",color:a.color("Green","Brown"),attack:12,defense:7,protection:15,damage:"3d10",hp:70,danger:10},{name:"spider queen",char:"S",base:"animal",color:a.color("Purple","Green"),attack:7,defense:7,protection:7,damage:"2d8 + 7",hp:45,danger:11,brain:"SpellCaster",spells:["SummonSpiders","ArrowOfWebs"],maxPP:40,pp:40,poison:{duration:"10d6",damage:"1d5 + 3",prob:"0.20"}},{name:"ancient manticore",char:"M",base:"animal",color:a.color("Gray","Brown"),attack:15,defense:10,protection:10,damage:"2d10 + 10",hp:75,danger:15,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1d6 + 1"}],spells:["SummonKin"],maxPP:30,pp:30},{name:"BeastBase",type:"beast",dontCreate:!0,enemies:r.default.ACTOR_RACES},{name:"imp",base:"BeastBase",char:"I",color:a.color("Black","Red"),attack:3,defense:3,protection:3,damage:"1d7 + 2",hp:10,danger:3,brain:"SpellCaster",spells:["SlimeBolt"],addComp:["Flying"],maxPP:12,pp:12},{name:"chasm fiend",base:"BeastBase",char:"I",color:a.color("Black","OrangeRed"),attack:6,defense:3,protection:3,damage:"1d8 + 3",hp:20,danger:3,addComp:["Flying"]},{name:"cave dweller",base:"BeastBase",char:"C",color:a.color("Black","Red"),attack:5,defense:5,protection:5,damage:"1d10 + 2",hp:30,danger:5,brain:"SpellCaster",spells:["SlimeBolt"],maxPP:18,pp:18},{name:"cave lurker",base:"BeastBase",char:"C",color:a.color("Black","OrangeRed"),attack:8,defense:8,protection:5,damage:"2d10 + 2",hp:50,danger:9,brain:"SpellCaster",spells:["SlimeBolt"],maxPP:30,pp:30},{name:"hezrou",base:"BeastBase",char:"B",className:"cell-actor-poison",attack:5,defense:5,protection:3,hp:50,danger:11,damage:"4d4",addComp:[a.resistance("POISON","IMMUNITY")],brain:"SpellCaster",spells:["PoisonCloud"],maxPP:40,pp:40},{name:"ConstructBase",type:"construct",dontCreate:!0,enemies:r.default.ACTOR_RACES},{name:"water golem",base:"ConstructBase",char:"Y",className:"cell-actor-water",addComp:"Amphibious",attack:3,defense:6,protection:6,hp:25,danger:6,damage:"3d4",brain:"SpellCaster",spells:["WaterBolt"],maxPP:10,pp:10},{name:"earth golem",base:"ConstructBase",char:"Y",className:"cell-actor-earth",equip:[{name:"Large rock",count:6}],attack:6,defense:3,protection:8,hp:25,danger:7,damage:"3d4"},{name:"fire golem",base:"ConstructBase",color:a.color("Red","Black"),char:"Y",attack:7,defense:4,protection:4,hp:35,danger:8,damage:"4d4",addComp:[a.resistance("FIRE","MEDIUM")],brain:"SpellCaster",spells:["RingOfFire"],maxPP:20,pp:20},{name:"void golem",base:"ConstructBase",color:a.color("Purple","Black"),char:"Y",className:"cell-actor-void",attack:7,defense:7,protection:7,hp:30,danger:8,damage:"3d4+4",addComp:["SpellStop",a.resistance("MAGIC","IMMUNITY"),a.resistance("VOID","MEDIUM")]},{name:"water elemental",base:"ConstructBase",char:"E",className:"cell-actor-water",attack:5,defense:5,protection:3,hp:45,danger:10,damage:"4d4",addComp:"Amphibious",brain:"SpellCaster",spells:["WaterBolt"],maxPP:40,pp:40},{name:"air elemental",base:"ConstructBase",char:"E",className:"cell-actor-air",attack:5,defense:5,protection:3,hp:45,danger:10,damage:"4d4",addComp:"Flying",brain:"SpellCaster",spells:["LightningBolt"],maxPP:40,pp:40},{name:"earth elemental",base:"ConstructBase",char:"E",className:"cell-actor-earth",attack:6,defense:3,protection:12,hp:60,danger:12,damage:"4d4",brain:"SpellCaster",spells:["RockStorm"],equip:[{name:"Huge rock",count:6}],maxPP:70,pp:70},{name:"fire elemental",base:"ConstructBase",color:a.color("Red","Black"),char:"E",attack:9,defense:6,protection:8,hp:55,danger:14,damage:"4d4",brain:"SpellCaster",spells:["FireBolt","RingOfFire"],addComp:[a.resistance("FIRE","IMMUNITY")],maxPP:60,pp:60},{name:"void elemental",base:"ConstructBase",color:a.color("Purple","Black"),char:"E",className:"cell-actor-void",attack:7,defense:7,protection:7,hp:70,danger:15,damage:"5d4",brain:"SpellCaster",spells:["PowerDrain"],addComp:["SpellStop",a.resistance("MAGIC","ABSORB"),a.resistance("VOID","IMMUNITY")],maxPP:70,pp:70},{name:"ancient void elemental",base:"ConstructBase",color:a.color("Purple","Black"),char:"E",className:"cell-actor-void",attack:20,defense:20,protection:20,hp:100,danger:25,damage:"7d4",brain:"SpellCaster",spells:["VoidBolt","PowerDrain"],addComp:["SpellStop",a.resistance("MAGIC","ABSORB"),a.resistance("VOID","IMMUNITY")],maxPP:100,pp:100},{name:"goblin",char:"g",type:"goblin",className:"cell-actor-goblin",attack:1,defense:1,damage:"1d6",range:1,hp:7,protection:1,danger:2,enemies:["human"],brain:o},{name:"goblin slinger",base:"goblin",attack:2,defense:1,hp:10,damage:"1d6",equip:[{name:"Rock",count:10}]},{name:"goblin fighter",base:"goblin",attack:2,defense:3,protection:1,hp:12,damage:"2d5",danger:2},{name:"goblin healer",base:"goblin",attack:2,defense:4,protection:2,hp:15,danger:3,damage:"1d6 + 2",brain:"SpellCaster",pp:18,maxPP:18,spells:["Heal"]},{name:"goblin sergeant",base:"goblin",damage:"3d4+2",attack:4,defense:4,protection:2,hp:21,danger:4},{name:"goblin summoner",base:"goblin",attack:2,defense:4,protection:2,hp:25,maxPP:20,pp:20,damage:"1d8",brain:"SpellCaster",spells:["SummonAnimal"],danger:5},{name:"goblin lord",base:"goblin",attack:5,defense:4,protection:3,hp:30,danger:7,damage:"4d4",colorfg:"pink"},{name:"goblin king",base:"goblin",attack:7,defense:7,protection:3,hp:40,danger:10,damage:"4d4+6",brain:"SpellCaster",spells:["SummonKin"],colorfg:"red"},{name:"HyrmBase",char:"Y",type:"hyrm",color:a.color("Black","Purple"),dontCreate:!0,attack:1,defense:1,damage:"1d4",range:1,hp:10,danger:2,brain:o,enemies:r.default.ACTOR_RACES},{name:"hyrm warrior",base:"HyrmBase",attack:3,defense:3,damage:"2d6+2",hp:20,danger:3},{name:"hyrm catapulter",base:"HyrmBase",attack:3,defense:3,damage:"1d8",hp:25,danger:4,equip:[{name:"Large rock",count:4}]},{name:"hyrm runemage",base:"HyrmBase",color:a.color("Black","Pink"),attack:3,defense:3,damage:"1d8",hp:25,danger:5,brain:"SpellCaster",spells:["SummonKin","StunningTouch"],maxPP:20,pp:20},{name:"hyrm hulk",base:"HyrmBase",color:a.color("Black","Pink"),attack:6,defense:3,damage:"2d8",hp:40,strength:15,speed:90,danger:7},{name:"humanoid",char:"h",type:"humanoid",attack:1,defense:1,damage:"1d4",range:1,hp:10,danger:2,brain:o,enemies:r.default.ACTOR_RACES},{name:"dark warrior",char:"h",type:"humanoid",className:"cell-actor-void",attack:6,defense:4,protection:2,damage:"2d5 + 3",range:1,hp:25,enemies:r.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes"],maxPP:16,pp:16,danger:5},{name:"dark archer",char:"h",type:"humanoid",className:"cell-actor-void",attack:8,defense:3,protection:4,damage:"2d5",range:1,hp:30,enemies:r.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes"],maxPP:16,pp:16,danger:7,equip:["Iron bow",{name:"Steel arrow",count:8}],addComp:["LongRangeShot"]},{name:"dark assassin",char:"h",type:"humanoid",className:"cell-actor-void",attack:10,defense:5,protection:6,damage:"3d5 + 3",range:1,hp:50,enemies:r.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes"],maxPP:30,pp:30,danger:10,addComp:[a.resistance("POISON","IMMUNITY")],poison:{duration:"4d6",damage:"1d4 + 2",prob:"0.20"}},{name:"dark lord",char:"h",type:"humanoid",color:a.color("Yellow","Purple"),attack:12,defense:10,protection:8,damage:"4d5 + 5",range:1,hp:75,enemies:r.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes","PoisonArrow"],maxPP:60,pp:60,danger:15,addComp:[a.resistance("POISON","IMMUNITY")],poison:{duration:"4d6",damage:"2d4 + 2",prob:"0.25"}},{name:"necromancer",char:"@",type:"humanoid",color:a.color("Black","Red"),attack:9,defense:9,protection:5,damage:"4d5 + 5",hp:45,enemies:r.default.ACTOR_RACES,brain:"SpellCaster",danger:10,pp:25,maxPP:25,addComp:[a.resistance("NECRO","STRONG"),a.resistance("ICE","MEDIUM")],spells:["AnimateDead"]},{name:"AvianFolkBase",char:"A",className:"cell-actor-avianfolk",type:"avianfolk",dontCreate:!0,enemies:["human","catfolk","dogfolk","wolfclan"],brain:o,addComp:"Flying",attack:2,defense:2,damage:"1d6",range:1,protection:1,hp:15,danger:2},{name:"avian townsfolk",base:"AvianFolkBase",danger:1,attack:1,defense:1,damage:"1d4",hp:10},{name:"avian scout",base:"AvianFolkBase",danger:2,attack:3,defense:3,damage:"2d4",hp:20,speed:110,fovrange:6},{name:"avian fighter",base:"AvianFolkBase",danger:4,attack:6,defense:7,damage:"3d4",hp:30},{name:"avian arbalist",base:"AvianFolkBase",danger:5,attack:6,defense:7,damage:"3d4",hp:30,equip:["Wooden crossbow",{name:"Wooden bolt",count:10}]},{name:"avian duelist",base:"AvianFolkBase",danger:8,attack:7,defense:10,damage:"3d5",hp:40,addComp:["CounterAttack","Flying"]},{name:"avian judicator",base:"AvianFolkBase",danger:9,attack:7,defense:10,damage:"4d4",hp:45,addComp:["FirstStrike","Flying"]},{name:"avian archmage",base:"AvianFolkBase",danger:11,attack:5,defense:10,damage:"3d4",hp:45,brain:"SpellCaster",spells:["SummonAirElemental"],pp:40,maxPP:40},{name:"avian emperor",base:"AvianFolkBase",danger:16,attack:8,defense:14,damage:"5d5",hp:85,addComp:["Flying",i(.15)]},{name:"BearfolkBase",char:"B",className:"cell-actor-bearfolk",dontCreate:!0,type:"bearfolk",attack:1,defense:1,damage:"1d5 + 1",range:1,hp:10,danger:1,enemies:["goblin","dwarf","undead","demon"],brain:o},{name:"bearfolk thief",base:"BearfolkBase",color:a.color("Yellow","Black"),damage:"1d7",brain:"Thief",attack:1,defense:1,danger:2,hp:12},{name:"bearfolk fighter",base:"BearfolkBase",damage:"1d8",attack:2,defense:2,danger:2,hp:15},{name:"bearfolk archer",base:"BearfolkBase",damage:"1d6",attack:2,defense:2,danger:3,hp:13,equip:["Wooden bow",{name:"Wooden arrow",count:10}]},{name:"bearfolk mage",base:"BearfolkBase",damage:"1d6",attack:2,defense:2,danger:4,hp:15,equip:["Robe","Wooden staff"],brain:"SpellCaster",spells:["SummonKin"],pp:20,maxPP:20},{name:"bearfolk magistrate",base:"BearfolkBase",damage:"1d10 + 2",colorfg:"Purple",attack:4,defense:4,danger:5,hp:30,equip:["Leather armour"]},{name:"bearfolk elite",base:"BearfolkBase",damage:"2d6",attack:5,defense:5,hp:37,danger:6,onHit:[{addComp:"Stun",duration:"1d4 + 1"}]},{name:"bearfolk king",base:"BearfolkBase",damage:"3d6",strength:16,attack:7,defense:7,protection:5,danger:8,hp:75},{name:"UndeadBase",className:"cell-actor-undead",color:a.color("White","Black"),dontCreate:!0,addComp:"Undead",brain:"GoalOriented",attack:1,defense:1,protection:0,range:1,enemies:r.default.ACTOR_RACES,type:"undead"},{name:"skeletal dog",char:"d",base:"UndeadBase",damage:"1d6",danger:1,brain:"Animal",hp:6},{name:"skeletal spider",char:"S",base:"UndeadBase",attack:2,defense:1,damage:"1d4",danger:1,hp:5,brain:"Animal",poison:{duration:"2d10",damage:"1d2",prob:"0.2"}},{name:"necrocentipede",char:"w",base:"UndeadBase",attack:1,defense:1,damage:"1d7",danger:2,brain:"Animal",speed:125,hp:6},{name:"skeleton",char:"z",base:"UndeadBase",attack:2,defense:1,damage:"1d5",danger:1,hp:9},{name:"zombie",char:"z",base:"UndeadBase",colorfg:"Brown",attack:2,defense:2,damage:"1d6",danger:2,hp:12},{name:"skeleton archer",char:"z",base:"UndeadBase",colorfg:"Yellow",attack:4,defense:2,damage:"1d8",danger:4,hp:15,equip:["Wooden bow",{name:"Wooden arrow",count:5}]},{name:"skeleton warrior",char:"z",base:"UndeadBase",attack:3,defense:3,damage:"1d8 + 2",danger:4,hp:20},{name:"necrowurm",char:"W",base:"UndeadBase",attack:4,defense:4,damage:"1d9",danger:5,brain:"Animal",speed:115,hp:21},{name:"skeleton berserker",char:"z",base:"UndeadBase",colorfg:"Pink",attack:6,defense:1,damage:"1d10 + 4",danger:5,hp:15},{name:"ghoul",char:"z",base:"UndeadBase",colorfg:"LightGray",attack:3,defense:3,damage:"1d7 + 2",danger:5,hp:15,onHit:[{addComp:"Paralysis",duration:"1d4"}]},{name:"crypt zombie",char:"z",base:"UndeadBase",colorfg:"Yellow",attack:2,defense:2,protection:4,damage:"3d5",danger:6,hp:30},{name:"ghost",char:"G",base:"UndeadBase",attack:4,defense:4,damage:"2d5 + 2",danger:6,onHit:[{addComp:"StatsMods",func:[{setter:"setSpeed",value:-5}],duration:"3d10"}],hp:25},{name:"wraith",char:"Z",base:"UndeadBase",colorfg:"Cyan",attack:5,defense:5,damage:"2d5 + 2",danger:6,onHit:[{addComp:"StatsMods",func:[{setter:"setStrength",value:-1}],duration:"2d10"}],hp:25},{name:"specter",char:"Z",base:"UndeadBase",colorfg:"Blue",attack:6,defense:6,damage:"2d5 + 5",danger:7,onHit:[{addComp:"StatsMods",func:[{setter:"setMagic",value:-1}],duration:"10d10"}],hp:25,addComp:["Flying",a.resistance("ICE","STRONG")]},{name:"boneclaw",char:"B",base:"UndeadBase",attack:12,defense:4,damage:"2d7 + 2",danger:9,speed:100,onAttackHit:[{addComp:"DirectDamage",func:[{setter:"setDamage",value:2},{setter:"setDamageType",value:r.default.DMG.NECRO},{setter:"setDamageCateg",value:r.default.DMG.MELEE}],duration:"1d8 + 2"}],hp:35},{name:"ghost lord",char:"G",base:"UndeadBase",colorfg:"LightGray",attack:7,defense:7,damage:"2d5 + 2",danger:8,onHit:[{addComp:"StatsMods",func:[{setter:"setSpeed",value:-10}],duration:"3d10"}],hp:35},{name:"skeleton king",char:"Z",base:"UndeadBase",colorfg:"red",attack:6,defense:6,damage:"3d5 + 5",danger:9,hp:45,addComp:[a.resistance("PIERCE","STRONG"),a.resistance("SLASH","STRONG"),a.resistance("ICE","STRONG")]},{name:"vampire",char:"V",base:"UndeadBase",colorfg:"Purple",attack:6,defense:6,damage:"3d5 + 2",danger:9,speed:120,onHit:[{addComp:"StatsMods",func:[{setter:"setStrength",value:-2}],duration:"5d10"}],hp:40},{name:"undead unicorn",char:"U",base:"UndeadBase",colorfg:"GhostWhite",attack:7,defense:7,protection:7,damage:"2d5 + 5",danger:9,speed:102,hp:50,addComp:[i(.25)]},{name:"necrowyrm",char:"W",base:"UndeadBase",colorfg:"GhostWhite",attack:7,defense:7,protection:7,damage:"3d5",danger:10,brain:"Animal",speed:107,hp:50,addComp:["Flying"]},{name:"ghost king",char:"G",base:"UndeadBase",colorfg:"Yellow",attack:7,defense:7,damage:"3d5 + 2",danger:12,brain:"SpellCaster",onHit:[{addComp:"StatsMods",func:[{setter:"setSpeed",value:-15}],duration:"3d10"}],hp:50,addComp:[i(.2)]},{name:"lich",char:"L",base:"UndeadBase",attack:4,defense:8,protection:4,damage:"1d8 + 6",danger:12,hp:50,brain:"SpellCaster",spells:["GraspOfWinter","SummonDead"],maxPP:50,pp:50,addComp:[a.resistance("ICE","MEDIUM")]},{name:"lich king",char:"L",base:"UndeadBase",colorfg:"Yellow",attack:8,defense:8,protection:6,damage:"2d8 + 2",danger:17,hp:75,brain:"SpellCaster",spells:["SummonDead","AnimateDead"],maxPP:75,pp:75,onHit:[a.meleeHitDamage(4,"1d6","NECRO")],addComp:[a.resistance("ICE","MEDIUM"),a.resistance("POISON","IMMUNITY"),a.resistance("NECRO","IMMUNITY")]},{name:"WinterBeingBase",dontCreate:!0,enemies:r.default.ACTOR_RACES,color:a.color("Blue","White"),addComp:["SnowWalk",a.resistance("ICE","MEDIUM")]},{name:"Crevasse worm",char:"w",base:"WinterBeingBase",attack:1,defense:1,damage:"1d4",speed:110,danger:1,hp:5,type:"animal"},{name:"Ice bat",char:"b",base:"WinterBeingBase",attack:1,defense:1,damage:"1d6",speed:110,danger:2,hp:8,brain:"Animal",addComp:["Flying",a.resistance("ICE","MEDIUM")],type:"animal"},{name:"Arctic fox",char:"f",base:"WinterBeingBase",attack:4,defense:1,damage:"1d7 + 3",speed:105,danger:3,hp:12,brain:"Animal",type:"animal"},{name:"Frost goblin",char:"g",base:"WinterBeingBase",attack:3,defense:3,protection:1,damage:"1d7",hp:12,danger:3,type:"icebeing",brain:o},{name:"Frost viper",char:"s",base:"WinterBeingBase",attack:3,defense:3,protection:3,damage:"1d7",hp:18,danger:4,type:"animal",poison:{duration:"1d6 + 5",damage:"1d6",prob:"0.1"}},{name:"Arctic Wolf",char:"w",base:"WinterBeingBase",attack:4,defense:2,damage:"1d8",brain:"Animal",hp:21,danger:5,type:"animal"},{name:"Glacial shaman",char:"@",base:"WinterBeingBase",colorfg:"CadetBlue",attack:4,defense:4,protection:3,damage:"1d7 + 2",type:"icebeing",danger:5,hp:25,spells:["IcyPrison"],maxPP:22,pp:21,brain:"SpellCaster"},{name:"Glacial golem",char:"G",base:"WinterBeingBase",attack:4,defense:4,protection:3,damage:"2d4",speed:90,danger:5,hp:30,type:"construct"},{name:"Ice minion",base:"WinterBeingBase",char:"m",attack:4,defense:4,protection:2,damage:"2d4",hp:20,danger:5,type:"demon",onHit:[{addComp:"Coldness",duration:"10d10"}]},{name:"Mighty raven",base:"WinterBeingBase",char:"R",attack:4,defense:10,damage:"2d4 + 2",range:1,hp:20,danger:5,brain:"Animal",addComp:["Flying",a.resistance("ICE","MEDIUM")]},{name:"Snow leopard",base:"WinterBeingBase",char:"f",attack:8,defense:4,damage:"1d6 + 5",range:1,hp:25,danger:5,brain:"Animal",type:"animal",speed:120},{name:"Cryomancer",base:"WinterBeingBase",char:"@",type:"icebeing",attack:4,defense:4,damage:"1d6",range:1,hp:30,danger:5,spells:["FrostBolt"],maxPP:22,pp:21,brain:"SpellCaster"},{name:"Winter demon",type:"demon",char:"&",colorfg:"CadetBlue",attack:5,defense:5,protection:2,damage:"3d3",range:1,hp:30,danger:10,brain:"GoalOriented",base:"WinterBeingBase"},{name:"Harbinger of winter",type:"demon",char:"@",colorfg:"DarkBlue",attack:5,defense:5,protection:2,damage:"3d3",range:1,hp:35,danger:10,brain:"SpellCaster",base:"WinterBeingBase",spells:["GraspOfWinter"],maxPP:30,pp:30},{name:"Stormrider",type:"demon",char:"&",colorfg:"DarkBlue",attack:6,defense:6,protection:3,damage:"4d3",range:1,hp:40,danger:12,brain:"GoalOriented",base:"WinterBeingBase",equip:["Permaice short sword"]},{name:"Ice archon",type:"demon",char:"A",attack:6,defense:6,protection:3,damage:"4d3",range:1,hp:40,danger:12,base:"WinterBeingBase",brain:"SpellCaster",pp:30,maxPP:30,spells:["RingOfFrost"]},{name:"Ice djinn",type:"demon",char:"&",attack:7,defense:6,protection:6,damage:"3d5+5",range:1,hp:45,danger:14,brain:"GoalOriented",base:"WinterBeingBase"},{name:"Blizzard beast",type:"demon",char:"B",colorfg:"CadetBlue",attack:7,defense:6,protection:8,damage:"3d5+5",range:1,hp:50,danger:16,brain:"GoalOriented",base:"WinterBeingBase"},{name:"Ice behemoth",type:"demon",char:"B",colorfg:"DarkBlue",attack:10,defense:3,protection:8,damage:"4d5+5",range:2,hp:65,danger:16,brain:"GoalOriented",base:"WinterBeingBase",onHit:[{addComp:"Coldness"}]},{name:"Frost Titan",type:"giant",char:"H",attack:8,defense:7,protection:12,damage:"5d5",range:1,hp:80,danger:18,brain:"GoalOriented",base:"WinterBeingBase",onHit:[{addComp:"Stun",duration:"1d8"}]},{name:"Frostburn monarch",type:"demon",char:"M",attack:10,defense:10,protection:10,damage:"4d5",range:1,hp:70,danger:20,brain:"SpellCaster",base:"WinterBeingBase",onHit:[{addComp:"Coldness"}],spells:["FrostBolt","SummonIceMinion"],pp:50,maxPP:50},{name:"dwarf",char:"h",type:"dwarf",className:"cell-actor-dwarf",attack:2,defense:2,protection:1,damage:"1d4",range:1,hp:20,danger:3,enemies:["human","undead","demon"],brain:o},{name:"dwarven fighter",base:"dwarf",attack:4,defense:4,protection:2,damage:"1d7",range:1,hp:30,danger:4,equip:["Spear"]},{name:"dwarven axeman",base:"dwarf",attack:4,defense:4,protection:3,damage:"1d8",range:1,hp:40,danger:5,equip:["Battle axe","Chain armour"]},{name:"dwarven priest",base:"dwarf",attack:7,defense:3,damage:"1d8",range:1,hp:40,danger:7,brain:"SpellCaster",spells:["Heal"],pp:50,maxPP:50},{name:"dwarven hammerer",base:"dwarf",attack:4,defense:6,protection:4,damage:"1d10",range:1,hp:45,danger:6,equip:["Dwarven pick-axe","Leather armour"]},{name:"dwarven bolter",base:"dwarf",attack:7,defense:3,damage:"1d8",range:1,hp:40,danger:7,fovrange:7,equip:["Steel crossbow",{name:"Steel bolt",count:7}]},{name:"dwarven rifleman",base:"dwarf",attack:4,defense:4,damage:"1d8",range:1,hp:40,danger:8,fovrange:7,equip:["Rifle",{name:"Steel bullet",count:10}]},{name:"dwarven elite",base:"dwarf",attack:5,defense:6,damage:"3d5 + 3",range:1,hp:50,danger:9,equip:["Steel armour"]},{name:"dwarven commander",base:"dwarf",attack:8,defense:8,protection:7,damage:"2d5",range:1,hp:60,danger:10,equip:["Great battle axe","Steel armour"]},{name:"dwarven king",base:"dwarf",colorfg:"red",attack:12,defense:12,protection:10,damage:"4d5 + 5",range:1,hp:75,danger:15,equip:["Mithril armour"]},{name:"human",char:"@",type:"human",className:"cell-actor-human",attack:2,defense:2,damage:"1d4",range:1,hp:20,danger:3,brain:o},{name:"townsfolk",base:"human",attack:1,defense:1,damage:"1d4",range:1,hp:10,danger:1},{name:"robber",base:"human",attack:2,defense:4,danger:3,enemies:["player"]},{name:"miner",base:"human",attack:4,danger:4,damage:"1d5",equip:["Pick-axe"]},{name:"fighter",base:"human",hp:25,attack:4,defense:4,damage:"1d8",danger:5},{name:"treasure hunter",base:"human",hp:25,attack:4,defense:4,damage:"1d8",danger:5,goals:[{name:"TreasureHunter",bias:.9}]},{name:"warlord",char:"W",base:"human",hp:35,attack:5,defense:6,damage:"3d3",danger:6},{name:"trainer",char:"@",base:"human",hp:50,attack:10,defense:10,protection:5,damage:"3d3",className:"cell-actor-trainer",noRandom:!0,danger:6,inv:[{name:"Gold coin",count:50}],addComp:"Trainer"},{name:"shopkeeper",char:"@",base:"human",hp:50,attack:10,defense:10,protection:5,damage:"3d3",className:"cell-actor-shopkeeper",noRandom:!0,danger:6,inv:[{name:"Gold coin",count:100}]},{name:"summoner",char:"@",base:"human",hp:50,attack:7,defense:7,protection:3,damage:"2d4",brain:"SpellCaster",spells:["SummonKin"],maxPP:30,pp:30,danger:10},{name:"traveller",char:"t",base:"human",hp:35,attack:5,defense:6,damage:"3d3",danger:6,brain:"NeedDriven",addComp:["Hunger"]},{name:"wildling",char:"I",className:"cell-actor-wildling",type:"wildling",brain:o,attack:2,defense:1,damage:"1d6",range:1,hp:15,danger:3,enemies:["human"]},{name:"wildling tribefolk",base:"wildling",attack:2,defense:1,damage:"1d6",hp:10,danger:1},{name:"wildling hunter",base:"wildling",attack:3,defense:3,damage:"1d6 + 2",hp:20,danger:3,equip:["Tomahawk"]},{name:"wildling archer",base:"wildling",attack:3,defense:3,damage:"1d6 + 2",hp:20,danger:4,equip:["Wooden bow",{name:"Wooden arrow",count:10}],colorfg:"Yellow",brain:o},{name:"wildling fighter",base:"wildling",attack:4,defense:3,damage:"1d9 + 3",hp:25,danger:5},{name:"wildling elite",base:"wildling",attack:5,defense:3,damage:"1d10 + 4",hp:32,danger:6},{name:"wildling warlord",base:"wildling",attack:6,defense:3,damage:"1d12 + 5",hp:40,danger:7,colorfg:"YellowGreen"},{name:"wildling king",base:"wildling",attack:8,defense:5,damage:"1d15 + 6",hp:50,danger:10,colorfg:"Red"},{name:"CatfolkBase",char:"f",className:"cell-actor-catfolk",type:"catfolk",dontCreate:!0,attack:1,defense:1,protection:1,damage:"1d6",range:1,hp:10,danger:1,enemies:["human","dogfolk","wolfclan"],brain:o},{name:"catfolk townsfolk",base:"CatfolkBase",attack:1,defense:1,hp:10,danger:1},{name:"catfolk hunter",base:"CatfolkBase",attack:1,defense:4,damage:"3d2",hp:15,danger:2},{name:"catfolk darter",base:"CatfolkBase",attack:1,defense:4,damage:"3d2",hp:15,danger:3,brain:o,equip:[{name:"Iron dart",count:9}]},{name:"catfolk warrior",base:"CatfolkBase",attack:2,defense:5,damage:"4d2",hp:20,danger:4},{name:"catfolk elite",base:"CatfolkBase",attack:3,defense:7,damage:"5d2",hp:27,danger:5,addComp:"CounterAttack"},{name:"catfolk wizard",base:"CatfolkBase",attack:3,defense:6,damage:"4d2",hp:25,danger:6,brain:"SpellCaster",spells:["EnergyArrow"],maxPP:20,pp:20},{name:"catfolk warlord",base:"CatfolkBase",attack:4,defense:8,damage:"6d2",hp:35,danger:7},{name:"catfolk queen",base:"CatfolkBase",attack:6,defense:15,damage:"7d3",hp:45,danger:10,colorfg:"Purple",addComp:"FirstStrike"},{name:"catfolk king",base:"CatfolkBase",attack:10,defense:12,protection:6,damage:"7d3 + 5",hp:60,danger:13,colorfg:"Red"},{name:"WolfclanBase",dontCreate:!0,danger:1,attack:1,defense:1,damage:"1d4",range:1,protection:2,className:"cell-actor-wolfclan",char:"w",type:"wolfclan",enemies:["human","catfolk","dogfolk","bearfolk"],brain:o},{name:"wolfclan folk",base:"WolfclanBase",danger:1,hp:12,attack:2,defense:1,damage:"1d6",range:1},{name:"wolfclan brave",base:"WolfclanBase",danger:4,attack:4,defense:3,damage:"2d4",hp:25},{name:"wolfclan skirmisher",base:"WolfclanBase",danger:5,attack:5,defense:4,damage:"2d4+3",hp:30},{name:"wolfclan scourger",base:"WolfclanBase",danger:6,attack:7,defense:5,damage:"2d4+7",hp:35},{name:"wolfclan mage",base:"WolfclanBase",danger:7,attack:7,defense:5,damage:"2d4+7",hp:35,spells:["PowerDrain"],maxPP:30,pp:30,brain:"SpellCaster"},{name:"wolfclan elite",base:"WolfclanBase",danger:8,attack:8,defense:5,protection:5,damage:"2d4+10",hp:50,addComp:"CounterAttack"},{name:"wolfclan judicator",base:"WolfclanBase",danger:9,attack:8,defense:8,damage:"3d4+6",hp:55,addComp:"FirstStrike"},{name:"wolfclan commander",base:"WolfclanBase",danger:10,attack:10,defense:5,damage:"4d4+10",hp:60},{name:"wolfclan king",base:"WolfclanBase",danger:14,attack:10,defense:10,damage:"5d4+10",hp:75},{name:"DogfolkBase",dontCreate:!0,className:"cell-actor-dogfolk",char:"d",type:"dogfolk",protection:1,enemies:["catfolk","wolfclan"],brain:o},{name:"dogfolk gatherer",base:"DogfolkBase",attack:1,defense:3,damage:"1d4 + 1",hp:10,danger:1},{name:"dogfolk hunter",base:"DogfolkBase",attack:2,defense:3,damage:"6d1",hp:15,danger:2},{name:"dogfolk thrower",base:"DogfolkBase",attack:2,defense:3,damage:"6d1+1",hp:15,danger:3,equip:[{name:"Throwing axe",count:7}]},{name:"dogfolk warrior",base:"DogfolkBase",danger:4,attack:3,defense:3,damage:"7d1+3",hp:20},{name:"dogfolk skirmisher",base:"DogfolkBase",danger:5,attack:4,defense:3,damage:"9d1+3",hp:25},{name:"dogfolk elite",base:"DogfolkBase",danger:8,attack:6,defense:6,damage:"8d2+4",hp:35,addComp:"CounterAttack"},{name:"dogfolk commander",base:"DogfolkBase",danger:10,attack:8,defense:8,damage:"8d3+4",hp:50},{name:"dogfolk king",base:"DogfolkBase",danger:13,colorfg:"red",colorbg:"white",attack:12,defense:8,damage:"8d3+8",hp:65},{name:"SpiritBase",char:"Q",className:"cell-actor-spirit",type:"spirit",dontCreate:!0,addComp:["Ethereal"],brain:"Spirit"},{name:"Rat spirit",base:"SpiritBase",strength:0,accuracy:0,agility:1,willpower:0,power:1,danger:1},{name:"Wolf spirit",base:"SpiritBase",strength:1,accuracy:0,agility:1,willpower:0,power:2,danger:2},{name:"Bear spirit",base:"SpiritBase",strength:2,accuracy:0,agility:1,willpower:0,power:3,danger:3},{name:"Fighter spirit",base:"SpiritBase",strength:2,accuracy:2,agility:1,willpower:0,power:4,danger:4},{name:"Shaman spirit",base:"SpiritBase",strength:0,accuracy:0,agility:0,willpower:6,power:5,danger:5},{name:"Winter demon spirit",base:"SpiritBase",strength:3,accuracy:3,agility:3,willpower:3,power:7,danger:7},{name:"Monarch spirit",base:"SpiritBase",strength:6,accuracy:0,agility:1,willpower:6,power:10,danger:12},{name:"HyrkhianBase",dontCreate:!0,className:"cell-actor-hyrkh",char:"y",enemies:["undead","demon","beast","animal"],damage:"1d6",type:"hyrkhian",brain:o},{name:"Hyrkhian townsfolk",base:"HyrkhianBase",damage:"1d6",attack:1,defense:1,protection:1,hp:7,danger:1},{name:"Hyrkhian footman",base:"HyrkhianBase",attack:2,defense:2,protection:2,hp:15,danger:3,equip:["Longsword"]},{name:"Hyrkhian phalanx",base:"HyrkhianBase",attack:4,defense:4,protection:2,hp:25,danger:5,equip:["Chain armour","Spear"]},{name:"Hyrkhian archer",base:"HyrkhianBase",attack:4,defense:4,protection:2,damage:"1d8",hp:20,equip:["Steel bow",{name:"Steel arrow",count:15}],danger:6},{name:"Hyrkhian adept",base:"HyrkhianBase",attack:4,defense:4,protection:2,hp:25,danger:7,maxPP:30,pp:30,brain:"SpellCaster",spells:["Heal","MagicArmor"]},{name:"Hyrkhian elite",base:"HyrkhianBase",attack:6,defense:6,protection:3,hp:35,brain:o,strength:13,equip:["Mithril short sword","Chain armour","Chain helmet"],danger:8},{name:"Hyrkhian commander",base:"HyrkhianBase",attack:8,defense:8,protection:4,hp:50,brain:o,strength:15,equip:["Great battle axe","Steel armour","Steel helmet"],danger:10},{name:"SpecialBase",noRandom:!0,actorType:"BaseActor",dontCreate:!0},{name:"Fire",className:"cell-actor-fire",base:"SpecialBase",char:"⟁",type:"flame",brain:"Flame",addComp:["Ethereal","NonSentient",{comp:"Damaging",func:{setDamageType:r.default.DMG.FIRE}}]},{name:"Ice flame",className:"cell-actor-winter",base:"SpecialBase",char:"⟁",type:"flame",brain:"Flame",addComp:["Ethereal","NonSentient",{comp:"Damaging",func:{setDamageType:r.default.DMG.ICE}}],onHit:[{addComp:"Coldness",duration:"10d10"}]},{name:"Poison gas",className:"cell-actor-poison",base:"SpecialBase",char:"⟁",type:"flame",brain:"Cloud",color:a.color("Green","Gray"),addComp:["Ethereal","NonSentient",{comp:"Damaging",func:{setDamageType:r.default.DMG.POISON}}],poison:{duration:"1d10",damage:"1d10",prob:"0.1"}},{name:"Forcefield",className:"cell-actor-forcefield",base:"SpecialBase",char:"⟁",type:"forcefield",brain:"NonSentient",speed:1,hp:25,defense:0,addComp:["Health","NonSentient","Combat","SpellStop","Breakable",{comp:"Weakness",func:{setEffect:r.default.DMG.MAGIC,setLevel:r.default.WEAKNESS.FATAL}}]},{name:"flying eye",className:"cell-actor-void",base:"SpecialBase",char:"e",type:"eye",addComp:["Ethereal"],brain:"Explorer",hp:1,speed:130,fovrange:3,actorType:"Sentient"},{name:"UniqueBase",dontCreate:!0,className:"cell-actor-unique",noRandom:!0,unique:!0,addComp:["RegenEffect"],color:a.color("DarkViolet","Beige")},{name:"Thabba, Son of Ice",base:"UniqueBase",char:"@",danger:200,enemies:["human"],type:"finalboss",spells:["FrostBolt","RingOfFrost"],hp:266,pp:100,brain:"SpellCaster",damage:"4d5",strength:30,accuracy:15,agility:20,willpower:20,perception:15,magic:30,attack:30,defense:30,protection:10,equip:["Permaice katana","Permaice armour"],addComp:["SnowWalk",a.resistance("ICE","STRONG"),"RegenEffect"]},{name:"Zamoned, Son of Frost",base:"UniqueBase",char:"@",danger:200,enemies:["human"],type:"finalboss",hp:200,pp:100,brain:o,strength:20,accuracy:25,agility:35,willpower:15,perception:25,magic:10,attack:30,defense:30,protection:10,damage:"4d5",equip:["Permaice axe","Permaice armour","Bow of Defense",{name:"Runed arrow",count:100}],addComp:["SnowWalk",a.resistance("ICE","STRONG"),"RegenEffect"]},{name:"Hag of North",type:"wolfclan",base:"UniqueBase",char:"w",danger:100,damage:"4d4+5",hp:75,pp:50,brain:"SpellCaster",spells:["IcyPrison","FrostBolt"],strength:15,accuracy:15,agility:15,willpower:30,perception:25,magic:25,attack:15,defense:15,protection:5,equip:["Ruby glass armour","Ruby glass collar"],addComp:["SnowWalk",a.resistance("ICE","STRONG"),"RegenEffect"]},{name:"Aime Aeon en Nev, Mighty spellsinger",type:"dogfolk",base:"UniqueBase",char:"d",danger:100,damage:"5d5 + 5",hp:100,pp:75,brain:"SpellCaster",spells:["Paralysis","Flying","Heal","LightningArrow"],strength:18,accuracy:19,agility:18,willpower:28,perception:15,magic:25,attack:20,defense:15,protection:5,equip:["Runed armour","Runed collar"],onHit:[{addComp:"Stun",duration:"1d4 + 1"}],addComp:["RegenEffect"]},{name:"Aspelin Primoen, the Blacksmith",type:"dogfolk",base:"UniqueBase",char:"d",danger:75,damage:"3d7 + 3",hp:134,brain:o,strength:25,accuracy:20,agility:19,willpower:15,perception:19,magic:13,attack:25,defense:15,protection:10,equip:["Hammer of Void","Mithril armour"]},{name:"Elene Immolate Kinin, Queen of cats",type:"catfolk",base:"UniqueBase",char:"f",danger:100,damage:"10d3 + 3",hp:123,pp:50,brain:"SpellCaster",spells:["ScorpionsTail","EnergyArrow","SummonKin"],strength:15,accuracy:25,agility:25,willpower:17,perception:25,magic:17,attack:25,defense:15,protection:5,equip:["Steel armour","Runed collar"],addComp:["FirstStrike","RangedEvasion","RegenEffect"]},{name:"Tajun Eon en Lotus, lich lord",type:"undead",base:"UniqueBase",char:"L",danger:85,color:{fg:"Red",bg:"Black"},enemies:r.default.ACTOR_RACES,damage:"2d9 + 4",hp:90,pp:100,maxPP:100,brain:"SpellCaster",strength:14,accuracy:15,agility:14,willpower:25,perception:19,magic:30,attack:25,defense:15,protection:10,equip:["Runed robe"],onHit:[a.meleeHitDamage(4,"2d8 + 2","NECRO")],spells:["SummonDead","FrostBolt","GraspOfWinter"],addComp:["RegenEffect"]},{name:"Zargoth, undead sorcerer",type:"undead",base:"UniqueBase",char:"Z",danger:75,color:{fg:"DarkSalmon",bg:"Black"},enemies:r.default.ACTOR_RACES,damage:"2d9 + 4",hp:100,pp:75,maxPP:75,brain:"SpellCaster",strength:17,accuracy:20,agility:17,willpower:21,perception:19,magic:25,attack:25,defense:15,protection:10,fovrange:7,onHit:[a.meleeHitDamage(2,"1d8 + 2","NECRO")],spells:["SummonUndeadUnicorns","ShadowRay"],addComp:["RegenEffect"]},{name:"Emption Agana Sunkist, Emperor bear",type:"bearfolk",base:"UniqueBase",char:"B",danger:75,damage:"4d7 + 3",hp:123,brain:o,strength:35,accuracy:17,agility:17,willpower:17,perception:17,magic:10,attack:35,defense:35,protection:15,equip:["Mithril armour","Mithril shield"],onHit:[a.meleeHitDamage(8,"1d2","LIGHTNING"),{addComp:"Stun",duration:"1d4 + 1"}]},{name:"Dvaling, dwarven sharpshooter",type:"dwarf",base:"UniqueBase",char:"h",danger:70,damage:"4d7 + 3",hp:123,brain:o,strength:35,accuracy:17,agility:17,willpower:17,perception:30,magic:10,attack:35,defense:35,protection:5,fovrange:9,equip:["Chain armour","Chain helmet","Chain boots","Double crossbow",{name:"Void bolt",count:30}],addComp:["EagleEye","RangedEvasion","StrongShot","RegenEffect"]},{name:"Sierra Lilith Hupoith Zoic, the arcavian",type:"avianfolk",base:"UniqueBase",char:"A",danger:77,damage:"4d7 + 3",hp:123,brain:o,strength:20,accuracy:21,agility:21,willpower:17,perception:23,magic:22,attack:25,defense:25,protection:7,fovrange:7,equip:["Ruby glass armour","Mithril helmet","Mithril shield"],addComp:["Flying","RegenEffect","RangedEvasion"]},{name:"Morkoe, the ancient frost bogey",type:"creature",base:"UniqueBase",char:"B",danger:100,damage:"3d7 + 3",hp:133,pp:78,brain:"SpellCaster",strength:25,accuracy:25,agility:5,willpower:30,perception:10,magic:10,attack:35,defense:35,protection:15,fovrange:5,enemies:r.default.ACTOR_RACES,addComp:["SnowWalk",a.resistance("ICE","IMMUNITY"),a.resistance("NECRO","STRONG"),a.resistance("VOID","STRONG"),"RegenEffect"],onHit:[a.meleeHitDamage(5,"1d8 + 4","ICE")],spells:["FrostBolt","GraspOfWinter"]}],t.Actors={},t.Actors.scaleValue=function(e,t,s){e.forEach(e=>{Number.isInteger(e[t])&&(e[t]=Math.round(s*e[t]))})},t.Actors.addValue=function(e,t,s){e.forEach(e=>{Number.isInteger(e[t])&&(e[t]+=s)})},t.Actors.scale={attack:2,danger:1,hp:1.5},t.Actors.add={attack:4},t.Actors.modToFunc={scale:"scaleValue",add:"addValue"},t.Actors.modOrder=["scale","add"],t.adjustActorValues=(e,s=t.Actors.modOrder)=>{s.forEach(s=>{const n=t.Actors.modToFunc[s];Object.keys(t.Actors[s]).forEach(r=>{t.Actors[n](e,r,t.Actors[s][r])})})},t.BypassComp=i},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RoomGraph=t.Corridor=t.Room=t.Feature=void 0;const r=n(s(14)),a=s(279);class o{}t.Feature=o;class i extends o{constructor(e,t,s,n,r,a){super(),this._x1=e,this._y1=t,this._x2=s,this._y2=n,this._doors={},this._feats={},this._stairs={},void 0!==r&&void 0!==a&&this.addDoor(r,a),this._roomID=i.id++}static createRandomAt(e,t,s,n,a){let o=a.roomWidth[0],i=a.roomWidth[1];const l=r.default.getUniformInt(o,i);o=a.roomHeight[0],i=a.roomHeight[1];const c=r.default.getUniformInt(o,i);if(1===s){const s=t-Math.floor(r.default.getUniform()*c);return new this(e+1,s,e+l,s+c-1,e,t)}if(-1===s){const s=t-Math.floor(r.default.getUniform()*c);return new this(e-l,s,e-1,s+c-1,e,t)}if(1===n){const s=e-Math.floor(r.default.getUniform()*l);return new this(s,t+1,s+l-1,t+c,e,t)}if(-1===n){const s=e-Math.floor(r.default.getUniform()*l);return new this(s,t-c,s+l-1,t-1,e,t)}throw new Error("dx or dy must be 1 or -1")}static createCenter(e,t,s){let n=s.roomWidth[0],a=s.roomWidth[1];const o=r.default.getUniformInt(n,a);n=s.roomHeight[0],a=s.roomHeight[1];const i=r.default.getUniformInt(n,a),l=e-Math.floor(o/2),c=t-Math.floor(i/2);return new this(l,c,l+o-1,c+i-1)}static createRandomCenter(e,t,s){let n=s.roomWidth[0],a=s.roomWidth[1];const o=r.default.getUniformInt(n,a);n=s.roomHeight[0],a=s.roomHeight[1];const i=r.default.getUniformInt(n,a),l=e-Math.floor(r.default.getUniform()*o),c=t-Math.floor(r.default.getUniform()*i);return new this(l,c,l+o-1,c+i-1)}static createRandom(e,t,s){let n=s.roomWidth[0],a=s.roomWidth[1];const o=r.default.getUniformInt(n,a);n=s.roomHeight[0],a=s.roomHeight[1];const i=r.default.getUniformInt(n,a),l=e-o-1,c=t-i-1,u=1+Math.floor(r.default.getUniform()*l),h=1+Math.floor(r.default.getUniform()*c);return new this(u,h,u+o-1,h+i-1)}addDoor(e,t){return this._doors[e+","+t]=1,this}addStairs(e,t,s){return this._stairs[e+","+t]=s,this}hasStairs(e,t){return Object.keys(this._stairs).length>0}hasStairsUp(e,t){const s=Object.values(this._stairs);for(let e=0;e<s.length;e++)if(!1===s[e])return!0;return!1}add(e,t,s){this._feats[t+","+s]||(this._feats[t+","+s]=[]),this._feats[t+","+s].push(e)}getDoors(e){for(const t in this._doors){const s=t.split(",");e(parseInt(s[0]),parseInt(s[1]))}return this}clearDoors(){return this._doors={},this}addDoors(e){const t=this._x1-1,s=this._x2+1,n=this._y1-1,r=this._y2+1;for(let a=t;a<=s;a++)for(let o=n;o<=r;o++)a!=t&&a!=s&&o!=n&&o!=r||e(a,o)||this.addDoor(a,o);return this}debug(){console.log("room",this._x1,this._y1,this._x2,this._y2)}isValid(e,t){const s=this._x1-1,n=this._x2+1,r=this._y1-1,a=this._y2+1;for(let o=s;o<=n;o++)for(let i=r;i<=a;i++)if(o===s||o===n||i===r||i===a){if(!e(o,i))return!1}else if(!t(o,i))return!1;return!0}create(e){const t=this._x1-1,s=this._x2+1,n=this._y1-1,r=this._y2+1;let a=0;for(let o=t;o<=s;o++)for(let i=n;i<=r;i++)a=o+","+i in this._doors?2:o==t||o==s||i==n||i==r?1:0,e(o,i,a)}getCenter(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]}getLeft(){return this._x1}getRight(){return this._x2}getTop(){return this._y1}getBottom(){return this._y2}getWidth(){return this._x2-this._x1}getHeight(){return this._y2-this._y1}getCorners(){return{nw:[this._x1,this._y1],ne:[this._x2,this._y1],sw:[this._x1,this._y2],se:[this._x2,this._y2]}}isTerm(){return 1===Object.keys(this._doors).length}getName(){return"room_"+this._roomID}getID(){return this._roomID}setID(e){this._roomID=e}getBbox(){return{ulx:this._x1,uly:this._y1,lrx:this._x2,lry:this._y2}}getOuterBbox(){return{ulx:this._x1-1,uly:this._y1-1,lrx:this._x2+1,lry:this._y2+1}}getInnerBbox(e=1){const t=this._x1+e,s=this._x2-e;if(t>s)return null;const n=this._y1+e,r=this._y2-e;return n>r?null:{ulx:t,uly:n,lrx:s,lry:r}}getXY(){const e=[],{ulx:t,uly:s,lrx:n,lry:r}=this.getInnerBbox(1);for(let a=t;a<=n;++a)for(let t=s;t<=r;++t)e.push([a,t]);return Object.keys(this._doors).forEach(t=>{const[s,n]=t.split(",");e.push([s,n])}),e}getAreaSize(){return(this._x2-this._x1)*(this._y2-this._y1)}}t.Room=i;class l extends o{constructor(e,t,s,n){super(),this._startX=e,this._startY=t,this._endX=s,this._endY=n,this._endsWithAWall=!0,this._corrID=l.id++}getID(){return this._corrID}getName(){return"corr_"+this._corrID}static createRandomAt(e,t,s,n,a){const o=a.corridorLength[0],i=a.corridorLength[1],l=r.default.getUniformInt(o,i);return new this(e,t,e+s*l,t+n*l)}debug(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)}isValid(e,t){const s=this._startX,n=this._startY;let r=this._endX-s,a=this._endY-n,o=1+Math.max(Math.abs(r),Math.abs(a));r&&(r/=Math.abs(r)),a&&(a/=Math.abs(a));const i=a,l=-r;let c=!0;for(let u=0;u<o;u++){const h=s+u*r,d=n+u*a;if(t(h,d)||(c=!1),e(h+i,d+l)||(c=!1),e(h-i,d-l)||(c=!1),!c){o=u,this._endX=h-r,this._endY=d-a;break}}if(0==o)return!1;if(1==o&&e(this._endX+r,this._endY+a))return!1;const u=!e(this._endX+r+i,this._endY+a+l),h=!e(this._endX+r-i,this._endY+a-l);return this._endsWithAWall=e(this._endX+r,this._endY+a),!u&&!h||!this._endsWithAWall}create(e){const t=this.getXY();for(let s=0;s<t.length;s++){const[n,r]=t[s];e(n,r,0)}return!0}getXY(){const e=[],t=this._startX,s=this._startY;let n=this._endX-t,r=this._endY-s;const a=1+Math.max(Math.abs(n),Math.abs(r));n&&(n/=Math.abs(n)),r&&(r/=Math.abs(r));for(let o=0;o<a;o++){const a=t+o*n,i=s+o*r;e.push([a,i])}return e}createPriorityWalls(e){if(!this._endsWithAWall)return;const t=this._startX,s=this._startY;let n=this._endX-t,r=this._endY-s;n&&(n/=Math.abs(n)),r&&(r/=Math.abs(r));const a=r,o=-n;e(this._endX+n,this._endY+r),e(this._endX+a,this._endY+o),e(this._endX-a,this._endY-o)}}t.Corridor=l,i.id=0,l.id=0;t.RoomGraph=class{constructor(){this.graph=new a.Graph({directed:!1})}addRoom(e){this.graph.setNode(e.getName(),e)}connectRooms(e,t){this.graph.setEdge(e.getName(),t.getName())}isTerm(e){const t=this.graph.nodeEdges(e.getName());return!!t&&1===t.length}}},function(e,t,s){(function(e){var n=s(24),r=s(314),a=t&&!t.nodeType&&t,o=a&&"object"==typeof e&&e&&!e.nodeType&&e,i=o&&o.exports===a?n.Buffer:void 0,l=(i?i.isBuffer:void 0)||r;e.exports=l}).call(this,s(114)(e))},function(e,t,s){(function(e){function s(e){return Object.prototype.toString.call(e)}t.isArray=function(e){return Array.isArray?Array.isArray(e):"[object Array]"===s(e)},t.isBoolean=function(e){return"boolean"==typeof e},t.isNull=function(e){return null===e},t.isNullOrUndefined=function(e){return null==e},t.isNumber=function(e){return"number"==typeof e},t.isString=function(e){return"string"==typeof e},t.isSymbol=function(e){return"symbol"==typeof e},t.isUndefined=function(e){return void 0===e},t.isRegExp=function(e){return"[object RegExp]"===s(e)},t.isObject=function(e){return"object"==typeof e&&null!==e},t.isDate=function(e){return"[object Date]"===s(e)},t.isError=function(e){return"[object Error]"===s(e)||e instanceof Error},t.isFunction=function(e){return"function"==typeof e},t.isPrimitive=function(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e},t.isBuffer=e.isBuffer}).call(this,s(51).Buffer)},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Builder=void 0;const r=n(s(0)),a=s(8),o=s(35),i=s(11),l=s(19);t.Builder=class{static addPathToMap(e,t){const s=[];for(let n=0;n<t.length;n++){const r=t[n];if(e.hasXY(r.x,r.y)){const t=e.getBaseElemXY(r.x,r.y).getType();t.match(/(chasm|water)/)?e.setBaseElemXY(r.x,r.y,a.ELEM.BRIDGE):/stone|highrock/.test(t)?e.setBaseElemXY(r.x,r.y,a.ELEM.PATH):e.setBaseElemXY(r.x,r.y,a.ELEM.ROAD),s.push(r)}}return s}static splitLevel(e,t){const s=[],n=e.getMap().cols/t.nLevelsX,a=e.getMap().rows/t.nLevelsY,c=e.getActors().slice(),u=e.getItems().slice(),h=c.length>0||u.length>0;for(let e=0;e<t.nLevelsX;e++){const e=[];for(let s=0;s<t.nLevelsY;s++){let t=null;if(h)t=(new l.FactoryLevel).createLevel("empty",n,a);else{const e=o.CellMap.createWithoutCells(n,a);t=new i.Level(e)}e.push(t)}s.push(e)}const d=(e,t)=>{const r=Math.floor(e/n),o=Math.floor(t/a);return s[r][o]},f=e=>e%n,g=e=>e%a,p=e.getMap();for(let e=0;e<p.cols;e++)for(let t=0;t<p.rows;t++){const s=d(e,t),n=f(e),r=g(t);h?s.getMap().setBaseElemXY(n,r,p.getBaseElemXY(e,t)):s.getMap().moveCellUnsafe(n,r,p.getCell(e,t))}c.forEach(t=>{const s=t.getX(),n=t.getY();if(e.removeActor(t)){const e=d(s,n),r=f(s),a=g(n);e.addActor(t,r,a)}else r.default.warn("Geometry","splitLevel","removeActor failed on "+JSON.stringify(t))}),u.forEach(t=>{const s=t.getX(),n=t.getY();e.removeItem(t,s,n);const r=d(s,n),a=f(s),o=g(n);r.addItem(t,a,o)});return e.getStairs().length>0&&r.default.warn("Geometry","splitLevel","Function does not move stairs correctly (yet)."),s}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Names=void 0,t.Names={};const r=n(s(0)),a=s(1),o=s(468),i=a.Random.getRNG();t.Names.place={},t.Names.place.generic={branch:["Hand","Foot","Small","Large"],dungeon:["Crypt","Catacombs","Tombs","Dungeon","Cells","Cave","Grotto","Cavern","Lair","Labyrinth","Maze"],mountain:["Summit","Volcano","Tops","Peaks","Bluff","Highlands","Pinnacle","Rise","Needle","Hills","Slopes"],face:["Face","Buttress","Ridge","Shoulder","Crag","Crest","Brink","Cairn","Col","Pass","Crown","Scree","Watershed"],forest:["Grove","Wilds","Woodlands","Timberland","Forest","Covert","Woods","Thicket","Glade"],city:["Town","Village","Fort","City"],lake:["Basin","Cove","Reservoir","Depths","Gorge","Lagoon","Domain","Pond","Expanse","Lake","Shallows","Loch","Falls","Rapids"],quarter:["Market","Bazaar","Plaza","Row","Works","Side","Acre","Garden","Park","Temple","Necropolis","Cemetery","Library","Arcane","Royal","Slum","Living","Arena","Military","Barracks"],area:[]},t.Names.place.prefix={dungeon:["Winding","Dark","Ominous","Tranquil"]},t.Names.place.suffix={dungeon:[]},t.Names.place.unique={city:{first:["Stag","Small","Mud","Ebon","Silk","Spirit","Basin","Shadow","Gold","Silver","Snow","Frost","Ice","Hound","Moon","Dire","Ever","Iron","Ruby","Star","Crystal","Glimmer","Winters","Raven","Pine","Ever","Never","Rune","Glace","Lumen","Confer","Flamen","Jotun","Troll","Winds","Oaken","Willow","Anvil","Ashen","Kosken","Storm"],second:["guard","point","fell","mire","shield","crest","yard","minster","swallow","grasp","cliff","cross","host","barrow","vein","view","home","gard","wall","heim","creek","gasp","mane","thorne","keep"]}},t.Names.place.unique.mountain={first:t.Names.place.unique.city.first,second:t.Names.place.generic.mountain.map(e=>" "+e.toLowerCase())},t.Names.place.unique.dungeon={first:t.Names.place.unique.city.first,second:t.Names.place.generic.dungeon.map(e=>" "+e.toLowerCase())},t.Names.actor={},t.Names.item={steal:{adjective:["emerald","exquisite","golden","silver","bronze","ruby","diamond"],substantive:["ring","amulet","plate","vase","goblet"],char:{ring:"=",amulet:"^",plate:"_",vase:"]",goblet:"]"}},gather:{adjective:[],substantive:[]}},t.Names.getItemToStealName=()=>{const e=t.Names.item.steal,s=i.arrayGetRand(e.adjective),n=i.arrayGetRand(e.substantive);return s.capitalize()+" "+n},t.Names.getItemToGather=()=>{const e=t.Names.item.gather,s=i.arrayGetRand(e.adjective),n=i.arrayGetRand(e.substantive);return s.capitalize()+" "+n},t.Names.getVillageType=()=>i.arrayGetRand(["Village","Hamlet","Town","Township"]),t.Names.alreadyUsed=new Set([""]),t.Names.getUniqueName=e=>{const s=t.Names.place.unique[e];if(s){let e="";for(;t.Names.alreadyUsed.has(e);){e=i.arrayGetRand(s.first)+i.arrayGetRand(s.second)}return e}return r.default.err("name-gen.ts","Names.getUniqueName","No unique names for type "+e),""},t.Names.getSuffix=e=>{const s=t.Names.place.suffix[e];return s?i.arrayGetRand(s):""},t.Names.getPrefix=e=>{const s=t.Names.place.suffix[e];return s?i.arrayGetRand(s):""},t.Names.getGenericPlaceName=e=>{const s=t.Names.place.generic[e];return i.arrayGetRand(s)},t.Names.getActorName=()=>o.ActorNames.getName();const l=["old","ancient","dusty","worn","well-preserved","heavy","light","thick","thin"],c=["rune-covered","worm-ridden","leather","hard-cover","metal-plated","decorated","exquisite","engraved","plain","ordinary","aesthetic","ornamental","skeletal"],u=["tome","book","tract","codex","opus","handbook","volume","treatise","grimoire","rariora","compendium","epitome","manuscript"];t.Names.getBookName=()=>{let e="";for(;t.Names.alreadyUsed.has(e);){let t=i.arrayGetRand(l);t=t.capitalize();e=`${t} ${i.arrayGetRand(c)} ${i.arrayGetRand(u)}`}return e}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryBase=t.Factory=void 0;const i=o(s(0)),l=s(209),c=a(s(27)),u=s(30),h=s(91),d=s(45),f=s(19),g=s(12),p=s(1),m=a(s(7)),y=s(8),_=g.EventPool.getPool(),b=p.Random.getRNG(),v=m.ElementStairs;t.Factory={},t.Factory.cityConfBase=e=>{const t=e||{},s={nShops:1,shopFunc:[e=>e.type===b.arrayGetRand(i.default.SHOP_TYPES)],shopType:"",levelType:"arena"};return Object.assign(s,t)};t.FactoryBase=class{constructor(){this._verif=new c.Conf("FactoryBase"),this._actorFact=new h.FactoryActor,this._itemFact=new d.FactoryItem,this._levelFact=new f.FactoryLevel}createPlayer(e,t){return this._actorFact.createPlayer(e,t)}createActor(e,t={}){return this._actorFact.createActor(e,t)}createBrain(e,t){return this._actorFact.createBrain(e,t)}createSpell(e){return this._actorFact.createSpell(e)}createElement(e){if(y.ELEM_MAP.elemTypeToObj[e])return y.ELEM_MAP.elemTypeToObj[e];switch(e){case"door":return new m.ElementDoor(!0);case"opendoor":return new m.ElementDoor(!1);case"stairsUp":case"stairsDown":return new v(e);default:return null}}createFloorCell(e,t){return new l.Cell(e,t,new m.ElementBase("floor"))}createWallCell(e,t){return new l.Cell(e,t,new m.ElementWall("wall"))}createLevel(e,t,s,n){return this._levelFact.createLevel(e,t,s,n)}addNRandItems(e,t,s){return this._verif.verifyConf("addNRandItems",s,["item","maxValue"]),this._itemFact.addNRandItems(e,s)}addNRandActors(e,t,s){this._verif.verifyConf("addNRandActors",s,["maxDanger","actorsPerLevel"]);const n=s.maxDanger,r=this.generateNActors(s.actorsPerLevel,s.actor,n);return r?(u.Placer.addPropsToFreeCells(e,r),r.length):0}setParser(e){this._parser=e}generateNActors(e,t,s){return this._actorFact.generateNActors(e,t,s)}addRandomGold(e,t,s){this._itemFact.addRandomGold(e,t,s)}createHumanArmy(e,t){for(let s=0;s<2;s++){for(let n=0;n<20;n++){const r=t.createActor("fighter");e.addActor(r,n+1,4+s)}const n=t.createActor("warlord");e.addActor(n,10,s+7)}}createDemonArmy(e,t){for(let s=0;s<2;s++)for(let n=0;n<10;n++){const r=t.createActor("Winter demon");e.addActor(r,n+10,14+s),_.emitEvent(i.default.EVT_ACTOR_CREATED,{actor:r,level:e,msg:"DemonSpawn"})}}createBeastArmy(e,t){const s=e.getMap().cols/2,n=e.getMap().rows/2;for(let r=n;r<n+2;r++)for(let n=s;n<s+10;n++){const s=t.createActor("Blizzard beast"),a=n+10,o=r+14;e.getMap().hasXY(a,o)?(e.addActor(s,a,o),_.emitEvent(i.default.EVT_ACTOR_CREATED,{actor:s,level:e,msg:"DemonSpawn"})):i.default.warn("FactoryBase","createBeastArmy",`Cannot put beast to ${a}, ${o}.`)}}addActorsToBbox(e,t,s){const n=s.nActors||4,{maxDanger:r,func:a}=s,o=this.generateNActors(n,a,r);u.Placer.addActorsToBbox(e,t,o)}addItemsToBbox(e,t,s){const n=s.nItems||4,r=Object.assign({itemsPerLevel:n},s),a=(new d.FactoryItem).generateItems(r),o=e.getMap().getFreeInBbox(t);u.Placer.addPropsToCells(e,o,a)}}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryWorld=void 0;const i=o(s(0)),l=s(481),c=s(72),u=s(38),h=s(5),d=h("bitn:Factory.World"),f=h("bitn:Factory.World-verb"),g=a(s(27)),p=s(221),m=a(s(32)),y=s(64),_=s(220),b=s(19),v=s(91),E=s(6),S=s(71),w=s(21),C=s(137),T=s(487),O=a(s(7)).ElementStairs,A=["City","Mountain","Dungeon","BattleZone"],M={tile:{Small:{x:40,y:20},Medium:{x:60,y:30},Large:{x:80,y:40},Huge:{x:140,y:60}},mountain:{Small:{x:40,y:20},Medium:{x:60,y:30},Large:{x:80,y:40},Huge:{x:140,y:60}},dungeon:{Small:{x:40,y:20},Medium:{x:60,y:30},Large:{x:80,y:40},Huge:{x:140,y:60}},city:{Small:{x:40,y:20},Medium:{x:60,y:30},Large:{x:80,y:40},Huge:{x:140,y:60}}};function N(e,t,s){if("Iron hills"===e.name){i.default.diag(s+" Creating iron hills connection now");const e=t.getConnections().filter(e=>"mountain"===e.getName());if(i.default.diag("\t## Ex. conns: "+JSON.stringify(e)),e.length>0){const t=e[0].getTargetLevel();i.default.diag("\t## Parent: "+t.getParent().getName())}}}t.FactoryWorld=class{constructor(){this._verif=new g.Conf("FactoryWorld"),this.factZone=new _.FactoryZone,this.createAllZones=!0,this.worldElemByID={},this.presetLevels={},this._conf=new p.ConfStack,this.id2level={},this.id2levelSet=!1,this.id2entity={},this.fromJSON=null,this.overworld=null}setRNG(e){this.factZone.setRNG(e)}setPresetLevels(e){this.presetLevels=e,this.debug("PresetLevels were set.")}setId2Level(e){0===Object.keys(e).length&&i.default.warn("FactoryWorld","setId2Level","There are no levels/keys present in id2level map. Bug?"),this.id2level=e,this.id2levelSet=!0,this.debug("Id2Level was set OK.")}pushScope(e){e?this._conf.pushScope(e):i.default.err("FactoryWorld","pushScope","Null/undef conf given")}popScope(e){this._conf.popScope(e)}setGlobalConf(e={}){const t=e.levelSize||"Medium",s=e.sqrPerActor||i.default.ACTOR_MEDIUM_SQR,n={levelSize:t,dungeonX:M.dungeon[t].x,dungeonY:M.dungeon[t].y,sqrPerActor:s,sqrPerItem:e.sqrPerItem||i.default.LOOT_MEDIUM_SQR,set:!0};this._conf.setGlobalConf(n),this.debug("globalConf set to "+JSON.stringify(n))}getGlobalConf(){return this._conf.getGlobalConf()}getConf(e){return this._conf.getConf(e)}setOverWorld(e){this.overworld=e}getHierName(){return this._conf.getScope().join(".")}createWorld(e){this._verif.verifyConf("createWorld",e,["name","nAreas"]),this.getGlobalConf().set||this.setGlobalConf({}),e.hasOwnProperty("createAllZones")&&(this.createAllZones=e.createAllZones,this.debug("createAllZones set to "+this.createAllZones)),this.pushScope(e);const t=new m.WorldTop(e.name);t.setConf(e);for(let s=0;s<e.nAreas;s++){const n=e.area[s],r=this.createArea(n);n.zonesCreated&&this.restoreCreatedZones(t,r,n),t.addArea(r),this.addWorldID(n,r)}return this.popScope(e),this.addWorldID(e,t),t}createArea(e){this._verif.verifyConf("createArea",e,["name","maxX","maxY"]),this.pushScope(e);const t=this.getHierName();let s=null;this.id2levelSet?s=this.getAreaLevels(e):(s=this.getPresetLevels(t,e),s&&0!==s.length||(s=null));const n=new m.Area(e.name,e.maxX,e.maxY,e.cols,e.rows,s);return n.setConf(e),n.setHierName(this.getHierName()),this.createAllZones?(this._createAllZones(n,e),n.markAllZonesCreated()):this.debug("Skipping the zone creating due to createZones=false"),this.popScope(e),n}restoreCreatedZones(e,t,s){Object.keys(s.zonesCreated).forEach(n=>{const[r,a]=n.split(","),[o,i]=[parseInt(r,10),parseInt(a,10)];s.zonesCreated[n]&&(this.debug(`\tRestoring created zones for tile ${o},${i}`),this.createZonesForTile(e,t,o,i))})}createZonesForTile(e,t,s,n){if(t.tileHasZonesCreated(s,n))this.debug(`Area ${s},${n} zones already created`);else{this.debug(`Creating Area ${s},${n} zones (not created yet)`);const r=e.getConf();this.pushScope(r);const a=t.getConf();this.pushScope(a),this.populateAreaLevel(t,s,n),this._createAllZones(t,a,s,n),t.markTileZonesCreated(s,n),this.createQuests(e,t,s,n),this.popScope(a),this.popScope(r)}}populateAreaLevel(e,t,s){const n=Math.floor(e.getSizeX()/2),r=e.getSizeY()-1,a=E.ObjectShell.getParser();e.isLoaded(t,s)||i.default.err("FactoryWorld","populateAreaLevel",`Cannot populate unloaded Tile ${t},${s}`);const o=e.getTileXY(t,s).getLevel(),l=Math.abs(n-t),c=r-s,u=7+l+2*c,h=10*(c+1)+2*l+10,d=new y.FactoryBase;d.setParser(a);const f=i.default.getMaxValue(l,c),g=i.default.getMaxDanger(l,c),p={itemsPerLevel:u,item:e=>e.value<=f&&"food"!==e.type,actor:e=>e.danger<=g,gold:()=>!1,food:()=>!1,maxValue:f,actorsPerLevel:h,maxDanger:g};this.setAreaLevelConstraints(p,t,s),p.item=p.item,d.addNRandItems(o,a,p),p.actor=p.actor,d.addNRandActors(o,a,p),this.addActorSpawner(o,a,p)}_createAllZones(e,t,s=-1,n=-1){if(this.debug(`_createAllZones ${s}, ${n}`),t.tiles)if(s<0||n<0)this.createZonesFromArea(e,t,s,n);else{const r=t.tiles[s][n];this.createZonesFromTile(e,r,s,n)}else this.createZonesFromArea(e,t,s,n)}createZonesFromArea(e,t,s=-1,n=-1){this.debug(`createZonesFromArea ${s}, ${n}`),A.forEach(r=>{const a=r.toLowerCase(),o="create"+r;let i=0;Array.isArray(t[a])&&(i=t[a].length),this.debug(`\tnZones (${r}) is now ${i}`);for(let l=0;l<i;l++){const i=t[a][l],{x:c,y:u}=i;if(!(-1!==s&&s!==c||-1!==n&&n!==u)){const t=this[o](i);t.setTileXY(c,u),e.addZone(r,t),this.addWorldID(i,t),this.id2levelSet||this.createAreaZoneConnection(e,t,i),this.addZoneComps(t,i)}}})}createZonesFromTile(e,t,s,n){A.forEach(r=>{const a=r.toLowerCase(),o="create"+r;let i=0;Array.isArray(t[a])&&(i=t[a].length),this.debug(`\t[${s}][${n}]: nZones (${r}) is now ${i}`);for(let l=0;l<i;l++){const i=t[a][l],{x:c,y:u}=i;if(!(-1!==s&&s!==c||-1!==n&&n!==u)){const t=this[o](i);t.setTileXY(c,u),e.addZone(r,t),this.addWorldID(i,t),this.id2levelSet||this.createAreaZoneConnection(e,t,i),this.addZoneComps(t,i)}}})}getAreaLevels(e){const t=[];return e.tiles?e.tiles.forEach(e=>{const s=[];e.forEach(e=>{const t=this.id2level[e.level];t?s.push(t):i.default.err("FactoryWorld","getAreaLevels",`No level ID ${e.level} in id2level`)}),t.push(s)}):i.default.err("FactoryWorld","getAreaLevels","conf.tiles null/undefined, but id2levelSet true"),t}createDungeon(e){this._verif.verifyConf("createDungeon",e,["name","nBranches"]),this.pushScope(e);const t=new m.Dungeon(e.name);if(t.setHierName(this.getHierName()),e.nBranches!==e.branch.length){const t=e.branch.length;i.default.err("Factory.World","createDungeon",`Branch number mismatch [] = ${t}, n: ${e.nBranches}`)}for(let s=0;s<e.nBranches;s++){const n=e.branch[s],r=this.createBranch(n);t.addBranch(r),this.addWorldID(n,r)}return e.entrance&&t.setEntrance(e.entrance),this.id2levelSet||e.nBranches>1&&(e.connectLevels?e.connectLevels.forEach(e=>{4===e.length?t.connectSubZones(...e):i.default.err("Factory.World","createDungeon","Each connection.length must be 4.")}):i.default.err("Factory.World","createDungeon","nBranches > 1, but no conf.connectLevels.")),this.popScope(e),t}createBranch(e){this._verif.verifyConf("createBranch",e,["name","nLevels"]),this.pushScope(e);const t=new m.Branch(e.name),s=this.getHierName();t.setHierName(s);const n=this.getPresetLevels(s,e);for(let s=0;s<e.nLevels;s++){const r=this.getConf("maxDanger"),a=this.getConf("maxValue"),o={x:this.getConf("dungeonX"),y:this.getConf("dungeonY"),sqrPerActor:this.getConf("sqrPerActor"),sqrPerItem:this.getConf("sqrPerItem"),maxValue:a?a+20*s:20*(s+1),maxDanger:r?r+s:2+s,nLevel:s},i=this.getConf("dungeonType");i&&(o.dungeonType=i),this.setLevelConstraints(o);let l=this.getFromPresetLevels(s,n);if(l)e.createPresetLevels&&e.create&&this.addFixedFeatures(s,l,t);else if(e.levels)l=this.id2level[e.levels[s]];else{const[n,r]=[o.x,o.y];if(o.markersPreserved=!1,/(crypt)/i.test(i)){l=(new w.CryptGenerator).create(n,r,o),this.factZone.addItemsAndActors(l,o),this.factZone.addExtraDungeonFeatures(l,o)}else if(/cave/.test(i)){l=(new w.CaveGenerator).create(n,r,o),this.factZone.addItemsAndActors(l,o),this.factZone.addExtraDungeonFeatures(l,o)}else if(/(fort|castle)/.test(i)){l=(new w.CastleGenerator).create(n,r,o)}else{const e=new w.DungeonGenerator,t=o;t.wallType="walldungeon",t.floorType="floordungeon",l=e.create(n,r,t)}this.addFixedFeatures(s,l,t);const a=new T.DungeonFeatures("dungeon");s===e.nLevels-1&&a.addLastLevelFeatures(s,l,o)}t.addLevel(l)}return this.id2levelSet?e.hasOwnProperty("entrance")&&t.setEntranceLocation(e.entrance):(t.connectLevels(),e.hasOwnProperty("entranceLevel")&&t.addEntrance(e.entranceLevel)),this.popScope(e),t}getFromPresetLevels(e,t){let s=null;if(t.length>0){const n=t.find(t=>t.nLevel===e);n&&(s=n.level)}return s}_errorOnFunc(e){"function"==typeof e&&i.default.err("Factory","_errorOnFunc","Function constraint not supported anymore: "+e.toString())}setLevelConstraints(e){const t=this.getConf("constraint"),s=new u.Constraints;if(t){const n=this.getHierName();if(t.actor){this._errorOnFunc(t.actor),e.actor=s.getConstraints(t.actor);const r=JSON.stringify(t.actor);this.debug(`Found actor constraint for ${n}: ${r}`)}if(t.item){this._errorOnFunc(t.item),e.item=s.getConstraints(t.item);const r=JSON.stringify(t.item);this.debug(`Found item constraint for ${n}: ${r}`)}if(t.food){this._errorOnFunc(t.food),e.food=s.getConstraints(t.food);const r=JSON.stringify(t.food);this.debug(`Found food constraint for ${n}: ${r}`)}if(t.gold){this._errorOnFunc(t.gold),e.gold=s.getConstraints(t.gold);const r=JSON.stringify(t.gold);this.debug(`Found gold constraint for ${n}: ${r}`)}if(t.shop){const r=[];t.shop.forEach(e=>{r.push(s.getConstraints(e))}),e.shopFunc=r;const a=JSON.stringify(t.shop);this.debug(`Found shop constraint for ${n}: ${a}`)}if(t.disposition){t.disposition;e.disposition=t.disposition}if(t.cellsAround){const{cellsAround:s}=t;e.cellsAround=s}}const n=this.getConf("groupType"),r=this.getConf("cityType"),a=this.getConf("quarterType"),o=this.getConf("alignment"),i=this.getConf("wallType"),l=this.getConf("floorType"),c=this.getConf("friendly");n&&(e.groupType=n),r&&(e.cityType=r),a&&(e.cityType=a),o&&(e.alignment=o),i&&(e.wallType=i),l&&(e.floorType=l),c&&(e.friendly=!0)}_verifyConstraintKeys(e){const t=new Set(["actor","item","food","gold","shop","disposition"]);Object.keys(e).forEach(s=>{if(!t.has(s)){const t=JSON.stringify(e);i.default.err("Factory.World","_verifyConstraintKeys",`Unsupported key ${s} in ${t}`)}})}setAreaLevelConstraints(e,t,s){const n=t+","+s,r=this.getConf("constraint");if(r&&r.hasOwnProperty(n)){const t={name:"AreaLevel["+n+"]",constraint:r[n]};this.pushScope(t),this.setLevelConstraints(e),this.popScope(t)}}addFixedFeatures(e,t,s){const n=this.getConf("create");if(n&&n.actor){n.actor.forEach(n=>{if(n.nLevel===e){const e=n.name;let r=1;n.num&&(r=n.num);for(let a=0;a<r;a++)n.hasOwnProperty("target")&&(s.getName(),n.target),this.factZone.addActorToLevel(e,t)}})}if(n&&n.stairs){n.stairs.forEach(s=>{if(s.nLevel===e){const{x:e,y:n,isDown:r}=s,a=new O(r?"stairsDown":"stairsUp",t);t.addStairs(a,e,n)}})}}getPresetLevels(e,t){const s=this.getConf("presetLevels");if(s){const t=Object.keys(s).find(t=>new RegExp(t+"$").test(e));if(t)return s[t]}const n=Object.keys(this.presetLevels).find(t=>new RegExp(t+"$").test(e));if(n)return this.presetLevels[n];if(t&&t.createPresetLevels){const{createPresetLevels:e}=t,s=new l.LevelFactory(new b.FactoryLevel).create(e.new,e.args);if(!s){let e="Found createPresetLevels but no levels created";e+=" conf: "+JSON.stringify(t),i.default.err("Factory","getPresetLevels",e)}return s}return[]}createMountain(e){this._verif.verifyConf("createMountain",e,["name","nFaces","face"]),this.pushScope(e);const t=new m.Mountain(e.name);if(t.setHierName(this.getHierName()),e.nFaces!==e.face.length){const t=e.face.length;i.default.err("Factory.World","createMountain",`Face number mismatch [] = ${t}, n: ${e.nFaces}`)}for(let s=0;s<e.nFaces;s++){const n=e.face[s],r=this.createMountainFace(n);t.addSubZone(r),this.addWorldID(n,r)}for(let s=0;s<e.nSummits;s++){const n=e.summit[s],r=this.createSummit(n);t.addSubZone(r),this.addWorldID(n,r)}return this.id2levelSet||(e.nFaces>1||1===e.nFaces&&e.nSummits>0)&&(e.connectLevels&&e.connectLevels.length>0?e.connectLevels.forEach(e=>{4===e.length?t.connectSubZones(...e):i.default.err("Factory.World","createMountain","Each connection.length must be 4.")}):i.default.err("Factory.World","createMountain","nFaces > 1, but no conf.connectLevels.")),this.popScope(e),t}createMountainFace(e){this.id2levelSet?this._verif.verifyConf("createMountainFace",e,["name","nLevels"]):this._verif.verifyConf("createMountainFace",e,["name","nLevels","x","y"]);const t=e.name;this.pushScope(e);const s=new m.MountainFace(t),n={x:e.x,y:e.y,maxValue:100,maxDanger:4};this.setLevelConstraints(n);for(let t=0;t<e.nLevels;t++){let r=null;if(this.id2levelSet){const s=e.levels[t];r=this.id2level[s]}else r=this.factZone.createMountainLevel(n);s.addLevel(r)}return this._addEntranceToSubZone(s,e),this.popScope(e),s}createSummit(e){this._verif.verifyConf("createSummit",e,["name","nLevels"]),this.pushScope(e);const t=new m.MountainSummit(e.name),s=Object.assign({},e);this.setLevelConstraints(s),this.addMaxDangerIfMissing(s);for(let n=0;n<e.nLevels;n++){let r=null;if(this.id2levelSet){const t=e.levels[n];r=this.id2level[t]}else{s.maxDanger||(s.maxDanger=4),r=this.factZone.createSummitLevel(s);const t=new T.DungeonFeatures("mountain");n===e.nLevels-1&&t.addLastLevelFeatures(n,r,s)}t.addLevel(r)}return this._addEntranceToSubZone(t,e),this.popScope(e),t}addMaxDangerIfMissing(e){if(Number.isInteger(e.maxDanger)||(e.maxDanger=this.getConf("maxDanger")),!Number.isInteger(e.maxValue)){const t=this.getConf("maxValue");t&&(e.maxValue=t)}}_addEntranceToSubZone(e,t){t.hasOwnProperty("entranceLevel")?e.addEntrance(t.entranceLevel):t.hasOwnProperty("entrance")&&e.setEntranceLocation(t.entrance)}createCity(e){this._verif.verifyConf("createCity",e,["name","nQuarters"]),this.pushScope(e),f("createCity",e.name,"addComp is ",e.addComp);const t=new m.City(e.name);if(t.setHierName(this.getHierName()),e.nQuarters!==e.quarter.length){const t=e.quarter.length;i.default.err("Factory.World","createCity",`Quarter number mismatch [] = ${t}, n: ${e.nQuarters}`)}for(let s=0;s<e.nQuarters;s++){const n=e.quarter[s],r=this.createCityQuarter(n);t.addSubZone(r),this.addWorldID(n,r)}if(!this.id2levelSet&&e.nQuarters>1)if(e.connectLevels)e.connectLevels.forEach(e=>{4===e.length?t.abutQuarters(...e):i.default.err("Factory.World","createCity","Each connection.length must be 4.")});else{let t="nQuarters > 1, but no conf.connectLevels.";t+="cityConf: "+JSON.stringify(e),i.default.err("Factory.World","createCity",t)}return this.popScope(e),t}createCityQuarter(e){this._verif.verifyConf("createCityQuarter",e,["name","nLevels"]),this.pushScope(e);const t=new m.CityQuarter(e.name),s=this.getHierName();t.setHierName(s);const n=this.getPresetLevels(s,e),r={x:e.x||80,y:e.y||40,nShops:e.nShops||1,shopFunc:e.shop||[t=>t.value<=50+50*e.nLevels]};0===e.nShops&&(r.nShops=0),this.setLevelConstraints(r);for(let a=0;a<e.nLevels;a++){let o=this.getFromPresetLevels(a,n);if(o)if(o.stub){const e=o,t=new l.LevelFactory(new b.FactoryLevel).create(e.new,e.args);t&&(o=t[0].level,o||i.default.err("Factory","createCityQuarter","Stub found but cannot create level")),d.enabled&&this.debug("Creating level from stub "+JSON.stringify(e.stub))}else e.createPresetLevels&&e.create?this.addFixedFeatures(a,o,t):this.debug(`cityQuarter ${s} ${a} from preset level`);else if(this.id2levelSet){const t=e.levels[a];o=this.id2level[t]}else o=this.factZone.createCityLevel(a,r),this.addFixedFeatures(a,o,t);if(o=o,!this.id2levelSet&&o.hasExtras()){const e=o.getExtras();Array.isArray(e.shops)&&e.shops.forEach(e=>{t.addShop(e)})}t.addLevel(o)}return this.id2levelSet||t.connectLevels(),this._addEntranceToSubZone(t,e),e.hasOwnProperty("shops")&&e.shops.forEach(e=>{const s=new m.WorldShop;if(s.setLevel(this.id2level[e.level]),s.setCoord(e.coord),s._isAbandoned=e.isAbandoned,!e.isAbandoned){const t=this.id2entity[e.shopkeeper];if(t)s.setShopkeeper(t);else{const t=e.shopkeeper,s="Possible IDs: "+Object.keys(this.id2entity);i.default.err("Factory","createCityQuarter",`Cannot find shopkeeper ID ${t}. ${s}`)}}t.addShop(s)}),this.popScope(e),t}createBattleZone(e){this.pushScope(e);const t=new m.BattleZone(e.name);this.id2levelSet||i.default.err("Factory","createBattleZone","Can create BattleZones only during restore");for(let s=0;s<e.nLevels;s++){const n=e.levels[s],r=this.id2level[n];r?t.addLevel(r):i.default.err("Factory","createBattleZone",`Cannot find level ID ${n} for BattleZone`)}return this.popScope(e),t}getConnectionName(e,t,s){let n="";if("city"===t)n="town",e.groupType&&"fort"===e.groupType&&(n="cityfort");else if("mountain"===t)n="mountain";else if(Array.isArray(s)){n=!s[0].isDown()?"stairsDown":"stairsUp"}else{n=!s.isDown()?"stairsDown":"stairsUp"}return n}getTileStairsXY(e,t){let[s,n]=[t.levelX,t.levelY];if(i.default.isNullOrUndef([s,n])){const t=e.getEmptyRandCell();t&&(s=t.getX(),n=t.getY())}let r=e.getMap().getCell(s,n),a=i.default.WATCHDOG;for(;r.hasConnection();){const t=e.getEmptyRandCell();if(t&&(s=t.getX(),n=t.getY()),r=e.getMap().getCell(s,n),--a<=0)break}return[s,n]}getEntryStairs(e,t,s){if(s.length>0){const n=t.getX(),r=t.getY();return e.getElements().indexOf(t)>=0&&(e.removeElement(t,n,r)||i.default.err("Factory.World","getEntryStairs","Cannot remove entryStairs")),s}return t}processConnObject(e,t,s){const n=e.nLevel,r=e.levelX,a=e.levelY,o=e.name;this.debug(`Processing connection obj ${o}: ${r},${a}`);const l=t.findLevel(o,n);if(l){let n=e.stairs||null;if(n&&!i.default.isNullOrUndef([n.getStairs])){const e=n.getStairs;if(n=l.getStairs()[e],n)this.debug("conn found via getStairs connObject");else{let t="zoneStairs null, index: "+e;t+="\tPoss: "+JSON.stringify(l.getStairs()),i.default.err("Factory.World","processConnObject",t)}}if(n){if("function"!=typeof n.getSrcLevel){const e=JSON.stringify(n);i.default.err("Factory.World","processConnObject","zoneStairs not a proper stairs object "+e)}}else n=this.createNewZoneConnects(t,l);let o="stairsDown";"city"===t.getType()?o="town":"mountain"===t.getType()&&(o="mountain");const c=new O(o,s,l);s.addStairs(c,r,a);try{c.connect(n)}catch(e){console.error(e);let t="zoneLevel: "+JSON.stringify(l,null,1);t+="\n\tzoneStairs: "+JSON.stringify(n),i.default.err("Factory.World","createAreaZoneConnection",t)}}else{let s="connectToAreaXY: "+JSON.stringify(e);s+="zone: "+JSON.stringify(t),i.default.err("Factory.World","createAreaZoneConnection","No level found. "+s)}}createNewZoneConnects(e,t){let s=null;return"dungeon"===e.getType()?s=this.createDungeonZoneConnect(e,t):"city"===e.getType()?s=this.createCityZoneConnect(e,t):"mountain"===e.getType()&&(this.debug("Creating new mountain south connection"),s=m.addExitsToEdge(t,"passage","south",!0)),s}createDungeonZoneConnect(e,t){this.debug("Creating dungeon connection");let s=0,n=0;if(t.hasExtras()){const r=t.getExtras();if(r.startPoint)[s,n]=r.startPoint;else if(r.connectEdges)return this.createCityZoneConnect(e,t)}else{const e=t.getFreeRandCell();[s,n]=e.getXY()}const r=new O("stairsUp",t);return t.addStairs(r,s,n),r}createCityZoneConnect(e,t){let s=null;this.debug("Creating new city edge connection");let n=[];if(i.default.CARDINAL_DIR.forEach(e=>{if(!m.edgeHasConnections(t,e)){const s=m.addExitsToEdge(t,"passage",e);s.length>0&&(n=n.concat(s))}}),s=n,0===s.length){const e=t.getFreeRandCell(),n=e.getX(),r=e.getY();s=new O("stairsUp",t),t.addStairs(s,n,r),s=[s],this.debug("City edge connection failed. Added stairs")}return s}debugPrintCityConns(e,t){if(d.enabled&&"city"===e){const e=t.getConnections();let s=JSON.stringify(e[0],null,1);e.length>1&&(s+=JSON.stringify(e[e.length-1],null,1)),this.debug("First/last conn: "+s),this.debug("conn length after: "+e.length)}}addWorldID(e,t){i.default.isNullOrUndef([e.id])||t.setID(e.id),this.worldElemByID[t.getID()]=t}createQuests(e,t,s,n){(new C.QuestPopulate).createQuests(e,t,s,n)}createAreaZoneConnection(e,t,s){this._verif.verifyConf("createAreaZoneConnection",s,["x","y"]),this.debug("Creating area-zone connections");const{x:n,y:r}=s,a=e.getTileXY(n,r).getLevel();N(s,a," CALL 1"),"function"!=typeof t.getEntrances&&i.default.err("Factory.World","createAreaZoneConnection","No getEntrances method for zone.");const o=t.getEntrances();if(o.length>0){const e=o[0];let n=e;const r=e.getSrcLevel(),l=t.getType();this.debug("Connecting area-zone by entrance");let c=null;if(l.match(/(city|mountain)/)||s.connectEdges){d.enabled&&(c=r.getConnections(),this.debug("conn length before: "+c.length));const s=this.createNewZoneConnects(t,r);n=this.getEntryStairs(r,e,s)}const u=this.getConnectionName(s,l,n);N(s,a," CALL 2");const h=new O(u,a,r),[f,g]=this.getTileStairsXY(a,s);try{a.addStairs(h,f,g),h.connect(n)}catch(e){throw i.default.log("Given conf: "+JSON.stringify(s)),e}this.debugPrintCityConns(l,r)}else if(!s.hasOwnProperty("connectToAreaXY")){const e=`No entrances in ${t.getHierName()}.`;i.default.err("Factory.World","createAreaZoneConnection",e+". Cannot connect to tile.")}if(s.hasOwnProperty("connectToAreaXY")){s.connectToAreaXY.forEach(e=>{this.processConnObject(e,t,a)})}}addActorSpawner(e,t,s){const n=s.maxDanger+1,r=[{op:"eq",prop:"type",value:c.ActorGen.getRaces()}],a=[{op:"eq",func:"getX",value:[0,e.getMap().cols-1]},{op:"eq",func:"getY",value:[0,e.getMap().rows-1]}],o=(new v.FactoryActor).createActorSpawner(n,r,a);e.addVirtualProp(i.default.TYPE_ACTOR,o)}addZoneComps(e,t){if(f("addZoneComps called with ",t.name),t.addComp){(new S.ObjectShellComps).addComponents(t,e),f("addZoneComps added comps to",t.name,",",t.addComp)}else t.components&&(this.fromJSON?(f.enabled&&(f("addZoneComps restoring comps for",t.name),f("Comps are",t.components)),this.fromJSON.addCompsToEntity(e,t.components)):i.default.err("FactoryWorld","addZoneComps","Failed to restore zone comps: fromJSON not set"))}debug(e){if(d.enabled){let t=this.getHierName();t||(t="EMPTY"),d(`|${t}| ${e}`)}}}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemQuest=void 0;const i=o(s(0)),l=s(6),c=s(3),u=a(s(2)),h=s(96),d=l.ObjectShell.getParser();class f extends c.SystemBase{constructor(e,t){super(i.default.SYS.QUEST,e,t),this.compTypesAny=!0,this._eventTable={battle:this.onBattleEvent=this.onBattleEvent.bind(this),damage:this.onDamageEvent=this.onDamageEvent.bind(this),escort:this.onEscortEvent=this.onEscortEvent.bind(this),get:this.onGetEvent=this.onGetEvent.bind(this),give:this.onGiveEvent=this.onGiveEvent.bind(this),goto:this.onGotoEvent=this.onGotoEvent.bind(this),kill:this.onKillEvent=this.onKillEvent.bind(this),listen:this.onListenEvent=this.onListenEvent.bind(this),read:this.onReadEvent=this.onReadEvent.bind(this),report:this.onReportEvent=this.onReportEvent.bind(this)}}static addQuestEvent(e,t,s,n={}){const r=new u.QuestTargetEvent;r.setArgs(n),r.setEventType(s),r.setTargetComp(t),e.add(r)}updateEntity(e){if(e.has("GiveQuest")){const t=e.get("GiveQuest");this.processGiveQuestComp(e,t),e.remove(t)}if(e.has("QuestCompleted")){const t=e.get("QuestCompleted");this.processComplComp(e,t),e.remove(t)}if(e.has("QuestTargetEvent")){const t=e.get("QuestTargetEvent");this.processQuestEvent(e,t),e.remove(t)}}processGiveQuestComp(e,t){const s=t.getGiver(),n=s.get("QuestGiver");if(n.getHasGivenQuest())return;const r=n.getQuestTargets(),a=new u.Quest;a.setQuestID(n.getQuestID()),0===r.length&&i.default.err("SystemQuest","processGiveQuestComp","No keys in questData, giver: "+s.getName),r.forEach(e=>{const t=Object.assign({},e);t.isCompleted=!1,a.addTarget(t)}),n.giveQuest(e),a.setGiver({name:s.getName(),id:s.getID()}),a.setDescr(n.getDescr()),e.add(a),this.checkQuestMsgEmits(e,a)}checkQuestMsgEmits(e,t){const s=e.getLevel(),n=t.first("location");let r=`You accept the quest from ${t.getGiver().name}.`;n&&(s.getID()===n.id?(r+=" You are already in the first quest location",this.setTargetCompleted(n,t)):r+=" You should try to get to the first quest location"),g({cell:e.getCell(),msg:r})}processComplComp(e,t){const s=t.getGiver(),n=s.get("QuestGiver").getQuestID();if(e.getList("Quest").find(e=>e.getQuestID()===n).isCompleted()){const t=s.get("QuestGiver"),n=t.getQuestTargets().length,r=t.getDanger()*n,a=new u.ExpPoints(r);e.add(a),this.giveQuestReward(e,s,t),h.emitZoneEvent(s.getLevel(),i.default.ZONE_EVT.QUEST_COMPLETED,{questGiver:s})}else i.default.gameDanger({cell:e.getCell(),msg:"Quest is not completed!"})}giveQuestReward(e,t,s){if(s.hasReward())if(s.getHasGivenReward()){const t="Reward has already been given!";g({cell:e.getCell(),msg:t})}else{s.setHasGivenReward(!0);const n=s.getReward();let r=null;if("item"===n.type){const t=n.name;if(r=d.createItem(t),r){let t=`${e.getName()} receives ${r.getName()} as`;t+=" a reward for completing the quest",g({cell:e.getCell(),msg:t})}}else"generate"===n.type&&(r=this.generateQuestRewardItem(e,s,t));r&&e.getInvEq().getInventory().addItem(r)}}generateQuestRewardItem(e,t,s){const n=e.getInvEq().getEquipment().getFreeSlotTypes(),[r,a]=function(e){switch(e){case 1:return[75,150];case 2:return[90,190];case 3:return[100,220];case 4:return[120,250];default:return[120+30*(e-4),250+30*(e-4)]}}(t.numTargets()),o=e=>e.value>=r&&e.value<=a;if(n.length>0){const e=this.rng.arrayGetRand(n);let t=t=>t.armourType===e&&o(t),s=d.createRandomItem({func:t});if(s)return console.log("generateQuestRewardItem Returning item ",s.getName()),s;if("hand"===e?t=e=>o(e)&&"weapon"===e.type:"spiritgem"===e?t=e=>o(e)&&"spiritgem"===e.type:"missile"===e?t=e=>o(e)&&("missile"===e.type||"ammo"===e.type):"missileweapon"===e&&(t=e=>o(e)&&"missileweapon"===e.type),s=d.createRandomItem({func:t}),s)return console.log("generateQuestRewardItem Returning item ",s.getName()),s}else{const e=e=>o(e)&&("rune"===e.type||"potion"===e.type),t=d.createRandomItem({func:e});if(t)return t}return null}processQuestEvent(e,t){const s=t.getEventType(),n=e.getList("Quest");if("function"==typeof this._eventTable[s])n.forEach(n=>{(function(e,t){const s=e.getTargetComp();return t.isInThisQuest(s)})(t,n)&&this._eventTable[s](e,t,n)});else{const e=Object.keys(this._eventTable);i.default.err("SystemQuest","processQuestEvent",`No function for ${s} in eventTable. Found: ${e}`)}}onBattleEvent(e,t,s){const n=t.getArgs(),r=t.getTargetComp(),a=r.getTarget(),o=r.getTargetType(),i=function(e,t){const s=e.getQuestTargets();return s.find(e=>e.id===t.getID())}(s,a);if("winbattle"===o){if(n.isWon){this.setTargetCompleted(i,s);let t=e.getName()+" has won a battle as ";t+="as a quest objective!",g({cell:e.getCell(),msg:t})}}else if("finishbattle"===o){this.setTargetCompleted(i,s);let t=e.getName()+" has finished a battle as ";t+="as a quest objective!",g({cell:e.getCell(),msg:t})}}onDamageEvent(e,t,s){const n=t.getTargetComp().getTarget(),r=s.getQuestTargets().find(e=>e.id===n.getID());this.setTargetCompleted(r,s);let a=e.getName()+" has finished a quest objective ";a+="to damage "+n.getDamage(),g({cell:e.getCell(),msg:a})}onEscortEvent(e,t,s){const n=t.getTargetComp().getTarget(),r=s.getQuestTargets().find(e=>e.id===n.getID());this.setTargetCompleted(r,s);let a="";const o=e.getLevel().getParentZone();o&&(a=" to "+o.getName());let i=`${e.getName()} has escorted ${n.getName()} `;i+=`safely back${a} as a quest objective!`,g({cell:e.getCell(),msg:i})}onGetEvent(e,t,s){const n=t.getTargetComp().getTarget(),r=s.getQuestTargets().find(e=>e.id===n.getID());this.setTargetCompleted(r,s);let a=`${e.getName()} has found ${n.getName()} `;a+="as a quest objective!",g({cell:e.getCell(),msg:a})}onGiveEvent(e,t,s){console.log("processing onGiveEvent");const n=t.getArgs(),{actor:r,item:a}=n,o=s.getQuestTargets().find(e=>e.id===r.getID());this.setTargetCompleted(o,s);let i=`${e.getName()} has given ${a.getName()} `;i+=`to ${r.getName()} as quest objective!`,g({cell:e.getCell(),msg:i})}onGotoEvent(e,t,s){const n=t.getTargetComp().getTarget(),r=s.getQuestTargets().find(e=>e.id===n.getID());if(!r.isCompleted){this.setTargetCompleted(r,s);const t=e.getName()+" has arrived to a quest target location!";g({cell:e.getCell(),msg:t})}}onKillEvent(e,t,s){const n=t.getArgs();if(n&&n.corpse){const r=t.getTargetComp().getTarget();this.moveQuestTargetComp(r,n.corpse);const a=s.getQuestTargets().find(e=>e.id===r.getID());this.setTargetCompleted(a,s);let o=e.getName()+" has reached quest target of killing";o+=` ${r.getName()}.`,g({cell:e.getCell(),msg:o})}else i.default.err("SystemQuest","onKillEvent","Args must contain |corpse|. Got: "+JSON.stringify(n))}onListenEvent(e,t,s){const n=t.getArgs();if(n&&n.info){const t=n.info.getInfo(),r=n.src;e.add(n.info.clone());const a=r.getID(),o=s.getQuestTargets().find(e=>e.id===a);this.setTargetCompleted(o,s);g({msg:`${r.getName()} tells about ${t}`,cell:e.getCell()})}else i.default.err("SystemQuest","onListenEvent","Args must contain |info|. Got: "+JSON.stringify(n))}onReadEvent(e,t,s){const n=t.getTargetComp().getTarget(),r=s.getQuestTargets(),a=r.find(e=>e.id===n.getID());this.setTargetCompleted(a,s);const o=n.getMetaData("place");if(o){const t=o[0];if(t.levelID===e.getLevel().getID()){const e=r.find(e=>e.id===t.levelID&&!e.isCompleted);this.setTargetCompleted(e,s)}else{let s=e.getName()+" learns to travel to ";s+=t.placeName+" as part of the quest.",g({cell:e.getCell(),msg:s})}}}onReportEvent(e,t,s){const n=s.getQuestTargets(),r=t.getTargetComp(),a=r.getTarget(),o=a.getName();let i=!1;if(a.has("QuestReport")){const l=a.get("QuestReport"),c=t.getArgs().info;if(c)if(l.getExpectInfoFrom()===c.getGivenBy())i=!0;else{const t=o+" is not interested in this info";g({cell:e.getCell(),msg:t})}else if(s.isTargetInQuest(r)){i=n.filter(e=>e.id!==a.getID()).reduce((e,t)=>e&&t.isCompleted,!0)}}if(i){const t=n.find(e=>e.id===a.getID()),r=`${e.getName()} reports info to ${o}`;g({cell:e.getCell(),msg:r}),this.setTargetCompleted(t,s)}}moveQuestTargetComp(e,t){try{const s=e.get("QuestTarget");s.changeEntity(t),s.setIsCompleted(!0),s.setTarget(t)}catch(t){console.log("srcEnt is",e),console.log(t.message)}}setTargetCompleted(e,t){const s=t.getEntity();if(!1===e.isCompleted)e.isCompleted=!0;else{let s="targetObj: "+JSON.stringify(e);s+="targetQuest: "+JSON.stringify(t),i.default.err("SystemQuest","setTargetCompleted","Tried to set completed quest to completed again: "+s)}if(t.isCompleted()){let e=s.getName()+" has completed a quest!";e+=" now it is time to go collect the reward.",g({cell:s.getCell(),msg:e}),this.checkSubQuestCompletion(s,t)}}checkSubQuestCompletion(e,t){const s=t.getQuestID();e.getList("Quest").forEach(e=>{e.getTargetsByType("subquest").forEach(e=>{e.subQuestID===s&&(e.isCompleted=!0)})})}}function g(e){i.default.gameInfo(e)}t.SystemQuest=f},function(e,t){String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BrainBase=void 0;const r=n(s(0));t.BrainBase=class{constructor(e){r.default.isNullOrUndef([e])&&r.default.err("BrainSentient","constructor","Actor must not be null."),this._actor=e,this._type=null}setActor(e){this._actor=e}getActor(){return this._actor}getType(){return this._type}setType(e){this._type=e}getMemory(){return null}getSeenCells(){return[]}findEnemyCell(e){return null}findFriendCell(e){return null}canMeleeAttack(e,t){return!1}canSeeActor(e){return!1}getSeenFriends(){return[]}getSeenEnemies(){return[]}decideNextAction(e){return r.default.err("BrainBase","decideNextAction","Not implemented. Do in derived class"),null}toJSON(){return{type:this._type}}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Keys=void 0;const r=n(s(0)),a=s(36),o={KEYS:a.KEYS,DIRS:a.DIRS};class i{}t.Keys=i,i.KeyMap=new class{constructor(){this.moveKeyMap={}}initMap(){this.moveKeyMap[i.KEY.MOVE_N]=0,this.moveKeyMap[i.KEY.MOVE_NE]=1,this.moveKeyMap[i.KEY.MOVE_E]=2,this.moveKeyMap[i.KEY.MOVE_SE]=3,this.moveKeyMap[i.KEY.MOVE_S]=4,this.moveKeyMap[i.KEY.MOVE_SW]=5,this.moveKeyMap[i.KEY.MOVE_W]=6,this.moveKeyMap[i.KEY.MOVE_NW]=7,this.moveKeyMap[o.KEYS.VK_8]=0,this.moveKeyMap[o.KEYS.VK_9]=1,this.moveKeyMap[o.KEYS.VK_6]=2,this.moveKeyMap[o.KEYS.VK_3]=3,this.moveKeyMap[o.KEYS.VK_2]=4,this.moveKeyMap[o.KEYS.VK_1]=5,this.moveKeyMap[o.KEYS.VK_4]=6,this.moveKeyMap[o.KEYS.VK_7]=7}inMoveCodeMap(e){return this.moveKeyMap.hasOwnProperty(e)}isRest(e){return e===i.VK.s||e===i.VK.PERIOD}isPickup(e){return e===i.KEY.PICKUP}isUseStairs(e){return e===i.KEY.USE_STAIRS_DOWN||e===i.KEY.USE_STAIRS_UP}isChat(e){return e===i.KEY.CHAT}isConfirmYes(e){return e===i.KEY.YES}isConfirmNo(e){return e===i.KEY.NO}isFightMode(e){return e===i.KEY.FIGHT}isGive(e){return e===i.KEY.GIVE}isGoto(e){return e===i.KEY.GOTO}isJump(e){return e===i.KEY.JUMP}isIssueOrder(e){return e===i.KEY.ORDER}isLook(e){return e===i.KEY.LOOK}isMark(e){return e===i.KEY.MARK}isNextItem(e){return e===i.KEY.NEXT_ITEM}isNextTarget(e){return e===i.KEY.NEXT}isPrevTarget(e){return e===i.KEY.PREV}isRead(e){return e===i.KEY.READ}isRunMode(e){return e===i.KEY.RUN}isSelect(e){return e===i.KEY.SELECT}isSelectAll(e){return e===i.KEY.SELECT_ALL}isTargetMode(e){return e===i.KEY.TARGET}isToggleDoor(e){return e===i.KEY.DOOR}isUsePower(e){return e===i.KEY.POWER}isUseAbility(e){return e===i.KEY.ABILITY}isMultiPurpose(e){return e===i.KEY.MULTI}getDiff(e,t,s){if(this.moveKeyMap.hasOwnProperty(e)){const n=o.DIRS[8][this.moveKeyMap[e]];return[t+n[0],s+n[1]]}return e===i.VK.s?[t,s]:null}getDir(e){if(this.moveKeyMap.hasOwnProperty(e)){const t=this.moveKeyMap[e];return o.DIRS[8][t]}return this.isRest(e)?[0,0]:null}dirToKeyCode(e,t){let s=e,n=t;switch(Array.isArray(e)&&(s=e[0],n=e[1]),0!==s&&(s/=Math.abs(s)),0!==n&&(n/=Math.abs(n)),s){case-1:switch(n){case-1:return i.KEY.MOVE_NW;case 0:return i.KEY.MOVE_W;case 1:return i.KEY.MOVE_SW;default:r.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${s},${n} not supported`)}break;case 0:switch(n){case-1:return i.KEY.MOVE_N;case 0:return i.KEY.REST;case 1:return i.KEY.MOVE_S;default:r.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${s},${n} not supported`)}break;case 1:switch(n){case-1:return i.KEY.MOVE_NE;case 0:return i.KEY.MOVE_E;case 1:return i.KEY.MOVE_SE;default:r.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${s},${n} not supported`)}break;default:r.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${s},${n} not supported`)}return null}keyCodeToCardinalDir(e){switch(e){case i.KEY.MOVE_NW:return"NW";case i.KEY.MOVE_W:return"W";case i.KEY.MOVE_SW:return"SW";case i.KEY.MOVE_N:return"N";case i.KEY.REST:return"REST";case i.KEY.MOVE_S:return"S";case i.KEY.MOVE_NE:return"NE";case i.KEY.MOVE_E:return"E";case i.KEY.MOVE_SE:return"SE";default:return""}}},i.VK={},i.INVALID_KEY=-1,i.VK.a=o.KEYS.VK_A+32,i.VK.b=o.KEYS.VK_B+32,i.VK.c=o.KEYS.VK_C+32,i.VK.d=o.KEYS.VK_D+32,i.VK.e=o.KEYS.VK_E+32,i.VK.f=o.KEYS.VK_F+32,i.VK.g=o.KEYS.VK_G+32,i.VK.h=o.KEYS.VK_H+32,i.VK.i=o.KEYS.VK_I+32,i.VK.j=o.KEYS.VK_J+32,i.VK.k=o.KEYS.VK_K+32,i.VK.l=o.KEYS.VK_L+32,i.VK.m=o.KEYS.VK_M+32,i.VK.n=o.KEYS.VK_N+32,i.VK.o=o.KEYS.VK_O+32,i.VK.p=o.KEYS.VK_P+32,i.VK.q=o.KEYS.VK_Q+32,i.VK.r=o.KEYS.VK_R+32,i.VK.s=o.KEYS.VK_S+32,i.VK.t=o.KEYS.VK_T+32,i.VK.u=o.KEYS.VK_U+32,i.VK.v=o.KEYS.VK_V+32,i.VK.w=o.KEYS.VK_W+32,i.VK.x=o.KEYS.VK_X+32,i.VK.y=o.KEYS.VK_Y+32,i.VK.z=o.KEYS.VK_Z+32,i.VK.A=o.KEYS.VK_A,i.VK.B=o.KEYS.VK_B,i.VK.C=o.KEYS.VK_C,i.VK.D=o.KEYS.VK_D,i.VK.E=o.KEYS.VK_E,i.VK.F=o.KEYS.VK_F,i.VK.G=o.KEYS.VK_G,i.VK.H=o.KEYS.VK_H,i.VK.I=o.KEYS.VK_I,i.VK.J=o.KEYS.VK_J,i.VK.K=o.KEYS.VK_K,i.VK.L=o.KEYS.VK_L,i.VK.M=o.KEYS.VK_M,i.VK.N=o.KEYS.VK_N,i.VK.O=o.KEYS.VK_O,i.VK.P=o.KEYS.VK_P,i.VK.Q=o.KEYS.VK_Q,i.VK.R=o.KEYS.VK_R,i.VK.S=o.KEYS.VK_S,i.VK.T=o.KEYS.VK_T,i.VK.U=o.KEYS.VK_U,i.VK.V=o.KEYS.VK_V,i.VK.W=o.KEYS.VK_W,i.VK.X=o.KEYS.VK_X,i.VK.Y=o.KEYS.VK_Y,i.VK.Z=o.KEYS.VK_Z,i.VK.COMMA=44,i.VK.PERIOD=46,i.VK.LT=60,i.VK.GT=62,i.menuIndices=[0,1,2,3,4,5,6,7,8,9,"a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],i.EXIT_INDEX=i.menuIndices.indexOf("Q"),i.codeToMenuChar=e=>{const t=i.codeToIndex(e);return i.menuIndices[t]};const l=/[a-z]/,c=/[A-Z]/;i.selectIndexToCode=e=>{const t=i.menuIndices.findIndex(t=>t===e);if(t>=0){if(t>=0&&t<=9)return o.KEYS.VK_0+t;if(l.test(e)){const e=t-i.menuIndices.indexOf("a");return i.VK.a+e}if(c.test(e)){const e=t-i.menuIndices.indexOf("A");return o.KEYS.VK_A+e}}return r.default.err("RG","selectIndexToCode",`Invalid select index |${e}|`),i.INVALID_KEY},i.codeToIndex=e=>e>=o.KEYS.VK_0&&e<=o.KEYS.VK_9?e-o.KEYS.VK_0:e>=i.VK.a&&e<=i.VK.z?e-i.VK.a+i.menuIndices.indexOf("a"):e>=o.KEYS.VK_A&&e<=o.KEYS.VK_Z?e-o.KEYS.VK_A+i.menuIndices.indexOf("A"):i.INVALID_KEY,i.isNumeric=e=>e>=o.KEYS.VK_0&&e<=o.KEYS.VK_9,i.KEY={},i.KEY.MOVE_N=o.KEYS.VK_W+32,i.KEY.MOVE_NE=o.KEYS.VK_E+32,i.KEY.MOVE_E=o.KEYS.VK_D+32,i.KEY.MOVE_SE=o.KEYS.VK_C+32,i.KEY.MOVE_S=o.KEYS.VK_X+32,i.KEY.MOVE_SW=o.KEYS.VK_Z+32,i.KEY.MOVE_W=o.KEYS.VK_A+32,i.KEY.MOVE_NW=o.KEYS.VK_Q+32,i.KEY.ABILITY=i.VK.k,i.KEY.CHAT=o.KEYS.VK_C,i.KEY.DELETE=o.KEYS.VK_D,i.KEY.DOOR=o.KEYS.VK_O+32,i.KEY.FIGHT=o.KEYS.VK_F+32,i.KEY.GIVE=o.KEYS.VK_G,i.KEY.GOTO=i.VK.g,i.KEY.JUMP=i.VK.j,i.KEY.LOOK=o.KEYS.VK_L+32,i.KEY.MARK=i.VK.b,i.KEY.MULTI=o.KEYS.VK_SPACE,i.KEY.NEXT=i.VK.n,i.KEY.NEXT_ITEM=o.KEYS.VK_H+32,i.KEY.ORDER=o.KEYS.VK_O,i.KEY.PICKUP=i.VK.COMMA,i.KEY.POWER=o.KEYS.VK_P+32,i.KEY.PREV=o.KEYS.VK_P+32,i.KEY.QUIT_MENU=i.VK.q,i.KEY.READ=o.KEYS.VK_R,i.KEY.REST=o.KEYS.VK_S+32,i.KEY.RUN=o.KEYS.VK_R+32,i.KEY.SELECT=i.VK.s,i.KEY.SELECT_ALL=o.KEYS.VK_A,i.KEY.TARGET=i.VK.t,i.KEY.USE_ABILITY=i.VK.k,i.KEY.USE_STAIRS_DOWN=i.VK.GT,i.KEY.USE_STAIRS_UP=i.VK.LT,i.KEY.YES=i.VK.y,i.KEY.NO=i.VK.n,i.KeyMap.initMap(),i.KEY.NO_ACTION=o.KEYS.VK_CAPS_LOCK,i.GUI={},i.GUI.CharInfo=o.KEYS.VK_I,i.GUI.Goto=i.KEY.GOTO,i.GUI.Help=o.KEYS.VK_H,i.GUI.Help2=o.KEYS.VK_QUESTION_MARK,i.GUI.Inv=i.VK.i,i.GUI.Look=i.VK.l,i.GUI.Map=i.VK.m,i.GUI.OwMap=o.KEYS.VK_M,i.GUI.Use=i.VK.u,i.GUI.Craft=i.VK.K,i.isValidKey=e=>{let t=!1;return Object.keys(i.KEY).forEach(s=>{t=t||i.KEY[s]===e}),t=t||i.KeyMap.inMoveCodeMap(e),t},i.getChar=e=>"`"+String.fromCharCode(e)+"`"},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SpellBase=t.SpellBook=t.Spell=void 0;const i=o(s(0)),l=s(69),c=a(s(2)),u=s(1),h=s(17),d=s(6),f=s(15),g=s(4),p=s(10),m=s(37),y=u.Random.getRNG(),{KeyMap:_}=l.Keys,b=c.create;t.Spell={};t.Spell.addPoisonEffect=(e,t)=>{const s=t.get("Experience").getExpLevel(),n=new h.Dice(1,s,Math.ceil(s/2));let r=.07*s;r>=.5&&(r=.5);const a=new h.Dice(2,s+5,Math.ceil(s/2)).roll();v(e,t,a,n,r)};const v=(e,t,s,n,r)=>{const a=new c.Poison;a.setDamageDie(n);const o=new c.Expiration;o.addEffect(a,s),a.setSource(t),a.setProb(r),e.add(a),e.add(o)},E=(e,t,s)=>{const n=s.getCaster();n.getLevel().addActor(e,t.getX(),t.getY());const r=new c.Fading,a=s.getDuration();r.setDuration(a),e.add(r);const o=new c.Created;o.setCreator(n),e.add(o)};t.Spell.addFadingActorToCell=E;const S=(e,t,s)=>{const n=[t.getX()-e.getX(),t.getY()-e.getY()];s(e,{dir:n,src:e})};t.Spell.aiSpellCellDone=S;t.Spell.aiSpellCellEnemy=(e,t)=>{const{actor:s,actorCellsAround:n}=e;let r=null;return n.forEach(t=>{t.getActors().forEach(t=>{if(s.isEnemy(t)){const s=t.get("Health");if(r)if(e.compFunc)e.compFunc(r,t)&&(r=t);else{s.getMaxHP()>r.get("Health").getMaxHP()&&(r=t)}else r=t}})}),!!r&&(S(s,r,t),!0)};t.Spell.aiSpellCellFriend=(e,t)=>{const{actor:s,actorCellsAround:n}=e;let r=null;return n.forEach(t=>{t.getActors().forEach(t=>{if(s.isFriend(t))if(r)if(e.compFunc)e.compFunc(r,t)&&(r=t);else{const e=r.get("Health");t.get("Health").hpLost()>e.hpLost()&&(r=t)}else r=t})}),!!r&&(S(s,r,t),!0)};t.Spell.aiSpellCellSelf=(e,t)=>{const{actor:s}=e;let n=!0;return e.compFunc&&(n=!!e.compFunc(s)),n&&S(s,s,t),n},t.Spell.getSelectionObjectSelf=(e,t)=>()=>{const s=new c.SpellCast;s.setSource(t),s.setSpell(e),s.setArgs({src:t}),t.add(s)},t.Spell.getSelectionObjectDir=(e,t,s)=>(i.default.gameMsg(s),{select:s=>{const n={dir:_.getDir(s)};return n.dir?(n.src=t,()=>{const s=new c.SpellCast;s.setSource(t),s.setSpell(e),s.setArgs(n),t.add(s)}):null},showMenu:()=>!1});const w=function(e,t){return{from:t.src.getXY(),dir:t.dir,spell:e,src:t.src}};t.Spell.getDirSpellArgs=w;class C{constructor(e){this._actor=e,this._spells=[],i.default.isNullOrUndef([this._actor])&&i.default.err("Spell.SpellBook","new","actor must be given.")}getActor(){return this._actor}addSpell(e){this._spells.push(e),e.setCaster(this.getActor())}getSpells(){return this._spells}equals(e){const t=e.getSpells();let s=!0;return this._spells.forEach((e,n)=>{s=s&&e.equals(t[n]),s||console.log("Spell",e.getName()," caused error")}),s}getSelectionObject(){const e=this._spells;return{select:t=>{const s=l.Keys.codeToIndex(t);return s>=0&&s<e.length?e[s].getSelectionObject(this._actor):null},getMenu:()=>{i.default.gameMsg("Please select a spell to cast:");const t=l.Keys.menuIndices.slice(0,this._spells.length),s={pre:["You know the following spells:"]};return e.forEach((e,n)=>{s[t[n]]=e.toString()}),s},showMenu:()=>!0}}toJSON(){return{spells:this._spells.map(e=>e.toJSON())}}}function T(e,t,s){const{actor:n,enemy:r}=e;if(!r)return!1;if(f.Brain.distToActor(n,r)<=s.getRange()){return t(n,{target:r,src:n}),!0}return!1}t.SpellBook=C,t.Spell.SpellBook=C,t.SpellBase=function(e,t){this._name=e,this._power=t||5,this._caster=null,this._dice={},this._range=0,this.setName(e)},t.SpellBase.prototype.setCaster=function(e){this._caster=e},t.SpellBase.prototype.getCaster=function(){return this._caster},t.SpellBase.prototype.setName=function(e){const t=e.split(/\s+/),s=[];t.forEach(e=>{s.push(e.capitalize())}),this._new=s.join("")},t.SpellBase.prototype.getName=function(){return this._name},t.SpellBase.prototype.getPower=function(){return this._power},t.SpellBase.prototype.canCast=function(){return this._caster.get("SpellPower").getPP()>=this.getCastingPower()},t.SpellBase.prototype.getCastingPower=function(){let e=this._power;const t=this._caster.get("Experience").getExpLevel();if(e-=Math.ceil(t/3),this._caster.has("Skills")){const t=this._caster.get("Skills").getLevel("SpellCasting");e-=Math.ceil(t/2)}const s=Math.round(.5*this._power);return e<s?s:e},t.SpellBase.prototype.getRange=function(){return this._range},t.SpellBase.prototype.setRange=function(e){this._range=e},t.SpellBase.prototype.getDuration=function(e=1){let t=0;if(this._dice.duration&&(t=this._dice.duration.roll()),e>0){const s=this._caster.get("Experience").getExpLevel();t+=Math.round(s/e)}return t},t.SpellBase.prototype.getDamage=function(e=1){let t=0;this._dice.damage&&(t=this._dice.damage.roll());const s=this._caster.get("Experience").getExpLevel();return t+=Math.round(s/e),t},t.SpellBase.prototype.setPower=function(e){this._power=e},t.SpellBase.prototype.getCastFunc=function(e,t){return t.dir||t.target||t.src?(t.src=e,()=>{const s=new c.SpellCast;s.setSource(e),s.setSpell(this),s.setArgs(t),e.add(s)}):null},t.SpellBase.prototype.toString=function(){const e=this.getCastingPower();let t=`${this.getName()} - ${e}PP`;return this._dice.damage&&(t+=" Dmg: "+this._dice.damage.toString()),this._dice.duration&&(t+=" Dur: "+this._dice.duration.toString()),this._range>0&&(t+=" R: "+this.getRange()),t},t.SpellBase.prototype.getCasterExpBonus=function(e){const t=this.getCaster().get("Experience").getExpLevel();return Math.round(t/e)},t.SpellBase.prototype.getCasterStatBonus=function(e,t){const s="get"+e.capitalize(),n=this.getCaster()[s]();return Math.round(n/t)},t.SpellBase.prototype.equals=function(e){let t=this.getName()===e.getName();return t=t&&this.getPower()===e.getPower(),t=t&&this.getRange()===e.getRange(),Object.keys(this._dice).forEach(s=>{t=!!e._dice[s]&&(t&&this._dice[s].equals(e._dice[s]))}),t},t.SpellBase.prototype.setDice=function(e,t){"string"==typeof t?this._dice[e]=h.Dice.create(t):t.roll&&(this._dice[e]=t)},t.SpellBase.prototype.getDice=function(e){return this._dice[e]},t.SpellBase.prototype.hasDice=function(e){return!(!this._dice.hasOwnProperty(e)||!this._dice[e])},t.SpellBase.prototype.removeDice=function(e){this._dice[e]=null},t.SpellBase.prototype.rollDice=function(e){return this._dice[e]?this._dice[e].roll():(i.default.err("SpellBase","rollDice",`No dice with name ${e} found`),0)},t.SpellBase.prototype.aiShouldCastSpell=function(e,t){return!1},t.SpellBase.prototype.toJSON=function(){const e={};return Object.keys(this._dice).forEach(t=>{i.default.isNullOrUndef([this._dice[t]])||(e[t]=this._dice[t].toJSON())}),{name:this.getName(),new:this._new,power:this.getPower(),dice:e,range:this._range}},t.Spell.AddComponent=function(e,s){t.SpellBase.call(this,e,s),this._compName="",this._dice.duration=h.Dice.create("1d6 + 3")},i.default.extend2(t.Spell.AddComponent,t.SpellBase),t.Spell.AddComponent.prototype.setDuration=function(e){this._dice.duration=e},t.Spell.AddComponent.prototype.setCompName=function(e){this._compName=e},t.Spell.AddComponent.prototype.getCompName=function(){return this._compName},t.Spell.AddComponent.prototype.cast=function(e){const t=w(this,e),s=b(this._compName);if(s.setSource&&s.setSource(e.src),t.addComp={comp:s},this.hasDice("duration")){const e=this.rollDice("duration");t.addComp.duration=e}const n=new c.SpellCell;n.setArgs(t),e.src.add(n)},t.Spell.AddComponent.prototype.getSelectionObject=function(e){return t.Spell.getSelectionObjectDir(this,e,"Select a direction for the spell:")},t.Spell.RemoveComponent=function(e,s){t.SpellBase.call(this,e,s),this._compNames=[],this.setCompNames=e=>{this._compNames="string"==typeof e?[e]:e},this.getCompNames=()=>this._compNames,this.cast=function(e){const t=w(this,e);t.removeComp=this._compNames;const s=new c.SpellCell;s.setArgs(t),e.src.add(s)},this.getSelectionObject=function(e){return t.Spell.getSelectionObjectDir(this,e,"Select a direction for the spell:")}},i.default.extend2(t.Spell.RemoveComponent,t.SpellBase),t.Spell.Ranged=function(e,s){t.SpellBase.call(this,e,s),this._dice.damage=h.Dice.create("4d4 + 4"),this._range=5},i.default.extend2(t.Spell.Ranged,t.SpellBase),t.Spell.BoltBase=function(e,s){t.Spell.Ranged.call(this,e,s),this.stopOnHit=!1,this.cast=function(e){const t=w(this,e);t.damageType=this.damageType,t.damage=this.rollDice("damage");const s=new c.SpellRay;s.setArgs(t),e.src.add(s)},this.getSelectionObject=function(e){return i.default.gameMsg("Select a direction for firing:"),{select:t=>{const s=_.getDir(t);return this.getCastFunc(e,{dir:s})},showMenu:()=>!1}},this.aiShouldCastSpell=(e,t)=>{const{actor:s,enemy:n}=e;if(!n)return!1;const[r,a]=[s.getX(),s.getY()],[o,l]=[n.getX(),n.getY()],c=g.Geometry.getStraightLine(r,a,o,l);if(c.length>1){const e={dir:[c[1][0]-c[0][0],c[1][1]-c[0][1]]};return"function"==typeof t?t(s,e):i.default.err("Spell.BoltBase","aiShouldCastSpell","No callback function given!"),!0}return!1}},i.default.extend2(t.Spell.BoltBase,t.Spell.Ranged),t.Spell.SummonBase=function(e,s){t.SpellBase.call(this,e,s),this.summonType="",this.nActors=1,this.summonFunc=null,this.setSummonType=e=>{this.summonType=e},this.cast=function(e){const t=w(this,e),s=h.Dice.getValue(this.nActors);t.callback=t=>{if(1===s)t.isFree()&&this._createAndAddActor(t,e);else{const t=e.src,n=t.getLevel().getMap(),[r,a]=t.getXY(),o=g.Geometry.getBoxAround(r,a,2);let l=0,c=30;for(;l<s;){const[t,s]=y.arrayGetRand(o);if(n.hasXY(t,s)){const r=n.getCell(t,s);r.isFree()&&(this._createAndAddActor(r,e),++l)}if(0==--c)break}if(l<s){const e=t.getName()+" has no space to summon";i.default.gameMsg({cell:t.getCell(),msg:e})}}};const n=new c.SpellCell;n.setArgs(t),e.src.add(n)},this.getSelectionObject=function(e){return t.Spell.getSelectionObjectDir(this,e,"Select a free cell for summoning:")},this.aiShouldCastSpell=(e,t)=>{const{actor:s,enemy:n}=e;if(0===f.Brain.getFriendCellsAround(s).length)if("function"==typeof t){const n=s.getBrain().getRandAdjacentFreeCell();if(n)return e.dir=i.default.dXdY(n,s),t(s,e),!0}else i.default.err("Spell."+this.getName(),"aiShouldCastSpell","No callback function given! enemy: "+n);return!1},this._createAndAddActor=(e,t)=>{const[s,n]=[e.getX(),e.getY()],r=t.src,a=r.getLevel(),o=d.ObjectShell.getParser();let l=null;if(""!==this.summonType?l=o.createActor(this.summonType):this.summonFunc&&(l=o.createRandomActor({func:this.summonFunc})),l){a.addActor(l,s,n),l.getBrain().getMemory().copyMemoryFrom(r),l.addFriend(r),r.addFriend(l);const o=`${r.getName()} summons ${l.getName()}!`;i.default.gameMsg({cell:e,msg:o}),"function"==typeof this.postSummonCallback&&this.postSummonCallback(e,t,l)}else{let e=`Failed to create summon type |${this.summonType}|`;if(this.summonFunc){e=`summonFunc ${this.summonFunc.toString()} gave no actors`}i.default.warn("Spell.SummonBase","_createAndActor",e)}}},i.default.extend2(t.Spell.SummonBase,t.SpellBase),t.Spell.Missile=function(e,s){t.Spell.Ranged.call(this,e,s),this.ammoName=""},i.default.extend2(t.Spell.Missile,t.Spell.Ranged),t.Spell.Missile.prototype.getAmmoName=function(){return this.ammoName},t.Spell.Missile.prototype.cast=function(e){const t={from:e.src.getXYZ(),target:e.target,spell:this,src:e.src,to:e.target.getXYZ()};t.damageType=this.damageType,t.damage=this.getDamage();const s=new c.SpellMissile;s.setArgs(t),e.src.add(s)},t.Spell.Missile.prototype.getSelectionObject=function(e){i.default.gameMsg("Press [n/p] for next/prev target. [t] to fire."),e.getBrain().startTargeting();const t=[{key:l.Keys.KEY.TARGET,func:()=>{const t=e.getBrain().getTarget();if(t){const s=new c.SpellCast;s.setSource(e),s.setSpell(this),s.setArgs({src:e,target:t}),e.add(s),e.getBrain().cancelTargeting()}}}];return new m.PlayerMissileMenu(t,e)},t.Spell.Missile.prototype.aiShouldCastSpell=function(e,t){const{actor:s,enemy:n}=e;if(n){const[e,r]=n.getXY(),[a,o]=s.getXY();if(p.Path.shortestDist(e,r,a,o)<=this.getRange()){return t(s,{target:n,src:s}),!0}}return!1},t.Spell.AreaBase=function(e,s){t.Spell.Ranged.call(this,e,s),this.getSelectionObject=function(e){return t.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=(e,t)=>T(e,t,this),this.cast=function(e){const t={src:e.src,range:this.getRange(),spell:this};t.damageType=this.damageType,t.damage=this.getDamage();const s=new c.SpellArea;s.setArgs(t),e.src.add(s);const n=e.src.getName(),r=`Huge ${this.getName()} emanates from ${n}`;i.default.gameMsg({msg:r,cell:e.src.getCell()})}},i.default.extend2(t.Spell.AreaBase,t.Spell.Ranged),t.Spell.RingBase=function(e,s){t.SpellBase.call(this,e,s),t.SpellBase.call(this,e,s),this._dice.duration=h.Dice.create("10d10"),this._range=2,this._createdActor="Fire",this.cast=function(e){const t=w(this,e);t.callback=this.castCallback.bind(this);const s=new c.SpellSelf;s.setArgs(t),e.src.add(s)},this.getSelectionObject=function(e){return t.Spell.getSelectionObjectSelf(this,e)},this.castCallback=()=>{const e=d.ObjectShell.getParser(),t=this._caster;f.Brain.getCellsAroundActor(t,this._range).forEach(t=>{if(t.isPassable()||t.hasActors()){const s=e.createActor(this._createdActor);E(s,t,this)}})},this.aiShouldCastSpell=(e,t)=>T(e,t,this)},i.default.extend2(t.Spell.RingBase,t.SpellBase),t.Spell.MultiSpell=function(e,s){t.SpellBase.call(this,e,s),this._spells=[]},i.default.extend2(t.Spell.MultiSpell,t.SpellBase),t.Spell.MultiSpell.prototype.addSpell=function(e){this._spells.push(e)},t.Spell.MultiSpell.prototype.removeSpells=function(){this._spells=[]},t.Spell.MultiSpell.prototype.canCast=function(){return this._caster.get("SpellPower").getPP()>=this.getCastingPower()},t.Spell.MultiSpell.prototype.cast=function(e){this._spells.forEach(t=>{t.cast(e)})},t.Spell.MultiSpell.prototype.getCastingPower=function(){return this._spells.map(e=>e.getCastingPower()).reduce((e,t)=>e+t,0)},t.Spell.MultiSpell.prototype.getPower=function(){return this._spells.map(e=>e.getPower()).reduce((e,t)=>e+t,0)},t.Spell.MultiSpell.prototype.aiShouldCastSpell=function(e,t){let s=!0;return this._spells.forEach(n=>{s=s&&n.aiShouldCastSpell(e,t)}),s},t.Spell.MultiSpell.prototype.equals=function(e){if(!e._spells)return!1;if(e._spells.length!==this._spells.length)return!1;let t=!0;return this._spells.forEach((s,n)=>{t=t&&s.equals(e._spells[n]),t||console.log("Spell",s.getName()," caused error")}),t},t.Spell.MultiSpell.prototype.toJSON=function(){const e=t.SpellBase.prototype.toJSON.call(this);return e.spells=this._spells.map(e=>e.toJSON()),e},t.Spell.MultiSpell.prototype.setCaster=function(e){this._spells.forEach(t=>{t.setCaster(e)})},t.Spell.override=!1,t.Spell.defineSpell=function(e,s){const n=class extends s{constructor(...t){super(e,0),this._init&&"function"==typeof this._init&&this._init(...t)}};return t.Spell.hasOwnProperty(e)&&!t.Spell.override&&i.default.err("Spell","defineSpell",`Tried to override spell |${e}|. Use Spell.override = true`),t.Spell[e]=n,n},t.Spell.undefineSpell=function(e){delete t.Spell[e]}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ObjectShellComps=void 0;const i=o(s(0)),l=a(s(2)),c=s(1),u=s(17),h=s(5)("bitn:objectshellcomps"),d=c.Random.getRNG();t.ObjectShellComps=class{constructor(e){this.debug=h.enabled,e&&e.debug&&(this.debug=e.debug)}addComponents(e,t){if("string"==typeof e.addComp)this._addCompFromString(e.addComp,t);else if(Array.isArray(e.addComp))e.addComp.forEach(e=>{let s=e;e&&"object"==typeof e&&e.random&&(s=d.arrayGetRand(e.random)),"string"==typeof s?this._addCompFromString(s,t):this._addCompFromObj(t,s)});else if("object"==typeof e.addComp){let s=e.addComp;e.addComp&&e.addComp.random&&(s=d.arrayGetRand(e.addComp.random)),this._addCompFromObj(t,s)}else i.default.err("Creator","addComponents","Giving up. shell.addComp must be string, array or object.")}addCompToObj(e,t,s){if(this.debug&&console.log(e.getName(),": compData with val",t,s),t.hasOwnProperty("func"))if(Array.isArray(t.func))t.func.forEach(n=>{const r=t.comp;if(e.has(r))"function"==typeof e.get(r)[n]?e.get(r)[n](s):this.noFuncError(r,n,t);else{const a=this.createComponent(r);"function"==typeof a[n]?(a[n](s),e.add(a)):this.noFuncError(r,n,t)}});else{const n=t.func,r=t.comp;if(e.has(r)&&"string"==typeof n){this.debug&&console.log("hasComp already KKK222 here now:",n);const t=e.get(r);"function"==typeof t[n]?t[n](s):i.default.err("ObjectShellComps","addCompToObj",`${n} is not a function on comp ${r}`)}else{let a=null;if(e.has(r)&&t.useOld||(a=this.createComponent(r),e.add(a)),a=e.get(r),"function"==typeof a[n])a[n](s),this.debug&&console.log("KKK333 new comp created and called",n,s);else if("object"==typeof n){Object.keys(t.func).forEach(s=>{const n={func:s,comp:r};t.useOld&&(n.useOld=t.useOld);const a=t.func[s];this.debug&&console.log("KKK444 Calling addCompToObj recursively",n,a),this.addCompToObj(e,n,a)})}else i.default.log(JSON.stringify(n)),i.default.err("ObjectShellComps","addCompToObj",`No function ${n} in ${r}`)}}else e.has(t.comp)?(console.log("newObj: ",e,"compData: ",t),i.default.err("ObjectShellComps","addCompToObj","else-if branch Not implemented")):e.add(this.createComponent(t.comp,s))}createComponent(e,t){switch(e){case"Health":return new l.Health(t);default:if(l.hasOwnProperty(e))return new l[e];i.default.err("Creator","createComponent","Component |"+e+"| does not exist.")}return null}addPoison(e,t){const s=e.poison,n=new l.Poison;n.setProb(s.prob),n.setSource(t),n.setDamageDie(u.Dice.create(s.damage));const r=u.Dice.create(s.duration);n.setDurationDie(r);const a=new l.AddOnHit;a.setComp(n),t.add(a)}addOnHitProperties(e,t){e.onHit.forEach(e=>{this.processAddComp(e,t)})}addOnAttackHitProperties(e,t){e.onAttackHit.forEach(e=>{const s=this.processAddComp(e,t);s.setOnDamage(!1),s.setOnAttackHit(!0)})}addOnEquipProperties(e,t){e.onEquip.forEach(e=>{this.processAddComp(e,t,!0)})}processAddComp(e,t,s=!1){let n=null;if(n=s?new l.AddOnEquip:new l.AddOnHit,e.addComp){const s=this.createComponent(e.addComp);s.setSource&&i.default.isActor(t)&&s.setSource(t),Array.isArray(e.func)&&e.func.forEach(e=>{if("function"==typeof s[e.setter])s[e.setter](e.value);else{const t=s.toJSON();i.default.err("ObjectShellParser","addOnHitProperties",`Not a func: ${e.setter} in comp ${t}`)}});const r=s;if(e.duration){const t=u.Dice.create(e.duration),s=new l.Duration;s.setDurationDie(t),s.setComp(r),n.setComp(s),e.expireMsg&&s.setExpireMsg(e.expireMsg)}else n.setComp(r);return t.add(n),n}return e.transientComp?(n.setComp(JSON.parse(JSON.stringify(e))),t.add(n),n):null}addCallbacks(e,t){const s=e.callbacks;t.has("Callbacks")||t.add(new l.Callbacks),Object.keys(s).forEach(e=>{t.get("Callbacks").addCb(e,s[e])})}noFuncError(e,t,s){const n="compData "+JSON.stringify(s);i.default.err("ObjectShellComps","addCompToObj",`Comp: ${e} no func ${t}, ${n}`)}_addCompFromString(e,t){try{const s=new l[e];t.add(s)}catch(t){let s=`shell.addComp |${e}|`;s+="Component names are capitalized.",i.default.err("Creator","_addCompFromString",`${t.message} - ${s}`)}}_addCompFromObj(e,t){this.addCompToObj(e,t,null)}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.shellProps=t.ActorGen=void 0;const r=n(s(0)),a=s(1),o=s(47),i=s(58);t.ActorGen={};const l=new a.Random;t.shellProps={races:{},ranks:{},roles:{},roleBases:{}};const c={range:1,danger:1,speed:100,brain:"GoalOriented",damage:"1d6",attack:1,defense:1,hp:5,protection:0,enemies:r.default.ACTOR_RACES,accuracy:5,agility:5,strength:5,magic:5,perception:5,willpower:5};t.shellProps.races={arborean:{strength:3,willpower:5,type:"arborean",prefix:"arborean",char:"a",colorbg:"white"},elf:{strength:-1,agility:4,accuracy:4,magic:3,type:"elf",prefix:"elven",char:"e",colorbg:"green"},fae:{type:"fae",prefix:"fae",char:"f",colorbg:"purple",speed:10,strength:-2,magic:3,addComp:["Flying"]},gnome:{strength:-1,magic:3,perception:5,type:"gnome",prefix:"gnomish",char:"n",colorbg:"beige"},naga:{strength:2,type:"naga",prefix:"naga",char:"N",colorbg:"darkgreen",addComp:[o.resistance("POISON","STRONG")]},ogre:{strength:4,magic:-3,willpower:-3,type:"ogre",prefix:"ogre",char:"O",colorbg:"darkseagreen"},orc:{strength:2,magic:-2,willpower:-2,type:"orc",prefix:"orc",char:"o",colorbg:"darkseagreen"},ratling:{agility:2,perception:4,type:"ratling",prefix:"ratling",char:"r",colorbg:"grey"},teradin:{agility:2,accuracy:3,type:"teradin",prefix:"teradin",char:"T",colorbg:"white",addComp:["Flying"]},vachefolk:{strength:2,type:"vachefolk",prefix:"vachefolk",char:"v",colorbg:"brown"},valkyr:{strength:3,type:"valkyr",prefix:"valkyr",char:"V",colorbg:"darkblue",addComp:[o.resistance("ICE","MEDIUM")]},viking:{strength:4,agility:3,type:"viking",prefix:"viking",char:"K",colorbg:"Azure",addComp:[o.resistance("ICE","MEDIUM")]}},m(t.shellProps.races,1.5,1);const u=Object.keys(t.shellProps.races);t.shellProps.ranks={commoner:{danger:1,hp:5,colorfg:"brown",damage:1},peon:{danger:1,hp:5,colorfg:"brown",damage:1},thrall:{danger:1,hp:7,damage:1},adventurer:{danger:2,hp:10,damage:2},sergeant:{danger:3,strength:1,hp:15,damage:3,colorfg:"lightblue"},lieutenant:{danger:4,damage:4,strength:3,hp:20,colorfg:"blue"},commander:{danger:5,damage:5,strength:5,hp:20,equip:["Great battle axe","Steel armour","Steel helmet"],colorfg:"orange"},steward:{colorfg:"steelblue",danger:5,hp:20,damage:5},lord:{colorfg:"LightGoldenRodYellow",danger:5,damage:5,strength:7,hp:20},hero:{colorfg:"green",danger:6,damage:6,strength:4,accuracy:4,agility:4,speed:7,hp:25},warlord:{danger:7,hp:25,colorfg:"black",damage:7},captain:{danger:7,hp:25,strength:7,agility:3,accuracy:3,colorfg:"salmon",damage:7},prince:{colorfg:"MediumPurple",danger:5,hp:20,damage:5},princess:{colorfg:"pink",danger:5,agility:5,magic:5,hp:20,damage:5},queen:{colorfg:"yellow",danger:10,hp:30,addComp:["FirstStrike"],damage:10},king:{colorfg:"red",strength:7,attack:7,defense:7,danger:12,hp:40,damage:12},emperor:{colorfg:"purple",danger:15,strength:10,attack:10,defense:10,hp:50,addComp:[i.BypassComp(.15)],damage:15},empress:{colorfg:"palevioletred",danger:17,damage:17,accuracy:10,agility:10,attack:10,defense:10,hp:45,addComp:[i.BypassComp(.25),"Charm"]},overlord:{colorfg:"orangered",danger:10,hp:35,damage:10,addComp:[i.BypassComp(.1)]}};const h=Object.keys(t.shellProps.ranks);m(t.shellProps.ranks,1.5,1),t.shellProps.roleBases={melee:{attack:2,defense:2,protection:2,danger:1,damage:"1d8"},magic:{magic:3,willpower:2,danger:2,brain:"SpellCaster",maxPP:10,PP:10,addComp:["RegenEffect"],damage:"1d4"},ranged:{accuracy:3,agility:1,danger:2,addComp:[{random:["EagleEye","StrongShot","ThroughShot","LongRangeShot","RangedEvasion","CriticalShot"]}],damage:"1d6"},stealth:{defense:2,agility:3,perception:2,danger:0,damage:"1d5"}},m(t.shellProps.roleBases,1.5,1),t.shellProps.roles={melee:{soldier:{danger:1,hp:5,attack:1,defense:1,damage:"1d4"},axeman:{danger:2,hp:10,damage:"1d6"},brave:{danger:2,hp:7,strength:2,damage:"1d6"},duelist:{danger:3,hp:13,agility:3,strength:2,addComp:["RangedEvasion"],damage:"1d8"},elite:{danger:5,hp:23,strength:4,addComp:["CounterAttack"],damage:"2d6"},fighter:{danger:2,hp:12,agility:1,strength:1},footman:{danger:1,damage:"1d4",equip:["Longsword"]},knight:{danger:4,hp:15,strength:4},phalanx:{danger:1,hp:10,defense:4,equip:["Spear"],damage:"1d4"},scourger:{danger:4,hp:20,attack:4,defense:4,strength:6},judicator:{danger:5,hp:30,attack:5,defense:5,strength:7,addComp:["FirstStrike"],damage:"2d6"},skirmisher:{danger:3,hp:15,attack:3,defense:3,damage:"2d3"},hunter:{danger:2,hp:10,attack:3,defense:3,damage:"1d6"},warrior:{danger:2,hp:10,attack:3,defense:3,damage:"1d6"},berserker:{danger:5,hp:20,attack:8,defense:3,strength:6,addComp:["RangedEvasion",o.resistance("ICE","MEDIUM")],damage:"2d6"}},magic:{adept:{danger:1,pp:3,maxPP:3,hp:5,spells:["EnergyArrow"]},archmage:{danger:15,pp:50,maxPP:50,hp:30,spells:["PowerDrain",{random:["WaterBolt","SlimeBolt","FrostBolt"]},{random:["Heal","MagicArmor","Charm"]},{random:["IceArrow","PoisonArrow","ArrowOfWebs"]}]},bard:{danger:3,magic:5,pp:7,maxPP:7,hp:7,spells:["SummonAnimal"]},cleric:{danger:1,magic:2,willpower:3,pp:7,maxPP:7,spells:["Heal"]},healer:{danger:1,magic:2,pp:7,maxPP:7,spells:["Heal"]},mage:{danger:5,magic:5,willpower:5,hp:13,spells:[{random:["RingOfFire","RingOfFrost"]}]},telepath:{danger:4,pp:12,maxPP:12,hp:12,magic:4,willpower:4,spells:["SummonFlyingEyes","Telepathy"]},necromancer:{danger:5,pp:10,maxPP:10,hp:15,spells:["AnimateDead"]},runemage:{danger:3,pp:15,maxPP:15,hp:15,spells:["StunningTouch"]},shaman:{danger:3,pp:15,maxPP:15,hp:10,spells:["IcyPrison"]},summoner:{danger:7,pp:15,maxPP:15,hp:15,spells:[{random:["SummonKin","SummonAirElemental"]}]},wizard:{danger:10,maxPP:30,pp:30,hp:15,magic:7,willpower:7,spells:[{random:["CrossBolt","FrostBolt","LightningBolt"]},{random:["Heal","MagicArmor","Paralysis"]}]}},ranged:{arbalist:{danger:3,hp:10,equip:["Wooden crossbow",{name:"Wooden bolt",count:10}]},archer:{danger:3,hp:5,equip:["Wooden bow",{name:"Wooden arrow",count:10},"Steel bow",{name:"Steel arrow",count:15}]},bolter:{danger:4,hp:5,equip:["Steel crossbow",{name:"Steel bolt",count:7}]},rifleman:{danger:6,hp:15,equip:["Rifle",{name:"Steel bullet",count:7}]},darter:{danger:2,hp:5,speed:5,equip:[{name:"Iron dart",count:9}]},thrower:{danger:1,equip:[{name:"Throwing axe",count:7}]},catapulter:{danger:2,hp:15,strength:5,speed:-5,equip:[{name:"Large rock",count:4}]},sharpshooter:{danger:8,hp:20,accuracy:5,agility:5,equip:["Rifle",{name:"Steel bullet",count:10}],fovrange:7},slinger:{danger:1,hp:3,equip:[{name:"Rock",count:10}]}},stealth:{assassin:{danger:3,addComp:[o.resistance("POISON","MEDIUM")]},acrobat:{danger:2,brain:"Thief",speed:20},rogue:{},scout:{danger:2,speed:10,fovrange:7},thief:{danger:2,brain:"Thief"}}};const d=Object.keys(t.shellProps.roles);d.forEach(e=>{m(t.shellProps.roles[e],1.5,1)});const f=d.reduce((e,s,n,r)=>Object.assign(e,t.shellProps.roles[s]),{}),g=Object.keys(f).reduce((e,t,s,n)=>(e.push(t),e),[]);function p(e,t,s){const n=t.join(" ");let r="";return r="commoner"!==s?e.prefix+" "+n+" "+s:e.prefix+" "+n,r}function m(e,t,s){Object.keys(e).forEach(n=>{const a=e[n];r.default.STATS_LC.forEach(e=>{a.hasOwnProperty(e)&&(a[e]=Math.round(t*a[e])+s)})})}t.ActorGen.genRandShell=function(){const e=l.getUniformInt(1,2),s=l.arrayGetRand(u),n=t.shellProps.races[s],r=l.arrayGetRand(h),a=t.shellProps.ranks[r],i=l.getUniqueItems(d,e),f=i.map(e=>t.shellProps.roleBases[e]),g=[],m=i.map(e=>{const s=t.shellProps.roles[e],n=l.arrayGetRand(Object.keys(s));return g.push(n),s[n]}),y=[c,n,a].concat(f).concat(m),_=o.mixNewShell(y);return _.name=p(n,g,r),_.roleTypes=i,_.roles=g,_.race=s,_},t.ActorGen.genActors=function(e){const s=[];for(let n=0;n<e;n++)s.push(t.ActorGen.genRandShell());return s},t.ActorGen.getRandShellWith=function(e,s=100){let n=s,r=null;for(;n>=0&&(r=t.ActorGen.genRandShell(),!e(r));)--n;return r},t.ActorGen.getRaces=function(){return u},t.ActorGen.genShell=function(e){let s=null,n="";e.rank?(n=e.rank,s=t.shellProps.ranks[e.rank]):(n=l.arrayGetRand(h),s=t.shellProps.ranks[n]);let a=e.race;e.race||(a=l.arrayGetRand(u));const i=t.shellProps.races[a];let m=e.roleTypes;if(!e.roleTypes){const e=l.getUniformInt(1,2);m=l.getUniqueItems(d,e)}const y=m.map(e=>t.shellProps.roleBases[e]),_=e.roles||[];e.roles||m.forEach(e=>{const s=t.shellProps.roles[e],n=l.arrayGetRand(Object.keys(s));_.push(n)});const b=[];_.forEach(e=>{b.push(f[e])});const v=[c,i,s].concat(b).concat(y),E=o.mixNewShell(v);return E.name=p(i,_,n),E.roles=_,E.rank=n,E.race=a,E.color||E.colorfg||(E.colorfg=function(e){if(e.length>1){let t=g.indexOf(e[0]),s=g.indexOf(e[1]);t%=r.default.COLORS.length,s%=r.default.COLORS.length;const n=r.default.COLORS[t];r.default.COLORS[s];return n}let t=g.indexOf(e[0]);return t%=r.default.COLORS.length,r.default.COLORS[t]}(_)),E}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ThinkCommander=t.ThinkSpellcaster=t.ThinkBasic=t.GoalTop=t.GoalsTop=void 0;const r=n(s(0)),a=s(54),o=s(1),i=s(23),l=s(150),c=s(5)("bitn:goals-top"),{GOAL_COMPLETED:u,GOAL_INACTIVE:h,GOAL_FAILED:d}=a.GoalStatus,f=o.Random.getRNG();t.GoalsTop={};class g extends a.GoalBase{constructor(e){super(e),this.setType("GoalTop"),this.evaluators=[]}removeEvaluators(){this.evaluators=[]}removeEvaluatorsByType(e){this.evaluators=this.evaluators.filter(t=>t.getType()!==e)}addEvaluator(e){this.evaluators.push(e)}addEvalByName(e,t){const s=new i.Evaluator[e](t);this.evaluators.push(s)}hasEvalType(e){return this.evaluators.findIndex(t=>t.type===e)>=0}activate(){this.arbitrate()}getEvaluator(e){return this.evaluators.find(t=>t.getType()===e)}process(){this.activateIfInactive();const e=this.processSubGoals();if(e===u||e===d){if(this._debug){const t=a.statusToString(e);this.dbg("process() COMPL/FAILED got status "+t)}return h}return this.removeFinishedOrFailed(),this.dbg("process() got status "+a.statusToString(e)),e}setBias(e){Object.keys(e).forEach(t=>{const s=this.evaluators.find(e=>e.getType()===t);if(s)s.setBias(e[t]);else{const e=this.evaluators.map(e=>e.getType()),s=`Bias ${t} not matching any evaluator: ${e}`;r.default.warn("GoalTop","setBias",s)}})}toJSON(){const e=[];return this.evaluators.forEach(t=>{"Orders"!==t.getType()&&"UseSkill"!==t.getType()&&e.push(t.toJSON())}),{type:this.getType(),evaluators:e}}arbitrate(){this.dbg("arbitrate() started"),this.isActive()||0!==this.evaluators.length||r.default.err("GoalTop","arbitrate",`No evaluators in ${this.getType}, actor: ${this.actor}`);let e=0,t=null;const s=this.evaluators.length;for(let n=0;n<s;n++){const s=this.evaluators[n],r=s.calculateDesirability(this.actor);s.wasLastChosen=!1,(e<r||null===t)&&(t=s,e=r)}t?e!==i.Evaluator.NOT_POSSIBLE&&(t.setActorGoal(this.actor),t.wasLastChosen=!0,t.isOneShot&&this.removeEvaluator(t)):this.isActive()||r.default.err("GoalTop","arbitrate","No next goal found"),this.dbg("arbitrate() finished")}removeEvaluator(e){const t=this.evaluators.indexOf(e);return t>=0&&(this.evaluators.splice(t,1),!0)}}t.GoalTop=g,t.GoalsTop.Top=g;class p extends g{constructor(e){super(e),this.setType("ThinkBasic");const[t,s]=[.75,1.5];this.bias={attack:f.getUniformRange(t,s),explore:r.default.BIAS.Explore,flee:r.default.BIAS.Flee,order:r.default.BIAS.Order,patrol:r.default.BIAS.Patrol},this.updateEvaluators()}updateEvaluators(){this.removeEvaluators(),this.evaluators.push(new i.Evaluator.AttackActor(this.bias.attack)),this.evaluators.push(new i.Evaluator.Flee(this.bias.flee)),this.evaluators.push(new i.Evaluator.Explore(this.bias.explore))}giveOrders(e){this.dbg("Received an order!!"+JSON.stringify(e)),this.addEvaluator(e)}clearOrders(){this.evaluators.filter(e=>e.isOrder()).forEach(e=>{const t=e;t.goal.isActive()&&t.goal.terminate();const s=this.evaluators.indexOf(t);this.evaluators.splice(s,1)})}addGoal(e){const t=e.getType();this.dbg("addGoal() "+t),this.isGoalPresent(t)||(this.removeSubGoalsOfType(t),this.addSubGoal(e),c.enabled&&r.default.log("Actor subgoals are now: "+this.subGoals.map(e=>e.getType())))}}t.ThinkBasic=p,t.GoalsTop.ThinkBasic=p;class m extends p{constructor(e){super(e),this.setType("ThinkSpellcaster"),this.bias.castSpell=1,this.evaluators.push(new i.Evaluator.CastSpell(this.bias.castSpell))}}t.ThinkSpellcaster=m,t.GoalsTop.ThinkSpellcaster=m;class y extends p{constructor(e){super(e),this.setType("ThinkCommander"),this.bias.attack=.1,this.bias.winBattle=.8,this.bias.retreat=.3,this.updateEvaluators()}updateEvaluators(){super.updateEvaluators();const e=new l.EvaluatorsBattle.WinBattle(this.bias.winBattle);this.evaluators.push(e);const t=new l.EvaluatorsBattle.Retreat(this.bias.retreat);this.evaluators.push(t)}}t.ThinkCommander=y,t.GoalsTop.ThinkCommander=y},function(e,t,s){var n=s(283),r=s(284),a=s(285),o=s(286),i=s(287);function l(e){var t=-1,s=null==e?0:e.length;for(this.clear();++t<s;){var n=e[t];this.set(n[0],n[1])}}l.prototype.clear=n,l.prototype.delete=r,l.prototype.get=a,l.prototype.has=o,l.prototype.set=i,e.exports=l},function(e,t,s){var n=s(110);e.exports=function(e,t){for(var s=e.length;s--;)if(n(e[s][0],t))return s;return-1}},function(e,t,s){var n=s(48),r=s(40);e.exports=function(e){if(!r(e))return!1;var t=n(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}},function(e,t,s){var n=s(39)(Object,"create");e.exports=n},function(e,t,s){var n=s(307);e.exports=function(e,t){var s=e.__data__;return n(t)?s["string"==typeof t?"string":"hash"]:s.map}},function(e,t,s){var n=s(158),r=s(159);e.exports=function(e,t,s,a){var o=!s;s||(s={});for(var i=-1,l=t.length;++i<l;){var c=t[i],u=a?a(s[c],e[c],c,s,e):void 0;void 0===u&&(u=e[c]),o?r(s,c,u):n(s,c,u)}return s}},function(e,t,s){var n=s(313),r=s(29),a=Object.prototype,o=a.hasOwnProperty,i=a.propertyIsEnumerable,l=n(function(){return arguments}())?n:function(e){return r(e)&&o.call(e,"callee")&&!i.call(e,"callee")};e.exports=l},function(e,t,s){var n=s(315),r=s(116),a=s(117),o=a&&a.isTypedArray,i=o?r(o):n;e.exports=i},function(e,t){var s=Object.prototype;e.exports=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||s)}},function(e,t,s){var n=s(174),r=s(343)(n);e.exports=r},function(e,t){e.exports=function(e){return e}},function(e,t,s){var n=s(347),r=s(357),a=s(84),o=s(9),i=s(366);e.exports=function(e){return"function"==typeof e?e:null==e?a:"object"==typeof e?o(e)?r(e[0],e[1]):n(e):i(e)}},function(e,t,s){var n=s(125);e.exports=function(e){if("string"==typeof e||n(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}},function(e,t,s){"use strict";(function(t){!t.version||0===t.version.indexOf("v0.")||0===t.version.indexOf("v1.")&&0!==t.version.indexOf("v1.8.")?e.exports={nextTick:function(e,s,n,r){if("function"!=typeof e)throw new TypeError('"callback" argument must be a function');var a,o,i=arguments.length;switch(i){case 0:case 1:return t.nextTick(e);case 2:return t.nextTick((function(){e.call(null,s)}));case 3:return t.nextTick((function(){e.call(null,s,n)}));case 4:return t.nextTick((function(){e.call(null,s,n,r)}));default:for(a=new Array(i-1),o=0;o<a.length;)a[o++]=arguments[o];return t.nextTick((function(){e.apply(null,a)}))}}}:e.exports=t}).call(this,s(31))},function(e,t,s){var n=s(51),r=n.Buffer;function a(e,t){for(var s in e)t[s]=e[s]}function o(e,t,s){return r(e,t,s)}r.from&&r.alloc&&r.allocUnsafe&&r.allocUnsafeSlow?e.exports=n:(a(n,t),t.Buffer=o),a(r,o),o.from=function(e,t,s){if("number"==typeof e)throw new TypeError("Argument must not be a number");return r(e,t,s)},o.alloc=function(e,t,s){if("number"!=typeof e)throw new TypeError("Argument must be a number");var n=r(e);return void 0!==t?"string"==typeof s?n.fill(t,s):n.fill(t):n.fill(0),n},o.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return r(e)},o.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return n.SlowBuffer(e)}},function(e,t,s){"use strict";var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var s=t.shift();if(s){if("object"!=typeof s)throw new TypeError(s+"must be non-object");for(var n in s)r(s,n)&&(e[n]=s[n])}}return e},t.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var a={arraySet:function(e,t,s,n,r){if(t.subarray&&e.subarray)e.set(t.subarray(s,s+n),r);else for(var a=0;a<n;a++)e[r+a]=t[s+a]},flattenChunks:function(e){var t,s,n,r,a,o;for(n=0,t=0,s=e.length;t<s;t++)n+=e[t].length;for(o=new Uint8Array(n),r=0,t=0,s=e.length;t<s;t++)a=e[t],o.set(a,r),r+=a.length;return o}},o={arraySet:function(e,t,s,n,r){for(var a=0;a<n;a++)e[r+a]=t[s+a]},flattenChunks:function(e){return[].concat.apply([],e)}};t.setTyped=function(e){e?(t.Buf8=Uint8Array,t.Buf16=Uint16Array,t.Buf32=Int32Array,t.assign(t,a)):(t.Buf8=Array,t.Buf16=Array,t.Buf32=Array,t.assign(t,o))},t.setTyped(n)},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Castle=void 0;const n=s(1),r=s(52),a=s(213),o=n.Random.getRNG();t.Castle={},t.Castle.corridorDoorThr=.2,t.Castle.tiles={corner:[],term:[],entrance:[],entranceWall:[],corridor:[],corridorWithExit:[],branch:[],storerooms:[],residential:[],crossCenter:[],fillerWall:"",fillerFloor:""},t.Castle.tiles.corner=["\ndir:NW\nname:corner_se\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n......#\nY.....#\n......#\n#######","\ndir:NW\nname:corner_se1\nX=#\nY=#\n\n#X#+#X#\nY.....#\n+.....#\n+...#.#\n+..####\nY...###\n#######","\ndir:NE\nname:corner_sw\nX=.\nY=#\n\n#X...X#\n#.....#\nY......\n#......\nY......\n#.....#\n#######","\ndir:SW\nname:corner_ne\nX=#\nY=.\n\n#X###X#\nY.....#\n......#\n......#\n......#\nY.....#\n#.....#","\ndir:SE\nname:corner_nw\nX=#\nY=#\n\n#X###X#\n#......\nY......\n#......\nY......\n#......\n#.....#"],t.Castle.tiles.term=["\ndir:N\nname:term_n\nX=#\nY=#\n\n#X#+#X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n#######","\ndir:S\nname:term_s\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n###+###","\ndir:E\nname:term_e\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n#.....+\nY.....#\n#.....#\n#######","\ndir:W\nname:term_w\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n+.....#\nY.....#\n#.....#\n#######"],t.Castle.tiles.entrance=["\ndir:NEW\nname:entrance_n\nX=.\nY=#\n\n#X...X#\n##...##\nY##.###\n..#+#..\n.......\nY.....#\n#######","\ndir:SEW\nname:entrance_s\nX=#\nY=#\n\n#X###X#\nY......\n..#.#..\n.##+##.\nY#...##\n#.....#\n##...##","\ndir:NSW\nname:entrance_w\nX=#\nY=#\n\n##X..X#\nY.##..#\n...##.#\n....+.#\n...##.#\nY.##..#\n###...#","\ndir:NSE\nname:entrance_e\nX=#\nY=#\n\n#.X.X##\nY.#..##\n#.##.#.\n#....+.\n#..#.#.\nY.##.##\n#.....#","\ndir:SEW\nname:entrance_ne\nX=#\nY=#\n\n##X#X##\nY.#..##\n..##.#.\n.....+.\n...#.#.\nY.##.##\n#.....#","\ndir:NSW\nname:entrance_nw\nX=#\nY=#\n\n##X#.X#\nY###..#\n.####.#\n.+....#\n.####.#\nY###..#\n###...#","\ndir:NEW\nname:entrance_se\nX=#\nY=#\n\n##X.X##\nY....##\n.....#.\n.....+.\n...#.#.\nY.##.##\n#######","\ndir:NW\nname:entrance_sw\nX=#\nY=#\n\n##X..X#\nY##...#\n.#....#\n.+....#\n.#....#\nY###..#\n#######"],t.Castle.tiles.entranceWall=["\ndir:NEW\nname:entrance_n\nX=.\nY=#\n\n#X...X#\n##...##\nY##.###\n..#+#..\n.......\nY.....#\n##...##","\ndir:SEW\nname:entrance_s\nX=#\nY=#\n\n#X...X#\nY.....#\n..#.#..\n.##+##.\nY#...##\n#.....#\n#.....#","\ndir:NSW\nname:entrance_w\nX=#\nY=#\n\n##X..X#\nY.##..#\n...##.#\n....+.#\n...##.#\nY.##..#\n###...#","\ndir:NSE\nname:entrance_e\nX=.\nY=#\n\n#.#XX##\nY.##.##\n...#.#.\n.....+.\n...#.#.\nY.##.##\n#.....#"],t.Castle.tiles.corridor=["\ndir:NS\nname:corridor_east\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n#.....#","\ndir:NS\nname:corridor_west\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n#.....#","\ndir:EW\nname:corridor_north\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n.......\n#######","\ndir:EW\nname:corridor_south\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n.......\n#######"],t.Castle.tiles.corridorWithExit=["\ndir:NS\nname:corridor_east\nX=.\nY=#\n\n#X...X#\n#.....#\nY#....#\n......#\nY#....#\n#.....#\n#.....#","\ndir:NS\nname:corridor_west\nX=.\nY=#\n\n#X...X#\n#.....#\nY....##\n#......\nY....##\n#.....#\n#.....#","\ndir:EW\nname:corridor_north\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n..#.#..\n###.###","\ndir:EW\nname:corridor_south\nX=#\nY=.\n\n#X#.#X#\n..#.#..\nY......\n.......\nY......\n..#.#..\n#######"],t.Castle.tiles.branch=["\ndir:NSE\nname:corridor_nse\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n#.....+\nY.....#\n#.....#\n#.....#","\ndir:NSW\nname:corridor_nsw\nX=#\nY=#\n\n#X...X#\n#.....#\nY.....#\n+.....#\nY.....#\n#.....#\n##...##","\ndir:NEW\nname:corridor_new\nX=#\nY=.\n\n#X#+#X#\n.......\nY......\n.......\nY......\n.......\n#######","\ndir:SEW\nname:corridor_sew\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n.......\n###+###"],t.Castle.tiles.storerooms=["\ndir:S\nname:storeroom_s\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n#.....#\nY.....#\n###|###\n##..&##","\ndir:N\nname:storeroom_n\nX=#\nY=#\n\n#X&..X#\n###|###\nY.....#\n#.....#\nY.....#\n#######\n#######","\ndir:W\nname:storeroom_w\nX=#\nY=#\n\n##X#X##\nY#.#.##\n.#....#\n.|...##\n&#....#\nY#.#.##\n#######","\ndir:E\nname:storeroom_e\nX=#\nY=#\n\n##X#X##\nY#.#.##\n#....#&\n#....|.\n#....#.\nY..#.##\n#######"],t.Castle.tiles.residential=["\nname:living2x2\nX=#\nY=#\n\n#X+#+X#\n#::#::#\nY::#::#\n#######\nY::#::#\n#::#::#\n##+#+##","\nname:living2x2\ndir:NS\nX=#\nY=#\n\n#X#.#X#\n#:+.+:#\nY:#.#:#\n###.###\nY:#.#:#\n#:+.+:#\n###.###","\nname:living2x2\ndir:NS\nX=#\nY=#\n\n#X#.#X#\nY:#.#:#\n#:+.+:#\n###.###\n#:+.+:#\nY:#.#:#\n###.###","\nname:livingL2S\ndir:S\nX=#\nY=#\n\n#X###X#\n#:::::#\nY:::::#\n###+###\nY:#.#:#\n#:+.+:#\n###.###","\nname:livingL_corner\ndir:NE\nX=#\nY=#\n\n#X#..X#\n#:#+#..\nY:::##.\n#::::#.\nY::::##\n#:::::#\n#######","\nname:living_3dir\ndir:NSE\nX=#\nY=#\n\n#X#.X##\nY:#.#:#\n#:#.#+#\n#:#....\nY:#.###\n#:+.###\n###.###","\nname:living_corner\ndir:NE\nX=#\nY=#\n\n#X#.#X#\n#:#...#\nY:###.#\n#:::+..\nY:::###\n#:::+:#\n#######","\nname:living_corner2\ndir:NE\nX=#\nY=#\n\n#X#.#X#\n#:#...#\nY:###..\n#:::+#.\nY::::##\n#:::::#\n#######"],t.Castle.tiles.crossCenter=["\nname:cross_center1\ndir:NSEW\nX=.\nY=.\n\n#X...X#\n##...##\nY..#...\n..###..\nY..#...\n##...##\n##...##"],t.Castle.tiles.fillerFloor="\nname:FILLER\nX=.\nY=.\n\n.X...X.\nY......\n.......\n.......\n.......\nY......\n.......",t.Castle.tiles.fillerWall="\nname:FILLER\nX=#\nY=#\n\n#X###X#\nY######\n#######\n#######\n#######\nY######\n#######",t.Castle.startFuncs={},t.Castle.startRoomFunc=function(){const e=Math.floor(this.tilesX/2);let t=null,s=0;return o.getUniform()<=.5?t=this.findTemplate({name:"entrance_n"}):(t=this.findTemplate({name:"entrance_s"}),s=this.tilesY-1),{x:e,y:s,room:t}},t.Castle.startRoomFuncNorth=function(){return{x:Math.floor(this.tilesX/2),y:0,room:this.findTemplate({name:"entrance_n"})}},t.Castle.startFuncs.N=t.Castle.startRoomFuncNorth,t.Castle.startRoomFuncSouth=function(){const e=this.tilesY-1;return{x:Math.floor(this.tilesX/2),y:e,room:this.findTemplate({name:"entrance_s"})}},t.Castle.startFuncs.S=t.Castle.startRoomFuncSouth,t.Castle.startRoomFuncWest=function(){return{x:0,y:Math.floor(this.tilesY/2),room:this.findTemplate({name:"entrance_w"})}},t.Castle.startFuncs.W=t.Castle.startRoomFuncWest,t.Castle.startRoomFuncEast=function(){const e=Math.floor(this.tilesY/2);return{x:this.tilesX-1,y:e,room:this.findTemplate({name:"entrance_e"})}},t.Castle.startFuncs.E=t.Castle.startRoomFuncEast,t.Castle.startRoomFuncNorthEast=function(){return{x:this.tilesX-1,y:0,room:this.findTemplate({name:"entrance_ne"})}},t.Castle.startFuncs.NE=t.Castle.startRoomFuncNorthEast,t.Castle.startRoomFuncNorthWest=function(){return{x:0,y:0,room:this.findTemplate({name:"entrance_nw"})}},t.Castle.startFuncs.NW=t.Castle.startRoomFuncNorthWest,t.Castle.startRoomFuncSouthEast=function(){const e=this.tilesY-1;return{x:this.tilesX-1,y:e,room:this.findTemplate({name:"entrance_se"})}},t.Castle.startFuncs.SE=t.Castle.startRoomFuncSouthEast,t.Castle.startRoomFuncSouthWest=function(){return{x:0,y:this.tilesY-1,room:this.findTemplate({name:"entrance_sw"})}},t.Castle.startFuncs.SW=t.Castle.startRoomFuncSouthWest,t.Castle.startFuncTwoGates=function(){const e=Math.floor(this.tilesX/2),t=this.findTemplate({name:"entrance_n"}),s=this.findTemplate({name:"entrance_s"});return this.addRoom(t,e,0),{x:e,y:this.tilesY-1,room:s}},t.Castle.startFuncFourGates=function(){const e=Math.floor(this.tilesX/2),t=Math.floor(this.tilesY/2),s=this.findTemplate({name:"entrance_n"}),n=this.findTemplate({name:"entrance_s"}),r=this.findTemplate({name:"entrance_e"}),a=this.findTemplate({name:"entrance_w"});return this.addRoom(s,e,0),this.addRoom(r,this.tilesX-1,t),this.addRoom(a,0,t),{x:e,y:this.tilesY-1,room:n}},t.Castle.constraintFunc=function(e,s,n){if(0===e&&0===s)return this.findTemplate({name:"corner_nw"});if(0===e&&s===this.tilesY-1)return this.findTemplate({name:"corner_sw"});if(e===this.tilesX-1&&0===s)return this.findTemplate({name:"corner_ne"});if(e===this.tilesX-1&&s===this.tilesY-1)return this.findTemplate({name:"corner_se"});if(0===s){const e=this.findTemplate({name:"corridor_north"}),s=this.findTemplate({name:"corridor_sew"});if(s){if("S"===n)return s;if(o.getUniform()<t.Castle.corridorDoorThr)return s}return e}if(s===this.tilesY-1){const e=this.findTemplate({name:"corridor_south"}),s=this.findTemplate({name:"corridor_new"});if(s){if("N"===n)return s;if(o.getUniform()<t.Castle.corridorDoorThr)return s}return e}if(0===e){const e=this.findTemplate({name:"corridor_west"}),s=this.findTemplate({name:"corridor_nse"});if(s){if("E"===n)return s;if(o.getUniform()<t.Castle.corridorDoorThr)return s}return e}if(e===this.tilesX-1){const e=this.findTemplate({name:"corridor_east"}),s=this.findTemplate({name:"corridor_nsw"});if(s){if("W"===n)return s;if(o.getUniform()<t.Castle.corridorDoorThr)return s}return e}return null},t.Castle.constraintFuncCross=function(e,s,n){const a=t.Castle.constraintFunc.call(this,e,s,n),i=Math.floor(this.tilesX/2),l=Math.floor(this.tilesY/2);if(null===a||e===i||s===l){if(0===e&&s===l)return this.findTemplate({name:"corridor_nse"});if(e===this.tilesX-1&&s===l)return this.findTemplate({name:"corridor_nsw"});if(0===s&&e===i)return this.findTemplate({name:"corridor_sew"});if(s===this.tilesY-1&&e===i)return this.findTemplate({name:"corridor_new"});if(e===i&&s===l){const e=o.arrayGetRand(t.Castle.tiles.crossCenter);return r.Template.createTemplate(e)}if(e===i){if("E"===n)return this.findTemplate({name:"corridor_nse"});if("W"===n)return this.findTemplate({name:"corridor_nsw"});const e=this.findTemplate({name:"corridor_east"}),t=this.findTemplate({name:"corridor_nsw"}),s=this.findTemplate({name:"corridor_west"}),r=this.findTemplate({name:"corridor_nse"});return o.arrayGetRand([e,t,s,r])}if(s===l){if("S"===n)return this.findTemplate({name:"corridor_sew"});if("N"===n)return this.findTemplate({name:"corridor_new"});const e=this.findTemplate({name:"corridor_north"}),t=this.findTemplate({name:"corridor_sew"}),s=this.findTemplate({name:"corridor_south"}),r=this.findTemplate({name:"corridor_new"});return o.arrayGetRand([e,t,s,r])}}return a},t.Castle.roomCount=-1,t.Castle.Models={},t.Castle.Models.full=[].concat(t.Castle.tiles.branch).concat(t.Castle.tiles.corner).concat(t.Castle.tiles.term).concat(t.Castle.tiles.entrance).concat(t.Castle.tiles.corridor).concat(t.Castle.tiles.storerooms).concat(a.Vault.tiles.vault).concat(a.Vault.tiles.corner),t.Castle.Models.residential=t.Castle.tiles.residential.concat(t.Castle.Models.full),t.Castle.Models.outerWall=[].concat(t.Castle.tiles.entranceWall).concat(t.Castle.tiles.corner).concat(t.Castle.tiles.corridor).concat(t.Castle.tiles.corridorWithExit),t.Castle.templates={},t.Castle.templates.all=t.Castle.Models.full.map(e=>r.Template.createTemplate(e));let i=r.Template.transformList(t.Castle.templates.all);t.Castle.templates.all=t.Castle.templates.all.concat(i),t.Castle.templates.livingOnly=t.Castle.tiles.residential.map(e=>r.Template.createTemplate(e)),i=r.Template.transformList(t.Castle.templates.livingOnly),t.Castle.templates.livingOnly=t.Castle.templates.livingOnly.concat(i),t.Castle.templates.residential=t.Castle.templates.livingOnly.concat(t.Castle.templates.all),r.verifyTiles("tiles.castle.ts","Castle.templates.all",t.Castle.templates.all)},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryActor=t.ActorRandomizer=void 0;const i=o(s(0)),l=a(s(56)),c=a(s(15)),u=a(s(6)),h=s(216),d=s(70),f=a(s(2)),g=s(132),p=s(5)("bitn:FactoryActor"),m=(e,t)=>{const{hp:s,att:n,def:r,prot:a}=t;if(!i.default.isNullOrUndef([s])){const t=e.get("Health");t.setHP(s),t.setMaxHP(s)}let o=null;e.has("Combat")?o=e.get("Combat"):(o=new f.Combat,e.add(o)),i.default.isNullOrUndef([n])||o.setAttack(n),i.default.isNullOrUndef([r])||o.setDefense(r),i.default.isNullOrUndef([a])||o.setProtection(a)};class y{adjustActor(e){const t=e.getType();if(h.ActorMods.hasOwnProperty(t)){const{stats:s}=h.ActorMods[t];Object.keys(s).forEach(t=>{const n=i.default.formatSetterName(t),r=i.default.formatGetterName(t),a=e.get("Stats")[r]+s[t];e.get("Stats")[n](a)})}}}t.ActorRandomizer=y;t.FactoryActor=class{constructor(){this._randomizer=new y}dbg(...e){p.enabled&&p(...e)}createPlayer(e,t){const s=new l.SentientActor(e);return s.setIsPlayer(!0),m(s,t),this._randomizer.adjustActor(s),s}createRandomActor(e){return u.getParser().createRandomActor(e)}createActorByName(e){return u.getParser().createActor(e)}createActor(e,t={}){const s=new l.SentientActor(e);s.setType(e);const n=t.brain;if(m(s,t),this._randomizer.adjustActor(s),!i.default.isNullOrUndef([n]))if("object"==typeof n)s.setBrain(n);else{const e=this.createBrain(s,n);s.setBrain(e)}return s}createBrain(e,t){switch(t){case"Flame":return new c.BrainFlame(e);case"GoalOriented":if(i.default.isSentient(e))return new c.BrainGoalOriented(e);i.default.err("RG","createBrain","Can only create GoalOriented for sentient actor");case"NonSentient":return new c.BrainNonSentient(e);case"SpellCaster":return new c.BrainSpellCaster(e);case"Spirit":return new c.BrainSpirit(e);default:if(c[t])return new c[t](e);if(t&&""!==t){let e=`Warning. No brain type ${t} found`;e+="Using the default Brain.BrainSentient instead.",console.warn(e)}return new c.BrainSentient(e)}}createSpell(e){if(d.Spell.hasOwnProperty(e))return new d.Spell[e];{const t=Object.keys(d.Spell).join("\n\t");i.default.err("FactoryActor","createSpell",`No spell ${e} found in Spell: \n\t${t}`)}return null}generateNActors(e,t,s){(!Number.isInteger(s)||s<=0)&&i.default.err("Factory.Actor","generateNActors","maxDanger (> 0) must be given. Got: "+s),s<3&&(s=3);const n=u.getParser(),r=[],a={func:e=>e.danger<=s};for(let o=0;o<e;o++){let e=null;if(e=t?n.createRandomActor({func:e=>t(e)&&e.danger<=s}):n.createRandomActorWeighted(1,s,a),e){const t=n.dbGet({categ:i.default.TYPE_ACTOR,name:e.getName()}),a=s-t.danger;a>1&&i.default.levelUpActor(e,a),r.push(e)}else{let e="Factory Could not meet constraints for actor.";if(e+=" maxDanger: "+s,i.default.diag(e),t.constraint){const e=JSON.stringify(t.constraint);i.default.diag("Used constraints were: "+e)}else t||i.default.diag("No func was given, so used randomWeighted")}}return r}createActorSpawner(e,t,s){const n=new g.SpawnerActor("spawner"),r=n.getBrain();let a=[{op:"lte",prop:"danger",value:e}];return a=a.concat(t),r.setConstraint(a),s&&r.setPlaceConstraint(s),n}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CreateStat=t.LoadStat=void 0,function(e){e.EMPTY="EMPTY",e.LOADED="LOADED",e.JSON="JSON",e.ON_DISK="ON_DISK",e.JSON2LOADED="JSON2LOADED",e.LOADED2JSON="LOADED2JSON",e.JSON2ON_DISK="JSON2ON_DISK",e.ON_DISK2JSON="ON_DISK2JSON"}(t.LoadStat||(t.LoadStat={})),function(e){e.EMPTY="EMPTY",e.CREATED="CREATED",e.POPULATED="POPULATED"}(t.CreateStat||(t.CreateStat={}))},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ACTOR_CLASSES_NO_ADV=t.ACTOR_CLASSES=t.Politician=t.Spiritcrafter=t.Spellsinger=t.Marksman=t.Cryomancer=t.Blademaster=t.Adventurer=t.Alpinist=t.ActorClassBase=t.ActorClass=void 0;const i=o(s(0)),l=s(37),c=a(s(2)),u=s(148),h=s(1),d=s(105),f=s(103),g=s(6),{Abilities:p}=d.Ability,m=h.Random.getRNG();t.ActorClass={},t.ActorClass.create=function(e,s){if(t.ActorClass.hasOwnProperty(e)){return new t.ActorClass[e](s)}return i.default.diag("Called with entity:"),i.default.diag(s),i.default.err("ActorClass","create",`No class ${e} in ActorClass`),null},t.ActorClass.getLevelUpObject=function(e,t){const s=new l.MenuInfoOnly,n=t.getActor(),r=t.getClassName(),a=t.getLevelUpMsg(e),o=`${n.getName()} is now level ${e} ${r}`;return s.addPre(["Congratulations! "+o]),s.addPre(a),s},t.ActorClass.addAbility=function(e,t){let s=null;if(s=t.has("Abilities")?t.get("Abilities").abilities:new p,d.Ability.hasOwnProperty(e)){const t=new d.Ability[e];s.addAbility(t)}else i.default.err("ActorClass","addAbility",`Cannot find Ability.${e} for new`)};t.ActorClass.startingItems={Alpinist:[{name:"Ration",count:1},{name:"rope",count:1},{func:e=>"mineral"===e.type,count:2}],Adventurer:[{name:"Ration",count:2},{name:"firemaking kit",count:1},{func:e=>"potion"===e.type,count:1}],Cryomancer:[{name:"Ration",count:1},{name:"Potion of power",count:1}],Marksman:[{name:"Ration",count:1}],Blademaster:[{name:"Ration",count:1}],Spiritcrafter:[{name:"Ration",count:1},{name:"Ordinary spirit gem"},{name:"Potion of spirit form"}],Spellsinger:[{name:"Ration",count:1},{name:"Potion of eagle",count:1}],Politician:[]};t.ActorClass.equipment={Alpinist:[{name:"Piolet",count:1},{name:"Spiked boots",count:1}],Adventurer:[{name:"Short sword",count:1},{name:"Leather armour",count:1}],Cryomancer:[{name:"Robe",count:1},{name:"Wooden staff",count:1}],Marksman:[{name:"Leather armour",count:1},{name:"Wooden bow",count:1},{name:"Wooden arrow",count:15}],Blademaster:[{name:"Longsword",count:1},{name:"Chain helmet",count:1},{name:"Chain armour",count:1}],Spiritcrafter:[{name:"Robe",count:1},{name:"Mace",count:1}],Spellsinger:[{name:"Iron staff",count:1},{name:"Leather armour",count:1}],Politician:[]},t.ActorClass.getEquipment=function(e){return O(t.ActorClass.equipment[e])},t.ActorClass.getStartingItems=function(e){return O(t.ActorClass.startingItems[e])};class y{constructor(e,t){this._actor=e,e.setActorClass(this),this._className=t}getActor(){return this._actor}getClassName(){return this._className}getLevelUpMsg(e){let t="";return this._messages.hasOwnProperty(e)&&(t+=this._messages[e]),t+="\n"+this._lastStateIncr,t}advanceLevel(){const e=this._actor.get("Experience").getExpLevel();if(this._messages.hasOwnProperty(e)){const t=this._actor.getCell();t&&i.default.gameMsg({cell:t,msg:this._messages[e]})}this._advances.hasOwnProperty(e)&&this._advances[e](),this.incrStats(e)}incrStats(e){const t=this._actor;this._lastStateIncr="";const s=t.get("Health"),n=Math.ceil(t.getStatVal("Strength")/2);if(s.setMaxHP(s.getMaxHP()+n),s.setHP(s.getHP()+n),t.has("SpellPower")){const e=Math.ceil(t.getStatVal("Magic")/2),s=t.get("SpellPower");s.setMaxPP(s.getMaxPP()+e),s.addPP(e)}const r=m.arrayGetRand(i.default.STATS);this._lastStateIncr=r+" was increased",t.get("Stats").incrStat(r,1),i.default.levelUpCombatStats(t,e)}}t.ActorClassBase=y;class _ extends y{constructor(e){super(e,"Alpinist");const s=e.getName();this._messages={4:s+" can climb on difficult terrain now",8:s+" can jump over obstacles such as chasms now",12:s+" can now hide from enemies using terrain"},this._advances={1:()=>{t.ActorClass.addAbility("Camouflage",this._actor)},4:()=>{this._actor.add(new c.Climber)},8:()=>{this._actor.add(new c.Jumper)},12:()=>{},16:()=>{},20:()=>{},24:()=>{},28:()=>{},32:()=>{}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("perception",3),e.incrStat("agility",3),e.incrStat("magic",-2)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("perception",1),this._lastStateIncr+="\nPerception was increased."),e%3!=1&&(t.incrStat("agility",1),this._lastStateIncr+="\nAgility was increased.")}}t.Alpinist=_,t.ActorClass.Alpinist=_;class b extends y{constructor(e){super(e,"Adventurer");const t=e.getName();this._messages={4:"Food is now more nourishing for "+t},this._advances={1:()=>{const e=new u.Spell.SpellBook(this._actor);this._actor.setBook(e)},4:()=>{this._actor.add(new c.NourishedOne)}}}advanceLevel(){super.advanceLevel();const e=this._actor.get("Experience").getExpLevel();if(e%4==0&&!this._advances.hasOwnProperty(e)){const s=m.arrayGetRand(t.ACTOR_CLASSES_NO_ADV),n=new t.ActorClass[s](this.getActor());n.advanceLevel(),this._messages[e]=n._messages[e]}}setStartingStats(){const e=this._actor.get("Stats");for(let t=0;t<3;t++){let t=m.arrayGetRand(i.default.STATS);t=t.toLowerCase(),e.incrStat(t,m.getUniformInt(1,3))}}incrStats(e){super.incrStats(e);const t=m.arrayGetRand(i.default.STATS);this._lastStateIncr+=`\n${t} was increased.`,this._actor.get("Stats").incrStat(t,1)}}t.Adventurer=b,t.ActorClass.Adventurer=b;class v extends y{constructor(e){super(e,"Blademaster");const s=e.getName();this._messages={4:s+" knows now how to defend more skillfully",8:s+" knows now how to hit enemies more accurately",12:s+" knows now how to handle equipment better",16:s+" can now strike in two directions",20:s+" can now keep the weapons sharp",24:s+" can now wield two blades at once",28:s+" can now strike back immediately when attacked",32:s+" has become a True Blademaster"},this._advances={1:()=>{},4:()=>{this._actor.add(new c.Defender)},8:()=>{this._actor.add(new c.Attacker)},12:()=>{this._actor.add(new c.MasterEquipper)},16:()=>{this._actor.add(new c.BiDirStrike)},20:()=>{this._actor.add(new c.Sharpener),t.ActorClass.addAbility("Sharpener",this._actor)},24:()=>{this._actor.add(new c.Ambidexterity)},28:()=>{this._actor.add(new c.CounterAttack)},32:()=>{this._actor.get("Combat").setAttackRange(2),this._actor.add(new c.LongReach)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("strength",3),e.incrStat("magic",-3)}getLevelUpMsg(e){return super.getLevelUpMsg(e)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("strength",1),this._lastStateIncr+="\nStrength was increased."),e%3==0&&(t.incrStat("accuracy",1),this._lastStateIncr+="\nAccuracy was increased.")}}t.Blademaster=v,t.ActorClass.Blademaster=v;class E extends y{constructor(e){super(e,"Cryomancer");const t=e.getName();this._messages={4:t+" learns a protection spell",8:t+" learns a spell to attack enemies from distance",12:t+" can freeze enemies on their tracks",16:t+" can summon an ice companion now",20:t+" can drain power from other spellcasters",24:t+" can fire ice arrows towards enemies",28:t+" can control their enemies now",32:t+" has become a True Cryomancer, Harbinger of Blizzard"},this._advances={1:()=>{const e=new u.Spell.SpellBook(this._actor),t=new u.Spell.GraspOfWinter;e.addSpell(t),this._actor.setBook(e)},4:()=>{this._actor.getBook().addSpell(new u.Spell.IceShield)},8:()=>{this._actor.getBook().addSpell(new u.Spell.FrostBolt)},12:()=>{this._actor.getBook().addSpell(new u.Spell.IcyPrison)},16:()=>{this._actor.getBook().addSpell(new u.Spell.SummonIceMinion)},20:()=>{this._actor.getBook().addSpell(new u.Spell.PowerDrain)},24:()=>{this._actor.getBook().addSpell(new u.Spell.IceArrow)},28:()=>{this._actor.getBook().addSpell(new u.Spell.MindControl)},32:()=>{this._actor.getBook().addSpell(new u.Spell.Blizzard)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("strength",-2),e.incrStat("magic",3)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("magic",1),this._lastStateIncr+="\nMagic was increased."),e%3==0&&(t.incrStat("willpower",1),this._lastStateIncr+="\nWillpower was increased.")}}t.Cryomancer=E,t.ActorClass.Cryomancer=E;class S extends y{constructor(e){super(e,"Marksman");const t=e.getName();this._messages={4:t+" can now see and shoot further",8:t+" deals now more damage with each shot",12:t+" can bypass enemies with ranged attacks",16:t+" can use arrows/bolts interchangeably",20:t+" can shoot even further",24:t+" can evade ranged attacks",28:t+" can shoot enemies critically",32:t+" has become a True Marksman"},this._advances={1:()=>{},4:()=>{this._actor.add(new c.EagleEye)},8:()=>{this._actor.add(new c.StrongShot)},12:()=>{this._actor.add(new c.ThroughShot)},16:()=>{this._actor.add(new c.MixedShot)},20:()=>{this._actor.add(new c.LongRangeShot)},24:()=>{this._actor.add(new c.RangedEvasion)},28:()=>{this._actor.add(new c.CriticalShot)},32:()=>{this._actor.add(new c.DoubleShot)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("accuracy",3),e.incrStat("perception",2),e.incrStat("magic",-3)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("accuracy",1),this._lastStateIncr+="\nAccuracy was increased."),e%3==0&&(t.incrStat("perception",1),this._lastStateIncr+="\nPerception was increased."),e%3==1&&(t.incrStat("agility",1),this._lastStateIncr+="\nAgility was increased.")}}t.Marksman=S,t.ActorClass.Marksman=S;class w extends y{constructor(e){super(e,"Spellsinger");const t=e.getName();this._messages={4:t+" can now summon animals",8:t+" can heal wounds",12:t+" can fly like an eagle",16:t+" can now paralyse enemies",20:t+" can summon lightning on enemies",24:t+" controls powers of the sky",28:t+" can attack enemies in multiple directions",32:t+" has become a Mighty Spellsinger"},this._advances={1:()=>{const e=new u.Spell.SpellBook(this._actor);this._actor.setBook(e),this._actor.getBook().addSpell(new u.Spell.MagicArmor)},4:()=>{this._actor.getBook().addSpell(new u.Spell.SummonAnimal)},8:()=>{this._actor.getBook().addSpell(new u.Spell.Heal)},12:()=>{this._actor.getBook().addSpell(new u.Spell.Flying)},16:()=>{this._actor.getBook().addSpell(new u.Spell.Paralysis)},20:()=>{this._actor.getBook().addSpell(new u.Spell.LightningArrow)},24:()=>{const e=new u.Spell.SummonAirElemental;this._actor.getBook().addSpell(e)},28:()=>{this._actor.getBook().addSpell(new u.Spell.CrossBolt)},32:()=>{this._actor.getBook().addSpell(new u.Spell.RockStorm)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("perception",2),e.incrStat("magic",2)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("magic",1),this._lastStateIncr+="\nMagic was increased."),e%3==0&&(t.incrStat("perception",1),this._lastStateIncr+="\nPerception was increased.")}}t.Spellsinger=w,t.ActorClass.Spellsinger=w;class C extends y{constructor(e){super(e,"Spiritcrafter");const t=e.getName();this._messages={4:t+" can now equip 2 spirit gems",8:t+" learns to project small amounts of energy",12:t+" learns to create protective forcefields",16:t+" can now equip 3 spirit gems",20:t+" can now bind spirit gems to items",24:t+" can take a spirit form now",28:t+" gains new skill",32:t+" has become a Mighty Spiritcrafter"},this._advances={1:()=>{const e=new u.Spell.SpellBook(this._actor);this._actor.setBook(e)},4:()=>{this.getActor().getInvEq().getEquipment().addSlot("spiritgem",new f.EquipSlot("spiritgem"))},8:()=>{this._actor.getBook().addSpell(new u.Spell.EnergyArrow)},12:()=>{this._actor.getBook().addSpell(new u.Spell.ForceField)},16:()=>{this.getActor().getInvEq().getEquipment().addSlot("spiritgem",new f.EquipSlot("spiritgem"))},20:()=>{this._actor.add(new c.SpiritItemCrafter)},24:()=>{this._actor.getBook().addSpell(new u.Spell.SpiritForm)},28:()=>{this._actor.getBook().addSpell(new u.Spell.EnergyStorm)},32:()=>{this.getActor().getInvEq().getEquipment().addSlot("spiritgem",new f.EquipSlot("spiritgem")),this._actor.getBook().addSpell(new u.Spell.RingOfEnergy)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("willpower",4),e.incrStat("magic",2)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("willpower",1),this._lastStateIncr+="\nWillpower was increased."),e%3==0&&(t.incrStat("magic",1),this._lastStateIncr+="\nMagic was increased.")}}t.Spiritcrafter=C,t.ActorClass.Spiritcrafter=C;class T extends y{constructor(e){super(e,"Politician");e.getName();this._messages={},this._advances={1:()=>{t.ActorClass.addAbility("Bribery",this._actor)},4:()=>{},8:()=>{},12:()=>{},16:()=>{},20:()=>{},24:()=>{},28:()=>{},32:()=>{}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("perception",3),e.incrStat("agility",-2),e.incrStat("strength",-3),e.incrStat("willpower",4)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("perception",1),this._lastStateIncr+="\nPerception was increased."),e%3!=1&&(t.incrStat("willpower",1),this._lastStateIncr+="\nWillpower was increased.")}}function O(e){const t=g.ObjectShell.getParser(),s=[];return e.forEach(e=>{if("function"==typeof e){const n=t.createRandomItem(e);s.push({name:n.getName(),count:1})}else if(e.func){const n=t.createRandomItem(e.func);e.count?s.push({name:n.getName(),count:e.count}):s.push({name:n.getName(),count:1})}else s.push(e)}),s}t.Politician=T,t.ActorClass.Politician=T,t.ACTOR_CLASSES=["Cryomancer","Blademaster","Marksman","Spiritcrafter","Adventurer","Alpinist","Spellsinger"],t.ACTOR_CLASSES_NO_ADV=t.ACTOR_CLASSES.filter(e=>"Adventurer"!==e)},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.OW=void 0;const r=n(s(0));t.OW={},t.OW.LL_WE="═",t.OW.LL_NS="║",t.OW.CC_NW="╔",t.OW.CC_NE="╗",t.OW.CC_SW="╚",t.OW.CC_SE="╝",t.OW.XX="╬",t.OW.EMPTY="e",t.OW.TT_W="╠",t.OW.TT_E="╣",t.OW.TT_N="╦",t.OW.TT_S="╩",t.OW.TERM=".",t.OW.WCAPITAL="♔",t.OW.BCAPITAL="♚",t.OW.BTOWER="♜",t.OW.WTOWER="♖",t.OW.WDUNGEON="☖",t.OW.MOUNTAIN="^",t.OW.BVILLAGE="▲",t.OW.WVILLAGE="△",t.OW.VTUNNEL="|",t.OW.HTUNNEL="-",t.OW.MFORT="⟎",t.OW.PROB_BVILLAGE=.25,t.OW.biomeTypeMap={arctic:0,alpine:1,tundra:2,taiga:3,forest:4,grassland:5},t.OW.PATH_WCAP_BTOWER="PATH_WCAP_BTOWER",t.OW.PATH_BEGIN_WCAP="PATH_BEGIN_WCAP";const a=r.default.cellStyles.elements;t.OW.classNames={[t.OW.TERM]:a.floor,[t.OW.MOUNTAIN]:a.highrock,[t.OW.LL_WE]:a.mountain,[t.OW.LL_NS]:a.mountain,[t.OW.CC_NW]:a.mountain,[t.OW.CC_NE]:a.mountain,[t.OW.CC_SW]:a.mountain,[t.OW.CC_SE]:a.mountain,[t.OW.XX]:a.mountain,[t.OW.TT_W]:a.mountain,[t.OW.TT_E]:a.mountain,[t.OW.TT_N]:a.mountain,[t.OW.TT_S]:a.mountain,default:"cell-element-ow"},t.OW.PASSABLE_FORT=[t.OW.WCAPITAL,t.OW.WTOWER,t.OW.BTOWER,t.OW.BCAPITAL],t.OW.BIOME={},t.OW.BIOME.ALPINE="alpine",t.OW.BIOME.ARCTIC="arctic",t.OW.BIOME.TUNDRA="tundra",t.OW.BIOME.TAIGA="taiga",t.OW.ILLEGAL_POS=-1,t.OW.CELL_ANY="OW.CELL_ANY",t.OW.E_HAS_CONN=[t.OW.XX,t.OW.TT_W,t.OW.TT_N,t.OW.TT_S,t.OW.CC_NW,t.OW.CC_SW,t.OW.LL_WE],t.OW.W_HAS_CONN=[t.OW.XX,t.OW.TT_E,t.OW.TT_N,t.OW.TT_S,t.OW.CC_NE,t.OW.CC_SE,t.OW.LL_WE],t.OW.N_HAS_CONN=[t.OW.XX,t.OW.TT_S,t.OW.TT_W,t.OW.TT_E,t.OW.CC_SW,t.OW.CC_SE,t.OW.LL_NS],t.OW.S_HAS_CONN=[t.OW.XX,t.OW.TT_N,t.OW.TT_W,t.OW.TT_E,t.OW.CC_NW,t.OW.CC_NE,t.OW.LL_NS],t.OW.N_BORDER=[t.OW.LL_WE,t.OW.TT_N],t.OW.S_BORDER=[t.OW.LL_WE,t.OW.TT_S],t.OW.E_BORDER=[t.OW.LL_NS,t.OW.TT_E],t.OW.W_BORDER=[t.OW.LL_NS,t.OW.TT_W],t.OW.ALL_WALLS=[t.OW.XX,t.OW.TT_N,t.OW.TT_S,t.OW.TT_E,t.OW.TT_W,t.OW.CC_SW,t.OW.CC_NW,t.OW.CC_SE,t.OW.CC_NE,t.OW.LL_WE,t.OW.LL_NS],t.OW.ALL_WALLS_LUT={},t.OW.ALL_WALLS.forEach(e=>{t.OW.ALL_WALLS_LUT[e]=e}),t.OW.LINE_WE_WEIGHT={[t.OW.LL_WE]:10,[t.OW.TT_N]:3,[t.OW.TT_S]:3,[t.OW.XX]:1},t.OW.LINE_NS_WEIGHT={[t.OW.LL_NS]:10,[t.OW.TT_E]:3,[t.OW.TT_W]:3,[t.OW.XX]:1},t.OW.CAN_CONNECT={[t.OW.LL_WE]:{N:[],S:[],E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.LL_NS]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:[],W:[]},[t.OW.CC_NW]:{N:t.OW.N_HAS_CONN,S:[],E:[],W:t.OW.W_HAS_CONN},[t.OW.CC_NE]:{N:t.OW.N_HAS_CONN,S:[],E:t.OW.E_HAS_CONN,W:[]},[t.OW.CC_SW]:{N:[],S:t.OW.S_HAS_CONN,E:[],W:t.OW.W_HAS_CONN},[t.OW.CC_SE]:{N:[],S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:[]},[t.OW.XX]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.EMPTY]:{N:[],S:[],E:[],W:[]},[t.OW.TT_W]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:[],W:t.OW.W_HAS_CONN},[t.OW.TT_E]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:[]},[t.OW.TT_N]:{N:t.OW.N_HAS_CONN,S:[],E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.TT_S]:{N:[],S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.TERM]:{N:[],S:[],E:[],W:[]}}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorldSimulation=t.WS_EVENT=void 0;const i=o(s(5)).default("bitn:WorldSimulation"),l=o(s(0)),c=s(496),u=s(497),h=a(s(13)),d=s(56),f=s(132);var g;!function(e){e[e.PHASE_CHANGED=0]="PHASE_CHANGED",e[e.DAY_CHANGED=1]="DAY_CHANGED",e[e.MONTH_CHANGED=2]="MONTH_CHANGED",e[e.SEASON_CHANGED=3]="SEASON_CHANGED",e[e.YEAR_CHANGED=4]="YEAR_CHANGED"}(g=t.WS_EVENT||(t.WS_EVENT={}));class p{constructor(e){this.dayMan=new u.DayManager(e),this.seasonMan=new c.SeasonManager(e),this.seasonMan._debug=i.enabled,this.worldEntity=new d.BaseActor("WorldEntity"),this.worldEntity.add(new h.Location),this.updateCount=0}setLevel(e){if(!e)throw new Error("WorldSim: Tried to set null level");this.worldEntity.get("Location").setLevel(e)}getLevel(){return this.worldEntity.get("Location").getLevel()}setOwPos(e){this.seasonMan.setOwPos(e)}update(){if(this.dayMan.update(),this.dayMan.phaseChanged()&&this.processPhaseChanged(),this.dayMan.dayChanged()){this.dbg(this.updateCount,"dayChange detected"),this.seasonMan.update();const e=new h.WorldSimEvent;e.setEventType(g.DAY_CHANGED),this.worldEntity.add(e),this.seasonMan.monthChanged()&&(this.emitMonthChanged(),this.dbg(this.updateCount,"monthChange detected"),this.seasonMan.seasonChanged()&&(this.emitSeasonChanged(),this.seasonMan.yearChanged()&&this.emitYearChanged()))}this.changed("weather")&&(this.seasonMan.resetWeatherChanged(),this.processWeatherChanged()),++this.updateCount}getTimeOfDayMins(){return this.dayMan.getTimeMins()}getSeason(){return this.seasonMan.getSeason()}getWeather(){return this.seasonMan.getWeather()}getTemperature(){return this.seasonMan.getTemperature()}getVisibility(){return this.dayMan.getVisibility()}setUpdateRates(e){this.dayMan.setUpdateRate(e)}setPool(e){this.dayMan.setPool(e),this.seasonMan.setPool(e)}setOverWorld(e){this.seasonMan.setBiomeMap(e.getBiomeMap())}toJSON(){return{dayManager:this.dayMan.toJSON(),seasonManager:this.seasonMan.toJSON(),updateCount:this.updateCount}}toString(){return"Day:    "+this.dayMan.toString()+"\nSeason: "+this.seasonMan.toString()}dbg(...e){if(i.enabled){const t=this.getSeason(),s=this.getTemperature();i(`|${t}, T${s}`,...e)}}emitMonthChanged(){const e=new h.WorldSimEvent;e.setEventType(g.MONTH_CHANGED),e.setEventData({season:this.seasonMan.getSeason()}),this.worldEntity.add(e)}emitSeasonChanged(){const e=new h.WorldSimEvent;e.setEventType(g.SEASON_CHANGED),e.setEventData({season:this.seasonMan.getSeason()}),this.worldEntity.add(e)}emitYearChanged(){const e=new h.WorldSimEvent;e.setEventType(g.YEAR_CHANGED),e.setEventData({season:this.seasonMan.getSeason()}),this.worldEntity.add(e)}changed(e){switch(e){case"day":return this.dayMan.dayChanged();case"month":return this.seasonMan.monthChanged();case"season":return this.seasonMan.seasonChanged();case"year":return this.seasonMan.yearChanged();case"weather":return this.seasonMan.weatherChanged();default:throw new Error("No change for "+e)}return!1}processPhaseChanged(){const e=new h.WorldSimEvent;e.setEventType(g.PHASE_CHANGED);const t=this.dayMan.getPhaseEntry();e.setEventData({currPhase:this.dayMan.getCurrPhase(),entry:t}),this.dbg("updateCount:",this.updateCount,"phaseChange detected",t),this.worldEntity.add(e),this.seasonMan.changeWeather();const s=this.getLevel();s&&s.has("Weather")&&s.get("Weather").setVisibility(this.getVisibility())}processWeatherChanged(){const e=this.getWeather(),t=this.getLevel();if(t){this.dbg(this.updateCount,"weather change detected -> ",e),t.removeAll("Weather");const s=new h.Weather;if(s.setWeatherType(e),s.setTemperature(this.getTemperature()),s.setVisibility(this.getVisibility()),t.getActors().findIndex(e=>"WeatherActor"===e.getName())<0){const e=new f.WeatherActor("WeatherActor");t.addVirtualProp(l.default.TYPE_ACTOR,e)}t.add(s)}}}t.WorldSimulation=p,p.fromJSON=function(e){const t=new p;return t.dayMan=u.DayManager.fromJSON(e.dayManager),t.seasonMan=c.SeasonManager.fromJSON(e.seasonManager),t.updateCount=e.updateCount,t}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.executeCompCb=t.emitZoneEvent=void 0;const i=o(s(0)),l=s(71),c=a(s(2));t.emitZoneEvent=function(e,t,s){const n=e.getParentZone();if(n){const e=new c.ZoneEvent;e.setEventType(t),s&&e.setEventData(s),n.add(e)}i.default.debugZoneEvents};const u=new l.ObjectShellComps({debug:!1});t.executeCompCb=function(e,t){if(t.addComp)if(t.addComp.duration){const s={name:t.addComp.comp,target:e,duration:t.addComp.duration};t.addComp.func&&(s.setters=t.modifyComp.func),t.addComp.expireMsg&&(s.expireMsg=t.addComp.expireMsg);const n=new c.Effects(s);e.add(n)}else u.addComponents(t,e);if(t.removeComp&&t.removeComp.forEach(t=>{e.has(t.comp)&&e.remove(t.comp)}),t.modifyComp){const s={name:t.modifyComp.comp,target:e,get:t.modifyComp.get,set:t.modifyComp.set,value:t.modifyComp.value},n=new c.Effects(s);e.add(n)}if(t.changeElement&&i.default.err("system.on-cb.ts","executeCompCb","changelement not supported yet. Need to write some code"),t.addEntity){const s=e.get("Location");if(s&&s.isValid()){const n={name:t.modifyComp.comp,target:{target:s.getCell()},entityName:t.addEntity.entityName};t.addEntity.duration&&(n.duration=t.addEntity.duration);const r=new c.Effects(n);e.add(r)}else i.default.err("system.on-cb.ts","executeCompCb","In addEntity, no valid location for adding.")}t.addElement&&i.default.err("system.on-cb.ts","executeCompCb","addElement not supported yet. Need to write some code"),t.removeElement&&i.default.err("system.on-cb.ts","executeCompCb","removelement not supported yet. Need to write some code")}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Damage=t.Defense=t.DurationRoll=t.DamageRoll=t.Locatable=t.Typed=t.Mixin=void 0;const r=n(s(0)),a=s(17);t.Mixin={},t.Typed=function(e){return class extends e{constructor(...e){super(...e),this.type=e.length>0?e[0].type:"",this._propType=e.length>0?e[0].propType:""}getPropType(){return this._propType}getType(){return this.type}setPropType(e){r.default.PROP_TYPES.indexOf(e)>=0?this._propType=e:r.default.err("Object.Typed","setPropType","Unknown prop type: |"+e+"|")}setType(e){this.type=e,r.default.nullOrUndefError("Object.Typed: setType","arg |type|",e)}}};t.Locatable=function(e){return class extends e{constructor(...e){super(...e),this._x=null,this._y=null,this._level=null}setX(e){this._x=e}setY(e){this._y=e}getX(){return this._x}getY(){return this._y}isAtXY(e,t){return e===this._x&&t===this._y}getXY(){return[this._x,this._y]}setXY(e,t){this._x=e,this._y=t}getCell(){if(this._level){const[e,t]=[this._x,this._y];return this._level.getMap().getCell(e,t)}return r.default.err("Locatable","getCell","Level is null. This call was most likely a bug"),{}}setLevel(e){this._level=e,r.default.nullOrUndefError("Mixin.Locatable: setLevel","arg |level|",e)}unsetLevel(){this._level?this._level=null:r.default.err("Mixin.Locatable","unsetLevel","Trying to unset already null level.")}getLevel(){return this._level}isLocated(){return null!==this._x&&null!==this._y&&null!==this._level}isSamePos(e){return this._x===e.getX()&&(this._y===e.getY()&&this._level===e.getLevel())}}},t.DamageRoll=e=>class extends e{constructor(e){super(e),this.damageDie=a.Dice.create("1d4")}rollDamage(){if(this.getEntity().hasOwnProperty("getWeapon")){const e=this.getEntity().getWeapon();if(null!==e)return e.rollDamage()}return this.damageDie.roll()}getDamageDie(){return this.damageDie}setDamageDie(e){this.damageDie="string"==typeof e?a.Dice.create(e):e}copy(e){super.copy(e),this.damageDie=e.getDamageDie().clone()}toJSON(){const e=super.toJSON();return e.setDamageDie=this.damageDie.toString(),e}},t.DurationRoll=e=>class extends e{constructor(e){super(e)}rollDuration(){return this.duration.roll()}setDurationDie(e){this.duration="string"==typeof e?a.Dice.create(e):e}getDurationDie(){return this.duration}copy(e){super.copy(e),this.duration=e.getDurationDie().clone()}toJSON(){const e=super.toJSON();return e.setDurationDie=this.duration.toString(),e}},t.Defense=e=>class extends e{constructor(e){super(e),this._attack=1,this._defense=1,this._protection=0}getAttack(){return this._attack}setAttack(e){this._attack=e}getDefense(){return this._defense}setDefense(e){this._defense=e}getProtection(){return this._protection}setProtection(e){this._protection=e}copy(e){super.copy(e),this.setAttack(e.getAttack()),this.setDefense(e.getDefense()),this.setProtection(e.getProtection())}equals(e){let t=super.equals(e);return t&&(t=this.getAttack()===e.getAttack()&&this.getDefense()===e.getDefense()&&this.getProtection()===e.getProtection()),t}toString(){let e=super.toString();return e+=` A: ${this.getAttack()}, D: ${this.getDefense()}, `,e+=` P: ${this.getProtection()}, `,e}toJSON(){const e=super.toJSON();return e.setAttack=this.getAttack(),e.setDefense=this.getDefense(),e.setProtection=this.getProtection(),e}},t.Damage=e=>class extends(t.Defense(e)){constructor(e){super(e),this._damageDie=new a.Dice(1,4,0),this._range=1}setAttackRange(e){this._range=e}getAttackRange(){return this._range}rollDamage(){if(this.hasOwnProperty("getWeapon")){const e=this.getWeapon();if(!r.default.isNullOrUndef([e]))return e.rollDamage()}return this._damageDie.roll()}getDamageDie(){return this._damageDie}setDamageDie(e){this._damageDie=a.Dice.getDice(e)}copy(e){super.copy(e),this.setAttackRange(e.getAttackRange());const t=e.getDamageDie().clone();this.setDamageDie(t)}equals(e){let t=super.equals(e);return t&&(t=this.getDamageDie().equals(e.getDamageDie()),t=t&&this.getAttackRange()===e.getAttackRange()),t}toString(){let e=super.toString();return e+="Dmg: "+this.getDamageDie().toString(),e+=", R:"+this.getAttackRange(),e}toJSON(){const e=super.toJSON();return e.setAttackRange=this.getAttackRange(),e.setDamageDie=this.getDamageDie().toString(),e}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Memory=void 0;const r=n(s(0)),a=[];t.Memory=class{constructor(){this._actors={},this._enemyTypes={},this._communications=[],this._lastAttackedID=null}addEnemyType(e){this._enemyTypes[e]=!0}hasEnemyType(e){return this._enemyTypes[e]}removeEnemyType(e){this._enemyTypes[e]&&delete this._enemyTypes[e]}removeEnemyTypes(){Object.keys(this._enemyTypes).forEach(e=>{this.removeEnemyType(e)})}addEnemyGroup(e){this._actors.enemyGroups||(this._actors.enemyGroups=[]),this._actors.enemyGroups.push(e)}addFriendGroup(e){this._actors.friendGroups||(this._actors.friendGroups=[]),this._actors.friendGroups.push(e)}isEnemy(e){if(this._actors.hasOwnProperty("enemies")){if(this._actors.enemies.indexOf(e)>=0)return!0}if(this._actors.enemyGroups&&e.has("Groups")&&e.get("Groups").hasGroupId(this._actors.enemyGroups))return!0;if(!this.isFriend(e)){if(this._enemyTypes[e.getType()])return!0;if(e.isPlayer())return this._enemyTypes.player}return!1}isFriend(e){if(this._actors.hasOwnProperty("friends")){if(this._actors.friends.indexOf(e)>=0)return!0}return!!(this._actors.friendGroups&&e.has("Groups")&&e.get("Groups").hasGroupId(this._actors.friendGroups))}addFriend(e){this.isEnemy(e)&&this.removeEnemy(e),this._actors.hasOwnProperty("friends")||(this._actors.friends=[]),this.isFriend(e)||this._actors.friends.push(e)}addEnemySeenCell(e){this._actors.seen||(this._actors.seen={}),this._actors.seen[e.getID()]={x:e.getX(),y:e.getY(),level:e.getLevel().getID()}}hasSeen(e){return!(!this._actors.seen||!this._actors.seen[e])}getLastSeen(e){let t=e;return r.default.isActor(e)&&(t=e.getID()),this._actors.seen&&this._actors.seen[t]?this._actors.seen[t]:null}addEnemy(e){if(!r.default.isActor(e)){const t=JSON.stringify(e);r.default.err("Memory","addEnemy","Only actors can be added. Got: "+t)}this.isEnemy(e)||(this.isFriend(e)&&this.removeFriend(e),this._actors.hasOwnProperty("enemies")||(this._actors.enemies=[]),this._actors.enemies.push(e),this._communications.length>0&&(this._communications=[]))}removeEnemy(e){if(this._actors.hasOwnProperty("enemies")){const t=this._actors.enemies.indexOf(e);t>=0&&this._actors.enemies.splice(t,1)}}removeFriend(e){if(this._actors.hasOwnProperty("friends")){const t=this._actors.friends.indexOf(e);t>=0&&this._actors.friends.splice(t,1)}}getEnemyActors(){return this._actors.enemies||a}getFriendActors(){return this._actors.friends||a}copyMemoryFrom(e){const t=e.getBrain().getMemory(),s=t.getEnemyActors().slice();this._actors.enemies=s;const n=t.getFriendActors().slice();this._actors.friends=n,this._enemyTypes=Object.assign({},t._enemyTypes)}addCommunicationWith(e){this.hasCommunicatedWith(e)||this._communications.push(e)}wasLastAttacked(e){return this._lastAttackedID===e.getID()}setLastAttacked(e){this._lastAttackedID=e?e.getID():null}hasCommunicatedWith(e){return-1!==this._communications.indexOf(e)}toJSON(){const e={enemyTypes:Object.keys(this._enemyTypes)};return this._actors.hasOwnProperty("enemies")&&(e.enemies=this._actors.enemies.map(e=>e.getID())),this._actors.hasOwnProperty("friends")&&(e.friends=this._actors.friends.map(e=>e.getID())),this._lastAttackedID>=0&&(e.lastAttackedID=this._lastAttackedID),this._actors.hasOwnProperty("seen")&&(e.seen=this._actors.seen),e}}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BrainPlayer=t.MemoryPlayer=void 0;const i=o(s(0)),l=s(37),c=s(69),u=a(s(145)),h=a(s(266)),d=a(s(13)),f=s(1),g=s(4),p=s(46),m=s(98),y=f.Random.getRNG(),_=c.Keys.KeyMap,{ACTION_ALREADY_DONE:b,ACTION_ZERO_ENERGY:v}=h;class E extends m.Memory{constructor(e){super(),this._lastAttackedID=null,this._player=e}setLastAttacked(e){Number.isInteger(e)?this._lastAttackedID=e:e&&(this._lastAttackedID=e.getID())}getLastAttacked(){return this._lastAttackedID}wasLastAttacked(e){return this._lastAttackedID===e.getID()}isEnemy(e){return!e.isPlayer()&&(!e.has("NonSentient")&&e.getBrain().getMemory().isEnemy(this._player))}toJSON(){const e={};return i.default.isNullOrUndef([this._lastAttackedID])||(e.setLastAttacked=this._lastAttackedID),e}}t.MemoryPlayer=E;class S{constructor(e){this._brain=e,this._targetList=[],this.targetIndex=-1,this._state="S_IDLE"}getActor(){return this._brain._actor}isTargeting(){return"S_TARGETING"===this._state}isLooking(){return"S_LOOKING"===this._state}nextTarget(){this.hasTargets()&&(++this.targetIndex,this.targetIndex>=this._targetList.length&&(this.targetIndex=0),this.setSelectedCells(this._targetList[this.targetIndex]))}prevTarget(){this.hasTargets()&&(--this.targetIndex,this.targetIndex<0&&(this.targetIndex=this._targetList.length-1),this.setSelectedCells(this._targetList[this.targetIndex]))}startLooking(){this._state="S_LOOKING"}stopLooking(){this._state="S_IDLE",this.selectedCells=null}startTargeting(){this._state="S_TARGETING",this._targetList=this.getTargetList(),this.targetIndex=this.getCellIndexToTarget(this._targetList),this.setSelectedCells(this._targetList[this.targetIndex])}cancelTargeting(){this._targetList=[],this._state="S_IDLE",this.selectedCells=null,this.targetIndex=-1}getTargetList(){const e={},t=this._brain.getSeenCells(),s=this._brain._actor;return i.default.findEnemyCellForActor(s,t).forEach(t=>{e[t.getX()+","+t.getY()]=t}),Object.values(e)}setSelectedCells(e){if(e)if(Array.isArray(e))this.selectedCells=e;else{const t=e;if(this.selectedCells=[t],this.isTargeting()){const e=this.getActor(),[s,n]=[t.getX(),t.getY()],[r,a]=[e.getX(),e.getY()],o=g.Geometry.getBresenham(r,a,s,n).map(t=>e.getLevel().getMap().getCell(t[0],t[1]));this.selectedCells=this.selectedCells.concat(o)}}}getSelectedCells(){return this.selectedCells}getTarget(){return(this.isLooking()||this.isTargeting())&&this.selectedCells&&this.selectedCells.length>0?this.selectedCells[0]:this.selectedCells}getTargetCell(){return this.selectedCells.length>0?this.selectedCells[0]:null}getCellIndexToTarget(e){const t=this._brain.getMemory().getLastAttacked();for(let s=0;s<e.length;s++){const n=e[s].getProp("actors");for(let e=0;e<n.length;e++)if(n[e].getID()===t)return s}return 0}selectCell(e){const t=this._brain._actor,s=this._brain.getSeenCells();if(i.default.isNullOrUndef([e]))this.setSelectedCells(t.getCell());else if(e===c.Keys.KEY.SELECT_ALL){const e=p.Brain.findCellsWithFriends(t,s);this.setSelectedCells(e)}else{const n=this.selectedCells[0],r=t.getLevel().getMap(),[a,o]=[n.getX(),n.getY()],[l,c]=_.getDiff(e,a,o);if(r.hasXY(l,c)&&this.setSelectedCells(r.getCell(l,c)),this.isLooking()){const e=this.getTarget(),t=s.indexOf(e);let n="You cannot see there.";if(t>=0){const t=e.getPropNames();n="",t.forEach(e=>{n+=`You see ${e}. `}),i.default.gameMsg(n)}else i.default.gameMsg(n)}}}hasTargetSelected(){return!!this.selectedCells||!!this._targetList&&this.hasTargets()}hasTargets(){return this._targetList.length>0}processKey(e){if(_.isTargetMode(e)){if(this.isTargeting()){const e=this.getTarget();return this.cancelTargeting(),e?this._brain.handleCommand({cmd:"missile",target:e}):(i.default.gameMsg("No valid targets to attack."),this._brain.noAction())}{const e="Press [n/p] for next/prev target. [t] to fire.";return i.default.gameMsg(e),this.startTargeting(),this._brain.noAction()}}return this.isTargeting()?(_.isNextTarget(e)?this.nextTarget():_.isPrevTarget(e)?this.prevTarget():this.cancelTargeting(),this._brain.noAction()):256}isTargetInRange(){const e=this.getTarget(),t=this._brain._actor;if(e&&e.getX){const[s,n]=[e.getX(),e.getY()],[r,a]=[t.getX(),t.getY()],o=g.Geometry.getBresenham(r,a,s,n),l=t.getInvEq().getMissile();if(l){const e=i.default.getMissileRange(t,l);if(o.length-1<=e)return!0}}return!1}}class w{constructor(e){this._brain=e,this._actor=e._actor,this._marks={}}addMark(e){const[t,s]=this._actor.getXY(),n=this._actor.getLevel().getID(),r={id:n,x:t,y:s};e&&(r.tag=e),this._marks[n]||(this._marks[n]=[]),this.markExists(n,t,s)||(this._marks[n].push(r),i.default.gameMsg('Added a mark to the current location. Press "g" to view them'))}getMenu(){const e=this._actor.getLevel().getID(),t=this._marks[e]||[],s=t.map(e=>{const{x:t,y:s}=e,n=this._brain._guiCallbacks.GOTO.bind(null,c.Keys.KEY.GOTO,t,s);return[this.getMarkListMsg(e),n]}),n=t.map(e=>{const{x:t,y:s}=e,n=e.id;return[this.getMarkListMsg(e),this.deleteMark.bind(this,n,t,s)]}),r=new l.MenuWithState;return r.addPre("Choose a mark for travelling:"),r.addItem(c.Keys.KEY.DELETE,["Delete mark",l.Menu.NEXT_STATE]),r.addState("",s),r.addState("DELETE",n),r.addTransition("DELETE",c.Keys.KEY.DELETE),r.addPreState("Choose a mark to delete","DELETE"),r}deleteMark(e,t,s){if(this._marks[e]){const n=this._marks[e].findIndex(n=>n.id===e&&n.x===t&&n.y===s);n>=0&&this._marks[e].splice(n,1)}}getMarkListMsg(e){const{x:t,y:s}=e;let n=`${t}, ${s}`;if(e.tag)n+=" "+e.tag;else{const e=this._actor.getLevel().getMap().getCell(t,s);if(e.hasElements()){if(n+=" "+e.getElements()[0].getName(),e.hasConnection()){const t=e.getConnection().getTargetLevel();if(t){const e=t.getParent();e&&(n+=" - "+e.getName())}}}else e.hasItems()&&(n+=" "+e.getItems()[0].getName())}return n}markExists(e,t,s){return this._marks[e].findIndex(e=>e.x===t&&e.y===s)>=0}toJSON(){return this._marks}fromJSON(e){this._marks=e}}class C extends p.BrainSentient{constructor(e){super(e),this._confirmCallback=null,this._guiCallbacks={},this._type="Player",this._memory=new E(e),this.energy=0,this._confirmCallback=null,this._wantConfirm=!1,this._confirmEnergy=0,this._wantSelection=!1,this._selectionObject=null,this._runModeEnabled=!1,this._fightMode=i.default.FMODE_NORMAL,this._fsm=new S(this),this._markList=new w(this),this._cache={seen:null},this._statBoosts={CombatMods:{setAttack:0,setDefense:0,setProtection:0},StatsMods:{setAccuracy:0,setAgility:0,setMagic:0,setPerception:0,setSpeed:0,setStrength:0,setWillpower:0}}}getType(){return this._type}setType(e){}getActor(){return this._actor}setActor(e){this._actor=e}addGUICallback(e,t){this._guiCallbacks[e]=t}getMemory(){return this._memory}_restoreBaseSpeed(){this._runModeEnabled=!1,this._actor.has("StatsMods")&&this._actor.get("StatsMods").setSpeed(0)}isRunModeEnabled(){return this._runModeEnabled}cmdNotPossible(e){return this.energy=0,i.default.gameWarn(e),v}isMenuShown(){return!!this._selectionObject&&this._selectionObject.showMenu()}getMenu(){return this._selectionObject&&this._selectionObject.showMenu()?this._selectionObject.getMenu():null}noAction(){return v}getFightMode(){return this._fightMode}toggleRunMode(){if(this.energy=0,this._runModeEnabled)this._restoreBaseSpeed();else{this._runModeEnabled=!0;const e=this._actor.get("Stats").getSpeed(),t=Math.floor(.2*e);this._actor.get("StatsMods").setSpeed(t)}}toggleFightMode(){this._fightMode+=1,this._fightMode>=i.default.FMODES.length&&(this._fightMode=i.default.FMODE_NORMAL)}_createBuyConfirmCallback(e){const t=e.getProp("items")[0],s=e.getPropType("shop")[0],n=s.getItemPriceForBuying(t);this._confirmEnergy=0,this._wantConfirm=!0,this._confirmCallback=()=>{const e=new d.Transaction;e.setArgs({item:t,buyer:this._actor,shop:s,seller:s.getShopkeeper()}),this._actor.add(e)},i.default.gameMsg("Press 'y' to buy "+t.getName()+" for "+n+" gold coins")}_setAttackStats(){const e=this._actor.get("Stats"),t=this._actor.get("Combat");let s=0,n=0,r=0;this._fightMode===i.default.FMODE_FAST?(s=Math.round(.2*e.getSpeed()),n=-Math.round(.2*t.getAttack()),n=n<=0?-1:n,r=-1):this._fightMode===i.default.FMODE_SLOW&&(s=-Math.round(.2*e.getSpeed()),n=Math.round(.2*t.getAttack()),n=0===n?1:n,r=2),this._actor.get("StatsMods").setSpeed(s),this._actor.get("CombatMods").setAttack(n),this._actor.get("CombatMods").setDamage(r)}handleCommand(e){switch(this._restoreBaseSpeed(),e.cmd){case"attack":return new h.CmdAttack(this).execute(e);case"craft":return new h.CmdCraft(this).execute(e);case"missile":return new h.CmdMissile(this).execute(e);case"use":return new h.CmdUseItem(this).execute(e);case"drop":return new h.CmdDropItem(this).execute(e);case"equip":return new h.CmdEquipItem(this).execute(e);case"unequip":return new h.CmdUnequipItem(this).execute(e);case"use-element":return new h.CmdUseElement(this).execute(e);default:return()=>{}}}resetBoosts(){this.energy=0;for(const e in this._statBoosts)if(e){const t=this._statBoosts[e];for(const s in t)if(s){const n=t[s];this._actor.has(e)&&this._actor.get(e)[s](n)}}}tryToToggleDoor(){const e=p.Brain.getCellsAroundActor(this._actor).filter(e=>e.hasDoor());if(1===e.length)return this.openDoorFromCell(e[0]);if(e.length>1){const t=y.arrayGetRand(e);return this.openDoorFromCell(t)}return this.cmdNotPossible("There are no doors to open or close")}openDoorFromCell(e){if(e){const t=e.getPropType("door")[0];if(t){const e=new d.OpenDoor;return e.setDoor(t),this._actor.add(e),b}}return this.cmdNotPossible("There are no doors to open or close")}getSeenCells(){if(null===this._cache.seen){let e=this._actor.getLevel().exploreCells(this._actor);if(this._actor.has("Telepathy")){const t=this._actor.getLevel().getID();this._actor.getList("Telepathy").forEach(s=>{const n=s.getTarget(),r=n.getLevel();if(i.default.isActorActive(n)&&r.getID()===t){const t=r.exploreCells(n);e=e.concat(t)}})}this._cache.seen=e}return this._cache.seen}getTargetActor(){const e=this.getTarget();if(Array.isArray(e)){const t=e;if(t.length>0)return t[0].getFirstActor()}else if(e.getFirstActor)return e.getFirstActor();return null}setSelectionObject(e){this._wantSelection=!0,this._selectionObject=e}selectionDone(){this._wantSelection=!1,this._selectionObject=null}decideNextAction(e){if(this._cache.seen=null,e.hasOwnProperty("cmd"))return this.resetBoosts(),this.handleCommand(e);const t=e.code;if(i.default.isNullOrUndef([t])&&i.default.err("Brain.Player","decideNextAction","obj.code or obj.cmd must exist. Got obj: "+JSON.stringify(e)),this._wantConfirm&&null!==this._confirmCallback)return this.processConfirm(t);if(this._wantSelection)return this.processMenuSelection(t);const s=this._fsm.processKey(t);if(256!==s)return s;if(_.isMark(t))return this._markList.addMark(),this.noAction();if(_.isGoto(t))return this.setSelectionObject(this._markList.getMenu()),this.noAction();if(this._guiCallbacks.hasOwnProperty(t))return this._guiCallbacks[t](t);if(_.isRunMode(t))return this.toggleRunMode(),this.noAction();if(_.isFightMode(t))return this.toggleFightMode(),this.noAction();if(_.isIssueOrder(t))return this.issueOrderCmd(),this.noAction();if(_.isLook(t))return this.lookCmd(),this.noAction();if(_.isJump(t))return this.jumpCmd(),this.noAction();if(_.isUseAbility(t))return this.useAbility(),this.noAction();if(_.isGive(t))return this.giveCmd(),this.noAction();const n=this._actor.getLevel();let r=this._actor.getX(),a=this._actor.getY();const o=n.getMap(),l=o.getCell(r,a);if(_.isNextItem(t))return function(e){if(e.hasItems()){const t=e.getItems();let s=t[0].getName();if(t.length>1){const e=t.shift();t.push(e),s=t[0].getName(),i.default.gameMsg("You see now "+s+" on top of the heap.")}else i.default.gameMsg("You see only "+s+" here")}else i.default.gameMsg("There are no items here to look through")}(l),this.noAction();let c="NULL";if(_.inMoveCodeMap(t)){const e=_.getDiff(t,r,a);r=e[0],a=e[1],c="MOVE"}else this._restoreBaseSpeed();if("NULL"===c){if(this.resetBoosts(),_.isRest(t)&&(c="REST"),_.isPickup(t)){if(c="PICKUP",l.hasProp("items")){if(l.hasShop()){return l.getShop().isAbandoned()?(this.energy=i.default.energy.PICKUP,()=>{const e=new d.Pickup;this._actor.add(e)}):(this._createBuyConfirmCallback(l),this.noAction())}return this.energy=i.default.energy.PICKUP,()=>{const e=new d.Pickup;this._actor.add(e)}}return this.cmdNotPossible("There are no items to pick up.")}if(_.isUseStairs(t))return c="STAIRS",l.hasConnection()?()=>{const e=new d.UseStairs;this._actor.add(e)}:this.cmdNotPossible("There are no stairs or passage here.");if(_.isToggleDoor(t))return this.tryToToggleDoor();if(_.isUsePower(t))return this.hasPowers()?(this._wantSelection=!0,this._selectionObject=this._actor.getBook().getSelectionObject(),i.default.gameMsg("Press 0-9 to make a selection.")):i.default.gameMsg("You have no powers to use."),this.noAction();if(_.isChat(t)&&(this._wantSelection=!0,this._selectionObject=(u=this._actor,i.default.gameMsg("Select direction for chatting:"),{select:e=>{const t={dir:_.getDir(e),src:null};return t.dir?(t.src=u,()=>{const e=new d.Chat;e.setArgs(t),u.add(e)}):null},showMenu:()=>!1})),_.isRead(t)){const e=new d.Read;return this._actor.add(e),b}}var u;return"MOVE"===c?this.moveCmd(n,o,r,a):"REST"===c?(this.energy=i.default.energy.REST,this._actor.add(new d.Rest),b):this.noAction()}hasPowers(){return!!this._actor.getBook()}processConfirm(e){return this._wantConfirm=!1,_.isConfirmYes(e)?(this.energy=this._confirmEnergy,this._confirmCallback):(i.default.gameMsg("You cancel the action."),this.noAction())}processMenuSelection(e){if(l.Menu.isMenuItem(this._selectionObject)){this._selectionObject.showMsg&&this._selectionObject.showMsg();const t=this._selectionObject.select(e);if(l.Menu.isSelectionDone(t))return this.selectionDone(),t;if(l.Menu.isMenuItem(t)){this._selectionObject=t;const e=t;return e.funcToCall?(this.selectionDone(),e.funcToCall()):this.noAction()}}return this.selectionDone(),i.default.gameMsg("You cancel the action."),this.noAction()}moveCmd(e,t,s,n){if(!t.hasXY(s,n)){if(this._actor.getCell().hasPassage()){const e=()=>{const e=new d.UseStairs;this._actor.add(e)},t="Press 'y' to move to another area";return this.setWantConfirm(i.default.energy.MOVE,e,t),this.noAction()}{const e="You cannot move there.";return this.cmdNotPossible(e)}}const[r,a]=this._actor.getXY();if(t.isPassable(s,n,r,a))return this.moveToCell(s,n,e);if(t.getCell(s,n).hasClosedDoor())return this.tryToToggleDoor();if(t.getCell(s,n).hasActors()){this._restoreBaseSpeed();const e=function(e,t,s){const n=e.getCell(t,s).getProp("actors");for(let e=0;e<n.length;e++)if(!n[e].has("Ethereal"))return n[e];return null}(t,s,n);null===e&&i.default.err("Brain.Player","decideNextAction","Null target for attack x,y: "+s+","+n);const r=()=>{this._setAttackStats();const t=new d.Attack({target:e});this._actor.add(t)};if(e.isEnemy(this._actor))return this.energy=i.default.energy.ATTACK,r;{const t="Press 'y' to attack non-hostile "+e.getName();return this.setWantConfirm(i.default.energy.ATTACK,r,t),this.noAction()}}if(this._actor.has("Flying")&&t.isPassableByAir(s,n))return this._restoreBaseSpeed(),this.moveToCell(s,n,e);{const e=i.default.getImpassableMsg(this._actor,t.getCell(s,n),"You");return this.cmdNotPossible(e)}}moveToCell(e,t,s){return this._runModeEnabled?this.energy=i.default.energy.RUN:(this.resetBoosts(),this.energy=i.default.energy.MOVE),()=>{const n=new d.Movement(e,t,s);this._actor.add(n)}}setWantConfirm(e,t,s){this._confirmEnergy=e,this._wantConfirm=!0,this._confirmCallback=t,s&&i.default.gameMsg(s)}issueOrderCmd(){const e=[["Follow me",this.giveOrder.bind(this,"Follow")],["Attack enemy",this.giveOrder.bind(this,"Attack")],["Pickup an item",this.giveOrder.bind(this,"Pickup")],["Forget my orders",this.giveOrder.bind(this,"Forget")]],t=new l.Menu.WithQuit(e);t.onQuit=this.cancelTargeting.bind(this);const s=[{key:c.Keys.KEY.SELECT,menu:t}];i.default.gameMsg('Select a target (all with "A"), then press "s" to choose it');const n=new l.Menu.SelectCell(s);n.enableSelectAll(),n.setCallback(this.selectCell.bind(this)),this.setSelectionObject(n),this.selectCell()}lookCmd(){const e=[{key:c.Keys.KEY.SELECT,funcToCall:this.showSelectedCellInfo.bind(this)}];i.default.gameMsg('Select a target with movement keys, then press "s" to choose it');const t=new l.Menu.SelectCell(e);t.setCallback(this.selectCell.bind(this)),this.setSelectionObject(t),this._fsm.startLooking(),this.selectCell()}giveCmd(){const e=new l.Menu.SelectDir;e.setCallback(this.giveCallback.bind(this)),this.setSelectionObject(e),i.default.gameMsg("Please select direction to giving an item:")}giveCallback(e){const[t,s]=i.default.newXYFromDir(e,this._actor),n=this._actor.getLevel().getMap().getCell(t,s);if(n.hasActors()){const e=n.getFirstActor(),t=this._actor.getInvEq().getInventory().getItems().map(t=>[t.toString(),this.giveItemToActor.bind(this,t,e)]),s=new l.Menu.WithQuit(t);s.addPre("Select an item to give:"),this.setSelectionObject(s)}else i.default.gameDanger("There is no one there")}giveItemToActor(e,t){const s=new d.Give;s.setGiveTarget(t),s.setItem(e),this._actor.add(s)}jumpCmd(){const e=new l.Menu.SelectDir;e.setCallback(this.jumpCallback.bind(this)),this.setSelectionObject(e),i.default.gameMsg("Please select direction to jump"),this.energy=i.default.energy.JUMP}jumpCallback(e){const[t,s]=e,n=new d.Jump;n.setX(t),n.setY(s),this._actor.add(n)}giveOrder(e){const t=this.getTarget();t.forEach(s=>{if(s.hasActors()){const t=s.getActors()[0];if(i.default.isSentient(t)){const s=t,n=s.getBrain();if(s&&n.getGoal)switch(e){case"Follow":this.giveFollowOrder(s);break;case"Forget":this.forgetOrders(s);break;case"Attack":this.giveOrderAttack(s);break;case"Pickup":this.giveOrderPickup(s)}}else i.default.gameDanger("This cell has no valid targets")}else 1===t.length&&i.default.gameDanger("This cell has no valid targets")}),this.setSelectedCells(null)}giveFollowOrder(e){const t=e.getName(),s={bias:.7,src:this._actor};u.giveFollowOrder(e,s),i.default.gameMsg(`You tell ${t} to follow you`)}forgetOrders(e){const t={bias:.7,src:this._actor};u.giveClearOrders(e,t),i.default.gameMsg(`You tell ${name} to forget your orders`)}giveOrderAttack(e){const t=this.getSeenCells(),s=i.default.findEnemyCellForActor(this._actor,t);if(0===s.length)return void i.default.gameMsg("There are no enemies around.");const n=s[this.getCellIndexToTarget(s)];if(n){const t=e.getName(),s=n.getActors()[0],r=s.getName(),a={bias:this.getOrderBias(),enemy:s,src:this._actor};u.giveAttackOrder(e,a),i.default.gameMsg(`You tell ${t} to attack ${r}`)}else i.default.gameMsg("There are no enemies around.")}giveOrderPickup(e){const t=this.getItemInSight(),s=e.getName();if(t){const n=t.getName(),r={bias:this.getOrderBias(),item:t,src:this._actor};u.givePickupOrder(e,r),i.default.gameMsg(`You tell ${s} to pickup ${n}`)}else i.default.gameMsg(`There are no items for ${s} to pickup`)}getOrderBias(){return this._actor.has("Leader")?1:this._actor.has("Commander")?1.5:.7}useAbility(){if(this._actor.has("Abilities")){const e=this._actor.get("Abilities").createMenu();this.setSelectionObject(e)}else i.default.gameMsg("You have no abilities to use")}addMark(e){this._markList.addMark(e)}getItemInSight(){const e=this.getSeenCells().filter(e=>e.hasItems());if(e.length>0){return y.arrayGetRand(e).getItems()[0]}return null}toJSON(){return{type:this.getType(),memory:this._memory.toJSON(),markList:this._markList.toJSON()}}addEnemy(){}addFriend(){}hasTargetSelected(){return this._fsm.hasTargetSelected()}startTargeting(){this._fsm.startTargeting()}nextTarget(){this._fsm.nextTarget()}getTargetList(){return this._fsm.getTargetList()}getSelectedCells(){return this._fsm.getSelectedCells()}prevTarget(){this._fsm.prevTarget()}getTarget(){return this._fsm.getTarget()}isTargetInRange(){return this._fsm.isTargetInRange()}cancelTargeting(){this._fsm.cancelTargeting()}isTargeting(){return this._fsm.isTargeting()}getCellIndexToTarget(e){return this._fsm.getCellIndexToTarget(e)}setSelectedCells(e){e?this._fsm.setSelectedCells(e):this.cancelTargeting()}selectCell(e){this._fsm.selectCell(e)}showSelectedCellInfo(){this._fsm.stopLooking()}}t.BrainPlayer=C},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.BrainWeather=void 0;const o=s(46),i=s(68),l=a(s(13));class c extends i.BrainBase{constructor(e){super(e),this.setType("Weather"),this.updateFreq=10}decideNextAction(e){--this.updateFreq;const t=this._actor.getLevel();if(0===this.updateFreq&&t.has("Weather")){const e=t.get("Weather"),s=e.getWeatherType(),n=new l.WeatherEffect;n.setEffectType(s),n.setTemperature(e.getTemperature()),this._actor.add(n),this.updateFreq=10}return o.ACTION_ALREADY_DONE}}t.BrainWeather=c},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameObject=void 0;class n{constructor(){this.$objID=n.ID++}static deref(e){return e?e.value:null}static createObjectID(){return n.ID++}static getProtoName(e){return Object.getPrototypeOf(e).constructor.name}static isPrimitive(e){return"object"!=typeof e}getID(){return this.$objID}setID(e){this.$objID=e}getObjRef(){return{$objRef:{type:"object",id:this.$objID}}}getRefAndVal(){const e=this.getObjRef();return e.value=this,e}}t.GameObject=n,n.ID=1},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OnRemoveCb=t.OnAddCb=void 0;const n=s(16).Component.TransientDataComponent;t.OnAddCb=n("OnAddCb",{compName:"",comp:null}),t.OnRemoveCb=n("OnRemoveCb",{compName:"",comp:null})},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Equipment=t.EquipSlot=void 0;const r=n(s(0));class a{constructor(e,t){this._type=e,this._item=null,this._hasItem=!1,this._unequipped=null,this._stacked=!1,this._reduceFactor=.5,r.default.isNullOrUndef([t])||(this._stacked=t)}isStacked(){return this._stacked}getWeight(){if(!this._hasItem)return 0;let e=this._item.getWeight()*this._item.getCount();return"hand"!==this._type&&"missile"!==this._type&&(e*=this._reduceFactor),e}getUnequipped(){return this._unequipped}getItem(){return this._hasItem?this._item:null}hasItem(){return this._hasItem}equipItem(e,t){return!!this.canEquip(e)&&(this._stacked&&this._hasItem?r.default.addStackedItems(this._item,e)&&(this._hasItem=!0):(e.setOwner(this),t&&e.setOwner(t),this._item=e,this._hasItem=!0),this._hasItem)}unequipItem(e){if(this._hasItem){if(!this._stacked)return this._hasItem=!1,this._unequipped=this._item,!0;if(e>0)return 1===e&&1===this._item.getCount()||e===this._item.getCount()?(this._hasItem=!1,this._unequipped=this._item):this._unequipped=r.default.removeStackedItems(this._item,e),!0}return!1}canEquip(e){return!this._hasItem||!!this._stacked&&e.equals(this._item)}}t.EquipSlot=a;const o=["getDefense","getAttack","getProtection","getSpeed"].concat(r.default.GET_STATS);class i{constructor(e){this._actor=e,this.equipReduceWeightFactor=1,this._slots={[r.default.EQUIP.HEAD]:new a(r.default.EQUIP.HEAD),[r.default.EQUIP.NECK]:new a(r.default.EQUIP.NECK),[r.default.EQUIP.CLOAK]:new a(r.default.EQUIP.CLOAK),[r.default.EQUIP.CHEST]:new a(r.default.EQUIP.CHEST),[r.default.EQUIP.HAND]:new a(r.default.EQUIP.HAND),[r.default.EQUIP.SHIELD]:new a(r.default.EQUIP.SHIELD),[r.default.EQUIP.LEGS]:new a(r.default.EQUIP.LEGS),[r.default.EQUIP.FEET]:new a(r.default.EQUIP.FEET),[r.default.EQUIP.MISSILE]:new a(r.default.EQUIP.MISSILE,!0),[r.default.EQUIP.MISSILEWEAPON]:new a(r.default.EQUIP.MISSILEWEAPON),[r.default.EQUIP.SPIRITGEM]:new a(r.default.EQUIP.SPIRITGEM)}}addSlot(e,t){if(this._hasSlot(e))if(Array.isArray(this._slots[e]))this._slots[e].push(t);else{const s=[this._slots[e]];s.push(t),this._slots[e]=s}else this._slots[e]=t}getWeight(){let e=0;return Object.values(this._slots).forEach(t=>{e+=t.getWeight()}),e*=this.equipReduceWeightFactor,this._actor.has("MasterEquipper")&&(e*=this._actor.get("MasterEquipper").getFactor()),e}getNumSlots(e){return this._hasSlot(e)?Array.isArray(this._slots[e])?this._slots[e].length:1:0}getSlotTypes(){return Object.keys(this._slots)}getFreeSlotTypes(){const e=[];return this.getSlotTypes().forEach(t=>{if(Array.isArray(this._slots[t])){this._slots[t][0].hasItem()||e.push(t)}else this._slots[t].hasItem()||e.push(t)}),e}getItems(e){return e&&this._hasSlot(e)?Array.isArray(this._slots[e])?this._slots[e]:[this._slots[e]]:this.getEquippedItems()}getUnequipped(e,t){if(this._hasSlot(e)){const s=this._slots[e];if(!Array.isArray(s))return this._slots[e].getUnequipped();if("number"==typeof t)return s[t].getUnequipped();r.default.err("Equipment","getUnequipped",`No slot index for slotType ${e} given!`)}else r.default.err("Equipment","getUnequipped","No slot type: "+e);return null}getItem(e){if(this._hasSlot(e)){const t=this._slots[e];return Array.isArray(t)?t.map(e=>e.getItem()):this._slots[e].getItem()}return null}equipItem(e){let t=!1;if(e.getArmourType)t=this._equipToSlotType(e.getArmourType(),e);else if(/^(missile|ammo)$/.test(e.getType())){this._slots.missile.equipItem(e)&&(t=!0)}else t="missileweapon"===e.getType()?this._equipToSlotType(r.default.EQUIP.MISSILEWEAPON,e):this._equipToSlotType(r.default.EQUIP.HAND,e);return t}_equipToSlotType(e,t){const s=this._slots[e];if(Array.isArray(s)){for(let e=0;e<s.length;e++)if(s[e].equipItem(t,this._actor))return!0}else if(s.equipItem(t,this._actor))return!0;return!1}isEquipped(e){return-1!==this.getItems().indexOf(e)}getEquipped(e){return this.getItem(e)}getEquippedItems(){const e=[];return Object.values(this._slots).forEach(t=>{Array.isArray(t)?t.forEach(t=>{t.hasItem()&&e.push(t.getItem())}):t.hasItem()&&e.push(t.getItem())}),e}unequipItem(e,t,s){if(this._hasSlot(e)){const n=this._slots[e];if(!Array.isArray(n))return this._slots[e].unequipItem(t);if("number"==typeof s&&s>=0){if(n[s].unequipItem(t))return!0}else for(let e=0;e<n.length;e++)if(n[e].unequipItem(t))return!0}else{const t="Non-existing slot type "+e;r.default.err("Equipment","unequipItem",t)}return!1}toJSON(){const e=[],t=this.getEquippedItems();for(let s=0;s<t.length;s++)e.push(t[s].toJSON());return e}propertySum(e){let t=0;return Object.keys(this._slots).forEach(s=>{let n=this._slots[s];Array.isArray(n)||(n=[n]),n.forEach(s=>{const n=s.getItem();t+=r.default.getItemStat(e,n)})}),t}_hasSlot(e){return this._slots.hasOwnProperty(e)}}t.Equipment=i;for(let e=0;e<o.length;e++)i.prototype[o[e]]=function(){return this.propertySum(o[e])}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(269);t.default=class{constructor(){this._queue=new n.EventQueue,this._repeat=[],this._current=null,this.traceIDs={},this.debugEnabled=!1}setTraceID(e){this.traceIDs[e]=!0,this.debugEnabled=!0}getTime(){return this._queue.getTime()}add(e,t){return t&&this._repeat.push(e),this}clear(){return this._queue.clear(),this._repeat=[],this._current=null,this}remove(e){let t=!1;const s=this._repeat.indexOf(e);return-1!==s&&this._repeat.splice(s,1),this._current===e?(this._current=null,t=!0):t=this._queue.remove(e),t}next(){return this._current=this._queue.get(),this._current}}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.addAllAbilities=t.Abilities=t.Bribery=t.Sharpener=t.Item=t.Area=t.Direction=t.Camouflage=t.AbilityBase=t.Ability=void 0;const i=o(s(0)),l=s(1),c=s(4),u=a(s(37)),h=a(s(13)),d=l.Random.getRNG();t.Ability={};class f{constructor(e){this.name=e}getName(){return this.name}getMenuItem(){return[this.getName(),this.activate.bind(this)]}activate(e){const t=this.getName();i.default.err("Ability.Base","activate",`${t} should implement activate(), given obj ${e}`)}}t.AbilityBase=f,t.Ability.Base=f;class g extends f{constructor(e){super("Camouflage")}activate(){this.actor.add(new h.Camouflage)}}t.Camouflage=g,t.Ability.Camouflage=g;class p extends f{constructor(e){super(e)}getMenuItem(){return[this.getName(),new u.MenuSelectDir([])]}}t.Direction=p;class m extends f{constructor(e){super(e),this.range=1}activate(e){}getCells(){const[e,t]=this.actor.getXY(),s=this.actor.getLevel().getMap(),n=c.Geometry.getBoxAround(e,t,this.range);return s.getCellsWithCoord(n)}getMenuItem(){const e=this.getCells();return[this.getName(),this.activate.bind(this,e)]}}t.Area=m,t.Ability.Area=m;class y extends f{constructor(e){super(e)}activate(e){const t=JSON.stringify(e);i.default.err("Ability.Item","activate","Not impl. in base class. Called with: "+t)}getMenuItem(){const e=this.actor.getInvEq().getInventory().getItems().map(e=>[e.toString(),this.activate.bind(this,e)]),t=new u.MenuWithQuit(e);return t.addPre("Select an item to sharpen:"),[this.getName(),t]}}t.Item=y,t.Ability.Item=y;class _ extends t.Ability.Item{constructor(){super("Sharpener")}activate(e){const t=e.getName();if(e.has("Sharpened"))i.default.gameMsg(t+" has already been sharpened");else if(e.getDamageDie){e.add(new h.Sharpened);const s=d.getUniformInt(1,3),n=e.getDamageDie();n.setMod(n.getMod()+s),e.setValue(e.getValue()+10*s),i.default.gameMsg("You sharpen "+t)}else i.default.gameMsg("It's useless to sharpen "+t)}}t.Sharpener=_,t.Ability.Sharpener=_;class b extends p{constructor(){super("Bribery")}getMenuItem(){const e=super.getMenuItem(),t=new u.MenuConfirm([]);return e[1].returnMenu=t,t.onSelectCallback=e=>{const s=function(e,t){const[s,n]=i.default.newXYFromDir(e,t),r=t.getLevel().getMap().getCell(s,n);if(r.hasActors())return r.getFirstActor();return null}(e,this.actor);t.callback=()=>{s&&this.bribeActor(s)};const n=`Bribing ${s.getName()} will cost 1.`+" "+t.msg;i.default.gameMsg(n),t.setMsg(n)},i.default.gameMsg("Select a direction for bribing an actor:"),e}bribeActor(e){const t=this.actor.getName();let s=`${e.getName()} seems to be friendly towards ${t}.`;e.isEnemy(this.actor)?(s=`${e.getName()} seems not to be hostile anymore towards ${t}.`,e.removeEnemyType("player"),e.removeEnemy(this.actor)):e.addFriend(this.actor);const n=this.actor.getCell();i.default.gameMsg({cell:n,msg:s})}}t.Bribery=b,t.Ability.Bribery=b;class v{constructor(e){this.actor=e,this.abilities={}}getMenu(){const e=Object.values(this.abilities).map(e=>e.getMenuItem());this.actor.useFuncs&&this.actor.useFuncs.forEach((t,s)=>{const n=this.actor.get("UseEffects").getEffects();e.push(this.getMenuItemForUseFunc(t,n[s]))});const t=new u.MenuWithQuit(e);return t.setName("MenuAbilities"),t.addPre("Select an ability to use:"),t}addAbility(e){this.abilities[e.getName()]=e,e.actor=this.actor}getMenuItemForUseFunc(e,t){const s=new u.MenuSelectDir([]);return s.setCallback(t=>{const[s,n]=i.default.newXYFromDir(t,this.actor),r=this.actor.getLevel().getMap().getCell(s,n);e.call(this.actor,{target:r})}),[this.getEffName(t),s]}getEffName(e){for(const t in e)if(e[t].name)return e[t].name;return"<ERROR: No effect name given >"}toJSON(){return Object.keys(this.abilities)}}t.Abilities=v,t.Ability.Abilities=v;const E=["Bribery","Camouflage","Sharpener"];function S(e){const s=e.get("Abilities");s&&E.forEach(e=>{const n=new t.Ability[e];s.addAbility(n)})}t.addAllAbilities=S,t.Ability.addAllAbilities=S},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ChatWizard=t.ChatTrainer=t.ChatQuest=t.ChatBase=t.Chat=void 0;const i=o(s(0)),l=s(69),c=a(s(37)),u=a(s(26)),h=a(s(107));t.Chat={};const d=i.default.STATS,f=c.Menu.EXIT_MENU,g="Say goodbye";t.Chat.TOP_MENU="TOP_MENU",t.Chat.tradeGoldWeightFromTo=(e,t,s)=>{const n=i.default.getGoldInCoins(e),r=new u.GoldCoin,a=i.default.removeNCoins(t,n);r.setCount(a),s.getInvEq().addItem(r)};class p{constructor(){this.options=[],this.parent=null,this.name=""}setName(e){this.name=e}getName(){return this.name}add({name:e,option:t}){this.options.push({name:e,option:t}),t&&t.setParent&&t.setParent(this)}clearOptions(){this.options=[]}setParent(e){this.parent=e}getParent(){return this.parent}getSelectionObject(){return{showMenu:()=>!0,getMenu:()=>{const e={pre:[],post:[]};return this.options.forEach((t,s)=>{e[l.Keys.menuIndices[s]]=t.name}),this.pre&&(e.pre=this.pre),this.post&&(e.post=this.post),b(e),e},select:e=>{const t=l.Keys.codeToIndex(e);if(t<this.options.length){const e=this.options[t].option;return e!==f&&e.getSelectionObject?e.getSelectionObject():e}return f}}}}t.ChatBase=p,t.Chat.ChatBase=p;class m extends p{constructor(){super();const e={name:"Accept the quest",option:this.questCallback.bind(this)},t={name:"Refuse the quest",option:f};this.add(e),this.add(t)}setQuestGiver(e){this.questGiver=e}setTarget(e){const t=this.questGiver;this.chatter=e;const s=this.questGiver.get("QuestGiver");if(s.getHasGivenQuest()){this.pre=[t.getName()+" has already given this quest:",""+s.getDescr(),"What do you want to do?"],this.clearOptions();const e={name:"Claim the reward",option:this.rewardCallback.bind(this)};this.add(e)}else this.pre=[t.getName()+" wants to offer a lengthy quest:",""+s.getDescr(),"What do you want to do?"]}questCallback(){i.default.isNullOrUndef([this.chatter,this.questGiver])&&i.default.err("ChatQuest","questCallback","target and questGiver must be defined");const e=new h.GiveQuest;e.setTarget(this.chatter),e.setGiver(this.questGiver),this.chatter.add(e)}rewardCallback(){const e=new h.QuestCompleted;e.setGiver(this.questGiver),this.chatter.add(e)}}t.ChatQuest=m,t.Chat.Quest=m;class y extends p{constructor(){super(),this.selectionObject={showMenu:()=>!0,getMenu:()=>{const e=l.Keys.menuIndices.slice(0,d.length),t={pre:["Please select a stat to train:"]};return d.forEach((s,n)=>{t[e[n]]=d[n],t[e[n]]+=` (${this.costs[n]} gold)`}),b(t),t},select:e=>{const t=l.Keys.codeToIndex(e);if(t<d.length){const e=d[t],s=this.costs[t];return this.trainCallback(e,s)}return f}},this.trainCallback=this.trainCallback.bind(this)}setTrainer(e){this.trainer=e}setTarget(e){this.chatter=e,this.costs=[],d.forEach(t=>{const s="get"+t;this.costs.push(100*e.get("Stats")[s]())})}getSelectionObject(){return this.selectionObject}trainCallback(e,s){return()=>{const n=i.default.valueToGoldWeight(s),r=this.chatter.getName();if(!i.default.hasEnoughGold(this.chatter,n)){const e=r+" does not have enough gold.";return void i.default.gameMsg({cell:this.chatter.getCell(),msg:e})}t.Chat.tradeGoldWeightFromTo(n,this.chatter,this.trainer);const a=this.chatter.get("Stats"),o=this.trainer.get("Stats"),l="get"+e,c="set"+e,u=a[l](),h=o[l](),d=this.trainer.getName();if(u<h){const t=u+1;a[c](t);const s=`${d} trains ${e} of ${r}`;i.default.gameMsg({cell:this.chatter.getCell(),msg:s})}else{const e=d+" doesn't have skill to train that stat";i.default.gameMsg({cell:this.chatter.getCell(),msg:e})}}}}t.ChatTrainer=y,t.Chat.Trainer=y;class _ extends p{constructor(){super(),this.costs={0:10,1:45,2:50},this.selectionObject={showMenu:()=>!0,getMenu:()=>{i.default.gameMsg("Please select a magical service to buy:");const e=this.wizard.get("SpellPower").getPP(),t={};e>=10&&(t[0]="Restore 10pp - 10 gold coins"),e>=50&&(t[1]="Restore 50pp - 45 gold coins"),e>=25&&(t[2]="Add one charge to rune - 50 gold coins")},select:e=>{const t=l.Keys.codeToIndex(e);return this.wizardCallback(t)}},this.wizardCallback=this.wizardCallback.bind(this)}setWizard(e){this.wizard=e}getSelectionObject(){return this.selectionObject}wizardCallback(e){const t=this.costs[e];return()=>{if(i.default.hasEnoughGold(this.chatter,t))switch(e){case 0:this.restorePP(10);break;case 1:this.restorePP(50);break;case 2:this.setRuneSelectionObject()}}}restorePP(e){this.wizard.get("SpellPower").decrPP(e);this.chatter.get("SpellPower").addPP(e)}setRuneSelectionObject(){this.chatter.getBrain().setSelectionObject({})}}t.ChatWizard=_,t.Chat.Wizard=_;function b(e){e.Q=g}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getQuestVerb=t.QuestTargetEvent=t.GiveQuest=t.QuestCompleted=t.QuestReport=t.QuestInfo=t.Quest=t.QuestEscortTarget=t.QuestTarget=t.QuestGiver=void 0;const r=n(s(0)),a=s(106),o=s(16),i=o.Component.UniqueDataComponent,l=o.Component.DataComponent,c=o.Component.TransientDataComponent,u=o.ComponentBase.prototype;function h(e){const t=e.toLowerCase();switch(t){case"location":return"Find location";case"reportlisten":return"Talk to";case"report":return"Report info to";case"give":return"Give item to";case"explore":return"Explore";case"get":return"Find item";case"listen":return"Get info from";case"winbattle":return"Defeat enemy army in";case"finishbattle":return"Fight battle until end in";case"kill":return"Kill";case"read":return"Read";case"damage":return"Do some damage to";default:return console.log("getQuestVerb ret default for",e),t.toUpperCase()}}t.QuestGiver=i("QuestGiver",{hasGivenQuest:!1,descr:"",questID:-1,danger:1,reward:-1,hasGivenReward:!1,questTargets:null}),t.QuestGiver.prototype._init=function(e){this.chatObj=new a.ChatQuest,this.descr=e,this.questID=this.getID(),this.questTargets=[];this.addCallback("onAdd",()=>{this.chatObj.setQuestGiver(this.getEntity())})},t.QuestGiver.prototype.hasReward=function(){return this.reward&&-1!==this.reward},t.QuestGiver.prototype.giveQuest=function(e){e?(this.questGivenTo=e,this.hasGivenQuest=!0):this.hasGivenQuest=!1},t.QuestGiver.prototype.numTargets=function(){return this.questTargets.length},t.QuestGiver.prototype.addTarget=function(e,t){t||r.default.err("QuestGiver","addTarget","No target given. Type "+e);const s=r.default.getNameForQuest(t);if(r.default.isEmpty(s))r.default.err("QuestGiver","addTarget","Empty name got for target "+JSON.stringify(t));else{const n={id:t.getID(),name:s,targetType:e,subQuestID:-1},r=t.get("QuestTarget");-1!==r.getSubQuestID()&&(n.subQuestID=r.getSubQuestID()),this.questTargets.push(n)}},t.QuestGiver.prototype.toJSON=function(){const e=u.toJSON.call(this);return this.questGivenTo&&(e.giveQuest=r.default.getObjRef("entity",this.questGivenTo)),e},t.QuestGiver.prototype.getChatObj=function(){return this.chatObj},t.QuestTarget=l("QuestTarget",{targetType:"",target:null,isCompleted:!1,targetID:-1,questID:-1,subQuestID:-1}),t.QuestTarget.prototype.isKill=function(){return"kill"===this.targetType},t.QuestTarget.prototype.toString=function(){let e="";if(this.target.getName)e=this.target.getName();else if(this.target.getParent){const t=this.target.getParent();if(t&&(e=t.getName()),t.getParent){e+=" of "+t.getParent().getName()}}return`${this.targetType} ${e}`},t.QuestTarget.prototype.toJSON=function(){const e=u.toJSON.call(this);return e.setTargetType=this.targetType,this.target.$objID?e.setTarget=r.default.getObjRef("object",this.target):e.setTarget=r.default.getObjRef("entity",this.target),e},t.QuestEscortTarget=l("QuestEscortTarget",{escortTo:-1,question:"Can I help you safely somewhere?"}),t.QuestEscortTarget.prototype.toJSON=function(){const e=u.toJSON.call(this);return e.setEscortTo=r.default.getObjRef("entity",this.escortTo),e},t.Quest=l("Quest",{giver:null,questTargets:null,questID:-1,descr:""}),t.Quest.prototype._init=function(){this.questTargets=[]},t.Quest.prototype.addTarget=function(e){this.questTargets.push(e)},t.Quest.prototype.isInThisQuest=function(e){return this.getQuestID()===e.getQuestID()},t.Quest.prototype.getTargetsByType=function(e){return this.questTargets.filter(t=>t.targetType===e)},t.Quest.prototype.first=function(e){const t=this.questTargets.find(t=>t.targetType===e);return t||null},t.Quest.prototype.isCompleted=function(){return this.questTargets.reduce((e,t)=>e&&t.isCompleted,!0)},t.Quest.prototype.isTargetInQuest=function(e){const t=e.getTarget();for(let e=0;e<this.questTargets.length;e++){if(this.questTargets[e].id===t.getID())return!0}return!1},t.Quest.prototype.toString=function(){let e="";return this.questTargets.forEach((t,s)=>{s>0&&(e+=". "),"subquest"===t.targetType?e+="Talk to "+t.name:e+=h(t.targetType)+" "+t.name}),e},t.QuestInfo=l("QuestInfo",{question:"",info:"",givenBy:-1}),t.QuestReport=l("QuestReport",{expectInfoFrom:-2}),t.QuestCompleted=c("QuestCompleted",{giver:null}),t.GiveQuest=c("GiveQuest",{target:null,giver:null}),t.QuestTargetEvent=c("QuestTargetEvent",{targetComp:null,args:null,eventType:""}),t.QuestTargetEvent.prototype.setTargetComp=function(e){r.default.assertType(e,"QuestTarget"),this.targetComp=e},t.getQuestVerb=h},function(e,t,s){"use strict";var n=s(20);e.exports=r;function r(e){this._isDirected=!n.has(e,"directed")||e.directed,this._isMultigraph=!!n.has(e,"multigraph")&&e.multigraph,this._isCompound=!!n.has(e,"compound")&&e.compound,this._label=void 0,this._defaultNodeLabelFn=n.constant(void 0),this._defaultEdgeLabelFn=n.constant(void 0),this._nodes={},this._isCompound&&(this._parent={},this._children={},this._children["\0"]={}),this._in={},this._preds={},this._out={},this._sucs={},this._edgeObjs={},this._edgeLabels={}}function a(e,t){e[t]?e[t]++:e[t]=1}function o(e,t){--e[t]||delete e[t]}function i(e,t,s,r){var a=""+t,o=""+s;if(!e&&a>o){var i=a;a=o,o=i}return a+""+o+""+(n.isUndefined(r)?"\0":r)}function l(e,t,s,n){var r=""+t,a=""+s;if(!e&&r>a){var o=r;r=a,a=o}var i={v:r,w:a};return n&&(i.name=n),i}function c(e,t){return i(e,t.v,t.w,t.name)}r.prototype._nodeCount=0,r.prototype._edgeCount=0,r.prototype.isDirected=function(){return this._isDirected},r.prototype.isMultigraph=function(){return this._isMultigraph},r.prototype.isCompound=function(){return this._isCompound},r.prototype.setGraph=function(e){return this._label=e,this},r.prototype.graph=function(){return this._label},r.prototype.setDefaultNodeLabel=function(e){return n.isFunction(e)||(e=n.constant(e)),this._defaultNodeLabelFn=e,this},r.prototype.nodeCount=function(){return this._nodeCount},r.prototype.nodes=function(){return n.keys(this._nodes)},r.prototype.sources=function(){var e=this;return n.filter(this.nodes(),(function(t){return n.isEmpty(e._in[t])}))},r.prototype.sinks=function(){var e=this;return n.filter(this.nodes(),(function(t){return n.isEmpty(e._out[t])}))},r.prototype.setNodes=function(e,t){var s=arguments,r=this;return n.each(e,(function(e){s.length>1?r.setNode(e,t):r.setNode(e)})),this},r.prototype.setNode=function(e,t){return n.has(this._nodes,e)?(arguments.length>1&&(this._nodes[e]=t),this):(this._nodes[e]=arguments.length>1?t:this._defaultNodeLabelFn(e),this._isCompound&&(this._parent[e]="\0",this._children[e]={},this._children["\0"][e]=!0),this._in[e]={},this._preds[e]={},this._out[e]={},this._sucs[e]={},++this._nodeCount,this)},r.prototype.node=function(e){return this._nodes[e]},r.prototype.hasNode=function(e){return n.has(this._nodes,e)},r.prototype.removeNode=function(e){var t=this;if(n.has(this._nodes,e)){var s=function(e){t.removeEdge(t._edgeObjs[e])};delete this._nodes[e],this._isCompound&&(this._removeFromParentsChildList(e),delete this._parent[e],n.each(this.children(e),(function(e){t.setParent(e)})),delete this._children[e]),n.each(n.keys(this._in[e]),s),delete this._in[e],delete this._preds[e],n.each(n.keys(this._out[e]),s),delete this._out[e],delete this._sucs[e],--this._nodeCount}return this},r.prototype.setParent=function(e,t){if(!this._isCompound)throw new Error("Cannot set parent in a non-compound graph");if(n.isUndefined(t))t="\0";else{for(var s=t+="";!n.isUndefined(s);s=this.parent(s))if(s===e)throw new Error("Setting "+t+" as parent of "+e+" would create a cycle");this.setNode(t)}return this.setNode(e),this._removeFromParentsChildList(e),this._parent[e]=t,this._children[t][e]=!0,this},r.prototype._removeFromParentsChildList=function(e){delete this._children[this._parent[e]][e]},r.prototype.parent=function(e){if(this._isCompound){var t=this._parent[e];if("\0"!==t)return t}},r.prototype.children=function(e){if(n.isUndefined(e)&&(e="\0"),this._isCompound){var t=this._children[e];if(t)return n.keys(t)}else{if("\0"===e)return this.nodes();if(this.hasNode(e))return[]}},r.prototype.predecessors=function(e){var t=this._preds[e];if(t)return n.keys(t)},r.prototype.successors=function(e){var t=this._sucs[e];if(t)return n.keys(t)},r.prototype.neighbors=function(e){var t=this.predecessors(e);if(t)return n.union(t,this.successors(e))},r.prototype.isLeaf=function(e){return 0===(this.isDirected()?this.successors(e):this.neighbors(e)).length},r.prototype.filterNodes=function(e){var t=new this.constructor({directed:this._isDirected,multigraph:this._isMultigraph,compound:this._isCompound});t.setGraph(this.graph());var s=this;n.each(this._nodes,(function(s,n){e(n)&&t.setNode(n,s)})),n.each(this._edgeObjs,(function(e){t.hasNode(e.v)&&t.hasNode(e.w)&&t.setEdge(e,s.edge(e))}));var r={};return this._isCompound&&n.each(t.nodes(),(function(e){t.setParent(e,function e(n){var a=s.parent(n);return void 0===a||t.hasNode(a)?(r[n]=a,a):a in r?r[a]:e(a)}(e))})),t},r.prototype.setDefaultEdgeLabel=function(e){return n.isFunction(e)||(e=n.constant(e)),this._defaultEdgeLabelFn=e,this},r.prototype.edgeCount=function(){return this._edgeCount},r.prototype.edges=function(){return n.values(this._edgeObjs)},r.prototype.setPath=function(e,t){var s=this,r=arguments;return n.reduce(e,(function(e,n){return r.length>1?s.setEdge(e,n,t):s.setEdge(e,n),n})),this},r.prototype.setEdge=function(){var e,t,s,r,o=!1,c=arguments[0];"object"==typeof c&&null!==c&&"v"in c?(e=c.v,t=c.w,s=c.name,2===arguments.length&&(r=arguments[1],o=!0)):(e=c,t=arguments[1],s=arguments[3],arguments.length>2&&(r=arguments[2],o=!0)),e=""+e,t=""+t,n.isUndefined(s)||(s=""+s);var u=i(this._isDirected,e,t,s);if(n.has(this._edgeLabels,u))return o&&(this._edgeLabels[u]=r),this;if(!n.isUndefined(s)&&!this._isMultigraph)throw new Error("Cannot set a named edge when isMultigraph = false");this.setNode(e),this.setNode(t),this._edgeLabels[u]=o?r:this._defaultEdgeLabelFn(e,t,s);var h=l(this._isDirected,e,t,s);return e=h.v,t=h.w,Object.freeze(h),this._edgeObjs[u]=h,a(this._preds[t],e),a(this._sucs[e],t),this._in[t][u]=h,this._out[e][u]=h,this._edgeCount++,this},r.prototype.edge=function(e,t,s){var n=1===arguments.length?c(this._isDirected,arguments[0]):i(this._isDirected,e,t,s);return this._edgeLabels[n]},r.prototype.hasEdge=function(e,t,s){var r=1===arguments.length?c(this._isDirected,arguments[0]):i(this._isDirected,e,t,s);return n.has(this._edgeLabels,r)},r.prototype.removeEdge=function(e,t,s){var n=1===arguments.length?c(this._isDirected,arguments[0]):i(this._isDirected,e,t,s),r=this._edgeObjs[n];return r&&(e=r.v,t=r.w,delete this._edgeLabels[n],delete this._edgeObjs[n],o(this._preds[t],e),o(this._sucs[e],t),delete this._in[t][n],delete this._out[e][n],this._edgeCount--),this},r.prototype.inEdges=function(e,t){var s=this._in[e];if(s){var r=n.values(s);return t?n.filter(r,(function(e){return e.v===t})):r}},r.prototype.outEdges=function(e,t){var s=this._out[e];if(s){var r=n.values(s);return t?n.filter(r,(function(e){return e.w===t})):r}},r.prototype.nodeEdges=function(e,t){var s=this.inEdges(e,t);if(s)return s.concat(this.outEdges(e,t))}},function(e,t,s){var n=s(74),r=s(288),a=s(289),o=s(290),i=s(291),l=s(292);function c(e){var t=this.__data__=new n(e);this.size=t.size}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=o,c.prototype.has=i,c.prototype.set=l,e.exports=c},function(e,t){e.exports=function(e,t){return e===t||e!=e&&t!=t}},function(e,t,s){var n=s(39)(s(24),"Map");e.exports=n},function(e,t,s){var n=s(299),r=s(306),a=s(308),o=s(309),i=s(310);function l(e){var t=-1,s=null==e?0:e.length;for(this.clear();++t<s;){var n=e[t];this.set(n[0],n[1])}}l.prototype.clear=n,l.prototype.delete=r,l.prototype.get=a,l.prototype.has=o,l.prototype.set=i,e.exports=l},function(e,t){e.exports=function(e,t){for(var s=-1,n=null==e?0:e.length;++s<n&&!1!==t(e[s],s,e););return e}},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t){e.exports=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}},function(e,t){e.exports=function(e){return function(t){return e(t)}}},function(e,t,s){(function(e){var n=s(156),r=t&&!t.nodeType&&t,a=r&&"object"==typeof e&&e&&!e.nodeType&&e,o=a&&a.exports===r&&n.process,i=function(){try{var e=a&&a.require&&a.require("util").types;return e||o&&o.binding&&o.binding("util")}catch(e){}}();e.exports=i}).call(this,s(114)(e))},function(e,t,s){var n=s(82),r=s(316),a=Object.prototype.hasOwnProperty;e.exports=function(e){if(!n(e))return r(e);var t=[];for(var s in Object(e))a.call(e,s)&&"constructor"!=s&&t.push(s);return t}},function(e,t,s){var n=s(165),r=s(166),a=Object.prototype.propertyIsEnumerable,o=Object.getOwnPropertySymbols,i=o?function(e){return null==e?[]:(e=Object(e),n(o(e),(function(t){return a.call(e,t)})))}:r;e.exports=i},function(e,t){e.exports=function(e,t){for(var s=-1,n=t.length,r=e.length;++s<n;)e[r+s]=t[s];return e}},function(e,t,s){var n=s(163)(Object.getPrototypeOf,Object);e.exports=n},function(e,t,s){var n=s(171);e.exports=function(e){var t=new e.constructor(e.byteLength);return new n(t).set(new n(e)),t}},function(e,t){e.exports=function(e){var t=-1,s=Array(e.size);return e.forEach((function(e){s[++t]=e})),s}},function(e,t,s){var n=s(9),r=s(125),a=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,o=/^\w*$/;e.exports=function(e,t){if(n(e))return!1;var s=typeof e;return!("number"!=s&&"symbol"!=s&&"boolean"!=s&&null!=e&&!r(e))||(o.test(e)||!a.test(e)||null!=t&&e in Object(t))}},function(e,t,s){var n=s(48),r=s(29);e.exports=function(e){return"symbol"==typeof e||r(e)&&"[object Symbol]"==n(e)}},function(e,t){e.exports=function(e,t){for(var s=-1,n=null==e?0:e.length,r=Array(n);++s<n;)r[s]=t(e[s],s,e);return r}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t,s){this.entity=e+"",this.__uniqid__=s,this.load(t||{})}return e.prototype.load=function(e){var t=Object.create(null);return Object.keys(e).forEach((function(s){t[s]=e[s]})),this.properties=t,this},e.prototype.set=function(e,t){return this.properties[e]=t},e.prototype.unset=function(e){return delete this.properties[e]},e.prototype.has=function(e){return Object.prototype.hasOwnProperty.call(this.properties,e)},e.prototype.get=function(e){return this.properties[e]},e.prototype.toString=function(){return[this.constructor.name," (",this.entity," ",JSON.stringify(this.properties),")"].join("")},e.prototype.valueOf=function(){return this.toString()},e.prototype.toJSON=function(){return[this.entity,this.properties,this.__uniqid__]},e}();t.Unit=n,t.default=function(){return n}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=s(196),r=function(){function e(e){this._name=e,this._units=[],this._indices=Object.create(null),this._indicesList=[]}return e.prototype.name=function(){return this._name},e.prototype.indices=function(){return this._indicesList.slice()},e.prototype.toJSON=function(){return[this._name,this._indicesList.slice()]},e.prototype.createIndex=function(e){return this.createIndices([e])},e.prototype.createIndices=function(e){this._indicesList=this._indicesList.concat(e);for(var t=this._indices,s=this._units,n=0,r=e.length;n<r;n++)for(var a=e[n],o=t[a]=Object.create(null),i=0,l=s.length;i<l;i++){var c=s[i],u=c.get(a);u&&(o[u]=c)}return this},e.prototype._add=function(e){if(e){this._units.push(e);for(var t=this._indicesList,s=t.length,n=this._indices,r=0;r<s;r++){var a=t[r],o=n[a],i=e.get(a);i&&(o[i]=e)}}return e},e.prototype._remove=function(e){if(e){var t=this._units.indexOf(e);t>-1&&this._units.splice(t,1);for(var s=this._indicesList,n=s.length,r=this._indices,a=0;a<n;a++){var o=s[a];delete r[o][e.get(o)]}}return e},e.prototype.find=function(e,t){t||(t=e,e=this._indicesList[0]);var s=this._indices[e];return s&&s[t]},e.prototype.destroy=function(e,t){t||(t=e,e=this._indicesList[0]);var s=this._indices[e];return s&&this._remove(s[t])},e.prototype.query=function(){return new n.Query(this._units)},e}();t.Collection=r,t.default=function(){return r}},function(e,t,s){"use strict";var n,r="object"==typeof Reflect?Reflect:null,a=r&&"function"==typeof r.apply?r.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)};n=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function i(){i.init.call(this)}e.exports=i,e.exports.once=function(e,t){return new Promise((function(s,n){function r(){void 0!==a&&e.removeListener("error",a),s([].slice.call(arguments))}var a;"error"!==t&&(a=function(s){e.removeListener(t,r),n(s)},e.once("error",a)),e.once(t,r)}))},i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var l=10;function c(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function u(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function h(e,t,s,n){var r,a,o,i;if(c(s),void 0===(a=e._events)?(a=e._events=Object.create(null),e._eventsCount=0):(void 0!==a.newListener&&(e.emit("newListener",t,s.listener?s.listener:s),a=e._events),o=a[t]),void 0===o)o=a[t]=s,++e._eventsCount;else if("function"==typeof o?o=a[t]=n?[s,o]:[o,s]:n?o.unshift(s):o.push(s),(r=u(e))>0&&o.length>r&&!o.warned){o.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=o.length,i=l,console&&console.warn&&console.warn(i)}return e}function d(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function f(e,t,s){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:s},r=d.bind(n);return r.listener=s,n.wrapFn=r,r}function g(e,t,s){var n=e._events;if(void 0===n)return[];var r=n[t];return void 0===r?[]:"function"==typeof r?s?[r.listener||r]:[r]:s?function(e){for(var t=new Array(e.length),s=0;s<t.length;++s)t[s]=e[s].listener||e[s];return t}(r):m(r,r.length)}function p(e){var t=this._events;if(void 0!==t){var s=t[e];if("function"==typeof s)return 1;if(void 0!==s)return s.length}return 0}function m(e,t){for(var s=new Array(t),n=0;n<t;++n)s[n]=e[n];return s}Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");l=e}}),i.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},i.prototype.getMaxListeners=function(){return u(this)},i.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var n="error"===e,r=this._events;if(void 0!==r)n=n&&void 0===r.error;else if(!n)return!1;if(n){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var i=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw i.context=o,i}var l=r[e];if(void 0===l)return!1;if("function"==typeof l)a(l,this,t);else{var c=l.length,u=m(l,c);for(s=0;s<c;++s)a(u[s],this,t)}return!0},i.prototype.addListener=function(e,t){return h(this,e,t,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(e,t){return h(this,e,t,!0)},i.prototype.once=function(e,t){return c(t),this.on(e,f(this,e,t)),this},i.prototype.prependOnceListener=function(e,t){return c(t),this.prependListener(e,f(this,e,t)),this},i.prototype.removeListener=function(e,t){var s,n,r,a,o;if(c(t),void 0===(n=this._events))return this;if(void 0===(s=n[e]))return this;if(s===t||s.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,s.listener||t));else if("function"!=typeof s){for(r=-1,a=s.length-1;a>=0;a--)if(s[a]===t||s[a].listener===t){o=s[a].listener,r=a;break}if(r<0)return this;0===r?s.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(s,r),1===s.length&&(n[e]=s[0]),void 0!==n.removeListener&&this.emit("removeListener",e,o||t)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(e){var t,s,n;if(void 0===(s=this._events))return this;if(void 0===s.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==s[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete s[e]),this;if(0===arguments.length){var r,a=Object.keys(s);for(n=0;n<a.length;++n)"removeListener"!==(r=a[n])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=s[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},i.prototype.listeners=function(e){return g(this,e,!0)},i.prototype.rawListeners=function(e){return g(this,e,!1)},i.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},i.prototype.listenerCount=p,i.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]}},function(e,t,s){(t=e.exports=s(199)).Stream=t,t.Readable=t,t.Writable=s(131),t.Duplex=s(44),t.Transform=s(203),t.PassThrough=s(434)},function(e,t,s){"use strict";(function(t,n,r){var a=s(87);function o(e){var t=this;this.next=null,this.entry=null,this.finish=function(){!function(e,t,s){var n=e.entry;e.entry=null;for(;n;){var r=n.callback;t.pendingcb--,r(s),n=n.next}t.corkedRequestsFree?t.corkedRequestsFree.next=e:t.corkedRequestsFree=e}(t,e)}}e.exports=_;var i,l=!t.browser&&["v0.10","v0.9."].indexOf(t.version.slice(0,5))>-1?n:a.nextTick;_.WritableState=y;var c=s(61);c.inherits=s(43);var u={deprecate:s(433)},h=s(200),d=s(88).Buffer,f=r.Uint8Array||function(){};var g,p=s(201);function m(){}function y(e,t){i=i||s(44),e=e||{};var n=t instanceof i;this.objectMode=!!e.objectMode,n&&(this.objectMode=this.objectMode||!!e.writableObjectMode);var r=e.highWaterMark,c=e.writableHighWaterMark,u=this.objectMode?16:16384;this.highWaterMark=r||0===r?r:n&&(c||0===c)?c:u,this.highWaterMark=Math.floor(this.highWaterMark),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var h=!1===e.decodeStrings;this.decodeStrings=!h,this.defaultEncoding=e.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){!function(e,t){var s=e._writableState,n=s.sync,r=s.writecb;if(function(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}(s),t)!function(e,t,s,n,r){--t.pendingcb,s?(a.nextTick(r,n),a.nextTick(C,e,t),e._writableState.errorEmitted=!0,e.emit("error",n)):(r(n),e._writableState.errorEmitted=!0,e.emit("error",n),C(e,t))}(e,s,n,t,r);else{var o=S(s);o||s.corked||s.bufferProcessing||!s.bufferedRequest||E(e,s),n?l(v,e,s,o,r):v(e,s,o,r)}}(t,e)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.bufferedRequestCount=0,this.corkedRequestsFree=new o(this)}function _(e){if(i=i||s(44),!(g.call(_,this)||this instanceof i))return new _(e);this._writableState=new y(e,this),this.writable=!0,e&&("function"==typeof e.write&&(this._write=e.write),"function"==typeof e.writev&&(this._writev=e.writev),"function"==typeof e.destroy&&(this._destroy=e.destroy),"function"==typeof e.final&&(this._final=e.final)),h.call(this)}function b(e,t,s,n,r,a,o){t.writelen=n,t.writecb=o,t.writing=!0,t.sync=!0,s?e._writev(r,t.onwrite):e._write(r,a,t.onwrite),t.sync=!1}function v(e,t,s,n){s||function(e,t){0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}(e,t),t.pendingcb--,n(),C(e,t)}function E(e,t){t.bufferProcessing=!0;var s=t.bufferedRequest;if(e._writev&&s&&s.next){var n=t.bufferedRequestCount,r=new Array(n),a=t.corkedRequestsFree;a.entry=s;for(var i=0,l=!0;s;)r[i]=s,s.isBuf||(l=!1),s=s.next,i+=1;r.allBuffers=l,b(e,t,!0,t.length,r,"",a.finish),t.pendingcb++,t.lastBufferedRequest=null,a.next?(t.corkedRequestsFree=a.next,a.next=null):t.corkedRequestsFree=new o(t),t.bufferedRequestCount=0}else{for(;s;){var c=s.chunk,u=s.encoding,h=s.callback;if(b(e,t,!1,t.objectMode?1:c.length,c,u,h),s=s.next,t.bufferedRequestCount--,t.writing)break}null===s&&(t.lastBufferedRequest=null)}t.bufferedRequest=s,t.bufferProcessing=!1}function S(e){return e.ending&&0===e.length&&null===e.bufferedRequest&&!e.finished&&!e.writing}function w(e,t){e._final((function(s){t.pendingcb--,s&&e.emit("error",s),t.prefinished=!0,e.emit("prefinish"),C(e,t)}))}function C(e,t){var s=S(t);return s&&(!function(e,t){t.prefinished||t.finalCalled||("function"==typeof e._final?(t.pendingcb++,t.finalCalled=!0,a.nextTick(w,e,t)):(t.prefinished=!0,e.emit("prefinish")))}(e,t),0===t.pendingcb&&(t.finished=!0,e.emit("finish"))),s}c.inherits(_,h),y.prototype.getBuffer=function(){for(var e=this.bufferedRequest,t=[];e;)t.push(e),e=e.next;return t},function(){try{Object.defineProperty(y.prototype,"buffer",{get:u.deprecate((function(){return this.getBuffer()}),"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(e){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(g=Function.prototype[Symbol.hasInstance],Object.defineProperty(_,Symbol.hasInstance,{value:function(e){return!!g.call(this,e)||this===_&&(e&&e._writableState instanceof y)}})):g=function(e){return e instanceof this},_.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe, not readable"))},_.prototype.write=function(e,t,s){var n,r=this._writableState,o=!1,i=!r.objectMode&&(n=e,d.isBuffer(n)||n instanceof f);return i&&!d.isBuffer(e)&&(e=function(e){return d.from(e)}(e)),"function"==typeof t&&(s=t,t=null),i?t="buffer":t||(t=r.defaultEncoding),"function"!=typeof s&&(s=m),r.ended?function(e,t){var s=new Error("write after end");e.emit("error",s),a.nextTick(t,s)}(this,s):(i||function(e,t,s,n){var r=!0,o=!1;return null===s?o=new TypeError("May not write null values to stream"):"string"==typeof s||void 0===s||t.objectMode||(o=new TypeError("Invalid non-string/buffer chunk")),o&&(e.emit("error",o),a.nextTick(n,o),r=!1),r}(this,r,e,s))&&(r.pendingcb++,o=function(e,t,s,n,r,a){if(!s){var o=function(e,t,s){e.objectMode||!1===e.decodeStrings||"string"!=typeof t||(t=d.from(t,s));return t}(t,n,r);n!==o&&(s=!0,r="buffer",n=o)}var i=t.objectMode?1:n.length;t.length+=i;var l=t.length<t.highWaterMark;l||(t.needDrain=!0);if(t.writing||t.corked){var c=t.lastBufferedRequest;t.lastBufferedRequest={chunk:n,encoding:r,isBuf:s,callback:a,next:null},c?c.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1}else b(e,t,!1,i,n,r,a);return l}(this,r,i,e,t,s)),o},_.prototype.cork=function(){this._writableState.corked++},_.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.finished||e.bufferProcessing||!e.bufferedRequest||E(this,e))},_.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=e.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((e+"").toLowerCase())>-1))throw new TypeError("Unknown encoding: "+e);return this._writableState.defaultEncoding=e,this},_.prototype._write=function(e,t,s){s(new Error("_write() is not implemented"))},_.prototype._writev=null,_.prototype.end=function(e,t,s){var n=this._writableState;"function"==typeof e?(s=e,e=null,t=null):"function"==typeof t&&(s=t,t=null),null!=e&&this.write(e,t),n.corked&&(n.corked=1,this.uncork()),n.ending||n.finished||function(e,t,s){t.ending=!0,C(e,t),s&&(t.finished?a.nextTick(s):e.once("finish",s));t.ended=!0,e.writable=!1}(this,n,s)},Object.defineProperty(_.prototype,"destroyed",{get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(e){this._writableState&&(this._writableState.destroyed=e)}}),_.prototype.destroy=p.destroy,_.prototype._undestroy=p.undestroy,_.prototype._destroy=function(e,t){this.end(),t(e)}}).call(this,s(31),s(431).setImmediate,s(28))},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.SpawnerActor=t.WeatherActor=t.VirtualActor=void 0;const o=s(56),i=s(55),l=s(100),c=a(s(13));class u extends o.BaseActor{constructor(e,t=!0){super(e,t),t&&(this._brain=new i.BrainVirtual(this))}}t.VirtualActor=u;class h extends o.BaseActor{constructor(e,t=!0){super(e,t),t&&(this._brain=new l.BrainWeather(this))}}t.WeatherActor=h;class d extends o.BaseActor{constructor(e,t=!0){super(e,t),t&&(this._brain=new i.BrainSpawner(this),this.add(new c.Stats),this.get("Stats").setSpeed(10))}getSpeed(){return this.get("Stats").getSpeed()}}t.SpawnerActor=d},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ItemGen=void 0;const r=n(s(0)),a=s(47),o=s(1),i=s(47),l=o.Random.getRNG();t.ItemGen={};const c={};t.ItemGen.shellProps=c;const u={};u.weaponTypes=Object.keys({melee:["dagger","sword","staff","whip","axe","mace","saber","spear","morningstar","battle axe","warhammer","pick-axe","hammer","katana","falchion","scimitar","war scythe"],missileweapon:["sling","short bow","warbow","crossbow","musket","rifle"],ammo:["arrow","bolt","bullet"],missile:["rock","dart","throwing axe","throwing dagger","throwing knife","throwing spear","shuriken"]}),t.ItemGen.names=u;const h={weapon:{heavy:{weight:1.5,value:1.2,damage:"2d3 + 4",rarity:1.5},light:{weight:.6,value:1.2,rarity:2},poisoned:{value:3,rarity:3,onAttackHit:[a.meleeHitDamage(2,"1d4 + 1","POISON")],colorfg:"Green"},sharp:{damage:"4",value:1.1,rarity:1.5},balanced:{attack:6,damage:"2",value:1.2,rarity:1.5},serrated:{value:2,rarity:2,onAttackHit:[a.meleeHitDamage(1,"1d4 + 2","PIERCE")]},icy:{value:2.5,rarity:2.5,onAttackHit:[a.meleeHitDamage(1,"1d6 + 4","ICE")]},flaming:{value:2.5,rarity:2.5,onAttackHit:[a.meleeHitDamage(1,"1d6 + 4","FIRE")]}},missileweapon:{},ammo:{},missile:{}};h.ammo=Object.assign(h.ammo,h.weapon),h.missile=Object.assign(h.missile,h.weapon),h.armour={light:h.weapon.light,heavy:{weight:1.5,value:1.2,protection:2,rarity:1.5},plated:{weight:1.2,value:1.3,protection:3,rarity:1.3},spiked:{weight:1.2,value:1.4,protection:1,attack:3,rarity:2},flexible:{weight:.9,value:1.4,protection:2,attack:2,rarity:2}},t.ItemGen.prefix=h,u.prefix={weapon:Object.keys(h.weapon),armour:Object.keys(h.armour),missileweapon:Object.keys(h.missileweapon),missile:Object.keys(h.missile),ammo:Object.keys(h.ammo)};const d={weapon:{ofAccuracy:{name:"of Accuracy",accuracy:5,rarity:2.5,value:2.5},ofAgility:{name:"of Agility",agility:5,rarity:2.5,value:2.5},ofDefense:{name:"of Defense",defense:5,rarity:3,value:3},ofFire:{name:"of Fire",onAttackHit:[a.meleeHitDamage(2,"1d6 + 1","FIRE")],rarity:3,value:3},ofMight:{name:"of Might",strength:4,rarity:3,value:3},ofNecropotence:{name:"of Necropotence",onAttackHit:[{transientComp:"DrainStat",func:[{setter:"setDrainAmount",value:1},{setter:"setSourceComp",value:"Health"},{setter:"setSourceGetter",value:"getHP"},{setter:"setSourceSetter",value:"setHP"},{setter:"setTargetComp",value:"SpellPower"},{setter:"setTargetGetter",value:"getPP"},{setter:"setTargetSetter",value:"setPP"},{setter:"setDrainMsg",value:"drains life from"}]}],onEquip:[a.directDamage(1,"1d1 + 3","NECRO",1,"You feel slightly easier"),{addComp:"DirectDamage",func:[{setter:"setDamage",value:1},{setter:"setDamageType",value:r.default.DMG.NECRO},{setter:"setDamageCateg",value:r.default.DMG.DIRECT},{setter:"setProb",value:.05},{setter:"setMsg",value:"Necropotence demands blood!"}]}],rarity:4,value:4},ofFrost:{name:"of Frost",onAttackHit:[a.meleeHitDamage(2,"1d6 + 1","ICE")],rarity:3,value:3},ofSerpent:{name:"of Serpent",addComp:[a.resistance("POISON","MEDIUM")],rarity:2,value:2},ofHoly:{name:"of Holy",addComp:[a.resistance("NECRO","MEDIUM")],rarity:2,value:2},ofMagic:{name:"of Magic",magic:5,rarity:2.5,value:2.5},ofPerception:{name:"of Perception",perception:5,rarity:3,value:3},ofProtection:{name:"of Protection",protection:5,rarity:3,value:3},ofSpeed:{name:"of Speed",speed:10,rarity:3,value:3},ofVoid:{name:"of Void",onAttackHit:[a.meleeHitDamage(2,"1d8 + 1","VOID")],rarity:4,value:4},ofSpirit:{name:"of Spirit",spirituality:6,rarity:3,value:3},ofWillpower:{name:"of Willpower",willpower:6,rarity:3,value:3}}};d.armour={ofAccuracy:d.weapon.ofAccuracy,ofAgility:d.weapon.ofAgility,ofDefense:d.weapon.ofProtection,ofMagic:d.weapon.ofMagic,ofMight:d.weapon.ofMight,ofPerception:d.weapon.ofPerception,ofProtection:d.weapon.ofProtection,ofSpeed:d.weapon.ofSpeed,ofSerpent:d.weapon.ofSerpent,ofHoly:d.weapon.ofHoly,ofLevitation:{onEquip:[{addComp:"Flying"}],rarity:5,value:5},ofNecropotence:{onEquip:[{addComp:"RegenEffect",func:[{setter:"setHP",value:0},{setter:"setMaxWaitPP",value:25}]},{addComp:"DirectDamage",func:[{setter:"setDamage",value:1},{setter:"setDamageType",value:r.default.DMG.NECRO},{setter:"setDamageCateg",value:r.default.DMG.DIRECT},{setter:"setProb",value:.05},{setter:"setMsg",value:"Necropotence demands blood!"}]}]},ofSpirituality:d.weapon.ofSpirit,ofWillpower:d.weapon.ofWillpower},d.missile={ofParalysis:{name:"of paralysis",rarity:3,value:2,onAttackHit:[{addComp:"Paralysis",duration:"1"}]},ofStunning:{name:"of stunning",rarity:3,value:2,onAttackHit:[{addComp:"Stun",duration:"1"}]},ofSlowness:{name:"of slowness",rarity:3,value:3,onAttackHit:[{addComp:"StatsMods",func:[{setter:"setSpeed",value:-10}],duration:"3d10"}]}},d.missileweapon={},d.ammo=d.missile,t.ItemGen.suffix=d,u.suffix={weapon:Object.keys(d.weapon),armour:Object.keys(d.armour),missileweapon:Object.keys(d.missileweapon),missile:Object.keys(d.missile),ammo:Object.keys(d.ammo)};const f={weapon:{type:"weapon",range:1,value:1,attack:0,defense:0,char:"(",speed:0,strength:0,accuracy:0,agility:0,willpower:0,perception:0,magic:0,spirituality:0},armour:{type:"armour",value:1,attack:0,defense:0,protection:0,char:"[",speed:0,strength:0,accuracy:0,agility:0,willpower:0,perception:0,magic:0,spirituality:0},missile:{type:"missile",value:1,attack:0,defense:0,char:"/"},missileweapon:{type:"missileweapon",value:1,attack:0,defense:0,char:"{",fireRate:1},ammo:{type:"ammo",value:1,attack:0,defense:0,char:"/"}};c.weapon={dagger:{damage:"1d6",attack:1,weight:.2,rarity:1,value:10,weaponType:"dagger"},sword:{damage:"1d8 + 2",attack:2,defense:1,weight:.8,rarity:2,value:20,weaponType:"sword"},spear:{damage:"1d9 + 1",attack:1,defense:3,weight:1,rarity:3,value:25,weaponType:"spear"},mace:{damage:"1d10",attack:2,weight:1.3,rarity:3,value:25,weaponType:"mace"},axe:{damage:"2d6",attack:2,weight:1.1,rarity:3,value:35,weaponType:"axe"},warhammer:{damage:"1d10",attack:2,weight:1.1,rarity:2,value:30,weaponType:"hammer"},staff:{damage:"1d8",attack:2,defense:2,weight:.9,rarity:4,value:30},"war scythe":{damage:"1d10+2",attack:4,weight:1.5,rarity:4,value:50,weaponType:"polearm",damageType:r.default.DMG.SLASH},halberd:{damage:"1d12+3",attack:5,weight:1.9,rarity:5,value:55,weaponType:"polearm",damageType:r.default.DMG.SLASH}},u.weapon=Object.keys(c.weapon),c.armour={robe:{armourType:"chest",weight:1,protection:0,defense:0,value:15},cuirass:{armourType:"chest",weight:2,protection:4,defense:-1,attack:-1,value:40,no:{material:["wooden"]}},mail:{armourType:"chest",weight:1.7,protection:3,defense:1,attack:0,value:30,no:{material:["leather","wooden"]}},brigandine:{armourType:"chest",weight:1.5,protection:5,defense:1,attack:0,value:50,no:{material:["leather","wooden"]}},"full plate":{armourType:"chest",weight:2.5,protection:8,defense:0,attack:-2,value:80,no:{material:["leather","wooden","cloth"]}},cloak:{armourType:"cloak",weight:.2,protection:0,defense:0,attack:0,value:15,only:{material:["cloth","leather"]}},boots:{armourType:"feet",weight:.5,protection:1,defense:0,attack:0,value:15,no:{material:"wooden"}},greaves:{armourType:"legs",weight:1,protection:2,defense:0,attack:1,value:20,no:{material:"wooden"}},helmet:{armourType:"head",weight:.3,protection:1,defense:0,attack:0,value:15},collar:{armourType:"neck",weight:.2,protection:1,defense:0,attack:0,value:15,no:{material:"wooden"}},shield:{armourType:"shield",weight:.8,protection:2,defense:1,attack:0,value:15,no:{material:["cloth","leather"]}},buckler:{armourType:"shield",weight:.4,protection:0,defense:3,attack:1,value:20,no:{material:["cloth","leather"]}}},u.armour=Object.keys(c.armour),c.missile={shuriken:{char:"*",damage:"1d6",range:3,value:10,weaponType:"shuriken",weight:.1},dart:{char:"/",damage:"1d6 + 1",range:3,value:13,weaponType:"dart",weight:.1},"throwing knife":{char:"/",damage:"1d6",range:3,weight:.2,value:13,attack:1,weaponType:"dagger"},"throwing spear":{attack:2,damage:"1d7 + 1",range:3,value:30,weight:.4,weaponType:"spear"},"throwing axe":{attack:2,damage:"1d8 + 1",range:3,value:35,weight:.3}},u.missile=Object.keys(c.missile),c.missileweapon={sling:{weaponType:"sling",value:15,damage:"1d4",range:3,weight:.3},"short bow":{weaponType:"bow",value:25,damage:"1d6",range:4,weight:.6},warbow:{weaponType:"bow",value:35,damage:"1d9",range:6,weight:.9},"light crossbow":{weaponType:"crossbow",value:30,damage:"1d8",range:5,weight:1},crossbow:{weaponType:"crossbow",value:40,damage:"2d6",range:6,weight:1.5},musket:{weaponType:"rifle",value:50,damage:"2d6",range:6,no:{material:["wooden"]},weight:2.5},rifle:{weaponType:"rifle",value:75,damage:"3d6",range:7,no:{material:["wooden"]},weight:3.5}},u.missileweapon=Object.keys(c.missileweapon),c.ammo={arrow:{ammoType:"bow",damage:"1d6",value:5,range:1,weight:.1},bolt:{ammoType:"crossbow",damage:"1d8",value:8,range:1,weight:.1},bullet:{ammoType:"rifle",damage:"1d8",value:15,no:{material:["wooden"]},range:1,weight:.1}},u.ammo=Object.keys(c.ammo),c.material={cloth:{weight:.5,value:.5,rarity:1,armour:{onEquip:[a.resistance("BLUNT","MEDIUM")]}},leather:{weight:1,value:1,rarity:1,armour:{protection:1}},wooden:{weight:1,value:1,rarity:1},iron:{weight:1.7,value:1.2,rarity:1,weapon:{damage:"1d2 + 1"},armour:{protection:"* 1.3",attack:-1}},steel:{weight:1.5,value:1.4,rarity:1.5,weapon:{damage:"1d4 + 2"},armour:{protection:"* 1.5",attack:-1}},mithril:{className:"cell-item-mithril",weight:.75,value:3,rarity:2.3,weapon:{damage:"2d3 + 3"},armour:{protection:"* 1.7",attack:-1}},adamantium:{className:"cell-item-adamantium",weight:1,value:4,rarity:2.7,weapon:{damage:"3d3 + 4"},armour:{protection:"* 2.0",attack:0}},rubyglass:{className:"cell-item-ruby-glass",weight:.5,value:5,rarity:3,weapon:{damage:"2d4 + 3"},armour:{protection:"* 2.2",defense:2}},permaice:{className:"cell-item-ice",weight:3,value:8,rarity:4,weapon:{damage:"3d4 + 6"},armour:{protection:"* 3.0",defense:-2,attack:-2}},forium:{className:"cell-item-magic",weight:1.2,value:7,rarity:5,weapon:{damage:"2d4 + 4"},armour:{protection:"* 2.2",defense:1}},netherium:{className:"cell-item-nether",weight:2,value:7,rarity:5,weapon:{damage:"2d4 + 2",attack:5},armour:{protection:"* 2.2",defense:-1,attack:-1}},void:{className:"cell-item-void",weight:1.4,value:10,rarity:8,weapon:{damage:"2d6 + 6",onAttackHit:[a.meleeHitDamage(2,"1d6 + 1","VOID")]},armour:{protection:"* 2.0",addComp:[a.resistance("VOID","MEDIUM")]}}},_(c.material,"weapon","missileweapon"),_(c.material,"weapon","missile"),_(c.material,"weapon","ammo"),u.materials=Object.keys(c.material);const g={weapon:u.materials.filter(e=>!/(wooden|leather|cloth)/.test(e)),armour:u.materials.slice(),missileweapon:u.materials.filter(e=>!/(leather|cloth)/.test(e)),missile:u.materials.filter(e=>!/(leather|cloth)/.test(e)),ammo:u.materials.filter(e=>!/(leather|cloth)/.test(e))},p=["armour","weapon","ammo","missile","missileweapon"];function m(e,t,s){let n=e;return n=s.name?s.name+" "+e:t+" "+e,n}function y(e,t,s){let n=e;return n=s.name?e+" "+s.name:e+" "+t,n}function _(e,t,s){Object.keys(e).forEach(n=>{const r=e[n];r[t]&&(r[s]=r[t])})}t.ItemGen.genRandShell=function(e){const t=r.default.isSuccess(r.default.ITEM_PREFIX_CHANCE),s=r.default.isSuccess(r.default.ITEM_SUFFIX_CHANCE);let n="",a="";const o=g[e],p=l.arrayGetRand(o),_=c.material[p];let b=null;_[e]&&(b=_[e]);const v=function(e,t,s){return s.filter(s=>{const n=c[e][s];if(n.no){const e=n.no;if(e.material===t)return!1;if(e.material.indexOf(t)>=0)return!1}if(n.only){const e=n.only;if(Array.isArray(e.material)){if(e.material.indexOf(t)<0)return!1}else if(e.material!==t)return!1}return!0})}(e,p,u[e]),E=l.arrayGetRand(v),S=c[e][E],w=[f[e],S,_];b&&w.push(b);let C=p+" "+E;if(t&&u.prefix[e].length>0){n=l.arrayGetRand(u.prefix[e]);const t=h[e][n];w.push(t),C=m(C,n,t)}if(s&&u.suffix[e].length>0){a=l.arrayGetRand(u.suffix[e]);const t=d[e][a];w.push(t),C=y(C,a,t)}const T=i.mixNewShell(w);return T.name=C,T},t.ItemGen.buildShell=function(e){const{type:t}=e;t||r.default.err("ItemGen","buildShell","No type was given");const s=f[t],n=c.material[e.material];let a=null;n[t]&&(a=n[t]);const o=h[t][e.prefix],l=d[t][e.suffix],u=[s,n,c[t][e.name]];a&&u.push(a);let g=e.material+" "+e.name;o&&(u.push(o),g=m(g,e.prefix,o)),l&&(u.push(l),g=y(g,e.suffix,l));const p=i.mixNewShell(u);return p.name=g,p},t.ItemGen.genItems=function(e){const s=[];for(let n=0;n<e;n++){const e=l.arrayGetRand(p);s.push(t.ItemGen.genRandShell(e))}return s},t.ItemGen.genRandShellWith=function(e){let s=100,n=null;for(;s>=0;){const r=l.arrayGetRand(p);if(--s,n=t.ItemGen.genRandShell(r),e(n))break}return n}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LevelSurroundings=void 0;const r=n(s(0)),a=s(4),o=s(1),i=s(11),l=s(35),c=s(21),u=s(8),h=o.Random.getRNG(),d=/\b(cliff|stone|steep cliff)\b/;function f(e){switch(e){case"wallmount":return!0;default:return!1}}t.LevelSurroundings=class{surround(e,t){if(t.cellsAround)return this.surroundWithCellsAround(e,t);const s=JSON.stringify(t);return r.default.err("LevelSurroundings","surround","No conf given for surround. Got: "+s),null}surroundWithCellsAround(e,t){const s=2*t.surroundX||20,n=2*t.surroundY||20,{cols:o,rows:u}=e.getMap(),h=o+s,f=u+n,{cellsAround:g}=t,p=new c.MapGenerator;let m=null;if(this.hasAnyMountains(g)){const e=this.getWallConfFromCells(t,s,n);m=p.createWall(h,f,e).map}else{m=new l.CellMap(h,f)}const y=new i.Level(m),_={wallmount:!0},b={};Object.keys(g).forEach(e=>{let t=g[e];t.match(d)&&(t="cliffs");const s=a.Geometry.dirToBbox(h,f,e);s?(b[t]||(b[t]=[]),b[t].push(s)):r.default.err("LevelSurroundings","surroundWithCellsAround",`Received null bbox from dir ${e}, type ${t}`)});const v=[];return Object.keys(b).forEach(e=>{const t=b[e],s=a.Geometry.combineAdjacent(t);v.push([e,s])}),v.forEach(e=>{const[t,s]=e;s.forEach(e=>{if("water"===t){const t={ratio:.6,skipTypes:_,forestSize:300,nForests:10};p.addLakes(y.getMap(),t,e)}else if("tree"===t){const t={ratio:1,skipTypes:_,nForests:10};p.addForest(y.getMap(),t,e)}else if("cliffs"===t){const t=c.MapGenerator.getOptions("mountain");t.nRoadTurns=0,t.highRockThr=100,t.snowRatio=0,t.chasmThr=-100,t.skipTypes=_,p.addCliffs(y.getMap(),t,e)}})}),a.Geometry.mergeLevels(y,e,s/2,n/2),this.offsetFunc=(e,t)=>[e+s/2,t+n/2],this.adjustCoord=e=>e.map(e=>this.offsetFunc(e[0],e[1])),this.lastLevelID=y.getID(),y}getWallConfFromCells(e,t,s){const{cellsAround:n}=e,r={};return"wallmount"===n.E?(r.alignHorizontal="right",r.east=!1,r.west=!1,r.north=!0,r.south=!0):"wallmount"===n.W&&(r.alignHorizontal="left",r.east=!1,r.west=!1,r.north=!0,r.south=!0),"wallmount"===n.N?(r.alignVertical="top",r.east=!0,r.west=!0):"wallmount"===n.S&&(r.alignVertical="bottom",r.east=!0,r.west=!0),r.meanWx=h.getUniformInt(5,t),r.meanWy=h.getUniformInt(5,s),r.wallElem=u.ELEM.WALL_MOUNT,r}hasAnyMountains(e){const t=Object.values(e);let s=!1;return t.forEach(e=>{"wallmount"===e&&(s=!0)}),s}scaleExtras(e){this.lastLevelID!==e.getID()&&r.default.err("LevelSurroundings","scaleExtras","Previous surrounded level not given. Scaling will not work");const t=e.getExtras();["corridor","entrance","room","storeroom","vault"].forEach(e=>{e in t&&this.scaleRooms(t[e])}),t.hasOwnProperty("houses")&&Object.values(t.houses).forEach(e=>{const t=e.getBbox(),[s,n]=this.offsetFunc(t.ulx,t.uly);e.adjustCoord(s,n)})}scaleRooms(e){e.forEach(e=>{[e._x1,e._y1]=this.offsetFunc(e._x1,e._y1),[e._x2,e._y2]=this.offsetFunc(e._x2,e._y2)})}getNonBlockedDirs(e){const t=[],s={};return["N","S","E","W"].forEach(n=>{f(e[n])?s[n]=!0:t.push(n)}),s.E||s.N||f(e.NE)||t.push("NE"),s.W||s.N||f(e.NW)||t.push("NW"),s.E||s.S||f(e.SE)||t.push("SE"),s.W||s.S||f(e.SW)||t.push("SW"),t}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NestGenerator=void 0;const r=n(s(0)),a=s(33),o=n(s(5)),i=s(34),l=s(11),c=s(30),u=s(4),h=s(1),d=s(8),f=s(72),g=s(6),p=s(23),m=s(133),y=h.Random.getRNG(),_=o.default("bitn:nest");class b extends a.LevelGenerator{constructor(){super(),this._debug=_.enabled||!0,this.squaresPerActor=9}static getOptions(){const e=a.LevelGenerator.getOptions();return e.actorConstr={race:"orc"},e.mapConf={tilesX:3,tilesY:3,genParams:{x:[1,1,1],y:[1,1,1]},wallType:"wall",floorType:"floor"},e}dbg(...e){this._debug&&_(...e)}create(e,t,s){const n=(new i.MapGenerator).createNest(e,t,s.mapConf),r=new l.Level(n.map);return r.updateLevelFromMap(),r}createAndEmbed(e,t,s){s.embedOpts&&s.embedOpts.level||r.default.err("NestGenerator","createAndEmbed","No level in conf.embedOpts. Got: "+JSON.stringify(s));const n=this.create(e,t,s);return s.removeBorderWall&&this.removeBorderWall(n,s),this.embedIntoLevel(n,s)}embedIntoLevel(e,t){if(!t.embedOpts)return r.default.err("NestGenerator","embedIntoLevel","conf.embedOpts must exist. Got: "+JSON.stringify(t)),!1;t.maxDanger||(t.maxDanger=5);const s=t.embedOpts.level,n=s.getMap(),a=e=>!e.isFree(),[o,i]=e.getSizeXY();let l=null;if(t.embedOpts.bbox)l=t.embedOpts.bbox;else{const e=1,t=c.Placer.findCellArea(n,o,i,a,e);if(0===t.length)return!1;l=y.arrayGetRand(t)}if(l.getArea()>0){u.Geometry.mergeLevels(s,e,l.ulx,l.uly);const n=this.connectNestToParentLevel(s,l,t);if(n.length>0)return this.addElemsToNestArea(s,l,t),this.populateNestArea(s,l,t),this.addLootToNestArea(s,l,t),this.populateTunnel(s,t,n),!0;r.default.warn("NestGenerator","embedIntoLevel","Nest was merged into parent, but no connection was done")}else t.embedOpts&&t.embedOpts.alwaysEmbed;return!1}connectNestToParentLevel(e,t,s){if(s.scanForDoors){const n=this.scanAndConnect(e,t,s);if(n.length>0)return n}const n=e.getMap();let r="";const[a,o]=e.getSizeXY();t.uly<o/2?r+="S":t.uly>=o/2&&(r+="N"),t.ulx<a/2?r+="E":t.ulx>=a/2&&(r+="W");const i=r.split("");for(i.push(r);i.length>0;){const e=y.arrayGetRand(i);i.splice(i.indexOf(e),1);let s=[],r=[],a=0;const o=5;for(;0===s.length&&(r=t.getBorderXY(e,a++),s=n.getCellsWithCoord(r),s=s.filter(e=>e.isFree()),!(a>o)););if(s.length>0){let t=[];if(this.dbg("Tunneling to",e,"using",t),this.getCoordForTunnel(s,n,e,t))return t=t.filter(e=>{const[t,s]=e;return!(t<1||s<1)&&!(t>=n.cols-1||s>=n.rows-1)}),n.setBaseElems(t,d.ELEM.FLOOR),t}}return[]}getCoordForTunnel(e,t,s,n){let a=null;const o=e;if(!(o.length>0))return!1;if(a=y.arrayGetRand(o),o.splice(o.indexOf(a),1),!a.isFree())return!1;{let[e,i]=a.getXY();const l=r.default.dirTodXdY(s);if(l){if([e,i]=r.default.newXYFromDir(l,[e,i]),!t.hasXY(e,i))return!1;a=t.getCell(e,i),n.push([e,i]);let s=0;for(;!a.isFree();){if([e,i]=r.default.newXYFromDir(l,[e,i]),t.hasXY(e,i)){a=t.getCell(e,i),n.push([e,i]);let s=u.Geometry.getCrossCaveConn(e,i,1);s=s.map(e=>y.shiftCoord(e)),n.push(...s)}else if(n.length=0,o.length>0){a=y.arrayGetRand(o),o.splice(o.indexOf(a),1),[e,i]=a.getXY(),[e,i]=r.default.newXYFromDir(l,[e,i]),a=t.getCell(e,i),n.push([e,i]),s=0;let c=u.Geometry.getCrossCaveConn(e,i,1);c=c.map(e=>y.shiftCoord(e)),n.push(...c)}if(250==++s)return!1}}else r.default.err("NestGenerator","connectNestToParentLevel",`No dXdY for dir ${s} found`)}return!0}addElemsToNestArea(e,t,s){super.markersToDoor(e)}populateNestArea(e,t,s){const{actorConstr:n}=s;if(n){const s=t.getArea(),r=this.getActorsForNest(n,s);c.Placer.addActorsToBbox(e,t,r)&&r.forEach(e=>{const s=new p.EvaluatorGuardArea(.7,t);e.getBrain().getGoal().addEvaluator(s)})}}getActorsForNest(e,t){const s=[],n=[],a=g.ObjectShell.getParser(),o=y.getUniformInt(3,8);let i=0;const l=Math.round(t/this.squaresPerActor);for(let t=0;t<o;t++){let t=f.ActorGen.genShell(e),s=35;for(;t.danger>e.maxDanger+2;)if(t=f.ActorGen.genShell(e),--s,0===s){t=null;break}t?n.push(t):r.default.warn("NestGenerator","getActorsForNest","Failed to create shell with "+JSON.stringify(e))}for(;i<l;){const e=y.arrayGetRand(n);s.push(a.createFromShell(r.default.TYPE_ACTOR,e)),++i}return s}addLootToNestArea(e,t,s){let{maxValue:n}=s;n||(n=100),n*=1.5;const a=g.ObjectShell.getParser(),o=super.removeOneMarkerType(e,"?","nest_loot"),i=e=>e.value<=n&&e.value>=.5*n;o.forEach(t=>{const s=a.createRandomItem(i);e.addItem(s,t[0],t[1])});const l=m.ItemGen.genItems(1)[0],c=a.createFromShell(r.default.TYPE_ITEM,l);if(c){const[t,s]=y.arrayGetRand(o);e.addItem(c,t,s)}}removeBorderWall(e,t){const{cols:s,rows:n}=e.getMap();let r=d.ELEM.FLOOR;t.borderElem&&(r=t.borderElem);for(let t=0;t<s;++t)e.getMap().setBaseElemXY(t,0,r);for(let t=0;t<n;++t)e.getMap().setBaseElemXY(0,t,r);for(let t=0;t<s;++t)e.getMap().setBaseElemXY(t,n-1,r);for(let t=0;t<n;++t)e.getMap().setBaseElemXY(s-1,t,r)}scanAndConnect(e,t,s){const n=[];for(let s=t.uly;s<=t.lry;s++){const a=t.lrx,o=e.getMap(),i=u.Geometry.getCrossAround(a,s,1,!0),l=u.Geometry.coordToDirMap([a,s],i);if(l.E){const[t,i]=l.E[0],c=o.getCell(t,i);if(c&&c.isFree()){const t=this.tunnelUntilFloor(e,a,s,r.default.DIR.W);n.push(...t)}}}for(let s=t.uly;s<=t.lry;s++){const a=t.ulx,o=e.getMap(),i=u.Geometry.getCrossAround(a,s,1,!0),l=u.Geometry.coordToDirMap([a,s],i);if(l.W){const[t,i]=l.W[0],c=o.getCell(t,i);if(c&&c.isFree()){console.log("scanAndConnect free west cell at",t,i);const o=this.tunnelUntilFloor(e,a,s,r.default.DIR.E);n.push(...o)}}}for(let s=t.ulx;s<=t.lrx;s++){const a=t.lry,o=e.getMap(),i=u.Geometry.getCrossAround(s,a,1,!0),l=u.Geometry.coordToDirMap([s,a],i);if(l.S){const[t,i]=l.S[0],c=o.getCell(t,i);if(c&&c.isFree()){console.log("scanAndConnect south cell at",t,i);const o=this.tunnelUntilFloor(e,s,a,r.default.DIR.N);n.push(...o)}}}for(let s=t.ulx;s<=t.lrx;s++){const a=t.uly,o=e.getMap(),i=u.Geometry.getCrossAround(s,a,1,!0),l=u.Geometry.coordToDirMap([s,a],i);if(l.N){const[t,i]=l.N[0],c=o.getCell(t,i);if(c&&c.isFree()){console.log("scanAndConnect north cell at",t,i);const o=this.tunnelUntilFloor(e,s,a,r.default.DIR.S);n.push(...o)}}}return n}tunnelUntilFloor(e,t,s,n){const[r,a]=n,o=[];let i=!1;const l=e.getMap();let c=0;l.setBaseElems([[t,s]],d.ELEM.FLOOR);let u=!1,h=!1;for(;!i;){const[e,n]=[t+c*r,s+c*a];if(!l.hasXY(e,n)){i=!1;break}l.getCell(e,n).isFree()?u&&(h=!0):(u=!0,o.push([e,n]),l.setBaseElemXY(e,n,d.ELEM.FLOOR)),++c,i=u&&h}return i?o:[]}populateTunnel(e,t,s){const n=[s[0],s[s.length-1]],{actorConstr:r}=t;if(r){const t=Math.round(s.length/5),a=this.getActorsForNest(r,t);c.Placer.addActorsToCoord(e,s,a)&&a.forEach(e=>{const t=new p.EvaluatorPatrol(.7,n);e.getBrain().getGoal().addEvaluator(t)})}}}t.NestGenerator=b},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Battle=t.Army=void 0;const r=n(s(0)),a=s(12),o=s(8),i=s(25),l=s(5)("bitn:game.battle"),c=a.EventPool.getPool();class u extends i.Entity{constructor(e){super(),this._name=e,this._actors=[],this._battle=null,this._casualties=0,this._defeatThreshold=0,this.hasNotify=!0,this._alignment={},c.listenEvent(r.default.EVT_ACTOR_KILLED,this)}getName(){return this._name}addAlignment(e,t){this._alignment[e]=t}setDefeatThreshold(e){this._defeatThreshold=e}isDefeated(){return this._actors.length<=this._defeatThreshold}setBattle(e){this._battle=e}getBattle(){return this._battle}getCasualties(){return this._casualties}getActors(){return this._actors.slice()}hasActor(e){const t=e.getID();return this._actors.findIndex(e=>e.getID()===t)>=0}addActor(e){return this.hasActor(e)?(r.default.err("Game.Army","addActor","Actor already in army "+this.getName()),!1):(this._actors.push(e),!0)}removeActor(e){const t=this._actors.findIndex(t=>t.getID()===e.getID());return t>=0&&(this._actors.splice(t,1),!0)}removeAllActors(){this._actors=[]}notify(e,t){if(e===r.default.EVT_ACTOR_KILLED){l(this._name+" got EVT_ACTOR_KILLED");const e=t.actor;if(this.hasActor(e))if(this.removeActor(e)){++this._casualties;let t=`Battle: ${this.getBattle().getName()}, Army ${this._name}`;t+=" Actor: "+e.getID(),l(`\tCasualties: ${this._casualties} ${t}`);const s={type:"Actor killed",army:this};l(this._name+" emit EVT_ARMY_EVENT"),c.emitEvent(r.default.EVT_ARMY_EVENT,s),0===this._actors.length&&(l("<>Army<> "+this._name+" decimated"),l("\tCasualties: "+this._casualties),c.removeListener(this))}else{let t="Battle: "+this.getBattle().getName();t+="Couldn't remove the actor "+e.getName(),r.default.err("Game.Army","notify",t)}}}toJSON(){return{id:this.getID(),name:this._name,actors:this._actors.map(e=>e.getID()),defeatThreshold:this._defeatThreshold,alignment:this._alignment}}}t.Army=u;class h extends i.Entity{constructor(e){super(),this._name=e,this._armies=[],this._level=null,this.finished=!1,this._stats={duration:0,casualties:0,survivors:0},this.hasNotify=!0,c.listenEvent(r.default.EVT_ARMY_EVENT,this)}setParent(e){this._parent=e}getParent(){return this._parent}getType(){return"battle"}getArmies(){return this._armies.slice()}setArmies(e){this._armies=e,this._armies.forEach(e=>{e.setBattle(this)})}getName(){return this._name}setLevel(e){this._level=e,this._level.setParent(this)}getLevel(){return this._level}getStats(){return this._stats}setStats(e){this._stats=e}addArmy(e,t,s,n){const a=!!n.horizontal,o=n.numRows>0?n.numRows:1;if(r.default.isNullOrUndef([this._level]))r.default.err("Game.Battle","addArmy","Level must exist before adding army.");else{this._armies.push(e);const n=e.getActors(),r=Math.ceil(n.length/o);if(a){let e=0;for(let a=0;a<o;a++)for(let o=0;o<r;o++)e<n.length&&this.addActor(n[e++],t+o,s+a)}else{let e=0;for(let a=0;a<o;a++)for(let o=0;o<r;o++)e<n.length&&this.addActor(n[e++],t+a,s+o)}}e.setBattle(this)}addActor(e,t,s){const n=this._level.getMap().getCell(t,s);n.isPassable()||n.setBaseElem(o.ELEM.FLOOR),this._level.addActor(e,t,s)||r.default.err("Game.Battle","addActor",`Cannot add ${e} to ${t},${s}`)}armyInThisBattle(e){return this._armies.indexOf(e)>=0}isOver(){if(this._armies.length>1){let e=0;if(this._armies.forEach(t=>{t.isDefeated()||++e}),e<=1)return!0}else r.default.err("Game.Battle","isOver","Battle should have >= 2 armies.");return!1}notify(e,t){if(e===r.default.EVT_ARMY_EVENT){const e=this.getName();l(e+" got EVT_ARMY_EVENT");const{type:s,army:n}=t;if(this.armyInThisBattle(n)&&"Actor killed"===s&&!this.finished&&this.isOver()){l(`Battle |${e}| is over!`),l("\tRemoving all event listeners"),c.removeListener(this);const t={battle:this};l(e+" emit EVT_BATTLE_OVER"),c.emitEvent(r.default.EVT_BATTLE_OVER,t),this.finished=!0}}}toJSON(){const e={isJSON:!0,id:this.getID(),name:this._name,level:this._level.getID(),armies:this._armies.map(e=>e.toJSON()),stats:this._stats,finished:this.finished};return this._parent&&(e.parent=this._parent.getID()),e}removeListeners(){this._armies.forEach(e=>{c.removeListener(e)}),c.removeListener(this)}}t.Battle=h},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||n(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),r(s(217),t),r(s(218),t),r(s(219),t),r(s(479),t)},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorldCreator=t.WorldConf=void 0;const r=n(s(0)),a=s(1),o=s(63),i=a.Random.getRNG(),l={seed:0,difficulty:"Medium",items:"Medium",monsters:"Medium",worldSize:"Medium",areaSize:"Medium",climate:"Medium",elevation:"Medium",mountainSize:"Medium",excavation:"Medium",dungeonSize:"Medium",forestation:"Medium",population:"Medium",citySize:"Medium",size:"Medium",water:"Sparse"},c={Small:1,Medium:2,Large:4,Huge:8},u={Small:.7,Medium:1,High:1.3,Huge:1.7},h={Small:{x:3,y:3},Medium:{x:5,y:5},Large:{x:5,y:7},Huge:{x:7,y:9}};t.WorldConf={},t.WorldConf.featCoeff=.3;const d=(e,t)=>i.getUniformInt(e,t);t.WorldConf.getBaseConf=e=>{let s=null;switch(e){case"branch":s=t.WorldConf.createSingleBranchConf();break;case"city":s={name:"city",nQuarters:1,quarter:[t.WorldConf.createSingleQuarterConf()]};break;case"dungeon":s={name:"dungeon",nBranches:1,branch:[t.WorldConf.createSingleBranchConf()]};break;case"face":s=t.WorldConf.createSingleFaceConf();break;case"mountain":s={name:"mountain",nFaces:1,face:[t.WorldConf.createSingleFaceConf()]};break;case"quarter":s=t.WorldConf.createSingleQuarterConf();break;default:console.log("No legal featureType given")}return s},t.WorldConf.createQuarterConnections=e=>{if(1===e.length)return null;const t=[];for(let s=1;s<e.length;s++){const n=e[s-1],a=e[s];let o=i.getWeightedLinear(n.nLevels-1);const l=0;r.default.isNullOrUndef([o])&&(o=n.nLevels-1),r.default.isNullOrUndef([o,l])&&r.default.err("WorldConf","createQuarterConnections",`l0 ${o} or l1 ${l} is undef`);const c=[n.name,a.name,o,l];t.push(c)}return t},t.WorldConf.createFaceConnections=(e,t)=>{if(1===t.length)return null;const s=[];for(let e=1;e<t.length;e++){const n=t[e-1],a=t[e];let o=i.getWeightedLinear(n.nLevels-1);const l=0;r.default.isNullOrUndef([o])&&(o=n.nLevels-1);const c=[n.name,a.name,o,l];s.push(c)}return s},t.WorldConf.createBranchConnections=(e,t)=>{if(1===t.length)return null;const s=[];for(let e=1;e<t.length;e++){const n=t[e-1],a=t[e];let o=i.getWeightedLinear(n.nLevels-1);const l=0;r.default.isNullOrUndef([o])&&(o=n.nLevels-1);const c=[n.name,a.name,o,l];s.push(c)}return s},t.WorldConf.setDistFromStart=(e,t)=>{const s=Math.floor(t.maxX/2),n=t.maxY;e.distX=Math.abs(e.x-s),e.distY=Math.abs(e.y-n),e.distSqr=Math.sqrt(Math.pow(e.distX,2)+Math.pow(e.distY,2))},t.WorldConf.getPlayerStart=(e,t)=>{const s=e.maxY-1,n=Math.floor(e.maxX/2);return{place:t.name,x:n,y:s}},t.WorldConf.getXYInArea=e=>({x:d(0,e.maxX-1),y:d(0,e.maxY-1)}),t.WorldConf.getNumBranches=(e,t)=>{switch(t.dungeonSize){case"Small":return 1;case"Medium":return d(1,2);case"Large":return d(1,3);case"Huge":return d(1,4);default:return 1}},t.WorldConf.getNumQuarters=(e,t)=>{switch(t.citySize){case"Small":return 1;case"Medium":return d(1,2);case"Large":return d(1,3);case"Huge":return d(1,4);default:return 1}},t.WorldConf.getNumFaces=(e,t)=>{switch(t.mountainSize){case"Small":return 1;case"Medium":return d(1,2);case"Large":return d(1,3);case"Huge":return d(1,4);default:return 1}},t.WorldConf.getNumLevels=e=>{switch(e){case"dungeon":return d(1,10);case"city":case"mountain":return d(1,3);default:return 1}},t.WorldConf.scaleNumFeatures=(e,t)=>{switch(e){case"dungeon":return u[t.excavation];case"mountain":return u[t.elevation];case"city":return u[t.population];default:r.default.err("Creator","scaleNumFeatures","Unknown feat type "+e)}return 1},t.WorldConf.getNumFeatures=(e,s,n)=>{let r=(s.maxX+1)*(s.maxY+1);return r=Math.ceil(r*t.WorldConf.scaleNumFeatures(e,n)),r=i.getNormal(r,t.WorldConf.featCoeff*r),r},t.WorldConf.createDungeonsConf=(e,s)=>{const n=t.WorldConf.getNumFeatures("dungeon",e,s),r=[];for(let a=0;a<n;a++){const n=t.WorldConf.createSingleDungeonConf(e,s);r.push(n)}return r},t.WorldConf.createSingleDungeonConf=(e,s)=>{const n=t.WorldConf.getXYInArea(e),r=Object.assign({},e);r.x=n.x,r.y=n.y,t.WorldConf.setDistFromStart(r,e);const a=t.WorldConf.createBranchesConf(r,s),i=t.WorldConf.createBranchConnections("branch",a),l={name:o.Names.getGenericPlaceName("dungeon"),x:n.x,y:n.y,nBranches:a.length,branch:a};return i&&(l.connectLevels=i),l},t.WorldConf.createBranchesConf=(e,s)=>{const n=t.WorldConf.getNumBranches(e,s),r=[];for(let e=0;e<n;e++){const s=t.WorldConf.createSingleBranchConf();r.push(s),0===e&&(s.entranceLevel=0)}return r},t.WorldConf.createSingleBranchConf=()=>{const e=t.WorldConf.getNumLevels("dungeon");return{dungeonX:80,dungeonY:28,sqrPerItem:40,sqrPerActor:40,maxDanger:2,maxValue:100,dungeonType:"digger",name:o.Names.getGenericPlaceName("branch"),nLevels:e}},t.WorldConf.createSingleQuarterConf=()=>({nLevels:t.WorldConf.getNumLevels("city"),name:o.Names.getGenericPlaceName("quarter")}),t.WorldConf.createSingleFaceConf=()=>{const e=t.WorldConf.getNumLevels("mountain");return{x:100,y:200,name:o.Names.getGenericPlaceName("face"),nLevels:e}};class f{constructor(){this.nCreated={}}createWorldConf(e){e.name||r.default.err("Creator","createWorldConf","conf.name must be specified."),Object.keys(l).forEach(t=>{e.hasOwnProperty(t)||(e[t]=l[t])}),this.rand=new a.Random,this.rand.setSeed(e.seed);const s=this.createAreasConf(e),n=t.WorldConf.getPlayerStart(s[0],e);return{name:e.name,nAreas:s.length,area:s,playerStart:n}}createAreasConf(e){const t=c[e.worldSize],s=[];for(let n=0;n<t;n++){const t=this.createSingleAreaConf(n,e);s.push(t)}return s}createSingleAreaConf(e,s){const n=h[s.areaSize],a=s.maxX||n.x,o=s.maxY||n.y,i={maxX:a,maxY:o,areaNum:e},l=t.WorldConf.createDungeonsConf(i,s),c=this.createCitiesConf(i,s),u=this.createMountainsConf(i,s);return{name:this.getName("area"),cols:r.default.AREA_LEVEL_COLS,rows:r.default.AREA_LEVEL_ROWS,maxX:a,maxY:o,nDungeons:l.length,nCities:c.length,nMountains:u.length,dungeon:l,city:c,mountain:u}}createCitiesConf(e,s){const n=t.WorldConf.getNumFeatures("city",e,s),r=[];for(let t=0;t<n;t++){const t=this.createSingleCityConf(e,s);r.push(t)}return r}createSingleCityConf(e,s){const n=t.WorldConf.getXYInArea(e),r=Object.assign({},e);r.x=n.x,r.y=n.y,t.WorldConf.setDistFromStart(r,e);const a=this.createQuartersConf(r,s),o=t.WorldConf.createQuarterConnections(a),i={name:"",x:n.x,y:n.y,nQuarters:a.length,quarter:a};return o&&(i.connectLevels=o),i}createQuartersConf(e,s){const n=t.WorldConf.getNumQuarters(e,s),r=[];for(let e=0;e<n;e++){const s=t.WorldConf.createSingleQuarterConf();0===e&&(s.entranceLevel=0),r.push(s)}return r}createMountainsConf(e,s){const n=t.WorldConf.getNumFeatures("mountain",e,s),r=[];for(let t=0;t<n;t++){const t=this.createSingleMountainConf(e,s);r.push(t)}return r}createSingleMountainConf(e,s){const n=t.WorldConf.getXYInArea(e),r=Object.assign({},e);r.x=n.x,r.y=n.y,t.WorldConf.setDistFromStart(r,e);const a=this.createFacesConf(r,s),o=t.WorldConf.createFaceConnections("mountain",a),i={name:"",x:n.x,y:n.y,nFaces:a.length,face:a};return o&&(i.connectLevels=o),i}createFacesConf(e,s){const n=t.WorldConf.getNumFaces(e,s),r=[];for(let e=0;e<n;e++){const s=t.WorldConf.createSingleFaceConf();r.push(s),0===e&&(s.entranceLevel=0)}return r}getName(e){return this.nCreated.hasOwnProperty(e)||(this.nCreated[e]=0),this.nCreated[e]+=1,`${e} ${this.nCreated[e]}`}}t.WorldCreator=f,t.WorldConf.Creator=f},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.OWMap=void 0;const r=s(5)("bitn:OW"),a=n(s(0)),o=s(18),i=s(35),l=s(10),c=s(4),u=s(94),h=s(1),d=s(223),f=s(224),g=s(7),p=h.Random.getRNG;class m{constructor(){this._baseMap=[],this._explored={},this._subLevels=[],this._hWalls=[],this._vWalls=[],this._features={},this._featureData={},this._featuresByXY={},this._biomeMap={},this._terrMap=null,this.debugMap={},this._paths={},this._pathsXY={}}static fromJSON(e){const t=new m;return t.setMap(e.baseMap),t._features=e.features,t._featuresByXY=e.featuresByXY,t._vWalls=e.vWalls,t._hWalls=e.hWalls,t._biomeMap=e.biomeMap,t._explored=e.explored,t._paths=e.paths,e.terrMap&&(t._terrMap=f.Territory.fromJSON(e.terrMap)),t}hasTerrMap(){return!!this._terrMap}getSizeXY(){return[this.getSizeX(),this.getSizeY()]}getCenterX(){return Math.round(this.getSizeX()/2)}getCenterY(){return Math.round(this.getSizeY()/2)}isWallTile(e,t){const s=this._baseMap[e][t];return u.OW.ALL_WALLS_LUT.hasOwnProperty(s)}isTerm(e,t){return this._baseMap[e][t]===u.OW.TERM}numTiles(e){let t=0;const[s,n]=this.getSizeXY();for(let r=0;r<s;r++)for(let s=0;s<n;s++)this._baseMap[r][s]===e&&++t;return t}numWallTiles(){let e=0;const[t,s]=this.getSizeXY();for(let n=0;n<t;n++)for(let t=0;t<s;t++)this.isWallTile(n,t)&&++e;return e}getBiomeMap(){return this._biomeMap}getBiome(e,t){const s=e+","+t;return this._biomeMap.hasOwnProperty(s)?this._biomeMap[e+","+t]:(a.default.err("OWMap","getBiome",`No biome set for x,y ${e},${t}`),"")}getMap(){return this._baseMap}getCell(e){return this._baseMap[e[0]][e[1]]}numHWalls(){return this._hWalls.length}numVWalls(){return this._vWalls.length}getHWall(e){return e<this._hWalls.length?this._hWalls[e]:null}getVWall(e){return e<this._vWalls.length?this._vWalls[e]:null}getHWalls(){return this._hWalls}getVWalls(){return this._vWalls}setMap(e){const t=e.length;this._baseMap=e;for(let e=0;e<t;e++)this._subLevels[e]=[]}setTerrMap(e){this._terrMap=e}getTerrMap(){return this._terrMap}addBiome(e,t,s){const n=e+","+t;this._biomeMap[n]=s}addVWall(e){e.type="vertical",this._vWalls.push(e)}addHWall(e){e.type="horizontal",this._hWalls.push(e)}hasFeatureAt(e){const t=a.default.toKey(e);return this._featuresByXY.hasOwnProperty(t)}addFeature(e,t){const s=e[0]+","+e[1];this._features.hasOwnProperty(t)||(this._features[t]=[]),this._featuresByXY.hasOwnProperty(s)||(this._featuresByXY[s]=[]),this._features[t].push(e),this._featuresByXY[s].push(t)}getFeatureData(e){return this.hasFeatureData(e)?this._featureData[a.default.toKey(e)]:[]}addFeatureData(e,t){const s=a.default.toKey(e);this._featureData.hasOwnProperty(s)||(this._featureData[s]=[]),this._featureData[s].push(t)}hasFeatureData(e){const t=a.default.toKey(e);return!!this._featureData[t]}hasFeatureDataWith(e,t){if(this.hasFeatureData(e)){const s=a.default.toKey(e),n=this._featureData[s];for(let e=0;e<n.length;e++)if(n[e].tags){if(n[e].tags.indexOf(t)>=0)return!0}}return!1}getXYForFeatureDataWith(e,t){let s=null;return Object.keys(this._featureData).forEach(n=>{this._featureData[n].forEach(r=>{if(!s&&r[e]){const o=r[e];(o===t||Array.isArray(o)&&o.indexOf(t)>=0)&&(s=a.default.fromKey(n))}})}),s}getFeaturesByType(e){return this._features.hasOwnProperty(e)?this._features[e]:[]}getFeaturesByXY(e){const t=a.default.toKey(e);return this._featuresByXY[t]}addPath(e,t){this._paths[e]=t,t.forEach(e=>{this._pathsXY[e.x+","+e.y]=t})}getPathAtXY(e){if(this.hasPathAt(e)){const t=a.default.toKey(e);return this._pathsXY[t]}return null}hasPathAt(e){const[t,s]=e,n=t+","+s;return this._pathsXY.hasOwnProperty(n)}getFeaturesOnPath(e){const t={};return e.forEach(e=>{const{x:s,y:n}=e;this.hasFeatureAt([s,n])&&(t[s+","+n]=this.getFeaturesByXY([s,n]))}),t}addSubLevel(e,t){this._subLevels[e[0]][e[1]]=t}getSubLevel(e){return this._subLevels[e[0]][e[1]]}clearSubLevels(){this._subLevels=[]}getSubLevelsWithFeature(e){return this.getFeaturesByType(e).map(e=>this.getSubLevel(e))}getAreaXY(){return this.getSizeX()*this.getSizeY()}getSizeX(){return this._baseMap.length}getSizeY(){return this._baseMap[0].length>0?this._baseMap[0].length:(a.default.warn("OWMap","getSizeY","Y-size requested but returning zero value"),0)}setExplored(e){this._explored[a.default.toKey(e)]=!0}isExplored(e){return this._explored[a.default.toKey(e)]}toJSON(){const e={baseMap:this._baseMap,biomeMap:this._biomeMap,features:this._features,featuresByXY:this._featuresByXY,vWalls:this._vWalls,hWalls:this._hWalls,explored:this._explored,paths:this._paths};return this.coordMap&&(e.coordMap=this.coordMap.toJSON()),this._terrMap&&(e.terrMap=this._terrMap.toJSON()),e}getOWMap(e=!1){const t=JSON.parse(JSON.stringify(this._baseMap)),s=t[0].length,n=t.length;if(Object.keys(this._features).forEach(e=>{this._features[e].forEach(s=>{t[s[0]][s[1]]=e})}),e)for(let e=0;e<n;e++)for(let n=0;n<s;n++)this._explored[e+","+n]||(t[e][n]="?");return Object.keys(this.debugMap).forEach(e=>{console.log("key is "+e);const[s,n]=e.split(","),r=parseInt(s,10),a=parseInt(n,10);t[r][a]=this.debugMap[e]}),t}getCellMap(){const e=this.getOWMap(),t=e[0].length,s=e.length,n=new i.CellMap(s,t);for(let r=0;r<s;r++)for(let s=0;s<t;s++){const t=new g.ElementMarker(e[r][s]);u.OW.classNames[e[r][s]]?t.setClassName(u.OW.classNames[e[r][s]]):t.setClassName(u.OW.classNames.default),n.setProp(r,s,a.default.TYPE_ELEM,t)}return n}mapToString(e=!1){const t=this.getOWMap(e),s=t[0].length,n=t.length,r=[];for(let e=0;e<s;e++){const s=[];for(let r=0;r<n;r++)s.push(t[r][e]);r.push(s)}return r.map(e=>e.join(""))}biomeMapToString(){const e=this.getSizeX()-1,t=this.getSizeY()-1,s=Object.keys(u.OW.biomeTypeMap),n={},r=s.map((e,t)=>(n[e]=""+t,`${t} - ${e}`));let a="";for(let s=0;s<t;s++){let t="";for(let r=0;r<e;r++){const e=r+","+s;t+=","+n[this._biomeMap[e]]}t+="\n",a+=t}return a+="\n"+r.join("\n"),a}filter(e){const t={},[s,n]=this.getSizeXY();for(let r=0;r<s;r++)for(let s=0;s<n;s++){const n=this.isWallTile(r,s),a=this.getFeaturesByXY([r,s]);e(r,s,a,n)&&(t[r+","+s]=a)}return t}addPathToDebug(e){e.forEach((t,s)=>{0===s?this.debugMap[t.x+","+t.y]="X":s===e.length-1?this.debugMap[t.x+","+t.y]="0":this.debugMap[t.x+","+t.y]="*"})}getPaths(){return this._paths}getPath(e){return this._paths[e]?this._paths[e]:[]}}function y(e,t,s,n=!1){const r=s.length;let a=!1;const o={y:t,x:[1]};s[0][t]=u.OW.TT_W,n||(s[r-1][t]=u.OW.TT_E);for(let e=1;e<r-1;e++)a||(s[e][t]!==u.OW.EMPTY?n?(a=!0,s[e][t]=u.OW.TT_E,o.x.push(e)):s[e][t]=u.OW.XX:s[e][t]=p().getWeighted(u.OW.LINE_WE_WEIGHT));a||(n&&(s[r-1][t]=u.OW.TT_E),o.x.push(r-1)),e.addHWall(o)}function _(e,t,s,n=!1){const r=s[0].length;let a=!1;const o={x:t,y:[1]};s[t][0]=u.OW.TT_N,n||(s[t][r-1]=u.OW.TT_S);for(let e=1;e<r-1;e++)a||(s[t][e]!==u.OW.EMPTY?n?(a=!0,s[t][e]=u.OW.TT_S,o.y.push(e)):s[t][e]=u.OW.XX:s[t][e]=p().getWeighted(u.OW.LINE_NS_WEIGHT));a||(n&&(s[t][r-1]=u.OW.TT_S),o.y.push(r-1)),e.addVWall(o)}function b(e,t,s){if(s[e][t]===u.OW.EMPTY){const n=function(e,t,s){const n=s[0].length,r=s.length,a=[];if(t>0){const n=u.OW.CAN_CONNECT[s[e][t-1]].N;a.push([s[e][t-1],n])}if(t<n-1){const n=u.OW.CAN_CONNECT[s[e][t+1]].S;a.push([s[e][t+1],n])}if(e<r-1){const n=u.OW.CAN_CONNECT[s[e+1][t]].E;a.push([s[e+1][t],n])}if(e>0){const n=u.OW.CAN_CONNECT[s[e-1][t]].W;a.push([s[e-1][t],n])}return a}(e,t,s).filter(e=>e[0]!==u.OW.EMPTY&&e[0]!==u.OW.TERM);1===n.length&&n[0][1].length>0?s[e][t]=p().arrayGetRand(n[0][1]):s[e][t]=u.OW.TERM}}function v(e,t){const{playerRace:s}=t;!function(e,t){const{playerX:s,playerY:n}=t,[r,i]=function(e){const t=e.owTilesX/e.nLevelsX,s=e.owTilesY/e.nLevelsY;return[t,s]}(t);if(a.default.isNullOrUndef([s,n,r,i]))return void a.default.warn("OWMap","addHomeTownTag","playerX/Y not found in OWMapConf: "+JSON.stringify(t));const l=s*r,c=n*i,u=l+r-1,h=c+i-1;let d=!1,f=r*i*2,g=null;for(;!d;)g=p().getRandInBbox(new o.BBox(l,c,u,h)),e.isWallTile(g[0],g[1])||(e.addFeatureData(g,{tags:["hometown"]}),d=!0),0==--f&&(console.log("Generated OWMap\n:"+e.mapToString().join("\n")),a.default.err("overworld.map.ts","addHomeTownTag","Failed to find owTileX/Y for player. Conf: "+JSON.stringify(t)))}(e,t);const n=e.getXYForFeatureDataWith("tags","hometown");if(!n)return void a.default.err("overworld.map.ts","createOverWorldTerritories","Unable to find owX/Y for player hometown");const r=d.TerritoryMap.create(e,s,n);e.setTerrMap(r)}function E(e,t){const s=e.getSizeX()*e.getSizeY(),n=e.numTiles(u.OW.TERM),r=e.numWallTiles(),o=t.nDungeonsSouth||Math.floor(r/12),i=t.nDungeonsCenter||Math.floor(r/24),l=t.nDungeonsNorth||Math.floor(r/24),h=t.nMountainsNorth||Math.floor(s/40),d=t.nMountainsMiddle||Math.floor(s/60),f=t.nMountainsSouth||Math.floor(s/60);!function(e,t,s,n){const r=e.getMap(),o=r[0].length,i=r.length;let l=P(t,s,i,o),c=1e3;for(;r[l[0]][l[1]]!==u.OW.TERM;){if(l=P(t,s,i,o),0===c){a.default.warn("OverWorld","addFeature","No empty cell to add "+n+", "+t);break}--c}e.addFeature(l,n)}(e,"NE",.5,u.OW.BTOWER);const g=e.numHWalls();if(g>1&&(S(e,e.getHWall(1),u.OW.WCAPITAL),S(e,e.getHWall(0),u.OW.WTOWER)),g>2)for(let t=2;t<g;t++)S(e,e.getHWall(t),u.OW.VTUNNEL);const p=e.numVWalls();p>0&&(S(e,e.getVWall(p-1),u.OW.BTOWER),S(e,e.getVWall(p-1),u.OW.BCAPITAL));const m={y:{start:["wall",0],end:["wall",1]}},y={y:{start:"N",end:"wall"}},_={y:{start:["wall",1],end:"S"}};w(e,y,u.OW.BIOME.ALPINE),w(e,{x:{start:["wall",0],end:"E"}},u.OW.BIOME.ARCTIC),w(e,m,u.OW.BIOME.TUNDRA),w(e,_,u.OW.BIOME.TAIGA),C(e,o,_),C(e,i,m),C(e,l,y);const b=t.nCitySouth||Math.floor(.5*n/80),E=t.nCityCenter||Math.floor(.2*n/100),M=t.nCityNorth||Math.floor(.2*n/80);T(e,f,_),T(e,d,m),T(e,h,y),t.createTerritory?(v(e,t),function(e){const t=e.getTerrMap(),s=t.getMap();a.default.forEach2D(s,(s,n)=>{const r=[s,n],o=t.getRival(r);let i=!1;if(e.hasFeatureDataWith(r,"hometown")&&(console.log("DBG addCitiesBasedOnTerritories found hometown at",r),i=!0),t.hasRival(r))if(a.default.isSuccess(.13)||i){A(e,r,i);const t=o+"_city";e.addFeatureData(r,{type:t})}else{const t=c.Geometry.getBoxAround(s,n,1);let r=!1;t.forEach(t=>{if(!r&&e.isWallTile(t[0],t[1])&&a.default.isSuccess(.09)){e.addFeature(t,u.OW.MFORT);const s=o+"_fort";e.addFeatureData(t,{type:s}),r=!0}})}else i&&a.default.err("overworld.map.ts","addCitiesBasedOnTerritories","isHome=true but no rival found at "+r)})}(e)):(O(e,b,_),O(e,E,m),O(e,M,y))}function S(e,t,s){const n=e.getMap();let a=null;if("horizontal"===t.type){const e=t.x[0],s=t.x[t.x.length-1];a=N(n,new o.BBox(e,t.y,s,t.y),u.OW.LL_WE)}if("vertical"===t.type){const e=t.y[0],s=t.y[t.y.length-1];a=N(n,new o.BBox(t.x,e,t.x,s),u.OW.LL_NS)}r(`Placed feature ${s} to ${a}`),e.addFeature(a,s)}function w(e,t,s){const n=D(e,t);for(let t=n.ulx;t<=n.lrx;t++)for(let r=n.uly;r<=n.lry;r++)e.addBiome(t,r,s)}function C(e,t,s){const n=D(e,s);for(let s=0;s<t;s++){const t=N(e.getMap(),n,u.OW.ALL_WALLS);e.addFeature(t,u.OW.WDUNGEON)}}function T(e,t,s){const n=D(e,s);for(let s=0;s<t;s++){const t=N(e.getMap(),n,[u.OW.TERM]);e.addFeature(t,u.OW.MOUNTAIN)}}function O(e,t,s){const n=D(e,s);for(let s=0;s<t;s++){const t=N(e.getMap(),n,[u.OW.TERM]);A(e,t,!1)}}function A(e,t,s){!s&&a.default.isSuccess(u.OW.PROB_BVILLAGE)?e.addFeature(t,u.OW.BVILLAGE):e.addFeature(t,u.OW.WVILLAGE)}function M(e,t){let s=t;"string"==typeof t&&(s=[t]);if(s.indexOf(u.OW.CELL_ANY)>=0)return!0;return s.indexOf(e)>=0}function N(e,t,s){const{ulx:n,uly:r,lrx:o,lry:i}=t;let l=n===o?n:p().getUniformInt(n,o),c=i===r?i:p().getUniformInt(r,i),u=100*(o-n+1)*(i-r+1),h=M(e[l][c],s);for(;!h;){if(l=n===o?n:p().getUniformInt(n,o),c=i===r?i:p().getUniformInt(r,i),h=M(e[l][c],s),0===u){const e=`(${n},${i}) -> (${o},${r})`;a.default.warn("OverWorld","findCellRandXYInBox",`No cells of type ${s} in ${e}`);break}--u}return[l,c]}function P(e,t,s,n){let r=0,a=0,o=0,i=0;return e.match(/N/)&&(i=0,a=Math.floor(.25*t*n)),e.match(/S/)&&(a=n-1,i=.75*n,i=Math.floor(i+(1-t)*(a-i))),e.match(/E/)&&(o=s-1,r=.75*s,r=Math.floor(r+(1-t)*(o-r))),e.match(/W/)&&(r=0,o=Math.floor(.25*t*s)),[p().getUniformInt(r,o),p().getUniformInt(i,a)]}function D(e,t){if(t.isBox)return t;let s=0,n=e.getSizeX()-1,r=0,a=e.getSizeY()-1;if(t.x){const r=t.x.start,a=t.x.end;if("W"===r)s=0;else if("wall"===r){const t=e.getVWalls();t.length>0&&(s=t[0].x)}else if(Array.isArray(r)&&"wall"===r[0]){const t=e.getVWalls();t.length>r[1]&&(s=t[r[1]].x)}if("E"===a)n=e.getSizeX()-1;else if("wall"===a){const t=e.getVWalls();t.length>0&&(n=t[0].x)}else if(Array.isArray(a)&&"wall"===a[0]){const t=e.getVWalls();t.length>a[1]&&(n=t[a[1]].x)}}if(t.y){const s=t.y.start,n=t.y.end;if("N"===s)r=0;else if("wall"===s){const t=e.getHWalls();t.length>0&&(r=t[0].y)}else if(Array.isArray(s)&&"wall"===s[0]){const t=e.getHWalls();t.length>s[1]&&(r=t[s[1]].y)}if("S"===n)a=e.getSizeY()-1;else if("wall"===n){const t=e.getHWalls();t.length>0&&(a=t[0].y)}else if(Array.isArray(n)&&"wall"===n[0]){const t=e.getHWalls();t.length>n[1]&&(a=t[n[1]].y)}}return{ulx:s,lrx:n,uly:r,lry:a}}t.OWMap=m,m.isPassable=function(e,t,s){if(t<0||t>=e.getSizeX())return!1;if(s<0||s>=e.getSizeY())return!1;if(e.isWallTile(t,s)){let n=!1;if(e.hasFeatureAt([t,s])){const r=e.getFeaturesByXY([t,s]),a=u.OW.PASSABLE_FORT;r.forEach(e=>{n=n||a.indexOf(e)>=0})}return n}return!0},m.getPath=function(e,t,s){const[n,r]=t,[a,o]=s;return l.Path.getShortestPath(n,r,a,o,(t,s)=>m.isPassable(e,t,s))},m.createOverWorld=function(e={}){const t=void 0===e.yFirst||e.yFirst,s=void 0===e.topToBottom||e.topToBottom,n=void 0!==e.printResult&&e.printResult,r=e.owTilesX||40,o=e.owTilesY||20,i=new m,l=function(e,t){const s=[];for(let n=0;n<e;n++){s[n]=[];for(let e=0;e<t;e++)s[n][e]=u.OW.EMPTY}return s}(r,o);return function(e){const t=e[0].length,s=e.length;e[0][0]=u.OW.CC_NW,e[0][t-1]=u.OW.CC_SW,e[s-1][t-1]=u.OW.CC_SE,e[s-1][0]=u.OW.CC_NE;for(let t=1;t<s-1;t++)e[t][0]=p().arrayGetRand(u.OW.N_BORDER);for(let n=1;n<s-1;n++)e[n][t-1]=p().arrayGetRand(u.OW.S_BORDER);for(let n=1;n<t-1;n++)e[s-1][n]=p().arrayGetRand(u.OW.E_BORDER);for(let s=1;s<t-1;s++)e[0][s]=p().arrayGetRand(u.OW.W_BORDER)}(l),function(e,t,s){const n=t[0].length,r=t.length;let a=void 0!==s.nHWalls?s.nHWalls:[.3,.5],o=void 0!==s.nVWalls?s.nVWalls:[];const i=void 0!==s.stopOnWall&&s.stopOnWall;if(Number.isInteger(s.nHWalls)){a=[];for(let e=0;e<s.nHWalls;e++){const e=p().getUniformInt(1,19);a.push(.05*e)}a=a.sort()}if(Number.isInteger(s.nVWalls)){o=[];for(let e=0;e<s.nVWalls;e++){const e=p().getUniformInt(1,19);o.push(.05*e)}o=a.sort()}for(let s=0;s<a.length;s++){let r=i;"random"===i&&(r=p().getUniform()>=.5),y(e,Math.floor(n*a[s]),t,r)}for(let s=0;s<o.length;s++){let n=i;"random"===i&&(n=p().getUniform()>=.5),_(e,Math.floor(r*o[s]),t,n)}}(i,l,e),function(e,t,s){const n=t[0].length,r=t.length,a=s.innerWallRatio||.05,o=Math.floor(r*n*a);for(let e=0;e<o;e++){const e=p().getUniformInt(2,r-2),s=p().getUniformInt(2,n-2);t[e][s]===u.OW.EMPTY&&(t[e][s]=p().arrayGetRand(u.OW.ALL_WALLS))}}(0,l,e),s?function(e,t=!0){const s=e[0].length,n=e.length;if(t)for(let t=0;t<n;t++)for(let n=0;n<s;n++)b(t,n,e);else for(let t=0;t<s;t++)for(let s=0;s<n;s++)b(s,t,e)}(l,t):function(e,t=!0){const s=e[0].length,n=e.length;if(t)for(let t=0;t<n;t++)for(let n=s-1;n>=0;n--)b(t,n,e);else for(let t=s-1;t>=0;t--)for(let s=0;s<n;s++)b(s,t,e)}(l,t),e.printResult&&a.default.printMap(l),i.setMap(l),E(i,e),function(e,t){const s=e.getFeaturesByType(u.OW.BTOWER),n=e.getFeaturesByType(u.OW.WCAPITAL),r=m.getPath(e,n[0],s[0]);e.addPath(u.OW.PATH_WCAP_BTOWER,r);const a=e.getFeaturesOnPath(r),o=(r.length,Object.keys(a).length,e.filter((t,s,n,r)=>{if(!n)return!1;if(s===e.getSizeY()-2){if(M(u.OW.WVILLAGE,n))return!0;if(M(u.OW.BVILLAGE,n))return!0;if(e.isTerm(t,s))return!0}return!1}));let i=p().arrayGetRand(Object.keys(o));if(!i){const t=e.filter((t,s,n,r)=>!!(s<e.getSizeY()-1&&s>=e.getSizeY()-3&&e.isTerm(t,s)));i=p().arrayGetRand(Object.keys(t))}if(i){const[t,s]=i.split(","),r=[parseInt(t,10),parseInt(s,10)],a=m.getPath(e,r,n[0]);e.addPath(u.OW.PATH_BEGIN_WCAP,a)}}(i),n&&a.default.log("\n",i.mapToString().join("\n")),e.verify&&function(e){let t="";const s=[u.OW.PATH_WCAP_BTOWER,u.OW.PATH_BEGIN_WCAP];s.forEach(s=>{const n=e.getPath(s);n&&0!==n.length||(t+=`Path ${s} not OK: |${JSON.stringify(n)}|\n`)}),""!==t&&(s.forEach(t=>{const s=e.getPath(t);e.addPathToDebug(s)}),console.log(e.mapToString()),a.default.err("overworld.map.ts","verifyOverWorld",t))}(i),i}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CoordMap=t.OWSubLevel=t.OWSubFeature=t.OWWall=t.OverWorld=void 0;const r=n(s(0)),a=s(63),o=s(490),i=s(10),l=s(62),c=(s(21),s(139)),u=s(491),h=s(493),d=s(94),f=s(8),g=s(1),p=s(19),m=s(4),y=s(141),_=s(18),b=s(5)("bitn:overworld");t.OverWorld={};const v=/(capital|city|abandoned fort|fort|village)/,E=/(dwarven city|abandoned fort|capital)/,S=f.ELEM.WALL_MOUNT.getType();let w=!1;const C=g.Random.getRNG;t.OverWorld.TILE_SIZE_X=100,t.OverWorld.TILE_SIZE_Y=100;const{TILE_SIZE_X:T,TILE_SIZE_Y:O}=t.OverWorld;class A{constructor(e){this.type=e,this.coord=[]}addWallCoord(e){this.coord.push(e)}getCoordAt(e){return this.coord[e]}getWallPos(){return"vertical"===this.type?this.coord[0][0][0]:"horizontal"===this.type?this.coord[0][0][1]:d.OW.ILLEGAL_POS}getWallStart(){return"vertical"===this.type?this.coord[0][0][1]:"horizontal"===this.type?this.coord[0][0][0]:d.OW.ILLEGAL_POS}getWallEnd(){const e=this.coord.length-1;return"vertical"===this.type?this.coord[e][0][1]:"horizontal"===this.type?this.coord[e][0][0]:-1}toString(){let e=`type: ${this.type} `;return e+=`Length: ${this.coord.length}\n`,e+=`Start: ${this.getWallStart()} End: ${this.getWallEnd()}\n`,e+="Tiles: "+JSON.stringify(this.coord),e}}t.OWWall=A;class M{constructor(e,t){this.type=e,this.coord=t,this.cellsAround={},Array.isArray(t)?0===t.length?r.default.err("OWSubFeature","new","coord len is 0."):Array.isArray(t[0])||r.default.err("OWSubFeature","new","Each coord must be [x, y] pair."):r.default.err("OWSubFeature","new","coord must be an array."),this.tags=[]}getLastCoord(){return this.coord.length>0?this.coord[this.coord.length-1]:[-1,-1]}addTag(e){this.tags.push(e)}getTags(){return this.tags}hasTag(e){return this.tags.indexOf(e)>=0}hasTags(){return this.tags.length>0}}t.OWSubFeature=M;class N{constructor(e){this._level=e,this._hWalls=[],this._vWalls=[],this._subX=e.getMap().rows,this._subY=e.getMap().cols,this._features={},this._featuresByXY={}}getFeatures(){return this._features}getSubX(){return this._subX}getSubY(){return this._subY}addWall(e){"vertical"===e.type?this._vWalls.push(e):"horizontal"===e.type&&this._hWalls.push(e)}getWall(){const e=this._hWalls.length,t=this._vWalls.length;return 0===e&&0===t?null:0===e?this._vWalls[0]:(0===t||r.default.warn("OWSubLevel","getWall",`Return hor wall. Too many walls: vLen: ${t}, hLen: ${e}`),this._hWalls[0])}addFeature(e){const t=e.type;this._features.hasOwnProperty(t)||(this._features[t]=[]),this._features[t].push(e),e.coord.forEach(e=>{const s=e[0]+","+e[1];this._featuresByXY[s]=t})}getFeaturesByType(e){return this._features.hasOwnProperty(e)?this._features[e]:[]}}t.OWSubLevel=N;class P{constructor(e={}){this.worldCols=e.worldCols||0,this.worldRows=e.worldRows||0,this.nTilesX=e.nTilesX||0,this.nTilesY=e.nTilesY||0,this.xMap=e.xMap||0,this.yMap=e.yMap||0}setXYMap(e,t){this.xMap=e,this.yMap=t}getAreaLevelCols(){return this.worldCols/this.nTilesX}getAreaLevelRows(){return this.worldRows/this.nTilesY}toOwLevelXY(e,t){return[e[0]*this.xMap+t[0],e[1]*this.yMap+t[1]]}toOWTileXY(e,t){const s=this.getOWTileBboxFromAreaTileXY(e[0],e[1]);return[s.ulx+Math.floor(t[0]/this.xMap),s.uly+Math.floor(t[1]/this.yMap)]}getAreaXYFromOWTileXY(e,t){return[Math.floor(e/this.xMap),Math.floor(t/this.yMap)]}getOWTileBboxFromAreaTileXY(e,t){return Number.isInteger(e)&&Number.isInteger(t)?_.BBox.fromBBox({ulx:e*T/this.xMap,uly:t*O/this.yMap,lrx:(e+1)*T/this.xMap-1,lry:(t+1)*O/this.yMap-1}):(r.default.err("OverWorld.CoordMap","getOWTileBboxFromAreaTileXY",`Args (x,y) must be ints. Got ${e}, ${t}`),null)}toJSON(){return{worldCols:this.worldCols,worldRows:this.worldRows,nTilesX:this.nTilesX,nTilesY:this.nTilesY,xMap:this.xMap,yMap:this.yMap}}}function D(e,t,s,n,a){const o=e.getMap()[t][s],i=(e.getBiome(t,s),n),l=a,c=(new p.FactoryLevel).createLevel(r.default.LEVEL_EMPTY,i,l),u=new N(c);return e.addSubLevel([t,s],u),function(e,t,s,n,r,a){const o=a.getMap(),i=d.OW.N_HAS_CONN.findIndex(e=>e===n)>=0,l=d.OW.S_HAS_CONN.findIndex(e=>e===n)>=0,c=d.OW.E_HAS_CONN.findIndex(e=>e===n)>=0,u=d.OW.W_HAS_CONN.findIndex(e=>e===n)>=0,h=o.cols,g=o.rows,p=e.getSizeX(),m=e.getSizeY(),y=Math.floor(h/2),_=Math.floor(g/2);let b=null,v=-1,E=-1;i&&l?(v=0,E=g-1):i?(v=0,E=_-1):l&&(v=_,E=g-1);0===t?v=0:t===p-1&&(E=g-1);let S=L(E+1,5,3,h,3);if(i||l){const e=new A("vertical");for(let s=v;s<=E;s++){b=S[s-v];const n=[];1===b&&(b=5);let r=y-(b-1),a=y+(b-1);0===t&&(r=0),t===p-1&&(a=h-1);for(let e=r;e<=a;e++)n.push([e,s]);o.setBaseElems(n,f.ELEM.WALL_MOUNT),e.addWallCoord(n)}r.addWall(e)}let w=-1,C=-1;c&&u?(w=0,C=h-1):c?(w=y,C=h-1):u&&(w=0,C=y-1);0===s?w=0:s===m-1&&(C=h-1);if(S=L(C+1,5,3,h,3),c||u){const e=new A("horizontal");for(let t=w;t<=C;t++){b=S[t-w];const n=[];1===b&&(b=5);let r=_-(b-1),a=_+(b-1);0===s&&(r=0),s===m-1&&(a=g-1);for(let e=r;e<=a;e++)n.push([t,e]);o.setBaseElems(n,f.ELEM.WALL_MOUNT),e.addWallCoord(n)}r.addWall(e)}}(e,t,s,o,u,c),c}function I(e,t,s){let n=Math.floor(C().getNormal(e,t));return n>s/2?n=s/2-1:n<1&&(n=1),n}function L(e,t,s,n,r){const a=[];for(let r=0;r<e;r++)a.push(I(t,s,n));const o=[];for(let e=0;e<r;e++)o.push(a[e]);for(let t=r;t<e-r;t++){const e=x(a,t,r);o.push(e)}for(let t=e-r;t<e;t++)o.length<a.length&&o.push(a[t]);return o}function x(e,t,s){const n=2*s+1;let r=0;for(let n=t-s;n<=t+s;n++)r+=e[n];return Math.floor(r/n)}function k(e,t,s,n){const a=[t,s],o=e.getSubLevel(a),i=e.getFeaturesByXY(a),l=e.getCell(a);let c=!1;if(e.hasFeatureDataWith(a,"hometown")&&(c=!0,console.log("addSubLevelFeatures found xy with hometown:",a)),!i)return void(c&&r.default.err("overworld.ts","addSubLevelFeatures","isHome=true but no features found at "+a));let u=0;i.forEach(e=>{if(e===d.OW.WCAPITAL)R(e,o,n);else if(function(e,t){return!(e!==d.OW.LL_WE&&e!==d.OW.LL_NS||t!==d.OW.BTOWER&&t!==d.OW.WTOWER)}(l,e))R(e,o,n);else if(e===d.OW.BTOWER||e===d.OW.WTOWER)!function(e,t,s){let n=!1;const r=s.getMap().getFree().map(e=>e.getXY());let a=[],o=111;for(;9!==a.length&&(m.Geometry.getFreeArea(r,3,3,a)&&(n=!0),a.length<9&&(b("addTowerToSubLevel. Too few coords. Retrying."),n=!1,a=[]),!(--o<=0)););const i=e===d.OW.BTOWER?"blacktower":"whitetower";if(n){b("addTowerToSubLevel feat placed with "+JSON.stringify(a)),s.getMap().setBaseElems(a,f.ELEM.FORT);const n=new M(i,a);n.alignment=B(e),t.addFeature(n)}}(e,o,n);else if(e===d.OW.WDUNGEON)!function(e,t){const s=G(t);if(s&&s.length>0){const t=new M("dungeon",s);e.addFeature(t)}}(o,n);else if(e===d.OW.WVILLAGE||e===d.OW.BVILLAGE){if(function(e,t,s){const n=s.getMap().getFreeNotOnEdge();if(n.length>0){const r=n.map(e=>e.getXY()),a=C().arrayGetRand(r),o=new M("village",[a]);o.alignment=B(e);const[i,l]=a;F(s,o,i,l),t.addFeature(o)}else s.debugPrintInASCII(),r.default.err("overworld.js","addVillageToSubLevel","No free cells found in the level.")}(e,o,n),c){const e=o.getFeaturesByType("village");console.log("Adding hometown tag to feature at owXY:",a),e[0].addTag("hometown")}}else if(e===d.OW.MOUNTAIN)!function(e,t){let s=!1;const n=t.getMap().getFreeNotOnEdge(),r=n.filter(e=>e.getZ()>=2).map(e=>[e.getX(),e.getY()]);if(0===r.length)return;let a=[],o=1110;for(;!s;){const e=C().arrayGetRand(r);if(a=[e],s=!0,--o<=0)break}if(s){const t=new M("mountain",a);e.addFeature(t)}}(o,n);else if(e===d.OW.VTUNNEL)!function(e,t){const s=t.getMap(),n=s.cols,r=C().getUniformInt(0,n-1);for(let e=0;e<s.rows;e++)s.setBaseElemXY(r,e,f.ELEM.FLOOR)}(0,n);else if(e===d.OW.MFORT)!function(e,t){const s=G(t,!1);if(s&&s.length>0){const n=new M("fort",s),[r,a]=s[0];F(t,n,r,a),e.addFeature(n)}}(o,n);else{b("addSubLevelFeat Skipped: "+`Base: ${l}, ${e}`),++u}}),u>0&&b(`Skipped ${u} features in addSubLevelFeatures`)}function R(e,t,s){const n=t.getWall(),a=n.getWallStart(),o=n.getWallEnd(),i=C().getUniformInt(a,o),l=n.getCoordAt(i);let c=null;switch(e){case d.OW.WTOWER:c="dwarven city";break;case d.OW.BTOWER:c="abandoned fort";break;case d.OW.WCAPITAL:c="capital";break;case d.OW.BCAPITAL:c="dark city";break;default:r.default.err("overworld.js","addMountainFortToSubLevel",`Type ${e} not supported`)}s.getMap().setBaseElems(l,f.ELEM.FORT);const u=new M(c,l);u.alignment=B(e),t.addFeature(u)}function B(e){switch(e){case d.OW.BCAPITAL:case d.OW.BTOWER:case d.OW.BVILLAGE:return r.default.ALIGN_EVIL;case d.OW.WCAPITAL:case d.OW.WTOWER:case d.OW.WVILLAGE:return r.default.ALIGN_GOOD;default:return r.default.ALIGN_NEUTRAL}}function F(e,t,s,n){const r=e.getMap();t.cellsAround=m.Geometry.getCellsAround(r,r.getCell(s,n))}function G(e,t=!0){let s=!1;const n=e.getMap();let a=n.getFree().map(e=>e.getXY());if(!t){const{cols:e,rows:t}=n;a=a.filter(s=>0!==s[0]&&s[0]!==e-1&&0!==s[1]&&s[1]!==t-1)}if(0===a.length)return[];let o=[],i=1110;for(;!s;){const e=C().arrayGetRand(a);let l=[];try{l=m.Geometry.getBoxAround(e[0],e[1],1)}catch(e){r.default.diag(e),r.default.diag(a),n.debugPrintInASCII()}if(!t){const{cols:e,rows:t}=n;l=l.filter(s=>0!==s[0]&&s[0]!==e-1&&0!==s[1]&&s[1]!==t-1)}if(l.forEach(e=>{if(!s&&n.hasXY(e[0],e[1])){n.getBaseElemXY(e[0],e[1]).getType()===S&&(o=[e],s=!0,n.setBaseElemXY(e[0],e[1],f.ELEM.FLOOR))}}),--i<=0)break}return o}function W(e,t,s,n,i,l){const c=e.getSubLevel([t,s]).getFeatures();if(0===Object.keys(c).length)return void l.addVisited([t,s]);const u=function(e,t,s,n){const a=[],o=[t,s],i=m.Geometry.getBoxAround(t,s,5);let l=!1;if(e.hasPathAt(o)){const c=e.getPathAtXY(o),u=c.findIndex(e=>e.x===t&&e.y===s);if(u>=0){const e=u+1;if(e<c.length){const t=c[e],s=r.default.getTextualDir([t.x,t.y],o),n=y.createDirNorthMsg(s);a.push(y.createLoreObj(n,"mainQuest")),l=!0}}i.forEach(e=>{n.addVisited(e),n.addXYKnownBy(o,e),n.addXYKnownBy(e,o)})}else i.forEach(t=>{if(e.hasPathAt(t)){const e=r.default.getTextualDir(t,o),s=y.createDirNorthMsg(e);a.push(y.createLoreObj(s,"mainQuest")),l=!0}n.addXYKnownBy(t,o),n.addXYKnownBy(o,t)});b(l?`${t},${s} lore was added`:`${t},${s} NO lore was added`);return a}(e,t,s,l);Object.keys(c).forEach(e=>{c[e].forEach(e=>{e.coord||r.default.err("OverWorld","createWorldConf","coord must exist. feat: "+JSON.stringify(e));let c=null;var h,d;"capital"===e.type?c=function(e,t,s){const n={name:"Blashyrkh",nQuarters:1,quarter:[{name:"Capital cave",nLevels:1}],owX:t.x,owY:t.y};n.presetLevels={"Blashyrkh.Capital cave":[{nLevel:0,level:{stub:!0,new:"Capital",args:[200,500,{}]}}]},$(e,t,n);const r={name:"Capital cave",levelX:n.levelX,levelY:n.levelY,nLevel:0,stairs:{getStairs:1}};return n.connectToAreaXY[0].stairs={getStairs:0},n.connectToAreaXY.push(r),s.nCities+=1,s.city.push(n),n}(e,n,i):"dwarven city"===e.type?c=function(e,t,s){const n={stub:!0,new:"DwarvenCity",args:[300,250,{}]},r={name:"Dwarven City",nQuarters:1,quarter:[{name:"Fort main level",nLevels:1}],owX:t.x,owY:t.y};r.presetLevels={"Dwarven City.Fort main level":[{nLevel:0,level:n}]},$(e,t,r);const a={name:"Fort main level",levelX:r.levelX,levelY:r.levelY,nLevel:0,stairs:{getStairs:1}};return r.connectToAreaXY[0].stairs={getStairs:0},r.connectToAreaXY.push(a),s.nCities+=1,s.city.push(r),r}(e,n,i):"abandoned fort"===e.type?c=function(e,t,s){const n={stub:!0,new:"AbandonedFort",args:[500,200,{}]},r={name:"Abandoned fort",nQuarters:1,quarter:[{name:"Fort ground level",nLevels:1}],owX:t.x,owY:t.y};r.presetLevels={"Abandoned fort.Fort ground level":[{nLevel:0,level:n}]},$(e,t,r,!1);const a={name:"Fort ground level",levelX:r.levelX,levelY:r.levelY,nLevel:0,stairs:{getStairs:0}};return r.connectToAreaXY[0].stairs={getStairs:1},r.connectToAreaXY.push(a),s.nCities+=1,s.city.push(r),r}(e,n,i):"dark city"===e.type||v.test(e.type)?c=U(e,n,i):"dungeon"===e.type?c=function(e,t,s){const[n,r]=V(t),i=e.coord,{x:l,y:c,aX:u,aY:h,slX:d,slY:f,subX:g,subY:p}=t;let m=j(i[0][0],d,g),y=X(i[0][1],f,p);[m,y]=function(e){let[t,s]=e;0===t&&(t=1);t===T-1&&(t-=1);0===s&&(s=1);s===O-1&&(s-=1);return[t,s]}([m,y]);const _=a.Names.getGenericPlaceName("dungeon"),b=a.Names.getUniqueName("dungeon"),v=o.LevelGen.getDungeonConf(_);return v.uniqueName=b,Object.assign(v,{x:u,y:h,levelX:m,levelY:y,owX:l,owY:c,uniqueName:b}),s.nDungeons+=1,Y(n,r,v),s.dungeon.push(v),v}(e,n,i):"mountain"===e.type?c=function(e,t,s){const[n,r]=V(t),i=e.coord,{x:l,y:c,aX:u,aY:h,slX:d,slY:f,subX:g,subY:p}=t,m=j(i[0][0],d,g),y=X(i[0][1],f,p),_=a.Names.getUniqueName("mountain"),b=o.LevelGen.getMountainConf(_);return Object.assign(b,{x:u,y:h,levelX:m,levelY:y,owX:l,owY:c}),Y(n,r,b),s.nMountains+=1,s.mountain.push(b),b}(e,n,i):"blacktower"===e.type&&(b("Adding final blacktower now"),c=function(e,t,s){const{slX:n,slY:a,aX:i,aY:l,subX:c,subY:u}=t,h=e.coord[7];if(r.default.isNullOrUndef([h])){const t="xy null/undef. feat: "+JSON.stringify(e);r.default.err("overworld.js","addBlackTowerConfToArea",t)}const d=j(h[0],n,c),f=X(h[1],a,u),g=o.LevelGen.getDungeonConf("Elder raventhrone");Object.assign(g,{x:i,y:l,levelX:d,levelY:f});b(`BlackTower: ${i},${l}, x,y ${d},${f}`),g.connectEdges=!0,g.branch[0].entranceLevel=0,g.branch[0].nLevels=5;const p=g.branch[0].nLevels-1;return g.branch[0].createPresetLevels={stub:!1,new:"BlackTower",args:[180,90]},g.branch[0].create={actor:[{name:"Thabba, Son of Ice",nLevel:p},{name:"Zamoned, Son of Frost",nLevel:p}]},s.nDungeons+=1,s.dungeon.push(g),g}(e,n,i)),c?(d=u,(h=c).addComp?h.addComp=h.addComp.concat(d):h.addComp=d.slice(),l.addZone([t,s],c),c.uniqueName&&(c.name=c.uniqueName)):r.default.err("overworld.ts","processSubLevel",`[${t}][${s}]: No feat.type ${e.type} supported!`)})})}function Y(e,t,s){const{x:n,y:a}=s,o=Math.abs(e-n),i=Math.abs(t-a);s.maxDanger=r.default.getMaxDanger(o,i),s.maxValue=r.default.getMaxValue(o,i),C().getUniform()<=r.default.EPIC_PROB&&(s.isEpic=!0,s.maxDanger*=2,s.maxValue*=3)}function j(e,t,s){if(Number.isInteger(e)){const n=e+t*s;return n>=T&&console.warn(`WARNING mapX: ${n}, ${e}, ${t}, ${s}`),n}return r.default.err("overworld.js","mapX","x must be an integer. Got: "+e),null}function X(e,t,s){return Number.isInteger(e)?e+t*s:(r.default.err("overworld.js","mapY","y must be an integer. Got: "+e),null)}function U(e,t,s){const n=a.Names.getUniqueName("city"),i=o.LevelGen.getCityConf(n,e);return i.owX=t.x,i.owY=t.y,i.groupType=e.type,$(e,t,i),i.alignment=e.alignment||C().arrayGetRand(r.default.ALIGNMENTS),e.cellsAround&&(i.constraint||(i.constraint={}),i.constraint.cellsAround=e.cellsAround),e.hasTags()&&(i.tags=e.getTags()),s.nCities+=1,s.city.push(i),i}function $(e,t,s,n=!0){const{slX:r,slY:a,aX:o,aY:i,subX:l,subY:c}=t,u=e.coord,h=u.length-1;let d=j(u[h][0],r,l),f=X(u[h][1],a,c);if(n||(d=j(u[0][0],r,l)-1,f=X(u[0][1],a,c)),f>=O&&(f-=1),E.test(e.type)){let e=j(u[0][0],r,l),t=X(u[0][1],a,c);n||(e=j(u[h][0],r,l)+1,t=X(u[h][1],a,c));const o=s.nQuarters-1;s.connectToAreaXY=[{name:s.quarter[o].name,levelX:e,levelY:t,nLevel:0}]}s.x=o,s.y=i,s.levelX=d,s.levelY=f,b(`Feat: ${e.type}, ${o},${i} : ${d},${f}`)}function V(e){const{xMap:t,yMap:s,nSubLevelsX:n,nSubLevelsY:r}=e;return[Math.floor(n/t/2),r/s-1]}function H(e,t,s,n){const r=e*s,a=t*n;return[r,a+n-1,r+s-1,a]}t.CoordMap=P,t.OverWorld.CoordMap=P,t.OverWorld.createOverWorld=(e={})=>{const s=c.OWMap.createOverWorld(e);return t.OverWorld.createOverWorldLevel(s,e)},t.OverWorld.createOverWorldLevel=(e,s)=>{const n=new P;n.worldCols=s.worldX||400,n.worldRows=s.worldY||400,n.nTilesX=s.nTilesX||n.worldCols/T,n.nTilesY=s.nTilesY||n.worldRows/O,n.xMap=Math.floor(n.worldCols/e.getSizeX()),n.yMap=Math.floor(n.worldRows/e.getSizeY()),e.coordMap=n,w=s.addMainRoads||w;return function(e,s,n){const{worldCols:a,worldRows:o,xMap:c,yMap:u,nTilesX:f,nTilesY:g}=s,y=e.getSizeX(),_=e.getSizeY(),b=(new p.FactoryLevel).createLevel(r.default.LEVEL_EMPTY,a,o),v={};for(let t=0;t<y;t++)for(let s=0;s<_;s++){const n=D(e,t,s,c,u),a=t*c,o=s*u;m.Geometry.mergeLevels(b,n,a,o),v[r.default.toKey([t,s])]=n}h.OWBiomes.addBiomes(e,b);for(let t=0;t<y;t++)for(let s=0;s<_;s++){const n=v[r.default.toKey([t,s])],a=t*c,o=s*u;m.Geometry.copyBaseElems(b,n,a,o),k(e,t,s,n)}const E=t.OverWorld.createWorldConf(e,y,_,f,g,n);return function(e,t,s,n){const[a,o]=function(e,t){const s=Math.floor(e.getSizeX()/2-1)*T,n=t.worldRows-Math.floor(O/2);return[s,n]}(e,n),c=e.getFeaturesByType(d.OW.WCAPITAL)[0],u=e.getSubLevel(c).getFeaturesByType("capital")[0],h=u.getLastCoord(),[f,g]=n.toOwLevelXY(c,h);if(w){const e=i.Path.getWeightPathSegmented(t.getMap(),a,o,f,g,5);0===e.length&&r.default.err("overworld.js","addGlobalFeatures","No path from player to capital."),l.Builder.addPathToMap(t.getMap(),e)}const p=u.coord[0],m=n.toOwLevelXY(c,p),y=e.getFeaturesByType(d.OW.WTOWER)[0],_=e.getSubLevel(y),b=_.getFeaturesByType("dwarven city")[0].getLastCoord(),v=n.toOwLevelXY(y,b);if(w){const e=i.Path.getWeightPathSegmented(t.getMap(),m[0],m[1],v[0],v[1],5);l.Builder.addPathToMap(t.getMap(),e)}}(e,b,0,s),[b,E]}(e,n,s)},t.OverWorld.createWorldConf=function(e,t,s,n,a,o){const i={name:"The North",nAreas:1,area:[{cols:100,rows:100,name:"The Northern Realm",maxX:n,maxY:a,biome:{},dungeon:[],mountain:[],city:[],nDungeons:0,nMountains:0,nCities:0}]},l=i.area[0];if(!t||!s){const e=`levels in X: ${t}, Y: ${s}`;r.default.err("OverWorld","createWorldConf","Illegal num of sublevels: "+e)}const c=t/n,h=s/a;b(`nSubLevelsX: ${t}, nTilesX: ${n}`),b(`nSubLevelsY: ${s}, nTilesY: ${a}`),b(`MapX: ${c} levels to one tile`),b(`MapY: ${h} levels to one tile`),Number.isInteger(c)||r.default.err("OverWorld","createWorldConf",`xMap not int: ${c}, sub X :${t}, nTilesX: ${n}`),Number.isInteger(h)||r.default.err("OverWorld","createWorldConf",`yMap not int: ${h}, sub Y :${s}, nTilesY: ${a}`);const d=Date.now(),f=new u.OWLore;for(let n=0;n<t;n++)for(let r=0;r<s;r++){const a=n%c,o=r%h,i=Math.floor(n/c),u=Math.floor(r/h),d=e.getSubLevel([n,r]),g={xMap:c,yMap:h,nSubLevelsX:t,nSubLevelsY:s,x:n,y:r,slX:a,slY:o,aX:i,aY:u,subX:d.getSubX(),subY:d.getSubY()};b(`Processing subLevel[${n}][${r}] with ${JSON.stringify(g)}`),W(e,n,r,g,l,f)}f.buildLore();const g=Date.now()-d;return console.log("overworld.ts Processing subLevels took "+g+" ms"),function(e,t){const s=e.getSizeX(),n=e.getSizeY(),r=s/t.maxX,a=n/t.maxY;t.biome||(t.biome={});for(let s=0;s<t.maxX;s++)for(let n=0;n<t.maxY;n++){const o=H(s,n,r,a),i=s+","+n,l=e.getBiome(o[0],o[3]);t.biome[i]=l}}(e,l),i}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createLoreObj=t.createLoreMsg=t.createDirNorthMsg=t.formatMsg=t.compile=t.prep=t.Lore=void 0;const r=s(492),a=n(s(0)),o=s(1).Random.getRNG();t.Lore={generic:[],mainQuest:[],directions:[],northDirections:[],genericTopics:["generic","mainQuest"],typesDirections:[]},t.Lore.getRand=e=>{d(e);const s=t.Lore[e];return console.log("WWW:",s),o.arrayGetRand(s)},t.Lore.getRandText=e=>{d(e);const s=t.Lore[e],n=o.arrayGetRand(s);return o.arrayGetRand(n.text)};const i=new RegExp("[().]+");function l(e,...t){let s=e[0];for(let n=0;n<t.length;n++)h(t[n])||(s+=c(t[n],"Pre")),s+="<%= "+t[n]+" %>",h(t[n])||(s+=c(t[n],"Post")),s+=e[n+1];return s}function c(e,t){const s=`${e}${t}`;return`<% if (typeof ${s} !== "undefined") { %><%= ${s} %><% } %>`}function u(e,t){return r.compile(e)(t)}function h(e){return i.test(e)}function d(e){t.Lore.hasOwnProperty(e)||a.default.err("lore.ts","checkKeyError",`Key ${e} does not exist`)}t.Lore.generic=[{level:[{op:"match",func:"getParentZone.getName",value:"Home town"}],text:[l`Welcome home ${"asker.getName()"}!`,l`Are you returning home from an adventure, ${"asker.getName()"}?`]},{text:["An instant of one second is a luxury amidst the heat of the battle","One day, all matter will be frozen and all movement will cease"]}],t.Lore.mainQuest=[{text:["There is something evil gathering its troops in the northern arctics","To reach the north, you need to pass through several great mountain walls"]},{text:["I've heard rumors of a great northern city carved into the mountainside"]},{text:["Hyrkhians who are natives of this land have a built a great city into the mountain","They say you need to pass through mighty dwarven fortress to reach the cold north"]},{text:["Adventurers have seen strange and cold-looking creatures gathering near an abandoned fort"]},{text:["A traveller had seen a gigantic black tower rising into the sky from beneath the icy arctic."]}],t.Lore.directions=[{text:[l`There might be something interesting in ${"dir"} to explore`]},{text:[l`Travel ${"dir"} if you are looking for adventures`]},{text:[l`I've heard rumors of something going on in ${"dir"} from here`]}],t.Lore.typesDirections=[{text:[l`There is ${"name"} ${"dir"} from here.`]},{text:[l`If you travel ${"dir"}, you should find a ${"name"} there.`]}],t.Lore.northDirections=t.Lore.directions,t.prep=l,t.compile=function(e){return r.compile(e)},t.formatMsg=u,t.createDirNorthMsg=function(e){const s=o.arrayGetRand(t.Lore.northDirections);return u(o.arrayGetRand(s.text),{dir:e})},t.createLoreMsg=function(e){const s=o.arrayGetRand(t.Lore.northDirections);return u(o.arrayGetRand(s.text),{dir:e})},t.createLoreObj=function(e,t,s){const n={comp:"Lore",func:{addEntry:{topic:t,respMsg:e}}};return s&&(n.func.addEntry.metaData=s),n}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemEffects=void 0;const i=o(s(0)),l=s(3),c=s(17),u=a(s(2)),h=s(8),d=s(6),f=s(7),g={AddComp:!0,ModifyCompValue:!0,AddEntity:!0,AddElement:!0,RemoveElement:!0,ChangeElement:!0,RemoveComp:!0};let p=Object.keys(g);class m extends l.SystemBase{constructor(e,t){super(i.default.SYS.EFFECTS,e,t),this._dtable={},Object.keys(g).forEach(e=>{if(g[e]){const t="handle"+e.capitalize();this._dtable[e]=this[t].bind(this)}})}static addEffect(e,t){if(!g.hasOwnProperty(e)){const s="handle"+e.capitalize();return m.prototype[s]=t,g[e]=!0,p=Object.keys(g),!0}return i.default.err("SystemEffects","addEffect",`Effect ${e} already exists.`),!1}static getEffectTarget(e){const t=e.target;if(!t){const e="Possibly missing args for useItem().";i.default.err("system.effects.js","getEffectTarget","Given object was null/undefined. "+e)}return m.getTargetFromObj(t,e.targetType)}static getTargetFromObj(e,t){if(!e.hasOwnProperty("target"))return e;{const s=e.target;let n=t;if(n||(n=["actors","items","elements","baseElem"]),Array.isArray(n)||(n=[n]),"cell"===n[0])return s;for(let e=0;e<n.length;e++){if(s.hasProp(n[e]))return s.getProp(n[e])[0];if(/base/.test(n[e]))return s.getBaseElem()}}return null}updateEntity(e){e.getList("Effects").forEach(t=>{const s=t.getEffectType();if(s&&""!==s)if(this._dtable.hasOwnProperty(s)){this._checkStartMsgEmits(e,t);const n=this._dtable[s](e,t);this._checkEndMsgEmits(e,t,n),this._postEffectChecks(e,t,n)}else i.default.err("SystemEffects","updateEntity",`Effect |${s}| not in handler list: ${p}`);else i.default.err("SystemEffects","updateEntity","No effect type in Effects comp");e.remove(t)})}_checkStartMsgEmits(e,t){const s=t.getArgs();s.startMsg&&i.default.gameMsg({cell:e.getCell(),msg:s.startMsg})}_checkEndMsgEmits(e,t,s){const n=t.getArgs();n.endMsg&&i.default.gameMsg({cell:e.getCell(),msg:n.endMsg}),s&&n.successMsg&&i.default.gameMsg({cell:e.getCell(),msg:n.successMsg}),!s&&n.failureMsg&&i.default.gameWarn({cell:e.getCell(),msg:n.failureMsg})}_postEffectChecks(e,t,s){t.getArgs();if(s)if(e.has("OneShot")&&e.getCount)if(1===e.getCount()){const t={item:e};this.pool.emitEvent(i.default.EVT_DESTROY_ITEM,t)}else e.decrCount(1);else e.getCharges&&e.getCharges()>0&&e.setCharges(e.getCharges()-1)}handleAddComp(e,t){const s=t.getArgs();let n=m.getEffectTarget(s);const r=y(s,n);let a=null;if(u.hasOwnProperty(r)&&(a=new u[r]),s.setters){const e=s.setters;Object.keys(e).forEach(t=>{if("function"==typeof a[t]){const s=e[t];if("$$target"===s)a[t](n);else{const e=_(s);a[t](e)}}else{const e=JSON.stringify(a);i.default.err("useEffect","addComp",`No ${t} in comp ${e}`)}})}if(a&&a.setSource&&a.setSource(e),s.addOnUser&&(n=e),s.duration){const e=c.Dice.getValue(s.duration),t=s.expireMsg;u.addToExpirationComp(n,a,e,t)}else n.add(a);return!0}handleAddElement(e,t){const s=t.getArgs(),n=b(s);s.elementName||i.default.err("System.Effects","handleAddElement","No elementName found in useArgs: "+JSON.stringify(s));let r=f.Element.create(s.elementName);if(!r){r=d.ObjectShell.getParser().createEntity(s.elementName)}if(r){const[t,a]=[n.getX(),n.getY()],o=e.getLevel(),i=n.getPropType(r.getType());return!(s.successCheck&&!this._successCheck(n,s.successCheck))&&(!i||i.length<s.numAllowed?o.addElement(r,t,a)?("function"==typeof r.onSystemAdd&&r.onSystemAdd(n),s.setters&&this._applySetters(r,s.setters),!0):(console.error("Failed to add element "+s.elementName),!1):(console.log("maxNumAllowed hit already for",r.getName()),!1))}{const e="Failed to create elem: "+JSON.stringify(s);i.default.err("System.Effects","handleAddElement",e)}return!1}handleRemoveElement(e,t){const s=t.getArgs(),n=b(s);s.elementName||i.default.err("System.Effects","handleRemoveElement","No elementName found in useArgs: "+JSON.stringify(s));const r=n.getPropType(s.elementName);if(r.length>0){const t=r[0],[s,a]=[n.getX(),n.getY()];if(e.getLevel().removeElement(t,s,a))return"function"==typeof t.onSystemRemove&&t.onSystemRemove(n),!0}return!1}handleModifyCompValue(e,t){const s=t.getArgs(),n=m.getEffectTarget(s),r=y(s,n);if(n&&n.has(r)){const e=n.get(r),t=e[s.get](),a=s.value,o=_(a);return e[s.set](t+o),!0}return!1}handleAddEntity(e,t){const s=t.getArgs(),n=b(s),r=d.ObjectShell.getParser().createEntity(s.entityName);if(r){const[t,a]=[n.getX(),n.getY()];if(e.getLevel().addEntity(r,t,a)){if(s.duration){const e=new u.Fading,{duration:t}=s;e.setDuration(t),r.add(e)}const t=new u.Created;return t.setCreator(e),r.add(t),!0}}return!1}handleChangeElement(e,t){const s=t.getArgs(),n=b(s),r=s.fromType,a=s.toType||h.ELEM.FLOOR;return n.getBaseElem().getType()===r&&(n.setBaseElem(a),!0)}handleRemoveComp(e,t){const s=t.getArgs(),n=m.getEffectTarget(s),r=y(s,n);return!!n.has(r)&&(s.all?n.removeAll(r):n.remove(r),!0)}_successCheck(e,t){let s=!0;return t.forEach(t=>{i.default.PROP_TYPES.forEach(n=>{t[n]&&(["has","hasAll"].forEach(r=>{if(t[n][r])if(n===i.default.TYPE_ELEM||e.hasProp(n)){let a=e.getProp(n);a&&(a=a.slice()),n===i.default.TYPE_ELEM&&(a||(a=[]),a.push(e.getBaseElem()));let o=!1;a.forEach(e=>{const s=t[n][r];e[r](s)&&(o=!0)}),s=s&&o}else s=!1}),["hasNot","hasNone"].forEach(r=>{let a=e.getProp(n);a&&(a=a.slice()),n===i.default.TYPE_ELEM&&(a||(a=[]),a.push(e.getBaseElem())),a&&a.forEach(e=>{let a=!0;t[n][r]&&(e[r](t[n][r])||(a=!1)),s=s&&a})}))})}),s}_applySetters(e,t){let s=[];e.getCell();s=Array.isArray(t)?t:[t],s.forEach(t=>{let s=e;t.get&&(s=e.get(t.get)),Object.keys(t).forEach(e=>{if("get"!==e){const n=t[e];s[e](n)}})})}}function y(e,t){const s=e.name;if(!s){let s="Unknown comp value. useArgs: "+JSON.stringify(e);t&&(s+=" targetEnt "+JSON.stringify(t)),i.default.err("SystemEffects","handleModifyCompValue",s)}return s.capitalize()}t.SystemEffects=m,m.handlerTable=g;const _=function(e){if(Number.isInteger(e))return e;if("string"==typeof e){const t=Number.parseFloat(e);if(!Number.isNaN(t))return t}return e};function b(e){if(e.target){const t=e.target;if(t.target)return t.target}const t=JSON.stringify(e);return i.default.err("system.effects.js","getTargetCellOrFail","Prop target must exist in useArgs. Got: |"+t),null}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MindControl=void 0;const r=n(s(0)),a=s(16),o=s(15);t.MindControl=function(){a.ComponentBase.call(this,"MindControl");let e=null,t=null;this.getSource=()=>e,this.setSource=t=>{e=t};this.addCallback("onAdd",()=>{const e=this.getEntity();t=e.getBrain(),this.getSource().isPlayer()?e.setPlayerCtrl(!0):e.setBrain(new o.BrainMindControl(e))}),this.addCallback("onRemove",()=>{this.getSource().isPlayer()&&this.getEntity().setPlayerCtrl(!1),this.getEntity().setBrain(t)})},r.default.extend2(t.MindControl,a.ComponentBase),t.MindControl.prototype.toJSON=function(){const e=a.ComponentBase.prototype.toJSON.call(this);return r.default.isActorActive(this.getSource())&&(e.setSource=r.default.getObjRef("entity",this.getSource())),e}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(36);t.default=class{constructor(e,t,s,r={}){this._toX=e,this._toY=t,this._passableCallback=s,this._options=Object.assign({topology:8},r),this._dirs=n.DIRS[this._options.topology],8===this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])}_getNeighbors(e,t){const s=[];for(let n=0;n<this._dirs.length;n++){const r=this._dirs[n],a=e+r[0],o=t+r[1];this._passableCallback(a,o,e,t)&&s.push([a,o])}return s}}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GoalRetreat=t.GoalHoldPosition=t.GoalEngageEnemy=t.GoalFindEnemyArmy=t.LevelGrid=t.GoalFollowArmy=t.GoalWinBattle=t.giveClearOrders=t.givePickupOrder=t.giveAttackOrder=t.giveFollowOrder=t.injectOrderEval=t.orderWithGoal=t.GoalsBattle=void 0;const i=o(s(0)),l=s(54),c=s(23),u=a(s(2)),{GOAL_ACTIVE:h,GOAL_COMPLETED:d}=l.GoalStatus;t.GoalsBattle={},t.orderWithGoal=(e,t)=>{const{bias:s}=t,n=new c.Evaluator.Orders(s);if(n.setArgs({srcActor:t.src,goal:t.goal}),e.isPlayer()){const s=new u.BattleOrder,n={srcActor:t.src};s.setArgs(n),e.add(s)}else{const t=e.getBrain();if("function"==typeof t.getGoal){const e=t.getGoal();e.clearOrders?(e.clearOrders(),e.giveOrders(n)):i.default.err("goals-battle.ts","orderWithGoal","No clearOrders found from the top goal")}else{const t="Actor without getGoal: "+JSON.stringify(e);i.default.warn("goals-battle.js","orderWithGoal",t)}}},t.GoalsBattle.orderWithGoal=t.orderWithGoal,t.injectOrderEval=(e,t,s)=>{if(i.default.isSentient(e)){const n=new c.Evaluator.Orders(s.bias);n.setArgs({srcActor:s.src,goal:t});const r=e.getBrain().getGoal();r.clearOrders&&(r.clearOrders(),r.giveOrders(n))}},t.giveFollowOrder=(e,s)=>{if(i.default.isSentient(e)){const n=new l.Goal.Follow(e,s.src);t.injectOrderEval(e,n,s)}},t.GoalsBattle.giveFollowOrder=t.giveFollowOrder,t.giveAttackOrder=(e,s)=>{if(i.default.isSentient(e)){const n=new l.Goal.AttackActor(e,s.enemy);t.injectOrderEval(e,n,s)}},t.GoalsBattle.giveAttackOrder=t.giveAttackOrder,t.givePickupOrder=(e,s)=>{if(i.default.isSentient(e)){const n=new l.Goal.GetItem(e,s.item);t.injectOrderEval(e,n,s)}},t.GoalsBattle.givePickupOrder=t.givePickupOrder,t.giveClearOrders=(e,t)=>{if(i.default.isSentient(e)){const{src:s}=t;if(!e.isEnemy(s)){const t=e.getBrain().getGoal();t.clearOrders&&t.clearOrders()}}},t.GoalsBattle.giveClearOrders=t.giveClearOrders;class f extends l.GoalBase{constructor(e){super(e),this.setType("GoalWinBattle")}activate(){const e=this.actor.getBrain(),t=e.getSeenCells();e.findEnemyCell(t)?(this.addSubGoal(new y(this.actor)),this.dbg("Activated goal. Added EngageEnemy")):(this.addSubGoal(new m(this.actor)),this.dbg("Activated goal. Added FindEnemyArmy")),this.status=h}process(){return this.dbg("process() begin"),this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}t.GoalWinBattle=f,t.GoalsBattle.WinBattle=f;class g extends l.GoalBase{constructor(e){super(e),this.setType("GoalFollowArmy")}activate(){}process(){return this.activateIfInactive(),this.status=d,this.status}}t.GoalFollowArmy=g,t.GoalsBattle.FollowArmy=g;class p{constructor(e,t,s){const n=e.getMap(),[r,a]=[n.cols,n.rows];let o=Math.floor(r/t),i=Math.floor(a/s);r%t!=0&&++o,a%s!=0&&++i,this.grid=[];for(let e=0;e<o;e++){this.grid[e]=[];for(let t=0;t<i;t++)this.grid[e][t]={data:[e,t]}}this.gridCols=o,this.gridRows=i,this.xMap=t,this.yMap=s,this.xMapHalf=Math.floor(t/2),this.yMapHalf=Math.floor(s/2)}getCenterLevelXY(e){const[t,s]=e;return[t*this.xMap+this.xMapHalf,s*this.yMap+this.yMapHalf]}getGridXY(e){const[t,s]=e;return[Math.floor(t/this.xMap),Math.floor(s/this.yMap)]}setDataLevelXY(e,t,s){const[n,r]=this.getGridXY(e);this.grid[n][r][t]=s}setDataGridXY(e,t,s){const[n,r]=e;this.grid[n][r][t]=s}isTrue(e,t){const[s,n]=e;return!0===this.grid[s][n][t]}hasProp(e,t){const[s,n]=e;return this.grid[s][n].hasOwnProperty(t)}getDataGridXY(e){const[t,s]=e;return this.grid[t][s]}getDataLevelXY(e){const[t,s]=this.getGridXY(e);return this.grid[t][s]}debugPrint(){for(let e=0;e<this.gridRows;e++){let t="||";for(let s=0;s<this.gridCols;s++)t+=JSON.stringify(this.grid[s][e])+" ||";i.default.diag(t),i.default.diag("=".repeat(t.length))}}}t.LevelGrid=p;class m extends l.GoalBase{constructor(e){super(e),this.setType("GoalFindEnemyArmy");const t=e.getLevel();this.gridSeen=new p(t,10,10);const[s,n]=this.actor.getXY();this.gridSeen.setDataLevelXY([s,n],"seen",!0),this.adjustRate=50}activate(){this.selectDirToMove(),this.status=h}process(){return this.activateIfInactive(),this.adjustRate>0?--this.adjustRate:(this.selectDirToMove(),this.adjustRate=50),this.status=this.processSubGoals(),this.status}selectDirToMove(){const e=this.actor.getBrain(),s=[0,0],n=this.actor.getLevel(),[r,a]=this.actor.getXY(),o=n.getMap().cols/2,i=n.getMap().rows/2;r<o?s[0]=1:r>o&&(s[0]=-1),a<i?s[1]=1:a>i&&(s[1]=-1),this.dbg("Cmd army to move to dir "+s);const c=e.getSeenFriends();this.dbg(c.length+" friends found for command"),c.forEach(e=>{const n=new l.Goal.MoveUntilEnemy(e,s);t.orderWithGoal(e,{src:this.actor,bias:1,goal:n})}),this.dbg("Issued Move order to "+c.length+" actors");const u=new l.Goal.MoveUntilEnemy(this.actor,s);this.removeAllSubGoals(),this.addSubGoal(u)}}t.GoalFindEnemyArmy=m,t.GoalsBattle.FindEnemyArmy=m;class y extends l.GoalBase{constructor(e){super(e),this.setType("GoalEngageEnemy")}activate(){this.dbg("ATTACK ENEMY activate()");const e=this.actor.getBrain(),s=e.getSeenEnemies();if(0===s.length)return;e.getSeenFriends().forEach(e=>{const n=new l.Goal.AttackActor(e,s[0]);t.orderWithGoal(e,{src:this.actor,bias:2,goal:n})}),this.enemy=s[0];const n=new l.Goal.AttackActor(this.actor,s[0]);this.addSubGoal(n),this.status=h}process(){return this.activateIfInactive(),this.dbg("ATTACK ENEMY process()"),this.status=this.processSubGoals(),this.status}}t.GoalEngageEnemy=y,t.GoalsBattle.EngageEnemy=y;class _ extends l.GoalBase{constructor(e){super(e),this.setType("GoalHoldPosition")}}t.GoalHoldPosition=_,t.GoalsBattle.HoldPosition=_;class b extends l.GoalBase{constructor(e){super(e),this.setType("GoalRetreat")}}t.GoalRetreat=b,t.GoalsBattle.Retreat=b},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Inventory=void 0;const i=o(s(0)),l=a(s(26)),c=s(103);t.Inventory=class{constructor(e){this._actor=e,this._inv=new l.Container(e),this._eq=new c.Equipment(e)}static equipAnyItem(e,t){const s=e.getInvEq();s.hasItem(t)||s.addItem(t),s.equipItem(t)}addItem(e){this._inv.addItem(e)}hasItem(e){return this._inv.hasItem(e)}removeItem(e){return this._inv.removeItem(e)}removeNItems(e,t){return this._inv.removeNItems(e,t)}getRemovedItem(){return this._inv.getRemovedItem()}hasItemNamed(e){return this._inv.hasItemWith(t=>t.getName()===e)}getItemsNamed(e){return this._inv.getItemsWith(t=>t.getName()===e)}useItem(e,t){if(this._inv.hasItem(e)){if(e.useItem)return e.useItem(t),!0}else i.default.err("Inv.Inventory","useItem","Not in inventory, cannot use!");return!1}canCarryItem(e){return!(this._eq.getWeight()+this._inv.getWeight()+e.getWeight()>this._actor.getMaxWeight())}dropItem(e){if(this._inv.removeItem(e)){const e=this._actor.getLevel(),t=this.getRemovedItem();if(t){const[s,n]=this._actor.getXY();if(e.addItem(t,s,n))return!0;this._inv.addItem(t)}}return!1}dropNItems(e,t){if(this.removeNItems(e,t)){const e=this._actor.getLevel(),t=this.getRemovedItem();if(t){const[s,n]=this._actor.getXY();if(e.addItem(t,s,n))return!0;this._inv.addItem(t)}}return!1}removeAndGetItem(e){return this._inv.removeItem(e)?this.getRemovedItem():null}getInventory(){return this._inv}getEquipment(){return this._eq}equipItem(e){if(this._inv.hasItem(e)){const t=this._getItemToEquip(e);if(i.default.isNullOrUndef([t]))return i.default.err("Inv.Inventory","equipItem","equippedItem is null. Should not happen"),!1;if(this._eq.equipItem(t))return!0;this._inv.addItem(t)}else i.default.err("Inv.Inventory","equipItem","Cannot equip. Not in inventory.");return!1}_getItemToEquip(e){if(this._inv.removeItem(e)){return this._inv.getRemovedItem()}return null}equipNItems(e,t){if(this._inv.hasItem(e)){if(this._inv.removeNItems(e,t)){const e=this._inv.getRemovedItem();if(this._eq.equipItem(e))return!0;this._inv.addItem(e)}}return!1}unequipItem(e,t,s){if(i.default.isNullOrUndef([e])){let n="Some params null/undef: ";n+=`type: |${e}| n: |${t}| number: |${s}|`,i.default.err("InvInventory","unequipItem",n)}const n=this._eq.getItem(e);if(!i.default.isNullOrUndef([n])&&this._eq.unequipItem(e,t,s)){const t=this._eq.getUnequipped(e,s);if(null!==t)return this.addItem(t),!0}return!1}unequipAndGetItem(e,t,s){const n=this._eq.getItem(e);return!i.default.isNullOrUndef([n])&&this._eq.unequipItem(e,t)?this._eq.getUnequipped(e,s):null}getWeapon(){const e=this._eq.getItem("hand");return i.default.isNullOrUndef([e])?null:Array.isArray(e)?e[0]:e}getMissileWeapon(){const e=this._eq.getItem("missileweapon");if(!i.default.isNullOrUndef([e])){return e}return null}getMissile(){const e=this._eq.getItem("missile");if(e){return e}return null}getEquipped(e){return this._eq.getItem(e)}getFreeEquipSlots(){return this._eq.getFreeSlotTypes()}restoreEquipped(e){return this._eq.equipItem(e)}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getNewFgColor=t.colorsTooClose=t.ColorMap=t.Colors=void 0,t.Colors={},t.Colors.race={},t.Colors.race.animal={bg:"Brown"},t.Colors.race.avianfolk={bg:"GreenYellow"},t.Colors.race.bearfolk={bg:"GreenYellow"},t.Colors.race.catfolk={bg:"GreenYellow"},t.Colors.race.dark={bg:"Brown"},t.Colors.race.dogfolk={bg:"GreenYellow"},t.Colors.race.dwarven={fg:"White",bg:"Brown"},t.Colors.race.goblin={bg:"GreenYellow"},t.Colors.race.human={bg:"Brown"},t.Colors.race.hyrkhian={bg:"Brown"},t.Colors.race.hyrm={bg:"Brown"},t.Colors.race.spirit={bg:"White"},t.Colors.race.undead={bg:"Black"},t.Colors.race.wildling={bg:"Brown"},t.Colors.race.wolfclan={bg:"Brown"},t.Colors.role={},t.Colors.role.archer="Yellow",t.Colors.role.berserker="Pink",t.Colors.role.commander="Yellow",t.Colors.role.elite="Cyan",t.Colors.role.fighter="Blue",t.Colors.role.king="Red",t.Colors.role.mage="Purple",t.Colors.role.slinger="Purple",t.ColorMap={"#000000":{hex:"#000000",name:"black",rgb:[0,0,0]},black:{hex:"#000000",name:"black",rgb:[0,0,0]},"#C0C0C0":{hex:"#C0C0C0",name:"silver",rgb:[192,192,192]},silver:{hex:"#C0C0C0",name:"silver",rgb:[192,192,192]},"#808080":{hex:"#808080",name:"grey",rgb:[128,128,128]},gray:{hex:"#808080",name:"gray",rgb:[128,128,128]},"#FFFFFF":{hex:"#FFFFFF",name:"white",rgb:[255,255,255]},white:{hex:"#FFFFFF",name:"white",rgb:[255,255,255]},"#800000":{hex:"#800000",name:"maroon",rgb:[128,0,0]},maroon:{hex:"#800000",name:"maroon",rgb:[128,0,0]},"#FF0000":{hex:"#FF0000",name:"red",rgb:[255,0,0]},red:{hex:"#FF0000",name:"red",rgb:[255,0,0]},"#800080":{hex:"#800080",name:"purple",rgb:[128,0,128]},purple:{hex:"#800080",name:"purple",rgb:[128,0,128]},"#FF00FF":{hex:"#FF00FF",name:"magenta",rgb:[255,0,255]},fuchsia:{hex:"#FF00FF",name:"fuchsia",rgb:[255,0,255]},"#008000":{hex:"#008000",name:"green",rgb:[0,128,0]},green:{hex:"#008000",name:"green",rgb:[0,128,0]},"#00FF00":{hex:"#00FF00",name:"lime",rgb:[0,255,0]},lime:{hex:"#00FF00",name:"lime",rgb:[0,255,0]},"#808000":{hex:"#808000",name:"olive",rgb:[128,128,0]},olive:{hex:"#808000",name:"olive",rgb:[128,128,0]},"#FFFF00":{hex:"#FFFF00",name:"yellow",rgb:[255,255,0]},yellow:{hex:"#FFFF00",name:"yellow",rgb:[255,255,0]},"#000080":{hex:"#000080",name:"navy",rgb:[0,0,128]},navy:{hex:"#000080",name:"navy",rgb:[0,0,128]},"#0000FF":{hex:"#0000FF",name:"blue",rgb:[0,0,255]},blue:{hex:"#0000FF",name:"blue",rgb:[0,0,255]},"#008080":{hex:"#008080",name:"teal",rgb:[0,128,128]},teal:{hex:"#008080",name:"teal",rgb:[0,128,128]},"#00FFFF":{hex:"#00FFFF",name:"cyan",rgb:[0,255,255]},aqua:{hex:"#00FFFF",name:"aqua",rgb:[0,255,255]},"#F0F8FF":{hex:"#F0F8FF",name:"aliceblue",rgb:[240,248,255]},aliceblue:{hex:"#F0F8FF",name:"aliceblue",rgb:[240,248,255]},"#FAEBD7":{hex:"#FAEBD7",name:"antiquewhite",rgb:[250,235,215]},antiquewhite:{hex:"#FAEBD7",name:"antiquewhite",rgb:[250,235,215]},"#7FFFD4":{hex:"#7FFFD4",name:"aquamarine",rgb:[127,255,212]},aquamarine:{hex:"#7FFFD4",name:"aquamarine",rgb:[127,255,212]},"#F0FFFF":{hex:"#F0FFFF",name:"azure",rgb:[240,255,255]},azure:{hex:"#F0FFFF",name:"azure",rgb:[240,255,255]},"#F5F5DC":{hex:"#F5F5DC",name:"beige",rgb:[245,245,220]},beige:{hex:"#F5F5DC",name:"beige",rgb:[245,245,220]},"#FFE4C4":{hex:"#FFE4C4",name:"bisque",rgb:[255,228,196]},bisque:{hex:"#FFE4C4",name:"bisque",rgb:[255,228,196]},"#FFEBCD":{hex:"#FFEBCD",name:"blanchedalmond",rgb:[255,235,205]},blanchedalmond:{hex:"#FFEBCD",name:"blanchedalmond",rgb:[255,235,205]},"#8A2BE2":{hex:"#8A2BE2",name:"blueviolet",rgb:[138,43,226]},blueviolet:{hex:"#8A2BE2",name:"blueviolet",rgb:[138,43,226]},"#A52A2A":{hex:"#A52A2A",name:"brown",rgb:[165,42,42]},brown:{hex:"#A52A2A",name:"brown",rgb:[165,42,42]},"#DEB887":{hex:"#DEB887",name:"burlywood",rgb:[222,184,135]},burlywood:{hex:"#DEB887",name:"burlywood",rgb:[222,184,135]},"#5F9EA0":{hex:"#5F9EA0",name:"cadetblue",rgb:[95,158,160]},cadetblue:{hex:"#5F9EA0",name:"cadetblue",rgb:[95,158,160]},"#7FFF00":{hex:"#7FFF00",name:"chartreuse",rgb:[127,255,0]},chartreuse:{hex:"#7FFF00",name:"chartreuse",rgb:[127,255,0]},"#D2691E":{hex:"#D2691E",name:"chocolate",rgb:[210,105,30]},chocolate:{hex:"#D2691E",name:"chocolate",rgb:[210,105,30]},"#FF7F50":{hex:"#FF7F50",name:"coral",rgb:[255,127,80]},coral:{hex:"#FF7F50",name:"coral",rgb:[255,127,80]},"#6495ED":{hex:"#6495ED",name:"cornflowerblue",rgb:[100,149,237]},cornflowerblue:{hex:"#6495ED",name:"cornflowerblue",rgb:[100,149,237]},"#FFF8DC":{hex:"#FFF8DC",name:"cornsilk",rgb:[255,248,220]},cornsilk:{hex:"#FFF8DC",name:"cornsilk",rgb:[255,248,220]},"#DC143C":{hex:"#DC143C",name:"crimson",rgb:[220,20,60]},crimson:{hex:"#DC143C",name:"crimson",rgb:[220,20,60]},cyan:{hex:"#00FFFF",name:"cyan",rgb:[0,255,255]},"#00008B":{hex:"#00008B",name:"darkblue",rgb:[0,0,139]},darkblue:{hex:"#00008B",name:"darkblue",rgb:[0,0,139]},"#008B8B":{hex:"#008B8B",name:"darkcyan",rgb:[0,139,139]},darkcyan:{hex:"#008B8B",name:"darkcyan",rgb:[0,139,139]},"#B8860B":{hex:"#B8860B",name:"darkgoldenrod",rgb:[184,134,11]},darkgoldenrod:{hex:"#B8860B",name:"darkgoldenrod",rgb:[184,134,11]},"#A9A9A9":{hex:"#A9A9A9",name:"darkgrey",rgb:[169,169,169]},darkgray:{hex:"#A9A9A9",name:"darkgray",rgb:[169,169,169]},"#006400":{hex:"#006400",name:"darkgreen",rgb:[0,100,0]},darkgreen:{hex:"#006400",name:"darkgreen",rgb:[0,100,0]},darkgrey:{hex:"#A9A9A9",name:"darkgrey",rgb:[169,169,169]},"#BDB76B":{hex:"#BDB76B",name:"darkkhaki",rgb:[189,183,107]},darkkhaki:{hex:"#BDB76B",name:"darkkhaki",rgb:[189,183,107]},"#8B008B":{hex:"#8B008B",name:"darkmagenta",rgb:[139,0,139]},darkmagenta:{hex:"#8B008B",name:"darkmagenta",rgb:[139,0,139]},"#556B2F":{hex:"#556B2F",name:"darkolivegreen",rgb:[85,107,47]},darkolivegreen:{hex:"#556B2F",name:"darkolivegreen",rgb:[85,107,47]},"#FF8C00":{hex:"#FF8C00",name:"darkorange",rgb:[255,140,0]},darkorange:{hex:"#FF8C00",name:"darkorange",rgb:[255,140,0]},"#9932CC":{hex:"#9932CC",name:"darkorchid",rgb:[153,50,204]},darkorchid:{hex:"#9932CC",name:"darkorchid",rgb:[153,50,204]},"#8B0000":{hex:"#8B0000",name:"darkred",rgb:[139,0,0]},darkred:{hex:"#8B0000",name:"darkred",rgb:[139,0,0]},"#E9967A":{hex:"#E9967A",name:"darksalmon",rgb:[233,150,122]},darksalmon:{hex:"#E9967A",name:"darksalmon",rgb:[233,150,122]},"#8FBC8F":{hex:"#8FBC8F",name:"darkseagreen",rgb:[143,188,143]},darkseagreen:{hex:"#8FBC8F",name:"darkseagreen",rgb:[143,188,143]},"#483D8B":{hex:"#483D8B",name:"darkslateblue",rgb:[72,61,139]},darkslateblue:{hex:"#483D8B",name:"darkslateblue",rgb:[72,61,139]},"#2F4F4F":{hex:"#2F4F4F",name:"darkslategrey",rgb:[47,79,79]},darkslategray:{hex:"#2F4F4F",name:"darkslategray",rgb:[47,79,79]},darkslategrey:{hex:"#2F4F4F",name:"darkslategrey",rgb:[47,79,79]},"#00CED1":{hex:"#00CED1",name:"darkturquoise",rgb:[0,206,209]},darkturquoise:{hex:"#00CED1",name:"darkturquoise",rgb:[0,206,209]},"#9400D3":{hex:"#9400D3",name:"darkviolet",rgb:[148,0,211]},darkviolet:{hex:"#9400D3",name:"darkviolet",rgb:[148,0,211]},"#FF1493":{hex:"#FF1493",name:"deeppink",rgb:[255,20,147]},deeppink:{hex:"#FF1493",name:"deeppink",rgb:[255,20,147]},"#00BFFF":{hex:"#00BFFF",name:"deepskyblue",rgb:[0,191,255]},deepskyblue:{hex:"#00BFFF",name:"deepskyblue",rgb:[0,191,255]},"#696969":{hex:"#696969",name:"dimgrey",rgb:[105,105,105]},dimgray:{hex:"#696969",name:"dimgray",rgb:[105,105,105]},dimgrey:{hex:"#696969",name:"dimgrey",rgb:[105,105,105]},"#1E90FF":{hex:"#1E90FF",name:"dodgerblue",rgb:[30,144,255]},dodgerblue:{hex:"#1E90FF",name:"dodgerblue",rgb:[30,144,255]},"#B22222":{hex:"#B22222",name:"firebrick",rgb:[178,34,34]},firebrick:{hex:"#B22222",name:"firebrick",rgb:[178,34,34]},"#FFFAF0":{hex:"#FFFAF0",name:"floralwhite",rgb:[255,250,240]},floralwhite:{hex:"#FFFAF0",name:"floralwhite",rgb:[255,250,240]},"#228B22":{hex:"#228B22",name:"forestgreen",rgb:[34,139,34]},forestgreen:{hex:"#228B22",name:"forestgreen",rgb:[34,139,34]},"#DCDCDC":{hex:"#DCDCDC",name:"gainsboro",rgb:[220,220,220]},gainsboro:{hex:"#DCDCDC",name:"gainsboro",rgb:[220,220,220]},"#F8F8FF":{hex:"#F8F8FF",name:"ghostwhite",rgb:[248,248,255]},ghostwhite:{hex:"#F8F8FF",name:"ghostwhite",rgb:[248,248,255]},"#FFD700":{hex:"#FFD700",name:"gold",rgb:[255,215,0]},gold:{hex:"#FFD700",name:"gold",rgb:[255,215,0]},"#DAA520":{hex:"#DAA520",name:"goldenrod",rgb:[218,165,32]},goldenrod:{hex:"#DAA520",name:"goldenrod",rgb:[218,165,32]},"#ADFF2F":{hex:"#ADFF2F",name:"greenyellow",rgb:[173,255,47]},greenyellow:{hex:"#ADFF2F",name:"greenyellow",rgb:[173,255,47]},grey:{hex:"#808080",name:"grey",rgb:[128,128,128]},"#F0FFF0":{hex:"#F0FFF0",name:"honeydew",rgb:[240,255,240]},honeydew:{hex:"#F0FFF0",name:"honeydew",rgb:[240,255,240]},"#FF69B4":{hex:"#FF69B4",name:"hotpink",rgb:[255,105,180]},hotpink:{hex:"#FF69B4",name:"hotpink",rgb:[255,105,180]},"#CD5C5C":{hex:"#CD5C5C",name:"indianred",rgb:[205,92,92]},indianred:{hex:"#CD5C5C",name:"indianred",rgb:[205,92,92]},"#4B0082":{hex:"#4B0082",name:"indigo",rgb:[75,0,130]},indigo:{hex:"#4B0082",name:"indigo",rgb:[75,0,130]},"#FFFFF0":{hex:"#FFFFF0",name:"ivory",rgb:[255,255,240]},ivory:{hex:"#FFFFF0",name:"ivory",rgb:[255,255,240]},"#F0E68C":{hex:"#F0E68C",name:"khaki",rgb:[240,230,140]},khaki:{hex:"#F0E68C",name:"khaki",rgb:[240,230,140]},"#E6E6FA":{hex:"#E6E6FA",name:"lavender",rgb:[230,230,250]},lavender:{hex:"#E6E6FA",name:"lavender",rgb:[230,230,250]},"#FFF0F5":{hex:"#FFF0F5",name:"lavenderblush",rgb:[255,240,245]},lavenderblush:{hex:"#FFF0F5",name:"lavenderblush",rgb:[255,240,245]},"#7CFC00":{hex:"#7CFC00",name:"lawngreen",rgb:[124,252,0]},lawngreen:{hex:"#7CFC00",name:"lawngreen",rgb:[124,252,0]},"#FFFACD":{hex:"#FFFACD",name:"lemonchiffon",rgb:[255,250,205]},lemonchiffon:{hex:"#FFFACD",name:"lemonchiffon",rgb:[255,250,205]},"#ADD8E6":{hex:"#ADD8E6",name:"lightblue",rgb:[173,216,230]},lightblue:{hex:"#ADD8E6",name:"lightblue",rgb:[173,216,230]},"#F08080":{hex:"#F08080",name:"lightcoral",rgb:[240,128,128]},lightcoral:{hex:"#F08080",name:"lightcoral",rgb:[240,128,128]},"#E0FFFF":{hex:"#E0FFFF",name:"lightcyan",rgb:[224,255,255]},lightcyan:{hex:"#E0FFFF",name:"lightcyan",rgb:[224,255,255]},"#FAFAD2":{hex:"#FAFAD2",name:"lightgoldenrodyellow",rgb:[250,250,210]},lightgoldenrodyellow:{hex:"#FAFAD2",name:"lightgoldenrodyellow",rgb:[250,250,210]},"#D3D3D3":{hex:"#D3D3D3",name:"lightgrey",rgb:[211,211,211]},lightgray:{hex:"#D3D3D3",name:"lightgray",rgb:[211,211,211]},"#90EE90":{hex:"#90EE90",name:"lightgreen",rgb:[144,238,144]},lightgreen:{hex:"#90EE90",name:"lightgreen",rgb:[144,238,144]},lightgrey:{hex:"#D3D3D3",name:"lightgrey",rgb:[211,211,211]},"#FFB6C1":{hex:"#FFB6C1",name:"lightpink",rgb:[255,182,193]},lightpink:{hex:"#FFB6C1",name:"lightpink",rgb:[255,182,193]},"#FFA07A":{hex:"#FFA07A",name:"lightsalmon",rgb:[255,160,122]},lightsalmon:{hex:"#FFA07A",name:"lightsalmon",rgb:[255,160,122]},"#20B2AA":{hex:"#20B2AA",name:"lightseagreen",rgb:[32,178,170]},lightseagreen:{hex:"#20B2AA",name:"lightseagreen",rgb:[32,178,170]},"#87CEFA":{hex:"#87CEFA",name:"lightskyblue",rgb:[135,206,250]},lightskyblue:{hex:"#87CEFA",name:"lightskyblue",rgb:[135,206,250]},"#778899":{hex:"#778899",name:"lightslategrey",rgb:[119,136,153]},lightslategray:{hex:"#778899",name:"lightslategray",rgb:[119,136,153]},lightslategrey:{hex:"#778899",name:"lightslategrey",rgb:[119,136,153]},"#B0C4DE":{hex:"#B0C4DE",name:"lightsteelblue",rgb:[176,196,222]},lightsteelblue:{hex:"#B0C4DE",name:"lightsteelblue",rgb:[176,196,222]},"#FFFFE0":{hex:"#FFFFE0",name:"lightyellow",rgb:[255,255,224]},lightyellow:{hex:"#FFFFE0",name:"lightyellow",rgb:[255,255,224]},"#32CD32":{hex:"#32CD32",name:"limegreen",rgb:[50,205,50]},limegreen:{hex:"#32CD32",name:"limegreen",rgb:[50,205,50]},"#FAF0E6":{hex:"#FAF0E6",name:"linen",rgb:[250,240,230]},linen:{hex:"#FAF0E6",name:"linen",rgb:[250,240,230]},magenta:{hex:"#FF00FF",name:"magenta",rgb:[255,0,255]},"#66CDAA":{hex:"#66CDAA",name:"mediumaquamarine",rgb:[102,205,170]},mediumaquamarine:{hex:"#66CDAA",name:"mediumaquamarine",rgb:[102,205,170]},"#0000CD":{hex:"#0000CD",name:"mediumblue",rgb:[0,0,205]},mediumblue:{hex:"#0000CD",name:"mediumblue",rgb:[0,0,205]},"#BA55D3":{hex:"#BA55D3",name:"mediumorchid",rgb:[186,85,211]},mediumorchid:{hex:"#BA55D3",name:"mediumorchid",rgb:[186,85,211]},"#9370DB":{hex:"#9370DB",name:"mediumpurple",rgb:[147,112,219]},mediumpurple:{hex:"#9370DB",name:"mediumpurple",rgb:[147,112,219]},"#3CB371":{hex:"#3CB371",name:"mediumseagreen",rgb:[60,179,113]},mediumseagreen:{hex:"#3CB371",name:"mediumseagreen",rgb:[60,179,113]},"#7B68EE":{hex:"#7B68EE",name:"mediumslateblue",rgb:[123,104,238]},mediumslateblue:{hex:"#7B68EE",name:"mediumslateblue",rgb:[123,104,238]},"#00FA9A":{hex:"#00FA9A",name:"mediumspringgreen",rgb:[0,250,154]},mediumspringgreen:{hex:"#00FA9A",name:"mediumspringgreen",rgb:[0,250,154]},"#48D1CC":{hex:"#48D1CC",name:"mediumturquoise",rgb:[72,209,204]},mediumturquoise:{hex:"#48D1CC",name:"mediumturquoise",rgb:[72,209,204]},"#C71585":{hex:"#C71585",name:"mediumvioletred",rgb:[199,21,133]},mediumvioletred:{hex:"#C71585",name:"mediumvioletred",rgb:[199,21,133]},"#191970":{hex:"#191970",name:"midnightblue",rgb:[25,25,112]},midnightblue:{hex:"#191970",name:"midnightblue",rgb:[25,25,112]},"#F5FFFA":{hex:"#F5FFFA",name:"mintcream",rgb:[245,255,250]},mintcream:{hex:"#F5FFFA",name:"mintcream",rgb:[245,255,250]},"#FFE4E1":{hex:"#FFE4E1",name:"mistyrose",rgb:[255,228,225]},mistyrose:{hex:"#FFE4E1",name:"mistyrose",rgb:[255,228,225]},"#FFE4B5":{hex:"#FFE4B5",name:"moccasin",rgb:[255,228,181]},moccasin:{hex:"#FFE4B5",name:"moccasin",rgb:[255,228,181]},"#FFDEAD":{hex:"#FFDEAD",name:"navajowhite",rgb:[255,222,173]},navajowhite:{hex:"#FFDEAD",name:"navajowhite",rgb:[255,222,173]},"#FDF5E6":{hex:"#FDF5E6",name:"oldlace",rgb:[253,245,230]},oldlace:{hex:"#FDF5E6",name:"oldlace",rgb:[253,245,230]},"#6B8E23":{hex:"#6B8E23",name:"olivedrab",rgb:[107,142,35]},olivedrab:{hex:"#6B8E23",name:"olivedrab",rgb:[107,142,35]},"#FFA500":{hex:"#FFA500",name:"orange",rgb:[255,165,0]},orange:{hex:"#FFA500",name:"orange",rgb:[255,165,0]},"#FF4500":{hex:"#FF4500",name:"orangered",rgb:[255,69,0]},orangered:{hex:"#FF4500",name:"orangered",rgb:[255,69,0]},"#DA70D6":{hex:"#DA70D6",name:"orchid",rgb:[218,112,214]},orchid:{hex:"#DA70D6",name:"orchid",rgb:[218,112,214]},"#EEE8AA":{hex:"#EEE8AA",name:"palegoldenrod",rgb:[238,232,170]},palegoldenrod:{hex:"#EEE8AA",name:"palegoldenrod",rgb:[238,232,170]},"#98FB98":{hex:"#98FB98",name:"palegreen",rgb:[152,251,152]},palegreen:{hex:"#98FB98",name:"palegreen",rgb:[152,251,152]},"#AFEEEE":{hex:"#AFEEEE",name:"paleturquoise",rgb:[175,238,238]},paleturquoise:{hex:"#AFEEEE",name:"paleturquoise",rgb:[175,238,238]},"#DB7093":{hex:"#DB7093",name:"palevioletred",rgb:[219,112,147]},palevioletred:{hex:"#DB7093",name:"palevioletred",rgb:[219,112,147]},"#FFEFD5":{hex:"#FFEFD5",name:"papayawhip",rgb:[255,239,213]},papayawhip:{hex:"#FFEFD5",name:"papayawhip",rgb:[255,239,213]},"#FFDAB9":{hex:"#FFDAB9",name:"peachpuff",rgb:[255,218,185]},peachpuff:{hex:"#FFDAB9",name:"peachpuff",rgb:[255,218,185]},"#CD853F":{hex:"#CD853F",name:"peru",rgb:[205,133,63]},peru:{hex:"#CD853F",name:"peru",rgb:[205,133,63]},"#FFC0CB":{hex:"#FFC0CB",name:"pink",rgb:[255,192,203]},pink:{hex:"#FFC0CB",name:"pink",rgb:[255,192,203]},"#DDA0DD":{hex:"#DDA0DD",name:"plum",rgb:[221,160,221]},plum:{hex:"#DDA0DD",name:"plum",rgb:[221,160,221]},"#B0E0E6":{hex:"#B0E0E6",name:"powderblue",rgb:[176,224,230]},powderblue:{hex:"#B0E0E6",name:"powderblue",rgb:[176,224,230]},"#BC8F8F":{hex:"#BC8F8F",name:"rosybrown",rgb:[188,143,143]},rosybrown:{hex:"#BC8F8F",name:"rosybrown",rgb:[188,143,143]},"#4169E1":{hex:"#4169E1",name:"royalblue",rgb:[65,105,225]},royalblue:{hex:"#4169E1",name:"royalblue",rgb:[65,105,225]},"#8B4513":{hex:"#8B4513",name:"saddlebrown",rgb:[139,69,19]},saddlebrown:{hex:"#8B4513",name:"saddlebrown",rgb:[139,69,19]},"#FA8072":{hex:"#FA8072",name:"salmon",rgb:[250,128,114]},salmon:{hex:"#FA8072",name:"salmon",rgb:[250,128,114]},"#F4A460":{hex:"#F4A460",name:"sandybrown",rgb:[244,164,96]},sandybrown:{hex:"#F4A460",name:"sandybrown",rgb:[244,164,96]},"#2E8B57":{hex:"#2E8B57",name:"seagreen",rgb:[46,139,87]},seagreen:{hex:"#2E8B57",name:"seagreen",rgb:[46,139,87]},"#FFF5EE":{hex:"#FFF5EE",name:"seashell",rgb:[255,245,238]},seashell:{hex:"#FFF5EE",name:"seashell",rgb:[255,245,238]},"#A0522D":{hex:"#A0522D",name:"sienna",rgb:[160,82,45]},sienna:{hex:"#A0522D",name:"sienna",rgb:[160,82,45]},"#87CEEB":{hex:"#87CEEB",name:"skyblue",rgb:[135,206,235]},skyblue:{hex:"#87CEEB",name:"skyblue",rgb:[135,206,235]},"#6A5ACD":{hex:"#6A5ACD",name:"slateblue",rgb:[106,90,205]},slateblue:{hex:"#6A5ACD",name:"slateblue",rgb:[106,90,205]},"#708090":{hex:"#708090",name:"slategrey",rgb:[112,128,144]},slategray:{hex:"#708090",name:"slategray",rgb:[112,128,144]},slategrey:{hex:"#708090",name:"slategrey",rgb:[112,128,144]},"#FFFAFA":{hex:"#FFFAFA",name:"snow",rgb:[255,250,250]},snow:{hex:"#FFFAFA",name:"snow",rgb:[255,250,250]},"#00FF7F":{hex:"#00FF7F",name:"springgreen",rgb:[0,255,127]},springgreen:{hex:"#00FF7F",name:"springgreen",rgb:[0,255,127]},"#4682B4":{hex:"#4682B4",name:"steelblue",rgb:[70,130,180]},steelblue:{hex:"#4682B4",name:"steelblue",rgb:[70,130,180]},"#D2B48C":{hex:"#D2B48C",name:"tan",rgb:[210,180,140]},tan:{hex:"#D2B48C",name:"tan",rgb:[210,180,140]},"#D8BFD8":{hex:"#D8BFD8",name:"thistle",rgb:[216,191,216]},thistle:{hex:"#D8BFD8",name:"thistle",rgb:[216,191,216]},"#FF6347":{hex:"#FF6347",name:"tomato",rgb:[255,99,71]},tomato:{hex:"#FF6347",name:"tomato",rgb:[255,99,71]},"#40E0D0":{hex:"#40E0D0",name:"turquoise",rgb:[64,224,208]},turquoise:{hex:"#40E0D0",name:"turquoise",rgb:[64,224,208]},"#EE82EE":{hex:"#EE82EE",name:"violet",rgb:[238,130,238]},violet:{hex:"#EE82EE",name:"violet",rgb:[238,130,238]},"#F5DEB3":{hex:"#F5DEB3",name:"wheat",rgb:[245,222,179]},wheat:{hex:"#F5DEB3",name:"wheat",rgb:[245,222,179]},"#F5F5F5":{hex:"#F5F5F5",name:"whitesmoke",rgb:[245,245,245]},whitesmoke:{hex:"#F5F5F5",name:"whitesmoke",rgb:[245,245,245]},"#9ACD32":{hex:"#9ACD32",name:"yellowgreen",rgb:[154,205,50]},yellowgreen:{hex:"#9ACD32",name:"yellowgreen",rgb:[154,205,50]}};function n(e){return Math.sqrt(.299*Math.pow(e[0],2)+.587*Math.pow(e[1],2)+.114*Math.pow(e[2],2))}t.colorsTooClose=function(e,s){if(e===s)return!0;if(!t.ColorMap[e.toLowerCase()])throw Error(`Color ${e} not usable`);if(!t.ColorMap[s.toLowerCase()])throw Error(`Color ${s} not usable`);const r=t.ColorMap[e.toLowerCase()].rgb,a=t.ColorMap[s.toLowerCase()].rgb,o=n(r),i=n(a);return Math.abs(o-i)<36},t.getNewFgColor=function(e,s){const r=t.ColorMap[e.toLowerCase()].rgb,a=t.ColorMap[s.toLowerCase()].rgb,o=n(r),i=n(a);if(Math.abs(o-i)<36)return i<128?"White":"Black"}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Spell=void 0;const i=o(s(0)),l=s(70);Object.defineProperty(t,"Spell",{enumerable:!0,get:function(){return l.Spell}});const c=a(s(2)),u=s(17),h=s(6),d=s(15),f=s(1),g=a(s(7)),p=f.Random.getRNG(),{getDirSpellArgs:m,aiSpellCellEnemy:y,aiSpellCellFriend:_,aiSpellCellSelf:b,addPoisonEffect:v,addFadingActorToCell:E,aiSpellCellDone:S}=l.Spell;l.Spell.DispelMagic=function(){l.Spell.RemoveComponent.call(this,"DispelMagic",8),this.setCompNames("Duration")},i.default.extend2(l.Spell.DispelMagic,l.Spell.RemoveComponent),l.Spell.Charm=function(){l.SpellBase.call(this,"Charm",10),this._dice.duration=u.Dice.create("10d6 + 5")},i.default.extend2(l.Spell.Charm,l.SpellBase),l.Spell.Charm.prototype.cast=function(e){const t=m(this,e),s=new c.SpellCell;t.callback=this.charmCallback.bind(this),s.setArgs(t),e.src.add(s)},l.Spell.Charm.prototype.charmCallback=function(e){const t=e.getSentientActors();if(t&&t.length>0){const e=t[0];let s=1+this.getCasterExpBonus(3);s+=this.getCasterStatBonus("willpower",3);const n=new c.Charm;n.setTargetActor(e.getID()),n.setLevel(s);const r=this.getDuration();c.addToExpirationComp(this.getCaster(),n,r);const a=this.getCaster(),o=`${a.getName()} charms ${e.getName()}`;i.default.gameMsg({cell:a.getCell(),msg:o})}},l.Spell.Charm.prototype.getSelectionObject=function(e){return l.Spell.getSelectionObjectDir(this,e,"Select a direction for charming:")},l.Spell.Charm.prototype.aiShouldCastSpell=function(e,t){return y(e,t)},l.Spell.GraspOfWinter=function(){l.SpellBase.call(this,"Grasp of winter"),this._dice.damage=u.Dice.create("4d4 + 4")},i.default.extend2(l.Spell.GraspOfWinter,l.SpellBase),l.Spell.GraspOfWinter.prototype.cast=function(e){const t=m(this,e);t.damageType=i.default.DMG.ICE,t.damage=this.getDamage();const s=new c.SpellCell;s.setArgs(t),e.src.add(s)},l.Spell.GraspOfWinter.prototype.getSelectionObject=function(e){return l.Spell.getSelectionObjectDir(this,e,"Select a direction for grasping:")},l.Spell.GraspOfWinter.prototype.aiShouldCastSpell=function(e,t){return y(e,t)},l.Spell.AnimateDead=function(){l.Spell.AddComponent.call(this,"AnimateDead",5),this.setCompName("Undead"),delete this._dice.duration},i.default.extend2(l.Spell.AnimateDead,l.Spell.AddComponent),l.Spell.AnimateDead.prototype.cast=function(e){l.Spell.AddComponent.prototype.cast.call(this,e);const{src:t}=e;t.get("SpellCell").getArgs().callback=this.animateCallback.bind(this)},l.Spell.AnimateDead.prototype.animateCallback=function(e){const t=["Stats","Combat","Experience"],s=this.getCaster();if(!e.hasItems())return;const n=e.getItems().find(e=>/corpse/.test(e.getName()));if(!n&&!s.isPlayer())return void i.default.warn("AnimateDead","animateCallback","No corpses found. Should not have cast the spell at all");const r=n;if(r.has("Undead")){const e=s.getName()+" fails to reanimate undead remains";i.default.gameMsg({cell:s.getCell(),msg:e})}else if(r){const e=h.getParser(),n=r.getActorName();if(!e.hasObj(i.default.TYPE_ACTOR,n)){const e=`${s.getName()} fails to reanimate corpse of ${n}`;return void i.default.gameWarn({cell:s.getCell(),msg:e})}const a=e.createActor(n);a.add(new c.Undead),t.forEach(e=>{const t=r.get(e);a.remove(e),t.changeEntity(a)}),a.get("Named").prepend("undead "),i.default.addCellStyle(i.default.TYPE_ACTOR,a.get("Named").getName(),"cell-actor-undead");const[o,l]=r.getXY(),u=s.getLevel(),d=new c.Created;d.setCreator(s),a.add(d),a.add(new c.Undead),u.removeItem(r,o,l)&&(u.addActor(a,o,l),a.has("NonSentient")||a.addFriend(s))}},l.Spell.AnimateDead.prototype.aiShouldCastSpell=(e,t)=>{const s=e.actor,n=d.Brain.getCellsAroundActor(s).filter(e=>e.hasItems()&&e.getItems().find(e=>"corpse"===e.getType()));if(0===n.length)return!1;const r=p.arrayGetRand(n);return S(s,r,t),!0},l.Spell.Flying=function(){l.Spell.AddComponent.call(this,"Flying",5),this.setCompName("Flying"),this._dice.duration=u.Dice.create("10d5 + 5"),this.aiShouldCastSpell=(e,t)=>_(e,t)},i.default.extend2(l.Spell.Flying,l.Spell.AddComponent),l.Spell.Telepathy=function(){l.Spell.AddComponent.call(this,"Telepathy",5),this.setCompName("Telepathy"),this._dice.duration=u.Dice.create("10d10 + 10"),this.aiShouldCastSpell=(e,t)=>{let s=_(e,t);return s||(s=y(e,t)),s}},i.default.extend2(l.Spell.Telepathy,l.Spell.AddComponent),l.Spell.Telepathy.prototype.cast=function(e){l.Spell.AddComponent.prototype.cast.call(this,e);const{src:t}=e;if(t){const s=t.get("SpellCell").getArgs(),{addComp:n}=s,r=n.comp;if("Telepathy"===r.getType()){const{duration:a}=n,o=r.clone();let i={dir:[0,0],src:this._caster,spell:null};i=m(this,i),i.addComp={comp:o,duration:a},s.postCallback=e=>{r.setSource(t),r.setTarget(e.getSentientActors()[0])},i.postCallback=()=>{o.setSource(r.getSource()),o.setTarget(r.getTarget())};const l=new c.SpellCell;l.setArgs(i),e.src.add(l)}}else{const t=JSON.stringify(e);i.default.err("Spell.Telepathy","cast","No src found in args: "+t)}},l.Spell.Paralysis=function(){l.Spell.AddComponent.call(this,"Paralysis",7),this.setCompName("Paralysis"),this.setDuration(u.Dice.create("1d6 + 2")),this.aiShouldCastSpell=(e,t)=>y(e,t)},i.default.extend2(l.Spell.Paralysis,l.Spell.AddComponent),l.Spell.StunningTouch=function(){l.Spell.AddComponent.call(this,"StunningTouch",7),this.setCompName("Stun"),this.setDuration(u.Dice.create("1d6 + 2")),this.aiShouldCastSpell=(e,t)=>y(e,t)},i.default.extend2(l.Spell.StunningTouch,l.Spell.AddComponent),l.Spell.SpiritForm=function(){l.Spell.AddComponent.call(this,"SpiritForm",10),this.setCompName("Ethereal"),this.setDuration(u.Dice.create("1d6 + 4")),this.aiShouldCastSpell=(e,t)=>_(e,t)},i.default.extend2(l.Spell.SpiritForm,l.Spell.AddComponent),l.Spell.FrostBolt=function(){l.Spell.BoltBase.call(this,"Frost bolt",5),this.setDice("damage",u.Dice.create("4d4 + 4")),this.setRange(5),this.damageType=i.default.DMG.ICE},i.default.extend2(l.Spell.FrostBolt,l.Spell.BoltBase),l.Spell.LightningBolt=function(){l.Spell.BoltBase.call(this,"Lightning bolt",8),this.damageType=i.default.DMG.LIGHTNING,this.setRange(6),this.setDice("damage",u.Dice.create("6d3 + 3"))},i.default.extend2(l.Spell.LightningBolt,l.Spell.BoltBase),l.Spell.FireBolt=function(){l.Spell.BoltBase.call(this,"Fire bolt",8),this.damageType=i.default.DMG.FIRE,this.setRange(6),this.setDice("damage",u.Dice.create("5d3 + 5"))},i.default.extend2(l.Spell.FireBolt,l.Spell.BoltBase),l.Spell.ScorpionsTail=function(){l.Spell.BoltBase.call(this,"Scorpions tail",1),this.damageType=i.default.DMG.MELEE,this.setRange(2),this.setDice("damage",u.Dice.create("2d4 + 2"))},i.default.extend2(l.Spell.ScorpionsTail,l.Spell.BoltBase),l.Spell.ScorpionsTail.prototype.onHit=function(e,t){v(e,t)},l.Spell.ShadowRay=function(){l.Spell.BoltBase.call(this,"Shadow ray",8),this.setDice("damage",u.Dice.create("6d4 + 4")),this.setRange(8),this.damageType=i.default.DMG.NECRO},i.default.extend2(l.Spell.ShadowRay,l.Spell.BoltBase),l.Spell.CrossBolt=function(){l.Spell.BoltBase.call(this,"Cross bolt",20),this.damageType=i.default.DMG.LIGHTNING,this.setRange(6),this.setDice("damage",u.Dice.create("6d3 + 3")),this.cast=function(e){const t=e.dir;let s=i.default.DIR_NSEW;0!==t[0]&&0!==t[1]&&(s=i.default.DIR_DIAG),s.forEach(t=>{const s=Object.assign({},e);s.dir=t;const n=m(this,s);n.damageType=this.damageType,n.damage=this.rollDice("damage");const r=new c.SpellRay;r.setArgs(n),e.src.add(r)})}},i.default.extend2(l.Spell.CrossBolt,l.Spell.BoltBase),l.Spell.PoisonBreath=function(){l.Spell.BoltBase.call(this,"PoisonBreath",8),this.setDice("damage",u.Dice.create("6d4 + 4")),this.setRange(8),this.damageType=i.default.DMG.POISON,this.nActors=2,this.stopOnHit=!0,this._createdActor="Poison gas",this._dice.duration=u.Dice.create("5d5 + 5")},i.default.extend2(l.Spell.PoisonBreath,l.Spell.BoltBase),l.Spell.PoisonBreath.prototype.onHit=function(e,t){v(e,t);const s=h.getParser(),n=d.Brain.getCellsAroundActor(e,1);for(let e=0;e<this.nActors;e++){const e=p.arrayGetRand(n);if(e.isPassable()||e.hasActors()){const t=s.createActor(this._createdActor);E(t,e,this)}}const r="Poison clouds spread from poison breath of "+t.getName();i.default.gameSuccess({cell:e.getCell(),msg:r})},l.Spell.WaterBolt=function(){l.Spell.BoltBase.call(this,"WaterBolt",10),this.setDice("damage",u.Dice.create("4d4 + 4")),this.setRange(5),this.damageType=i.default.DMG.WATER},i.default.extend2(l.Spell.WaterBolt,l.Spell.BoltBase),l.Spell.VoidBolt=function(){l.Spell.BoltBase.call(this,"VoidBolt",12),this.setDice("damage",u.Dice.create("5d4 + 4")),this.setRange(5),this.damageType=i.default.DMG.VOID},i.default.extend2(l.Spell.VoidBolt,l.Spell.BoltBase),l.Spell.SlimeBolt=function(){l.Spell.BoltBase.call(this,"SlimeBolt",10),this.setDice("damage",u.Dice.create("4d4 + 4")),this.setRange(5),this.damageType=i.default.DMG.SLIME,this.stopOnHit=!0},i.default.extend2(l.Spell.SlimeBolt,l.Spell.BoltBase),l.Spell.SlimeBolt.prototype.onHit=function(e,t){const s=e.getLevel();d.Brain.getCellsAroundActor(e,1).forEach(e=>{if(e.isPassable()||e.hasActors()){const t=new g.ElementSlime;s.addElement(t,e.getX(),e.getY())}}),e.add(new c.Entrapped);const n="Slime is spread around by "+t.getName();i.default.gameSuccess({cell:e.getCell(),msg:n})},l.Spell.IceShield=function(){l.SpellBase.call(this,"Ice shield",6),this._dice.duration=u.Dice.create("5d5 + 15"),this._dice.defense=u.Dice.create("1d6 + 3"),this.cast=e=>{const t=e.src,s=this.getDuration(),n=new c.CombatMods;n.setDefense(this.rollDice("defense")),c.addToExpirationComp(t,n,s),i.default.gameMsg({cell:t.getCell(),msg:t.getName()+" is surrounded by defensive aura"})},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=(e,t)=>_(e,t)},i.default.extend2(l.Spell.IceShield,l.SpellBase),l.Spell.IceShield.prototype.toString=function(){let e=l.SpellBase.prototype.toString.call(this);return e+=" Def: "+this._dice.defense.toString(),e},l.Spell.MagicArmor=function(){l.SpellBase.call(this,"MagicArmor",5),this._dice.duration=u.Dice.create("6d5 + 15"),this._dice.protection=u.Dice.create("2d6 + 2"),this.cast=e=>{const t=e.src,s=t.getName(),n={target:t,name:"CombatMods",setters:{setProtection:this.rollDice("protection")},duration:this._dice.duration,startMsg:s+" is surrounded by a protective aura",expireMsg:"Protective aura disappears from "+s},r=new c.Effects(n);r.setEffectType("AddComp"),t.add(r)},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=(e,t)=>_(e,t)},i.default.extend2(l.Spell.MagicArmor,l.SpellBase),l.Spell.MagicArmor.prototype.toString=function(){let e=l.SpellBase.prototype.toString.call(this);return e+=" Pro: "+this._dice.protection.toString(),e},l.Spell.IcyPrison=function(){l.SpellBase.call(this,"Icy prison",10),this._dice.duration=u.Dice.create("1d8 + 1"),this.cast=function(e){const t=m(this,e),s=this.getDuration(),n=new c.Paralysis;n.setSource(e.src),t.addComp={comp:n,duration:s};const r=new c.SpellCell;r.setArgs(t),e.src.add(r)},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectDir(this,e,"Select a direction for casting:")},this.aiShouldCastSpell=(e,t)=>y(e,t)},i.default.extend2(l.Spell.IcyPrison,l.SpellBase),l.Spell.SummonIceMinion=function(){l.Spell.SummonBase.call(this,"SummonIceMinion",14),this.summonType="Ice minion"},i.default.extend2(l.Spell.SummonIceMinion,l.Spell.SummonBase),l.Spell.SummonAirElemental=function(){l.Spell.SummonBase.call(this,"SummonAirElemental",20),this.summonFunc=e=>"air elemental"===e.name},i.default.extend2(l.Spell.SummonAirElemental,l.Spell.SummonBase),l.Spell.SummonUndeadUnicorns=function(){l.Spell.SummonBase.call(this,"SummonUndeadUnicorns",15),this.nActors="1d4 + 1",this.summonFunc=e=>"undead unicorn"===e.name},i.default.extend2(l.Spell.SummonUndeadUnicorns,l.Spell.SummonBase),l.Spell.SummonAnimal=function(){l.Spell.SummonBase.call(this,"SummonAnimal",10),this.summonFunc=e=>{const t=this.getCaster().get("Experience").getExpLevel();let s=Math.round(t/3)||1;s>10&&(s=10);const n=Math.round(t/2);return"animal"===e.type&&e.danger>=s&&e.danger<=n}},i.default.extend2(l.Spell.SummonAnimal,l.Spell.SummonBase),l.Spell.SummonDead=function(){l.Spell.SummonBase.call(this,"SummonDead",15),this.nActors=4,this.summonFunc=e=>"undead"===e.type&&e.name!==this.getCaster().getName()},i.default.extend2(l.Spell.SummonDead,l.Spell.SummonBase),l.Spell.SummonSpiders=function(){l.Spell.SummonBase.call(this,"SummonSpiders",10),this.nActors="1d4 + 1",this.summonFunc=e=>{const t=this.getCaster().get("Experience"),s=t.getDanger(),n=t.getExpLevel(),r=s+Math.round(n/2),a=this.getCaster().getName();return/spider/.test(e.name)&&!/undead/.test(e.name)&&e.danger<=r&&a!==e.name}},i.default.extend2(l.Spell.SummonSpiders,l.Spell.SummonBase),l.Spell.SummonKin=function(){l.Spell.SummonBase.call(this,"SummonKin",10),this.summonFunc=e=>{const t=this.getCaster().getType(),s=this.getCaster().get("Experience"),n=s.getDanger(),r=s.getExpLevel(),a=n+Math.round(r/2);return e.type===t&&e.danger<=a}},i.default.extend2(l.Spell.SummonKin,l.Spell.SummonBase),l.Spell.SummonFlyingEyes=function(){l.Spell.SummonBase.call(this,"SummonFlyingEyes",4),this.summonType="flying eye",this.nActors="1d6 + 1",this._dice.duration=u.Dice.create("10d5 + 10"),this.postSummonCallback=(e,t,s)=>{const n=new c.Fading,r=this.getDuration();n.setDuration(r),s.add(n);const a=new c.Telepathy;a.setTarget(s),a.setSource(this._caster);const o=a.clone();c.addToExpirationComp(s,a,r),c.addToExpirationComp(this._caster,o,r)},this.aiShouldCastSpell=(e,t)=>{const{actor:s}=e;return!s.has("Telepathy")&&(e.dir=[0,0],t(s,e),!0)}},i.default.extend2(l.Spell.SummonFlyingEyes,l.Spell.SummonBase),l.Spell.PowerDrain=function(){l.SpellBase.call(this,"PowerDrain",15),this._dice.duration=u.Dice.create("20d5 + 10"),this.cast=e=>{const t=e.src,s=this.getDuration(),n=new c.PowerDrain;c.addToExpirationComp(t,n,s),i.default.gameMsg({cell:t.getCell(),msg:t.getName()+" is surrounded by purple aura"})},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=(e,t)=>(this.compFuncArgs={enemy:e.enemy},e.compFunc=this.aiCompFunc.bind(this),b(e,t)),this.aiCompFunc=e=>{const{enemy:t}=this.compFuncArgs;return!!t&&!(e.has("PowerDrain")||!t.has("SpellPower"))}},i.default.extend2(l.Spell.PowerDrain,l.SpellBase),l.Spell.IceArrow=function(){l.Spell.Missile.call(this,"IceArrow",16),this.setRange(9),this.damageType=i.default.DMG.ICE,this.ammoName="Ice arrow"},i.default.extend2(l.Spell.IceArrow,l.Spell.Missile),l.Spell.LightningArrow=function(){l.Spell.Missile.call(this,"LightningArrow",14),this.setRange(8),this.damageType=i.default.DMG.LIGHTNING,this.ammoName="Lightning arrow"},i.default.extend2(l.Spell.LightningArrow,l.Spell.Missile),l.Spell.EnergyArrow=function(){l.Spell.Missile.call(this,"EnergyArrow",2),this.setRange(5),this.setDice("damage",u.Dice.create("1d4 + 1")),this.damageType=i.default.DMG.ENERGY,this.ammoName="Energy arrow"},i.default.extend2(l.Spell.EnergyArrow,l.Spell.Missile),l.Spell.Kindle=function(){l.Spell.Missile.call(this,"Kindle",2),this.setRange(5),this.setDice("damage",u.Dice.create("1d4 + 2")),this.damageType=i.default.DMG.FIRE,this.ammoName="Fire bolt"},i.default.extend2(l.Spell.Kindle,l.Spell.Missile),l.Spell.PoisonArrow=function(){l.Spell.Missile.call(this,"PoisonArrow",20),this.setRange(10),this.setDice("damage",u.Dice.create("1d6 + 2")),this.damageType=i.default.DMG.POISON,this.ammoName="Poison arrow"},i.default.extend2(l.Spell.PoisonArrow,l.Spell.Missile),l.Spell.PoisonArrow.prototype.cast=function(e){l.Spell.Missile.prototype.cast.call(this,e);e.src.get("SpellMissile").onHit=this.onHit.bind(this)},l.Spell.PoisonArrow.prototype.onHit=function(e){const t=this._caster;v(e,t)},l.Spell.ArrowOfWebs=function(){l.Spell.Missile.call(this,"ArrowOfWebs",10),this.setRange(7),this.setDice("damage",u.Dice.create("1d6 + 2")),this.damageType=i.default.DMG.PIERCE,this.ammoName="Arrow of webs"},i.default.extend2(l.Spell.ArrowOfWebs,l.Spell.Missile),l.Spell.ArrowOfWebs.prototype.cast=function(e){l.Spell.Missile.prototype.cast.call(this,e);e.src.get("SpellMissile").onHit=this.onHit.bind(this)},l.Spell.ArrowOfWebs.prototype.onHit=function(e){const t=this._caster,s={target:{target:e.getCell()},targetType:["cell"],elementName:"Web",effectType:"AddElement",numAllowed:1},n=new c.Effects(s);t.add(n)},l.Spell.RockStorm=function(){l.Spell.Missile.call(this,"RockStorm",35),this.setRange(4),this.setDice("damage",u.Dice.create("5d4 + 1")),this.damageType=i.default.DMG.MELEE,this.ammoName="Huge rock",this.cast=function(e){const[t,s,n]=e.src.getXYZ();Object.values(i.default.DIR).forEach(r=>{const a=t+this.getRange()*r[0],o=s+this.getRange()*r[1],i={from:[t,s,n],spell:this,src:e.src,to:[a,o,n]};i.damageType=this.damageType,i.damage=this.getDamage(),i.destroyItem=!1;const l=new c.SpellMissile;l.setArgs(i),e.src.add(l)})},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectSelf(this,e)}},i.default.extend2(l.Spell.RockStorm,l.Spell.Missile),l.Spell.MindControl=function(){l.SpellBase.call(this,"MindControl",25),this._dice.duration=u.Dice.create("1d6 + 3"),this.cast=function(e){const t=m(this,e),s=this.getDuration(),n=new c.MindControl;n.setSource(e.src),t.addComp={comp:n,duration:s};const r=new c.SpellCell;r.setArgs(t),e.src.add(r)},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectDir(this,e,"Select an actor to control:")},this.aiShouldCastSpell=(e,t)=>y(e,t)},i.default.extend2(l.Spell.MindControl,l.SpellBase),l.Spell.Blizzard=function(){l.Spell.AreaBase.call(this,"Blizzard",35),this.setDice("damage",u.Dice.create("5d5 + 5")),this.damageType=i.default.DMG.ICE,this.setRange(6)},i.default.extend2(l.Spell.Blizzard,l.Spell.AreaBase),l.Spell.Blizzard.prototype.onHit=function(e){e.add(new c.Coldness)},l.Spell.EnergyStorm=function(){l.Spell.AreaBase.call(this,"EnergyStorm",20),this.setDice("damage",u.Dice.create("3d4 + 3")),this.damageType=i.default.DMG.ENERGY},i.default.extend2(l.Spell.EnergyStorm,l.Spell.AreaBase),l.Spell.Heal=function(){l.SpellBase.call(this,"Heal",6),this._dice.healing=u.Dice.create("2d4"),this.cast=function(e){const t=m(this,e);t.targetComp="Health",t.set="addHP",t.value=this._dice.healing.roll();const s=new c.SpellCell;s.setArgs(t),e.src.add(s)},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectDir(this,e,"Select a direction for healing:")},this.aiShouldCastSpell=(e,t)=>_(e,t)},i.default.extend2(l.Spell.Heal,l.SpellBase),l.Spell.RingOfFire=function(){l.Spell.RingBase.call(this,"RingOfFire",10),this._dice.duration=u.Dice.create("10d10"),this._range=2,this._createdActor="Fire"},i.default.extend2(l.Spell.RingOfFire,l.Spell.RingBase),l.Spell.RingOfFrost=function(){l.Spell.RingBase.call(this,"RingOfFrost",10),this._dice.duration=u.Dice.create("10d10"),this._range=2,this._createdActor="Ice flame"},i.default.extend2(l.Spell.RingOfFrost,l.Spell.RingBase),l.Spell.RingOfEnergy=function(){l.Spell.RingBase.call(this,"RingOfEnergy",10),this._dice.duration=u.Dice.create("10d10"),this._range=3,this._createdActor="Forcefield"},i.default.extend2(l.Spell.RingOfEnergy,l.Spell.RingBase),l.Spell.PoisonCloud=function(){l.Spell.RingBase.call(this,"PoisonCloud",15),this._dice.duration=u.Dice.create("10d10"),this._range=1,this._createdActor="Poison gas"},i.default.extend2(l.Spell.PoisonCloud,l.Spell.RingBase),l.Spell.ForceField=function(){l.SpellBase.call(this,"ForceField",5),this._dice.duration=u.Dice.create("10d10"),this.cast=function(e){const t=m(this,e);t.callback=this.castCallback.bind(this,e);const s=new c.SpellSelf;s.setArgs(t),e.src.add(s)},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectDir(this,e,"Select a direction for the forcefield:")},this.castCallback=e=>{const t=h.getParser(),s=this._caster.getLevel(),{dir:n}=e,[r,a]=this._caster.getXY(),[o,i]=[r+n[0],a+n[1]];(function(e,t,s,n){return 0===t[0]?[e.getCell(s-1,n),e.getCell(s,n),e.getCell(s+1,n)]:0===t[1]?[e.getCell(s,n-1),e.getCell(s,n),e.getCell(s,n+1)]:-1===t[0]?[e.getCell(s+1,n),e.getCell(s,n),e.getCell(s,n-t[1])]:[e.getCell(s-1,n),e.getCell(s,n),e.getCell(s,n-t[1])]})(s.getMap(),n,o,i).forEach(e=>{if(e.isPassable()||!e.hasActors()){const n=t.createActor("Forcefield");s.addActor(n,e.getX(),e.getY());const r=new c.Fading,a=this.getDuration();r.setDuration(a),n.add(r)}})}},i.default.extend2(l.Spell.ForceField,l.SpellBase);class w extends l.Spell.MultiSpell{constructor(){super("IcyTouch",5),this._spells.push(new l.Spell.GraspOfWinter),this._spells.push(new l.Spell.RingOfFrost)}getSelectionObject(e){return l.Spell.getSelectionObjectDir(this,e,"Select a direction for touching:")}}l.Spell.IcyTouch=w,l.Spell.addAllSpells=e=>{e.addSpell(new l.Spell.AnimateDead),e.addSpell(new l.Spell.ArrowOfWebs),e.addSpell(new l.Spell.Blizzard),e.addSpell(new l.Spell.Charm),e.addSpell(new l.Spell.CrossBolt),e.addSpell(new l.Spell.DispelMagic),e.addSpell(new l.Spell.EnergyArrow),e.addSpell(new l.Spell.Flying),e.addSpell(new l.Spell.ForceField),e.addSpell(new l.Spell.FireBolt),e.addSpell(new l.Spell.FrostBolt),e.addSpell(new l.Spell.GraspOfWinter),e.addSpell(new l.Spell.Heal),e.addSpell(new l.Spell.IceArrow),e.addSpell(new l.Spell.IceShield),e.addSpell(new l.Spell.IcyPrison),e.addSpell(new l.Spell.IcyTouch),e.addSpell(new l.Spell.Kindle),e.addSpell(new l.Spell.LightningArrow),e.addSpell(new l.Spell.LightningBolt),e.addSpell(new l.Spell.MagicArmor),e.addSpell(new l.Spell.MindControl),e.addSpell(new l.Spell.Paralysis),e.addSpell(new l.Spell.PoisonArrow),e.addSpell(new l.Spell.PoisonBreath),e.addSpell(new l.Spell.PoisonCloud),e.addSpell(new l.Spell.PowerDrain),e.addSpell(new l.Spell.RingOfEnergy),e.addSpell(new l.Spell.RingOfFire),e.addSpell(new l.Spell.RingOfFrost),e.addSpell(new l.Spell.RockStorm),e.addSpell(new l.Spell.SlimeBolt),e.addSpell(new l.Spell.SpiritForm),e.addSpell(new l.Spell.SummonAirElemental),e.addSpell(new l.Spell.SummonAnimal),e.addSpell(new l.Spell.SummonDead),e.addSpell(new l.Spell.SummonFlyingEyes),e.addSpell(new l.Spell.SummonIceMinion),e.addSpell(new l.Spell.SummonKin),e.addSpell(new l.Spell.SummonUndeadUnicorns),e.addSpell(new l.Spell.Telepathy),e.addSpell(new l.Spell.VoidBolt)}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BrainMindControl=t.BrainCloud=t.BrainFlame=t.BrainCommander=t.BrainAnimal=t.BrainThief=t.BrainSpirit=t.BrainExplorer=t.BrainSpellCaster=t.BrainGoalOriented=void 0;const i=o(s(0)),l=a(s(73)),c=s(46),u=s(23),h=a(s(13)),d=s(1).Random.getRNG(),f={};class g extends c.BrainSentient{constructor(e){super(e),this.setType("GoalOriented"),this.goal=new l.ThinkBasic(e)}getGoal(){return this.goal}setGoal(e){this.goal=e}decideNextAction(){return this._cache.seen=null,this.goal.process(),this._cache.seen=null,c.ACTION_ALREADY_DONE}toJSON(){const e=super.toJSON();return e.goal=this.goal.toJSON(),e}}t.BrainGoalOriented=g,f.GoalOriented=g;class p extends g{constructor(e){super(e),this.setType("SpellCaster"),this.goal=new l.ThinkSpellcaster(e),this.goal.setBias({CastSpell:2,AttackActor:.7});this.goal.getEvaluator("CastSpell").setCastingProbability(.8)}}t.BrainSpellCaster=p,f.SpellCaster=p;class m extends g{constructor(e){super(e),this.setType("Explorer"),this.goal.removeEvaluators(),this.goal.addEvaluator(new u.Evaluator.Explore)}}t.BrainExplorer=m,f.Explorer=m;class y extends g{constructor(e){super(e),this.setType("Spirit"),this.goal.removeEvaluators(),this.goal.addEvaluator(new u.Evaluator.Explore)}}t.BrainSpirit=y,f.Spirit=y;class _ extends g{constructor(e){super(e),this.setType("Thief"),this.goal.addEvaluator(new u.Evaluator.Thief(1.2)),this.goal.setBias({Thief:1.2,AttackActor:.7})}}t.BrainThief=_,f.Thief=_;class b extends g{constructor(e){super(e),this.setType("Animal")}}t.BrainAnimal=b,f.Animal=b;class v extends g{constructor(e){super(e),this.setType("Commander"),this.goal=new l.ThinkCommander(e)}decideNextAction(){return this._cache.seen=null,this.goal.process(),this._cache.seen=null,c.ACTION_ALREADY_DONE}}t.BrainCommander=v,f.Commander=v;class E extends c.BrainSentient{constructor(e){super(e),this.setType("Flame")}decideNextAction(){return this._actor.getCell().getActors().forEach(e=>{const t=this.getActor().get("Damaging");if(t){const s=new h.Flame;s.setSource(this._actor),s.setDamageType(t.getDamageType()),e.add(s)}}),c.ACTION_ALREADY_DONE}}t.BrainFlame=E,f.Flame=E;class S extends E{constructor(e){super(e),this.setType("Cloud"),this.chanceToMove=.2}decideNextAction(){if(d.getUniform()<=this.chanceToMove){const e=d.getRandDir(),[t,s]=i.default.newXYFromDir(e,this._actor),n=this._actor.getLevel();if(n.getMap().hasXY(t,s)){const e=new h.Movement(t,s,n);this._actor.add(e)}}return super.decideNextAction.call(this)}}t.BrainCloud=S,f.Cloud=S;class w extends g{constructor(e){super(e),this.setType("MindControl"),this.goal=new l.ThinkBasic(e),this.getGoal=()=>this.goal,this.setGoal=e=>{this.goal=e}}decideNextAction(){return c.ACTION_ALREADY_DONE}}t.BrainMindControl=w,f.MindControl=w},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EvaluatorRetreat=t.EvaluatorWinBattle=t.EvaluatorsBattle=void 0;const n=s(145),r=s(23);t.EvaluatorsBattle={};class a extends r.EvaluatorBase{constructor(e){super(e),this.type="WinBattle"}calculateDesirability(e){return e.has("InBattle")?this.actorBias:r.Evaluator.NOT_POSSIBLE}setActorGoal(e){const t=e.getBrain().getGoal(),s=new n.GoalsBattle.WinBattle(e);t.addGoal(s)}}t.EvaluatorWinBattle=a,t.EvaluatorsBattle.WinBattle=a;class o extends r.EvaluatorBase{constructor(e){super(e),this.cooldown=5,this.type="Retreat"}calculateDesirability(){return 0===this.cooldown?this.actorBias:(--this.cooldown,0)}setActorGoal(e){const t=e.getBrain().getGoal(),s=new n.GoalsBattle.Retreat(e);t.addGoal(s)}}t.EvaluatorRetreat=o,t.EvaluatorsBattle.Retreat=o},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.BrainNeedDriven=void 0;const o=a(s(73)),i=s(46),l=s(152),c=s(23);class u extends i.BrainSentient{constructor(e){super(e),this.setType("NeedDriven"),this.goal=new o.ThinkBasic(e),this.needs=new l.NeedsHierarchy(e),this.goal.removeEvaluators(),this.goal.addEvaluator(new c.Evaluator.AttackActor(1.5)),this.needUpdatePeriod=0}decideNextAction(e){return this._cache.seen=null,0===this.needUpdatePeriod?(this.needs.process(this.goal,e),this.needUpdatePeriod=0):this.needUpdatePeriod-=1,this.goal.process(),this._cache.seen=null,i.ACTION_ALREADY_DONE}getGoal(){return this.goal}setGoal(e){this.goal=e}toJSON(){const e=super.toJSON();return e.goal=this.goal.toJSON(),e}}t.BrainNeedDriven=u},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NeedsHierarchy=t.processNeed=void 0;const r=n(s(5)).default("bitn:Needs"),a=n(s(0)),o=s(23),i=s(1),l=s(38),c=s(277),u=s(153),h=i.Random.getRNG(),d=new l.Constraints;function f(e){e.func||(e.func=d.getConstraints(e.constr))}t.processNeed=f;t.NeedsHierarchy=class{constructor(e){this.actor=e,this.weightedRand=!0,this._debug=r.enabled,this.needs=[],this.addNeedWithEval(u.Needs.Health),this.addNeedWithEval(u.Needs.Rest),this.addNeedWithEval(u.Needs.Hunger),e.has("SpellPower")&&this.addNeedWithEval(u.Needs.SpellPower),this._jobSchedule=null,this.addSchedule(new c.JobSchedule("testSchedule"))}addSchedule(e){this._jobSchedule=e}addNeedWithEval(e){e||a.default.err("NeedsHierarchy","addNeedWithEval","Tried to add null/undef need"),f(e),this.needs.push(e)}setDebug(e){this._debug=e}process(e,t){const{timeOfDay:s}=t,n=this.getEvaluators(this.actor,s);if(this.processJobSchedule(n,s),this.weightedRand&&n.length>0){const t={},s={};n.forEach(e=>{const[n,r,a]=e;t[n]?t[n]+=r:t[n]=r,a&&(s[n]?s[n]=Object.assign(s[n],a):s[n]=a)});const r=h.getWeighted(t),a=t[r];this.dbg(`Chose need [${r}], bias: ${a}`);let i=null;i=o.Evaluator[r]?new o.Evaluator[r](a):o.Evaluator.create(r,a),e.removeEvaluatorsByType(r),e.addEvaluator(i),s[r]&&Object.keys(s[r]).forEach(e=>{i[e]=s[r][e]})}else n.forEach(t=>{const s=t[0],n=new o.Evaluator[s](u.NEED_BIAS[s]);e.addEvaluator(n),t[2]&&t[2].isOneShot&&(n.isOneShot=!0)})}processJobSchedule(e,t){if(this._jobSchedule){const s=this._jobSchedule.getCurrentNeeds(this.actor,t);e.push(...s)}}getEvaluators(e,t){const s=[];for(let n=0;n<this.needs.length;n++){const r=this.needs[n];if(r.func&&r.func(e)){const e=[r.evalName,r.bias];if(r.only)return[e];if(s.push(e),r.last)return s}else if(r.script){const n=r.script(e,t);if(n.length>0){if(r.only)return n;if(s.push(...n),r.last)return s}}}return e.has("SpellPower")&&e.get("SpellPower").propLeft()<.2&&s.push(["Rest",.5*u.NEED_BIAS.Rest]),s}dbg(e){if(this._debug){const t=this.actor.getName(),s=this.actor.getID();r(`@${s} ${t} |${e}|`)}}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Needs=t.NEED_BIAS=void 0;const r=n(s(0));t.NEED_BIAS={Equip:1,Flee:1.5,FindAmmo:1,FindMissile:1,FindFood:1,FindWeapon:1,Rest:1},t.Needs={};const a={constr:{op:"<",value:.2,comp:["Health","propLeft"]},evalName:"Flee",bias:t.NEED_BIAS.Flee};t.Needs.Health=a;const o={constr:{op:"<",value:.5,comp:["Health","propLeft"]},evalName:"Rest",bias:t.NEED_BIAS.Rest};t.Needs.Rest=o;const i={constr:{op:"eq",value:!0,comp:["Hunger","isStarving"]},evalName:"FindFood",bias:t.NEED_BIAS.FindFood};t.Needs.Hunger=i;const l={constr:{op:"<",value:.4,comp:["SpellPower","propLeft"]},evalName:"Rest",bias:.75*t.NEED_BIAS.Rest};t.Needs.SpellPower=l;const c={script:function(e){const s=e.getInvEq(),n=[],a=e.getBrain().getGoal();if(!s.getWeapon()){const e=s.getInventory().getItems();e.find(e=>e.getType()===r.default.ITEM.WEAPON)?(a.removeEvaluatorsByType("FindWeapon"),n.push(["Equip",t.NEED_BIAS.Equip,{isOneShot:!0}])):n.push(["FindWeapon",t.NEED_BIAS.FindWeapon,{isOneShot:!0}])}return n},evalName:"FindWeapon",bias:t.NEED_BIAS.FindWeapon};t.Needs.FindWeapon=c},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Abilities=void 0;const o=a(s(105)),i=s(16),l=i.Component.UniqueDataComponent;t.Abilities=l("Abilities",{}),t.Abilities.prototype._init=function(){this.addCallback("onAdd",()=>{const e=new o.Abilities(this.getEntity());Array.isArray(this.abilities)&&this.abilities.forEach(t=>{const s=new o[t];e.addAbility(s)}),this.abilities=e,this.removeCallbacks("onAdd")})},t.Abilities.prototype.setAbilities=function(e){this.abilities=e},t.Abilities.prototype.createMenu=function(){return this.abilities.getMenu()},t.Abilities.prototype.addAbility=function(e){this.abilities.addAbility(e)},t.Abilities.prototype.toJSON=function(){const e=i.ComponentBase.prototype.toJSON.call(this);return e.setAbilities=this.abilities.toJSON(),e}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Trainer=void 0;const n=s(106),r=s(16).Component.UniqueDataComponent;t.Trainer=r("Trainer",{chatObj:null}),delete t.Trainer.prototype.setChatObj,t.Trainer.prototype._init=function(){this.chatObj=new n.ChatTrainer;this.addCallback("onAdd",()=>{this.chatObj.setTrainer(this.getEntity())})}},function(e,t,s){(function(t){var s="object"==typeof t&&t&&t.Object===Object&&t;e.exports=s}).call(this,s(28))},function(e,t){var s=Function.prototype.toString;e.exports=function(e){if(null!=e){try{return s.call(e)}catch(e){}try{return e+""}catch(e){}}return""}},function(e,t,s){var n=s(159),r=s(110),a=Object.prototype.hasOwnProperty;e.exports=function(e,t,s){var o=e[t];a.call(e,t)&&r(o,s)&&(void 0!==s||t in e)||n(e,t,s)}},function(e,t,s){var n=s(160);e.exports=function(e,t,s){"__proto__"==t&&n?n(e,t,{configurable:!0,enumerable:!0,value:s,writable:!0}):e[t]=s}},function(e,t,s){var n=s(39),r=function(){try{var e=n(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();e.exports=r},function(e,t,s){var n=s(312),r=s(80),a=s(9),o=s(60),i=s(162),l=s(81),c=Object.prototype.hasOwnProperty;e.exports=function(e,t){var s=a(e),u=!s&&r(e),h=!s&&!u&&o(e),d=!s&&!u&&!h&&l(e),f=s||u||h||d,g=f?n(e.length,String):[],p=g.length;for(var m in e)!t&&!c.call(e,m)||f&&("length"==m||h&&("offset"==m||"parent"==m)||d&&("buffer"==m||"byteLength"==m||"byteOffset"==m)||i(m,p))||g.push(m);return g}},function(e,t){var s=/^(?:0|[1-9]\d*)$/;e.exports=function(e,t){var n=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==n||"symbol"!=n&&s.test(e))&&e>-1&&e%1==0&&e<t}},function(e,t){e.exports=function(e,t){return function(s){return e(t(s))}}},function(e,t,s){var n=s(161),r=s(318),a=s(42);e.exports=function(e){return a(e)?n(e,!0):r(e)}},function(e,t){e.exports=function(e,t){for(var s=-1,n=null==e?0:e.length,r=0,a=[];++s<n;){var o=e[s];t(o,s,e)&&(a[r++]=o)}return a}},function(e,t){e.exports=function(){return[]}},function(e,t,s){var n=s(120),r=s(121),a=s(119),o=s(166),i=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)n(t,a(e)),e=r(e);return t}:o;e.exports=i},function(e,t,s){var n=s(169),r=s(119),a=s(41);e.exports=function(e){return n(e,a,r)}},function(e,t,s){var n=s(120),r=s(9);e.exports=function(e,t,s){var a=t(e);return r(e)?a:n(a,s(e))}},function(e,t,s){var n=s(39)(s(24),"Set");e.exports=n},function(e,t,s){var n=s(24).Uint8Array;e.exports=n},function(e,t,s){var n=s(40),r=Object.create,a=function(){function e(){}return function(t){if(!n(t))return{};if(r)return r(t);e.prototype=t;var s=new e;return e.prototype=void 0,s}}();e.exports=a},function(e,t){e.exports=function(e){return function(){return e}}},function(e,t,s){var n=s(341),r=s(41);e.exports=function(e,t){return e&&n(e,t,r)}},function(e,t,s){var n=s(349),r=s(29);e.exports=function e(t,s,a,o,i){return t===s||(null==t||null==s||!r(t)&&!r(s)?t!=t&&s!=s:n(t,s,a,o,e,i))}},function(e,t,s){var n=s(177),r=s(352),a=s(178);e.exports=function(e,t,s,o,i,l){var c=1&s,u=e.length,h=t.length;if(u!=h&&!(c&&h>u))return!1;var d=l.get(e);if(d&&l.get(t))return d==t;var f=-1,g=!0,p=2&s?new n:void 0;for(l.set(e,t),l.set(t,e);++f<u;){var m=e[f],y=t[f];if(o)var _=c?o(y,m,f,t,e,l):o(m,y,f,e,t,l);if(void 0!==_){if(_)continue;g=!1;break}if(p){if(!r(t,(function(e,t){if(!a(p,t)&&(m===e||i(m,e,s,o,l)))return p.push(t)}))){g=!1;break}}else if(m!==y&&!i(m,y,s,o,l)){g=!1;break}}return l.delete(e),l.delete(t),g}},function(e,t,s){var n=s(112),r=s(350),a=s(351);function o(e){var t=-1,s=null==e?0:e.length;for(this.__data__=new n;++t<s;)this.add(e[t])}o.prototype.add=o.prototype.push=r,o.prototype.has=a,e.exports=o},function(e,t){e.exports=function(e,t){return e.has(t)}},function(e,t,s){var n=s(40);e.exports=function(e){return e==e&&!n(e)}},function(e,t){e.exports=function(e,t){return function(s){return null!=s&&(s[e]===t&&(void 0!==t||e in Object(s)))}}},function(e,t,s){var n=s(182),r=s(86);e.exports=function(e,t){for(var s=0,a=(t=n(t,e)).length;null!=e&&s<a;)e=e[r(t[s++])];return s&&s==a?e:void 0}},function(e,t,s){var n=s(9),r=s(124),a=s(359),o=s(362);e.exports=function(e,t){return n(e)?e:r(e,t)?[e]:a(o(e))}},function(e,t,s){var n=s(182),r=s(80),a=s(9),o=s(162),i=s(115),l=s(86);e.exports=function(e,t,s){for(var c=-1,u=(t=n(t,e)).length,h=!1;++c<u;){var d=l(t[c]);if(!(h=null!=e&&s(e,d)))break;e=e[d]}return h||++c!=u?h:!!(u=null==e?0:e.length)&&i(u)&&o(d,u)&&(a(e)||r(e))}},function(e,t){e.exports=function(e){return function(t){return null==t?void 0:t[e]}}},function(e,t,s){var n=s(20),r=s(186);e.exports=function(e,t,s,n){return function(e,t,s,n){var a,o,i={},l=new r,c=function(e){var t=e.v!==a?e.v:e.w,n=i[t],r=s(e),c=o.distance+r;if(r<0)throw new Error("dijkstra does not allow negative edge weights. Bad edge: "+e+" Weight: "+r);c<n.distance&&(n.distance=c,n.predecessor=a,l.decrease(t,c))};e.nodes().forEach((function(e){var s=e===t?0:Number.POSITIVE_INFINITY;i[e]={distance:s},l.add(e,s)}));for(;l.size()>0&&(a=l.removeMin(),(o=i[a]).distance!==Number.POSITIVE_INFINITY);)n(a).forEach(c);return i}(e,String(t),s||a,n||function(t){return e.outEdges(t)})};var a=n.constant(1)},function(e,t,s){var n=s(20);function r(){this._arr=[],this._keyIndices={}}e.exports=r,r.prototype.size=function(){return this._arr.length},r.prototype.keys=function(){return this._arr.map((function(e){return e.key}))},r.prototype.has=function(e){return n.has(this._keyIndices,e)},r.prototype.priority=function(e){var t=this._keyIndices[e];if(void 0!==t)return this._arr[t].priority},r.prototype.min=function(){if(0===this.size())throw new Error("Queue underflow");return this._arr[0].key},r.prototype.add=function(e,t){var s=this._keyIndices;if(e=String(e),!n.has(s,e)){var r=this._arr,a=r.length;return s[e]=a,r.push({key:e,priority:t}),this._decrease(a),!0}return!1},r.prototype.removeMin=function(){this._swap(0,this._arr.length-1);var e=this._arr.pop();return delete this._keyIndices[e.key],this._heapify(0),e.key},r.prototype.decrease=function(e,t){var s=this._keyIndices[e];if(t>this._arr[s].priority)throw new Error("New priority is greater than current priority. Key: "+e+" Old: "+this._arr[s].priority+" New: "+t);this._arr[s].priority=t,this._decrease(s)},r.prototype._heapify=function(e){var t=this._arr,s=2*e,n=s+1,r=e;s<t.length&&(r=t[s].priority<t[r].priority?s:r,n<t.length&&(r=t[n].priority<t[r].priority?n:r),r!==e&&(this._swap(e,r),this._heapify(r)))},r.prototype._decrease=function(e){for(var t,s=this._arr,n=s[e].priority;0!==e&&!(s[t=e>>1].priority<n);)this._swap(e,t),e=t},r.prototype._swap=function(e,t){var s=this._arr,n=this._keyIndices,r=s[e],a=s[t];s[e]=a,s[t]=r,n[a.key]=e,n[r.key]=t}},function(e,t,s){var n=s(20);e.exports=function(e){var t=0,s=[],r={},a=[];return e.nodes().forEach((function(o){n.has(r,o)||function o(i){var l=r[i]={onStack:!0,lowlink:t,index:t++};if(s.push(i),e.successors(i).forEach((function(e){n.has(r,e)?r[e].onStack&&(l.lowlink=Math.min(l.lowlink,r[e].index)):(o(e),l.lowlink=Math.min(l.lowlink,r[e].lowlink))})),l.lowlink===l.index){var c,u=[];do{c=s.pop(),r[c].onStack=!1,u.push(c)}while(i!==c);a.push(u)}}(o)})),a}},function(e,t,s){var n=s(20);function r(e){var t={},s={},r=[];if(n.each(e.sinks(),(function o(i){if(n.has(s,i))throw new a;n.has(t,i)||(s[i]=!0,t[i]=!0,n.each(e.predecessors(i),o),delete s[i],r.push(i))})),n.size(t)!==e.nodeCount())throw new a;return r}function a(){}e.exports=r,r.CycleException=a,a.prototype=new Error},function(e,t,s){var n=s(20);e.exports=function(e,t,s){n.isArray(t)||(t=[t]);var r=(e.isDirected()?e.successors:e.neighbors).bind(e),a=[],o={};return n.each(t,(function(t){if(!e.hasNode(t))throw new Error("Graph does not have node: "+t);!function e(t,s,r,a,o,i){n.has(a,s)||(a[s]=!0,r||i.push(s),n.each(o(s),(function(s){e(t,s,r,a,o,i)})),r&&i.push(s))}(e,t,"post"===s,o,r,a)})),a}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(191)),a=s(59),o=n(s(14));class i extends r.default{constructor(e,t,s){super(e,t),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3,corridorLength:[3,10]},Object.assign(this._options,s),this._map=[],this._dug=0,this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)}startRoom(e){this._startRoom=e}create(e){const t=Date.now();for(;;){if(Date.now()-t>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._firstRoom(),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),this._startRoom&&(this._addRoom(this._startRoom),this._startRoom.create(this._digCallback)),!(this._rooms.length<2)&&this._generateCorridors())break}if(e)for(let t=0;t<this._width;t++)for(let s=0;s<this._height;s++)e(t,s,this._map[t][s]);return this}_generateRooms(){const e=this._width-2,t=this._height-2;let s;do{if(s=this._generateRoom(),this._dug/(e*t)>this._options.roomDugPercentage)break}while(s)}_generateRoom(){let e=0;for(;e<this._roomAttempts;){e++;const t=a.Room.createRandom(this._width,this._height,this._options);if(t.isValid(this._isWallCallback,this._canBeDugCallback))return t.create(this._digCallback),this._addRoom(t),t}return null}_generateCorridors(){let e=0;for(;e<this._corridorAttempts;){e++,this._corridors=[],this._map=this._fillMap(1);for(let e=0;e<this._rooms.length;e++){const t=this._rooms[e];t.clearDoors(),t.create(this._digCallback)}for(this._unconnected=o.default.shuffle(this._rooms.slice()),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){const e=o.default.getItem(this._connected);if(!e)break;const t=this._closestRoom(this._unconnected,e);if(!t)break;const s=this._closestRoom(this._connected,t);if(!s)break;if(!this._connectRooms(t,s))break;if(!this._unconnected.length)return!0}}return!1}_closestRoom(e,t){let s=1/0;const n=t.getCenter();let r=null;for(let t=0;t<e.length;t++){const a=e[t],o=a.getCenter(),i=o[0]-n[0],l=o[1]-n[1],c=i*i+l*l;c<s&&(s=c,r=a)}return r}_connectRooms(e,t){const s=e.getCenter(),n=t.getCenter(),r=n[0]-s[0],a=n[1]-s[1];let o,i,l,c,u,h,d;if(Math.abs(r)<Math.abs(a)?(l=a>0?2:0,c=(l+2)%4,u=t.getLeft(),h=t.getRight(),d=0):(l=r>0?1:3,c=(l+2)%4,u=t.getTop(),h=t.getBottom(),d=1),o=this._placeInWall(e,l),!o)return!1;if(o[d]>=u&&o[d]<=h){i=o.slice();let e=0;switch(c){case 0:e=t.getTop()-1;break;case 1:e=t.getRight()+1;break;case 2:e=t.getBottom()+1;break;case 3:e=t.getLeft()-1}i[(d+1)%2]=e,this._digLine([o,i])}else if(o[d]<u-1||o[d]>h+1){const e=o[d]-n[d];let s=0;switch(c){case 0:case 1:s=e<0?3:1;break;case 2:case 3:s=e<0?1:3}if(c=(c+s)%4,i=this._placeInWall(t,c),!i)return!1;const r=[0,0];r[d]=o[d];const a=(d+1)%2;r[a]=i[a],this._digLine([o,r,i])}else{const e=(d+1)%2;if(i=this._placeInWall(t,c),!i)return!1;const s=Math.round((i[e]+o[e])/2),n=[0,0],r=[0,0];n[d]=o[d],n[e]=s,r[d]=i[d],r[e]=s,this._digLine([o,n,r,i])}e.addDoor(o[0],o[1]),t.addDoor(i[0],i[1]),d=this._unconnected.indexOf(e),-1!==d&&(this._unconnected.splice(d,1),this._connected.push(e)),d=this._unconnected.indexOf(t),-1!==d&&(this._unconnected.splice(d,1),this._connected.push(t)),this._ngraph.addLink(e.getName(),t.getName(),{weight:1});const f=e.getName()+"->"+t.getName();return this._ugraph.createEdge(f).link(this._ugraph.nodes(e.getName()).query().first(),this._ugraph.nodes(t.getName()).query().first(),{weight:1}),!0}_placeInWall(e,t){let s=[0,0],n=[0,0],r=0;switch(t){case 0:n=[1,0],s=[e.getLeft(),e.getTop()-1],r=e.getRight()-e.getLeft()+1;break;case 1:n=[0,1],s=[e.getRight()+1,e.getTop()],r=e.getBottom()-e.getTop()+1;break;case 2:n=[1,0],s=[e.getLeft(),e.getBottom()+1],r=e.getRight()-e.getLeft()+1;break;case 3:n=[0,1],s=[e.getLeft()-1,e.getTop()],r=e.getBottom()-e.getTop()+1}const a=[];let i=-2;for(let e=0;e<r;e++){const t=s[0]+e*n[0],r=s[1]+e*n[1];a.push(null);1===this._map[t][r]?i!==e-1&&(a[e]=[t,r]):(i=e,e&&(a[e-1]=null))}for(let e=a.length-1;e>=0;e--)a[e]||a.splice(e,1);return a.length?o.default.getItem(a):null}_digLine(e){for(let t=1;t<e.length;t++){const s=e[t-1],n=e[t],r=new a.Corridor(s[0],s[1],n[0],n[1]);r.create(this._digCallback),this._corridors.push(r)}}_digCallback(e,t,s){this._map[e][t]=s,0===s&&this._dug++}_isWallCallback(e,t){return!(e<0||t<0||e>=this._width||t>=this._height)&&1===this._map[e][t]}_canBeDugCallback(e,t){return!(e<1||t<1||e+1>=this._width||t+1>=this._height)&&1===this._map[e][t]}}t.default=i},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(22)),a=s(59),o=s(418),i=s(420);class l extends r.default{constructor(e,t){super(e,t),this._rooms=[],this._corridors=[],this._ngraph=o(),this._ugraph=new i.Graph,this._digCallback=this._digCallback.bind(this)}startRoom(e){this._startRoom=e}_digCallback(e,t,s){throw Error("_digCallback must be done in derived class")}_firstRoom(){let e=this._startRoom;if(!e){const t=Math.floor(this._width/2),s=Math.floor(this._height/2);e=a.Room.createRandomCenter(t,s,this._options)}this._addRoom(e),e.create(this._digCallback),this._extraRooms&&this._extraRooms.forEach(t=>{this._addRoom(e),t.create(this._digCallback)})}_addRoom(e){this._rooms.push(e),this._ngraph.addNode(e.getName(),e),this._ugraph.createNode(e.getName(),e)}addRoom(e){this._startRoom?(this._extraRooms||(this._extraRooms=[]),this._extraRooms.push(e)):this._startRoom=e}getRooms(){return this._rooms}getCorridors(){return this._corridors}}t.default=l},function(e,t,s){"use strict";(function(e){var n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});var r=s(193),a=s(194),o=s(195),i=s(197),l=s(198),c=n(s(424)),u=n(s(425)),h=function(){function t(){this.__uniqval__=Number.MAX_SAFE_INTEGER,this.__init__()}return t.prototype.__init__=function(){this._lookup=Object.create(null),this._nodes=[],this._edges=[],this._nodeCollections=Object.create(null),this._edgeCollections=Object.create(null)},t.prototype.unit=function(e){return this._lookup[e]},t.prototype.nodeCount=function(){return this._nodes.length},t.prototype.edgeCount=function(){return this._edges.length},t.prototype.createNode=function(e,t){return this._createNode(e,t,(this.__uniqval__--).toString(16))},t.prototype._createNode=function(e,t,s){return this._addNode(new r.Node(e,t,s))},t.prototype._addNode=function(e){return this._nodes.push(e),this._lookup[e.__uniqid__]=e,this.nodes(e.entity)._add(e)},t.prototype.createEdge=function(e,t){return this._createEdge(e,t,(this.__uniqval__--).toString(16))},t.prototype._createEdge=function(e,t,s){return this._addEdge(new a.Edge(e,t,s))},t.prototype._addEdge=function(e){return this._edges.push(e),this._lookup[e.__uniqid__]=e,this.edges(e.entity)._add(e)},t.prototype.nodes=function(e){return this._nodeCollections[e]||(this._nodeCollections[e]=new o.NodeCollection(e))},t.prototype.edges=function(e){return this._edgeCollections[e]||(this._edgeCollections[e]=new i.EdgeCollection(e))},t.prototype._getPath=function(e,t){for(var s=t[e.__uniqid__];s[0]instanceof a.Edge;){s=t[s[0].oppositeNode(s[1]).__uniqid__].concat(s)}return s},t.prototype.closest=function(e,t){return t=t||{},this._search(e,t.compare,t.count,t.direction,t.minDepth,t.maxDepth)},t.prototype.trace=function(e,t,s){return this._search(e,(function(e){return e===t}),1,s,void 0,void 0)[0]||new l.Path([])},t.prototype._search=function(e,t,s,n,r,a){t="function"==typeof t?t:function(e){return!0},n|=0,s=Math.max(0,0|s),r=Math.max(0,0|r),a=Math.max(0,0|a);var o=Object.create(null);o[e.__uniqid__]=[e];var i=new Map;i.set(0,[e]);var c=[0],u=[],h=this._getPath;function d(e,t){i.has(t)?i.get(t).push(e):i.set(t,[e]),function(e,t){var s=e.length,n=s>>>1;for(;s;){if(s>>>=1,e[n]===t)return e;e[n]<t?n+=s:n-=s}var r=e[n]<t?1:0;e.splice(n+r,0,t)}(c,t)}function f(e,s){for(var i=0===n?e.edges:n>0?e.outputEdges:e.inputEdges,c=0,u=i.length;c<u;c++){var f=i[c],g=s+f.distance;if(!(a&&g>a)){var p=i[c].oppositeNode(e);o[p.__uniqid__]||(o[p.__uniqid__]=[f,p],d(p,g))}}return!!(s>=r&&t(e))&&new l.Path(h(e,o))}for(;c.length;)for(var g=c.shift(),p=i.get(g);p.length;){var m=f(p.shift(),g);if(m&&u.push(m),s&&u.length>=s)return u}return u},t.prototype.toJSON=function(){var e=this._nodeCollections,t=Object.keys(e).map((function(t){return e[t].toJSON()})),s=this._edgeCollections,n=Object.keys(s).map((function(e){return s[e].toJSON()})),r=this._nodes.map((function(e){return e.toJSON()})),a=this._edges.map((function(e){return e.toJSON()}));return JSON.stringify({nc:t,ec:n,n:r,e:a})},t.prototype.fromJSON=function(e){this.__init__();for(var t=JSON.parse(e),s=t.nc,n=t.ec,r=0,a=s.length;r<a;r++){var o=s[r];this.nodes(o[0]).createIndices(o[1])}for(r=0,a=n.length;r<a;r++){o=n[r];this.edges(o[0]).createIndices(o[1])}var i=t.n,l=t.e;for(r=0,a=i.length;r<a;r++){var c=i[r];this._createNode(c[0],c[1],c[2]);var u=parseInt(c[2],16);this.__uniqval__=u<this.__uniqval__?u-1:this.__uniqval__}for(r=0,a=l.length;r<a;r++){var h=l[r];this._createEdge(h[0],h[1],h[2]).link(this._lookup[h[3]],this._lookup[h[4]],h[5]).setDistance(h[6]);u=parseInt(h[2],16);this.__uniqval__=u<this.__uniqval__?u-1:this.__uniqval__}return this},t.prototype.gzip=function(t){var s=new e(this.toJSON());return t=t.bind(this),u.gzip(s,t),this},t.prototype.gunzip=function(t,s){s=s.bind(this);var n=this.fromJSON.bind(this);e.isBuffer(t)||(t=new e(t,"binary")),u.gunzip(t,(function(e,t){!e&&n(t.toString()),s(e)}))},t.prototype.save=function(e,t){return t=t.bind(this),this.gzip((function(s,n){s?t(s):c.writeFile(e,n,t)})),this},t.prototype.load=function(e,t){t=t.bind(this);var s=this.gunzip.bind(this);return c.readFile(e,(function(e,n){e?t(e):s(n,t)})),this},t}();t.Graph=h,t.default=function(){return h}}).call(this,s(51).Buffer)},function(e,t,s){"use strict";var n,r=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])})(e,t)},function(e,t){function s(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)});Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(t,s,n){var r=e.call(this,t,s,n)||this;return r.edges=[],r.inputEdges=[],r.outputEdges=[],r}return r(t,e),t.prototype.unlink=function(){for(var e=this.edges,t=0,s=e.length;t<s;t++)e[t].unlink();return!0},t.prototype.toJSON=function(){return e.prototype.toJSON.call(this)},t}(s(127).Unit);t.Node=a,t.default=function(){return a}},function(e,t,s){"use strict";var n,r=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])})(e,t)},function(e,t){function s(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)});Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(t,s,n){var r=e.call(this,t,s,n)||this;return r.inputNode=null,r.outputNode=null,r.duplex=!1,r.distance=1,r}return r(t,e),t.prototype._linkTo=function(e,t){if(t<=0&&e.inputEdges.push(this),t>=0){e.outputEdges.push(this)}return e.edges.push(this),!0},t.prototype.link=function(e,t,s){return this.unlink(),this.inputNode=e,this.outputNode=t,this.duplex=!!s,s?(this._linkTo(e,0),this._linkTo(t,0),this):(this._linkTo(e,1),this._linkTo(t,-1),this)},t.prototype.setDistance=function(e){return this.distance=Math.abs(e||0),this},t.prototype.setWeight=function(e){return this.distance=1/Math.abs(e||0),this},t.prototype.oppositeNode=function(e){return this.inputNode===e?this.outputNode:this.outputNode===e?this.inputNode:void 0},t.prototype.unlink=function(){var e,t=this.inputNode,s=this.outputNode;if(t&&s)return(e=t.edges.indexOf(this))>-1&&t.edges.splice(e,1),(e=s.edges.indexOf(this))>-1&&s.edges.splice(e,1),(e=t.outputEdges.indexOf(this))>-1&&t.outputEdges.splice(e,1),(e=s.inputEdges.indexOf(this))>-1&&s.inputEdges.splice(e,1),this.duplex&&((e=t.inputEdges.indexOf(this))>-1&&t.inputEdges.splice(e,1),(e=s.outputEdges.indexOf(this))>-1&&s.outputEdges.splice(e,1)),this.inputNode=null,this.outputNode=null,this.duplex=!1,!0},t.prototype.toJSON=function(){return e.prototype.toJSON.call(this).concat([this.inputNode.__uniqid__,this.outputNode.__uniqid__,this.duplex?1:0,this.distance])},t}(s(127).Unit);t.Edge=a,t.default=function(){return a}},function(e,t,s){"use strict";var n,r=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])})(e,t)},function(e,t){function s(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)});Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t}(s(128).Collection);t.NodeCollection=a,t.default=function(){return a}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={is:function(e,t){return e===t},not:function(e,t){return e!==t},gt:function(e,t){return e>t},lt:function(e,t){return e<t},gte:function(e,t){return e>=t},lte:function(e,t){return e<=t},ilike:function(e,t){return e.toLowerCase().indexOf(t.toLowerCase())>-1},like:function(e,t){return e.indexOf(t)>-1},in:function(e,t){return t.indexOf(e)>-1},not_in:function(e,t){return-1===t.indexOf(e)}},r=function(){function e(e){this._units=e.slice()}return e.prototype.__filter=function(t,s){s=!!s;for(var r=0,a=t.length;r<a;r++)"object"==typeof t[r]&&null!==t[r]||(t[r]={});t.length||(t=[{}]);for(var o,i,l,c,u,h,d,f,g,p,m=this._units.slice(),y=t.length,_=0;_!==y;_++){o=t[_],c=[];r=0;for(var b=(i=Object.keys(o)).length;r<b;r++){if((u=(l=i[r]).split("__")).length<2&&u.push("is"),h=u.pop(),!n[h])throw new Error('Filter type "'+h+'" not supported.');c.push([n[h],u,o[l]])}t[_]=c}var v,E,S=m.length,w=0,C=Array(S);try{for(r=0;r!==S;r++){var T=m[r];g=T.properties,v=!0;for(var O=0;O!==y&&v;O++){v=!1,p=(c=t[O]).length;for(var A=0;A!==p&&!v;A++){f=(d=c[A])[0],E=g,l=d[1];_=0;for(var M=l.length;_!==M;_++)E=E[l[_]];f(E,d[2])===s&&(v=!0)}!v&&(C[w++]=T)}}}catch(e){throw console.log(e),new Error("Nested field "+l.join("__")+" does not exist")}return new e(C=C.slice(0,w))},e.prototype.filter=function(){var e=[].slice.call(arguments);return e=e[0]instanceof Array?e[0]:e,this.__filter(e,!1)},e.prototype.exclude=function(){var e=[].slice.call(arguments);return e=e[0]instanceof Array?e[0]:e,this.__filter(e,!0)},e.prototype.first=function(){return this._units[0]},e.prototype.last=function(){var e=this._units;return e[e.length-1]},e.prototype.units=function(){return this._units.slice()},e}();t.Query=r,t.default=function(){return r}},function(e,t,s){"use strict";var n,r=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s])})(e,t)},function(e,t){function s(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)});Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t}(s(128).Collection);t.EdgeCollection=a,t.default=function(){return a}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this._raw=e.slice()}return e.prototype.start=function(){return this._raw[0]},e.prototype.end=function(){return this._raw[this._raw.length-1]},e.prototype.length=function(){return this._raw.length>>>1},e.prototype.distance=function(){return this._raw.filter((function(e,t){return!!(1&t)})).reduce((function(e,t){return e+t.distance}),0)},e.prototype.prettify=function(){return this._raw.map((function(e,t,s){var n=e.toString();if(1&t){if(e.duplex)return["<>",n,"<>"].join(" ");var r=s[t-1];return e.inputNode===r?[">>",n,">>"].join(" "):["<<",n,"<<"].join(" ")}return n})).join(" ")},e.prototype.toString=function(){return this.prettify()},e}();t.Path=n,t.default=function(){return n}},function(e,t,s){"use strict";(function(t,n){var r=s(87);e.exports=b;var a,o=s(427);b.ReadableState=_;s(129).EventEmitter;var i=function(e,t){return e.listeners(t).length},l=s(200),c=s(88).Buffer,u=t.Uint8Array||function(){};var h=s(61);h.inherits=s(43);var d=s(428),f=void 0;f=d&&d.debuglog?d.debuglog("stream"):function(){};var g,p=s(429),m=s(201);h.inherits(b,l);var y=["error","close","destroy","pause","resume"];function _(e,t){e=e||{};var n=t instanceof(a=a||s(44));this.objectMode=!!e.objectMode,n&&(this.objectMode=this.objectMode||!!e.readableObjectMode);var r=e.highWaterMark,o=e.readableHighWaterMark,i=this.objectMode?16:16384;this.highWaterMark=r||0===r?r:n&&(o||0===o)?o:i,this.highWaterMark=Math.floor(this.highWaterMark),this.buffer=new p,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.destroyed=!1,this.defaultEncoding=e.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,e.encoding&&(g||(g=s(202).StringDecoder),this.decoder=new g(e.encoding),this.encoding=e.encoding)}function b(e){if(a=a||s(44),!(this instanceof b))return new b(e);this._readableState=new _(e,this),this.readable=!0,e&&("function"==typeof e.read&&(this._read=e.read),"function"==typeof e.destroy&&(this._destroy=e.destroy)),l.call(this)}function v(e,t,s,n,r){var a,o=e._readableState;null===t?(o.reading=!1,function(e,t){if(t.ended)return;if(t.decoder){var s=t.decoder.end();s&&s.length&&(t.buffer.push(s),t.length+=t.objectMode?1:s.length)}t.ended=!0,w(e)}(e,o)):(r||(a=function(e,t){var s;n=t,c.isBuffer(n)||n instanceof u||"string"==typeof t||void 0===t||e.objectMode||(s=new TypeError("Invalid non-string/buffer chunk"));var n;return s}(o,t)),a?e.emit("error",a):o.objectMode||t&&t.length>0?("string"==typeof t||o.objectMode||Object.getPrototypeOf(t)===c.prototype||(t=function(e){return c.from(e)}(t)),n?o.endEmitted?e.emit("error",new Error("stream.unshift() after end event")):E(e,o,t,!0):o.ended?e.emit("error",new Error("stream.push() after EOF")):(o.reading=!1,o.decoder&&!s?(t=o.decoder.write(t),o.objectMode||0!==t.length?E(e,o,t,!1):T(e,o)):E(e,o,t,!1))):n||(o.reading=!1));return function(e){return!e.ended&&(e.needReadable||e.length<e.highWaterMark||0===e.length)}(o)}function E(e,t,s,n){t.flowing&&0===t.length&&!t.sync?(e.emit("data",s),e.read(0)):(t.length+=t.objectMode?1:s.length,n?t.buffer.unshift(s):t.buffer.push(s),t.needReadable&&w(e)),T(e,t)}Object.defineProperty(b.prototype,"destroyed",{get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(e){this._readableState&&(this._readableState.destroyed=e)}}),b.prototype.destroy=m.destroy,b.prototype._undestroy=m.undestroy,b.prototype._destroy=function(e,t){this.push(null),t(e)},b.prototype.push=function(e,t){var s,n=this._readableState;return n.objectMode?s=!0:"string"==typeof e&&((t=t||n.defaultEncoding)!==n.encoding&&(e=c.from(e,t),t=""),s=!0),v(this,e,t,!1,s)},b.prototype.unshift=function(e){return v(this,e,null,!0,!1)},b.prototype.isPaused=function(){return!1===this._readableState.flowing},b.prototype.setEncoding=function(e){return g||(g=s(202).StringDecoder),this._readableState.decoder=new g(e),this._readableState.encoding=e,this};function S(e,t){return e<=0||0===t.length&&t.ended?0:t.objectMode?1:e!=e?t.flowing&&t.length?t.buffer.head.data.length:t.length:(e>t.highWaterMark&&(t.highWaterMark=function(e){return e>=8388608?e=8388608:(e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e++),e}(e)),e<=t.length?e:t.ended?t.length:(t.needReadable=!0,0))}function w(e){var t=e._readableState;t.needReadable=!1,t.emittedReadable||(f("emitReadable",t.flowing),t.emittedReadable=!0,t.sync?r.nextTick(C,e):C(e))}function C(e){f("emit readable"),e.emit("readable"),N(e)}function T(e,t){t.readingMore||(t.readingMore=!0,r.nextTick(O,e,t))}function O(e,t){for(var s=t.length;!t.reading&&!t.flowing&&!t.ended&&t.length<t.highWaterMark&&(f("maybeReadMore read 0"),e.read(0),s!==t.length);)s=t.length;t.readingMore=!1}function A(e){f("readable nexttick read 0"),e.read(0)}function M(e,t){t.reading||(f("resume read 0"),e.read(0)),t.resumeScheduled=!1,t.awaitDrain=0,e.emit("resume"),N(e),t.flowing&&!t.reading&&e.read(0)}function N(e){var t=e._readableState;for(f("flow",t.flowing);t.flowing&&null!==e.read(););}function P(e,t){return 0===t.length?null:(t.objectMode?s=t.buffer.shift():!e||e>=t.length?(s=t.decoder?t.buffer.join(""):1===t.buffer.length?t.buffer.head.data:t.buffer.concat(t.length),t.buffer.clear()):s=function(e,t,s){var n;e<t.head.data.length?(n=t.head.data.slice(0,e),t.head.data=t.head.data.slice(e)):n=e===t.head.data.length?t.shift():s?function(e,t){var s=t.head,n=1,r=s.data;e-=r.length;for(;s=s.next;){var a=s.data,o=e>a.length?a.length:e;if(o===a.length?r+=a:r+=a.slice(0,e),0===(e-=o)){o===a.length?(++n,s.next?t.head=s.next:t.head=t.tail=null):(t.head=s,s.data=a.slice(o));break}++n}return t.length-=n,r}(e,t):function(e,t){var s=c.allocUnsafe(e),n=t.head,r=1;n.data.copy(s),e-=n.data.length;for(;n=n.next;){var a=n.data,o=e>a.length?a.length:e;if(a.copy(s,s.length-e,0,o),0===(e-=o)){o===a.length?(++r,n.next?t.head=n.next:t.head=t.tail=null):(t.head=n,n.data=a.slice(o));break}++r}return t.length-=r,s}(e,t);return n}(e,t.buffer,t.decoder),s);var s}function D(e){var t=e._readableState;if(t.length>0)throw new Error('"endReadable()" called on non-empty stream');t.endEmitted||(t.ended=!0,r.nextTick(I,t,e))}function I(e,t){e.endEmitted||0!==e.length||(e.endEmitted=!0,t.readable=!1,t.emit("end"))}function L(e,t){for(var s=0,n=e.length;s<n;s++)if(e[s]===t)return s;return-1}b.prototype.read=function(e){f("read",e),e=parseInt(e,10);var t=this._readableState,s=e;if(0!==e&&(t.emittedReadable=!1),0===e&&t.needReadable&&(t.length>=t.highWaterMark||t.ended))return f("read: emitReadable",t.length,t.ended),0===t.length&&t.ended?D(this):w(this),null;if(0===(e=S(e,t))&&t.ended)return 0===t.length&&D(this),null;var n,r=t.needReadable;return f("need readable",r),(0===t.length||t.length-e<t.highWaterMark)&&f("length less than watermark",r=!0),t.ended||t.reading?f("reading or ended",r=!1):r&&(f("do read"),t.reading=!0,t.sync=!0,0===t.length&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1,t.reading||(e=S(s,t))),null===(n=e>0?P(e,t):null)?(t.needReadable=!0,e=0):t.length-=e,0===t.length&&(t.ended||(t.needReadable=!0),s!==e&&t.ended&&D(this)),null!==n&&this.emit("data",n),n},b.prototype._read=function(e){this.emit("error",new Error("_read() is not implemented"))},b.prototype.pipe=function(e,t){var s=this,a=this._readableState;switch(a.pipesCount){case 0:a.pipes=e;break;case 1:a.pipes=[a.pipes,e];break;default:a.pipes.push(e)}a.pipesCount+=1,f("pipe count=%d opts=%j",a.pipesCount,t);var l=(!t||!1!==t.end)&&e!==n.stdout&&e!==n.stderr?u:b;function c(t,n){f("onunpipe"),t===s&&n&&!1===n.hasUnpiped&&(n.hasUnpiped=!0,f("cleanup"),e.removeListener("close",y),e.removeListener("finish",_),e.removeListener("drain",h),e.removeListener("error",m),e.removeListener("unpipe",c),s.removeListener("end",u),s.removeListener("end",b),s.removeListener("data",p),d=!0,!a.awaitDrain||e._writableState&&!e._writableState.needDrain||h())}function u(){f("onend"),e.end()}a.endEmitted?r.nextTick(l):s.once("end",l),e.on("unpipe",c);var h=function(e){return function(){var t=e._readableState;f("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,0===t.awaitDrain&&i(e,"data")&&(t.flowing=!0,N(e))}}(s);e.on("drain",h);var d=!1;var g=!1;function p(t){f("ondata"),g=!1,!1!==e.write(t)||g||((1===a.pipesCount&&a.pipes===e||a.pipesCount>1&&-1!==L(a.pipes,e))&&!d&&(f("false write response, pause",s._readableState.awaitDrain),s._readableState.awaitDrain++,g=!0),s.pause())}function m(t){f("onerror",t),b(),e.removeListener("error",m),0===i(e,"error")&&e.emit("error",t)}function y(){e.removeListener("finish",_),b()}function _(){f("onfinish"),e.removeListener("close",y),b()}function b(){f("unpipe"),s.unpipe(e)}return s.on("data",p),function(e,t,s){if("function"==typeof e.prependListener)return e.prependListener(t,s);e._events&&e._events[t]?o(e._events[t])?e._events[t].unshift(s):e._events[t]=[s,e._events[t]]:e.on(t,s)}(e,"error",m),e.once("close",y),e.once("finish",_),e.emit("pipe",s),a.flowing||(f("pipe resume"),s.resume()),e},b.prototype.unpipe=function(e){var t=this._readableState,s={hasUnpiped:!1};if(0===t.pipesCount)return this;if(1===t.pipesCount)return e&&e!==t.pipes||(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this,s)),this;if(!e){var n=t.pipes,r=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var a=0;a<r;a++)n[a].emit("unpipe",this,s);return this}var o=L(t.pipes,e);return-1===o||(t.pipes.splice(o,1),t.pipesCount-=1,1===t.pipesCount&&(t.pipes=t.pipes[0]),e.emit("unpipe",this,s)),this},b.prototype.on=function(e,t){var s=l.prototype.on.call(this,e,t);if("data"===e)!1!==this._readableState.flowing&&this.resume();else if("readable"===e){var n=this._readableState;n.endEmitted||n.readableListening||(n.readableListening=n.needReadable=!0,n.emittedReadable=!1,n.reading?n.length&&w(this):r.nextTick(A,this))}return s},b.prototype.addListener=b.prototype.on,b.prototype.resume=function(){var e=this._readableState;return e.flowing||(f("resume"),e.flowing=!0,function(e,t){t.resumeScheduled||(t.resumeScheduled=!0,r.nextTick(M,e,t))}(this,e)),this},b.prototype.pause=function(){return f("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(f("pause"),this._readableState.flowing=!1,this.emit("pause")),this},b.prototype.wrap=function(e){var t=this,s=this._readableState,n=!1;for(var r in e.on("end",(function(){if(f("wrapped end"),s.decoder&&!s.ended){var e=s.decoder.end();e&&e.length&&t.push(e)}t.push(null)})),e.on("data",(function(r){(f("wrapped data"),s.decoder&&(r=s.decoder.write(r)),s.objectMode&&null==r)||(s.objectMode||r&&r.length)&&(t.push(r)||(n=!0,e.pause()))})),e)void 0===this[r]&&"function"==typeof e[r]&&(this[r]=function(t){return function(){return e[t].apply(e,arguments)}}(r));for(var a=0;a<y.length;a++)e.on(y[a],this.emit.bind(this,y[a]));return this._read=function(t){f("wrapped _read",t),n&&(n=!1,e.resume())},this},b._fromList=P}).call(this,s(28),s(31))},function(e,t,s){e.exports=s(129).EventEmitter},function(e,t,s){"use strict";var n=s(87);function r(e,t){e.emit("error",t)}e.exports={destroy:function(e,t){var s=this,a=this._readableState&&this._readableState.destroyed,o=this._writableState&&this._writableState.destroyed;return a||o?(t?t(e):!e||this._writableState&&this._writableState.errorEmitted||n.nextTick(r,this,e),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(e||null,(function(e){!t&&e?(n.nextTick(r,s,e),s._writableState&&(s._writableState.errorEmitted=!0)):t&&t(e)})),this)},undestroy:function(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}}},function(e,t,s){"use strict";var n=s(88).Buffer,r=n.isEncoding||function(e){switch((e=""+e)&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function a(e){var t;switch(this.encoding=function(e){var t=function(e){if(!e)return"utf8";for(var t;;)switch(e){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:if(t)return;e=(""+e).toLowerCase(),t=!0}}(e);if("string"!=typeof t&&(n.isEncoding===r||!r(e)))throw new Error("Unknown encoding: "+e);return t||e}(e),this.encoding){case"utf16le":this.text=l,this.end=c,t=4;break;case"utf8":this.fillLast=i,t=4;break;case"base64":this.text=u,this.end=h,t=3;break;default:return this.write=d,void(this.end=f)}this.lastNeed=0,this.lastTotal=0,this.lastChar=n.allocUnsafe(t)}function o(e){return e<=127?0:e>>5==6?2:e>>4==14?3:e>>3==30?4:-1}function i(e){var t=this.lastTotal-this.lastNeed,s=function(e,t,s){if(128!=(192&t[0]))return e.lastNeed=0,"�".repeat(s);if(e.lastNeed>1&&t.length>1){if(128!=(192&t[1]))return e.lastNeed=1,"�".repeat(s+1);if(e.lastNeed>2&&t.length>2&&128!=(192&t[2]))return e.lastNeed=2,"�".repeat(s+2)}}(this,e,t);return void 0!==s?s:this.lastNeed<=e.length?(e.copy(this.lastChar,t,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(e.copy(this.lastChar,t,0,e.length),void(this.lastNeed-=e.length))}function l(e,t){if((e.length-t)%2==0){var s=e.toString("utf16le",t);if(s){var n=s.charCodeAt(s.length-1);if(n>=55296&&n<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1],s.slice(0,-1)}return s}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=e[e.length-1],e.toString("utf16le",t,e.length-1)}function c(e){var t=e&&e.length?this.write(e):"";if(this.lastNeed){var s=this.lastTotal-this.lastNeed;return t+this.lastChar.toString("utf16le",0,s)}return t}function u(e,t){var s=(e.length-t)%3;return 0===s?e.toString("base64",t):(this.lastNeed=3-s,this.lastTotal=3,1===s?this.lastChar[0]=e[e.length-1]:(this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1]),e.toString("base64",t,e.length-s))}function h(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+this.lastChar.toString("base64",0,3-this.lastNeed):t}function d(e){return e.toString(this.encoding)}function f(e){return e&&e.length?this.write(e):""}t.StringDecoder=a,a.prototype.write=function(e){if(0===e.length)return"";var t,s;if(this.lastNeed){if(void 0===(t=this.fillLast(e)))return"";s=this.lastNeed,this.lastNeed=0}else s=0;return s<e.length?t?t+this.text(e,s):this.text(e,s):t||""},a.prototype.end=function(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+"�".repeat(this.lastTotal-this.lastNeed):t},a.prototype.text=function(e,t){var s=function(e,t,s){var n=t.length-1;if(n<s)return 0;var r=o(t[n]);if(r>=0)return r>0&&(e.lastNeed=r-1),r;if(--n<s)return 0;if((r=o(t[n]))>=0)return r>0&&(e.lastNeed=r-2),r;if(--n<s)return 0;if((r=o(t[n]))>=0)return r>0&&(2===r?r=0:e.lastNeed=r-3),r;return 0}(this,e,t);if(!this.lastNeed)return e.toString("utf8",t);this.lastTotal=s;var n=e.length-(s-this.lastNeed);return e.copy(this.lastChar,0,n),e.toString("utf8",t,n)},a.prototype.fillLast=function(e){if(this.lastNeed<=e.length)return e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,e.length),this.lastNeed-=e.length}},function(e,t,s){"use strict";e.exports=o;var n=s(44),r=s(61);function a(e,t){var s=this._transformState;s.transforming=!1;var n=s.writecb;if(!n)return this.emit("error",new Error("write callback called multiple times"));s.writechunk=null,s.writecb=null,null!=t&&this.push(t),n(e);var r=this._readableState;r.reading=!1,(r.needReadable||r.length<r.highWaterMark)&&this._read(r.highWaterMark)}function o(e){if(!(this instanceof o))return new o(e);n.call(this,e),this._transformState={afterTransform:a.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.on("prefinish",i)}function i(){var e=this;"function"==typeof this._flush?this._flush((function(t,s){l(e,t,s)})):l(this,null,null)}function l(e,t,s){if(t)return e.emit("error",t);if(null!=s&&e.push(s),e._writableState.length)throw new Error("Calling transform done when ws.length != 0");if(e._transformState.transforming)throw new Error("Calling transform done when still transforming");return e.push(null)}r.inherits=s(43),r.inherits(o,n),o.prototype.push=function(e,t){return this._transformState.needTransform=!1,n.prototype.push.call(this,e,t)},o.prototype._transform=function(e,t,s){throw new Error("_transform() is not implemented")},o.prototype._write=function(e,t,s){var n=this._transformState;if(n.writecb=s,n.writechunk=e,n.writeencoding=t,!n.transforming){var r=this._readableState;(n.needTransform||r.needReadable||r.length<r.highWaterMark)&&this._read(r.highWaterMark)}},o.prototype._read=function(e){var t=this._transformState;null!==t.writechunk&&t.writecb&&!t.transforming?(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform)):t.needTransform=!0},o.prototype._destroy=function(e,t){var s=this;n.prototype._destroy.call(this,e,(function(e){t(e),s.emit("close")}))}},function(e,t,s){"use strict";(function(t){var n=s(440);
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 */function r(e,t){if(e===t)return 0;for(var s=e.length,n=t.length,r=0,a=Math.min(s,n);r<a;++r)if(e[r]!==t[r]){s=e[r],n=t[r];break}return s<n?-1:n<s?1:0}function a(e){return t.Buffer&&"function"==typeof t.Buffer.isBuffer?t.Buffer.isBuffer(e):!(null==e||!e._isBuffer)}var o=s(205),i=Object.prototype.hasOwnProperty,l=Array.prototype.slice,c="foo"===function(){}.name;function u(e){return Object.prototype.toString.call(e)}function h(e){return!a(e)&&("function"==typeof t.ArrayBuffer&&("function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):!!e&&(e instanceof DataView||!!(e.buffer&&e.buffer instanceof ArrayBuffer))))}var d=e.exports=_,f=/\s*function\s+([^\(\s]*)\s*/;function g(e){if(o.isFunction(e)){if(c)return e.name;var t=e.toString().match(f);return t&&t[1]}}function p(e,t){return"string"==typeof e?e.length<t?e:e.slice(0,t):e}function m(e){if(c||!o.isFunction(e))return o.inspect(e);var t=g(e);return"[Function"+(t?": "+t:"")+"]"}function y(e,t,s,n,r){throw new d.AssertionError({message:s,actual:e,expected:t,operator:n,stackStartFunction:r})}function _(e,t){e||y(e,!0,t,"==",d.ok)}function b(e,t,s,n){if(e===t)return!0;if(a(e)&&a(t))return 0===r(e,t);if(o.isDate(e)&&o.isDate(t))return e.getTime()===t.getTime();if(o.isRegExp(e)&&o.isRegExp(t))return e.source===t.source&&e.global===t.global&&e.multiline===t.multiline&&e.lastIndex===t.lastIndex&&e.ignoreCase===t.ignoreCase;if(null!==e&&"object"==typeof e||null!==t&&"object"==typeof t){if(h(e)&&h(t)&&u(e)===u(t)&&!(e instanceof Float32Array||e instanceof Float64Array))return 0===r(new Uint8Array(e.buffer),new Uint8Array(t.buffer));if(a(e)!==a(t))return!1;var i=(n=n||{actual:[],expected:[]}).actual.indexOf(e);return-1!==i&&i===n.expected.indexOf(t)||(n.actual.push(e),n.expected.push(t),function(e,t,s,n){if(null==e||null==t)return!1;if(o.isPrimitive(e)||o.isPrimitive(t))return e===t;if(s&&Object.getPrototypeOf(e)!==Object.getPrototypeOf(t))return!1;var r=v(e),a=v(t);if(r&&!a||!r&&a)return!1;if(r)return e=l.call(e),t=l.call(t),b(e,t,s);var i,c,u=w(e),h=w(t);if(u.length!==h.length)return!1;for(u.sort(),h.sort(),c=u.length-1;c>=0;c--)if(u[c]!==h[c])return!1;for(c=u.length-1;c>=0;c--)if(i=u[c],!b(e[i],t[i],s,n))return!1;return!0}(e,t,s,n))}return s?e===t:e==t}function v(e){return"[object Arguments]"==Object.prototype.toString.call(e)}function E(e,t){if(!e||!t)return!1;if("[object RegExp]"==Object.prototype.toString.call(t))return t.test(e);try{if(e instanceof t)return!0}catch(e){}return!Error.isPrototypeOf(t)&&!0===t.call({},e)}function S(e,t,s,n){var r;if("function"!=typeof t)throw new TypeError('"block" argument must be a function');"string"==typeof s&&(n=s,s=null),r=function(e){var t;try{e()}catch(e){t=e}return t}(t),n=(s&&s.name?" ("+s.name+").":".")+(n?" "+n:"."),e&&!r&&y(r,s,"Missing expected exception"+n);var a="string"==typeof n,i=!e&&r&&!s;if((!e&&o.isError(r)&&a&&E(r,s)||i)&&y(r,s,"Got unwanted exception"+n),e&&r&&s&&!E(r,s)||!e&&r)throw r}d.AssertionError=function(e){this.name="AssertionError",this.actual=e.actual,this.expected=e.expected,this.operator=e.operator,e.message?(this.message=e.message,this.generatedMessage=!1):(this.message=function(e){return p(m(e.actual),128)+" "+e.operator+" "+p(m(e.expected),128)}(this),this.generatedMessage=!0);var t=e.stackStartFunction||y;if(Error.captureStackTrace)Error.captureStackTrace(this,t);else{var s=new Error;if(s.stack){var n=s.stack,r=g(t),a=n.indexOf("\n"+r);if(a>=0){var o=n.indexOf("\n",a+1);n=n.substring(o+1)}this.stack=n}}},o.inherits(d.AssertionError,Error),d.fail=y,d.ok=_,d.equal=function(e,t,s){e!=t&&y(e,t,s,"==",d.equal)},d.notEqual=function(e,t,s){e==t&&y(e,t,s,"!=",d.notEqual)},d.deepEqual=function(e,t,s){b(e,t,!1)||y(e,t,s,"deepEqual",d.deepEqual)},d.deepStrictEqual=function(e,t,s){b(e,t,!0)||y(e,t,s,"deepStrictEqual",d.deepStrictEqual)},d.notDeepEqual=function(e,t,s){b(e,t,!1)&&y(e,t,s,"notDeepEqual",d.notDeepEqual)},d.notDeepStrictEqual=function e(t,s,n){b(t,s,!0)&&y(t,s,n,"notDeepStrictEqual",e)},d.strictEqual=function(e,t,s){e!==t&&y(e,t,s,"===",d.strictEqual)},d.notStrictEqual=function(e,t,s){e===t&&y(e,t,s,"!==",d.notStrictEqual)},d.throws=function(e,t,s){S(!0,e,t,s)},d.doesNotThrow=function(e,t,s){S(!1,e,t,s)},d.ifError=function(e){if(e)throw e},d.strict=n((function e(t,s){t||y(t,!0,s,"==",e)}),d,{equal:d.strictEqual,deepEqual:d.deepStrictEqual,notEqual:d.notStrictEqual,notDeepEqual:d.notDeepStrictEqual}),d.strict.strict=d.strict;var w=Object.keys||function(e){var t=[];for(var s in e)i.call(e,s)&&t.push(s);return t}}).call(this,s(28))},function(e,t,s){(function(e){var n=Object.getOwnPropertyDescriptors||function(e){for(var t=Object.keys(e),s={},n=0;n<t.length;n++)s[t[n]]=Object.getOwnPropertyDescriptor(e,t[n]);return s},r=/%[sdj%]/g;t.format=function(e){if(!y(e)){for(var t=[],s=0;s<arguments.length;s++)t.push(i(arguments[s]));return t.join(" ")}s=1;for(var n=arguments,a=n.length,o=String(e).replace(r,(function(e){if("%%"===e)return"%";if(s>=a)return e;switch(e){case"%s":return String(n[s++]);case"%d":return Number(n[s++]);case"%j":try{return JSON.stringify(n[s++])}catch(e){return"[Circular]"}default:return e}})),l=n[s];s<a;l=n[++s])p(l)||!v(l)?o+=" "+l:o+=" "+i(l);return o},t.deprecate=function(s,n){if(void 0!==e&&!0===e.noDeprecation)return s;if(void 0===e)return function(){return t.deprecate(s,n).apply(this,arguments)};var r=!1;return function(){if(!r){if(e.throwDeprecation)throw new Error(n);e.traceDeprecation?console.trace(n):console.error(n),r=!0}return s.apply(this,arguments)}};var a,o={};function i(e,s){var n={seen:[],stylize:c};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),g(s)?n.showHidden=s:s&&t._extend(n,s),_(n.showHidden)&&(n.showHidden=!1),_(n.depth)&&(n.depth=2),_(n.colors)&&(n.colors=!1),_(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=l),u(n,e,n.depth)}function l(e,t){var s=i.styles[t];return s?"["+i.colors[s][0]+"m"+e+"["+i.colors[s][1]+"m":e}function c(e,t){return e}function u(e,s,n){if(e.customInspect&&s&&w(s.inspect)&&s.inspect!==t.inspect&&(!s.constructor||s.constructor.prototype!==s)){var r=s.inspect(n,e);return y(r)||(r=u(e,r,n)),r}var a=function(e,t){if(_(t))return e.stylize("undefined","undefined");if(y(t)){var s="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(s,"string")}if(m(t))return e.stylize(""+t,"number");if(g(t))return e.stylize(""+t,"boolean");if(p(t))return e.stylize("null","null")}(e,s);if(a)return a;var o=Object.keys(s),i=function(e){var t={};return e.forEach((function(e,s){t[e]=!0})),t}(o);if(e.showHidden&&(o=Object.getOwnPropertyNames(s)),S(s)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return h(s);if(0===o.length){if(w(s)){var l=s.name?": "+s.name:"";return e.stylize("[Function"+l+"]","special")}if(b(s))return e.stylize(RegExp.prototype.toString.call(s),"regexp");if(E(s))return e.stylize(Date.prototype.toString.call(s),"date");if(S(s))return h(s)}var c,v="",C=!1,T=["{","}"];(f(s)&&(C=!0,T=["[","]"]),w(s))&&(v=" [Function"+(s.name?": "+s.name:"")+"]");return b(s)&&(v=" "+RegExp.prototype.toString.call(s)),E(s)&&(v=" "+Date.prototype.toUTCString.call(s)),S(s)&&(v=" "+h(s)),0!==o.length||C&&0!=s.length?n<0?b(s)?e.stylize(RegExp.prototype.toString.call(s),"regexp"):e.stylize("[Object]","special"):(e.seen.push(s),c=C?function(e,t,s,n,r){for(var a=[],o=0,i=t.length;o<i;++o)M(t,String(o))?a.push(d(e,t,s,n,String(o),!0)):a.push("");return r.forEach((function(r){r.match(/^\d+$/)||a.push(d(e,t,s,n,r,!0))})),a}(e,s,n,i,o):o.map((function(t){return d(e,s,n,i,t,C)})),e.seen.pop(),function(e,t,s){if(e.reduce((function(e,t){return t.indexOf("\n")>=0&&0,e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60)return s[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+s[1];return s[0]+t+" "+e.join(", ")+" "+s[1]}(c,v,T)):T[0]+v+T[1]}function h(e){return"["+Error.prototype.toString.call(e)+"]"}function d(e,t,s,n,r,a){var o,i,l;if((l=Object.getOwnPropertyDescriptor(t,r)||{value:t[r]}).get?i=l.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):l.set&&(i=e.stylize("[Setter]","special")),M(n,r)||(o="["+r+"]"),i||(e.seen.indexOf(l.value)<0?(i=p(s)?u(e,l.value,null):u(e,l.value,s-1)).indexOf("\n")>-1&&(i=a?i.split("\n").map((function(e){return"  "+e})).join("\n").substr(2):"\n"+i.split("\n").map((function(e){return"   "+e})).join("\n")):i=e.stylize("[Circular]","special")),_(o)){if(a&&r.match(/^\d+$/))return i;(o=JSON.stringify(""+r)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.substr(1,o.length-2),o=e.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),o=e.stylize(o,"string"))}return o+": "+i}function f(e){return Array.isArray(e)}function g(e){return"boolean"==typeof e}function p(e){return null===e}function m(e){return"number"==typeof e}function y(e){return"string"==typeof e}function _(e){return void 0===e}function b(e){return v(e)&&"[object RegExp]"===C(e)}function v(e){return"object"==typeof e&&null!==e}function E(e){return v(e)&&"[object Date]"===C(e)}function S(e){return v(e)&&("[object Error]"===C(e)||e instanceof Error)}function w(e){return"function"==typeof e}function C(e){return Object.prototype.toString.call(e)}function T(e){return e<10?"0"+e.toString(10):e.toString(10)}t.debuglog=function(s){if(_(a)&&(a=e.env.NODE_DEBUG||""),s=s.toUpperCase(),!o[s])if(new RegExp("\\b"+s+"\\b","i").test(a)){var n=e.pid;o[s]=function(){var e=t.format.apply(t,arguments);console.error("%s %d: %s",s,n,e)}}else o[s]=function(){};return o[s]},t.inspect=i,i.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},i.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},t.isArray=f,t.isBoolean=g,t.isNull=p,t.isNullOrUndefined=function(e){return null==e},t.isNumber=m,t.isString=y,t.isSymbol=function(e){return"symbol"==typeof e},t.isUndefined=_,t.isRegExp=b,t.isObject=v,t.isDate=E,t.isError=S,t.isFunction=w,t.isPrimitive=function(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e},t.isBuffer=s(441);var O=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function A(){var e=new Date,t=[T(e.getHours()),T(e.getMinutes()),T(e.getSeconds())].join(":");return[e.getDate(),O[e.getMonth()],t].join(" ")}function M(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.log=function(){console.log("%s - %s",A(),t.format.apply(t,arguments))},t.inherits=s(43),t._extend=function(e,t){if(!t||!v(t))return e;for(var s=Object.keys(t),n=s.length;n--;)e[s[n]]=t[s[n]];return e};var N="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function P(e,t){if(!e){var s=new Error("Promise was rejected with a falsy value");s.reason=e,e=s}return t(e)}t.promisify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');if(N&&e[N]){var t;if("function"!=typeof(t=e[N]))throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(t,N,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}function t(){for(var t,s,n=new Promise((function(e,n){t=e,s=n})),r=[],a=0;a<arguments.length;a++)r.push(arguments[a]);r.push((function(e,n){e?s(e):t(n)}));try{e.apply(this,r)}catch(e){s(e)}return n}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),N&&Object.defineProperty(t,N,{value:t,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(t,n(e))},t.promisify.custom=N,t.callbackify=function(t){if("function"!=typeof t)throw new TypeError('The "original" argument must be of type Function');function s(){for(var s=[],n=0;n<arguments.length;n++)s.push(arguments[n]);var r=s.pop();if("function"!=typeof r)throw new TypeError("The last argument must be of type Function");var a=this,o=function(){return r.apply(a,arguments)};t.apply(this,s).then((function(t){e.nextTick(o,null,t)}),(function(t){e.nextTick(P,t,o)}))}return Object.setPrototypeOf(s,Object.getPrototypeOf(t)),Object.defineProperties(s,n(t)),s}}).call(this,s(31))},function(e,t,s){"use strict";e.exports=function(e,t,s,n){for(var r=65535&e|0,a=e>>>16&65535|0,o=0;0!==s;){s-=o=s>2e3?2e3:s;do{a=a+(r=r+t[n++]|0)|0}while(--o);r%=65521,a%=65521}return r|a<<16|0}},function(e,t,s){"use strict";var n=function(){for(var e,t=[],s=0;s<256;s++){e=s;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[s]=e}return t}();e.exports=function(e,t,s,r){var a=n,o=r+s;e^=-1;for(var i=r;i<o;i++)e=e>>>8^a[255&(e^t[i])];return-1^e}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(191)),a=s(59),o=n(s(14)),i=s(36),l={room:a.Room,corridor:a.Corridor};class c extends r.default{constructor(e,t,s={}){super(e,t),this._options=Object.assign({roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3},s),this._features={room:4,corridor:4},this._map=[],this._featureAttempts=20,this._walls={},this._dug=0,this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this),this._xyToFeat={}}create(e){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;const t=(this._width-2)*(this._height-2);this._firstRoom();const s=Date.now();let n=0;do{n=0;if(Date.now()-s>this._options.timeLimit)break;const e=this._findWall();if(!e)break;const t=e.split(","),r=parseInt(t[0],10),a=parseInt(t[1],10),o=this._getDiggingDirection(r,a);if(!o)continue;let i=0;do{if(i++,this._tryFeature(r,a,o[0],o[1])){this._removeSurroundingWalls(r,a),this._removeSurroundingWalls(r-o[0],a-o[1]);break}}while(i<this._featureAttempts);for(const e in this._walls)this._walls[e]>1&&n++}while(this._dug/t<this._options.dugPercentage||n);if(this._addDoors(),this._createEdgesForGraph(),e)for(let t=0;t<this._width;t++)for(let s=0;s<this._height;s++)e(t,s,this._map[t][s]);return this._walls={},this._map=[],this}_digCallback(e,t,s){0===s||2===s?(this._map[e][t]=0,this._dug++):this._walls[e+","+t]=1}_isWallCallback(e,t){return!(e<0||t<0||e>=this._width||t>=this._height)&&1===this._map[e][t]}_canBeDugCallback(e,t){return!(e<1||t<1||e+1>=this._width||t+1>=this._height)&&1===this._map[e][t]}_priorityWallCallback(e,t){this._walls[e+","+t]=2}_findWall(){const e=[],t=[];for(const s in this._walls)if(this._walls.hasOwnProperty(s)){2===this._walls[s]?t.push(s):e.push(s)}const s=t.length?t:e;if(!s.length)return null;const n=o.default.getItem(s.sort());return delete this._walls[n],n}_tryFeature(e,t,s,n){const r=o.default.getWeightedValue(this._features),i=l[r].createRandomAt(e,t,s,n,this._options);return!!i.isValid(this._isWallCallback,this._canBeDugCallback)&&(i.create(this._digCallback),this._markFeatureXY(i),i instanceof a.Room&&this._addRoom(i),i instanceof a.Corridor&&(i.createPriorityWalls(this._priorityWallCallback),this._corridors.push(i)),!0)}_removeSurroundingWalls(e,t){const s=i.DIRS[4];for(let n=0;n<s.length;n++){const r=s[n];let a=e+r[0],o=t+r[1];delete this._walls[a+","+o],a=e+2*r[0],o=t+2*r[1],delete this._walls[a+","+o]}}_getDiggingDirection(e,t){if(e<=0||t<=0||e>=this._width-1||t>=this._height-1)return null;let s=null;const n=i.DIRS[4];for(let r=0;r<n.length;r++){const a=n[r],o=e+a[0],i=t+a[1];if(!this._map[o][i]){if(s)return null;s=a}}return s?[-s[0],-s[1]]:null}_addDoors(){const e=this._map;function t(t,s){return 1===e[t][s]}for(let e=0;e<this._rooms.length;e++){const s=this._rooms[e];s.clearDoors(),s.addDoors(t)}}getCrossAround(e,t,s,n=!1){const r=[];for(let n=e-s;n<=e+s;n++)for(let a=t-s;a<=t+s;a++)n!==e&&a!==t||n===e&&a===t||n>=0&&a>=0&&n<this._width&&a<this._height&&r.push([n,a]);return n&&r.push([e,t]),r}_markFeatureXY(e){const t={};e.getXY().forEach(s=>{const[n,r]=s;this.getCrossAround(n,r,1,!0).forEach(s=>{const[n,r]=s,a=n+","+r;t[a]||(t[a]=!0,this._xyToFeat[a]||(this._xyToFeat[a]=[]),this._xyToFeat[a].push(e))})})}_createEdgesForGraph(){Object.keys(this._xyToFeat).forEach(e=>{const[t,s]=e.split(","),n=this._xyToFeat[e];n.length>2?console.warn("More than 2 feats in "+JSON.stringify(n)):2===n.length&&this._ngraph.addLink(n[0],n[1],{x:t,y:s})})}}t.default=c},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Cell=void 0;const r=n(s(0)),a=s(8),{TYPE_ACTOR:o,TYPE_ITEM:i,TYPE_ELEM:l}=r.default,c=4294901760;t.Cell=class{constructor(e,t,s){this._baseElem=s,this._xy=65535&e|t<<16&c,this._state=0,this.setStateBit(1,s.lightPasses()),this.setStateBit(2,s.isPassable())}getX(){return 65535&this._xy}getY(){return(this._xy&c)>>>16}getXY(){return[65535&this._xy,(this._xy&c)>>>16]}setX(e){this._xy=65535&e}setY(e){this._xy=e<<16&c}getZ(){return this._baseElem.getZ()}getXYZ(){return[this.getX(),this.getY(),this._baseElem.getZ()]}setXY(e){this._xy=65535&e[0]|e[1]<<16&c}isAtXY(e,t){return e===this.getX()&&t===this.getY()}getKeyXY(){return this.getX()+","+this.getY()}setBaseElem(e){this._baseElem=e,this.setStateBit(1,e.lightPasses()),this.setStateBit(2,e.isPassable())}getBaseElem(){return this._baseElem}hasProp(e){return!!this._p&&this._p.hasOwnProperty(e)}getProp(e){return this._p&&this._p[e]?this._p[e]:null}hasElements(){return this.hasProp(l)}getElements(){return this.getProp(l)}hasActors(){return this.hasProp(o)}getActors(){return this.getProp(o)}getFirstActor(){const e=this.getProp(o);return e&&e.length>0?e[0]:null}getSentientActors(){const e=this.getActors();return e?e.filter(e=>!e.has("NonSentient")):[]}hasItems(){return this.hasProp(i)}getItems(){return this.getProp(i)}getMarkers(){const e=this.getElements(),t=[];if(e)for(let s=0;s<e.length;s++)"marker"===e[s].getType()&&t.push(e[s]);return t}hasMarker(e){if(this.hasElements()){const t=this.getElements();for(let s=0;s<t.length;s++)if("marker"===t[s].getType()&&t[s].getTag()===e)return!0}return!1}hasProps(){return!!this._p&&Object.keys(this._p).length>0}getProps(){let e=[];return this._p?(Object.keys(this._p).forEach(t=>{e=e.concat(this._p[t].slice())}),e):e}hasStairs(){const e=this.getConnection();if(e){const t=e.getName();return/stairs(Up|Down)/.test(t)}return!1}hasPassage(){const e=this.getConnection();return!!e&&"passage"===e.getName()}hasShop(){return this.hasPropType("shop")}getShop(){return this.getPropType("shop")[0]}hasDoor(){return this.hasPropType("door")}hasClosedDoor(){if(this.hasDoor()){return this.getPropType("door")[0].isClosed()}return!1}hasConnection(){return this.hasPropType("connection")}hasHouse(){return"floorhouse"===this._baseElem.getType()}hasConnectionType(e){if(this.hasConnection()){return this.getConnection().getName()===e}return!1}hasTown(){return this.hasConnectionType("town")}hasBattle(){return this.hasConnectionType("battle")}hasMountain(){return this.hasConnectionType("mountain")}getStairs(){return this.hasStairs()?this.getConnection():null}getConnection(){if(this.hasPropType("connection")){return this.getPropType("connection")[0]}return null}getPassage(){return this.hasPassage()?this.getConnection():null}lightPasses(){if(!this.getBit(1))return!1;if(!this._p)return!0;const e=this._p.elements;if(e)if(1===e.length){if(e[0].has("Opaque"))return!1}else for(let t=0;t<e.length;t++)if(e[t].has("Opaque"))return!1;return!0}isPassable(){return this.isFree()}isPassableByAir(e=10){return e>=this._baseElem.getZ()&&this._baseElem.isPassableByAir()}isDangerous(){if(this._p&&this._p.actors){const e=this.getProp(o);if(e)return e[0].has("Damaging")}return!1}hasObstacle(){return this._baseElem.isObstacle()}isSpellPassable(){return this._baseElem.isSpellPassable()}setExplored(){this.setStateBit(0,!0)}isExplored(){return this.getBit(0)}isFree(e=!1){if(!e&&!this.getBit(2))return!1;if(this.hasProp(o)){for(let e=0;e<this._p.actors.length;e++)if(!this._p.actors[e].has("Ethereal"))return!1;return!0}if(this.hasProp(l)){if(this.hasPropType("door")){return this.getDoor().isOpen()}if(this.hasPropType("leverdoor")){return this.getLeverDoor().isOpen()}}return!e||this._baseElem.isPassableByAir()}getDoor(){if(this.hasPropType("door")){return this.getPropType("door")[0]}return null}getLeverDoor(){if(this.hasPropType("leverdoor")){return this.getPropType("leverdoor")[0]}return null}setProp(e,t){if("connection"===t.getType()&&this.hasConnection()){let e=`${this.getX()},${this.getY()}`;e+="\nExisting: "+JSON.stringify(this.getConnection()),e+="\nTried to add: "+JSON.stringify(t),r.default.err("Cell","setProp","Tried to add 2nd connection: "+e)}this._p||(this._p={}),this._p.hasOwnProperty(e)?e===o?t.has("NonSentient")||t.has("Ethereal")?this._p[e].push(t):this._p[e].unshift(t):this._p[e].push(t):(this._p[e]=[],this._p[e].push(t)),t.isOwnable&&t.setOwner(this)}removeProps(e){delete this._p[e]}removeProp(e,t){if(this.hasProp(e)){const s=this._p[e].indexOf(t);return-1!==s&&(this._p[e].splice(s,1),0===this._p[e].length&&(delete this._p[e],0===Object.keys(this._p).length&&(this._p=void 0)),!0)}return!1}toString(){let e="Map.Cell "+this.getX()+", "+this.getY();return e+=" explored: "+this.isExplored(),e+=" passes light: "+this.lightPasses(),this._p?(Object.keys(this._p).forEach(t=>{const s=this._p[t];for(let t=0;t<s.length;t++)s[t].hasOwnProperty("toString")?e+=s[t].toString():s[t].hasOwnProperty("toJSON")&&(e+=JSON.stringify(s[t].toJSON()))}),e):e}hasUsable(){const e=this.getProp(r.default.TYPE_ELEM);if(e)for(let t=0;t<e.length;t++)if(e[t].onUse)return!0;return!1}toJSON(){const e={t:a.ELEM_MAP.elemTypeToIndex[this._baseElem.getType()]};return this.getBit(0)&&(e.ex=1),e}getPropNames(){const e=[this._baseElem.getType()];if(!this._p)return e;return Object.keys(this._p).forEach(t=>{this.getProp(t).forEach(t=>{e.push(t.getName())})}),e}hasPropType(e){if(this._baseElem.getType()===e)return!0;if(!this._p)return!1;const t=Object.keys(this._p);for(let s=0;s<t.length;s++){const n=t[s],r=this._p[n];for(let t=0;t<r.length;t++)if(r[t].getType()===e)return!0}return!1}getPropType(e){const t=[];return this._p?this._baseElem.getType()===e?[this._baseElem]:(Object.keys(this._p).forEach(s=>{const n=this._p[s];for(let s=0;s<n.length;s++)n[s].getType()===e&&t.push(n[s])}),t):t}findObj(e){const t=[];return this._p?(Object.keys(this._p).forEach(s=>{this._p[s].forEach(s=>{e(s)&&t.push(s)})}),t):t}isOutdoors(){return!this._baseElem.has("Indoor")}getBit(e){return!!(this._state&1<<e)}setStateBit(e,t){t?this._state=1<<e|this._state:this._state&=~(1<<e)}toggleBit(e){this._state^=1<<e}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.TemplateLevel=void 0;const r=n(s(0)),a=s(1),o=s(52),i=s(211);s(67);const l=s(5)("bitn:TemplateLevel"),c=i.Crypt.tiles.filler,u=a.Random.getRNG(),h=()=>{},d=r.default.VERB.MEDIUM;t.TemplateLevel=class{constructor(e,t){this.tilesX=e,this.tilesY=t,this.debugEnabled=!!l.enabled,this.genParams=[1,1,1,1],this.roomCount=40,this.callbacks={afterInit:h},this.filler=o.Template.createTemplate(c),this.templates=[],this.tryToMatchAllExits=!0,this.missingExitIsError=!1,this._ind=0,this._unusedExits=[],this._freeExits={},this._possibleDirections=["N","S","E","W"],this._sortedByExit={N:[],S:[],E:[],W:[]},this.noEdge={},this.lastPlaced=null,this._sortedWithAllExits={},this.useFillerWhenNoMatch=!0,this.rng=u}setFiller(e){"string"==typeof e?(this.filler=o.Template.createTemplate(e),this.filler.setProp("name","FILLER")):(this.filler=e.clone(),this.filler.setProp("name","FILLER"))}setTemplates(e){this.templates=[],"string"==typeof e[0]?this.templates=e.map(e=>o.Template.createTemplate(e)):this.templates=e}addTemplate(e){"string"==typeof e?this.templates.push(o.Template.createTemplate(e)):e instanceof o.Template.ElemTemplate&&this.templates.push(e)}setGenParams(e){this.genParams=e}setRoomCount(e){this.roomCount=e}setRNG(e){this.rng=e}setConstraintFunc(e){this.constraintFunc=e.bind(this)}setStartRoomFunc(e){this.startRoomFunc=e.bind(this)}addCallback(e,t){this.callbacks.hasOwnProperty(e)?"function"==typeof t?this.callbacks[e]=t:r.default.err("TemplateLevel","setCallback","Tried setting non-function as cb: "+t):r.default.err("TemplateLevel","setCallback","No callback for "+e)}use(e){["constraintFunc","startRoomFunc","roomCount","genParams"].forEach(t=>{if(e.hasOwnProperty(t)){this["set"+t.capitalize()](e[t])}}),e.tiles&&e.tiles.filler&&this.setFiller(e.tiles.filler),e.Models&&e.Models.default&&this.setTemplates(e.Models.default)}create(){0===this.templates.length&&r.default.err("TemplateLevel","create","No templates set. Use setTemplates() before create()"),this._sortDataIntoListsByLocation(),this._initMapWithFillerCells();let e=!0,t=10;for(;e;){++this._ind,this.dbg(`Dungeon not ready. Tries left  ${t}/10`),this._placeStartRoom();let s=0;const n=this.roomCount;let a=0,o=!0;for(;a<1e3&&o;){const t=this._getRoomWithUnusedExits();if(null===t){o=!1;break}const{x:i,y:l}=t;this.dbg(`BEGIN: Current room @ ${i},${l}`),++this._ind;const c=this._getFreeExits(t);this.dbg("It has free exits: "+c);const u=this.rng.arrayGetRand(c);this.dbg(`Chose exit: ${u} for next room`);const h=this.getMatchingExit(u),d=this._getNewX(i,h),f=this._getNewY(l,h);if(d===i&&f===l){let e=`Illegal ${i},${l} -> ${d},${f}`;e+=` Exits: Chosen ${u} -> ${h}`,r.default.err("TemplateLevel","create",e)}const g=this._getNextTemplate(d,f,h);if(this._isXYInBounds(d,f)&&(this._placeRoom(i,l,u,d,f,h,g),++s,this.dbg(`**** Room count is now ${s} ****`)),--this._ind,++a,-1!==n&&s>=n){e=!1;break}}if(s>=n||-1===n)e=!1;else{if(0==--t){r.default.warn("Level.Template","create","Max tries reached. No valid level created");break}this._cleanupAndTryAgain()}--this._ind}this.expandTemplates()}_sortDataIntoListsByLocation(){const e=this._possibleDirections.map(e=>new RegExp(e));this.templates.forEach(t=>{const s=t.getProp("dir");if(s){this._possibleDirections.forEach((n,r)=>{e[r].test(s)&&this._sortedByExit[n].push(t)});const n=s.split("").sort().join("");this._sortedWithAllExits[n]||(this._sortedWithAllExits[n]=[]),this._sortedWithAllExits[n].push(t)}const n=t.getProp("noedge");n&&parseInt(n,10)>0&&(this.noEdge[t.getProp("name")]=!0)})}expandTemplates(){this.genParamsX=[],this.genParamsY=[];for(let e=0;e<this.tilesX;e++)if(this.genParams.x)this.genParamsX.push(this.genParams.x);else{const e=[this.genParams[0],this.genParams[1]];this.genParamsX.push(e)}for(let e=0;e<this.tilesY;e++)if(this.genParams.y)this.genParamsY.push(this.genParams.y);else{const e=[this.genParams[2],this.genParams[3]];this.genParamsY.push(e)}this.mapExpanded=[];for(let e=0;e<this.tilesX;e++){this.mapExpanded[e]=[];for(let t=0;t<this.tilesY;t++){const s=this.genParamsX[e].concat(this.genParamsY[t]);this.mapExpanded[e][t]=this.templMap[e][t].getChars(s)}}this.map=[],this.placedTileData={};let e=0,t=0;for(let s=0;s<this.tilesX;s++){const n=this.mapExpanded[s][0].length;t=e+n-1;for(let r=0;r<n;r++){let n=0,a=0,o=[];for(let i=0;i<this.tilesY;i++){const l=this.mapExpanded[s][i][r],c=l.length;n=a+c-1,o=o.concat(l),this.placedTileData[s+","+i]={name:this.templMap[s][i].getProp("name"),type:this.templMap[s][i].getProp("type"),llx:e,urx:t,ury:a,lly:n,tileX:s,tileY:i},a+=c}this.map.push(o)}e+=n}}getPlacedData(){return this.placedTileData}getMap(){return this.map||r.default.warn("TemplateLevel","getMap","Not not generated. Call create() first"),this.map}findTemplate(e){const t=[];return Object.keys(e).forEach(s=>{this.templates.forEach(n=>{n.getProp(s)===e[s]&&t.push(n)})}),t.length>0?this.rng.arrayGetRand(t):null}removeTemplate(e){const t=Object.keys(e)[0],s=this.templates.findIndex(s=>s.getProp(t)===e[t]);s>=0&&this.templates.splice(s,1)}addRoom(e,t,s){const n={x:t,y:s,room:e};this._addRoomData(n),this._removeExitsOfAbuttingRooms(n),this._removeBorderExits(n),this.templMap[t][s]=e,this.lastPlaced=n}_getNextTemplate(e,t,s){++this._ind;let n=null;if("function"==typeof this.constraintFunc&&(n=this.constraintFunc(e,t,s)),!n&&this.tryToMatchAllExits){this.dbg(`_getNextTemplate: Compute required exits for ${e},${t}`);const s=this.getAllRequiredExits(e,t);let n=this._getMatchWithExits(s);if(n=this.filterOutNoEdge(e,t,n),this.customMatchFilter&&(n=this.customMatchFilter(this,e,t,n,this.lastPlaced)),n.length>0)return--this._ind,this._getRandTemplate(n);let a=`x,y: ${e},${t}`;if(a+=`| Required: ${s[1]}, Excl: ${s[2]}`,r.default.warn("TemplateLevel","_getNextTemplate","Not all exits match. "+a),this.missingExitIsError){this.expandTemplates(),r.default.printMap(this.map);const n=`${e},${t} exitReqd: ${JSON.stringify(s)}`;throw new Error(n)}}if(!n){let n=this._sortedByExit[s];return n=this.filterOutNoEdge(e,t,n),--this._ind,this.useFillerWhenNoMatch?(this.dbg("Returning FILLER as no match was found"),this.filler):n.length>0?this._getRandTemplate(n):this._getRandTemplate(this._sortedByExit[s])}return--this._ind,n}_getRandTemplate(e){if(!this.weights)return this.rng.arrayGetRand(e);const t={},s=e.map(e=>e.getProp("name")),n={};s.forEach((e,s)=>{n[e]=s,this.weights.hasOwnProperty(e)?t[e]=this.weights[e]:t[e]=1});const r=this.rng.getWeighted(t);return e[n[r]]}_getRoomWithUnusedExits(){return this._unusedExits.length>0?this.rng.arrayGetRand(this._unusedExits):null}_getFreeExits(e){const{x:t,y:s}=e,n=t+","+s;return this._freeExits[n]?this._freeExits[n]:(r.default.err("TemplateLevel","_getFreeExits",`No ${n}, Room: ${JSON.stringify(e)}`),null)}_removeChosenExit(e,t,s){const n=e+","+t,a=this._freeExits[n];if(this.debugEnabled&&(this.dbg(JSON.stringify(this._freeExits)),this.dbg(`${e},${t} removeChosenExit ${s}`),a?this.dbg("nExits: "+a.length):this.dbg("nExits: NONE AVAILABLE")),!a)return;const o=a.indexOf(s);if(o>=0){if(this._freeExits[n].splice(o,1),0===this._freeExits[n].length){const s=this._unusedExits.findIndex(s=>s.x===e&&s.y===t);s>=0?(this._unusedExits.splice(s,1),delete this._freeExits[n],this.dbg(`${e},${t} has no unused exits anymore.`)):r.default.err("TemplateLevel","_removeChosenExit",`Cannot find ${e},${t} in unusedExits to remove.`)}this._freeExits[n]&&this.dbg(`_freeExits [${n}] After remove: `+JSON.stringify(this._freeExits[n]))}else{const n=JSON.stringify(this.templMap[e][t]);r.default.err("TemplateLevel","_removeChosenExit",`${e},${t} dir: ${s} not found. Templ: ${n}`)}}_isXYInBounds(e,t){return e>=0&&e<this.tilesX&&t>=0&&t<this.tilesY}_placeStartRoom(){++this._ind;let e=null;if("function"==typeof this.startRoomFunc){e=this.startRoomFunc();["x","y","room"].forEach(t=>{if(!e.hasOwnProperty(t)){const e="room must have {x, y, room}.";r.default.err("TemplateLevel","_placeStartRoom",`Prop ${t} null/undef. ${e}.`)}})}else{const t=this.rng.getUniformInt(1,this.tilesX-2),s=this.rng.getUniformInt(1,this.tilesY-2),n=this.getAllRequiredExits(t,s);let r=this._getMatchWithExits(n);this.customMatchFilter?(r=this.customMatchFilter(this,t,s,r,null),e={x:t,y:s,room:this.rng.arrayGetRand(r)}):e={x:t,y:s,room:this.getRandomTemplate()}}this.dbg("Start room: "+JSON.stringify(e)),this.templMap[e.x][e.y]=e.room,null!==e?(this._addRoomData(e),this._removeBorderExits(e)):r.default.err("TemplateLevel","_placeStartRoom","Starting room was null. Oh no!"),--this._ind}_placeRoom(e,t,s,n,r,a,o){this._removeChosenExit(e,t,s);const i={x:n,y:r,room:o};this._addRoomData(i),this._removeChosenExit(n,r,a),this._removeExitsOfAbuttingRooms(i),this._removeBorderExits(i),this.templMap[n][r]=o}_addRoomData(e){const t=e.room.getProp("dir");if(t){this._unusedExits.push(e);const s=t.split(""),n=e.x+","+e.y;this._freeExits[n]=s,this.dbg("_addRoomData: Added room "+JSON.stringify(e.room.elemPropMap),20)}}getMatchingExit(e){if(this.matchMap&&this.matchMap.hasOwnProperty(e))return this.matchMap[e];switch(e){case"N":return"S";case"S":return"N";case"E":return"W";case"W":return"E";default:return"N"}}_getNewX(e,t){let s=t;return this.dir2NSEWRemap&&this.dir2NSEWRemap[t]&&(s=this.dir2NSEWRemap[t]),"E"===s?e-1:"W"===s?e+1:e}_getNewY(e,t){let s=t;return this.dir2NSEWRemap&&this.dir2NSEWRemap[t]&&(s=this.dir2NSEWRemap[t]),"N"===s?e+1:"S"===s?e-1:e}getRandomTemplate(){return this.rng.arrayGetRand(this.templates)}_removeBorderExits(e){const{x:t,y:s}=e;0===t&&(this._hasExit("W",t,s)&&this._removeChosenExit(t,s,"W"),this.nsew2DirRemap&&this._removeExitsRemapped(t,s,"W")),t===this.tilesX-1&&(this._hasExit("E",t,s)&&this._removeChosenExit(t,s,"E"),this.nsew2DirRemap&&this._removeExitsRemapped(t,s,"E")),0===s&&(this._hasExit("N",t,s)&&this._removeChosenExit(t,s,"N"),this.nsew2DirRemap&&this._removeExitsRemapped(t,s,"N")),s===this.tilesY-1&&(this._hasExit("S",t,s)&&this._removeChosenExit(t,s,"S"),this.nsew2DirRemap&&this._removeExitsRemapped(t,s,"S"))}_removeExitsRemapped(e,t,s){const n=this.nsew2DirRemap[s];this._hasExit(n,e,t)&&this._removeChosenExit(e,t,n)}_removeExitsOfAbuttingRooms(e){const{x:t,y:s}=e;if(this.dbg(`CheckAbut ${t},${s}`),t>0){const e=t-1;this._isFiller(e,s)||(this._removeExitByXY("W",t,s),this._removeExitByXY("E",e,s),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.W,t,s),this._removeExitByXY(this.nsew2DirRemap.E,e,s)))}if(t<this.tilesX-1){const e=t+1;this._isFiller(e,s)||(this._removeExitByXY("E",t,s),this._removeExitByXY("W",e,s),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.E,t,s),this._removeExitByXY(this.nsew2DirRemap.W,e,s)))}if(s>0){const e=s-1;this._isFiller(t,e)||(this._removeExitByXY("N",t,s),this._removeExitByXY("S",t,e),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.N,t,s),this._removeExitByXY(this.nsew2DirRemap.S,t,e)))}if(s<this.tilesY-1){const e=s+1;this._isFiller(t,e)||(this._removeExitByXY("S",t,s),this._removeExitByXY("N",t,e),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.S,t,s),this._removeExitByXY(this.nsew2DirRemap.N,t,e)))}}_isFiller(e,t){const s="FILLER"===this.templMap[e][t].getProp("name");return this.dbg(`isFiller x,y ${e},${t}: ${s}`,r.default.VERB.HIGH),s}_removeExitByXY(e,t,s){this._hasExit(e,t,s)&&this._removeChosenExit(t,s,e)}_hasExit(e,t,s){const n=t+","+s;return!!this._freeExits[n]&&this._freeExits[n].indexOf(e)>=0}_cleanupAndTryAgain(){this._initMapWithFillerCells(),this._freeExits={},this._unusedExits=[]}_initMapWithFillerCells(){this.templMap=[];for(let e=0;e<this.tilesX;e++){this.templMap[e]=[];for(let t=0;t<this.tilesY;t++)this.templMap[e][t]=this.filler}this.callbacks.afterInit&&this.callbacks.afterInit(this)}setExitMap(e,t){this._possibleDirections=Object.keys(e),this._sortedByExit={},this._possibleDirections.forEach(e=>{this._sortedByExit[e]=[]}),this.matchMap=e,this.nsew2DirRemap=t;const s={};Object.keys(this.nsew2DirRemap).forEach(e=>{const t=this.nsew2DirRemap[e];s[t]=e}),this.dir2NSEWRemap=s}getAllRequiredExits(e,t){++this._ind;const s=[],n=[],r=[];let a=null,o=null;const i=t-1;this.nsew2DirRemap&&(a=this.nsew2DirRemap.N,o=this.matchMap[a]),i>=0?(this._isFiller(e,i)?s.push("N"):this._hasExit("S",e,i)?n.push("N"):r.push("N"),a&&(this._isFiller(e,i)?s.push(a):this._hasExit(o,e,i)?n.push(a):r.push(a))):(r.push("N"),a&&r.push(a));const l=t+1;this.nsew2DirRemap&&(a=this.nsew2DirRemap.S,o=this.matchMap[a]),l<this.tilesY?(this._isFiller(e,l)?s.push("S"):this._hasExit("N",e,l)?n.push("S"):r.push("S"),a&&(this._isFiller(e,l)?s.push(a):this._hasExit(o,e,l)?n.push(a):r.push(a))):(r.push("S"),a&&r.push(a));const c=e+1;this.nsew2DirRemap&&(a=this.nsew2DirRemap.E,o=this.matchMap[a]),c<this.tilesX?(this._isFiller(c,t)?s.push("E"):this._hasExit("W",c,t)?n.push("E"):r.push("E"),a&&(this._isFiller(c,t)?s.push(a):this._hasExit(o,c,t)?n.push(a):r.push(a))):(r.push("E"),a&&r.push(a));const u=e-1;return this.nsew2DirRemap&&(a=this.nsew2DirRemap.W,o=this.matchMap[a]),u>=0?(this._isFiller(u,t)?s.push("W"):this._hasExit("E",u,t)?n.push("W"):r.push("W"),a&&(this._isFiller(u,t)?s.push(a):this._hasExit(o,u,t)?n.push(a):r.push(a))):(r.push("W"),a&&r.push(a)),this.dbg("getAllRequired "+n),--this._ind,[s,n,r]}_getMatchWithExits(e){const[t,s,n]=e;this.dbg(`_getMatchWithExits: GOT: any:${t}, req:${s}, excl:${n}`);let r=Object.keys(this._sortedWithAllExits);n.forEach(e=>{r=r.filter(t=>!new RegExp(e).test(t))});let a=r.map(e=>e.split(""));a=a.filter(e=>this._arrayContainsArray(e,s)),r=a.map(e=>e.join(""));let o=[];return r.forEach(e=>{o=o.concat(this._sortedWithAllExits[e])}),o}_arrayContainsArray(e,t){return t.every(t=>e.indexOf(t)>=0)}dbg(e,t=r.default.VERB.MEDIUM){if(this.debugEnabled&&d>=t){const t=" ".repeat(this._ind);console.log(t+e)}}printTile(e,t){if(4===e&&3===t){const s=this.templMap[e][t];console.log("Tile @{x},"+t),console.log("Has exits: "+s.getDir()),console.log(JSON.stringify(s,null,2))}}isEdge(e,t){return 0===e||0===t||e===this.tilesX-1||t===this.tilesY-1}isCorner(e,t){return 0===e&&0===t||0===e&&t===this.tilesY-1||e===this.tilesX-1&&0===t||e===this.tilesX-1&&t===this.tilesY-1}filterOutNoEdge(e,t,s){return e===this.tilesX-1||0===e||t===this.tilesY-1||0===t?s.filter(e=>!this.noEdge.hasOwnProperty(e.getProp("name"))):s}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Crypt=void 0;const n=s(52),r=s(1).Random.getRNG();t.Crypt={Models:{default:[]},templates:{all:[]}},t.Crypt.tiles={},t.Crypt.tiles.filler="\nname:FILLER\nX=#\nY=#\n\n#X###X#\nY######\n#######\n#######\n#######\nY######\n#######",t.Crypt.tiles.start=["\ndir:NSEW\nname:start_nsew\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n+.###.+\n#.#.#.#\nY.....#\n###+###","\ndir:SEW\nname:start_sew\nX=#\nY=#\n\n#X###X#\nY.....#\n#.#.#.#\n+.###.+\n#.#.#.#\nY.....#\n###+###","\ndir:NEW\nname:start_new\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n+.###.+\n#.#.#.#\nY.....#\n#######","\ndir:NSE\nname:start_nse\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n#..#..+\n#.#.#.#\nY.....#\n###+###","\ndir:NSW\nname:start_nsw\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n+..#..#\n#.#.#.#\nY.....#\n###+###"],t.Crypt.tiles.omni=["\ndir:NSEW\nnoedge:1\nname:omni\nX=#\nY=#\n\n#X#.#X#\nY.....#\n#.....#\n...#...\n#.....#\nY.....#\n###.###","\ndir:NSEW\nnoedge:1\nname:omni\nX=#\nY=#\n\n#X#.#X#\nY.....#\n#.#.#.#\n...#...\n#.#.#.#\nY.....#\n###.###","\ndir:NSEW\nnoedge:1\nname:omni\nX=#\nY=#\n\n#.X.X.#\nY.....#\n#..#..#\n..###..\n#..#..#\nY.....#\n###.###","\nname:omni\nnoedge:1\ndir:NSEW\nX=#\nY=#\n\n#X...X#\n.......\nY..#..#\n..###..\nY..#..#\n.......\n##...##","\nname:omni\nnoedge:1\ndir:NSEW\nX=.\nY=.\n\n..X.X..\n.##.##.\nY#...#.\n...#...\nY#...#.\n.##.##.\n.......","\nname:omni\nnoedge:1\ndir:NSEW\nX=.\nY=.\n\n#.X.X.#\n###.###\nY#...#.\n...#...\nY#...#.\n###.###\n#.....#","\nname:omni\nnoedge:1\ndir:NSEW\nX=.\nY=.\n\n..X.X..\n.##.##.\nY##.##.\n.......\nY##.##.\n.##.##.\n.......","\ndir:NSEW\nnoedge:1\nname:omni\nX=.\nY=.\n\n..X.X..\n.##.##.\nY#...#.\n.#...#.\nY#...#.\n.##.##.\n......."],t.Crypt.tiles.term=["\ndir:N\nname:term\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.#.#.#\n###.###\nY.....#\n#.....#\n#######","\ndir:N\nname:term\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.#.#.#\n###.###\nY##.###\n##...##\n#######","\ndir:S\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY.#.#.#\n###.###\nY.#.#.#\n#.....#\n##...##","\ndir:S\nname:term\nX=#\nY=#\n\n#X###X#\n#######\nY######\n###.###\nY.....#\n#.....#\n##...##","\ndir:W\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY.#.#.#\n...####\nY.#.#.#\n#.....#\n#######","\ndir:W\nname:term\nX=#\nY=#\n\n#X###X#\n#.#...#\nY.#.###\n..#...#\nY.###.#\n#.....#\n#######","\ndir:E\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY..#..#\n#..#...\nY.###.#\n#.....#\n#######","\ndir:E\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY...###\n#...#..\nY.###.#\n#.....#\n#######"],t.Crypt.tiles.corridor=["\ndir:NS\nname:corridor\nX=#\nY=#\n\n#X...X#\n##...##\nY#...##\n##...##\nY#...##\n##...##\n##...##","\ndir:NS\nname:corridor\nX=#\nY=#\n\n#X...X#\n#.....#\nY#...##\n#.....#\nY#...##\n#.....#\n##...##","\ndir:EW\nname:corridor\nX=#\nY=#\n\n#X###X#\n#######\nY......\n.......\nY......\n#######\n#######","\ndir:EW\nname:corridor\nX=#\nY=#\n\n#X###X#\n#.#.#.#\nY.....#\n.......\nY.....#\n#.#.#.#\n#######"],t.Crypt.tiles.corner=["\ndir:NW\nname:corner\nX=#\nY=#\n\n#X...X#\n###.###\nY....##\n.....##\nY....##\n#######\n#######","\ndir:NW\nname:corner\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.....#\n......#\nY.###.#\n#.....#\n#######","\ndir:NE\nname:corner\nX=.\nY=#\n\n#X...X#\n###.###\nY#...#.\n##.....\nY#...#.\n#######\n#######","\ndir:NE\nname:corner\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.###.#\n#......\nY.....#\n#.....#\n#######","\ndir:SE\nname:corner\nX=#\nY=#\n\n#X###X#\n###.###\nY#...#.\n##.....\nY#...#.\n###.###\n###.###","\ndir:SE\nname:corner\nX=#\nY=#\n\n#X###X#\n#.#.#.#\nY#...##\n#......\nY#...##\n#.#.#.#\n###.###","\ndir:SW\nname:corner\nX=#\nY=.\n\n#X###X#\n###.###\nY#...##\n......#\nY#...##\n###.###\n###.###"],t.Crypt.tiles.misc=["\ndir:SEW\nname:threeway\nX=#\nY=.\n\n#X###X#\n###.###\nY#...#.\n.......\nY#...#.\n###.###\n###.###","\ndir:SEW\nname:threeway\nX=#\nY=#\n\n#X###X#\n#.....#\nY.#.#.#\n..#.#..\nY##.###\n#.....#\n#.....#","\ndir:NEW\nname:threeway\nX=#\nY=.\n\n#X...X#\n###.###\nY#...#.\n.......\nY#...#.\n#######\n#######","\ndir:NSW\nname:threeway\nX=#\nY=#\n\n#X...X#\n###.###\nY#...##\n......#\nY#...##\n###.###\n###.###","\ndir:NSE\nname:threeway\nX=#\nY=#\n\n#X...X#\n###.###\nY#...##\n##.....\nY#...##\n###.###\n###.###"],t.Crypt.templates.start=t.Crypt.tiles.start.map(e=>n.Template.createTemplate(e)),t.Crypt.startRoomFunc=function(){const e=r.arrayGetRand(t.Crypt.templates.start);let s=r.getUniformInt(0,this.tilesX-1),n=r.getUniformInt(0,this.tilesY-1);switch(e.getProp("name")){case"start_nsew":s=Math.floor(this.tilesX/2),n=Math.floor(this.tilesY/2);break;case"start_sew":n=0,0===s&&(s+=1),s===this.tilesX-1&&(s-=1);break;case"start_new":n=this.tilesY-1,0===s&&(s+=1),s===this.tilesX-1&&(s-=1);break;case"start_nse":s=0,0===n&&(n+=1),n===this.tilesY-1&&(n-=1);break;case"start_nsw":s=this.tilesX-1,0===n&&(n+=1),n===this.tilesY-1&&(n-=1)}return{x:s,y:n,room:e}},t.Crypt.Models.default=[].concat(t.Crypt.tiles.corner).concat(t.Crypt.tiles.corridor).concat(t.Crypt.tiles.omni).concat(t.Crypt.tiles.term).concat(t.Crypt.tiles.misc),t.Crypt.templates.all=t.Crypt.Models.default.map(e=>n.Template.createTemplate(e));const a=n.Template.transformList(t.Crypt.templates.all);t.Crypt.templates.all=t.Crypt.templates.all.concat(a)},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HouseGenerator=t.House=void 0;const r=n(s(0)),a=s(210),o=s(459),i=s(1),l=s(4),c=s(18),u=i.Random.getRNG();class h{constructor(e){this.coord={},this.map=r.default.copy2D(e),this.trimEmpty(),this.x=0,this.y=0,this.w=e.length,this.h=e[0].length;let t=0,s=0;r.default.forEach2D(e,(e,n,r)=>{this.coord[r]||(this.coord[r]=[]),this.coord[r].push([e,n]),":"===r?(t+=e,s+=n):"+"===r&&(this.door=[e,n])}),this.floor=this.coord[":"],this.walls=this.coord["#"];const n=Object.values(this.coord[":"]).length;this.cX=Math.round(t/n),this.cY=Math.round(s/n),this.numFloor=n}getCenter(){return[this.cX,this.cY]}isFloor(e){const[t,s]=e;return this.floor.findIndex(e=>e[0]===t&&e[1]===s)>=0}getFloorCenter(){let e=this.getCenter();if(this.isFloor(e))return e;const[t,s]=e;return l.Geometry.getBoxAround(t,s,1).forEach(t=>{this.isFloor(t)&&(e=t)}),e||r.default.err("House","getFloorCenter","No floor centerpoint found"),e}getBbox(){return c.BBox.fromBBox({ulx:this.x,uly:this.y,lrx:this.x+this.w-1,lry:this.y+this.h-1})}trimEmpty(){}adjustCoord(e,t){const s=e-this.x,n=t-this.y;this.moveHouse(s,n)}moveHouse(e,t){this.x+=e,this.y+=t,Object.keys(this.coord).forEach(s=>{this.coord[s].forEach(s=>{s[0]+=e,s[1]+=t})}),this.cX+=e,this.cY+=t,this.door=[this.door[0]+e,this.door[1]+t]}addWindows(e){this.coord.windows=[];const t=this.coord["#"].slice();let s=0;u.shuffle(t);const n={};t.forEach(e=>{n[e[0]+","+e[1]]=!0}),this.coord["+"].forEach(e=>{n[e[0]+","+e[1]]=!1});for(let r=0;r<t.length&&s!==e;r++){const a=t[r],o=[];l.Geometry.getBoxAround(a[0],a[1],1).forEach(e=>{n[e[0]+","+e[1]]&&o.push(e)}),2===o.length&&(s<e||-1===e)&&this.windowPosOk(a,o)&&(this.coord.windows.push(a),n[a[0]+","+a[1]]=!1,++s)}return this.coord.windows.forEach(e=>{const t=this.walls.findIndex(t=>t[0]===e[0]&&t[1]===e[1]);this.walls.splice(t,1)}),s}windowPosOk(e,t){const[s,n]=e,[r,a]=t[0],[o,i]=t[1];return s===r?2===Math.abs(a-i):n===a&&2===Math.abs(r-o)}}t.House=h;t.HouseGenerator=class{constructor(){this.baseSizeX=3,this.baseSizeY=3}createHouse(e){const{cols:t,rows:s}=e,{fullHouse:n}=e,r=this.getGenParams(t,s),{genParamsX:i,genParamsY:l}=r;let{tilesX:c,tilesY:d}=r;if(!Number.isInteger(c)||!Number.isInteger(d)){if(!(c>1))return null;if(c=Math.floor(c),!(d>1))return null;d=Math.floor(d)}const f=new a.TemplateLevel(c,d);f.setFiller(o.Houses5x5.tiles.filler),f.setTemplates(o.Houses5x5.templates.all),f.setGenParams({x:i,y:l}),f.roomCount=-1,n&&(f.roomCount=c*d,f.roomCount-=1),f.setStartRoomFunc(o.Houses5x5.startRoomFunc),f.create();const g=new h(f.map);if(e.addWindows){const e=c*d;g.addWindows(u.getUniformInt(1,e))}return g}getGenParams(e,t){const s=this.baseSizeX,n=this.baseSizeY;let a=u.getUniformInt(1,3),o=u.getUniformInt(1,3),i=s+a+o,l=r.default.WATCHDOG;for(;e%i!=0&&(a=u.getUniformInt(1,3),o=u.getUniformInt(1,3),i=s+a+o,0!=--l););const c=e/i,h=[a,1,o];let d=u.getUniformInt(1,3),f=u.getUniformInt(1,3),g=n+d+f,p=r.default.WATCHDOG;for(;t%g!=0&&(d=u.getUniformInt(1,3),f=u.getUniformInt(1,3),g=n+d+f,0!=--p););return{tilesX:c,tilesY:t/g,genParamsX:h,genParamsY:[d,1,f]}}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Vault=void 0;const r=n(s(0)),a=s(52);t.Vault={},t.Vault.tiles={},t.Vault.tiles.vault=["\nname:vault_small_s\nX=#\nY=#\n\n#X###X#\n#..?..#\nY.....#\n#.....#\n#.....#\nY.....#\n###.###","\nname:vault_small_n\nX=#\nY=#\n\n#X#.#X#\nY.....#\n#.....#\n#.....#\nY.....#\n#..?..#\n#######","\nname:vault_small_e\nX=#\nY=#\n\n##X##X#\nY.....#\n#.....#\n#?.....\n#.....#\nY.....#\n#######","\nname:vault_small_w\nX=#\nY=#\n\n#X##X##\nY.....#\n#.....#\n.....?#\n#.....#\nY.....#\n#######","\nname:vault_medium_s\nX=#\nY=#\n\n#X...X#\nY.....#\n#.....#\n#.....#\n#.....#\nY.....#\n###.###","\nname:vault_medium_n\nX=#\nY=#\n\n#X###X#\n#..?..#\nY.....#\n#.....#\n#.....#\nY..#..#\n##...##"],t.Vault.tiles.corner=["\nname:vault_nw_corner\nX=#\nY=#\n\n#X###X#\nY......\n#......\n#......\n#......\nY......\n#......","\nname:vault_ne_corner\nX=#\nY=.\n\n#X###X#\nY.....#\n......#\n......#\n......#\nY.....#\n......#","\nname:vault_sw_corner\nX=.\nY=#\n\n#X...X.\nY......\n#......\n#......\n#......\nY......\n###.###","\nname:vault_se_corner\nX=.\nY=.\n\n.X...X#\nY.....#\n......#\n......#\n......#\nY.....#\n#######"],t.Vault.tiles.wall=["\nname:vault_n_wall\nX=#\nY=.\n\n#X###X#\nY......\n.......\n.......\n.......\nY......\n.......","\nname:vault_e_wall\nX=.\nY=.\n\n.X...X#\nY.....#\n......#\n......#\n......#\nY.....#\n......#","\nname:vault_w_wall\nX=.\nY=#\n\n#X...X.\nY......\n#......\n#......\n#......\nY......\n#......","\nname:vault_s_wall\nX=.\nY=.\n\n.X...X.\nY......\n.......\n.......\n.......\nY......\n##...##"],t.Vault.tiles.center=["\nname:vault_center1\nX=.\nY=.\n\n.X...X.\nY......\n.......\n.......\n.......\nY......\n.......","\nname:vault_center2\nX=.\nY=.\n\n.X...X.\nY..#...\n...#...\n.#####.\n...#...\nY..#...\n.......","\nname:vault_center3\nX=#\nY=#\n\n.X...X.\nY..#..#\n...#...\n.#####.\n...#...\nY..#..#\n.#...#."],t.Vault.func={},t.Vault.func.createMediumVault=(e,t,s,n)=>{const r=s.findTemplate({name:"vault_medium_n"}),a=s.findTemplate({name:"vault_medium_s"});s.addRoom(r,e,t),s.addRoom(a,e,t+1),n&&s.addRoom(n,e,t+2)},t.Vault.func.createLargeVault=(e,t,s,n)=>{const r=s.findTemplate({name:"vault_nw_corner"}),a=s.findTemplate({name:"vault_ne_corner"}),o=s.findTemplate({name:"vault_sw_corner"}),i=s.findTemplate({name:"vault_se_corner"});s.addRoom(r,e,t),s.addRoom(a,e+1,t),s.addRoom(o,e,t+1),s.addRoom(i,e+1,t+1),n&&s.addRoom(n,e,t+2)},t.Vault.func.createHugeVault=(e,t,s,n,a)=>{const o=s.findTemplate({name:"vault_nw_corner"}),i=s.findTemplate({name:"vault_ne_corner"}),l=s.findTemplate({name:"vault_sw_corner"}),c=s.findTemplate({name:"vault_se_corner"});r.default.isNullOrUndef([o,i,l,c])&&r.default.err("Vault.func","createHugeVault","Corner templates cannot be null. Check they are loaded"),s.addRoom(o,e,t),s.addRoom(i,e+2,t),s.addRoom(l,e,t+2),s.addRoom(c,e+2,t+2);const u=s.findTemplate({name:n});s.addRoom(u,e+1,t+1);const h=s.findTemplate({name:"vault_n_wall"}),d=s.findTemplate({name:"vault_e_wall"}),f=s.findTemplate({name:"vault_w_wall"}),g=s.findTemplate({name:"vault_s_wall"});if(s.addRoom(h,e+1,t),s.addRoom(d,e+2,t+1),s.addRoom(f,e,t+1),s.addRoom(g,e+1,t+2),a){let n=a;"string"==typeof a&&(n=s.findTemplate({name:a})),s.addRoom(n,e+1,t+3)}},t.Vault.Models={},t.Vault.Models.default=[].concat(t.Vault.tiles.center).concat(t.Vault.tiles.corner).concat(t.Vault.tiles.wall).concat(t.Vault.tiles.vault),t.Vault.templates={},t.Vault.templates.all=t.Vault.Models.default.map(e=>a.Template.createTemplate(e));const o=a.Template.transformList(t.Vault.templates.all);t.Vault.templates.all=t.Vault.templates.all.concat(o)},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BSPGen=t.Room=t.Container=t.Point=t.Tree=t.BSP=void 0;const n=s(1).Random.getRNG();t.BSP={};const r={discardByRatio:!0,hRatio:.35,wRatio:.35,vertSplit:.5,minSplitW:8,minSplitH:8,discardBySize:!0,minRoomW:3,minRoomH:2};class a{constructor(e){this.leaf=e,this.lchild=null,this.rchild=null}getLeafs(){return null===this.lchild&&null===this.rchild?[this.leaf]:[].concat(this.lchild.getLeafs(),this.rchild.getLeafs())}getLevel(e,t){return t||(t=[]),1===e?t.push(this):(null!==this.lchild&&this.lchild.getLevel(e-1,t),null!==this.rchild&&this.rchild.getLevel(e-1,t)),t}}t.Tree=a,t.BSP.Tree=a;class o{constructor(e,t){this.x=e,this.y=t}}t.Point=o;class i{constructor(e,t,s,n){this.x=e,this.y=t,this.w=s,this.h=n,this.center=new o(this.x+Math.floor(this.w/2),this.y+Math.floor(this.h/2))}}t.Container=i,t.BSP.Container=i;class l{constructor(e){return this.x=e.x+l.rng.getUniformInt(1,Math.floor(e.w/3)),this.y=e.y+l.rng.getUniformInt(1,Math.floor(e.h/3)),this.w=e.w-(this.x-e.x)-1,this.h=e.h-(this.y-e.y)-1,this.w-=l.rng.getUniformInt(0,this.w/3),this.h-=l.rng.getUniformInt(0,this.h/3),this.w<r.minRoomW&&(this.w=r.minRoomW),this.h<r.minRoomH&&(this.h=r.minRoomH),this}getCoord(){const e=[],t=this.x,s=t+(this.w-1),n=this.y,r=n+(this.h-1);for(let a=t;a<=s;a++)for(let t=n;t<=r;t++)e.push([a,t]);return e}getOuterBorder(){const[e,t]=[this.x-1,this.y-1],[s,n]=[this.x+this.w+1,this.y+this.h+1];return c(e,t,s,n)}getInnerBorder(){const[e,t]=[this.x,this.y],[s,n]=[this.x+this.w-1,this.y+this.h-1];return c(e,t,s,n)}}function c(e,t,s,n){const r=[];for(let a=e;a<=s;a++)for(let o=t;o<=n;o++)o!==t&&o!==n&&a!==e&&a!==s||r.push([a,o]);return r}t.Room=l,l.rng=n,t.BSP.Room=l;class u{constructor(e={}){this._opts=r,Object.keys(e).forEach(t=>{this._opts.hasOwnProperty(t)&&(this._opts[t]=e)}),this.rng=this._opts.rng||n}createPath(e,t){const s=[],n=e.center,r=t.center;if(n.x===r.x){const e=n.y>r.y?r.y:n.y,t=n.y<r.y?r.y:n.y;for(let r=e;r<=t;r++)s.push([n.x,r])}else{const e=n.x>r.x?r.x:n.x,t=n.x<r.x?r.x:n.x;for(let r=e;r<=t;r++)s.push([r,n.y])}return s}splitContainer(e,t){const s=new a(e);if(this.isLargeEnough(e)&&0!==t){const n=this.randomSplit(e);s.lchild=this.splitContainer(n[0],t-1),s.rchild=this.splitContainer(n[1],t-1)}return s}isLargeEnough(e){return!this._opts.discardBySize||e.w>=this._opts.minSplitW&&e.h>=this._opts.minSplitH}randomSplit(e){let t,s;if(this.rng.getUniform()<=this._opts.vertSplit){if(t=new i(e.x,e.y,this.rng.getUniformInt(1,e.w),e.h),s=new i(e.x+t.w,e.y,e.w-t.w,e.h),this._opts.discardByRatio&&this.isVRatioTooSmall(t,s))return this.randomSplit(e)}else if(t=new i(e.x,e.y,e.w,this.rng.getUniformInt(1,e.h)),s=new i(e.x,e.y+t.h,e.w,e.h-t.h),this._opts.discardByRatio&&this.isHRatioTooSmall(t,s))return this.randomSplit(e);return[t,s]}isVRatioTooSmall(e,t){const s=e.w/e.h,n=t.w/t.h;return s<this._opts.wRatio||n<this._opts.wRatio}isHRatioTooSmall(e,t){const s=e.h/e.w,n=t.h/t.w;return s<this._opts.hRatio||n<this._opts.hRatio}createWithRooms(e,t,s=5){const n=new i(0,0,e,t),r=this.splitContainer(n,s),a=r.getLeafs(),o=[];return a.forEach(e=>{o.push(new l(e))}),this.generated={tree:r,rooms:o},[r,o]}createWithRoomsAndPaths(e,t,s=5){const n=new i(0,0,e,t),r=this.splitContainer(n,s),a=r.getLeafs(),o=[];a.forEach(e=>{o.push(new l(e))});const c=[];return this.createPaths(r,c),this.generated={tree:r,rooms:o,paths:c},[r,o,c]}createPaths(e,t){if(null===e.lchild||null===e.rchild)return[];const s=this.createPath(e.lchild.leaf,e.rchild.leaf);return s.length>0&&t.push(s),this.createPaths(e.lchild,t),this.createPaths(e.rchild,t),t}get(e){return this.generated.hasOwnProperty(e)?this.generated[e]:null}}t.BSPGen=u,t.BSP.BSPGen=u},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(465)),a=n(s(14)),o=s(466),i=.5*(Math.sqrt(3)-1),l=(3-Math.sqrt(3))/6;class c extends r.default{constructor(e=256){super(),this._gradients=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];let t=[];for(let s=0;s<e;s++)t.push(s);t=a.default.shuffle(t),this._perms=[],this._indexes=[];for(let s=0;s<2*e;s++)this._perms.push(t[s%e]),this._indexes.push(this._perms[s]%this._gradients.length)}get(e,t){const s=this._perms,n=this._indexes,r=s.length/2;let a,c=0,u=0,h=0;const d=(e+t)*i,f=Math.floor(e+d),g=Math.floor(t+d),p=(f+g)*l,m=e-(f-p),y=t-(g-p);let _,b;m>y?(_=1,b=0):(_=0,b=1);const v=m-_+l,E=y-b+l,S=m-1+2*l,w=y-1+2*l,C=o.mod(f,r),T=o.mod(g,r);let O=.5-m*m-y*y;if(O>=0){O*=O,a=n[C+s[T]];const e=this._gradients[a];c=O*O*(e[0]*m+e[1]*y)}let A=.5-v*v-E*E;if(A>=0){A*=A,a=n[C+_+s[T+b]];const e=this._gradients[a];u=A*A*(e[0]*v+e[1]*E)}let M=.5-S*S-w*w;if(M>=0){M*=M,a=n[C+1+s[T+1]];const e=this._gradients[a];h=M*M*(e[0]*S+e[1]*w)}return 70*(c+u+h)}}t.default=c},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ActorMods=void 0,t.ActorMods={},t.ActorMods.bearfolk={description:"",stats:{magic:-2,agility:-3,strength:5},player:{startingItems:[],equipment:[{name:"Chain boots",count:1}]}},t.ActorMods.catfolk={stats:{agility:6,perception:4,strength:-3},player:{startingItems:[],equipment:[]}},t.ActorMods.dogfolk={stats:{agility:4,perception:5},player:{Spellsinger:{startingItems:[{func:e=>"rune"===e.type,count:1}]},startingItems:[],equipment:[]}},t.ActorMods.dwarf={stats:{agility:-2,strength:3,willpower:3},player:{Adventurer:{},Blademaster:{equipment:[{name:"Battle axe",count:1}]},startingItems:[],equipment:[]}},t.ActorMods.goblin={stats:{magic:-3,accuracy:3,agility:4,spirituality:-3},player:{startingItems:[{name:"Rock",count:5}],equipment:[{name:"Rock",count:3}]}},t.ActorMods.human={stats:{accuracy:6,magic:2,willpower:2,spirituality:2},player:{startingItems:[],equipment:[]}},t.ActorMods.hyrkhian={stats:{magic:5,willpower:5,spirituality:3},player:{Cryomancer:{startingItems:[{name:"Potion of power",count:"1d2"}]},startingItems:[{name:"Lesser spirit gem",count:1}],equipment:[]}},t.ActorMods.wildling={stats:{accuracy:2,agility:2,perception:6},player:{startingItems:[],equipment:[]}},t.ActorMods.wolfclan={stats:{strength:3,magic:4,willpower:4},player:{startingItems:[],equipment:[]}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Quest=t.Task=void 0;const r=n(s(0));class a{constructor(e){this.stepType="Task",this.name="",this.taskType=e}isTask(){return!0}isQuest(){return!1}getName(){return this.name}getTaskType(){return this.taskType}}t.Task=a;t.Quest=class{constructor(e,t){e&&"string"!=typeof e&&r.default.err("Quest","new","Quest must have a name!"),this.name=e,this.steps=[],this.stepType="Quest",this.motive="",this.terms=[],Array.isArray(t)&&t.forEach(e=>{if(e.isQuest)this.addStep(e);else if(e.isTask)this.addStep(e);else{const t=new a(e);this.addStep(t)}})}setName(e){this.name=e}getName(){return this.name}setMotive(e){this.motive=e}getMotive(){return this.motive}isTask(){return!1}isQuest(){return!0}addTerm(e){this.terms.push(e)}getTasks(){return this.steps.filter(e=>e.isTask())}addStep(e){Array.isArray(e)?this.steps=this.steps.concat(e):this.steps.push(e)}numQuests(){let e=1;return this.steps.forEach(t=>{t.isQuest&&t.isQuest()&&(e+=1)}),e}numTasks(){const e=this.numQuests()-1;return this.steps.length-e}getSteps(){return this.steps.slice()}numSteps(){return this.steps.length}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.QuestData=void 0;const r=n(s(0)),a=s(107);class o{constructor(){this._stacks={},this.path=[],this._ptr={}}addTarget(e,t){if(!r.default.isEntity(t)&&!t.createTarget){const e=JSON.stringify(t);r.default.err("QuestData","addTarget","Only entities can be added. Got: "+e)}if(o.mapStepToType[e])this._stacks[e]||(this._stacks[e]=[]),this._stacks[e].push(t),this.path.push({type:e,target:t});else{const t=JSON.stringify(o.mapStepToType);r.default.err("QuestData","add",`Step type ${e} not supported. See:\n${t}`)}}replaceTarget(e,t,s){const n=this._stacks[e];let a=n.indexOf(t);if(a>=0){if(n.splice(a,1,s),a=this.path.findIndex(e=>e.target===t),a>=0){const e={target:s,type:this.path[a].type};this.path.splice(a,1,e)}else r.default.err("QuestData","replaceTarget","Could not replace target on path");return!0}return!1}numSteps(){return this.path.length}keys(){return Object.keys(this._stacks)}getPathTypes(){return this.path.map(e=>e.type)}getPathTargets(){return this.path.map(e=>e.target)}pop(e){if(this._stacks[e]){const t=this._stacks[e].pop();if(t)return t}return null}resetIter(){this.keys().forEach(e=>{this._ptr[e]=0})}next(e){if(this._stacks[e]){this._ptr.hasOwnProperty(e)||(this._ptr[e]=0);const t=this._ptr[e];if(t<this._stacks[e].length)return++this._ptr[e],this._stacks[e][t]}return null}getCurrent(e){if(this._stacks[e]){const t=this._stacks[e];return t[t.length-1]}return null}getCurrentLocation(){const e=this.getCurrent("location");if(e)return e;r.default.err("QuestGen","getCurrentLocation","No location found")}getDescr(){let e="";return this.path.forEach(t=>{const s=t.type,n=t.target,o=r.default.getName(n);e+=a.getQuestVerb(s)+" "+o+". "}),e}toJSON(){const e=[];return this.path.forEach(t=>{const s=o.mapStepToType[t.type];if(s)if(t.target.getID){const n={type:t.type,target:r.default.getObjRef(s,t.target)};e.push(n)}else{const s={type:t.type,target:t.target};e.push(s)}else console.error("Used step is",t),r.default.err("QuestData","toJSON","No refType for step type "+t.type)}),e.$objRefArray=!0,{createFunc:"createQuestData",value:{path:e}}}}t.QuestData=o,o.mapStepToType={capture:"entity",escort:"entity",exchange:"item",experiment:"item",explore:"element",damage:"entity",defend:"entity",get:"item",give:"entity",kill:"entity",listen:"entity",location:"place",finishbattle:"place",read:"item",repair:"element",report:"entity",reportListen:"entity",rescue:"entity",spy:"entity",steal:"item",take:"item",subquest:"entity",use:"item",winbattle:"place"}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QuestGen=void 0;const n=s(5)("bitn:quest-gen"),r=s(1),a=s(477),o=s(217),i=s(478).QuestGrammar.grammar,l=r.Random.getRNG();function c(e,t){return t[e]}class u{constructor(e){this._init(),this.rng=e||l}static parse(e){const t=a.parse(e),s={};return t.productions.forEach(e=>{s[e.lhs.text]=e.rhs.map(c.bind(null,"terms"))}),s}_init(){this.stack=[],this.currQuest=null,this.ruleHist={},this.startRule="QUEST"}genQuestWithMotive(e={}){const{motive:t}=e,s=e.rules||u.rules,[n]=this.chooseRandomRule(s[t]),r=n.text;console.log("questType is",r);const a=Object.assign({},e);a.rules=s,a.startRule=r;const o=this.genQuestWithConf({startRule:r,rules:s});return o.setName(r),o.setMotive(t),o}genQuestWithConf(e={}){e.debug&&(n.enabled=!0);const t=e.rules||u.rules,s=e.startRule||"QUEST";let r=!1,a=e.maxTries||20,o=[];for(;!r;)if(this._init(),this.startRule=s,n("=== Generating new quest now ==="),o=this.generateQuest(t,s).split("|"),r=this._questMeetsReqs(o,e),r||n("QUEST DISCARDED"),0==--a){console.warn("Could not find a matching quest.");break}return this.currQuest}genQuestWithName(e){const t=new o.Quest(e),s=new o.Task("<goto>already_there");t.addStep(s);const n=new o.Task("<kill>kill");return t.addStep(n),t}_questMeetsReqs(e,t){let s=!0;const r=t.minLength||1,a=t.maxLength||-1;return(e.length<=a||-1===a)&&e.length>=r?(s=!0,n("MATCHING QUEST FOUND")):s=!1,t.minQuests&&(s=s&&this.currQuest.numQuests()>=t.minQuests),t.maxQuests&&(s=s&&this.currQuest.numQuests()<=t.maxQuests),s}generateQuest(e,t){if(this.ruleHist[t]?this.ruleHist[t]+=1:this.ruleHist[t]=1,n(`generateQuest with rule |${t}|`),t===this.startRule||"QUEST"===t){n("New (sub)-quest will be generated");const e="";this.currQuest=new o.Quest(e),this.stack.push(this.currQuest)}n(`Choosing randRule ${t} from ${JSON.stringify(e[t])}`);const s=this.chooseRandomRule(e[t]);if(Array.isArray(s)){const n=s.map(this.generateTerm.bind(this,e));return this._checkIfQuestOver(t),n.join("|")}return n(`generateQuest end reached, return |${s}|`),this._checkIfQuestOver(t),s}generateTerm(e,t){if(!t.text){const t=JSON.stringify(e);throw new Error(`Null/undef term.text with rules| ${t}|`)}return"terminal"===t.type?this.currQuest.addTerm(t.text):this.currQuest.addTerm("<<"+t.text+">>"),"terminal"===t.type?(this.currQuest.addStep(new o.Task(t.text)),t.text):(n(`genTerm: term.type ${t.type} text: ${t.text}`),n(`calling generate() with term.text |${t.text}|`),this.generateQuest(e,t.text))}_checkIfQuestOver(e){if(e===this.startRule||"QUEST"===e){n("Finishing current quest");if(this.stack.length>1){const e=this.stack.pop();this.currQuest=this.stack[this.stack.length-1],this.currQuest.addStep(e)}}}chooseRandomRule(e){if(Array.isArray(e)){const t=this.rng.arrayGetRand(e);return n("chose next rule at RANDOM:",t),t}return n("chooseRandomRule() not an ARRAY: |"+e),null}}t.QuestGen=u,u.rules=u.parse(i),u.defaultConfig={rules:u.rules,startRule:"QUEST",maxTries:20,debug:!1,minQuests:1,maxQuests:-1,minLength:1,maxLength:-1}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryZone=void 0;const i=o(s(0)),l=s(5)("bitn:FactoryZone"),c=a(s(27)),u=s(64),h=s(45),d=s(19),f=s(21),g=s(1),p=s(6),m=a(s(7)),y=g.Random.getRNG();t.FactoryZone=class{constructor(){this._verif=new c.Conf("FactoryZone"),this._parser=p.ObjectShell.getParser(),this._levelFact=new d.FactoryLevel,this._factBase=new u.FactoryBase,this.rng=y}getRandLevelType(){const e=["uniform","rooms","rogue","digger"];return e[this.rng.randIndex(e)]}setRNG(e){this.rng=e}addItemsAndActors(e,t){this._verif.verifyConf("addItemsAndActors",t,["nLevel","sqrPerItem","sqrPerActor","maxValue"]);const s=e.getMap().getFree().length,n=Math.round(s/t.sqrPerActor),r=Math.round(s/t.sqrPerItem),a=r;l(`Adding ${n} monsters and items `+r+" to the level");const o=(e,t)=>s=>s.value>=e&&s.value<=t,c={nLevel:t.nLevel,itemsPerLevel:r,item:o(0,t.maxValue),maxValue:t.maxValue,food:!0,gold:!0};t.hasOwnProperty("food")&&(c.food=t.food),t.hasOwnProperty("gold")&&(c.gold=t.gold),t.item?(c.item=t.item,l("Set itemConf.func to "+t.item.toString())):t.minValue&&(c.item=o(t.minValue,t.maxValue)),this._factBase.addNRandItems(e,this._parser,c);const u={actorsPerLevel:t.actorsPerLevel||n,maxDanger:t.maxDanger||t.nLevel+1};if(t.actor&&("function"==typeof t.actor?u.actor=t.actor:i.default.err("FactoryZone","addItemsAndActors","conf.actor must be a function")),this._factBase.addNRandActors(e,this._parser,u),c.gold){const s={goldPerLevel:a,nLevel:t.nLevel+1,maxValue:c.maxValue,item:()=>!0};this._factBase.addRandomGold(e,this._parser,s)}}createDungeonLevel(e){this._verif.verifyConf("createDungeonLevel",e,["x","y"]);let t=null,s=this.getRandLevelType();return e.dungeonType&&""!==e.dungeonType&&(s=e.dungeonType),l(`dungeonLevel: ${s}, ${JSON.stringify(e)}`),t=this._levelFact.createLevel(s,e.x,e.y,e),this.addItemsAndActors(t,e),this.addExtraDungeonFeatures(t,e),t}createMountainLevel(e){let t=Object.assign(f.MountainGenerator.getFaceOptions(),{maxValue:100,sqrPerActor:50,sqrPerItem:200,nLevel:4});t=Object.assign(t,e),l("Creating mountain level with "+e);const s=(new f.MountainGenerator).createFace(e.x,e.y,t);return this.addItemsAndActors(s,t),s}createSummitLevel(e){this._verif.verifyConf("createSummitLevel",e,["cols","rows"]);let t={maxValue:100,sqrPerActor:20,sqrPerItem:200,nLevel:4,maxDanger:3};t=Object.assign(t,e);const s=(new f.MountainGenerator).createSummit(e.cols,e.rows,t);return l("Creating summit level with "+e),this.addItemsAndActors(s,t),e.maxValue||(e.maxValue=t.maxValue),s}createCityLevel(e,t){const s=u.Factory.cityConfBase(t);s.parser=this._parser;let n=null;const{x:r,y:a}=t;if(s.groupType)switch(s.groupType){case"village":n=this.createVillageLevel(r,a,s);break;case"capital":n=this.createCapitalLevel(e,r,a,s);break;case"stronghold":n=this.createStrongholdLevel(r,a,s);break;case"fort":n=this.createFortLevel(r,a,s)}if(null===n&&(n=this._levelFact.createLevel("town",r,a,s),this.populateCityLevel(n,s)),t.friendly){n.getActors().forEach(e=>{e.has("NonSentient")||e.getBrain().getMemory().removeEnemyType("player")})}if(t.disposition){const{disposition:e}=t;n.getActors().forEach(t=>{Object.keys(e).forEach(s=>{"enemy"===e[s]&&t.getBrain().getMemory().addEnemyType(s)})})}return n}createVillageLevel(e,t,s){s.levelType="empty",s.wallType="wooden",s.actorsPerLevel||(s.actorsPerLevel=30),s.maxDanger||(s.maxDanger=3),s.itemsPerLevel||(s.itemsPerLevel=2*s.maxDanger);const n=(new f.CityGenerator).create(e,t,s);return this.populateCityLevel(n,s),this.addItemsToCityLevel(n,s),n}createFortLevel(e,t,s){const n=new f.CastleGenerator;s.roomCount=-1,s.maxDanger||(s.maxDanger=6);const r=n.create(100,84,s);return this.populateCityLevel(r,s),r}createCapitalLevel(e,t,s,n){n.levelType="miner";let r=null;return 0===e?(n.levelType="townwithwall",r=this._levelFact.createLevel("townwithwall",200,84,n)):r=this._levelFact.createLevel("town",100,84,n),this.populateCityLevel(r,n),r}createStrongholdLevel(e,t,s){s.levelType="miner";const n=this._levelFact.createLevel("town",100,84,s);return this.populateCityLevel(n,s),n}populateCityLevel(e,t){let s=t.alignment;s||(s=this.rng.arrayGetRand(i.default.ALIGNMENTS)),t.actor?this.populateWithActors(e,t):s===i.default.ALIGN_GOOD?this.populateWithHumans(e,t):s===i.default.ALIGN_EVIL?this.populateWithEvil(e,t):this.populateWithNeutral(e,t)}addItemsToCityLevel(e,t){const s=e.getMap().getCells(e=>"floorhouse"===e.getBaseElem().getType()),n=new h.FactoryItem,r=p.ObjectShell.getParser(),a={item:e=>e.value<=10*t.maxDanger,maxValue:50*t.maxDanger};i.default.isNullOrUndef([t.itemsPerLevel])||(a.itemsPerLevel=t.itemsPerLevel),n.addItemsToCells(e,r,s,a)}populateWithActors(e,t){const s={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,actor:t.actor};if(0===this._factBase.addNRandActors(e,this._parser,s)){const t=e.getParent();let n="No actors added to level.";n+="\nUsed conf was "+JSON.stringify(s),t&&(n+="\nLevel parent: "+t.getName()),i.default.err("FactoryZone","populateWithActors",n)}}populateWithHumans(e,t){const s={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,actor:e=>"human"===e.type&&"shopkeeper"!==e.name};t.actor&&(s.actor=t.actor),this._factBase.addNRandActors(e,this._parser,s)}populateWithEvil(e,t){let s=!1;for(;!s;){const n=this.rng.arrayGetRand(i.default.EVIL_RACES),r={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,actor:e=>e.type===n};t.actor&&(r.actor=t.actor);this._factBase.addNRandActors(e,this._parser,r)>0&&(s=!0)}}populateWithNeutral(e,t){const s=this.rng.arrayGetRand(i.default.NEUTRAL_RACES),n={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,actor:e=>e.type===s};t.actor&&(n.actor=t.actor),this._factBase.addNRandActors(e,this._parser,n)}addActorToLevel(e,t){const s=this._parser.createActor(e),n=t.getFreeRandCell();t.addActor(s,n.getX(),n.getY())}addExtraDungeonFeatures(e,t){const s=e.getExtras();if(s.rooms){s.rooms.forEach(t=>{t.getDoors((t,s)=>{e.addElement(new m.ElementDoor(!0),t,s)})});const n=this.rng.arrayGetRand(s.rooms).getBbox();(new u.FactoryBase).addActorsToBbox(e,n,t)}}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfStack=void 0;const r=n(s(0)),a=s(5)("bitn:ConfStack");t.ConfStack=class{constructor(){this.globalConf={levelSize:"Medium",dungeonX:80,dungeonY:40,sqrPerActor:200,sqrPerItem:200,set:!1},this.scope=[],this.confStack=[]}setGlobalConf(e){this.globalConf=e}getGlobalConf(){return this.globalConf}getScope(){return this.scope}pushScope(e){this.scope.push(e.name),this.confStack.push(e),this.dbg("Pushed scope: "+e.name)}popScope(e){const t=e.name,s=this.scope.pop();if(s!==t)r.default.err("Factory.ConfStack","popScope",`Popped: ${s}, Expected: ${t}`);else{const e=this.confStack.pop();this.dbg("Popped scope: "+e.name)}}getConf(e){for(let t=this.confStack.length-1;t>=0;t--)if(this.dbg(`[${t}] looking for |${e}|`),this.confStack[t].hasOwnProperty(e))return this.dbg(`  >> [${t}] Found key |${e}|`),this.confStack[t][e];return this.globalConf.hasOwnProperty(e)?this.globalConf[e]:null}dbg(e){a.enabled&&r.default.diag(e)}}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FromJSON=void 0;const i=s(5)("bitn:Game.FromJSON"),l=o(s(0)),c=s(139),u=s(136),h=s(73),d=s(23),f=s(150),g=s(101),p=s(137),m=s(495),y=s(11),_=s(93),b=s(12),v=s(17),E=s(70),S=s(8),w=s(6),C=s(2),T=s(26),O=s(146),A=s(56),M=s(35),N=a(s(7)),P=s(65),D=a(s(32)),I=s(1),L=s(140),x=a(s(57)),k=s(95),R=s(25),B=s(15),F=s(99),G=s(55),W=s(225),Y=s(92),j=b.EventPool.getPool();B.Brain.Player=F.BrainPlayer,B.Brain.Spawner=G.BrainSpawner;const X=Symbol();t.FromJSON=class{constructor(){this._dungeonLevel=1,this._parser=w.ObjectShell.getParser(),this.id2level={},this.id2entity={},this.id2EntityJson={},this.id2Object={},this.id2Place={},this.actorsKilled={},this.id2Component={},this.id2CompJSON={},this.compsWithMissingRefs={},this.stairsInfo={},this.IND=0,this.chunkMode=!1}reset(){this.id2level={},this.id2entity={},this.id2EntityJson={},this.id2Object={},this.id2Component={},this.id2CompJSON={},this.id2Place={},this.stairsInfo={},this.compsWithMissingRefs={}}setChunkMode(e){this.chunkMode=e}getDungeonLevel(){return this._dungeonLevel}addObjRef(e,t,s){const n=t.getID();Number.isInteger(n)||l.default.err("FromJSON","addObjRef",`ID must be integer. Got: |${n}|`),this.id2entity[n]=t,this.id2Object[n]=t,s&&(this.id2EntityJson[n]=s),"level"===e?(this.id2level[n]=t,this.id2Place[n]=t):"element"===e||"entity"===e||l.default.err("FromJSON","addObjRef",`Unsupported type ${e} give`)}getObjByRef(e){let t=null;if(t=e.$objRef?e.$objRef:e,"entity"===t.type){const e=this.id2entity[t.id];if(!e){if(this.actorsKilled[t.id])return X;l.default.err("FromJSON","getObjRef",`No ID ${t.id} found`)}return e}return"level"===t.type?this.id2level[t.id]:"object"===t.type?this.id2Object[t.id]:"component"===t.type?this.id2Component[t.id]:"place"===t.type?this.id2Place[t.id]:null}createGame(e,t){"string"==typeof t&&l.default.err("Game.FromJSON","createGame","An object must be given instead of string"),this.dbg("createGame: Restoring now full game"),this.IND=1,this.setGlobalConfAndObjects(e,t),t.chunkManager&&this.setChunkMode(!0),C.Component.setIDCount(t.lastComponentID);const s=[];if(this.getLevelsToRestore(t).forEach(t=>{const n=this.restoreLevel(t);s.push(n),t.parent||(this.dbg(">> No parent. Adding directly "+n.getID()),e.addLevel(n))}),t.places&&Object.keys(t.places).forEach(s=>{const n=t.places[s],r=this.restorePlace(n);e.addPlace(r)}),t.overworld){const s=this.restoreOverWorld(t.overworld);e.setOverWorld(s)}if(t.worldSim){this.restoreWorldSim(e._worldSim,t.worldSim)}if(this.connectGameLevels(s),t.player){const s=this.restorePlayer(t.player);this.addRestoredPlayerToGame(s,e,t)}this.restoreEntityData(),this.restoreComponentData();const n=this.restoreGameMaster(e,t.gameMaster);if(e.setGameMaster(n),this.restoreChunkManager(e,t),this.checkNumOfLevels(e,t),g.GameObject.ID=t.gameObjectID,i.enabled&&this.dbg("Restored GameObject ID count to "+g.GameObject.ID),t.rng){const s=new I.Random(t.rng.seed);s.setState(t.rng.state),e.setRNG(s)}if(t.diceRng){const e=new I.Random(t.diceRng.seed);e.setState(t.diceRng.state),v.Dice.RNG=e}return this.restoreActiveLevels(e,t),this.IND=0,e.updateEventPoolRefs(),e}restorePlayer(e){const t=new A.SentientActor(e.name);return t.setIsPlayer(!0),t.remove("StatsMods"),t.remove("CombatMods"),t.setType(e.type),t.setID(e.id),this._dungeonLevel=e.dungeonLevel,this.addObjRef("entity",t,e),l.default.addCellStyle(l.default.TYPE_ACTOR,e.name,"cell-actor-player"),t}restorePlayerBrain(e,t){const s=e.getBrain(),n=s.getMemory(),r=t.memory;Object.keys(r).forEach(e=>{n[e](r[e])}),t.markList&&s._markList.fromJSON(t.markList)}addRestoredPlayerToGame(e,t,s){this._addRegenEvents(t,e);const n=s.player.levelID,r=t.getLevels().find(e=>e.getID()===n);if(r){const n=s.player.x,a=s.player.y;r.addActor(e,n,a),t.addPlayer(e)}else{const e="IDs available: "+t.getLevels().map(e=>e.getID());l.default.err("Game.FromJSON","addRestoredPlayerToGame",`Cannot find player level object with level ID ${n}. ${e}`)}}restoreEntity(e,t){l.default.isActor(t)?(this.createBrain(e.brain,t),this._addEntityFeatures(e,t),this.addEffectsToEntity(t)):l.default.isElement(t)?this.restoreElementEntity(e,t):this.restoreLevelEntity(e,t)}_addEntityFeatures(e,t){this.addCompsToEntity(t,e.components),this.createInventoryItems(e,t),this.createEquippedItems(e,t),e.spellbook&&this.createSpells(e,t)}restoreElementEntity(e,t){"lever"===t.getType()&&e.addTarget.forEach(e=>{const s=e.$objRef,n=this.id2entity[s.id];n&&t.addTarget(n)})}restoreLevelEntity(e,t){this.addCompsToEntity(t,e.components)}addCompsToEntity(e,t){for(const s in t)if(s){const n=t[s],r=n.setType;if(!r){const e='No "setType" in component: ';l.default.err("Game.FromJSON","addCompsToEntity",e+JSON.stringify(n))}const a=this.createComponent(r,n);e.add(a)}}addEffectsToEntity(e){if(e.has("UseEffects")){const t=e.get("UseEffects").getEffects();0===t.length&&l.default.err("Game.FromJSON","addEffectsToEntity","effects length was 0"),t.forEach(t=>{const s={use:t};this._parser.getCreator().addUseEffects(s,e)})}}createComponent(e,t){if(!C.Component.hasOwnProperty(e)){let s=`No |${e}| in Component.`;s+=" compJSON: "+JSON.stringify(t),l.default.err("Game.FromJSON","createComponent",s)}const s=C.Component.create(e);for(const n in t)if("function"==typeof s[n]){const e=t[n],r=this.getCompValue(s,t,n,e);s[n](r)}else{const s=JSON.stringify(t);l.default.err("FromJSON","createComponent",`${n} not function in ${e}. Comp: ${s}`)}const n=s.getID();return this.id2Component[n]=s,this.id2CompJSON[n]=t,s}getCompValue(e,t,s,n){if("string"==typeof n||"number"==typeof n)return n;if(l.default.isNullOrUndef([n])){const e=JSON.stringify(t);let r=`valueToSet |${n}|. setFunc |${s}|`;r+=`Comp |${t.setType}|, json: ${e}`,l.default.err("FromJSON","addCompsToEntity",r)}else{if(Array.isArray(n)){if(n.$objRefArray)return this.compsWithMissingRefs[t.setID]=e,n;const r=[];return n.forEach(n=>{const a=this.getCompValue(e,t,s,n);r.push(a)}),r}if(n.createFunc){return this[n.createFunc](n.value)}if(n.createComp){const e=n.createComp.setType;return this.createComponent(e,n.createComp)}if(!n.$objRef)return n;if("component"===n.$objRef.type)return this.compsWithMissingRefs[t.setID]=e,n;{const e=this.getObjByRef(n.$objRef);if(e)return e;{let e="Null obj for objRef "+JSON.stringify(n.$objRef);e+=" compJSON: "+JSON.stringify(t),l.default.err("FromJSON","getCompValue",e)}}}return null}createActorClass(e){const{className:t,actorRef:s}=e,n=this.getObjByRef(s);return n?_.ActorClass.create(t,n):(l.default.err("FromJSON","createActorClass",`No actor for class ${t} found`),null)}createQuestData(e){const t=new p.QuestData;return e.path.forEach(e=>{let s=null;if(s=e.target.$objRef?this.getObjByRef(e.target.$objRef):e.target,s===X)s={msg:"Quest target missing/killed"};else if(!s){const t="Missing objRef: "+JSON.stringify(e.target);l.default.err("FromJSON","createQuest",t)}t.addTarget(e.type,s)}),t}createBrain(e,t){const s=e.type;if(B.Brain[s]){const n=new B.Brain[s](t);if(t.setBrain(n),"Player"===s)return void this.restorePlayerBrain(t,e);e.constraint&&n.setConstraint(e.constraint),e.placeConstraint&&n.setPlaceConstraint(e.constraint),e.spawnProb&&(n.spawnProb=e.spawnProb),e.hasOwnProperty("spawnLeft")&&(n.spawnLeft=e.spawnLeft);const r=n.getMemory(),a=e.memory;if(a){if(a.enemyTypes.forEach(e=>{n.addEnemyType(e)}),a.lastAttackedID){const e=this.id2entity[a.lastAttackedID];r.setLastAttacked(e)}if(a.enemies&&a.enemies.forEach(e=>{const t=this.id2entity[e];t&&r.addEnemy(t)}),a.friends&&a.friends.forEach(e=>{const t=this.id2entity[e];t&&r.addFriend(t)}),a.seen&&(r._actors.seen=a.seen),e.goal){const s=this.createTopGoal(e.goal,t);n.setGoal(s)}}else"Rogue"===s&&n.getMemory().addEnemyType("player")}else l.default.err("FromJSON","createBrain",`Cannot find Brain.${s}, JSON: ${e}`)}createTopGoal(e,t){const s=new h.GoalsTop[e.type](t);return s.removeEvaluators(),e.evaluators.forEach(e=>{let n=null;if(d.Evaluator[e.type])n=new d.Evaluator[e.type](e.bias);else if(f.EvaluatorsBattle[e.type])n=new f.EvaluatorsBattle[e.type](e.bias);else{const s="Entity: "+JSON.stringify(t);l.default.err("FromJSON","createTopGoal",`Evaluator ${e.type} not found. ${s}`)}e.args&&n.setArgs(e.args),s.addEvaluator(n)}),s}createSpells(e,t){return t._spellbook=new E.Spell.SpellBook(t),e.spellbook.spells.forEach(e=>{if(E.Spell.hasOwnProperty(e.new)){const s=this.restoreSpell(e,t);t._spellbook.addSpell(s)}else l.default.err("FromJSON","createSpells",`No spell ${e.new} found in Spell`)}),t._spellbook}restoreSpell(e,t){const s=new E.Spell[e.new];if(s.setPower(e.power),e.range&&s.setRange(e.range),e.dice){const t={};Object.keys(e.dice).forEach(s=>{const n=e.dice[s];t[s]=v.Dice.create(n)}),s._dice=t}return e.spells&&(s.removeSpells(),e.spells.forEach(e=>{const n=this.restoreSpell(e,t);s.addSpell(n)})),s}createItem(e){const t=e;let s=null;if(this._parser.hasItem(e.setName))s=this._parser.createItem(e.setName);else{const n=this.getItemObjectType(t);if(T.Item[n])s=new T.Item[n];else{let t=`No RG.Item[${n}] found for new()`;t+=" JSON: "+JSON.stringify(e),l.default.err("FromJSON","createItem",t)}}for(const e in t)if("setSpirit"===e){const n=t[e],r=this.createActor(n);this._addEntityFeatures(n,r),s[e](r)}else if("function"==typeof s[e])s[e](t[e]);else if("components"!==e&&"isUsable"!==e){const t=JSON.stringify(s);l.default.err("Game.FromJSON","createItem",`${e} not func in ${t}`)}return this.addEntityInfo(s,e),t.components&&this.addCompsToEntity(s,e.components),s}createInventoryItems(e,t){if("Sentient"===e.new&&(t._invEq=new O.Inventory(t)),e.hasOwnProperty("inventory")){const s=e.inventory;for(let e=0;e<s.length;e++){const n=this.createItem(s[e]);t.getInvEq().addItem(n)}}}createEquippedItems(e,t){if(e.hasOwnProperty("equipment")){const s=e.equipment;for(let e=0;e<s.length;e++){const n=this.createItem(s[e]);t.getInvEq().restoreEquipped(n)}}}getItemObjectType(e){if("spiritgem"===e.setType)return"SpiritGem";if("goldcoin"===e.setType)return"GoldCoin";if("missileweapon"===e.setType)return"MissileWeapon";if(l.default.isNullOrUndef([e]))l.default.err("FromJSON","getItemObjectType","item is undefined");else{if(!l.default.isNullOrUndef([e.setType]))return e.setType.capitalize();{const t=JSON.stringify(e);l.default.err("FromJSON","getItemObjectType","item.setType is undefined. item: "+t)}}return null}restoreLevel(e){const t=this.createCellMap(e.map),s=new y.Level(t);return s.setID(e.id),s.setLevelNumber(e.levelNumber),e.actors.forEach(e=>{const t=this.createActor(e.obj);null!==t?this.isVirtual(e)?s.addVirtualProp(l.default.TYPE_ACTOR,t):s.addActor(t,e.x,e.y):l.default.err("FromJSON","restoreLevel",`Actor ${JSON.stringify(e)} returned null`)}),e.elements.forEach(e=>{const t=this.createElement(e);null!==t?s.addElement(t,e.x,e.y):l.default.err("FromJSON","restoreLevel",`createElement ${JSON.stringify(e)} returned null`)}),e.items.forEach(e=>{const t=this.createItem(e.obj);null!==t?s.addItem(t,e.x,e.y):l.default.err("FromJSON","restoreLevel",`Actor ${JSON.stringify(e)} returned null`)}),this.addLevels([s],"restoreLevel",[e]),s}isVirtual(e){return-1===e.x&&-1===e.y}createElement(e){const t=e.obj,s=t.type;let n=null;if("connection"===s)n=this.createUnconnectedStairs(e);else if("shop"===s){const e=new N.ElementShop;let s=null;l.default.isNullOrUndef([t.shopkeeper])||(s=this.id2entity[t.shopkeeper],s?e.setShopkeeper(s):l.default.err("Game.FromJSON","createElement",`Shopkeeper with ID ${t.shopkeeper} not found`)),e.setCostFactor(t.costFactorBuy,t.costFactorSell),t.isAbandoned&&e.abandonShop(),n=e}else if("door"===s)n=new N.ElementDoor(t.closed);else if("leverdoor"===s)n=new N.ElementLeverDoor(t.closed);else if("lever"===s)n=new N.ElementLever;else if("marker"===s)n=new N.ElementMarker(t.char),n.setTag(t.tag);else if("exploration"===s){const e=new N.ElementExploration;e.setExp(t.setExp),t.data&&e.setData(t.data),n=e}else"web"===s?n=new N.ElementWeb:"slime"===s?n=new N.ElementSlime:"hole"===s&&(n=new N.ElementHole);if(t.msg&&n.setMsg(t.msg),n){const e=t.id;Number.isInteger(e)&&(n.setID(e),this.addObjRef("element",n,t))}return n}createActor(e){null===e.type&&l.default.err("FromJSON","createActor","json.type null, json: "+JSON.stringify(e));let t=null;if(e.new&&A.Actor[e.new])t=new A.Actor[e.new](e.name,!1);else{let t="";const s=JSON.stringify(e);if(e.new){const n=Object.keys(A.Actor);t=`Constr ${e.new} not in Actor: ${n}. JSON obj: `+s}else t="No json.new given. JSON obj: "+s;l.default.err("Game.FromJSON","createActor",t)}return t.add(new C.Component.Location),t.add(new C.Component.Typed("BaseActor",l.default.TYPE_ACTOR)),t.setType(e.type),t.setID(e.id),this.addEntityInfo(t,e),t}addEntityInfo(e,t){this.addObjRef("entity",e,t)}createUnconnectedStairs(e){const{x:t,y:s}=e,n=`${e.obj.srcLevel},${t},${s}`,r=e.obj,a=new N.ElementStairs(r.name);return this.stairsInfo[n]={targetLevel:r.targetLevel,targetStairs:r.targetStairs},a}createCellMap(e){if(e.encoded)return M.CellMap.fromJSON(e);const t=new M.CellMap(e.cols,e.rows);return e.cells.forEach((e,s)=>{e.forEach((e,n)=>{const r=this.createBaseElem(e);t.setBaseElemXY(s,n,r)})}),e.explored.forEach(e=>{t.getCell(e[0],e[1]).setExplored()}),t}createBaseElem(e){const t=S.ELEM_MAP.elemIndexToType[e];return S.ELEM_MAP.elemTypeToObj[t]?S.ELEM_MAP.elemTypeToObj[t]:(l.default.err("Game.fromJSON","createBaseElem","Unknown type "+t),null)}setGlobalConfAndObjects(e,t){t.globalConf&&(this.dbg("Setting globalConf for game: "+JSON.stringify(t.globalConf,null,1)),e.setGlobalConf(t.globalConf)),t.cellStyles&&(l.default.cellStyles=t.cellStyles),t.charStyles&&(l.default.charStyles=t.charStyles),t.actorsKilled&&(this.actorsKilled=t.actorsKilled,e.actorsKilled=t.actorsKilled),t.objectShellParser&&w.ObjectShell.restoreParser(t.objectShellParser),t.gameID&&(e.gameID=t.gameID);const s=t.engine;if(s.msgHandler){const t=s.msgHandler,n=e.getPool();e._engine._msg=W.MessageHandler.fromJSON(t,n)}}connectGameLevels(e){e.forEach(e=>{e.getConnections().forEach(t=>{const s=this.stairsInfo[t.getConnID()],n=this.id2level[s.targetLevel];if(!n&&this.chunkMode)return void t.setConnObj(s);const r=s.targetStairs;r||(l.default.diag(JSON.stringify(e,null,1)),l.default.diag(s),l.default.diag("Parent: "+e.getParent().getName()),l.default.diag(JSON.stringify(t)));const a=r.x,o=r.y;if(n){t.setTargetLevel(n);const e=n.getMap().getCell(a,o).getConnection();e?t.connect(e):l.default.err("Game.FromJSON","connectGameLevels","Target stairs was null. Cannot connect.")}else{const e=s.targetLevel;l.default.err("Game.FromJSON","connectGameLevels",`Target level ${e} null. Cannot connect.`)}})})}restoreGameMaster(e,t){++this.IND;const s=e.getGameMaster(),n={};return Object.keys(t.battles).forEach(e=>{t.battles[e].forEach(t=>{if(n[e]=[],this.id2level[e]){this.dbg("FromJSON Restoring Battle "+e);const s=this.restoreBattle(t);n[e].push(s)}else this.dbg(`FromJSON Battle ${e} not created`),this.dbg(JSON.stringify(t)),n[e].push(t)})}),s.setBattles(n),t.battlesDone&&(s.battlesDone=t.battlesDone),s.hasBattleSpawned=t.hasBattleSpawned,--this.IND,s}restoreBattle(e){const t=this.getLevelOrFatal(e.level,"restoreBattle");if(t){++this.IND,this.dbg("\trestoreBattle found level ID "+e.level);const s=new u.Battle(e.name);s.setID(e.id),s.setLevel(t),s.setStats(e.stats),s.finished=e.finished;const n=[];if(e.armies.forEach(e=>{n.push(this.restoreArmy(e))}),s.setArmies(n),s.finished&&(i(e.name+" finished. rm listeners"),j.removeListener(s),n.forEach(e=>{j.removeListener(e)})),e.parent){const t=this.id2Place[e.parent];if(t)l.default.isBattleZone(t)?t.setBattle(s):l.default.err("FromJSON","restoreBattle","Only battleZone can be parentZone of battle");else{const t=JSON.stringify(e);l.default.err("FromJSON","restoreBattle",`Could not find parent zone with ID ${e.parent}: ${t}`)}}return--this.IND,s}return l.default.err("Game.FromJSON","restoreBattle","No level for battle ID's "+e.level),null}restoreArmy(e){const t=new u.Army(e.name);return e.id&&t.setID(e.id),e.actors.forEach(e=>{if(this.id2entity[e]){const s=this.id2entity[e];l.default.isActor(s)&&t.addActor(s)}}),t.setDefeatThreshold(e.defeatThreshold),Object.entries(e.alignment).forEach(e=>{const[s,n]=e;t.addAlignment(s,n)}),t}restorePlace(e){const t=new m.WorldFromJSON(this.id2level,this.id2entity);t.fromJSON=this;const s=t.createPlace(e);return this.id2Place=Object.assign(this.id2Place,s.getID2Place()),s}restoreOverWorld(e){const t=c.OWMap.fromJSON(e),s=new L.OverWorld.CoordMap;for(const t in e.coordMap)e.coordMap.hasOwnProperty(t)&&(s[t]=e.coordMap[t]);return t.coordMap=s,t}restoreWorldSim(e,t){const s=k.WorldSimulation.fromJSON(t);return e.updateCount=s.updateCount,e.seasonMan=s.seasonMan,e.dayMan=s.dayMan,e}restoreEntityData(){const e=JSON.parse(JSON.stringify(R.Entity.num));if(Object.keys(this.id2EntityJson).forEach(e=>{const t=this.id2EntityJson[e],s=this.id2entity[e];if(t&&s)this.restoreEntity(t,s);else{let n=t?"":"|JSON is null/undef|";n+=s?"":"|entity is null/undef|",l.default.err("FromJSON","restoreEntityData",`ID: ${e} ${n}`)}}),i.enabled){const t=JSON.parse(JSON.stringify(R.Entity.num));Object.keys(t).forEach(s=>{console.log(`${s}: ${t[s]-e[s]}`)})}}restoreComponentData(){Object.keys(this.compsWithMissingRefs).forEach(e=>{const t=this.compsWithMissingRefs[e],s=this.id2CompJSON[e];this.restoreComponent(s,t)})}restoreComponent(e,t){Object.keys(e).forEach(s=>{const n=e[s];if(Array.isArray(n)){if(n.$objRefArray){const e=[];n.forEach(t=>{if(t.$objRef)e.push(this.getObjByRef(t.$objRef));else{const e=JSON.stringify(n);l.default.err("FromJSON","restoreComponent","$objRefArray found but no $objRefs inside: "+e)}}),t[s](e)}}else n.$objRef&&"component"===n.$objRef.type&&t[s](this.getObjByRef(n.$objRef))})}reportMissingLevel(e){let t="connObj: "+JSON.stringify(e);Object.keys(this.id2level).forEach(e=>{t+="\n\t"+e}),console.warn(t+"\n")}_addRegenEvents(e,t){const s=new x.RegenEvent(t,20*l.default.ACTION_DUR);if(e.addEvent(s),t.has("SpellPower")){const s=new x.RegenPPEvent(t,30*l.default.ACTION_DUR);e.addEvent(s)}}dbg(e){if(i.enabled){const t=">".repeat(this.IND);i(`${t} ${e}`)}}getLevelsToRestore(e){let t=[],s=0;return e.levels?e.levels:e.places?(Object.keys(e.places).forEach(n=>{const r=e.places[n];r.area&&r.area.forEach(e=>{e.tiles.forEach((n,r)=>{n.forEach((n,a)=>{e.tileStatus[r][a]===Y.LoadStat.LOADED&&(s+=n.levels.length,t=t.concat(n.levels))})})})}),this.dbg(`Restoring ${t.length} out of ${s}`),t):t}createTiles(e,t){const s=e.getLevels();this.addLevels(s,"createTiles");let n=[];t.forEach(e=>{n=n.concat(e.levels)});const r=[];n.forEach(e=>{const t=this.restoreLevel(e);r.push(t),s.push(t)}),this.connectGameLevels(r),this.restoreEntityData(),this.restoreComponentData();const a=e.getCurrentWorld().getCurrentArea(),o=new P.FactoryWorld;o.setId2Level(this.id2level),o.id2entity=this.id2entity,t.forEach(t=>{const[s,n]=[t.x,t.y],r=new D.AreaTile(s,n,a),i=this.id2level[t.level];r.setLevel(i),e.addLevel(i);const l=JSON.parse(JSON.stringify(t));a.setTile(s,n,r),a.setLoaded(s,n),i.setParent(a),o.fromJSON=this,o.createZonesFromTile(a,l,s,n),this.restoreSerializedBattles(e,r)})}restoreSerializedBattles(e,t){const s=t.getLevel().getID(),n=e.getGameMaster();if(n.battles[s]){const e=n.battles[s];n.battles[s]=[],e.forEach(e=>{const t=this.restoreBattle(e);n.battles[s].push(t)})}}addLevels(e,t="",s=[]){e.forEach((e,n)=>{const r=e.getID();if(this.id2level.hasOwnProperty(r))l.default.log(e),l.default.err("Game.FromJSON","addLevels - "+t,"Duplicate level ID detected "+r);else{let a=null;n<s.length&&(a=s[n]),this.addObjRef("level",e,a),this.dbg(`Added level ${r} to this.id2level ${t}`)}})}connectTileLevels(e,t){t.forEach(e=>{const t=e.getID(),s=e.getTargetLevel();this.stairsInfo[t]={targetLevel:s,targetStairs:e.getTargetStairs()}}),this.addLevels(e,"connectTileLevels"),this.connectConnections(t)}connectConnections(e){e.forEach(e=>{const t=this.stairsInfo[e.getID()],s=this.id2level[t.targetLevel],n=t.targetStairs,{x:r,y:a}=n;if(s){e.setTargetLevel(s);const t=s.getMap().getCell(r,a).getConnection();t?e.connect(t):l.default.err("Game.FromJSON","connectConnections","Target stairs was null. Cannot connect.")}else{const e=t.targetLevel;l.default.err("Game.FromJSON","connectConnections",`Target level ${e} null. Cannot connect.`)}})}restoreChunkManager(e,t){if(t.chunkManager){const{chunkManager:s}=t;e.setEnableChunkUnload(!0),e._chunkManager.store.data=s.data,e._chunkManager.recordedTileMoves=s.recordedTileMoves}}checkNumOfLevels(e,t){const s=e.getLevels().length;if(t.levels&&s!==t.levels.length){const e=t.levels.length;l.default.err("Game.FromJSON","checkNumOfLevels",`Exp. ${e} levels, after restore ${s}`)}}getLevelOrFatal(e,t){if(!Number.isInteger(e)){const s="ID must be number. Got "+e;l.default.err("Game.FromJSON",t,s)}if(this.id2level.hasOwnProperty(e))return this.id2level[e];let s=`No level with ID ${e}.`;return s+=" Available: "+Object.keys(this.id2level),l.default.err("Game.FromJSON",t,s),null}restoreActiveLevels(e,t){t.engine.activeLevels.forEach(t=>{this.id2level[t]?e.addActiveLevel(this.id2level[t]):l.default.warn("FromJSON","restoreActiveLevels","Did not find active level ID "+t)})}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.TerritoryMap=void 0;const r=n(s(0)),a=s(224),o=s(94),i=s(1),l=s(140);i.Random.getRNG();t.TerritoryMap=function(){},t.TerritoryMap.create=function(e,t,s){const[n,i]=s,c=e.getFeaturesByType(o.OW.WCAPITAL)[0],u=e.getFeaturesByType(o.OW.WTOWER)[0],h=e.getFeaturesByType(o.OW.BTOWER)[0],d=e.getFeaturesByType(o.OW.BCAPITAL)[0],f=e.getOWMap(),g=new a.Territory(e.getSizeX(),e.getSizeY(),{startSize:2,maxNumPos:2});g.useMap(f,{[o.OW.TERM]:!0,[o.OW.MOUNTAIN]:!0,[o.OW.BVILLAGE]:!0,[o.OW.WVILLAGE]:!0,[o.OW.WCAPITAL]:!0,[o.OW.BCAPITAL]:!0,[o.OW.WTOWER]:!0,[o.OW.BTOWER]:!0});g.addRival({name:"avianfolk",char:"A"}),g.addRival({name:"wildling",char:"I"}),g.addRival({name:"bearfolk",char:"B"}),g.addRival({name:"wolfclan",char:"w"}),g.addRival({name:"catfolk",char:"f"}),g.addRival({name:"dogfolk",char:"d"}),g.addRival({name:"human",char:"@"});const p={name:"undead",char:"z",numPos:3,startX:[e.getCenterX()],startY:[e.getSizeY()-5]};g.addRival(p),g.addRival({name:"goblin",char:"g",numPos:8}),g.addRival({name:"dwarf",char:"h",startX:u[0],startY:u[1]}),g.addRival({name:"hyrkhian",char:"y",startX:c[0],startY:c[1]});const m={name:"winterbeing",char:"W",startX:[h[0],d[0]],startY:[h[1],d[1]]};g.addRival(m);const y=new l.OverWorld.CoordMap;y.xMap=10,y.yMap=10;const _=g.getRivalData(t);return _?(_.numPos+=1,_.startX.push(n),_.startY.push(i),console.log("TerritoryMap gen player owX:",n,"owY:",i),g.addTag([n,i],"player"),g.generate(),g):(r.default.err("TerritoryMap","create","Unable to find rivalData for player race "+t),g)}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Territory=void 0;const r=n(s(0)),a=s(4),o=s(1).Random.getRNG();class i{constructor(e,t,s={}){this.map=new Array(e),this.cols=e,this.rows=t,this.rivals=[],this.currRivals=[],this.empty={},this.occupied={},this.occupiedBy={},this.numEmpty=0,this.numCells=e*t,this.terrData={},this.rng=o,this.doPostProcess=!0,this.maxNumPos=1,this.startSize=1,this.maxFillRatio=1,this.dirs=r.default.DIR_NSEW.concat(r.default.DIR_DIAG);["maxNumPos","startSize","dirs","doPostProcess","maxFillRatio","rng"].forEach(e=>{s.hasOwnProperty(e)&&(this[e]=s[e])});for(let s=0;s<e;s++){this.map[s]=new Array(t);for(let e=0;e<t;e++)this._markEmpty(s,e)}this.infoTags={}}static fromJSON(e){const t=new i(0,0,{});return Object.keys(e).forEach(s=>{t[s]=e[s]}),t}setRNG(e){this.rng=e}getMap(){return this.map}getData(){return this.terrData}addTag(e,t){const s=r.default.toKey(e);this.infoTags[s]||(this.infoTags[s]=[]),this.infoTags[s].push(t)}getRivalData(e){return this.terrData[e]?this.terrData[e]:null}_markEmpty(e,t){this.map[e][t]=".",this.empty[e+","+t]=[e,t],++this.numEmpty}hasRival(e){return!this.isEmpty(e)&&!this.isFull(e)}getRival(e){const[t,s]=e,n=this.map[t][s];return this.getName(n)}findTag(e){const t=[];return Object.keys(this.infoTags).forEach(s=>{this.infoTags[s].indexOf(e)>=0&&t.push(r.default.fromKey(s))}),t}useMap(e,t){this.numEmpty=0;for(let s=0;s<e.length;s++)for(let n=0;n<e[0].length;n++)t[e[s][n]]?this._markEmpty(s,n):(this.map[s][n]="#",delete this.empty[s+","+n])}addRival(e){this._initRival(e)}generate(e=-1){this.currRivals=this.rivals.slice(),this.rng.shuffle(this.currRivals);let t=0;for(;this._hasTurnsLeftToProcess(t,e);){const e=this.currRivals.shift(),{name:s}=e,n=this.terrData[s],{open:r,currPos:a,maxNumPos:o}=n;if(a<o){const t=this._getStartPosition(s);this._addStartPosition(s,t),this.currRivals.push(e)}else if(Object.keys(r).length>0){const t=this.getRandOpenXY(s),n=this.getEmptyAdjacentXY(t);n?(this._addOccupied(s,n),this.currRivals.push(e)):(this._closeCell(s,t),Object.keys(r).length>0&&this.currRivals.push(e))}++t}this.doPostProcess&&this.postProcessData()}update(){this.currRivals=this.rivals.slice(),this.rng.shuffle(this.currRivals),this.currRivals.forEach(e=>{const{name:t}=e,s=this.getRandOpenXY(t),n=this.getEmptyAdjacentXY(s);n?this._addOccupied(t,n):this._closeCell(t,s)}),this.currRivals=[]}getName(e){const t=this.rivals.find(t=>t.char===e);return t?t.name:null}getFillRatio(){return(this.numCells-this.numEmpty)/this.numCells}_hasTurnsLeftToProcess(e,t){return this.hasEmpty()&&this.currRivals.length>0&&e!==t&&this.getFillRatio()<this.maxFillRatio}_getStartPosition(e){const t=this.terrData[e],{currPos:s}=t,n=this.getRandEmptyXY();t.startX.length>s?n[0]=t.startX[s]:t.startX.push(n[0]),t.startY.length>s?n[1]=t.startY[s]:t.startY.push(n[1]);const a=r.default.toKey(n);return this.empty.hasOwnProperty(a)||"#"!==this.map[n[0]][n[1]]&&r.default.warn("Territory","_getStartPosition",`${e} overriding another position @ ${n}`),t.currPos+=1,n}_addOccupied(e,t){const s=r.default.toKey(t);this.occupied[s]=t,this.occupiedBy[e].push(t),this.terrData[e].open[s]=t,this.terrData[e].occupied[s]=t,this.map[t[0]][t[1]]=this.terrData[e].char,this.empty[s]&&(--this.numEmpty,delete this.empty[s])}_addStartPosition(e,t){const s=this.getRivalData(e);if(!s)return void r.default.err("Territory","_addStartPosition",`TerrData for name |${e}| is null`);const n=s.startSize-1,o=a.Geometry.getBoxAround(t[0],t[1],n,!0);o.forEach(t=>{this.isEmpty(t)&&this._addOccupied(e,t)}),0===o.length&&r.default.err("Territory","_addStartPosition","No startCoord found!")}getRandEmptyXY(){return this.rng.arrayGetRand(Object.values(this.empty))}isFull(e){const[t,s]=e;return"#"===this.map[t][s]}isEmpty(e){const t=r.default.toKey(e);return this.empty.hasOwnProperty(t)}getRandOpenXY(e){const{open:t}=this.terrData[e];return this.rng.arrayGetRand(Object.values(t))}getEmptyAdjacentXY(e){const t=this.dirs.slice();for(this.rng.shuffle(t);t.length>0;){const s=t.shift(),[n,a]=r.default.newXYFromDir(s,e);if(this.hasXY(n,a)&&"."===this.map[n][a])return[n,a]}return null}hasXY(e,t){return e>=0&&t>=0&&e<this.map.length&&t<this.map[0].length}_closeCell(e,t){const s=r.default.toKey(t);this.terrData[e].closed[s]=t,delete this.terrData[e].open[s]}hasEmpty(){return this.numEmpty>0}mapToString(){const e=this.map[0].length,t=this.map.length,s=[];for(let n=0;n<e;n++){const e=[];for(let s=0;s<t;s++)e.push(this.map[s][n]);s.push(e)}return s.map(e=>e.join(""))}getAreaProportions(){const e={};return Object.keys(this.occupiedBy).forEach(t=>{e[t]=this.occupiedBy[t].length}),e}_initRival(e){this.rivals.push(e);const{name:t,char:s}=e;this.terrData[t]={currPos:0,maxNumPos:this.maxNumPos,char:s,occupied:{},closed:{},open:{},startX:[],startY:[],startSize:this.startSize},Array.isArray(e.startX)?this.terrData[t].startX=e.startX:e.startX>=0&&(this.terrData[t].startX=[e.startX]),Array.isArray(e.startY)?this.terrData[t].startY=e.startY:e.startY>=0&&(this.terrData[t].startY=[e.startY]),e.numPos?this.terrData[t].maxNumPos=e.numPos:e.maxNumPos&&(this.terrData[t].maxNumPos=e.maxNumPos),e.startSize&&(this.terrData[t].startSize=e.startSize),this.occupiedBy[t]=[]}postProcessData(){const e=this.dirs.length>4;Object.keys(this.terrData).forEach(t=>{const s=this.terrData[t],{startX:n,startY:o,char:i}=s;s.numOccupied=Object.keys(s.occupied).length,s.areas={},n.forEach((t,n)=>{const l=[t,o[n]],c=a.Geometry.floodfill2D(this.map,l,i,{},e);s.areas[r.default.toKey(l)]=c})})}toJSON(){return{terrData:this.terrData,map:this.map,cols:this.cols,rows:this.rows,currRivals:this.currRivals,empty:this.empty,occupied:this.occupied,occupiedBy:this.occupiedBy,numEmpty:this.numEmpty,dirs:this.dirs}}}t.Territory=i},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MessageHandler=void 0;const r=n(s(0));class a{constructor(e){this._lastMsg=null,this._messages=[],this._prevMessages=[],this._hasNew=!1,this.hasNotify=!0,e.listenEvent(r.default.EVT_MSG,this)}static fromJSON(e,t){const s=new a(t);return s._hasNew=e._hasNew,s._messages=e._messages,s._prevMessages=e._prevMessages,s._lastMsg=e._lastMsg,s}notify(e,t){if(e===r.default.EVT_MSG&&t.hasOwnProperty("msg")){const e={msg:t.msg,style:"prim",count:1};t.hasOwnProperty("cell")&&(e.cell=t.cell),t.hasOwnProperty("style")&&(e.style=t.style),this._lastMsg&&this._lastMsg.msg===e.msg?this._lastMsg.count?this._lastMsg.count+=1:this._lastMsg.count=1:(this._lastMsg=e,this._messages.push(e)),this._hasNew=!0}}hasNew(){return this._hasNew}getMessages(){return this._hasNew=!1,this._messages.length>0?this._messages:this._prevMessages.length>0?this._prevMessages:[]}clear(){this._messages.length>0&&(this._prevMessages=this._messages.slice()),this._messages=[]}toJSON(){return{_lastMsg:this._lastMsg,_messages:o(this._messages),_prevMessages:o(this._prevMessages),_hasNew:this._hasNew}}}function o(e){const t=[];return e.forEach(e=>{e.cell||t.push(e)}),t}t.MessageHandler=a},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemAnimation=void 0;const r=n(s(0)),a=s(3),o=s(4),i=s(506);class l extends a.SystemBase{constructor(e,t){super(r.default.SYS.ANIMATION,e,t),this._enabled=!0,this.currAnim=null}enableAnimations(){this._enabled=!0}disableAnimations(){this._enabled=!1}missileAnimation(e,t){const s=t.missile,n=t.to[0],a=t.to[1],o=s.first();let i=o[0],l=o[1];const c=t.item,u=r.default.getChar(r.default.TYPE_ITEM,c.getName()),h=r.default.getCssClass(r.default.TYPE_ITEM,c.getName()),d=this._createAnimation(t);for(;i!==n||l!==a;){const e={},t=i+","+l;if(e[t]={},e[t].char=u,e[t].className=h,d.addFrame(e),!s.next())break;i=s.getX(),l=s.getY()}this._setCurrAnim(d)}lineAnimation(e,t){let s=t.from[0],n=t.from[1];const a=t.dir[0],o=t.dir[1];let i=t.range,l=r.default.dirToChar(t.dir);t.lineChar&&(l=t.lineChar);const c=this._createAnimation(t),u={};if(t.ray)for(;i>0;){s+=a,n+=o,u[s+","+n]={char:l||"*",className:t.className||"cell-ray"};let e={};e=Object.assign(e,u),c.addFrame(e),--i}this._setCurrAnim(c)}cellAnimation(e,t){const s=this._createAnimation(t),n={};s.slowDown=10,t.coord.forEach(e=>{n[e[0]+","+e[1]]={char:t.cellChar||"*",className:t.className||"cell-animation"}}),s.addFrame(n),this._setCurrAnim(s)}areaAnimation(e,t){const s=this._createAnimation(t),n=t.range,[r,a]=[t.cX,t.cY];for(let e=1;e<=n;e++){const n={};o.Geometry.getBoxAround(r,a,e).forEach(e=>{n[e[0]+","+e[1]]={char:t.cellChar||"*",className:t.className||"cell-animation"}}),s.addFrame(n)}this._setCurrAnim(s)}_createAnimation(e){const t=new i.Animation;return t.setLevel(e.level),t}updateEntity(e){if(this._enabled){e.getList("Animation").forEach(t=>{const s=t.getArgs();s.dir?this.lineAnimation(e,s):s.missile?this.missileAnimation(e,s):s.cell?this.cellAnimation(e,s):r.default.isNullOrUndef([s.range,s.cX,s.cY])||this.areaAnimation(e,s)})}e.removeAll("Animation"),this.hasEntities()||(this.pool.emitEvent(r.default.EVT_ANIMATION,{animation:this.currAnim}),this.currAnim=null)}_setCurrAnim(e){this.currAnim?this.currAnim.combine(e):this.currAnim=e}}t.SystemAnimation=l},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemAreaEffects=void 0;const i=o(s(0)),l=s(3),c=a(s(2)),u=s(4);class h extends l.SystemBase{constructor(e,t){super(i.default.SYS.AREA_EFFECTS,e,t),this.radRange=1}updateEntity(e){const t=e.getList("Flame");let s=!1,n=!1;e.has("Health")?t.forEach(t=>{const r=t.getDamageType(),a=new c.Damage(t.getDamage(),r),o=t.getSource();if(a.setSource(o),o.has("Created")){const e=o.get("Created").getCreator();a.setSourceActor(e)}e.add(a),e.remove(t),r===i.default.DMG.FIRE?s=!0:r===i.default.DMG.ICE&&(n=!0)}):e.removeAll("Flame"),s?this._createRadiationComps(e,"Heat","Fire"):n&&this._createRadiationComps(e,"Coldness","Ice flame")}_createRadiationComps(e,t,s){const n=e.getLevel().getMap(),r=e.getCell(),[a,o]=r.getXY();u.Geometry.getBoxAround(a,o,this.radRange).forEach(e=>{if(n.hasXY(e[0],e[1])){const r=n.getCell(e[0],e[1]);if(r.hasActors()){r.getActors().forEach(e=>{e.getName()!==s&&e.add(new c[t])})}}})}}t.SystemAreaEffects=h},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemAttack=void 0;const i=o(s(0)),l=s(3),c=a(s(2)),u=s(15);class h extends l.SystemBase{constructor(e,t){super(i.default.SYS.ATTACK,e,t)}updateEntity(e){e.getList("Attack").forEach(t=>{this.processAttackComp(e,t),e.remove(t)})}processAttackComp(e,t){const s=e,n=t.getTarget(),r=s.getName(),a=n.getName();if(n.has("Ethereal"))i.default.gameMsg({cell:s.getCell(),msg:"Attack of "+r+" passes through "+a});else{if(n.has("FirstStrike")){const e=a+" seems to strike first.";i.default.gameMsg({cell:n.getCell(),msg:e}),this.performAttack(n,s,a,r)}const e=s.get("Combat").getNumHits();for(let t=0;t<e;t++)this.performAttack(s,n,r,a);if(n.has("CounterAttack")){const e=a+" seems to counter attack.";i.default.gameMsg({cell:n.getCell(),msg:e}),this.performAttack(n,s,a,r)}if(s.has("BiDirStrike")){const e=this.getBiDirTarget(s,n);if(e){const t=r+" tries to hit double strike.";i.default.gameMsg({msg:t,cell:s.getCell()});const n=e.getName();if(this.performAttack(s,e,r,n),e.has("CounterAttack")){const t=n+" seems to counter attack.";i.default.gameMsg({cell:e.getCell(),msg:t}),this.performAttack(e,s,n,r)}}}s.getBrain().getMemory().setLastAttacked(n)}}addAttackerBonus(e){return u.Brain.getEnemyCellsAround(e).length}addDefenderBonus(e){return u.Brain.getEnemyCellsAround(e).length}performAttack(e,t,s,n){if(t.has("Charm")&&this.attIsCharmed(e,t)){let s=`${e.getName()} is charmed by ${t.getName()} `;return s+=", and does not attack",void i.default.gameMsg({cell:e.getCell(),msg:s})}let r=i.default.getMeleeAttack(e);e.has("Attacker")&&(r+=this.addAttackerBonus(e));const a=this.getEntityDefense(t),o=r/(r+a),u=this.rng.getUniform();if(this._emitDbgMsg(`hitChance is ${o}, threshold ${u}`,e),o>=u){const r=e.getDamage();r>0?(this.doDamage(e,t,r),t.has("Experience")&&l.SystemBase.addSkillsExp(e,"Melee",1)):i.default.gameMsg({cell:e.getCell,msg:s+" fails to hurt "+n}),this._applyAddOnHitComp(e,t)}else this.checkForShieldSkill(u,r,a,t),i.default.gameMsg({cell:e.getCell(),msg:s+" misses "+n});if(t.addEnemy(e),e.isPlayer()||t.isPlayer()){const s=new c.Event;s.setArgs({type:i.default.EVT_ACTOR_ATTACKED,cause:e}),t.add(s)}}getEntityDefense(e){if(e.has("Paralysis"))return 0;let t=0;return e.getDefense&&(t=e.getDefense(),e.has("Defender")&&(t+=this.addDefenderBonus(e))),t}doDamage(e,t,s){const n=new c.Damage(s,i.default.DMG.MELEE);if(n.setSource(e),this.debugEnabled){const n=`${e.getName()}, ID: ${e.getID()}`;this._emitDbgMsg(`Dmg: ${s}, 'Melee' from ${n}`,t)}t.add(n),i.default.gameWarn({cell:e.getCell(),msg:e.getName()+" hits "+t.getName()})}getBiDirTarget(e,t){const[s,n]=[e.getX(),e.getY()],[r,a]=[t.getX(),t.getY()],o=s+-1*(r-s),i=n+-1*(a-n),l=e.getLevel().getMap();if(l.hasXY(o,i)){const t=l.getCell(o,i);if(t.hasActors()){const s=t.getActors();for(let t=0;t<s.length;t++)if(e.isEnemy(s[t]))return s[t]}}return null}checkForShieldSkill(e,t,s,n){if(n.has("Skills")){t/(t+(s-n.getShieldDefense()))>e&&l.SystemBase.addSkillsExp(n,"Shields",1)}}attIsCharmed(e,t){const s=t.getList("Charm");let n=!1;return s.forEach(t=>{const s=t.getTargetActor(),r=t.getLevel(),a=e.getWillpower();let o=r/(r+a);s!==i.default.NO_TARGET&&s===e.getID()&&(o=r/(r+a)*2,o>.8&&(o=.8)),i.default.isSuccess(o)&&(n=!0)}),n}_applyAddOnHitComp(e,t){const s=e.getWeapon();if(s&&s.has){if(s.has("AddOnHit")){const n=s.get("AddOnHit");if(n.getOnAttackHit()){const s=n.getCompToAdd();l.SystemBase.addCompToEntAfterHit(s,t,e)}}}else if(s&&s.onAttackHit){const n=e;s.onAttackHit(t,n)}else{const s=e;if(s&&s.has("AddOnHit")){const e=s.get("AddOnHit");if(e.getOnAttackHit()){const n=e.getCompToAdd();l.SystemBase.addCompToEntAfterHit(n,t,s)}}}}}t.SystemAttack=h},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemAttackRanged=void 0;const i=o(s(0)),l=s(3),c=a(s(2));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.ATTACK_RANGED,e,t)}updateEntity(e){const t=e.get("AttackRanged"),s=t.getTarget(),n=t.getAttacker(),r=n.getInvEq();let a=1;n.has("DoubleShot")&&(a=2);for(let t=0;t<a;t++){const t=r.unequipAndGetItem("missile",1,0);if(i.default.isNullOrUndef([t]))this.cmdNotPossible(e,"No missile equipped");else{if(t.has("Ammo")){const s=r.getEquipment().getEquipped("missileweapon");if(null===s){const t="No missile weapon equipped.";this.cmdNotPossible(e,t)}else{const r=t.getAmmoType(),a=s.getWeaponType();if(n.has("MixedShot")){const t=/bow/;if(!(t.test(r)&&t.test(a)||r===a)){const t="Ammo/weapon not compatible.";this.cmdNotPossible(e,t)}}else if(r!==a){const t="Ammo/weapon not compatible.";this.cmdNotPossible(e,t)}}}if(i.default.isNullOrUndef([s]))i.default.err("System.AttackMissile","updateEntity","No x,y given for missile.");else{const[r,a,o]=s.getXYZ(),l=new c.Missile(n);l.setTargetXYZ(r,a,o),l.setDamage(i.default.getMissileDamage(n,t)),l.setAttack(i.default.getMissileAttack(n)),l.setRange(i.default.getMissileRange(n,t)),t.add(l),e.get("Action").setEnergy(i.default.energy.MISSILE)}}}e.remove(t)}cmdNotPossible(e,t){e.get("Action").setMsg(t),e.get("Action").setStatus(-1),e.has("Player")&&e.add(new c.ImpossibleCmd)}}t.SystemAttackRanged=u},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemBaseAction=void 0;const i=o(s(0)),l=a(s(37)),c=s(3),u=s(10),h=s(142),d=s(66),f=a(s(2)),g=s(15),p=s(7),m=["Pickup","UseStairs","OpenDoor","UseItem","UseElement","Jump","Read","Rest","Give"];class y extends c.SystemBase{constructor(e,t){super(i.default.SYS.BASE_ACTION,e,t),this.compTypesAny=!0,this._dtable={Give:this._handleGive.bind(this),Jump:this._handleJump.bind(this),OpenDoor:this._handleOpenDoor.bind(this),Pickup:this._handlePickup.bind(this),Read:this._handleRead.bind(this),UseElement:this._handleUseElement.bind(this),UseItem:this._handleUseItem.bind(this),UseStairs:this._handleUseStairs.bind(this),Rest:this._handleRest.bind(this)}}updateEntity(e){m.forEach(t=>{e.has(t)&&(this._dtable[t](e),e.remove(t))})}_handleGive(e){const t=e.get("Give"),s=t.getGiveTarget(),n=t.getItem();if(s.isEnemy(e)){let t=s.getName()+" refuses to take ";t+=`${n.getName()} from ${e.getName()}`,i.default.gameMsg({cell:e.getCell(),msg:t})}else if(e.getInvEq().removeItem(n)){const t=e.getInvEq().getRemovedItem();s.getInvEq().addItem(t);if(t.has("QuestTarget")&&s.has("QuestTarget")){const n={actor:s,item:t},r=t.get("QuestTarget");d.SystemQuest.addQuestEvent(e,r,"give",n)}let r=e.getName()+" gives ";r+=`${n.getName()} to ${s.getName()}`,i.default.gameMsg({cell:e.getCell(),msg:r})}}_handlePickup(e){const[t,s]=[e.getX(),e.getY()],n=e.getLevel(),r=n.getMap().getCell(t,s);if(r.hasProp(i.default.TYPE_ITEM)){const a=r.getProp(i.default.TYPE_ITEM)[0];if(e.getInvEq().canCarryItem(a)){e.getInvEq().addItem(a);try{n.removeItem(a,t,s)}catch(t){let s=`Unable to remove item ${JSON.stringify(a)}\n`;s+="Actor for pickup: "+e.getName(),i.default.err("System.BaseAction","handlePickup",s)}let o=a.getName();a.getCount()>1&&(o+=" x"+a.getCount());const l={msg:e.getName()+" picked up "+o,cell:r};if(i.default.gameMsg(l),this._checkForAutoEquip(e,a),a.has("QuestTarget")){const t=a.get("QuestTarget");d.SystemQuest.addQuestEvent(e,t,"get")}}else{const t={msg:e.getName()+" cannot carry more weight",cell:r};i.default.gameMsg(t)}}const a={type:i.default.EVT_ITEM_PICKED_UP};this._createEventComp(e,a)}_checkForAutoEquip(e,t){const s=e.getInvEq().getMissile();if(s&&s.equals(t)&&e.getInvEq().equipNItems(t,t.getCount())){const s=t.getNameWithCount();i.default.gameMsg({cell:e.getCell(),msg:`${e.getName()} equips ${s}`})}}_handleUseStairs(e){const t=e.getLevel(),s=e.getCell(),n=g.Brain.getActorsAround(e);if(t.useStairs(e)){e.isPlayer()&&e.getBrain().addMark();const r=e.getLevel();if(r.has("QuestTarget")){const t=new f.QuestTargetEvent;t.setEventType("goto"),t.setTargetComp(r.get("QuestTarget")),e.add(t)}if(this.pool.emitEvent(i.default.EVT_LEVEL_CHANGED,{target:r,src:t,actor:e}),this.pool.emitEvent(i.default.EVT_LEVEL_ENTERED,{actor:e,target:r}),n.length>0){const s=g.Brain.getBoxOfFreeCellsAround(e,1);for(;n.length>0&&s.length>0;){const a=n.pop(),o=s.pop();if(t.removeActor(a)){const[t,s]=[o.getX(),o.getY()];r.addActor(a,t,s);const n=a.getName();i.default.gameMsg(`${n} follows ${e.getName()}`)}else{const e=JSON.stringify(a);i.default.warn("System.BaseAction","_handleUseStairs","Could not remove the actor: "+e)}}}const a={type:i.default.EVT_ACTOR_USED_STAIRS,cell:s};this._createEventComp(e,a)}}_handleOpenDoor(e){const t=e.get("OpenDoor").getDoor(),[s,n]=t.getXY(),r=e.getLevel().getCell(s,n);let a="";const o=e.getName();t.has("Broken")?a="Door is broken and does not move at all!":t.canToggle()?r.hasItems()?a="Door is blocked by an item":r.hasActors()?a="Door is blocked by someone":t.isOpen()?(t.closeDoor(),a=o+" closes a door."):(t.openDoor(),a=o+" opens a door."):a=o+" cannot toggle the door.",""!==a&&i.default.gameMsg({cell:r,msg:a})}_handleUseItem(e){const t=e.get("UseItem"),s=t.getItem(),n=t.getEffect();if(s.has("Broken")){const t=s.getName()+" cannot be used because it is broken";i.default.gameMsg({cell:e.getCell(),msg:t})}else{if(!n){if(s.has("OneShot"))if(1===s.getCount()){const e={item:s};this.pool.emitEvent(i.default.EVT_DESTROY_ITEM,e)}else s.decrCount(1);else s.getCharges&&s.getCharges()>0&&s.setCharges(s.getCharges()-1);this._checkUseItemMsgEmit(e,t)}if(n){const t=new f.Effects(n);e.add(t)}}}_handleUseElement(e){const t=e.get("UseElement"),s=t.getElement();s.has("Broken")||s.onUse&&s.onUse(e),this._checkUseElementMsgEmit(e,t)}_handleJump(e){const t=e.get("Jump"),[s,n]=[t.getX(),t.getY()];let r=2;e.has("Jumper")&&(r=e.get("Jumper").getJumpRange());const a=e.getLevel().getMap(),[o,i]=e.getXY(),l=o+s*r,c=i+n*r;if(u.Path.getShortestActorPath(a,o,i,l,c,(e,t)=>{const s=a.getCell(e,t);if(s.hasActors()){const e=s.getActors();for(let t=0;t<e.length;t++){if(!e[t].has("Ethereal"))return!1}}return p.Element.canJumpOver(s.getBaseElem().getType())}).length===r){const t=new f.Movement(l,c,e.getLevel());e.add(t)}}_handleRead(e){let t=e.get("Read").getReadTarget();if(!t){const s=e.getCell();if(s.hasItems()){const e=s.getItems().find(e=>"book"===e.getType());e&&(t=e)}}if(t){const s=t.getText(),n=new l.MenuInfoOnly;n.addPre(s);const r=t.getName();i.default.gameInfo(`The book "${r}" reads:`),e.getBrain().setSelectionObject&&e.getBrain().setSelectionObject(n)}else{const t=e.getName()+" finds nothing interesting to read.";i.default.gameMsg({cell:e.getCell(),msg:t})}if(t.has("QuestTarget")){const s=new f.QuestTargetEvent;s.setEventType("read"),s.setTargetComp(t.get("QuestTarget")),e.add(s)}}_handleRest(e){const t=e.getCell();if("bed"===t.getBaseElem().getType()){if(0===g.Brain.getSeenHostiles(e).length){e.get("Health").addHP(1);const s=e.getName()+" rests for a while in bed";i.default.gameMsg({cell:t,msg:s})}else{const s=e.getName()+" cannot rest with enemies around";i.default.gameMsg({cell:t,msg:s})}}else{const s=e.getName()+" seems to be resting.";i.default.gameMsg({cell:t,msg:s})}}_createEventComp(e,t){const s=new f.Event;s.setArgs(t),e.add(s)}_checkUseItemMsgEmit(e,t){if(t.getUseType()===i.default.USE.DRINK){const e=t.getItem(),s=function(e,t){if(e.target)return h.SystemEffects.getTargetFromObj(e,t);if(e.getCell)return e;return null}(t.getTarget(),t.getTargetType()),n=s.getCell(),r=s.getName()+" drinks "+e.getName();i.default.gameMsg({cell:n,msg:r})}}_checkUseElementMsgEmit(e,t){const s=t.getElement(),n=s.getName(),r=e.getCell();let a="";if(s.has("Broken"))a=n+" is broken, and cannot be used.";else if(t.getUseType()===i.default.USE.LEVER){a=e.getName()+" toggles the lever"}a&&i.default.gameMsg({cell:r,msg:a})}}t.SystemBaseAction=y},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemBattle=void 0;const i=o(s(0)),l=s(3),c=s(66),u=a(s(2)),h=s(96);class d extends l.SystemBase{constructor(e,t){super(i.default.SYS.BATTLE,e,t),this.compTypesAny=!0}updateEntity(e){if(e.has("BattleOver")){const t=e.get("BattleOver");if(e.has("BattleExp")){const t=e.get("BattleExp").getData(),s=t.name,n=this._getBadgeForBattle(s,e);if(t.kill>0)if(l.SystemBase.addSkillsExp(e,"Battle",t.kill),n)n.updateData({kill:t.kill});else{const e="No badge found for battle";i.default.err("System.Battle","updateEntity",e)}if(t.isTraitor&&n.updateDate({status:"Traitor"}),n.isWon()){let t=null;e.has("Reputation")?t=e.get("Reputation"):(t=new u.Reputation,e.add(t)),t.addToFame(1)}e.remove("BattleExp");const r=i.default.getLevel(e);if(e.has("Quest")&&r.has("QuestTarget")){const t=e.get("QuestTarget"),s={isWon:n.isWon()};c.SystemQuest.addQuestEvent(e,t,"battle",s)}}e.remove(t)}else if(e.has("BattleOrder")){const t=e.get("BattleOrder");this._emitMsg(e,t),e.remove(t)}else if(e.has("BattleEvent")){const t=e.get("BattleEvent");this._processBattleEvent(e,t),e.remove(t)}}_getBadgeForBattle(e,t){return t.getList("BattleBadge").find(t=>t.getData().name===e)}_emitMsg(e,t){const s=t.getArgs().srcActor.getName(),n=e.getCell(),r=s+" shouts a command into your direction.";i.default.gameMsg({msg:r,cell:n})}_processBattleEvent(e,t){const s={battle:t.getBattle()};h.emitZoneEvent(e,i.default.ZONE_EVT.BATTLE_OVER,s)}}t.SystemBattle=d},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemChat=void 0;const r=n(s(0)),a=s(3),o=s(106),i=s(66),l=s(141),c=s(38),u=[],h="<ERROR: You should not see this. A bug found >";class d extends a.SystemBase{constructor(e,t){super(r.default.SYS.CHAT,e,t),this.factFuncs={},this.registeredObjs={Trainer:!0,QuestGiver:!0},this.loreData={}}addLore(e,t){this.loreData[e]=t}updateEntity(e){const t=e.get("Chat").getArgs().dir,s=r.default.toActor(e),n=this.getActorsInDirection(s,t);let a=null;for(let t=0;t<n.length;t++){const o=n[t];if(o.isEnemy(s)){const e=this.getHostileMsg(s,o);r.default.gameMsg({cell:o.getCell(),msg:e})}else{if(Object.keys(this.registeredObjs).forEach(e=>{o.has(e)&&(a=a?this.appendToChatObj(a,s,o,e):this.getChatObject(s,o,e))}),!a){a=this.getGenericChatObject(e,o);const t=`You chat with ${o.getName()} for a while.`;r.default.gameMsg({cell:s.getCell(),msg:t})}o.has("QuestTarget")&&this.addQuestTargetItems(s,o,a),this.addQuestSpecificItems(s,o,a),s.getLevel().has("Lore")&&this.addLevelLoreItems(s,o,a),s.getLevel().getParentZone()&&(this.addGenericLoreItems(s,o,a),this.addZoneLoreItems(e,o,a))}}if(a){const e=s.getBrain(),t=a.getSelectionObject();e.setSelectionObject(t)}e.remove("Chat")}getActorsInDirection(e,t){const[s,n]=[t[0],t[1]],a=e.getX()+s,o=e.getY()+n,i=e.getLevel().getMap();if(i.hasXY(a,o)){const e=i.getCell(a,o);if(e.hasActors())return e.getActors();{const t="There is no one to talk to.";r.default.gameMsg({cell:e,msg:t})}}else{const t="There is no one to talk to.";r.default.gameMsg({cell:e.getCell(),msg:t})}return u.slice()}registerChatObject(e,t){"function"==typeof t&&(this.factFuncs[e]=t),this.registeredObjs[e]=!0}appendToChatObj(e,t,s,n){let a=e;e.getName()!==o.Chat.TOP_MENU&&(a=new o.ChatBase,a.setName(o.Chat.TOP_MENU),a.add({name:"Do you offer any special services?",option:e}));const i=this.getChatObject(t,s,n);if(i){const e=this.getChatQuestion(n);a.add({name:e,option:i})}else r.default.err("System.Chat","appendToChatObj","Failed to add new chat object with compType "+n);return a}getChatObject(e,t,s){if(this.factFuncs.hasOwnProperty(s))return this.factFuncs[s]();const n=t.get(s).getChatObj();n.setTarget(e);if(n.getSelectionObject())return n;{const e=t.getName();r.default.err("SystemChat","setChatObject",`Null/undef selectObj with type ${s}, src: ${e}`)}return null}getGenericChatObject(e,t){const s=new o.Chat.ChatBase,n=t.getName();return s.pre=n+" greets you. What do you say?",s}addQuestTargetItems(e,t,s){const n=t.get("QuestTarget");if("escort"===n.getTargetType()){const r=t.get("QuestEscortTarget");r.getEscortTo().getID()!==e.getLevel().getID()?s.add({name:r.getQuestion(),option:()=>{}}):s.add({name:"I have escorted you safely to correct place now",option:()=>{const s={src:t};i.SystemQuest.addQuestEvent(e,n,"escort",s)}})}}addQuestSpecificItems(e,t,s){if(e.has("Quest")){if(e.get("Quest").getQuestTargets().forEach(e=>{this.addQuestTargetToChat(e,t,s)}),t.has("QuestInfo")){const n=t.get("QuestInfo"),r=t.get("QuestTarget");s.add({name:n.getQuestion(),option:()=>{const s={info:n,src:t};i.SystemQuest.addQuestEvent(e,r,"listen",s)}})}if(e.has("QuestInfo")&&t.has("QuestTarget")){const n=t.get("QuestTarget"),r=e.getList("QuestInfo"),a=t=>{i.SystemQuest.addQuestEvent(e,n,"report",{info:t})};r.forEach(e=>{s.add({name:"Tell about "+e.getInfo(),option:a.bind(null,e)})})}t.has("QuestReport")&&s.add({name:"Tell about quest being completed",option:()=>{i.SystemQuest.addQuestEvent(e,t.get("QuestTarget"),"report")}})}}addQuestTargetToChat(e,t,s){const n=t.getName(),a=e.name;let o=null,i=!1;[i,o]=this.actorHasInMemory(e,t,s);const l={};if(!i){const e=t.getLevel().getParentZone();if(e.has("Lore")){e.getList("Lore").forEach(e=>{e.getKey({topic:"sideQuest"}).forEach(e=>{const{names:s}=e;s&&s.find(e=>e===a)&&(o=()=>{const s=this.getRespMsgFromEntry(t,e),a=this.getFormattedReply(t,"sideQuest",s),o=`${n} says: ${a}`;r.default.gameInfo(o)})})})}}if(""!==a){o||(o=()=>{const e=`${n} says: I don't know where ${a} is`;r.default.gameInfo(e)});const e=`Do you know where is ${a}?`;l[e]||(l[e]=!0,s.add({name:e,option:o}))}}addLevelLoreItems(e,t,s){t.getLevel().getList("Lore").forEach(n=>{n.getLoreTopics().forEach(a=>{const o={},i=n.getKey({topic:a});this.rng.shuffle(i),i.forEach(i=>{const l=this.getTopicQuestion(t,a,i);o[l]||(o[l]=!0,s.add({name:l,option:()=>{const s=this.getRespMsgFromEntry(t,i),o=this.getFormattedReply(t,a,s);this.checkEntryForRevealed(n,i),r.default.gameInfo({cell:e.getCell(),msg:o})}}))})})})}addGenericLoreItems(e,t,s){let n=0;const a=this.rng.arrayGetRand(l.Lore.genericTopics),o=l.Lore[a];let i="";for(;n<3;){const s=this.rng.arrayGetRand(o);if(this._meetsAllReq(s,e,t)){i=this.rng.arrayGetRand(s.text);break}++n}const c=e.getLevel(),u=l.formatMsg(i,{level:c,target:t,asker:e});s.add({name:"Have you heard anything interesting lately?",option:()=>{r.default.gameInfo({cell:e.getCell(),msg:u})}})}addZoneLoreItems(e,t,s){const n=t.getLevel().getParentZone();if(n.has("Lore")){n.getList("Lore").forEach(n=>{if(n.hasTopic("mainQuest")){const a=n.getKey({topic:"mainQuest"}),o=this.rng.arrayGetRand(a),i=this.getRespMsgFromEntry(t,o),l=this.getFormattedReply(t,"mainQuest",i);"string"==typeof l?s.add({name:"Can you tell me anything about the North?",option:()=>{this.checkEntryForRevealed(n,o),r.default.gameInfo({cell:e.getCell(),msg:l})}}):r.default.err("SystemChat","addZoneLoreItems","Expected msg to be string. Got "+JSON.stringify(i))}if(n.hasTopic("sideQuest")){const a=n.getKey({topic:"sideQuest"}),o=this.rng.arrayGetRand(a),i=this.getRespMsgFromEntry(t,o),l=this.getFormattedReply(t,"sideQuest",i);"string"==typeof l?s.add({name:"What can you tell me about this area?",option:()=>{this.checkEntryForRevealed(n,o),r.default.gameInfo({cell:e.getCell(),msg:l})}}):r.default.err("SystemChat","addZoneLoreItems","Expected msg to be string. Got "+JSON.stringify(l))}if(n.hasTopic("location")){const a=n.getKey({topic:"location"}),o=this.rng.arrayGetRand(a),i=this.getRespMsgFromEntry(t,o),l=this.getFormattedReply(t,"location",i);"string"==typeof l?s.add({name:"Are there any interesting places nearby?",option:()=>{this.checkEntryForRevealed(n,o),r.default.gameInfo({cell:e.getCell(),msg:l})}}):r.default.err("SystemChat","addZoneLoreItems","Expected msg to be string. Got "+JSON.stringify(l))}})}}getRespMsgFromEntry(e,t){let s=t.respMsg;if(!s&&t.msg&&r.default.err("System.Chat","getRespMsgFromEntry","entry.msg not supported. Use entry.respMsg from now on"),Array.isArray(s)&&(s=this.rng.arrayGetRand(s)),"string"==typeof s)return s;if(t.cmd)switch(t.cmd){case"queryLocationFromMemory":{const s=t.names[0],n=t.ids[0],r=e.getBrain().getMemory();if(r.hasSeen(n)){const{x:e,y:t}=r.getLastSeen(n);return{xy:[e,t],name:s}}return e.getID()===n?`I am ${s}. What do you need?`:`I haven't seen ${s} around here.`}default:r.default.err("System.Chat","getRespMsgFromEntry",`No cmd ${t.cmd} supported`)}else if(s.xy)return s;const n={msg:s,entry:t};return r.default.err("System.Chat","getRespMsgFromEntry","Only str/str[]/ILoreOpt msg supported in entry. Got: "+JSON.stringify(n)),h}getAskMsgFromEntry(e,t){if(t.msg){let e="entry.msg not supported. Use entry.askMsg from now on";e+=" Got: "+JSON.stringify(t.msg),r.default.err("System.Chat","getRespMsgFromEntry",e)}if(t.askMsg){const e=t.askMsg;if(Array.isArray(e))return this.rng.arrayGetRand(e);if("string"==typeof e)return e}return r.default.err("System.Chat","getAskMsgFromEntry","entry.askMsg does not exist"),h}actorHasInMemory(e,t,s){const n=t.getName(),a=e.name;let o=null;const i=e.id,l=t.getBrain().getMemory();if(l.hasSeen(i)){o=s.getSelectionObject();const{x:e,y:c}=l.getLastSeen(i);let u=`${n} says: I know where ${a} is.`;return u+=` I saw ${a} ${r.default.getTextualDir([e,c],t)} from here.`,r.default.gameInfo(u),[!0,o]}if("location"===e.targetType&&i===t.getLevel().getID()){o=s.getSelectionObject();const e=`This place is ${a}.`;return r.default.gameInfo(e),[!0,o]}return[!1,o]}_meetsAllReq(e,t,s){const n=new c.Constraints;let r=!0;if(e.level){const s=n.getConstraints(e.level);r=r&&s(t.getLevel())}if(e.target){const t=n.getConstraints(e.target);r=r&&t(s)}if(e.asker){const s=n.getConstraints(e.asker);r=r&&s(t)}return r}getChatQuestion(e){switch(e){case"QuestGiver":return"Can you give me some work to do?"}return"Do you know anything about "+e+"?"}getHostileMsg(e,t){const s=t.getName(),n=e.getType();return t.getBrain().getMemory().hasEnemyType(n)?`${s} shouts: 'Go away filthy ${n}!'`:s+" is hostile and refuses to talk."}checkEntryForRevealed(e,t){t.revealNames&&t.revealNames.forEach(s=>{const n={topic:"custom",askMsg:["Where can I find "+s+"?"],names:[s],cmd:"queryLocationFromMemory"};t.revealIds&&1===t.revealNames.length&&1===t.revealIds.length&&(n.ids=t.revealIds.slice()),e.hasEntry(n)||e.addEntry(n)})}getTopicQuestion(e,t,s){const n={quests:"Is anyone looking for help here?",places:"Do you know what places are nearby?",shops:"Is there a place for trading?",people:"What can you tell me about people here?",world:"Do you have any rumors from faraway lands?"};return n[t]?n[t]:"custom"===t?this.getAskMsgFromEntry(e,s):(r.default.err("system.chat.ts","getTopicQuestion","No match for topic "+t),h)}getFormattedReply(e,t,s){if(console.log(t+"| getFormattedReply msg is ",s),"string"==typeof s)return s;let n="";s.xy&&(n=r.default.getTextualDir(s.xy,e));let a="";switch(t){case"shops":a=e.has("Shopkeeper")?"You are already in my shop. Welcome!":`${s.name} should have a shop ${n} from here.`;break;case"custom":a=""!==n?`I saw ${s.name} ${n} from here.`:`I saw ${s.name} around, but don't remember where.`}return console.log(t+"| getFormattedReply return msg ",a),a}}t.SystemChat=d},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemCommunication=void 0;const r=n(s(0)),a=s(3);class o extends a.SystemBase{constructor(e,t){super(r.default.SYS.COMMUNICATION,e,t),this._msgFunc={Enemies:this.processEnemies.bind(this),Shout:this.processShout.bind(this)}}updateEntity(e){const t=e.get("Communication").getMsg();for(let s=0;s<t.length;s++)this.processMessage(e,t[s]);e.remove("Communication")}processMessage(e,t){this._msgFunc.hasOwnProperty(t.type)?this._msgFunc[t.type](e,t):r.default.err("CommunicationSystem","processMessage","No function for msg type |"+t.type+"| in dtable.")}processEnemies(e,t){const s=t.enemies,n=t.src.getName();for(let t=0;t<s.length;t++)e.addEnemy(s[t]);const a={cell:e.getCell(),msg:`${n} seems to communicate with ${e.getName()}`};r.default.gameInfo(a)}processShout(e,t){const s=t.shout,n=t.src.getName(),a={cell:t.src.getCell(),msg:`${n} shouts ${s}`};r.default.gameInfo(a)}}t.SystemCommunication=o},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemCrafting=void 0;const r=n(s(0)),a=s(3),o=s(6);class i extends a.SystemBase{constructor(e,t){super(r.default.SYS.CRAFTING,e,t),this.parser=o.ObjectShell.getParser()}updateEntity(e){e.getList("Crafting").forEach(t=>{this.processComp(e,t),e.remove(t)})}processComp(e,t){const s=e.getName(),n=t.getItem(),a=[{count:t.getCount(),name:n}],o=t.getArgs(),i=this.parser.get(r.default.TYPE_ITEM,n).recipe;i||r.default.err("SystemCrafting","processComp","No recipe found for "+n);const l=i;if(this.extractInputsFromEntity(e,l))a.forEach(t=>{const{count:r,name:a}=t;if(this.addOutputsToEntity(e,r,a),o&&o.hasOwnProperty("callback")){const e=`${s} succesfully crafted ${n}`;o.callback({msg:e,result:!0})}});else if(o&&o.hasOwnProperty("callback")){const e=`${s} does not have materials to craft ${n}`;o.callback({msg:e,result:!1})}}extractInputsFromEntity(e,t){let s=!0;return t.forEach(t=>{const{count:n,name:r}=t;this.entityHasInput(e,n,r)||(s=!1)}),s&&t.forEach(t=>{const{count:s,name:n}=t;this.removeInputsFromEntity(e,s,n)}),s}entityHasInput(e,t,s){return e.getInvEq().getItemsNamed(s).reduce((e,t)=>e+t.getCount(),0)>=t}removeInputsFromEntity(e,t,s){const n=e.getInvEq(),r=n.getItemsNamed(s);if(r.length>0){return n.removeNItems(r[0],t)}return!1}addOutputsToEntity(e,t,s){const n=e.getInvEq(),r=this.parser.createItem(s);r.setCount(t),n.addItem(r)}}t.SystemCrafting=i},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemDamage=void 0;const i=o(s(0)),l=s(3),c=a(s(2));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.DAMAGE,e,t)}processDamageComp(e,t){const s=e.get("Health");if(s){let n=this._getDamageModified(e,t);if(n<=0){n=0;const t="Attack doesn't penetrate protection of "+e.getName();i.default.gameMsg({msg:t,cell:e.getCell()})}else if(this._applyAddOnHitComp(e,t),s.decrHP(n),this.debugEnabled){const t=s.getMaxHP(),r=`(${n}),(${s.getHP()}/${t})`;i.default.gameDanger({msg:r,cell:e.getCell()})}const r=this._getUltimateDmgSource(t);if(r&&e.getID()!==r.getID()&&i.default.isActor(r)&&e.addEnemy(r),s.isDead()&&!e.has("Dead")&&!e.has("DeathEvent")){const s=new c.DeathEvent;if(s.setSource(r),t.isType(i.default.DMG.POISON)){const t=e.getName()+" dies horribly of poisoning";s.setMsg(t)}e.add(s)}if(r&&i.default.isActor(r)&&(r.isPlayer()||e.isPlayer())&&!i.default.isNullOrUndef([r,e])){const t=new c.Event;t.setArgs({type:i.default.EVT_ACTOR_DAMAGED,cause:r}),e.add(t),e.has("QuestTarget")&&this.checkForDamagedQuestEvent(e,r)}}}checkForDamagedQuestEvent(e,t){if("damage"===e.get("QuestTarget").getTargetType()){const s=new c.QuestTargetEvent;s.setEventType("damage"),s.setArgs({target:e}),s.setTargetComp(e.get("QuestTarget")),t.add(s)}}_getUltimateDmgSource(e){let t=e.getSourceActor();return t||(t=e.getSource()),t&&t.has&&t.has("Created")?t=t.get("Created").getCreator():t&&!t.has&&(console.log("Warning. No damageSrc.has():",t),i.default.err("System.Damage","_getUltimateDmgSource","No damageSrc.has()")),t}_getDamageModified(e,t){const s=t.getDamageType();let n=t.getSourceActor();n||(n=t.getSource());const r=this._getDmgAfterWeaknessAndResistance(e,t),a=e.getCell();if(s===i.default.DMG.POISON){const t="Poison is gnawing inside "+e.getName();return i.default.gameDanger({cell:a,msg:t}),r}if(s===i.default.DMG.HUNGER)return r;if(s===i.default.DMG.FIRE){const t=`Fire is burning ${e.getName()}.`;return i.default.gameDanger({cell:a,msg:t}),r}if(s===i.default.DMG.ICE){const t=`Ice is freezing ${e.getName()}.`;return i.default.gameDanger({cell:a,msg:t}),r}if(s===i.default.DMG.COLD){const t=e.getName()+" is extremely hypothermic";return i.default.gameInfo({cell:a,msg:t}),r}const o=t.getDamageCateg();if(o===i.default.DMG.MAGIC)return r;if(o===i.default.DMG.DIRECT)return r;if(this.isProtectionBypassed(e,n)){const t=`${n.getName()} hits ${e.getName()} through armor.`;return i.default.gameDanger({cell:a,msg:t}),r}return r-(e.getEquipProtection()+e.get("Combat").getProtection())}_getDmgAfterWeaknessAndResistance(e,t){const s=e.getName();let n=t.getDamage();if(e.has("Weakness")){e.getList("Weakness").forEach(s=>{if(this.effectMatches(t,s)){switch(s.getLevel()){case i.default.WEAKNESS.MINOR:n=Math.round(1.25*n);break;case i.default.WEAKNESS.MEDIUM:n=Math.round(1.5*n);break;case i.default.WEAKNESS.SEVERE:n*=2;break;case i.default.WEAKNESS.FATAL:n=e.get("Health").getMaxHP()}}})}if(e.has("Resistance")){let r="";e.getList("Resistance").forEach(s=>{if(this.effectMatches(t,s)){switch(s.getLevel()){case i.default.RESISTANCE.MINOR:n=Math.round(n/1.25),r+=" resists the attack slighty";break;case i.default.RESISTANCE.MEDIUM:n=Math.round(n/1.5),r+=" resists the attack";break;case i.default.RESISTANCE.STRONG:n=Math.round(n/2),r+=" resists the attack strongly";break;case i.default.RESISTANCE.IMMUNITY:n=0,r+=" is immune against the attack";break;case i.default.RESISTANCE.ABSORB:e.get("Health").addHP(n),r+=" absorbs the power of the attack";break}}}),""!==r&&(r=s+" "+r,i.default.gameMsg({msg:r,cell:e.getCell()}))}return n}effectMatches(e,t){const s=t.getEffect(),n=e.getDamageType(),r=e.getDamageCateg();return s===n||s===r}isProtectionBypassed(e,t){const s=this.rng.getUniform();return t&&!t.has&&(console.log("src is not entity:",t),console.log("With entity:",e),i.default.err("System.Damage","isProtectionBypassed","No src.has()")),t&&t.has("BypassProtection")?s<=t.get("BypassProtection").getChance():s<=i.default.PROT_BYPASS_CHANCE}_applyAddOnHitComp(e,t){const s=t.getWeapon();if(s&&s.has){if(s.has("AddOnHit")){const n=s.get("AddOnHit").getCompToAdd();l.SystemBase.addCompToEntAfterHit(n,e,t.getSource())}}else if(s&&s.onHit){const n=t.getSource();s.onHit&&s.onHit(e,n)}else{const s=t.getSource();if(t.getDamageCateg()!==i.default.DMG.EFFECT&&s&&s.has("AddOnHit")){const t=s.get("AddOnHit").getCompToAdd();l.SystemBase.addCompToEntAfterHit(t,e,s)}}}updateEntity(e){e.getList("Damage").forEach(t=>{this.processDamageComp(e,t),e.remove(t)})}}t.SystemDamage=u},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemDeath=void 0;const i=o(s(0)),l=s(3),c=a(s(2)),u=a(s(26)),h=s(6),d=i.default.NO_DAMAGE_SRC;class f extends l.SystemBase{constructor(e,t){super(i.default.SYS.DEATH,e,t),this.enableRandomLootDrops=!0,this.normalLootChance=.07,this.betterLootChance=.03,this.traceID=686,this.debugEnabled=!0,this.disableEventEmit=!1}updateEntity(e){const t=e.get("DeathEvent"),s=t.getSource();if(e.has("Loot")){const t=e.getCell();e.get("Loot").dropLoot(t)}this._dropInvAndEq(e),this._killActor(s,e,t),e.remove(t)}_killActor(e,t,s){const n=t.getLevel(),r=t.getCell();if(t.add(new c.Dead),this.debugEnabled){let e="Killing actor now";e+=JSON.stringify(t.getCompList()),this._emitDbgMsg(e,t)}if(n.removeActor(t)){const a=t.getName();t.has("Experience")&&this._giveExpToSource(e,t);const o=s.getMsg();o&&i.default.gameDanger({cell:r,msg:o});let l="killed";t.has("NonSentient")&&(l="destroyed");let u=a+" was "+l;e!==d&&(u+=" by "+e.getName()),i.default.gameDanger({cell:r,msg:u}),this.disableEventEmit||(this.pool.emitEvent(i.default.EVT_ACTOR_KILLED,{actor:t}),t.isPlayer()&&this.pool.emitEvent(i.default.EVT_PLAYER_KILLED,{actor:t}));const h=new c.Event;h.setArgs({type:i.default.EVT_ACTOR_KILLED,cause:e}),t.add(h),this.enableRandomLootDrops&&this._genRandomLootDrop(t,n,r,e),this._dropActorCorpse(t,n,r,e),this._cleanUpComponents(t)}else i.default.err("System.Damage","killActor","Couldn't remove actor")}_giveExpToSource(e,t){if(e!==d&&!e.has("Dead")){const s=t.get("Experience").getExpLevel(),n=t.get("Experience").getDanger();if(e.has("Experience")){const t=new c.ExpPoints(s+n);e.add(t),e.get("Experience").incrNumKilled()}else console.log(`Killer was ${e.getName()} without Experience`);e.has("InBattle")&&(this._giveBattleExpToSource(e),t.has("InBattle")&&this._checkIfKillerIsTraitor(e,t))}}_giveBattleExpToSource(e){if(!e.has("BattleExp")){const t=e.get("InBattle").getData();if(t){const s=t.name,n=new c.BattleExp;n.setData({kill:0,name:s}),e.add(n)}else{const t="Actor: "+JSON.stringify(e);i.default.err("System.Damage","_giveBattleExpToSource","InBattle data is null. Actor: "+t)}}e.get("BattleExp").getData().kill+=1}_checkIfKillerIsTraitor(e,t){const s=e.get("InBattle").getData(),n=t.get("InBattle").getData();s.army===n.army&&(s.isTraitor=!0)}_dropInvAndEq(e){const[t,s]=e.getXY();if(!e.getInvEq)return;const n=e.getInvEq(),r=n.getInventory().getItems(),a=e.getLevel();r.forEach(e=>{if(n.removeNItems(e,e.getCount())){const e=n.getRemovedItem();a.addItem(e,t,s)}});n.getEquipment().getItems().forEach(e=>{a.addItem(e,t,s)})}_cleanUpComponents(e){["Coldness","Expiration","Fading"].forEach(t=>{e.getList(t).forEach(t=>{"function"==typeof t.cleanup&&t.cleanup(),e.remove(t)})})}_cloneComponentsToCorpse(e,t){["Health","Stats","Combat","Experience"].forEach(s=>{const n=e.get(s).clone();t.add(n)});const s=["Undead"];e.hasAny(s)&&s.forEach(s=>{if(e.has(s)){const n=e.get(s).clone();t.add(n)}})}_dropActorCorpse(e,t,s,n){const r=e.getName(),[a,o]=s.getXY();if(e.has("Corporeal")){const s=new u.Corpse(r+" corpse");s.setActorName(e.get("Named").getBaseName()),this._cloneComponentsToCorpse(e,s);const l=i.default.getCssClass(i.default.TYPE_ACTOR,r);if(i.default.addCellStyle(i.default.TYPE_ITEM,s.getName(),l),t.addItem(s,a,o),e.has("QuestTarget")){const t=new c.QuestTargetEvent;t.setEventType("kill"),t.setArgs({corpse:s}),t.setTargetComp(e.get("QuestTarget")),n.add(t)}this._addSpawnableUndeadActor(e)}}_genRandomLootDrop(e,t,s,n){if(!function(e){if(/(animal)/.test(e.getType())){return e.get("Experience").getDanger()>=7}return!0}(e))return;if(!i.default.isSuccess(this.normalLootChance))return;const r=e.get("Experience").getExpLevel(),a=e.get("Experience").getDanger(),o=10*r+10*a;let l=10*r+30*a;i.default.isSuccess(this.betterLootChance)&&(l*=2);const c=h.ObjectShell.getParser().createRandomItem({func:e=>e.value>=o&&e.value<=l});if(c){const[e,n]=s.getXY();t.addItem(c,e,n)||i.default.warn("System.Death","_genRandomLootDrop",`Failed to add item to ${e},${n}`)}}_addSpawnableUndeadActor(e){if("undead"===e.getType()||e.has("Undead"))return;const t=e.get("Named").getBaseName(),s=h.ObjectShell.getParser(),n=s.dbGet({name:t,categ:i.default.TYPE_ACTOR});if(n){const e=n,t=JSON.parse(JSON.stringify(e));t.type="undead",t.enemies=i.default.ACTOR_RACES,t.tag="killed",t.addComp?Array.isArray(t.addComp)?t.addComp.push("Undead"):t.addComp=[t.addComp,"Undead"]:t.addComp=["Undead"],t.name="undead "+t.name,t.color={fg:"Cyan",bg:"Black"},s.hasObj(i.default.TYPE_ACTOR,t.name)||s.parseObjShell(i.default.TYPE_ACTOR,t)}}}t.SystemDeath=f},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemDrainStats=void 0;const i=o(s(0)),l=s(3),c=a(s(2));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.DRAIN_STATS,e,t)}updateEntity(e){e.getList("DrainStat").forEach(t=>{this.processDrainComp(e,t),e.remove(t)})}processDrainComp(e,t){if(t.applyComp()){let s=t.getDrainMsg();if(""!==s){s=t.getSource().getName()+" "+s+" "+e.getName(),i.default.gameMsg({cell:e.getCell(),msg:s})}}if(e.remove(t),e.has("Health")){if(e.get("Health").isDead()&&!e.has("Dead")&&!e.has("DeathEvent")){const s=new c.DeathEvent;s.setSource(t.getSource());let n=e.getName()+" is drained out of life";n+=" permanently",s.setMsg(n),e.add(s)}}}}t.SystemDrainStats=u},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemDisability=void 0;const i=o(s(0)),l=s(3),c=a(s(2)),u={Entrapped:{Attack:"cannot attack while trapped",AttackRanged:"cannot attack while trapped",Movement:"cannot move while trapped",SpellCast:"cannot cast spells while trapped"},Paralysis:{Attack:"cannot attack under paralysis",AttackRanged:"cannot attack while trapped",Movement:"cannot move under paralysis",SpellCast:"cannot cast spells under paralysis"},Stun:{Attack:"is too stunned to attack",AttackRanged:"cannot attack while trapped",Movement:"is stunned, and stumbles",SpellCast:"is too stunned to cast spells"}};class h extends l.SystemBase{constructor(e,t){super(i.default.SYS.DISABILITY,e,t),this.compTypesAny=!0,this._dispatchTable={Entrapped:{Attack:e=>{e.remove("Attack"),this._emitMsg("Paralysis","Attack",e)},AttackRanged:e=>{e.remove("AttackRanged"),this._emitMsg("Entrapped","AttackRanged",e)},Movement:e=>{this._handleEntrapped(e)},SpellCast:e=>{e.remove("SpellCast"),this._emitMsg("Entrapped","SpellCast",e)},UseStairs:e=>{e.remove("UseStairs"),this._emitMsg("Entrapped","UseStairs",e)}},Fear:{Attack:e=>{this._handleFear(e,"Attack")},Movement:e=>{this._handleFear(e,"Movement")}},Paralysis:{Attack:e=>{e.remove("Attack"),this._emitMsg("Paralysis","Attack",e)},AttackRanged:e=>{e.remove("AttackRanged"),this._emitMsg("Paralysis","AttackRanged",e)},Movement:e=>{e.remove("Movement"),this._emitMsg("Paralysis","Movement",e)},SpellCast:e=>{e.remove("SpellCast"),this._emitMsg("Paralysis","SpellCast",e)},UseStairs:e=>{e.remove("UseStairs"),this._emitMsg("Paralysis","Movement",e)}},Stun:{Attack:e=>{e.remove("Attack"),this._emitMsg("Stun","Attack",e)},AttackRanged:e=>{e.remove("AttackRanged"),this._emitMsg("Stun","AttackRanged",e)},Movement:e=>{const t=this.rng.getRandDir(),[s,n]=i.default.newXYFromDir(t,e);e.remove("Movement");if(e.getLevel().getMap().hasXY(s,n)){const t=new c.Movement(s,n,e.getLevel());e.add(t)}this._emitMsg("Stun","Movement",e)},SpellCast:e=>{e.remove("SpellCast"),this._emitMsg("Stun","SpellCast",e)},UseStairs:e=>{i.default.isSuccess(.5)&&(e.remove("UseStairs"),this._emitMsg("Stun","Movement",e))}}},this._compOrder=["Paralysis","Entrapped","Stun"],this._actComp=["Attack","AttackRanged","Movement","SpellCast","UseStairs"]}updateEntity(e){this._compOrder.forEach(t=>{e.has(t)&&this._actComp.forEach(s=>{e.has(s)&&this._dispatchTable[t][s](e)})})}_emitMsg(e,t,s){const n=s.getCell(),r=`${s.getName()} ${u[e][t]}`;i.default.gameMsg({cell:n,msg:r})}_handleEntrapped(e){const t=e.getCell(),s=t.getElements();if(!s)return void e.removeAll("Entrapped");const n=s.filter(e=>e.has("Entrapping"));let r=0;n.forEach(e=>{r+=e.get("Entrapping").getDifficulty()});const a=e.getStrength(),o=e.getAgility(),l=(a+o)/(a+o+r);if(i.default.isSuccess(l)){const s=e.getLevel();n.forEach(e=>{e.get("Entrapping").getDestroyOnMove()&&s.removeElement(e,e.getX(),e.getY())}),e.removeAll("Entrapped");const r=e.getName()+" breaks free from traps!";i.default.gameMsg({cell:t,msg:r})}else{e.remove("Movement");const s=e.getName()+" is trapped and cannot move!";i.default.gameMsg({cell:t,msg:s})}}_handleFear(e,t){const s=e.getList("Fear"),n=e.getBrain().getSeenEnemies();let r=0,a=null;if(s.forEach(e=>{const t=e.getTarget(),s=e.getFearLevel(),o=n.find(e=>e.getID()===t);o&&r<s&&(r=s,a=o)}),a){const s=e.getWillpower(),n=r/(s+r);if(i.default.isSuccess(n)){e.remove(t);const s=i.default.dXdY(a.getXY(),e.getXY()),[n,r]=i.default.newXYFromDir(s,e.getXY());if(e.getLevel().getMap().isPassable()){const t=new c.Movement(n,r,e.getLevel());e.add(t);const s=`${e.getName} panics, and runs away from ${a.getName()}`;i.default.gameMsg({cell:e.getCell(),msg:s})}else{const t=e.getName+" is paralysed by fear!";i.default.gameMsg({cell:e.getCell(),msg:t})}}}}}t.SystemDisability=h},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemEquip=void 0;const i=o(s(0)),l=s(3),c=a(s(13));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.EQUIP,e,t)}updateEntity(e){const t=e.get("Equip");t.getIsRemove()?this.unequipItem(e,t.getArgs()):this.equipItem(e,t.getArgs()),e.remove(t)}unequipItem(e,t){const s=t.slot,n=t.slotNumber,r=e.getInvEq();let a=!1,o=`Failed to remove item from slot ${s}.`;if("missile"===s){null!==r.getEquipment().getItem("missile")&&r.unequipItem(s,t.count)&&(a=!0)}else r.unequipItem(s,1,n)&&(a=!0);t.hasOwnProperty("callback")&&(a&&(o=`Unequipping from ${s} succeeded!`),t.callback({msg:o,result:a}));const i=r.getEquipment().getUnequipped(s,n);if(a&&i.has("AddOnEquip")){i.getList("AddOnEquip").forEach(t=>{this.handleAddOnEquip(e,t,!1)})}}equipItem(e,t){const s=e.getInvEq(),n=t.item;let r=!1,a="Failed to equip "+n.getName();if(n.getType().match(/^(missile|ammo)$/)?s.equipNItems(n,t.count)&&(r=!0):s.equipItem(n)&&(r=!0),t.hasOwnProperty("callback"))r&&(a=`Equipping ${n.getName()} succeeded!`),t.callback({msg:a,result:r});else{const t=`${e.getName()} equips ${n.getName()}`;i.default.gameMsg({msg:t,cell:e.getCell()})}if(r&&n.has("AddOnEquip")){n.getList("AddOnEquip").forEach(t=>{this.handleAddOnEquip(e,t)})}}handleAddOnEquip(e,t,s=!0){if(s){const s=t.getComp();if(s.setSource&&s.setSource(t.getEntity()),s.is("Duration")){const t=s.rollDuration(),n=s.getExpireMsg();c.addToExpirationComp(e,s,t,n)}else e.add(s);t.setAddedToActor(!0)}else{const s=t.getComp();if("number"==typeof s){const n=e.get(s);e.remove(s),t.setComp(n),t.setAddedToActor(!1)}else i.default.err("System.Equip","handleAddOnEquip","Expected comp ID number. Got: "+s)}}}t.SystemEquip=u},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemEvents=void 0;const r=n(s(0)),a=s(3),o=s(4);class i extends a.SystemBase{constructor(e,t){super(r.default.SYS.EVENTS,e,t),this.eventRadiusPerID={},this.eventRadius=10,this._dtable={[r.default.EVT_ACTOR_KILLED]:this._handleActorKilled.bind(this),[r.default.EVT_ITEM_PICKED_UP]:this._handleItemPickedUp.bind(this),[r.default.EVT_ACTOR_DAMAGED]:this._handleActorDamaged.bind(this),[r.default.EVT_ACTOR_ATTACKED]:this._handleActorAttacked.bind(this),[r.default.EVT_ACTOR_USED_STAIRS]:this._handleActorUsedStairs.bind(this)}}updateEntity(e){e.getList("Event").forEach(t=>{const s=t.getArgs(),{type:n}=s;let r=e.getCell();s.cell&&(r=s.cell);const a=this._getEventRadius(e),[i,l]=[r.getX(),r.getY()],c=o.Geometry.getBoxAround(i,l,a,!0);e.getLevel().getMap().getCellsWithCoord(c).forEach(s=>{const r=s.getActors();r&&r.forEach(s=>{if(!s.isPlayer()&&s.has("Perception")){s.getBrain().getSeenCells().find(e=>e.getX()===i&&e.getY()===l)&&this._dtable[n](e,t,s)}})}),e.remove(t)})}addLevel(e,t){this.eventRadiusPerID[e.getID()]=t}removeLevel(e){delete this.eventRadiusPerID[e.getID()]}_getEventRadius(e){const t=e.getLevel().getID();return this.eventRadiusPerID.hasOwnProperty(t)?this.eventRadiusPerID[t]:this.eventRadius}_handleActorKilled(e,t,s){if(e.isPlayer()){const n=t.getArgs().cause;if(n){const t=s.getName(),a=e.getName(),o=`${t} saw ${n.getName()} killing ${a}`;r.default.gameMsg({cell:e.getCell,msg:o})}}}_handleItemPickedUp(e,t,s){if(s.getID()!==e.getID()&&!s.isEnemy(e)){const t=e.getCell(),n=`${s.getName()} saw ${e.getName()} picking up an item.`;r.default.gameMsg({msg:n,cell:t})}}_handleActorDamaged(e,t,s){if(e.getID()!==s.getID()){const n=t.getArgs(),{cause:r}=n;this._addActorAsEnemy(r,e,s)}}_handleActorAttacked(e,t,s){if(e.getID()!==s.getID()){const n=t.getArgs(),{cause:r}=n;this._addActorAsEnemy(r,e,s)}}_handleActorUsedStairs(e,t,s){r.default.gameMsg(`${s.getName()} saw ${e.getName()} using stairs.`)}_addActorAsEnemy(e,t,s){e.getID()!==t.getID()&&(t.getType()===s.getType()?s.isEnemy(t)||t.isEnemy(s)||(s.isFriend(e)?(this._emitMsg("seems to dislike action",e,t,s),s.getBrain().getMemory().removeFriend(e)):(this._emitMsg("shows hatred against action",e,t,s),s.addEnemy(e))):s.isFriend(t)&&(this._emitMsg("shows hatred against action",e,t,s),s.addEnemy(e)))}_emitMsg(e,t,s,n){const a=t.getName(),o=s.getCell();let i=`${n.getName()} ${e} of ${a} `;i+=" towards "+s.getName(),r.default.gameMsg({cell:o,msg:i})}}t.SystemEvents=i},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemExpPoints=void 0;const r=n(s(0)),a=s(3),o=s(93);class i extends a.SystemBase{constructor(e,t){super(r.default.SYS.EXP_POINTS,e,t)}updateEntity(e){e.getList("ExpPoints").forEach(t=>{const s=e.get("Experience");let n=!0,a=s.getExp();for(a+=t.getExpPoints(),s.setExp(a);n;){const t=s.getExpLevel()+1;if(a>=r.default.getExpRequired(t)){r.default.levelUpActor(e,t);const s=e.getName();if(e.isPlayer()&&e.has("ActorClass")){const s=e.get("ActorClass").getClass(),n=o.ActorClass.getLevelUpObject(t,s);e.getBrain().setSelectionObject(n)}else{const t=s+" is more experienced now.";r.default.gameSuccess({msg:t,cell:e.getCell()})}n=!0}else n=!1}e.remove(t)})}}t.SystemExpPoints=i},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemFarming=void 0;const r=n(s(0)),a=s(3),o=s(95),i=s(6);class l extends a.SystemBase{constructor(e,t){super(r.default.SYS.FARMING,e,t),this.compTypesAny=!0}updateEntity(e){if(e.has("WorldSimEvent")){e.getList("WorldSimEvent").forEach(t=>{t.getEventType()===o.WS_EVENT.PHASE_CHANGED&&this._processPhaseChanged(e)})}}_processPhaseChanged(e){const t=e.getLevel();if(!t)return;t.getElements().slice().forEach(e=>{if(e.has("PlantedSoil")){const s=e.get("PlantedSoil");if(s.timeLeftToGrow-=1,0===s.timeLeftToGrow){const n=i.ObjectShell.getParser(),a=s.getGrowsInto(),o=n.createItem(a),[l,c]=e.getXY();t.addItem(o,l,c);const u=a+" is ready for harvesting";r.default.gameMsg({cell:e.getCell(),msg:u}),t.removeElement(e,l,c)}}})}}t.SystemFarming=l},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemHunger=void 0;const i=o(s(0)),l=s(3),c=a(s(2));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.HUNGER,e,t)}updateEntity(e){const t=e.get("Hunger"),s=e.get("Action");if(t.decrEnergy(s.getEnergy()),s.resetEnergy(),t.isStarving()&&e.has("Health")&&i.default.isSuccess(i.default.HUNGER_PROB)){const t=new c.Damage(i.default.HUNGER_DMG,i.default.DMG.HUNGER);e.add(t),i.default.gameWarn(e.getName()+" is starving!")}}}t.SystemHunger=u},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemMissile=void 0;const i=o(s(0)),l=s(3),c=a(s(2));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.MISSILE,e,t),this.criticalShot=i.default.MISSILE_CRITICAL_SHOT}updateEntity(e){const t=e.get("Missile"),s=t.getSource(),n=t.getLevel().getMap(),r=t.getTargetX(),a=t.getTargetY();let o=null;n.hasXY(r,a)&&(o=n.getCell(r,a));const c=this._formatFiredMsg(e,s);if(o&&o.hasProp("actors")){const e=o.getSentientActors()[0];s.getBrain().getMemory().setLastAttacked(e)}for(;t.isFlying()&&!t.inTarget()&&t.hasRange();){t.next();const r=t.getX(),a=t.getY(),o=t.getZ();let u=null;n.hasXY(r,a)&&(u=n.getCell(r,a));let h="";if(u)if(u.hasActors()||u.isPassableByAir(o))if(u.hasProp("actors")&&u.getZ()===o){const n=u.getActors()[0];if(this.targetWasHit(e,n,t)){this.finishMissileFlight(e,t,u),"function"==typeof t.onHit&&t.onHit(n);const r=this._addDamageToActor(n,t);i.default.debug(this,"Hit an actor"),h=`${c} ${r} ${n.getName()}`,n.has("Experience")&&("missile"===e.getType()?l.SystemBase.addSkillsExp(s,"Throwing",1):"ammo"===e.getType()&&l.SystemBase.addSkillsExp(s,"Archery",1)),i.default.gameWarn({cell:u,msg:h}),h=""}else if(t.inTarget()){this.finishMissileFlight(e,t,u),i.default.debug(this,"In target cell, and missed an entity");const s=u.getFirstActor();if(s){h=c+" misses "+s.getName()}else h=c+" misses the target"}else t.hasRange()||(this.finishMissileFlight(e,t,u),i.default.debug(this,"Missile out of range. Missed entity."),h=e.getName()+" does not reach the target")}else if(t.inTarget())this.finishMissileFlight(e,t,u),i.default.debug(this,"In target cell but no hits"),h=e.getName()+" doesn't hit anything";else if(t.hasRange()){if(u.hasProp("actors")&&u.getZ()<o){const t=u.getActors()[0];h=e.getName()+" flies over "+t.getName()}}else this.finishMissileFlight(e,t,u),i.default.debug(this,"Missile out of range. Hit nothing."),h=e.getName()+" doesn't hit anything";else{t.prev();const s=t.getX(),r=t.getY(),a=n.getCell(s,r);this.finishMissileFlight(e,t,a),i.default.debug(this,"Stopped missile to wall"),h=c+" thuds to an obstacle"}else{t.prev();const s=t.getX(),r=t.getY(),a=n.getCell(s,r);this.finishMissileFlight(e,t,a),h=c+" disappears"}h.length>0&&i.default.gameMsg({cell:u,msg:h})}}_addDamageToActor(e,t){let s="hits";const n=t.getDamage(),r=new c.Damage(n,i.default.DMG.MISSILE),a=t.getSource();r.setSource(a);let o=t.getDamage();return a.has("CriticalShot")&&i.default.isSuccess(this.criticalShot)&&(o*=2,s="critically hits"),r.setDamage(o),e.add(r),s}finishMissileFlight(e,t,s){t.stopMissile(),e.remove(t);const n=t.getLevel();let r=!0;if(t.destroyItem||(r=!1,e.has("Indestructible")||(t.destroyItem=this._isItemDestroyed(e))),t.destroyItem){if(!r){const t=e.getName()+" is destroyed!";i.default.gameMsg({cell:s,msg:t})}}else{let t=!1;if(s.hasItems()){s.getItems().forEach(s=>{t||(t=i.default.addStackedItems(s,e))})}t||n.addItem(e,s.getX(),s.getY())}const a={missile:t,item:e,to:[s.getX(),s.getY()],level:n},o=new c.Animation(a);e.add(o)}_isItemDestroyed(e){const t=e.getName(),s=this.rng.getUniform();return e.has("Ammo")?/(magic|ruby|permaice)/i.test(t)?s>.95:/(iron|steel)/i.test(t)?s>.9:s>.85:/rock/i.test(t)?s>.95:/(magic|ruby|permaice)/i.test(t)?s>.97:s>.95}_formatFiredMsg(e,t){let s="thrown";return e.has("Ammo")&&(s="shot"),`${e.getName()} ${s} by ${t.getName()}`}targetWasHit(e,t,s){if(t.has("Ethereal"))return!1;const n=s.getSource();if(n.has("ThroughShot")&&!s.inTarget())return!1;const r="missile"===e.getType();let a=s.getAttack();n.has("Skills")&&(a+=r?n.get("Skills").getLevel("Throwing"):n.get("Skills").getLevel("Archery"));let o=t.getDefense();t.has("Skills")&&(o+=t.get("Skills").getLevel("Dodge"));let c=a/(a+o);if(!n.isEnemy(t)&&!s.inTarget()){c=.15;const[e,s]=i.default.dXdYAbs(n,t);e<=1&&s<=1&&(c=0)}if(i.default.isSuccess(c)){if(t.has("RangedEvasion"))return i.default.isSuccess(.5);if(t.has("Deflection")){const s=`${t.getName()} deflects ${e.getName()}!`;return i.default.gameMsg({cell:t.getCell(),msg:s}),!1}return!0}return l.SystemBase.addSkillsExp(t,"Dodge",1),!1}}t.SystemMissile=u},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemMovement=void 0;const i=o(s(0)),l=s(3),c=a(s(2)),u=s(8),h=s(96),d=s(71),f=s(5)("bitn:System.Movement"),{addSkillsExp:g}=l.SystemBase,p={"light snow":u.ELEM.SNOW_LIGHT_TRACKS,snow:u.ELEM.SNOW_TRACKS,"deep snow":u.ELEM.SNOW_DEEP_TRACKS},m={"deep snow":"snow","deep snow with tracks":"snow","light snow":"snow","light snow with tracks":"snow","snow with tracks":"snow"};class y extends l.SystemBase{constructor(e,t){super(i.default.SYS.MOVEMENT,e,t),this.somethingSpecial=["QuestTarget"],this.climbRe=/highrock/,this._bonuses={}}checkMessageEmits(e,t){if(t.hasProp(i.default.TYPE_ELEM)){if(t.hasStairs()){const e=t.getStairs().getTargetLevel();let s="You see stairs here";if(e.getParent()){s+=". They seem to be leading to "+i.default.formatLocationName(e)}i.default.gameMsg(s)}else if(t.hasPassage()){const e=t.getPassage().getTargetLevel();let s=`You see a passage to ${i.default.getCardinalDirection(e,t)} here.`;if(e.getParent()){s+=". It seems to be leading to "+i.default.formatLocationName(e)}i.default.gameMsg(s)}else if(t.hasConnection()){const e=t.getConnection().getTargetLevel();let s="You see an entrance here";if(e.getParent()){s+=". It seems to be leading to "+i.default.formatLocationName(e)}i.default.gameMsg(s)}if(t.hasPropType("lever")&&i.default.gameMsg("There is a lever on the floor"),!e.hasShop()&&t.hasShop()){if(t.getShop().isAbandoned())i.default.gameMsg("This shop seems to be abandoned");else{const e="You can drop items to sell them here.";i.default.gameMsg("You have entered a shop. "+e)}}else if(t.hasShop()){t.getShop().isAbandoned()}}if(t.hasItems()){const e=t.getItems(),s=e[0];let n=s.getName();s.getCount()>1&&(n=`${n} (x${s.getCount()})`),e.length>1?i.default.gameMsg(`There are several items here. You see ${n} on top`):i.default.gameMsg("You see "+n+" on the floor"),s.has("Unpaid")&&(s.getCount()>1?i.default.gameMsg("They are for sale"):i.default.gameMsg("It is for sale"));for(let t=0;t<e.length;t++)if(e[t].hasAny(this.somethingSpecial)){const s=e[t].getName();i.default.gameMsg("There is something special about "+s)}}const s=t.getBaseElem();s.hasMsg("onEnter")&&i.default.gameMsg(s.getMsg("onEnter"))}updateEntity(e){const t=e.get("Movement"),[s,n]=t.getXY(),r=t.getLevel().getMap();if(!r.hasXY(s,n)){let t=`Tried to move to ${s},${n}.`;t+=" Entity: "+e.getName(),i.default.warn("System.Movement","updateEntity",t)}const a=r.getCell(s,n),o=e.getCell();let l=a.isFree(e.has("Flying"));const c=o.getBaseElem(),u=a.getBaseElem();if(Math.abs(u.getZ()-c.getZ())>1&&(e.has("Flying")||(l=!1)),l||(l=this._checkSpecialMovement(e,a)),l){const t=e.getXY();f.enabled&&i.default.debug(this,"Trying to move ent from "+t);const l=e.getPropType();if(r.moveProp(t,[s,n],l,e)){e.setXY(s,n),this.checkForStatsMods(e,o,a),e.isPlayer&&e.isPlayer()&&this.checkMessageEmits(o,a),a.hasElements()&&(e.isPlayer&&e.isPlayer()&&a.hasPropType("exploration")&&this._processExploreElem(e,a),this._checkEntrapment(e,a));const t=o.getBaseElem();if(t.has("Snowy")){const e=t.getType();p[e]&&o.setBaseElem(p[e])}}else this._fatalMoveError(e)}else e.get("Action").setStatus(i.default.ACTION_FAILED),i.default.debug(this,"Cell wasn't free at "+s+", "+n);e.remove(t),e.has("Movement")&&i.default.err("SystemMovement","updateEntity",`Ent ${e.getName()} has still MoveComp after one move`)}checkForStatsMods(e,t,s){const n=s.getBaseElem(),r=t.getBaseElem();let[a,o]=[r.getType(),n.getType()];m[a]&&(a=m[a]),m[o]&&(o=m[o]);const i=n.getName(),l=r.getName();if(r.has("Callbacks")&&b("onLeave",r,e),n.has("Callbacks")&&b("onEnter",n,e),l===i)return;let u=null;if(this._bonuses.hasOwnProperty(a)?u=this._bonuses[a]:r.has("Terrain")&&(u=r.get("Terrain").getMods(),u.mods=u),u){const t=e.getList("StatsMods"),s=e.getList("CombatMods");t.forEach(t=>{t.getTag()===a&&e.remove(t)}),s.forEach(t=>{t.getTag()===a&&e.remove(t)})}if(u=null,this._bonuses.hasOwnProperty(o)?u=this._bonuses[o]:n.has("Terrain")&&(u=n.get("Terrain").getMods(),u.mods=u),u){let t=!0;u.dontApplyTo&&u.dontApplyTo.forEach(s=>{e.has(s)&&(t=!1)}),t&&u.mods.forEach(t=>{let s=!0;if(t.dontApplyTo&&t.dontApplyTo.forEach(t=>{e.has(t)&&(s=!1)}),s)if(Number.isInteger(t.value)){const s=c.create(t.targetComp);s[t.targetFunc](t.value),s.setTag(o),e.add(s)}else{const s=e.get(t.srcComp);if(s){let n=s[t.srcFunc]();n=Math.round(t.value*n);const r=c.create(t.targetComp);r[t.targetFunc](n),r.setTag(o),e.add(r)}}})}}_checkSpecialMovement(e,t){const s=t.getBaseElem().getType();if(this.climbRe.test(s)&&e.has("Climber")){const s=e.getName()+" climbs the rocky terrain";return i.default.gameMsg({cell:t,msg:s}),!0}return!1}_processExploreElem(e,t){const s=e.getLevel(),[n,r]=[t.getX(),t.getY()],a=t.getPropType("exploration")[0];if(s.removeElement(a,n,r)){const n=a.getExp(),r=new c.ExpPoints(n);if(e.add(r),g(e,"Exploration",1),a.hasData()){const t=a.getData();t.zoneType&&e.get("GameInfo").addZoneType(t.zoneType)}const o=s.getParent();o&&e.get("GameInfo").addZone(o.getID());let l=a.getMsg("onEnter");if(l&&0!==l.length||(l=e.getName()+" has explored zone thoroughly."),i.default.gameInfo({cell:t,msg:l}),e.isPlayer()){e.getBrain().addMark()}h.emitZoneEvent(s,i.default.ZONE_EVT.ZONE_EXPLORED,{})}}_checkEntrapment(e,t){const s=t.getElements();s&&s.forEach(s=>{if(s.has("Entrapping")&&!e.has("Entrapped")){const n=s.get("Entrapping").getDifficulty(),r=e.getStrength(),a=e.getAgility(),o=(r+a)/(r+a+n);if(i.default.isSuccess(o)){let n=e.getName()+" avoids getting trapped";n+=` by ${s.getName()}!`,i.default.gameMsg({cell:t,msg:n})}else{e.add(new c.Entrapped);let n=e.getName()+" becomes trapped";n+=` by ${s.getName()}!`,i.default.gameMsg({cell:t,msg:n})}}})}_fatalMoveError(e){const[t,s]=e.getXY(),n=e.getLevel().getMap(),r=t+", "+s;this._diagnoseRemovePropError(t,s,n,e),e.has("Dead")&&console.log("WoW! Trying to move a Dead entity!"),i.default.err("MovementSystem","moveActorTo",`Couldn't remove ent |${e.getName()}, ID: ${e.getID()}| @ ${r}`)}_diagnoseRemovePropError(e,t,s,n){const r=n.getPropType();let a=-1,o=-1;for(let e=0;e<s.cols;e++)for(let t=0;t<s.rows;t++)s.removeProp(e,t,r,n)&&(a=e,o=t);const l=s.getCell(e,t);i.default.diag(`Cell at ${e},${t}:`),i.default.diag(l);const c=n.getCell();i.default.diag("Cell of the entity:"),i.default.diag(c),i.default.diag("System.Movement: diagnoseRemovePropError:");const u=n.getName();if(a>=0&&o>=0){const s=`\tEnt |${u}| found from |${`${a},${o} instead of ${e},${t}.`}|`;i.default.diag(s)}else{const e=`\tNo ent |${u}| found on entire map.`;i.default.diag(e)}}}t.SystemMovement=y;const _=new d.ObjectShellComps({debug:!1});function b(e,t,s){const n=t.get("Callbacks").cb(e);n&&n.addComp&&_.addComponents(n,s)}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemShop=void 0;const i=o(s(0)),l=s(3),c=a(s(26)),u=a(s(2)),{addSkillsExp:h}=l.SystemBase;class d extends l.SystemBase{constructor(e,t){super(i.default.SYS.SHOP,e,t)}updateEntity(e){const t=e.get("Transaction"),s=t.getArgs(),{buyer:n}=s;this._checkTransArgsOK(e,s),n.getID()===e.getID()?this.buyItem(s):this.sellItem(s),e.remove(t)}_checkTransArgsOK(e,t){const{item:s,buyer:n,shop:r,seller:a}=t;let o="";s||(o+="Item is null/undef. "),n||(o+="Buyer is null/undef. "),a||(o+="Seller is null/undef. "),r||(o+="Shop (element) is null/undef. "),""!==o&&(o+="Entity: "+e.getName(),i.default.err("System.Shop","_checkTransArgsOK",o))}buyItem(e){const{item:t,buyer:s,shop:n,seller:r}=e,a=s.getCell(),o=t.getValue()*n.getCostFactorSell(),l=i.default.valueToGoldWeight(o),u=i.default.getGoldInCoins(l);if(i.default.hasEnoughGold(s,l)){const e=new c.GoldCoin(i.default.GOLD_COIN_NAME),o=i.default.removeNCoins(s,u);if(e.setCount(o),!s.getInvEq().canCarryItem(t))return s.getInvEq().addItem(e),void i.default.gameMsg(s.getName()+" cannot carry more weight");r.getInvEq().addItem(e);r.getLevel().removeItem(t,n.getX(),n.getY())?(s.getInvEq().addItem(t),t.remove("Unpaid"),i.default.gameMsg({cell:a,msg:s.getName()+" bought "+t.getName()+" for "+u+" coins."}),h(r,"Trading",1)):i.default.err("System.Shop","buyItem","Could not remove item from level")}else i.default.gameMsg({cell:a,msg:s.getName()+" doesn't have enough money to buy "+t.getName()+" for "+u+" coins."})}sellItem(e){const{item:t,buyer:s,seller:n,shop:r}=e;if(n||i.default.err("System.Shop","sellItem","Seller is null or undefined."),!this.willingToBuyItem(t,s)){let r=t.getName();t.getCount()>1&&(r=i.default.pluralize(r));const a=`${s.getName()} is not interested in ${r}.`;return i.default.gameMsg({cell:n.getCell(),msg:a}),void(e.callback&&e.callback({msg:a,result:!1}))}const a=e.count||1,o=n.getCell(),l=a*t.getValue()*r.getCostFactorBuy(),d=i.default.valueToGoldWeight(l),f=i.default.getGoldInCoins(d);if(i.default.hasEnoughGold(s,d)){if(n.getInvEq().dropNItems(t,a)){const r=new c.GoldCoin(i.default.GOLD_COIN_NAME),a=i.default.removeNCoins(s,f);r.setCount(a),n.getInvEq().addItem(r);const l=n.getCell().getItems(),d=l[l.length-1];d.add(new u.Unpaid);const g=d.getName();if(i.default.gameMsg({cell:o,msg:n.getName()+" sold "+g+" for "+f+" coins."}),e.callback){const s=t.getName()+" was sold.";e.callback({msg:s,result:!0})}h(n,"Trading",1)}}else{const n=s.getName();if(i.default.gameMsg({cell:s.getCell(),msg:"Buyer "+n+" doesn't have enough gold to buy it."}),e.callback){const s=`Cannot sell ${t.getName()}.`;e.callback({msg:s,result:!1})}}}willingToBuyItem(e,t){return e.getName()!==i.default.GOLD_COIN_NAME}}t.SystemShop=d},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemSkills=void 0;const i=o(s(0)),l=s(3),c=a(s(2));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.SKILLS,e,t)}updateEntity(e){const t=e.getList("SkillsExp"),s=e.get("Skills"),n=e.getCell();t.forEach(t=>{const r=t.getSkill();s.hasSkill(r)||(s.addSkill(r),i.default.gameSuccess({cell:n,msg:`${e.getName()} learns a skill ${r}`}));const a=t.getPoints();s.addPoints(r,a);const o=s.getPoints(r),l=s.getLevel(r);if(o>=10*l){const t=e.getName();s.setLevel(r,l+1),s.resetPoints(r),i.default.gameSuccess({cell:n,msg:`${t} advances a skill ${r}`});const a=new c.ExpPoints(10*l);e.add(a),i.default.gameSuccess({cell:n,msg:`${t} gains experience from skill ${r}`})}e.remove(t)})}}t.SystemSkills=u},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemSpellCast=void 0;const r=n(s(0)),a=s(3),o=s(10),{addSkillsExp:i}=a.SystemBase;class l extends a.SystemBase{constructor(e,t){super(r.default.SYS.SPELL_CAST,e,t),this.compTypesAny=!0}updateEntity(e){const t=e.getName(),s=e.getCell();if(e.has("SpellPower")&&e.has("SpellCast")){const n=e.get("SpellCast"),a=e.get("SpellPower"),o=n.getSpell();if(o.getCastingPower()<=a.getPP()){const t=Object.values(this.entities).filter(e=>e.has("PowerDrain")),l=n.getArgs();if(a.decrPP(o.getCastingPower()),0===t.length)o.cast(l),i(e,"SpellCasting",1);else if(this._checkPowerDrain(o,l,t)){let e=`Spell ${o.getName()} was canceled by power drain of`;e+=" "+this._drainerName,r.default.gameMsg({cell:s,msg:e})}else o.cast(l),i(e,"SpellCasting",1)}else{const e=t+" has no enough power to cast spell";r.default.gameMsg({cell:s,msg:e})}e.remove("SpellCast")}}_checkPowerDrain(e,t,s){let n=!1;const r=t.src.getX(),a=t.src.getY();return this._drainerName="",s.forEach(s=>{if(s.getLevel().getID()===t.src.getLevel().getID()){const i=s.getX(),l=s.getY(),c=o.Path.shortestDist(r,a,i,l);if(s.getID()!==t.src.getID()&&c<=s.get("PowerDrain").drainDist){if(s.remove("PowerDrain"),n=!0,this._drainerName=s.getName(),s.has("SpellPower")){const t=e.getCastingPower();s.get("SpellPower").addPP(t)}return}}}),n}}t.SystemSpellCast=l},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemSpellEffect=void 0;const i=o(s(0)),l=s(3),c=a(s(2)),u=s(6),h=s(4),{addSkillsExp:d}=l.SystemBase,f=["SpellRay","SpellCell","SpellMissile","SpellArea","SpellSelf"];class g extends l.SystemBase{constructor(e,t){super(i.default.SYS.SPELL_EFFECT,e,t),this.compTypesAny=!0,this._dtable={SpellRay:this.processSpellRay.bind(this),SpellCell:this.processSpellCell.bind(this),SpellMissile:this.processSpellMissile.bind(this),SpellArea:this.processSpellArea.bind(this),SpellSelf:this.processSpellSelf.bind(this)}}updateEntity(e){f.forEach(t=>{if(e.has(t)){e.getList(t).forEach(s=>{this._dtable[t](e,s),e.remove(s)})}})}processSpellRay(e,t){const s=t.getArgs();let n=null;if(!i.default.isActor(e)){const t=JSON.stringify(e);return void i.default.err("SystemSpellEffect","processSpellRay","RayComps only supported on actors. Got: "+t)}n=e;const r=n.getLevel().getMap(),a=s.spell,o=a.getName();if(!s.from||!s.dir)return void i.default.err("SystemSpellEffect","processSpellRay","Args must have from and dir. Got "+JSON.stringify(s));let[l,u]=s.from;const[h,d]=s.dir;let f=a.getRange(),g=0;for(;f>0;)if(l+=h,u+=d,r.hasXY(l,u)){const e=r.getCell(l,u);if(a.onCellCallback&&a.onCellCallback(e),e.hasActors()){const t=e.getActors()[0],n=t.getName(),r=t.has("SpellStop");r||this.rayHitsActor(t,f)?(this._addDamageToActor(t,s),r?(f=0,i.default.gameMsg({cell:e,msg:`${o} is stopped by ${n}`})):a.stopOnHit&&(f=0),i.default.gameMsg({cell:e,msg:`${o} hits ${n}`})):i.default.gameMsg({cell:e,msg:`${o} misses ${n}`})}e.isSpellPassable()?++g:f=0,--f}else f=0;const p={dir:s.dir,ray:!0,from:s.from,range:g,className:i.default.getDmgClassName(s.damageType),level:n.getLevel()},m=new c.Animation(p);e.add(m)}rayHitsActor(e,t){if(!e.has("Health"))return!1;let s=e.get("Stats").getAgility();e.has("Skills")&&(s+=e.get("Skills").getLevel("Dodge")),s-=t,s<0&&(s=0);const n=(100-s)/100;return i.default.isSuccess(n)?!e.has("RangedEvasion")||i.default.isSuccess(.5):(d(e,"Dodge",1),!1)}processSpellCell(e,t){const s=t.getArgs(),n=i.default.toActor(e).getLevel().getMap(),r=s.spell.getName(),a=s.dir[0],o=s.dir[1],l=s.from[0]+a,u=s.from[1]+o;if(n.hasXY(l,u)){const t=n.getCell(l,u);if(s.preCallback&&s.preCallback(t),s.callback)s.callback(t);else if(t.hasActors()){const e=t.getActors()[0];if(s.targetComp){const n=s.set,a=s.get;if(e.has(s.targetComp)){const o=e.get(s.targetComp),l=e.getName();a?o[n](o[a()]+s.value):o[n](s.value),i.default.gameMsg({cell:t,msg:`Spell ${r} is cast on ${l}`})}}else if(s.addComp){const t=s.addComp.comp;if(t)if(s.addComp.duration){const n=s.addComp.duration;if(e.has("Expiration"))e.get("Expiration").addEffect(t,n);else{const s=new c.Expiration;s.addEffect(t,n),e.add(s)}e.add(t)}else e.add(t);else{const e=JSON.stringify(s);i.default.err("SystemSpellEffect","processSpellCell","args.addComp.comp must be defined. Args: "+e)}const n=t.getType(),r=`${e.getName()} seems to have ${n}`;i.default.gameMsg({cell:e.getCell(),msg:r})}else s.removeComp?s.removeComp.forEach(t=>{e.has(t)&&e.removeAll(t)}):(this._addDamageToActor(e,s),i.default.gameMsg({cell:t,msg:`${r} hits ${e.getName()}`}))}s.postCallback&&s.postCallback(t),p(e,s,[l,u])}}processSpellMissile(e,t){const s=t.getArgs(),n=s.spell,r=u.ObjectShell.getParser(),a=n.getAmmoName();a||i.default.err("System.SpellEffect","processSpellMissile","No |ammoName| set for spell "+n.getName());const o=r.createItem(a),l=new c.Missile(s.src);l.setTargetXYZ(s.to[0],s.to[1],s.to[2]),l.destroyItem=!0,s.hasOwnProperty("destroyItem")&&(l.destroyItem=s.destroyItem),l.setDamage(s.damage),l.setAttack(100),l.setRange(n.getRange()),s.onHit&&!t.onHit?l.onHit=s.onHit:t.onHit&&!s.onHit?l.onHit=t.onHit:t.onHit&&s.onHit&&i.default.err("SystemSpellEffect","processSpellMissile","onHit given in both SpellMissile and its args"),o.add(l)}processSpellArea(e,t){const s=t.getArgs(),n=s.spell,r=n.getRange(),[a,o]=[s.src.getX(),s.src.getY()],l=s.src.getLevel().getMap();h.Geometry.getBoxAround(a,o,r).forEach(e=>{if(l.hasXY(e[0],e[1])){const t=l.getCell(e[0],e[1]);if(t.hasActors()){const e=t.getActors();for(let r=0;r<e.length;r++){this._addDamageToActor(e[r],s),n.onCellCallback&&n.onCellCallback(t);const a=e[r].getName();i.default.gameMsg({cell:e[r].getCell(),msg:`${a} is hit by ${n.getName()}`})}}}});const u={range:r,cX:a,cY:o,className:i.default.getDmgClassName(s.damageType),level:i.default.toActor(e).getLevel()},d=new c.Animation(u);e.add(d)}processSpellSelf(e,t){const s=t.getArgs();if("function"==typeof s.callback)s.callback();else{let e="args.callback must be a function. ";e+="Got args: "+JSON.stringify(s),i.default.err("SystemSpellEffect","processSpellSelf",e)}p(e,s,e.getXY())}_addDamageToActor(e,t){const s=new c.Damage;s.setSource(t.src),s.setDamageType(t.damageType),s.setDamage(t.damage),s.setDamageCateg(i.default.DMG.MAGIC),s.setWeapon(t.spell),e.add(s)}}function p(e,t,s){let n=i.default.getDmgClassName(t.damageType);n||(n=i.default.getDmgClassName(i.default.DMG.MAGIC));const r={cell:!0,coord:[s],className:n,level:e.getLevel()},a=new c.Animation(r);e.add(a)}t.SystemSpellEffect=g},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemSpiritBind=void 0;const i=o(s(0)),l=s(3),c=a(s(2));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.SPIRIT,e,t),this.compTypesAny=!0}updateEntity(e){e.has("SpiritBind")&&this._doSpiritBind(e)}_doSpiritBind(e){const t=e.get("SpiritBind"),s=t.getBinder(),n=s.getName(),r=t.getTarget();if(e.hasSpirit()){if(r.hasItems())if(s.has("SpiritItemCrafter")){const t=r.getItems()[0],a=t.getName();if(t.has("GemBound")){const e=a+" has already a gem bound to it.";i.default.gameMsg({cell:r,msg:e})}else{const o=new c.GemBound,l=s.getInvEq().removeAndGetItem(e);o.setGem(l),t.add(o);const u=`${e.getName()} was bound to ${a} by ${n}`;i.default.gameMsg({cell:r,msg:u})}}else{const e=n+" cannot bind gems to items.";i.default.gameMsg({cell:r,msg:e})}}else{const t=r.getPropType("spirit");if(t.length>0){const s=t[0];s.get("Action").disable();s.getLevel().removeActor(s),e.setSpirit(s);const a=`${s.getName()} was bound to gem by ${n}`;i.default.gameMsg({cell:r,msg:a})}else{const e="There are no spirits to capture there!";i.default.gameMsg({cell:r,msg:e})}}e.remove("SpiritBind")}}t.SystemSpiritBind=u},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemTimeEffects=void 0;const i=o(s(0)),l=s(3),c=a(s(2));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.TIME_EFFECTS,e,t),this.compTypesAny=!0,this._dtable={},this._expiredEffects=[],this._dtable.Poison=this._applyPoison.bind(this),this._dtable.Fading=this._applyFading.bind(this),this._dtable.Heat=this._applyHeat.bind(this),this._dtable.Coldness=this._applyColdness.bind(this),this._dtable.DirectDamage=this._applyDirectDamage.bind(this),this._dtable.RegenEffect=this._applyRegenEffect.bind(this),this._dtable.Drowning=this._applyDrowningEffect.bind(this)}update(){for(const e in this.entities){if(!e)continue;const t=this.entities[e];for(let e=0;e<this.compTypes.length;e++)"Expiration"!==this.compTypes[e]&&t.has(this.compTypes[e])&&this._dtable[this.compTypes[e]](t);t.has("Expiration")&&this._decreaseDuration(t)}for(let e=0;e<this._expiredEffects.length;e++){const t=this._expiredEffects[e][0];this._expiredEffects[e][1].remove(t)}this._expiredEffects=[]}_decreaseDuration(e){e.getList("Expiration").forEach(t=>{t.decrDuration(),t.hasEffects()||this._expiredEffects.push([t.getID(),e])})}_applyPoison(e){e.getList("Poison").forEach(t=>{if(e.get("Health").isDead()){if(this._expiredEffects.push([t.getID(),e]),e.has("Expiration")){const s=e.get("Expiration");s.hasEffect(t)&&s.removeEffect(t)}}else if(i.default.isSuccess(t.getProb())){const s=t.rollDamage(),n=new c.Damage(s,i.default.DMG.POISON);n.setSource(t.getSource()),n.setDamageCateg(i.default.DMG.EFFECT),e.add(n)}})}_applyDirectDamage(e){e.getList("DirectDamage").forEach(t=>{if(e.get("Health").isDead()){if(this._expiredEffects.push([t.getID(),e]),e.has("Expiration")){const s=e.get("Expiration");s.hasEffect(t)&&s.removeEffect(t)}}else if(i.default.isSuccess(t.getProb())){const s=t.rollDamage(),n=new c.Damage(s,t.getDamageType());n.setDamageCateg(t.getDamageCateg()),n.setSource(t.getSource()),e.add(n);const r=t.getMsg();r&&i.default.gameMsg({cell:e.getCell(),msg:r})}})}_applyFading(e){const t=e.get("Fading");if(t.decrDuration(),t.getDuration()<=0){if(i.default.isActor(e)){const t=e.getCell();if(e.getLevel().removeActor(e)){this.pool.emitEvent(i.default.EVT_ACTOR_KILLED,{actor:e});const s=e.getName()+" disappears.";i.default.gameMsg({cell:t,msg:s})}else{const t=JSON.stringify(e);i.default.err("System.TimeEffects","_applyFading","Could not remove actor from level: "+t)}}else i.default.err("System.TimeEffects","_applyFading","Fading not handled for non-actors yet.");e.remove(t)}}_applyHeat(e){e.getList("Heat").forEach(t=>{const s=t.getLevel();if(e.has("Coldness")){const t=e.getCell();e.removeAll("Coldness");const s=`Thanks to heat, ${e.getName()} stops shivering`;if(e.has("BodyTemp")){e.get("BodyTemp").incr()}i.default.gameMsg({cell:t,msg:s})}if(e.has("Drenched")){const t=e.getCell(),n=e.get("Drenched");n.decrLevel(s);const r=e.getName()+" feels a bit drier due to warmth!";i.default.gameMsg({cell:t,msg:r}),n.isDry()&&e.remove(n)}}),e.removeAll("Heat")}_applyColdness(e){if(e.has("BodyTemp")){const t=e.get("BodyTemp");let s=1;if(e.has("Drenched")&&(s=Math.min(1,e.get("Drenched").getLevel())),t.decr(s),t.isFreezing()&&i.default.isSuccess(.1)){const t=new c.Damage(1,i.default.DMG.COLD);e.add(t)}if(t.isFrozen()){const t=new c.Damage(1,i.default.DMG.COLD);e.add(t)}}}_applyRegenEffect(e){e.getList("RegenEffect").forEach(t=>{let s=!0;if(t.getHP()>0){const n=t.getWaitHP();if(0===n){const n=e.get("Health");n&&(n.addHP(t.getHP()),n.getHP()<n.getMaxHP()&&(s=!1)),t.setWaitHP(t.getMaxWaitHP())}else t.setWaitHP(n-1)}if(t.getPP()>0){const n=t.getWaitPP();if(0===n){const n=e.get("SpellPower");n&&(n.addPP(t.getPP()),n.getPP()<n.getMaxPP()&&(s=!1)),t.setWaitPP(t.getMaxWaitPP())}else t.setWaitPP(n-1)}s&&e.remove(t)})}_applyDrowningEffect(e){e.get("Drowning");if(e.has("Health")){const t=5,s=new c.Damage(t,i.default.DMG.WATER);e.add(s)}}printMatchedType(e){for(let t=0;t<this.compTypes.length;t++)e.has(this.compTypes[t])&&i.default.debug(this.compTypes[t],"Has component")}}t.SystemTimeEffects=u},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemZoneEvents=void 0;const r=n(s(0)),a=s(3),o=s(30),i=s(91),l={NECROMANCER:1,ENCOUNTER:1};class c extends a.SystemBase{constructor(e,t){super(r.default.SYS.ZONE_EVENTS,e,t),this.legalArgs=["owMap","worldTop"],this._dtable={},this._dtable[r.default.ZONE_EVT.ZONE_EXPLORED]=this._processZoneExplored.bind(this),this._dtable[r.default.ZONE_EVT.BATTLE_OVER]=this._processBattleOver.bind(this),this._dtable[r.default.ZONE_EVT.QUEST_COMPLETED]=this._processQuestCompleted.bind(this),this._dtable[r.default.ZONE_EVT.CITY_WIPED]=this._processCityWipedOut.bind(this),this._dtable[r.default.ZONE_EVT.MOUNTAIN_CLIMBED]=this._processMountainClimbed.bind(this),this._dtable[r.default.ZONE_EVT.UNIQUE_KILLED]=this._processUniqueKilled.bind(this),this.zoneActionWeights=l}setWeights(e){this.zoneActionWeights=e}addEventProcessor(e,t){this._dtable[e]=t}updateEntity(e){e.getList("ZoneEvent").forEach(t=>{this._processEvent(e,t),e.remove(t)})}getAreaTile(e){const[t,s]=e.getTileXY();return this.worldTop.getCurrentArea().getTileXY(t,s)}getNewZoneAction(){return this.rng.getWeighted(this.zoneActionWeights)}_processEvent(e,t){const s=t.getEventType();if(this._dtable.hasOwnProperty(s))this._dtable[s](this,e,t);else{const e="Registered funcs: "+Object.keys(this._dtable).join(",");r.default.warn("SystemZoneEvents","_processEvent",`No callback function for evtType ${s}, ${e}`)}}_processZoneExplored(e,t,s){const n=t;u(e.getAreaTile(n).getLevel(),{name:"necromancer",levelUp:5})}_processBattleOver(e,t,s){const n=s.getEventData().battle,r=n.getLevel();u(r,{name:"necromancer",levelUp:5}),this._addBattleLore(r,n)}_processQuestCompleted(e,t,s){}_processCityWipedOut(e,t,s){}_processMountainClimbed(e,t,s){}_processUniqueKilled(e,t,s){}_addBattleLore(e,t){}}function u(e,t){const s=(new i.FactoryActor).createActorByName(t.name);if(s||r.default.err("system.zone-events.ts","addActorToLevel","Failed to create actor with "+JSON.stringify(t)),t.levelUp){const e=s.get("Experience").getExpLevel()+t.levelUp;r.default.levelUpActor(s,e)}return o.Placer.addEntityToCellType(s,e,e=>e.isFree())}t.SystemZoneEvents=c},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemWorldSim=void 0;const r=n(s(0)),a=s(3),o=s(95);class i extends a.SystemBase{constructor(e,t){super(r.default.SYS.WORLD_SIM,e,t),this.legalArgs=["owMap","worldSim","worldTop","territory"],this._dtable={},this._dtable[o.WS_EVENT.PHASE_CHANGED]=this._processPhaseChanged.bind(this),this._dtable[o.WS_EVENT.DAY_CHANGED]=this._processDayChanged.bind(this),this._dtable[o.WS_EVENT.MONTH_CHANGED]=this._processMonthChanged.bind(this),this._dtable[o.WS_EVENT.SEASON_CHANGED]=this._processSeasonChanged.bind(this),this._dtable[o.WS_EVENT.YEAR_CHANGED]=this._processYearChanged.bind(this),this.dayCount=0}updateEntity(e){e.getList("WorldSimEvent").forEach(t=>{this._checkEntityValid(e),this._processEvent(e,t),e.remove(t)})}_checkEntityValid(e){const t=r.default.getEntName(e);if(t!==r.default.WORLD_ENTITY){const e=t;r.default.err("System.WorldSim","updateEntity","Only actor WorldEntity can be added to System.WorldSim. Got: "+e)}}_processEvent(e,t){const s=t.getEventType();this._dtable.hasOwnProperty(s)&&this._dtable[s](e,t)}_processPhaseChanged(e,t){const s=t.getEventData();r.default.gameMsg(`It is ${s.currPhase} now.`)}_processDayChanged(e,t){}_processMonthChanged(e,t){}_processSeasonChanged(e,t){}_processYearChanged(e,t){}}t.SystemWorldSim=i},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemWeather=void 0;const i=o(s(0)),l=s(3),c=s(21),u=s(8),h=a(s(13)),d=["Coldness","Drenched"];class f extends l.SystemBase{constructor(e,t){super(i.default.SYS.WEATHER,e,t),this._effTable={snowStorm:this.handleSnowStorm=this.handleSnowStorm.bind(this),hailStorm:this.handleSnowStorm=this.handleSnowStorm.bind(this),snowFall:this.handleSnowFall=this.handleSnowFall.bind(this),warm:this.handleWarm=this.handleWarm.bind(this),rain:this.handleRain=this.handleRain.bind(this),coldRain:this.handleRain=this.handleRain.bind(this),"heavy rain":this.handleRain=this.handleRain.bind(this),clear:this.handleClear=this.handleClear.bind(this),sunny:this.handleClear=this.handleClear.bind(this),cloudy:this.handleClear=this.handleClear.bind(this)}}updateEntity(e){if(e.has("WeatherEffect")){const t=e.get("WeatherEffect"),s=t.getEffectType();this._effTable[s]&&(this._effTable[s](e,t),this.handleTemperature(e,t)),e.removeAll("WeatherEffect")}}handleTemperature(e,t){const s=i.default.getLevel(e),n=t.getTemperature();console.log("SystemWeather: Outdoor temperature is ",n);s.getActors().forEach(e=>{if(e.has("Location")&&e.get("Location").isValid()){let t=n;const s=e.getCell().getBaseElem();if(s.has("Indoor")&&(t+=10,"floorhouse"===s.getName()&&(t+=15),n>=15?t=n:t>15&&(t=15)),t<-15){e.getList("Coldness").length<2&&e.add(new h.Coldness)}else t<0&&!e.has("Coldness")&&e.add(new h.Coldness);t>=15&&e.hasAny(d)&&e.add(new h.Heat)}})}handleSnowFall(e,t){this.handleSnowStorm(e,t)}handleClear(e,t){}handleSnowStorm(e,t){const s=i.default.getLevel(e);if(s){const e=s.getMap(),t=e.getFree().filter(e=>!e.getBaseElem().has("Snowy"));c.MapGenerator.addRandomSnow(e,.1,t)>5&&i.default.gameMsg("It is snowing heavily!")}else i.default.err("SystemWeather","handleSnowStorm","Null level for ent: "+JSON.stringify(e))}handleRain(e,t){const s=i.default.getLevel(e);s.getMap();s.getActors().forEach(e=>{if(e.has("Location")&&e.get("Location").isValid()){if(!e.getCell().getBaseElem().has("Indoor")){if(!e.has("Drenched")){e.add(new h.Drenched);const t=e.getName()+" is drenched by the heavy rain!";i.default.gameInfo({cell:e.getCell(),msg:t})}e.get("Drenched").incrLevel()}}}),i.default.gameMsg("It is raining heavily outdoors")}handleWarm(e,t){this.handleMeltSnow(e,t)}handleMeltSnow(e,t){const s=e.getLevel().getMap().getFree().filter(e=>e.getBaseElem().has("Snowy"));s.forEach(e=>{if(this.rng.getUniform()<.1){const t=e.getBaseElem().getType(),s=u.snowMeltMap[t];e.setBaseElem(s)}}),s.length>0&&i.default.gameMsg("It is getting warmer. Snow and ice are melting")}}t.SystemWeather=f},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemOnCbs=void 0;const r=n(s(0)),a=s(3),o=s(96);class i extends a.SystemBase{constructor(e,t){super(r.default.SYS.ON_CBS,e,t),this.compTypesAny=!0,this.numRemoveComp={},this.numAddComp={}}updateEntity(e){let t=100;for(;e.has("OnAddCb");){const s=e.get("OnAddCb");if(this.processAddComp(e,s),e.remove(s),--t,0===t)break}for(t=100;e.has("OnRemoveCb");){const s=e.get("OnRemoveCb");if(this.processRemoveComp(e,s),e.remove(s),--t,0===t)break}}processAddComp(e,t){const s=t.getCompName();if(e.has("Callbacks")){const t=e.get("Callbacks"),n="onAdd"+s;if(t.hasCb(n)){const s=t.cb(n);o.executeCompCb(e,s)}}if(e.has("Location")){const t=e.get("Location");if(t.isValid()){const n=t.getCell().getBaseElem();if(n.has("Callbacks")){const t=n.get("Callbacks"),r="onAdd"+s+"Entity";if(t.hasCb(r)){console.log("addComp Processing "+r+"for "+n.getName());const s=t.cb(r);o.executeCompCb(e,s)}}}}this.numAddComp[s]||(this.numAddComp[s]=0),this.numAddComp[s]+=1}processRemoveComp(e,t){const s=t.getCompName();if(e.has("Callbacks")){const t=e.get("Callbacks"),n="onRemove"+s;if(t.hasCb(n)){const s=t.cb(n);o.executeCompCb(e,s)}}if(e.has("Location")){const t=e.get("Location");if(t.isValid()){const n=t.getCell().getBaseElem();if(n.has("Callbacks")){const t=n.get("Callbacks"),r="onRemove"+s+"Entity";if(t.hasCb(r)){console.log("removeComp Processing "+r+"for "+n.getName());const s=t.cb(r);o.executeCompCb(e,s)}}}}this.numRemoveComp[s]||(this.numRemoveComp[s]=0),this.numRemoveComp[s]+=1}}t.SystemOnCbs=i},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemMining=void 0;const i=o(s(0)),l=s(3),c=a(s(6)),u=s(38),h=s(507);class d extends l.SystemBase{constructor(e,t){super(i.default.SYS.MINING,e,t),this.parser=c.getParser()}updateEntity(e){e.getList("Mining").forEach(t=>{this.processComp(e,t),e.remove(t)})}processComp(e,t){const s=e.get("Location").getLevel(),n=s.get("Place"),r=n.getDepth();n.getDanger();if(r>0){const n=t.getTarget(),r=n.getBaseElem().getType(),a=h.Wall2Floor[r];if(a){n.setBaseElem(a);const t=h.Wall2Items[r];t.always.forEach(e=>{const t=this.parser.createItem(e);t&&s.addItem(t,n.getX(),n.getY())});let o="";if(t.rand){const r=t.rand;if(o=this.rng.getWeighted(r),""!==o&&"nothing"!==o){const t=this.parser.createItem(o);if(t){s.addItem(t,n.getX(),n.getY());let r=`${i.default.getName(e)} discovers ${t.getName()}`;r+=" while digging",i.default.gameMsg({cell:n,msg:r})}}}if("nothing"===o&&t.constraint){(new u.Constraints).getConstraints(t.constraint)}}}}}t.SystemMining=d},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(258),r=s(27),a=self;function o(e){const t={type:0,progress:e};a.postMessage(t)}a.addEventListener("message",(function(e){try{const t=e.data[0],s=new n.FactoryGame;s.setCallback("progress",o);const i=s.createNewGame(t).toJSON();r.verifySaveData(i);const l={type:1,ready:!0,data:JSON.stringify(i)};a.postMessage(l)}catch(e){const t={type:2,error:e.message};a.postMessage(t)}}))},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryGame=void 0;const i=o(s(0)),l=a(s(2)),c=a(s(57)),u=a(s(27)),h=a(s(32)),d=s(93),f=s(58),g=s(216),p=s(475),m=s(489),y=s(25),_=s(12),b=s(64),v=s(45),E=s(65),S=s(222),w=s(498),C=s(4),T=s(62),O=s(139),A=s(6),M=s(140),N=s(1),P=s(223),D=s(138),I=s(11),L=s(93),x=_.EventPool.getPool(),k=N.Random.getRNG(),R={Weak:{att:1,def:1,prot:1,hp:15},Medium:{att:2,def:4,prot:2,hp:25},Strong:{att:5,def:6,prot:3,hp:40},Inhuman:{att:10,def:10,prot:4,hp:80}};class B{constructor(){this._verif=new u.Conf("Factory.Game"),this._parser=A.ObjectShell.getParser(),this.presetLevels={},this.callbacks={},this._factBase=new b.FactoryBase}static getOwConf(e=1,t={}){const s=t.xMult||1,n=t.yMult||1,r={yFirst:!1,topToBottom:!1,stopOnWall:!0,nVWalls:[.8],owTilesX:s*e*40,owTilesY:n*e*40,worldX:s*e*400,worldY:n*e*400,nLevelsX:s*e*4,nLevelsY:n*e*4,nTilesX:s*e*4,nTilesY:n*e*4,verify:!0};return t.owConf&&Object.keys(t.owConf).forEach(e=>{r[e]=t.owConf[e]}),r}static getGameConf(){return{cols:60,rows:30,levels:2,seed:(new Date).getTime(),playerLevel:"Medium",levelSize:"Medium",playerClass:L.ACTOR_CLASSES[0],playerRace:i.default.ACTOR_RACES[0],sqrPerActor:120,sqrPerItem:120,playMode:"OverWorld",loadedPlayer:null,loadedLevel:null,playerName:"Player",world:D.WorldConf,xMult:1,yMult:1}}restoreGame(e){const t=new S.FromJSON,s=new w.GameMain;return t.createGame(s,e)}createNewGame(e){this._verif.verifyConf("createNewGame",e,["sqrPerItem","sqrPerActor","playMode"]);const t=new w.GameMain;if(Number.isInteger(e.seed)){const s=new N.Random(e.seed);t.setRNG(s)}const s=this.createPlayerUnlessLoaded(e);switch(this.createPlayerRegenEvents(t,s),e.playMode){case"Arena":return this.createArenaDebugGame(e,t,s);case"Battle":return this.createDebugBattle(e,t,s);case"World":return this.createFullWorld(e,t,s);case"OverWorld":return this.createOverWorldGame(e,t,s);case"Quests":return this.createQuestsDebugGame(e,t,s);default:return this.createEmptyGame(e,t,s)}}createEmptyGame(e,t,s){return e.levels&&(e.levels.forEach(e=>{const n=e.getExtras();if(t.addLevel(e),n.startPoint){const[t,r]=n.startPoint;e.addActor(s,t,r)}}),t.addPlayer(s)),t}createPlayerUnlessLoaded(e){let t=e.loadedPlayer;if(i.default.isNullOrUndef([t])){this._verif.verifyConf("createPlayerUnlessLoaded",e,["playerLevel","playerRace","playerName"]);const s=e.playerLevel,n=R[s];t=this._factBase.createPlayer(e.playerName,{att:n.att,def:n.def,prot:n.prot}),t.setType(e.playerRace),t.add(new l.Health(n.hp)),this.addActorClass(e,t),this.addRaceStuff(e,t),t.add(new l.Skills),t.add(new l.GameInfo),t.add(new l.BodyTemp),t.add(new l.Abilities)}if(t.has("Hunger")){const e=t.get("Hunger");t.remove("Hunger"),t.add(e)}else{const e=new l.Hunger(2e4);t.add(e)}return i.default.addCellStyle(i.default.TYPE_ACTOR,t.getName(),"cell-actor-player"),"Emilia"===e.playerName?i.default.addCharStyle(i.default.TYPE_ACTOR,t.getName(),"E"):"Oliver"===e.playerName&&i.default.addCharStyle(i.default.TYPE_ACTOR,t.getName(),"O"),t}createPlayerRegenEvents(e,t){const s=new c.RegenEvent(t,i.default.PLAYER_HP_REGEN_PERIOD*i.default.ACTION_DUR);if(e.addEvent(s),t.has("SpellPower")){const s=new c.RegenPPEvent(t,i.default.PLAYER_PP_REGEN_PERIOD*i.default.ACTION_DUR);e.addEvent(s)}}addActorClass(e,t){if(e.playerClass)if(d.ActorClass.hasOwnProperty(e.playerClass)){const s=new l.ActorClass,n=d.ActorClass.create(e.playerClass,t);s.setClassName(e.playerClass),s.setActorClass(n),t.add(s);const r=e.playerClass,a=d.ActorClass.getStartingItems(r),o=d.ActorClass.getEquipment(r);v.FactoryItem.addItemsToActor(t,a),v.FactoryItem.equipItemsToActor(t,o),n.setStartingStats(),n.advanceLevel()}else i.default.err("Factory.Game","addActorClass",e.playerClass+" not found in ActorClass.")}addRaceStuff(e,t){const{playerRace:s}=e;if(!g.ActorMods[s])return;const n=g.ActorMods[s].player,r=n.startingItems,a=n.equipment;v.FactoryItem.addItemsToActor(t,r),v.FactoryItem.equipItemsToActor(t,a);const{playerClass:o}=e;if(n.hasOwnProperty(o)){const e=n[o],s=e.startingItems,r=e.equipment;s&&v.FactoryItem.addItemsToActor(t,s),r&&v.FactoryItem.equipItemsToActor(t,r)}}setCallback(e,t){this.callbacks[e]=t}createOverWorldGame(e,t,s){const n=e.owMultiplier||1,r=B.getOwConf(n,e),a=Math.floor(r.nLevelsX/2),o=r.nLevelsY-1;r.playerX=a,r.playerY=o,r.playerRace=e.playerRace,r.createTerritory=!0;const l=(new Date).getTime();this.progress("Creating Overworld Tile Map...");const c=O.OWMap.createOverWorld(r);if(this.progress("DONE"),!c.hasTerrMap()){this.progress("Generating territory for clans/races...");const t=this.createTerritoryMap(c,e.playerRace,a,o);c.setTerrMap(t),this.progress("DONE")}this.progress("Creating Overworld Level Map...");const u=M.OverWorld.createOverWorldLevel(c,r),[d,f]=u;this.progress("DONE"),this.progress("Mapping settlements into territory areas.."),this.mapZonesToTerritoryMap(c.getTerrMap(),f),this.progress("DONE"),this.progress("Splitting Overworld Level Map into AreaTiles...");const g=T.Builder.splitLevel(d,r);this.progress("DONE"),this.progress("Creating and connecting World.Area tiles...");new h.Area("Ravendark",r.nLevelsX,r.nLevelsY,100,100,g).connectTiles(),this.progress("DONE");const p=new E.FactoryWorld;p.setOverWorld(c),p.setGlobalConf(e),t.setGlobalConf(e),p.setPresetLevels({Realm:g}),f.createAllZones=!1,this.progress("Creating places and local zones...");const m=g[a][o];this.modifyConfForHometown(f,s,m),this.createAreaLevelConstraints(f,c.getTerrMap());const y=p.createWorld(f);t.addPlace(y),c.clearSubLevels(),t.setOverWorld(c),t.setEnableChunkUnload(!0),this.progress("DONE"),this.progress("Adding player to the game..."),this.placePlayer(s,m),x.emitEvent(i.default.EVT_TILE_CHANGED,{actor:s,target:m}),s.setFOVRange(i.default.PLAYER_FOV_RANGE),t.addPlayer(s);let _="You have decided to venture outside your home village.";_+=" You feel there is something drawing you towards the North.",i.default.gameMsg("You have decided to venture outside your home village. You feel there is something drawing you towards the North."),this.progress("DONE");const b=(new Date).getTime()-l;return this.progress("World generation took "+b+" ms."),t}progress(e){const t=(new Date).getTime();let s=0;this.timePrev&&(s=(t-this.timePrev)/1e3),this.timePrev=t,this.callbacks.progress&&this.callbacks.progress(e),"DONE"===e&&i.default.log(`${this.prevMsg} - Time: ${s} sec`),this.prevMsg=e}placePlayer(e,t){const[s,n]=e.getXY();if(s>=0&&n>=0)return void t.addActor(e,s,n);const r=t.getMap().getFree(),a={};r.forEach(e=>{a[e.getKeyXY()]=!0});let o=null,l=!1,c=1e3;const u=Math.pow(5,2)-1;for(;!l;){o=k.arrayGetRand(r);const[e,t]=o.getXY(),s=C.Geometry.getBoxAround(e,t,2);s.length===u&&(l=!0);for(let e=0;e<s.length;e++){const[t,n]=s[e];l=l&&a[t+","+n]}if(--c<=0){i.default.log("Timeout reached");break}}l&&o?t.addActor(e,o.getX(),o.getY()):t.addActorToFreeCell(e)}createTerritoryMap(e,t,s,n){return P.TerritoryMap.create(e,t,[s,n])}mapZonesToTerritoryMap(e,t){const s=f.ActorsData.filter(e=>"UniqueBase"===e.base),n={};const r=this.getDisposition(),a=e.getMap();t.area[0].city.forEach(t=>{const{owX:o,owY:l}=t,c=a[o][l];let u=e.getName(c),h=null;if(u){if(h=[{op:"eq",prop:"type",value:[u]},{op:"neq",prop:"base",value:["WinterBeingBase"]}],"winterbeing"===u&&(h={op:"eq",prop:"base",value:["WinterBeingBase"]}),i.default.isSuccess(.07)){const e=s.filter(e=>e.type===u);if(e.length>0){const s=k.arrayGetRand(e);if(!n.hasOwnProperty(s.name)){const e={name:s.name,nLevel:0};let r=t.quarter[0].create;r||(r={}),r.actor||(r.actor=[]),r.actor.push(e),n[s.name]=s,t.hasUniques=!0,t.quarter[0].create=r}}}}else{const[t,s]=this.getAreaXYFromOWTileXY(o,l),n=this.getConstrWeightsForAreaXY(t,s,e),r=Object.keys(n);if(n.hasOwnProperty("winterbeing"))h={op:"eq",prop:"base",value:["WinterBeingBase"]};else if(r.length>0)u=k.getWeighted(n),h=[{op:"eq",prop:"type",value:[u]},{op:"neq",prop:"base",value:["WinterBeingBase"]}];else if(0===r.length){i.default.log("factory.game.js",e.mapToString());const n=`owX: ${o}, owY: ${l}`;i.default.err("FactoryGame","mapZonesToTerritoryMap",`No values for AreaTile ${t},${s}, ${n} found`)}}t.constraint||(t.constraint={}),t.constraint.actor=h,t.constraint.disposition=r[u],t.quarter.forEach(e=>{e.constraint||(e.constraint={}),e.constraint.actor=h,e.constraint.disposition=r[u],t.constraint.cellsAround&&(e.constraint.cellsAround=t.constraint.cellsAround)})})}getDisposition(){const e=new m.Disposition(i.default.ALL_RACES,{});return e.randomize(),e.getTable()}getAreaXYFromOWTileXY(e,t){return new M.OverWorld.CoordMap({xMap:10,yMap:10}).getAreaXYFromOWTileXY(e,t)}modifyConfForHometown(e,t,s){const n=e.area[0],r=n.city.find(e=>e.tags&&e.tags.indexOf("hometown")>=0);if(!r)return console.log(JSON.stringify(n.city,null,1)),void i.default.err("FactoryGame","modifyConfForHometown",'Unable to find city conf with "hometown" tag.');r.friendly=!0,r.quarter[0].create={actor:[{name:"chicken",num:15,nLevel:0}]},t.setXY(r.levelX,r.levelY),r.constraint?(r.constraint.actor=[{op:"eq",prop:"type",value:[t.getType()]},{op:"neq",prop:"base",value:["WinterBeingBase"]}],r.constraint.shop=[{op:"<=",prop:"value",value:50}],r.quarter[0].create||(r.quarter[0].create={}),r.quarter[0].create=Object.assign(r.quarter[0].create,{actor:[{name:"chicken",num:15,nLevel:0}]}),r.name+=", home town of "+t.getName()):i.default.err("FactoryGame","modifyConfForHometown","No homeConf.constraint found. Something went wrong in ow generation")}createAreaLevelConstraints(e,t){const s=e.area[0],n={};for(let e=0;e<s.maxX;e++)for(let r=0;r<s.maxY;r++){const s=this.getConstrWeightsForAreaXY(e,r,t),a=Object.keys(s);a.push("animal"),n[e+","+r]={actor:{op:"eq",prop:"type",value:a}},s.hasOwnProperty("winterbeing")&&(n[e+","+r].actor={op:"eq",prop:"base",value:"WinterBeingBase"})}s.constraint=n}getConstrWeightsForAreaXY(e,t,s){const n=s.getMap(),r=new M.CoordMap({xMap:10,yMap:10}).getOWTileBboxFromAreaTileXY(e,t),a=C.Geometry.getCellsInBbox(n,r),o=C.Geometry.histArrayVals(a);let i=Object.keys(o);i=i.filter(e=>"#"!==e&&"."!==e);const l={};return i.forEach(e=>{const t=s.getName(e);l[t]=o[e]}),l}createFullWorld(e,t,s){const n=e.world;if(this.processPresetLevels(n),!n)return i.default.err("Factory","createFullWorld","obj.world must exist!"),null;n.levelSize=e.levelSize;const r=new E.FactoryWorld;r.setGlobalConf(e),r.setPresetLevels(this.presetLevels);const a=r.createWorld(n),o=a.getLevels();let l={place:n.name,x:0,y:0};return n.playerStart&&(l=n.playerStart),o.length>0?(t.addPlace(a),t.addPlayer(s,l),t):(i.default.err("Factory","createFullWorld","There are no levels in the world!"),null)}processPresetLevels(e){if(this.presetLevels={},e.hasOwnProperty("presetLevels")){Object.keys(e.presetLevels).forEach(t=>{this.presetLevels[t]=this.createPresetLevels(e.presetLevels[t]),e.presetLevels[t]=this.presetLevels[t]})}}createPresetLevels(e){const t=new S.FromJSON;return e.map(e=>{if("function"==typeof e.level.getID)return e;const s=t.restoreLevel(e.level);return s.getID()<i.default.LEVEL_ID_ADD&&s.setID(I.Level.createLevelID()),s.getActors().forEach(e=>{e.getID()<i.default.ENTITY_ID_ADD&&e.setID(y.Entity.createEntityID())}),s.getItems().forEach(e=>{e.getID()<i.default.ENTITY_ID_ADD&&e.setID(y.Entity.createEntityID())}),i.default.setAllExplored(s),{nLevel:e.nLevel,level:s}})}createArenaDebugGame(e,t,s){return new p.DebugGame(this,this._parser).createArena(e,t,s)}createQuestsDebugGame(e,t,s){return new p.DebugGame(this,this._parser).createQuestsDebug(e,t,s)}createDebugBattle(e,t,s){return new p.DebugGame(this,this._parser).createDebugBattle(e,t,s)}createOneDungeonAndBoss(e,t,s){return new p.DebugGame(this,this._parser).createOneDungeonAndBoss(e,t,s)}}t.FactoryGame=B},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Lore=void 0;const r=n(s(0)),a=s(16).Component.DataComponent;t.Lore=a("Lore",{entries:null,tag:""}),t.Lore.prototype._init=function(){this.entries=[]},t.Lore.prototype.addEntry=function(e){if(e.msg){let t="entry.msg not supported. Use entry.respMsg from now on";t+=" Got: "+JSON.stringify(e.msg),r.default.err("Component.Lore","addEntry",t)}e.topic||(console.log("Entry was ",e),r.default.err("Component.Lore","addEntry","Given entry has no topic: "+JSON.stringify(e))),this.entries.push(e)},t.Lore.prototype.hasEntry=function(e){let t=!1;return this.getKey({topic:e.topic}).forEach(s=>{t=t||this.compareEntry(e,s)}),t},t.Lore.prototype.compareEntry=function(e,t){if(e.topic!==t.topic)return!1;if((e.askMsg||t.askMsg)&&e.askMsg!==t.askMsg)return!1;if((e.respMsg||t.respMsg)&&e.respMsg!==t.respMsg)return!1;if(e.names&&t.names){if(e.names.length!==t.names.length)return!1}else if(e.names||t.names)return!1;return!0},t.Lore.prototype.getKey=function(e){const t=[];return this.entries.forEach(s=>{let n=!1;Object.keys(e).forEach(r=>{s[r]===e[r]&&(n||t.push(s),n=!0)})}),t},t.Lore.prototype.getRespMsg=function(e){let t=[];return this.entries.forEach(s=>{if(s.topic===e){const e=s.respMsg;e&&(Array.isArray(e)?t=t.concat(e):t.push(e))}}),t},t.Lore.prototype.addTopic=function(e,t){const s={topic:e,respMsg:t};this.entries.push(s)},t.Lore.prototype.hasTopic=function(e){return this.getLoreTopics().indexOf(e)>=0},t.Lore.prototype.getLoreTopics=function(){const e=[];return this.entries.forEach(t=>{e.indexOf(t.topic)<0&&e.push(t.topic)}),e}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(144));class a extends r.default{constructor(e,t,s,n={}){super(e,t,s,n),this._todo=[],this._done={}}compute(e,t,s){for(this._todo=[],this._done={},this._fromX=e,this._fromY=t,this._add(this._toX,this._toY,null);this._todo.length;){const s=this._todo.shift(),n=s.x+","+s.y;if(n in this._done)continue;if(this._done[n]=s,s.x===e&&s.y===t)break;const r=this._getNeighbors(s.x,s.y);for(let e=0;e<r.length;e++){const t=r[e],n=t[0],a=t[1];n+","+a in this._done||this._add(n,a,s)}}let n=this._done[e+","+t];if(n)for(;n;)s(n.x,n.y,n.prev),n=n.prev}_add(e,t,s){const n=this._distance(e,t),r={x:e,y:t,prev:s,g:s?s.g+1:0,h:n},a=r.g+r.h;for(let e=0;e<this._todo.length;e++){const t=this._todo[e],s=t.g+t.h;if(a<s||a===s&&n<t.h)return void this._todo.splice(e,0,r)}this._todo.push(r)}_distance(e,t){switch(this._options.topology){case 4:return Math.abs(e-this._fromX)+Math.abs(t-this._fromY);case 6:const s=Math.abs(e-this._fromX),n=Math.abs(t-this._fromY);return n+Math.max(0,(s-n)/2);case 8:return Math.max(Math.abs(e-this._fromX),Math.abs(t-this._fromY))}}}t.default=a},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.AStar3D=void 0;const r=n(s(144));class a extends r.default{constructor(e,t,s,n,r={}){super(e,t,n,r),this._todo=[],this._done={},this._map=s}compute(e,t,s){for(this._todo=[],this._done={},this._fromX=e,this._fromY=t,this._fromZ=this._map.getZ(e,t),this._add(this._toX,this._toY,null);this._todo.length;){const s=this._todo.shift(),n=s.x+","+s.y;if(n in this._done)continue;if(this._done[n]=s,s.x===e&&s.y===t)break;const r=this._getNeighbors(s.x,s.y);for(let e=0;e<r.length;e++){const t=r[e],n=t[0],a=t[1];n+","+a in this._done||this._add(n,a,s)}}let n=this._done[e+","+t];if(n)for(;n;)s(n.x,n.y,n.prev),n=n.prev}_add(e,t,s){const n=this._map.getZ(e,t),r=this._distance(e,t,n,s);let a=0;s&&(a=Math.abs(s.z-n));const o={x:e,y:t,z:n,prev:s,g:s?s.g+1+a:0,h:r},i=o.g+o.h;for(let e=0;e<this._todo.length;e++){const t=this._todo[e],s=t.g+t.h;if(i<s||i===s&&r<t.h)return void this._todo.splice(e,0,o)}this._todo.push(o)}_distance(e,t,s,n){switch(this._options.topology){case 4:return Math.abs(e-this._fromX)+Math.abs(t-this._fromY);case 6:const n=Math.abs(e-this._fromX),r=Math.abs(t-this._fromY);return r+Math.max(0,(n-r)/2);case 8:{const n=Math.abs(e-this._fromX),r=Math.abs(t-this._fromY),a=Math.abs(s-this._fromZ);return Math.max(n+a,r+a)}}}}t.AStar3D=a},function(e,t,s){e.exports=function(e){function t(e){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return n.colors[Math.abs(t)%n.colors.length]}function n(e){let s;function o(...e){if(!o.enabled)return;const t=o,r=Number(new Date),a=r-(s||r);t.diff=a,t.prev=s,t.curr=r,s=r,e[0]=n.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let i=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(s,r)=>{if("%%"===s)return s;i++;const a=n.formatters[r];if("function"==typeof a){const n=e[i];s=a.call(t,n),e.splice(i,1),i--}return s}),n.formatArgs.call(t,e);(t.log||n.log).apply(t,e)}return o.namespace=e,o.enabled=n.enabled(e),o.useColors=n.useColors(),o.color=t(e),o.destroy=r,o.extend=a,"function"==typeof n.init&&n.init(o),n.instances.push(o),o}function r(){const e=n.instances.indexOf(this);return-1!==e&&(n.instances.splice(e,1),!0)}function a(e,t){const s=n(this.namespace+(void 0===t?":":t)+e);return s.log=this.log,s}function o(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return n.debug=n,n.default=n,n.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},n.disable=function(){const e=[...n.names.map(o),...n.skips.map(o).map(e=>"-"+e)].join(",");return n.enable(""),e},n.enable=function(e){let t;n.save(e),n.names=[],n.skips=[];const s=("string"==typeof e?e:"").split(/[\s,]+/),r=s.length;for(t=0;t<r;t++)s[t]&&("-"===(e=s[t].replace(/\*/g,".*?"))[0]?n.skips.push(new RegExp("^"+e.substr(1)+"$")):n.names.push(new RegExp("^"+e+"$")));for(t=0;t<n.instances.length;t++){const e=n.instances[t];e.enabled=n.enabled(e.namespace)}},n.enabled=function(e){if("*"===e[e.length-1])return!0;let t,s;for(t=0,s=n.skips.length;t<s;t++)if(n.skips[t].test(e))return!1;for(t=0,s=n.names.length;t<s;t++)if(n.names[t].test(e))return!0;return!1},n.humanize=s(263),Object.keys(e).forEach(t=>{n[t]=e[t]}),n.instances=[],n.names=[],n.skips=[],n.formatters={},n.selectColor=t,n.enable(n.load()),n}},function(e,t){var s=1e3,n=6e4,r=60*n,a=24*r;function o(e,t,s,n){var r=t>=1.5*s;return Math.round(e/s)+" "+n+(r?"s":"")}e.exports=function(e,t){t=t||{};var i=typeof e;if("string"===i&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var o=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*o;case"weeks":case"week":case"w":return 6048e5*o;case"days":case"day":case"d":return o*a;case"hours":case"hour":case"hrs":case"hr":case"h":return o*r;case"minutes":case"minute":case"mins":case"min":case"m":return o*n;case"seconds":case"second":case"secs":case"sec":case"s":return o*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return o;default:return}}(e);if("number"===i&&isFinite(e))return t.long?function(e){var t=Math.abs(e);if(t>=a)return o(e,t,a,"day");if(t>=r)return o(e,t,r,"hour");if(t>=n)return o(e,t,n,"minute");if(t>=s)return o(e,t,s,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=a)return Math.round(e/a)+"d";if(t>=r)return Math.round(e/r)+"h";if(t>=n)return Math.round(e/n)+"m";if(t>=s)return Math.round(e/s)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GoalThief=t.GoalSearchHouse=void 0;const i=o(s(0)),l=s(54),c=s(1),u=s(15),h=a(s(2)),{GOAL_ACTIVE:d,GOAL_COMPLETED:f}=l.GoalStatus,g=c.Random.getRNG();class p extends l.GoalBase{constructor(e){super(e),this.setType("GoalSearchHouse");const t=e.getCell();t.hasDoor()&&(this.door=t.getXY()),this.subGoals=[],this.searchTime=g.getUniformInt(20,40)}activate(){this.status=d;const e=this.actor.getBrain().getSeenCells();this.floorCells&&0!==this.floorCells.length||(this.floorCells=e.filter(e=>"floorhouse"===e.getBaseElem().getType()));let t=y(this.actor,e);if(!t&&this.floorCells.length>0){const e=g.arrayGetRand(this.floorCells);t=new l.Goal.FollowPath(this.actor,e.getXY())}if(this.searchTime<=0){const e=this.actor.getCell();if(e.hasDoor()){const e=u.Brain.getCellsAroundActor(this.actor);let t=null;e.forEach(e=>{"floorhouse"!==e.getBaseElem().getType()&&e.isPassable()&&(t=e)}),t?(l.Goal.moveActorTo(this.actor,t),this.status=f):i.default.warn("Goal.SearcHouse","activate","Could not move out of the house")}else t=l.Goal.FollowPath(this.actor,e.getXY())}t&&this.addSubGoal(t)}process(){return this.activateIfInactive(),--this.searchTime,this.hasSubGoals()?this.status=this.processSubGoals():(this.activate(),this.status!==f&&(this.status=this.processSubGoals())),this.status}}t.GoalSearchHouse=p;class m extends l.GoalBase{constructor(e){super(e),this.setType("GoalThief"),this.subGoals=[],this.shopCooldown=20,this.doorCooldown=25,this.visitedDoors={},this.shops={}}activate(){this.status=d,this.chooseThiefTask()}process(){return this.activateIfInactive(),--this.shopCooldown,--this.doorCooldown,this.isCompleted()?f:(this.hasSubGoals()?this.status=this.processSubGoals():(this.chooseThiefTask(),this.hasSubGoals()?this.status=this.processSubGoals():this.status=f),this.status)}isInActiveShop(){const e=this.actor.getCell();if(e&&e.hasShop()){const t=e.getShop();if(t&&!t.isAbandoned())return this.shops[e.getKeyXY()]=e,!0}return!1}tryToSellItem(){const e=this.actor.getInvEq().getInventory(),t=g.arrayGetRand(e.getItems()),s=this.actor.getCell();if(s&&t){const e=s.getPropType("shop")[0],n=new h.Transaction;n.setArgs({item:t,seller:this.actor,shop:e,buyer:e.getShopkeeper(),count:t.getCount()}),this.actor.add(n)}else i.default.err("Goal.Thief","tryToSellItem","Null item for sale. Inv: "+JSON.stringify(e))}tryToGoToShopCell(){let e=null;const t=Object.values(this.shops);if(t.length>0){const e=g.arrayGetRand(t);return new l.Goal.FollowPath(this.actor,e.getXY())}const s=this.actor.getBrain().getSeenCells();for(let t=0;t<s.length;t++){const n=s[t];n.hasShop()&&(e=new l.Goal.FollowPath(this.actor,n.getXY()))}return e||(this.shopCooldown=20),e}chooseThiefTask(){const e=!this.actor.getInvEq().getInventory().isEmpty();let t=null;const s=this.actor.getCell();if(s){if(e&&this.isInActiveShop())this.tryToSellItem(),this.status=f;else if(e&&this.shopCooldown<=0)t=this.tryToGoToShopCell();else{const e=this.actor.getBrain().getSeenCells(),n={};t=y(this.actor,e,n,e=>e.hasElements()),!t&&!s.hasDoor()&&this.doorCooldown<=0?Object.values(n).forEach(e=>{if(e.hasDoor()){const s=e.getXY(),n=e.getKeyXY();if(!this.visitedDoors.hasOwnProperty(n))return this.doorCooldown=25,void(t=new l.Goal.FollowPath(this.actor,s))}}):s.hasDoor()&&(this.visitedDoors[s.getKeyXY()]=s.getXY(),this.thiefSeesHouse()&&(t=new p(this.actor))),t||(t=new l.Goal.Explore(this.actor,30),t.setCallback(this.exploreCallback.bind(this)))}t&&this.addSubGoal(t)}}exploreCallback(e,t){const s=this.actor.getLevel().getMap();if(s.hasXY(e,t)){const n=s.getCell(e,t);n.hasShop()&&(this.shops[n.getKeyXY()]=n)}}thiefSeesHouse(){return this.actor.getBrain().getSeenCells().filter(e=>"floorhouse"===e.getBaseElem().getType()).length>0}}function y(e,t,s,n){let r=null;for(let a=0;a<t.length;a++){const o=t[a];if(o.hasItems()){const t=o.getItems()[0];if(!t.has("Unpaid")){r=new l.Goal.GetItem(e,t);break}}s&&n(t[a])&&(s[o.getKeyXY()]=o)}return r}t.GoalThief=m,l.Goal.Thief=m},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GoalTreasureHunter=void 0;const n=s(54),r=s(1),{GOAL_ACTIVE:a,GOAL_COMPLETED:o}=n.GoalStatus;r.Random.getRNG();class i extends n.GoalBase{constructor(e){super(e),this.setType("GoalTreasureHunter"),this.subGoals=[],this.treasure=null,this.constraint={op:">=",func:"getValue",value:0}}setConstraint(e){this.constraint=e}setTreasure(e){this.treasure=e}activate(){this.status=a,this.chooseHunterTask()}process(){return this.activateIfInactive(),this.isCompleted()?o:(this.hasSubGoals()?(console.log("chooseHunterTask processSubGoals 1"),this.status=this.processSubGoals()):(this.chooseHunterTask(),this.hasSubGoals()&&(console.log("chooseHunterTask processSubGoals 2"),this.status=this.processSubGoals())),this.status)}chooseHunterTask(){let e=null,t=null;console.log("chooseHunterTask"),this.hasTreasure()?(console.log("hunter has treasure now!!!"),t=this.checkForZoneExit()):this.treasure?(console.log("chooseHunterTask chose GetItem goal"),e=new n.Goal.GetItem(this.actor,this.treasure)):(console.log("chooseHunterTask chose FindItem goal"),e=new n.Goal.FindItem(this.actor,this.constraint,this.setTreasure.bind(this))),e&&(t||(t=this.checkForZoneExit()),t&&this.addSubGoal(t),this.addSubGoal(e))}hasTreasure(){if(!this.treasure)return console.log("hunter hasTreasure is false again!"),!1;const e=this.treasure.getName();return!!this.actor.getInvEq().hasItemNamed(e)}checkForZoneExit(){if(this.knowsZoneExit()){const e=this.getExitCell();if(e)return new n.Goal.ChangeLevel(this.actor,e.getXY())}return null}knowsZoneExit(){return!0}getExitCell(){const e=this.actor.getLevel(),t=e.getElements().find(e=>"connection"===e.getType());return t?e.getMap().getCell(t.getX(),t.getY()):null}}t.GoalTreasureHunter=i,n.Goal.TreasureHunter=i},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CmdCraft=t.CmdUnequipItem=t.CmdEquipItem=t.CmdDropItem=t.CmdUseElement=t.CmdUseItem=t.CmdMissile=t.CmdAttack=t.CmdBase=t.ACTION_ZERO_ENERGY=t.ACTION_ALREADY_DONE=t.Cmd=void 0;const i=o(s(0)),l=s(10),c=a(s(13));t.Cmd={},t.ACTION_ALREADY_DONE=()=>{},t.ACTION_ZERO_ENERGY=null,t.Cmd.ACTION_ALREADY_DONE=t.ACTION_ALREADY_DONE,t.Cmd.ACTION_ZERO_ENERGY=t.ACTION_ZERO_ENERGY;class u{constructor(e){this._actor=e.getActor(),this.brain=e}}t.CmdBase=u;class h extends u{execute(e){let s=e.target;if(s.hasActors&&e.target.hasActors()&&(s=e.target.getSentientActors()[0]),s){const[e,n]=this._actor.getXY(),[r,a]=s.getXY();if(l.Path.shortestDist(e,n,r,a)<=i.default.getMeleeAttackRange(this._actor)){const e=new c.Attack({target:s});return this._actor.add(e),t.ACTION_ALREADY_DONE}return this.brain.cmdNotPossible("Target not within attack range")}return this.brain.cmdNotPossible("No valid targets for attack")}}t.CmdAttack=h,t.Cmd.Attack=h;class d extends u{execute(e){const s=new c.AttackRanged;return s.setAttacker(this._actor),s.setTarget(e.target),this._actor.add(s),t.ACTION_ALREADY_DONE}}t.CmdMissile=d,t.Cmd.Missile=d;class f extends u{execute(e){if(e.hasOwnProperty("item")){const t=e.item;let s=!1,n=`You failed to use ${t.getName()}.`;if("function"==typeof t.useItem&&(this.brain.energy=i.default.energy.USE,t.useItem({target:e.target}),s=!0),e.hasOwnProperty("callback"))s&&(n=`You used ${t.getName()}!`),e.callback({msg:n,result:s});else if(s)i.default.gameMsg(`You used ${t.getName()}!`);else{const s=new c.UseItem;s.setItem(t),s.setTarget(e.target),this._actor.add(s)}}else i.default.err("Brain.Player","handleCommand","obj has no item");return t.ACTION_ALREADY_DONE}}t.CmdUseItem=f,t.Cmd.UseItem=f;class g extends u{execute(e){const s=e.target.getElements(),n=new c.UseElement;return s.forEach(e=>{e.onUse&&n.setElement(e)}),this._actor.add(n),t.ACTION_ALREADY_DONE}}t.CmdUseElement=g,t.Cmd.UseElement=g;class p extends u{execute(e){const s=this._actor.getInvEq(),n=this._actor.getCell();let r=!1,a="Failed to drop "+e.item.getName();const o=e.count<=e.item.getCount()?e.count:e.item.getCount();let l=!1;if(n){if(n.hasShop()){l=!n.getShop().isAbandoned()}if(l){const t=n.getShop(),s=()=>{const s=new c.Transaction;s.setArgs({item:e.item,seller:this._actor,shop:t,callback:e.callback,buyer:t.getShopkeeper(),count:o}),this._actor.add(s)};a=`Press y to sell item for ${t.getItemPriceForSelling(e.item,o)} gold coins.`,this.brain.setWantConfirm(this.brain.energy,s,a),e.hasOwnProperty("callback")&&e.callback({msg:a,result:r})}else s.dropNItems(e.item,o)&&(r=!0,a="Item dropped!");return e.hasOwnProperty("callback")&&e.callback({msg:a,result:r}),t.ACTION_ALREADY_DONE}i.default.err("CmdDropItem","execute","Null actorCell. Cannot execute cmd")}}t.CmdDropItem=p,t.Cmd.DropItem=p;class m extends u{execute(e){const s=new c.Equip;return s.setArgs(e),s.setIsRemove(!1),this._actor.add(s),t.ACTION_ALREADY_DONE}}t.CmdEquipItem=m,t.Cmd.EquipItem=m;class y extends u{execute(e){const s=new c.Equip;return s.setArgs(e),s.setIsRemove(!0),this._actor.add(s),t.ACTION_ALREADY_DONE}}t.CmdUnequipItem=y,t.Cmd.UnequipItem=y;class _ extends u{execute(e){const s=new c.Crafting;return s.setItem(e.item.getName()),s.setCount(e.item.getCount()),s.setArgs(e),this._actor.add(s),t.ACTION_ALREADY_DONE}}t.CmdCraft=_,t.Cmd.Craft=_},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(268)),a=n(s(270)),o=n(s(271));t.default={Simple:r.default,Speed:a.default,Action:o.default}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(104));class a extends r.default{add(e,t){return this._queue.add(e,0),super.add(e,t)}next(){return null!==this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),super.next()}}t.default=a},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventQueue=void 0;t.EventQueue=class{constructor(){this._time=0,this._events=[],this._eventTimes=[],this.traceIDs={},this.debugEnabled=!1}setTraceID(e){this.traceIDs[e]=!0,this.debugEnabled=!0}getTime(){return this._time}clear(){return this._events=[],this._eventTimes=[],this}add(e,t){let s=this._events.length;for(let e=0;e<this._eventTimes.length;e++)if(this._eventTimes[e]>t){s=e;break}n(this._events,s,e),n(this._eventTimes,s,t);const r=e;r.getID&&this.traceIDs[r.getID()]&&this._events.findIndex(e=>e.getID&&this.traceIDs[e.getID()])>0&&console.log("EQ.add found actor ID "+r.getID())}get(){if(!this._events.length)return null;const e=this._eventTimes.shift();if(e>0){this._time+=e;for(let t=0;t<this._eventTimes.length;t++)this._eventTimes[t]-=e}const t=this._events.shift();return t.getID&&this.traceIDs[t.getID()]&&console.debug("EQ.get(): Shifted out ID "+t.getID()),t}remove(e){const t=e;t.getID&&this.traceIDs[t.getID()]&&(console.log("EQ.remove(): Trying to remove actor with ID "+t.getID()),this._events.findIndex(e=>e.getID&&this.traceIDs[e.getID()])>0&&console.log(`EQ.remove(): Found actor ID ${t.getID()} for removal`));const s=this._events.indexOf(e);return-1!==s&&(this._remove(s),!0)}_remove(e){r(this._events,e),r(this._eventTimes,e)}};const n=function(e,t,s){let n=e.length;for(;n-- >=t;)e[n+1]=e[n];return e[t]=s,e},r=function(e,t){const s=e.length;if(s){for(;t<s;)e[t]=e[t+1],t++;e.length--}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(104));class a extends r.default{add(e,t,s){return this._queue.add(e,void 0!==s?s:1/e.getSpeed()),super.add(e,t)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed()),super.next()}}t.default=a},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(104));class a extends r.default{constructor(){super(),this._defaultDuration=1,this._duration=this._defaultDuration}add(e,t,s){return this._queue.add(e,s||this._defaultDuration),super.add(e,t)}clear(){return this._duration=this._defaultDuration,super.clear()}remove(e){return e===this._current&&(this._duration=this._defaultDuration),super.remove(e)}next(){return null!==this._current&&-1!==this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),super.next()}setDuration(e){return this._current&&(this._duration=e),this}}t.default=a},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Effects=t.createUseItemComp=void 0;const i=o(s(0)),l=s(17),c=a(s(2)),u=["actors","items","elements"],h=e=>{if(!e){const e="Possibly missing args for useItem().";i.default.err("effects.js","getTargetActor","Given object was null/undefined. "+e)}if(e.hasOwnProperty("target")){const t=e.target;if(t.hasActors())return t.getProp("actors")[0]}return null},d=e=>e.getTopOwner?e.getTopOwner():e;t.createUseItemComp=(e,t,s)=>{const n=new c.UseItem;n.setTarget(t),n.setItem(e),s&&n.setEffect(s);const r=i.default.getEffectUseType(e,t);n.setUseType(r);d(e).add(n)};t.Effects={effects:[{name:"use",func(e,t=-1){if(this.getCharges&&0===this.getCharges()){const e=this.getName();return i.default.gameMsg(e+" does not have any charges left"),!1}if(t>=0)return this.useFuncs[t].call(this,e);for(let t=0;t<this.useFuncs.length;t++)if(this.useFuncs[t].call(this,e))return!0;return!1}},{name:"addComp",requires:["name","duration"],optional:["setters"],func(e){const s={duration:this.useArgs.duration,effectType:"AddComp",name:this.useArgs.name,target:e,targetType:["actors","items"]};return this.useArgs.setters&&(s.setters=this.useArgs.setters),t.createUseItemComp(this,e,s),!0}},{name:"removeComp",requires:["name"],optional:["all"],func(e){const s={all:this.useArgs.all,effectType:"RemoveComp",name:this.useArgs.name,target:e,targetType:u};return t.createUseItemComp(this,e,s),!0}},{name:"modifyCompValue",requires:["name","set","get","value"],optional:["op"],func(e){const s={target:e,targetType:u,name:this.useArgs.name,set:this.useArgs.set,get:this.useArgs.get,value:this.useArgs.value,effectType:"ModifyCompValue"};return t.createUseItemComp(this,e,s),!0}},{name:"cure",requires:["effect"],func(e){const s=h(e);if(s){const e=this.useArgs.effect.capitalize();return s.has(e)?(s.remove(e),i.default.gameMsg(s.getName()+" seems to be cured of "+e)):i.default.gameMsg(this.getName()+" was wasted"),t.createUseItemComp(this,s),!0}return!1}},{name:"digger",func(e){d(this).getName(),this.getName();const s={effectType:"AddComp",name:"Mining",target:e,targetType:["cell"],setters:{setTarget:"$$target"},addOnUser:!0};return t.createUseItemComp(this,e,s),!0}},{name:"heal",requires:["hp"],func(e){const s=h(e);if(s){const e=l.Dice.create(this.useArgs.hp).roll();if(s.has("Health"))return s.get("Health").addHP(e),t.createUseItemComp(this,s),i.default.gameMsg(s.getName()+" drinks "+this.getName()),!0}else i.default.gameWarn("Cannot see anyone there for using the potion.");return!1}},{name:"poison",requires:["duration","damage","prob"],func(e){const s=l.Dice.parseDieSpec(this.useArgs.damage),n=new l.Dice(s[0],s[1],s[2]),r={target:e,targetType:["actors","items"],name:"Poison",duration:this.useArgs.duration,effectType:"AddComp",setters:{setDamageDie:n,setProb:this.useArgs.prob,setSource:d(this)}};return t.createUseItemComp(this,e,r),!0}},{name:"stun",requires:["duration"],func(e){const s=h(e);if(s){const e=function(e){const t=l.Dice.parseDieSpec(e);return new l.Dice(t[0],t[1],t[2]).roll()}(this.useArgs.duration),n=new c.Stun,r=new c.Expiration;r.addEffect(n,e);const a=d(this);return n.setSource(a),s.add(n),s.add(r),t.createUseItemComp(this,s),i.default.gameMsg(s.getName()+" is stunned by "+this.getName()),!0}return!1}},{name:"modifyStat",requires:["statName","value"],func(e){const s={target:e,targetType:["actors"],name:"Stats",set:"set"+this.useArgs.statName.capitalize(),get:"get"+this.useArgs.statName.capitalize(),value:this.useArgs.value,effectType:"ModifyCompValue"};return t.createUseItemComp(this,e,s),!0}},{name:"addEntity",requires:["entityName"],optional:["duration","endMsg"],func(e){const s={target:e,targetType:["cell"],entityName:this.useArgs.entityName,effectType:"AddEntity",duration:this.useArgs.duration,endMsg:this.useArgs.endMsg};return t.createUseItemComp(this,e,s),!0}},{name:"addElement",requires:["elementName"],optional:["duration","numAllowed","successMsg","failureMsg","successCheck","setters"],func(e){const s={target:e,targetType:["cell"],elementName:this.useArgs.elementName,effectType:"AddElement",duration:this.useArgs.duration,numAllowed:this.useArgs.numAllowed||1,successMsg:this.useArgs.successMsg,successCheck:this.useArgs.successCheck,failureMsg:this.useArgs.failureMsg,setters:this.useArgs.setters};return t.createUseItemComp(this,e,s),!0}},{name:"removeElement",requires:["elementName"],optional:["successMsg","failureMsg"],func(e){const s={target:e,targetType:["cell"],elementName:this.useArgs.elementName,effectType:"RemoveElement",successMsg:this.useArgs.successMsg,failureMsg:this.useArgs.failureMsg};return t.createUseItemComp(this,e,s),!0}}]}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Objects=void 0;const r=n(s(274)),a=s(58),o=n(s(276));t.Objects={actors:a.ActorsData,items:r.default,elements:o.default}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.dmgTypes=void 0;const r=n(s(0)),a=s(147),o=s(47),i=s(275);function l(e,t){let s=0;if("string"==typeof e)switch(e){case"leather":case"chain":case"steel":s=1*t;break;case"permaice":case"ruby":case"magic":s=1.5*t;break;case"void":s=1.75*t;break;case"gem":s=1*t;break;default:s=t}else Number.isInteger(e)&&(s=e);return Math.floor(1*s)}const c=[{name:"Gold coin",className:"cell-item-gold-coin",char:"$",material:"gold",type:"goldcoin",value:1,weight:r.default.GOLD_COIN_WEIGHT},{name:"MeleeWeaponBase",className:"cell-item-melee-weapon",char:"(",material:["iron","wood"],type:"weapon",range:1,attack:0,defense:0,dontCreate:!0},{name:"Dagger",base:"MeleeWeaponBase",material:"iron",damage:"1d4",weaponType:"dagger",weight:.2,value:l(5)},{name:"Bayonette",base:"MeleeWeaponBase",material:"iron",damage:"1d5",weaponType:"dagger",weight:.1,value:l(10)},{name:"Short sword",base:"MeleeWeaponBase",material:"iron",damage:"1d6",weaponType:"sword",weight:.5,value:l(20)},{name:"Wooden staff",base:"MeleeWeaponBase",material:"wood",damage:"1d6",weaponType:"staff",defense:1,weight:1,value:l(30)},{name:"Whip",base:"MeleeWeaponBase",material:"leather",damage:"1d6",range:2,attack:-1,weight:.2,value:l(10)},{name:"Tomahawk",base:"MeleeWeaponBase",material:["wood","stone","leather"],damage:"1d7",attack:1,defense:1,weaponType:"axe",weight:.7,value:l(35)},{name:"Iron staff",base:"MeleeWeaponBase",material:"iron",damage:"1d8",weaponType:"staff",defense:2,weight:1.9,value:l(40)},{name:"Piolet",base:"MeleeWeaponBase",damage:"1d8",attack:1,defense:1,weaponType:"axe",weight:.7,value:l(50)},{name:"Pick-axe",base:"MeleeWeaponBase",damage:"1d8",attack:1,defense:2,weaponType:"axe",weight:2.3,value:l(50),use:"digger"},{name:"Saber",base:"MeleeWeaponBase",material:"iron",damage:"2d4 + 1",attack:2,defense:1,weaponType:"sword",weight:.6,value:l(30)},{name:"Mace",base:"MeleeWeaponBase",material:"iron",damage:"2d4 + 2",attack:2,defense:0,weaponType:"mace",weight:.8,value:l(35)},{name:"Spear",base:"MeleeWeaponBase",damage:"1d8",attack:1,defense:3,weaponType:"spear",weight:1.2,value:l(50)},{name:"Iron axe",base:"MeleeWeaponBase",damage:"1d8",attack:3,defense:1,weaponType:"axe",weight:1.5,value:l(60)},{name:"Longsword",base:"MeleeWeaponBase",material:"steel",damage:"1d8",attack:2,defense:2,weaponType:"sword",weight:.8,value:l(75)},{name:"Morningstar",base:"MeleeWeaponBase",material:["wood","iron"],damage:"1d9 + 2",attack:2,defense:3,weaponType:"mace",weight:.7,value:l(75)},{name:"Battle axe",base:"MeleeWeaponBase",material:"iron",damage:"2d6 + 2",attack:2,defense:1,weaponType:"axe",weight:2.5,value:l(85)},{name:"Warhammer",base:"MeleeWeaponBase",material:"iron",damage:"2d6 + 5",attack:3,defense:1,weaponType:"hammer",weight:4.5,value:l(100)},{name:"Dwarven pick-axe",base:"MeleeWeaponBase",damage:"1d12",attack:2,defense:2,color:a.Colors.race.dwarven,weaponType:"axe",weight:3.5,value:l(120),use:"digger"},{name:"Great battle axe",base:"MeleeWeaponBase",material:"steel",damage:"2d8 + 4",attack:3,defense:0,weaponType:"axe",weight:4.5,value:l(130)},{name:"MithrilWeaponBase",base:"MeleeWeaponBase",className:"cell-item-mithril",material:"mithril",dontCreate:!0,attack:1},{name:"Mithril dagger",base:"MithrilWeaponBase",attack:2,damage:"1d7 + 3",weaponType:"dagger",weight:.15,value:l(50)},{name:"Mithril short sword",base:"MithrilWeaponBase",attack:3,damage:"1d9 + 4",defense:2,weight:.35,value:l(100),weaponType:"sword"},{name:"Mithril mace",base:"MithrilWeaponBase",damage:"1d11 + 5",weaponType:"mace",attack:3,defense:2,weight:2.5,value:l(150)},{name:"Mithril staff",base:"MithrilWeaponBase",damage:"1d12 + 2",weaponType:"staff",defense:6,weight:1.5,value:l(170)},{name:"Mithril axe",base:"MithrilWeaponBase",attack:4,damage:"1d15 + 2",defense:3,weaponType:"axe",weight:1.2,value:l(200)},{name:"Mithril hammer",base:"MithrilWeaponBase",attack:5,damage:"1d15 + 6",defense:1,weaponType:"axe",weight:2.4,value:l(250)},{name:"Mithril long sword",base:"MithrilWeaponBase",attack:5,damage:"1d15 + 4",defense:4,weight:.6,value:l(300),weaponType:"sword"},{name:"Mithril spear",base:"MithrilWeaponBase",attack:5,damage:"1d12 + 4",defense:8,weight:.9,value:l(350),weaponType:"spear"},{name:"Mithril pick-axe",base:"MithrilWeaponBase",damage:"1d15",attack:3,defense:2,weaponType:"axe",weight:1.2,value:l(150),use:"digger"},{name:"IceWeaponBase",base:"MeleeWeaponBase",className:"cell-item-ice",material:"permaice",dontCreate:!0,attack:1},{name:"Permaice dagger",base:"IceWeaponBase",damage:"1d4 + 9",defense:6,weight:.6,value:l(150),weaponType:"dagger"},{name:"Permaice short sword",base:"IceWeaponBase",damage:"2d5 + 6",defense:6,weight:1.5,value:l(300),weaponType:"sword"},{name:"Permaice mace",base:"IceWeaponBase",damage:"2d7 + 6",weaponType:"mace",defense:6,weight:2.5,value:l(300)},{name:"Permaice staff",base:"IceWeaponBase",damage:"3d5 + 6",weaponType:"staff",defense:7,weight:3.8,value:l(300)},{name:"Permaice axe",base:"IceWeaponBase",damage:"3d6 + 6",defense:7,weaponType:"axe",weight:4.5,value:l(400)},{name:"Permaice hammer",base:"IceWeaponBase",damage:"3d6 + 10",defense:7,weaponType:"hammer",weight:6.5,value:l(440)},{name:"Permaice long sword",base:"IceWeaponBase",damage:"4d5 + 6",defense:8,weight:3,value:l(500),weaponType:"sword"},{name:"Permaice spear",base:"IceWeaponBase",damage:"4d5 + 6",defense:12,weight:3.5,value:l(550),weaponType:"spear"},{name:"Permaice katana",base:"IceWeaponBase",damage:"10d3 + 6",defense:10,weight:4,value:l(750),weaponType:"sword"},{name:"Permaice pick-axe",base:"IceWeaponBase",damage:"3d6 + 6",defense:6,weaponType:"axe",weight:3.6,value:l(300),use:"digger"},{name:"RubyWeaponBase",base:"MeleeWeaponBase",className:"cell-item-ruby-glass",material:"ruby glass",dontCreate:!0},{name:"Ruby glass dagger",base:"RubyWeaponBase",damage:"2d5 + 2",attack:4,defense:1,weight:.1,value:l(110),weaponType:"dagger"},{name:"Ruby glass short sword",base:"RubyWeaponBase",damage:"3d5 + 2",attack:3,defense:2,weight:.2,value:l(200),weaponType:"sword"},{name:"Ruby glass mace",base:"RubyWeaponBase",damage:"3d6 + 2",attack:3,defense:3,weight:.3,value:l(250),weaponType:"mace"},{name:"Ruby glass hammer",base:"RubyWeaponBase",damage:"3d6 + 4",attack:4,defense:2,weight:.6,value:l(250),weaponType:"hammer"},{name:"Ruby glass staff",base:"RubyWeaponBase",damage:"3d5",weaponType:"staff",attack:4,defense:5,weight:.4,value:l(300)},{name:"Ruby glass sword",base:"RubyWeaponBase",damage:"4d5 + 2",attack:5,defense:2,weight:.3,value:l(350),weaponType:"sword"},{name:"Ruby glass spear",base:"RubyWeaponBase",damage:"3d5 + 2",attack:3,defense:6,weight:.4,value:l(400),weaponType:"spear"},{name:"Ruby glass battle axe",base:"RubyWeaponBase",damage:"4d6 + 3",attack:6,defense:2,weight:.7,value:l(800),weaponType:"axe"},{name:"Ruby glass pick-axe",base:"RubyWeaponBase",damage:"3d5",attack:5,defense:2,weaponType:"axe",weight:1,value:l(300),use:"digger"},{name:"RunedWeaponBase",base:"MeleeWeaponBase",className:"cell-item-magic",material:"forium",dontCreate:!0},{name:"Runed dagger",base:"RunedWeaponBase",damage:"2d5 + 2",attack:2,defense:1,weight:.2,value:l(100),weaponType:"dagger"},{name:"Runed short sword",base:"RunedWeaponBase",damage:"3d5 + 2",attack:3,defense:2,weight:.5,value:l(300),weaponType:"sword"},{name:"Runed mace",base:"RunedWeaponBase",damage:"3d6 + 2",attack:3,defense:2,weight:1,value:l(340),weaponType:"mace"},{name:"Runed axe",base:"RunedWeaponBase",damage:"4d5 + 2",attack:4,defense:2,weight:1.5,value:l(400),weaponType:"axe"},{name:"Runed hammer",base:"RunedWeaponBase",damage:"4d5 + 4",attack:5,defense:1,weight:2.7,value:l(400),weaponType:"hammer"},{name:"Runed staff",base:"RunedWeaponBase",damage:"4d5",weaponType:"staff",attack:2,defense:9,weight:2,value:l(400)},{name:"Runed sword",base:"RunedWeaponBase",damage:"5d5 + 2",attack:5,defense:2,weight:1,value:l(500),weaponType:"sword"},{name:"Runed spear",base:"RunedWeaponBase",damage:"4d5 + 4",attack:4,defense:8,weight:1.4,value:l(600),weaponType:"spear"},{name:"Runed katana",base:"RunedWeaponBase",damage:"3d12 + 2",attack:5,defense:5,weight:.8,value:l(750),weaponType:"sword"},{name:"Wintersbane",base:"RunedWeaponBase",damage:"3d10 + 4",attack:6,defense:3,weight:1,value:l(1e3),weaponType:"sword"},{name:"Rune-covered pick-axe",base:"RunedWeaponBase",damage:"4d5",attack:5,defense:2,weaponType:"axe",weight:2.5,value:l(300),use:"digger"},{name:"VoidWeaponBase",base:"MeleeWeaponBase",className:"cell-item-void",material:"netherium",dontCreate:!0,onAttackHit:[o.meleeHitDamage(2,"1d8 + 1","VOID")]},{name:"Void dagger",base:"VoidWeaponBase",damage:"2d5 + 1",attack:2,defense:1,weight:.3,value:l(200),weaponType:"dagger"},{name:"Void short sword",base:"VoidWeaponBase",damage:"3d5 + 1",attack:3,defense:2,weight:.7,value:l(300),weaponType:"sword"},{name:"Void mace",base:"VoidWeaponBase",damage:"3d6 + 1",attack:3,defense:2,weight:1.4,value:l(390),weaponType:"mace"},{name:"Void axe",base:"VoidWeaponBase",damage:"4d5 + 1",attack:4,defense:2,weight:1.9,value:l(450),weaponType:"axe"},{name:"Void staff",base:"VoidWeaponBase",damage:"3d6",weaponType:"staff",attack:2,defense:9,weight:2,value:l(450)},{name:"Void longsword",base:"VoidWeaponBase",damage:"5d5 + 1",attack:5,defense:2,weight:1.4,value:l(550),weaponType:"sword"},{name:"Void spear",base:"VoidWeaponBase",damage:"4d5 + 2",attack:4,defense:8,weight:1.8,value:l(650),weaponType:"spear"},{name:"Hammer of Void",base:"VoidWeaponBase",damage:"5d5 + 8",attack:8,defense:8,weight:3.7,value:l(850),weaponType:"hammer",onAttackHit:[o.meleeHitDamage(2,"2d8 + 4","VOID")]},{name:"ArmourBase",type:"armour",className:"cell-item-armour",char:"[",dontCreate:!0,attack:0,defense:0,protection:0},{name:"Robe",base:"ArmourBase",className:"cell-item-cloth",weight:1,defense:1,armourType:"chest",value:l(15)},{name:"Spiked boots",base:"ArmourBase",weight:.4,defense:1,protection:1,armourType:"feet",value:l(35)},{name:"Robe of defense",base:"ArmourBase",className:"cell-item-cloth",weight:.9,defense:4,armourType:"chest",value:l(200)},{name:"Robe of protection",base:"ArmourBase",className:"cell-item-cloth",weight:.8,protection:4,armourType:"chest",value:l(200)},{name:"Runed robe",base:"ArmourBase",className:"cell-item-cloth",weight:.7,defense:4,protection:4,armourType:"chest",value:l(350)},{name:"Boots of flying",base:"ArmourBase",weight:.4,defense:1,protection:1,armourType:"feet",value:l(35),onEquip:[{addComp:"Flying"}]},{name:"Snow shoes",base:"ArmourBase",weight:.4,defense:-1,protection:0,armourType:"feet",value:l(75),onEquip:[{addComp:"SnowWalk"}],noRandom:!0},{name:"LeatherArmourBase",base:"ArmourBase",dontCreate:!0,material:"leather",className:"cell-item-leather"},{name:"Leather helmet",base:"LeatherArmourBase",weight:.3,defense:1,armourType:"head",value:l(15)},{name:"Leather collar",base:"LeatherArmourBase",weight:.2,protection:1,armourType:"neck",value:l(15)},{name:"Leather boots",base:"LeatherArmourBase",weight:.5,defense:1,armourType:"feet",value:l(15)},{name:"Leather leggings",base:"LeatherArmourBase",weight:1,defense:1,protection:2,armourType:"legs",value:l(30)},{name:"Leather armour",base:"LeatherArmourBase",weight:2,defense:2,protection:3,armourType:"chest",value:l(30)},{name:"Leather shield",base:"LeatherArmourBase",weight:1,defense:2,attack:-1,armourType:"shield",value:l(15)},{name:"ChainArmourBase",base:"ArmourBase",dontCreate:!0,material:"iron",className:"cell-item-iron"},{name:"Chain helmet",base:"ChainArmourBase",weight:.6,defense:1,protection:1,armourType:"head",value:l(45)},{name:"Chain collar",base:"ChainArmourBase",weight:.4,protection:2,armourType:"neck",value:l(45)},{name:"Chain boots",base:"ChainArmourBase",weight:1.2,defense:1,protection:1,armourType:"feet",value:l(45)},{name:"Chain leggings",base:"ChainArmourBase",weight:2,defense:1,protection:3,armourType:"legs",value:l(75)},{name:"Chain armour",base:"ChainArmourBase",weight:4,defense:1,protection:4,armourType:"chest",value:l(90)},{name:"Chain shield",base:"ChainArmourBase",weight:2,defense:3,attack:-2,armourType:"shield",value:l(40)},{name:"SteelArmourBase",base:"ArmourBase",dontCreate:!0,material:"steel",className:"cell-item-steel"},{name:"Steel helmet",base:"SteelArmourBase",weight:1.1,defense:1,protection:2,armourType:"head",value:l(75)},{name:"Steel collar",base:"SteelArmourBase",weight:.8,protection:3,armourType:"neck",value:l(75)},{name:"Steel boots",base:"SteelArmourBase",weight:2,defense:1,protection:2,armourType:"feet",value:l(75)},{name:"Steel leggings",base:"SteelArmourBase",weight:4,defense:0,protection:3,armourType:"legs",value:l(100)},{name:"Steel armour",base:"SteelArmourBase",weight:8,defense:0,protection:6,armourType:"chest",value:l(150)},{name:"Steel shield",base:"SteelArmourBase",weight:3,defense:4,attack:-2,armourType:"shield",value:l(80)},{name:"MithrilArmourBase",base:"ArmourBase",dontCreate:!0,material:"mithril",className:"cell-item-mithril"},{name:"Mithril helmet",base:"MithrilArmourBase",weight:.8,defense:1,protection:2,armourType:"head",value:l(120)},{name:"Mithril collar",base:"MithrilArmourBase",weight:.6,protection:3,armourType:"neck",value:l(110)},{name:"Mithril boots",base:"MithrilArmourBase",weight:1.6,defense:1,protection:2,armourType:"feet",value:l(120)},{name:"Mithril leggings",base:"MithrilArmourBase",weight:3,defense:0,protection:4,armourType:"legs",value:l(150)},{name:"Mithril armour",base:"MithrilArmourBase",weight:6,defense:0,protection:7,armourType:"chest",value:l(200)},{name:"Mithril shield",base:"MithrilArmourBase",weight:2.2,defense:5,attack:-1,armourType:"shield",value:l(120)},{name:"IceArmourBase",base:"ArmourBase",dontCreate:!0,material:"permaice",className:"cell-item-ice"},{name:"Permaice helmet",base:"IceArmourBase",weight:1.8,defense:0,protection:4,armourType:"head",value:l(200)},{name:"Permaice collar",base:"IceArmourBase",weight:1.8,defense:0,protection:4,armourType:"neck",value:l(200)},{name:"Permaice boots",base:"IceArmourBase",weight:3.6,defense:0,protection:3,armourType:"feet",value:l(200)},{name:"Permaice leggings",base:"IceArmourBase",weight:6,defense:0,protection:8,armourType:"legs",value:l(300)},{name:"Permaice armour",base:"IceArmourBase",weight:12,defense:0,protection:12,armourType:"chest",value:l(400)},{name:"Permaice shield",base:"IceArmourBase",weight:6,defense:4,attack:-3,protection:2,armourType:"shield",value:l(120)},{name:"RubyArmourBase",base:"ArmourBase",dontCreate:!0,material:"ruby glass",className:"cell-item-ruby-glass"},{name:"Ruby glass helmet",base:"RubyArmourBase",weight:.1,defense:2,protection:2,armourType:"head",value:l("ruby",100)},{name:"Ruby glass collar",base:"RubyArmourBase",weight:.1,defense:2,protection:2,armourType:"neck",value:l("ruby",100)},{name:"Ruby glass boots",base:"RubyArmourBase",weight:.2,defense:3,protection:2,armourType:"feet",value:l("ruby",200)},{name:"Ruby glass leggings",base:"RubyArmourBase",weight:1,defense:6,protection:5,armourType:"legs",value:l("ruby",350)},{name:"Ruby glass armour",base:"RubyArmourBase",weight:1,defense:7,protection:8,armourType:"chest",value:l("ruby",500)},{name:"Ruby glass shield",base:"RubyArmourBase",weight:.4,defense:5,armourType:"shield",value:l("ruby",250)},{name:"RunedArmourBase",base:"ArmourBase",dontCreate:!0,material:"forium",className:"cell-item-magic"},{name:"Runed helmet",base:"RunedArmourBase",weight:.6,defense:3,protection:4,armourType:"head",value:l("magic",200)},{name:"Runed collar",base:"RunedArmourBase",weight:.4,defense:3,protection:2,armourType:"neck",value:l("magic",200)},{name:"Runed boots",base:"RunedArmourBase",weight:1.2,defense:3,protection:2,armourType:"feet",value:l("magic",200)},{name:"Runed leggings",base:"RunedArmourBase",weight:2.5,defense:6,protection:6,armourType:"chest",value:l("magic",400)},{name:"Runed armour",base:"RunedArmourBase",weight:4,defense:12,protection:8,armourType:"chest",value:l("magic",500)},{name:"Runed shield",base:"RunedArmourBase",weight:2,defense:5,attack:-2,armourType:"shield",value:l("magic",200)},{name:"MissileBase",className:"cell-item-missile",char:"➹",type:"missile",dontCreate:!0,attack:1,damage:"1d1",range:2,weight:.1},{name:"Rock",base:"MissileBase",className:"cell-item-rock",char:"*",damage:"1d4",range:5,value:l(10),weight:.2},{name:"Large rock",base:"MissileBase",className:"cell-item-rock",char:"*",damage:"2d4 + 2",range:2,value:l(20),weight:1},{name:"Huge rock",base:"MissileBase",className:"cell-item-rock",char:"*",damage:"5d4 + 2",range:1,value:l(40),weight:20},{name:"Shuriken",base:"MissileBase",className:"cell-item-iron",char:"*",damage:"1d6",range:3,value:l(20),weaponType:"shuriken"},{name:"Iron dart",base:"MissileBase",className:"cell-item-iron",damage:"1d6 + 1",range:4,value:l(40),weaponType:"dart"},{name:"Steel dart",base:"MissileBase",className:"cell-item-steel",damage:"1d6 + 3",range:4,value:l(50),weaponType:"dart"},{name:"Throwing spear",base:"MissileBase",className:"cell-item-iron",attack:2,damage:"1d7 + 1",range:3,value:l(55),weight:.4,weaponType:"spear"},{name:"Throwing axe",base:"MissileBase",className:"cell-item-iron",attack:2,damage:"1d8 + 1",range:3,value:l(60),weight:.3,weaponType:"axe"},{name:"Ruby glass throwing knife",base:"MissileBase",className:"cell-item-ruby-glass",attack:3,damage:"1d10",range:5,value:l(80),weight:.1,weaponType:"dagger",material:"ruby glass"},{name:"Runed Shuriken",base:"MissileBase",attack:3,className:"cell-item-magic",char:"*",material:"forium",damage:"3d4 + 2",range:5,value:l(100),weight:.1,weaponType:"shuriken"},{name:"Throwing axe of death",base:"MissileBase",className:"cell-item-magic",attack:5,damage:"2d10 + 3",range:3,value:l(200),weight:.5,addComp:"Indestructible",weaponType:"axe"},{name:"MissileWeaponBase",dontCreate:!0,type:"missileweapon",fireRate:1,className:"cell-item-missileweapon",attack:0,defense:0,char:"{"},{name:"Wooden bow",base:"MissileWeaponBase",className:"cell-item-wooden",attack:1,range:4,value:l(75),weaponType:"bow",weight:1},{name:"Wooden crossbow",base:"MissileWeaponBase",className:"cell-item-wooden",attack:3,range:6,value:l(150),weaponType:"crossbow",weight:2},{name:"Iron bow",base:"MissileWeaponBase",className:"cell-item-iron",attack:1,range:5,value:l(110),weaponType:"bow",weight:1.5},{name:"Steel bow",base:"MissileWeaponBase",className:"cell-item-steel",attack:2,range:5,value:l(150),weaponType:"bow",weight:2},{name:"Steel crossbow",base:"MissileWeaponBase",className:"cell-item-steel",attack:4,range:7,value:l(250),weaponType:"crossbow",weight:3},{name:"Ruby glass bow",base:"MissileWeaponBase",className:"cell-item-ruby-glass",attack:6,range:6,value:l("ruby",300),weaponType:"bow",weight:.3},{name:"Double crossbow",base:"MissileWeaponBase",className:"cell-item-steel",attack:0,range:5,value:l(400),fireRate:2,weaponType:"crossbow",weight:4},{name:"Bow of Defense",base:"MissileWeaponBase",className:"cell-item-magic",attack:1,range:4,defense:6,value:l("magic",500),weaponType:"bow",weight:1},{name:"Rifle",base:"MissileWeaponBase",className:"cell-item-steel",attack:4,range:7,value:l(350),weaponType:"rifle",weight:4.5},{name:"Dwarven rifle",base:"MissileWeaponBase",className:"cell-item-steel",attack:4,range:8,damage:"1d6",value:l(500),weaponType:"rifle",weight:5.5},{name:"Wooden arrow",base:"MissileBase",className:"cell-item-wooden",type:"ammo",range:1,weight:.1,ammoType:"bow",attack:0,damage:"1d6",value:l(10)},{name:"Wooden bolt",base:"MissileBase",className:"cell-item-wooden",type:"ammo",range:1,weight:.1,ammoType:"crossbow",attack:1,damage:"1d8",value:l(15)},{name:"Steel arrow",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.1,ammoType:"bow",attack:0,damage:"1d6 + 2",value:l("steel",20)},{name:"Steel bolt",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.1,ammoType:"crossbow",attack:1,damage:"1d8",value:l("steel",25)},{name:"Stone bullet",base:"MissileBase",className:"cell-item-rock",type:"ammo",range:1,weight:.1,ammoType:"rifle",attack:-1,damage:"2d4",value:l(30)},{name:"Arrow of targeting",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.1,ammoType:"bow",attack:10,damage:"1d6 + 3",value:l("steel",40)},{name:"Runed arrow",base:"MissileBase",className:"cell-item-magic",type:"ammo",range:1,weight:.2,ammoType:"bow",attack:4,damage:"2d7",value:l("magic",50)},{name:"Ruby glass bolt",base:"MissileBase",className:"cell-item-ruby-glass",type:"ammo",range:2,weight:.05,ammoType:"crossbow",attack:3,damage:"2d8",value:l("ruby",60)},{name:"Steel bullet",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.05,ammoType:"rifle",attack:1,damage:"3d4",value:l(50)},{name:"Void bolt",base:"MissileBase",className:"cell-item-void",type:"ammo",range:1,weight:.1,ammoType:"crossbow",attack:5,damage:"4d4 + 4",value:l(100)},{name:"PotionBase",char:"!",type:"potion",dontCreate:!0,weight:.1,addComp:"OneShot",color:o.color("random","black")},{name:"Healing potion",base:"PotionBase",use:{heal:{hp:"3d4"}},value:l(10)},{name:"Potion of venom",base:"PotionBase",use:{poison:{duration:"4d4 + 5",damage:"1d6",prob:"0.1"}},value:l(30)},{name:"Potion of stunning",base:"PotionBase",use:{stun:{duration:"2d4 + 1"}},value:l(50)},{name:"Potion of power",base:"PotionBase",use:{modifyCompValue:{name:"SpellPower",set:"setPP",get:"getPP",value:"1d10 + 2"}},value:l(50)},{name:"Potion of nourishment",base:"PotionBase",use:{modifyCompValue:{name:"Hunger",set:"setEnergy",get:"getEnergy",value:"10000"}},value:l(50)},{name:"Potion of cure poison",base:"PotionBase",use:{cure:{effect:"poison"}},value:l(80)},{name:"Potion of eagle",base:"PotionBase",use:{addComp:{name:"Flying",duration:"10d10 + 10"}},value:l(80)},{name:"Potion of deflection",base:"PotionBase",use:{addComp:{name:"Deflection",duration:"10d10 + 10"}},value:l(80)},{name:"Potion of eagle eye",base:"PotionBase",use:{addComp:{name:"EagleEye",duration:"10d10 + 10"}},value:l(80)},{name:"Potion of first strike",base:"PotionBase",use:{addComp:{name:"FirstStrike",duration:"10d10 + 10"}},value:l(80)},{name:"Potion of paralysis",base:"PotionBase",use:{addComp:{name:"Paralysis",duration:"2d5"}},value:l(80)},{name:"Potion of frost poison",base:"PotionBase",use:{poison:{duration:"5d20",damage:"1d6 + 1",prob:"0.2"}},value:l(100)},{name:"Healing elixir",base:"PotionBase",use:{heal:{hp:"10d5"}},value:l(100)},{name:"Potion of spirit form",base:"PotionBase",use:{addComp:{name:"Ethereal",duration:"2d10"}},value:l(100)},{name:"Potion of charm",base:"PotionBase",use:{addComp:{name:"Charm",duration:"2d10"}},value:l(120)},{name:"Potion of mana",base:"PotionBase",use:{modifyCompValue:{name:"SpellPower",set:"setPP",get:"getPP",value:"6d5 + 5"}},value:l(150)},{name:"Potion of quickness",base:"PotionBase",use:{modifyStat:{value:2,statName:"speed"}},value:l(150)},{name:"Potion of greater quickness",base:"PotionBase",use:{modifyStat:{value:4,statName:"speed"}},value:l(350)},{name:"FoodBase",className:"cell-item-food",char:"%",weight:.1,type:"food",dontCreate:!0,addComp:"OneShot"},{name:"Wheat",base:"FoodBase",energy:100,value:l(10),color:o.color("ForestGreen","Coral")},{name:"Rye",base:"FoodBase",energy:100,value:l(10),color:o.color("ForestGreen","Coral")},{name:"Barley",base:"FoodBase",energy:100,value:l(10),color:o.color("ForestGreen","Coral")},{name:"Oat",base:"FoodBase",energy:100,value:l(10),color:o.color("ForestGreen","Coral")},{name:"Carrots",base:"FoodBase",energy:500,value:l(10),color:o.color("ForestGreen","Coral")},{name:"Cabbage",base:"FoodBase",energy:700,value:l(10),color:o.color("ForestGreen","Chartreuse")},{name:"Turnips",base:"FoodBase",energy:700,value:l(10),color:o.color("ForestGreen","Khaki")},{name:"Blueberries",base:"FoodBase",energy:1700,value:l(30),color:o.color("FloralWhite","DarkBlue")},{name:"Lingonberries",base:"FoodBase",energy:1700,value:l(30),color:o.color("FloralWhite","DarkRed")},{name:"Chicken egg",base:"FoodBase",energy:1300,value:l(25)},{name:"Potatoes",base:"FoodBase",energy:1200,value:l(20),color:o.color("DarkGray","Sienna")},{name:"Dried meat",base:"FoodBase",energy:1300,value:l(20),color:o.color("white","red")},{name:"Corn",base:"FoodBase",energy:1600,value:l(30),color:o.color("ForestGreen","Yellow")},{name:"Chunk of meat",base:"FoodBase",energy:1e3,value:l(20),weight:.4,color:o.color("white","red")},{name:"Reindeer meat",base:"FoodBase",energy:1500,value:l(20),weight:.3,color:o.color("white","red")},{name:"Wheat bread",base:"FoodBase",energy:2e3,value:l(30),recipe:[{count:3,name:"Wheat"}]},{name:"Rye bread",base:"FoodBase",energy:2e3,value:l(30),recipe:[{count:3,name:"Rye"}]},{name:"Barley bread",base:"FoodBase",energy:2e3,value:l(30),recipe:[{count:3,name:"Barley"}]},{name:"Oats",base:"FoodBase",energy:2800,value:l(30),recipe:[{count:4,name:"Oat"}]},{name:"Ration",base:"FoodBase",energy:2e3,value:l(40),weight:1},{name:"Dried fruit",base:"FoodBase",energy:3500,value:l(50)},{name:"Cloudberries",base:"FoodBase",energy:1500,value:l(50),color:o.color("Orange","DarkGreen")},{name:"Seeds and nuts",base:"FoodBase",energy:5e3,value:l(50),color:o.color("GoldenRod","Sienna")},{name:"Ghost pepper",base:"FoodBase",energy:100,value:l(50),use:{stun:{duration:"3d3"}},color:o.color("OrangeRed","DarkGreen")},{name:"Whale fat",base:"FoodBase",energy:8e3,value:l(100)},{name:"tool",type:"tool",uses:10,className:"cell-item-tool",char:"]",dontCreate:!0},{name:"shovel",base:"tool",use:{addElement:{elementName:"Hole",numAllowed:1,successMsg:"You dig a hole to the ground",successCheck:[{elements:{has:"Diggable"}}],failureMsg:"You fail to dig a hole there"}},value:100},{name:"machete",base:"tool",char:"(",use:{removeElement:{elementName:"web",successMsg:"You remove the webs using machete",failureMsg:"You do not manage to remove any webs"}},noRandom:!0},{name:"trapmaking kit",base:"tool"},{name:"firemaking kit",base:"tool",className:"cell-item-fire",use:{addEntity:{entityName:"Fire",duration:20}},value:100},{name:"hoe",base:"tool",className:"cell-item-iron",use:{addElement:{elementName:"TilledSoil",duration:"100",successMsg:"You till the soil with hoe.",successCheck:[{elements:{has:"Tillable"}}],failureMsg:"This location cannot be tilled."}},value:30},{name:"wheat seeds",base:"tool",addComp:"OneShot",use:h("Wheat",12),value:10},{name:"oat seeds",base:"tool",addComp:"OneShot",use:h("Oat",12),value:10},{name:"barley seeds",base:"tool",addComp:"OneShot",use:h("Oat",12),value:10},{name:"rye seeds",base:"tool",addComp:"OneShot",use:h("Oat",12),value:10},{name:"repair tool kit",base:"tool",use:{removeComp:{name:"Broken"}},noRandom:!0},{name:"rope",base:"tool"},{name:"piece of wood",base:"tool",value:5,className:"cell-item-wooden",weight:.2},{name:"piece of grass",base:"tool",value:2,className:"cell-item-wooden",char:"]",weight:.1},{name:"piece of stone",base:"tool",value:3,className:"cell-item-stone",char:"]",weight:.25},{name:"iron ingot",base:"tool",value:15,className:"cell-item-iron",char:"]",weight:.5,recipe:[{count:3,name:"iron ore"}]},{name:"steel ingot",base:"tool",value:25,className:"cell-item-steel",char:"]",weight:.6,recipe:[{count:4,name:"iron ore"}]},{name:"mithril ingot",base:"tool",value:35,className:"cell-item-mithril",char:"]",weight:.45,recipe:[{count:3,name:"mithril ore"}]},{name:"permaice ingot",base:"tool",value:70,className:"cell-item-ice",char:"]",weight:1,recipe:[{count:3,name:"permaice ore"}]},{name:"ruby class ingot",base:"tool",value:70,className:"cell-item-ruby-glass",char:"]",weight:.2,recipe:[{count:3,name:"ruby glass ore"}]},{name:"forium ingot",base:"tool",value:75,className:"cell-item-magic",char:"]",weight:.4,recipe:[{count:3,name:"forium ore"}]},{name:"netherium ingot",base:"tool",value:100,className:"cell-item-void",char:"]",weight:.7,recipe:[{count:3,name:"netherium ore"}]},{name:"SpiritGemBase",char:",",weight:.1,type:"spiritgem",dontCreate:!0,color:o.color("random","MediumPurple")},{name:"Lesser spirit gem",base:"SpiritGemBase",value:l("gem",30),weight:4},{name:"Ordinary spirit gem",base:"SpiritGemBase",value:l("gem",60),weight:2.5},{name:"Greater spirit gem",base:"SpiritGemBase",value:l("gem",100),weight:1.5},{name:"Glowing spirit gem",base:"SpiritGemBase",value:l("gem",200),weight:1},{name:"Mystical spirit gem",base:"SpiritGemBase",value:l("gem",300),weight:.5},{name:"Mythic spirit gem",base:"SpiritGemBase",value:l("gem",500),weight:.2},{name:"RuneBase",dontCreate:!0,type:"rune",char:"ⵅ",color:o.color("random","black"),weight:1},{name:"rune of healing",base:"RuneBase",use:{heal:{hp:"4d4"}},value:l("rune",100)},{name:"rune of protection",base:"RuneBase",use:{addComp:{name:"CombatMods",duration:"10d5 + 10",setters:{setProtection:"2d5"}}},value:l("rune",100)},{name:"rune of defense",base:"RuneBase",use:{addComp:{name:"CombatMods",duration:"10d5 + 10",setters:{setProtection:"2d5"}}},value:l("rune",100)},{name:"rune of attack",base:"RuneBase",use:{addComp:{name:"CombatMods",duration:"10d5 + 10",setters:{setAttack:"2d5"}}},value:l("rune",100)},{name:"rune of webs",base:"RuneBase",use:{addElement:{elementName:"Web",numAllowed:1}},value:l("rune",100)},{name:"rune of cold",base:"RuneBase",use:{addComp:{name:"Coldness",duration:"100d5 + 50"}},value:l("rune",100)},{name:"rune of fire",base:"RuneBase",use:{addEntity:{entityName:"Fire",duration:50}},value:l("rune",100)},{name:"rune of force",base:"RuneBase",use:{addEntity:{entityName:"Forcefield"}},value:l("rune",100)},{name:"rune of skies",base:"RuneBase",use:{addComp:{name:"Flying",duration:"5d10 + 5"}},value:l("rune",100)},{name:"rune of ice flames",base:"RuneBase",use:{addEntity:{entityName:"Ice flame",duration:100}},value:l("rune",150)},{name:"rune of tunneling",base:"RuneBase",use:"digger",value:l("rune",150)},{name:"rune of traps",base:"RuneBase",use:{addElement:{elementName:"Hole",numAllowed:1}},value:l("rune",150)},{name:"rune of poison clouds",base:"RuneBase",use:{addEntity:{entityName:"Poison gas",duration:30}},value:l("rune",150)},{name:"rune of venom",base:"RuneBase",use:{poison:{duration:"4d6 + 5",damage:"1d8 + 2",prob:"0.2"}},value:l("rune",150)},{name:"rune of control",base:"RuneBase",use:{addComp:{name:"MindControl",duration:"1d4 + 2"}},value:l("rune",250)},{name:"MineralBase",dontCreate:!0,type:"mineral",char:"]"},{name:"copper ore",base:"MineralBase",weight:.2,value:l("mineral",20),className:"cell-item-copper"},{name:"iron ore",base:"MineralBase",weight:.3,value:l("mineral",20),className:"cell-item-iron"},{name:"lapis lazuli",base:"MineralBase",weight:.35,value:l("mineral",40),char:"*",color:{fg:"LightSkyBlue",bg:"DarkSlateGrey"}},{name:"amethyst",base:"MineralBase",weight:.25,value:l("mineral",50),char:"*",color:{fg:"Orchid",bg:"DarkSlateGrey"}},{name:"aquamarine",base:"MineralBase",weight:.25,value:l("mineral",50),char:"*",color:{fg:"Aquamarine",bg:"Black"}},{name:"topaz",base:"MineralBase",weight:.15,value:l("mineral",75),char:"*",color:{fg:"Blue",bg:"White"}},{name:"fire opal",base:"MineralBase",weight:.15,value:l("mineral",75),char:"*",color:{fg:"Salmon",bg:"Black"}},{name:"white opal",base:"MineralBase",weight:.15,value:l("mineral",75),char:"*",color:{fg:"Wheat",bg:"Black"}},{name:"mithril ore",base:"MineralBase",weight:.2,value:l("mineral",60),className:"cell-item-mithril"},{name:"adamantium ore",base:"MineralBase",weight:.3,value:l("mineral",80),className:"cell-item-adamantium"},{name:"snowshard",base:"MineralBase",weight:.2,value:l("mineral",50),char:"*",color:{fg:"DarkBlue",bg:"White"}},{name:"ruby glass ore",base:"MineralBase",weight:.1,value:l("mineral",100),className:"cell-item-ruby-glass"},{name:"emerald",base:"MineralBase",weight:.15,value:l("mineral",150),char:"*",color:{fg:"Green",bg:"Black"}},{name:"froststone",base:"MineralBase",weight:.25,value:l("mineral",150),char:"*",color:{fg:"LightCyan",bg:"Gray"}},{name:"permaice ore",base:"MineralBase",weight:.4,value:l("mineral",100),className:"cell-item-ice"},{name:"sapphire",base:"MineralBase",weight:.15,value:l("mineral",150),char:"*",color:{fg:"Blue",bg:"White"}},{name:"forium ore",base:"MineralBase",weight:.2,value:l("mineral",150),className:"cell-item-magic"},{name:"netherium ore",base:"MineralBase",weight:.3,value:l("mineral",200),className:"cell-item-void"},{name:"ruby",base:"MineralBase",weight:.2,value:l("mineral",250),char:"*",className:"cell-item-ruby-glass"},{name:"diamond",base:"MineralBase",weight:.3,value:l("mineral",300),char:"*",color:o.color("white","blue")},{name:"ice diamond",base:"MineralBase",weight:.3,value:l("mineral",400),char:"*",className:"cell-item-ice"},{name:"Blizzard Star",base:"MineralBase",weight:1,value:l("mineral",600),char:"*",color:o.color("cyan","darkblue")},{name:"MagicBoltBase",noRandom:!0,type:"ammo",char:"*",addComp:"Magical"},{name:"Fire bolt",base:"MagicBoltBase",className:"cell-item-fire"},{name:"MagicalArrowBase",noRandom:!0,type:"ammo",char:"➹",addComp:"Magical"},{name:"Ice arrow",base:"MagicalArrowBase",className:"cell-item-ice"},{name:"Lightning arrow",base:"MagicalArrowBase",className:"cell-item-lightning"},{name:"Energy arrow",base:"MagicalArrowBase",className:"cell-item-energy"},{name:"Poison arrow",base:"MagicalArrowBase",className:"cell-item-poison"},{name:"Arrow of webs",base:"MagicalArrowBase",className:"cell-item-energy"}];var u;function h(e,t){return{addElement:{elementName:"PlantedSoil",setters:{get:"PlantedSoil",setTimeLeftToGrow:t,setGrowsInto:e},successCheck:[{elements:{has:"TilledSoil"}}],failureMsg:"Seeds cannot be planted here."}}}t.dmgTypes={sword:r.default.DMG.SLASH,spear:r.default.DMG.PIERCE,dagger:r.default.DMG.SLASH,axe:r.default.DMG.SLASH,dart:r.default.DMG.PIERCE,shuriken:r.default.DMG.SLASH,bow:r.default.DMG.PIERCE,crossbow:r.default.DMG.PIERCE,rifle:r.default.DMG.PIERCE},c.forEach(e=>{e.damageType||(e.weaponType?t.dmgTypes.hasOwnProperty(e.weaponType)&&(e.damageType=t.dmgTypes[e.weaponType]):e.ammoType&&t.dmgTypes.hasOwnProperty(e.ammoType)&&(e.damageType=t.dmgTypes[e.ammoType]))}),u=c,Object.values(r.default.DMG).forEach(e=>{"EFFECT"!==e&&Object.entries(r.default.RESISTANCE).forEach(t=>{const s=t[0],n=o.resistance(e,s),a=10*t[1];n.name="Resistance",n.duration="5d10 + 10";let i="Potion of "+s.toLowerCase()+" "+e.toLowerCase();t[1]===r.default.RESISTANCE.IMMUNITY?i="Potion of "+e.toLowerCase()+" "+s.toLowerCase():t[1]!==r.default.RESISTANCE.ABSORB&&(i+=" resistance");const c={name:i,base:"PotionBase",use:{addComp:n},value:l("potion",a)};u.push(c)})}),function(e){const t=[["",1],[" greater",2]];r.default.STATS.forEach(s=>{const n=s.toLowerCase();t.forEach(t=>{const[s,r]=t,a={name:"Potion of"+s+" "+n,base:"PotionBase",use:{modifyStat:{value:r,statName:n}},value:l("potion",200*r)};e.push(a)})})}(c),c.push(...i.GemItems),t.default=c},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GemItems=void 0;t.GemItems=[{type:"mineral",base:"MineralBase",name:"Amber",gemType:"Phosphate",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"Yellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Apatite",gemType:"Carbonate",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"GhostWhite",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Azurite",gemType:"Cyclosilicate",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Azure",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Benitoite",gemType:"Beryl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[150]},color:{fg:"Blue",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Aquamarine",gemType:"Beryl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[75,150]},color:{fg:"Aquamarine",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Bixbite",gemType:"Beryl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[300]},color:{fg:"Red",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Emerald",gemType:"Beryl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Heliodor",gemType:"Beryl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"Yellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Goshenite",gemType:"Beryl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"GhostWhite",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Morganite",gemType:"Calcite",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"MistyRose",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Marble",gemType:"Calcite",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"White",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Mexican onyx",gemType:"Calcite",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Ivory",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Charoite",gemType:"Chrysoberyl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Violet",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Alexandrite",gemType:"Chrysoberyl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[150]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Catʼs eye",gemType:"Chrysoberyl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Chrysolite",gemType:"Chrysoberyl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[75]},color:{fg:"Yellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Chrysocolla",gemType:"Chrysoberyl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Coral",gemType:"Corundum",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Coral",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Ruby",gemType:"Corundum",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[300]},color:{fg:"Red",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Sapphire",gemType:"Corundum",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[150]},color:{fg:"Blue",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Star Sapphire",gemType:"Corundum",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"Red",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Star Ruby",gemType:"Corundum",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"Red",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Cubic zirconia",gemType:"Corundum",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"GhostWhite",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Diamond",gemType:"Feldspar",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[300]},color:{fg:"White",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Amazonite",gemType:"Feldspar",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"DarkSeaGreen",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Labradorite",gemType:"Feldspar",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"DimGray",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Sunstone",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Orange",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Garnet",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"Brown",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Almandine",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"OrangeRed",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Andradite",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"YellowGreen",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Demantoid",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"GreenYellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Topazolite",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"LightYellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Grossular",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"GhostWhite",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Tsavorite",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Hessonite",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"LightGoldenRodYellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Pyrope",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"DeepPink",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Chrome Pyrope",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[75,300]},color:{fg:"HotPink",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Malaia",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"RosyBrown",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Rhodolite",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"MediumPurple",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Spessartine",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"Orange",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Uvarovite",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"ForestGreen",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Hematite",gemType:"Jade",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Black",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Jadeite",gemType:"Jade",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,300]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Nephrite",gemType:"Jade",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Purple",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Jet",gemType:"lazuli",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Brown",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Lapis lazuli",gemType:"lazuli",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"DarkSlateBlue",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Malachite",gemType:"lazuli",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"DarkGreen",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Moissanite",gemType:"lazuli",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"PaleGreen",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Obsidian",gemType:"lazuli",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Gray",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Opal",gemType:"lazuli",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"OrangeRed",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Peridot",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[75]},color:{fg:"Yellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Agate",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"LightSalmon",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Amethyst",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[75]},color:{fg:"Purple",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Aventurine",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Cairngorm",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Darkorange",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Carnelian",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"IndianRed",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Chalcedony",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"PowderBlue",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Chrysoprase",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Citrine",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Yellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Jasper",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Crimson",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Onyx",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"White",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Petrified wood",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Brown",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Rock crystal",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"GhostWhite",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Rose",gemType:"Other",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Pink",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Tigerʼs eye",gemType:"Carbonate",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"LightGoldenRodYellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Rhodochrosite",gemType:"Inosilicate",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"MistyRose",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Rhodonite",gemType:"Shell",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"DarkRed",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Mother-of-pearl",gemType:"Shell",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"White",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Pearl",gemType:"Shell",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"White",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Spinel",gemType:"Spodumene",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[75]},color:{fg:"MediumVioletRed",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Hiddenite",gemType:"Spodumene",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[75]},color:{fg:"Yellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Kunzite",gemType:"Spodumene",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Pink",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Tanzanite",gemType:"Topaz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[150]},color:{fg:"lavender",bg:"black"}},{type:"mineral",base:"MineralBase",name:"White Topaz",gemType:"Topaz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"White",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Blue Topaz",gemType:"Topaz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Blue",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Green Topaz",gemType:"Topaz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Pink Topaz",gemType:"Tourmaline",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"Pink",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Achorite",gemType:"Tourmaline",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"GhostWhite",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Dravite",gemType:"Tourmaline",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Brown",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Indicolite",gemType:"Tourmaline",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"DarkBlue",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Rubellite",gemType:"Tourmaline",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Pink",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Siberite",gemType:"Tourmaline",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Violet",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Verdilite",gemType:"Turquoise",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Turquoise",gemType:"Other",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Turquoise",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Unakite",gemType:"Zircon",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"DarkOliveGreen",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Jargon",gemType:"Zircon",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"White",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Matura diamond",gemType:"Zircon",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"GhostWhite",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Yellow Hyacinth",gemType:"Zircon",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"Yellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Orange Hyacinth",gemType:"Zircon",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"Orange",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Red Hyacinth",gemType:"Zircon",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"Red",bg:"black"}}]},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=s(47),r=["∙",":","⋮"],a=["∼","≈","≋"],o=[{name:"bed",className:"cell-element-bed",char:"=",msg:{onEnter:"There is a bed here for resting"},addComp:["Indoor"]},{name:"bridge",className:"cell-element-bridge",char:"=",msg:{onEnter:"You are standing on a bridge."},addComp:[{comp:"Terrain",func:{setMods:[n.defensePenalty(.5,["Flying"])]}}]},{name:"shallow chasm",className:"cell-element-chasm",char:a[0],addComp:["Impassable"],z:-1,callbacks:{onRemoveFlyingEntity:{addComp:[{comp:"Paralysis"}]},onAddFlyingEntity:{removeComp:[{comp:"Paralysis"}]}}},{name:"chasm",className:"cell-element-chasm",char:a[1],addComp:["Impassable"],z:-2,callbacks:{onRemoveFlyingEntity:{addComp:[{comp:"Paralysis"}]},onAddFlyingEntity:{removeComp:[{comp:"Paralysis"}]}}},{name:"deep chasm",className:"cell-element-chasm",char:a[2],addComp:["Impassable"],z:-10},{name:"grass",className:"cell-element-grass",char:'"',msg:{onEnter:"You see some grass."},addComp:[{comp:"Terrain",func:{setMods:[n.speedPenalty(.1,["Flying"])]}}]},{name:"snowy grass",className:"cell-element-snowy-grass",char:'"',msg:{onEnter:"You see some snow-covered grass."},addComp:[{comp:"Terrain",func:{setMods:[n.speedPenalty(.15,["Flying"])]}}]},{name:"highrock",className:"cell-element-highrock",char:"^",addComp:["Impassable","Opaque"]},{name:"floor",className:"cell-element-floor",char:".",addComp:["Tillable"]},{name:"floorcastle",className:"cell-element-floor-castle",char:".",addComp:["Indoor"]},{name:"floordungeon",className:"cell-element-floor-dungeon",char:".",addComp:["Indoor"]},{name:"floorcave",className:"cell-element-floor-cave",char:".",addComp:["Indoor"]},{name:"floorcrypt",className:"cell-element-floor-crypt",char:".",addComp:["Indoor"]},{name:"floorhouse",className:"cell-element-floor-house",char:".",addComp:["Indoor"]},{name:"floorwooden",className:"cell-element-floor-wooden",char:".",addComp:["Indoor"]},{name:"fort",className:"cell-element-fort",char:"#",addComp:["Impassable"]},{name:"lava",className:"cell-element-lava",char:"~",addComp:["Impassable"]},{name:"path",className:"cell-element-path",char:".",z:1},{name:"road",className:"cell-element-road",char:".",msg:{onEnter:"You tread lightly on the road."}},{name:"sky",className:"cell-element-sky",char:"~",addComp:["Impassable"]},{name:"light snow",className:"cell-element-light-snow",char:".",addComp:["Snowy"],msg:{onEnter:"A thin layer of snow is on the ground"}},{name:"light snow with tracks",className:"cell-element-light-snow-tracks",char:".",addComp:["Snowy"],msg:{onEnter:"Someone has traversed this thin crust of snow"}},{name:"snow",className:"cell-element-snow",char:".",msg:{onEnter:"Ground is covered with snow."},addComp:["Snowy",{comp:"Terrain",func:{setMods:[n.speedPenalty(.1,["Flying","SnowWalk"])]}}]},{name:"snow with tracks",className:"cell-element-snow-tracks",char:".",addComp:["Snowy"],msg:{onEnter:"Someone has left their tracks on snow"}},{name:"deep snow",className:"cell-element-deep-snow",char:".",msg:{onEnter:"Snow is deep and difficult to traverse here"},addComp:["Snowy",{comp:"Terrain",func:{setMods:[n.speedPenalty(.25,["Flying","SnowWalk"])]}}]},{name:"deep snow with tracks",className:"cell-element-deep-snow-tracks",char:".",msg:{onEnter:"Snow is deep, but there are some tracks here"},addComp:["Snowy",{comp:"Terrain",func:{setMods:[n.speedPenalty(.1,["Flying","SnowWalk"])]}}]},{name:"cliff",className:"cell-element-stone",char:r[0],z:1,msg:{onEnter:"Difficult rocky terrain slows you down."},addComp:[{comp:"Terrain",func:{setMods:[n.speedPenalty(.25,["Flying"])]}}]},{name:"stone",className:"cell-element-stone",char:r[1],z:2,msg:{onEnter:"Difficult rocky terrain slows you down."},addComp:[{comp:"Terrain",func:{setMods:[n.speedPenalty(.25,["Flying"])]}}]},{name:"steep cliff",className:"cell-element-stone",char:r[2],z:3,msg:{onEnter:"Difficult rocky terrain slows you down."},addComp:[{comp:"Terrain",func:{setMods:[n.speedPenalty(.25,["Flying"])]}}]},{name:"snowy cliff",className:"cell-element-snow-tree",char:r[0],z:1,msg:{onEnter:"Difficult and slippery snowy terrain slows you down."},addComp:["Snowy",{comp:"Terrain",func:{setMods:[n.speedPenalty(.35,["Flying"])]}}]},{name:"snow-covered stone",className:"cell-element-snow-tree",char:r[1],z:2,msg:{onEnter:"Difficult and slippery snowy terrain slows you down."},addComp:["Snowy",{comp:"Terrain",func:{setMods:[n.speedPenalty(.35,["Flying"])]}}]},{name:"frozen steep cliff",className:"cell-element-snow-tree",char:r[2],z:3,msg:{onEnter:"Difficult and slippery snowy terrain slows you down."},addComp:["Snowy",{comp:"Terrain",func:{setMods:[n.speedPenalty(.35,["Flying"])]}}]},{name:"tree",className:"cell-element-tree",char:"T",addComp:["Opaque"],msg:{onEnter:"There is a tree here."}},{name:"large tree",className:"cell-element-tree-large",char:"T",addComp:["Impassable","Opaque"],msg:{onEnter:"There is a large tree here."}},{name:"snow-covered tree",className:"cell-element-snow-tree",char:"T",addComp:["Opaque","Snowy"],msg:{onEnter:"There is a snow-covered tree here."}},{name:"large frozen tree",className:"cell-element-tree-large-frozen",char:"T",addComp:["Impassable","Opaque"],msg:{onEnter:"There is a large frozen tree here."}},{name:"shallow water",className:"cell-element-water",char:a[0],msg:{onEnter:"Shallow water slows you down slightly"},addComp:[{comp:"Terrain",func:{setMods:[n.speedPenalty(.1,["Flying","Amphibious"]),n.defensePenalty(.1,["Flying","Amphibious"]),n.attackPenalty(.1,["Flying","Amphibious"])]}}],callbacks:{onEnter:{addComp:[{comp:"Drenched",useOld:!0,func:{incrLevel:1}}]}}},{name:"water",className:"cell-element-water",char:a[1],msg:{onEnter:"Water slows you down"},addComp:[{comp:"Terrain",func:{setMods:[n.speedPenalty(.25,["Flying","Amphibious"]),n.defensePenalty(.25,["Flying","Amphibious"]),n.attackPenalty(.25,["Flying","Amphibious"])]}}],callbacks:{onEnter:{addComp:[{comp:"Drenched",useOld:!0,func:{incrLevel:2}}]},onRemoveParalysisEntity:{removeComp:[{comp:"Drowning"}]},onAddParalysisEntity:{addComp:[{comp:"Drowning"}]}}},{name:"deep water",className:"cell-element-water",char:a[2],msg:{onEnter:"Deep water makes moving extremely difficult"},addComp:[{comp:"Terrain",func:{setMods:[n.speedPenalty(.5,["Flying","Amphibious"]),n.defensePenalty(.5,["Flying","Amphibious"]),n.attackPenalty(.5,["Flying","Amphibious"])]}}],callbacks:{onEnter:{addComp:[{comp:"Drenched",useOld:!0,func:{incrLevel:4}}]},onRemoveParalysisEntity:{removeComp:[{comp:"Drowning"}]},onAddParalysisEntity:{addComp:[{comp:"Drowning"}]}}},{name:"frozen shallow water",className:"cell-element-frozen-water",char:a[0],msg:{onEnter:"There is some ice here"},addComp:["Snowy",{comp:"Terrain",func:{setMods:[n.speedPenalty(.15,["Flying"])]}}]},{name:"frozen water",className:"cell-element-frozen-water",char:a[1],msg:{onEnter:"There is some ice here"},addComp:["Snowy",{comp:"Terrain",func:{setMods:[n.speedPenalty(.15,["Flying"])]}}]},{name:"frozen deep water",className:"cell-element-frozen-water",char:a[2],msg:{onEnter:"There is some ice here"},addComp:["Snowy",{comp:"Terrain",func:{setMods:[n.speedPenalty(.15,["Flying"])]}}]},{name:"wallcave",className:"cell-element-wall-cave",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]}]},{name:"walldungeon",className:"cell-element-wall-dungeon",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]}]},{name:"wallcrypt",className:"cell-element-wall-crypt",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]}]},{name:"wallwooden",className:"cell-element-wall-wooden",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]}]},{name:"wallice",className:"cell-element-wall-ice",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]}]},{name:"wallcastle",className:"cell-element-wall-castle",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]}]},{name:"wallruby",className:"style-ruby",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]}]},{name:"wallvoid",className:"style-void",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]}]},{name:"wallforium",className:"style-forium",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]}]},{name:"closed window",className:"cell-element-window",char:"+",addComp:["Impassable"]},{name:"tilled soil",noRandom:!0,className:"cell-element-floor",char:"|"},{name:"planted soil",noRandom:!0,className:"cell-element-floor",char:"+"},{dontCreate:!0,name:"web",char:"|",className:"cell-element-web"},{dontCreate:!0,name:"slime",char:"|",className:"cell-element-slime"},{dontCreate:!0,name:"hole",char:"^",className:"cell-element-hole"},{dontCreate:!0,name:"mountain",char:"⛰",className:"cell-element-mountain"},{dontCreate:!0,name:"town",char:"o",className:"cell-element-town"},{dontCreate:!0,name:"battle",char:"X",className:"cell-element-battle"},{dontCreate:!0,name:"cityfort",char:"o",className:"cell-element-fort"}];t.default=o},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.JobSchedule=t.SchedEntry=void 0;const r=n(s(5)).default("bitn:JobSchedule"),a=s(18),o=s(152),i=s(153);class l{constructor(e){e.needs.forEach(e=>{e.constr&&o.processNeed(e)}),this.entry=e}static create(e){return new l(e)}}t.SchedEntry=l;const c={from:0,to:720,in:{bbox:new a.BBox(0,0,9,9),levelID:0},needs:[i.Needs.Rest]},u={from:720,to:1440,in:{bbox:new a.BBox(70,20,79,27),levelID:0},needs:[i.Needs.FindWeapon]};t.JobSchedule=class{constructor(e){this.name=e,this.entries=[],this.addEntry(c),this.addEntry(u),this._debug=r.enabled}setDebug(e){this._debug=e}dbg(...e){this._debug&&console.log("["+this.name,...e)}addEntry(e){this.entries.forEach(t=>{this.checkOverlap(e,t.entry)}),this.entries.push(new l(e))}getCurrentNeeds(e,t){const s=this.getCurrEntry(t),n=[];if(!s)return n;if(s.in){const t=s.in.bbox;if(!t.hasXY(e.getX(),e.getY())){const s=t.getRandXY();if(n.push(["FollowPath",1,{xy:s,isOneShot:!0}]),this._debug){const t=`${e.getX()},${e.getY()} -> ${s}`;this.dbg("Added one shot entry to FollowPath "+t)}return n}}const{needs:r}=s;for(let s=0;s<r.length;s++){const a=r[s];if(a.func&&a.func(e)){const e=[a.evalName,a.bias];if(a.only)return[e];if(n.push(e),a.last)return n}else if(a.script){const s=a.script(e,t);if(s.length>0){if(a.only)return s;if(n.push(...s),a.last)return n}}}return n}getCurrEntry(e){for(let t=0;t<this.entries.length;t++){const s=this.entries[t].entry;if(s.from<s.to){if(e>=s.from&&e<=s.to)return this._debug&&this.dbg("Found entry:",s),s}else if(e>=s.from||e<=s.to)return this.dbg("Found entry:",s),s}return null}checkOverlap(e,t){t.to,t.from,e.to,e.from}}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CastleGenerator=void 0;const i=o(s(0)),l=s(59),c=a(s(7)),u=s(33),h=s(34),d=s(11),f=s(53),g=s(90),p=s(134),m=s(45),y=s(30),_=s(1),b=s(4),v=s(10),E=s(8),S=_.Random.getRNG();class w extends u.LevelGenerator{constructor(){super(),this.addDoors=!0,this.shouldRemoveMarkers=!0,this.nItemsAdded=0}static getOptions(){const e=u.LevelGenerator.getOptions();return e.centralCorridors=!1,e.roomCount=-1,e}static carvePathFromEdge(e,t){const s=e.getFreeEdgeCells(),n=e.getMap(),r=e.getCellWithElem(t),a=s[0],[o,i]=a.getXY(),[l,c]=r.getXY(),u=v.Path.getShortestPath(o,i,l,c,(e,t)=>n.hasXY(e,t)&&"wallcastle"!==n.getCell(e,t).getBaseElem().getType());return u.forEach(e=>{const t=n.getCell(e.x,e.y);t.isFree()||t.setBaseElem(E.ELEM.FLOOR)}),u}create(e,t,s){const n=this.createLevel(e,t,s);return this.removeMarkers(n,s),s.addItems&&(this.nItemsAdded=this.addItemsToCastle(n,s)),this.populateStoreRooms(n,s),s.addActors&&i.default.err("CastleGenerator","create","addActors == true not supported yet"),n}createLevel(e,t,s){const n=Object.assign({dungeonType:"castle",wallType:"wallcastle",floorType:"floorcastle"},s);n.preserveMarkers=!0;const r=new h.MapGenerator,a=function(e){if(e.cellsAround){const{cellsAround:t}=e,s=[],n=new p.LevelSurroundings;if(n.getNonBlockedDirs(t).forEach(e=>{s.push(g.Castle.startFuncs[e])}),0!==s.length)return S.arrayGetRand(s);i.default.warn("CastleGenerator","getGateDirFunction","No free cellsAround "+JSON.stringify(t))}return null}(s);a&&(n.startRoomFunc=a),s.centralCorridors&&(n.constraintFunc=g.Castle.constraintFuncCross);const o=r.createCastle(e,t,n);let l=new d.Level(o.map);return l.setMap(o.map,o),this.addMarkersFromTiles(l,o.tiles),s.cellsAround&&(l=this.createCastleSurroundings(l,s),l||i.default.err("CastleGenerator","createLevel","Got null level from surround. Something went wrong")),this.createDoorsAndLevers(l),l}addItemsToCastle(e,t){let s=0;const n=e.getExtras(),r=n.storeroom,{maxValue:a}=t;if(!a)return i.default.err("CastleGenerator","addItemsToCastle","maxValue was not given in conf "+JSON.stringify(t)),0;const o={item:e=>e.value<=2*a&&e.value>=a,maxValue:a,nItems:1},l=new m.FactoryItem;if(r.forEach(t=>{const n=l.generateItems(o);y.Placer.addPropsToRoom(e,t,n)&&(s+=n.length)}),i.default.isSuccess(C)){const t=S.arrayGetRand(r),n=S.getUniformInt(6,12),o=l.generateGold({nGold:5,nLevel:n,maxValue:a});y.Placer.addPropsToRoom(e,t,o)&&(s+=o.length)}const c=n.room;o.nItems=c.length;return l.generateItems(o).forEach(t=>{const n=S.arrayGetRand(c);y.Placer.addPropsToRoom(e,n,[t])&&(s+=1)}),s}addMarkersFromTiles(e,t){e.setExtras({corridor:[],entrance:[],room:[],storeroom:[],vault:[]}),Object.values(t).forEach(t=>{T.storeroom.test(t.name)?this.addToExtras(e,t,"storeroom"):T.vault.test(t.name)?this.addToExtras(e,t,"vault"):T.entrance.test(t.name)?this.addToExtras(e,t,"entrance"):T.corridor.test(t.name)?this.addToExtras(e,t,"corridor"):T.filler.test(t.name)||this.addToExtras(e,t,"room")})}addToExtras(e,t,s){const n=b.Geometry.convertBbox(t);e.getMap().getFreeInBbox(n).forEach(t=>{const[n,r]=t.getXY(),a=new c.ElementMarker(O[s]);a.setTag(s),e.addElement(a,n,r)});const r=new l.Room(n.ulx,n.uly,n.lrx,n.lry);e.getExtras()[s].push(r)}createDoorsAndLevers(e){const t=e.getMap(),s=t.getCells(),n={},r=[];s.forEach(s=>{if(s.hasElements()){const[a,o]=s.getXY();if(s.hasMarker("leverdoor")){const r=new c.ElementLeverDoor;t.getCell(a,o).removeProps(i.default.TYPE_ELEM),e.addElement(r,a,o),n[s.getKeyXY()]=r}else if(s.hasMarker("lever")){const s=new c.ElementLever;t.getCell(a,o).removeProps(i.default.TYPE_ELEM),e.addElement(s,a,o),r.push(s)}else if(s.hasMarker("door")){const s=new c.ElementDoor(!0);t.getCell(a,o).removeProps(i.default.TYPE_ELEM),e.addElement(s,a,o)}}}),r.forEach(e=>{const[s,r]=e.getXY();b.Geometry.getBoxAround(s,r,1).forEach(a=>{const o=a[0]+","+a[1];if(n[o]){let n=t.getCell(a[0],a[1]).getPropType("leverdoor");n?n=n[0]:i.default.err("CastleGenerator","createDoorsAndLevers",`No door found for lever@${s},${r}`),e.addTarget(n)}})})}populateStoreRooms(e,t){const s=new f.DungeonPopulate;t.actorFunc&&s.setActorFunc(t.actorFunc);const n=t.maxDanger,r=e.getExtras();if(r.storeroom){const a=r.storeroom;a.forEach(t=>{const r=t.getCenter();s.addPointGuardian(e,r,n)});const o=S.arrayGetRand(a);if(o){const r=o.getCenter();s.addMainLoot(e,r,t.maxValue)&&s.addPointGuardian(e,r,n+4)}}}createCastleSurroundings(e,t){const s=new p.LevelSurroundings,n=e.getExtras(),r=s.surround(e,t);return r?(r.setExtras(n),s.scaleExtras(r),r):null}}t.CastleGenerator=w;const C=.1,T={corridor:/(corridor|corner)/,entrance:/entrance/,storeroom:/storeroom/,vault:/vault/,filler:/filler/i},O={corridor:"C",room:"R",entrance:"E",storeroom:"S",vault:"V"}},function(e,t,s){var n=s(280);e.exports={Graph:n.Graph,json:s(406),alg:s(407),version:n.version}},function(e,t,s){e.exports={Graph:s(108),version:s(405)}},function(e,t,s){var n=s(282);e.exports=function(e){return n(e,4)}},function(e,t,s){var n=s(109),r=s(113),a=s(158),o=s(311),i=s(317),l=s(320),c=s(321),u=s(322),h=s(323),d=s(168),f=s(324),g=s(50),p=s(328),m=s(329),y=s(334),_=s(9),b=s(60),v=s(335),E=s(40),S=s(337),w=s(41),C={};C["[object Arguments]"]=C["[object Array]"]=C["[object ArrayBuffer]"]=C["[object DataView]"]=C["[object Boolean]"]=C["[object Date]"]=C["[object Float32Array]"]=C["[object Float64Array]"]=C["[object Int8Array]"]=C["[object Int16Array]"]=C["[object Int32Array]"]=C["[object Map]"]=C["[object Number]"]=C["[object Object]"]=C["[object RegExp]"]=C["[object Set]"]=C["[object String]"]=C["[object Symbol]"]=C["[object Uint8Array]"]=C["[object Uint8ClampedArray]"]=C["[object Uint16Array]"]=C["[object Uint32Array]"]=!0,C["[object Error]"]=C["[object Function]"]=C["[object WeakMap]"]=!1,e.exports=function e(t,s,T,O,A,M){var N,P=1&s,D=2&s,I=4&s;if(T&&(N=A?T(t,O,A,M):T(t)),void 0!==N)return N;if(!E(t))return t;var L=_(t);if(L){if(N=p(t),!P)return c(t,N)}else{var x=g(t),k="[object Function]"==x||"[object GeneratorFunction]"==x;if(b(t))return l(t,P);if("[object Object]"==x||"[object Arguments]"==x||k&&!A){if(N=D||k?{}:y(t),!P)return D?h(t,i(N,t)):u(t,o(N,t))}else{if(!C[x])return A?t:{};N=m(t,x,P)}}M||(M=new n);var R=M.get(t);if(R)return R;M.set(t,N),S(t)?t.forEach((function(n){N.add(e(n,s,T,n,t,M))})):v(t)&&t.forEach((function(n,r){N.set(r,e(n,s,T,r,t,M))}));var B=I?D?f:d:D?keysIn:w,F=L?void 0:B(t);return r(F||t,(function(n,r){F&&(n=t[r=n]),a(N,r,e(n,s,T,r,t,M))})),N}},function(e,t){e.exports=function(){this.__data__=[],this.size=0}},function(e,t,s){var n=s(75),r=Array.prototype.splice;e.exports=function(e){var t=this.__data__,s=n(t,e);return!(s<0)&&(s==t.length-1?t.pop():r.call(t,s,1),--this.size,!0)}},function(e,t,s){var n=s(75);e.exports=function(e){var t=this.__data__,s=n(t,e);return s<0?void 0:t[s][1]}},function(e,t,s){var n=s(75);e.exports=function(e){return n(this.__data__,e)>-1}},function(e,t,s){var n=s(75);e.exports=function(e,t){var s=this.__data__,r=n(s,e);return r<0?(++this.size,s.push([e,t])):s[r][1]=t,this}},function(e,t,s){var n=s(74);e.exports=function(){this.__data__=new n,this.size=0}},function(e,t){e.exports=function(e){var t=this.__data__,s=t.delete(e);return this.size=t.size,s}},function(e,t){e.exports=function(e){return this.__data__.get(e)}},function(e,t){e.exports=function(e){return this.__data__.has(e)}},function(e,t,s){var n=s(74),r=s(111),a=s(112);e.exports=function(e,t){var s=this.__data__;if(s instanceof n){var o=s.__data__;if(!r||o.length<199)return o.push([e,t]),this.size=++s.size,this;s=this.__data__=new a(o)}return s.set(e,t),this.size=s.size,this}},function(e,t,s){var n=s(76),r=s(296),a=s(40),o=s(157),i=/^\[object .+?Constructor\]$/,l=Function.prototype,c=Object.prototype,u=l.toString,h=c.hasOwnProperty,d=RegExp("^"+u.call(h).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=function(e){return!(!a(e)||r(e))&&(n(e)?d:i).test(o(e))}},function(e,t,s){var n=s(49),r=Object.prototype,a=r.hasOwnProperty,o=r.toString,i=n?n.toStringTag:void 0;e.exports=function(e){var t=a.call(e,i),s=e[i];try{e[i]=void 0;var n=!0}catch(e){}var r=o.call(e);return n&&(t?e[i]=s:delete e[i]),r}},function(e,t){var s=Object.prototype.toString;e.exports=function(e){return s.call(e)}},function(e,t,s){var n,r=s(297),a=(n=/[^.]+$/.exec(r&&r.keys&&r.keys.IE_PROTO||""))?"Symbol(src)_1."+n:"";e.exports=function(e){return!!a&&a in e}},function(e,t,s){var n=s(24)["__core-js_shared__"];e.exports=n},function(e,t){e.exports=function(e,t){return null==e?void 0:e[t]}},function(e,t,s){var n=s(300),r=s(74),a=s(111);e.exports=function(){this.size=0,this.__data__={hash:new n,map:new(a||r),string:new n}}},function(e,t,s){var n=s(301),r=s(302),a=s(303),o=s(304),i=s(305);function l(e){var t=-1,s=null==e?0:e.length;for(this.clear();++t<s;){var n=e[t];this.set(n[0],n[1])}}l.prototype.clear=n,l.prototype.delete=r,l.prototype.get=a,l.prototype.has=o,l.prototype.set=i,e.exports=l},function(e,t,s){var n=s(77);e.exports=function(){this.__data__=n?n(null):{},this.size=0}},function(e,t){e.exports=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}},function(e,t,s){var n=s(77),r=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;if(n){var s=t[e];return"__lodash_hash_undefined__"===s?void 0:s}return r.call(t,e)?t[e]:void 0}},function(e,t,s){var n=s(77),r=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;return n?void 0!==t[e]:r.call(t,e)}},function(e,t,s){var n=s(77);e.exports=function(e,t){var s=this.__data__;return this.size+=this.has(e)?0:1,s[e]=n&&void 0===t?"__lodash_hash_undefined__":t,this}},function(e,t,s){var n=s(78);e.exports=function(e){var t=n(this,e).delete(e);return this.size-=t?1:0,t}},function(e,t){e.exports=function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}},function(e,t,s){var n=s(78);e.exports=function(e){return n(this,e).get(e)}},function(e,t,s){var n=s(78);e.exports=function(e){return n(this,e).has(e)}},function(e,t,s){var n=s(78);e.exports=function(e,t){var s=n(this,e),r=s.size;return s.set(e,t),this.size+=s.size==r?0:1,this}},function(e,t,s){var n=s(79),r=s(41);e.exports=function(e,t){return e&&n(t,r(t),e)}},function(e,t){e.exports=function(e,t){for(var s=-1,n=Array(e);++s<e;)n[s]=t(s);return n}},function(e,t,s){var n=s(48),r=s(29);e.exports=function(e){return r(e)&&"[object Arguments]"==n(e)}},function(e,t){e.exports=function(){return!1}},function(e,t,s){var n=s(48),r=s(115),a=s(29),o={};o["[object Float32Array]"]=o["[object Float64Array]"]=o["[object Int8Array]"]=o["[object Int16Array]"]=o["[object Int32Array]"]=o["[object Uint8Array]"]=o["[object Uint8ClampedArray]"]=o["[object Uint16Array]"]=o["[object Uint32Array]"]=!0,o["[object Arguments]"]=o["[object Array]"]=o["[object ArrayBuffer]"]=o["[object Boolean]"]=o["[object DataView]"]=o["[object Date]"]=o["[object Error]"]=o["[object Function]"]=o["[object Map]"]=o["[object Number]"]=o["[object Object]"]=o["[object RegExp]"]=o["[object Set]"]=o["[object String]"]=o["[object WeakMap]"]=!1,e.exports=function(e){return a(e)&&r(e.length)&&!!o[n(e)]}},function(e,t,s){var n=s(163)(Object.keys,Object);e.exports=n},function(e,t,s){var n=s(79),r=s(164);e.exports=function(e,t){return e&&n(t,r(t),e)}},function(e,t,s){var n=s(40),r=s(82),a=s(319),o=Object.prototype.hasOwnProperty;e.exports=function(e){if(!n(e))return a(e);var t=r(e),s=[];for(var i in e)("constructor"!=i||!t&&o.call(e,i))&&s.push(i);return s}},function(e,t){e.exports=function(e){var t=[];if(null!=e)for(var s in Object(e))t.push(s);return t}},function(e,t,s){(function(e){var n=s(24),r=t&&!t.nodeType&&t,a=r&&"object"==typeof e&&e&&!e.nodeType&&e,o=a&&a.exports===r?n.Buffer:void 0,i=o?o.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var s=e.length,n=i?i(s):new e.constructor(s);return e.copy(n),n}}).call(this,s(114)(e))},function(e,t){e.exports=function(e,t){var s=-1,n=e.length;for(t||(t=Array(n));++s<n;)t[s]=e[s];return t}},function(e,t,s){var n=s(79),r=s(119);e.exports=function(e,t){return n(e,r(e),t)}},function(e,t,s){var n=s(79),r=s(167);e.exports=function(e,t){return n(e,r(e),t)}},function(e,t,s){var n=s(169),r=s(167),a=s(164);e.exports=function(e){return n(e,a,r)}},function(e,t,s){var n=s(39)(s(24),"DataView");e.exports=n},function(e,t,s){var n=s(39)(s(24),"Promise");e.exports=n},function(e,t,s){var n=s(39)(s(24),"WeakMap");e.exports=n},function(e,t){var s=Object.prototype.hasOwnProperty;e.exports=function(e){var t=e.length,n=new e.constructor(t);return t&&"string"==typeof e[0]&&s.call(e,"index")&&(n.index=e.index,n.input=e.input),n}},function(e,t,s){var n=s(122),r=s(330),a=s(331),o=s(332),i=s(333);e.exports=function(e,t,s){var l=e.constructor;switch(t){case"[object ArrayBuffer]":return n(e);case"[object Boolean]":case"[object Date]":return new l(+e);case"[object DataView]":return r(e,s);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return i(e,s);case"[object Map]":return new l;case"[object Number]":case"[object String]":return new l(e);case"[object RegExp]":return a(e);case"[object Set]":return new l;case"[object Symbol]":return o(e)}}},function(e,t,s){var n=s(122);e.exports=function(e,t){var s=t?n(e.buffer):e.buffer;return new e.constructor(s,e.byteOffset,e.byteLength)}},function(e,t){var s=/\w*$/;e.exports=function(e){var t=new e.constructor(e.source,s.exec(e));return t.lastIndex=e.lastIndex,t}},function(e,t,s){var n=s(49),r=n?n.prototype:void 0,a=r?r.valueOf:void 0;e.exports=function(e){return a?Object(a.call(e)):{}}},function(e,t,s){var n=s(122);e.exports=function(e,t){var s=t?n(e.buffer):e.buffer;return new e.constructor(s,e.byteOffset,e.length)}},function(e,t,s){var n=s(172),r=s(121),a=s(82);e.exports=function(e){return"function"!=typeof e.constructor||a(e)?{}:n(r(e))}},function(e,t,s){var n=s(336),r=s(116),a=s(117),o=a&&a.isMap,i=o?r(o):n;e.exports=i},function(e,t,s){var n=s(50),r=s(29);e.exports=function(e){return r(e)&&"[object Map]"==n(e)}},function(e,t,s){var n=s(338),r=s(116),a=s(117),o=a&&a.isSet,i=o?r(o):n;e.exports=i},function(e,t,s){var n=s(50),r=s(29);e.exports=function(e){return r(e)&&"[object Set]"==n(e)}},function(e,t,s){e.exports=s(340)},function(e,t,s){var n=s(113),r=s(83),a=s(344),o=s(9);e.exports=function(e,t){return(o(e)?n:r)(e,a(t))}},function(e,t,s){var n=s(342)();e.exports=n},function(e,t){e.exports=function(e){return function(t,s,n){for(var r=-1,a=Object(t),o=n(t),i=o.length;i--;){var l=o[e?i:++r];if(!1===s(a[l],l,a))break}return t}}},function(e,t,s){var n=s(42);e.exports=function(e,t){return function(s,r){if(null==s)return s;if(!n(s))return e(s,r);for(var a=s.length,o=t?a:-1,i=Object(s);(t?o--:++o<a)&&!1!==r(i[o],o,i););return s}}},function(e,t,s){var n=s(84);e.exports=function(e){return"function"==typeof e?e:n}},function(e,t,s){var n=s(165),r=s(346),a=s(85),o=s(9);e.exports=function(e,t){return(o(e)?n:r)(e,a(t,3))}},function(e,t,s){var n=s(83);e.exports=function(e,t){var s=[];return n(e,(function(e,n,r){t(e,n,r)&&s.push(e)})),s}},function(e,t,s){var n=s(348),r=s(356),a=s(180);e.exports=function(e){var t=r(e);return 1==t.length&&t[0][2]?a(t[0][0],t[0][1]):function(s){return s===e||n(s,e,t)}}},function(e,t,s){var n=s(109),r=s(175);e.exports=function(e,t,s,a){var o=s.length,i=o,l=!a;if(null==e)return!i;for(e=Object(e);o--;){var c=s[o];if(l&&c[2]?c[1]!==e[c[0]]:!(c[0]in e))return!1}for(;++o<i;){var u=(c=s[o])[0],h=e[u],d=c[1];if(l&&c[2]){if(void 0===h&&!(u in e))return!1}else{var f=new n;if(a)var g=a(h,d,u,e,t,f);if(!(void 0===g?r(d,h,3,a,f):g))return!1}}return!0}},function(e,t,s){var n=s(109),r=s(176),a=s(353),o=s(355),i=s(50),l=s(9),c=s(60),u=s(81),h="[object Object]",d=Object.prototype.hasOwnProperty;e.exports=function(e,t,s,f,g,p){var m=l(e),y=l(t),_=m?"[object Array]":i(e),b=y?"[object Array]":i(t),v=(_="[object Arguments]"==_?h:_)==h,E=(b="[object Arguments]"==b?h:b)==h,S=_==b;if(S&&c(e)){if(!c(t))return!1;m=!0,v=!1}if(S&&!v)return p||(p=new n),m||u(e)?r(e,t,s,f,g,p):a(e,t,_,s,f,g,p);if(!(1&s)){var w=v&&d.call(e,"__wrapped__"),C=E&&d.call(t,"__wrapped__");if(w||C){var T=w?e.value():e,O=C?t.value():t;return p||(p=new n),g(T,O,s,f,p)}}return!!S&&(p||(p=new n),o(e,t,s,f,g,p))}},function(e,t){e.exports=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this}},function(e,t){e.exports=function(e){return this.__data__.has(e)}},function(e,t){e.exports=function(e,t){for(var s=-1,n=null==e?0:e.length;++s<n;)if(t(e[s],s,e))return!0;return!1}},function(e,t,s){var n=s(49),r=s(171),a=s(110),o=s(176),i=s(354),l=s(123),c=n?n.prototype:void 0,u=c?c.valueOf:void 0;e.exports=function(e,t,s,n,c,h,d){switch(s){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!h(new r(e),new r(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return a(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var f=i;case"[object Set]":var g=1&n;if(f||(f=l),e.size!=t.size&&!g)return!1;var p=d.get(e);if(p)return p==t;n|=2,d.set(e,t);var m=o(f(e),f(t),n,c,h,d);return d.delete(e),m;case"[object Symbol]":if(u)return u.call(e)==u.call(t)}return!1}},function(e,t){e.exports=function(e){var t=-1,s=Array(e.size);return e.forEach((function(e,n){s[++t]=[n,e]})),s}},function(e,t,s){var n=s(168),r=Object.prototype.hasOwnProperty;e.exports=function(e,t,s,a,o,i){var l=1&s,c=n(e),u=c.length;if(u!=n(t).length&&!l)return!1;for(var h=u;h--;){var d=c[h];if(!(l?d in t:r.call(t,d)))return!1}var f=i.get(e);if(f&&i.get(t))return f==t;var g=!0;i.set(e,t),i.set(t,e);for(var p=l;++h<u;){var m=e[d=c[h]],y=t[d];if(a)var _=l?a(y,m,d,t,e,i):a(m,y,d,e,t,i);if(!(void 0===_?m===y||o(m,y,s,a,i):_)){g=!1;break}p||(p="constructor"==d)}if(g&&!p){var b=e.constructor,v=t.constructor;b==v||!("constructor"in e)||!("constructor"in t)||"function"==typeof b&&b instanceof b&&"function"==typeof v&&v instanceof v||(g=!1)}return i.delete(e),i.delete(t),g}},function(e,t,s){var n=s(179),r=s(41);e.exports=function(e){for(var t=r(e),s=t.length;s--;){var a=t[s],o=e[a];t[s]=[a,o,n(o)]}return t}},function(e,t,s){var n=s(175),r=s(358),a=s(364),o=s(124),i=s(179),l=s(180),c=s(86);e.exports=function(e,t){return o(e)&&i(t)?l(c(e),t):function(s){var o=r(s,e);return void 0===o&&o===t?a(s,e):n(t,o,3)}}},function(e,t,s){var n=s(181);e.exports=function(e,t,s){var r=null==e?void 0:n(e,t);return void 0===r?s:r}},function(e,t,s){var n=s(360),r=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,a=/\\(\\)?/g,o=n((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(r,(function(e,s,n,r){t.push(n?r.replace(a,"$1"):s||e)})),t}));e.exports=o},function(e,t,s){var n=s(361);e.exports=function(e){var t=n(e,(function(e){return 500===s.size&&s.clear(),e})),s=t.cache;return t}},function(e,t,s){var n=s(112);function r(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError("Expected a function");var s=function(){var n=arguments,r=t?t.apply(this,n):n[0],a=s.cache;if(a.has(r))return a.get(r);var o=e.apply(this,n);return s.cache=a.set(r,o)||a,o};return s.cache=new(r.Cache||n),s}r.Cache=n,e.exports=r},function(e,t,s){var n=s(363);e.exports=function(e){return null==e?"":n(e)}},function(e,t,s){var n=s(49),r=s(126),a=s(9),o=s(125),i=n?n.prototype:void 0,l=i?i.toString:void 0;e.exports=function e(t){if("string"==typeof t)return t;if(a(t))return r(t,e)+"";if(o(t))return l?l.call(t):"";var s=t+"";return"0"==s&&1/t==-1/0?"-0":s}},function(e,t,s){var n=s(365),r=s(183);e.exports=function(e,t){return null!=e&&r(e,t,n)}},function(e,t){e.exports=function(e,t){return null!=e&&t in Object(e)}},function(e,t,s){var n=s(184),r=s(367),a=s(124),o=s(86);e.exports=function(e){return a(e)?n(o(e)):r(e)}},function(e,t,s){var n=s(181);e.exports=function(e){return function(t){return n(t,e)}}},function(e,t,s){var n=s(369),r=s(183);e.exports=function(e,t){return null!=e&&r(e,t,n)}},function(e,t){var s=Object.prototype.hasOwnProperty;e.exports=function(e,t){return null!=e&&s.call(e,t)}},function(e,t,s){var n=s(118),r=s(50),a=s(80),o=s(9),i=s(42),l=s(60),c=s(82),u=s(81),h=Object.prototype.hasOwnProperty;e.exports=function(e){if(null==e)return!0;if(i(e)&&(o(e)||"string"==typeof e||"function"==typeof e.splice||l(e)||u(e)||a(e)))return!e.length;var t=r(e);if("[object Map]"==t||"[object Set]"==t)return!e.size;if(c(e))return!n(e).length;for(var s in e)if(h.call(e,s))return!1;return!0}},function(e,t){e.exports=function(e){return void 0===e}},function(e,t,s){var n=s(126),r=s(85),a=s(373),o=s(9);e.exports=function(e,t){return(o(e)?n:a)(e,r(t,3))}},function(e,t,s){var n=s(83),r=s(42);e.exports=function(e,t){var s=-1,a=r(e)?Array(e.length):[];return n(e,(function(e,n,r){a[++s]=t(e,n,r)})),a}},function(e,t,s){var n=s(375),r=s(83),a=s(85),o=s(376),i=s(9);e.exports=function(e,t,s){var l=i(e)?n:o,c=arguments.length<3;return l(e,a(t,4),s,c,r)}},function(e,t){e.exports=function(e,t,s,n){var r=-1,a=null==e?0:e.length;for(n&&a&&(s=e[++r]);++r<a;)s=t(s,e[r],r,e);return s}},function(e,t){e.exports=function(e,t,s,n,r){return r(e,(function(e,r,a){s=n?(n=!1,e):t(s,e,r,a)})),s}},function(e,t,s){var n=s(118),r=s(50),a=s(42),o=s(378),i=s(379);e.exports=function(e){if(null==e)return 0;if(a(e))return o(e)?i(e):e.length;var t=r(e);return"[object Map]"==t||"[object Set]"==t?e.size:n(e).length}},function(e,t,s){var n=s(48),r=s(9),a=s(29);e.exports=function(e){return"string"==typeof e||!r(e)&&a(e)&&"[object String]"==n(e)}},function(e,t,s){var n=s(380),r=s(381),a=s(382);e.exports=function(e){return r(e)?a(e):n(e)}},function(e,t,s){var n=s(184)("length");e.exports=n},function(e,t){var s=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");e.exports=function(e){return s.test(e)}},function(e,t){var s="[\\ud800-\\udfff]",n="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",r="\\ud83c[\\udffb-\\udfff]",a="[^\\ud800-\\udfff]",o="(?:\\ud83c[\\udde6-\\uddff]){2}",i="[\\ud800-\\udbff][\\udc00-\\udfff]",l="(?:"+n+"|"+r+")"+"?",c="[\\ufe0e\\ufe0f]?"+l+("(?:\\u200d(?:"+[a,o,i].join("|")+")[\\ufe0e\\ufe0f]?"+l+")*"),u="(?:"+[a+n+"?",n,o,i,s].join("|")+")",h=RegExp(r+"(?="+r+")|"+u+c,"g");e.exports=function(e){for(var t=h.lastIndex=0;h.test(e);)++t;return t}},function(e,t,s){var n=s(113),r=s(172),a=s(174),o=s(85),i=s(121),l=s(9),c=s(60),u=s(76),h=s(40),d=s(81);e.exports=function(e,t,s){var f=l(e),g=f||c(e)||d(e);if(t=o(t,4),null==s){var p=e&&e.constructor;s=g?f?new p:[]:h(e)&&u(p)?r(i(e)):{}}return(g?n:a)(e,(function(e,n,r){return t(s,e,n,r)})),s}},function(e,t,s){var n=s(385),r=s(387),a=s(393),o=s(402),i=r((function(e){return a(n(e,1,o,!0))}));e.exports=i},function(e,t,s){var n=s(120),r=s(386);e.exports=function e(t,s,a,o,i){var l=-1,c=t.length;for(a||(a=r),i||(i=[]);++l<c;){var u=t[l];s>0&&a(u)?s>1?e(u,s-1,a,o,i):n(i,u):o||(i[i.length]=u)}return i}},function(e,t,s){var n=s(49),r=s(80),a=s(9),o=n?n.isConcatSpreadable:void 0;e.exports=function(e){return a(e)||r(e)||!!(o&&e&&e[o])}},function(e,t,s){var n=s(84),r=s(388),a=s(390);e.exports=function(e,t){return a(r(e,t,n),e+"")}},function(e,t,s){var n=s(389),r=Math.max;e.exports=function(e,t,s){return t=r(void 0===t?e.length-1:t,0),function(){for(var a=arguments,o=-1,i=r(a.length-t,0),l=Array(i);++o<i;)l[o]=a[t+o];o=-1;for(var c=Array(t+1);++o<t;)c[o]=a[o];return c[t]=s(l),n(e,this,c)}}},function(e,t){e.exports=function(e,t,s){switch(s.length){case 0:return e.call(t);case 1:return e.call(t,s[0]);case 2:return e.call(t,s[0],s[1]);case 3:return e.call(t,s[0],s[1],s[2])}return e.apply(t,s)}},function(e,t,s){var n=s(391),r=s(392)(n);e.exports=r},function(e,t,s){var n=s(173),r=s(160),a=s(84),o=r?function(e,t){return r(e,"toString",{configurable:!0,enumerable:!1,value:n(t),writable:!0})}:a;e.exports=o},function(e,t){var s=Date.now;e.exports=function(e){var t=0,n=0;return function(){var r=s(),a=16-(r-n);if(n=r,a>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}},function(e,t,s){var n=s(177),r=s(394),a=s(399),o=s(178),i=s(400),l=s(123);e.exports=function(e,t,s){var c=-1,u=r,h=e.length,d=!0,f=[],g=f;if(s)d=!1,u=a;else if(h>=200){var p=t?null:i(e);if(p)return l(p);d=!1,u=o,g=new n}else g=t?[]:f;e:for(;++c<h;){var m=e[c],y=t?t(m):m;if(m=s||0!==m?m:0,d&&y==y){for(var _=g.length;_--;)if(g[_]===y)continue e;t&&g.push(y),f.push(m)}else u(g,y,s)||(g!==f&&g.push(y),f.push(m))}return f}},function(e,t,s){var n=s(395);e.exports=function(e,t){return!!(null==e?0:e.length)&&n(e,t,0)>-1}},function(e,t,s){var n=s(396),r=s(397),a=s(398);e.exports=function(e,t,s){return t==t?a(e,t,s):n(e,r,s)}},function(e,t){e.exports=function(e,t,s,n){for(var r=e.length,a=s+(n?1:-1);n?a--:++a<r;)if(t(e[a],a,e))return a;return-1}},function(e,t){e.exports=function(e){return e!=e}},function(e,t){e.exports=function(e,t,s){for(var n=s-1,r=e.length;++n<r;)if(e[n]===t)return n;return-1}},function(e,t){e.exports=function(e,t,s){for(var n=-1,r=null==e?0:e.length;++n<r;)if(s(t,e[n]))return!0;return!1}},function(e,t,s){var n=s(170),r=s(401),a=s(123),o=n&&1/a(new n([,-0]))[1]==1/0?function(e){return new n(e)}:r;e.exports=o},function(e,t){e.exports=function(){}},function(e,t,s){var n=s(42),r=s(29);e.exports=function(e){return r(e)&&n(e)}},function(e,t,s){var n=s(404),r=s(41);e.exports=function(e){return null==e?[]:n(e,r(e))}},function(e,t,s){var n=s(126);e.exports=function(e,t){return n(t,(function(t){return e[t]}))}},function(e,t){e.exports="2.1.8"},function(e,t,s){var n=s(20),r=s(108);function a(e){return n.map(e.nodes(),(function(t){var s=e.node(t),r=e.parent(t),a={v:t};return n.isUndefined(s)||(a.value=s),n.isUndefined(r)||(a.parent=r),a}))}function o(e){return n.map(e.edges(),(function(t){var s=e.edge(t),r={v:t.v,w:t.w};return n.isUndefined(t.name)||(r.name=t.name),n.isUndefined(s)||(r.value=s),r}))}e.exports={write:function(e){var t={options:{directed:e.isDirected(),multigraph:e.isMultigraph(),compound:e.isCompound()},nodes:a(e),edges:o(e)};n.isUndefined(e.graph())||(t.value=n.clone(e.graph()));return t},read:function(e){var t=new r(e.options).setGraph(e.value);return n.each(e.nodes,(function(e){t.setNode(e.v,e.value),e.parent&&t.setParent(e.v,e.parent)})),n.each(e.edges,(function(e){t.setEdge({v:e.v,w:e.w,name:e.name},e.value)})),t}}},function(e,t,s){e.exports={components:s(408),dijkstra:s(185),dijkstraAll:s(409),findCycles:s(410),floydWarshall:s(411),isAcyclic:s(412),postorder:s(413),preorder:s(414),prim:s(415),tarjan:s(187),topsort:s(188)}},function(e,t,s){var n=s(20);e.exports=function(e){var t,s={},r=[];function a(r){n.has(s,r)||(s[r]=!0,t.push(r),n.each(e.successors(r),a),n.each(e.predecessors(r),a))}return n.each(e.nodes(),(function(e){t=[],a(e),t.length&&r.push(t)})),r}},function(e,t,s){var n=s(185),r=s(20);e.exports=function(e,t,s){return r.transform(e.nodes(),(function(r,a){r[a]=n(e,a,t,s)}),{})}},function(e,t,s){var n=s(20),r=s(187);e.exports=function(e){return n.filter(r(e),(function(t){return t.length>1||1===t.length&&e.hasEdge(t[0],t[0])}))}},function(e,t,s){var n=s(20);e.exports=function(e,t,s){return function(e,t,s){var n={},r=e.nodes();return r.forEach((function(e){n[e]={},n[e][e]={distance:0},r.forEach((function(t){e!==t&&(n[e][t]={distance:Number.POSITIVE_INFINITY})})),s(e).forEach((function(s){var r=s.v===e?s.w:s.v,a=t(s);n[e][r]={distance:a,predecessor:e}}))})),r.forEach((function(e){var t=n[e];r.forEach((function(s){var a=n[s];r.forEach((function(s){var n=a[e],r=t[s],o=a[s],i=n.distance+r.distance;i<o.distance&&(o.distance=i,o.predecessor=r.predecessor)}))}))})),n}(e,t||r,s||function(t){return e.outEdges(t)})};var r=n.constant(1)},function(e,t,s){var n=s(188);e.exports=function(e){try{n(e)}catch(e){if(e instanceof n.CycleException)return!1;throw e}return!0}},function(e,t,s){var n=s(189);e.exports=function(e,t){return n(e,t,"post")}},function(e,t,s){var n=s(189);e.exports=function(e,t){return n(e,t,"pre")}},function(e,t,s){var n=s(20),r=s(108),a=s(186);e.exports=function(e,t){var s,o=new r,i={},l=new a;function c(e){var n=e.v===s?e.w:e.v,r=l.priority(n);if(void 0!==r){var a=t(e);a<r&&(i[n]=s,l.decrease(n,a))}}if(0===e.nodeCount())return o;n.each(e.nodes(),(function(e){l.add(e,Number.POSITIVE_INFINITY),o.setNode(e)})),l.decrease(e.nodes()[0],0);var u=!1;for(;l.size()>0;){if(s=l.removeMin(),n.has(i,s))o.setEdge(s,i[s]);else{if(u)throw new Error("Input graph is not connected: "+e);u=!0}e.nodeEdges(s).forEach(c)}return o}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(417)),a=n(s(190)),o=n(s(453)),i=n(s(208)),l=n(s(454)),c=n(s(455)),u=n(s(456)),h=n(s(457));t.default={Arena:r.default,Uniform:a.default,Cellular:o.default,Digger:i.default,EllerMaze:l.default,DividedMaze:c.default,IceyMaze:u.default,Rogue:h.default}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(22));class a extends r.default{create(e){const t=this._width-1,s=this._height-1;for(let n=0;n<=t;n++)for(let r=0;r<=s;r++){e(n,r,n&&r&&n<t&&r<s?0:1)}return this}}t.default=a},function(e,t,s){e.exports=function(e){"uniqueLinkId"in(e=e||{})&&(console.warn("ngraph.graph: Starting from version 0.14 `uniqueLinkId` is deprecated.\nUse `multigraph` option instead\n","\n","Note: there is also change in default behavior: From now on each graph\nis considered to be not a multigraph by default (each edge is unique)."),e.multigraph=e.uniqueLinkId);void 0===e.multigraph&&(e.multigraph=!1);if("function"!=typeof Map)throw new Error("ngraph.graph requires `Map` to be defined. Please polyfill it before using ngraph");var t=new Map,s=[],c={},u=0,h=e.multigraph?function(e,t,s){var n=l(e,t),r=c.hasOwnProperty(n);if(r||O(e,t)){r||(c[n]=0);var a="@"+ ++c[n];n=l(e+a,t+a)}return new i(e,t,s,n)}:function(e,t,s){var n=l(e,t);return new i(e,t,s,n)},d=[],f=A,g=A,p=A,m=A,y={addNode:v,addLink:function(e,t,n){p();var r=E(e)||v(e),a=E(t)||v(t),i=h(e,t,n);s.push(i),o(r,i),e!==t&&o(a,i);return f(i,"add"),m(),i},removeLink:T,removeNode:S,getNode:E,getNodeCount:w,getLinkCount:C,getLinksCount:C,getNodesCount:w,getLinks:function(e){var t=E(e);return t?t.links:null},forEachNode:P,forEachLinkedNode:function(e,s,n){var r=E(e);if(r&&r.links&&"function"==typeof s)return n?function(e,s,n){for(var r=0;r<e.length;++r){var a=e[r];if(a.fromId===s&&n(t.get(a.toId),a))return!0}}(r.links,e,s):function(e,s,n){for(var r=0;r<e.length;++r){var a=e[r],o=a.fromId===s?a.toId:a.fromId;if(n(t.get(o),a))return!0}}(r.links,e,s)},forEachLink:function(e){var t,n;if("function"==typeof e)for(t=0,n=s.length;t<n;++t)e(s[t])},beginUpdate:p,endUpdate:m,clear:function(){p(),P((function(e){S(e.id)})),m()},hasLink:O,hasNode:E,getLink:O};return n(y),function(){var e=y.on;y.on=function(){return y.beginUpdate=p=M,y.endUpdate=m=N,f=_,g=b,y.on=e,e.apply(y,arguments)}}(),y;function _(e,t){d.push({link:e,changeType:t})}function b(e,t){d.push({node:e,changeType:t})}function v(e,s){if(void 0===e)throw new Error("Invalid node identifier");p();var n=E(e);return n?(n.data=s,g(n,"update")):(n=new a(e,s),g(n,"add")),t.set(e,n),m(),n}function E(e){return t.get(e)}function S(e){var s=E(e);if(!s)return!1;p();var n=s.links;if(n){s.links=null;for(var r=0;r<n.length;++r)T(n[r])}return t.delete(e),g(s,"remove"),m(),!0}function w(){return t.size}function C(){return s.length}function T(e){if(!e)return!1;var t=r(e,s);if(t<0)return!1;p(),s.splice(t,1);var n=E(e.fromId),a=E(e.toId);return n&&(t=r(e,n.links))>=0&&n.links.splice(t,1),a&&(t=r(e,a.links))>=0&&a.links.splice(t,1),f(e,"remove"),m(),!0}function O(e,t){var s,n=E(e);if(!n||!n.links)return null;for(s=0;s<n.links.length;++s){var r=n.links[s];if(r.fromId===e&&r.toId===t)return r}return null}function A(){}function M(){u+=1}function N(){0===(u-=1)&&d.length>0&&(y.fire("changed",d),d.length=0)}function P(e){if("function"!=typeof e)throw new Error("Function is expected to iterate over graph nodes. You passed "+e);for(var s=t.values(),n=s.next();!n.done;){if(e(n.value))return!0;n=s.next()}}};var n=s(419);function r(e,t){if(!t)return-1;if(t.indexOf)return t.indexOf(e);var s,n=t.length;for(s=0;s<n;s+=1)if(t[s]===e)return s;return-1}function a(e,t){this.id=e,this.links=null,this.data=t}function o(e,t){e.links?e.links.push(t):e.links=[t]}function i(e,t,s,n){this.fromId=e,this.toId=t,this.data=s,this.id=n}function l(e,t){return e.toString()+"👉 "+t.toString()}},function(e,t){e.exports=function(e){!function(e){if(!e)throw new Error("Eventify cannot use falsy object as events subject");for(var t=["on","fire","off"],s=0;s<t.length;++s)if(e.hasOwnProperty(t[s]))throw new Error("Subject cannot be eventified, since it already has property '"+t[s]+"'")}(e);var t=function(e){var t=Object.create(null);return{on:function(s,n,r){if("function"!=typeof n)throw new Error("callback is expected to be a function");var a=t[s];return a||(a=t[s]=[]),a.push({callback:n,ctx:r}),e},off:function(s,n){if(void 0===s)return t=Object.create(null),e;if(t[s])if("function"!=typeof n)delete t[s];else for(var r=t[s],a=0;a<r.length;++a)r[a].callback===n&&r.splice(a,1);return e},fire:function(s){var n,r=t[s];if(!r)return e;arguments.length>1&&(n=Array.prototype.splice.call(arguments,1));for(var a=0;a<r.length;++a){var o=r[a];o.callback.apply(o.ctx,n)}return e}}}(e);return e.on=t.on,e.off=t.off,e.fire=t.fire,e}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=s(192);!function(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}(s(450)),t.default={Graph:n.Graph}},function(e,t,s){"use strict";t.byteLength=function(e){var t=c(e),s=t[0],n=t[1];return 3*(s+n)/4-n},t.toByteArray=function(e){var t,s,n=c(e),o=n[0],i=n[1],l=new a(function(e,t,s){return 3*(t+s)/4-s}(0,o,i)),u=0,h=i>0?o-4:o;for(s=0;s<h;s+=4)t=r[e.charCodeAt(s)]<<18|r[e.charCodeAt(s+1)]<<12|r[e.charCodeAt(s+2)]<<6|r[e.charCodeAt(s+3)],l[u++]=t>>16&255,l[u++]=t>>8&255,l[u++]=255&t;2===i&&(t=r[e.charCodeAt(s)]<<2|r[e.charCodeAt(s+1)]>>4,l[u++]=255&t);1===i&&(t=r[e.charCodeAt(s)]<<10|r[e.charCodeAt(s+1)]<<4|r[e.charCodeAt(s+2)]>>2,l[u++]=t>>8&255,l[u++]=255&t);return l},t.fromByteArray=function(e){for(var t,s=e.length,r=s%3,a=[],o=0,i=s-r;o<i;o+=16383)a.push(u(e,o,o+16383>i?i:o+16383));1===r?(t=e[s-1],a.push(n[t>>2]+n[t<<4&63]+"==")):2===r&&(t=(e[s-2]<<8)+e[s-1],a.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"="));return a.join("")};for(var n=[],r=[],a="undefined"!=typeof Uint8Array?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,l=o.length;i<l;++i)n[i]=o[i],r[o.charCodeAt(i)]=i;function c(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var s=e.indexOf("=");return-1===s&&(s=t),[s,s===t?0:4-s%4]}function u(e,t,s){for(var r,a,o=[],i=t;i<s;i+=3)r=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2]),o.push(n[(a=r)>>18&63]+n[a>>12&63]+n[a>>6&63]+n[63&a]);return o.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},function(e,t){t.read=function(e,t,s,n,r){var a,o,i=8*r-n-1,l=(1<<i)-1,c=l>>1,u=-7,h=s?r-1:0,d=s?-1:1,f=e[t+h];for(h+=d,a=f&(1<<-u)-1,f>>=-u,u+=i;u>0;a=256*a+e[t+h],h+=d,u-=8);for(o=a&(1<<-u)-1,a>>=-u,u+=n;u>0;o=256*o+e[t+h],h+=d,u-=8);if(0===a)a=1-c;else{if(a===l)return o?NaN:1/0*(f?-1:1);o+=Math.pow(2,n),a-=c}return(f?-1:1)*o*Math.pow(2,a-n)},t.write=function(e,t,s,n,r,a){var o,i,l,c=8*a-r-1,u=(1<<c)-1,h=u>>1,d=23===r?Math.pow(2,-24)-Math.pow(2,-77):0,f=n?0:a-1,g=n?1:-1,p=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(i=isNaN(t)?1:0,o=u):(o=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-o))<1&&(o--,l*=2),(t+=o+h>=1?d/l:d*Math.pow(2,1-h))*l>=2&&(o++,l/=2),o+h>=u?(i=0,o=u):o+h>=1?(i=(t*l-1)*Math.pow(2,r),o+=h):(i=t*Math.pow(2,h-1)*Math.pow(2,r),o=0));r>=8;e[s+f]=255&i,f+=g,i/=256,r-=8);for(o=o<<r|i,c+=r;c>0;e[s+f]=255&o,f+=g,o/=256,c-=8);e[s+f-g]|=128*p}},function(e,t){var s={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==s.call(e)}},function(e,t){},function(e,t,s){"use strict";(function(e){var n=s(51).Buffer,r=s(426).Transform,a=s(439),o=s(205),i=s(204).ok,l=s(51).kMaxLength,c="Cannot create final Buffer. It would be larger than 0x"+l.toString(16)+" bytes";a.Z_MIN_WINDOWBITS=8,a.Z_MAX_WINDOWBITS=15,a.Z_DEFAULT_WINDOWBITS=15,a.Z_MIN_CHUNK=64,a.Z_MAX_CHUNK=1/0,a.Z_DEFAULT_CHUNK=16384,a.Z_MIN_MEMLEVEL=1,a.Z_MAX_MEMLEVEL=9,a.Z_DEFAULT_MEMLEVEL=8,a.Z_MIN_LEVEL=-1,a.Z_MAX_LEVEL=9,a.Z_DEFAULT_LEVEL=a.Z_DEFAULT_COMPRESSION;for(var u=Object.keys(a),h=0;h<u.length;h++){var d=u[h];d.match(/^Z/)&&Object.defineProperty(t,d,{enumerable:!0,value:a[d],writable:!1})}for(var f={Z_OK:a.Z_OK,Z_STREAM_END:a.Z_STREAM_END,Z_NEED_DICT:a.Z_NEED_DICT,Z_ERRNO:a.Z_ERRNO,Z_STREAM_ERROR:a.Z_STREAM_ERROR,Z_DATA_ERROR:a.Z_DATA_ERROR,Z_MEM_ERROR:a.Z_MEM_ERROR,Z_BUF_ERROR:a.Z_BUF_ERROR,Z_VERSION_ERROR:a.Z_VERSION_ERROR},g=Object.keys(f),p=0;p<g.length;p++){var m=g[p];f[f[m]]=m}function y(e,t,s){var r=[],a=0;function o(){for(var t;null!==(t=e.read());)r.push(t),a+=t.length;e.once("readable",o)}function i(){var t,o=null;a>=l?o=new RangeError(c):t=n.concat(r,a),r=[],e.close(),s(o,t)}e.on("error",(function(t){e.removeListener("end",i),e.removeListener("readable",o),s(t)})),e.on("end",i),e.end(t),o()}function _(e,t){if("string"==typeof t&&(t=n.from(t)),!n.isBuffer(t))throw new TypeError("Not a string or buffer");var s=e._finishFlushFlag;return e._processChunk(t,s)}function b(e){if(!(this instanceof b))return new b(e);A.call(this,e,a.DEFLATE)}function v(e){if(!(this instanceof v))return new v(e);A.call(this,e,a.INFLATE)}function E(e){if(!(this instanceof E))return new E(e);A.call(this,e,a.GZIP)}function S(e){if(!(this instanceof S))return new S(e);A.call(this,e,a.GUNZIP)}function w(e){if(!(this instanceof w))return new w(e);A.call(this,e,a.DEFLATERAW)}function C(e){if(!(this instanceof C))return new C(e);A.call(this,e,a.INFLATERAW)}function T(e){if(!(this instanceof T))return new T(e);A.call(this,e,a.UNZIP)}function O(e){return e===a.Z_NO_FLUSH||e===a.Z_PARTIAL_FLUSH||e===a.Z_SYNC_FLUSH||e===a.Z_FULL_FLUSH||e===a.Z_FINISH||e===a.Z_BLOCK}function A(e,s){var o=this;if(this._opts=e=e||{},this._chunkSize=e.chunkSize||t.Z_DEFAULT_CHUNK,r.call(this,e),e.flush&&!O(e.flush))throw new Error("Invalid flush flag: "+e.flush);if(e.finishFlush&&!O(e.finishFlush))throw new Error("Invalid flush flag: "+e.finishFlush);if(this._flushFlag=e.flush||a.Z_NO_FLUSH,this._finishFlushFlag=void 0!==e.finishFlush?e.finishFlush:a.Z_FINISH,e.chunkSize&&(e.chunkSize<t.Z_MIN_CHUNK||e.chunkSize>t.Z_MAX_CHUNK))throw new Error("Invalid chunk size: "+e.chunkSize);if(e.windowBits&&(e.windowBits<t.Z_MIN_WINDOWBITS||e.windowBits>t.Z_MAX_WINDOWBITS))throw new Error("Invalid windowBits: "+e.windowBits);if(e.level&&(e.level<t.Z_MIN_LEVEL||e.level>t.Z_MAX_LEVEL))throw new Error("Invalid compression level: "+e.level);if(e.memLevel&&(e.memLevel<t.Z_MIN_MEMLEVEL||e.memLevel>t.Z_MAX_MEMLEVEL))throw new Error("Invalid memLevel: "+e.memLevel);if(e.strategy&&e.strategy!=t.Z_FILTERED&&e.strategy!=t.Z_HUFFMAN_ONLY&&e.strategy!=t.Z_RLE&&e.strategy!=t.Z_FIXED&&e.strategy!=t.Z_DEFAULT_STRATEGY)throw new Error("Invalid strategy: "+e.strategy);if(e.dictionary&&!n.isBuffer(e.dictionary))throw new Error("Invalid dictionary: it should be a Buffer instance");this._handle=new a.Zlib(s);var i=this;this._hadError=!1,this._handle.onerror=function(e,s){M(i),i._hadError=!0;var n=new Error(e);n.errno=s,n.code=t.codes[s],i.emit("error",n)};var l=t.Z_DEFAULT_COMPRESSION;"number"==typeof e.level&&(l=e.level);var c=t.Z_DEFAULT_STRATEGY;"number"==typeof e.strategy&&(c=e.strategy),this._handle.init(e.windowBits||t.Z_DEFAULT_WINDOWBITS,l,e.memLevel||t.Z_DEFAULT_MEMLEVEL,c,e.dictionary),this._buffer=n.allocUnsafe(this._chunkSize),this._offset=0,this._level=l,this._strategy=c,this.once("end",this.close),Object.defineProperty(this,"_closed",{get:function(){return!o._handle},configurable:!0,enumerable:!0})}function M(t,s){s&&e.nextTick(s),t._handle&&(t._handle.close(),t._handle=null)}function N(e){e.emit("close")}Object.defineProperty(t,"codes",{enumerable:!0,value:Object.freeze(f),writable:!1}),t.Deflate=b,t.Inflate=v,t.Gzip=E,t.Gunzip=S,t.DeflateRaw=w,t.InflateRaw=C,t.Unzip=T,t.createDeflate=function(e){return new b(e)},t.createInflate=function(e){return new v(e)},t.createDeflateRaw=function(e){return new w(e)},t.createInflateRaw=function(e){return new C(e)},t.createGzip=function(e){return new E(e)},t.createGunzip=function(e){return new S(e)},t.createUnzip=function(e){return new T(e)},t.deflate=function(e,t,s){return"function"==typeof t&&(s=t,t={}),y(new b(t),e,s)},t.deflateSync=function(e,t){return _(new b(t),e)},t.gzip=function(e,t,s){return"function"==typeof t&&(s=t,t={}),y(new E(t),e,s)},t.gzipSync=function(e,t){return _(new E(t),e)},t.deflateRaw=function(e,t,s){return"function"==typeof t&&(s=t,t={}),y(new w(t),e,s)},t.deflateRawSync=function(e,t){return _(new w(t),e)},t.unzip=function(e,t,s){return"function"==typeof t&&(s=t,t={}),y(new T(t),e,s)},t.unzipSync=function(e,t){return _(new T(t),e)},t.inflate=function(e,t,s){return"function"==typeof t&&(s=t,t={}),y(new v(t),e,s)},t.inflateSync=function(e,t){return _(new v(t),e)},t.gunzip=function(e,t,s){return"function"==typeof t&&(s=t,t={}),y(new S(t),e,s)},t.gunzipSync=function(e,t){return _(new S(t),e)},t.inflateRaw=function(e,t,s){return"function"==typeof t&&(s=t,t={}),y(new C(t),e,s)},t.inflateRawSync=function(e,t){return _(new C(t),e)},o.inherits(A,r),A.prototype.params=function(s,n,r){if(s<t.Z_MIN_LEVEL||s>t.Z_MAX_LEVEL)throw new RangeError("Invalid compression level: "+s);if(n!=t.Z_FILTERED&&n!=t.Z_HUFFMAN_ONLY&&n!=t.Z_RLE&&n!=t.Z_FIXED&&n!=t.Z_DEFAULT_STRATEGY)throw new TypeError("Invalid strategy: "+n);if(this._level!==s||this._strategy!==n){var o=this;this.flush(a.Z_SYNC_FLUSH,(function(){i(o._handle,"zlib binding closed"),o._handle.params(s,n),o._hadError||(o._level=s,o._strategy=n,r&&r())}))}else e.nextTick(r)},A.prototype.reset=function(){return i(this._handle,"zlib binding closed"),this._handle.reset()},A.prototype._flush=function(e){this._transform(n.alloc(0),"",e)},A.prototype.flush=function(t,s){var r=this,o=this._writableState;("function"==typeof t||void 0===t&&!s)&&(s=t,t=a.Z_FULL_FLUSH),o.ended?s&&e.nextTick(s):o.ending?s&&this.once("end",s):o.needDrain?s&&this.once("drain",(function(){return r.flush(t,s)})):(this._flushFlag=t,this.write(n.alloc(0),"",s))},A.prototype.close=function(t){M(this,t),e.nextTick(N,this)},A.prototype._transform=function(e,t,s){var r,o=this._writableState,i=(o.ending||o.ended)&&(!e||o.length===e.length);return null===e||n.isBuffer(e)?this._handle?(i?r=this._finishFlushFlag:(r=this._flushFlag,e.length>=o.length&&(this._flushFlag=this._opts.flush||a.Z_NO_FLUSH)),void this._processChunk(e,r,s)):s(new Error("zlib binding closed")):s(new Error("invalid input"))},A.prototype._processChunk=function(e,t,s){var r=e&&e.length,a=this._chunkSize-this._offset,o=0,u=this,h="function"==typeof s;if(!h){var d,f=[],g=0;this.on("error",(function(e){d=e})),i(this._handle,"zlib binding closed");do{var p=this._handle.writeSync(t,e,o,r,this._buffer,this._offset,a)}while(!this._hadError&&_(p[0],p[1]));if(this._hadError)throw d;if(g>=l)throw M(this),new RangeError(c);var m=n.concat(f,g);return M(this),m}i(this._handle,"zlib binding closed");var y=this._handle.write(t,e,o,r,this._buffer,this._offset,a);function _(l,c){if(this&&(this.buffer=null,this.callback=null),!u._hadError){var d=a-c;if(i(d>=0,"have should not go down"),d>0){var p=u._buffer.slice(u._offset,u._offset+d);u._offset+=d,h?u.push(p):(f.push(p),g+=p.length)}if((0===c||u._offset>=u._chunkSize)&&(a=u._chunkSize,u._offset=0,u._buffer=n.allocUnsafe(u._chunkSize)),0===c){if(o+=r-l,r=l,!h)return!0;var m=u._handle.write(t,e,o,r,u._buffer,u._offset,u._chunkSize);return m.callback=_,void(m.buffer=e)}if(!h)return!1;s()}}y.buffer=e,y.callback=_},o.inherits(b,A),o.inherits(v,A),o.inherits(E,A),o.inherits(S,A),o.inherits(w,A),o.inherits(C,A),o.inherits(T,A)}).call(this,s(31))},function(e,t,s){e.exports=r;var n=s(129).EventEmitter;function r(){n.call(this)}s(43)(r,n),r.Readable=s(130),r.Writable=s(435),r.Duplex=s(436),r.Transform=s(437),r.PassThrough=s(438),r.Stream=r,r.prototype.pipe=function(e,t){var s=this;function r(t){e.writable&&!1===e.write(t)&&s.pause&&s.pause()}function a(){s.readable&&s.resume&&s.resume()}s.on("data",r),e.on("drain",a),e._isStdio||t&&!1===t.end||(s.on("end",i),s.on("close",l));var o=!1;function i(){o||(o=!0,e.end())}function l(){o||(o=!0,"function"==typeof e.destroy&&e.destroy())}function c(e){if(u(),0===n.listenerCount(this,"error"))throw e}function u(){s.removeListener("data",r),e.removeListener("drain",a),s.removeListener("end",i),s.removeListener("close",l),s.removeListener("error",c),e.removeListener("error",c),s.removeListener("end",u),s.removeListener("close",u),e.removeListener("close",u)}return s.on("error",c),e.on("error",c),s.on("end",u),s.on("close",u),e.on("close",u),e.emit("pipe",s),e}},function(e,t){var s={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==s.call(e)}},function(e,t){},function(e,t,s){"use strict";var n=s(88).Buffer,r=s(430);e.exports=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.head=null,this.tail=null,this.length=0}return e.prototype.push=function(e){var t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length},e.prototype.unshift=function(e){var t={data:e,next:this.head};0===this.length&&(this.tail=t),this.head=t,++this.length},e.prototype.shift=function(){if(0!==this.length){var e=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,e}},e.prototype.clear=function(){this.head=this.tail=null,this.length=0},e.prototype.join=function(e){if(0===this.length)return"";for(var t=this.head,s=""+t.data;t=t.next;)s+=e+t.data;return s},e.prototype.concat=function(e){if(0===this.length)return n.alloc(0);if(1===this.length)return this.head.data;for(var t,s,r,a=n.allocUnsafe(e>>>0),o=this.head,i=0;o;)t=o.data,s=a,r=i,t.copy(s,r),i+=o.data.length,o=o.next;return a},e}(),r&&r.inspect&&r.inspect.custom&&(e.exports.prototype[r.inspect.custom]=function(){var e=r.inspect({length:this.length});return this.constructor.name+" "+e})},function(e,t){},function(e,t,s){(function(e){var n=void 0!==e&&e||"undefined"!=typeof self&&self||window,r=Function.prototype.apply;function a(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new a(r.call(setTimeout,n,arguments),clearTimeout)},t.setInterval=function(){return new a(r.call(setInterval,n,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},a.prototype.unref=a.prototype.ref=function(){},a.prototype.close=function(){this._clearFn.call(n,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout((function(){e._onTimeout&&e._onTimeout()}),t))},s(432),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,s(28))},function(e,t,s){(function(e,t){!function(e,s){"use strict";if(!e.setImmediate){var n,r,a,o,i,l=1,c={},u=!1,h=e.document,d=Object.getPrototypeOf&&Object.getPrototypeOf(e);d=d&&d.setTimeout?d:e,"[object process]"==={}.toString.call(e.process)?n=function(e){t.nextTick((function(){g(e)}))}:!function(){if(e.postMessage&&!e.importScripts){var t=!0,s=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=s,t}}()?e.MessageChannel?((a=new MessageChannel).port1.onmessage=function(e){g(e.data)},n=function(e){a.port2.postMessage(e)}):h&&"onreadystatechange"in h.createElement("script")?(r=h.documentElement,n=function(e){var t=h.createElement("script");t.onreadystatechange=function(){g(e),t.onreadystatechange=null,r.removeChild(t),t=null},r.appendChild(t)}):n=function(e){setTimeout(g,0,e)}:(o="setImmediate$"+Math.random()+"$",i=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(o)&&g(+t.data.slice(o.length))},e.addEventListener?e.addEventListener("message",i,!1):e.attachEvent("onmessage",i),n=function(t){e.postMessage(o+t,"*")}),d.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),s=0;s<t.length;s++)t[s]=arguments[s+1];var r={callback:e,args:t};return c[l]=r,n(l),l++},d.clearImmediate=f}function f(e){delete c[e]}function g(e){if(u)setTimeout(g,0,e);else{var t=c[e];if(t){u=!0;try{!function(e){var t=e.callback,s=e.args;switch(s.length){case 0:t();break;case 1:t(s[0]);break;case 2:t(s[0],s[1]);break;case 3:t(s[0],s[1],s[2]);break;default:t.apply(void 0,s)}}(t)}finally{f(e),u=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,s(28),s(31))},function(e,t,s){(function(t){function s(e){try{if(!t.localStorage)return!1}catch(e){return!1}var s=t.localStorage[e];return null!=s&&"true"===String(s).toLowerCase()}e.exports=function(e,t){if(s("noDeprecation"))return e;var n=!1;return function(){if(!n){if(s("throwDeprecation"))throw new Error(t);s("traceDeprecation")?console.trace(t):console.warn(t),n=!0}return e.apply(this,arguments)}}}).call(this,s(28))},function(e,t,s){"use strict";e.exports=a;var n=s(203),r=s(61);function a(e){if(!(this instanceof a))return new a(e);n.call(this,e)}r.inherits=s(43),r.inherits(a,n),a.prototype._transform=function(e,t,s){s(null,e)}},function(e,t,s){e.exports=s(131)},function(e,t,s){e.exports=s(44)},function(e,t,s){e.exports=s(130).Transform},function(e,t,s){e.exports=s(130).PassThrough},function(e,t,s){"use strict";(function(e,n){var r=s(204),a=s(442),o=s(443),i=s(446),l=s(449);for(var c in l)t[c]=l[c];t.NONE=0,t.DEFLATE=1,t.INFLATE=2,t.GZIP=3,t.GUNZIP=4,t.DEFLATERAW=5,t.INFLATERAW=6,t.UNZIP=7;function u(e){if("number"!=typeof e||e<t.DEFLATE||e>t.UNZIP)throw new TypeError("Bad argument");this.dictionary=null,this.err=0,this.flush=0,this.init_done=!1,this.level=0,this.memLevel=0,this.mode=e,this.strategy=0,this.windowBits=0,this.write_in_progress=!1,this.pending_close=!1,this.gzip_id_bytes_read=0}u.prototype.close=function(){this.write_in_progress?this.pending_close=!0:(this.pending_close=!1,r(this.init_done,"close before init"),r(this.mode<=t.UNZIP),this.mode===t.DEFLATE||this.mode===t.GZIP||this.mode===t.DEFLATERAW?o.deflateEnd(this.strm):this.mode!==t.INFLATE&&this.mode!==t.GUNZIP&&this.mode!==t.INFLATERAW&&this.mode!==t.UNZIP||i.inflateEnd(this.strm),this.mode=t.NONE,this.dictionary=null)},u.prototype.write=function(e,t,s,n,r,a,o){return this._write(!0,e,t,s,n,r,a,o)},u.prototype.writeSync=function(e,t,s,n,r,a,o){return this._write(!1,e,t,s,n,r,a,o)},u.prototype._write=function(s,a,o,i,l,c,u,h){if(r.equal(arguments.length,8),r(this.init_done,"write before init"),r(this.mode!==t.NONE,"already finalized"),r.equal(!1,this.write_in_progress,"write already in progress"),r.equal(!1,this.pending_close,"close is pending"),this.write_in_progress=!0,r.equal(!1,void 0===a,"must provide flush value"),this.write_in_progress=!0,a!==t.Z_NO_FLUSH&&a!==t.Z_PARTIAL_FLUSH&&a!==t.Z_SYNC_FLUSH&&a!==t.Z_FULL_FLUSH&&a!==t.Z_FINISH&&a!==t.Z_BLOCK)throw new Error("Invalid flush value");if(null==o&&(o=e.alloc(0),l=0,i=0),this.strm.avail_in=l,this.strm.input=o,this.strm.next_in=i,this.strm.avail_out=h,this.strm.output=c,this.strm.next_out=u,this.flush=a,!s)return this._process(),this._checkError()?this._afterSync():void 0;var d=this;return n.nextTick((function(){d._process(),d._after()})),this},u.prototype._afterSync=function(){var e=this.strm.avail_out,t=this.strm.avail_in;return this.write_in_progress=!1,[t,e]},u.prototype._process=function(){var e=null;switch(this.mode){case t.DEFLATE:case t.GZIP:case t.DEFLATERAW:this.err=o.deflate(this.strm,this.flush);break;case t.UNZIP:switch(this.strm.avail_in>0&&(e=this.strm.next_in),this.gzip_id_bytes_read){case 0:if(null===e)break;if(31!==this.strm.input[e]){this.mode=t.INFLATE;break}if(this.gzip_id_bytes_read=1,e++,1===this.strm.avail_in)break;case 1:if(null===e)break;139===this.strm.input[e]?(this.gzip_id_bytes_read=2,this.mode=t.GUNZIP):this.mode=t.INFLATE;break;default:throw new Error("invalid number of gzip magic number bytes read")}case t.INFLATE:case t.GUNZIP:case t.INFLATERAW:for(this.err=i.inflate(this.strm,this.flush),this.err===t.Z_NEED_DICT&&this.dictionary&&(this.err=i.inflateSetDictionary(this.strm,this.dictionary),this.err===t.Z_OK?this.err=i.inflate(this.strm,this.flush):this.err===t.Z_DATA_ERROR&&(this.err=t.Z_NEED_DICT));this.strm.avail_in>0&&this.mode===t.GUNZIP&&this.err===t.Z_STREAM_END&&0!==this.strm.next_in[0];)this.reset(),this.err=i.inflate(this.strm,this.flush);break;default:throw new Error("Unknown mode "+this.mode)}},u.prototype._checkError=function(){switch(this.err){case t.Z_OK:case t.Z_BUF_ERROR:if(0!==this.strm.avail_out&&this.flush===t.Z_FINISH)return this._error("unexpected end of file"),!1;break;case t.Z_STREAM_END:break;case t.Z_NEED_DICT:return null==this.dictionary?this._error("Missing dictionary"):this._error("Bad dictionary"),!1;default:return this._error("Zlib error"),!1}return!0},u.prototype._after=function(){if(this._checkError()){var e=this.strm.avail_out,t=this.strm.avail_in;this.write_in_progress=!1,this.callback(t,e),this.pending_close&&this.close()}},u.prototype._error=function(e){this.strm.msg&&(e=this.strm.msg),this.onerror(e,this.err),this.write_in_progress=!1,this.pending_close&&this.close()},u.prototype.init=function(e,s,n,a,o){r(4===arguments.length||5===arguments.length,"init(windowBits, level, memLevel, strategy, [dictionary])"),r(e>=8&&e<=15,"invalid windowBits"),r(s>=-1&&s<=9,"invalid compression level"),r(n>=1&&n<=9,"invalid memlevel"),r(a===t.Z_FILTERED||a===t.Z_HUFFMAN_ONLY||a===t.Z_RLE||a===t.Z_FIXED||a===t.Z_DEFAULT_STRATEGY,"invalid strategy"),this._init(s,e,n,a,o),this._setDictionary()},u.prototype.params=function(){throw new Error("deflateParams Not supported")},u.prototype.reset=function(){this._reset(),this._setDictionary()},u.prototype._init=function(e,s,n,r,l){switch(this.level=e,this.windowBits=s,this.memLevel=n,this.strategy=r,this.flush=t.Z_NO_FLUSH,this.err=t.Z_OK,this.mode!==t.GZIP&&this.mode!==t.GUNZIP||(this.windowBits+=16),this.mode===t.UNZIP&&(this.windowBits+=32),this.mode!==t.DEFLATERAW&&this.mode!==t.INFLATERAW||(this.windowBits=-1*this.windowBits),this.strm=new a,this.mode){case t.DEFLATE:case t.GZIP:case t.DEFLATERAW:this.err=o.deflateInit2(this.strm,this.level,t.Z_DEFLATED,this.windowBits,this.memLevel,this.strategy);break;case t.INFLATE:case t.GUNZIP:case t.INFLATERAW:case t.UNZIP:this.err=i.inflateInit2(this.strm,this.windowBits);break;default:throw new Error("Unknown mode "+this.mode)}this.err!==t.Z_OK&&this._error("Init error"),this.dictionary=l,this.write_in_progress=!1,this.init_done=!0},u.prototype._setDictionary=function(){if(null!=this.dictionary){switch(this.err=t.Z_OK,this.mode){case t.DEFLATE:case t.DEFLATERAW:this.err=o.deflateSetDictionary(this.strm,this.dictionary)}this.err!==t.Z_OK&&this._error("Failed to set dictionary")}},u.prototype._reset=function(){switch(this.err=t.Z_OK,this.mode){case t.DEFLATE:case t.DEFLATERAW:case t.GZIP:this.err=o.deflateReset(this.strm);break;case t.INFLATE:case t.INFLATERAW:case t.GUNZIP:this.err=i.inflateReset(this.strm)}this.err!==t.Z_OK&&this._error("Failed to reset stream")},t.Zlib=u}).call(this,s(51).Buffer,s(31))},function(e,t,s){"use strict";
/*
object-assign
(c) Sindre Sorhus
@license MIT
*/var n=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable;function o(e){if(null==e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}e.exports=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},s=0;s<10;s++)t["_"+String.fromCharCode(s)]=s;if("0123456789"!==Object.getOwnPropertyNames(t).map((function(e){return t[e]})).join(""))return!1;var n={};return"abcdefghijklmnopqrst".split("").forEach((function(e){n[e]=e})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},n)).join("")}catch(e){return!1}}()?Object.assign:function(e,t){for(var s,i,l=o(e),c=1;c<arguments.length;c++){for(var u in s=Object(arguments[c]))r.call(s,u)&&(l[u]=s[u]);if(n){i=n(s);for(var h=0;h<i.length;h++)a.call(s,i[h])&&(l[i[h]]=s[i[h]])}}return l}},function(e,t){e.exports=function(e){return e&&"object"==typeof e&&"function"==typeof e.copy&&"function"==typeof e.fill&&"function"==typeof e.readUInt8}},function(e,t,s){"use strict";e.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},function(e,t,s){"use strict";var n,r=s(89),a=s(444),o=s(206),i=s(207),l=s(445);function c(e,t){return e.msg=l[t],t}function u(e){return(e<<1)-(e>4?9:0)}function h(e){for(var t=e.length;--t>=0;)e[t]=0}function d(e){var t=e.state,s=t.pending;s>e.avail_out&&(s=e.avail_out),0!==s&&(r.arraySet(e.output,t.pending_buf,t.pending_out,s,e.next_out),e.next_out+=s,t.pending_out+=s,e.total_out+=s,e.avail_out-=s,t.pending-=s,0===t.pending&&(t.pending_out=0))}function f(e,t){a._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,d(e.strm)}function g(e,t){e.pending_buf[e.pending++]=t}function p(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function m(e,t){var s,n,r=e.max_chain_length,a=e.strstart,o=e.prev_length,i=e.nice_match,l=e.strstart>e.w_size-262?e.strstart-(e.w_size-262):0,c=e.window,u=e.w_mask,h=e.prev,d=e.strstart+258,f=c[a+o-1],g=c[a+o];e.prev_length>=e.good_match&&(r>>=2),i>e.lookahead&&(i=e.lookahead);do{if(c[(s=t)+o]===g&&c[s+o-1]===f&&c[s]===c[a]&&c[++s]===c[a+1]){a+=2,s++;do{}while(c[++a]===c[++s]&&c[++a]===c[++s]&&c[++a]===c[++s]&&c[++a]===c[++s]&&c[++a]===c[++s]&&c[++a]===c[++s]&&c[++a]===c[++s]&&c[++a]===c[++s]&&a<d);if(n=258-(d-a),a=d-258,n>o){if(e.match_start=t,o=n,n>=i)break;f=c[a+o-1],g=c[a+o]}}}while((t=h[t&u])>l&&0!=--r);return o<=e.lookahead?o:e.lookahead}function y(e){var t,s,n,a,l,c,u,h,d,f,g=e.w_size;do{if(a=e.window_size-e.lookahead-e.strstart,e.strstart>=g+(g-262)){r.arraySet(e.window,e.window,g,g,0),e.match_start-=g,e.strstart-=g,e.block_start-=g,t=s=e.hash_size;do{n=e.head[--t],e.head[t]=n>=g?n-g:0}while(--s);t=s=g;do{n=e.prev[--t],e.prev[t]=n>=g?n-g:0}while(--s);a+=g}if(0===e.strm.avail_in)break;if(c=e.strm,u=e.window,h=e.strstart+e.lookahead,d=a,f=void 0,(f=c.avail_in)>d&&(f=d),s=0===f?0:(c.avail_in-=f,r.arraySet(u,c.input,c.next_in,f,h),1===c.state.wrap?c.adler=o(c.adler,u,f,h):2===c.state.wrap&&(c.adler=i(c.adler,u,f,h)),c.next_in+=f,c.total_in+=f,f),e.lookahead+=s,e.lookahead+e.insert>=3)for(l=e.strstart-e.insert,e.ins_h=e.window[l],e.ins_h=(e.ins_h<<e.hash_shift^e.window[l+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[l+3-1])&e.hash_mask,e.prev[l&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=l,l++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<262&&0!==e.strm.avail_in)}function _(e,t){for(var s,n;;){if(e.lookahead<262){if(y(e),e.lookahead<262&&0===t)return 1;if(0===e.lookahead)break}if(s=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,s=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==s&&e.strstart-s<=e.w_size-262&&(e.match_length=m(e,s)),e.match_length>=3)if(n=a._tr_tally(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,s=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else n=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(n&&(f(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,4===t?(f(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(f(e,!1),0===e.strm.avail_out)?1:2}function b(e,t){for(var s,n,r;;){if(e.lookahead<262){if(y(e),e.lookahead<262&&0===t)return 1;if(0===e.lookahead)break}if(s=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,s=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==s&&e.prev_length<e.max_lazy_match&&e.strstart-s<=e.w_size-262&&(e.match_length=m(e,s),e.match_length<=5&&(1===e.strategy||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){r=e.strstart+e.lookahead-3,n=a._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=r&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,s=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,n&&(f(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if((n=a._tr_tally(e,0,e.window[e.strstart-1]))&&f(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(n=a._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,4===t?(f(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(f(e,!1),0===e.strm.avail_out)?1:2}function v(e,t,s,n,r){this.good_length=e,this.max_lazy=t,this.nice_length=s,this.max_chain=n,this.func=r}function E(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new r.Buf16(1146),this.dyn_dtree=new r.Buf16(122),this.bl_tree=new r.Buf16(78),h(this.dyn_ltree),h(this.dyn_dtree),h(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new r.Buf16(16),this.heap=new r.Buf16(573),h(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new r.Buf16(573),h(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function S(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=2,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?42:113,e.adler=2===t.wrap?0:1,t.last_flush=0,a._tr_init(t),0):c(e,-2)}function w(e){var t,s=S(e);return 0===s&&((t=e.state).window_size=2*t.w_size,h(t.head),t.max_lazy_match=n[t.level].max_lazy,t.good_match=n[t.level].good_length,t.nice_match=n[t.level].nice_length,t.max_chain_length=n[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=2,t.match_available=0,t.ins_h=0),s}function C(e,t,s,n,a,o){if(!e)return-2;var i=1;if(-1===t&&(t=6),n<0?(i=0,n=-n):n>15&&(i=2,n-=16),a<1||a>9||8!==s||n<8||n>15||t<0||t>9||o<0||o>4)return c(e,-2);8===n&&(n=9);var l=new E;return e.state=l,l.strm=e,l.wrap=i,l.gzhead=null,l.w_bits=n,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=a+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+3-1)/3),l.window=new r.Buf8(2*l.w_size),l.head=new r.Buf16(l.hash_size),l.prev=new r.Buf16(l.w_size),l.lit_bufsize=1<<a+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new r.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=t,l.strategy=o,l.method=s,w(e)}n=[new v(0,0,0,0,(function(e,t){var s=65535;for(s>e.pending_buf_size-5&&(s=e.pending_buf_size-5);;){if(e.lookahead<=1){if(y(e),0===e.lookahead&&0===t)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var n=e.block_start+s;if((0===e.strstart||e.strstart>=n)&&(e.lookahead=e.strstart-n,e.strstart=n,f(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-262&&(f(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(f(e,!0),0===e.strm.avail_out?3:4):(e.strstart>e.block_start&&(f(e,!1),e.strm.avail_out),1)})),new v(4,4,8,4,_),new v(4,5,16,8,_),new v(4,6,32,32,_),new v(4,4,16,16,b),new v(8,16,32,32,b),new v(8,16,128,128,b),new v(8,32,128,256,b),new v(32,128,258,1024,b),new v(32,258,258,4096,b)],t.deflateInit=function(e,t){return C(e,t,8,15,8,0)},t.deflateInit2=C,t.deflateReset=w,t.deflateResetKeep=S,t.deflateSetHeader=function(e,t){return e&&e.state?2!==e.state.wrap?-2:(e.state.gzhead=t,0):-2},t.deflate=function(e,t){var s,r,o,l;if(!e||!e.state||t>5||t<0)return e?c(e,-2):-2;if(r=e.state,!e.output||!e.input&&0!==e.avail_in||666===r.status&&4!==t)return c(e,0===e.avail_out?-5:-2);if(r.strm=e,s=r.last_flush,r.last_flush=t,42===r.status)if(2===r.wrap)e.adler=0,g(r,31),g(r,139),g(r,8),r.gzhead?(g(r,(r.gzhead.text?1:0)+(r.gzhead.hcrc?2:0)+(r.gzhead.extra?4:0)+(r.gzhead.name?8:0)+(r.gzhead.comment?16:0)),g(r,255&r.gzhead.time),g(r,r.gzhead.time>>8&255),g(r,r.gzhead.time>>16&255),g(r,r.gzhead.time>>24&255),g(r,9===r.level?2:r.strategy>=2||r.level<2?4:0),g(r,255&r.gzhead.os),r.gzhead.extra&&r.gzhead.extra.length&&(g(r,255&r.gzhead.extra.length),g(r,r.gzhead.extra.length>>8&255)),r.gzhead.hcrc&&(e.adler=i(e.adler,r.pending_buf,r.pending,0)),r.gzindex=0,r.status=69):(g(r,0),g(r,0),g(r,0),g(r,0),g(r,0),g(r,9===r.level?2:r.strategy>=2||r.level<2?4:0),g(r,3),r.status=113);else{var m=8+(r.w_bits-8<<4)<<8;m|=(r.strategy>=2||r.level<2?0:r.level<6?1:6===r.level?2:3)<<6,0!==r.strstart&&(m|=32),m+=31-m%31,r.status=113,p(r,m),0!==r.strstart&&(p(r,e.adler>>>16),p(r,65535&e.adler)),e.adler=1}if(69===r.status)if(r.gzhead.extra){for(o=r.pending;r.gzindex<(65535&r.gzhead.extra.length)&&(r.pending!==r.pending_buf_size||(r.gzhead.hcrc&&r.pending>o&&(e.adler=i(e.adler,r.pending_buf,r.pending-o,o)),d(e),o=r.pending,r.pending!==r.pending_buf_size));)g(r,255&r.gzhead.extra[r.gzindex]),r.gzindex++;r.gzhead.hcrc&&r.pending>o&&(e.adler=i(e.adler,r.pending_buf,r.pending-o,o)),r.gzindex===r.gzhead.extra.length&&(r.gzindex=0,r.status=73)}else r.status=73;if(73===r.status)if(r.gzhead.name){o=r.pending;do{if(r.pending===r.pending_buf_size&&(r.gzhead.hcrc&&r.pending>o&&(e.adler=i(e.adler,r.pending_buf,r.pending-o,o)),d(e),o=r.pending,r.pending===r.pending_buf_size)){l=1;break}l=r.gzindex<r.gzhead.name.length?255&r.gzhead.name.charCodeAt(r.gzindex++):0,g(r,l)}while(0!==l);r.gzhead.hcrc&&r.pending>o&&(e.adler=i(e.adler,r.pending_buf,r.pending-o,o)),0===l&&(r.gzindex=0,r.status=91)}else r.status=91;if(91===r.status)if(r.gzhead.comment){o=r.pending;do{if(r.pending===r.pending_buf_size&&(r.gzhead.hcrc&&r.pending>o&&(e.adler=i(e.adler,r.pending_buf,r.pending-o,o)),d(e),o=r.pending,r.pending===r.pending_buf_size)){l=1;break}l=r.gzindex<r.gzhead.comment.length?255&r.gzhead.comment.charCodeAt(r.gzindex++):0,g(r,l)}while(0!==l);r.gzhead.hcrc&&r.pending>o&&(e.adler=i(e.adler,r.pending_buf,r.pending-o,o)),0===l&&(r.status=103)}else r.status=103;if(103===r.status&&(r.gzhead.hcrc?(r.pending+2>r.pending_buf_size&&d(e),r.pending+2<=r.pending_buf_size&&(g(r,255&e.adler),g(r,e.adler>>8&255),e.adler=0,r.status=113)):r.status=113),0!==r.pending){if(d(e),0===e.avail_out)return r.last_flush=-1,0}else if(0===e.avail_in&&u(t)<=u(s)&&4!==t)return c(e,-5);if(666===r.status&&0!==e.avail_in)return c(e,-5);if(0!==e.avail_in||0!==r.lookahead||0!==t&&666!==r.status){var _=2===r.strategy?function(e,t){for(var s;;){if(0===e.lookahead&&(y(e),0===e.lookahead)){if(0===t)return 1;break}if(e.match_length=0,s=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,s&&(f(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(f(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(f(e,!1),0===e.strm.avail_out)?1:2}(r,t):3===r.strategy?function(e,t){for(var s,n,r,o,i=e.window;;){if(e.lookahead<=258){if(y(e),e.lookahead<=258&&0===t)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(n=i[r=e.strstart-1])===i[++r]&&n===i[++r]&&n===i[++r]){o=e.strstart+258;do{}while(n===i[++r]&&n===i[++r]&&n===i[++r]&&n===i[++r]&&n===i[++r]&&n===i[++r]&&n===i[++r]&&n===i[++r]&&r<o);e.match_length=258-(o-r),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(s=a._tr_tally(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(s=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),s&&(f(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(f(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(f(e,!1),0===e.strm.avail_out)?1:2}(r,t):n[r.level].func(r,t);if(3!==_&&4!==_||(r.status=666),1===_||3===_)return 0===e.avail_out&&(r.last_flush=-1),0;if(2===_&&(1===t?a._tr_align(r):5!==t&&(a._tr_stored_block(r,0,0,!1),3===t&&(h(r.head),0===r.lookahead&&(r.strstart=0,r.block_start=0,r.insert=0))),d(e),0===e.avail_out))return r.last_flush=-1,0}return 4!==t?0:r.wrap<=0?1:(2===r.wrap?(g(r,255&e.adler),g(r,e.adler>>8&255),g(r,e.adler>>16&255),g(r,e.adler>>24&255),g(r,255&e.total_in),g(r,e.total_in>>8&255),g(r,e.total_in>>16&255),g(r,e.total_in>>24&255)):(p(r,e.adler>>>16),p(r,65535&e.adler)),d(e),r.wrap>0&&(r.wrap=-r.wrap),0!==r.pending?0:1)},t.deflateEnd=function(e){var t;return e&&e.state?42!==(t=e.state.status)&&69!==t&&73!==t&&91!==t&&103!==t&&113!==t&&666!==t?c(e,-2):(e.state=null,113===t?c(e,-3):0):-2},t.deflateSetDictionary=function(e,t){var s,n,a,i,l,c,u,d,f=t.length;if(!e||!e.state)return-2;if(2===(i=(s=e.state).wrap)||1===i&&42!==s.status||s.lookahead)return-2;for(1===i&&(e.adler=o(e.adler,t,f,0)),s.wrap=0,f>=s.w_size&&(0===i&&(h(s.head),s.strstart=0,s.block_start=0,s.insert=0),d=new r.Buf8(s.w_size),r.arraySet(d,t,f-s.w_size,s.w_size,0),t=d,f=s.w_size),l=e.avail_in,c=e.next_in,u=e.input,e.avail_in=f,e.next_in=0,e.input=t,y(s);s.lookahead>=3;){n=s.strstart,a=s.lookahead-2;do{s.ins_h=(s.ins_h<<s.hash_shift^s.window[n+3-1])&s.hash_mask,s.prev[n&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=n,n++}while(--a);s.strstart=n,s.lookahead=2,y(s)}return s.strstart+=s.lookahead,s.block_start=s.strstart,s.insert=s.lookahead,s.lookahead=0,s.match_length=s.prev_length=2,s.match_available=0,e.next_in=c,e.input=u,e.avail_in=l,s.wrap=i,0},t.deflateInfo="pako deflate (from Nodeca project)"},function(e,t,s){"use strict";var n=s(89);function r(e){for(var t=e.length;--t>=0;)e[t]=0}var a=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],o=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],l=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],c=new Array(576);r(c);var u=new Array(60);r(u);var h=new Array(512);r(h);var d=new Array(256);r(d);var f=new Array(29);r(f);var g,p,m,y=new Array(30);function _(e,t,s,n,r){this.static_tree=e,this.extra_bits=t,this.extra_base=s,this.elems=n,this.max_length=r,this.has_stree=e&&e.length}function b(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function v(e){return e<256?h[e]:h[256+(e>>>7)]}function E(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function S(e,t,s){e.bi_valid>16-s?(e.bi_buf|=t<<e.bi_valid&65535,E(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=s-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=s)}function w(e,t,s){S(e,s[2*t],s[2*t+1])}function C(e,t){var s=0;do{s|=1&e,e>>>=1,s<<=1}while(--t>0);return s>>>1}function T(e,t,s){var n,r,a=new Array(16),o=0;for(n=1;n<=15;n++)a[n]=o=o+s[n-1]<<1;for(r=0;r<=t;r++){var i=e[2*r+1];0!==i&&(e[2*r]=C(a[i]++,i))}}function O(e){var t;for(t=0;t<286;t++)e.dyn_ltree[2*t]=0;for(t=0;t<30;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function A(e){e.bi_valid>8?E(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function M(e,t,s,n){var r=2*t,a=2*s;return e[r]<e[a]||e[r]===e[a]&&n[t]<=n[s]}function N(e,t,s){for(var n=e.heap[s],r=s<<1;r<=e.heap_len&&(r<e.heap_len&&M(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!M(t,n,e.heap[r],e.depth));)e.heap[s]=e.heap[r],s=r,r<<=1;e.heap[s]=n}function P(e,t,s){var n,r,i,l,c=0;if(0!==e.last_lit)do{n=e.pending_buf[e.d_buf+2*c]<<8|e.pending_buf[e.d_buf+2*c+1],r=e.pending_buf[e.l_buf+c],c++,0===n?w(e,r,t):(w(e,(i=d[r])+256+1,t),0!==(l=a[i])&&S(e,r-=f[i],l),w(e,i=v(--n),s),0!==(l=o[i])&&S(e,n-=y[i],l))}while(c<e.last_lit);w(e,256,t)}function D(e,t){var s,n,r,a=t.dyn_tree,o=t.stat_desc.static_tree,i=t.stat_desc.has_stree,l=t.stat_desc.elems,c=-1;for(e.heap_len=0,e.heap_max=573,s=0;s<l;s++)0!==a[2*s]?(e.heap[++e.heap_len]=c=s,e.depth[s]=0):a[2*s+1]=0;for(;e.heap_len<2;)a[2*(r=e.heap[++e.heap_len]=c<2?++c:0)]=1,e.depth[r]=0,e.opt_len--,i&&(e.static_len-=o[2*r+1]);for(t.max_code=c,s=e.heap_len>>1;s>=1;s--)N(e,a,s);r=l;do{s=e.heap[1],e.heap[1]=e.heap[e.heap_len--],N(e,a,1),n=e.heap[1],e.heap[--e.heap_max]=s,e.heap[--e.heap_max]=n,a[2*r]=a[2*s]+a[2*n],e.depth[r]=(e.depth[s]>=e.depth[n]?e.depth[s]:e.depth[n])+1,a[2*s+1]=a[2*n+1]=r,e.heap[1]=r++,N(e,a,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var s,n,r,a,o,i,l=t.dyn_tree,c=t.max_code,u=t.stat_desc.static_tree,h=t.stat_desc.has_stree,d=t.stat_desc.extra_bits,f=t.stat_desc.extra_base,g=t.stat_desc.max_length,p=0;for(a=0;a<=15;a++)e.bl_count[a]=0;for(l[2*e.heap[e.heap_max]+1]=0,s=e.heap_max+1;s<573;s++)(a=l[2*l[2*(n=e.heap[s])+1]+1]+1)>g&&(a=g,p++),l[2*n+1]=a,n>c||(e.bl_count[a]++,o=0,n>=f&&(o=d[n-f]),i=l[2*n],e.opt_len+=i*(a+o),h&&(e.static_len+=i*(u[2*n+1]+o)));if(0!==p){do{for(a=g-1;0===e.bl_count[a];)a--;e.bl_count[a]--,e.bl_count[a+1]+=2,e.bl_count[g]--,p-=2}while(p>0);for(a=g;0!==a;a--)for(n=e.bl_count[a];0!==n;)(r=e.heap[--s])>c||(l[2*r+1]!==a&&(e.opt_len+=(a-l[2*r+1])*l[2*r],l[2*r+1]=a),n--)}}(e,t),T(a,c,e.bl_count)}function I(e,t,s){var n,r,a=-1,o=t[1],i=0,l=7,c=4;for(0===o&&(l=138,c=3),t[2*(s+1)+1]=65535,n=0;n<=s;n++)r=o,o=t[2*(n+1)+1],++i<l&&r===o||(i<c?e.bl_tree[2*r]+=i:0!==r?(r!==a&&e.bl_tree[2*r]++,e.bl_tree[32]++):i<=10?e.bl_tree[34]++:e.bl_tree[36]++,i=0,a=r,0===o?(l=138,c=3):r===o?(l=6,c=3):(l=7,c=4))}function L(e,t,s){var n,r,a=-1,o=t[1],i=0,l=7,c=4;for(0===o&&(l=138,c=3),n=0;n<=s;n++)if(r=o,o=t[2*(n+1)+1],!(++i<l&&r===o)){if(i<c)do{w(e,r,e.bl_tree)}while(0!=--i);else 0!==r?(r!==a&&(w(e,r,e.bl_tree),i--),w(e,16,e.bl_tree),S(e,i-3,2)):i<=10?(w(e,17,e.bl_tree),S(e,i-3,3)):(w(e,18,e.bl_tree),S(e,i-11,7));i=0,a=r,0===o?(l=138,c=3):r===o?(l=6,c=3):(l=7,c=4)}}r(y);var x=!1;function k(e,t,s,r){S(e,0+(r?1:0),3),function(e,t,s,r){A(e),r&&(E(e,s),E(e,~s)),n.arraySet(e.pending_buf,e.window,t,s,e.pending),e.pending+=s}(e,t,s,!0)}t._tr_init=function(e){x||(!function(){var e,t,s,n,r,l=new Array(16);for(s=0,n=0;n<28;n++)for(f[n]=s,e=0;e<1<<a[n];e++)d[s++]=n;for(d[s-1]=n,r=0,n=0;n<16;n++)for(y[n]=r,e=0;e<1<<o[n];e++)h[r++]=n;for(r>>=7;n<30;n++)for(y[n]=r<<7,e=0;e<1<<o[n]-7;e++)h[256+r++]=n;for(t=0;t<=15;t++)l[t]=0;for(e=0;e<=143;)c[2*e+1]=8,e++,l[8]++;for(;e<=255;)c[2*e+1]=9,e++,l[9]++;for(;e<=279;)c[2*e+1]=7,e++,l[7]++;for(;e<=287;)c[2*e+1]=8,e++,l[8]++;for(T(c,287,l),e=0;e<30;e++)u[2*e+1]=5,u[2*e]=C(e,5);g=new _(c,a,257,286,15),p=new _(u,o,0,30,15),m=new _(new Array(0),i,0,19,7)}(),x=!0),e.l_desc=new b(e.dyn_ltree,g),e.d_desc=new b(e.dyn_dtree,p),e.bl_desc=new b(e.bl_tree,m),e.bi_buf=0,e.bi_valid=0,O(e)},t._tr_stored_block=k,t._tr_flush_block=function(e,t,s,n){var r,a,o=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,s=4093624447;for(t=0;t<=31;t++,s>>>=1)if(1&s&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<256;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0}(e)),D(e,e.l_desc),D(e,e.d_desc),o=function(e){var t;for(I(e,e.dyn_ltree,e.l_desc.max_code),I(e,e.dyn_dtree,e.d_desc.max_code),D(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*l[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),r=e.opt_len+3+7>>>3,(a=e.static_len+3+7>>>3)<=r&&(r=a)):r=a=s+5,s+4<=r&&-1!==t?k(e,t,s,n):4===e.strategy||a===r?(S(e,2+(n?1:0),3),P(e,c,u)):(S(e,4+(n?1:0),3),function(e,t,s,n){var r;for(S(e,t-257,5),S(e,s-1,5),S(e,n-4,4),r=0;r<n;r++)S(e,e.bl_tree[2*l[r]+1],3);L(e,e.dyn_ltree,t-1),L(e,e.dyn_dtree,s-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),P(e,e.dyn_ltree,e.dyn_dtree)),O(e),n&&A(e)},t._tr_tally=function(e,t,s){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&s,e.last_lit++,0===t?e.dyn_ltree[2*s]++:(e.matches++,t--,e.dyn_ltree[2*(d[s]+256+1)]++,e.dyn_dtree[2*v(t)]++),e.last_lit===e.lit_bufsize-1},t._tr_align=function(e){S(e,2,3),w(e,256,c),function(e){16===e.bi_valid?(E(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}},function(e,t,s){"use strict";e.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},function(e,t,s){"use strict";var n=s(89),r=s(206),a=s(207),o=s(447),i=s(448);function l(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function c(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new n.Buf16(320),this.work=new n.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function u(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new n.Buf32(852),t.distcode=t.distdyn=new n.Buf32(592),t.sane=1,t.back=-1,0):-2}function h(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,u(e)):-2}function d(e,t){var s,n;return e&&e.state?(n=e.state,t<0?(s=0,t=-t):(s=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?-2:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=s,n.wbits=t,h(e))):-2}function f(e,t){var s,n;return e?(n=new c,e.state=n,n.window=null,0!==(s=d(e,t))&&(e.state=null),s):-2}var g,p,m=!0;function y(e){if(m){var t;for(g=new n.Buf32(512),p=new n.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(i(1,e.lens,0,288,g,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;i(2,e.lens,0,32,p,0,e.work,{bits:5}),m=!1}e.lencode=g,e.lenbits=9,e.distcode=p,e.distbits=5}function _(e,t,s,r){var a,o=e.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new n.Buf8(o.wsize)),r>=o.wsize?(n.arraySet(o.window,t,s-o.wsize,o.wsize,0),o.wnext=0,o.whave=o.wsize):((a=o.wsize-o.wnext)>r&&(a=r),n.arraySet(o.window,t,s-r,a,o.wnext),(r-=a)?(n.arraySet(o.window,t,s-r,r,0),o.wnext=r,o.whave=o.wsize):(o.wnext+=a,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=a))),0}t.inflateReset=h,t.inflateReset2=d,t.inflateResetKeep=u,t.inflateInit=function(e){return f(e,15)},t.inflateInit2=f,t.inflate=function(e,t){var s,c,u,h,d,f,g,p,m,b,v,E,S,w,C,T,O,A,M,N,P,D,I,L,x=0,k=new n.Buf8(4),R=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return-2;12===(s=e.state).mode&&(s.mode=13),d=e.next_out,u=e.output,g=e.avail_out,h=e.next_in,c=e.input,f=e.avail_in,p=s.hold,m=s.bits,b=f,v=g,D=0;e:for(;;)switch(s.mode){case 1:if(0===s.wrap){s.mode=13;break}for(;m<16;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}if(2&s.wrap&&35615===p){s.check=0,k[0]=255&p,k[1]=p>>>8&255,s.check=a(s.check,k,2,0),p=0,m=0,s.mode=2;break}if(s.flags=0,s.head&&(s.head.done=!1),!(1&s.wrap)||(((255&p)<<8)+(p>>8))%31){e.msg="incorrect header check",s.mode=30;break}if(8!=(15&p)){e.msg="unknown compression method",s.mode=30;break}if(m-=4,P=8+(15&(p>>>=4)),0===s.wbits)s.wbits=P;else if(P>s.wbits){e.msg="invalid window size",s.mode=30;break}s.dmax=1<<P,e.adler=s.check=1,s.mode=512&p?10:12,p=0,m=0;break;case 2:for(;m<16;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}if(s.flags=p,8!=(255&s.flags)){e.msg="unknown compression method",s.mode=30;break}if(57344&s.flags){e.msg="unknown header flags set",s.mode=30;break}s.head&&(s.head.text=p>>8&1),512&s.flags&&(k[0]=255&p,k[1]=p>>>8&255,s.check=a(s.check,k,2,0)),p=0,m=0,s.mode=3;case 3:for(;m<32;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}s.head&&(s.head.time=p),512&s.flags&&(k[0]=255&p,k[1]=p>>>8&255,k[2]=p>>>16&255,k[3]=p>>>24&255,s.check=a(s.check,k,4,0)),p=0,m=0,s.mode=4;case 4:for(;m<16;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}s.head&&(s.head.xflags=255&p,s.head.os=p>>8),512&s.flags&&(k[0]=255&p,k[1]=p>>>8&255,s.check=a(s.check,k,2,0)),p=0,m=0,s.mode=5;case 5:if(1024&s.flags){for(;m<16;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}s.length=p,s.head&&(s.head.extra_len=p),512&s.flags&&(k[0]=255&p,k[1]=p>>>8&255,s.check=a(s.check,k,2,0)),p=0,m=0}else s.head&&(s.head.extra=null);s.mode=6;case 6:if(1024&s.flags&&((E=s.length)>f&&(E=f),E&&(s.head&&(P=s.head.extra_len-s.length,s.head.extra||(s.head.extra=new Array(s.head.extra_len)),n.arraySet(s.head.extra,c,h,E,P)),512&s.flags&&(s.check=a(s.check,c,E,h)),f-=E,h+=E,s.length-=E),s.length))break e;s.length=0,s.mode=7;case 7:if(2048&s.flags){if(0===f)break e;E=0;do{P=c[h+E++],s.head&&P&&s.length<65536&&(s.head.name+=String.fromCharCode(P))}while(P&&E<f);if(512&s.flags&&(s.check=a(s.check,c,E,h)),f-=E,h+=E,P)break e}else s.head&&(s.head.name=null);s.length=0,s.mode=8;case 8:if(4096&s.flags){if(0===f)break e;E=0;do{P=c[h+E++],s.head&&P&&s.length<65536&&(s.head.comment+=String.fromCharCode(P))}while(P&&E<f);if(512&s.flags&&(s.check=a(s.check,c,E,h)),f-=E,h+=E,P)break e}else s.head&&(s.head.comment=null);s.mode=9;case 9:if(512&s.flags){for(;m<16;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}if(p!==(65535&s.check)){e.msg="header crc mismatch",s.mode=30;break}p=0,m=0}s.head&&(s.head.hcrc=s.flags>>9&1,s.head.done=!0),e.adler=s.check=0,s.mode=12;break;case 10:for(;m<32;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}e.adler=s.check=l(p),p=0,m=0,s.mode=11;case 11:if(0===s.havedict)return e.next_out=d,e.avail_out=g,e.next_in=h,e.avail_in=f,s.hold=p,s.bits=m,2;e.adler=s.check=1,s.mode=12;case 12:if(5===t||6===t)break e;case 13:if(s.last){p>>>=7&m,m-=7&m,s.mode=27;break}for(;m<3;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}switch(s.last=1&p,m-=1,3&(p>>>=1)){case 0:s.mode=14;break;case 1:if(y(s),s.mode=20,6===t){p>>>=2,m-=2;break e}break;case 2:s.mode=17;break;case 3:e.msg="invalid block type",s.mode=30}p>>>=2,m-=2;break;case 14:for(p>>>=7&m,m-=7&m;m<32;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}if((65535&p)!=(p>>>16^65535)){e.msg="invalid stored block lengths",s.mode=30;break}if(s.length=65535&p,p=0,m=0,s.mode=15,6===t)break e;case 15:s.mode=16;case 16:if(E=s.length){if(E>f&&(E=f),E>g&&(E=g),0===E)break e;n.arraySet(u,c,h,E,d),f-=E,h+=E,g-=E,d+=E,s.length-=E;break}s.mode=12;break;case 17:for(;m<14;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}if(s.nlen=257+(31&p),p>>>=5,m-=5,s.ndist=1+(31&p),p>>>=5,m-=5,s.ncode=4+(15&p),p>>>=4,m-=4,s.nlen>286||s.ndist>30){e.msg="too many length or distance symbols",s.mode=30;break}s.have=0,s.mode=18;case 18:for(;s.have<s.ncode;){for(;m<3;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}s.lens[R[s.have++]]=7&p,p>>>=3,m-=3}for(;s.have<19;)s.lens[R[s.have++]]=0;if(s.lencode=s.lendyn,s.lenbits=7,I={bits:s.lenbits},D=i(0,s.lens,0,19,s.lencode,0,s.work,I),s.lenbits=I.bits,D){e.msg="invalid code lengths set",s.mode=30;break}s.have=0,s.mode=19;case 19:for(;s.have<s.nlen+s.ndist;){for(;T=(x=s.lencode[p&(1<<s.lenbits)-1])>>>16&255,O=65535&x,!((C=x>>>24)<=m);){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}if(O<16)p>>>=C,m-=C,s.lens[s.have++]=O;else{if(16===O){for(L=C+2;m<L;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}if(p>>>=C,m-=C,0===s.have){e.msg="invalid bit length repeat",s.mode=30;break}P=s.lens[s.have-1],E=3+(3&p),p>>>=2,m-=2}else if(17===O){for(L=C+3;m<L;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}m-=C,P=0,E=3+(7&(p>>>=C)),p>>>=3,m-=3}else{for(L=C+7;m<L;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}m-=C,P=0,E=11+(127&(p>>>=C)),p>>>=7,m-=7}if(s.have+E>s.nlen+s.ndist){e.msg="invalid bit length repeat",s.mode=30;break}for(;E--;)s.lens[s.have++]=P}}if(30===s.mode)break;if(0===s.lens[256]){e.msg="invalid code -- missing end-of-block",s.mode=30;break}if(s.lenbits=9,I={bits:s.lenbits},D=i(1,s.lens,0,s.nlen,s.lencode,0,s.work,I),s.lenbits=I.bits,D){e.msg="invalid literal/lengths set",s.mode=30;break}if(s.distbits=6,s.distcode=s.distdyn,I={bits:s.distbits},D=i(2,s.lens,s.nlen,s.ndist,s.distcode,0,s.work,I),s.distbits=I.bits,D){e.msg="invalid distances set",s.mode=30;break}if(s.mode=20,6===t)break e;case 20:s.mode=21;case 21:if(f>=6&&g>=258){e.next_out=d,e.avail_out=g,e.next_in=h,e.avail_in=f,s.hold=p,s.bits=m,o(e,v),d=e.next_out,u=e.output,g=e.avail_out,h=e.next_in,c=e.input,f=e.avail_in,p=s.hold,m=s.bits,12===s.mode&&(s.back=-1);break}for(s.back=0;T=(x=s.lencode[p&(1<<s.lenbits)-1])>>>16&255,O=65535&x,!((C=x>>>24)<=m);){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}if(T&&0==(240&T)){for(A=C,M=T,N=O;T=(x=s.lencode[N+((p&(1<<A+M)-1)>>A)])>>>16&255,O=65535&x,!(A+(C=x>>>24)<=m);){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}p>>>=A,m-=A,s.back+=A}if(p>>>=C,m-=C,s.back+=C,s.length=O,0===T){s.mode=26;break}if(32&T){s.back=-1,s.mode=12;break}if(64&T){e.msg="invalid literal/length code",s.mode=30;break}s.extra=15&T,s.mode=22;case 22:if(s.extra){for(L=s.extra;m<L;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}s.length+=p&(1<<s.extra)-1,p>>>=s.extra,m-=s.extra,s.back+=s.extra}s.was=s.length,s.mode=23;case 23:for(;T=(x=s.distcode[p&(1<<s.distbits)-1])>>>16&255,O=65535&x,!((C=x>>>24)<=m);){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}if(0==(240&T)){for(A=C,M=T,N=O;T=(x=s.distcode[N+((p&(1<<A+M)-1)>>A)])>>>16&255,O=65535&x,!(A+(C=x>>>24)<=m);){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}p>>>=A,m-=A,s.back+=A}if(p>>>=C,m-=C,s.back+=C,64&T){e.msg="invalid distance code",s.mode=30;break}s.offset=O,s.extra=15&T,s.mode=24;case 24:if(s.extra){for(L=s.extra;m<L;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}s.offset+=p&(1<<s.extra)-1,p>>>=s.extra,m-=s.extra,s.back+=s.extra}if(s.offset>s.dmax){e.msg="invalid distance too far back",s.mode=30;break}s.mode=25;case 25:if(0===g)break e;if(E=v-g,s.offset>E){if((E=s.offset-E)>s.whave&&s.sane){e.msg="invalid distance too far back",s.mode=30;break}E>s.wnext?(E-=s.wnext,S=s.wsize-E):S=s.wnext-E,E>s.length&&(E=s.length),w=s.window}else w=u,S=d-s.offset,E=s.length;E>g&&(E=g),g-=E,s.length-=E;do{u[d++]=w[S++]}while(--E);0===s.length&&(s.mode=21);break;case 26:if(0===g)break e;u[d++]=s.length,g--,s.mode=21;break;case 27:if(s.wrap){for(;m<32;){if(0===f)break e;f--,p|=c[h++]<<m,m+=8}if(v-=g,e.total_out+=v,s.total+=v,v&&(e.adler=s.check=s.flags?a(s.check,u,v,d-v):r(s.check,u,v,d-v)),v=g,(s.flags?p:l(p))!==s.check){e.msg="incorrect data check",s.mode=30;break}p=0,m=0}s.mode=28;case 28:if(s.wrap&&s.flags){for(;m<32;){if(0===f)break e;f--,p+=c[h++]<<m,m+=8}if(p!==(4294967295&s.total)){e.msg="incorrect length check",s.mode=30;break}p=0,m=0}s.mode=29;case 29:D=1;break e;case 30:D=-3;break e;case 31:return-4;case 32:default:return-2}return e.next_out=d,e.avail_out=g,e.next_in=h,e.avail_in=f,s.hold=p,s.bits=m,(s.wsize||v!==e.avail_out&&s.mode<30&&(s.mode<27||4!==t))&&_(e,e.output,e.next_out,v-e.avail_out)?(s.mode=31,-4):(b-=e.avail_in,v-=e.avail_out,e.total_in+=b,e.total_out+=v,s.total+=v,s.wrap&&v&&(e.adler=s.check=s.flags?a(s.check,u,v,e.next_out-v):r(s.check,u,v,e.next_out-v)),e.data_type=s.bits+(s.last?64:0)+(12===s.mode?128:0)+(20===s.mode||15===s.mode?256:0),(0===b&&0===v||4===t)&&0===D&&(D=-5),D)},t.inflateEnd=function(e){if(!e||!e.state)return-2;var t=e.state;return t.window&&(t.window=null),e.state=null,0},t.inflateGetHeader=function(e,t){var s;return e&&e.state?0==(2&(s=e.state).wrap)?-2:(s.head=t,t.done=!1,0):-2},t.inflateSetDictionary=function(e,t){var s,n=t.length;return e&&e.state?0!==(s=e.state).wrap&&11!==s.mode?-2:11===s.mode&&r(1,t,n,0)!==s.check?-3:_(e,t,n,n)?(s.mode=31,-4):(s.havedict=1,0):-2},t.inflateInfo="pako inflate (from Nodeca project)"},function(e,t,s){"use strict";e.exports=function(e,t){var s,n,r,a,o,i,l,c,u,h,d,f,g,p,m,y,_,b,v,E,S,w,C,T,O;s=e.state,n=e.next_in,T=e.input,r=n+(e.avail_in-5),a=e.next_out,O=e.output,o=a-(t-e.avail_out),i=a+(e.avail_out-257),l=s.dmax,c=s.wsize,u=s.whave,h=s.wnext,d=s.window,f=s.hold,g=s.bits,p=s.lencode,m=s.distcode,y=(1<<s.lenbits)-1,_=(1<<s.distbits)-1;e:do{g<15&&(f+=T[n++]<<g,g+=8,f+=T[n++]<<g,g+=8),b=p[f&y];t:for(;;){if(f>>>=v=b>>>24,g-=v,0===(v=b>>>16&255))O[a++]=65535&b;else{if(!(16&v)){if(0==(64&v)){b=p[(65535&b)+(f&(1<<v)-1)];continue t}if(32&v){s.mode=12;break e}e.msg="invalid literal/length code",s.mode=30;break e}E=65535&b,(v&=15)&&(g<v&&(f+=T[n++]<<g,g+=8),E+=f&(1<<v)-1,f>>>=v,g-=v),g<15&&(f+=T[n++]<<g,g+=8,f+=T[n++]<<g,g+=8),b=m[f&_];s:for(;;){if(f>>>=v=b>>>24,g-=v,!(16&(v=b>>>16&255))){if(0==(64&v)){b=m[(65535&b)+(f&(1<<v)-1)];continue s}e.msg="invalid distance code",s.mode=30;break e}if(S=65535&b,g<(v&=15)&&(f+=T[n++]<<g,(g+=8)<v&&(f+=T[n++]<<g,g+=8)),(S+=f&(1<<v)-1)>l){e.msg="invalid distance too far back",s.mode=30;break e}if(f>>>=v,g-=v,S>(v=a-o)){if((v=S-v)>u&&s.sane){e.msg="invalid distance too far back",s.mode=30;break e}if(w=0,C=d,0===h){if(w+=c-v,v<E){E-=v;do{O[a++]=d[w++]}while(--v);w=a-S,C=O}}else if(h<v){if(w+=c+h-v,(v-=h)<E){E-=v;do{O[a++]=d[w++]}while(--v);if(w=0,h<E){E-=v=h;do{O[a++]=d[w++]}while(--v);w=a-S,C=O}}}else if(w+=h-v,v<E){E-=v;do{O[a++]=d[w++]}while(--v);w=a-S,C=O}for(;E>2;)O[a++]=C[w++],O[a++]=C[w++],O[a++]=C[w++],E-=3;E&&(O[a++]=C[w++],E>1&&(O[a++]=C[w++]))}else{w=a-S;do{O[a++]=O[w++],O[a++]=O[w++],O[a++]=O[w++],E-=3}while(E>2);E&&(O[a++]=O[w++],E>1&&(O[a++]=O[w++]))}break}}break}}while(n<r&&a<i);n-=E=g>>3,f&=(1<<(g-=E<<3))-1,e.next_in=n,e.next_out=a,e.avail_in=n<r?r-n+5:5-(n-r),e.avail_out=a<i?i-a+257:257-(a-i),s.hold=f,s.bits=g}},function(e,t,s){"use strict";var n=s(89),r=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],a=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],i=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];e.exports=function(e,t,s,l,c,u,h,d){var f,g,p,m,y,_,b,v,E,S=d.bits,w=0,C=0,T=0,O=0,A=0,M=0,N=0,P=0,D=0,I=0,L=null,x=0,k=new n.Buf16(16),R=new n.Buf16(16),B=null,F=0;for(w=0;w<=15;w++)k[w]=0;for(C=0;C<l;C++)k[t[s+C]]++;for(A=S,O=15;O>=1&&0===k[O];O--);if(A>O&&(A=O),0===O)return c[u++]=20971520,c[u++]=20971520,d.bits=1,0;for(T=1;T<O&&0===k[T];T++);for(A<T&&(A=T),P=1,w=1;w<=15;w++)if(P<<=1,(P-=k[w])<0)return-1;if(P>0&&(0===e||1!==O))return-1;for(R[1]=0,w=1;w<15;w++)R[w+1]=R[w]+k[w];for(C=0;C<l;C++)0!==t[s+C]&&(h[R[t[s+C]]++]=C);if(0===e?(L=B=h,_=19):1===e?(L=r,x-=257,B=a,F-=257,_=256):(L=o,B=i,_=-1),I=0,C=0,w=T,y=u,M=A,N=0,p=-1,m=(D=1<<A)-1,1===e&&D>852||2===e&&D>592)return 1;for(;;){b=w-N,h[C]<_?(v=0,E=h[C]):h[C]>_?(v=B[F+h[C]],E=L[x+h[C]]):(v=96,E=0),f=1<<w-N,T=g=1<<M;do{c[y+(I>>N)+(g-=f)]=b<<24|v<<16|E|0}while(0!==g);for(f=1<<w-1;I&f;)f>>=1;if(0!==f?(I&=f-1,I+=f):I=0,C++,0==--k[w]){if(w===O)break;w=t[s+h[C]]}if(w>A&&(I&m)!==p){for(0===N&&(N=A),y+=T,P=1<<(M=w-N);M+N<O&&!((P-=k[M+N])<=0);)M++,P<<=1;if(D+=1<<M,1===e&&D>852||2===e&&D>592)return 1;c[p=I&m]=A<<24|M<<16|y-u|0}}return 0!==I&&(c[y+I]=w-N<<24|64<<16|0),d.bits=A,0}},function(e,t,s){"use strict";e.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},function(e,t,s){"use strict";function n(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}Object.defineProperty(t,"__esModule",{value:!0}),n(s(192)),n(s(198)),n(s(196)),n(s(451)),n(s(452))},function(e,t,s){"use strict";function n(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}Object.defineProperty(t,"__esModule",{value:!0}),n(s(194)),n(s(193)),n(s(127))},function(e,t,s){"use strict";function n(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}Object.defineProperty(t,"__esModule",{value:!0}),n(s(128)),n(s(197)),n(s(195))},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(22)),a=s(36),o=n(s(14));class i extends r.default{constructor(e,t,s={}){super(e,t),this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8},this.setOptions(s),this._dirs=a.DIRS[this._options.topology],this._map=this._fillMap(0)}randomize(e){for(let t=0;t<this._width;t++)for(let s=0;s<this._height;s++)this._map[t][s]=o.default.getUniform()<e?1:0;return this}setOptions(e){Object.assign(this._options,e)}set(e,t,s){this._map[e][t]=s}create(e){const t=this._fillMap(0),s=this._options.born,n=this._options.survive;for(let e=0;e<this._height;e++){let r=1,a=0;6==this._options.topology&&(r=2,a=e%2);for(let o=a;o<this._width;o+=r){const r=this._map[o][e],a=this._getNeighbors(o,e);r&&-1!=n.indexOf(a)?t[o][e]=1:r||-1==s.indexOf(a)||(t[o][e]=1)}}this._map=t,e&&this._serviceCallback(e)}_serviceCallback(e){for(let t=0;t<this._height;t++){let s=1,n=0;6==this._options.topology&&(s=2,n=t%2);for(let r=n;r<this._width;r+=s)e(r,t,this._map[r][t])}}_getNeighbors(e,t){let s=0;for(let n=0;n<this._dirs.length;n++){const r=this._dirs[n],a=e+r[0],o=t+r[1];a<0||a>=this._width||o<0||o>=this._height||(s+=1==this._map[a][o]?1:0)}return s}connect(e,t,s){t||(t=0);const n=[],r={};let a=1,i=[0,0];6==this._options.topology&&(a=2,i=[0,1]);for(let e=0;e<this._height;e++)for(let s=i[e%2];s<this._width;s+=a)if(this._freeSpace(s,e,t)){const t=[s,e];r[this._pointKey(t)]=t,n.push([s,e])}const l=n[o.default.getUniformInt(0,n.length-1)],c=this._pointKey(l),u={};for(u[c]=l,delete r[c],this._findConnected(u,r,[l],!1,t);Object.keys(r).length>0;){const e=this._getFromTo(u,r),n=e[0],a=e[1],o={};o[this._pointKey(n)]=n,this._findConnected(o,r,[n],!0,t);(6==this._options.topology?this._tunnelToConnected6:this._tunnelToConnected).call(this,a,n,u,r,t,s);for(const e in o){const s=o[e];this._map[s[0]][s[1]]=t,u[e]=s,delete r[e]}}e&&this._serviceCallback(e)}_getFromTo(e,t){let s,n=[0,0],r=[0,0];const a=Object.keys(e),i=Object.keys(t);for(let l=0;l<5;l++){if(a.length<i.length){const s=a;r=e[s[o.default.getUniformInt(0,s.length-1)]],n=this._getClosest(r,t)}else{const s=i;n=t[s[o.default.getUniformInt(0,s.length-1)]],r=this._getClosest(n,e)}if(s=(n[0]-r[0])*(n[0]-r[0])+(n[1]-r[1])*(n[1]-r[1]),s<64)break}return[n,r]}_getClosest(e,t){let s=null,n=null;for(const r in t){const a=t[r],o=(a[0]-e[0])*(a[0]-e[0])+(a[1]-e[1])*(a[1]-e[1]);(null==n||o<n)&&(n=o,s=a)}return s}_findConnected(e,t,s,n,r){for(;s.length>0;){const a=s.splice(0,1)[0];let o;o=6==this._options.topology?[[a[0]+2,a[1]],[a[0]+1,a[1]-1],[a[0]-1,a[1]-1],[a[0]-2,a[1]],[a[0]-1,a[1]+1],[a[0]+1,a[1]+1]]:[[a[0]+1,a[1]],[a[0]-1,a[1]],[a[0],a[1]+1],[a[0],a[1]-1]];for(let a=0;a<o.length;a++){const i=this._pointKey(o[a]);null==e[i]&&this._freeSpace(o[a][0],o[a][1],r)&&(e[i]=o[a],n||delete t[i],s.push(o[a]))}}}_tunnelToConnected(e,t,s,n,r,a){let o,i;t[0]<e[0]?(o=t,i=e):(o=e,i=t);for(let e=o[0];e<=i[0];e++){this._map[e][o[1]]=r;const t=[e,o[1]],a=this._pointKey(t);s[a]=t,delete n[a]}a&&o[0]<i[0]&&a(o,[i[0],o[1]]);const l=i[0];t[1]<e[1]?(o=t,i=e):(o=e,i=t);for(let e=o[1];e<i[1];e++){this._map[l][e]=r;const t=[l,e],a=this._pointKey(t);s[a]=t,delete n[a]}a&&o[1]<i[1]&&a([i[0],o[1]],[i[0],i[1]])}_tunnelToConnected6(e,t,s,n,r,a){let o,i;t[0]<e[0]?(o=t,i=e):(o=e,i=t);let l=o[0],c=o[1];for(;l!=i[0]||c!=i[1];){let e=2;c<i[1]?(c++,e=1):c>i[1]&&(c--,e=1),l<i[0]?l+=e:l>i[0]||i[1]%2?l-=e:l+=e,this._map[l][c]=r;const t=[l,c],a=this._pointKey(t);s[a]=t,delete n[a]}a&&a(t,e)}_freeSpace(e,t,s){return e>=0&&e<this._width&&t>=0&&t<this._height&&this._map[e][t]==s}_pointKey(e){return e[0]+"."+e[1]}}t.default=i},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(22)),a=n(s(14));function o(e,t,s){s[t[e+1]]=s[e],t[s[e]]=t[e+1],s[e]=e+1,t[e+1]=e}function i(e,t,s){s[t[e]]=s[e],t[s[e]]=t[e],s[e]=e,t[e]=e}class l extends r.default{create(e){const t=this._fillMap(1),s=Math.ceil((this._width-2)/2),n=[],r=[];for(let e=0;e<s;e++)n.push(e),r.push(e);let l;for(n.push(s-1),l=1;l+3<this._height;l+=2)for(let e=0;e<s;e++){const s=2*e+1,c=l;t[s][c]=0,e!=n[e+1]&&a.default.getUniform()>9/24&&(o(e,n,r),t[s+1][c]=0),e!=n[e]&&a.default.getUniform()>9/24?i(e,n,r):t[s][c+1]=0}for(let e=0;e<s;e++){const s=2*e+1,c=l;t[s][c]=0,e!=n[e+1]&&(e==n[e]||a.default.getUniform()>9/24)&&(o(e,n,r),t[s+1][c]=0),i(e,n,r)}for(let s=0;s<this._width;s++)for(let n=0;n<this._height;n++)e(s,n,t[s][n]);return this}}t.default=l},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(22)),a=n(s(14));class o extends r.default{constructor(){super(...arguments),this._stack=[],this._map=[]}create(e){const t=this._width,s=this._height;this._map=[];for(let e=0;e<t;e++){this._map.push([]);for(let n=0;n<s;n++){const r=0==e||0==n||e+1==t||n+1==s;this._map[e].push(r?1:0)}}this._stack=[[1,1,t-2,s-2]],this._process();for(let n=0;n<t;n++)for(let t=0;t<s;t++)e(n,t,this._map[n][t]);return this._map=[],this}_process(){for(;this._stack.length;){const e=this._stack.shift();this._partitionRoom(e)}}_partitionRoom(e){const t=[],s=[];for(let s=e[0]+1;s<e[2];s++){const n=this._map[s][e[1]-1],r=this._map[s][e[3]+1];!n||!r||s%2||t.push(s)}for(let t=e[1]+1;t<e[3];t++){const n=this._map[e[0]-1][t],r=this._map[e[2]+1][t];!n||!r||t%2||s.push(t)}if(!t.length||!s.length)return;const n=a.default.getItem(t),r=a.default.getItem(s);this._map[n][r]=1;const o=[];let i=[];o.push(i);for(let t=e[0];t<n;t++)this._map[t][r]=1,t%2&&i.push([t,r]);i=[],o.push(i);for(let t=n+1;t<=e[2];t++)this._map[t][r]=1,t%2&&i.push([t,r]);i=[],o.push(i);for(let t=e[1];t<r;t++)this._map[n][t]=1,t%2&&i.push([n,t]);i=[],o.push(i);for(let t=r+1;t<=e[3];t++)this._map[n][t]=1,t%2&&i.push([n,t]);const l=a.default.getItem(o);for(let e=0;e<o.length;e++){const t=o[e];if(t==l)continue;const s=a.default.getItem(t);this._map[s[0]][s[1]]=0}this._stack.push([e[0],e[1],n-1,r-1]),this._stack.push([n+1,e[1],e[2],r-1]),this._stack.push([e[0],r+1,n-1,e[3]]),this._stack.push([n+1,r+1,e[2],e[3]])}}t.default=o},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(22)),a=n(s(14));class o extends r.default{constructor(e,t,s=0){super(e,t),this._regularity=s,this._map=[]}create(e){let t=this._width,s=this._height;const n=this._fillMap(1);t-=t%2?1:2,s-=s%2?1:2;let r=0,o=0,i=0,l=0,c=0,u=!1;const h=[[0,0],[0,0],[0,0],[0,0]];do{if(r=1+2*Math.floor(a.default.getUniform()*(t-1)/2),o=1+2*Math.floor(a.default.getUniform()*(s-1)/2),c||(n[r][o]=0),!n[r][o]){this._randomize(h);do{0==Math.floor(a.default.getUniform()*(this._regularity+1))&&this._randomize(h),u=!0;for(let e=0;e<4;e++)if(i=r+2*h[e][0],l=o+2*h[e][1],this._isFree(n,i,l,t,s)){n[i][l]=0,n[r+h[e][0]][o+h[e][1]]=0,r=i,o=l,u=!1,c++;break}}while(!u)}}while(c+1<t*s/4);for(let t=0;t<this._width;t++)for(let s=0;s<this._height;s++)e(t,s,n[t][s]);return this._map=[],this}_randomize(e){for(let t=0;t<4;t++)e[t][0]=0,e[t][1]=0;switch(Math.floor(4*a.default.getUniform())){case 0:e[0][0]=-1,e[1][0]=1,e[2][1]=-1,e[3][1]=1;break;case 1:e[3][0]=-1,e[2][0]=1,e[1][1]=-1,e[0][1]=1;break;case 2:e[2][0]=-1,e[3][0]=1,e[0][1]=-1,e[1][1]=1;break;case 3:e[1][0]=-1,e[0][0]=1,e[3][1]=-1,e[2][1]=1}}_isFree(e,t,s,n,r){return!(t<1||s<1||t>=n||s>=r)&&e[t][s]}}t.default=o},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(s(22)),a=n(s(14)),o=s(36);class i extends r.default{constructor(e,t,s){super(e,t),this.map=[],this.rooms=[],this.connectedCells=[],(s=Object.assign({cellWidth:3,cellHeight:3},s)).hasOwnProperty("roomWidth")||(s.roomWidth=this._calculateRoomSize(this._width,s.cellWidth)),s.hasOwnProperty("roomHeight")||(s.roomHeight=this._calculateRoomSize(this._height,s.cellHeight)),this._options=s}create(e){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),e)for(let t=0;t<this._width;t++)for(let s=0;s<this._height;s++)e(t,s,this.map[t][s]);return this}_calculateRoomSize(e,t){let s=Math.floor(e/t*.8),n=Math.floor(e/t*.25);return n<2&&(n=2),s<2&&(s=2),[n,s]}_initRooms(){for(let e=0;e<this._options.cellWidth;e++){this.rooms.push([]);for(let t=0;t<this._options.cellHeight;t++)this.rooms[e].push({x:0,y:0,width:0,height:0,connections:[],cellx:e,celly:t})}}_connectRooms(){let e,t,s,n,r,i,l=a.default.getUniformInt(0,this._options.cellWidth-1),c=a.default.getUniformInt(0,this._options.cellHeight-1),u=!1;do{i=[0,2,4,6],i=a.default.shuffle(i);do{if(u=!1,e=i.pop(),t=l+o.DIRS[8][e][0],s=c+o.DIRS[8][e][1],!(t<0||t>=this._options.cellWidth||s<0||s>=this._options.cellHeight)){if(n=this.rooms[l][c],n.connections.length>0&&n.connections[0][0]==t&&n.connections[0][1]==s)break;r=this.rooms[t][s],0==r.connections.length&&(r.connections.push([l,c]),this.connectedCells.push([t,s]),l=t,c=s,u=!0)}}while(i.length>0&&0==u)}while(i.length>0)}_connectUnconnectedRooms(){const e=this._options.cellWidth,t=this._options.cellHeight;let s,n,r;this.connectedCells=a.default.shuffle(this.connectedCells);for(let i=0;i<this._options.cellWidth;i++)for(let l=0;l<this._options.cellHeight;l++)if(s=this.rooms[i][l],0==s.connections.length){let c=[0,2,4,6];c=a.default.shuffle(c),r=!1;do{const s=c.pop(),a=i+o.DIRS[8][s][0],u=l+o.DIRS[8][s][1];if(!(a<0||a>=e||u<0||u>=t)){if(n=this.rooms[a][u],r=!0,0==n.connections.length)break;for(let e=0;e<n.connections.length;e++)if(n.connections[e][0]==i&&n.connections[e][1]==l){r=!1;break}if(r)break}}while(c.length);r?s.connections.push([n.cellx,n.celly]):console.log("-- Unable to connect room.")}}_createRandomRoomConnections(){}_createRooms(){const e=this._width,t=this._height,s=this._options.cellWidth,n=this._options.cellHeight,r=Math.floor(this._width/s),o=Math.floor(this._height/n);let i,l;const c=this._options.roomWidth,u=this._options.roomHeight;let h,d,f;for(let g=0;g<s;g++)for(let s=0;s<n;s++){if(h=r*g,d=o*s,0==h&&(h=1),0==d&&(d=1),i=a.default.getUniformInt(c[0],c[1]),l=a.default.getUniformInt(u[0],u[1]),s>0)for(f=this.rooms[g][s-1];d-(f.y+f.height)<3;)d++;if(g>0)for(f=this.rooms[g-1][s];h-(f.x+f.width)<3;)h++;let n=Math.round(a.default.getUniformInt(0,r-i)/2),p=Math.round(a.default.getUniformInt(0,o-l)/2);for(;h+n+i>=e;)n?n--:i--;for(;d+p+l>=t;)p?p--:l--;h+=n,d+=p,this.rooms[g][s].x=h,this.rooms[g][s].y=d,this.rooms[g][s].width=i,this.rooms[g][s].height=l;for(let e=h;e<h+i;e++)for(let t=d;t<d+l;t++)this.map[e][t]=0}}_getWallPosition(e,t){let s,n,r;return 1==t||3==t?(s=a.default.getUniformInt(e.x+1,e.x+e.width-2),1==t?(n=e.y-2,r=n+1):(n=e.y+e.height+1,r=n-1),this.map[s][r]=0):(n=a.default.getUniformInt(e.y+1,e.y+e.height-2),2==t?(s=e.x+e.width+1,r=s-1):(s=e.x-2,r=s+1),this.map[r][n]=0),[s,n]}_drawCorridor(e,t){const s=t[0]-e[0],n=t[1]-e[1];let r,i,l,c,u=e[0],h=e[1];const d=[],f=Math.abs(s),g=Math.abs(n),p=a.default.getUniform(),m=p,y=1-p;for(i=s>0?2:6,l=n>0?4:0,f<g?(r=Math.ceil(g*m),d.push([l,r]),d.push([i,f]),r=Math.floor(g*y),d.push([l,r])):(r=Math.ceil(f*m),d.push([i,r]),d.push([l,g]),r=Math.floor(f*y),d.push([i,r])),this.map[u][h]=0;d.length>0;)for(c=d.pop();c[1]>0;)u+=o.DIRS[8][c[0]][0],h+=o.DIRS[8][c[0]][1],this.map[u][h]=0,c[1]=c[1]-1}_createCorridors(){const e=this._options.cellWidth,t=this._options.cellHeight;let s,n,r,a,o;for(let i=0;i<e;i++)for(let e=0;e<t;e++){s=this.rooms[i][e];for(let e=0;e<s.connections.length;e++)n=s.connections[e],r=this.rooms[n[0]][n[1]],r.cellx>s.cellx?(a=2,o=4):r.cellx<s.cellx?(a=4,o=2):r.celly>s.celly?(a=3,o=1):(a=1,o=3),this._drawCorridor(this._getWallPosition(s,a),this._getWallPosition(r,o))}}}t.default=i},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Fov3D=void 0;const r=n(s(0)),a=s(4);t.Fov3D=class{constructor(e,t){this._passCb=t,this._map=e,this._maxZ=3,this._distSquare=0,this._maxZ=this.calcMapMaxZ(e),this._seen={},this._alreadySeen={}}canSeeCell(e,t,s){let n=!1;const r=this._init(t),[a,o,i]=s;return this._internalViewTo(e,r,a,o,i,(e,t,s)=>{a===e&&o===t&&i===s&&(n=!0)}),n}_init(e){const t=e+1;return this._distSquare=t*t,this._seen={},this._alreadySeen={},t}compute(e,t,s,n,a){const o=[e,t,s],i=this._init(n);a(e,t,s,!0);const l=r.default.toKey([e,t,s]);this._seen[l]=!0;const c=e-i,u=t-i,h=e+i,d=t+i;for(let e=0;e<=this._maxZ;++e){for(let t=u;t<=d;t++)this._internalViewTo(o,i,c,t,e,a),this._internalViewTo(o,i,h,t,e,a);for(let t=c;t<=h;t++)this._internalViewTo(o,i,t,u,e,a),this._internalViewTo(o,i,t,d,e,a)}}_compute(e,t,s,n,a){const o=[e,t,s],i=n+1;this._distSquare=i*i,this._seen={},this._alreadySeen={},a(e,t,s,!0);const l=r.default.toKey([e,t,s]);this._seen[l]=!0;for(let e=0;e<=this._maxZ;++e)for(let t=-i;t<=i;t++)this._internalViewTo(o,i,t,i,e,a),this._internalViewTo(o,i,t,-i,e,a),this._internalViewTo(o,i,i,t,e,a),this._internalViewTo(o,i,-i,t,e,a)}_internalViewTo(e,t,s,n,o,i){let l=!1;const c=[s,n,o],u=r.default.toKey(c);if(this._alreadySeen[u])return;this._alreadySeen[u]=!0;const h=a.Geometry.lineFuncUnique3D(e,c),d=h.length;for(let t=0;t<d;t++){const[s,n,o]=h[t];if(l)return;if(this._map.hasXY(s,n)){const t=[s,n,o];if(a.Geometry.distance3DSquared(e,t)<this._distSquare){const a=r.default.toKey(t);this._seen[a]||(i(s,n,o,!l),this._seen[a]=!0);let c=!1;o>=this._map._map[s][n].getBaseElem().getZ()&&(c=this._map._map[s][n].lightPasses()),c||(l=!0,e[0]===s&&e[1]===n&&e[2]===o&&(l=!1))}}}}calcMapMaxZ(e){let t=0;return r.default.forEach2D(e._map,(e,s,n)=>{n&&n.getZ()>t&&(t=n.getZ())}),t}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Houses5x5=void 0;const r=n(s(0)),a=s(52),o=s(1);t.Houses5x5={tiles:{},templates:{},Models:{}};const i=o.Random.getRNG();t.Houses5x5.tiles.start1x1=["\nname:start1x1_A\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##","\nname:start1x1_B\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n.ABC.\nD#:##\nE:::#\nF:::#\n##+##","\nname:start1x1_C\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n.ABC.\nD#:#.\nE::##\nF:::#\n##+##","\nname:start1x1_D\nA=.\nB=.\nC=.\nD=#\nE=#\nF=#\n\n.ABC.\nD###.\nE::##\nF:::#\n##+##"],t.Houses5x5.tiles.start1xN=["\ndir:N\nstartY:max\nstartX:first\nname:start1xN_A\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##","\ndir:N\nstartY:max\nstartX:first\nname:start1xN_B\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD#:##\nE:::#\nF:::#\n##+##","\ndir:N\nstartY:max\nstartX:first\nname:start1xN_C\nA=:\nB=:\nC=:\nD=#\nE=#\nF=.\n\n#ABC#\nD:::#\nE#:##\nF#:#.\n.#+#.","\ndir:N\nstartY:max\nstartX:first\nname:start1xD_C\nA=#\nB=:\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##"],t.Houses5x5.tiles.start2xN=["\ndir:NE\nstartX:first\nstartY:max\nname:start2xN_A\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE::::\nF:::#\n##+##","\ndir:NW\nstartX:max\nstartY:max\nname:start2xN_B\nA=#\nB=:\nC=#\nD=#\nE=:\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##"],t.Houses5x5.tiles.start2xN=t.Houses5x5.tiles.start2xN.concat(t.Houses5x5.tiles.start1xN),t.Houses5x5.tiles.start=["\ndir:NEW\nname:entrance2\nA=:\nB=:\nC=:\nD=#\nE=:\nF=#\n\n#ABC#\nD:::#\nE::::\nF:::#\n##+##","\ndir:NW\nname:entrance3\nA=#\nB=:\nC=#\nD=#\nE=:\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##"],t.Houses5x5.tiles.corners=["\ndir:SE\nname:corner1\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD::::\nE::::\nF:::#\n#::##","\ndir:SEW\nname:corner2\nA=#\nB=#\nC=#\nD=:\nE=:\nF=#\n\n#ABC#\nD::::\nE::::\nF:::#\n##:##","\ndir:SE\nname:corner3\nA=.\nB=.\nC=.\nD=#\nE=#\nF=#\n\n.ABC#\nD####\nE::::\nF:::#\n##:##","\ndir:NSEW\nname:corner4\nA=:\nB=:\nC=:\nD=:\nE=:\nF=:\n\n#ABC#\nD::::\nE::::\nF::::\n#:::#"],t.Houses5x5.tiles.body=["\ndir:NS\nname:corridor\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n#:::#","\ndir:NSEW\nname:body1\nA=:\nB=:\nC=:\nD=:\nE=:\nF=:\n\n#ABC#\nD::::\nE:#::\nF::::\n#:::#","\ndir:NSEW\nname:body_cross\nA=:\nB=:\nC=:\nD=:\nE=:\nF=:\n\n#ABC#\nD:#::\nE###:\nF:#::\n#:::#"],t.Houses5x5.tiles.terms=["\ndir:S\nname:term3x1\nA=.\nB=.\nC=.\nD=.\nE=.\nF=#\n\n.ABC.\nD....\nE....\nF####\n#:::#","\ndir:S\nname:term3x2\nA=.\nB=.\nC=.\nD=.\nE=#\nF=#\n\n.ABC.\nD....\nE####\nF:::#\n#:::#","\ndir:S\nname:term3x3\nA=.\nB=.\nC=.\nD=#\nE=#\nF=#\n\n.ABC.\nD####\nE:::#\nF:::#\n#:::#","\ndir:S\nname:term3x4\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n#:::#"],t.Houses5x5.tiles.blocker="\nname:BLOCKER\nA=.\nB=.\nC=.\nD=.\nE=.\nF=.\n\n.ABC.\nD....\nE....\nF....\n.....",t.Houses5x5.tiles.filler="\nname:FILLER\nA=.\nB=.\nC=.\nD=.\nE=.\nF=.\n\n.ABC.\nD....\nE....\nF....\n.....",t.Houses5x5.startRoomFunc=function(){if(1===this.tilesX&&1===this.tilesY)return{x:0,y:0,room:i.arrayGetRand(t.Houses5x5.templates.start1x1)};if(1===this.tilesX){const e=t.Houses5x5.templates.start1xN.filter(e=>!/(R90|R270)/i.test(e.getProp("name"))),s=i.arrayGetRand(e);let n=this.tilesY-1;return/R180/i.test(s.getProp("name"))&&(n=0),{x:0,y:n,room:s}}if(1===this.tilesY){const e=t.Houses5x5.templates.start1xN.filter(e=>/(R90|R270)/i.test(e.getProp("name"))),s=i.arrayGetRand(e);let n=0;return/R270/i.test(s.getProp("name"))&&(n=this.tilesX-1),{x:n,y:0,room:s}}if(2===this.tilesX||2===this.tilesY){const e=t.Houses5x5.templates.start2xN,s=i.arrayGetRand(e);let n=0,r=0;return"max"===s.getProp("startX")&&(n=this.tilesX-1),"max"===s.getProp("startY")&&(r=this.tilesY-1),{x:n,y:r,room:s}}const e=Math.floor(this.tilesX/2),s=Math.floor(this.tilesY/2),n=i.arrayGetRand(t.Houses5x5.tiles.start),r=a.Template.createTemplate(t.Houses5x5.tiles.blocker);for(let t=s;t<this.tilesY;t++)this.addRoom(r,e,t);return{x:e,y:s,room:a.Template.createTemplate(n)}},t.Houses5x5.Models.default=[].concat(t.Houses5x5.tiles.terms).concat(t.Houses5x5.tiles.body).concat(t.Houses5x5.tiles.corners),t.Houses5x5.tiles.all=t.Houses5x5.Models.default;function l(e){const t=e.getProp("startX"),s=e.getProp("startY");r.default.isNullOrUndef([t])||e.setProp("startY",t),"max"===s?e.setProp("startX","first"):"first"===s&&e.setProp("startX","max")}["all","start1x1","start1xN","start2xN"].forEach(e=>{t.Houses5x5.templates[e]=t.Houses5x5.tiles[e].map(e=>a.Template.createTemplate(e));const s=a.Template.transformList(t.Houses5x5.templates[e]);t.Houses5x5.templates[e]=t.Houses5x5.templates[e].concat(s)}),t.Houses5x5.templates.start2xN.forEach(e=>{const t=e.getProp("name");/_flip/.test(t)&&function(e){const t=e.getProp("startX");"max"===t?e.setProp("startX","first"):"first"===t&&e.setProp("startX","max")}(e),/R90/i.test(t)?l(e):/R180/i.test(t)?(l(e),l(e)):/R270/i.test(t)&&(l(e),l(e),l(e))})},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Nests=void 0;const n=s(52),r=n.Template.transformList;t.Nests={},t.Nests.tiles={},t.Nests.tiles.corner=["\nname:corner1\ndir:E\nX=#\nY=#\nW=#\nZ=#\n\n#X#W#X#\nY.....#\n#.###..\nZ.+?##.\n#.###..\nY.....#\n#######","\nname:corner2\ndir:SE\nX=#\nY=#\nW=#\nZ=#\n\n#X#W#X#\nY.....#\n#.###..\nZ.+?##.\n#.###..\nY.....#\n###+###","\nname:corner3\ndir:E\nX=#\nY=#\nW=#\nZ=#\n\n#X#W#X#\nY#.#?##\n#..#+##\nZ......\n#..#+##\nY#.#?##\n#######","\nname:corner4\ndir:SE\nX=#\nY=#\nW=#\nZ=#\n\n#X#W#X#\nY#?#?##\n##+#+##\nZ......\n#...###\nY#..+?#\n###.###"],t.Nests.tiles.center=["\nname:center1\nnoedge:1\ndir:S\nX=#\nY=#\nW=#\nZ=#\n\n#X#W#X#\nY.....#\n#.....#\nZ.....#\n#.....#\nY.....#\n###.###","\nname:center2\nnoedge:1\ndir:NS\nX=#\nY=#\nW=.\nZ=#\n\n#X#W#X#\nY.....#\n#.....#\nZ.....#\n#.....#\nY.....#\n###.###","\nname:center3\nnoedge:1\ndir:NSW\nX=#\nY=#\nW=.\nZ=.\n\n#X#W#X#\nY.....#\n#.....#\nZ.....#\n#.....#\nY.....#\n###.###","\nname:center4\nnoedge:1\ndir:NSEW\nX=#\nY=#\nW=.\nZ=.\n\n#X#W#X#\nY.....#\n#.....#\nZ......\n#.....#\nY.....#\n###.###","\nname:center5_open\nnoedge:1\ndir:NSEW\nX=.\nY=.\nW=.\nZ=.\n\n.X.W.X.\nY......\n.......\nZ......\n.......\nY......\n.......","\nname:center5_open_chest\nnoedge:1\ndir:NSEW\nX=.\nY=.\nW=.\nZ=.\n\n.X.W.X.\nY......\n..#+#..\nZ.+?+..\n..#+#..\nY......\n.......","\nname:center6_open\nnoedge:1\ndir:SEW\nX=#\nY=.\nW=#\nZ=.\n\n#X#W#X#\nY......\n.......\nZ......\n.......\nY......\n.......","\nname:center7_open\nnoedge:1\ndir:EW\nX=#\nY=.\nW=#\nZ=.\n\n#X#W#X#\nY......\n.......\nZ......\n.......\nY......\n#######","\nname:center8_open\nnoedge:1\ndir:SW\nX=#\nY=.\nW=#\nZ=.\n\n#X#W#X#\nY.....#\n......#\nZ.....#\n......#\nY.....#\n......#","\nname:center9_open\nnoedge:1\ndir:W\nX=#\nY=.\nW=#\nZ=.\n\n#X#W#X#\nY.....#\n......#\nZ.....#\n......#\nY.....#\n#######"],t.Nests.tiles.corridor=["\nname:corridor1\ndir:EW\nX=#\nY=#\nW=#\nZ=.\n\n#X#W#X#\nY######\n#.....#\nZ......\n#.....#\nY######\n#######","\nname:corridor2\ndir:SEW\nX=#\nY=#\nW=#\nZ=.\n\n#X#W#X#\nY######\n#.....#\nZ......\n#.....#\nY##.###\n###.###","\nname:corridor3\ndir:SE\nX=#\nY=#\nW=#\nZ=#\n\n#X#W#X#\nY######\n#.....#\nZ......\n#.....#\nY##.###\n###.###","\nname:corridor_term\ndir:N\nX=#\nY=#\nW=.\nZ=#\n\n#X.W.X#\nY.....#\n#.....#\nZ######\n#######\nY######\n#######"],t.Nests.tiles.filler="\nname:FILLER\nX=#\nY=#\nW=#\nZ=#\n\n#X#W#X#\nY######\n#######\nZ######\n#######\nY######\n#######";t.Nests.matchFilter=function(e,t,s,n,r){return e.isCorner(t,s)?n.filter(e=>/corner/.test(e.getProp("name"))):e.isEdge(t,s)?n.filter(e=>/corridor/.test(e.getProp("name"))):n.filter(e=>/center\d+_open/.test(e.getProp("name")))},t.Nests.startRoomFuncNx3=function(){const e=this.findTemplate({name:"center5_open_chest"});return{x:Math.floor(this.tilesX/2),y:Math.floor(this.tilesY/2),room:e}};t.Nests.tiles.all=[].concat(t.Nests.tiles.corner).concat(t.Nests.tiles.corridor).concat(t.Nests.tiles.center),t.Nests.templates=t.Nests.tiles.all.map(e=>n.Template.createTemplate(e));const a=r(t.Nests.templates,{all:"*",flipVer:[],rotateR90:[],rotateR180:[],rotateR270:[]});t.Nests.templates=t.Nests.templates.concat(a);n.verifyTiles("tiles.nests.ts","Verifying tiles",t.Nests.templates,[1,1,1,1,1,1]);t.Nests.names={},["center","corridor","corner"].forEach(e=>{t.Nests.names[e]=t.Nests.templates.filter(t=>new RegExp(e).test(t.getProp("name"))).map(e=>e.getProp("name"))}),t.Nests.weights={},t.Nests.names.corridor.forEach(e=>{t.Nests.weights[e]=1e3,"corridor_term"===e&&(t.Nests.weights[e]=1)})},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||n(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),r(s(214),t),r(s(462),t),r(s(463),t),r(s(464),t),r(s(467),t)},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MapForest=void 0;const r=n(s(22)),a=n(s(14)),o=r.default;t.MapForest=class extends o{constructor(e,t,s={}){super(e,t),this._options={nForests:5,forestSize:100,factor:6,rng:a.default};for(const e in s)this._options.hasOwnProperty(e)&&(this._options[e]=s[e])}create(e){const t=this._options.rng;this.map=this._fillMap(0);for(let e=0;e<this._options.nForests;e++){const e=t.getUniformInt(0,this._width-1),s=t.getUniformInt(0,this._height-1);this.drawForest(e,s,this._options.forestSize)}if(e)for(let t=0;t<this._height;t++)for(let s=0;s<this._width;s++)e(s,t,this.map[s][t])}inBounds(e,t){return e>=0&&e<this._width&&t>=0&&t<this._height}drawForest(e,t,s){let n=e,r=t;const a=this._options.rng;for(let e=1;e<=s;e++){const e=a.getUniformInt(0,this._options.factor),t=a.getUniformInt(0,this._options.factor),s=a.getUniformInt(0,this._options.factor),o=a.getUniformInt(0,this._options.factor);1===e&&(n-=1,this.inBounds(n,r)&&(this.map[n][r]=1)),1===s&&(n+=1,this.inBounds(n,r)&&(this.map[n][r]=1)),1===t&&(r+=1,this.inBounds(n,r)&&(this.map[n][r]=1)),1===o&&(r-=1,this.inBounds(n,r)&&(this.map[n][r]=1))}}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MapMiner=void 0;const r=n(s(22)),a=n(s(14)),o=s(36),i=n(s(0)),l=s(4),c=s(10);s(67);const u=s(5)("bitn:Map.Miner"),h=r.default;t.MapMiner=class extends h{constructor(e,t,s={}){super(e,t);const n=e>t?t:e,r=Math.floor(e*t/n),o=Math.round(this._width/2),i=Math.round(this._height/2);if(this._options={addMiners:[],dontDig:!1,maxMinersCreated:r,minerSpawnProb:.07,smooth:!0,rng:a.default,startX:o,startY:i,nSmooth:2,dirWeights:{N:1,NE:1,E:1,SE:1,S:1,SW:1,W:1,NW:1}},!s.dirWeights){const s=e>t?t:e;Object.keys(this._options.dirWeights).forEach(n=>{this._options.dirWeights[n]*="W"===n||"E"===n?6*e:"S"===n||"N"===n?t:s})}for(const e in s)this._options.hasOwnProperty(e)&&(this._options[e]=s[e]);if(s.maxMinersOp){let e=this._options.maxMinersCreated;const{op:t,value:n}=s.maxMinersOp;switch(t){case"+":e+=n;break;case"-":e-=n;break;case"/":e/=n;break;case"*":e*=n;break;default:console.warn(`Op ${t} illegal`)}this._options.maxMinersCreated=Math.round(e)}this._hist={minerDir:{}},this._verifyRngFunctions()}create(e){const t=this._options.rng;this._map=this._fillMap(1);const s=this._options.maxMinersCreated,n=this._options.minerSpawnProb;let r=[{id:0,x:this._options.startX,y:this._options.startY,dirWeights:this._options.dirWeights}];this.minerID=1,Array.isArray(this._options.addMiners)&&this._options.addMiners.forEach(e=>{if(this.inBounds(e.x,e.y)){const t=Object.assign({},e);t.id=this.minerID++,t.dirWeights||(t.dirWeights=this._options.dirWeights),r.push(t)}else console.error(e,"out of level mining bounds. Not added")}),r.forEach(e=>{i.default.isNullOrUndef([e.x,e.y])?i.default.err("Map.Miner","create","miner.x,y must exist. "+e):this._markAsDug(e.x,e.y)});let a=0,o=0,l=0,c=[],h=[],d=0;for(;o<s&&(u.enabled&&this.printMap(),this.dbg("Active miners: "+r.length),r.forEach(e=>{const[s,i]=this._getXYToDig(e);if(0===this._map[s][i]&&r.length>1)c.push(e);else if(this.inBounds(s,i)){if(t.getUniform()<=n){const t=this._tryToAddNew(e,s,i);t&&(h.push(t),++a),++o}this._markAsDug(s,i,e),e.x=s,e.y=i}else c.push(e)}),c.forEach(e=>{const t=r.findIndex(t=>e.id===t.id);if(r.length>1){const{id:s,x:n,y:a}=e;this.dbg(`remove miner ${s} at ${n}, ${a}`),++l,r.splice(t,1)}}),r=r.concat(h),h=[],c=[],!(d>100*this._width*this._height))&&0!==r.length;)++d;if(this._options.smooth&&this.smoothWalls(2),this.connect(),e)for(let t=0;t<this._height;t++)for(let s=0;s<this._width;s++)e(s,t,this._map[s][t]);this._hist.minersSpawned=o,this._hist.minersAdded=a,this._hist.minersRemoved=l}_tryToAddNew(e,t,s){let[n,r]=this._getXYToDig({x:t,y:s,dirWeights:e.dirWeights}),a=null;const i=this._options.rng;if(1===this._map[t][s]&&this.inBounds(n,r))a={id:this.minerID++,x:n,y:r},e.dugCallback&&(a.dugCallback=e.dugCallback),this._markAsDug(n,r,a),this.dbg(e,"spawned new miner:",a);else{const t=i.getUniformInt(0,7),s=o.DIRS[8][t];n+=s[0],r+=s[1],this.inBounds(n,r)&&(a={id:this.minerID++,x:n,y:r},e.dugCallback&&(a.dugCallback=e.dugCallback),this._markAsDug(n,r,a),this.dbg(e,"(else) spawned new miner:",a))}return a&&(a.dirWeights=e.dirWeights),a}printMap(){for(let e=0;e<this._height;e++){let t="";for(let s=0;s<this._width;s++)t+=1===this._map[s][e]?"#":".";console.log(t)}}_getXYToDig(e){const t=this._options.rng,s=l.Geometry.getBoxAround(e.x,e.y,1).filter(e=>1===this._map[e[0]][e[1]]&&this.inBounds(e[0],e[1]));if(0===s.length)return this.dbg("No wall cells around "+e.x+", "+e.y),[e.x,e.y];this.dbg("UndugXY is now "+s);const n=s.map(t=>{const s=[t[0]-e.x,t[1]-e.y];return i.default.dXdYToDir(s)}),r=e.dirWeights,a={};if(n.forEach(e=>{r[e]&&(a[e]=r[e])}),0===Object.keys(a).length)return[e.x,e.y];u.enabled&&this.dbg("dirsLeft: "+JSON.stringify(a));let o=t.getWeightedValue(a),c=i.default.dirTodXdY(o);if(!c)return void i.default.err("Map.Miner","getXYToDig","Got null dir!");let[h,d]=[e.x+c[0],e.y+c[1]];for(this.dbg(`dir: ${o}, COMP: dXdY: ${c}, x,y: ${h},${d}`),this._hist.minerDir[o]||(this._hist.minerDir[o]=0),this._hist.minerDir[o]+=1;0===this._map[h][d]&&(delete a[o],0!==Object.keys(a).length);)o=t.getWeightedValue(a),c=i.default.dirTodXdY(o),[h,d]=[e.x+c[0],e.y+c[1]],this.dbg(`dir: ${o}, COMP: dXdY: ${c}, x,y: ${h},${d}`),this._hist.minerDir[o]||(this._hist.minerDir[o]=0),this._hist.minerDir[o]+=1;return this.dbg(`Next x,y to dig is ${h},${d}`),[h,d]}inBounds(e,t){if(this._options.dontDig)if(this._options.dontDig.ulx){const{ulx:s,uly:n,lrx:r,lry:a}=this._options.dontDig;if(e>=s&&e<=r&&t>=n&&t<=a)return!1}else if(this._options.dontDig[e+","+t])return!1;return e>=1&&e<this._width-1&&t>=1&&t<this._height-1}connect(){const{addMiners:e}=this._options;let t=!0;const s={},n={};if(e.length>0){const r=e.map(e=>[e.x,e.y]);r.push([this._options.startX,this._options.startY]);let a=-1;r.forEach(e=>{const r={},o=l.Geometry.floodfill2D(this._map,e,0,r,!0);if(0===o.length){throw new Error(`Floodfill from: ${e} returned 0 cells`)}const i=e[0]+","+e[1];s[i]=o,n[i]=r,-1===a?a=o.length:a!==o.length&&(t=!1)})}t?this._regions=[]:this.connectFilledRegions(s,n)}connectFilledRegions(e,t){const s={};let n=0,r=null;const a=this._options.rng;Object.keys(e).forEach(t=>{const a=e[t];s[t]=l.Geometry.getMassCenter(a),a.length>n&&(n=a.length,r=t)});const o=[];this._regions=[],this._regions.push([e[r]]),Object.keys(s).forEach(s=>{if(s!==r){t[s][r]||(o.push(s),this._regions.push([e[s]]))}});const[i,c]=s[r];this._paths=[],o.forEach(e=>{const[t,n]=s[e],r=this._getPath(i,c,t,n);r.forEach(e=>{let t=a.getUniformInt(1,3);this._options.connWidth&&(t=this._options.connWidth);l.Geometry.getCrossCaveConn(e.x,e.y,t,!0).forEach(e=>{const[t,s]=e;this.inBounds(t,s)&&(this._map[t][s]=0)})}),this._paths.push(r)})}getMapData(){const e=this._options.addMiners,t=e.map(e=>[e.x,e.y]);return t.push([this._options.startX,this._options.startY]),{nRegions:1+e.length,regions:this._regions,startPoints:t,paths:this._paths}}smoothWalls(e){for(let t=0;t<e;t++)for(let e=1;e<this._width-1;e++)for(let t=1;t<this._height-1;t++)if(1===this._map[e][t]){const s=l.Geometry.getCrossAround(e,t,1);let n=0;s.forEach(e=>{this.inBounds(e[0],e[1])&&this._map[e[0]][e[1]]&&++n}),this.inBounds(e,t)&&n<this._options.nSmooth&&this._markAsDug(e,t)}}_getPath(e,t,s,n){return c.Path.getShortestPath(e,t,s,n)}_markAsDug(e,t,s){e<this._minX&&(this._minX=e),e>this._maxX&&(this._maxX=e),t<this._minY&&(this._minY=t),t>this._maxY&&(this._maxY=t),this._map[e][t]=0,this._options.dugCallback&&this._options.dugCallback(e,t,s),s&&s.dugCallback&&s.dugCallback(e,t,s)}_verifyRngFunctions(){const{rng:e}=this._options,t=["getUniform","getUniformInt","getWeightedValue"];t.forEach(s=>{if("function"!=typeof e[s]){let e=`RNG must have functions: ${t}.`;throw e+="See ROT.RNG for example (you can use it)",new Error(e)}})}dbg(e,...t){u.enabled&&console.log(e,...t)}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MapMountain=void 0;const r=n(s(215)),a=n(s(22)),o=n(s(14)),i=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],l=a.default;class c extends l{constructor(e,t,s={}){if(super(e,t),this._options={gradients:i,noiseMult:1,noiseDivider:20,rng:o.default},s)for(const e in this._options)this._options.hasOwnProperty(e)&&s.hasOwnProperty(e)&&(this._options[e]=s[e]);this.noise=new r.default}create(e){const t=this._fillMap(0);for(let e=0;e<this._width;e++)for(let s=0;s<this._height;s++){const n=this.noise.get(e/this._options.noiseDivider,s/this._options.noiseDivider)*this._options.noiseMult;t[e][s]=n}for(let s=0;s<this._width;s++)for(let n=0;n<this._height;n++)e(s,n,t[s][n])}}t.MapMountain=c,c.gradients=i},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{}},function(e,t,s){"use strict";function n(e){return e.charAt(0).toUpperCase()+e.substring(1)}function r(e,...t){const s=r.map;return e.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,(function(r,a,o,i){if("%"==e.charAt(i-1))return r.substring(1);if(!t.length)return r;let l=t[0];const c=(a||o).split(","),u=c.shift()||"",h=s[u.toLowerCase()];if(!h)return r;l=t.shift();let d=l[h].apply(l,c);const f=u.charAt(0);return f!=f.toLowerCase()&&(d=n(d)),d}))}Object.defineProperty(t,"__esModule",{value:!0}),t.format=t.capitalize=t.clamp=t.mod=void 0,t.mod=function(e,t){return(e%t+t)%t},t.clamp=function(e,t=0,s=1){return e<t?t:e>s?s:e},t.capitalize=n,t.format=r,r.map={s:"toString"}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MapWall=void 0;const r=n(s(22));s(67);const a=n(s(14)),o=r.default;function i(e,t,s){const n=2*s+1;let r=0;for(let n=t-s;n<=t+s;n++)n>=0&&n<e.length&&(r+=e[n]);return Math.floor(r/n)}t.MapWall=class extends o{constructor(e,t,s){if(super(e,t),this._options={north:!1,south:!1,east:!0,west:!0,alignVertical:"center",alignHorizontal:"center",meanWx:5,meanWy:5,stdDev:3,filterW:3,rng:a.default},s)for(const e in this._options)this._options.hasOwnProperty(e)&&s.hasOwnProperty(e)&&(this._options[e]=s[e])}create(e){const t=this._fillMap(0),s=this._options.north,n=this._options.south,r=this._options.east,a=this._options.west,{alignVertical:o,alignHorizontal:i}=this._options,l=this._width,c=this._height,u=Math.floor(l/2),h=Math.floor(c/2),d=this._options.meanWx,f=this._options.meanWy,g=this._options.stdDev,p=this._options.filterW;let m=null,y=-1,_=-1;s&&n?(y=0,_=c-1):s?(y=0,_=h-1):n&&(y=h,_=c-1),this._wallNS=[];let b=this.getWidthMovingAvg(_+1,d,g,l,p);if(s||n)for(let e=y;e<=_;e++){m=b[e-y];const s=[];1===m&&(m=d);let n=u-(m-1),r=u+(m-1);"center"===i||("left"===i?(n=0,r=n+(m-1)):"right"===i&&(n=this._width-(m-1),r=this._width-1));for(let a=n;a<=r;a++)t[a][e]=1,s.push([a,e]);this._wallNS.push(s)}let v=-1,E=-1;if(r&&a?(v=0,E=l-1):r?(v=u,E=l-1):a&&(v=0,E=u-1),this._wallEW=[],b=this.getWidthMovingAvg(E+1,f,g,c,p),r||a)for(let e=v;e<=E;e++){m=b[e-v];const s=[];1===m&&(m=f);let n=h-(m-1),r=h+(m-1);"center"===o||("top"===o?(n=0,r=n+(m-1)):"bottom"===o&&(n=this._height-(m-1),r=this._height-1));for(let a=n;a<=r;a++)t[e][a]=1,s.push([e,a]);this._wallEW.push(s)}for(let s=0;s<this._width;s++)for(let n=0;n<this._height;n++)e(s,n,t[s][n])}getWidthMovingAvg(e,t,s,n,r){const a=[];for(let r=0;r<e;r++)a.push(this.getWallWidth(t,s,n));let o=[];for(let e=0;e<r;e++)o.push(a[e]);for(let t=r;t<e-r;t++){const e=i(a,t,r);o.push(e)}for(let t=e-r;t<e;t++)o.length<a.length&&o.push(a[t]);return o=o.map(e=>Math.round(e)),o}getWallWidth(e,t,s){const n=this._options.rng;let r=Math.floor(n.getNormal(e,t));return r>s/2?r=s/2-1:r<1&&(r=1),r}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ActorNames=void 0;const r=n(s(0)),a=s(1).Random.getRNG(),o={1:5,2:30,3:30,4:20,5:5},i=r.default.LETTERS,l=/[aeiouy]/,c=i.filter(e=>l.test(e)),u=i.filter(e=>!l.test(e)),h=[],d=[],f=[],g=[],p={vowel:[],consonant:[]},m={vowel:[],consonant:[]};i.forEach(e=>{if(l.test(e)){const t=e;c.forEach(e=>{h.push(t+e),p.vowel.push(t+e),m.vowel.push(t+e),u.forEach(s=>{d.push(t+e+s),p.vowel.push(t+e+s),m.consonant.push(t+e+s)})}),u.forEach(e=>{h.push(t+e),p.vowel.push(t+e),m.consonant.push(t+e),c.forEach(s=>{d.push(t+e+s),p.vowel.push(t+e+s),m.vowel.push(t+e+s)})})}else{const t=e;c.forEach(e=>{h.push(t+e),m.vowel.push(t+e),p.consonant.push(t+e),i.forEach(s=>{d.push(t+e+s),p.consonant.push(t+e+s)}),u.forEach(s=>{c.forEach(n=>{f.push(t+e+s+n),p.consonant.push(t+e+s+n),m.vowel.push(t+e+s+n),u.forEach(r=>{const a=t+e+s+n+r;g.push(a),p.consonant.push(a),m.consonant.push(a)})}),u.forEach(n=>{const r=t+e+s+n;f.push(r),p.consonant.push(r),m.consonant.push(r),c.forEach(e=>{const t=r+e;g.push(t),p.consonant.push(t),m.vowel.push(t)})})})})}}),t.ActorNames={};const y=/[aeiouy][aeiouy][aeiouy]/,_=/[xqjv]$/;t.ActorNames.getName=function(e=o){const t=parseInt(a.getWeighted(o),10);let s=!1,n="";for(;!s;){if(n="",1===t)n=a.arrayGetRand(g);else for(let e=0;e<t;e++){let e="";e=r.default.isSuccess(.4)?a.arrayGetRand(h):r.default.isSuccess(.4)?a.arrayGetRand(d):a.arrayGetRand(f),n+=e}y.test(n)||_.test(n)||(s=!0)}return n.capitalize()};const b=u.concat(["th","gr","dr","wh"]),v=["th","r","l","n","ch","zh"];function E(e){return!y.test(e)&&!_.test(e)}t.ActorNames.getModName=function(){let e="";r.default.isSuccess(.5)&&(e=a.arrayGetRand(b),e+=a.arrayGetRand(p.vowel)),r.default.isSuccess(.25)&&(e=a.arrayGetRand(c)+e,r.default.isSuccess(.25)&&(e=a.arrayGetRand(c)+e));let s="";r.default.isSuccess(.5)&&(s=a.arrayGetRand(v),r.default.isSuccess(.5)&&(s+=a.arrayGetRand(m.vowel)));let n=e+s;n=n.length<2?t.ActorNames.getName({2:50,3:35}).toLowerCase():n.length<4?t.ActorNames.getName({2:50}).toLowerCase():r.default.isSuccess(.5)?a.arrayGetRand(f):a.arrayGetRand(g);const o=e+n+s;return E(o)?o.capitalize():t.ActorNames.getModName()},t.ActorNames.isNameOk=E},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createCaveLevel=t.CaveBrGenerator=void 0;const n=s(35),r=s(11),a=s(1),o=s(4),i=s(8),l=s(5)("bitn:cave-br"),c=a.Random.getRNG(),[u,h]=[3,16],[d,f]=[4,8],[g,p]=[40,80],[m,y]=[40,80],[_,b]=[2,4],v=[];class E{create(e,t,s){return S(e,t,s)}}function S(e,t,s){const a=new n.CellMap(e,t,i.ELEM.WALL);s.mapWidth=e,s.mapHeight=t,s.connectedRatio=s.connectedRatio||1,function(e,t){++w;let{mapWidth:s,mapHeight:n}=t;s-=1,n-=1;let r=Math.floor((s+n)/2/10);t.numBranches&&(r=t.numBranches);P("Creating",r,"branches for level",`${s+1}x${n+1}`);const a=c.getUniformInt(m,y),l=c.getUniformInt(g,p),u=c.getUniformInt(_,b),h=s-1,d=n-1,f=Math.floor(r*t.connectedRatio);let E=[];for(let t=0;t<f;++t){if(P("Creating connected branch",t),++w,0===c.getUniformInt(0,1)){P("Creating vertical connected branch",t);const s=O(e,2,h,2,d,u,a,l,E);E=E.concat(s)}else{P("\tCreating horizontal connected branch",t);const s=A(e,2,h,2,d,u,a,l,E);E=E.concat(s)}--w}const S=[],C=r-f;for(let t=0;t<C;++t)if(0===c.getUniformInt(0,1)){const t=O(e,2,h,2,d,u,a,l,v);S.push(t)}else{const t=A(e,2,h,2,d,u,a,l,v);S.push(t)}0===E.length&&(E=c.arrayGetRand(S));t.connectAll&&S.forEach(s=>{const[n,r]=c.arrayGetRand(s),[a,l]=c.arrayGetRand(E),u=o.Geometry.getCaveConnLine(n,r,a,l);!function(e,t,s){t.forEach(t=>{const[n,r]=t;e.hasXY(n,r)&&e.setBaseElemXY(n,r,s)})}(e,u,i.ELEM.FLOOR),t.appendConnected&&(E=E.concat(s))});(function(e,t,s){for(let n=0;n<=t;++n)e.setBaseElemXY(n,0,i.ELEM.WALL),e.setBaseElemXY(n,s,i.ELEM.WALL);for(let n=0;n<=s;++n)e.setBaseElemXY(0,n,i.ELEM.WALL),e.setBaseElemXY(t,n,i.ELEM.WALL)})(e,s,n),--w}(a,s);return new r.Level(a)}t.CaveBrGenerator=E,E.getOptions=()=>({appendConnected:!1,connectAll:!0,connectedRatio:.5,numBranches:30,mapWidth:150,mapHeight:150}),t.createCaveLevel=S;let w=0;function C(e,t,s,n,r,a){++w;let o=c.getUniformInt(d,f),[i,l,u]=[0,0,0];if("h"===a){if(e.length>0){const[h,d]=c.arrayGetRand(e);P("Branch will start from",h,d,"type",a),l=d,i=L(h,n),u=n-i-3,P("xs, ys, blen",i,l,u),[o,i,l]=T(t,n,s,r,i,l,o,a),P("ADJ xs, ys, blen",i,l,u)}else i=I(t,n,.9),l=I(s,r,.9),u=n-i-3,P("no caveCoord xs, ys, blen",i,l,u);return u=Math.floor(u/4),[i,l,u,o]}if("v"===a){if(e.length>0){const[h,d]=c.arrayGetRand(e);P("Branch will start from",h,d,"type",a),i=h,l=L(d,r),u=Math.floor(r-l-3),P("xs, ys, blen",i,l,u),[o,i,l]=T(t,n,s,r,i,l,o,a),P("ADJ xs, ys, blen",i,l,u)}else i=I(t,n,.9),l=I(s,r,.9),u=r-l-3,P("no caveCoord xs, ys, blen",i,l,u);return u=Math.floor(u/4),[i,l,u,o]}--w}function T(e,t,s,n,r,a,o,i){return++w,o<u?o=u:o>h&&(o=h),"v"===i&&(r<=e&&(r=e+1),r+o>=t&&(o=t-(r=t-o-1))),"h"===i&&(a<s&&(a=s+1),a+o>=n&&(o=n-(a=n-o-1))),--w,[o,r,a]}function O(e,t,s,n,r,a,o,i,l){++w;const u=[],[h,d,f,g]=C(l,t,n,s,r,"v"),p=h+g;M(e,h,p,d);for(let e=h;e<=p;e++)u.push([e,d]);let m=h,y=d,_=g;P("createVerCaveBranch magn:",a,"brLen",f);const b=D(-a,a).filter(e=>0!==e),v=D(-a,a).filter(e=>0!==e);for(let a=0;a<f;++a){if(y+=1,c.getUniformInt(1,100)<=i){_+=c.arrayGetRand(b)}if(c.getUniformInt(1,100)<=o){m+=c.arrayGetRand(v)}[_,m,y]=T(t,s,n,r,m,y,_,"v");const a=m+_;M(e,m,a,y);for(let e=m;e<=a;e++)u.push([e,y])}if(_>3)for(P("Ver br starting to round, width:",_);n<y&&y<r-1;){y+=1,m+=1,_=x(_,a);const t=m+_;M(e,m,t,y);for(let e=m;e<=t;++e)u.push([e,y]);if(_<3)break}return--w,u}function A(e,t,s,n,r,a,o,i,l){++w;const u=[],[h,d,f,g]=C(l,t,n,s,r,"h"),p=d+g;N(e,d,p,h);for(let e=d;e<=p;++e)u.push([h,e]);let m=h,y=d,_=g;const b=D(-a,a).filter(e=>0!==e),v=D(-a,a).filter(e=>0!==e);P("Hor branch Magnitude is ",a,"brLen",f);for(let a=0;a<f;++a){if(m+=1,c.getUniformInt(1,100)<=i){_+=c.arrayGetRand(b)}if(c.getUniformInt(1,100)<=o){y+=c.arrayGetRand(v)}[_,m,y]=T(t,s,n,r,m,y,_,"h");const a=y+_;N(e,y,a,m);for(let e=y;e<=a;++e)u.push([m,e])}if(_>3)for(P("Hor br starting to round, width:",_);t<m&&m<s-1;){y+=1,m+=1,_=x(_,a);const t=y+_;N(e,y,t,m);for(let e=y;e<=t;++e)u.push([m,e]);if(_<3)break}return--w,u}function M(e,t,s,n){++w;const r=Math.min(t,s),a=Math.max(t,s);P("createHoriSlice x:",r,"->",a,"y:",n);for(let t=r;t<=a;++t)e.hasXY(t,n)&&e.setBaseElemXY(t,n,i.ELEM.FLOOR);--w}function N(e,t,s,n){++w;const r=Math.min(t,s),a=Math.max(t,s);P("createVertSlice x:",n,"y:",r,"->",a);for(let t=r;t<=a;++t)e.hasXY(n,t)&&e.setBaseElemXY(n,t,i.ELEM.FLOOR);--w}function P(...e){if(l.enabled){const t=" ".repeat(w);console.log(t+"[DBG]",...e)}}function D(e,t,s){s||(s=1);const n=[];if(t<e||s<1)return[];if(void 0===t)for(let t=0;t<e;t+=s)n.push(t);else for(let r=e;r<t;r+=s)n.push(r);return n}function I(e,t,s){return e+c.getUniformInt(e,Math.floor(t*s))}function L(e,t){const s=Math.floor(.5*t);return e>Math.floor(.5*t)?e-2*(e-s):e}function x(e,t){return e-t<=1?1:e-t}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Miners=t.CaveGenerator=void 0;const i=o(s(0)),l=s(34),c=s(135),u=s(11),h=s(53),d=s(33),f=s(10),g=s(4),p=s(1),m=s(8),y=a(s(7)),_=p.Random.getRNG(),b=["orc","naga","ratling","gnome","teradin","elf"],v=y.ElementMarker;class E extends d.LevelGenerator{static getOptions(){const e=d.LevelGenerator.getOptions();return Object.assign(e,{dungeonType:"Lair",isCollapsed:!1})}constructor(){super(),this.shouldRemoveMarkers=!0}create(e,t,s){i.default.isNullOrUndef([e,t])&&i.default.err("CaveGenerator","create",`cols or rows not defined: cols: ${e} / rows: ${t}`);const n=this._createLevel(e,t,s);return this.addStairsLocations(n),this._addSpecialFeatures(n),this._addEncounters(n,s),this.embedNest(n,s),this.removeMarkers(n,s),n}_createLevel(e,t,s){const n=this._createMapOptions(e,t,s),r=new l.MapGenerator;r.setGen("cave",e,t);const a=r.createCave(e,t,n),o=new u.Level(a.map);return this.setLevelExtras(o,a.mapGen),n.isCollapsed&&(o.getExtras().isCollapsed=!0),o}setLevelExtras(e,t){const s=t.getMapData();s.startPoints=i.default.uniquifyCoord(s.startPoints),e.setExtras(s)}_createMapOptions(e,s,n){let{dungeonType:r}=n,a={};const o=S(e,s);switch(r=r.capitalize(),r){case"Cave":a=t.Miners.getRandOpts(e,s,1,3);break;case"Grotto":a=t.Miners.getRandOpts(e,s,2,4);break;case"Lair":{const n=t.Miners.getMinersAndExclude(e,s,["C"]),r=[_.arrayGetRand(n),o.C];a=t.Miners.getOptsWithMiners(r);break}case"Cavern":a=t.Miners.getRandOpts(e,s,3,9);break;default:a=t.Miners.getRandOpts(e,s)}let i=_.getUniform()<=.1;return!1===n.isCollapsed&&(i=!1),(i||n.isCollapsed)&&(a.floorElem=m.ELEM.CHASM,a.isCollapsed=!0),a}addStairsLocations(e){const t=e.getExtras(),{startPoints:s}=t;let n=null,r=null;s.length>1?[n,r]=_.getUniqueItems(s,2):(n=s[0],r=this.getEndPointFromMap(e,n)),this.addStartAndEndPointMarker(e,n,r),t.startPoint=n,r&&(t.endPoint=r);const a=s.slice();t.points=[],a.splice(a.indexOf(n),1),a.splice(a.indexOf(r),1),a.forEach(s=>{const[n,r]=s,a=new v(">");a.setTag("end_point"),e.addElement(a,n,r),t.points.push(s)})}_addSpecialFeatures(e){e.getExtras().isCollapsed&&this._createCollapsedLevel(e)}getEndPointFromMap(e,t){const s=e.getMap(),n=this.getMapOfNonWallCells(e);return this.getRandomEndPoint(s,t,n)}getMapOfNonWallCells(e){const t=e.getMap().getCells(e=>!e.getBaseElem().isWall()),s={};return t.forEach(e=>{s[e.getKeyXY()]=e}),s}_createCollapsedLevel(e){const t=e.getExtras(),s=e.getMap();let{endPoint:n}=t;const{startPoint:r}=t,a=this.getMapOfNonWallCells(e);if(n||(n=this.getRandomEndPoint(s,r,a)),r&&n){this.createPath(s,r,n).forEach(e=>{delete a[e[0]+","+e[1]]})}const o=[r,n];t.points&&t.points.forEach(e=>{const t=_.arrayGetRand(o);this.createPath(s,e,t).forEach(e=>{delete a[e[0]+","+e[1]]}),o.push(e)});const i=_.getUniformInt(1,10);for(let e=0;e<i;e++){const e=this.getRandomPoint(s,r,a);if(e){const t=_.arrayGetRand(o);this.createPath(s,e,t).forEach(e=>{delete a[e[0]+","+e[1]]}),o.push(e)}}}createPath(e,t,s){const[n,r]=t,[a,o]=s,i=f.Path.getShortestPath(n,r,a,o,(t,s)=>e.hasXY(t,s)&&!e.getBaseElemXY(t,s).getType().match(/wall/)),l=[];return i.forEach(t=>{const{x:s,y:n}=t;g.Geometry.getCrossAround(s,n,1,!0).forEach(t=>{const[s,n]=t;"chasm"===e.getCell(s,n).getBaseElem().getType()&&(e.setBaseElemXY(s,n,m.ELEM.FLOOR_CAVE),l.push([s,n]))})}),l}getRandomEndPoint(e,t,s){const n=(t,s)=>e.hasXY(t,s)&&!e.getBaseElemXY(t,s).getType().match(/wall/),[r,a]=t;let o=null;const i=e.cols>e.rows?e.rows:e.cols;let l=0,c=10;const u=Object.values(s);let h=null;for(;l<i;){const e=_.arrayGetRand(u),[t,s]=e.getXY();if(o=[t,s],h=f.Path.getShortestPath(t,s,r,a,n),l=h.length,0===c)break;--c}return o&&h&&h.forEach(e=>{const t=e.x+","+e.y;delete s[t]}),o}getRandomPoint(e,t,s){const[n,r]=t,a=Object.values(s),o=_.arrayGetRand(a),[i,l]=o.getXY(),c=[i,l],u=f.Path.getShortestPath(i,l,n,r,(t,s)=>e.hasXY(t,s)&&!e.getBaseElemXY(t,s).getType().match(/wall/));return c&&u&&u.forEach(e=>{const t=e.x+","+e.y;delete s[t]}),c}_addEncounters(e,t){const{dungeonType:s}=t;"Lair"===s&&this._addLairBoss(e,t),this.populatePoints(e,t)}_addLairBoss(e,t){const{maxDanger:s,maxValue:n}=t,r=e.getExtras().endPoint;if(r){const t=new h.DungeonPopulate({});e.getExtras().isCollapsed&&t.setActorFunc(e=>e.flying),t.addPointGuardian(e,r,s+4),t.addMainLoot(e,r,n)}else{const t=JSON.stringify(e.getExtras());i.default.err("CaveGenerator","_addLairBoss","No endPoint in extras: "+t)}}populatePoints(e,t){const s=e.getExtras(),{points:n}=s,r=new h.DungeonPopulate({});n.forEach(s=>{r.populatePoint(e,s,t)})}embedNest(e,t){let s=0;for(;s<10;){const n=_.getUniformInt(2,5),r=_.getUniformInt(2,5),a=new c.NestGenerator,o={actorConstr:{race:_.arrayGetRand(b),maxDanger:t.maxDanger},mapConf:{tilesX:n,tilesY:r,genParams:{x:[1,1,1],y:[1,1,1]},wallType:"wallcave",floorType:"floorcave"},embedOpts:{level:e}};if(a.createAndEmbed(7*n,7*r,o))return!0;++s}return!1}}function S(e,t,s=1){const n=Math.round(e/2),r=Math.round(t/2),a=e-1-s,o=t-1-s;return{N:{x:n,y:1,dirWeights:{E:1,W:1,S:5,SE:5,SW:5},dugCallback:(e,t,s)=>{t===o&&(s.dirWeights={})}},S:{x:n,y:o,dirWeights:{E:1,W:1,N:5,NE:5,NW:5},dugCallback:(e,t,s)=>{1===t&&(s.dirWeights={})}},E:{x:a,y:r,dirWeights:{N:1,S:1,NW:5,W:5,SW:5}},W:{x:1,y:r,dirWeights:{N:1,S:1,NE:5,E:5,SE:5}},NE:{x:a,y:1,dirWeights:{NW:1,W:10,SW:5,S:10}},NW:{x:1,y:1,dirWeights:{NE:1,E:10,SE:5,S:10}},SE:{x:a,y:o,dirWeights:{SW:1,W:10,NW:5,N:10}},SW:{x:1,y:o,dirWeights:{SE:1,E:10,NE:5,N:10}},C:{x:n,y:r,dirWeights:{N:1,S:1,E:2,W:2,NE:1,SE:1,NW:1,SW:1}}}}function w(e){const t=e[0],s={startX:t.x,startY:t.y,dirWeights:t.dirWeights},n=[];for(let t=1;t<e.length;t++)n.push(e[t]);return s.addMiners=n,s}t.CaveGenerator=E,t.Miners={},t.Miners.getMiners=S,t.Miners.getMinersAndExclude=function(e,t,s){const n=S(e,t);return s.forEach(e=>{delete n[e]}),Object.values(n)},t.Miners.getOptsWithMiners=w,t.Miners.getRandOpts=function(e,t,s=1,n=9){const r=S(e,t),a=Object.values(r),o=_.getUniformInt(s,n),i=[];for(let e=0;e<o;e++){const e=_.arrayGetRand(a);i.push(e)}return w(i)},t.Miners.getMinersCorners=function(e,t,s){return s||(s=S(e,t)),{cols:e,rows:t,dirWeights:s.NW.dirWeights,addMiners:[s.SW,s.NE,s.SE],startX:s.NW.x,startY:s.NW.y}},t.Miners.getMinersNSEW=function(e,t,s){return s||(s=S(e,t)),{cols:100,rows:100,maxMinersCreated:100,startX:s.N.x,startY:s.N.y,dirWeights:s.N.dirWeights,addMiners:[s.S,s.E,s.W]}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CityGenerator=void 0;const n=s(33),r=s(34),a=s(53),o=s(134),i=s(1),l=s(11),c=s(8),u=s(7),h=i.Random.getRNG();class d extends n.LevelGenerator{constructor(){super(),this.addDoors=!0,this.shouldRemoveMarkers=!0}static getOptions(){const e=n.LevelGenerator.getOptions();return e.hasWall=!1,e.nShops=1,e.shopFunc=[()=>!0],e.shopType=["potion"],e}create(e,t,s){let n=this.createLevel(e,t,s);return s.cellsAround&&(n=this.createCitySurroundings(n,s)),this.populateCityLevel(n,s),this.removeMarkers(n,s),n}createLevel(e,t,s){const n=new r.MapGenerator;let a=null;a=s.hasWall?n.createTownWithWall(e,t,s):n.createTownBSP(e,t,s);const o=new l.Level(a.map);return o.addExtras("houses",a.houses),this.createHouseElements(o),this.fillUnusedAreas(o,a.unused),o}createHouseElements(e){const t=e.getExtras().houses;for(let s=0;s<t.length;s++){const n=t[s].door,r=new u.ElementDoor(!0);e.addElement(r,n[0],n[1])}}fillUnusedAreas(e,t){const s=e.getMap(),n=[c.ELEM.GRASS,c.ELEM.TREE,c.ELEM.WATER];t.forEach(e=>{const t=h.arrayGetRand(n);let{w:r,h:a}=e;const{x:o,y:i}=e;r-=2,a-=2;for(let e=o;e<=o+r;e++)for(let n=i;n<=i+a;n++)s.setBaseElemXY(e,n,t)})}populateCityLevel(e,t){let s=e.getExtras().houses;const n=new a.DungeonPopulate(t),r=n.createShops(e,t);s=s.filter(e=>r.indexOf(e)<0);const o=n.createTrainers(e,t);s=s.filter(e=>o.indexOf(e)<0),e.addExtras("houses",s),this.createTownsfolk(e,t)}createTownsfolk(e,t){const s=new a.DungeonPopulate(t);e.getExtras().houses.forEach(n=>{s.populateHouse(e,n,t)})}createCitySurroundings(e,t){const s=new o.LevelSurroundings,n=s.surround(e,t);return n.setExtras(e.getExtras()),s.scaleExtras(n),n}}t.CityGenerator=d,d.options={village:{actorsPerLevel:30,maxDanger:3,itemsPerLevels:6},capital:{},stronghold:{},fort:{}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CryptGenerator=void 0;const n=s(33),r=s(34),a=s(11);class o extends n.LevelGenerator{static getOptions(){let e=n.LevelGenerator.getOptions();return e=Object.assign(e,{tilesX:12,tilesY:7,genParams:[2,2,2,2],roomCount:40}),e}constructor(){super(),this.shouldRemoveMarkers=!0}create(e,t,s){return this.createLevel(e,t,s)}createLevel(e,t,s){const n=new r.MapGenerator;n.setGen("crypt",e,t);const o=n.createCryptNew(e,t,s);return new a.Level(o.map)}}t.CryptGenerator=o},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DungeonGenerator=void 0;const r=n(s(0)),a=n(s(208)),o=n(s(190)),i=s(59),l=n(s(5)),c=s(33),u=s(35),h=s(11),d=s(4),f=s(34),g=s(10),p=s(53),m=s(1),y=s(8),_=s(6),b=s(7),v=s(135),E=s(18),S=l.default("bitn:dungeon"),w=(a.default,o.default),C=i.Room,T=m.Random.getRNG(),O=g.Path.getShortestPath,A={x:[1,1,1],y:[1,1,1]},M=e=>!e.hasObstacle()||e.hasDoor(),N={chasm:{elem:y.ELEM.CHASM},water:{elem:y.ELEM.WATER},snow:{elem:y.ELEM.SNOW},forest:{elem:y.ELEM.TREE},fire:{elem:y.ELEM.LAVA}},P=.07,D=.5,I={cross:{special:["splashes"]},"small vault":{},"large vault":{},"large corridor":{special:["splashes"]},center:{},nest:{}};class L{constructor(e,t){this.type=e,this.room=t}}class x extends c.LevelGenerator{constructor(){super(),this.addDoors=!0,this.shouldRemoveMarkers=!0,this._debug=this._debug||S.enabled}static getOptions(e="digger"){const t=c.LevelGenerator.getOptions(),s={levelType:e,nBigRooms:1,dungeonType:"",wallType:"walldungeon",floorType:"floordungeon",bigRooms:{bigRoomX:["cen"],bigRoomY:["cen"],bigRoomWidth:[10],bigRoomHeight:[10]},minNumRooms:3,rerunOnFailure:!0,errorOnFailure:!1},n={options:k[e]};return Object.assign(s,n,t)}create(e,t,s){const n=this._createLevel(e,t,s);this.addSpecialFeatures(n),this.addStairsLocations(n),this.addCriticalPath(n),(s.rerunOnFailure||s.errorOnFailure)&&(this.verifyLevel(n,s)||(console.log("verifyLevel failed. Re-running"),this.create(e,t,s)));return new p.DungeonPopulate({theme:""}).populateLevel(n),this.removeMarkers(n,s),n}_createLevel(e,t,s){e||(e=T.getUniformInt(80,120)),t||(t=T.getUniformInt(28,56));const n=s.minNumRooms||3;let r=null,a=null;const o=(e,t,n)=>{1===n?a.setBaseElemXY(e,t,y.getElem(s.wallType)||y.ELEM.WALL):a.setBaseElemXY(e,t,y.getElem(s.floorType)||y.ELEM.FLOOR_CAVE)};let i=10;for(;(!r||r.getRooms().length<n)&&(r=this.getMapGen(e,t,s),a=new u.CellMap(e,t),r.create(o),0!=--i););const l=new h.Level(a),c={rooms:r.getRooms(),corridors:r.getCorridors()};return r.bigRooms&&(c.bigRooms=r.bigRooms),l.setExtras(c),this.addNestIntoLevel(l),l}getMapGen(e,t,s){let n=R();s.dungeonType&&""!==s.dungeonType&&(n=s.dungeonType);const r=s.options||k[n];r&&!r.roomDugPercentage&&(r.roomDugPercentage=r.dugPercentage);const a=new w(e,t,r),o=this.addBigRooms(a,s);return o.length>0&&(a.bigRooms=o),a}addBigRooms(e,t){let s=[];t.nBigRooms&&t.nBigRooms>0&&t.bigRooms&&(s=this.addCustomBigRooms(e,t));if(T.getUniform()<=D&&0===t.nBigRooms){const t=this.getBigRoomType();/center/.test(t)&&(s=this.addBigCenterRoom(e)),/large corridor/.test(t)&&(s=this.addLargeCorridorRoom(e)),/cross/.test(t)&&(s=this.addLargeCross(e)),/vault/.test(t)&&(s=this.addVault(e)),/nest/.test(t)&&(s=this.addRoomForNest(e))}return s}getBigRoomType(){return T.arrayGetRand(Object.keys(I))}addCustomBigRooms(e,t){const[s,n]=e.getCenterXY(),[r,a]=[e.getCols(),e.getRows()],o=t.nBigRooms||0,i=[];for(let l=0;l<o;l++){let o=Math.floor(r/4);t.bigRoomWidth&&t.bigRoomWidth[l]&&(o=t.bigRoomWidth[l]);let c=Math.floor(a/4);t.bigRoomHeight&&t.bigRoomHeight[l]&&(c=t.bigRoomHeight[l]);const u=r-2-o;let h=T.getUniformInt(1,u),d="";t.bigRoomX&&(d=t.bigRoomX[l]),/cen/.test(d)&&(h=s-Math.floor(o/2));const f=a-2-c;let g=T.getUniformInt(1,f),p="";t.bigRoomY&&(p=t.bigRoomY[l]),/cen/.test(p)&&(g=n-Math.floor(c/2));const m=new C(h,g,h+(o-1),g+(c-1));e._options.dugPercentage+=.1,e.addRoom(m),i.push(new L("custom",m))}return i}addBigCenterRoom(e){const[t,s]=[e.getCols(),e.getRows()],[n,r]=e.getCenterXY(),a=T.getUniformInt(2,5),o=T.getUniformInt(2,6),i={roomWidth:[Math.floor(t/(o+1)),Math.floor(t/o)],roomHeight:[Math.floor(s/a),Math.floor(s/a)]},l=C.createCenter(n,r,i);return e._options.dugPercentage+=.2,e.addRoom(l),[new L("center",l)]}addLargeCorridorRoom(e){const[t,s]=[e.getCols(),e.getRows()],n=T.getCardinalDirLetter(),a="large corridor "+n;let o=null;if("E"===n){const e=T.getUniformInt(2,6),n=Math.floor(t/e);o=new C(1,1,n,s-2)}if("W"===n){const e=T.getUniformInt(2,6),n=Math.floor(t/e);o=new C(t-2-n,1,t-2,s-2)}if("N"===n){const e=T.getUniformInt(2,5),n=Math.floor(s/e);o=new C(1,1,t-2,n)}if("S"===n){const e=T.getUniformInt(2,5),n=Math.floor(s/e);o=new C(1,s-2-n,t-2,s-2)}return o||r.default.err("DungeonGenerator","addLargeCorridorRoom","room null something went wrong"),e._options.dugPercentage+=.2,e.addRoom(o),[new L(a,o)]}addLargeCross(e){const[t,s]=[e.getCols(),e.getRows()],[n,r]=e.getCenterXY(),a=T.getUniformInt(3,8),o=Math.floor(t/a),i=Math.floor(s/a),l={roomWidth:[t-2,t-2],roomHeight:[i,i]},c={roomHeight:[s-2,s-2],roomWidth:[o,o]},u=C.createCenter(n,r,l),h=C.createCenter(n,r,c);e.addRoom(u),e.addRoom(h);const d=(u.getAreaSize()+h.getAreaSize())/(t*s);return e._options.dugPercentage+=1.6*d,e._options.dugPercentage>=.75&&(e._options.dugPercentage=.75),[new L("crossHor",u),new L("crossVer",h)]}addVault(e){const[t,s]=[e.getCols(),e.getRows()],n=T.getUniform()<=P;let r=Math.floor(t/2),a=Math.floor(s/2),o=["NE","NW","SW","SE"],i="small vault";n&&(T.getUniform()<=.5?(o=["NE","NW"],r=Math.floor(t/2),a=s-2):(o=["NW","SW"],r=t-2,a=Math.floor(s/2)),e._options.dugPercentage+=.25,i="large vault");const[l,c]=this.getRandCorner(r,a,t,s,o),u=new C(l,c,l+r-1,c+a-1);return e._options.dugPercentage+=.2,e.addRoom(u),[new L(i,u)]}addRoomForNest(e){let t=7*T.getUniformInt(2,5),s=7*T.getUniformInt(2,5);const[n,r]=[e.getCols(),e.getRows()];for(;t>n-2;)t-=7;for(;s>r-2;)s-=7;const[a,o]=this.getRandCorner(t,s,n,r,["NE","NW","SW","SE"]),i=new C(a,o,a+t-1,o+s-1);return e._options.dugPercentage+=.2,e.addRoom(i),[new L("nest",i)]}getRandCorner(e,t,s,n,r){const a=T.arrayGetRand(r);let[o,i]=[1,1];switch(a){case"NW":o=1,i=1;break;case"NE":o=s-2-e,i=1;break;case"SW":o=1,i=n-2-t;break;case"SE":o=s-2-e,i=n-2-t}return[o,i]}addSpecialFeatures(e){const t=e.getExtras(),s=e.getMap();if(t.bigRooms){const s=t.bigRooms[0];let n={};if(Object.keys(I).forEach(e=>{new RegExp(e).test(s.type)&&(n=I[e])}),n.special){const s=T.arrayGetRand(n.special);this.addBigRoomSpecialFeat(e,s,t.bigRooms)}}if(t.rooms){const n=T.arrayGetRand(t.rooms),r=[];this.addFireToRoom(e,n),t.rooms.forEach((t,n)=>{t.setID(n);let a=0;const o=E.BBox.fromBBox(t.getOuterBbox());d.Geometry.getBorderForBbox(o).forEach(t=>{if(e.getMap().hasXY(t[0],t[1]))if(s.has(t,"floor"))++a;else{const s=new b.ElementMarker("w");s.setTag("room wall"),e.addElement(s,t[0],t[1])}}),this.addDoorsForRoom(e,t),1===a&&r.push(t)}),r.forEach(t=>{const s=t.getInnerBbox();if(null!==s){d.Geometry.getCoordBbox(s).forEach(t=>{const s=new b.ElementMarker("t");s.setTag("term"),e.addElement(s,t[0],t[1])})}}),t.terms=r}}addBigRoomSpecialFeat(e,t,s){s.forEach(s=>{const n=s.room;switch(n||r.default.err("DungeonGenerator","addBigRoomSpecialFeat","room is null for "+JSON.stringify(s)),t){case"splashes":this.addElemSplashes(e,n)}})}addDoorsForRoom(e,t){this.addDoors&&t.getDoors((t,s)=>{if(!e.getMap().getCell(t,s).hasDoor()){const n=new b.ElementDoor(!0);e.addElement(n,t,s)}})}addElemSplashes(e,t){const s=T.arrayGetRand(Object.keys(N)),n=N[s],r=n.elem;e.getExtras().theme=n,S("Adding splashes with theme",s);const a=t.getLeft()+1,o=t.getTop()+1,i=t.getWidth(),l=t.getHeight(),{map:c}=f.MapGenerator.createSplashes(i,l,{nForests:10,elem:r});d.Geometry.mergeMapBaseElems(e.getMap(),c,a,o)}addFireToRoom(e,t){const s=_.ObjectShell.getParser();Object.values(t.getCorners()).forEach(t=>{const n=s.createActor("Fire");e.addActor(n,t[0],t[1])})}addStairsLocations(e){const t=e.getExtras();let s=r.default.WATCHDOG;if(t.rooms){let[n,a]=T.getUniqueItems(t.rooms,2),o=null,i=null,l=0,c=0;const u=Math.floor(e.getMap().cols/2)+Math.floor(e.getMap().rows/2);for(;l<u&&([n,a]=T.getUniqueItems(t.rooms,2),l=B(e,n,a),l>c&&(c=l,o=n,i=a),0!=--s););n=o,a=i,S("Rooms for stairs locations",n,a);const h=e.getMap().getFreeInBbox(n.getBbox()),d=e.getMap().getFreeInBbox(a.getBbox()),f=T.arrayGetRand(h),g=T.arrayGetRand(d);f||r.default.err("DungeonGenerator","addStairsLocation","Failed to find free place for Stairs@room1"),g||r.default.err("DungeonGenerator","addStairsLocation","Failed to find free place for Stairs@room2"),t.startPoint=g.getXY(),t.endPoint=f.getXY();const{startPoint:p,endPoint:m}=t;this.addStartAndEndPointMarker(e,p,m),n.addStairs(...t.endPoint,!0),a.addStairs(...t.startPoint,!1)}else{const e="rooms must be set as level extras";r.default.err("DungeonGenerator","addStairsLocations","Not enough rooms to add stairs. "+e)}}addCriticalPath(e){const t=e.getExtras();if(!t.startPoint||!t.endPoint)return;const[s,n]=t.startPoint,[a,o]=t.endPoint,i=e.getMap(),l=(e,t,s,n)=>i.isPassable(e,t,s,n)||i.hasXY(e,t)&&i.getCell(e,t).hasDoor();S("Critical path",s,n,"=>",a,o);let c=g.Path.getShortestPath(s,n,a,o,l);if(0===c.length){const e=(e,t)=>(console.log("newPathFunc x,y ",e,t),!/wall/.test(i.getCell(e,t).getBaseElem().getType()));if(c=g.Path.getShortestPath(s,n,a,o,e),0===c.length)r.default.err("DungeonGenerator","addCriticalPath","No path found between stairs");else for(let e=1;e<c.length;e++){const t=c[e-1],{x:s,y:n}=c[e];i.isPassable(s,n,t.x,t.y)||i.setBaseElemXY(s,n,y.ELEM.BRIDGE)}}const u=(e,t,s,n)=>l(e,t,s,n)&&!i.getCell(e,t).hasMarker("path broken");let h=c;for(;c.length<50;){if(!this._breakPath(e,c))break;if(c=O(s,n,a,o,u),0===c.length){this.restorePath(e,h),c=h;break}h=c}this._addWallsToBrokenPath(e),c.forEach(t=>{const s=new b.ElementMarker("*");s.setTag("critical_path"),e.addElement(s,t.x,t.y)}),t.criticalPath=c}_breakPath(e,t){for(let s=0;s<t.length;s++){const{x:n,y:r}=t[s];if(e.getMap().getCell(n,r).hasDoor()){const t=new b.ElementMarker("X");return t.setTag("path broken"),e.addElement(t,n,r),!0}}return!1}_addWallsToBrokenPath(e){e.getElements().filter(e=>"marker"===e.getType()&&"path broken"===e.getTag()).forEach(t=>{const[s,n]=t.getXY();e.getMap().setBaseElemXY(s,n,y.ELEM.WALL)})}restorePath(e,t){for(let s=0;s<t.length;s++){const{x:n,y:r}=t[s];if(e.getMap().getCell(n,r).hasMarker("path broken")){e.getElements().filter(e=>e.isAtXY(n,r)).forEach(t=>{"marker"===t.getType()&&"path broken"===t.getTag()&&e.removeElement(t,n,r)})}}}addNestIntoLevel(e){const{bigRooms:t}=e.getExtras();if(!t)return;const s=t.filter(e=>/nest/.test(e.type))[0];if(s){const{room:t}=s,n=E.BBox.fromBBox(t.getBbox());S("Adding nest to dungeon now using room bbox",n),S("level cols/rows",e.getMap().cols,e.getMap().rows);const r=new v.NestGenerator,a={mapConf:{tilesX:t.getWidth()/7,tilesY:t.getHeight()/7,genParams:A},embedOpts:{level:e,bbox:n},scanForDoors:!0};r.createAndEmbed(1,1,a)}}verifyLevel(e,t){const s=e.getMap(),n=s.getCells(M),a=d.Geometry.floodfillPassable(s,!0),o=n.length,i=a.length;if(i!==o){const s=o-i;if(s>10){this.tryToFillUnreachable(e);const n=this.verifyLevel(e,t);if(!n&&t.errorOnFailure){e.debugPrintInASCII();const t="Max: 10, got: "+s;r.default.err("DungeonGenerator","verifyLevel","Too many unreachable cells "+t)}return n}}return!0}tryToFillUnreachable(e){const t=e.getMap(),s=d.Geometry.floodfillRegions(t,!0),{startPoint:n,endPoint:a}=e.getExtras(),o=t.getCell(n[0],n[1]),i=t.getCell(a[0],a[1]),l=d.Geometry.floodfill(t,o,M,!0),c=d.Geometry.floodfill(t,i,M,!0);l.length===c.length?s.forEach(e=>{e.length!==l.length&&t.setBaseElems(e,y.ELEM.WALL)}):r.default.err("DungeonGenerator","tryToFillUnreachable","floodfill sizes for start/endFill differ. They are not connected!")}}t.DungeonGenerator=x,x.mapOptions={digger:{roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2},uniform:{roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1}};const k=x.mapOptions,R=()=>T.arrayGetRand(["uniform","digger"]);function B(e,t,s){const n=e.getMap(),[r,a]=t.getCenter(),[o,i]=s.getCenter();return g.Path.getShortestPassablePathWithDoors(n,r,a,o,i).length}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MountainGenerator=void 0;const r=n(s(0)),a=s(34),o=s(11),i=s(4),l=s(10),c=s(53),u=s(1),h=s(8),d=s(33),f=u.Random.getRNG();class g{static getSummitOptions(){const e=d.LevelGenerator.getOptions();return Object.assign({},g.options.summit,e)}static getFaceOptions(){const e=d.LevelGenerator.getOptions(),t=a.MapGenerator.getOptions("mountain");return Object.assign({},t,g.options.face,e)}createMountain(e,t,s){return[this.createFace(e,t,s),this.createSummit(e,t,s)]}createFace(e,t,s){const n=new a.MapGenerator;n.setGen("mountain",e,t),s.nRoadTurns=0;const r=n.createMountain(e,t,s),i=new o.Level(r.map);return this.createCrux(i,s),i}createSummit(e,t,s){const n=new a.MapGenerator;n.setGen("mountain",e,t);const r=n.createSummit(e,t,s),i=new o.Level(r.map);return i.setExtras({}),i}createCrux(e,t){const s=e.getMap(),n=s.cols,r=Math.round(s.rows/6),o={wallElem:h.ELEM.HIGH_ROCK,meanWy:Math.round(r/2.5)},l=new a.MapGenerator;l.setGen("wall",n,r);const u=l.createWall(n,r,o).map,d=f.getUniformInt(0,n-1),g=f.getUniformInt(0,n-1),p=this.carvePath(u,d,0,g,r-1),m=Math.round(s.rows/5);i.Geometry.mergeMaps(s,u,0,m,(e,t)=>{const s=t.getBaseElem();return!/(floor)/.test(s.getType())});const y={startX:0,startY:0,maxY:m,yPerTurn:Math.round(m/4),endX:d};let _=l.createMountainPath(s,y);y.startY=m+r,y.maxY=s.rows-1,y.startX=g,y.yPerTurn=0,_=_.concat(l.createMountainPath(s,y)),e.addExtras("paths",_),p.forEach(e=>{e[1]+=m});const b=new c.DungeonPopulate(t);for(let s=0;s<3;s++){const s=f.arrayGetRand(p);b.addPointGuardian(e,s,t.maxDanger)}}carvePath(e,t,s,n,a){const o=[];return l.Path.getShortestPath(t,s,n,a).forEach(t=>{i.Geometry.getCrossAround(t.x,t.y,2,!0).forEach(t=>{const[s,n]=t;e.hasXY(s,n)&&(o.push(t),r.default.isSuccess(.25)?e.setBaseElemXY(s,n,h.ELEM.STEEP_CLIFF):e.setBaseElemXY(s,n,h.ELEM.STONE))}),e.setBaseElemXY(t.x,t.y,h.ELEM.CLIFF)}),o}}t.MountainGenerator=g,g.options={},g.options.face={},g.options.summit={ratio:.3}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DebugGame=void 0;const i=o(s(0)),l=a(s(2)),c=a(s(7)),u=a(s(26)),h=a(s(57)),d=s(105),f=s(58),g=s(55),p=s(136),m=s(21),y=s(103),_=s(45),b=s(1),v=s(70),E=s(476),S=s(132),w=s(8),C=s(133),T=s(137),O=s(12),A=s(64),M=s(19),N=s(65),P=a(s(32)),D=s(138),I=s(488),L=s(214),x=O.EventPool.getPool(),k=b.Random.getRNG(),R=c.ElementStairs;t.DebugGame=class{constructor(e,t){this._fact=e,this._factBase=new A.FactoryBase,this._parser=t,this._savedPlayerFOV=1}createArena(e,t,s){L.Room.rng=k;const n=this._parser,r=e.sqrPerItem;e.cols=100,e.rows=100;const[a,o]=[50,50],h=this.createLastBattle(t,e);h.addActor(s,a,o);const p=new P.CityQuarter("Debug quarter");p.addLevel(h);h.getExtras().shops.forEach(e=>{p.addShop(e)});const m=new P.City("Wrapper city for Debug quarter");m.addSubZone(p),m.tileX=0,m.tileY=0;const _=new P.Area("Wrapper area",2,2,10,10);_.addZone("City",m);const b=new P.WorldTop("Wrapper world"),E=b.getConf();b.addArea(_),E.nAreas=1,E.area=[_.getConf()],b.setConf(E),t.addPlace(b);const O=this._parser.createActor("Wolf spirit");O.get("Stats").setStrength(500),h.addActor(O,2,1);const A=new u.SpiritGem("Lesser gem");h.addItem(A);const M=this._parser.createItem("Pick-axe");s.getInvEq().addItem(M);const N=this._parser.createItem("Potion of frost poison");N.setCount(5),h.addItem(N,2,2);const D=this._parser.createItem("Potion of cure poison");h.addItem(D,3,2);const x=this._parser.createItem("Rifle"),R=this._parser.createItem("Steel bullet");R.setCount(100),h.addItem(x,1,1),h.addItem(R,1,1);const B=this._parser.createActor("shopkeeper"),G=new u.GoldCoin;G.setCount(50),B.getInvEq().addItem(G),h.addActor(B,2,2);const W=h.getMap().getFree().length,Y={itemsPerLevel:Math.round(W/r),item:e=>e.value<=2500,maxValue:2500,food:()=>!0,gold:()=>!1};this._factBase.addNRandItems(h,this._parser,Y);const{cols:j,rows:X}=h.getMap(),U=this._parser.createActor("Thabba, Son of Ice");h.addActor(U,j-2,X-2);const $=this._parser.createActor("Cryomancer");h.addActor($,1,X-2);const V=this._parser.createActualObj("items","Potion of spirit form");s.getInvEq().addItem(V);const H=this._parser.createItem("Potion of strength");s.getInvEq().addItem(H),s.add(new l.Attacker),s.add(new l.Defender),s.add(new l.MasterEquipper),s.add(new l.BiDirStrike),s.add(new l.ThroughShot);new I.WinCondition("Kill a keeper",t.getPool()).addActorKilled(B);s.getInvEq().getEquipment().addSlot("spiritgem",new y.EquipSlot("spiritgem"));const q=this._parser.createItem("Lesser spirit gem"),K=this._parser.createItem("Greater spirit gem");s.getInvEq().addItem(q),s.getInvEq().addItem(K),s.add(new l.SpiritItemCrafter);const z=new c.ElementExploration;z.setExp(100),h.addElement(z,1,20);const J=this.createTrainer();h.addActor(J,1,2);const Q=new u.GoldCoin;Q.setCount(600),s.getInvEq().addItem(Q);const Z=new v.Spell.SpellBook(s);s.setBook(Z),v.Spell.addAllSpells(Z),s.add(new l.SpellPower),s.get("SpellPower").setPP(100);const ee=new S.VirtualActor("spawner"),te=new g.BrainSpawner(ee);te.setConstraint({op:"lt",prop:"danger",value:10}),ee.setBrain(te),h.addVirtualProp(i.default.TYPE_ACTOR,ee);const se=this._parser.createActor("Fire"),ne=new l.Fading;ne.setDuration(20),se.add(ne),h.addActor(se,7,1);const re=this._parser.createActor("thunderbird");h.addActor(re,20,1);const ae=n.createEntity("firemaking kit");s.getInvEq().addItem(ae),s.get("SpellPower").setPP(100),s.get("SpellPower").setMaxPP(100),this.addRunesForDebug(s,n);const oe=new c.ElementLever;h.addElement(oe,2,1);for(let e=0;e<3;e++){const t=new c.ElementLeverDoor;oe.addTarget(t),h.addElement(t,3+e,1)}d.Ability.addAllAbilities(s),this.addGoblinWithLoot(h);const ie=F(n,s,"Void dagger");s.getInvEq().unequipItem("hand",1,0),s.getInvEq().equipItem(ie),F(n,s,"shovel"),F(n,s,"machete"),F(n,s,"rune of webs");const le=n.createActor("bearfolk thief");h.addActor(le,a+1,o+1),console.log("XYZ created thief: ",le.getID(),le.getName()),s.getInvEq().addItem(n.createItem("Boots of flying"));const ce=new l.RegenEffect;ce.setPP(2),ce.setWaitPP(0),ce.setMaxWaitPP(0),s.add(ce),h.getMap().setBaseElemXY(a-1,o-1,w.ELEM.WATER);f.ActorsData.filter(e=>"UniqueBase"===e.base).forEach(e=>{const{name:t}=e,s=n.createActor(t);s?h.addActorToFreeCell(s):i.default.warn("DebugGame","creating uniques","Failed to create unique actor: "+t)});const ue=new T.QuestPopulate,he=new u.Book("Book of shadows");he.addText("In the land of mordor where shadows lie..."),s.getInvEq().addItem(he);const de=new T.Quest("Report info to actor",["<goto>already_there","<report>listen","<goto>already_there","report"]);ue.mapQuestToResources(de,m,null),ue.addQuestComponents(m);const fe=h.getActors(),ge=fe.find(e=>e.has("QuestGiver"));ge.get("QuestGiver").setReward({type:"item",name:"Ruby glass mace"}),h.moveActorTo(ge,a+1,o),ge.add(new l.Trainer);fe.filter(e=>e.has("QuestTarget")).forEach((e,t)=>{h.moveActorTo(e,a,o+1+t),e.get("Stats").setSpeed(10)});const pe=h.getMap().getCells(e=>e.isFree());for(let e=0;e<200;e++){const e=k.arrayGetRand(pe),[t,s]=e.getXY();h.addElement(new c.ElementWeb,t,s),h.getMap().hasXY(t+1,s+1)&&h.addElement(new c.ElementSlime,t+1,s+1)}const me=h.getMap().getCells(e=>e.hasPropType("floorhouse"));for(let e=0;e<40;e++){k.arrayGetRand(me).setBaseElem(w.ELEM.BED)}const ye=new l.Charm({level:10});s.add(ye);const _e=new l.Lore({});_e.addTopic("quests",ge.getName()+" is looking for someone."),h.add(_e);const be=C.ItemGen.buildShell({type:"weapon",name:"sword",material:"steel",suffix:"ofNecropotence"}),ve=n.createFromShell(i.default.TYPE_ITEM,be);s.getInvEq().addItem(ve);n.getCreator().addAbilityEffects({ability:{addEntity:{name:"Lay an egg",entityName:"Chicken egg"}}},s);const Ee=h.getMap().getCells(e=>e.isFree());for(let e=0;e<50;e++){const e=k.arrayGetRand(Ee),t=n.createActor("chicken");h.addActor(t,e.getX(),e.getY())}return F(n,s,"hoe"),F(n,s,"wheat seeds"),s.setFOVRange(5),t.addPlayer(s),t}addRunesForDebug(e,t){const s=new _.ItemRandomizer,n=t.createItem("rune of protection");s.adjustItem(n,100),e.getInvEq().addItem(n);const r=t.createItem("rune of tunneling");s.adjustItem(r,100),e.getInvEq().addItem(r);const a=t.createItem("rune of force");s.adjustItem(a,100),e.getInvEq().addItem(a);const o=t.createItem("rune of control");s.adjustItem(o,250),e.getInvEq().addItem(o);const i=t.createItem("rune of venom");s.adjustItem(i,150),e.getInvEq().addItem(i);const l=t.createItem("rune of poison clouds");s.adjustItem(l,150),e.getInvEq().addItem(l)}createQuestsDebug(e,t,s){const n={name:"Quest test world",nAreas:1,area:[(new D.WorldCreator).createSingleAreaConf(0,{maxX:2,maxY:2})]},r=(new N.FactoryWorld).createWorld(n),a=r.getZones("City")[0].getLevels()[0],o=Math.floor(a.getMap().cols/2),i=Math.floor(a.getMap().rows/2);return a.addActor(s,o,i),t.addPlace(r),t.addPlayer(s),t}createTrainer(){const e=this._parser.createActor("fighter");e.setName("Old trainer");const t=new l.Trainer;return t.getChatObj().setTrainer(e),e.add(t),e}addGoblinWithLoot(e){const t=this._parser.createActor("goblin");t.setName("goblin with loot");const s=new l.Loot(new u.Weapon("sword"));t.add(s),e.addActor(t,2,10)}createDebugBattle(e,t,s){const n=new p.Battle("Battle of ice kingdoms"),r=new p.Army("Blue army"),a=new p.Army("Red army");this.addActorsToArmy(r,10,"warlord"),this.addActorsToArmy(a,10,"Winter demon");const o=(new M.FactoryLevel).createLevel("arena",60,30);return n.setLevel(o),n.addArmy(r,1,1,{}),n.addArmy(a,1,2,{}),t.addBattle(n),t.addPlayer(s),t}addActorsToArmy(e,t,s){for(let n=0;n<t;n++){const t=this._parser.createActor(s);t.setFOVRange(10),e.addActor(t)}}createOneDungeonAndBoss(e,t,s){const{cols:n,rows:r,nLevels:a,sqrPerActor:o,sqrPerItem:i}=e;let c=1;const h=["rooms","rogue","digger"],d=[],f=[],g=new P.Branch("StartBranch"),p=e=>t=>t.value<=e;for(let e=0;e<a;e++){let t=h[k.randIndex(h)];0===e&&(t="ruins");const s=this._fact.createLevel(t,n,r);g.addLevel(s);const a=s.getMap().getFree().length,l=Math.round(a/o),c=Math.round(a/i),d=new u.Potion("Healing potion");s.addItem(d);const m=this._parser.createItem("Shuriken");m.setCount(20),s.addItem(m);const y=20*(e+1),_={itemsPerLevel:c,func:p(y),maxValue:y,food:()=>!0};this._fact.addNRandItems(s,this._parser,_);const b={actorsPerLevel:l,maxDanger:e+1};this._fact.addNRandActors(s,this._parser,b),f.push(s)}const m=f.slice(-1)[0],y=m.getFreeRandCell(),_=this._fact.createActor("Summoner",{hp:100,att:10,def:10});_.setType("summoner"),_.get("Experience").setExpLevel(10),m.addActor(_,y.getX(),y.getY());const b=this.createLastBattle(t,{cols:80,rows:60});t.addLevel(b),b.setLevelNumber(c++),g.connectLevels(),t.addPlace(g);const v=new R("stairsDown",f[a-1],b),E=new l.Loot(v);_.add(E),d.push(v);const S=d.slice(-1)[0],w=new R("stairsUp",b,m),C=b.getFreeRandCell();b.addStairs(w,C.getX(),C.getY()),w.setTargetStairs(S),S.setTargetStairs(w);for(let e=0;e<10;e++){const e="Townsman",t=this._fact.createActor(e,{brain:"Human"});t.setType("human");const s=b.getFreeRandCell();b.addActor(t,s.getX(),s.getY())}if(null!==e.loadedLevel){const t=e.loadedLevel;t<=a?f[t-1].addActorToFreeCell(s):f[0].addActorToFreeCell(s)}return t.addPlayer(s,{place:"StartBranch"}),t}createLastBattle(e,t){const s=A.Factory.cityConfBase({});s.parser=this._parser,s.nShops=5;const n=e=>e.type===k.arrayGetRand(i.default.SHOP_TYPES);for(let e=0;e<s.nShops-1;e++)s.shopFunc.push(n);s.actorFunc=e=>"bearfolk"===e.type,s.hasWall=!1;const r=(new m.CityGenerator).create(t.cols,t.rows,s);this._listener=new B(this,e,r);return(new A.FactoryBase).createHumanArmy(r,this._parser),r.setOnFirstEnter(()=>{const t=new h.OneShotEvent(this._factBase.createDemonArmy.bind(this._fact,r,this._parser),2e3,"Demon hordes are unleashed from the unsilent abyss!");e.addEvent(t)}),r.setOnEnter(()=>{this._savedPlayerFOV=e.getPlayer().getFOVRange(),e.getPlayer().setFOVRange(20)}),r.setOnExit(()=>{e.getPlayer().setFOVRange(this._savedPlayerFOV)}),r}};class B{constructor(e,t,s){this.parent=e,this._game=t,this._level=s,this._maxBeasts=0,this._maxDemons=0,this._beastsKilled=0,this._demonsKilled=0,this.hasNotify=!0,x.listenEvent(i.default.EVT_ACTOR_CREATED,this),x.listenEvent(i.default.EVT_ACTOR_KILLED,this),this.notify=this.notify.bind(this)}notify(e,t){if(e===i.default.EVT_ACTOR_CREATED){if(t.hasOwnProperty("msg")&&"DemonSpawn"===t.msg){const e=t.actor;"Winter demon"===e.getName()&&++this._maxDemons,"Blizzard beast"===e.getName()&&++this._maxBeasts}}else if(e===i.default.EVT_ACTOR_KILLED){const e=t.actor;"Winter demon"===e.getName()?(++this._demonsKilled,this._demonsKilled===this._maxDemons&&this.allDemonsKilled(),i.default.debug(this,"A winter demon was slain! #"+this._demonsKilled),i.default.debug(this,"Max demons: "+this._maxDemons)):"Blizzard beast"===e.getName()&&(++this._beastsKilled,this._beastsKilled===this._maxBeasts&&this.allBeastsKilled())}}addSnow(e,t){const s=e.getMap();m.MapGenerator.addRandomSnow(s,t)}allDemonsKilled(){i.default.gameMsg("Humans have vanquished all demons! But it's not over..");const e=new h.OneShotEvent(this.addSnow.bind(this,this._level,.2),2e3,"Winds are blowing stronger. You feel it's getting colder");this._game.addEvent(e);const t=new h.OneShotEvent(()=>{},3500,E.Texts.battle.eyeOfStorm);this._game.addEvent(t);const s=new h.OneShotEvent(this.parent.createBeastArmy.bind(this.parent,this._level,this.parent._parser),5e3,"Winter spread by Blizzard Beasts! Hell seems to freeze.");this._game.addEvent(s)}allBeastsKilled(){i.default.gameMsg(E.Texts.battle.beastsSlain);const e=new h.OneShotEvent(()=>{},1e3,E.Texts.battle.enemiesDead);this._game.addEvent(e);const t=new h.OneShotEvent(()=>{},2e3,"Battles in the North will continue soon in larger scale...");this._game.addEvent(t)}}function F(e,t,s){const n=e.createItem(s);return t.getInvEq().addItem(n),n}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Texts=void 0,t.Texts={},t.Texts.intro={},t.Texts.intro.chapter1="\nWelcome to the wintry realms!\nWinds are ever-blowing. Blowing off the\nglaciers.\nAre you ready to face the challenges of the\nicy north? Hunger, coldness, ravenous\nbeasts, glacial chasms and forthcoming\neternal winter are waiting for you in the\ndarkness.\n",t.Texts.intro.chapter2="\nYou have come a long way from your homelands\nseeking\nthe thrill of the adventure. Now, you must\nfight freezing battles in\nthe north against hordes of winter demons\nand blizzard beasts. Will you bring back the\npeace\nto the grim and frostbitten kingdoms. Or\nwill you\nbring the Winter of Ages upon its lands,\nreigning\nyour kingdom cold for all eternity? Or will\nyou\nperish\nnameless and forgotten on the icy wastes?\n",t.Texts.battle={},t.Texts.battle.eyeOfStorm="You see an eye of the storm approaching. Brace yourself now..",t.Texts.battle.beastsSlain="All beasts have been slain. The blizzard seems to calm down",t.Texts.battle.enemiesDead="All enemies are dead! You emerge victorious. Congratulations!",t.Texts.mainQuest=["Go north","Something is going on in the North","Some speak about ancient ice beasts waking up in the arctic!","Two huge mountain passes divide this realm into regions","If you follow the Great Road to north, you will reach a city carved into the mountain","Recently, the breezes from north have been colder than before"]},function(e,t,s){!function(e){"use strict";function t(t){var s=this!==e?this:{};s.input=t,s.pos=0,s.line=1,s.linePos=0}e.version="0.1.2",e.parse=function(e){return new t(e).grammar()},e.stringify=function e(t){switch(t.type){case"terminal":return'"'+n(t.text)+'"';case"nonterminal":return"<"+n(t.text)+">";case"expression":return t.terms.map(e).join(" ");case"production":return e(t.lhs)+" ::= "+t.rhs.map(e).join(" | ")+";";case"grammar":return t.productions.map(e).join("\n")+"\n"}throw new Error("Unknown node type: "+t.type)},e.Parser=t;var s=t.EOF=-1;function n(e){return e.replace(/\\/g,"\\\\").replace(/\"/g,'\\"').replace(/\n/g,"\\n").replace(/\t/g,"\\t")}t.prototype.error=function(e){throw new SyntaxError(e+" at "+this.line+":"+this.linePos)},t.prototype.peek=function(){return this.pos>=this.input.length?s:this.input[this.pos]},t.prototype.eat=function(e){var t=this.peek();return void 0!==e&&e!==t&&this.error("Expected "+e+", got"+t),t===s?s:(this.pos++,this.linePos++,t)},t.prototype.ws=function(){for(var e,t="";" \n\t".indexOf(e=this.peek())>=0;)"\n"===e&&(this.line++,this.linePos=0),t+=this.eat();return t},t.prototype.escaped=function(){this.eat("\\");var e=this.peek();switch(e){case"n":return this.eat(),"\n";case"t":return this.eat(),"\t";case'"':return this.eat(),'"';case"\\":return this.eat(),"\\"}this.error("Invalid escape sequence: \\"+e)},t.prototype.isChar=function(){var e=this.peek();return e!==s&&(/[a-zA-Z0-9\-_|:=; \/\(\)]/.test(e)||"\\"===e)},t.prototype.text=function(){for(var e="";this.isChar();)"\\"===this.peek()?e+=this.escaped():e+=this.eat();return e},t.prototype.terminal_text=function(){for(var e="",t=this.peek();this.isChar()||"<"===t||">"===t;)e+="\\"===t?this.escaped():this.eat(),t=this.peek();return e},t.prototype.terminal=function(){this.eat('"');var e=this.terminal_text();return this.eat('"'),{type:"terminal",text:e}},t.prototype.nonterminal=function(){this.eat("<");var e=this.text();return this.eat(">"),{type:"nonterminal",text:e}},t.prototype.term=function(){return"<"===this.peek()?this.nonterminal():this.terminal()},t.prototype.expression=function(){var e=[this.term()];for(this.ws();'<"'.indexOf(this.peek())>=0;)e.push(this.term()),this.ws();return{type:"expression",terms:e}},t.prototype.expressions=function(){for(var e=[this.expression()];"|"===this.peek();)this.eat("|"),this.ws(),e.push(this.expression());return e},t.prototype.production=function(){var e=this.nonterminal();this.ws(),this.eat(":"),this.eat(":"),this.eat("="),this.ws();var t=this.expressions();return this.eat(";"),{type:"production",lhs:e,rhs:t}},t.prototype.grammar=function(){var e=[this.production()];for(this.ws();"<"===this.peek();)e.push(this.production()),this.ws();return{type:"grammar",productions:e}}}(t)},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QuestGrammar=void 0;const n=s(1).Random.getRNG();t.QuestGrammar={};const r="<Comfort> ::= <Kill_pests>;\n\n<Reputation> ::= <Obtain_rare_items> |\n <Kill_enemies> |\n <Visit_a_dangerous_place>;\n\n<Conquest> ::= <Attack_enemy> | <Steal_stuff>;\n\n<Strategy> ::= <Win_a_battle>\n    | <Survive_a_battle>;",a=`<QUEST> ::= <Conquest> | <Comfort> | <Strategy> | <Reputation>;\n\n${r}\n\n<Kill_pests> ::= <goto> "damage" <goto> "report";\n\n<Obtain_rare_items> ::= <get> <goto> "give";\n<Kill_enemies> ::= <goto> <kill> <goto> "report";\n<Visit_a_dangerous_place> ::= <goto> <goto> "report";\n\n<Attack_enemy> ::= <goto> "damage";\n<Steal_stuff> ::= <goto> <steal> <goto> "give";\n\n<Win_a_battle> ::= <goto> "winbattle";\n<Survive_a_battle> ::= <goto> "finishbattle";\n\n<goto> ::= "<goto>already_there" | "<goto>explore" | <learn> "<goto>goto";\n\n<goto_new_place> ::= "<goto>explore" | <learn> "<goto>goto";\n\n<learn> ::= "<learn>already_know_it" |\n    <goto> "listen" |\n    <goto> <get> "<learn>read" |\n    <get> "give" "listen";\n\n<get> ::= "<get>already_have_it" |\n    <steal> |\n    <goto> "<get>gather";\n\n<steal> ::= <goto> "<steal>stealth" "<steal>take" |\n    <goto> <kill> "<steal>take";\n\n<kill> ::= <goto> "<kill>kill";`,o=/<(\w+)>\s*::=/;const i={Knowledge:180,Comfort:20,Reputation:70,Serenity:140,Protection:180,Conquest:200,Wealth:20,Ability:10,Equipment:180,Strategy:40};t.QuestGrammar.motiveWeights=i;const l=function(e){const t=[];return e.split("\n").forEach(e=>{const s=e.match(o);s&&s.length>1&&t.push(s[1])}),t}(r);t.QuestGrammar.setWeight=function(e,t,s=!1){s&&Object.keys(i).forEach(e=>{i[e]=0}),i[e]=t},t.QuestGrammar.getRandMotive=function(){n.getWeighted(i)},t.QuestGrammar.grammar=a,t.QuestGrammar.actorMotivations=l},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.QuestPopulate=void 0;const i=s(5)("bitn:quest-gen"),l=o(s(0)),c=s(480),u=s(1),h=s(30),d=s(6),f=s(63),g=s(12),p=a(s(26)),m=a(s(2)),y=s(218),_=s(219),b=u.Random.getRNG(),v=g.EventPool.getPool();class E{constructor(e){this.resetData(),this.questList=[],this.conf={maxLength:10,minLength:1,minQuests:1,maxQuests:2,numQuestsPerZone:1},this.maxTriesPerZone=5,this.questTargetCallback={escort:this.handleEscort=this.handleEscort.bind(this),repair:this.handleRepair=this.handleRepair.bind(this),listen:this.handleListen=this.handleListen.bind(this),reportListen:this.handleListen=this.handleListen.bind(this),report:this.handleReport=this.handleReport.bind(this),subquest:this.handleSubQuest=this.handleSubQuest.bind(this)},this.checkImplemented=!0,this.IND=0,this.debug=i.enabled,this.rng=b,e&&e.rng&&(this.rng=e.rng),this.pool=v}resetData(){this.questData={quests:[]},this.questList=[],this._cleanup=[],this.flags={alreadyKnowIt:!1,escort:!1,listen:!1,read:!1,report:!1},this.listOfAllTasks=[],this.currQuest=null,this._data=new Map,this._questCrossRefs=new Map,this.questGivers=new Map}getCurrQuest(){return this.currQuest?this.currQuest:(l.default.err("QuestPopulate","getCurrQuest","currQuest is null!"),new y.QuestData)}setDebug(e){this.debug=e,i.enabled=e}getParentQuestData(){const e=this.questData.quests.indexOf(this.currQuest);return e>0?this.questData.quests[e-1]:null}initQuestPopulDataForQuest(e){this._data.set(e,{actor:[],element:[],escort:[],item:[],listen:[],place:[],read:[],reportListen:[],return:[],zone:[]})}addQuestPopulData(e,t){const s=this.getCurrQuest();if(this._data.has(s)||this.initQuestPopulDataForQuest(this.getCurrQuest()),this._data.get(s).hasOwnProperty(e))this._data.get(s)[e].push(t);else{const t=Object.keys(this._data.get(s)).join(",");l.default.err("QuestPopulate","addQuestPopulData",`Key ${e} not present. Choices: ${t}`)}}getQuestPopulData(e,t=!1){const s=this.getCurrQuest();if(this._data.has(s)){const n=this._data.get(s);if(n.hasOwnProperty(e)&&n[e].length>0){const t=n[e].length;return n[e][t-1]}if(t){const t=this.getParentQuestData();if(t){const s=this._data.get(t);if(s.hasOwnProperty(e)){const t=s[e].length;return s[e][t-1]}}l.default.err("QuestPopulate","getQuestPopulData",`No data for type ${e}. Searched parent also`)}else{const t=Object.keys(n);l.default.err("QuestPopulate","getQuestPopulData",`No data for type ${e}. Keys: ${t}`)}}else l.default.err("QuestPopulate","getQuestPopulData","No data for currQuest exists");return null}createQuests(e,t,s,n){t.isLoaded(s,n)||l.default.err("QuestPopulate","createQuests",`Tried to create quests for unloaded AreaTile[${s}][${n}]!`);const r=t.getTileXY(s,n),a=r.getZones("City");let o=0;return a.forEach(e=>{o+=this.createQuestsForZone(e,r)}),o}createQuestsForZone(e,t){const s=this.conf.numQuestsPerZone||1;let n=0;for(let r=0;r<s;r++)for(let s=0;s<this.maxTriesPerZone;s++){const s=(new _.QuestGen).genQuestWithConf(this.conf);if(this.resetData(),this.mapQuestToResources(s,e,t)){this.addQuestComponents(e),++n;break}}return n}mapQuestToResources(e,t,s){++this.IND,this.currTile=s;const n=new y.QuestData;this.dbg("*** New quest started ****"),e.isQuest()&&(this.dbg("  Quest has "+e.numTasks()+" tasks"),this.dbg("  Quest has "+(e.numQuests()-1)+" sub-quests"));let r=null;if(this.currQuest){const e={createTarget:"createSubQuestTarget",subQuest:n,args:[]};this.dbg("Adding |subquest| target for current quest"),this.currQuest.addTarget("subquest",e),r=this.currQuest.getCurrentLocation()}r&&this.addQuestPopulData("return",r),this.currQuest=n,this.questData.quests.push(this.currQuest);const a=this.rng.arrayGetRand(t.getLevels());this.currQuest.addTarget("location",a);let o=!0;if(e.getSteps().forEach(t=>{const n=this.currQuest.getCurrentLocation();if(t.isQuest()){const e=n.getParentZone();o=o&&this.mapQuestToResources(t,e,s)}else{const r=n.getParentZone();o=o&&this.mapTask(e,t,r,s)}}),o=o&&this._checkQuestFlags(),!o)return this.cleanUpFailedQuest(),--this.IND,!1;this.dbg("Created quest: "+this.currQuest.getDescr());if(this.questData.quests.length>1){this.questList.unshift(this.questData.quests.pop());const e=this.questData.quests.length-1;this.currQuest=this.questData.quests[e]}else this.questList.unshift(this.currQuest);return--this.IND,!0}pushQuestCrossRef(e,t){const s=this.currTaskType;e||l.default.err("QuestPopulate","pushQuestCrossRef",`${s}: Undefined KEY with data ${t}`),t||l.default.err("QuestPopulate","pushQuestCrossRef",`${s}: Undefined DATA with key ${e}`),this._questCrossRefs.has(e)||this._questCrossRefs.set(e,[]),this._questCrossRefs.get(e).push(t)}popQuestCrossRef(e){if(this._questCrossRefs.has(e)){const t=this._questCrossRefs.get(e);if(t.length>0){const s=this._questCrossRefs.get(e).pop();return 0===t.length&&this._questCrossRefs.delete(e),s}}return null}mapTask(e,t,s,n){++this.IND;const r=t.getTaskType();let a=!1;if(this.checkImplemented&&!S.has(r))return!1;if(!this.currQuest)return l.default.err("QuestPopulate","mapTask","currQuest must not be null/undefiend"),!1;switch(this.dbg("Processing taskType |"+r+"|"),this.listOfAllTasks.push(r),this.currTaskType=r,r){case"capture":{const e=this.getActorToCapture();e&&(this.currQuest.addTarget("capture",e),a=!0);break}case"damage":{const e=this.getEntityToDamage();e&&(this.currQuest.addTarget("damage",e),a=!0);break}case"defend":{const e=this.getEntityToDefend();e&&(this.currQuest.addTarget("defend",e),a=!0);break}case"escort":{const e=this.getActorToEscort(n);e&&(this.currQuest.addTarget("escort",e),a=!0,this.addQuestPopulData("escort",e),this.flags.escort=!0);break}case"experiment":{const e=this.getQuestPopulData("item");e&&(this.currQuest.addTarget("experiment",e),a=!0);break}case"<get>already_have_it":{const e=this.getAlreadyOwnedItem();e&&(this.currQuest.addTarget("get",e),a=!0,this.addQuestPopulData("item",e));break}case"<get>gather":{const e=this.getItemToGather();e&&(this.currQuest.addTarget("get",e),a=!0,this.addQuestPopulData("item",e));break}case"<get>exchange":{const e=this.getItemToExchange();e&&(this.currQuest.addTarget("exchange",e),a=!0,this.addQuestPopulData("item",e));break}case"give":{const e=this.currQuest.getCurrentLocation(),t=this.getActorForQuests(e.getActors());t&&(this.currQuest.addTarget("give",t),a=!0);break}case"<goto>already_there":a=!0,this.flags.escort&&(a=!1);break;case"<goto>explore":{const e=this.getNewExploreLocation(s,n);this.currQuest.addTarget("location",e);const t=this.getExploreTarget();if(t&&(this.currQuest.addTarget("explore",t),a=!0,this.flags.read&&(this.flags.read=!1,this.pushQuestCrossRef(this.getQuestPopulData("read"),e)),this.flags.escort)){this.flags.escort=!1;const t=this.getQuestPopulData("escort",!0);this.pushQuestCrossRef(t,e)}break}case"<goto>goto":{const e=this.getNewLocation(s,n);if(this.currQuest.addTarget("location",e),a=!0,this.flags.read&&(this.flags.read=!1,this.pushQuestCrossRef(this.getQuestPopulData("read"),e)),this.flags.listen&&(this.flags.listen=!1,this.pushQuestCrossRef(this.getQuestPopulData("listen"),e)),this.flags.escort){this.flags.escort=!1;const t=this.getQuestPopulData("escort",!0);this.pushQuestCrossRef(t,e)}break}case"<kill>kill":{const e=this.getActorToKill();e&&(this.currQuest.addTarget("kill",e),a=!0);break}case"<learn>already_know_it":this.flags.alreadyKnowIt=!0,a=!0;break;case"listen":{const e=this.getActorToListen();e&&(this.currQuest.addTarget("listen",e),this.flags.listen=!0,this.addQuestPopulData("listen",e),a=!0);break}case"finishbattle":this.currQuest.addTarget("finishbattle",{createTarget:"createBattle",args:[s,n]}),a=!0;break;case"<learn>read":{const e=this.getReadTarget(s,n);e&&(this.addQuestPopulData("read",e),this.flags.read=!0,this.currQuest.addTarget("read",e),a=!0);break}case"repair":{const e=this.getRepairTarget();e&&(this.currQuest.addTarget("repair",e),a=!0);break}case"<report>listen":{const e=this.getActorToListen();e&&(this.currQuest.addTarget("reportListen",e),this.flags.report=!0,this.addQuestPopulData("reportListen",e),a=!0);break}case"report":{const e=this.getActorForReport();if(e&&(this.currQuest.addTarget("report",e),a=!0,this.flags.report)){const t=this.getQuestPopulData("reportListen");this.pushQuestCrossRef(e,t),this.flags.report=!1}break}case"<spy>spy":{const e=this.getActorToSpy();e&&(this.currQuest.addTarget("spy",e),a=!0);break}case"<steal>stealth":a=!0;break;case"<subquest>goto":{const e=this.getQuestPopulData("return");if(e&&(this.currQuest.addTarget("location",e),a=!0,this.flags.escort)){this.flags.escort=!1;const t=this.getQuestPopulData("escort",!0);this.pushQuestCrossRef(t,e)}break}case"<steal>take":{const e=this.getItemToSteal();e&&(this.currQuest.addTarget("get",e),this.addQuestPopulData("item",e),a=!0);break}case"take":{const e=this.getItemToSteal();e&&(this.currQuest.addTarget("get",e),this.addQuestPopulData("item",e),a=!0);break}case"use":{const e=this.getItemToUse();e&&(this.currQuest.addTarget("use",e),a=!0);break}case"winbattle":this.currQuest.addTarget("winbattle",{createTarget:"createBattle",args:[s,n]}),a=!0;break;default:l.default.err("QuestPopulate","mapTask",`Task type ${t.taskType} not supported yet`)}return a||console.warn("QuestPopulate","mapTask",`Failed to map ${t.getTaskType()}, ${JSON.stringify(t)}`),--this.IND,a}getActorForQuests(e){let t=this.rng.arrayGetRand(e),s=20,n=!1;for(;!w(t);)if(t=this.rng.arrayGetRand(e),0==--s){n=!0;break}return n&&l.default.warn("QuestPopulate","getActorForQuests",`No suitable actor found. Using ${t.getName()}. May bring undesirable effects`),t}getActorToKill(){let e=this.currQuest.getCurrentLocation().getActors();return e=e.filter(e=>!e.isPlayer()&&e.hasNone(["QuestGiver","QuestTarget"])),this.rng.arrayGetRand(e)}getActorForReport(){const e=this.currQuest.getCurrentLocation().getActors();return this.getActorForQuests(e)}getActorToSpy(){const e=this.currQuest.getCurrentLocation().getActors();return this.getActorForQuests(e)}getActorToListen(){const e=this.currQuest.getCurrentLocation();return this.getActorForQuests(e.getActors())}getActorToEscort(e){const t=this.currQuest.getCurrentLocation();return this.getActorForQuests(t.getActors())}dbg(e){if(this.debug){const t="==".repeat(this.IND);i(t+e)}}getAlreadyOwnedItem(){const e=this.currQuest.getCurrentLocation().getPlayer();if(e){const t=e.getInvEq().getInventory().getItems();return this.rng.arrayGetRand(t)}return null}getItemToSteal(){const e=this.currQuest.getCurrentLocation(),t=new p.ItemBase(f.Names.getItemToStealName());t.setValue(b.getUniformInt(100,200)),t.setWeight(.1*b.getUniformInt(1,25));let s=h.Placer.addEntityToCellType(t,e,e=>e.hasHouse());return s||(s=h.Placer.addEntityToCellType(t,e,e=>e.isFree())),s?(this._cleanup.push({location:e,item:t,tag:"getItemToSteal"}),t):null}getItemToGather(){const e=this.currQuest.getCurrentLocation(),t=d.ObjectShell.getParser().createRandomItem(e=>"mineral"===e.type&&e.value<=150);return h.Placer.addEntityToCellType(t,e,e=>e.isPassable())?(this._cleanup.push({location:e,item:t,tag:"getItemToGather"}),t):null}getReadTarget(e,t){return{createTarget:"createBook",args:[this.currQuest.getCurrentLocation(),e,t]}}getItemToUse(){const e=this.currQuest.getCurrentLocation(),t=e.getItems().filter(e=>e.hasOwnProperty("useItem"));if(t.length>0)return this.rng.arrayGetRand(t);const s=d.ObjectShell.getParser().createRandomItem(e=>e.use);return h.Placer.addEntityToCellType(s,e,e=>e.isPassable())&&s?(this._cleanup.push({location:e,item:s,tag:"getItemToUse"}),s):null}getRepairTarget(){const e=this.currQuest.getCurrentLocation().getElements().filter(e=>"door"===e.getType()||"leverdoor"===e.getType()||"lever"===e.getType());if(e.length>0){return this.rng.arrayGetRand(e)}return null}getEntityToDamage(){const e=this.currQuest.getCurrentLocation(),t=e.getElements().filter(e=>"door"===e.getType());if(t){return this.rng.arrayGetRand(t)}const s=e.getActors();return s.length>0?this.rng.arrayGetRand(s):null}getEntityToDefend(){const e=this.currQuest.getCurrentLocation().getActors();return e.length>0?this.rng.arrayGetRand(e):null}getActorToCapture(){const e=this.currQuest.getCurrentLocation().getActors();return this.getActorForQuests(e)}getItemToExchange(){const e=this.currQuest.getCurrentLocation().getElements().filter(e=>"shop"===e.getType());for(this.rng.shuffle(e);e.length>0;){const t=e[0].getCell();if(t.hasItems()){const e=t.getItems().filter(e=>e.has("Unpaid"));if(e.length>0)return e[0]}e.shift()}return null}getNewLocation(e,t){this.flags.alreadyKnowIt&&(this.flags.alreadyKnowIt=!1);let s=t.getZones();s=s.filter(e=>"battlezone"!==e.getType());const[n,r]=e.getTileXY(),a=s.filter(e=>{const t=e.getTileXY(),[s,a]=l.default.dXdY([n,r],t);return s<=10&&a<=10});a.length>1&&(s=a);let o=this.rng.arrayGetRand(s);if(s.length>1)for(;o.getID()===e.getID();)o=this.rng.arrayGetRand(s);return this.addQuestPopulData("zone",o),this.rng.arrayGetRand(o.getLevels())}getNewExploreLocation(e,t){const s=t.getZones("Dungeon"),n=t.getZones("Mountain"),r=s.concat(n),a=new c.RandomCyclic(r);if(r.length>0){let t=a.next(),s=20;for(;t.getID()===e.getID()&&(t=a.next(),0!=--s););return this.addQuestPopulData("zone",t),t.getLevels()[0]}return null}getExploreTarget(){const e=this.getQuestPopulData("zone").getLevels();let t=null;return e.forEach(e=>{if(!t){const s=e.getElements();t=s.find(e=>"exploration"===e.getType())}}),t}addQuestComponents(e){for(let t=this.questList.length-1;t>=0;t--){const s=this.questList[t];s.resetIter(),s.keys().forEach(e=>{if(E.legalKeys.has(e)){let t=s.next(e);for(;t;){if(l.default.isEntity(t))this.setAsQuestTarget(e,t);else if(t.createTarget){const{createTarget:n,args:r}=t;"function"!=typeof this[n]&&l.default.err("QuestPopulate","addQuestComponents",n+" not a func in QuestPopulate");const a=this[n](t,...r);this.setAsQuestTarget(e,a),s.replaceTarget(e,t,a)||l.default.err("QuestPopulate","addQuestComponents","Failed to repl obj for "+n)}t=s.next(e)}}else l.default.err("QuestPopulate","addQuestComponents",`Unsupported key |${e}| found`)});const n=this.rng.arrayGetRand(e.getLevels()),r=this.getActorForQuests(n.getActors()),a=new m.QuestGiver(s.getDescr());this.addTargetsToGiver(a,s),a.setReward({type:"generate"}),r.add(a),this.addUniqueName(r);const o={topic:"quests",respMsg:r.getName()+" could have some work for you",revealNames:[r.getName()],revealIds:[r.getID()]};n.get("Lore").addEntry(o);const i=r;this.questGivers.set(s,i)}}addTargetsToGiver(e,t){const s=e.getQuestID();this.dbg("addTargetsToGiver now, ID "+s),++this.IND;t.getPathTargets().forEach(t=>{if(l.default.isEntity(t)){const n=t;this._checkTargetValidity(n);const r=n.get("QuestTarget");if(r){const[t,n]=[r.getTarget(),r.getTargetType()];e.addTarget(n,t),r.setQuestID(s)}else{const e=JSON.stringify(t);l.default.err("QuestPopulate","addTargetsToGiver","No QuestTarget found from target "+e)}}}),--this.IND}_checkTargetValidity(e){if(!l.default.isEntity(e)){const t="Non-Entity given: "+JSON.stringify(e);l.default.err("QuestPopulate","_checkTargetValidity",t)}}setAsQuestTarget(e,t){if(!t){const t=`Null/undef target with key |${e}|`;l.default.err("QuestPopulate","setAsQuestTarget",t)}if("function"!=typeof t.getID){let s=`questTarget without getID() given with key ${e}:`;s+=" "+JSON.stringify(t),l.default.err("QuestPopulate","setAsQuestTarget",s)}const s=m.create("QuestTarget");s.setTargetType(e),s.setTarget(t),s.setTargetID(t.getID()),t.add(s),(l.default.isActor(t)||l.default.isItem(t))&&this.addUniqueName(t),this.questTargetCallback[e]&&this.questTargetCallback[e](t)}handleEscort(e){const t=this.popQuestCrossRef(e);if(t){const s=m.create("QuestEscortTarget");s.setEscortTo(t),e.add(s)}else this.dumpInternalData("handleEscort"),this.errorQuestHandle(e,"handleEscort")}handleRepair(e){e.add(m.create("Broken"))}handleListen(e){const t=m.create("QuestInfo");t.setQuestion("Can you tell me something to report?"),t.setInfo("Generate something to report"),t.setGivenBy(e.getID()),e.add(t)}handleReport(e){const t=m.create("QuestReport"),s=this.popQuestCrossRef(e);s&&t.setExpectInfoFrom(s.getID()),e.add(t)}handleSubQuest(e){const t=e.get("QuestTarget"),s=e.get("QuestGiver");if(t&&s)t.setSubQuestID(s.getQuestID());else{const t=JSON.stringify(e);l.default.err("QuestPopulate","handleSubQuest","Target must have QuestTarget + Giver comps: "+t)}}addUniqueName(e){if(!e.has("Named")){const t=m.create("Named");e.getName&&t.setName(e.getName()),e.add(t)}const t=e.get("Named");if(l.default.isActor(e)){t.setUniqueName(f.Names.getActorName());const s=e.getName(),n=s[0];l.default.addCharStyle(l.default.TYPE_ACTOR,s,n),l.default.addCellStyle(l.default.TYPE_ACTOR,s,"cell-actor-unique")}else if(l.default.isItem(e)){const e="Quest item "+this.rng.getUniformInt(0,1e6);t.setUniqueName(e)}}createBattle(e,t,s){const n=s.getZones("BattleZone");if(n.length>0){return this.rng.arrayGetRand(n).getLevels()[0]}{const e={areaTile:s,zone:t};if(this.pool.emitEvent(l.default.EVT_CREATE_BATTLE,e),e.response){console.log("createBattle return eventArgs.response.level");const{battle:t}=e.response;if(t)return t.getLevel()}else l.default.err("QuestPopulate","createBattle","No response in eventArgs for EVT_CREATE_BATTLE")}return null}createBook(e,t){const s=new p.Book(f.Names.getBookName()),n=this.popQuestCrossRef(e);if(n){t.addItem(s);const e=l.default.formatLocationName(n),r=["To proceed on your quest:"];return r.push("You should go to place called "+e),s.setText(r),s.addMetaData("place",{levelID:n.getID(),name:e}),s}{const e=JSON.stringify(this._questCrossRefs);l.default.err("QuestPopulate","createBook","No cross-refs set for book. refs: "+e)}return null}createSubQuestTarget(e){const{subQuest:t}=e;return this.questGivers.get(t)}_checkQuestFlags(){let e=!0;return Object.keys(this.flags).forEach(t=>{!1!==this.flags[t]&&(e=!1,console.log("Flag ",t,"still true!"))}),e}cleanUpFailedQuest(){let e=0;this._cleanup.forEach(t=>{const{location:s}=t;let n=!1,r=null;if(t.item){const[e,a]=t.item.getXY();r=t.item;try{n=s.removeItem(t.item,e,a)}catch(n){const{tag:r}=t,o=t.item.getName(),i=s.getItems().map(e=>e.toString());let c=`Failed to cleanup item ${o} @ ${e},${a}`;r&&(c+="\nTag specified: |"+r+"|"),c+="\n"+n.message,c+="\nItems at loc: "+i,l.default.err("QuestPopulate","cleanUpFailedQuest",c)}}else if(t.actor){const[e,a]=t.actor.getXY();n=s.removeActor(t.actor),r=t.actor}else if(t.element){const[e,a]=t.element.getXY();n=s.removeElement(t.element,e,a),r=t.element}n&&++e}),e!==this._cleanup.length&&l.default.warn("QuestPopulate","cleanUpFailedQuest","Did not remove all quest items for failed quest"),this._cleanup=[]}errorQuestHandle(e,t){let s="Failed to get location for escort: ";s+="\n\ttarget: "+e.getName(),s+="\n\tcrossRefs: "+JSON.stringify(Object.values(this._questCrossRefs.entries())),l.default.err("QuestPopulate",t,s)}dumpInternalData(e){"undefined"!=typeof window&&(window.QUEST_GEN=this)}}t.QuestPopulate=E;const S=new Set(["damage","escort","<get>gather","give","<kill>kill","<goto>already_there","<goto>explore","<goto>goto","<learn>already_know_it","<learn>read","listen","<report>listen","report","<steal>stealth","<steal>take","take","<subquest>goto","finishbattle","winbattle"]);function w(e){return e.has("Corporeal")&&l.default.ALL_RACES.indexOf(e.getType())>=0&&!(e.isPlayer()||e.has("QuestTarget")||e.has("QuestGiver"))}E.legalKeys=new Set(["defend","capture","explore","kill","location","listen","give","report","reportListen","get","steal","use","repair","damage","winbattle","finishbattle","escort","spy","exchange","read","experiment","subquest"])},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RandomCyclic=void 0;const r=n(s(0)),a=s(1).Random.getRNG();t.RandomCyclic=class{constructor(e){e&&0!==e.length||r.default.err("RandomCyclic","new","array with length > 0 must be given"),this.arr=e,this.reset(),this.length=e.length}reset(){this.indicesLeft=[],this.arr.forEach((e,t)=>{this.indicesLeft.push(t)}),this._prevValue=null,this._currValue=null}prev(){return this._prevValue}next(){0===this.indicesLeft.length&&this.reset();const e=a.arrayGetRand(this.indicesLeft);return this.indicesLeft=this.indicesLeft.filter(t=>t!==e),this._prevValue=this._currValue,this._currValue=this.arr[e],this._currValue}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LevelFactory=void 0;const r=s(482),a=s(483),o=s(484),i=s(485),l=n(s(0));class c{constructor(e){this.fact=e,this.createFunc={}}addFunction(e,t){this.createFunc[e]=t}create(e,t){if(c.levels.hasOwnProperty(e)){const s=c.levels[e](...t);return Array.isArray(s)?s:[{level:s,nLevel:0}]}if(this.createFunc.hasOwnProperty(e)){const s=this.createFunc[e](...t);return Array.isArray(s)?s:[{level:s,nLevel:0}]}if(this.fact){return[{level:this.fact.createLevel(e,...t),nLevel:0}]}return l.default.err("LevelFactory","create","No factory/factory function given. Name: "+e),null}}t.LevelFactory=c,c.levels={Capital:(...e)=>new o.Capital(...e).getLevel(),DwarvenCity:(...e)=>new i.DwarvenCity(...e).getLevel(),AbandonedFort:(...e)=>new r.AbandonedFort(...e).getLevel(),BlackTower:(...e)=>new a.BlackTower(...e).getLevels()}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.AbandonedFort=t.abandonedFortConf=void 0;const o=s(64),i=s(45),l=s(19),c=s(6),u=s(10),h=s(62),d=a(s(7)),f=s(90),g=s(21),p=s(4),m=s(18);t.abandonedFortConf={outerColsRatio:.4,outerRowsRatio:.4,outerStartXRatio:.4,mountainWallRatio:.3,castleRowsRatio:.6,castleColsRatio:.6};t.AbandonedFort=class{constructor(e,s,n){n||(n=t.abandonedFortConf);const r=n.outerColsRatio||.4,a=n.outerRowsRatio||.4,l=n.outerStartXRatio||.4,u=n.mountainWallRatio||.3,h={meanWx:Math.floor(u*e),stdDev:10,filterW:7,north:!0,south:!0,east:!1,west:!1,alignHorizontal:"right"},y=this.createLevel("mountain",e,s,{nRoadTurns:0,snowRatio:.3}),_=y.getMap(),b=new g.MapGenerator,v={startRoomFunc:f.Castle.startRoomFuncWest},E=Math.round(r*e),S=Math.round(a*s),w=b.createCastleWall(E,S,v),C=Math.round(l*e),T=Math.round(s/2-w.map.rows/2);p.Geometry.mergeMapBaseElems(_,w.map,C,T);const O=Math.floor(e/2),A=this.createLevel("wall",O,s,h),M=e-A.getMap().cols;g.MapGenerator.addRandomSnow(A.getMap(),.3),p.Geometry.mergeLevels(y,A,M,0);const N=this.getCastleLevel(s,e,n),P=e-N.getMap().cols,D=Math.round((s-N.getMap().rows)/2);p.Geometry.mergeLevels(y,N,P,D);const I=Math.floor(s/2),L=new d.ElementStairs("stairsUp",y);y.addStairs(L,0,I);const x=N.getMap().rows,k=N.getMap().cols;let R=D,B=D+(x-1);R+=7,B-=7;const F=_.getFirstFreeFromRight(R,B),[G,W]=[F.getX(),F.getY()],Y=new d.ElementStairs("stairsDown",y);y.addStairs(Y,G,W);const j=m.BBox.fromBBox({ulx:P,uly:D,lrx:P+k-1,lry:D+x-1}),X=c.ObjectShell.getParser(),U=new i.FactoryItem,$=_.getFreeInBbox(j);U.addItemsToCells(y,X,$,{itemsPerLevel:50,nLevel:0,item:e=>e.value>=100&&e.value<=200,maxValue:500});const V={"Mighty raven":!0,"Winter demon":!0,Cryomancer:!0,"Ice djinn":!0,Stormrider:!0,"Snow leopard":!0},H={actorsPerLevel:500,actor:e=>V.hasOwnProperty(e.name),maxDanger:10};(new o.FactoryBase).addNRandActors(y,X,H),this.createPathToFort(y,P),this.level=y}getCastleLevel(e,t,s){const n=s.castleRowsRatio||.6,r=s.castleColsRatio||.6,a=Math.floor(n*e),o=Math.floor(r*t),i={tilesX:Math.round(o/7),tilesY:Math.round(a/7),roomCount:200,startRoomFunc:f.Castle.startRoomFuncWest};return this.createLevel("castle",o,a,i)}createLevel(e,t,s,n){return(new l.FactoryLevel).createLevel(e,t,s,n)}createPathToFort(e,t){const s=e.getMap(),n=t+1,r=Math.floor(s.rows/2),a=Math.floor(s.rows/2);this.createVariedPath(s,{x0:0,x1:n,y0:r,y1:a})}createVariedPath(e,t){const{x0:s,y0:n,x1:r,y1:a}=t;let o=[];for(let t=s;t<r;t+=20){let s=t+20;s>r&&(s=r);const i=u.Path.getMinWeightPath(e,t,n,s,a);o=o.concat(i)}h.Builder.addPathToMap(e,o)}getLevel(){return this.level}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BlackTower=void 0;const r=n(s(0)),a=s(213),o=s(21),i=s(220),l=s(4),c=s(19);t.BlackTower=class{constructor(e,t,s={}){this.nLevels=s.nLevels||5,this.cols=e||100,this.rows=t||50,this.tileSize=s.tileSize||9,this.tilesX=Math.round(this.cols/9),this.tilesY=Math.round(this.rows/9),this.conf=s}getLevels(){const e=new o.CastleGenerator,t={wallType:"wallice",genParams:[2,2,2,2],nGates:2,roomCount:-1,tilesX:this.tilesX,tilesY:this.tilesY},s=[e.createLevel(this.cols,this.rows,t)];delete t.nGates;for(let n=0;n<this.nLevels-2;n++)s.push(e.createLevel(this.cols,this.rows,t));const[n,r]=[Math.round(this.tilesX/2),Math.round(this.tilesY/2)];t.callbacks={};t.callbacks.afterInit=e=>{a.Vault.templates.all.forEach(t=>{e.addTemplate(t)}),a.Vault.func.createHugeVault(n-1,r-2,e,"vault_center1","entrance_n")};const i=e.createLevel(this.cols,this.rows,t);return s.push(i),this.generateYard(s),this.addProps(s),s.forEach((t,s)=>{e.removeMarkers(t,{markersPreserved:!1,shouldRemoveMarkers:!0});const n={maxDanger:this.getDanger(s)+5,actorFunc:e=>"WinterBeingBase"===e.base};e.populateStoreRooms(t,n)}),s.map((e,t)=>({nLevel:t,level:e}))}getDanger(e){return 7+3*e}addProps(e){const t=new i.FactoryZone;e.forEach((e,s)=>{const n=this.getDanger(s),a={nLevel:s,minValue:50+10*s,maxValue:65+20*(s+1),sqrPerItem:200,sqrPerActor:40-2*s,maxDanger:n,actor:e=>"WinterBeingBase"===e.base};t.addItemsAndActors(e,a);e.getActors().forEach(e=>{const t=e.get("Experience");if(t){const s=t.getDanger(),a=n-s,o=t.getExpLevel(),i=o+a;i>o&&r.default.levelUpActor(e,i)}})})}generateYard(e){const t=e[0],[s,n]=t.getColsRows(),r=Math.round(1.4*n),a=Math.round(1.4*s),o=(new c.FactoryLevel).createLevel("arctic",a,r),i=Math.round((a-s)/2),u=Math.round((r-n)/2);l.Geometry.mergeLevels(o,t,i,u),o.getExtras().connectEdges=!0,e[0]=o}}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Capital=void 0;const i=o(s(0)),l=s(30),c=s(10),u=s(62),h=s(6),d=a(s(7)),f=s(19),g=s(4),p=s(21);t.Capital=class{constructor(e,t,s={}){i.default.isNullOrUndef([e,t])&&i.default.err("Capital","constructor","Use new Capital(cols, rows, conf?)");const n={meanWy:Math.floor(.9*t/2),stdDev:10,filterW:7};s.transpose&&(n.north=!0,n.south=!0,n.east=!1,n.west=!1,n.meanWx=Math.floor(.9*e/2));const r=(new f.FactoryLevel).createLevel("wall",e,t,n),a=r.getMap(),o=[.03,.2,.75,.95],m=[.5,.8,.6],y=h.ObjectShell.getParser(),_=e=>"Hyrkhian townsfolk"===e.name,b=[{actorFunc:_,nShops:2,parser:y,nGates:2,hasWall:!0},{actorFunc:_,nShops:5,parser:y,nGates:2,hasWall:!0},{actorFunc:_,nShops:2,parser:y,nGates:2,hasWall:!0}],v=[];for(let n=0;n<o.length-1;n++){const r=Math.floor(t*o[n]);let a=Math.floor(t*o[n+1])-r,i=Math.floor(m[n]*e);if(s.transpose){const s=Math.floor(e*o[n]);i=Math.floor(e*o[n+1])-s,a=Math.floor(m[n]*t)}b[n].nHouses=Math.floor(i*a/500),b[n].floorType="cave",b[n].wallType="castle",b[n].addWindows=!0;const l=(new p.CityGenerator).create(i,a,b[n]);v.push(l)}const E={x:0,y:Math.floor(o[0]*e),centerX:!0};if(s.transpose&&(E.centerY=!0,E.centerX=!1,E.y=0,E.x=Math.floor(o[0]*t)),g.Geometry.tileLevels(r,v,E),s.transpose){const s=Math.floor(t/2),n=new d.ElementStairs("stairsUp",r);r.addStairs(n,0,s);const o=new d.ElementStairs("stairsUp",r);r.addStairs(o,e-1,s);const i=c.Path.getMinWeightPath(a,0,s,e-1,s);u.Builder.addPathToMap(a,i)}else{const s=Math.floor(e/2),n=new d.ElementStairs("stairsUp",r);r.addStairs(n,s,0);const o=new d.ElementStairs("stairsUp",r);r.addStairs(o,s,t-1);const i=c.Path.getMinWeightPath(a,s,0,s,t-1,c.Path.getShortestPassablePathWithDoors);u.Builder.addPathToMap(a,i)}const S={footman:100,archer:50,elite:25,commander:5},w=[];Object.keys(S).forEach(e=>{const t="Hyrkhian "+e,s=S[e];for(let e=0;e<s;e++){const e=y.createActor(t);w.push(e)}});for(let e=0;e<3;e++){const e=y.createActor("trainer");w.push(e)}l.Placer.addPropsToFreeCells(r,w);const C=[y.createItem("Longsword")];l.Placer.addPropsToFreeCells(r,C),this.level=r}setConfig(){}getLevel(){return this.level}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DwarvenCity=t.dwarvenCityConf=void 0;const n=s(19),r=s(90),a=s(30),o=s(11),i=s(7),l=s(21),c=s(4),u=s(8),h=s(6),d=s(486),f=s(18),g={outerColsRatio:.45,outerRowsRatio:.4,outerStartXRatio:.3,cols:300,rows:250};t.dwarvenCityConf=g;t.DwarvenCity=class{constructor(e,t,s=g){const r={meanWy:Math.floor(.85*t/2),stdDev:10,filterW:7},a=new n.FactoryLevel,o=a.createLevel("wall",e,t,r),i=s.outerColsRatio||.35,l=s.outerRowsRatio||.35;let u=Math.round(i*e),h=Math.round(l*t);u=this.adjustToTileSize(u),h=this.adjustToTileSize(h);const d=this.createEntryFortLevel(u,h),p=u+14,m=h+14,y=this.createMainFortLevel(p,m),_=m+h,b=Math.ceil((e-y.getMap().cols)/2),v=e-b,E={centerY:!1,centerX:!0,y:10,x:0},S=[y,d,a.createLevel("empty",14,50)];c.Geometry.tileLevels(o,S,E);const w=f.BBox.fromBBox({ulx:b,uly:10,lrx:v,lry:_});this.addItemsAndActors(o,w),this.addStairsToLevel(e,t,o),this.level=o}adjustToTileSize(e){for(;e%7!=0;)++e;return e%14==0&&(e+=7),e}createMainFortLevel(e,t){const s={startRoomFunc:r.Castle.startFuncFourGates},n=new l.MapGenerator,a=n.createCastleWall(e,t,s),i=e-42,h=t-28,f=n.createCastle(i,h,{roomCount:-1,nGates:2});c.Geometry.mergeMapBaseElems(a.map,f.map,21,14);const g=new o.Level(a.map),p=n.createCastle(49,35,{startRoomFunc:r.Castle.startRoomFuncEast,roomCount:-1,genParams:[1,1,1,1]}),m=n.createCastle(49,35,{startRoomFunc:r.Castle.startRoomFuncWest,roomCount:-1,genParams:[1,1,1,1]}),y=[new o.Level(p.map),g,new o.Level(m.map)],_={centerY:!0,baseElem:u.ELEM.WALL};return d.LevelUtils.wrapAsLevel(y,_)}createEntryFortLevel(e,t){const s=new l.MapGenerator,n={startRoomFunc:r.Castle.startFuncFourGates},a=s.createCastleWall(e,t,n),i=e-42,h=t-42,f=s.createCastle(i,h,{nGates:2,roomCount:-1});new o.Level(f.map);c.Geometry.mergeMapBaseElems(a.map,f.map,21,21);const g=s.createCastleWall(21,21,{startRoomFunc:r.Castle.startRoomFuncEast}),p=s.createCastleWall(21,21,{startRoomFunc:r.Castle.startRoomFuncWest}),m=new o.Level(a.map),y=[new o.Level(g.map),m,new o.Level(p.map)],_={centerY:!0,baseElem:u.ELEM.WALL};return d.LevelUtils.wrapAsLevel(y,_)}addItemsAndActors(e,t){const s=h.ObjectShell.getParser(),n=e.getMap().getFreeInBbox(t),r={fighter:200,axeman:100,elite:50,rifleman:50,commander:20},o=[];Object.keys(r).forEach(e=>{const t="dwarven "+e,n=r[e];for(let e=0;e<n;e++){const e=s.createActor(t);o.push(e)}}),a.Placer.addPropsToCells(e,n,o)}getLevel(){return this.level}addStairsToLevel(e,t,s){const n=Math.floor(e/2),r=new i.ElementStairs("stairsUp",s);s.addStairs(r,n,0);const a=new i.ElementStairs("stairsUp",s);s.addStairs(a,n,t-1)}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelUtils=void 0;const n=s(11),r=s(35),a=s(8),o=s(4);t.LevelUtils={},t.LevelUtils.wrapAsLevel=function(e,t){const s=(e,t)=>Math.max(e,t),i=e.map(e=>e.getMap().cols),l=e.map(e=>e.getMap().rows);let c=null,u=null;const h=t.baseElem||a.ELEM.FLOOR;if(t.centerY){const t=l.reduce(s),a=i.reduce((e,t)=>e+t,0);c=new r.CellMap(a,t,h),u=new n.Level(c),o.Geometry.tileLevels(u,e,{centerY:!0,x:0,y:0})}else if(t.centerX){const t=l.reduce((e,t)=>e+t,0),a=i.reduce(s);c=new r.CellMap(a,t,h),u=new n.Level(c),o.Geometry.tileLevels(u,e,{centerX:!0,x:0,y:0})}return u}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DungeonFeatures=void 0;const i=o(s(0)),l=a(s(27)),c=s(7),u=s(1),h=s(6),d=s(15),f=u.Random.getRNG();t.DungeonFeatures=class{constructor(e){this._verif=new l.Conf("DungeonFeatures"),this._zoneType=e}addLastLevelFeatures(e,t,s){this._verif.verifyConf("addLastLevelFeatures",s,["maxDanger","maxValue"]);const n=new c.ElementExploration,r=10*(e+1)*s.maxDanger;Number.isInteger(r)||i.default.err("DungeonFeatures","addLastLevelFeatures",`expPoints NaN. nLevel: ${e}, dang: ${s.maxDanger}`),n.setExp(r),n.setData({zoneType:this._zoneType});const a=t.getParent();a&&a.getName&&n.addData("zoneName",a.getName());const o=t.getExtras();if(o&&o.endPoint){const[e,s]=o.endPoint;t.addElement(n,e,s)}else{const e=t.getFreeRandCell();if(e){const[s,r]=e.getXY();t.addElement(n,s,r)}else i.default.err("DungeonFeatures","addLastLevelFeatures","Failed to find a free cell for ending element")}const l=this.generateBoss(e,t,s);if(l)this.addMinions(l,e,t,s);else{let s="Failed to created boss. nLevel: "+e;s+=" Level parent: "+t.getParent(),i.default.debug({},s)}}generateBoss(e,t,s){this._verif.verifyConf("generateBoss",s,["maxDanger","maxValue"]);const n=h.ObjectShell.getParser(),r=s.maxDanger+2,a=n.createRandomActor({func:e=>e.danger<=r&&e.danger>=s.maxDanger});if(a){t.addActorToFreeCell(a);const e=2*s.maxValue,r=n.createRandomItem({func:t=>t.value<=e});if(r)a.getInvEq().addItem(r);else{const t="Value: "+e;i.default.err("DungeonFeatures","generateBoss","Failed to create prize item: "+t)}}return a}addMinions(e,t,s,n){const r=h.ObjectShell.getParser(),a=e.getType(),o=f.getUniform()<=.5;let i=t+1,l=n.maxDanger;o&&(i*=2,l-=1);const c=Math.round(Math.sqrt(i))+1,u=d.Brain.getBoxOfFreeCellsAround(e,c);f.shuffle(u);const g=e=>e.danger<=l&&e.type===a;for(;u.length>0&&i>0;){const e=u.pop();--i;const t=r.createRandomActor({func:g});if(t){const[n,r]=[e.getX(),e.getY()];s.addActor(t,n,r)}}}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WinCondition=void 0;const r=n(s(0));t.WinCondition=class{constructor(e,t){this._name=e,this.description="",this._condIncomplete={},this._condFilled={},this.pool=t,this._isTrue=!1,this.hasNotify=!0,this._notifyCallbacks={[r.default.EVT_ACTOR_KILLED]:this.actorKilledCallback.bind(this)}}getName(){return this._name}setPool(e){e!==this.pool&&this.pool.isListener(this)&&this.pool.removeListener(this),this.pool=e}isTrue(){return this._isTrue}addNotifyCallback(e,t){this._notifyCallbacks[e]=t}notify(e,t){this._notifyCallbacks.hasOwnProperty(e)&&this._notifyCallbacks[e](t),this._isTrue||0===Object.keys(this._condIncomplete).length&&(this._isTrue=!0,this.onTrue())}_addEvent(e){this.pool.listenEvent(e,this)}addActorKilled(e){this._addEvent(r.default.EVT_ACTOR_KILLED),this._condIncomplete[r.default.EVT_ACTOR_KILLED]=[e.getID()]}onTrue(){let e=`Condition: ${this._name}, Description: ${this.description}.`;e+="Congratulations. You have won!",r.default.gameSuccess(e),this.pool.emitEvent(r.default.EVT_WIN_COND_TRUE,{name:this._name})}actorKilledCallback(e){const t=e.actor,s=this._condIncomplete[r.default.EVT_ACTOR_KILLED];if(s){const e=s.indexOf(t.getID());e>=0&&(s.splice(e,1),0===s.length&&delete this._condIncomplete[r.default.EVT_ACTOR_KILLED])}}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Disposition=void 0;const r=n(s(0)),a=s(1).Random.getRNG();t.Disposition=class{constructor(e,t){this.rivals=e,this.conf=Object.assign({},t),this.weights={default:{ally:20,neutral:50,enemy:30}}}setWeights(e){this.weights=e}addWeight(e,t){this.weights[e]=t}getTable(){return this.dispTable}_initTable(){this.dispTable={},this.rivals.forEach(e=>{this.dispTable[e]={}})}randomize(){this._initTable(),this.rivals.forEach(e=>{this.rivals.forEach(t=>{if(!this.pairDone(e,t)){const s=this.getWeights(e,t),n=a.getWeighted(s);this.dispTable[e][t]=n,this.dispTable[t][e]=n}})})}getWeights(e,t){return this.weights.hasOwnProperty(e)?this.weights[e]:this.weights.hasOwnProperty(t)?this.weights[t]:this.weights.default}pairDone(e,t){return e===t||!!this.dispTable[e][t]&&(this.dispTable[t][e]||r.default.err("Disposition","pairDone","Something went wrong. No [r2][r1] but [r1][r2] exists"),!0)}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LevelGen=void 0;const r=n(s(0)),a=s(63),o=s(138),i=s(1).Random.getRNG();t.LevelGen={};t.LevelGen.getDungeonConf=e=>{let t=function(e){switch(e){case"Grotto":case"Cavern":case"Lair":return"Cave";case"Catacombs":case"Tombs":return"Crypt";case"Cells":return"Dungeon";default:return e}}(e);const s=function(e){switch(e){case"Cave":return 1;case"Crypt":return 2;case"Dungeon":return 3;case"Labyrinth":return 1;default:return 3}}(t),n=function(e){switch(e){case"Cave":return{actor:[{op:"eq",prop:"type",value:["animal","goblin","beast"]}]};case"Crypt":return{actor:[{op:"eq",prop:"type",value:"undead"}]};default:return null}}(t),[r,a]=function(e){const t=[80,40];switch(e){case"Cave":return[80,50];case"Cavern":return[200,200];case"Grotto":return[120,60];case"Lair":return[200,150];case"Cells":case"Dungeon":return[100,50];case"Labyrinth":return[100,100];case"Maze":return[80,50];case"Crypt":return t;case"Tombs":return[100,100];case"Catacombs":return[140,60];default:return t}}(e);t=t.toLowerCase();const o={name:e,dungeonX:r,dungeonY:a,dungeonType:t,nBranches:1,branch:[{name:e,nLevels:s,entranceLevel:0}]};return n&&(o.constraint=n),o},t.LevelGen.getMountainConf=e=>{const[t,s]=[80,240];return{name:e,nFaces:1,face:[{name:e,nLevels:1,entranceLevel:0,x:t,y:s}],nSummits:1,summit:[{name:"Summit",nLevels:1,cols:80,rows:50}],connectLevels:[[e,"Summit",0,0]]}};const l=(e,t)=>{const s=t.maxValue||100,n=t.shopType||"random",a=t.name;if("Market"===a||"Bazaar"===a){const t=i.getUniformInt(1,3);e.nShops=t,e.constraint.shop=[];for(let a=0;a<t;a++){let t=i.arrayGetRand(r.default.SHOP_TYPES);"random"!==n&&0===a&&(t=n);const o=[{op:"eq",prop:"type",value:t},{op:"lte",prop:"value",value:s}];e.constraint.shop.push(o)}}else e.nShops=1};t.LevelGen.getCityConf=(e,t)=>{let s=a.Names.getGenericPlaceName("city");"fort"===t.type?s="Fort":t.capital?s="Capital":"stronghold"===t.type?s="Stronghold":"village"===t.type&&(s=a.Names.getVillageType());const n=(e=>{switch(e){case"Hamlet":case"Village":return 1;case"Town":return 2;case"Fort":return 1;case"Stronghold":return i.getUniformInt(2,4);case"Capital":return i.getUniformInt(3,5);default:return 1}})(s),r=((e,t)=>{const s=[];for(let n=0;n<e;n++){const e={name:a.Names.getGenericPlaceName("quarter"),nLevels:1,constraint:{}};0===n&&(e.entranceLevel=0),l(e,t),s.push(e)}return s})(n,t),c=o.WorldConf.createQuarterConnections(r),u={name:e,nQuarters:n,quarter:r};return c&&(u.connectLevels=c),u}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.OWLore=void 0;const r=n(s(0)),a=s(141),o=s(1),i=s(5)("bitn:ow-lore"),l=o.Random.getRNG();t.OWLore=class{constructor(){this.hasInfoAbout={},this.isKnownBy={},this.xyVisited={},this.zonesByXY={},this.nZones=0,this.nAddedCompsTo=0}getKey(e){return e[0]+","+e[1]}toCoord(e){const t=e.split(",");return[parseInt(t[0],10),parseInt(t[1],10)]}addVisited(e){this.xyVisited[this.getKey(e)]=!0}isVisited(e){return this.xyVisited[this.getKey(e)]}addXYKnownBy(e,t){const s=this.getKey(e),n=this.getKey(t);this.isKnownBy[s]||(this.isKnownBy[s]=[]),this.isKnownBy[s].push(t),this.hasInfoAbout[n]||(this.hasInfoAbout[n]=[]),this.hasInfoAbout[n].push(e)}hasInfoAboutXY(e){return this.hasInfoAbout.hasOwnProperty(this.getKey(e))}addZone(e,t){const s=this.getKey(e);this.zonesByXY[s]||(this.zonesByXY[s]=[]),this.zonesByXY[s].push(t),++this.nZones,i(`addZone ${t.name} to ${s}, nZones: ${this.nZones}`)}buildLore(){Object.keys(this.zonesByXY).forEach(e=>{const t=this.zonesByXY[e],s=this.toCoord(e);this.hasInfoAboutXY(s)&&(t.forEach(t=>{let n=this.hasInfoAbout[e];n=[l.arrayGetRand(n)],n.forEach(e=>{const n=e,o=this.zonesByXY[this.getKey(n)];o&&o.forEach(e=>{const o=e,l=r.default.getTextualDir(n,s),c=this.formatRespMsg(l,o),u=this.getZoneMeta(o),h=a.createLoreObj(c,"sideQuest",u);t.addComp?t.addComp.push(h):t.addComp=[h],++this.nAddedCompsTo,i.enabled&&this.dbg("knowerZone:",t.name,t.x,t.y,JSON.stringify(t.addComp))})})}),t.forEach(t=>{const n=t.isEpic;let o=this.isKnownBy[e];o.length>2&&(o=[l.arrayGetRand(o),l.arrayGetRand(o)]),o.forEach(e=>{const o=this.getKey(e),l=this.zonesByXY[o];l&&l.forEach(o=>{const l=o,c=r.default.getTextualDir(s,e);let u=this.formatRespMsg(c,t);n&&(u+=" They say a great adventure awaits there.");const h=this.getZoneMeta(t),d=a.createLoreObj(u,"location",h);l.addComp?l.addComp.push(d):l.addComp=[d],++this.nAddedCompsTo,i.enabled&&this.dbg("knowerZone:",l.name,l.x,l.y,JSON.stringify(l.addComp))})})}))}),i(`buildLore END. ${this.nAddedCompsTo}/${this.nZones} zones have addComp`)}formatRespMsg(e,t){const s=a.Lore.getRandText("typesDirections"),n=this.getNamePre(t),r=this.getNamePost(t);return a.formatMsg(s,{dir:e,name:t.name,namePre:n,namePost:r})}getNamePre(e){return e.isEpic?"an ancient place called ":""}getNamePost(e){return r.default.isSuccess(.05)?" where shadows lie":""}debugPrint(){i.enabled=!0,i(this.zonesByXY),i.enabled=!1}getZoneMeta(e){const{name:t,x:s,y:n,levelX:r,levelY:a,owX:o,owY:i}=e;return{name:t,x:s,y:n,levelX:r,levelY:a,owX:o,owY:i}}toString(){return"OverWorld Lore:\n"}dbg(...e){i(...e)}}},function(e,t,s){e.exports=function e(t,s,n){function r(o,i){if(!s[o]){if(!t[o]){if(a)return a(o,!0);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}var c=s[o]={exports:{}};t[o][0].call(c.exports,(function(e){return r(t[o][1][e]||e)}),c,c.exports,e,t,s,n)}return s[o].exports}for(var a=!1,o=0;o<n.length;o++)r(n[o]);return r}({1:[function(e,t,s){"use strict";var n=e("fs"),r=e("path"),a=e("./utils"),o=!1,i=e("../package.json").version,l=["delimiter","scope","context","debug","compileDebug","client","_with","rmWhitespace","strict","filename","async"],c=l.concat("cache"),u=/^\uFEFF/;function h(e,t){var r,a,o=t.views,i=/^[A-Za-z]+:\\|^\//.exec(e);if(i&&i.length)r=s.resolveInclude(e.replace(/^\/*/,""),t.root||"/",!0);else if(t.filename&&(a=s.resolveInclude(e,t.filename),n.existsSync(a)&&(r=a)),r||Array.isArray(o)&&o.some((function(t){return a=s.resolveInclude(e,t,!0),n.existsSync(a)}))&&(r=a),!r)throw new Error('Could not find the include file "'+t.escapeFunction(e)+'"');return r}function d(e,t){var n,r=e.filename,a=arguments.length>1;if(e.cache){if(!r)throw new Error("cache option requires a filename");if(n=s.cache.get(r))return n;a||(t=g(r).toString().replace(u,""))}else if(!a){if(!r)throw new Error("Internal EJS error: no file name or template provided");t=g(r).toString().replace(u,"")}return n=s.compile(t,e),e.cache&&s.cache.set(r,n),n}function f(e,t,n){var r;if(!n){if("function"==typeof s.promiseImpl)return new s.promiseImpl((function(s,n){try{s(r=d(e)(t))}catch(e){n(e)}}));throw new Error("Please provide a callback function")}try{r=d(e)(t)}catch(e){return n(e)}n(null,r)}function g(e){return s.fileLoader(e)}function p(e,t,s,n,r){var a=t.split("\n"),o=Math.max(n-3,0),i=Math.min(a.length,n+3),l=r(s),c=a.slice(o,i).map((function(e,t){var s=t+o+1;return(s==n?" >> ":"    ")+s+"| "+e})).join("\n");throw e.path=l,e.message=(l||"ejs")+":"+n+"\n"+c+"\n\n"+e.message,e}function m(e){return e.replace(/;(\s*$)/,"$1")}function y(e,t){t=t||{};var n={};this.templateText=e,this.mode=null,this.truncate=!1,this.currentLine=1,this.source="",this.dependencies=[],n.client=t.client||!1,n.escapeFunction=t.escape||t.escapeFunction||a.escapeXML,n.compileDebug=!1!==t.compileDebug,n.debug=!!t.debug,n.filename=t.filename,n.openDelimiter=t.openDelimiter||s.openDelimiter||"<",n.closeDelimiter=t.closeDelimiter||s.closeDelimiter||">",n.delimiter=t.delimiter||s.delimiter||"%",n.strict=t.strict||!1,n.context=t.context,n.cache=t.cache||!1,n.rmWhitespace=t.rmWhitespace,n.root=t.root,n.outputFunctionName=t.outputFunctionName,n.localsName=t.localsName||s.localsName||"locals",n.views=t.views,n.async=t.async,n.destructuredLocals=t.destructuredLocals,n.legacyInclude=void 0===t.legacyInclude||!!t.legacyInclude,n.strict?n._with=!1:n._with=void 0===t._with||t._with,this.opts=n,this.regex=this.createRegex()}s.cache=a.cache,s.fileLoader=n.readFileSync,s.localsName="locals",s.promiseImpl=new Function("return this;")().Promise,s.resolveInclude=function(e,t,s){var n=r.dirname,a=r.extname,o=(0,r.resolve)(s?t:n(t),e);return a(e)||(o+=".ejs"),o},s.compile=function(e,t){return t&&t.scope&&(o||(console.warn("`scope` option is deprecated and will be removed in EJS 3"),o=!0),t.context||(t.context=t.scope),delete t.scope),new y(e,t).compile()},s.render=function(e,t,s){var n=t||{},r=s||{};return 2==arguments.length&&a.shallowCopyFromList(r,n,l),d(r,e)(n)},s.renderFile=function(){var e,t,s,n=Array.prototype.slice.call(arguments),r=n.shift(),o={filename:r};return"function"==typeof arguments[arguments.length-1]&&(e=n.pop()),n.length?(t=n.shift(),n.length?a.shallowCopy(o,n.pop()):(t.settings&&(t.settings.views&&(o.views=t.settings.views),t.settings["view cache"]&&(o.cache=!0),(s=t.settings["view options"])&&a.shallowCopy(o,s)),a.shallowCopyFromList(o,t,c)),o.filename=r):t={},f(o,t,e)},s.Template=y,s.clearCache=function(){s.cache.reset()},y.modes={EVAL:"eval",ESCAPED:"escaped",RAW:"raw",COMMENT:"comment",LITERAL:"literal"},y.prototype={createRegex:function(){var e="(<%%|%%>|<%=|<%-|<%_|<%#|<%|%>|-%>|_%>)",t=a.escapeRegExpChars(this.opts.delimiter),s=a.escapeRegExpChars(this.opts.openDelimiter),n=a.escapeRegExpChars(this.opts.closeDelimiter);return e=e.replace(/%/g,t).replace(/</g,s).replace(/>/g,n),new RegExp(e)},compile:function(){var e,t,s,n=this.opts,o="",i="",l=n.escapeFunction;if(!this.source){if(this.generateSource(),o+='  var __output = "";\n  function __append(s) { if (s !== undefined && s !== null) __output += s }\n',n.outputFunctionName&&(o+="  var "+n.outputFunctionName+" = __append;\n"),n.destructuredLocals&&n.destructuredLocals.length){for(var c="  var __locals = ("+n.localsName+" || {}),\n",u=0;u<n.destructuredLocals.length;u++){var f=n.destructuredLocals[u];u>0&&(c+=",\n  "),c+=f+" = __locals."+f}o+=c+";\n"}!1!==n._with&&(o+="  with ("+n.localsName+" || {}) {\n",i+="  }\n"),i+="  return __output;\n",this.source=o+this.source+i}e=n.compileDebug?"var __line = 1\n  , __lines = "+JSON.stringify(this.templateText)+"\n  , __filename = "+(n.filename?JSON.stringify(n.filename):"undefined")+";\ntry {\n"+this.source+"} catch (e) {\n  rethrow(e, __lines, __filename, __line, escapeFn);\n}\n":this.source,n.client&&(e="escapeFn = escapeFn || "+l.toString()+";\n"+e,n.compileDebug&&(e="rethrow = rethrow || "+p.toString()+";\n"+e)),n.strict&&(e='"use strict";\n'+e),n.debug&&console.log(e),n.compileDebug&&n.filename&&(e=e+"\n//# sourceURL="+n.filename+"\n");try{if(n.async)try{s=new Function("return (async function(){}).constructor;")()}catch(e){throw e instanceof SyntaxError?new Error("This environment does not support async/await"):e}else s=Function;t=new s(n.localsName+", escapeFn, include, rethrow",e)}catch(e){throw e instanceof SyntaxError&&(n.filename&&(e.message+=" in "+n.filename),e.message+=" while compiling ejs\n\n",e.message+="If the above error is not helpful, you may want to try EJS-Lint:\n",e.message+="https://github.com/RyanZim/EJS-Lint",n.async||(e.message+="\n",e.message+="Or, if you meant to create an async function, pass `async: true` as an option.")),e}var g=n.client?t:function(e){return t.apply(n.context,[e||{},l,function(t,s){var r=a.shallowCopy({},e);return s&&(r=a.shallowCopy(r,s)),function(e,t){var s=a.shallowCopy({},t);return s.filename=h(e,s),d(s)}(t,n)(r)},p])};if(g.dependencies=this.dependencies,n.filename&&"function"==typeof Object.defineProperty){var m=n.filename,y=r.basename(m,r.extname(m));try{Object.defineProperty(g,"name",{value:y,writable:!1,enumerable:!1,configurable:!0})}catch(e){}}return g},generateSource:function(){var e=this.opts;e.rmWhitespace&&(this.templateText=this.templateText.replace(/[\r\n]+/g,"\n").replace(/^\s+|\s+$/gm,"")),this.templateText=this.templateText.replace(/[ \t]*<%_/gm,"<%_").replace(/_%>[ \t]*/gm,"_%>");var t=this,n=this.parseTemplateText(),r=this.opts.delimiter,o=this.opts.openDelimiter,i=this.opts.closeDelimiter;n&&n.length&&n.forEach((function(l,c){var d,f,p,m,_,b;if(0===l.indexOf(o+r)&&0!==l.indexOf(o+r+r)&&(f=n[c+2])!=r+i&&f!="-"+r+i&&f!="_"+r+i)throw new Error('Could not find matching close tag for "'+l+'".');if(e.legacyInclude&&(p=l.match(/^\s*include\s+(\S+)/))&&(d=n[c-1])&&(d==o+r||d==o+r+"-"||d==o+r+"_"))return m=a.shallowCopy({},t.opts),_=function(e,t){var s,n,r=a.shallowCopy({},t);n=g(s=h(e,r)).toString().replace(u,""),r.filename=s;var o=new y(n,r);return o.generateSource(),{source:o.source,filename:s,template:n}}(p[1],m),b=t.opts.compileDebug?"    ; (function(){\n      var __line = 1\n      , __lines = "+JSON.stringify(_.template)+"\n      , __filename = "+JSON.stringify(_.filename)+";\n      try {\n"+_.source+"      } catch (e) {\n        rethrow(e, __lines, __filename, __line, escapeFn);\n      }\n    ; }).call(this)\n":"    ; (function(){\n"+_.source+"    ; }).call(this)\n",t.source+=b,void t.dependencies.push(s.resolveInclude(p[1],m.filename));t.scanLine(l)}))},parseTemplateText:function(){for(var e,t=this.templateText,s=this.regex,n=s.exec(t),r=[];n;)0!==(e=n.index)&&(r.push(t.substring(0,e)),t=t.slice(e)),r.push(n[0]),t=t.slice(n[0].length),n=s.exec(t);return t&&r.push(t),r},_addOutput:function(e){if(this.truncate&&(e=e.replace(/^(?:\r\n|\r|\n)/,""),this.truncate=!1),!e)return e;e=(e=(e=(e=e.replace(/\\/g,"\\\\")).replace(/\n/g,"\\n")).replace(/\r/g,"\\r")).replace(/"/g,'\\"'),this.source+='    ; __append("'+e+'")\n'},scanLine:function(e){var t,s=this.opts.delimiter,n=this.opts.openDelimiter,r=this.opts.closeDelimiter;switch(t=e.split("\n").length-1,e){case n+s:case n+s+"_":this.mode=y.modes.EVAL;break;case n+s+"=":this.mode=y.modes.ESCAPED;break;case n+s+"-":this.mode=y.modes.RAW;break;case n+s+"#":this.mode=y.modes.COMMENT;break;case n+s+s:this.mode=y.modes.LITERAL,this.source+='    ; __append("'+e.replace(n+s+s,n+s)+'")\n';break;case s+s+r:this.mode=y.modes.LITERAL,this.source+='    ; __append("'+e.replace(s+s+r,s+r)+'")\n';break;case s+r:case"-"+s+r:case"_"+s+r:this.mode==y.modes.LITERAL&&this._addOutput(e),this.mode=null,this.truncate=0===e.indexOf("-")||0===e.indexOf("_");break;default:if(this.mode){switch(this.mode){case y.modes.EVAL:case y.modes.ESCAPED:case y.modes.RAW:e.lastIndexOf("//")>e.lastIndexOf("\n")&&(e+="\n")}switch(this.mode){case y.modes.EVAL:this.source+="    ; "+e+"\n";break;case y.modes.ESCAPED:this.source+="    ; __append(escapeFn("+m(e)+"))\n";break;case y.modes.RAW:this.source+="    ; __append("+m(e)+")\n";break;case y.modes.COMMENT:break;case y.modes.LITERAL:this._addOutput(e)}}else this._addOutput(e)}this.opts.compileDebug&&t&&(this.currentLine+=t,this.source+="    ; __line = "+this.currentLine+"\n")}},s.escapeXML=a.escapeXML,s.__express=s.renderFile,e.extensions&&(e.extensions[".ejs"]=function(e,t){console.log("Deprecated: this API will go away in EJS v2.8");var n=t||e.filename,r={filename:n,client:!0},a=g(n).toString(),o=s.compile(a,r);e._compile("module.exports = "+o.toString()+";",n)}),s.VERSION=i,s.name="ejs","undefined"!=typeof window&&(window.ejs=s)},{"../package.json":6,"./utils":2,fs:3,path:4}],2:[function(e,t,s){"use strict";var n=/[|\\{}()[\]^$+*?.]/g;s.escapeRegExpChars=function(e){return e?String(e).replace(n,"\\$&"):""};var r={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&#34;","'":"&#39;"},a=/[&<>'"]/g;function o(e){return r[e]||e}s.escapeXML=function(e){return null==e?"":String(e).replace(a,o)},s.escapeXML.toString=function(){return Function.prototype.toString.call(this)+';\nvar _ENCODE_HTML_RULES = {\n      "&": "&amp;"\n    , "<": "&lt;"\n    , ">": "&gt;"\n    , \'"\': "&#34;"\n    , "\'": "&#39;"\n    }\n  , _MATCH_HTML = /[&<>\'"]/g;\nfunction encode_char(c) {\n  return _ENCODE_HTML_RULES[c] || c;\n};\n'},s.shallowCopy=function(e,t){for(var s in t=t||{})e[s]=t[s];return e},s.shallowCopyFromList=function(e,t,s){for(var n=0;n<s.length;n++){var r=s[n];void 0!==t[r]&&(e[r]=t[r])}return e},s.cache={_data:{},set:function(e,t){this._data[e]=t},get:function(e){return this._data[e]},remove:function(e){delete this._data[e]},reset:function(){this._data={}}}},{}],3:[function(e,t,s){},{}],4:[function(e,t,s){(function(e){function t(e,t){for(var s=0,n=e.length-1;n>=0;n--){var r=e[n];"."===r?e.splice(n,1):".."===r?(e.splice(n,1),s++):s&&(e.splice(n,1),s--)}if(t)for(;s--;s)e.unshift("..");return e}function n(e,t){if(e.filter)return e.filter(t);for(var s=[],n=0;n<e.length;n++)t(e[n],n,e)&&s.push(e[n]);return s}s.resolve=function(){for(var s="",r=!1,a=arguments.length-1;a>=-1&&!r;a--){var o=a>=0?arguments[a]:e.cwd();if("string"!=typeof o)throw new TypeError("Arguments to path.resolve must be strings");o&&(s=o+"/"+s,r="/"===o.charAt(0))}return(r?"/":"")+(s=t(n(s.split("/"),(function(e){return!!e})),!r).join("/"))||"."},s.normalize=function(e){var a=s.isAbsolute(e),o="/"===r(e,-1);return(e=t(n(e.split("/"),(function(e){return!!e})),!a).join("/"))||a||(e="."),e&&o&&(e+="/"),(a?"/":"")+e},s.isAbsolute=function(e){return"/"===e.charAt(0)},s.join=function(){var e=Array.prototype.slice.call(arguments,0);return s.normalize(n(e,(function(e,t){if("string"!=typeof e)throw new TypeError("Arguments to path.join must be strings");return e})).join("/"))},s.relative=function(e,t){function n(e){for(var t=0;t<e.length&&""===e[t];t++);for(var s=e.length-1;s>=0&&""===e[s];s--);return t>s?[]:e.slice(t,s-t+1)}e=s.resolve(e).substr(1),t=s.resolve(t).substr(1);for(var r=n(e.split("/")),a=n(t.split("/")),o=Math.min(r.length,a.length),i=o,l=0;l<o;l++)if(r[l]!==a[l]){i=l;break}var c=[];for(l=i;l<r.length;l++)c.push("..");return(c=c.concat(a.slice(i))).join("/")},s.sep="/",s.delimiter=":",s.dirname=function(e){if("string"!=typeof e&&(e+=""),0===e.length)return".";for(var t=e.charCodeAt(0),s=47===t,n=-1,r=!0,a=e.length-1;a>=1;--a)if(47===(t=e.charCodeAt(a))){if(!r){n=a;break}}else r=!1;return-1===n?s?"/":".":s&&1===n?"/":e.slice(0,n)},s.basename=function(e,t){var s=function(e){"string"!=typeof e&&(e+="");var t,s=0,n=-1,r=!0;for(t=e.length-1;t>=0;--t)if(47===e.charCodeAt(t)){if(!r){s=t+1;break}}else-1===n&&(r=!1,n=t+1);return-1===n?"":e.slice(s,n)}(e);return t&&s.substr(-1*t.length)===t&&(s=s.substr(0,s.length-t.length)),s},s.extname=function(e){"string"!=typeof e&&(e+="");for(var t=-1,s=0,n=-1,r=!0,a=0,o=e.length-1;o>=0;--o){var i=e.charCodeAt(o);if(47!==i)-1===n&&(r=!1,n=o+1),46===i?-1===t?t=o:1!==a&&(a=1):-1!==t&&(a=-1);else if(!r){s=o+1;break}}return-1===t||-1===n||0===a||1===a&&t===n-1&&t===s+1?"":e.slice(t,n)};var r="b"==="ab".substr(-1)?function(e,t,s){return e.substr(t,s)}:function(e,t,s){return t<0&&(t=e.length+t),e.substr(t,s)}}).call(this,e("_process"))},{_process:5}],5:[function(e,t,s){var n,r,a=t.exports={};function o(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function l(e){if(n===setTimeout)return setTimeout(e,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(e){n=o}try{r="function"==typeof clearTimeout?clearTimeout:i}catch(e){r=i}}();var c,u=[],h=!1,d=-1;function f(){h&&c&&(h=!1,c.length?u=c.concat(u):d=-1,u.length&&g())}function g(){if(!h){var e=l(f);h=!0;for(var t=u.length;t;){for(c=u,u=[];++d<t;)c&&c[d].run();d=-1,t=u.length}c=null,h=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===i||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function m(){}a.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var s=1;s<arguments.length;s++)t[s-1]=arguments[s];u.push(new p(e,t)),1!==u.length||h||l(g)},p.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=m,a.addListener=m,a.once=m,a.off=m,a.removeListener=m,a.removeAllListeners=m,a.emit=m,a.prependListener=m,a.prependOnceListener=m,a.listeners=function(e){return[]},a.binding=function(e){throw new Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(e){throw new Error("process.chdir is not supported")},a.umask=function(){return 0}},{}],6:[function(e,t,s){t.exports={name:"ejs",description:"Embedded JavaScript templates",keywords:["template","engine","ejs"],version:"2.7.4",author:"Matthew Eernisse <mde@fleegix.org> (http://fleegix.org)",license:"Apache-2.0",main:"./lib/ejs.js",repository:{type:"git",url:"git://github.com/mde/ejs.git"},bugs:"https://github.com/mde/ejs/issues",homepage:"https://github.com/mde/ejs",dependencies:{},devDependencies:{browserify:"^13.1.1",eslint:"^4.14.0","git-directory-deploy":"^1.5.1",jake:"^10.3.1",jsdoc:"^3.4.0","lru-cache":"^4.0.1",mocha:"^5.0.5","uglify-js":"^3.3.16"},engines:{node:">=0.10.0"},scripts:{test:"mocha",postinstall:"node ./postinstall.js"}}},{}]},{},[1])(1)},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OWBiomes=void 0;const n=s(8),r=s(494);class a{static addBiomes(e,t){const s=a.debug,n=new r.Noise,l=new r.Noise,c=new r.Noise,u=t.getMap()._map,{cols:h,rows:d}=t.getMap();let f=0;[1,2,4].forEach(e=>{f+=1/e}),console.log("maxElev can be",f);for(let e=0;e<h;e++)for(let t=0;t<d;t++){let r=u[e][t].isFree()?0:5,a=o(e,t,h,d);const f=(c.get(e/10,t/10)+.5*c.get(e/20,t/20))/1.5;r+=n.getOctavesDiv(e,t,[[1,20],[.5,8],[.25,1]]),s&&console.log(e,t,"temp before:",a),a+=.1*l.get(e,t),s&&console.log("temp after:",a),r<5&&u[e][t].setBaseElem(i(r,f,a))}}}function o(e,t,s,n){return t/(n-1)*2-.3*e/(s-1)}function i(e,t,s){return e<.6?s<.85?n.ELEM.WATER_FROZEN:e<.6-.2?n.ELEM.DEEP_WATER:e<.5?n.ELEM.WATER:n.ELEM.SHALLOW_WATER:e<=.6+.3?s<.85?n.ELEM.SNOW:n.ELEM.FLOOR:e>.6+.3&&e<1.2?t<.1?s<.85?n.ELEM.SNOW:n.ELEM.FLOOR:s<.85?n.ELEM.TREE_SNOW:n.ELEM.TREE:e<5?s<.85?e<1.2+.15?n.ELEM.SNOWY_CLIFF:e<1.45?n.ELEM.STONE_SNOW:n.ELEM.FROZEN_STEEP_CLIFF:e<1.2+.15?n.ELEM.CLIFF:e<1.45?n.ELEM.STONE:n.ELEM.STEEP_CLIFF:void 0}t.OWBiomes=a,a.debug=!1},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Noise=void 0;const r=n(s(215));t.Noise=class{constructor(){this.noise=new r.default}get(e,t){return(this.noise.get(e,t)+1)/2}getOctaves(e,t,s){let n=0;return s.forEach(s=>{n+=1/s*this.get(s*e,s*t)}),n}getOctavesDiv(e,t,s){let n=0;return s.forEach(s=>{const[r,a]=s;n+=r*this.get(e/a,t/a)}),n}}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorldFromJSON=void 0;const i=o(s(0)),l=s(221),c=s(65),u=a(s(27)),h=s(92),d=s(5)("bitn:WorldFromJSON"),f=a(s(32));t.WorldFromJSON=class{constructor(e,t){this.id2level=e,this.id2entity=t,this._conf=new l.ConfStack,this._verif=new u.Conf("WorldFromJSON"),this.worldElemByID={},this.createAllZones=!0,this._IND=0}createPlace(e){switch(e.type){case"world":return this.createWorld(e);default:i.default.err("WorldFromJSON","createPlace",`No place ${e.type} implemented yet`)}return null}createWorld(e){let t=null;if(e.conf)this.dbg("Creating a restored world now"),t=this.createRestoredWorld(e);else{i.default.err("WorldFromJSON","Should not be called at all.","ERROR"),this.dbg("Creating world using Factory.World fully");const s=new c.FactoryWorld;s.setId2Level(this.id2level),s.fromJSON=this.fromJSON,t=s.createWorld(e)}return t}createRestoredWorld(e){e.conf||i.default.err("WorldFromJSON","createRestoredWorld","No worldJSON.conf. Does not look like restored world.");const t=this.createWorldFromJSON(e);t.setConf(e.conf);const s=t.getAreas();if(s.length>0){const t=""+Object.keys(e.conf);e.conf.hasOwnProperty("area")||i.default.err("WorldFromJSON","createRestoredWorld",`No prop 'area' in ${e.conf}. Props ${t}`)}return s.forEach((t,s)=>{t.setConf(e.conf.area[s])}),t}pushScope(e){this._conf.pushScope(e),this.fact.pushScope(e),++this._IND}popScope(e){this._conf.popScope(e),this.fact.popScope(e),--this._IND}getHierName(){return this._conf.getScope().join(".")}createWorldFromJSON(e){const t=new c.FactoryWorld;t.setId2Level(this.id2level),t.id2entity=this.id2entity,t.fromJSON=this.fromJSON,this.fact=t,this.verify("createWorld",e,["name","nAreas"]),e.hasOwnProperty("createAllZones")&&(this.createAllZones=e.createAllZones,this.dbg("createAllZones set to "+this.createAllZones),t.createAllZones=this.createAllZones),this.pushScope(e);const s=new f.WorldTop(e.name);s.setConf(e);for(let t=0;t<e.nAreas;t++){const n=e.area[t];d.enabled&&this.printKeys("areaJSON keys",n);const r=this.restoreAreaFromJSON(n);n.zonesCreated&&this.restoreCreatedZones(s,r),s.addArea(r),this.addWorldID(n,r)}return this.popScope(e),this.addWorldID(e,s),s}restoreAreaFromJSON(e){this.verify("restoreAreaFromJSON",e,["name","maxX","maxY"]),this.pushScope(e);const t=this.getAreaLevels(e),{name:s,maxX:n,maxY:r,cols:a,rows:o}=e,i=new f.Area(s,n,r,a,o,t);return i.setConf(e),i.setHierName(this.getHierName()),i.tileStatus=e.tileStatus,i.zonesCreated=e.zonesCreated,this.setTileJSONForUnloadedTiles(i,e),this.createAllZones?(this.fact._createAllZones(i,e),i.markAllZonesCreated()):this.dbg("Skipping the zone creating due to createZones=false"),this.popScope(e),i}restoreCreatedZones(e,t){Object.keys(t.zonesCreated).forEach(s=>{const[n,r]=s.split(","),[a,o]=[parseInt(n,10),parseInt(r,10)];t.zonesCreated[s]&&t.isLoaded(a,o)&&(this.dbg(`\tRestoring created zones for tile ${a},${o}`),this.restoreZonesForTile(e,t,a,o))})}restoreZonesForTile(e,t,s,n){const r=e.getConf();this.pushScope(r);const a=t.getConf();this.pushScope(a),this.fact._createAllZones(t,a,s,n),this.popScope(a),this.popScope(r)}getAreaLevels(e){this.verify("getAreaLevels",e,["tileStatus"]),++this._IND;const t=[];return e.tiles?e.tiles.forEach((s,n)=>{const r=[];s.forEach((t,s)=>{if(e.tileStatus[n][s]===h.LoadStat.LOADED){this.dbg(`Tile ${n},${s} is loaded`);const e=this.id2level[t.level];e?r.push(e):i.default.err("WorldFromJSON","getAreaLevels",`No level ID ${t.level} in id2level`)}else this.dbg(`Will NOT load Tile ${n},${s}`),r.push(i.default.LEVEL_NOT_LOADED)}),t.push(r)}):i.default.err("WorldFromJSON","getAreaLevels","areaJSON.tiles cannot be null/undefined"),--this._IND,t}setTileJSONForUnloadedTiles(e,t){const s=e.getTiles();s.forEach((e,n)=>{e.forEach((e,r)=>{s[n][r]===i.default.TILE_NOT_LOADED&&(s[n][r]=t.tiles[n][r])})})}addWorldID(e,t){i.default.isNullOrUndef([e.id])||t.setID(e.id),this.worldElemByID[t.getID()]=t}dbg(e){if(d.enabled){const t=" ".repeat(this._IND);i.default.diag(t+"WorldFromJSON: "+e)}}verify(e,t,s){this._verif.verifyConf(e,t,s)}printKeys(e,t){i.default.diag(e),i.default.diag(Object.keys(t))}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SeasonManager=t.getSeasonDist=t.biomePossibleSeasons=t.seasonConfig=void 0;const r=n(s(5)).default("bitn:WorldSimulation"),a=n(s(0)),o=s(1).Random.getRNG(),i=["sunny","cloudy"];t.seasonConfig={AUTUMN:{dur:2,temp:[0,15],weather:["rain","heavy rain"],index:0},AUTUMN_WINTER:{dur:1,temp:[-10,10],weather:["snowFall","coldRain"],index:1},WINTER:{dur:4,temp:[-35,3],weather:["snowFall","snowStorm","hailStorm"],index:2},WINTER_SPRING:{dur:1,temp:[-10,10],weather:["snowFall"],index:3},SPRING:{dur:1,temp:[5,15],weather:["rain"],index:4},SPRING_SUMMER:{dur:1,temp:[10,20],weather:["rain"],index:5},SUMMER:{dur:1,temp:[15,25],weather:["rain"],index:6},SUMMER_AUTUMN:{dur:1,temp:[10,20],weather:["heavy rain","rain"],index:7}},t.biomePossibleSeasons={arctic:["WINTER"],alpine:["WINTER","WINTER_SPRING"],tundra:["AUTUMN_WINTER","WINTER","WINTER_SPRING"],taiga:["all"],forest:["all"],grassland:["all"]},t.getSeasonDist=function(e,s){const n=t.seasonConfig[e].index,r=t.seasonConfig[s].index;return Math.abs(n-r)};class l{constructor(e){this._currSeason=a.default.SEASON.AUTUMN,this._daysPerMonth=5,this._monthLeft=5,this._seasonLeft=t.seasonConfig[this._currSeason].dur,this._currWeather="sunny",this._seasonChanged=!1,this._weatherChanged=!1,this._monthChanged=!1,this._yearChanged=!1,this.pool=e,this._currTemp=this.getNewTemperature(this._currSeason),this._debug=r.enabled}static fromJSON(e){const t=new l;return t._currSeason=e.currSeason,t._currWeather=e.currWeather,t._monthLeft=e.monthLeft,t._seasonLeft=e.seasonLeft,t._seasonChanged=e.seasonChanged,t._weatherChanged=e.weatherChanged,t._monthChanged=e.monthChanged,t._yearChanged=e.yearChanged,t._biomeMap=e.biomeMap,t}dbg(...e){this._debug&&r("",...e)}setDaysInMonth(e){this._monthLeft=e,this._daysPerMonth=e}getNewTemperature(e){const[s,n]=t.seasonConfig[e].temp;return o.getUniformInt(s,n)}setOwPos(e){this._owPos=e}setBiomeMap(e){this._biomeMap=e}seasonChanged(){return this._seasonChanged}monthChanged(){return this._monthChanged}yearChanged(){return this._yearChanged}weatherChanged(){return this._weatherChanged}resetWeatherChanged(){this._weatherChanged=!1}getSeason(){return this._currSeason}update(){--this._monthLeft,this._seasonChanged=!1,this._monthChanged=!1,this._yearChanged=!1,0===this._monthLeft&&(this._seasonLeft-=1,this._monthLeft=5,this._monthChanged=!0),this._seasonLeft<=0&&(this.nextSeason(),this._seasonChanged=!0,this._checkMsgEmits())}nextSeason(){const e=Object.keys(t.seasonConfig);let s=e.indexOf(this._currSeason)+1;s>=e.length&&(s=0,this._yearChanged=!0),this.dbg("SeasonMan currSeason is now",this._currSeason),this._currSeason=e[s]}getWeather(){return this._currWeather}getTemperature(){return this._currTemp}changeWeather(){this._weatherChanged=!1;const e=a.default.isSuccess(.2),s=a.default.isSuccess(.75);if(this.dbg("changeWeather() called. Checking to change weatherisSpecial: "+e+", isSame: "+s),!e&&s)return this._currWeather;const n=this.filterSeasonForBiome();this._currTemp=this.getNewTemperature(n);let r=this._currWeather;if(e){const e=t.seasonConfig[n].weather,a=e.indexOf(r)>=0;s&&a?this.dbg("Keeping existing special weather: "+r):e.length>0&&(r=o.arrayGetRand(e))}else r=o.arrayGetRand(i);return this.dbg("changeWeather() called. New weather will be |",r),r!==this._currWeather&&(this._weatherChanged=!0),this._currWeather=r,this._currWeather}filterSeasonForBiome(){if(!this._biomeMap)return this._currSeason;if(!this._owPos)return this._currSeason;const e=a.default.toKey(this._owPos),s=this._biomeMap[e];if(s){const e=t.biomePossibleSeasons[s];if("all"===e[0])return this._currSeason;return e.indexOf(this._currSeason)>=0?this._currSeason:e[0]}return a.default.err("SeasonManager","filterSeasonForBiome","currBiome not found with key "+e),""}setPool(e){this.pool=e}toJSON(){return{currSeason:this._currSeason,currWeather:this._currWeather,monthLeft:this._monthLeft,seasonLeft:this._seasonLeft,seasonChanged:this._seasonChanged,weatherChanged:this._weatherChanged,monthChanged:this._monthChanged,yearChanged:this._yearChanged,owPos:this._owPos,biomeMap:this._biomeMap}}toString(){return"Weather: "+this._currWeather+",Month left: "+this._monthLeft+",Season: "+this._currSeason+"("+this._seasonLeft+")"}_checkMsgEmits(){this.seasonChanged()&&(this._currSeason===a.default.SEASON.AUTUMN_WINTER?a.default.gameMsg("Winter is approaching quickly!"):this._currSeason===a.default.SEASON.WINTER&&a.default.gameMsg("The call of Winter has arrived!"))}}t.SeasonManager=l},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DayManager=void 0;const r=n(s(0)),a={NIGHT:{from:1320,to:300,visibility:-3},DAWN:{from:300,to:420,visibility:-1},MORNING:{from:420,to:660,visibility:0},NOON:{from:660,to:780,visibility:0},AFTERNOON:{from:780,to:1080,visibility:0},EVENING:{from:1080,to:1200,visibility:-1},DUSK:{from:1200,to:1320,visibility:-2}};class o{constructor(e){this._currPhase=r.default.DAY.MORNING,this._updateRate=5,this._currTimeMins=720,this._dayChanged=!1,this._phaseChanged=!1,e&&(this.pool=e)}static fromJSON(e){const t=new o;return t._currPhase=e.currPhase,t._currTimeMins=e.timeOfDayMins,t._updateRate=e.updateRate,t._dayChanged=e.dayChanged,t._phaseChanged=e.phaseChanged,t}setUpdateRate(e){e>=1?this._updateRate=e:r.default.warn("DayManager","setUpdateRate","Rate must be >= 1. Got "+e)}getTimeMins(){return this._currTimeMins}getVisibility(){return this.getPhaseEntry().visibility}update(){const e=a[this._currPhase];this._dayChanged=!1,this._phaseChanged=!1,this._currTimeMins+=this._updateRate,this._currTimeMins>1440&&(this._currTimeMins=0),this._currTimeMins>=e.to&&(e.to<e.from?this._currTimeMins<e.from&&(this.nextPhase(),this._phaseChanged=!0):(this.nextPhase(),this._phaseChanged=!0))}dayChanged(){return this._dayChanged}phaseChanged(){return this._phaseChanged}getCurrPhase(){return this._currPhase}getPhaseEntry(){return a[this._currPhase]}toJSON(){return{currPhase:this._currPhase,timeOfDayMins:this._currTimeMins,updateRate:this._updateRate,dayChanged:this._dayChanged,phaseChanged:this._phaseChanged}}setPool(e){this.pool=e}toString(){return`Curr phase: ${this._currPhase}, timeOfDay: ${this._currTimeMins},`+(this._phaseChanged?" *PHASE CHANGED*":"")+(this._dayChanged?" *DAY CHANGED*":"")}nextPhase(){const e=Object.keys(a);let t=e.indexOf(this._currPhase)+1;t>=e.length&&(t=0,this.pool.emitEvent(r.default.EVT_DAY_CHANGED,{prevPhase:this._currPhase,nextPhase:e[t]}),this._dayChanged=!0),this.pool.emitEvent(r.default.EVT_DAY_PHASE_CHANGED,{prevPhase:this._currPhase,nextPhase:e[t]}),this._currPhase=e[t]}}t.DayManager=o},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GameMain=t.Game=void 0;const i=o(s(0)),l=s(25),c=s(499),u=s(12),h=s(503),d=s(508),f=s(101),g=s(65),p=s(1),m=s(4),y=s(95),_=a(s(2)),b=a(s(32)),v=s(17),E=s(6),S=u.EventPool.getPool();t.Game={};t.GameMain=class{constructor(){this.hasNotify=!0,this.debugEnabled=!1,this.notify=this.notify.bind(this),this._players=[],this._places={},this._shownLevel=null,this._gameOver=!1,this.actorsKilled={},this.gameID=Date.now(),this._enableChunkUnload=!1,this._chunkManager=null,this._eventPool=S,S.reset(),this.currPlaceIndex=0,this._rng=new p.Random,this._engine=new h.Engine(this._eventPool),this._master=new d.GameMaster(this,this._eventPool),this._worldSim=new y.WorldSimulation(this._eventPool),this._engine.addRegularUpdate(this._worldSim),this._engine.setSystemArgs({worldSim:this._worldSim}),this.visibleCells=[],this.globalConf={},this._engine.playerCommandCallback=this.playerCommandCallback.bind(this),this._engine.isGameOver=this.isGameOver.bind(this),this._eventPool.listenEvent(i.default.EVT_ACTOR_KILLED,this),this._eventPool.listenEvent(i.default.EVT_LEVEL_CHANGED,this),this._eventPool.listenEvent(i.default.EVT_TILE_CHANGED,this),this._eventPool.listenEvent(i.default.EVT_TILE_ENTERED,this),this._eventPool.listenEvent(i.default.EVT_TILE_LEFT,this)}setGlobalConf(e){this.globalConf=e}getGlobalConf(){return this.globalConf}shownLevel(){return this._shownLevel}setShownLevel(e){this._shownLevel=e,this._worldSim.setLevel(e)}getPool(){return this._eventPool}getTimeOfDayMins(){return this._worldSim.getTimeOfDayMins()}setGUICallbacks(e,t){this._engine.isGUICommand=e,this._engine.doGUICommand=t;const s=this.getPlayer();s&&s.getBrain().addGUICallback("GOTO",t)}setRNG(e){this._rng=e,p.Random.setRNG(this._rng),this._engine.setRNG(e)}playerCommandCallback(e){this.visibleCells=e.getBrain().getSeenCells(),this._engine.setVisibleArea(this.shownLevel(),this.visibleCells)}isGameOver(){return this._gameOver}getLevels(){return this._engine.getLevels()}getComponents(){return this._engine.getComponents()}getPlaces(){return this._places}getLevelsInAllPlaces(){let e=[];return Object.values(this._places).forEach(t=>{e=e.concat(t.getLevels())}),e}setEnableChunkUnload(e=!0){if(this._enableChunkUnload=e,e&&this.getArea(0)){const e=this.getArea(0);this._chunkManager=new c.ChunkManager(this,e)}}getPlayer(){return this._engine.getPlayer()}addPlayer(e,t){let s=!1;return this._master.setPlayer(e),s=!i.default.isNullOrUndef([e.getLevel()])||(i.default.isNullOrUndef([t])?this._addPlayerToFirstLevel(e,this.getLevels()):this._addPlayerToPlace(e,t)),s&&(this._engine.nextActor=e,this._engine.setPlayer(e),null===this._shownLevel&&this.setShownLevel(e.getLevel()),this._players.push(e),this._engine.addActiveLevel(e.getLevel()),e.getLevel().onEnter(),e.getLevel().onFirstEnter()),s&&this._gameOver&&(this._gameOver=!1),s}useAsPlayer(e){let t=e;Number.isInteger(e)&&(t=i.default.ent(e)),t||(t=i.default.CLICKED_ACTOR),t&&(t.setIsPlayer(!0),t.add(new _.Player),this.addPlayer(t))}movePlayer(e,t,s=0,n=0){const r=this.getPlayer(),a=this.getCurrentWorld().getAreas()[0];let o=null;this._enableChunkUnload?this._chunkManager?(this._chunkManager.isLoaded(e,t)||this._chunkManager.setPlayerTile(e,t,null,null),o=a.getTileXY(e,t)):i.default.err("GameMain","movePlayer","chunkUnload enabled, but no chunkManager created"):o=a.getTileXY(e,t);const l=o.getLevel(),c=r.getLevel(),[u,h]=[r.getX(),r.getY()];c.removeActor(r)?l.addActor(r,s,n)||l.addActorToFreeCell(r)?(S.emitEvent(i.default.EVT_LEVEL_CHANGED,{target:l,src:c,actor:r}),S.emitEvent(i.default.EVT_LEVEL_ENTERED,{actor:r,target:l})):c.addActor(r,u,h):console.error("Could not remove player from level")}_addPlayerToFirstLevel(e,t){let s=!1;return t.length>0?(s=t[0].addActorToFreeCell(e),s?this.checkIfTileChanged({actor:e,src:null,target:t[0]}):i.default.err("Game","addPlayer","Failed to add the player.")):i.default.err("Game","addPlayer","No levels exist. Cannot add player."),s}_addPlayerToPlace(e,t){if(t.hasOwnProperty("place")){const s=t.place;if(this._places.hasOwnProperty(s))if(t.hasOwnProperty("x")&&t.hasOwnProperty("y")){const n=this._places[s];if("world"===n.getType()){const s=n.getAreas()[0];if(s.isLoaded(t.x,t.y)){const n=[s.getTileXY(t.x,t.y).getLevel()];return this._addPlayerToFirstLevel(e,n)}i.default.err("GameMain","_addPlayerToPlace","Tried to add player to unloaded tile @"+t)}else i.default.err("GameMain","_addPlayerToPlace","Tried to add player to non-world: "+n.toJSON())}else{const t=this._places[s];if(t.getLevels){const s=t.getLevels();return this._addPlayerToFirstLevel(e,s)}}else i.default.err("GameMain","_addPlayerToPlace","No place |"+s+"| found.")}else i.default.err("GameMain","_addPlayerToPlace","obj.place must exist.");return!1}checkIfTileChanged(e){const{actor:t,src:s,target:n}=e,r=[n];i.default.isNullOrUndef([s])||r.push(s);const a=this.getArea(0);a&&2===r.length&&a.hasTiles(r)&&S.emitEvent(i.default.EVT_TILE_CHANGED,{actor:t,target:n,src:s}),this.isTileLevel(n)?S.emitEvent(i.default.EVT_TILE_ENTERED,{actor:t,target:n,src:s}):this.isTileLevel(s)&&S.emitEvent(i.default.EVT_TILE_LEFT,{actor:t,target:n,src:s})}isTileLevel(e){const t=this.getArea(0);return!!t&&t.hasTiles([e])}checkIfExploredZoneLeft(e){const{actor:t,src:s,target:n}=e;let r=!1;if(t.has("GameInfo")&&s&&n){const e=s.getParent();if(e)if(e.getID){const s=e.getID();t.get("GameInfo").hasZone(s)&&(r=this.isTileLevel(n))}else i.default.warn("GameMain","checkIfExploredZoneLeft","No getID: "+JSON.stringify(e))}r&&S.emitEvent(i.default.EVT_EXPLORED_ZONE_LEFT,{actor:t,target:n,src:s})}getMessages(){return this._engine.getMessages()}clearMessages(){this._engine.clearMessages()}hasNewMessages(){return this._engine.hasNewMessages()}addActor(e){this._engine.addActor(e)}removeActor(e){this._engine.removeActor(e)}addEvent(e){this._engine.addEvent(e)}addActiveLevel(e){this._engine.addActiveLevel(e)}addLevel(e){this._engine.hasLevel(e)?this.errorDuplicateLevel("addLevel",e):this._engine.addLevel(e)}addLevelUnlessExists(e){this._engine.hasLevel(e)||this._engine.addLevel(e)}removeLevels(e){this._engine.removeLevels(e)}addPlace(e){if("function"==typeof e.getLevels){const t=e.getName();if(this._places.hasOwnProperty(t))i.default.err("GameMain","addPlace","A place |"+t+"| exists.");else{const s=e.getLevels();if(s.length>0)for(const e of s)this.addLevel(e);else i.default.err("GameMain","addPlace",`Place ${t} has no levels!`);if(this._places[t]=e,this._engine.setSystemArgs({worldTop:e}),this.getArea(0)){const e=this.getCurrentWorld();if(e){const t=e.getCurrentArea();this._enableChunkUnload&&!this._chunkManager&&(this._chunkManager=new c.ChunkManager(this,t))}}}}else i.default.err("GameMain","addPlace","Added place must have getLevels()")}hasPlaces(){return Object.keys(this._places).length>0}getVisibleMap(){return this.getPlayer().getLevel().getMap()}simulate(e){this._engine.timeOfDay=this.getTimeOfDayMins(),this._engine.simulateGame(e)}simulateGame(e){this._engine.timeOfDay=this.getTimeOfDayMins(),this._engine.simulateGame(e)}update(e){this._engine.timeOfDay=this.getTimeOfDayMins(),this._worldSim.setLevel(this.getPlayer().getLevel()),this._engine.update(e)}getArea(e){const t=this.getCurrentWorld();return t&&"function"==typeof t.getAreas?t.getAreas()[e]:null}notify(e,t){if(this.dbg(`Received event ${e} with args`,t),e===i.default.EVT_ACTOR_KILLED){if(this.actorsKilled[t.actor.getID()]=!0,t.actor.isPlayer()){const{actor:e}=t,s=this._players.indexOf(e);s>=0?(1===this._players.length&&(this.dbg("Setting the game to be over now"),this._gameOver=!0,i.default.gameMsg("GAME OVER!")),this._players.splice(s,1)):i.default.err("Game","notify","No player found from list: "+JSON.stringify(this._players))}}else if(e===i.default.EVT_LEVEL_CHANGED){const{actor:e}=t;e.isPlayer()&&(this.setShownLevel(e.getLevel()),this._overworld&&this._worldSim.setOwPos(this.getPlayerOwPos()),this.checkIfTileChanged(t),this.checkIfExploredZoneLeft(t))}else if(e===i.default.EVT_TILE_CHANGED){const{actor:e,target:s}=t;if(e.isPlayer()){const e=s.getID(),n=this.getCurrentWorld();if(n&&n.getAreas){const s=n.getAreas()[0],[r,a]=s.findTileXYById(e),o=new g.FactoryWorld;o.setGlobalConf(this.getGlobalConf());let i=null,l=null;if(t.src){const e=s.findTileXYById(t.src.getID());e&&([i,l]=e)}this._enableChunkUnload&&this._chunkManager.setPlayerTile(r,a,i,l),o.createZonesForTile(n,s,r,a);n.getLevels().forEach(e=>{this.addLevelUnlessExists(e)})}}}else e===i.default.EVT_TILE_ENTERED?this._worldSim.setUpdateRates(30):e===i.default.EVT_TILE_LEFT&&this._worldSim.setUpdateRates(5)}addBattle(e,t=-1,s=!1){const n=e.getLevel();this.addLevel(n),s&&this._engine.addActiveLevel(n),this.hasPlaces()&&t>-1&&this._addBattleZoneToArea(e,t)}_addBattleZoneToArea(e,t){const s=e.getLevel(),n="Zone of "+e.getName(),r=new b.BattleZone(n);r.addLevel(s);const a=this.getCurrentWorld().getAreas()[0],o=a.findTileXYById(t);o?(r.setTileXY(o[0],o[1]),a.addZone("BattleZone",r)):i.default.err("GameMain","_addBattleZoneToArea",`ID ${t} not found in area.`)}getChunkManager(){return this._chunkManager}getGameMaster(){return this._master}setGameMaster(e){this._master=e,this._master.setPlayer(this.getPlayer());const t=this.getCurrentWorld();t?(this._master.setWorld(t),this._master.setGame(this)):i.default.warn("GameMain","setGameMaster","Cannot set gameMaster without existing world")}getOverWorld(){return this._overworld}setOverWorld(e){this._overworld=e,this._worldSim.setOverWorld(e),this._engine.setSystemArgs({owMap:e})}setWorldSim(e){e.setPool(this._eventPool),this._engine.addRegularUpdate(this._worldSim),this._worldSim=e,this._engine.setSystemArgs({worldSim:this._worldSim})}updateEventPoolRefs(){this._worldSim.setPool(this._eventPool)}toJSON(){const e=E.ObjectShell.getParser(),t={gameID:this.gameID,engine:this._engine.toJSON(),gameMaster:this._master.toJSON(),gameObjectID:f.GameObject.ID,lastComponentID:_.getIDCount(),globalConf:this.globalConf,rng:this._rng.toJSON(),diceRng:v.Dice.RNG.toJSON(),charStyles:i.default.charStyles,cellStyles:i.default.cellStyles,actorsKilled:this.actorsKilled,enableChunkUnload:this._enableChunkUnload,objectShellParser:e.toJSON()};if(this.hasPlaces()){const e={};Object.keys(this._places).forEach(t=>{const s=this._places[t];e[t]=s.toJSON()}),t.places=e}else{const e=[];this._engine.getLevels().forEach(t=>{e.push(t.toJSON())}),t.levels=e,t.places={}}const s=this.getPlayer();return s&&(t.player=s.toJSON()),this._overworld&&(t.overworld=this._overworld.toJSON()),this._chunkManager&&(t.chunkManager=this._chunkManager.toJSON()),this._worldSim&&(t.worldSim=this._worldSim.toJSON()),t}isMenuShown(){return this._engine.isMenuShown()}getMenu(){const e=this.getPlayer();return e?e.getBrain().getMenu():null}setAnimationCallback(e){"function"==typeof e?this._engine.animationCallback=e:i.default.warn("GameMain","setAnimationCallback","Callback must be a function.")}hasAnimation(){return this._engine.hasAnimation()}finishAnimation(){return this._engine.finishAnimation()}getAnimationFrame(){return this._engine.animation?this._engine.animation.nextFrame():null}enableAnimations(){this._engine.enableAnimations()}disableAnimations(){this._engine.disableAnimations()}getPlayerOwPos(){const e=this.getPlayer(),t=this.getCurrentWorld();if(!this._overworld||!e||!t)return null;const s=this._overworld;let n=t.getAreas()[0].findTileXYById(e.getLevel().getID()),[r,a]=e.getXY();if(!n){if(n=this.tryToGetTileXY(),!n)return null;r=50,a=50}const{xMap:o,yMap:i}=s.coordMap,l=100*n[0]+r,c=100*n[1]+a;return[Math.floor(l/o),Math.floor(c/i)]}tryToGetTileXY(){let e=this.getPlayer().getLevel().getParent();for(;e;)if(e=e.getParent?e.getParent():null,e&&e.getTileXY)return e.getTileXY();return null}setOverWorldExplored(e){m.Geometry.getBoxAround(e[0],e[1],1,!0).forEach(e=>{this._overworld.setExplored(e)})}getCurrentWorld(){const e=Object.values(this.getPlaces());if(e.length>this.currPlaceIndex){const t=e[this.currPlaceIndex];if("world"===t.getType())return t}return null}find(e,t=-1,s="find"){const n=this._engine.getLevels();if(-1===t){return this.getPlayer().getLevel().getActors()[s](e)}if(Number.isInteger(t)){const r=n.find(e=>e.getID()===t);if(r)return r.getActors()[s](e)}else for(const t of n){const n=t.getActors()[s](e);if(n)return n}return null}errorDuplicateLevel(e,t){const s=t.getParent(),n=t.toJSON();delete n.elements,delete n.map.cells;let r="";if(s){r=`Parent: ${i.default.formatLocationName(t)}| `}r+="Duplicate level ID "+t.getID(),r+=" JSON: "+JSON.stringify(n,null,1),i.default.err("GameMain",e,r)}entityPrint(){i.default.diag(l.Entity.num)}dbg(...e){this.debugEnabled&&console.log("[Game DEBUG]: ",...e)}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Chunk=t.ChunkManager=void 0;const r=n(s(0)),a=s(222),o=s(92),i=s(11),l=s(500),c=s(5)("bitn:ChunkManager");class u{constructor(e,t){const[s,n]=[t.getSizeX(),t.getSizeY()];this.sizeX=s,this.sizeY=n,this.area=t,this.game=e,this.state=[],this.store=new l.InMemoryStore(this.game.gameID),this.recordedTileMoves=[];for(let e=0;e<s;e++){this.state[e]=[];for(let s=0;s<n;s++)if(t.isLoaded(e,s)){c(`new() area ${e},${s} is loaded`);const t={loadState:o.LoadStat.LOADED};this.state[e].push(t)}else if(t.isOnDisk(e,s)){const t={loadState:o.LoadStat.ON_DISK};this.state[e].push(t)}else{const t={loadState:o.LoadStat.JSON};this.state[e].push(t)}}this.loadDistX=1,this.loadDistY=1,this.jsonDistX=2,this.jsonDistY=2,this.onDiskDistX=3,this.onDiskDistY=3}setPlayerTile(e,t,s,n){const r=this.getMoveDir(e,t,s,n);c.enabled&&(c(`## setPlayerTile START ${s},${n}->${e},${t}`),this.debugPrint()),this.recordedTileMoves.push([[e,t],[s,n]]);const a=[];for(let s=0;s<this.sizeX;s++)for(let n=0;n<this.sizeY;n++)this.inLoadRange(e,t,s,n)?this.isLoaded(s,n)||a.push([s,n]):this.isLoaded(s,n)?this.inJSONRange(e,t,s,n)?this.unloadTile(e,t,s,n,r):this.writeTileToDisk(e,t,s,n,r):this.isJSON(s,n)?this.inJSONRange(e,t,s,n)||this.writeTileToDisk(e,t,s,n,r):this.isOnDisk(s,n)?(c("Checking json range for ",e,t,"to",s,n),this.inJSONRange(e,t,s,n)&&(c("Reading tile from disk now",s,n),this.readTileFromDisk(e,t,s,n,r))):this.writeTileToDisk(e,t,s,n,r);a.length>0&&this.loadTiles(e,t,a,r),c.enabled&&(c(`## setPlayerTile END ${s},${n}->${e},${t}`),this.debugPrint())}isLoaded(e,t){return this.state[e][t].loadState===o.LoadStat.LOADED}isJSON(e,t){return this.state[e][t].loadState===o.LoadStat.JSON}isOnDisk(e,t){return this.state[e][t].loadState===o.LoadStat.ON_DISK}inLoadRange(e,t,s,n){for(let r=e-this.loadDistX;r<=e+this.loadDistX;r++)for(let e=t-this.loadDistY;e<=t+this.loadDistY;e++)if(s===r&&n===e)return!0;return!1}inJSONRange(e,t,s,n){const r=Math.abs(s-e),a=Math.abs(n-t);return(r>this.loadDistX||a>this.loadDistY)&&(r<=this.jsonDistX&&a<=this.jsonDistY)}loadAllTiles(){this.setLoadStateAll(o.LoadStat.LOADED)}getNumInState(e){let t=0;for(let s=0;s<this.sizeX;s++)for(let n=0;n<this.sizeY;n++)this.state[s][n].loadState===e&&++t;return t}loadTiles(e,t,s,n){const a=this.area.getTiles();c("loadTiles: "+JSON.stringify(s)),s.forEach(s=>{this.isOnDisk(s[0],s[1])&&this.readTileFromDisk(e,t,s[0],s[1],n)});const i=s.map(e=>{const[t,s]=e;if(this.area.isJSON(t,s))return a[e[0]][e[1]];r.default.err("ChunkManager","loadTiles",`Cannot load non-JSON tile at ${t},${s}`)});this.createTiles(i),s.forEach(s=>{c("ChunkManager load now tile "+s);const[r,i]=s;if(this.state[r][i].loadState=o.LoadStat.LOADED,this.area.setLoaded(r,i),""===n&&(c(`Rm adjacent conns to ${r},${i}`),this.removeAdjacentConnections(a,e,t,r,i)),0===s[0]&&2===s[1]){this.area.getTiles()}})}removeAdjacentConnections(e,t,s,n,r){this.inLoadRange(t,s,n,r-1)||r-1>=0&&(c(`Rm NORTH conns from ${n},${r}`),this.removeConnections("NORTH",e[n][r])),this.inLoadRange(t,s,n,r+1)||r+1<this.area.getSizeY()&&(c(`Rm SOUTH conns from ${n},${r}`),this.removeConnections("SOUTH",e[n][r])),this.inLoadRange(t,s,n+1,r)||n+1<this.area.getSizeX()&&(c(`Rm EAST conns from ${n},${r}`),this.removeConnections("EAST",e[n][r])),this.inLoadRange(t,s,n-1,r)||n-1>=0&&(c(`Rm WEST conns from ${n},${r}`),this.removeConnections("WEST",e[n][r]))}unloadTile(e,t,s,n,r){c(`Unloading tile ${s},${n}`);const a=this.area.getTiles();this.state[s][n].loadState=o.LoadStat.LOADED2JSON,this.area.setUnloaded2JSON(s,n);const i=a[s][n],l=i.getLevels();this.game.removeLevels(l);const u=i.getLevel();c(`\tUnloading battles @ ${s},${n}, id: ${u.getID()}`);if(this.game.getGameMaster().unloadBattles(u),c.enabled){const e=i.getLevels().map(e=>e.getID());c("\t-- Unloading levels "+e)}if(i.removeListeners(),a[s][n]=i.toJSON(),"WEST"===r){const e=s-1;c(`Removing connections from tile ${s-1},${n}`),e<this.area.getSizeX()&&this.removeConnections("EAST",a[s-1][n])}else if("EAST"===r){const e=s+1;c(`Removing connections from tile ${s+1},${n}`),e<this.area.getSizeX()&&this.removeConnections("WEST",a[s+1][n])}else if("NORTH"===r){const e=n-1;c(`Removing connections from tile ${s},${n-1}`),e>=0&&this.removeConnections("SOUTH",a[s][n-1])}else if("SOUTH"===r){const e=n+1;c(`Removing connections from tile ${s},${n+1}`),e<this.area.getSizeY()&&this.removeConnections("NORTH",a[s][n+1])}else this.inLoadRange(e,t,s,n-1)&&n-1>=0&&this.isLoaded(s,n-1)&&(c(`Rm SOUTH conns from ${s},${n-1}`),this.removeConnections("SOUTH",a[s][n-1])),this.inLoadRange(e,t,s,n+1)&&n+1<this.area.getSizeY()&&this.isLoaded(s,n+1)&&(c(`Rm NORTH conns from ${s},${n+1}`),this.removeConnections("NORTH",a[s][n+1])),this.inLoadRange(e,t,s+1,n)&&s+1<this.area.getSizeX()&&this.isLoaded(s+1,n)&&(c(`Rm WEST conns from ${s+1},${n}`),this.removeConnections("WEST",a[s+1][n])),this.inLoadRange(e,t,s-1,n)&&s-1>=0&&this.isLoaded(s-1,n)&&(c(`Rm EAST conns from ${s-1},${n}`),this.removeConnections("EAST",a[s-1][n]));this.state[s][n].loadState=o.LoadStat.JSON}writeTileToDisk(e,t,s,n,a){this.isLoaded(s,n)&&this.unloadTile(e,t,s,n,a),this.state[s][n].loadState=o.LoadStat.JSON2ON_DISK;const i=this.getTileId(s,n),l=this.area.getTileXY(s,n);l||r.default.err("ChunkManager","writeTileToDisk",`Expected JSON, got undefined ${s},${n}`),this.store.setItem(i,l),this.area.setOnDisk(s,n,{onDisk:!0,tileId:i,level:l.level}),this.state[s][n].loadState=o.LoadStat.ON_DISK}readTileFromDisk(e,t,s,n,a){if(this.isOnDisk(s,n)){c(`Reading ${s},${n} from disk now`),this.state[s][n].loadState=o.LoadStat.ON_DISK2JSON;const e=this.getTileId(s,n),t=this.store.getItem(e);this.area.setUnloaded2JSON(s,n),"string"==typeof t?this.area.setTile(s,n,JSON.parse(t)):this.area.setTile(s,n,t),this.state[s][n].loadState=o.LoadStat.JSON}else r.default.err("ChunkManager","readTileFromDisk",`Tried to read tile ${s},${n} from disk: ${this.state}`)}getTileId(e,t){return this.game.gameID+","+e+","+t}getLoadState(e,t){return this.state[e][t].loadState}toJSON(){const e={state:this.state,useInMemoryStore:this.useInMemoryStore,recordedTileMoves:this.recordedTileMoves};return e.data=this.store.data,e}setLoadStateAll(e){this.state.forEach((t,s)=>{t.forEach((t,n)=>{this.state[s][n].loadState=e})})}createTiles(e){const t=e.length;c(`Creating ${t} AreaTiles with FromJSON`);const s=new a.FromJSON;s.setChunkMode(!0),s.createTiles(this.game,e)}addConnections(e,t,s){const n=this.getOpposite(e),r=this.getReplacedConnections(e,t),o=this.getReplacedConnections(n,s),i=new a.FromJSON,l=r.concat(o),c=[t.getLevel(),s.getLevel()];i.connectTileLevels(c,l)}removeConnections(e,t){this.getReplacedConnections(e,t).forEach(e=>{const t=e.getTargetStairs(),s=e.getTargetLevel();if(s instanceof i.Level){const n={targetLevel:s.getID(),targetStairs:{x:t.getX(),y:t.getY()}};e.setConnObj(n)}})}getReplacedConnections(e,t){const s=t.getLevel().getConnections();0===s.length&&r.default.err("ChunkManager","getReplacedConnections","No connections found.");let n=[];return"SOUTH"===e?n=s.filter(e=>e.getY()===t.rows-1):"NORTH"===e?n=s.filter(e=>0===e.getY()):"EAST"===e?n=s.filter(e=>e.getX()===t.cols-1):"WEST"===e&&(n=s.filter(e=>0===e.getX())),n}getOpposite(e){switch(e){case"NORTH":return"SOUTH";case"SOUTH":return"NORTH";case"EAST":return"WEST";case"WEST":return"EAST";default:r.default.err("ChunkManager","getOpposite",`Illegal dir ${e} given.`)}return""}getMoveDir(e,t,s,n){let[a,o]=[0,0],i="";if(!r.default.isNullOrUndef([s,n])){if(a=e-s,o=t-n,0!==a&&0!==o){const a=`MOVE: ${s},${n} -> ${e},${t}`;r.default.err("ChunkManager","getMoveDir","Diagonal move not supported: "+a)}a>0?i="EAST":a<0&&(i="WEST"),o>0?i="SOUTH":o<0&&(i="NORTH")}return i}debugPrint(){let e="";for(let t=0;t<this.sizeY;t++){for(let s=0;s<this.sizeX;s++)e+=" "+this.stateToChar(this.state[s][t]);e+=` - ${t} \n`}e+="\n\tNum loaded: "+this.getNumInState(o.LoadStat.LOADED),e+="\n\tNum serialized: "+this.getNumInState(o.LoadStat.JSON),e+="\n\tNum on disk: "+this.getNumInState(o.LoadStat.ON_DISK),e+="\n";for(let t=0;t<this.area.getSizeY();t++){for(let s=0;s<this.area.getSizeX();s++){e+=`${s},${t}: `+(this.area.zonesCreated[s+","+t]?" X ":" - ")+"|"}e+="\n"}r.default.diag(e)}stateToChar(e){switch(e.loadState){case o.LoadStat.LOADED:return"L";case o.LoadStat.JSON:return"J";case o.LoadStat.ON_DISK:return"D";case o.LoadStat.EMPTY:return"E";case o.LoadStat.LOADED2JSON:return"*";case o.LoadStat.JSON2ON_DISK:return"V";case o.LoadStat.ON_DISK2JSON:return"^";default:return""}}_checkDist(e,t,s,n,r,a){for(let o=e-r;o<=e+r;o++)for(let e=t-a;e<=t+a;e++)if(s===o&&n===e)return!0;return!1}}t.ChunkManager=u,t.Chunk={},t.Chunk.printTileConnections=function(e,t,s=-1){if(r.default.diag(e),"function"==typeof t.getLevel){if(t.getLevel().getID()===s||-1===s){t.getLevel().getConnections().forEach(e=>{const t=e.getTargetLevel();Number.isInteger(t)?console.log(`\tTarget ID ${t} found`):console.log(`\tLevel ${t.getID()} found`)})}}else console.log("Skipping printTileConnections due to json input")},t.Chunk.ChunkManager=u},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Persist=t.InMemoryStore=void 0;const n=s(501),r=s(502);function a(e){this.store=n,this.fromStorage=t=>this.store.getItem(e,t),this.fromStorageWithKey=(e,t)=>this.store.getItem(e,t),this.toStorage=(t,s)=>{this.store.setItem(e,t,s)},this.toStorageWithKey=(e,t,s)=>{this.store.setItem(e,t,s)},this.deleteStorage=t=>{this.store.removeItem(e).then(t)},this.deleteStorageWithKey=(e,t)=>{this.store.removeItem(e).then(t)}}t.InMemoryStore=class{constructor(e,t=!0){this.name=e,this.data={},this.compress=t}getItem(e){this.data.hasOwnProperty(e)||console.warn(`No key |${e}| in InMemoryStore`);const t=this.data[e];if(this.compress){return r.decompress(t)}return t}setItem(e,t){let s;if(s="string"!=typeof t?JSON.stringify(t):t,this.compress){const t=r.compress(s);this.data[e]=t}else this.data[e]=s}removeItem(e){delete this.data[e]}},t.Persist=a,a.fromStorage=function(e,t){return n.getItem(e,t)},a.toStorage=function(e,t,s){n.setItem(e,t,s)},a.deleteStorage=function(e,t){n.removeItem(e).then(t)}},function(e,t,s){(function(t){e.exports=function e(t,s,n){function r(o,i){if(!s[o]){if(!t[o]){if(a)return a(o,!0);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}var c=s[o]={exports:{}};t[o][0].call(c.exports,(function(e){var s=t[o][1][e];return r(s||e)}),c,c.exports,e,t,s,n)}return s[o].exports}for(var a=!1,o=0;o<n.length;o++)r(n[o]);return r}({1:[function(e,s,n){(function(e){"use strict";var t,n,r=e.MutationObserver||e.WebKitMutationObserver;if(r){var a=0,o=new r(u),i=e.document.createTextNode("");o.observe(i,{characterData:!0}),t=function(){i.data=a=++a%2}}else if(e.setImmediate||void 0===e.MessageChannel)t="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){u(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(u,0)};else{var l=new e.MessageChannel;l.port1.onmessage=u,t=function(){l.port2.postMessage(0)}}var c=[];function u(){var e,t;n=!0;for(var s=c.length;s;){for(t=c,c=[],e=-1;++e<s;)t[e]();s=c.length}n=!1}s.exports=function(e){1!==c.push(e)||n||t()}}).call(this,void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,t,s){"use strict";var n=e(1);function r(){}var a={},o=["REJECTED"],i=["FULFILLED"],l=["PENDING"];function c(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=l,this.queue=[],this.outcome=void 0,e!==r&&f(this,e)}function u(e,t,s){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof s&&(this.onRejected=s,this.callRejected=this.otherCallRejected)}function h(e,t,s){n((function(){var n;try{n=t(s)}catch(t){return a.reject(e,t)}n===e?a.reject(e,new TypeError("Cannot resolve promise with itself")):a.resolve(e,n)}))}function d(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function f(e,t){var s=!1;function n(t){s||(s=!0,a.reject(e,t))}function r(t){s||(s=!0,a.resolve(e,t))}var o=g((function(){t(r,n)}));"error"===o.status&&n(o.value)}function g(e,t){var s={};try{s.value=e(t),s.status="success"}catch(e){s.status="error",s.value=e}return s}t.exports=c,c.prototype.catch=function(e){return this.then(null,e)},c.prototype.then=function(e,t){if("function"!=typeof e&&this.state===i||"function"!=typeof t&&this.state===o)return this;var s=new this.constructor(r);return this.state!==l?h(s,this.state===i?e:t,this.outcome):this.queue.push(new u(s,e,t)),s},u.prototype.callFulfilled=function(e){a.resolve(this.promise,e)},u.prototype.otherCallFulfilled=function(e){h(this.promise,this.onFulfilled,e)},u.prototype.callRejected=function(e){a.reject(this.promise,e)},u.prototype.otherCallRejected=function(e){h(this.promise,this.onRejected,e)},a.resolve=function(e,t){var s=g(d,t);if("error"===s.status)return a.reject(e,s.value);var n=s.value;if(n)f(e,n);else{e.state=i,e.outcome=t;for(var r=-1,o=e.queue.length;++r<o;)e.queue[r].callFulfilled(t)}return e},a.reject=function(e,t){e.state=o,e.outcome=t;for(var s=-1,n=e.queue.length;++s<n;)e.queue[s].callRejected(t);return e},c.resolve=function(e){return e instanceof this?e:a.resolve(new this(r),e)},c.reject=function(e){var t=new this(r);return a.reject(t,e)},c.all=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var s=e.length,n=!1;if(!s)return this.resolve([]);for(var o=new Array(s),i=0,l=-1,c=new this(r);++l<s;)u(e[l],l);return c;function u(e,r){t.resolve(e).then((function(e){o[r]=e,++i!==s||n||(n=!0,a.resolve(c,o))}),(function(e){n||(n=!0,a.reject(c,e))}))}},c.race=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var s=e.length,n=!1;if(!s)return this.resolve([]);for(var o,i=-1,l=new this(r);++i<s;)o=e[i],t.resolve(o).then((function(e){n||(n=!0,a.resolve(l,e))}),(function(e){n||(n=!0,a.reject(l,e))}));return l}},{1:1}],3:[function(e,s,n){(function(t){"use strict";"function"!=typeof t.Promise&&(t.Promise=e(2))}).call(this,void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(e,t,s){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(e){return}}();function a(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(r){if("TypeError"!==r.name)throw r;for(var s=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),n=0;n<e.length;n+=1)s.append(e[n]);return s.getBlob(t.type)}}"undefined"==typeof Promise&&e(3);var o=Promise;function i(e,t){t&&e.then((function(e){t(null,e)}),(function(e){t(e)}))}function l(e,t,s){"function"==typeof t&&e.then(t),"function"==typeof s&&e.catch(s)}function c(e){return"string"!=typeof e&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function u(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}var h=void 0,d={},f=Object.prototype.toString;function g(e){return"boolean"==typeof h?o.resolve(h):function(e){return new o((function(t){var s=e.transaction("local-forage-detect-blob-support","readwrite"),n=a([""]);s.objectStore("local-forage-detect-blob-support").put(n,"key"),s.onabort=function(e){e.preventDefault(),e.stopPropagation(),t(!1)},s.oncomplete=function(){var e=navigator.userAgent.match(/Chrome\/(\d+)/),s=navigator.userAgent.match(/Edge\//);t(s||!e||parseInt(e[1],10)>=43)}})).catch((function(){return!1}))}(e).then((function(e){return h=e}))}function p(e){var t=d[e.name],s={};s.promise=new o((function(e,t){s.resolve=e,s.reject=t})),t.deferredOperations.push(s),t.dbReady?t.dbReady=t.dbReady.then((function(){return s.promise})):t.dbReady=s.promise}function m(e){var t=d[e.name].deferredOperations.pop();if(t)return t.resolve(),t.promise}function y(e,t){var s=d[e.name].deferredOperations.pop();if(s)return s.reject(t),s.promise}function _(e,t){return new o((function(s,n){if(d[e.name]=d[e.name]||{forages:[],db:null,dbReady:null,deferredOperations:[]},e.db){if(!t)return s(e.db);p(e),e.db.close()}var a=[e.name];t&&a.push(e.version);var o=r.open.apply(r,a);t&&(o.onupgradeneeded=function(t){var s=o.result;try{s.createObjectStore(e.storeName),t.oldVersion<=1&&s.createObjectStore("local-forage-detect-blob-support")}catch(s){if("ConstraintError"!==s.name)throw s;console.warn('The database "'+e.name+'" has been upgraded from version '+t.oldVersion+" to version "+t.newVersion+', but the storage "'+e.storeName+'" already exists.')}}),o.onerror=function(e){e.preventDefault(),n(o.error)},o.onsuccess=function(){s(o.result),m(e)}}))}function b(e){return _(e,!1)}function v(e){return _(e,!0)}function E(e,t){if(!e.db)return!0;var s=!e.db.objectStoreNames.contains(e.storeName),n=e.version<e.db.version,r=e.version>e.db.version;if(n&&(e.version!==t&&console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),r||s){if(s){var a=e.db.version+1;a>e.version&&(e.version=a)}return!0}return!1}function S(e){return a([function(e){for(var t=e.length,s=new ArrayBuffer(t),n=new Uint8Array(s),r=0;r<t;r++)n[r]=e.charCodeAt(r);return s}(atob(e.data))],{type:e.type})}function w(e){return e&&e.__local_forage_encoded_blob}function C(e){var t=this,s=t._initReady().then((function(){var e=d[t._dbInfo.name];if(e&&e.dbReady)return e.dbReady}));return l(s,e,e),s}function T(e,t,s,n){void 0===n&&(n=1);try{var r=e.db.transaction(e.storeName,t);s(null,r)}catch(r){if(n>0&&(!e.db||"InvalidStateError"===r.name||"NotFoundError"===r.name))return o.resolve().then((function(){if(!e.db||"NotFoundError"===r.name&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),v(e)})).then((function(){return function(e){p(e);for(var t=d[e.name],s=t.forages,n=0;n<s.length;n++){var r=s[n];r._dbInfo.db&&(r._dbInfo.db.close(),r._dbInfo.db=null)}return e.db=null,b(e).then((function(t){return e.db=t,E(e)?v(e):t})).then((function(n){e.db=t.db=n;for(var r=0;r<s.length;r++)s[r]._dbInfo.db=n})).catch((function(t){throw y(e,t),t}))}(e).then((function(){T(e,t,s,n-1)}))})).catch(s);s(r)}}var O={_driver:"asyncStorage",_initStorage:function(e){var t=this,s={db:null};if(e)for(var n in e)s[n]=e[n];var r=d[s.name];r||(r={forages:[],db:null,dbReady:null,deferredOperations:[]},d[s.name]=r),r.forages.push(t),t._initReady||(t._initReady=t.ready,t.ready=C);var a=[];function i(){return o.resolve()}for(var l=0;l<r.forages.length;l++){var c=r.forages[l];c!==t&&a.push(c._initReady().catch(i))}var u=r.forages.slice(0);return o.all(a).then((function(){return s.db=r.db,b(s)})).then((function(e){return s.db=e,E(s,t._defaultConfig.version)?v(s):e})).then((function(e){s.db=r.db=e,t._dbInfo=s;for(var n=0;n<u.length;n++){var a=u[n];a!==t&&(a._dbInfo.db=s.db,a._dbInfo.version=s.version)}}))},_support:function(){try{if(!r||!r.open)return!1;var e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),t="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!e||t)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e){return!1}}(),iterate:function(e,t){var s=this,n=new o((function(t,n){s.ready().then((function(){T(s._dbInfo,"readonly",(function(r,a){if(r)return n(r);try{var o=a.objectStore(s._dbInfo.storeName).openCursor(),i=1;o.onsuccess=function(){var s=o.result;if(s){var n=s.value;w(n)&&(n=S(n));var r=e(n,s.key,i++);void 0!==r?t(r):s.continue()}else t()},o.onerror=function(){n(o.error)}}catch(e){n(e)}}))})).catch(n)}));return i(n,t),n},getItem:function(e,t){var s=this;e=c(e);var n=new o((function(t,n){s.ready().then((function(){T(s._dbInfo,"readonly",(function(r,a){if(r)return n(r);try{var o=a.objectStore(s._dbInfo.storeName).get(e);o.onsuccess=function(){var e=o.result;void 0===e&&(e=null),w(e)&&(e=S(e)),t(e)},o.onerror=function(){n(o.error)}}catch(e){n(e)}}))})).catch(n)}));return i(n,t),n},setItem:function(e,t,s){var n=this;e=c(e);var r=new o((function(s,r){var a;n.ready().then((function(){return a=n._dbInfo,"[object Blob]"===f.call(t)?g(a.db).then((function(e){return e?t:(s=t,new o((function(e,t){var n=new FileReader;n.onerror=t,n.onloadend=function(t){var n=btoa(t.target.result||"");e({__local_forage_encoded_blob:!0,data:n,type:s.type})},n.readAsBinaryString(s)})));var s})):t})).then((function(t){T(n._dbInfo,"readwrite",(function(a,o){if(a)return r(a);try{var i=o.objectStore(n._dbInfo.storeName);null===t&&(t=void 0);var l=i.put(t,e);o.oncomplete=function(){void 0===t&&(t=null),s(t)},o.onabort=o.onerror=function(){var e=l.error?l.error:l.transaction.error;r(e)}}catch(e){r(e)}}))})).catch(r)}));return i(r,s),r},removeItem:function(e,t){var s=this;e=c(e);var n=new o((function(t,n){s.ready().then((function(){T(s._dbInfo,"readwrite",(function(r,a){if(r)return n(r);try{var o=a.objectStore(s._dbInfo.storeName).delete(e);a.oncomplete=function(){t()},a.onerror=function(){n(o.error)},a.onabort=function(){var e=o.error?o.error:o.transaction.error;n(e)}}catch(e){n(e)}}))})).catch(n)}));return i(n,t),n},clear:function(e){var t=this,s=new o((function(e,s){t.ready().then((function(){T(t._dbInfo,"readwrite",(function(n,r){if(n)return s(n);try{var a=r.objectStore(t._dbInfo.storeName).clear();r.oncomplete=function(){e()},r.onabort=r.onerror=function(){var e=a.error?a.error:a.transaction.error;s(e)}}catch(e){s(e)}}))})).catch(s)}));return i(s,e),s},length:function(e){var t=this,s=new o((function(e,s){t.ready().then((function(){T(t._dbInfo,"readonly",(function(n,r){if(n)return s(n);try{var a=r.objectStore(t._dbInfo.storeName).count();a.onsuccess=function(){e(a.result)},a.onerror=function(){s(a.error)}}catch(e){s(e)}}))})).catch(s)}));return i(s,e),s},key:function(e,t){var s=this,n=new o((function(t,n){e<0?t(null):s.ready().then((function(){T(s._dbInfo,"readonly",(function(r,a){if(r)return n(r);try{var o=a.objectStore(s._dbInfo.storeName),i=!1,l=o.openKeyCursor();l.onsuccess=function(){var s=l.result;s?0===e||i?t(s.key):(i=!0,s.advance(e)):t(null)},l.onerror=function(){n(l.error)}}catch(e){n(e)}}))})).catch(n)}));return i(n,t),n},keys:function(e){var t=this,s=new o((function(e,s){t.ready().then((function(){T(t._dbInfo,"readonly",(function(n,r){if(n)return s(n);try{var a=r.objectStore(t._dbInfo.storeName).openKeyCursor(),o=[];a.onsuccess=function(){var t=a.result;t?(o.push(t.key),t.continue()):e(o)},a.onerror=function(){s(a.error)}}catch(e){s(e)}}))})).catch(s)}));return i(s,e),s},dropInstance:function(e,t){t=u.apply(this,arguments);var s=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||s.name,e.storeName=e.storeName||s.storeName);var n,a=this;if(e.name){var l=e.name===s.name&&a._dbInfo.db,c=l?o.resolve(a._dbInfo.db):b(e).then((function(t){var s=d[e.name],n=s.forages;s.db=t;for(var r=0;r<n.length;r++)n[r]._dbInfo.db=t;return t}));n=e.storeName?c.then((function(t){if(t.objectStoreNames.contains(e.storeName)){var s=t.version+1;p(e);var n=d[e.name],a=n.forages;t.close();for(var i=0;i<a.length;i++){var l=a[i];l._dbInfo.db=null,l._dbInfo.version=s}return new o((function(t,n){var a=r.open(e.name,s);a.onerror=function(e){a.result.close(),n(e)},a.onupgradeneeded=function(){a.result.deleteObjectStore(e.storeName)},a.onsuccess=function(){var e=a.result;e.close(),t(e)}})).then((function(e){n.db=e;for(var t=0;t<a.length;t++){var s=a[t];s._dbInfo.db=e,m(s._dbInfo)}})).catch((function(t){throw(y(e,t)||o.resolve()).catch((function(){})),t}))}})):c.then((function(t){p(e);var s=d[e.name],n=s.forages;t.close();for(var a=0;a<n.length;a++)n[a]._dbInfo.db=null;return new o((function(t,s){var n=r.deleteDatabase(e.name);n.onerror=n.onblocked=function(e){var t=n.result;t&&t.close(),s(e)},n.onsuccess=function(){var e=n.result;e&&e.close(),t(e)}})).then((function(e){s.db=e;for(var t=0;t<n.length;t++)m(n[t]._dbInfo)})).catch((function(t){throw(y(e,t)||o.resolve()).catch((function(){})),t}))}))}else n=o.reject("Invalid arguments");return i(n,t),n}},A="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",M=/^~~local_forage_type~([^~]+)~/,N="__lfsc__:".length,P=N+"arbf".length,D=Object.prototype.toString;function I(e){var t,s,n,r,a,o=.75*e.length,i=e.length,l=0;"="===e[e.length-1]&&(o--,"="===e[e.length-2]&&o--);var c=new ArrayBuffer(o),u=new Uint8Array(c);for(t=0;t<i;t+=4)s=A.indexOf(e[t]),n=A.indexOf(e[t+1]),r=A.indexOf(e[t+2]),a=A.indexOf(e[t+3]),u[l++]=s<<2|n>>4,u[l++]=(15&n)<<4|r>>2,u[l++]=(3&r)<<6|63&a;return c}function L(e){var t,s=new Uint8Array(e),n="";for(t=0;t<s.length;t+=3)n+=A[s[t]>>2],n+=A[(3&s[t])<<4|s[t+1]>>4],n+=A[(15&s[t+1])<<2|s[t+2]>>6],n+=A[63&s[t+2]];return s.length%3==2?n=n.substring(0,n.length-1)+"=":s.length%3==1&&(n=n.substring(0,n.length-2)+"=="),n}var x={serialize:function(e,t){var s="";if(e&&(s=D.call(e)),e&&("[object ArrayBuffer]"===s||e.buffer&&"[object ArrayBuffer]"===D.call(e.buffer))){var n,r="__lfsc__:";e instanceof ArrayBuffer?(n=e,r+="arbf"):(n=e.buffer,"[object Int8Array]"===s?r+="si08":"[object Uint8Array]"===s?r+="ui08":"[object Uint8ClampedArray]"===s?r+="uic8":"[object Int16Array]"===s?r+="si16":"[object Uint16Array]"===s?r+="ur16":"[object Int32Array]"===s?r+="si32":"[object Uint32Array]"===s?r+="ui32":"[object Float32Array]"===s?r+="fl32":"[object Float64Array]"===s?r+="fl64":t(new Error("Failed to get type for BinaryArray"))),t(r+L(n))}else if("[object Blob]"===s){var a=new FileReader;a.onload=function(){var s="~~local_forage_type~"+e.type+"~"+L(this.result);t("__lfsc__:blob"+s)},a.readAsArrayBuffer(e)}else try{t(JSON.stringify(e))}catch(s){console.error("Couldn't convert value into a JSON string: ",e),t(null,s)}},deserialize:function(e){if("__lfsc__:"!==e.substring(0,N))return JSON.parse(e);var t,s=e.substring(P),n=e.substring(N,P);if("blob"===n&&M.test(s)){var r=s.match(M);t=r[1],s=s.substring(r[0].length)}var o=I(s);switch(n){case"arbf":return o;case"blob":return a([o],{type:t});case"si08":return new Int8Array(o);case"ui08":return new Uint8Array(o);case"uic8":return new Uint8ClampedArray(o);case"si16":return new Int16Array(o);case"ur16":return new Uint16Array(o);case"si32":return new Int32Array(o);case"ui32":return new Uint32Array(o);case"fl32":return new Float32Array(o);case"fl64":return new Float64Array(o);default:throw new Error("Unkown type: "+n)}},stringToBuffer:I,bufferToString:L};function k(e,t,s,n){e.executeSql("CREATE TABLE IF NOT EXISTS "+t.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],s,n)}function R(e,t,s,n,r,a){e.executeSql(s,n,r,(function(e,o){o.code===o.SYNTAX_ERR?e.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[t.storeName],(function(e,i){i.rows.length?a(e,o):k(e,t,(function(){e.executeSql(s,n,r,a)}),a)}),a):a(e,o)}),a)}function B(e,t,s,n){var r=this;e=c(e);var a=new o((function(a,o){r.ready().then((function(){void 0===t&&(t=null);var i=t,l=r._dbInfo;l.serializer.serialize(t,(function(t,c){c?o(c):l.db.transaction((function(s){R(s,l,"INSERT OR REPLACE INTO "+l.storeName+" (key, value) VALUES (?, ?)",[e,t],(function(){a(i)}),(function(e,t){o(t)}))}),(function(t){if(t.code===t.QUOTA_ERR){if(n>0)return void a(B.apply(r,[e,i,s,n-1]));o(t)}}))}))})).catch(o)}));return i(a,s),a}function F(e){return new o((function(t,s){e.transaction((function(n){n.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],(function(s,n){for(var r=[],a=0;a<n.rows.length;a++)r.push(n.rows.item(a).name);t({db:e,storeNames:r})}),(function(e,t){s(t)}))}),(function(e){s(e)}))}))}var G={_driver:"webSQLStorage",_initStorage:function(e){var t=this,s={db:null};if(e)for(var n in e)s[n]="string"!=typeof e[n]?e[n].toString():e[n];var r=new o((function(e,n){try{s.db=openDatabase(s.name,String(s.version),s.description,s.size)}catch(e){return n(e)}s.db.transaction((function(r){k(r,s,(function(){t._dbInfo=s,e()}),(function(e,t){n(t)}))}),n)}));return s.serializer=x,r},_support:"function"==typeof openDatabase,iterate:function(e,t){var s=this,n=new o((function(t,n){s.ready().then((function(){var r=s._dbInfo;r.db.transaction((function(s){R(s,r,"SELECT * FROM "+r.storeName,[],(function(s,n){for(var a=n.rows,o=a.length,i=0;i<o;i++){var l=a.item(i),c=l.value;if(c&&(c=r.serializer.deserialize(c)),void 0!==(c=e(c,l.key,i+1)))return void t(c)}t()}),(function(e,t){n(t)}))}))})).catch(n)}));return i(n,t),n},getItem:function(e,t){var s=this;e=c(e);var n=new o((function(t,n){s.ready().then((function(){var r=s._dbInfo;r.db.transaction((function(s){R(s,r,"SELECT * FROM "+r.storeName+" WHERE key = ? LIMIT 1",[e],(function(e,s){var n=s.rows.length?s.rows.item(0).value:null;n&&(n=r.serializer.deserialize(n)),t(n)}),(function(e,t){n(t)}))}))})).catch(n)}));return i(n,t),n},setItem:function(e,t,s){return B.apply(this,[e,t,s,1])},removeItem:function(e,t){var s=this;e=c(e);var n=new o((function(t,n){s.ready().then((function(){var r=s._dbInfo;r.db.transaction((function(s){R(s,r,"DELETE FROM "+r.storeName+" WHERE key = ?",[e],(function(){t()}),(function(e,t){n(t)}))}))})).catch(n)}));return i(n,t),n},clear:function(e){var t=this,s=new o((function(e,s){t.ready().then((function(){var n=t._dbInfo;n.db.transaction((function(t){R(t,n,"DELETE FROM "+n.storeName,[],(function(){e()}),(function(e,t){s(t)}))}))})).catch(s)}));return i(s,e),s},length:function(e){var t=this,s=new o((function(e,s){t.ready().then((function(){var n=t._dbInfo;n.db.transaction((function(t){R(t,n,"SELECT COUNT(key) as c FROM "+n.storeName,[],(function(t,s){var n=s.rows.item(0).c;e(n)}),(function(e,t){s(t)}))}))})).catch(s)}));return i(s,e),s},key:function(e,t){var s=this,n=new o((function(t,n){s.ready().then((function(){var r=s._dbInfo;r.db.transaction((function(s){R(s,r,"SELECT key FROM "+r.storeName+" WHERE id = ? LIMIT 1",[e+1],(function(e,s){var n=s.rows.length?s.rows.item(0).key:null;t(n)}),(function(e,t){n(t)}))}))})).catch(n)}));return i(n,t),n},keys:function(e){var t=this,s=new o((function(e,s){t.ready().then((function(){var n=t._dbInfo;n.db.transaction((function(t){R(t,n,"SELECT key FROM "+n.storeName,[],(function(t,s){for(var n=[],r=0;r<s.rows.length;r++)n.push(s.rows.item(r).key);e(n)}),(function(e,t){s(t)}))}))})).catch(s)}));return i(s,e),s},dropInstance:function(e,t){t=u.apply(this,arguments);var s=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||s.name,e.storeName=e.storeName||s.storeName);var n,r=this;return i(n=e.name?new o((function(t){var n;n=e.name===s.name?r._dbInfo.db:openDatabase(e.name,"","",0),e.storeName?t({db:n,storeNames:[e.storeName]}):t(F(n))})).then((function(e){return new o((function(t,s){e.db.transaction((function(n){function r(e){return new o((function(t,s){n.executeSql("DROP TABLE IF EXISTS "+e,[],(function(){t()}),(function(e,t){s(t)}))}))}for(var a=[],i=0,l=e.storeNames.length;i<l;i++)a.push(r(e.storeNames[i]));o.all(a).then((function(){t()})).catch((function(e){s(e)}))}),(function(e){s(e)}))}))})):o.reject("Invalid arguments"),t),n}};function W(e,t){var s=e.name+"/";return e.storeName!==t.storeName&&(s+=e.storeName+"/"),s}function Y(){return!function(){try{return localStorage.setItem("_localforage_support_test",!0),localStorage.removeItem("_localforage_support_test"),!1}catch(e){return!0}}()||localStorage.length>0}var j={_driver:"localStorageWrapper",_initStorage:function(e){var t={};if(e)for(var s in e)t[s]=e[s];return t.keyPrefix=W(e,this._defaultConfig),Y()?(this._dbInfo=t,t.serializer=x,o.resolve()):o.reject()},_support:function(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(e){return!1}}(),iterate:function(e,t){var s=this,n=s.ready().then((function(){for(var t=s._dbInfo,n=t.keyPrefix,r=n.length,a=localStorage.length,o=1,i=0;i<a;i++){var l=localStorage.key(i);if(0===l.indexOf(n)){var c=localStorage.getItem(l);if(c&&(c=t.serializer.deserialize(c)),void 0!==(c=e(c,l.substring(r),o++)))return c}}}));return i(n,t),n},getItem:function(e,t){var s=this;e=c(e);var n=s.ready().then((function(){var t=s._dbInfo,n=localStorage.getItem(t.keyPrefix+e);return n&&(n=t.serializer.deserialize(n)),n}));return i(n,t),n},setItem:function(e,t,s){var n=this;e=c(e);var r=n.ready().then((function(){void 0===t&&(t=null);var s=t;return new o((function(r,a){var o=n._dbInfo;o.serializer.serialize(t,(function(t,n){if(n)a(n);else try{localStorage.setItem(o.keyPrefix+e,t),r(s)}catch(e){"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name||a(e),a(e)}}))}))}));return i(r,s),r},removeItem:function(e,t){var s=this;e=c(e);var n=s.ready().then((function(){var t=s._dbInfo;localStorage.removeItem(t.keyPrefix+e)}));return i(n,t),n},clear:function(e){var t=this,s=t.ready().then((function(){for(var e=t._dbInfo.keyPrefix,s=localStorage.length-1;s>=0;s--){var n=localStorage.key(s);0===n.indexOf(e)&&localStorage.removeItem(n)}}));return i(s,e),s},length:function(e){var t=this.keys().then((function(e){return e.length}));return i(t,e),t},key:function(e,t){var s=this,n=s.ready().then((function(){var t,n=s._dbInfo;try{t=localStorage.key(e)}catch(e){t=null}return t&&(t=t.substring(n.keyPrefix.length)),t}));return i(n,t),n},keys:function(e){var t=this,s=t.ready().then((function(){for(var e=t._dbInfo,s=localStorage.length,n=[],r=0;r<s;r++){var a=localStorage.key(r);0===a.indexOf(e.keyPrefix)&&n.push(a.substring(e.keyPrefix.length))}return n}));return i(s,e),s},dropInstance:function(e,t){if(t=u.apply(this,arguments),!(e="function"!=typeof e&&e||{}).name){var s=this.config();e.name=e.name||s.name,e.storeName=e.storeName||s.storeName}var n,r=this;return i(n=e.name?new o((function(t){e.storeName?t(W(e,r._defaultConfig)):t(e.name+"/")})).then((function(e){for(var t=localStorage.length-1;t>=0;t--){var s=localStorage.key(t);0===s.indexOf(e)&&localStorage.removeItem(s)}})):o.reject("Invalid arguments"),t),n}},X=function(e,t){for(var s,n,r=e.length,a=0;a<r;){if((s=e[a])===(n=t)||"number"==typeof s&&"number"==typeof n&&isNaN(s)&&isNaN(n))return!0;a++}return!1},U=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},$={},V={},H={INDEXEDDB:O,WEBSQL:G,LOCALSTORAGE:j},q=[H.INDEXEDDB._driver,H.WEBSQL._driver,H.LOCALSTORAGE._driver],K=["dropInstance"],z=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(K),J={description:"",driver:q.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function Q(e,t){e[t]=function(){var s=arguments;return e.ready().then((function(){return e[t].apply(e,s)}))}}function Z(){for(var e=1;e<arguments.length;e++){var t=arguments[e];if(t)for(var s in t)t.hasOwnProperty(s)&&(U(t[s])?arguments[0][s]=t[s].slice():arguments[0][s]=t[s])}return arguments[0]}var ee=new(function(){function e(t){for(var s in function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),H)if(H.hasOwnProperty(s)){var n=H[s],r=n._driver;this[s]=r,$[r]||this.defineDriver(n)}this._defaultConfig=Z({},J),this._config=Z({},this._defaultConfig,t),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch((function(){}))}return e.prototype.config=function(e){if("object"===(void 0===e?"undefined":n(e))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var t in e){if("storeName"===t&&(e[t]=e[t].replace(/\W/g,"_")),"version"===t&&"number"!=typeof e[t])return new Error("Database version must be a number.");this._config[t]=e[t]}return!("driver"in e)||!e.driver||this.setDriver(this._config.driver)}return"string"==typeof e?this._config[e]:this._config},e.prototype.defineDriver=function(e,t,s){var n=new o((function(t,s){try{var n=e._driver,r=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!e._driver)return void s(r);for(var a=z.concat("_initStorage"),l=0,c=a.length;l<c;l++){var u=a[l];if((!X(K,u)||e[u])&&"function"!=typeof e[u])return void s(r)}!function(){for(var t=function(e){return function(){var t=new Error("Method "+e+" is not implemented by the current driver"),s=o.reject(t);return i(s,arguments[arguments.length-1]),s}},s=0,n=K.length;s<n;s++){var r=K[s];e[r]||(e[r]=t(r))}}();var h=function(s){$[n]&&console.info("Redefining LocalForage driver: "+n),$[n]=e,V[n]=s,t()};"_support"in e?e._support&&"function"==typeof e._support?e._support().then(h,s):h(!!e._support):h(!0)}catch(e){s(e)}}));return l(n,t,s),n},e.prototype.driver=function(){return this._driver||null},e.prototype.getDriver=function(e,t,s){var n=$[e]?o.resolve($[e]):o.reject(new Error("Driver not found."));return l(n,t,s),n},e.prototype.getSerializer=function(e){var t=o.resolve(x);return l(t,e),t},e.prototype.ready=function(e){var t=this,s=t._driverSet.then((function(){return null===t._ready&&(t._ready=t._initDriver()),t._ready}));return l(s,e,e),s},e.prototype.setDriver=function(e,t,s){var n=this;U(e)||(e=[e]);var r=this._getSupportedDrivers(e);function a(){n._config.driver=n.driver()}function i(e){return n._extend(e),a(),n._ready=n._initStorage(n._config),n._ready}var c=null!==this._driverSet?this._driverSet.catch((function(){return o.resolve()})):o.resolve();return this._driverSet=c.then((function(){var e=r[0];return n._dbInfo=null,n._ready=null,n.getDriver(e).then((function(e){n._driver=e._driver,a(),n._wrapLibraryMethodsWithReady(),n._initDriver=function(e){return function(){var t=0;return function s(){for(;t<e.length;){var r=e[t];return t++,n._dbInfo=null,n._ready=null,n.getDriver(r).then(i).catch(s)}a();var l=new Error("No available storage method found.");return n._driverSet=o.reject(l),n._driverSet}()}}(r)}))})).catch((function(){a();var e=new Error("No available storage method found.");return n._driverSet=o.reject(e),n._driverSet})),l(this._driverSet,t,s),this._driverSet},e.prototype.supports=function(e){return!!V[e]},e.prototype._extend=function(e){Z(this,e)},e.prototype._getSupportedDrivers=function(e){for(var t=[],s=0,n=e.length;s<n;s++){var r=e[s];this.supports(r)&&t.push(r)}return t},e.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0,t=z.length;e<t;e++)Q(this,z[e])},e.prototype.createInstance=function(t){return new e(t)},e}());t.exports=ee},{3:3}]},{},[4])(4)}).call(this,s(28))},function(e,t,s){var n,r=function(){var e=String.fromCharCode,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",n={};function r(e,t){if(!n[e]){n[e]={};for(var s=0;s<e.length;s++)n[e][e.charAt(s)]=s}return n[e][t]}var a={compressToBase64:function(e){if(null==e)return"";var s=a._compress(e,6,(function(e){return t.charAt(e)}));switch(s.length%4){default:case 0:return s;case 1:return s+"===";case 2:return s+"==";case 3:return s+"="}},decompressFromBase64:function(e){return null==e?"":""==e?null:a._decompress(e.length,32,(function(s){return r(t,e.charAt(s))}))},compressToUTF16:function(t){return null==t?"":a._compress(t,15,(function(t){return e(t+32)}))+" "},decompressFromUTF16:function(e){return null==e?"":""==e?null:a._decompress(e.length,16384,(function(t){return e.charCodeAt(t)-32}))},compressToUint8Array:function(e){for(var t=a.compress(e),s=new Uint8Array(2*t.length),n=0,r=t.length;n<r;n++){var o=t.charCodeAt(n);s[2*n]=o>>>8,s[2*n+1]=o%256}return s},decompressFromUint8Array:function(t){if(null==t)return a.decompress(t);for(var s=new Array(t.length/2),n=0,r=s.length;n<r;n++)s[n]=256*t[2*n]+t[2*n+1];var o=[];return s.forEach((function(t){o.push(e(t))})),a.decompress(o.join(""))},compressToEncodedURIComponent:function(e){return null==e?"":a._compress(e,6,(function(e){return s.charAt(e)}))},decompressFromEncodedURIComponent:function(e){return null==e?"":""==e?null:(e=e.replace(/ /g,"+"),a._decompress(e.length,32,(function(t){return r(s,e.charAt(t))})))},compress:function(t){return a._compress(t,16,(function(t){return e(t)}))},_compress:function(e,t,s){if(null==e)return"";var n,r,a,o={},i={},l="",c="",u="",h=2,d=3,f=2,g=[],p=0,m=0;for(a=0;a<e.length;a+=1)if(l=e.charAt(a),Object.prototype.hasOwnProperty.call(o,l)||(o[l]=d++,i[l]=!0),c=u+l,Object.prototype.hasOwnProperty.call(o,c))u=c;else{if(Object.prototype.hasOwnProperty.call(i,u)){if(u.charCodeAt(0)<256){for(n=0;n<f;n++)p<<=1,m==t-1?(m=0,g.push(s(p)),p=0):m++;for(r=u.charCodeAt(0),n=0;n<8;n++)p=p<<1|1&r,m==t-1?(m=0,g.push(s(p)),p=0):m++,r>>=1}else{for(r=1,n=0;n<f;n++)p=p<<1|r,m==t-1?(m=0,g.push(s(p)),p=0):m++,r=0;for(r=u.charCodeAt(0),n=0;n<16;n++)p=p<<1|1&r,m==t-1?(m=0,g.push(s(p)),p=0):m++,r>>=1}0==--h&&(h=Math.pow(2,f),f++),delete i[u]}else for(r=o[u],n=0;n<f;n++)p=p<<1|1&r,m==t-1?(m=0,g.push(s(p)),p=0):m++,r>>=1;0==--h&&(h=Math.pow(2,f),f++),o[c]=d++,u=String(l)}if(""!==u){if(Object.prototype.hasOwnProperty.call(i,u)){if(u.charCodeAt(0)<256){for(n=0;n<f;n++)p<<=1,m==t-1?(m=0,g.push(s(p)),p=0):m++;for(r=u.charCodeAt(0),n=0;n<8;n++)p=p<<1|1&r,m==t-1?(m=0,g.push(s(p)),p=0):m++,r>>=1}else{for(r=1,n=0;n<f;n++)p=p<<1|r,m==t-1?(m=0,g.push(s(p)),p=0):m++,r=0;for(r=u.charCodeAt(0),n=0;n<16;n++)p=p<<1|1&r,m==t-1?(m=0,g.push(s(p)),p=0):m++,r>>=1}0==--h&&(h=Math.pow(2,f),f++),delete i[u]}else for(r=o[u],n=0;n<f;n++)p=p<<1|1&r,m==t-1?(m=0,g.push(s(p)),p=0):m++,r>>=1;0==--h&&(h=Math.pow(2,f),f++)}for(r=2,n=0;n<f;n++)p=p<<1|1&r,m==t-1?(m=0,g.push(s(p)),p=0):m++,r>>=1;for(;;){if(p<<=1,m==t-1){g.push(s(p));break}m++}return g.join("")},decompress:function(e){return null==e?"":""==e?null:a._decompress(e.length,32768,(function(t){return e.charCodeAt(t)}))},_decompress:function(t,s,n){var r,a,o,i,l,c,u,h=[],d=4,f=4,g=3,p="",m=[],y={val:n(0),position:s,index:1};for(r=0;r<3;r+=1)h[r]=r;for(o=0,l=Math.pow(2,2),c=1;c!=l;)i=y.val&y.position,y.position>>=1,0==y.position&&(y.position=s,y.val=n(y.index++)),o|=(i>0?1:0)*c,c<<=1;switch(o){case 0:for(o=0,l=Math.pow(2,8),c=1;c!=l;)i=y.val&y.position,y.position>>=1,0==y.position&&(y.position=s,y.val=n(y.index++)),o|=(i>0?1:0)*c,c<<=1;u=e(o);break;case 1:for(o=0,l=Math.pow(2,16),c=1;c!=l;)i=y.val&y.position,y.position>>=1,0==y.position&&(y.position=s,y.val=n(y.index++)),o|=(i>0?1:0)*c,c<<=1;u=e(o);break;case 2:return""}for(h[3]=u,a=u,m.push(u);;){if(y.index>t)return"";for(o=0,l=Math.pow(2,g),c=1;c!=l;)i=y.val&y.position,y.position>>=1,0==y.position&&(y.position=s,y.val=n(y.index++)),o|=(i>0?1:0)*c,c<<=1;switch(u=o){case 0:for(o=0,l=Math.pow(2,8),c=1;c!=l;)i=y.val&y.position,y.position>>=1,0==y.position&&(y.position=s,y.val=n(y.index++)),o|=(i>0?1:0)*c,c<<=1;h[f++]=e(o),u=f-1,d--;break;case 1:for(o=0,l=Math.pow(2,16),c=1;c!=l;)i=y.val&y.position,y.position>>=1,0==y.position&&(y.position=s,y.val=n(y.index++)),o|=(i>0?1:0)*c,c<<=1;h[f++]=e(o),u=f-1,d--;break;case 2:return m.join("")}if(0==d&&(d=Math.pow(2,g),g++),h[u])p=h[u];else{if(u!==f)return null;p=a+a.charAt(0)}m.push(p),h[f++]=a+p.charAt(0),a=p,0==--d&&(d=Math.pow(2,g),g++)}}};return a}();void 0===(n=function(){return r}.call(t,s,t,e))||(e.exports=n)},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Engine=void 0;const i=o(s(0)),l=a(s(57)),c=s(504),u=s(225);t.Engine=class{constructor(e){this.isGUICommand=()=>!1,this.doGUICommand=null,this.nextActor=null,this.animation=null,this.animationCallback=null,this._levelMap={},this._activeLevels=[],this._scheduler=new l.Scheduler,this._msg=new u.MessageHandler(e),this._eventPool=e,this.visibleCells=[],this.timeOfDay=0,this._cache={visibleCoord:{},visibleValid:!1},this.sysMan=new c.SystemManager(this,e),this.hasNotify=!0,this._eventPool.listenEvent(i.default.EVT_DESTROY_ITEM,this),this._eventPool.listenEvent(i.default.EVT_ACT_COMP_ENABLED,this),this._eventPool.listenEvent(i.default.EVT_ACT_COMP_DISABLED,this),this._eventPool.listenEvent(i.default.EVT_LEVEL_PROP_ADDED,this),this._eventPool.listenEvent(i.default.EVT_LEVEL_CHANGED,this),this._eventPool.listenEvent(i.default.EVT_ANIMATION,this),this._eventPool.listenEvent(i.default.EVT_ACTOR_KILLED,this),this.debugEnabled=!1,this.traceIDs={}}setSystemArgs(e){this.sysMan.setSystemArgs(e)}getMessages(){return this._msg.getMessages()}hasNewMessages(){return this._msg.hasNew()}clearMessages(){this._msg.clear()}setRNG(e){this.sysMan.setRNG(e)}isMenuShown(){if(!this.hasAnimation()&&this.nextActor.isPlayer()){return this.nextActor.getBrain().isMenuShown()}return!1}getPlayer(){return this.currPlayer}setPlayer(e){this.currPlayer=e}numActiveLevels(){return this._activeLevels.length}hasLevel(e){return this._levelMap.hasOwnProperty(e.getID())}getLevels(){return Object.values(this._levelMap)}isGameOver(){return!1}isActiveLevel(e){return this._activeLevels.indexOf(e.getID())>=0}hasAnimation(){return null!==this.animation&&this.animation.hasFrames()}finishAnimation(){this.animation=null}setVisibleArea(e,t){this.visibleLevelID=e.getID(),this.visibleCells=t,this._cache.visibleCoord={},this._cache.visibleValid=!1}canPlayerSeeAnimation(e){return e.levelID===this.visibleLevelID&&(this._cache.visibleValid||(this.visibleCells.forEach(e=>{this._cache.visibleCoord[e.getKeyXY()]=!0}),this._cache.visibleValid=!0),e.hasCoord(this._cache.visibleCoord))}enableAnimations(){this.sysMan.get("Animation").enableAnimations()}disableAnimations(){this.sysMan.get("Animation").disableAnimations()}addTimeSystem(e,t){const s=new l.GameEvent(100,t.update.bind(t),!0,0);this.addEvent(s)}addRegularUpdate(e,t=100){const s=new l.GameEvent(t,e.update.bind(e),!0,0);this.addEvent(s)}getComponents(){const e=this.getEntities();let t=[];return e.forEach(e=>{const s=Object.keys(e.getComponents());t=t.concat(s.map(e=>parseInt(e,10)))}),t}getEntities(){const e=this.getLevels();let t=[];return e.forEach(e=>{t=t.concat(e.getActors()),t=t.concat(e.getItems()),t=t.concat(e.getElements())}),t}updateGameLoop(e){this.playerCommand(e),this.currPlayer=this.nextActor,this.sysMan.updateLoopSystems();const t={timeOfDay:this.timeOfDay};this.nextActor=this.getNextActor();let s=this.nextActor;this.debugEnabled&&s.getID&&this.traceIDs[s.getID()]&&console.debug("updateGameLoop out-of-while ID:",s.getID());let n=1e4,r=0;for(;!this.nextActor.isPlayer()&&!this.isGameOver();){this.debugEnabled&&(s=this.nextActor,s.getID&&this.traceIDs[s.getID()]&&console.debug(r,"updateGameLoop start, ID:",s.getID()));const e=this.nextActor.nextAction(t);if(this.doAction(e),this.sysMan.updateSystems(),this._scheduler.setAction(e),this.debugEnabled&&(s=this.nextActor,s.getID&&this.traceIDs[s.getID()]&&console.debug(r,"updateGameLoop loop end, ID:",s.getID())),this.nextActor=this.getNextActor(),s=this.nextActor,this.debugEnabled&&s.getID&&this.traceIDs[s.getID()]&&console.debug(r,"updateGameLoop next will be, ID:",s.getID()),s.has&&s.has("Dead")&&i.default.err("Engine","simulateGame","Tried to schedule Dead actor ID: "+s.getID()),!this.nextActor){i.default.err("Game.Engine","updateGameLoop","Game loop out of events! Fatal!");break}if(--n,n<=0){i.default.err("Engine","updateGameLoop","GameLoop stuck. 10K events taken, no player");break}++r}this.isGameOver()||this.setPlayer(this.nextActor)}playerCommand(e){!1===this.nextActor.isPlayer()&&this.nextActorNotPlayerError();const t=this.nextActor,s=t.get("Action");s.setStatus(i.default.ACTION_OK);const n=t.nextAction(e);this.doAction(n),this.sysMan.updateSystems(),t.has("ImpossibleCmd")?t.remove("ImpossibleCmd"):this._scheduler.setAction(n);const r=s.getMsg();""!==r&&(i.default.gameDanger({cell:t.getCell(),msg:r}),t.get("Action").setMsg("")),this.playerCommandCallback(t)}simulateGame(e=1){const t={timeOfDay:this.timeOfDay};for(let s=0;s<e;s++){this.nextActor=this.getNextActor();const e=this.nextActor;if(e.has&&e.has("Dead")&&i.default.err("Engine","simulateGame","Tried to schedule Dead actor ID: "+e.getID()),this.nextActor.isPlayer())i.default.err("Engine","simulateGame","Doesn't work with player.");else{const e=this.nextActor.nextAction(t);this.doAction(e),this.sysMan.updateSystems(),this._scheduler.setAction(e)}}}addLevel(e){const t=e.getID();this._levelMap.hasOwnProperty(t)?i.default.err("Game.Engine","addLevel","Level ID "+t+" already exists!"):this._levelMap[e.getID()]=e}removeLevels(e){e.forEach(e=>{const t=e.getID();if(this._levelMap.hasOwnProperty(t)){const e=this._activeLevels.indexOf(t);if(e>=0){this._activeLevels.splice(e,1);const s=this._levelMap[t];if(s){const e=s.getActors();for(let t=0;t<e.length;t++)e[t].get("Action").disable()}}delete this._levelMap[t]}else i.default.err("Game.Engine","removeLevels","No level with ID "+t)})}addActiveLevel(e){const t=e.getID(),s=this._activeLevels.indexOf(t);if(this._activeLevels.length===i.default.MAX_ACTIVE_LEVELS)if(-1===s){const e=this._activeLevels.pop(),t=this._levelMap[e];if(t){const e=t.getActors();for(let t=0;t<e.length;t++){const s=e[t].get("Action");s&&s.disable()}i.default.debug(this,"Removed active level to make space...")}else{const t=Object.keys(this._levelMap).join(", ");i.default.err("Game.Engine","addActiveLevel",`Failed to remove level ID ${e}.\n                        IDs: ${t}`)}}else this._activeLevels.splice(s,1),this._activeLevels.unshift(t),i.default.debug(this,"Moved level to the front of active levels.");if(-1===s){this._activeLevels.unshift(t);const s=e.getActors();for(let e=0;e<s.length;e++){const t=s[e].get("Action");t&&t.enable()}}else this._activeLevels.splice(s,1),this._activeLevels.unshift(t)}notify(e,t){if(e===i.default.EVT_DESTROY_ITEM){const e=t.item;e.getOwner().getOwner().getInvEq().removeItem(e)||i.default.err("Game.Engine","notify - DESTROY_ITEM","Failed to remove item from inventory.")}else if(e===i.default.EVT_ACT_COMP_ENABLED)t.hasOwnProperty("actor")?(this.addActor(t.actor),this.traceIDs[t.actor.getID()]&&console.debug("EVT_ACT_COMP_ENABLED Added actor with ID: ",t.actor.getID())):i.default.err("Game.Engine","notify - ACT_COMP_ENABLED","No actor specified for the event.");else if(e===i.default.EVT_ACT_COMP_DISABLED)t.hasOwnProperty("actor")?this.removeActor(t.actor):i.default.err("Game","notify - ACT_COMP_DISABLED","No actor specified for the event.");else if(e===i.default.EVT_LEVEL_PROP_ADDED){if("actors"===t.propType&&this.isActiveLevel(t.level)){const e=t.obj;this.traceIDs[e.getID()]&&console.debug("Enabling Action comp for: ",e.getID()),t.obj.get("Action").enable()}}else if(e===i.default.EVT_LEVEL_CHANGED){const e=t.actor;e.isPlayer()&&(this.addActiveLevel(e.getLevel()),t.src.onExit(),t.src.onFirstExit(),t.target.onEnter(),t.target.onFirstEnter())}else if(e===i.default.EVT_ACTOR_KILLED){if(t.hasOwnProperty("actor")){if(this.debugEnabled&&this.traceIDs[t.actor.getID()]){const e=t.actor.getID();console.debug(`@@Actor ID${e} killed. Remove from scheduler/Engine now`)}this.removeActor(t.actor)}}else e===i.default.EVT_ANIMATION&&this.canPlayerSeeAnimation(t.animation)&&this.animationCallback&&(this.animation?this.animation.combine(t.animation):this.animation=t.animation,this.animationCallback(this.animation))}update(e){if(this.isGameOver())this.clearMessages(),this._eventPool.emitEvent(i.default.EVT_MSG,{msg:"GAME OVER!"}),this.simulateGame(100);else if(this.clearMessages(),null!==this.nextActor)if(e.hasOwnProperty("code")){const t=e.code;!this.isMenuShown()&&this.isGUICommand(t)?(this.doGUICommand(t),this.playerCommandCallback(this.nextActor)):this.updateGameLoop({code:t})}else this.updateGameLoop(e)}getNextActor(){return this._scheduler.next()}addActor(e){this._scheduler.add(e,!0,0)}removeActor(e){const t=this._scheduler.remove(e);if(this.debugEnabled&&this.traceIDs[e.getID()]&&console.debug("Engine rm from scheduler: ",JSON.stringify(e)),!t){const t=`ID: ${e.getID()}, ${e.getName()}`;i.default.err("Engine","removeActor","Failed to remove actor from scheduler: "+t)}}addEvent(e){const t=e.getRepeat(),s=e.getOffset();this._scheduler.add(e,t,s)}doAction(e){if(e.doAction(),e.hasOwnProperty("energy")&&e.hasOwnProperty("actor")){const t=e.actor;t.has("Action")&&t.get("Action").addEnergy(e.energy)}}toJSON(){return{msgHandler:this._msg.toJSON(),activeLevels:this._activeLevels}}nextActorNotPlayerError(){let e="";if(this.nextActor.hasOwnProperty("isEvent"))e="Expected player, got an event: ";else{e="Expected player, got: "+this.nextActor.getName()}e+="\n"+JSON.stringify(this.nextActor),i.default.err("Engine","playerCommand",e)}}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemManager=void 0;const r=n(s(0)),a=s(505);class o{constructor(e,t){this._engine=e,this.systemOrder=o.systemOrder;const s={};Object.keys(o.systems).forEach(e=>{const n=o.systems[e];if(n.create){const r=n;s[e]=r.create(r.comps,t)}else Array.isArray(n)&&(a.System[e]?s[e]=new a.System[e](n,t):r.default.err("SystemManager","new",`System[${e}] not found for new`))}),this.systems=s,this.loopSystemOrder=["Hunger"],this.loopSystems={},this.loopSystems.Hunger=new a.System.Hunger(["Action","Hunger"],t),this.timeSystems={};const n=new a.System.TimeEffects(["Expiration","Poison","Fading","Heat","Coldness","DirectDamage","RegenEffect","Drowning"],t);this.timeSystems.TimeEffects=n,this._engine.addTimeSystem("TimeEffects",n)}static addSystemBefore(e,t){const s=o.systemOrder.indexOf(t);s>=0&&o.insertSystemAt(s,e)}static addSystemAfter(e,t){const s=o.systemOrder.indexOf(t);s>=0&&o.insertSystemAt(s+1,e)}static removeSystem(e){delete o.systems[e];const t=o.systemOrder.indexOf(e);t>=0&&o.systemOrder.splice(t,1)}static insertSystemAt(e,t){o.systemOrder.splice(e,0,t.name),"function"==typeof t.create?t.name?o.systems[t.name]=t:r.default.err("SystemManager","insertSystemAt","No system.name given"):r.default.err("SystemManager","insertSystemAt","Object must specify system.create")}get(e){return this.systems.hasOwnProperty(e)?this.systems[e]:null}updateSystems(){for(let e=0;e<this.systemOrder.length;e++){const t=this.systemOrder[e];this.systems[t].update()}}updateLoopSystems(){for(let e=0;e<this.loopSystemOrder.length;e++){const t=this.loopSystemOrder[e];this.loopSystems[t].update()}}setRNG(e){Object.values(this.systems).forEach(t=>{t.setRNG(e)})}setSystemArgs(e){Object.values(this.systems).forEach(t=>{t.setArgs(e)})}}t.SystemManager=o,o.systemOrder=["AreaEffects","Disability","SpiritBind","BaseAction","Equip","Attack","AttackRanged","Chat","Shop","SpellCast","SpellEffect","Missile","Movement","Effects","Animation","DrainStats","Damage","Death","Mining","Farming","Crafting","Battle","Skills","Quest","ExpPoints","Communication","Events","ZoneEvents","Weather","WorldSim","OnCbs"],o.systems={AreaEffects:["Flame"],Disability:["Stun","Entrapped","Paralysis"],SpiritBind:["SpiritBind"],BaseAction:["Pickup","UseStairs","OpenDoor","UseItem","UseElement","Jump","Read","Rest","Give"],Equip:["Equip"],Attack:["Attack"],AttackRanged:["AttackRanged"],Chat:["Chat"],Shop:["Transaction"],SpellCast:["SpellCast","PowerDrain"],SpellEffect:["SpellRay","SpellCell","SpellMissile","SpellArea","SpellSelf"],Missile:["Missile"],Movement:["Movement"],OnCbs:["OnAddCb","OnRemoveCb"],Effects:["Effects"],Animation:["Animation"],DrainStats:["DrainStat"],Damage:["Damage","Health"],Death:["DeathEvent"],Mining:["Mining"],Farming:["Farming","WorldSimEvent"],Crafting:["Crafting"],Battle:["BattleOver","BattleOrder","BattleEvent"],Skills:["SkillsExp"],Quest:["GiveQuest","QuestCompleted","QuestTargetEvent"],Events:["Event"],ExpPoints:["ExpPoints","Experience"],Communication:["Communication"],ZoneEvents:["ZoneEvent"],Weather:["WeatherEffect"],WorldSim:["WorldSimEvent"]}},function(e,t,s){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemMining=t.SystemOnCbs=t.SystemWeather=t.SystemWorldSim=t.SystemZoneEvents=t.SystemTimeEffects=t.SystemSpiritBind=t.SystemSpellEffect=t.SystemSpellCast=t.SystemSkills=t.SystemShop=t.SystemQuest=t.SystemMovement=t.SystemMissile=t.SystemHunger=t.SystemFarming=t.SystemExpPoints=t.SystemEvents=t.SystemEquip=t.SystemEffects=t.SystemDisability=t.SystemDrainStats=t.SystemDeath=t.SystemDamage=t.SystemCrafting=t.SystemCommunication=t.SystemChat=t.SystemBattle=t.SystemBaseAction=t.SystemAttackRanged=t.SystemAttack=t.SystemAreaEffects=t.SystemAnimation=t.SystemBase=t.System=void 0;const r=n(s(0));t.System={};const a=s(3);var o=s(3);Object.defineProperty(t,"SystemBase",{enumerable:!0,get:function(){return o.SystemBase}}),t.System.Base=a.SystemBase;const i=s(226);var l=s(226);Object.defineProperty(t,"SystemAnimation",{enumerable:!0,get:function(){return l.SystemAnimation}}),t.System.Animation=i.SystemAnimation;const c=s(227);var u=s(227);Object.defineProperty(t,"SystemAreaEffects",{enumerable:!0,get:function(){return u.SystemAreaEffects}}),t.System.AreaEffects=c.SystemAreaEffects;const h=s(228);var d=s(228);Object.defineProperty(t,"SystemAttack",{enumerable:!0,get:function(){return d.SystemAttack}}),t.System.Attack=h.SystemAttack;const f=s(229);var g=s(229);Object.defineProperty(t,"SystemAttackRanged",{enumerable:!0,get:function(){return g.SystemAttackRanged}}),t.System.AttackRanged=f.SystemAttackRanged;const p=s(230);var m=s(230);Object.defineProperty(t,"SystemBaseAction",{enumerable:!0,get:function(){return m.SystemBaseAction}}),t.System.BaseAction=p.SystemBaseAction;const y=s(231);var _=s(231);Object.defineProperty(t,"SystemBattle",{enumerable:!0,get:function(){return _.SystemBattle}}),t.System.Battle=y.SystemBattle;const b=s(232);var v=s(232);Object.defineProperty(t,"SystemChat",{enumerable:!0,get:function(){return v.SystemChat}}),t.System.Chat=b.SystemChat;const E=s(233);var S=s(233);Object.defineProperty(t,"SystemCommunication",{enumerable:!0,get:function(){return S.SystemCommunication}}),t.System.Communication=E.SystemCommunication;const w=s(234);var C=s(234);Object.defineProperty(t,"SystemCrafting",{enumerable:!0,get:function(){return C.SystemCrafting}}),t.System.Crafting=w.SystemCrafting;const T=s(235);var O=s(235);Object.defineProperty(t,"SystemDamage",{enumerable:!0,get:function(){return O.SystemDamage}}),t.System.Damage=T.SystemDamage;const A=s(236);var M=s(236);Object.defineProperty(t,"SystemDeath",{enumerable:!0,get:function(){return M.SystemDeath}}),t.System.Death=A.SystemDeath;const N=s(237);var P=s(237);Object.defineProperty(t,"SystemDrainStats",{enumerable:!0,get:function(){return P.SystemDrainStats}}),t.System.DrainStats=N.SystemDrainStats;const D=s(238);var I=s(238);Object.defineProperty(t,"SystemDisability",{enumerable:!0,get:function(){return I.SystemDisability}}),t.System.Disability=D.SystemDisability;const L=s(142);var x=s(142);Object.defineProperty(t,"SystemEffects",{enumerable:!0,get:function(){return x.SystemEffects}}),t.System.Effects=L.SystemEffects;const k=s(239);var R=s(239);Object.defineProperty(t,"SystemEquip",{enumerable:!0,get:function(){return R.SystemEquip}}),t.System.Equip=k.SystemEquip;const B=s(240);var F=s(240);Object.defineProperty(t,"SystemEvents",{enumerable:!0,get:function(){return F.SystemEvents}}),t.System.Events=B.SystemEvents;const G=s(241);var W=s(241);Object.defineProperty(t,"SystemExpPoints",{enumerable:!0,get:function(){return W.SystemExpPoints}}),t.System.ExpPoints=G.SystemExpPoints;const Y=s(242);var j=s(242);Object.defineProperty(t,"SystemFarming",{enumerable:!0,get:function(){return j.SystemFarming}}),t.System.Farming=Y.SystemFarming;const X=s(243);var U=s(243);Object.defineProperty(t,"SystemHunger",{enumerable:!0,get:function(){return U.SystemHunger}}),t.System.Hunger=X.SystemHunger;const $=s(244);var V=s(244);Object.defineProperty(t,"SystemMissile",{enumerable:!0,get:function(){return V.SystemMissile}}),t.System.Missile=$.SystemMissile;const H=s(245);var q=s(245);Object.defineProperty(t,"SystemMovement",{enumerable:!0,get:function(){return q.SystemMovement}}),t.System.Movement=H.SystemMovement;const K=s(66);var z=s(66);Object.defineProperty(t,"SystemQuest",{enumerable:!0,get:function(){return z.SystemQuest}}),t.System.Quest=K.SystemQuest;const J=s(246);var Q=s(246);Object.defineProperty(t,"SystemShop",{enumerable:!0,get:function(){return Q.SystemShop}}),t.System.Shop=J.SystemShop;const Z=s(247);var ee=s(247);Object.defineProperty(t,"SystemSkills",{enumerable:!0,get:function(){return ee.SystemSkills}}),t.System.Skills=Z.SystemSkills;const te=s(248);var se=s(248);Object.defineProperty(t,"SystemSpellCast",{enumerable:!0,get:function(){return se.SystemSpellCast}}),t.System.SpellCast=te.SystemSpellCast;const ne=s(249);var re=s(249);Object.defineProperty(t,"SystemSpellEffect",{enumerable:!0,get:function(){return re.SystemSpellEffect}}),t.System.SpellEffect=ne.SystemSpellEffect;const ae=s(250);var oe=s(250);Object.defineProperty(t,"SystemSpiritBind",{enumerable:!0,get:function(){return oe.SystemSpiritBind}}),t.System.SpiritBind=ae.SystemSpiritBind;const ie=s(251);var le=s(251);Object.defineProperty(t,"SystemTimeEffects",{enumerable:!0,get:function(){return le.SystemTimeEffects}}),t.System.TimeEffects=ie.SystemTimeEffects;const ce=s(252);var ue=s(252);Object.defineProperty(t,"SystemZoneEvents",{enumerable:!0,get:function(){return ue.SystemZoneEvents}}),t.System.ZoneEvents=ce.SystemZoneEvents;const he=s(253);var de=s(253);Object.defineProperty(t,"SystemWorldSim",{enumerable:!0,get:function(){return de.SystemWorldSim}}),t.System.WorldSim=he.SystemWorldSim;const fe=s(254);var ge=s(254);Object.defineProperty(t,"SystemWeather",{enumerable:!0,get:function(){return ge.SystemWeather}}),t.System.Weather=fe.SystemWeather;const pe=s(255);var me=s(255);Object.defineProperty(t,"SystemOnCbs",{enumerable:!0,get:function(){return me.SystemOnCbs}}),t.System.OnCbs=pe.SystemOnCbs;const ye=s(256);var _e=s(256);Object.defineProperty(t,"SystemMining",{enumerable:!0,get:function(){return _e.SystemMining}}),t.System.Mining=ye.SystemMining,t.System.defineSystem=function(e){const s=e.toUpperCase();r.default.SYS[s]=Symbol();const n=class extends a.SystemBase{constructor(e,t,n){super(r.default.SYS[s],e,n),this._init&&"function"==typeof this._init&&this._init(e,...t)}};return t.System[e]=n,n},t.System.undefineSystem=function(e){const s=e.toUpperCase();delete r.default.SYS[s],delete t.System[e]}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Animation=void 0;t.Animation=class{constructor(){this.levelID=-1,this.numFrames=0,this.currFrame=0,this.slowDown=2,this.frames=[]}setLevel(e){this.levelID=e.getID()}addFrame(e){for(let t=0;t<this.slowDown;t++)++this.numFrames,this.frames.push(e)}nextFrame(){return this.frames[this.currFrame++]}hasFrames(){return this.currFrame<this.frames.length}combine(e){let t=0;for(;e.hasFrames();){const s=e.nextFrame();if(t<this.frames.length){const e=Object.keys(s);for(let n=0;n<e.length;n++){const r=e[n];this.frames[t][r]=s[r]}}else this.frames.push(s);++t}}hasCoord(e){const t=this.frames.length;for(let s=0;s<t;s++){const t=this.frames[s];for(const s in t)if(e[s])return!0}return!1}}},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Wall2Items=t.Wall2Floor=void 0;const n=s(8);t.Wall2Floor={wall:n.ELEM.FLOOR,walldungeon:n.ELEM.FLOOR_DUNGEON,wallwooden:n.ELEM.FLOOR_HOUSE,wallcave:n.ELEM.FLOOR_CAVE,wallcrypt:n.ELEM.FLOOR_CRYPT,wallcastle:n.ELEM.FLOOR_CASTLE},t.Wall2Items={wall:{always:["piece of stone"],rand:{nothing:97,goldcoin:3}},walldungeon:{always:["piece of stone"],rand:{nothing:90,goldcoin:5}},wallwooden:{always:["piece of wood"]},wallcave:{always:["piece of stone"],rand:{nothing:200,goldcoin:16,"iron ore":8,"copper ore":8,amethyst:8,topaz:4,"mithril ore":4,sapphire:2,emerald:2,"adamantium ore":2,diamond:1}},wallcrypt:{always:["piece of stone"],rand:{nothing:90,goldcoin:3,topaz:3,amethyst:3,"lapis lazuli":3}},wallcastle:{always:["piece of stone"],rand:{nothing:90,goldcoin:10}},wallice:{always:["piece of ice"],rand:{nothing:90,"permaice ore":3,"ice diamond":1,froststone:3,"adamantium ore":4}}}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GameMaster=void 0;const i=o(s(0)),l=s(509),c=s(94),u=s(37),h=s(1),d=s(18),f=s(12),g=a(s(2)),p=s(5)("bitn:GameMaster"),m=f.EventPool.getPool(),y=h.Random.getRNG();t.GameMaster=class{constructor(e,t=m){this.player=null,this.game=e,this.fact=new l.FactoryBattle,this.pool=t,this.battles={},this.battlesDone={},this.hasBattleSpawned={},this.hasNotify=!0,this.pool.listenEvent(i.default.EVT_LEVEL_CHANGED,this),this.pool.listenEvent(i.default.EVT_TILE_CHANGED,this),this.pool.listenEvent(i.default.EVT_BATTLE_OVER,this),this.pool.listenEvent(i.default.EVT_CREATE_BATTLE,this)}setDebug(e){p.enabled=e}setBattles(e){this.battles=e}setPool(e){this.pool=e}setGame(e){this.game=e}setPlayer(e){this.player=e}setWorld(e){this.world=e}notify(e,t){if(e===i.default.EVT_LEVEL_CHANGED){p("EVT_LEVEL_CHANGED");const{actor:e}=t;e.isPlayer()&&(e.has("InBattle")?this.removePlayerFromBattle(t):this.tryToAddPlayerToBattle(t))}else if(e===i.default.EVT_CREATE_BATTLE){p("EVT_CREATE_BATTLE");const{areaTile:e}=t;t.response&&i.default.err("GameMaster","notify<EVT_CREATE_BATTLE>","Args has response already: "+JSON.stringify(t));const s=e.getLevel(),n=this.createBattleIntoAreaTileLevel(s);n&&(t.response={battle:n})}else if(e===i.default.EVT_TILE_CHANGED){if(p("EVT_TILE_CHANGED"),!this.player)return void p("\tBut player is NULL for the moment");p("\tPlayer not null. Creating battle");const e=this.player.getLevel();this.hasBattleSpawned[e.getID()]||this.createBattleIntoAreaTileLevel(e)}else if(e===i.default.EVT_EXPLORED_ZONE_LEFT)i.default.diag("Explored zone left");else if(e===i.default.EVT_BATTLE_OVER){const{battle:e}=t;p("EVT_BATTLE_OVER: "+e.getName());const s=e.getLevel().getID();if(p(`1. battlesDone for ${s}: ${this.battlesDone[s]}`),!this.battlesDone[s]&&e){p(`2. battlesDone for ${s}: ${this.battlesDone[s]}`),this.battlesDone[s]=!0,p(`3. battlesDone for ${s}: ${this.battlesDone[s]}`),this.addBadgesForActors(e),this.moveActorsOutOfBattle(e),this.createBattleEvent(e);const t=e.getName();i.default.gameMsg(`Battle ${t} is over!`)}else{const e=JSON.stringify(t);i.default.err("Game.Master","notify",`Args ${e} does not contain "battle"`)}p("GameMaster registered battle over")}}getLevelBbox(e,t,s,n,r){const[a,o]=[e.getSizeX(),e.getSizeY()],[i,l]=n,[c,u]=[t.getSizeX(),t.getSizeY()],[h,f]=r.getColsRows(),g=c*h/a,p=u*f/o,m=i%(a/c),y=l%(o/u);return d.BBox.fromBBox({ulx:m*g,uly:y*p,lrx:(m+1)*g-1,lry:(y+1)*p-1})}tryToAddPlayerToBattle(e){const{actor:t,target:s,src:n}=e,r=n.getID();if(this.battles.hasOwnProperty(r)){p("tryToAddPlayerToBattle",r,"->",s.getID());const e=this.getBattle(r,s.getID());if(!e||e.isJSON)return;const n=e;if(n.getLevel().getID()===s.getID())if(this.actorCanEnter(t,n)){const e=new g.InBattle;e.setData({name:n.getName()}),t.add(e);const s=this.getSelArmyObject(t,n);t.getBrain().setSelectionObject(s)}else n.isOver()?i.default.gameMsg("Looks like the battle is already fought.."):i.default.gameMsg("You cannot join the fight anymore, deserter.")}}addBattle(e,t){this.battles.hasOwnProperty(e)||(this.battles[e]=[]),this.battles[e].push(t)}getBattle(e,t){return this.battles[e].find(e=>{if(e.isJSON)return!1;return e.getLevel().getID()===t})}getBattles(e){return this.battles[e]}actorCanEnter(e,t){return!t.isOver()&&!this.actorDesertedBattle(e,t)}removePlayerFromBattle(e){const{actor:t,target:s,src:n}=e,r=s.getID(),a=n.getID(),o=this.getBattle(r,a),l=o.getLevel().getID(),c=t.get("InBattle").getData();if(a!==l){const e=`Level ID mismatch: ${a} !== ${l}`;i.default.err("GameMaster","removePlayerFromBattle",e)}if(!o.isOver()&&c.army){const e=new g.BattleBadge;e.setData({status:"Fled",name:o.getName(),army:c.army}),t.add(e),t.remove("InBattle"),t.add(new g.BattleOver)}else o.isOver()||c.army||t.remove("InBattle")}addBadgesForActors(e){e.getArmies().forEach(t=>{const s=t.getActors(),n=s.map(e=>e.getID());s.forEach(s=>{if(!this.actorDesertedBattle(s,e)){const r=new g.BattleBadge,a={name:e.getName(),id:e.getID(),army:t.getName(),allies:n,status:t.isDefeated()?"Lost":"Won"};r.setData(a),s.add(r),s.remove("InBattle"),s.add(new g.BattleOver)}})})}actorDesertedBattle(e,t){return!!e.getList("BattleBadge").find(e=>e.getData().id===t.getID())}moveActorsOutOfBattle(e){const t=e.getLevel(),s=t.getConnections();s&&0!==s.length||i.default.err("Game.Master","moveActorsOutOfBattle","No exit connnection in level");const n=s[0].getTargetLevel();this.hasBattleSpawned[n.getID()]&&(this.hasBattleSpawned[n.getID()]=!1);e.getArmies().forEach(e=>{e.getActors().forEach(e=>{if(e.isInLevel(t))if(e.isPlayer()){const s=this.getLeaveBattleMenu(e,t);e.getBrain().setSelectionObject(s)}else if(t.removeActor(e))n.addActorToFreeCell(e);else{const t=JSON.stringify(e.toJSON());i.default.err("Game.Master","moveActorsOutOfBattle","level.removeActor failed for actor "+t)}})})}getSelArmyObject(e,t){const s=t.getArmies(),n=n=>{const r=s[n],a=t.getLevel();let o=r.getActors();const l=o.length,c=o[y.getUniformInt(0,l-1)],[u,h]=c.getXY();c.get("Action").disable(),r.removeActor(c),a.removeActor(c),o=r.getActors(),r.addActor(e),e.get("InBattle").updateData({army:r.getName}),e.has("Groups")||e.add(new g.Groups),e.get("Groups").addGroup(r.getID()),r.getActors().forEach(t=>{t.isEnemy(e)&&t.getBrain().getMemory().removeEnemy(e)}),a.moveActorTo(e,u,h)||i.default.err("GameMaster","getSelArmyObject",`Could not move player to ${u},${h}`)},r=s.map((e,t)=>[" Army "+e.getName(),n.bind(this,t)]);r.push(["Take no side",u.Menu.EXIT_MENU]);const a=new u.Menu.SelectRequired(r);return a.addPre("Please select an army to join:"),a}getLeaveBattleMenu(e,t){const s=[["Leave immediately",()=>{const s=t.getConnections()[0];if(t.moveActorTo(e,s.getX(),s.getY())){const t=new g.UseStairs;e.add(t);const s=e.getName();i.default.gameMsg(s+" leaves the battlefield")}else i.default.err("GameMaster","moveActorsOutOfBattle","Cannot move player to stairs cell")}],["Stay behind to scavenge the bodies of the dead.",u.Menu.EXIT_MENU]],n=new u.Menu.SelectRequired(s);return n.addPre("Battle is over! Do you want to leave battle?"),n}createBattleEvent(e){const t=e.getLevel(),s=new g.BattleEvent;s.setEventType(i.default.EVT_BATTLE_OVER),s.setBattle(e),t.add(s)}toJSON(){const e=Object.keys(this.battles),t={};return e.forEach(e=>{this.getBattles(parseInt(e,10)).forEach(s=>{t.hasOwnProperty(e)||(t[e]=[]),"function"==typeof s.toJSON?t[e].push(s.toJSON()):s.name?t[e].push(s):i.default.err("GameMaster","toJSON","Does not look like proper battle object.")})}),{battles:t,battlesDone:this.battlesDone,hasBattleSpawned:this.hasBattleSpawned}}unloadBattles(e){const t=e.getID();if(this.battles.hasOwnProperty(t)){const e=this.getBattles(t);this.battles[t]=[],e.forEach(e=>{if("function"==typeof e.toJSON){const s=e;s.isOver()||s.removeListeners(),this.battles[t].push(s.toJSON())}else i.default.err("GameMaster","unloadBattle",`Unload for level ${t} failed`)})}}biomeToLevelType(e){switch(e){case c.OW.BIOME.ARCTIC:case c.OW.BIOME.TUNDRA:return"arctic";case c.OW.BIOME.ALPINE:return"mountain";case c.OW.BIOME.TAIGA:default:return"forest"}}getBattleLevels(){const e=[];return Object.values(this.battles).forEach(t=>{t.forEach(t=>{t.isJSON||e.push(t.getLevel())})}),e}createBattleIntoAreaTileLevel(e){e||i.default.err("GameMaster","createBattleIntoAreaTileLevel","Parent level is null");const t=e.getID(),s=this.game.getOverWorld();let n=4,r=20;const a={};let o="forest",l=e.getBbox();if(s){const a=this.game.getCurrentWorld().getAreas()[0],i=a.findTileXYById(t),c=2,u=a.getSizeY()-1,h=Math.abs(c-i[0]),d=Math.abs(u-i[1]);n+=h+d,r+=20*d+10*h;p(`${`dx,dy: ${h},${d} armySize ${r}`} , danger: ${n}`);const f=this.game.getPlayerOwPos();if(f){const t=s.getBiome(f[0],f[1]);o=this.biomeToLevelType(t),p("Creating battle on tile "+i),l=this.getLevelBbox(s,a,i,f,e)}}a.maxDanger=n,a.armySize=r,a.levelType=o,a.bbox=l;const c=this.fact.createBattle(e,a);this.addBattle(t,c);const u=c.getLevel().getID();return this.game.addBattle(this.getBattle(t,u),t),this.hasBattleSpawned[t]=!0,c}}},function(e,t,s){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&n(t,e,s);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryBattle=void 0;const i=s(38),l=o(s(0)),c=s(32),u=s(136),h=s(1),d=s(19),f=s(6),g=a(s(15)),p=a(s(2)),m=a(s(73)),y=a(s(7)),_=s(134),b=s(4),v=y.ElementStairs,E=h.Random.getRNG(),S=["avianfolk","human","dwarf","dogfolk","wolfclan","goblin","catfolk","bearfolk","wildling","undead"];t.FactoryBattle=class{constructor(){this.minCommDanger=5}createBattle(e,t={}){const s=t.cols||80,n=t.rows||40,r=e?e.getID():0,a=t.name||"Battle of level "+r;let o=this.createBattleLevel(s,n,t);if(e){const s=new v("battle",e),n=e.getMap();if(t.bbox){const{bbox:r}=t;let a=E.getRandInBbox(r),i=n.getCell(a[0],a[1]),c=l.default.WATCHDOG;for(;i.hasProps()&&(a=E.getRandInBbox(r),i=n.getCell(a[0],a[1]),0!=--c););e.addStairs(s,a[0],a[1]);const u=b.Geometry.getCellsAround(n,i);o=(new _.LevelSurroundings).surround(o,{cellsAround:u})}else e.addStairs(s,4,4);c.World.addExitsToEdge(o);const r=o.getConnections();s.connect(r[0]);for(let t=1;t<r.length;t++)r[t].setTargetLevel(e),r[t].setTargetStairs(s)}const i=new u.Battle(a);i.setLevel(o);const[h,d]=this.getFactions(t);let f=t.numRows||2;const g=t.armySize||20,p=t.numArmies||2,m=t.armies||[h,d];let y=Math.ceil(g/f);for(;y>s;)++f,y=Math.ceil(g/f);const S=[];for(let e=0;e<p;e++){const r=this.createArmy(i,m[e],t);let a=E.getUniformInt(0,s-1),o=E.getUniformInt(0,n-1);a+y>s-1&&(a=s-y),o+f>n-1&&(o=n-1-f),t.centerX&&(a=Math.floor(s/2),a-=Math.floor(g/f/2)),t.centerY&&(o=Math.floor(n/2),o-=e*(f+2)),(a>s-1||a<0)&&l.default.err("FactoryBattle","createBattle",`armyX ${a} out of bounds 0-${s-1}`),(o>n-1||o<0)&&l.default.err("FactoryBattle","createBattle",`armyY ${o} out of bounds 0-${n-1}`);const c={horizontal:!0,numRows:f};i.addArmy(r,a,o,c),S.push(r)}return this.makeArmiesAsEnemies(S),i}getFactions(e){let t=null,s=null;if(e.factions)[t,s]=e.factions;else for(t=E.arrayGetRand(S),s=E.arrayGetRand(S);t===s;)s=E.arrayGetRand(S);return[t,s]}createArmy(e,t,s){const n=f.ObjectShell.getParser(),r=s.armySize||20,a=s.danger||5,o=new u.Army(t),c=o.getID();o.addAlignment(t,1);const h=[{op:"eq",prop:"type",value:t},{op:"lte",prop:"danger",value:a}],d=(new i.Constraints).getConstraints(h);for(let t=0;t<r-1;t++){const t=n.createRandomActor({func:d});if(t){const s=new p.InBattle;s.setData({name:e.getName(),army:o.getName()}),t.add(s),t.has("Groups")||t.add(new p.Groups),t.get("Groups").addGroup(c),o.addActor(t)}}const g=n.createRandomActor({func:e=>e.type===t&&e.danger>=this.minCommDanger});if(g){this.addCommanderAbilities(g);const t=new p.InBattle;t.setData({name:e.getName(),army:o.getName()}),g.add(t),o.addActor(g)}else l.default.warn("FactoryBattle","createArmy","No commander for army generated");return o.setDefeatThreshold(Math.round(.1*r)),o}makeArmiesAsEnemies(e){e.forEach(t=>{e.forEach(e=>{if(t.getID()!==e.getID()){const s=e.getID();t.getActors().forEach(e=>{e.getBrain().getMemory().addEnemyGroup(s)})}}),t.getActors().forEach(e=>{e.getBrain().getMemory().addFriendGroup(t.getID())})})}createBattleLevel(e,t,s){const n=s.levelType||"forest",r=l.default.getForestConf(e,t);return d.FactoryLevel.createLevel(n,e,t,r)}addCommanderAbilities(e){const t=new g.BrainGoalOriented(e),s=new m.ThinkCommander(e);e.setBrain(t),t.setGoal(s),e.add(new p.Commander),e.setFOVRange(10)}}}]);
!function(e){var t={};function n(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(s,r,function(t){return e[t]}.bind(null,r));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/build/",n(n.s=422)}([function(e,t,n){e.exports=n(427)()},function(e,t){e.exports=React},function(e,t,n){"use strict";t.__esModule=!0;var s,r=n(250),a=(s=r)&&s.__esModule?s:{default:s};t.default=a.default||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e}},function(e,t,n){var s;
/*!
  Copyright (c) 2016 Jed Watson.
  Licensed under the MIT License (MIT), see
  http://jedwatson.github.io/classnames
*/!function(){"use strict";var n={}.hasOwnProperty;function r(){for(var e=[],t=0;t<arguments.length;t++){var s=arguments[t];if(s){var a=typeof s;if("string"===a||"number"===a)e.push(s);else if(Array.isArray(s))e.push(r.apply(null,s));else if("object"===a)for(var o in s)n.call(s,o)&&s[o]&&e.push(o)}}return e.join(" ")}e.exports?e.exports=r:void 0===(s=function(){return r}.apply(t,[]))||(e.exports=s)}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n(130);const s=n(9),r=n(23);const a=new class{constructor(){this.gameTitle="Battles in the North (BitN)",this.suppressErrorMessages=!1,this.suppressLogs=!1,this.suppressWarningMessages=!1,this.suppressDiagnosticMessages=!1,this.cellRenderVisible=["actors","items","elements"],this.cellRenderAlways=["items","elements"],this.ACTOR_MEDIUM_SQR=40,this.LOOT_MEDIUM_SQR=200,this.LEVEL_MEDIUM_X=80,this.LEVEL_MEDIUM_Y=40,this.debugZoneEvents=!1,this.POOL=r.EventPool.getPool(),this.charStyles={elements:{default:".",exit:".",exploration:"?",lever:"&",leverdoor:{isClosed:"+",default:"/"},marker:{getChar:"",default:"X"},passage:".",placeholder:"?",shop:".",stairsDown:">",stairsUp:"<",wall:"#",wallcave:"#",wallcrypt:"#",wallice:"#",wallwooden:"#",wallmount:"^",door:{isClosed:"+",default:"/"}},actors:{default:"@"},items:{default:"?",corpse:"ยง"}},this.cellStyles={elements:{default:"cell-element-default",door:"cell-element-door",exit:"cell-element-exit",exploration:"cell-element-exploration",marker:{getClassName:"",default:"cell-element-marker"},lever:"cell-element-door",leverdoor:"cell-element-door",passage:"cell-element-passage",placeholder:"cell-element-placeholder",shop:"cell-element-shop",stairsDown:"cell-element-stairs",stairsUp:"cell-element-stairs",wall:"cell-element-wall",wallcave:"cell-element-wall-cave",wallcrypt:"cell-element-wall-crypt",wallice:"cell-element-wall-ice",wallwooden:"cell-element-wall-wooden",wallmount:"cell-element-wall-mount"},actors:{default:"cell-actor-default",player:"cell-actor-player",spirit:"cell-actor-spirit"},items:{potion:"cell-item-potion",spiritgem:"cell-item-spiritgem",default:"cell-item-default"}},this.VERB={NONE:10,LOW:20,MEDIUM:30,HIGH:40,FULL:50,DEBUG:100},this.PLAYER_FOV_RANGE=10,this.NPC_FOV_RANGE=7,this.ACTION_DUR=100,this.BASE_SPEED=100,this.DEFAULT_HP=50,this.ACTION_OK=1,this.ACTION_FAILED=-1,this.MAX_ACTIVE_LEVELS=3,this.EVT={},this.EVT_ACTOR_CREATED="EVT_ACTOR_CREATED",this.EVT_ACTOR_KILLED="EVT_ACTOR_KILLED",this.EVT_PLAYER_KILLED="EVT_PLAYER_KILLED",this.EVT_DESTROY_ITEM="EVT_DESTROY_ITEM",this.EVT_MSG="EVT_MSG",this.EVT_LEVEL_CHANGED="EVT_LEVEL_CHANGED",this.EVT_LEVEL_ENTERED="EVT_LEVEL_ENTERED",this.EVT_TILE_CHANGED="EVT_TILE_CHANGED",this.EVT_TILE_ENTERED="EVT_TILE_ENTERED",this.EVT_TILE_LEFT="EVT_TILE_LEFT",this.EVT_EXPLORED_ZONE_LEFT="EVT_EXPLORED_ZONE_LEFT",this.EVT_LEVEL_PROP_ADDED="EVT_LEVEL_PROP_ADDED",this.EVT_LEVEL_PROP_REMOVED="EVT_LEVEL_PROP_REMOVED",this.EVT_ACT_COMP_ENABLED="EVT_ACT_COMP_ENABLED",this.EVT_ACT_COMP_DISABLED="EVT_ACT_COMP_DISABLED",this.EVT_ON_ADD_COMP="OnAddComponent",this.EVT_ON_REMOVE_COMP="OnRemoveComponent",this.EVT_WIN_COND_TRUE="EVT_WIN_COND_TRUE",this.EVT_ANIMATION="EVT_ANIMATION",this.EVT_CREATE_ZONE="EVT_CREATE_ZONE",this.EVT_CREATE_BATTLE="EVT_CREATE_BATTLE",this.EVT_BATTLE_OVER="EVT_BATTLE_OVER",this.EVT_ARMY_EVENT="EVT_ARMY_EVENT",this.EVT_ITEM_PICKED_UP="EVT_ITEM_PICKED_UP",this.EVT_ACTOR_DAMAGED="EVT_ACTOR_DAMAGED",this.EVT_ACTOR_ATTACKED="EVT_ACTOR_ATTACKED",this.EVT_ACTOR_USED_STAIRS="EVT_ACTOR_USED_STAIRS",this.EVT_WEATHER_CHANGED="EVT_WEATHER_CHANGED",this.EVT_DAY_PHASE_CHANGED="EVT_DAY_PHASE_CHANGED",this.EVT_DAY_CHANGED="EVT_DAY_CHANGED",this.EVT_MONTH_CHANGED="EVT_MONTH_CHANGED",this.EVT_SEASON_CHANGED="EVT_SEASON_CHANGED",this.EVT_YEAR_CHANGED="EVT_YEAR_CHANGED",this.TYPE_ACTOR="actors",this.TYPE_ELEM="elements",this.TYPE_ITEM="items",this.ITEM={},this.ITEM.BASE="base",this.ITEM.FOOD="food",this.ITEM.BOOK="book",this.ITEM.CORPSE="corpse",this.ITEM.WEAPON="weapon",this.ITEM.ARMOUR="armour",this.ITEM.SPIRITGEM="spiritgem",this.ITEM.GOLD="gold",this.ITEM.MINERAL="mineral",this.ITEM.MISSILE="missile",this.ITEM.MISSILE_WEAPON="missileweapon",this.ITEM.AMMUNITION="ammo",this.ITEM.POTION="potion",this.ITEM.RUNE="rune",this.ITEM.GOLD_COIN="goldcoin",this.SHOP_TYPES=["ammo","armour","food","mineral","missile","missileweapon","potion","rune","spiritgem","weapon"],this.USE={DRINK:"DRINK",DIG:"DIG",LEVER:"LEVER",SKILL:"SKILL",DEFAULT:""},this.LEVEL_ID_ADD=1e9,this.ENTITY_ID_ADD=1e9,this.WATCHDOG=100,this.NO_TARGET=-1,this.LEVEL_EMPTY="empty",this.LEVEL_FOREST="forest",this.LEVEL_MOUNTAIN="mountain",this.energy={ATTACK:15,DEFAULT:5,JUMP:50,MISSILE:10,MOVE:10,PICKUP:5,REST:5,RUN:20,USE:5,SPELL:15},this.BIAS={ALWAYS:10,NOT_POSSIBLE:-10,Explore:.2,Flee:.2,Guard:1.1,Order:.7,Patrol:1,Follow:1,Attack:1.5,GoHome:1.4},this.FMODE_NORMAL=0,this.FMODE_FAST=1,this.FMODE_SLOW=2,this.ITEM_SUFFIX_CHANCE=.1,this.ITEM_PREFIX_CHANCE=.1,this.PROT_BYPASS_CHANCE=.05,this.MISSILE_CRITICAL_SHOT=.1,this.DANGER_ADJ_FACTOR=1.4,this.PLAYER_HP_REGEN_PERIOD=40,this.PLAYER_PP_REGEN_PERIOD=40,this.MIN_VALUE=30,this.MIN_DANGER=4,this.MAX_DANGER=6,this.TRAINER_PROB=.2,this.EPIC_PROB=.05,this.GOLD_COIN_WEIGHT=.001,this.GOLD_COIN_NAME="Gold coin",this.GOLD_WEIGHT_ADJUST=600,this.HUNGER_PROB=.1,this.HUNGER_DMG=1,this.ALIGN_GOOD="ALIGN_GOOD",this.ALIGN_EVIL="ALIGN_EVIL",this.ALIGN_NEUTRAL="ALIGN_NEUTRAL",this.EVIL_RACES=["catfolk","dogfolk","wolfclan","wildling","undead","goblin"],this.NEUTRAL_RACES=["dwarf","bearfolk","animal"],this.ACTOR_RACES=["catfolk","dogfolk","wolfclan","wildling","goblin","bearfolk","dwarf","human","hyrkhian"],this.ACTOR_RACES=this.ACTOR_RACES.sort(),this.ALL_RACES=["avianfolk"].concat(this.ACTOR_RACES),this.CARDINAL_DIR=["north","south","east","west"],this.CARDINAL_DIR_ABBR=["N","S","E","W"],this.DIAG_DIR_ABBR=["NE","SE","NW","SW"],this.DIR={N:"N",S:"S",E:"E",W:"W",NE:"NE",SE:"SE",NW:"NW",SW:"SW"},this.DIR_XY={N:[0,-1],S:[0,1],E:[1,0],W:[-1,0],NE:[1,-1],SE:[1,1],NW:[-1,-1],SW:[-1,1]},this.DIR_NSEW=[this.DIR.N,this.DIR.S,this.DIR.E,this.DIR.W],this.DIR_DIAG=[this.DIR.NE,this.DIR.SE,this.DIR.NW,this.DIR.SW],this.DIR_NSEW_XY=[this.DIR_XY.N,this.DIR_XY.S,this.DIR_XY.E,this.DIR_XY.W],this.DIR_DIAG_XY=[this.DIR_XY.NE,this.DIR_XY.SE,this.DIR_XY.NW,this.DIR_XY.SW],this.SEASON={AUTUMN:"AUTUMN",AUTUMN_WINTER:"AUTUMN_WINTER",WINTER:"WINTER",WINTER_SPRING:"WINTER_SPRING",SPRING:"SPRING",SPRING_SUMMER:"SPRING_SUMMER",SUMMER:"SUMMER",SUMMER_AUTUMN:"SUMMER_AUTUMN"},this.DAY={DAWN:"DAWN",MORNING:"MORNING",NOON:"NOON",AFTERNOON:"AFTERNOON",EVENING:"EVENING",DUSK:"DUSK",NIGHT:"NIGHT"},this.AREA_LEVEL_COLS=100,this.AREA_LEVEL_ROWS=100,this.LETTERS=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],this.LETTERS_UC=this.LETTERS.map(e=>e.toUpperCase()),this.DMG={ACID:"ACID",BLUNT:"BLUNT",COLD:"COLD",DIRECT:"DIRECT",ENERGY:"ENERGY",EFFECT:"EFFECT",EXPLOSION:"EXPLOSION",FIRE:"FIRE",HUNGER:"HUNGER",ICE:"ICE",LIGHTNING:"LIGHTNING",MAGIC:"MAGIC",MELEE:"MELEE",MISSILE:"MISSILE",NECRO:"NECRO",PIERCE:"PIERCE",POISON:"POISON",SLASH:"SLASH",SLIME:"SLIME",VOID:"VOID",WATER:"WATER"},this.EQUIP={HEAD:"head",NECK:"neck",CLOAK:"cloak",CHEST:"chest",HAND:"hand",SHIELD:"shield",LEGS:"legs",FEET:"feet",MISSILE:"missile",MISSILEWEAPON:"missileweapon",SPIRITGEM:"spiritgem",TOOL:"tool"},this.classNameDMG={ACID:"cell-damage-ACID",BLUNT:"cell-damage-BLUNT",COLD:"cell-damage-COLD",ENERGY:"cell-damage-ENERGY",FIRE:"cell-damage-FIRE",EXPLOSION:"cell-damage-FIRE",HUNGER:"cell-damage-HUNGER",ICE:"cell-damage-ICE",LIGHTNING:"cell-damage-LIGHTNING",MAGIC:"cell-damage-MAGIC",MELEE:"cell-damage-MELEE",MISSILE:"cell-damage-MISSILE",NECRO:"cell-damage-NECRO",PIERCE:"cell-damage-PIERCE",POISON:"cell-damage-POISON",SLASH:"cell-damage-SLASH",WATER:"cell-damage-WATER",VOID:"cell-damage-VOID"},this.STATS=["Accuracy","Agility","Magic","Perception","Strength","Willpower","Spirituality"];this.ZONE_EVT={BATTLE_OVER:"BATTLE_OVER",ZONE_EXPLORED:"ZONE_EXPLORED",QUEST_COMPLETED:"QUEST_COMPLETED",CITY_WIPED:"CITY_WIPED",MOUNTAIN_CLIMBED:"MOUNTAIN_CLIMBED",UNIQUE_KILLED:"UNIQUE_KILLED"},this.WEAKNESS={},this.WEAKNESS.MINOR=1,this.WEAKNESS.MEDIUM=3,this.WEAKNESS.SEVERE=7,this.WEAKNESS.FATAL=10,this.RESISTANCE={},this.RESISTANCE.MINOR=1,this.RESISTANCE.MEDIUM=3,this.RESISTANCE.STRONG=6,this.RESISTANCE.IMMUNITY=10,this.RESISTANCE.ABSORB=15,this.SYS={},this.SYS.ANIMATION=Symbol("ANIMATION"),this.SYS.AREA_EFFECTS=Symbol("AREA_EFFECTS"),this.SYS.ATTACK=Symbol("ATTACK"),this.SYS.ATTACK_RANGED=Symbol("ATTACK_RANGED"),this.SYS.BATTLE=Symbol("BATTLE"),this.SYS.BASE_ACTION=Symbol("BASE_ACTION"),this.SYS.CHAT=Symbol("CHAT"),this.SYS.COMMUNICATION=Symbol("COMMUNICATION"),this.SYS.CRAFTING=Symbol("CRAFTING"),this.SYS.DAMAGE=Symbol("DAMAGE"),this.SYS.DEATH=Symbol("DEATH"),this.SYS.DISABILITY=Symbol("DISABILITY"),this.SYS.DRAIN_STATS=Symbol("DRAIN_STATS"),this.SYS.EQUIP=Symbol("EQUIP"),this.SYS.EVENTS=Symbol("EVENTS"),this.SYS.EXP_POINTS=Symbol("EXP_POINTS"),this.SYS.FARMING=Symbol("FARMING"),this.SYS.HUNGER=Symbol("HUNGER"),this.SYS.MISSILE=Symbol("MISSILE"),this.SYS.MOVEMENT=Symbol("MOVEMENT"),this.SYS.QUEST=Symbol("QUEST"),this.SYS.SHOP=Symbol("SHOP"),this.SYS.SKILLS=Symbol("SKILLS"),this.SYS.SPELL_CAST=Symbol("SPELL_CAST"),this.SYS.SPELL_EFFECT=Symbol("SPELL_EFFECT"),this.SYS.SPIRIT=Symbol("SPIRIT"),this.SYS.TIME_EFFECTS=Symbol("TIME_EFFECTS"),this.SYS.ZONE_EVENTS=Symbol("ZONE_EVENTS"),this.SYS.WEATHER=Symbol("WEATHER"),this.SYS.ON_CBS=Symbol("ON_CBS"),this.SYS.MINING=Symbol("MINING"),this.NO_DAMAGE_SRC=null,this.initStats(this.STATS),this.LEVEL_NOT_LOADED="LEVEL_NOT_LOADED",this.TILE_NOT_LOADED="TILE_NOT_LOADED",this.cellRenderArray=this.cellRenderVisible,this.PROP_TYPES=[this.TYPE_ACTOR,this.TYPE_ELEM,this.TYPE_ITEM],this.FMODES=[this.FMODE_NORMAL,this.FMODE_FAST,this.FMODE_SLOW],this.ALIGNMENTS=[this.ALIGN_GOOD,this.ALIGN_NEUTRAL,this.ALIGN_EVIL],this.cellRenderArray=this.cellRenderVisible,this.ONE_SHOT_ITEMS=["potion"],this.WORLD_ENTITY="WorldEntity",this.MAX_DRENCHED=10,this.MATERIAL={DEFAULT:"iron",IRON:"iron",STEEL:"steel",MITHRIL:"mithril",PERMAICE:"permaice",RUBY_GLASS:"ruby glass",FORIUM:"forium",NETHERIUM:"netherium",CLOTH:"cloth",WOOD:"wood",FLESH:"flesh",BONE:"bone"},this.MATERIAL2HARDNESS={[this.MATERIAL.IRON]:4,[this.MATERIAL.STEEL]:6,[this.MATERIAL.MITHRIL]:8,[this.MATERIAL.PERMAICE]:16,[this.MATERIAL.RUBY_GLASS]:12,[this.MATERIAL.FORIUM]:24,[this.MATERIAL.NETHERIUM]:32,[this.MATERIAL.CLOTH]:1,[this.MATERIAL.WOOD]:2,[this.MATERIAL.FLESH]:1,[this.MATERIAL.BONE]:3},this.ORE_VEIN_SIZES={1:10,2:20,3:30,4:40,5:30,6:20,7:10,8:8,16:4,32:2},this.NO_OWNER=null,this.DEBUG=0,this.SKILLS={ARCHERY:"Archery",ARMOUR:"Armour",BATTLE:"Battle",CLIMBING:"Climbing",DODGE:"Dodge",EXPLORATION:"Exploration",FARMING:"Farming",MELEE:"Melee",MINING:"Mining",SHIELDS:"Shields",SPELLCASTING:"SpellCasting",THROWING:"Throwing",TRADING:"Trading"},this.CANNOT_BRIBE=["animal","construct","demon","creature","undead","finalboss","boss","forcefield","flame","eye","wave","spirit","icebeing"]}getCssClassForCell(e,t){this.cellRenderArray=t?this.cellRenderVisible:this.cellRenderAlways;const n=this.getStyleClassForCell(e);return this.cellRenderArray=this.cellRenderVisible,n}getTopEntityNameForCell(e,t){this.cellRenderArray=t?this.cellRenderVisible:this.cellRenderAlways;const n=this.getTopEntityName(e);return this.cellRenderArray=this.cellRenderVisible,n}getCssClassFullMap(e){if(this.cellRenderArray=this.cellRenderVisible,!e.hasProps()){const t=e.getBaseElem().getType();return this.cellStyles.elements[t]}for(let t=0;t<3;t++){const n=this.cellRenderVisible[t];if(e.hasProp(n)){const t=e.getProp(n),s=this.cellStyles[n];return this.getPropClassOrChar(s,t[0])}}return null}getCharForCell(e,t){this.cellRenderArray=t?this.cellRenderVisible:this.cellRenderAlways;const n=this.getCellChar(e);return this.cellRenderArray=this.cellRenderVisible,n}getCharFullMap(e){if(this.cellRenderArray=this.cellRenderVisible,!e.hasProps()){const t=e.getBaseElem().getType();return this.charStyles.elements[t]}for(let t=0;t<3;t++)if(e.hasProp(this.cellRenderVisible[t])){const n=e.getProp(this.cellRenderVisible[t]),s=this.charStyles[this.cellRenderVisible[t]];return this.getPropClassOrChar(s,n[0])}return null}getStyleClassForCell(e){if(!e.isExplored())return"cell-not-explored";for(let t=0;t<this.cellRenderArray.length;t++){const n=this.cellRenderArray[t];if(e.hasProp(n)){const t=e.getProp(n),s=this.cellStyles[n],r=t[0];if(!r.has("DontRender"))return this.getPropClassOrChar(s,r)}}const t=e.getBaseElem().getType();return this.cellStyles.elements[t]}getPropClassOrChar(e,t){let n=null;if(t.getName?(n=t.getName(),e.hasOwnProperty(n)||(n=t.getType())):n=t.getType(),e.hasOwnProperty(n)){if("object"==typeof e[n]){const s=e[n];for(const e in s)if("default"!==e){const n=t[e]();if(!0===n)return s[e];if(!1!==n)return n}return s.default}return e[n]}return e.default}getCellChar(e){if(!e.isExplored())return"X";for(let t=0;t<this.cellRenderArray.length;t++)if(e.hasProp(this.cellRenderArray[t])){const n=e.getProp(this.cellRenderArray[t]),s=this.charStyles[this.cellRenderArray[t]],r=n[0];return this.getPropClassOrChar(s,r)}const t=e.getBaseElem().getType();return this.charStyles.elements[t]}getTopEntityName(e){if(!e.isExplored())return"Unexplored";for(let t=0;t<this.cellRenderArray.length;t++)if(e.hasProp(this.cellRenderArray[t])){const n=e.getProp(this.cellRenderArray[t])[0];let s=null;return s=n.getName?n.getName():n.getType(),s}return""}addCellStyle(e,t,n){this.cellStyles.hasOwnProperty(e)?this.cellStyles[e][t]=n:this.err("RG","addCellStyle","Unknown prop type: "+e)}removeCellStyle(e,t){this.cellStyles.hasOwnProperty(e)&&delete this.cellStyles[e][t]}addCharStyle(e,t,n){this.charStyles.hasOwnProperty(e)?this.charStyles[e][t]=n:this.err("RG","addCharStyle","Unknown prop type: "+e)}removeCharStyle(e,t){this.charStyles.hasOwnProperty(e)&&delete this.charStyles[e][t]}getChar(e,t,n=null){if(this.charStyles.hasOwnProperty(e)){if(n){return this.charStyles[e][t][n]}return this.charStyles[e][t]}return"X"}getCssClass(e,t,n=null){if(this.cellStyles.hasOwnProperty(e)){if(n){return this.cellStyles[e][t][n]}if(this.cellStyles[e].hasOwnProperty(t))return this.cellStyles[e][t]}return""}debug(e,t){if(this.DEBUG>0){const n=typeof e,s=JSON.stringify(e);console.log(`[DEBUG]: Type: ${n} ${s} |${t}|`)}}err(e,t,n){if(!this.suppressErrorMessages){const s=`[ERROR]: ${e} ${t} -> |${n}|`;throw console.error(s),new Error(s)}}warn(e,t,n){if(!this.suppressWarningMessages){const s=`[WARN]: ${e} ${t} -> |${n}|`;console.error(s)}}diag(e){if(!this.suppressDiagnosticMessages){const t=(new Error).stack.split("at ");if(t.length>3){const e=t[3].trim();console.info(e)}console.info(e)}}log(...e){this.suppressLogs||console.log("[INFO]:",...e)}assertType(e,t){e.getType?e.getType()!==t&&this.err("RG","assertType",`Exp: ${t}, Got: ${e.getType()}`):this.err("RG","assertType",`object ${e} has no getType()`)}extend2(e,t){this.isNullOrUndef([e])&&this.err("RG","extend2","Child not defined. Parent: "+t),this.isNullOrUndef([t])&&this.err("RG","extend2","Parent not defined. Child: "+e);const n=t.prototype,s=e.prototype;for(const e in n)s.hasOwnProperty(e)||(s[e]=n[e]);if(s.hasOwnProperty("uber")){const e=[s.uber];e.push(n),s.uber=e}else s.uber=[],s.uber.push(n)}nullOrUndefError(e,t,n){if(this.isNullOrUndef([n])){const n=`nullOrUndef ${e} ${t}`;throw console.error(n),new Error(n)}}isNullOrUndef(e){for(let t=0;t<e.length;t++)if(null===e[t]||void 0===e[t]||void 0===e)return!0;return!1}addStackedItems(e,t){if(e.equals(t)){const n=t.getCount();return e.incrCount(n),!0}return!1}removeStackedItems(e,t){if(t>0){let n=null;return 1===t&&1===e.getCount()?e:t<e.getCount()?(e.decrCount(t),n=e.clone(),n.setCount(t),n):e}return null}getFOVRange(e){let t=e.getFOVRange();if(e.has("Blindness"))return 1;if(e.has("Location")){const n=e.get("Location").getLevel();if(n&&n.has("Weather")){t+=n.get("Weather").getVisibility()}n.get("Place").getDepth()>0&&(t+=a.getSkillLevel(e,a.SKILLS.EXPLORATION))}return t<1&&(t=1),t}getItemDamage(e){if(e.rollDamage)return e.rollDamage();{const t=e.getWeight();return Math.ceil(t/1.1)}}getMeleeAttack(e){let t=e.getAttack();const n=e.getInvEq().getMissile(),s=e.getInvEq().getMissileWeapon();return n&&(t-=n.getAttack()),s&&(t-=s.getAttack()),t}getMeleeAttackRange(e){const t=e.get("Combat").getAttackRange(),n=e.getWeapon();if(n&&n.getAttackRange){const e=n.getAttackRange();return e>t?e:t}return t}getMeleeDamageAdded(e){let t=e.getCombatBonus("getDamage");return t+=this.strengthToDamage(e.getStatVal("Strength")),t}getMeleeAttackInfo(e){let t="Att: "+this.getMeleeAttack(e);const n=e.getWeapon();return n&&n.getDamageDie?t+=" D: "+n.getDamageDie().toString():t+=" D: "+e.get("Combat").getDamageDie().toString(),t+=" + "+this.getMeleeDamageAdded(e),t}getMissileAgilityDmg(e){return Math.round(e/3)}getMissileDamageAdded(e,t){let n=this.getMissileAgilityDmg(e.get("Stats").getAgility());if(t.has("Ammo")){const t=e.getMissileWeapon();t&&(n+=t.rollDamage())}return e.has("StrongShot")&&(n+=this.strengthToDamage(e.getStatVal("Strength"))),n}getMissileDamage(e,t){if(this.isAmmoOrMissile(t)){let n=t.rollDamage();return n+=this.getMissileDamageAdded(e,t),n}return Math.round(t.getWeight()/1.5)}getMissileAttack(e){let t=e.get("Combat").getAttack();t+=e.getInvEq().getEquipment().getAttack(),t+=e.get("Stats").getAccuracy()/2,t+=e.getInvEq().getEquipment().getAccuracy()/2;const n=e.getWeapon();return n&&n.getAttack&&(t-=n.getAttack()),t}getMissileAttackInfo(e){const t=e.getMissileWeapon(),n=e.getInvEq().getMissile();if(!n)return"No missile equipped";let s="Att: "+this.getMissileAttack(e);if(s+=" D: "+n.getDamageDie().toString(),t){s+=" + "+t.getDamageDie().toString()+" (wpn)"}return s+=" + "+this.getMissileDamageAdded(e,n),s+=" R: "+this.getMissileRange(e,n),s}getMissileRange(e,t){if(!this.isAmmoOrMissile(t))return 2;let n=t.getAttackRange();if(t.has("Ammo")){const t=e.getMissileWeapon();if(!t)return 0;n+=t.getAttackRange()}return e.has("LongRangeShot")&&(n*=2),e.has("EagleEye")&&(n+=2),e.has("Skills")&&(t.has("Ammo")?n+=e.get("Skills").getLevel("Archery"):n+=e.get("Skills").getLevel("Throwing")),n}isAmmoOrMissile(e){return!!e.getAttackRange}strengthToDamage(e){return Math.round(e/4)}accuracyToAttack(e){return Math.floor(e/2)}agilityToDefense(e){return Math.floor(e/2)}findEnemyCellForActor(e,t){const n=[];return t.filter(e=>e.hasActors()).forEach(t=>{const s=t.getActors();let r=!1;for(let t=0;t<s.length;t++)e!==s[t]&&"function"==typeof s[t].isEnemy&&s[t].isEnemy(e)&&(r=!0);r&&n.push(t)}),n}initVars(){}dirTodXdY(e){if(Array.isArray(e))return e;if(this.DIR_XY.hasOwnProperty(e)){const t=e.toUpperCase();return this.DIR_XY[t]}return this.err("RG","dirTodXdY","Arg must be array/string (N,S,E,W..). Got: "+e),null}dXdYToDir(e){const[t,n]=e;let s="";return 1===n?s+="S":-1===n&&(s+="N"),1===t?s+="E":-1===t&&(s+="W"),0===t&&0===n&&this.warn("RG","dXdYToDir","dXdY 0,0 passed in"),s}dirToChar(e){const[t,n]=e;return 0!==t?0===n?"-":1===t&&1===n?"\\":-1===t&&1===n?"/":-1===t&&-1===n?"\\":"/":"|"}formatGetterName(e){return"get"+e.capitalize()}formatSetterName(e){return"set"+e.capitalize()}initStats(e){this.STATS_LC=e.map(e=>e.toLowerCase()),this.STATS_DEFAULTS=this.STATS_LC.reduce((e,t)=>(e[t]=5,e),{}),this.STATS_DEFAULTS.speed=100,this.STATS_ABBR=e.map(e=>e.substr(0,3)),this.GET_STATS=e.map(e=>this.formatGetterName(e)),this.SET_STATS=e.map(e=>this.formatSetterName(e)),this.STATS_ABBR2STAT=e.reduce((e,t)=>(e[t.substr(0,3)]=t,e),{})}createStatsObj(e,t=!0){const n={speed:e};return t?this.STATS_LC.forEach(t=>{n[t]=e}):this.STATS.forEach(t=>{n[t]=e}),n}getDmgClassName(e){return this.classNameDMG[e]}key2Num(e){const[t,n]=e.split(",");return[parseInt(t,10),parseInt(n,10)]}isEmpty(e){return!!this.isNullOrUndef([e])||("string"==typeof e?""===e:!!Array.isArray(e)&&0===e.length)}getName(e){if(e.getName)return e.getName();if(e.getParentZone){return this.formatLocationName(e)}if(e.getParent){return e.getParent().getName()}return""}getNameForQuest(e){const t=this.getName(e);return"exploration"===t?this.getName(e.getLevel()):t}getObjRefArray(e,t){const n=t.map(t=>this.getObjRef(e,t));return n.$objRefArray=!0,n}getObjRef(e,t){if("entity"===e){if(this.isItem(t)){const e=" Got: |"+t.getName()+"|";this.err("RG","getObjRef","objRefs to items not supported."+e)}return{$objRef:{type:e,id:t.getID()}}}if("object"===e){if(t.$objID)return t.getObjRef();if(t.$objRef)return{$objRef:{type:"object",id:t.$objRef}}}else{if("component"===e)return{$objRef:{type:"component",id:t.getID()}};if("place"===e)return{$objRef:{type:"place",id:t.getID()}};if("item"===e)return{$objRef:{type:"item",id:t.getID()}};if("element"===e)return{$objRef:{type:"element",id:t.getID()}}}return this.err("RG","getObjRef",`Type ${e} not supported. Obj: ${t}`),null}getForestConf(e,t){const n=e/this.LEVEL_MEDIUM_X*(t/this.LEVEL_MEDIUM_Y);return{ratio:.5,nForests:Math.floor(30*n),forestSize:100}}getDangerProb(e,t){if(e>t)return console.error("this.getDangerProb param order is min < max"),console.error(`\tGot min: ${e}, max: ${t}`),{};const n=t+1,s=[];for(let t=e;t<=n;t++)s.push(t);const r=s[s.length-1],a=r%2==0?r/2:(r+1)/2,o={};return s.forEach(e=>{const t=Math.abs(e-a);let n=r-Math.floor(this.DANGER_ADJ_FACTOR*t);n=0===n?n+1:n,o[e]=n}),o}getMaxDanger(e,t){let n=Math.round(2.5*t)+e+3;return n<this.MIN_DANGER&&(n=this.MIN_DANGER),n}getMaxValue(e,t){let n=25*t+10*e;return n<=this.MIN_VALUE&&(n=this.MIN_VALUE),n}getMaxRarity(e,t,n){let s=Math.floor(2*t/3)+Math.floor(e/2);return n&&(s=t+Math.floor(e/2)),s<1&&(s=1),s}getFoodWeightDistr(){return{.1:20,.2:10,.3:5,.4:3,.5:1}}getGoldCoinCountDistr(e){const t=e+1,n={};for(let s=1;s<=t;s++)n[s]=e;return n}getRuneChargeDistr(){return{0:2,1:10,2:30,3:10,4:5,5:2,6:1}}valueToGoldWeight(e){return 1===e?a.GOLD_COIN_WEIGHT:e/a.GOLD_WEIGHT_ADJUST}scaleItemValue(e,t,n){const s=n.getValue();let r=1;switch(e){case"combat":r*=1+.1*t;break;case"stats":r*=1+.2*t;break;default:r=1}const a=Math.floor(s*r);n.setValue(a)}hasEnoughGold(e,t){const n=this.getGoldInCoins(t),s=e.getInvEq().getInventory().getItems();for(let e=0;e<s.length;e++)if("goldcoin"===s[e].getType()&&s[e].getCount()>=n)return!0;return!1}removeNCoins(e,t){let n=0;const s=e.getInvEq().getInventory().getItems();let r=null;for(let e=0;e<s.length;e++)"goldcoin"===s[e].getType()&&(s[e].getCount()>t?(n=t,s[e].decrCount(t)):(r=s[e],n=r.getCount(),r.setCount(0)));return null!==r&&e.getInvEq().removeItem(r),n}getItemStat(e,t){if(!t)return 0;let n=0;if("function"==typeof t[e]&&(n+=t[e]()),t.has("Stats")){const s=t.get("Stats");"function"==typeof s[e]&&(n+=s[e]())}if(t.has("GemBound")){const s=t.get("GemBound").getGem();"function"==typeof s[e]&&(n+=s[e]())}return n}getExpRequired(e){let t=0;for(let n=1;n<=e;n++)t+=10*(n-1);return t}newXYFromDir(e,t){let[n,s]=[0,0];return Array.isArray(t)?[n,s]=t:t.getXY?[n,s]=t.getXY():this.err("RG","newXYFromDir","src must be TCoord or have getXY function. Got "+t),[n+e[0],s+e[1]]}dXdY(e,t){let[n,s,r,a]=[0,0,0,0];return Array.isArray(e)?(n=e[0],s=e[1]):e.getX&&(n=e.getX(),s=e.getY()),Array.isArray(t)?(r=t[0],a=t[1]):t.getX&&(r=t.getX(),a=t.getY()),[n-r,s-a]}dXdYAbs(e,t){const[n,s]=this.dXdY(e,t);return[Math.abs(n),Math.abs(s)]}dXdYUnit(e,t){const[n,s]=this.dXdY(e,t);return[0===n?0:n/Math.abs(n),0===s?0:s/Math.abs(s)]}withinRange(e,t,n){const[s,r]=this.dXdYAbs(t,n);return s<=e&&r<=e}levelUpActor(e,t){if(e.has("Experience")){let n=e.get("Experience").getExpLevel();if(n<t)for(;n<t;){const t=n+1;if(++n,e.get("Experience").setExpLevel(t),e.has("ActorClass"))e.get("ActorClass").getClass().advanceLevel();else if(this.levelUpStats(e,t),this.levelUpCombatStats(e,t),e.has("Health")){const t=e.get("Health");let n=2;e.isPlayer()&&(n=5),t.setMaxHP(t.getMaxHP()+n),t.setHP(t.getHP()+n)}}else{let e=`Curr: ${n}, New: ${t}`;e+=" New level must be > current level.",this.err("RG","levelUpActor",e)}}else this.err("RG","levelUpActor","No exp. component found.")}levelUpStats(e,t){const n=s.Random.getRNG().arrayGetRand(this.STATS_LC);e.get("Stats").incrStat(n,1)}levelUpCombatStats(e,t){if(e.has("Combat")){const n=e.get("Combat"),s=1;n.setAttack(n.getAttack()+s);const r=1;if(n.setDefense(n.getDefense()+r),t%3==0){const e=n.getProtection();n.setProtection(e+1)}const a=n.getDamageDie();a.setDice(a.getDice()+1),t%3==0&&a.setMod(a.getMod()+1)}}printObj(e,t,n){const s=(e,t)=>{"object"==typeof e?(console.debug("\t## "+t+n),console.debug(e+n)):console.debug("\t## "+t+" -> "+e+n)};if(t){if(Array.isArray(t))t.forEach(n=>{if("function"==typeof e[n]){const t=e[n]();s(t,n)}else{const n=JSON.stringify(e);this.err("RG","printObj",`No func ${t} in object ${n}`)}});else if("string"==typeof t)if("function"==typeof e[t]){const n=e[t]();s(n,t)}else this.err("RG","printObj",`No func ${t} in object ${JSON.stringify(e)}`)}else console.debug(e+n)}printObjList(e,t,n){const s=e.length;console.log(`List has ${s} objects`),e.forEach((e,s)=>{"function"==typeof n?n(e)&&(console.log(`Object [${s}]: `),this.printObj(e,t,"")):(console.log(`Object [${s}]: `),this.printObj(e,t,""))})}getUseCmd(e,t){return{cmd:"use",item:e,target:t}}getDropCmd(e,t){return{cmd:"drop",item:e,count:t}}getEquipCmd(e,t){return{cmd:"equip",item:e,count:t}}getUnequipCmd(e,t,n){return{cmd:"unequip",slot:e,slotNumber:t,count:n}}getCraftCmd(e,t){return{cmd:"craft",item:e,count:t}}getBuyCmd(e,t){return{cmd:"buy",items:e,count:t}}getSellCmd(e,t){return{cmd:"sell",items:e,count:t}}isOneShotItem(e){const t=e.getType();return this.ONE_SHOT_ITEMS.indexOf(t)>=0}isActor(e){return!(!e||!e.getPropType)&&e.getPropType()===this.TYPE_ACTOR}toActor(e){return this.isActor(e)||this.err("RG","toActor","Given entity not an actor: "+JSON.stringify(e)),e}isElement(e){return!(!e||!e.getPropType)&&e.getPropType()===this.TYPE_ELEM}isElementXY(e){return!(!e||!e.getPropType||e.getPropType()!==this.TYPE_ELEM)&&(e.getX&&e.getY&&e.getLevel)}isItem(e){return!(!e||!e.getPropType)&&e.getPropType()===this.TYPE_ITEM}isEntity(e){return!!e&&!!(e.comps&&e.compsByType&&e.add&&e.get)}isSentient(e){if(e){return"function"==typeof e.getBrain().getGoal}return!1}isBattleZone(e){return!(!e||!e.setBattle||"battlezone"!==e.getType())}isActorActive(e){return e&&!e.has&&a.err("RG.isActorActive","Got non-entity: ",JSON.stringify(e)),e&&!e.has("Dead")}isArea(e){return e.getType&&"area"===e.getType()}getEffectUseType(e,t){let n=t;if(t.target){if(n=t.target,n.getActors){const e=n;e.hasActors()&&(n=e.getFirstActor())}}const s=e.getType();if(a.isActor(e))return this.USE.SKILL;switch(s){case"potion":if(this.isActor(n))return this.USE.DRINK;break;default:return this.USE.DEFAULT}return this.USE.DEFAULT}getGoldInCoins(e){return Math.round(e/this.GOLD_COIN_WEIGHT)}getCardinalDirection(e,t){const n=e.getMap().cols,s=e.getMap().rows,r=t.getX(),a=t.getY();return 0===a?"north":a===s-1?"south":r===n-1?"east":0===r?"west":"somewhere"}getTextualDir(e,t,n=10){let s="";const[r,a]=this.dXdY(e,t),o=r/n,i=a/n;return i>0?s+="south":i<0&&(s+="north"),o>0?s+="east":o<0&&(s+="west"),""===s&&(s="nearby"),s}printMap(e){let t=null;if(Array.isArray(e)?t=this.colsToRows(e):Array.isArray(e._map)&&(t=this.colsToRows(e._map)),t){const e=t.length;for(let n=0;n<e;n++)console.log(t[n].join(""))}}forEach2D(e,t){for(let n=0;n<e.length;n++)for(let s=0;s<e[n].length;s++)t(n,s,e[n][s])}map2D(e,t){const n=[];return this.forEach2D(e,(e,s,r)=>{n.push(t(e,s,r))}),n}copy2D(e){const t=new Array(e.length);for(let n=0;n<e.length;n++){t[n]=new Array(e[n].length);for(let s=0;s<e[n].length;s++)t[n][s]=e[n][s]}return t}colsToRows(e){const t=[],n=e[0].length,s=e.length;for(let r=0;r<n;r++){t[r]=[];for(let n=0;n<s;n++)t[r][n]=e[n][r]}return t}flattenTo2D(e){const t=e.length,n=[];for(let r=0;r<t;r++){let t=e[r];t=s(t),n.push(t)}function s(e){let t=[];return e.forEach(e=>{Array.isArray(e)?t=t.concat(s(e)):t.push(e)}),t}return n}uniquifyCoord(e){const t={},n=[];for(let s=0;s<e.length;s++){const[r,a]=e[s],o=r+","+a;t[o]||(t[o]=!0,n.push(e[s]))}return n}setAllExplored(e){const t=e.getMap();for(let e=0;e<t.cols;e++)for(let n=0;n<t.rows;n++){t._map[e][n].setExplored()}}inSameLevel(e,t){return e.getLevel().getID()===t.getLevel().getID()}getImpassableMsg(e,t,n){return`${n} ${"cannot venture beyond "+t.getBaseElem().getType()}`}formatLocationName(e){const t=e.getParent();if(!t)return"";switch(t.getType()){case"branch":case"face":case"quarter":{const e=t.getParent();if(e){const n=t.getName(),s=e.getName();return n===s?n:""+s}this.err("RG","formatLocationName","parent is null")}default:return t.getName()}}isSuccess(e){return s.Random.getRNG().getUniform()<=e}ent(e){if(window.PLAYER){const t=window.PLAYER.getLevel();if(Number.isInteger(e)){const n=t.getActors().find(t=>t.getID()===e);if(n){const t=n.getName();return this.diag(`this.ent: Found ${t} with ID ${e}`),this.diag(JSON.stringify(n)),n}const s=t.getItems().find(t=>t.getID()===e);if(s){const t=s.getName();return this.diag(`RG.ent: Item Found ${t} with ID ${e}`),this.diag(JSON.stringify(s)),s}}}return null}comp(e,t=-1){let n=null;if(t>=0&&(n=this.ent(t)),n){const t=n.getComponents();if(t[e]){const n=t[e],s=n.getType();console.log(`this.comp: Found ${s} with ID ${e}`);const r=n.toJSON();return r?this.diag(JSON.stringify(r)):(this.diag("Not serialisable"),this.diag(n)),n}}return null}while(e,t,n=-1){let s=n;for(;e();)if(t(),0==--s)return!1;return!0}gameMsg(e){this.emitMsgEvent("prim",e)}gameInfo(e){this.emitMsgEvent("info",e)}gameDescr(e){this.emitMsgEvent("descr",e)}gameSuccess(e){this.emitMsgEvent("success",e)}gameWarn(e){this.emitMsgEvent("warn",e)}gameDanger(e){this.emitMsgEvent("danger",e)}gameIntError(e){this.emitMsgEvent("bg-danger text-white",e)}emitMsgEvent(e,t){let n="";if("object"==typeof t){const s=t,r=s.cell;n=s.msg,n=n[0].toUpperCase()+n.substring(1);const a={cell:r,msg:n,style:e};this.POOL.emitEvent(this.EVT_MSG,a),this.DEBUG>1&&console.log("Msg: "+n)}else n=t[0].toUpperCase()+t.substring(1),this.POOL.emitEvent(this.EVT_MSG,{msg:n,style:e}),this.DEBUG>1&&console.log("Msg: "+n)}destroyItemIfNeeded(e){if(this.isOneShotItem(e))if(1===e.getCount()){const t={item:e};this.POOL.emitEvent(this.EVT_DESTROY_ITEM,t)}else e.decrCount(1)}getEntName(e){return e.has("Named")?e.get("Named").getFullName():""}getLevel(e){return e.has("Location")?e.get("Location").getLevel():null}getCell(e){return e.has("Location")?e.get("Location").getCell():null}getSkillLevel(e,t){return e.has("Skills")?e.get("Skills").getLevel(t):0}toKey(e){let t=e[0]+","+e[1];return e.length>2&&(t+=","+e[2]),t}fromKey3D(e){const t=e.split(",");return[parseInt(t[0],10),parseInt(t[1],10),parseInt(t[2],10)]}fromKey(e){const t=e.split(",");return[parseInt(t[0],10),parseInt(t[1],10)]}pluralize(e){return e+"s"}reduceCountOrCharge(e,t,n){if(e.has("OneShot"))if(1===e.getCount()){const t={item:e};n.emitEvent(a.EVT_DESTROY_ITEM,t)}else e.decrCount(1);else if(e.getCharges&&e.getCharges()>0){const n=e;if(e.getCount()>1){const n=e.clone();n.setCount(1),e.setCount(e.getCount()-1),n.setCharges(n.getCharges()-1),t.getInvEq().addItem(n)}else n.setCharges(n.getCharges()-1)}}getMaterialHardness(e){const t=e.get("Physical");if(t){const e=t.getMaterial();return this.MATERIAL2HARDNESS[e]}return 0}clone(e){return JSON.parse(JSON.stringify(e))}};a.COLORS=["AliceBlue","AntiqueWhite","Aqua","Aquamarine","Azure","Beige","Bisque","Black","BlanchedAlmond","Blue","BlueViolet","Brown","BurlyWood","CadetBlue","Chartreuse","Chocolate","Coral","CornflowerBlue","Cornsilk","Crimson","Cyan","DarkBlue","DarkCyan","DarkGoldenRod","DarkGray","DarkGrey","DarkGreen","DarkKhaki","DarkMagenta","DarkOliveGreen","Darkorange","DarkOrchid","DarkRed","DarkSalmon","DarkSeaGreen","DarkSlateBlue","DarkSlateGray","DarkSlateGrey","DarkTurquoise","DarkViolet","DeepPink","DeepSkyBlue","DimGray","DimGrey","DodgerBlue","FireBrick","FloralWhite","ForestGreen","Fuchsia","Gainsboro","GhostWhite","Gold","GoldenRod","Gray","Grey","Green","GreenYellow","HoneyDew","HotPink","IndianRed","Indigo","Ivory","Khaki","Lavender","LavenderBlush","LawnGreen","LemonChiffon","LightBlue","LightCoral","LightCyan","LightGoldenRodYellow","LightGray","LightGrey","LightGreen","LightPink","LightSalmon","LightSeaGreen","LightSkyBlue","LightSlateGray","LightSlateGrey","LightSteelBlue","LightYellow","Lime","LimeGreen","Linen","Magenta","Maroon","MediumAquaMarine","MediumBlue","MediumOrchid","MediumPurple","MediumSeaGreen","MediumSlateBlue","MediumSpringGreen","MediumTurquoise","MediumVioletRed","MidnightBlue","MintCream","MistyRose","Moccasin","NavajoWhite","Navy","OldLace","Olive","OliveDrab","Orange","OrangeRed","Orchid","PaleGoldenRod","PaleGreen","PaleTurquoise","PaleVioletRed","PapayaWhip","PeachPuff","Peru","Pink","Plum","PowderBlue","Purple","Red","RosyBrown","RoyalBlue","SaddleBrown","Salmon","SandyBrown","SeaGreen","SeaShell","Sienna","Silver","SkyBlue","SlateBlue","SlateGray","SlateGrey","Snow","SpringGreen","SteelBlue","Tan","Teal","Thistle","Tomato","Turquoise","Violet","Wheat","White","WhiteSmoke","Yellow","YellowGreen"],t.default=a},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t,n){"use strict";t.__esModule=!0;var s,r=n(172),a=(s=r)&&s.__esModule?s:{default:s};t.default=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":(0,a.default)(t))&&"function"!=typeof t?e:t}},function(e,t,n){"use strict";t.__esModule=!0;var s=o(n(731)),r=o(n(735)),a=o(n(172));function o(e){return e&&e.__esModule?e:{default:e}}t.default=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":(0,a.default)(t)));e.prototype=(0,r.default)(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(s.default?(0,s.default)(e,t):e.__proto__=t)}},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Random=void 0;const r=s(n(4)),a=s(n(22)),o=[-1,0,1],i=[-1,1];class l{constructor(e=0){this.seed=e,this.rng=a.default.clone(),this.rng.setSeed(this.seed)}static setRNG(e){l.instance=e}static getRNG(e){return e?(l.rngMap[e]||(l.rngMap[e]=new l(0)),l.rngMap[e]):(l.instance||(l.instance=new l(0)),l.instance)}static reseed(e){a.default.setSeed(e);l.getRNG().setSeed(e)}setSeed(e){this.seed=e,this.rng.setSeed(e)}setState(e){this.rng.setState(e)}randProp(e){const t=Object.keys(e);return e[t[this.randIndex(t)]]}arrayGetRand(e){return e[this.randIndex(e)]}getUniqueItems(e,t=2){if(e.length<=t)return e.slice();const n={},s=[];for(;s.length<t;){const t=this.randIndex(e);n[t]||(n[t]=!0,s.push(e[t]))}return s}getUniformInt(e,t){return this.rng.getUniformInt(e,t)}randIndex(e){return Math.floor(this.rng.getUniform()*e.length)}getUniform(){return this.rng.getUniform()}getUniformRange(e,t){return e+(t-e)*this.getUniform()}getNormal(e,t){return this.rng.getNormal(e,t)}getWeighted(e){return this.rng.getWeightedValue(e)}getWeightedLinear(e){const t={};if(0===e)return 0;for(let n=0;n<e;n++)t[n]=n+1;return parseInt(this.rng.getWeightedValue(t),10)}toJSON(){return{seed:this.seed,state:this.rng.getState()}}getRandDir(){const e=this.arrayGetRand(o);let t=this.arrayGetRand(o);return 0===e&&(t=this.arrayGetRand(i)),[e,t]}getCardinalDir(){return this.arrayGetRand(r.default.CARDINAL_DIR)}getCardinalDirLetter(){return this.arrayGetRand(r.default.CARDINAL_DIR_ABBR)}getRandInBbox(e){const{ulx:t,uly:n,lrx:s,lry:r}=e;return[this.getUniformInt(t,s),this.getUniformInt(n,r)]}shiftCoord(e){const t=this.arrayGetRand(o),n=this.arrayGetRand(o);return[e[0]+t,e[1]+n]}shuffle(e){if(e.length<=1)return e;let t,n=e.length-1,s=0;for(;0!==n;)s=this.getUniformInt(0,n),n-=1,t=e[n],e[n]=e[s],e[s]=t;return e}getRandDxDy(e){return[this.getUniformInt(-e.x,e.x),this.getUniformInt(-e.y,e.y)]}}t.Random=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=o(n(1)),a=o(n(107));function o(e){return e&&e.__esModule?e:{default:e}}t.default=(0,a.default)((function(e,t,n,a,o){var i=e[t],l=void 0===i?"undefined":s(i);return r.default.isValidElement(i)?new Error("Invalid "+a+" `"+o+"` of type ReactElement supplied to `"+n+"`, expected an element type (a string or a ReactClass)."):"function"!==l&&"string"!==l?new Error("Invalid "+a+" `"+o+"` of value `"+i+"` supplied to `"+n+"`, expected an element type (a string or a ReactClass)."):null})),e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0});const a=n(34);r(n(34),t),r(n(29),t);const o=n(264);r(n(264),t);const i=n(275);r(n(275),t);const l=n(276);r(n(276),t),r(n(188),t);const c=n(181);r(n(181),t),a.Component.MindControl=o.MindControl,a.Component.Abilities=i.Abilities,a.Component.Trainer=l.Trainer,a.Component.OnAddCb=c.OnAddCb,a.Component.OnRemoveCb=c.OnRemoveCb},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.restoreParser=t.getParser=t.createItem=t.Parser=t.ProcGen=t.Creator=t.IShellDb=t.ObjectShell=void 0;const i=o(n(4)),l=a(n(61)),c=a(n(11)),u=a(n(39)),h=n(27),d=n(267),p=n(16),f=n(38),m=n(467),g=n(9),y=n(270),v=n(112),b=n(137),_=n(268),E=n(26),S=n(138),w=g.Random.getRNG();t.ObjectShell={};class C{constructor(){this.actors={},this.items={},this.elements={},this.effects={}}}t.IShellDb=C;class O{constructor(e,t){this._db=e,this._dbNoRandom=t,this._compGen=new b.ObjectShellComps,this._propToCall={actors:{type:"setType",attackRange:{comp:"Combat",func:"setAttackRange"},attack:{comp:"Combat",func:"setAttack"},defense:{comp:"Combat",func:"setDefense"},damage:{comp:"Combat",func:"setDamageDie"},numHits:{comp:"Combat",func:"setNumHits"},speed:{comp:"Stats",func:"setSpeed"},strength:{comp:"Stats",func:"setStrength"},accuracy:{comp:"Stats",func:"setAccuracy"},agility:{comp:"Stats",func:"setAgility"},willpower:{comp:"Stats",func:"setWillpower"},perception:{comp:"Stats",func:"setPerception"},magic:{comp:"Stats",func:"setMagic"},spirituality:{comp:"Stats",func:"setSpirituality"},fovrange:{comp:"Perception",func:"setFOVRange"},pp:{comp:"SpellPower",func:["setPP","setMaxPP"]},maxPP:{comp:"SpellPower",func:"setMaxPP"},hp:{comp:"Health",func:["setHP","setMaxHP"]},danger:{comp:"Experience",func:"setDanger"},brain:{func:"setBrain",factory:this.createBrain}},items:{type:"setType",value:"setValue",weight:{comp:"Physical",func:"setWeight"},material:{comp:"Physical",func:"setMaterial"},damageType:"setDamageType",speed:{comp:"Stats",func:"setSpeed"},strength:{comp:"Stats",func:"setStrength"},accuracy:{comp:"Stats",func:"setAccuracy"},agility:{comp:"Stats",func:"setAgility"},willpower:{comp:"Stats",func:"setWillpower"},perception:{comp:"Stats",func:"setPerception"},magic:{comp:"Stats",func:"setMagic"},spirituality:{comp:"Stats",func:"setSpirituality"},armour:{attack:"setAttack",defense:"setDefense",protection:"setProtection",armourType:"setArmourType"},weapon:{damage:"setDamageDie",attack:"setAttack",defense:"setDefense",weaponType:"setWeaponType",range:"setAttackRange"},missile:{damage:"setDamageDie",attack:"setAttack",range:"setAttackRange"},food:{energy:"setEnergy"}},elements:{z:"setZ",type:"setType",msg:"setMsg",name:"setName"},effects:{}},this._propToCall.items.missileweapon=this._propToCall.items.weapon,this._propToCall.items.missileweapon.fireRate="setFireRate",this._propToCall.items.ammo=this._propToCall.items.missile,this._propToCall.items.ammo.ammoType="setAmmoType"}get(e,t){return this._dbNoRandom[e][t]?this._dbNoRandom[e][t]:this._db[e][t]}createActualObj(e,t){const n=this.get(e,t),s=this._propToCall[e];if(!n)return i.default.err("Creator","createActualObj",`shell for ${t} is not found.`),null;const r=this.createNewObject(e,n);if(!r)return i.default.err("ObjectShell.creator","createActualObj","Failed to create obj with "+JSON.stringify(n)),null;n&&n.hasOwnProperty("addComp")&&this._compGen.addComponents(n,r);for(const e in n)if(s.hasOwnProperty(e)){const t=this.getShellValue(n[e]),a=s[e];if("object"==typeof a){if(a.hasOwnProperty("comp"))this._compGen.addCompToObj(r,a,t);else if(a.hasOwnProperty("factory")){if("brain"===e){const e=a.factory(r,t);r[a.func](e)}}else for(const e in a)if(a.hasOwnProperty(e)){const n=a[e];r.hasOwnProperty(n)&&r[n](t)}}else r[a](t)}else if(n.hasOwnProperty("type")){const t=this.getShellValue(n[e]);if(s.hasOwnProperty(n.type)){const a=s[n.type];if(a.hasOwnProperty(e)){const n=a[e];if("object"==typeof n){for(const e in n)if(n.hasOwnProperty(e)){const s=n[e];r.hasOwnProperty(s)&&r[n[e]](t)}}else r[n](t)}}}return n.hasOwnProperty("use")&&this.addUseEffects(n,r),n.hasOwnProperty("equip")&&this.addEquippedItems(n,r),n.hasOwnProperty("inv")&&i.default.isActor(r)&&i.default.isSentient(r)&&this.addInventoryItems(n,r),n.hasOwnProperty("loot")&&this.addLootComponents(n,r),n.hasOwnProperty("poison")&&this._compGen.addPoison(n,r),n.hasOwnProperty("enemies")&&this.addEnemies(n,r),n.hasOwnProperty("spells")&&this.addSpellbookAndSpells(n,r),n.hasOwnProperty("onHit")&&this._compGen.addOnHitProperties(n,r),n.hasOwnProperty("onAttackHit")&&this._compGen.addOnAttackHitProperties(n,r),n.hasOwnProperty("onEquip")&&this._compGen.addOnEquipProperties(n,r),n.hasOwnProperty("goals")&&this.addGoalsToObject(n,r),n.hasOwnProperty("ability")&&this.addAbilityEffects(n,r),n.hasOwnProperty("callbacks")&&this._compGen.addCallbacks(n,r),r}getShellValue(e){if("object"==typeof e){if(e.hasOwnProperty("$$dice")){console.log("$$dice: ",e.$$dice);const t=E.Dice.getValue(e.$$dice);return console.log("Rolled $$dice: ",t),t}return e.hasOwnProperty("$$select")?this.getShellValue(w.arrayGetRand(e.$$select)):e}return e}addEnemies(e,t){e.enemies.forEach(e=>{t.getBrain().addEnemyType(e)}),0===e.enemies.length&&t.getBrain().getMemory().removeEnemyTypes()}addSpellbookAndSpells(e,t){t.setBook(new y.Spell.SpellBook(t)),e.spells.forEach(e=>{const n=this.getUsedObject(e);if(y.Spell[n])t.getBook().addSpell(new y.Spell[n]);else{const e=`Spell |${n}| does not exist.`;i.default.err("Creator","addSpellbookAndSpells",e)}})}addGoalsToObject(e,t){if(i.default.isActor(t)){const{goals:n}=e;n.forEach(e=>{const{name:n,bias:s}=e,r=new f.Evaluator[n](s);Object.keys(e).forEach(t=>{"name"!==t&&"bias"!==t&&r[t](e[t])});t.getBrain().getGoal().addEvaluator(r)})}}getUsedObject(e){return"object"==typeof e&&e.random?w.arrayGetRand(e.random):e}createNewObject(e,t){switch(e){case i.default.TYPE_ACTOR:t.type;switch(t.actorType){case"BaseActor":return new l.BaseActor(t.name);default:return new l.SentientActor(t.name)}case i.default.TYPE_ITEM:const e=t.type;switch(e){case"armour":return new u.Armour(t.name);case"book":return new u.Book(t.name);case"food":return new u.Food(t.name);case"gold":return new u.Gold(t.name);case"goldcoin":return new u.GoldCoin(t.name);case"mineral":return new u.Mineral(t.name);case"missile":return new u.Missile(t.name);case"missileweapon":return new u.MissileWeapon(t.name);case"ammo":return new u.Ammo(t.name);case"potion":return new u.Potion(t.name);case"rune":return new u.Rune(t.name);case"spiritgem":return new u.SpiritGem(t.name);case"weapon":return new u.Weapon(t.name);default:{if(e){const e=new u.ItemBase(t.name);return e.setType(t.type),e}const n=`Null/undef type: ${e}, obj: ${JSON.stringify(t)}`;i.default.err("","createNewObject",n)}}break;case i.default.TYPE_ELEM:{const e=t.type||t.name;return t.new?new p.Element[t.new](t.name,e):new p.ElementBase(t.name,e)}}return null}addInventoryItems(e,t){e.inv.forEach(e=>{const n=e.name||e,s=e.count||1,r=this.createActualObj(i.default.TYPE_ITEM,n);r?(r.setCount(s),t.getInvEq().addItem(r)):i.default.err("Creator","addInventoryItems",`itemObj for ${n} is null. Actor: ${t.getName()}`)})}addLootComponents(e,t){const n=e.loot,s=this.createActualObj(i.default.TYPE_ITEM,n),r=new c.Loot(s);t.add(r)}addEquippedItems(e,t){const n=e.equip;let s=!1;n.forEach(e=>{const n=e.name||e,r=e.count||1,a=this.createActualObj(i.default.TYPE_ITEM,n);a?(a.setCount(r),t.getInvEq().restoreEquipped(a)||(s=!0)):i.default.err("Creator","addEquippedItems",`itemObj for ${e} is null. Actor: ${t.getName()}`)}),s&&w.shuffle(e.equip)}addUseEffects(e,t){if(t.useFuncs=[],i.default.isItem(t))t.useItem=this._db.effects.use.func.bind(t);else if(i.default.isActor(t)){t.useSkill=this._db.effects.use.func.bind(t);const e=t.getBrain();e.getGoal&&(e.getGoal().hasEvalType("UseSkill")||e.getGoal().addEvalByName("UseSkill",1))}if(Array.isArray(e.use))for(let n=0;n<e.use.length;n++)this._addUseEffectToEntity(e,t,e.use[n]);else if("object"==typeof e.use)for(const n in e.use)e.use.hasOwnProperty(n)&&this._addUseEffectToEntity(e,t,n);else this._addUseEffectToEntity(e,t,e.use)}_addUseEffectToEntity(e,t,n){const s=n;if(this._db.effects.hasOwnProperty(s)){const r=this._db.effects[s],a=r.func;if(t.useFuncs.push(a),t.has("UseEffects")){const s={[n]:e.use[n]};t.get("UseEffects").hasEffect(n)||t.get("UseEffects").addEffect(s)}if(r.hasOwnProperty("requires"))if(e.use.hasOwnProperty(n)){t.useArgs={};const s=r.requires;if("object"==typeof s)for(let r=0;r<s.length;r++)this._verifyAndAddReq(e.use[n],t,s[r]);else this._verifyAndAddReq(e.use[n],t,s)}else i.default.err("ObjectCreator","addUseEffects","useEffect shell has 'requires'.\n                        newObj shell 'use' must be an object.");if(r.hasOwnProperty("optional")){r.optional.forEach(s=>{e.use[n].hasOwnProperty(s)&&(t.useArgs[s]=e.use[n][s])})}}else i.default.err("ObjectCreator","addUseEffects","Unknown effect: |"+s+"|")}addAbilityEffects(e,t){e.use||(e.use=e.ability),t.has("UseEffects")||t.add(new c.UseEffects),this.addUseEffects(e,t)}_verifyAndAddReq(e,t,n){e.hasOwnProperty(n)?t.useArgs[n]=e[n]:i.default.err("ObjectCreator","_verifyAndAddReq",`Req |${n}| not specified in item shell. Item: ${t}`)}createFromShell(e,t){return t?this.createActualObj(e,t.name):(i.default.err("Creator","createFromShell","obj given must be defined."),null)}createBrain(e,t){if(h.Brain[t])return new h.Brain[t](e);const n=`ERROR. No brain type |${t}| found`;i.default.err("Creator","createBrain",n)}}t.Creator=O,t.ObjectShell.Creator=O;class T{constructor(e,t){this._db=e,this._dbDanger=t,this._cache={actorWeights:{},categByType:{actors:{},items:{},elements:{}}}}dbGet(e){const t=e.name,n=e.categ,s=e.danger;if(!i.default.isNullOrUndef([t]))return n||i.default.err("ProcGen","dbGet","Both name and categ must be given!"),this._db[n][t];if(!i.default.isNullOrUndef([s])){if(this._dbDanger.hasOwnProperty(s)){const e=this._dbDanger[s];return void 0!==n?e.hasOwnProperty(n)?e[n]:{}:this._dbDanger[s]}return{}}return!i.default.isNullOrUndef([n])&&this._db.hasOwnProperty(n)?this._db[n]:{}}filterCategWithFunc(e,t){const n=this.dbGet({categ:e}),s=[],r=Object.keys(n);for(let e=0;e<r.length;e++){const a=n[r[e]];t(a)&&s.push(a)}return s}dbGetRand(e){const t=e.danger,n=e.categ;if(void 0!==t&&void 0!==n&&this._dbDanger.hasOwnProperty(t)){const e=this._dbDanger[t][n];return this.getRandFromObj(e)}return null}getRandomActor(e){if(e.hasOwnProperty("danger")){const t=e.danger,n=this.dbGetRand({danger:t,categ:i.default.TYPE_ACTOR});if(null!==n)return n}else if(e.hasOwnProperty("func")){const t=this.filterCategWithFunc(i.default.TYPE_ACTOR,e.func);return w.arrayGetRand(t)}return null}getRandomItem(e){if("function"==typeof e){const t=this.filterCategWithFunc(i.default.TYPE_ITEM,e);return w.arrayGetRand(t)}if(e.hasOwnProperty("func")){const t=this.filterCategWithFunc(i.default.TYPE_ITEM,e.func);return w.arrayGetRand(t)}return i.default.err("ProcGen","getRandomItem","No function with func. obj arg: "+JSON.stringify(e)),null}getRandomActorWeighted(e,t){const n=e+","+t;this._cache.actorWeights.hasOwnProperty(n)||(this._cache.actorWeights[n]=i.default.getDangerProb(e,t));const s=w.getWeighted(this._cache.actorWeights[n]);return this.getRandomActor({danger:parseInt(s,10)})}getRandFromObj(e){const t=Object.keys(e);return e[t[w.randIndex(t)]]}}t.ProcGen=T,t.ObjectShell.ProcGen=T;class M{constructor(){this._base=new C,this._db=new C,this._dbDanger={},this._dbNoRandom=new C,this._creator=new O(this._db,this._dbNoRandom),this._procgen=new T(this._db,this._dbDanger),this.adjustColorsWhenNeeded=!0}getCreator(){return this._creator}getProcGen(){return this._procgen}parseShellData(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const s=e[t[n]];Array.isArray(s)?this.parseShellCateg(t[n],s):i.default.err("ObjectShell.Parser","parseShellData",t[n]+" is not an array of shells!")}}parseShellCateg(e,t){for(let n=0;n<t.length;n++)this.parseObjShell(e,t[n])}parseObjShell(e,t){if(this.validShellGiven(t)){if(t.hasOwnProperty("base")){("string"==typeof t.base?[t.base]:t.base).forEach(n=>{this.baseExists(e,n)?t=this.extendObj(t,this.getBase(e,n)):i.default.err("ObjectParser","parseObjShell","Unknown base "+n+" specified for "+JSON.stringify(t))})}return e===i.default.TYPE_ACTOR&&this.addTypeIfUntyped(t),this.storeIntoDb(e,t),t}return null}validShellGiven(e){return!!e.hasOwnProperty("name")||(i.default.err("Parser","validShellGiven","shell doesn't have a name. shell: "+JSON.stringify(e)),!1)}addTypeIfUntyped(e){e.hasOwnProperty("type")||(e.type=e.name)}get(e,t){return this._db[e][t]}getBase(e,t){return this._base[e][t]}storeForUsingAsBase(e,t){this._base[e][t.name]=t}storeIntoDb(e,t){if(this._db.hasOwnProperty(e)){if(this.storeForUsingAsBase(e,t),t.hasOwnProperty("noRandom"))this._dbNoRandom[e][t.name]=t;else if(!t.hasOwnProperty("dontCreate")&&(this._db[e][t.name]=t,t.hasOwnProperty("danger"))){const n=t.danger;this._dbDanger.hasOwnProperty(n)||(this._dbDanger[n]={}),this._dbDanger[n].hasOwnProperty(e)||(this._dbDanger[n][e]={}),this._dbDanger[n][e][t.name]=t}}else i.default.err("ObjectParser","storeIntoDb","Unknown category: "+e);"effects"!==e&&this.storeRenderingInfo(e,t)}storeRenderingInfo(e,t){let n="",s="";if(t.hasOwnProperty("color")){if(i.default.isNullOrUndef([t.color])){const e=JSON.stringify(t);i.default.err("Parser","storeRenderingInfo","obj.color null/undef! obj: "+e)}n=this._creator.getShellValue(t.color.fg),s=this._creator.getShellValue(t.color.bg)}t.hasOwnProperty("colorfg")&&(n=this._creator.getShellValue(t.colorfg)),t.hasOwnProperty("colorbg")&&(s=this._creator.getShellValue(t.colorbg)),"random"===n&&(n=w.arrayGetRand(i.default.COLORS)),"random"===s&&(s=w.arrayGetRand(i.default.COLORS)),this.adjustColorsWhenNeeded&&""!==n&&""!==s&&_.colorsTooClose(n,s)&&(n=_.getNewFgColor(n,s)),""===n&&""===s||(t.className||(t.className=""),t.className+=" cell-fg-"+n.toLowerCase()+" cell-bg-"+s.toLowerCase()),t.hasOwnProperty("char")&&(t.hasOwnProperty("name")?(i.default.addCharStyle(e,t.name,t.char),t.dontCreate&&i.default.addCharStyle(e,t.type,t.char)):i.default.addCharStyle(e,t.type,t.char)),t.hasOwnProperty("className")&&(t.hasOwnProperty("name")?(i.default.addCellStyle(e,t.name,t.className),t.dontCreate&&i.default.addCellStyle(e,t.type,t.className)):i.default.addCellStyle(e,t.type,t.className))}baseExists(e,t){return!!this._base.hasOwnProperty(e)&&this._base[e].hasOwnProperty(t)}extendObj(e,t){for(const n in t)e.hasOwnProperty(n)||"dontCreate"!==n&&(e[n]=t[n]);return e}createEntity(e){return this.hasObj(i.default.TYPE_ITEM,e)?this.createItem(e):this.hasObj(i.default.TYPE_ACTOR,e)?this.createActor(e):null}createActor(e){return this.createActualObj(i.default.TYPE_ACTOR,e)}createItem(e){return this.createActualObj(i.default.TYPE_ITEM,e)}createElement(e){return this.createActualObj(i.default.TYPE_ELEM,e)}hasItem(e){return this.hasObj(i.default.TYPE_ITEM,e)}hasObj(e,t){return this.dbExists(e,t)}createActualObj(e,t){return this.dbExists(e,t)?this._creator.createActualObj(e,t):(i.default.err("Parser","createActualObj",`Categ: ${e} Name: ${t} doesn't exist.`),null)}createFromShell(e,t){return this.dbExists(e,t.name)||this.parseObjShell(e,t),this._creator.createFromShell(e,t)}dbExists(e,t){return!(!this._db.hasOwnProperty(e)||!this._db[e].hasOwnProperty(t))||!!this._dbNoRandom[e][t]}dbGet(e){return this._procgen.dbGet(e)}dbGetActor(e){const t={name:e.name,categ:i.default.TYPE_ACTOR};return this._procgen.dbGet(t)}dbGetItem(e){const t={name:e.name,categ:i.default.TYPE_ITEM};return this._procgen.dbGet(t)}dbGetRand(e){return this._procgen.dbGetRand(e)}filter(e,t){return this._procgen.filterCategWithFunc(e,t)}filterItems(e){return this._procgen.filterCategWithFunc(i.default.TYPE_ITEM,e)}dbGetNoRandom(e){const t=e.name,n=e.categ,s=e.danger;if(n&&this._dbNoRandom[n]){if(!t)return Object.values(this._dbNoRandom[n]);{const e=this._dbNoRandom[n][t];if(e)return[e]}}else n&&s&&i.default.err("ProcGen","dbGetNoRandom","Query by danger not implemented yet");return[]}createRandomActor(e){const t=this._procgen.getRandomActor(e);return t?this._creator.createFromShell(i.default.TYPE_ACTOR,t):null}createRandomActorWeighted(e,t,n){const s=this._procgen.getRandomActorWeighted(e,t);return s?this._creator.createFromShell(i.default.TYPE_ACTOR,s):i.default.isNullOrUndef([n])?null:this.createRandomActor(n)}createRandomItem(e){const t=this._procgen.getRandomItem(e);return t?this._creator.createFromShell("items",t):null}toJSON(){const e={_base:{},_db:{},_dbDanger:this._dbDanger,_dbNoRandom:this._dbNoRandom};return["actors","items","elements"].forEach(t=>{e._base[t]=this._base[t],e._db[t]=this._db[t]}),e}restoreFromDb(e){["_base","_db","_dbDanger","_dbNoRandom"].forEach(t=>{Object.keys(e[t]).forEach(n=>{this[t][n]=e[t][n]})})}}t.Parser=M,t.ObjectShell.Parser=M,t.createItem=function(e){const n=t.ObjectShell.getParser(),s=n.getCreator();return"string"==typeof e?s.createItem(e):(n.parseObjShell(i.default.TYPE_ITEM,e),s.createFromShell(i.default.TYPE_ITEM,e))},t.getParser=function(){if(!t.ObjectShell.parserInstance){const e=new M;e.parseShellData(d.Effects);const n=JSON.stringify(m.Objects),s=JSON.parse(n);v.adjustActorValues(s.actors),e.adjustColorsWhenNeeded=!1,e.parseShellData(s),e.adjustColorsWhenNeeded=!0,t.ObjectShell.parserInstance=e,S.ActorGen.maxNumRoles=1;const r=S.ActorGen.genActors(1e3);S.ActorGen.maxNumRoles=2,e.parseShellData({actors:r})}return t.ObjectShell.parserInstance},t.ObjectShell.getParser=t.getParser,t.restoreParser=function(e){const n=new M;n.restoreFromDb(e),n.parseShellData(d.Effects),t.ObjectShell.parserInstance=n},t.ObjectShell.restoreParser=t.restoreParser},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Geometry=void 0;const r=s(n(4)),a=n(9),o=n(30),i=a.Random.getRNG();class l{static getBoxAround(e,t,n,s=!1){c([e,t]);const r=[];for(let s=e-n;s<=e+n;s++)for(let a=t-n;a<=t+n;a++)s===e&&a===t||r.push([s,a]);return s&&r.push([e,t]),r}static getCrossAround(e,t,n,s=!1){c([e,t,n]);const r=[];for(let s=e-n;s<=e+n;s++)for(let a=t-n;a<=t+n;a++)s!==e&&a!==t||s===e&&a===t||r.push([s,a]);return s&&r.push([e,t]),r}static getDiagCross(e,t,n,s=!1){c([e,t,n]);const r=[];for(let s=e-n;s<=e+n;s++)for(let a=t-n;a<=t+n;a++){const n=a-t;0!==s-e&&0!==n&&r.push([s,a])}return s&&r.push([e,t]),r}static getCrossCaveConn(e,t,n,s=!1){c([e,t,n]);const r=[];for(let s=e-n;s<=e+n;s++)for(let a=t-n;a<=t+n;a++)s!==e&&a!==t||s===e&&a===t||r.push([s,a]);return s&&r.push([e,t]),r}static getBox(e,t,n,s){c([e,t,n,s]);const r=[];for(let a=e;a<=n;a++)for(let e=t;e<=s;e++)r.push([a,e]);return r}static convertBbox(e){return e.hasOwnProperty("llx")?o.BBox.fromBBox({ulx:e.llx,uly:e.ury,lrx:e.urx,lry:e.lly}):o.BBox.fromBBox(e)}static getCoordBbox(e){const{ulx:t,uly:n,lrx:s,lry:r}=e;return this.getBox(t,n,s,r)}static getBorderForBbox(e){const{ulx:t,uly:n,lrx:s,lry:r}=e;return this.getHollowBox(t,n,s,r)}static getCellsInBbox(e,t){const n=this.getCoordBbox(t),s=[];return n.forEach(t=>{s.push(e[t[0]][t[1]])}),s}static isInBbox(e,t,n){const{ulx:s,uly:r,lrx:a,lry:o}=n;return e>=s&&e<=a&&t>=r&&t<=o}static isValidBbox(e){if(!e)return!1;const{ulx:t,uly:n,lrx:s,lry:a}=e;return!r.default.isNullOrUndef([t,n,s,a])}static dirToBbox(e,t,n){const s=Math.round(e/3),a=Math.round(t/3),i=s,l=a,c=2*s-1,u=2*a-1,h=r.default.dirTodXdY(n);return h?o.BBox.fromBBox({ulx:i+h[0]*s,uly:l+h[1]*a,lrx:c+h[0]*s,lry:u+h[1]*a}):(r.default.err("Geometry","dirToBbox",`Invalid dir ${n} given.`),null)}static combineAdjacent(e){let t=!1;const n=[],s={},r=e.sort((e,t)=>e.uly<=t.uly?1:-1);r.forEach((e,t)=>{s[t]=e});for(let e=0;e<r.length;e++)for(let a=0;a<r.length;a++)if(e!==a&&s[e]&&s[a]){const o=r[e].combine(r[a]);o&&(t=!0,n.push(o),delete s[e],delete s[a])}return t?(Object.values(s).forEach(e=>{n.push(e)}),l.combineAdjacent(n)):e.slice()}static coordToDirMap(e,t){const n={};return t.forEach(t=>{if(t[0]===e[0]&&t[1]===e[1])return;const s=r.default.dXdYUnit(t,e),a=r.default.dXdYToDir(s);n[a]||(n[a]=[]),n[a].push(t)}),n}static getBoxCornersForCells(e,t){const[n,s]=[e.getX(),e.getY()],[r,a]=[t.getX(),t.getY()],i=n<=r?n:r,l=r>n?r:n,c=s<=a?s:a,u=a>s?a:s;return o.BBox.fromBBox({ulx:i,uly:c,lrx:l,lry:u})}static getHollowBox(e,t,n,s){c([e,t,n,s]);const r=[];for(let a=e;a<=n;a++)for(let o=t;o<=s;o++)o!==t&&o!==s&&a!==e&&a!==n||r.push([a,o]);return r}static getHollowDiamond(e,t,n){c([e,t,n]);const s=e+2*n,r=e+n,a=t+n,o=t-n,i=[[e,t]],l={N:[r,a],S:[r,o],E:[s,t],W:[e,t],coord:[]};for(let n=e+1;n<=r;n++){for(let e=t+1;e<=a;e++)i.push([n,e]);for(let e=t-1;e>=o;e--)i.push([n,e])}for(let e=r+1;e<=s;e++){for(let n=t+1;n<=a;n++)i.push([e,n]);for(let n=t-1;n>=o;n--)i.push([e,n])}return l.coord=i,l}static isCorner(e,t,n,s,r,a){return(e===n||e===r)&&(t===s||t===a)}static removeMatching(e,t){let n=0;return Array.isArray(e)?t.forEach(t=>{const s=e.findIndex(e=>e[0]===t[0]&&e[1]===t[1]);s>=0&&(e.splice(s,1),++n)}):t.forEach(t=>{const s=t[0]+","+t[1];e.hasOwnProperty(s)&&(delete e[s],++n)}),n}static getCellsAround(e,t){const n=t.getXY(),s=this.getBoxAround(n[0],n[1],1),a=e.getCellsWithCoord(s),o={};return a.forEach(e=>{const t=r.default.dXdYUnit(e,n),s=r.default.dXdYToDir(t);o[s]=e.getBaseElem().getType()}),o}static tileLevels(e,t,n){const{x:s,y:r}=n;let a=s,o=r;if(n.alignLeft)t.forEach(t=>{this.mergeLevels(e,t,a,o),o+=t.getMap().rows});else if(n.centerX){const n=Math.round(e.getMap().cols/2);t.forEach(t=>{a=n-Math.round(t.getMap().cols/2),this.mergeLevels(e,t,a,o),o+=t.getMap().rows})}else if(n.centerY){const n=Math.round(e.getMap().rows/2);t.forEach(t=>{o=n-Math.round(t.getMap().rows/2),this.mergeLevels(e,t,a,o),a+=t.getMap().cols})}}static mergeLevels(e,t,n,s,a){const o=e.getMap(),i=t.getMap(),l=e.getActors().length+t.getActors().length,c=t.getActors().slice(),u=t.getItems().slice(),h=t.getElements().slice(),d=e=>[e.getX()+n,e.getY()+s];c.forEach(n=>{const[s,r]=d(n);o.hasXY(s,r)&&t.removeActor(n)&&e.addActor(n,s,r)}),u.forEach(n=>{const[s,r]=[n.getX(),n.getY()],[a,i]=d(n);o.hasXY(a,i)&&t.removeItem(n,s,r)&&e.addItem(n,a,i)}),h.forEach(n=>{const[s,r]=[n.getX(),n.getY()],[a,i]=d(n);o.hasXY(a,i)&&t.removeElement(n,s,r)&&e.addElement(n,a,i)}),this.mergeMapBaseElems(o,i,n,s,a),t.hasExtras()&&this.mergeLevelExtras(e,t,n,s);const p=e.getActors().length;p!==l&&r.default.err("Geometry","mergeLevels",`Num actors new: ${p}, exp: ${l}`)}static mergeLevelExtras(e,t,n,s){const r=t.getExtras();Object.keys(r).forEach(t=>{if("houses"===t){const a=r[t];if(a.forEach(e=>{e.moveHouse(n,s)}),e.getExtras().houses){const t=e.getExtras().houses.concat(a);e.addExtras("houses",t)}else e.addExtras("houses",a)}else if("term"===t||"room"===t||"bigRoom"===t||"storeroom"===t||"corridor"===t||"vault"===t){const a=r[t];if(a.forEach(e=>{e.moveRoom(n,s)}),e.getExtras()[t]){const n=e.getExtras()[t].concat(a);e.addExtras(t,n)}else e.addExtras(t,a)}})}static mergeMapBaseElems(e,t,n,s,a){if(e.cols<t.cols){const n=`m1: ${e.cols} m2: ${t.cols}`;r.default.err("Geometry","mergeMapBaseElems","Cols: m2 cols must be smaller/equal: "+n)}if(e.rows<t.rows){const n=`m1: ${e.rows} m2: ${t.rows}`;r.default.err("Geometry","mergeMapBaseElems","Rows: m2 rows must be smaller/equal: "+n)}const o=n+t.cols-1,l=s+t.rows-1;if(a){for(let r=n;r<=o;r++)for(let o=s;o<=l;o++)if(e.hasXY(r,o)){const l=t.getCell(r-n,o-s).getBaseElem(),c=l.getName();if(a.skip&&a.skip[c])continue;if(a.only&&!a.only[c])continue;let[u,h]=[r,o];if(a.noise&&a.noise.baseElems){const e=i.getRandDxDy(a.noise.baseElems);u+=e[0],h+=e[1]}e.hasXY(u,h)&&e._map[u][h].setBaseElem(l)}}else for(let r=n;r<=o;r++)for(let a=s;a<=l;a++)if(e.hasXY(r,a)){const o=t.getCell(r-n,a-s);e._map[r][a].setBaseElem(o.getBaseElem())}}static copyBaseElems(e,t,n,s){const r=e.getMap(),a=t.getMap(),o=n+a.cols-1,i=s+a.rows-1;for(let e=n;e<=o;e++)for(let t=s;t<=i;t++){const o=r._map[e][t].getBaseElem();a._map[e-n][t-s].setBaseElem(o)}}static mergeMapCellsUnsafe(e,t,n,s){const a=n+t.cols-1,o=s+t.rows-1;for(let i=n;i<=a;i++)for(let a=s;a<=o;a++)if(e.hasXY(i,a)){const o=t.getCell(i-n,a-s);o||r.default.err("Geometry","mergeMapCellsUnsafe",`Null cell: ${n},${s}, [${i}][${a}]`),e.moveCellUnsafe(i,a,o)}}static mergeMaps(e,t,n,s,r=((e,t)=>!0)){const a=n+t.cols-1,o=s+t.rows-1;for(let i=n;i<=a;i++)for(let a=s;a<=o;a++)if(e.hasXY(i,a)){const o=t.getCell(i-n,a-s),l=e._map[i][a];r(l,o)&&l.setBaseElem(o.getBaseElem())}}static iterateMapWithBBox(e,t,n){for(let s=t.ulx;s<=t.lrx;s++)for(let r=t.uly;r<=t.lry;r++)e.hasXY(s,r)&&n(s,r)}static insertEntity(e,t,n,s){switch(t){case r.default.TYPE_ACTOR:this.insertActors(e,t,n,s);break;case r.default.TYPE_ITEM:this.insertItems(e,t,n,s);break;case r.default.TYPE_ELEM:this.insertElements(e,t,n,s);break;default:r.default.err("Geometry","insertEntity",`No type ${t} supported`)}}static insertElements(e,t,n,s){const r=e.getMap();this.iterateMapWithBBox(r,n,(n,a)=>{const o=s(t);o.getX&&o.getY?(console.log("Geometry.insertElements, added to",n,a),e.addElement(o,n,a)):r._map[n][a].setBaseElem(o)})}static insertActors(e,t,n,s){const a=e.getMap();this.iterateMapWithBBox(a,n,(n,o)=>{if(a.getCell(n,o).isFree()){const a=s.createActualObj(r.default.TYPE_ACTOR,t);e.addActor(a,n,o)}})}static insertItems(e,t,n,s){const a=e.getMap();this.iterateMapWithBBox(a,n,(n,o)=>{if(a.getCell(n,o).isFree()){const a=s.createActualObj(r.default.TYPE_ITEM,t);e.addItem(a,n,o)}})}static getFreeArea(e,t,n,s){let r=!1;const a=e.slice(),o={};for(e.forEach(e=>{o[e[0]+","+e[1]]=e});!r&&a.length>0;){const e=i.getUniformInt(0,a.length-1),l=a[e][0],c=a[e][1];let u=!0;for(let e=l;e<l+t;e++)for(let t=c;t<c+n;t++)o[e+","+t]?s.push([e,t]):u=!1;r=u,r||(s=[],a.splice(e))}return r}static isLine(e,t,n,s){return e===n||t===s||Math.abs(n-e)===Math.abs(s-t)}static xyInLine(e){for(let t=1;t<e.length;t++){const[n,s]=[e[t],e[t-1]],[r,a]=n,[o,i]=s;if(!this.isLine(r,a,o,i))return!1}return!0}static sameXOrY(e){for(let t=1;t<e.length;t++){const[n,s]=[e[t],e[t-1]],[r,a]=n,[o,i]=s;if(r!==o&&a!==i)return!1}return!0}static getStraightLine(e,t,n,s,r=!0){if(this.isLine(e,t,n,s)){const a=[],o=n===e?0:(n-e)/Math.abs(n-e),i=s===t?0:(s-t)/Math.abs(s-t);for(r&&a.push([e,t]);e!==n||t!==s;)e!==n&&(e+=o),t!==s&&(t+=i),e===n&&t===s?r&&a.push([e,t]):a.push([e,t]);return a}return[]}static getBresenham(e,t,n,s){let[r,a,o,i]=[0,0,0,0],[l,c,u,h]=[0,0,0,0],[d,p]=[0,0];const f=[];if(r=n-e,a=s-t,r<0&&(r=-r),a<0&&(a=-a),l=1,n<e&&(l=-1),c=1,s<t&&(c=-1),d=e,p=t,f.push([d,p]),r>a)for(i=2*a-r,u=2*(a-r),h=2*a,o=0;o<r;o++)i>=0?(p+=c,i+=u):i+=h,d+=l,f.push([d,p]);else for(i=2*r-a,u=2*(r-a),h=2*r,o=0;o<a;o++)i>=0?(d+=l,i+=u):i+=h,p+=c,f.push([d,p]);return f}static getMissilePath(e,t,n,s,r=!0){let a=[];if(this.isLine(e,t,n,s))a=this.getStraightLine(e,t,n,s,r);else{r&&a.push([e,t]);const o=n-e,i=s-t,l=Math.abs(o),c=Math.abs(i),u=o/l,h=i/c;let d=l,p=c,f=e,m=t;if(l>c){for(;p>=0&&d%p!=0;)f+=u,m+=h,a.push([f,m]),d-=1,p-=1;if(0===p)for(;f!==n;)f+=u,a.push([f,m]);else{const e=d/p;for(;f!==n&&m!==s;){m!==s&&(m+=h);for(let t=0;t<e;t++)f!==n&&(f+=u,a.push([f,m]))}}}else if(c>l){for(;d>=0&&p%d!=0;)f+=u,m+=h,a.push([f,m]),d-=1,p-=1;if(0===d)for(;m!==s;)m+=h,a.push([f,m]);else{const e=p/d;for(;f!==n&&m!==s;){f!==n&&(f+=u);for(let t=0;t<e;t++)m!==s&&(m+=h,a.push([f,m]))}}}}return a}static distance3D(e,t){const n=t[0]-e[0],s=t[1]-e[1],r=t[2]-e[2];return Math.sqrt(Math.pow(n,2)+Math.pow(s,2)+Math.pow(r,2))}static distance3DSquared(e,t){const n=t[0]-e[0],s=t[1]-e[1],r=t[2]-e[2];return Math.pow(n,2)+Math.pow(s,2)+Math.pow(r,2)}static lineFunc3D(e,t,n,s=!0){let[r,a,o]=e.map(e=>e+.5);const i=l.distance3D(e,t),c=Math.floor(i),u=(t[0]-r)/i,h=(t[1]-a)/i,d=(t[2]-o)/i;s&&n(Math.floor(r),Math.floor(a),Math.floor(o));for(let e=0;e<c;e++)r+=u,a+=h,o+=d,n(Math.floor(r),Math.floor(a),Math.floor(o));s&&n(t[0],t[1],t[2])}static lineFuncUnique3D(e,t,n=!0){const s=r.default.toKey(e)+","+r.default.toKey(t)+n;return l._cache.lineFuncUnique3D.hasOwnProperty(s)||(l._cache.lineFuncUnique3D[s]=l.bresenham3D(...e,...t)),l._cache.lineFuncUnique3D[s]}static getBresenham3D(e,t){return l.bresenham3D(...e,...t)}static bresenham3D(e,t,n,s,r,a){let o=0,i=0,l=0;const c=[-1,-1,-1];c[0]=e,c[1]=t,c[2]=n;const u=s-e,h=r-t,d=a-n,p=u<0?-1:1,f=Math.abs(u),m=h<0?-1:1,g=Math.abs(h),y=d<0?-1:1,v=Math.abs(d),b=f<<1,_=g<<1,E=v<<1,S=[];if(f>=g&&f>=v)for(i=_-f,l=E-f,o=0;o<f;o++)S.push([c[0],c[1],c[2]]),i>0&&(c[1]+=m,i-=b),l>0&&(c[2]+=y,l-=b),i+=_,l+=E,c[0]+=p;else if(g>=f&&g>=v)for(i=b-g,l=E-g,o=0;o<g;o++)S.push([c[0],c[1],c[2]]),i>0&&(c[0]+=p,i-=_),l>0&&(c[2]+=y,l-=_),i+=b,l+=E,c[1]+=m;else for(i=_-v,l=b-v,o=0;o<v;o++)S.push([c[0],c[1],c[2]]),i>0&&(c[1]+=m,i-=E),l>0&&(c[0]+=p,l-=E),i+=_,l+=b,c[2]+=y;return S.push([c[0],c[1],c[2]]),S}static drunkenWalk(e,t,n=!1){const s={},a=[e];let o=e,l=1e3;for(;t>0&&l>0;){const e=i.getRandDir(),c=[o[0]+e[0],o[1]+e[1]];o=c;const u=r.default.toKey(c);n&&s[u]||(a.push(c),--t,s[u]=!0),--l}return a}}function c(e){e.forEach(t=>{if(!Number.isInteger(t)){const t=JSON.stringify(e);r.default.err("Geometry","verifyInt","Value not an Int. Arr: "+t)}})}t.Geometry=l,l.floodfill=function(e,t,n,s=!1){let r=n;if("string"==typeof n&&(r=e=>e.getBaseElem().getType()===n),!r(t))return[];let a=t;const o=[],i=[t],l={};l[t.getKeyXY()]=!0;const c=function(t,n){if(e.hasXY(t,n)&&!l[t+","+n]){const s=e.getCell(t,n);r(s)&&(l[s.getKeyXY()]=!0,i.push(s),o.push(s))}};for(;a;){const[e,t]=a.getXY(),n=e-1;c(n,t);const r=e+1;c(r,t);const i=t-1;c(e,i);const l=t+1;c(e,l),s&&(c(n,i),c(r,i),c(n,l),c(r,l)),a=o.shift()}return i},l.floodfillPassable=function(e,t=!1){const n=e=>!e.hasObstacle()||e.hasDoor(),s=e.getCells(n)[0];return l.floodfill(e,s,n,t)},l.floodfillRegions=function(e,t=!1){const n=[],s=e=>!e.hasObstacle()||e.hasDoor(),r=e.getCells(s).map(e=>e.getXY());for(;r.length>0;){const t=r[0],[a,o]=t,i=l.floodfill(e,e.getCell(a,o),s,!0).map(e=>e.getXY());l.removeMatching(r,i),n.push(i)}return n},l.floodfill2D=function(e,t,n,s=!1,r=!1){const[a,o]=t;if(e[a][o]!==n)return[];let i=t;const l=[],c=[i],u={};u[a+","+o]=!0;const h=function(t,r){if(t>=0&&t<e.length&&r>=0&&r<e[0].length&&!u[t+","+r]){e[t][r]===n&&(u[t+","+r]=!0,c.push([t,r]),s&&(s[t+","+r]=!0),l.push([t,r]))}};for(;i;){const[e,t]=i,n=e-1;h(n,t);const s=e+1;h(s,t);const a=t-1;h(e,a);const o=t+1;h(e,o),r&&(h(n,a),h(s,a),h(n,o),h(s,o)),i=l.shift()}return c},l.getMassCenter=function(e){let t=0,n=0;for(let s=0;s<e.length;s++)t+=e[s][0],n+=e[s][1];return[Math.round(t/e.length),Math.round(n/e.length)]},l.squareFill=function(e,t,n,s){const[a,o]=t.getXY(),[i,l]=s;0!==i&&0!==l||r.default.err("Geometry","squareFill","dx,dy must be -1 or 1. Got "+s);let c=!1,u=[t],h=t;for(;!c;){const t=[],[s,r]=h.getXY(),[d,p]=[s+i,r+l];if(e.hasXY(d,p)){const s=e.getCell(d,p);if(s.getBaseElem().getType()!==n){c=!0;break}t.push(s);let r=d;do{r+=-i;const s=e.getCell(r,p);if(s.getBaseElem().getType()!==n){c=!0;break}t.push(s)}while(r!==a);let f=p;do{f+=-l;const s=e.getCell(d,f);if(s.getBaseElem().getType()!==n){c=!0;break}t.push(s)}while(f!==o);c||(u=u.concat(t)),h=s}}return u},l.histArrayVals=function(e){const t={};return e.forEach(e=>{t[e]?t[e]+=1:t[e]=1}),t},l.tesselateLine=function(e,t,n,s,r,a){const o=Math.abs(e-n),c=Math.abs(t-s),u=e<n?e:n,h=e>n?e:n,d=t<s?t:s,p=t>s?t:s;if(o>=r&&c>=r){const o=i.getUniformInt(u,h),c=i.getUniformInt(d,p);l.tesselateLine(e,t,o,c,r,a),l.tesselateLine(o,c,n,s,r,a)}else{l.getBresenham(e,t,n,s).forEach(e=>{a.push(e)})}},l.getCaveConnLine=function(e,t,n,s,r){let a=[];const o=[];l.tesselateLine(e,t,n,s,4,o);let c=l.getCrossCaveConn;return r&&"function"==typeof r.brush&&(c=r.brush),o.forEach(e=>{const[t,n]=e,s=i.getUniformInt(1,3),r=c(t,n,s,!0);a=a.concat(r)}),a},l._cache={lineFuncUnique3D:{}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemBase=void 0;const i=o(n(4)),l=a(n(11)),c=n(23),u=n(9),h=n(15)("bitn:System");c.EventPool.getPool();t.SystemBase=class{constructor(e,t,n){Array.isArray(t)||i.default.err("System.Base","new","2nd arg must be an array of component types"),this.type=e,this.compTypes=t,this.entities={},this.compTypesAny=!1,this.hasNotify=!0,this.enabled=!0,this.legalArgs=[],this.pool=n;for(let e=0;e<this.compTypes.length;e++)l.hasOwnProperty(this.compTypes[e])||i.default.err("System.Base","new",`Comp type |${this.compTypes[e]}| not in Component`),this.pool.listenEvent(this.compTypes[e],this);this.traceID=686,this.traceIDs={270512:!0},this.debugEnabled=h.enabled,this.rng=new u.Random(0)}static addSkillsExp(e,t,n=1){if(e.has("Skills")){const s=new l.SkillsExp;s.setSkill(t),s.setPoints(n),e.add(s)}}static addCompToEntAfterHit(e,t,n){const s=e.clone();if(s.hasOwnProperty("duration")){const e=s.rollDuration(),n=new l.Expiration;n.addEffect(s,e),t.add(n)}if(s.getSource){const e=s.getSource();i.default.isNullOrUndef([e])&&s.setSource(n)}t.add(s)}setRNG(e){this.rng=e}setArgs(e){this.legalArgs.forEach(t=>{e.hasOwnProperty(t)&&(this[t]=e[t])})}numEntities(){return Object.keys(this.entities).length}addEntity(e){this.entities[e.getID()]=e}removeEntity(e){delete this.entities[e.getID()]}notify(e,t){t.hasOwnProperty("add")?this.hasCompTypes(t.entity)&&(this.addEntity(t.entity),this.debugEnabled&&this._emitDbgMsg("ADD",t.entity)):t.hasOwnProperty("remove")&&(this.hasCompTypes(t.entity)||(this.removeEntity(t.entity),this.debugEnabled&&this._emitDbgMsg("RMV",t.entity)))}hasCompTypes(e){const t=this.compTypes;return!1===this.compTypesAny?e.hasAll(t):e.hasAny(t)}hasEntities(){return Object.keys(this.entities).length>0}update(){if(this.enabled)for(const e in this.entities)e&&this.updateEntity(this.entities[e])}updateEntity(e){i.default.err("SystemBase","updateEntity","Not implemented in the base class")}dbg(e){if(this.debugEnabled){const t=this.numEntities();let n=`[System ${this.type.toString()}]`;n+=" nEnt: "+t,h.enabled?h(`${n} ${e}`):console.log(`${n} ${e}`)}}addDebugTraceID(e){this.traceIDs[e]=!0}_emitDbgMsg(e,t){let n="<UNNAMED>";t.getName&&(n=t.getName());const s=t.getID();if(-1===this.traceID||this.traceIDs[s]){const t=`|${e}| Ent: ${n}, ID: ${s}`;this.dbg(t)}}}},function(e,t,n){(function(s){t.log=function(...e){return"object"==typeof console&&console.log&&console.log(...e)},t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;t.splice(1,0,n,"color: inherit");let s=0,r=0;t[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(s++,"%c"===e&&(r=s))}),t.splice(r,0,n)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}!e&&void 0!==s&&"env"in s&&(e=s.env.DEBUG);return e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.exports=n(458)(t);const{formatters:r}=e.exports;r.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}).call(this,n(43))},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.create=t.ElementMarker=t.ElementPlantedSoil=t.ElementTilledSoil=t.ElementPlaceholder=t.ElementHole=t.ElementSlime=t.ElementWeb=t.ElementTrap=t.ElementExploration=t.ElementShop=t.ElementLever=t.ElementLeverDoor=t.ElementDoor=t.ElementStairs=t.ElementXY=t.ElementWall=t.ElementBase=t.Element=void 0;const i=o(n(4)),l=n(55),c=a(n(133)),u=a(n(29)),h=n(34);t.Element={};const d=/wall/,p=/(?:highrock|chasm|wall)/;t.Element.canJumpOver=e=>!(d.test(e)||/highrock/.test(e));class f extends(c.Typed(l.Entity)){constructor(e,t){let n=null,s=null;"object"==typeof e?(n=e.name,s=e.type):(n=e,s=t),s=s||n,super({propType:i.default.TYPE_ELEM,type:s}),this._name=n,this.msg={},this.z=0}getName(){return this._name}setName(e){this._name=e}getZ(){return this.z}setZ(e){this.z=e}isWall(){return d.test(this.getType())}isObstacle(){return p.test(this.getType())}isPassable(){return!this.has("Impassable")}isPassableByAir(){return!this.has("Impassable")||this.get("Impassable").canFlyOver}isSpellPassable(){return!this.has("Impassable")||this.get("Impassable").spellPasses}lightPasses(){return!this.has("Opaque")}setMsg(e){this.msg=e}getMsg(e){return this.msg[e]}hasMsg(e){return this.msg.hasOwnProperty(e)}onSystemAdd(e){}onSystemRemove(e){}toJSON(){const e=h.compsToJSON(this),t={id:this.getID(),name:this.getName(),type:this.getType(),msg:this.msg};return e&&(t.components=e),t}}t.ElementBase=f,t.Element.Base=f;class m extends f{constructor(e){super(e),this.add(new u.Opaque);const t=new u.Impassable;t.setAllImpassable(),this.add(t);const n=new u.Breakable;n.setHardness(4),n.setDurability(100),this.add(n)}}t.ElementWall=m,t.Element.Wall=m;class g extends f{constructor(e,t){super(e,t),this.add(new u.Location)}getCell(){return this.get("Location").getCell()}isLocated(){return this.get("Location").isLocated()}unsetLevel(){this.get("Location").unsetLevel()}setLevel(e){return this.get("Location").setLevel(e)}getLevel(){return this.get("Location").getLevel()}getX(){return this.get("Location").getX()}getY(){return this.get("Location").getY()}getXY(){return this.get("Location").getXY()}setXY(e,t){this.get("Location").setXY(e,t)}isAtXY(e,t){return this.get("Location").isAtXY(e,t)}getZ(){return this.getCell().getZ()}getXYZ(){const[e,t]=this.getXY();return[e,t,this.getCell().getBaseElem().getZ()]}}t.ElementXY=g,t.Element.XY=g;class y extends g{constructor(e,t,n){super({name:e,type:"connection"}),this._srcLevel=t,this._targetLevel=n,this._targetStairs=null,this.isOneway=!1}isConnected(){return!i.default.isNullOrUndef([this._srcLevel,this._targetLevel,this._targetLevel])}setSrcLevel(e){i.default.isNullOrUndef([e])?i.default.err("Element.Stairs","setSrcLevel","Cannot set null/undefined level"):this._srcLevel=e}setTargetOnewayXY(e,t){if(this._targetStairs){const e=JSON.stringify(this._targetStairs);i.default.err("ElementStairs","setTargetXY","targetStairs already set to "+e)}else this._targetStairs={x:e,y:t},this.isOneway=!0}getSrcLevel(){return this._srcLevel}setTargetLevel(e){i.default.isNullOrUndef([e])?i.default.err("Element.Stairs","setTargetLevel","Cannot set null/undefined level."):this._targetLevel=e}getTargetLevel(){return this._targetLevel}setTargetStairs(e){if(i.default.isNullOrUndef([e]))i.default.err("Element.Stairs","setTargetStairs","Cannot set null/undefined stairs.");else{this._targetStairs=e;const t=e.getSrcLevel();i.default.isNullOrUndef([t])||this.setTargetLevel(t)}}getTargetStairs(){return this._targetStairs}getConnID(){const e=this.getX(),t=this.getY();this._srcLevel||i.default.err("Stairs","getID","_srcLevel is not defined");return`${this._srcLevel.getID()},${e},${t}`}connect(e,t=0){const n=this.getSrcLevel();if(n||i.default.err("Stairs","connect","Cannot connect. srcLevel is not defined!"),Array.isArray(e)){e.forEach(e=>{e.setTargetStairs(this),e.setTargetLevel(n)}),this.setTargetStairs(e[t]);const s=e[t].getSrcLevel();s?this.setTargetLevel(s):i.default.err("Stairs","connect","Tried to set undefined target level")}else{this.setTargetStairs(e),e.setTargetStairs(this);const t=e.getSrcLevel();t?this.setTargetLevel(t):i.default.err("Stairs","connect","Tried to set undefined target level"),e.setTargetLevel(n)}}isDown(){return/stairsDown/.test(this.getName())}useStairs(e){if(!i.default.isNullOrUndef([this._targetStairs,this._targetLevel]))if(this._targetStairs instanceof y){const t=this._targetStairs.getX(),n=this._targetStairs.getY(),s=this._srcLevel;if(s&&s.removeActor(e)){if(this._targetLevel.addActor(e,t,n))return!0}else i.default.err("Stairs","useStairs","Tried to use stairs without srcLevel")}else if(this.isOneway&&this._targetStairs){const t=this._targetStairs.x,n=this._targetStairs.y,s=this._srcLevel;if(s&&s.removeActor(e)){if(this._targetLevel.addActor(e,t,n))return!0}else i.default.err("Stairs","useStairs","Tried to use oneway stairs without srcLevel")}else i.default.err("ElementStairs","useStairs","Tried to use stairs without proper targetStairs");return!1}setConnObj(e){this._targetStairs=e.targetStairs,this._targetLevel=e.targetLevel}getConnObj(){const e=this.getTargetStairs();if(e instanceof y){const t=this.getTargetLevel();return{targetStairs:{x:e.getX(),y:e.getY()},targetLevel:t.getID()}}return e?{targetStairs:{x:e.x,y:e.y},targetLevel:this.getTargetLevel()}:(i.default.err("ElementStairs","getConnObj","targetStairs is null. Cannot create the connObj!"),null)}toJSON(){const e=super.toJSON();this.isOneway&&(e.isOneway=!0),this._srcLevel&&(e.srcLevel=this.getSrcLevel().getID()),Number.isInteger(this._targetLevel)?e.targetLevel=this._targetLevel:this._targetLevel&&(e.targetLevel=this.getTargetLevel().getID());const t=this.getTargetStairs();return t&&(e.targetStairs=t instanceof y?{x:t.getX(),y:t.getY()}:t),e}}t.ElementStairs=y,t.Element.Stairs=y;class v extends g{constructor(e){super("door"),this._closed=void 0===e||e,this._opaque=new u.Opaque;const t=new u.Impassable;t.setAllImpassable(),this._impassable=t,this._closed&&this.closeDoor();const n=new u.Breakable;n.setHardness(1),n.setDurability(25),this.add(n)}canToggle(){return!0}isOpen(){return!this._closed}isClosed(){return this._closed}openDoor(){this._closed=!1,this.remove("Opaque"),this.remove("Impassable")}closeDoor(){this._closed=!0,this.add(this._opaque),this.add(this._impassable)}toJSON(){const e=super.toJSON();return e.closed=this._closed,e}}t.ElementDoor=v,t.Element.Door=v;class b extends v{constructor(e=!0){super(e),this.setType("leverdoor");const t=new u.Breakable;t.setHardness(16),t.setDurability(150),this.add(t)}canToggle(){return!1}onUse(){this.isOpen()?this.closeDoor():this.openDoor()}toJSON(){const e=super.toJSON();return e.type="leverdoor",e}}t.ElementLeverDoor=b,t.Element.LeverDoor=b;class _ extends g{constructor(){super("lever"),this._targets=[]}getTargets(){return this._targets}addTarget(e){this._targets.push(e)}onUse(e){this._targets.forEach(t=>{t.onUse&&t.onUse(e)})}toJSON(){const e=super.toJSON();return e.id=this.getID(),e.type="lever",e.addTarget=this._targets.map(e=>i.default.getObjRef("entity",e)),e}}t.ElementLever=_,t.Element.Lever=_;class E extends g{constructor(){super("shop"),this._shopkeeper=null,this._costFactorShopSells=1,this._costFactorShopBuys=.5,this._isAbandoned=!0}isAbandoned(){return this._isAbandoned}reclaim(e){this._shopkeeper=e,this._isAbandoned=!1}getItemPriceForBuying(e){if(e.has("Unpaid")){const t=e.getValue(),n=i.default.valueToGoldWeight(t);let s=i.default.getGoldInCoins(n);return s*=e.getCount(),s=Math.ceil(this._costFactorShopSells*s),0===s?1:s}return i.default.err("Element.Shop","getItemPriceForBuying","Item "+e.getName()+" is not Unpaid item"),0}getItemPriceForSelling(e,t){const n=e.getValue(),s=i.default.valueToGoldWeight(n);let r=i.default.getGoldInCoins(s);return r*=t||e.getCount(),r=Math.floor(this._costFactorShopBuys*r),r}abandonShop(){this._shopkeeper=null,this._isAbandoned=!0}setShopkeeper(e){i.default.isNullOrUndef([e])?i.default.err("Element.Shop","setShopkeeper","Shopkeeper must be non-null and defined."):(this._shopkeeper=e,this._isAbandoned=!1)}getShopkeeper(){return this._shopkeeper}setCostFactor(e,t){i.default.isNullOrUndef([e,t])?i.default.err("Element.Shop","setCostFactor","Args buy/sell must be non-null and defined!"):(this._costFactorShopSells=t,this._costFactorShopBuys=e)}getCostFactorSell(){return this._costFactorShopSells}getCostFactorBuy(){return this._costFactorShopBuys}toJSON(){let e=null;this._shopkeeper&&(e=this._shopkeeper.getID());const t={type:"shop",isAbandoned:this._isAbandoned,costFactorSell:this._costFactorShopSells,costFactorBuy:this._costFactorShopBuys};return null!==e&&(t.shopkeeper=e),t}}t.ElementShop=E,t.Element.Shop=E;class S extends g{constructor(){super("exploration"),this.exp=0}setData(e){this.data=e}addData(e,t){this.data[e]=t}getData(){return this.data}hasData(){return!!this.data}setExp(e){Number.isInteger(e)?this.exp=e:i.default.err("ElementExploration","setExp","exp is not an integer: "+e)}getExp(){return this.exp}toJSON(){const e={type:this.getType(),setExp:this.getExp()};return this.hasData()&&(e.data=this.data),e}}t.ElementExploration=S,t.Element.Exploration=S;class w extends g{constructor(e){super(e)}onSystemAdd(e){e.getSentientActors().forEach(e=>{e.add(new u.Entrapped)})}onSystemRemove(e){e.getSentientActors().forEach(e=>{e.remove("Entrapped")})}}t.ElementTrap=w;class C extends g{constructor(){super("web");const e=new u.Entrapping;e.setDestroyOnMove(!0),e.setDifficulty(20),this.add(e);const t=new u.Breakable;t.setHardness(1),t.setDurability(20),this.add(t)}setDifficulty(e){this.get("Entrapping").setDifficulty(e)}}t.ElementWeb=C,t.Element.Web=C;class O extends w{constructor(){super("slime");const e=new u.Entrapping;e.setDestroyOnMove(!0),e.setDifficulty(30),this.add(e);const t=new u.Breakable;t.setHardness(1),t.setDurability(20),this.add(t)}setDifficulty(e){this.get("Entrapping").setDifficulty(e)}}t.ElementSlime=O,t.Element.Slime=O;class T extends w{constructor(){super("hole");const e=new u.Entrapping;e.setDestroyOnMove(!1),e.setDifficulty(50),this.add(e)}setDifficulty(e){this.get("Entrapping").setDifficulty(e)}}t.ElementHole=T,t.Element.Hole=T;class M extends g{constructor(){super("placeholder")}}t.ElementPlaceholder=M,t.Element.PlaceHolder=M;class A extends g{constructor(){super("tilled soil"),this.add(new u.TilledSoil)}}t.ElementTilledSoil=A,t.Element.TilledSoil=A;class N extends g{constructor(){super("planted soil"),this.add(new u.PlantedSoil)}}t.ElementPlantedSoil=N,t.Element.PlantedSoil=N;class x extends g{constructor(e){super("marker"),this.char=e,this.char=e,this.tag="",this.className=!1}getClassName(){return this.className}setClassName(e){this.className=e}getChar(){return this.char}setChar(e){this.char=e}setTag(e){this.tag=e}getTag(){return this.tag}toJSON(){const e=super.toJSON();return e.char=this.char,e.tag=this.tag,e}}t.ElementMarker=x,t.Element.Marker=x,t.create=function(e,...n){return t.Element.hasOwnProperty(e)?new t.Element[e](...n):null},t.Element.create=t.create},function(e,t){e.exports=ReactDOM},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.snowMeltMap=t.snowElemMap=t.getElem=t.ELEM_MAP=t.ELEMS=t.ELEM=void 0;const s=n(12),r=n(16);t.ELEM={},t.ELEMS={};const a=Object.freeze,o=s.ObjectShell.getParser();t.ELEM.BED=a(o.createElement("bed")),t.ELEM.BRIDGE=a(o.createElement("bridge")),t.ELEM.SHALLOW_CHASM=a(o.createElement("shallow chasm")),t.ELEM.CHASM=a(o.createElement("chasm")),t.ELEM.DEEP_CHASM=a(o.createElement("deep chasm")),t.ELEMS.CHASMS=[t.ELEM.SHALLOW_CHASM,t.ELEM.CHASM,t.ELEM.DEEP_CHASM],t.ELEM.GRASS=a(o.createElement("grass")),t.ELEM.GRASS_SNOW=a(o.createElement("snowy grass")),t.ELEM.HIGH_ROCK=a(o.createElement("highrock")),t.ELEM.LAVA=a(o.createElement("lava")),t.ELEM.PATH=a(o.createElement("path")),t.ELEM.ROAD=a(o.createElement("road")),t.ELEM.SKY=a(o.createElement("sky")),t.ELEM.SNOW=a(o.createElement("snow")),t.ELEM.SNOW_TRACKS=a(o.createElement("snow with tracks")),t.ELEM.SNOW_DEEP=a(o.createElement("deep snow")),t.ELEM.SNOW_DEEP_TRACKS=a(o.createElement("deep snow with tracks")),t.ELEM.SNOW_LIGHT=a(o.createElement("light snow")),t.ELEM.SNOW_LIGHT_TRACKS=a(o.createElement("light snow with tracks")),t.ELEM.SWAMP=a(o.createElement("swamp")),t.ELEM.FROZEN_SWAMP=a(o.createElement("frozen swamp")),t.ELEM.CLIFF=a(o.createElement("cliff")),t.ELEM.STONE=a(o.createElement("stone")),t.ELEM.STEEP_CLIFF=a(o.createElement("steep cliff")),t.ELEM.SNOWY_CLIFF=a(o.createElement("snowy cliff")),t.ELEM.STONE_SNOW=a(o.createElement("snow-covered stone")),t.ELEM.FROZEN_STEEP_CLIFF=a(o.createElement("frozen steep cliff")),t.ELEM.TREE=a(o.createElement("tree")),t.ELEM.TREE_LARGE=a(o.createElement("large tree")),t.ELEM.TREE_SNOW=a(o.createElement("snow-covered tree")),t.ELEM.TREE_LARGE_SNOW=a(o.createElement("large frozen tree")),t.ELEM.WINDOW=a(o.createElement("closed window")),t.ELEM.FLOOR=a(o.createElement("floor")),t.ELEM.FLOOR_CASTLE=a(o.createElement("floorcastle")),t.ELEM.FLOOR_CAVE=a(o.createElement("floorcave")),t.ELEM.FLOOR_CRYPT=a(o.createElement("floorcrypt")),t.ELEM.FLOOR_HOUSE=a(o.createElement("floorhouse")),t.ELEM.FLOOR_WOODEN=a(o.createElement("floorwooden")),t.ELEM.WALL=a(new r.ElementWall("wall")),t.ELEM.WALL_DUNGEON=a(o.createElement("walldungeon")),t.ELEM.WALL_CASTLE=a(o.createElement("wallcastle")),t.ELEM.WALL_CAVE=a(o.createElement("wallcave")),t.ELEM.WALL_CRYPT=a(o.createElement("wallcrypt")),t.ELEM.WALL_ICE=a(o.createElement("wallice")),t.ELEM.WALL_WOODEN=a(o.createElement("wallwooden")),t.ELEM.WALL_MOUNT=a(new r.ElementWall("wallmount")),t.ELEM.WALL_RUBY=a(o.createElement("wallruby")),t.ELEM.WALL_VOID=a(o.createElement("wallvoid")),t.ELEM.WALL_FORIUM=a(o.createElement("wallforium")),t.ELEM.SHALLOW_WATER=a(o.createElement("shallow water")),t.ELEM.WATER=a(o.createElement("water")),t.ELEM.DEEP_WATER=a(o.createElement("deep water")),t.ELEMS.WATER=[t.ELEM.SHALLOW_WATER,t.ELEM.WATER,t.ELEM.DEEP_WATER],t.ELEM.SHALLOW_FROZEN_WATER=a(o.createElement("frozen shallow water")),t.ELEM.WATER_FROZEN=a(o.createElement("frozen water")),t.ELEM.DEEP_FROZEN_WATER=a(o.createElement("frozen deep water")),t.ELEM.FORT=a(o.createElement("fort")),t.ELEM_MAP={},t.ELEM_MAP.elemTypeToObj={},t.ELEM_MAP.elemTypeToIndex={},t.ELEM_MAP.elemIndexToType={},t.ELEM_MAP.elemIndexToElemObj={};let i=1;Object.keys(t.ELEM).forEach(e=>{const n=t.ELEM[e].getType();t.ELEM_MAP.elemTypeToObj[n]=t.ELEM[e],t.ELEM_MAP.elemTypeToIndex[n]=i,t.ELEM_MAP.elemIndexToType[i]=n,t.ELEM_MAP.elemIndexToElemObj[i]=t.ELEM[e],++i}),t.getElem=function(e){return"string"==typeof e?t.ELEM_MAP.elemTypeToObj[e]:e},t.snowElemMap={floor:t.ELEM.SNOW_LIGHT,"light snow":t.ELEM.SNOW,"light snow with tracks":t.ELEM.SNOW,snow:t.ELEM.SNOW_DEEP,"snow with tracks":t.ELEM.SNOW,tree:t.ELEM.TREE_SNOW,"snow-covered tree":t.ELEM.TREE_SNOW,"shallow water":t.ELEM.SHALLOW_FROZEN_WATER,water:t.ELEM.WATER_FROZEN,"deep water":t.ELEM.DEEP_FROZEN_WATER,grass:t.ELEM.GRASS_SNOW,"snowy grass":t.ELEM.GRASS_SNOW,"deep snow with tracks":t.ELEM.SNOW_DEEP,cliff:t.ELEM.SNOWY_CLIFF,stone:t.ELEM.STONE_SNOW,"steep cliff":t.ELEM.FROZEN_STEEP_CLIFF,swamp:t.ELEM.FROZEN_SWAMP},t.snowMeltMap={"light snow":t.ELEM.FLOOR,"light snow with tracks":t.ELEM.FLOOR,snow:t.ELEM.SNOW_LIGHT,"snow with tracks":t.ELEM.SNOW_LIGHT,"snow-covered tree":t.ELEM.TREE,"frozen shallow water":t.ELEM.SHALLOW_WATER,"frozen water":t.ELEM.WATER,"frozen deep water":t.ELEM.DEEP_WATER,"snowy grass":t.ELEM.GRASS,"deep snow":t.ELEM.SNOW,"deep snow with tracks":t.ELEM.SNOW,"snowy cliff":t.ELEM.CLIFF,"snow-covered stone":t.ELEM.STONE,"frozen steep cliff":t.ELEM.STEEP_CLIFF,"frozen swamp":t.ELEM.SWAMP}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Path=t.PathAlgoXY=void 0;const r=s(n(265)),a=s(n(4)),o=n(457),i=Object.freeze([]),l=(e,t,n,s)=>!0;class c{constructor(e,t,n){this.tx=e,this.ty=t,this.passCb=n}compute(e,t,n){const s=[];let r=e,o=t;for(;r!==this.tx||o!==this.ty;){const e=this.tx-r,t=this.ty-o,n=e/Math.abs(e),i=t/Math.abs(t);if(r===this.tx){if(o===this.ty)break;1!==Math.abs(t)&&(r+=this.passCb(r+1,o,r,o)&&a.default.isSuccess(.33)?1:this.passCb(r-1,o,r,o)&&a.default.isSuccess(.33)?-1:0),o+=i}else if(o===this.ty){if(r===this.tx)break;r+=n,1!==Math.abs(e)&&(o+=this.passCb(r,o+1,r,o)&&a.default.isSuccess(.33)?1:this.passCb(r,o-1,r,o)&&a.default.isSuccess(.33)?-1:0)}else r+=n,o+=i;if(!this.passCb(r,o,r-n,o-i))break;s.push([r,o])}s.forEach(e=>{n(e[0],e[1])})}}t.PathAlgoXY=c;class u{}function h(e,t,n,s){for(let r=e-1;r<=e+1;r++)for(let a=t-1;a<=t+1;a++)if(n.hasXY(r,a)&&s(r,a,e,t))return!1;return!0}function d(e){e.length>1&&(e.shift(),e.pop())}t.Path=u,u.getPossiblePath=function(e,t,n,s,r=l){const a=[];return new c(n,s,r).compute(e,t,(e,t)=>{a.push({x:e,y:t})}),a},u.getShortestPath=function(e,t,n,s,a=l){const o=[],i=a;return new r.default(n,s,i).compute(e,t,(e,t)=>{o.push({x:e,y:t})}),o},u.getShortestSeenPath=function(e,t,n,s){const r=e.getBrain().getSeenCells(),a={};r.forEach(e=>{a[e.getKeyXY()]=e});const l=(e,r,o,i)=>!!a.hasOwnProperty(e+","+r)&&(t.isPassable(e,r,o,i)||e===c&&r===u||e===n&&r===s),[c,u]=e.getXY();if(h(c,u,t,l))return i;const p=[];return new o.AStar3D(n,s,t,l).compute(c,u,(e,t)=>{p.push({x:e,y:t})}),d(p),p},u.getShortestPassablePath=function(e,t,n,s,r){const a=[];return new o.AStar3D(s,r,e,(t,n,s,r)=>e.isPassable(t,n,s,r)).compute(t,n,(e,t)=>{a.push({x:e,y:t})}),a},u.getShortestPassablePathWithDoors=function(e,t,n,s,r){const a=[];return new o.AStar3D(s,r,e,(t,n,s,r)=>!e.getCell(t,n).hasBaseElemWithComp("Impassable")||e.getCell(t,n).hasDoor()).compute(t,n,(e,t)=>{a.push({x:e,y:t})}),a},u.getActorToActorPath=function(e,t,n,s,r){const a=[],l=(a,o,i,l)=>!!e.hasXY(a,o)&&(e.isPassable(a,o,i,l)||a===t&&o===n&&e.getElemDzAbs(a,o,i,l)<=1||a===s&&o===r&&e.getElemDzAbs(a,o,i,l)<=1);if(h(t,n,e,l))return i;return new o.AStar3D(s,r,e,l).compute(t,n,(e,t)=>{a.push({x:e,y:t})}),d(a),a},u.getShortestActorPath=function(e,t,n,s,r,a){const l=[],c=(s,r,o,i)=>{if(e.hasXY(s,r)){if(a)return a(s,r,o,i)||s===t&&r===n&&e.getElemDzAbs(s,r,o,i)<=1;let l=e.isPassable(s,r,o,i);if(!l){const a=e.getElemDzAbs(s,r,o,i);l=s===t&&r===n&&a<=1}return l}return!1};if(h(t,n,e,c))return i;const u=new o.AStar3D(s,r,e,c);return u.setLimit(4e3),u.compute(t,n,(e,t)=>{l.push({x:e,y:t})}),function(e){e.length>0&&e.shift()}(l),l},u.getShortestPassablePathWithDoors=function(e,t,n,s,r){const a=[];return new o.AStar3D(s,r,e,(t,n,s,r)=>!!e.hasXY(t,n)&&(e.isPassable(t,n,s,r)||e.getCell(t,n).hasDoor())).compute(t,n,(e,t)=>{a.push({x:e,y:t})}),a},u.shortestDist=function(e,t,n,s){return u.getShortestPath(e,t,n,s).length-1},u.getPathWeight=(e,t)=>{let n=0;return t.forEach(t=>{if(e.hasXY(t.x,t.y)){switch(e.getBaseElemXY(t.x,t.y).getType()){case"floor":n+=1;break;case"forest":case"stone":n+=2;break;case"water":case"highrock":n+=4;break;case"chasm":n+=5;break;case"wall":n+=20;break;default:n+=0}}}),n},u.getMinWeightPath=function(e,t,n,s,r,a){let o=[];o=a?a(e,t,n,s,r):u.getShortestPassablePath(e,t,n,s,r);const i=u.getShortestPath(t,n,s,r),l=u.getPathWeight(e,o),c=u.getPathWeight(e,i);let h=null;return h=0===o.length||l>=c?i:o,h},u.getMinWeightOrShortest=function(e,t,n,s,r,a){const o=u.getShortestPath(t,n,s,r),i=[];a.forEach(e=>{const a=u.getShortestPath(t,n,s,r,e);a.length>0&&i.push(a)}),i.push(o);let l=[],c=-1;return i.forEach(t=>{const n=u.getPathWeight(e,t);(-1===c||n<c)&&(c=n,l=t)}),l},u.getWeightPathSegmented=function(e,t,n,s,r,a,o){const i=s-t,l=r-n,c=u.getPathSeg(i,a),h=u.getPathSeg(l,a);let d=[],[p,f]=[t,n];for(let t=0;t<a;t++){const[n,s]=[p+c[t],f+h[t]],r=u.getMinWeightPath(e,p,f,n,s,o);[p,f]=[n,s],d=d.concat(r)}return d},u.getPathSeg=function(e,t){let n=e;const s=[],r=Math.floor(e/t);for(let e=0;e<t-1;e++)s.push(r),n-=r;return s.push(n),s},u.getPathFromEdgeToCell=function(e,t){const n=e.getFreeEdgeCells()[0],s=e.getCellWithElem(t);if(!s||!n)return[];const r=e.getMap(),[a,o]=n.getXY(),[i,l]=s.getXY();return u.getShortestPath(a,o,i,l,(e,t)=>r.hasXY(e,t)&&!/wall/.test(r.getCell(e,t).getBaseElem().getType()))}},function(e,t){var n=Array.isArray;e.exports=n},function(e,t,n){"use strict";
/*
object-assign
(c) Sindre Sorhus
@license MIT
*/var s=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable;function o(e){if(null==e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}e.exports=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},n=0;n<10;n++)t["_"+String.fromCharCode(n)]=n;if("0123456789"!==Object.getOwnPropertyNames(t).map((function(e){return t[e]})).join(""))return!1;var s={};return"abcdefghijklmnopqrst".split("").forEach((function(e){s[e]=e})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},s)).join("")}catch(e){return!1}}()?Object.assign:function(e,t){for(var n,i,l=o(e),c=1;c<arguments.length;c++){for(var u in n=Object(arguments[c]))r.call(n,u)&&(l[u]=n[u]);if(s){i=s(n);for(var h=0;h<i.length;h++)a.call(n,i[h])&&(l[i[h]]=n[i[h]])}}return l}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RNG=void 0;const s=2.3283064365386963e-10;class r{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(e){return e=e<1?1/e:e,this._seed=e,this._s0=(e>>>0)*s,e=69069*e+1>>>0,this._s1=e*s,e=69069*e+1>>>0,this._s2=e*s,this._c=1,this}getUniform(){const e=2091639*this._s0+this._c*s;return this._s0=this._s1,this._s1=this._s2,this._c=0|e,this._s2=e-this._c,this._s2}getUniformInt(e,t){const n=Math.max(e,t),s=Math.min(e,t);return Math.floor(this.getUniform()*(n-s+1))+s}getNormal(e=0,t=1){let n,s,r;do{n=2*this.getUniform()-1,s=2*this.getUniform()-1,r=n*n+s*s}while(r>1||0===r);return e+n*Math.sqrt(-2*Math.log(r)/r)*t}getPercentage(){return 1+Math.floor(100*this.getUniform())}getItem(e){return e.length?e[Math.floor(this.getUniform()*e.length)]:null}shuffle(e){const t=[],n=e.slice();for(;n.length;){const e=n.indexOf(this.getItem(n));t.push(n.splice(e,1)[0])}return t}getWeightedValue(e){let t=0;for(const n in e)t+=e[n];const n=this.getUniform()*t;let s="",r=0;for(s in e)if(r+=e[s],n<r)return s;return s}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(e){return this._s0=e[0],this._s1=e[1],this._s2=e[2],this._c=e[3],this}clone(){return(new r).setState(this.getState())}}t.RNG=r,t.default=(new r).setSeed(0)},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.EventPool=void 0;const r=s(n(4));class a{constructor(){this.reset(),this.cannotRemove=!1}static getPool(){return a.poolInstance||(a.poolInstance=new a),a.poolInstance}getNumListeners(){return this._nListeners}getNumEventsListened(){return Object.keys(this._listeners).length}emitEvent(e,t){if(r.default.isNullOrUndef([e]))r.default.nullOrUndefError("EventPool: emitEvent","Event name must be given.",e);else if(++this.notifyStackSize,this._listeners.hasOwnProperty(e)){this.cannotRemove=!0;const n=this._listeners[e];for(let s=0,r=n.length;s<r;s++)n[s].notify(e,t)}1===this.notifyStackSize&&(this.cannotRemove=!1,this.pendingRemoves.length>0&&(this.pendingRemoves.forEach(e=>{this.removeListener(e)}),this.pendingRemoves=[])),--this.notifyStackSize}listenEvent(e,t){if(r.default.isNullOrUndef([e]))r.default.err("EventPool","listenEvent","Event name not well defined.");else if(t.hasOwnProperty("notify")||t.hasNotify){if(this._listeners.hasOwnProperty(e)){-1===this._listeners[e].indexOf(t)&&this._listeners[e].push(t)}else this._listeners[e]=[],this._listeners[e].push(t);++this._nListeners,t.hasOwnProperty("listenerID")||(t.listenerID=this._listenerID++)}else{let n="evtName: "+e;n+="\nprototype: "+JSON.stringify(t),n+="\nCannot add object. Listener must implement notify()!",r.default.err("EventPool","listenEvent",n)}}isListener(e){let t=!1;return this.forEachEvent(e,e=>{t=!0}),t}forEachEvent(e,t){const n=e.listenerID;Object.keys(this._listeners).forEach(s=>{this._listeners[s].findIndex(e=>e.listenerID===n)>=0&&t(e,s)})}removeListener(e){if(e.hasOwnProperty("listenerID")){if(this.cannotRemove)return void this.pendingRemoves.push(e);let t=0;const n=e.listenerID;Object.keys(this._listeners).forEach(e=>{const s=this._listeners[e].findIndex(e=>e.listenerID===n);s>=0&&(this._listeners[e].splice(s,1),++t,--this._nListeners,0===this._listeners[e].length&&delete this._listeners[e])}),0===t&&r.default.warn("EventPool","removeListener",`ListenerID ${e.listenerID} not found`),delete e.listenerID}else{const t=JSON.stringify(e);r.default.err("EventPool","removeListener","No prop listener ID from on object "+t)}}removeAll(){if(this.cannotRemove)r.default.err("EventPool","removeAll","Cannot remove listeners. cannotRemove is set");else{const e={};Object.keys(this._listeners).forEach(t=>{this._listeners[t].forEach(t=>{e[t.listenerID]=t})}),Object.values(e).forEach(e=>{this.removeListener(e)})}}reset(){this._listeners={},this._nListeners=0,this._listenerID=0,this._lastEmitted=null,this._lastRemoved=null,this.pendingRemoves=[],this.notifyStackSize=0}getListeners(e){return this._listeners.hasOwnProperty(e)?this._listeners[e].slice():[]}printListeners(){Object.keys(this._listeners).forEach(e=>{r.default.diag("Listeners for event "+String(e)),r.default.diag(this._listeners[e])})}}t.EventPool=a},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Level=t.LevelCallback=void 0;const i=o(n(4)),l=n(55),c=n(29),u=n(34),h=n(9),d=n(23),p=n(47),f=n(18),m=a(n(29)),g=n(16),y=n(30),v=d.EventPool.getPool(),{TYPE_ACTOR:b,TYPE_ELEM:_,TYPE_ITEM:E}=i.default,S=h.Random.getRNG();t.LevelCallback=class{constructor(e){this.cbType=e}execute(){i.default.gameMsg(this.msg)}getCbType(){return this.cbType}toJSON(){return{cbType:this.getCbType(),msg:this.msg}}};class w extends l.Entity{constructor(e){super(),this._map=e,this._parent=null,this._p={actors:[],elements:[],items:[]},this._levelNo=0,this._callbacks={},this._cbState={onFirstEnterDone:!1,onFirstExitDone:!1},this.add(new m.Lore),this.add(new m.Place),this.actorWarnLimit=5e3}static createLevelID(){return l.Entity.createEntityID()}setLevelNumber(e){this._levelNo=e}getLevelNumber(){return this._levelNo}getSizeXY(){return[this._map.cols,this._map.rows]}getParent(){return this._parent}getParentZone(){const e=this.getParent();if(e){if(e.getParent)return e.getParent();i.default.err("Level","getParentZone","No getParent() in "+JSON.stringify(e))}return null}setParent(e){i.default.isNullOrUndef([e])?i.default.err("Map.Level","setParent","Parent is not defined."):this._parent=e}getActors(){return this._p.actors}getItems(){return this._p.items}getElements(){return this._p.elements}getStairs(){const e=[];return this._p.elements.forEach(t=>{this._isStairs(t)&&e.push(t)}),e}getPassages(){const e=[];return this._p.elements.forEach(t=>{if("passage"===t.getName()){const n=t;e.push(n)}}),e}getConnections(){const e=[];return this._p.elements.forEach(t=>{if("connection"===t.getType()){const n=t;e.push(n)}}),e}_isStairs(e){return/stairs(Down|Up)/.test(e.getName())}setMap(e,t){this._map=e,t&&(t.elements&&(this._p.elements=t.elements),this._p.elements.forEach(e=>{e.setLevel(this)}))}getMap(){return this._map}getStairsToLevel(e){i.default.isNullOrUndef([e])&&i.default.err("Map.Level","getStairs","arg |level| required.");const t=this.getStairs();for(let n=0;n<t.length;n++)if(t[n].getTargetLevel()===e)return t[n];return null}addStairs(e,t,n){if(i.default.isNullOrUndef([t,n]))i.default.err("Map.Level","addStairs","Cannot add stairs. x, y missing.");else{if(this._map.hasXY(t,n)){e.setSrcLevel(this);const s=this._map.getBaseElemXY(t,n);return(s.has("Impassable")||0===s.getZ())&&this._map.setBaseElemXY(t,n,f.ELEM.FLOOR),this._addPropToLevelXY(i.default.TYPE_ELEM,e,t,n)}{const e=`x,y ${t},${n} out of map bounds.`;i.default.err("Map.Level","addStairs",`${e}: cols ${this._map.cols}, rows: ${this._map.rows}`)}}return!1}useStairs(e){const t=this._map.getCell(e.getX(),e.getY());if(t.hasConnection()){if(t.getConnection().useStairs(e))return!0;i.default.err("Level","useStairs","Failed to use connection.")}return!1}addElement(e,t,n){if("connection"===e.getType()){const s=e;return this.addStairs(s,t,n)}if(!i.default.isNullOrUndef([t,n]))return this._addPropToLevelXY(i.default.TYPE_ELEM,e,t,n);const s=this._getFreeCell();if(!s)return this.debugPrintInASCII(),i.default.err("Level","addElement","Cannot add prop to null xy-coord"),!1;const[r,a]=s.getXY();return this._addPropToLevelXY(i.default.TYPE_ELEM,e,r,a)}removeElement(e,t,n){return this._removePropFromLevelXY(i.default.TYPE_ELEM,e,t,n)}addEntity(e,t,n){return i.default.isActor(e)?this.addActor(e,t,n):i.default.isItem(e)?this.addItem(e,t,n):i.default.isElement(e)?this.addElement(e,t,n):(i.default.err("Level","addEntity","No support for ents without getPropType"),!1)}removeEntity(e,t,n){return i.default.isActor(e)?this.removeActor(e):i.default.isItem(e)?this.removeItem(e,t,n):i.default.isElement(e)?this.removeElement(e,t,n):(i.default.err("Level","addEntity","No support for ents without getPropType"),!1)}addItem(e,t,n){if(0===e.getWeight()&&(console.log(e),i.default.err("Level","addItem","Item with zero-weight detected")),!i.default.isNullOrUndef([t,n]))return this._addPropToLevelXY(i.default.TYPE_ITEM,e,t,n);const s=this._getFreeCell();if(s){const[t,n]=s.getXY();return this._addPropToLevelXY(i.default.TYPE_ITEM,e,t,n)}return!1}removeItem(e,t,n){return this._removePropFromLevelXY(i.default.TYPE_ITEM,e,t,n)}pickupItem(e){const t=new c.Pickup;e.add(t)}moveActorTo(e,t,n){const s=e.getLevel(),[r,a]=[e.getX(),e.getY()],o=e.getPropType();return!!s._removePropFromLevelXY(o,e,r,a)&&this._addPropToLevelXY(o,e,t,n)}addActor(e,t,n){return i.default.debug(this,"addActor called with x,y "+t+", "+n),i.default.isNullOrUndef([t,n])?(i.default.nullOrUndefError("Level: addActor","arg |x|",t),i.default.nullOrUndefError("Level: addActor","arg |y|",n),!1):this._map&&this._map.hasXY(t,n)?(this._addPropToLevelXY(i.default.TYPE_ACTOR,e,t,n),i.default.debug(this,"Added actor to map x: "+t+" y: "+n),this._p.actors.length>this.actorWarnLimit&&i.default.warn("Level","addActor",`Over ${this.actorWarnLimit} actors. Last added: ${e.getName()}`),!0):(i.default.err("Level","addActor","No coordinates "+t+", "+n+" in the map."),!1)}addActorToFreeCell(e){i.default.debug(this,"Adding actor to free slot");const t=this._map.getFree();if(t.length>0){const n=t[0].getX(),s=t[0].getY();if(this._addPropToLevelXY(i.default.TYPE_ACTOR,e,n,s))return i.default.debug(this,"Added actor to free cell in "+n+", "+s),!0}else i.default.err("Level","addActor","No free cells for the actor.");return!1}_addPropToLevelXY(e,t,n,s){return this._p.hasOwnProperty(e)?(this._p[e].push(t),t.setXY(n,s),t.setLevel(this),this._map.setProp(n,s,e,t),v.emitEvent(i.default.EVT_LEVEL_PROP_ADDED,{level:this,obj:t,propType:e}),!0):(i.default.err("Map.Level","_addPropToLevelXY",`No prop ${e} supported. Obj: ${JSON.stringify(t)}`),!1)}addVirtualProp(e,t){if(this._p.hasOwnProperty(e)){if(i.default.isActor(t))return this._p[e].push(t),t.setLevel(this),v.emitEvent(i.default.EVT_LEVEL_PROP_ADDED,{level:this,obj:t,propType:e}),!0;i.default.err("Level","addVirtualProp","Only virtual actors are supported. Got "+e)}else i.default.err("Map.Level","addVirtualProp",`No prop ${e} supported. Obj: ${JSON.stringify(t)}`);return!1}_removePropFromLevelXY(e,t,n,s){if(this._p.hasOwnProperty(e)){const r=this._p[e].indexOf(t);return r>=0?(this._p[e].splice(r,1),i.default.isItem(t)||(t.setXY(null,null),t.unsetLevel()),v.emitEvent(i.default.EVT_LEVEL_PROP_REMOVED,{level:this,obj:t,propType:e}),this._map.removeProp(n,s,e,t)):(i.default.err("Map.Level","_removePropFromLevelXY",`Obj index not found in list this._p[${e}]`),!1)}return i.default.err("Map.Level","_removePropFromLevelXY",`No prop ${e} supported. Obj: ${JSON.stringify(t)}`),!1}removeVirtualProp(e,t){if(this._p.hasOwnProperty(e)){const n=this._p[e].indexOf(t);if(n>=0)return this._p[e].splice(n,1),v.emitEvent(i.default.EVT_LEVEL_PROP_REMOVED,{level:this,obj:t,propType:e}),!0}return!1}removeActor(e){const t=this._p.actors.indexOf(e),n=e.getX(),s=e.getY();return!!this._map.removeProp(n,s,i.default.TYPE_ACTOR,e)&&(this._p.actors.splice(t,1),!0)}exploreCells(e){const t=this._map.getCellsInFOV(e);for(let e=0;e<t.length;e++)t[e].setExplored();return t}getExploredCells(){return this._map.getExploredCells()}setExtras(e){this._extras=e}getExtras(){return this._extras||(this._extras={}),this._extras}hasExtras(){return!i.default.isNullOrUndef([this._extras])&&Object.keys(this._extras).length>0}addExtras(e,t){this._extras||(this._extras={}),this._extras[e]=t}getBbox(){return y.BBox.fromBBox({ulx:0,uly:0,lrx:this.getMap().cols-1,lry:this.getMap().rows-1})}getColsRows(){return[this.getMap().cols,this.getMap().rows]}setOnEnter(e){this._callbacks.OnEnter=e}setOnFirstEnter(e){this._callbacks.OnFirstEnter=e}setOnExit(e){this._callbacks.OnExit=e}setOnFirstExit(e){this._callbacks.OnFirstExit=e}onEnter(){this._callbacks.hasOwnProperty("OnEnter")&&this._callbacks.OnEnter(this)}onFirstEnter(){this._cbState.onFirstEnterDone||(this._callbacks.hasOwnProperty("OnFirstEnter")&&this._callbacks.OnFirstEnter(this),this._cbState.onFirstEnterDone=!0)}onExit(){this._callbacks.hasOwnProperty("OnExit")&&this._callbacks.OnExit(this)}onFirstExit(){this._cbState.onFirstExitDone||(this._callbacks.hasOwnProperty("OnFirstExit")&&this._callbacks.OnFirstExit(this),this._cbState.onFirstExitDone=!0)}getFreeRandCell(){const e=this.getMap().getFree();if(e.length>0){return e[S.randIndex(e)]}return null}getEmptyRandCell(){const e=this.getMap().getEmptyCells();if(e.length>0){return e[S.randIndex(e)]}return null}_getFreeCell(){const e=this._map.getFree();return e.length>0?e[0]:null}debugPrintInASCII(){this.getMap().debugPrintInASCII()}removeElements(e){this._p.elements.filter(e).forEach(e=>{const[t,n]=e.getXY();this.removeElement(e,t,n)})}getCell(e,t){return this._map.getCell(e,t)}getPlayer(){return this._p.actors.find(e=>e.isPlayer&&e.isPlayer())}getFreeEdgeCells(){const e=this.getMap();return this.getMap().getCells(t=>(0===t.getX()||0===t.getY()||t.getX()===e.cols-1||t.getY()===e.rows-1)&&!t.getBaseElem().has("Impassable"))}getCellWithElem(e){return this.getElements().filter(t=>t.getType()===e)[0]}updateLevelFromMap(){this.getMap().getCells().forEach(e=>{if(e.hasProps()){e.getProps().forEach(t=>{const n=t.getPropType();this._p[n].push(t),t.setXY&&(t.setXY(e.getX(),e.getY()),t.setLevel(this))})}})}toJSON(){const e={isJSON:!0,id:this.getID(),levelNumber:this.getLevelNumber(),actors:[],items:[],elements:[],map:this.getMap().toJSON(),cbState:this._cbState};this._parent&&(e.parent=this._parent.getName(),"string"!=typeof e.parent&&i.default.err("Map.Level","toJSON","Parent name not a string")),e.components=u.compsToJSON(this);return[b,E,_].forEach(t=>{this._p[t].forEach(n=>{const s={x:n.getX(),y:n.getY(),obj:n.toJSON()};t!==i.default.TYPE_ACTOR?e[t].push(s):s.obj.isPlayer||e[t].push(s)})}),e}verifyLevelCache(){p.verifyLevelCache(this)}static connectLevels(e,t,n,s){const r=e.getCellsOnEdge(n),a=t.getCellsOnEdge(s);r.length!==a.length&&i.default.err("Level","connectLevels","Cell arrays not same length");for(let n=0;n<r.length;n++){const s=new g.Element.Stairs("stairs",e,t),o=new g.Element.Stairs("stairs",t,e);e.addElement(s,r[n].getX(),r[n].getY()),t.addElement(o,a[n].getX(),a[n].getY())}}getCellsOnEdge(e){return this.getMap().getEdgeCells(e)}}t.Level=w},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Keys=void 0;const r=s(n(4)),a=n(42),o={KEYS:a.KEYS,DIRS:a.DIRS};class i{}t.Keys=i,i.KeyMap=new class{constructor(){this.moveKeyMap={}}initMap(){this.moveKeyMap[i.KEY.MOVE_N]=0,this.moveKeyMap[i.KEY.MOVE_NE]=1,this.moveKeyMap[i.KEY.MOVE_E]=2,this.moveKeyMap[i.KEY.MOVE_SE]=3,this.moveKeyMap[i.KEY.MOVE_S]=4,this.moveKeyMap[i.KEY.MOVE_SW]=5,this.moveKeyMap[i.KEY.MOVE_W]=6,this.moveKeyMap[i.KEY.MOVE_NW]=7,this.moveKeyMap[o.KEYS.VK_8]=0,this.moveKeyMap[o.KEYS.VK_9]=1,this.moveKeyMap[o.KEYS.VK_6]=2,this.moveKeyMap[o.KEYS.VK_3]=3,this.moveKeyMap[o.KEYS.VK_2]=4,this.moveKeyMap[o.KEYS.VK_1]=5,this.moveKeyMap[o.KEYS.VK_4]=6,this.moveKeyMap[o.KEYS.VK_7]=7}inMoveCodeMap(e){return this.moveKeyMap.hasOwnProperty(e)}isRest(e){return e===i.VK.s||e===i.VK.PERIOD}isPickup(e){return e===i.KEY.PICKUP}isUseStairs(e){return e===i.KEY.USE_STAIRS_DOWN||e===i.KEY.USE_STAIRS_UP}isChat(e){return e===i.KEY.CHAT}isConfirmYes(e){return e===i.KEY.YES}isConfirmNo(e){return e===i.KEY.NO}isFightMode(e){return e===i.KEY.FIGHT}isGive(e){return e===i.KEY.GIVE}isGoto(e){return e===i.KEY.GOTO}isJump(e){return e===i.KEY.JUMP}isIssueOrder(e){return e===i.KEY.ORDER}isLook(e){return e===i.KEY.LOOK}isMark(e){return e===i.KEY.MARK}isNextItem(e){return e===i.KEY.NEXT_ITEM}isNextTarget(e){return e===i.KEY.NEXT}isPrevTarget(e){return e===i.KEY.PREV}isRead(e){return e===i.KEY.READ}isRunMode(e){return e===i.KEY.RUN}isSelect(e){return e===i.KEY.SELECT}isSelectAll(e){return e===i.KEY.SELECT_ALL}isTargetMode(e){return e===i.KEY.TARGET}isToggleDoor(e){return e===i.KEY.DOOR}isUsePower(e){return e===i.KEY.POWER}isUseAbility(e){return e===i.KEY.ABILITY}isMultiPurpose(e){return e===i.KEY.MULTI}getDiff(e,t,n){if(this.moveKeyMap.hasOwnProperty(e)){const s=o.DIRS[8][this.moveKeyMap[e]];return[t+s[0],n+s[1]]}return e===i.VK.s?[t,n]:null}getDir(e){if(this.moveKeyMap.hasOwnProperty(e)){const t=this.moveKeyMap[e];return o.DIRS[8][t]}return this.isRest(e)?[0,0]:null}dirToKeyCode(e,t){let n=e,s=t;switch(Array.isArray(e)&&(n=e[0],s=e[1]),0!==n&&(n/=Math.abs(n)),0!==s&&(s/=Math.abs(s)),n){case-1:switch(s){case-1:return i.KEY.MOVE_NW;case 0:return i.KEY.MOVE_W;case 1:return i.KEY.MOVE_SW;default:r.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${n},${s} not supported`)}break;case 0:switch(s){case-1:return i.KEY.MOVE_N;case 0:return i.KEY.REST;case 1:return i.KEY.MOVE_S;default:r.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${n},${s} not supported`)}break;case 1:switch(s){case-1:return i.KEY.MOVE_NE;case 0:return i.KEY.MOVE_E;case 1:return i.KEY.MOVE_SE;default:r.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${n},${s} not supported`)}break;default:r.default.err("Keys.KeyMap","dirToKeyCode",`Dir ${n},${s} not supported`)}return null}keyCodeToCardinalDir(e){switch(e){case i.KEY.MOVE_NW:return"NW";case i.KEY.MOVE_W:return"W";case i.KEY.MOVE_SW:return"SW";case i.KEY.MOVE_N:return"N";case i.KEY.REST:return"REST";case i.KEY.MOVE_S:return"S";case i.KEY.MOVE_NE:return"NE";case i.KEY.MOVE_E:return"E";case i.KEY.MOVE_SE:return"SE";default:return""}}},i.VK={},i.INVALID_KEY=-1,i.VK.a=o.KEYS.VK_A+32,i.VK.b=o.KEYS.VK_B+32,i.VK.c=o.KEYS.VK_C+32,i.VK.d=o.KEYS.VK_D+32,i.VK.e=o.KEYS.VK_E+32,i.VK.f=o.KEYS.VK_F+32,i.VK.g=o.KEYS.VK_G+32,i.VK.h=o.KEYS.VK_H+32,i.VK.i=o.KEYS.VK_I+32,i.VK.j=o.KEYS.VK_J+32,i.VK.k=o.KEYS.VK_K+32,i.VK.l=o.KEYS.VK_L+32,i.VK.m=o.KEYS.VK_M+32,i.VK.n=o.KEYS.VK_N+32,i.VK.o=o.KEYS.VK_O+32,i.VK.p=o.KEYS.VK_P+32,i.VK.q=o.KEYS.VK_Q+32,i.VK.r=o.KEYS.VK_R+32,i.VK.s=o.KEYS.VK_S+32,i.VK.t=o.KEYS.VK_T+32,i.VK.u=o.KEYS.VK_U+32,i.VK.v=o.KEYS.VK_V+32,i.VK.w=o.KEYS.VK_W+32,i.VK.x=o.KEYS.VK_X+32,i.VK.y=o.KEYS.VK_Y+32,i.VK.z=o.KEYS.VK_Z+32,i.VK.A=o.KEYS.VK_A,i.VK.B=o.KEYS.VK_B,i.VK.C=o.KEYS.VK_C,i.VK.D=o.KEYS.VK_D,i.VK.E=o.KEYS.VK_E,i.VK.F=o.KEYS.VK_F,i.VK.G=o.KEYS.VK_G,i.VK.H=o.KEYS.VK_H,i.VK.I=o.KEYS.VK_I,i.VK.J=o.KEYS.VK_J,i.VK.K=o.KEYS.VK_K,i.VK.L=o.KEYS.VK_L,i.VK.M=o.KEYS.VK_M,i.VK.N=o.KEYS.VK_N,i.VK.O=o.KEYS.VK_O,i.VK.P=o.KEYS.VK_P,i.VK.Q=o.KEYS.VK_Q,i.VK.R=o.KEYS.VK_R,i.VK.S=o.KEYS.VK_S,i.VK.T=o.KEYS.VK_T,i.VK.U=o.KEYS.VK_U,i.VK.V=o.KEYS.VK_V,i.VK.W=o.KEYS.VK_W,i.VK.X=o.KEYS.VK_X,i.VK.Y=o.KEYS.VK_Y,i.VK.Z=o.KEYS.VK_Z,i.VK.COMMA=44,i.VK.PERIOD=46,i.VK.LT=60,i.VK.GT=62,i.menuIndices=[0,1,2,3,4,5,6,7,8,9,"a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],i.EXIT_INDEX=i.menuIndices.indexOf("Q"),i.codeToMenuChar=e=>{const t=i.codeToIndex(e);return i.menuIndices[t]};const l=/[a-z]/,c=/[A-Z]/;i.selectIndexToCode=e=>{const t=i.menuIndices.findIndex(t=>t===e);if(t>=0){if(t>=0&&t<=9)return o.KEYS.VK_0+t;if(l.test(e)){const e=t-i.menuIndices.indexOf("a");return i.VK.a+e}if(c.test(e)){const e=t-i.menuIndices.indexOf("A");return o.KEYS.VK_A+e}}return r.default.err("RG","selectIndexToCode",`Invalid select index |${e}|`),i.INVALID_KEY},i.codeToIndex=e=>e>=o.KEYS.VK_0&&e<=o.KEYS.VK_9?e-o.KEYS.VK_0:e>=i.VK.a&&e<=i.VK.z?e-i.VK.a+i.menuIndices.indexOf("a"):e>=o.KEYS.VK_A&&e<=o.KEYS.VK_Z?e-o.KEYS.VK_A+i.menuIndices.indexOf("A"):i.INVALID_KEY,i.isNumeric=e=>e>=o.KEYS.VK_0&&e<=o.KEYS.VK_9,i.KEY={},i.KEY.MOVE_N=o.KEYS.VK_W+32,i.KEY.MOVE_NE=o.KEYS.VK_E+32,i.KEY.MOVE_E=o.KEYS.VK_D+32,i.KEY.MOVE_SE=o.KEYS.VK_C+32,i.KEY.MOVE_S=o.KEYS.VK_X+32,i.KEY.MOVE_SW=o.KEYS.VK_Z+32,i.KEY.MOVE_W=o.KEYS.VK_A+32,i.KEY.MOVE_NW=o.KEYS.VK_Q+32,i.KEY.ABILITY=i.VK.k,i.KEY.CHAT=o.KEYS.VK_C,i.KEY.DELETE=o.KEYS.VK_D,i.KEY.DOOR=o.KEYS.VK_O+32,i.KEY.FIGHT=o.KEYS.VK_F+32,i.KEY.GIVE=o.KEYS.VK_G,i.KEY.GOTO=i.VK.g,i.KEY.JUMP=i.VK.j,i.KEY.LOOK=o.KEYS.VK_L+32,i.KEY.MARK=i.VK.b,i.KEY.MULTI=o.KEYS.VK_SPACE,i.KEY.NEXT=i.VK.n,i.KEY.NEXT_ITEM=o.KEYS.VK_H+32,i.KEY.ORDER=o.KEYS.VK_O,i.KEY.PICKUP=i.VK.COMMA,i.KEY.POWER=i.VK.Z,i.KEY.PREV=o.KEYS.VK_P+32,i.KEY.QUIT_MENU=i.VK.q,i.KEY.READ=o.KEYS.VK_R,i.KEY.REST=o.KEYS.VK_S+32,i.KEY.RUN=o.KEYS.VK_R+32,i.KEY.SELECT=i.VK.s,i.KEY.SELECT_ALL=o.KEYS.VK_A,i.KEY.TARGET=i.VK.t,i.KEY.USE_ABILITY=i.VK.k,i.KEY.USE_STAIRS_DOWN=i.VK.GT,i.KEY.USE_STAIRS_UP=i.VK.LT,i.KEY.YES=i.VK.y,i.KEY.NO=i.VK.n,i.KeyMap.initMap(),i.KEY.NO_ACTION=o.KEYS.VK_CAPS_LOCK,i.GUI={},i.GUI.CharInfo=o.KEYS.VK_I,i.GUI.Goto=i.KEY.GOTO,i.GUI.Help=o.KEYS.VK_H,i.GUI.Help2=o.KEYS.VK_QUESTION_MARK,i.GUI.Inv=i.VK.i,i.GUI.Look=i.VK.l,i.GUI.Map=i.VK.m,i.GUI.OwMap=o.KEYS.VK_M,i.GUI.Use=i.VK.u,i.GUI.Craft=i.VK.K,i.GUI.Shop=i.VK.S,i.isValidKey=e=>{let t=!1;return Object.keys(i.KEY).forEach(n=>{t=t||i.KEY[n]===e}),t=t||i.KeyMap.inMoveCodeMap(e),t},i.getChar=e=>"`"+String.fromCharCode(e)+"`"},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Dice=void 0;const r=s(n(4)),a=n(9);class o{constructor(e,t,n){this._num=parseInt(e,10),this._dice=parseInt(t,10),this._mod=parseInt(n,10)}static create(e){const t=o.parseDieSpec(e);if(3===t.length)return new o(t[0],t[1],t[2]);r.default.err("Dice","create","Could not create dice properly")}static isDieSpec(e){return o.DIE_RE.test(e)}static getDice(e){return"object"==typeof e?e:o.create(e)}static getValue(e){if("number"==typeof e){if(Number.isInteger(e))return e}else if("string"==typeof e){const t=o.parseDieSpec(e);return new o(t[0],t[1],t[2]).roll()}return e.roll()}static parseDieSpec(e){if("number"==typeof e)return[0,0,e];if("object"==typeof e){if(e.length>=3)return[e[0],e[1],e[2]]}else{const t=o.DIE_RE.exec(e);if(null!==t){const e=t[1],n=t[2];let s=null;return s=r.default.isNullOrUndef([t[3],t[4]])?"0":"+"===t[3]?t[4]:"-"+t[4],[e,n,s]}if(o.DIE_NUMBER.test(e))return[0,0,parseInt(e,10)];r.default.err("RG","parseDieSpec","Cannot parse: "+e)}return[]}static combine(e,t){const n=e.getNum()+t.getNum();let s=e.getNum()*e.getDice()+t.getNum()*t.getDice();s=Math.round(s/n);const r=e.getMod()+t.getMod();return new o(n,s,r)}static addDice(e,t){const n=e.getNum()+t.getNum(),s=e.getDice()+t.getDice(),r=e.getMod()+t.getMod();return new o(n,s,r)}getNum(){return this._num}setNum(e){this._num=e}getDice(){return this._dice}setDice(e){this._dice=e}getMod(){return this._mod}setMod(e){this._mod=e}roll(){let e=0;for(let t=0;t<this._num;t++)e+=o.RNG.getUniformInt(1,this._dice);return e+this._mod}toString(){let e="+ "+this._mod;return this._mod<0?e="- "+Math.abs(this._mod):0===this._mod&&(e=""),this._num+"d"+this._dice+" "+e}copy(e){this._num=e.getNum(),this._dice=e.getDice(),this._mod=e.getMod()}clone(){return new o(this._num,this._dice,this._mod)}equals(e){let t=this._num===e.getNum();return t=t&&this._dice===e.getDice(),t=t&&this._mod===e.getMod(),t}toJSON(){return[this._num,this._dice,this._mod]}}t.Dice=o,o.DIE_RE=/\s*(\d+)d(\d+)\s*(\+|-)?\s*(\d+)?/,o.DIE_NUMBER=/^\s*(-?\d+)\s*$/,o.RNG=new a.Random((new Date).getTime())},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)},o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Brain=void 0,a(n(134),t),a(n(71),t);const i=n(71);Object.defineProperty(t,"Brain",{enumerable:!0,get:function(){return i.Brain}}),a(n(178),t),a(n(176),t);const l=n(180);a(n(180),t);const c=n(111);a(n(111),t);const u=o(n(271));a(n(271),t);const h=n(272);a(n(272),t),i.Brain.Animal=u.BrainAnimal,i.Brain.Commander=u.BrainCommander,i.Brain.Explorer=u.BrainExplorer,i.Brain.GoalOriented=u.BrainGoalOriented,i.Brain.SpellCaster=u.BrainSpellCaster,i.Brain.Spirit=u.BrainSpirit,i.Brain.Thief=u.BrainThief,i.Brain.Flame=u.BrainFlame,i.Brain.Cloud=u.BrainCloud,i.Brain.Virtual=c.BrainVirtual,i.Brain.Weather=l.BrainWeather,i.Brain.NeedDriven=h.BrainNeedDriven,i.Brain.Wave=u.BrainWave},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryLevel=void 0;const i=o(n(4)),l=n(31),c=n(24),u=n(16),h=a(n(47)),d=n(81);class p{constructor(){this._verif=new h.Conf("FactoryLevel")}static createLevel(e,t,n,s){return(new p).createLevel(e,t,n,s)}createLevel(e,t,n,s){const r=new l.MapGenerator;let a=null,o=null;if(r.setGen(e,t,n),"empty"===e?a=r.createEmptyMap():"town"===e?(a=r.createTownBSP(t,n,s),o=new c.Level(a.map),this.createHouseElements(o,a),this.createShops(o,a,s),this.createTrainers(o,s)):"townwithwall"===e?(a=r.createTownWithWall(t,n,s),o=new c.Level(a.map),this.createHouseElements(o,a),this.createShops(o,a,s),this.createTrainers(o,s)):a="forest"===e?r.createForest(s):"lakes"===e?r.createLakes(s):"mountain"===e?r.createMountain(t,n,s):"summit"===e?r.createSummit(t,n,s):"crypt"===e?r.createCryptNew(t,n,s):"cave"===e?r.createCave(t,n,s):"castle"===e?r.createCastle(t,n,s):"wall"===e?r.createWall(t,n,s):"arctic"===e?r.createArctic(t,n,s):r.getMap(),null===o)if(a)o=new c.Level(a.map);else{const t=JSON.stringify(s);i.default.err("FactoryBase","createLevel",`mapObj is null. type: ${e}. ${t}`)}return this.setLevelExtras(o,a),o}setLevelExtras(e,t){const n={};["rooms","corridors","vaults","houses","paths"].forEach(e=>{t.hasOwnProperty(e)&&(n[e]=t[e])}),e.setExtras(n)}createHouseElements(e,t){if(t.houses){const n=t.houses;for(let t=0;t<n.length;t++){const s=n[t].door,r=new u.ElementDoor(!0);e.addElement(r,s[0],s[1])}}}createShops(e,t,n){this._verif.verifyConf("createShops",n,["nShops"]);const s=new d.DungeonPopulate;e.addExtras("houses",t.houses),s.createShops(e,n)}createTrainers(e,t){(new d.DungeonPopulate).createTrainers(e,t)}}t.FactoryLevel=p},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Lore=t.BuildEvent=t.Place=t.DrainStat=t.Entrapped=t.Entrapping=t.Snowy=t.Indoor=t.ZoneEvent=t.WorldSimEvent=t.WeatherEffect=t.Weather=t.Duration=t.Expiration=t.Fading=t.GameInfo=t.Callbacks=t.UseStairs=t.UseItem=t.UseElement=t.Rest=t.Read=t.Pickup=t.OpenDoor=t.Jump=t.Give=t.Farming=t.Crafting=t.Explosion=t.Mining=t.PlantedSoil=t.TilledSoil=t.Tillable=t.Unpickable=t.DontRender=t.addToExpirationComp=t.Animation=t.Telepathy=t.RegenEffect=t.Regeneration=t.AddOnEquip=t.Equip=t.AddOnHit=t.Player=t.PlayerControlled=t.Effects=t.Event=t.Reputation=t.Commander=t.BattleOrder=t.BattleBadge=t.BattleOver=t.BattleExp=t.InBattle=t.BattleEvent=t.Groups=t.UseEffects=t.Transaction=t.Shopkeeper=t.SkillsExp=t.Skills=t.SpiritItemCrafter=t.GemBound=t.SpiritBind=t.NourishedOne=t.SpellStop=t.SpellWave=t.SpellSelf=t.SpellArea=t.SpellCell=t.SpellMissile=t.SpellRay=t.SpellCast=t.PowerDrain=t.SpellPower=t.Deflection=t.DoubleShot=t.CriticalShot=t.RangedEvasion=t.LongRangeShot=t.MixedShot=t.ThroughShot=t.StrongShot=t.EagleEye=t.Amphibious=t.SnowWalk=t.Camouflage=t.Jumper=t.Climber=t.Charm=t.BypassProtection=t.MasterEquipper=t.FirstStrike=t.LongReach=t.Ambidexterity=t.CounterAttack=t.BiDirStrike=t.Attacker=t.Defender=t.Breakable=t.ActorClass=t.NonSentient=t.Magical=t.Resistance=t.Weakness=t.Flame=t.Possessed=t.Sharpened=t.Sharpener=t.Summoned=t.Undead=t.Flying=t.Ammo=t.Indestructible=t.Drowning=t.Unpaid=t.Stolen=t.Owned=t.BodyTemp=t.Heat=t.Coldness=t.Drenched=t.Poison=t.Named=t.Created=t.Blindness=t.Paralysis=t.Stun=t.Ethereal=t.Physical=t.OneShot=t.Damaging=t.Communication=t.Loot=t.Missile=t.Chat=t.Movement=t.Displace=t.AttackRanged=t.Attack=t.Perception=t.StatsMods=t.Stats=t.CombatMods=t.Combat=t.ExpPoints=t.Experience=t.Terrain=t.Opaque=t.Impassable=t.Broken=t.Damaged=t.DirectDamage=t.Damage=t.Corporeal=t.DeathEvent=t.Dead=t.Health=t.Hunger=t.Item=t.Typed=t.Location=t.Action=t.PlayerCmdInfo=void 0;const i=o(n(4)),l=a(n(133)),c=n(34),u=n(23),h=n(26),d=n(13),p=u.EventPool.getPool(),f=c.Component.DataComponent,m=c.Component.UniqueDataComponent,g=c.Component.UniqueTransientDataComponent,y=c.Component.TransientDataComponent,v=c.Component.TransientTagComponent,b=c.Component.TagComponent,_=c.Component.UniqueTagComponent,E=c.ComponentBase.prototype,S=Object.freeze("");t.PlayerCmdInfo=m("PlayerCmdInfo",{impossibleCmd:!1}),t.Action=g("Action",{energy:0,active:!1,msg:"",status:0}),t.Action.prototype.addEnergy=function(e){this.energy+=e},t.Action.prototype.resetEnergy=function(){this.energy=0},t.Action.prototype.enable=function(){!1===this.active&&(p.emitEvent(i.default.EVT_ACT_COMP_ENABLED,{actor:this.getEntity()}),this.active=!0)},t.Action.prototype.disable=function(){!0===this.active&&(p.emitEvent(i.default.EVT_ACT_COMP_DISABLED,{actor:this.getEntity()}),this.active=!1)},t.Action.prototype.statusOk=function(){return this.getStatus()!==i.default.ACTION_FAILED},t.Location=m("Location",{x:-1,y:-1,level:null}),t.Location.prototype.getXY=function(){return[this.x,this.y]},t.Location.prototype.setXY=function(e,t){this.x=e,this.y=t},t.Location.prototype.isValid=function(){return this.level,this.x>=0&&this.y>=0},t.Location.prototype.unsetLevel=function(){this.level?this.level=null:i.default.err("Location","unsetLevel","Trying to unset already null level.")},t.Location.prototype.isLocated=function(){return this.x>=0&&this.y>=0&&null!==this.level},t.Location.prototype.getCell=function(){return this.level?this.level.getMap().getCell(this.x,this.y):null},t.Location.prototype.isAtXY=function(e,t){return this.x===e&&this.y===t},t.Location.prototype.toJSON=function(){const e={setType:this.getType(),setID:this.getID(),setX:this.x,setY:this.y};return this.level&&(e.setLevel=i.default.getObjRef("entity",this.level)),e},t.Typed=m("Typed",{objType:S,propType:S}),t.Typed.prototype._init=function(e,t){this.objType=e,this.propType=t},t.Item=m("Item",{value:1,damageType:i.default.DMG.BLUNT,count:1}),t.Item.prototype.incrCount=function(e){this.count+=e},t.Item.prototype.decrCount=function(e){this.count-=e},t.Hunger=m("Hunger",{energy:2e4,maxEnergy:2e4,minEnergy:-5e3}),t.Hunger.prototype.addEnergy=function(e){this.energy+=e,this.energy>this.maxEnergy&&(this.energy=this.maxEnergy)},t.Hunger.prototype.decrEnergy=function(e){this.energy-=e,this.energy<this.minEnergy&&(this.energy=this.minEnergy)},t.Hunger.prototype.isStarving=function(){return this.energy<=0},t.Hunger.prototype.isFull=function(){return this.energy===this.maxEnergy},t.Health=m("Health",{HP:10,maxHP:10}),t.Health.prototype.addHP=function(e){this.HP+=e,this.HP>this.maxHP&&(this.HP=this.maxHP)},t.Health.prototype.propLeft=function(){return this.HP/this.maxHP},t.Health.prototype.decrHP=function(e){this.HP-=e},t.Health.prototype.isAlive=function(){return this.HP>0},t.Health.prototype.isDead=function(){return this.HP<=0},t.Health.prototype.hpLost=function(){return this.maxHP-this.HP},t.Health.prototype._init=function(e){this.HP=e,this.maxHP=e},t.Dead=_("Dead"),t.DeathEvent=g("DeathEvent",{msg:"",source:null}),t.Corporeal=_("Corporeal"),t.Damage=y("Damage",{damage:0,weapon:null,damageType:"",damageCateg:"",source:null,sourceActor:null}),t.Damage.prototype.setSource=function(e){i.default.isEntity(e)||(console.log("Wrong (non-Entity) source given: ",e),i.default.err("Comp.Damage","setSource","Non-entity sources not supported.")),this.source=e},t.Damage.prototype._init=function(e,t){this.damage=e,this.damageType=t},t.Damage.prototype.isType=function(e){return this.damageType===e},t.DirectDamage=f("DirectDamage",{damage:0,damageType:"",damageCateg:"",prob:1,source:null,msg:""}),t.DirectDamage.prototype.rollDamage=function(){return this.damage.roll()},t.DirectDamage.prototype.setDamage=function(e){this.damage="number"==typeof e?new h.Dice(0,0,e):"object"==typeof e?e.clone():h.Dice.create(e)},t.DirectDamage.prototype.toJSON=function(){const e=c.ComponentBase.prototype.toJSON.call(this);return this.source?e.setSource=i.default.getObjRef("entity",this.source):delete e.setSource,e.setDamage=this.damage.toString(),e},t.Damaged=m("Damaged",{damageLevel:0}),t.Broken=_("Broken"),t.Impassable=m("Impassable",{canFlyOver:!0,canJumpOver:!0,spellPasses:!0}),t.Impassable.prototype.setAllImpassable=function(){this.canFlyOver=!1,this.spellPasses=!1,this.canJumpOver=!1},t.Opaque=_("Opaque"),t.Terrain=m("Terrain",{mods:null}),t.Terrain.prototype._init=function(){this.mods=[]},t.Experience=m("Experience",{exp:0,expLevel:1,danger:1,numKilled:0}),t.Experience.prototype.incrNumKilled=function(){this.numKilled+=1},t.ExpPoints=y("ExpPoints",{expPoints:null,skillPoints:null}),t.ExpPoints.prototype._init=function(e){this.expPoints=e,this.skills={}},t.ExpPoints.prototype.addSkillPoints=function(e,t){this.skills[e]=t},t.ExpPoints.prototype.addExpPoints=function(e){this.expPoints+=e},t.Combat=m("Combat",{attack:1,defense:1,protection:0,attackRange:1,damageDie:null,numHits:1}),t.Combat.prototype._init=function(){this.damageDie=h.Dice.create("1d4")},t.Combat.prototype.rollDamage=function(){return this.damageDie.roll()},t.Combat.prototype.setDamageDie=function(e){this.damageDie="string"==typeof e?h.Dice.create(e):e},t.Combat.prototype.copy=function(e){E.copy.call(this,e),this.damageDie=e.getDamageDie().clone()},t.Combat.prototype.toJSON=function(){const e=E.toJSON.call(this);return e.setDamageDie=this.damageDie.toString(),e},t.CombatMods=f("CombatMods",{attack:0,defense:0,protection:0,attackRange:0,damage:0,tag:""}),t.Stats=m("Stats",i.default.STATS_DEFAULTS),t.Stats.prototype.clearValues=function(){i.default.SET_STATS.forEach(e=>{this[e](0)})},t.Stats.prototype.incrStat=function(e,t){const n="set"+e.capitalize(),s=this["get"+e.capitalize()]();this[n](s+t)},t.Stats.prototype.toString=function(){let e="";return i.default.GET_STATS.forEach((t,n)=>{const s=this[t]();0!==s&&(e+=i.default.STATS_ABBR[n]+": "+s)}),e},t.Stats.prototype.equals=function(e){let t=this.getType()===e.getType();return i.default.GET_STATS.forEach(n=>{t=t&&this[n]()===e[n]()}),t};const w=i.default.createStatsObj(0);t.StatsMods=f("StatsMods",Object.assign({tag:""},w)),t.Perception=m("Perception",{FOVRange:i.default.NPC_FOV_RANGE}),t.Attack=y("Attack",{target:null}),t.AttackRanged=y("AttackRanged",{target:null,attacker:null}),t.Displace=y("Displace",{displaceTarget:null}),t.Movement=y("Movement",{x:0,y:0,level:null,displace:!1,actor:null}),t.Movement.prototype.setXY=function(e,t){this.x=e,this.y=t},t.Movement.prototype.getXY=function(){return[this.x,this.y]},t.Movement.prototype._init=function(e,t,n){this.x=e,this.y=t,this.level=n},t.Chat=y("Chat",{args:null}),t.Missile=y("Missile",{x:null,y:null,z:null,source:null,level:null,flying:!0,targetX:null,targetY:null,range:0,attack:0,damage:0,path:null}),t.Missile.prototype._init=function(e){this.source=e,this.x=e.getX(),this.y=e.getY(),this.z=e.getZ(),this.level=e.getLevel(),this.path=[],this.pathIter=-1},t.Missile.prototype.hasRange=function(){return this.range>0},t.Missile.prototype.isFlying=function(){return this.flying},t.Missile.prototype.stopMissile=function(){this.flying=!1},t.Missile.prototype.setTargetXYZ=function(e,t,n){const s=[this.x,this.y,this.z],r=[e,t,n];i.default.isNullOrUndef([n])&&i.default.err("Component.Missile","setTargetXYZ","z is undefined"),this.path=d.Geometry.getBresenham3D(s,r),this.targetX=e,this.targetY=t,this.targetZ=n,this.path.length>0&&(this.pathIter=0)},t.Missile.prototype.inTarget=function(){return this.x===this.targetX&&this.y===this.targetY&&this.z===this.targetZ},t.Missile.prototype.iteratorValid=function(){return this.pathIter>=0&&this.pathIter<this.path.length},t.Missile.prototype.setValuesFromIterator=function(){const e=this.path[this.pathIter];this.x=e[0],this.y=e[1],this.z=e[2]},t.Missile.prototype.first=function(){return this.pathIter=0,this.setValuesFromIterator(),[this.x,this.y,this.z]},t.Missile.prototype.next=function(){return this.iteratorValid()?(--this.range,++this.pathIter,this.setValuesFromIterator(),!0):null},t.Missile.prototype.prev=function(){return this.iteratorValid()?(++this.range,--this.pathIter,this.setValuesFromIterator(),!0):null},t.Loot=function(e){c.ComponentBase.call(this,"Loot"),this._lootEntity=e},i.default.extend2(t.Loot,c.ComponentBase),c.Component.Loot=t.Loot,t.Loot.prototype.dropLoot=function(e){const t=this.getEntity().getLevel();if(this._lootEntity.getPropType){const n=this._lootEntity.getPropType();"elements"===n?this.setElemToCell(e):n===i.default.TYPE_ITEM?t.addItem(this._lootEntity,e.getX(),e.getY()):i.default.err("Component.Loot","dropLoot","Unsupported propType for entity: "+n)}else i.default.err("Loot","dropLoot","Loot has no propType!")},t.Loot.prototype.setElemToCell=function(e){const t=this.getEntity().getLevel();this._lootEntity.hasOwnProperty("useStairs")&&(i.default.debug(this,"Added stairs to "+e.getX()+", "+e.getY()),t.addStairs(this._lootEntity,e.getX(),e.getY()))},t.Loot.prototype.setLootEntity=function(e){this._lootEntity=e},t.Loot.prototype.toJSON=function(){const e=c.ComponentBase.prototype.toJSON.call(this),t=this._lootEntity.toJSON();return this._lootEntity.getPropType()===i.default.TYPE_ITEM?e.setLootEntity={createFunc:"createItem",value:t}:this._lootEntity.getPropType()===i.default.TYPE_ACTOR?e.setLootEntity={createFunc:"createActor",value:t}:i.default.err("Loot","toJSON","Only items/actors loot types are supported"),e},t.Communication=y("Communication",{msg:null}),t.Communication.prototype._init=function(){this.msg=[]},t.Communication.prototype.addMsg=function(e){this.msg.push(e)},t.Damaging=f("Damaging",{damage:1,damageType:""}),t.OneShot=_("OneShot"),t.OneShot.description="Destroyed automatically after one use",t.Physical=m("Physical",{weight:1,size:1,material:i.default.MATERIAL.DEFAULT}),t.Ethereal=b("Ethereal",{description:"Ethereal beings cannot interact physically with others"}),t.Stun=f("Stun",{source:null}),t.Stun.prototype.toJSON=function(){const e=c.ComponentBase.prototype.toJSON.call(this);return i.default.isActorActive(this.source)?e.setSource=i.default.getObjRef("entity",this.source):delete e.setSource,e},t.Stun.description="Stunning prevents some actions to be done",t.Paralysis=f("Paralysis",{source:null}),t.Paralysis.description="Paralysed actors cannot perform any actions",t.Paralysis.prototype.toJSON=function(){const e=c.ComponentBase.prototype.toJSON.call(this);return i.default.isActorActive(this.source)?e.setSource=i.default.getObjRef("entity",this.source):delete e.setSource,e},t.Blindness=f("Blindness",{source:null}),t.Blindness.description="Blinded actors cannot see their surroundings",t.Blindness.prototype.toJSON=function(){const e=c.ComponentBase.prototype.toJSON.call(this);return i.default.isActorActive(this.source)?e.setSource=i.default.getObjRef("entity",this.source):delete e.setSource,e},t.Created=m("Created",{creator:null}),t.Created.prototype.toJSON=function(){const e=c.ComponentBase.prototype.toJSON.call(this);return e.setCreator=i.default.getObjRef("entity",this.creator),e},t.Named=m("Named",{name:"",uniqueName:""}),t.Named.prototype.prepend=function(e){this.name=e+this.name},t.Named.prototype.getBaseName=function(){return this.name},t.Named.prototype.getFullName=function(){return""!==this.uniqueName?`${this.uniqueName}, ${this.name}`:this.name};class C extends(l.DamageRoll(c.ComponentBase)){constructor(){super("Poison"),this._src=null,this._prob=.05}getProb(){return this._prob}setProb(e){this._prob=e}getSource(){return this._src}setSource(e){this._src=e}copy(e){super.copy(e),this._prob=e.getProb(),this._src=e.getSource()}toJSON(){const e=super.toJSON();return e.setType=this.getType(),e.setProb=this._prob,i.default.isActorActive(this._src)&&(e.setSource=i.default.getObjRef("entity",this._src)),e}}t.Poison=C,C.description="Poison causes damage periodically until it stop",c.Component.Poison=C,t.Drenched=m("Drenched",{level:0},{description:"Indicates the soakness of entity"}),t.Drenched.prototype.incrLevel=function(e=1){this.level+=e,this.level>i.default.MAX_DRENCHED&&(this.level=i.default.MAX_DRENCHED)},t.Drenched.prototype.decrLevel=function(e=1){this.level-=e,this.level<0&&(this.level=0)},t.Drenched.prototype.isDry=function(){return 0===this.level},t.Coldness=b("Coldness",{description:"Coldness will gradually freeze a non-resistant beings"}),t.Heat=f("Heat",{level:1}),t.BodyTemp=m("BodyTemp",{temp:100,maxTemp:100,minTemp:-100}),t.BodyTemp.prototype.incr=function(e=1){this.temp<this.maxTemp&&(this.temp+=e)},t.BodyTemp.prototype.decr=function(e=1){this.temp>this.minTemp&&(this.temp-=e)},t.BodyTemp.prototype.isFreezing=function(){return this.temp<=0},t.BodyTemp.prototype.isFrozen=function(){return this.temp===this.minTemp},t.Owned=m("Owned",{owner:null}),t.Stolen=b("Stolen"),t.Unpaid=b("Unpaid"),t.Drowning=_("Drowning"),t.Indestructible=_("Indestructible"),t.Ammo=b("Ammo"),t.Flying=b("Flying",{description:"Flying beings can avoid difficult terrain and obstacles"}),t.Undead=b("Undead"),t.Summoned=b("Summoned"),t.Sharpener=b("Sharpener",{description:"You can sharpen weapons (once per weapoon"}),t.Sharpened=b("Sharpened"),t.Possessed=b("Possessed"),t.Flame=y("Flame",{damageType:"",damage:1,source:null}),t.Weakness=f("Weakness",{effect:"",level:i.default.WEAKNESS.MINOR},{description:"Weakness increases damage from attacks of that type"}),t.Resistance=f("Resistance",{effect:"",level:i.default.RESISTANCE.MINOR},{description:"Resistance reduces damage from attacks of that type"}),t.Magical=_("Magical"),t.NonSentient=_("NonSentient"),t.ActorClass=function(){c.ComponentBase.call(this,"ActorClass"),this._class=null,this._className=null,this.setClassName=e=>{this._className=e},this.getClassName=()=>this._className,this.getClass=()=>this._class,this.setActorClass=e=>{this._class=e}},i.default.extend2(t.ActorClass,c.ComponentBase),c.Component.ActorClass=t.ActorClass,t.ActorClass.prototype.toJSON=function(){const e=E.toJSON.call(this);return e.setActorClass={createFunc:"createActorClass",value:{className:this._className,actorRef:i.default.getObjRef("entity",this.getEntity())}},e},t.Breakable=m("Breakable",{hardness:1,durability:100}),t.Defender=_("Defender",{description:"Grants a minor defense (Def) bonus"}),t.Attacker=_("Attacker",{description:"Grants a minor attack (Att) bonus"}),t.BiDirStrike=_("BiDirStrike",{description:"You can attack to 2 opposite directions"}),t.CounterAttack=_("CounterAttack",{desciption:"You perform a counterattack when attacked by enemies"}),t.Ambidexterity=_("Ambidexterity"),t.LongReach=_("LongReach"),t.FirstStrike=_("FirstStrike",{description:"You can hit enemies first before they attack you"}),t.MasterEquipper=f("MasterEquipper",{factor:.5}),t.BypassProtection=f("BypassProtection",{chance:0}),t.Charm=f("Charm",{level:1,targetActor:i.default.NO_TARGET}),t.Climber=_("Climber"),t.Jumper=m("Jumper",{jumpRange:2}),t.Camouflage=_("Camouflage"),t.SnowWalk=_("SnowWalk"),t.Amphibious=_("Amphibious"),t.EagleEye=b("EagleEye",{description:"Grants bonus to missile range and visibility"}),t.StrongShot=b("StrongShot",{description:"Strength (Str) adds extra damage to missile attacks"}),t.ThroughShot=b("ThroughShot",{description:"You can shoot through enemies to hit another target"}),t.MixedShot=b("MixedShot",{description:"Allows mixing of ammo from different type of weapons"}),t.LongRangeShot=b("LongRangeShot",{description:"Doubles missile attack range"}),t.RangedEvasion=b("RangedEvasion",{description:"Grants 50% chance to evade missile/ranged spell attacks"}),t.CriticalShot=b("CriticalShot"),t.DoubleShot=b("DoubleShot"),t.Deflection=b("Deflection",{description:"Grants ability to deflect missile attacks"}),t.SpellPower=m("SpellPower",{PP:10,maxPP:10}),t.SpellPower.prototype.addPP=function(e){this.PP+=e,this.PP>this.maxPP&&(this.PP=this.maxPP)},t.SpellPower.prototype.decrPP=function(e){this.PP-=e},t.SpellPower.prototype.propLeft=function(){return this.PP/this.maxPP},t.SpellPower.prototype.hasPower=function(){return this.PP>0},t.SpellPower.prototype.canCast=function(e){return this.PP>=e},t.PowerDrain=f("PowerDrain",{drainDist:5}),t.PowerDrain.description="Counters any spell cast near you, gives you power and then disappears";const O={spell:null,source:null,args:null};t.SpellCast=y("SpellCast",O),t.SpellRay=y("SpellRay",O),t.SpellMissile=y("SpellMissile",O),t.SpellCell=y("SpellCell",O),t.SpellArea=y("SpellArea",O),t.SpellSelf=y("SpellSelf",O),t.SpellWave=y("SpellWave",O),t.SpellStop=_("SpellStop"),t.NourishedOne=_("NourishedOne",{description:"You gain triple amount of energy from food"}),t.SpiritBind=y("SpiritBind",{binder:null,target:null}),t.GemBound=m("GemBound",{gem:null}),t.GemBound.prototype.toJSON=function(){return{setID:this.getID(),setType:"GemBound",setGem:{createFunc:"createItem",value:this.getGem().toJSON()}}},t.SpiritItemCrafter=_("SpiritItemCrafter",{description:"Grants ability to bind gems to items such as weapons/armour"}),t.Skills=m("Skills",{skills:null}),t.Skills.prototype._init=function(){this.skills={}},t.Skills.prototype.hasSkill=function(e){return this.skills.hasOwnProperty(e)},t.Skills.prototype.addSkill=function(e){this.skills[e]={name:e,level:1,points:0}},t.Skills.prototype.getLevel=function(e){return this.hasSkill(e)?this.skills[e].level:0},t.Skills.prototype.setLevel=function(e,t){this.skills[e].level=t},t.Skills.prototype.getPoints=function(e){return this.skills[e].points},t.Skills.prototype.resetPoints=function(e){this.skills[e].points=0},t.Skills.prototype.addPoints=function(e,t){this.hasSkill(e)&&(this.skills[e].points+=t)},t.Skills.prototype.toJSON=function(){return{setID:this.getID(),setType:this.getType(),setSkills:this.skills}},t.SkillsExp=y("SkillsExp",{skill:"",points:0}),t.Shopkeeper=m("Shopkeeper",{levelID:-1,coord:null,doorXY:null}),t.Shopkeeper._init=function(){this.coord=[]},t.Transaction=y("Transaction",{args:null}),t.UseEffects=m("UseEffects",{effects:null}),t.UseEffects.prototype._init=function(){this.effects=[]},t.UseEffects.prototype.addEffect=function(e){this.effects.push(e)},t.UseEffects.prototype.hasEffect=function(e){return this.effects.findIndex(t=>t.hasOwnProperty(e))>=0},t.Groups=m("Groups",{groups:null}),t.Groups.prototype._init=function(){this.groups=[]},t.Groups.prototype.addGroup=function(e){this.groups.indexOf(e)<0&&this.groups.push(e)},t.Groups.prototype.hasGroupId=function(e){for(let t=0;t<e.length;t++)if(this.groups.indexOf(e[t])>=0)return!0;return!1},t.BattleEvent=y("BattleEvent",{battle:null,eventType:""}),t.InBattle=m("InBattle",{data:null}),t.InBattle.prototype._init=function(){this.data={}},t.InBattle.prototype.updateData=function(e){Object.keys(e).forEach(t=>{this.data[t]=e[t]})},t.BattleExp=f("BattleExp",{data:null}),t.BattleExp.prototype._init=function(){this.data={}},t.BattleExp.prototype.updateData=function(e){Object.keys(e).forEach(t=>{this.data[t]=e[t]})},t.BattleOver=_("BattleOver"),t.BattleBadge=f("BattleBadge",{data:null}),t.BattleBadge.prototype._init=function(){this.data={}},t.BattleBadge.prototype.updateData=function(e){Object.keys(e).forEach(t=>{this.data[t]=e[t]})},t.BattleBadge.prototype.isWon=function(){return"Won"===this.data.status},t.BattleBadge.prototype.isLost=function(){return"Lost"===this.data.status},t.BattleBadge.prototype.isTraitor=function(){return"Traitor"===this.data.status},t.BattleBadge.prototype.isTied=function(){return"Tied"===this.data.status},t.BattleBadge.prototype.isEscaped=function(){return"Fled"===this.data.status},t.BattleOrder=f("BattleOrder",{args:null}),t.Commander=b("Commander"),t.Reputation=m("Reputation",{data:null}),t.Reputation.prototype._init=function(){this.data={fame:0,numFriendsAttacked:0}},t.Reputation.prototype.updateData=function(e){this.data=Object.assign(this.data,e)},t.Reputation.prototype.addToFame=function(e){this.data.fame+=e},t.Event=y("Event",{args:null}),t.Event.prototype._init=function(e){this.args=e},t.Effects=y("Effects",{args:null,effectType:"",item:null}),t.Effects.prototype._init=function(e){this.args=e||{}},t.PlayerControlled=_("PlayerControlled"),t.Player=_("Player"),t.AddOnHit=f("AddOnHit",{comp:null,onDamage:!0,onAttackHit:!1}),t.AddOnHit.prototype.getCompToAdd=function(){return this.comp.toJSON?this.comp:c.Component.createFromObj(this.comp.transientComp,this.comp.func)},t.AddOnHit.prototype.toJSON=function(){const e={setID:this.getID(),setType:this.getType(),setComp:this.comp,setOnDamage:this.onDamage,setOnAttackHit:this.onAttackHit};return this.comp.toJSON&&(e.setComp={createComp:this.comp.toJSON()}),e},t.Equip=y("Equip",{args:null,item:null,isRemove:!1}),t.AddOnEquip=f("AddOnEquip",{comp:null,addedToActor:!1}),t.AddOnEquip.prototype.toJSON=function(){const e={setID:this.getID(),setType:this.getType(),setAddedToActor:this.addedToActor};if(this.addedToActor)e.setComp={createComp:this.comp};else{const t=this.comp.toJSON();e.setComp={createComp:t}}return e};const T={PP:1,HP:1,waitPP:30,waitHP:30,maxWaitPP:60,maxWaitHP:60,regenID:-1};t.Regeneration=f("Regeneration",T),t.RegenEffect=f("RegenEffect",T),t.RegenEffect.prototype.initEffect=function(e){Object.keys(T).forEach(t=>{this[t]=e[t]}),this.regenID=e.getID()},t.Telepathy=f("Telepathy",{target:null,source:null},{description:"Grants ability to see through eyes of another being"}),t.Telepathy.prototype.toJSON=function(){const e={setID:this.getID(),setType:this.getType()};return i.default.isActorActive(this.target)&&(e.setTarget=i.default.getObjRef("entity",this.target)),i.default.isActorActive(this.source)&&(e.setSource=i.default.getObjRef("entity",this.source)),e},t.Animation=y("Animation",{args:null}),t.Animation.prototype._init=function(e){this.args=e},t.addToExpirationComp=(e,n,s,r)=>{if(e.has("Expiration"))e.get("Expiration").addEffect(n,s,r);else{const a=new t.Expiration;a.addEffect(n,s,r),e.add(a)}e.has(n)||e.add(n)},t.DontRender=_("DontRender"),t.Unpickable=_("Unpickable"),t.Tillable=_("Tillable"),t.TilledSoil=_("TilledSoil"),t.PlantedSoil=m("PlantedSoil",{growsInto:"",timeLeftToGrow:1}),t.Mining=y("Mining",{target:null,item:null}),t.Explosion=y("Explosion",{damage:"3d12",force:i.default.MATERIAL2HARDNESS[i.default.MATERIAL.IRON],source:null,item:null,element:null}),t.Crafting=y("Crafting",{args:null,item:"",count:1}),t.Farming=y("Farming",{action:"",args:null}),t.Give=y("Give",{giveTarget:null,item:null}),t.Jump=y("Jump",{x:-1,y:-1}),t.OpenDoor=y("OpenDoor",{door:null}),t.Pickup=v("Pickup"),t.Read=y("Read",{readTarget:null}),t.Rest=v("Rest"),t.UseElement=y("UseElement",{element:null,useType:""}),t.UseItem=y("UseItem",{item:null,useType:"",target:null,targetType:null,effect:null}),t.UseStairs=v("UseStairs"),t.Callbacks=f("Callbacks",{cbs:null}),t.Callbacks.prototype._init=function(){this.cbs={}},t.Callbacks.prototype.addCb=function(e,t){"function"==typeof t&&i.default.err("Component.Callbacks","addCb","Callback must be object, not func."),this.cbs[e]=t},t.Callbacks.prototype.hasCb=function(e){return this.cbs.hasOwnProperty(e)},t.Callbacks.prototype.cb=function(e){return this.cbs[e]},t.GameInfo=m("GameInfo",{data:null}),t.GameInfo.prototype._init=function(){this.data={zones:{}}},t.GameInfo.prototype.updateData=function(e){const t=this.data;this.data=Object.assign(t,e)},t.GameInfo.prototype.addZone=function(e){this.data.zones[e]=!0},t.GameInfo.prototype.hasZone=function(e){return this.data.zones[e]},t.GameInfo.prototype.addZoneType=function(e){const t=this.data;t.zones.hasOwnProperty(e)?t.zones[e]+=1:t.zones[e]=1,this.data=t},t.Fading=f("Fading",{duration:0}),t.Fading.prototype.decrDuration=function(){this.duration-=1},t.Expiration=f("Expiration",{duration:null,expireMsg:null}),t.Expiration.prototype._init=function(){this.expireMsg={}},t.Expiration.prototype.addEffect=function(e,t,n){this.duration||(this.duration={});const s=e.getID();this.duration.hasOwnProperty(s)?this.duration[s]+=t:(this.duration[s]=t,e.addCallback("onRemove",()=>{this.removeEffect(e)})),n&&(this.expireMsg||(this.expireMsg={}),this.expireMsg[s]=n)},t.Expiration.prototype.decrDuration=function(){for(const e in this.duration)if(this.duration[e]){const t=parseInt(e,10);if(t>=0&&(this.duration[t]-=1,0===this.duration[t])){const e=this.getEntity();if(this.expireMsg&&this.expireMsg[t]){const n=this.expireMsg[t];i.default.gameMsg({cell:e.getCell(),msg:n})}else{const t="An effect wears of from "+e.getName();i.default.gameMsg({cell:e.getCell(),msg:t})}e.remove(t),delete this.duration[t]}}},t.Expiration.prototype.hasEffects=function(){return Object.keys(this.duration).length>0},t.Expiration.prototype.hasEffect=function(e){const t=e.getID();return this.duration.hasOwnProperty(t)},t.Expiration.prototype.removeEffect=function(e){const t=e.getID();this.duration.hasOwnProperty(t)&&delete this.duration[t],this.expireMsg&&this.expireMsg.hasOwnProperty(t)&&delete this.expireMsg[t]},t.Expiration.prototype.cleanup=function(){const e=this.getEntity();Object.keys(this.duration).forEach(t=>{e.remove(parseInt(t,10))})};class M extends(l.DurationRoll(c.ComponentBase)){constructor(){super("Duration"),this._comp=null,this._source=null,this._addedOnActor=!1,this._expireMsg=""}setSource(e){this._source=e}setExpireMsg(e){this._expireMsg=e}getExpireMsg(){return this._expireMsg}getSource(){return this._source}setComp(e){if(this._comp=e,!this._addedOnActor){const e=()=>{this.getEntity().add(this._comp),this._comp.setSource&&this._source&&this._comp.setSource(this._source),this._comp=this._comp.getID(),this._addedOnActor=!0,this.removeCallbacks("onAdd")};this.addCallback("onAdd",e)}this.addCallback("onRemove",()=>{this.getEntity().has(this._comp)&&this.getEntity().remove(this._comp)})}getComp(){return this._comp}copy(e){super.copy(e);const t=e.getComp().clone();this.setComp(t)}clone(){const e=super.clone();return e.copy(this),e}setAddedOnActor(e){this._addedOnActor=e}getAddedOnActor(){return this._addedOnActor}toJSON(){const e=super.toJSON();if(i.default.isActorActive(this._source)&&(e.setSource=i.default.getObjRef("entity",this._source)),this._addedOnActor)return Object.assign(e,{setAddedOnActor:!0,setComp:this._comp});{const t=this._comp.toJSON();return Object.assign(e,{setComp:{createComp:t}})}}}t.Duration=M,c.Component.Duration=M,t.Weather=f("Weather",{weatherType:"clear",temperature:0,visibility:0,humidity:50}),t.WeatherEffect=y("WeatherEffect",{effectType:"clear",temperature:0,humidity:50}),t.WorldSimEvent=y("WorldSimEvent",{eventType:"",eventData:null}),t.ZoneEvent=y("ZoneEvent",{eventType:"",eventData:null}),t.Indoor=_("Indoor"),t.Snowy=_("Snowy"),t.Entrapping=m("Entrapping",{difficulty:1,destroyOnMove:!1}),t.Entrapped=_("Entrapped"),t.DrainStat=y("DrainStat",{drainAmount:1,sourceComp:"",sourceGetter:"",sourceSetter:"",targetComp:"",targetGetter:"",targetSetter:"",source:null,drainMsg:""}),t.DrainStat.prototype.applyComp=function(){const e=this.getEntity().get(this.sourceComp);if(e){const t=e[this.sourceGetter]();e[this.sourceSetter](t-this.drainAmount);const n=this.source.get(this.targetComp);if(n){const e=n[this.targetGetter]();return n[this.targetSetter](e+this.drainAmount),!0}}return!1},t.Place=m("Place",{depth:0,danger:1,elevation:0}),t.BuildEvent=y("BuildEvent",{buildType:"",elem:"",target:null});const A=n(456);Object.defineProperty(t,"Lore",{enumerable:!0,get:function(){return A.Lore}}),c.Component.Lore=A.Lore},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BBox=void 0;const r=s(n(4)),a=n(9).Random.getRNG();class o{constructor(e,t,n,s){this.ulx=e,this.uly=t,this.lrx=n,this.lry=s,(e>n||t>s)&&r.default.err("BBox","constructor",`Illegal bbox: ${e},${t} -> ${n},${s}`)}static fromBBox(e){return new o(e.ulx,e.uly,e.lrx,e.lry)}getDist(e){const[t,n]=e;if(this.hasXY(t,n))return[0,0];return[this.getDistX(t),this.getDistY(n)]}getDistX(e){return e<this.ulx?this.ulx-e:e-this.lrx}getDistY(e){return e<this.uly?this.uly-e:e-this.lry}getArea(){return this.getSizeX()*this.getSizeY()}getSizeX(){return this.lrx-this.ulx+1}getSizeY(){return this.lry-this.uly+1}hasXY(e,t){return e>=this.ulx&&e<=this.lrx&&t>=this.uly&&t<=this.lry}getRandXY(){return[a.getUniformInt(this.ulx,this.lrx),a.getUniformInt(this.uly,this.lry)]}overlaps(e){return!!this.overlapsX(e)&&this.overlapsY(e)}overlapsX(e){return e.ulx>=this.ulx&&e.ulx<=this.lrx||e.lrx>=this.ulx&&e.lrx<=this.lrx}overlapsY(e){return e.uly>=this.uly&&e.uly<=this.lry||e.lry>=this.uly&&e.lry<=this.lry}getBorderXY(e,t=0){const n=[];let s=t||0;if(/N/.test(e))for(let e=this.ulx;e<=this.lrx;++e)n.push([e,this.uly+s]);if(/S/.test(e))for(let e=this.ulx;e<=this.lrx;++e)s>0&&(s=-s),n.push([e,this.lry+s]);if(/E/.test(e))for(let e=this.uly;e<=this.lry;++e)s>0&&(s=-s),n.push([this.lrx+s,e]);if(/W/.test(e))for(let e=this.uly;e<=this.lry;++e)n.push([this.ulx+s,e]);return n}getSides(){return[[[this.ulx,this.uly],[this.lrx,this.uly]],[[this.ulx,this.uly],[this.ulx,this.lry]],[[this.lrx,this.uly],[this.lrx,this.lry]],[[this.ulx,this.lry],[this.lrx,this.lry]]]}getMatchingSide(e){const t=this.getSides(),n=e.getSides();for(let e=0;e<t.length;e++){const s=t[e];for(let t=0;t<n.length;t++){if(i(s,n[t]))return[e,s]}}return null}combine(e){const t=this.getMatchingSide(e);if(t){const[n,s]=t;return 0===n||1===n?new o(e.ulx,e.uly,this.lrx,this.lry):new o(this.ulx,this.uly,e.lrx,e.lry)}return null}getCoord(){const e=[];for(let t=this.ulx;t<=this.lrx;t++)for(let n=this.uly;n<=this.lry;n++)e.push([t,n]);return e}withOffsetXY(e,t){return new o(this.ulx+e,this.uly+t,this.lrx+e,this.lry+t)}getCenter(){const e=this.getSizeX(),t=this.getSizeY();return[this.ulx+Math.round(e/2),this.uly+Math.round(t/2)]}}function i(e,t){const[n,s]=e,[r,a]=t;return n[0]===r[0]&&n[1]===r[1]&&s[0]===a[0]&&s[1]===a[1]}t.BBox=o},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),r(n(692),t),r(n(700),t),r(n(343),t),r(n(701),t),r(n(702),t),r(n(344),t),r(n(337),t),r(n(62),t),r(n(703),t),r(n(225),t),r(n(63),t)},function(e,t,n){"use strict";e.exports=function(){}},function(e,t){var n=(t=e.exports=function(e){if(e&&"object"==typeof e){var t=e.which||e.keyCode||e.charCode;t&&(e=t)}if("number"==typeof e)return a[e];var r,o=String(e);return(r=n[o.toLowerCase()])?r:(r=s[o.toLowerCase()])||(1===o.length?o.charCodeAt(0):void 0)}).code=t.codes={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,"pause/break":19,"caps lock":20,esc:27,space:32,"page up":33,"page down":34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46,command:91,"left command":91,"right command":93,"numpad *":106,"numpad +":107,"numpad -":109,"numpad .":110,"numpad /":111,"num lock":144,"scroll lock":145,"my computer":182,"my calculator":183,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222},s=t.aliases={windows:91,"โง":16,"โฅ":18,"โ":17,"โ":91,ctl:17,control:17,option:18,pause:19,break:19,caps:20,return:13,escape:27,spc:32,pgup:33,pgdn:34,ins:45,del:46,cmd:91};
/*!
 * Programatically add the following
 */
for(r=97;r<123;r++)n[String.fromCharCode(r)]=r-32;for(var r=48;r<58;r++)n[r-48]=r;for(r=1;r<13;r++)n["f"+r]=r+111;for(r=0;r<10;r++)n["numpad "+r]=r+96;var a=t.names=t.title={};for(r in n)a[n[r]]=r;for(var o in s)n[o]=s[o]},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.undefineComponent=t.defineComponent=t.create=t.createFromObj=t.ComponentBase=t.setIDCount=t.getIDCount=t.compsToJSON=t.SharedComponent=t.UniqueTransientDataComponent=t.TransientDataComponent=t.TransientTagComponent=t.UniqueDataComponent=t.UniqueTagComponent=t.DataComponent=t.TagComponent=t.NO_SERIALISATION=t.Component=t.C=void 0;const r=s(n(4));t.C={ID:{},ID2TYPE:{}},t.Component={},t.Component.createdCompDecls={},t.NO_SERIALISATION=()=>null,t.Component.NO_SERIALISATION=t.NO_SERIALISATION;const a=new Set(["description","_isUnique","_isShared"]);let o=1;function i(e,t){a.forEach(n=>{t.hasOwnProperty(n)&&(e[n]=t[n])})}function l(e,n){t.Component.hasOwnProperty(e)?r.default.err("Component","addCompDecl",`Comp ${e} exists already!`):(t.Component[e]=n,t.C.ID[e]=o++,t.C.ID2TYPE[t.C.ID[e]]=e)}function c(e){t.Component.createdCompDecls[e]&&r.default.err("Component","Tag/DataComponent","Duplicate decl: "+e)}function u(e){return t.Component.idCount=e}t.TagComponent=function(e,n={}){c(e);const s=function(){t.ComponentBase.call(this,e),Object.keys(n).forEach(e=>{a.has(e)||(this[e]=n[e])})};return r.default.extend2(s,t.ComponentBase),t.Component.createdCompDecls[e]=s,i(s,n),l(e,s),s},t.Component.TagComponent=t.TagComponent,t.DataComponent=(e,n,s={})=>{if(c(e),"string"!=typeof e){const t=JSON.stringify(e);r.default.err("component.base.js","DataComponent: NO TYPE GIVEN","First arg must be string! Got: |"+t+"|")}("object"!=typeof n||Array.isArray(n))&&r.default.err("component.base.js","DataComponent: "+e,"Members must be given as key/value pairs.");const a=function(...r){t.ComponentBase.call(this,e),Object.keys(s).forEach(e=>{this[e]=s[e]}),Object.keys(n).forEach(e=>{r&&r[0]&&r[0].hasOwnProperty(e)?this[e]=r[0][e]:"object"==typeof n[e]?this[e]=JSON.parse(JSON.stringify(n[e])):this[e]=n[e]}),this._init&&"function"==typeof this._init&&this._init(...r)};return r.default.extend2(a,t.ComponentBase),Object.keys(n).forEach(n=>{t.ComponentBase.prototype.hasOwnProperty(n)&&r.default.err("component.js","DataComponent: "+e,n+" is reserved in Base");const s=r.default.formatSetterName(n);t.ComponentBase.prototype.hasOwnProperty(s)&&r.default.err("component.js","DataComponent: "+e,s+" is reserved in Base"),a.prototype[s]=function(e){this[n]=e};const o=r.default.formatGetterName(n);t.ComponentBase.prototype.hasOwnProperty(s)&&r.default.err("component.js","DataComponent: "+e,o+" is reserved in Base"),a.prototype[o]=function(){return this[n]}}),s.objRefs&&(a.prototype.objRefs=Object.freeze(s.objRefs)),a.prototype.members=Object.freeze(n),i(a,s),t.Component.createdCompDecls[e]=a,l(e,a),a},t.Component.DataComponent=t.DataComponent,t.UniqueTagComponent=(e,n={})=>t.TagComponent(e,Object.assign({_isUnique:!0},n)),t.Component.UniqueTagComponent=t.UniqueTagComponent,t.UniqueDataComponent=(e,n,s={})=>t.DataComponent(e,n,Object.assign({_isUnique:!0},s)),t.Component.UniqueDataComponent=t.UniqueDataComponent,t.TransientTagComponent=(e,n={})=>t.TagComponent(e,Object.assign({toJSON:t.NO_SERIALISATION},n)),t.Component.TransientTagComponent=t.TransientTagComponent,t.TransientDataComponent=(e,n,s={})=>t.DataComponent(e,n,Object.assign({toJSON:t.NO_SERIALISATION},s)),t.Component.TransientDataComponent=t.TransientDataComponent,t.UniqueTransientDataComponent=(e,n,s={})=>t.DataComponent(e,n,Object.assign({_isUnique:!0,toJSON:t.NO_SERIALISATION},s)),t.Component.UniqueTransientDataComponent=t.UniqueTransientDataComponent,t.SharedComponent=(e,n,s={})=>{const r=t.DataComponent(e,n,Object.assign({_isUnique:!0,toJSON:t.NO_SERIALISATION,_isShared:!0},s));return r.prototype.setEntity=()=>{},r.prototype.getEntity=()=>null,r},t.Component.SharedComponent=t.SharedComponent,t.compsToJSON=e=>{const t={},n=e.getComponents();return Object.keys(n).forEach(e=>{const s=n[e].toJSON();s&&(t[e]=s)}),t},t.Component.compsToJSON=t.compsToJSON,t.Component.idCount=0,t.getIDCount=function(){return t.Component.idCount},t.setIDCount=u,t.Component.setIDCount=u,t.ComponentBase=function(e){this._type=e,this._entity=null,this._id=t.Component.idCount++},t.Component.ComponentBase=t.ComponentBase,t.ComponentBase.prototype.getID=function(){return this._id},t.ComponentBase.prototype.setID=function(e){this._id=e},t.ComponentBase.prototype.getEntity=function(){return this._entity},t.ComponentBase.prototype.setEntity=function(e){null===this._entity&&null!==e?this._entity=e:null===e?this._entity=null:r.default.err("Base","setEntity","Entity already set.")},t.ComponentBase.prototype.changeEntity=function(e){r.default.isNullOrUndef([this._entity])?r.default.err("Base","changeEntity","No entity set. Use setEntity() instead of changeEntity()"):(this._entity.remove(this.getID()),e.add(this))},t.ComponentBase.prototype.isUnique=function(){return!!t.Component[this._type]._isUnique},t.ComponentBase.prototype.getType=function(){return this._type},t.ComponentBase.prototype.setType=function(e){this._type=e},t.ComponentBase.prototype.entityAddCallback=function(e){if(this.setEntity(e),this._onAddCallbacks)for(let e=0;e<this._onAddCallbacks.length;e++)this._onAddCallbacks[e]()},t.ComponentBase.prototype.entityRemoveCallback=function(){if(this._onRemoveCallbacks)for(let e=0;e<this._onRemoveCallbacks.length;e++)this._onRemoveCallbacks[e]();this.setEntity(null)},t.ComponentBase.prototype.addCallback=function(e,t){"onAdd"===e?(this._onAddCallbacks||(this._onAddCallbacks=[]),this._onAddCallbacks.push(t)):"onRemove"===e?(this._onRemoveCallbacks||(this._onRemoveCallbacks=[]),this._onRemoveCallbacks.push(t)):r.default.err("Base","addCallback","CB name "+e+" must be onAdd/onRemove")},t.ComponentBase.prototype.removeCallbacks=function(e){"onAdd"===e?this._onAddCallbacks=[]:("onRemove"===e||(this._onAddCallbacks=[]),this._onRemoveCallbacks=[])},t.ComponentBase.prototype.clone=function(){const e=this.getType();if(t.Component.hasOwnProperty(e)){const n=new t.Component[e];return n.copy(this),n}return r.default.err("Base","clone",`No type |${e}| in Component.`),null},t.ComponentBase.prototype.copy=function(e){for(const t in this)if(/^get/.test(t)){const n=t;if("getEntity"!==n&&"getID"!==n){const t=n.replace("get","set");if("function"==typeof e[n]&&"function"==typeof this[t]){const s=e[n]();this[t](s)}}}},t.ComponentBase.prototype.equals=function(e){return this.getType()===e.getType()},t.ComponentBase.prototype.is=function(e){return t.Component[e]||r.default.err("ComponentBase","is","Unknown type: "+e),this._type===e},t.ComponentBase.prototype.toString=function(){return"Component: "+this.getType()};const h=/^get/,d={};t.ComponentBase.prototype.toJSON=function(){const e={},t=this.getType();if(d[t])d[t].forEach(t=>{const n=t[0],s=t[1];e[s]=this[n]()});else{d[t]=[];for(const n in this)if(h.test(n)){const s=n;if("getEntity"!==s&&"function"==typeof this[s]){const n=s.replace("get","set");"function"==typeof this[n]&&(e[n]=this[s](),d[t].push([s,n]))}}}return e},t.Component.Base=t.ComponentBase,t.createFromObj=function(e,n){if(t.Component[e]){const s=new t.Component[e];return n.forEach(e=>{e.setter&&e.value?s[e.setter](e.value):Object.keys(e).forEach(t=>{const n=e[t];s[t](n)})}),s}return r.default.err("Component","createFromObj",`Comp type |${e}| does not exist. Args: ${n}`),null},t.Component.createFromObj=t.createFromObj,t.create=function(e,...n){return t.Component[e]?new t.Component[e](...n):(r.default.err("Component","create",`Comp type |${e}| does not exist.`),null)},t.Component.create=t.create,t.defineComponent=function(e,n){if(!t.Component.hasOwnProperty(e)){return t.DataComponent(e,n)}return r.default.err("Component","defineComponent",`Component ${e} already defined`),null},t.Component.defineComponent=t.defineComponent,t.undefineComponent=function(e){delete t.Component.createdCompDecls[e],delete t.Component[e]},t.Component.undefineComponent=t.undefineComponent},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){var s;try{s={clone:n(492),constant:n(298),each:n(550),filter:n(556),has:n(579),isArray:n(20),isEmpty:n(581),isFunction:n(143),isUndefined:n(582),keys:n(76),map:n(583),reduce:n(585),size:n(588),transform:n(594),union:n(595),values:n(614)}}catch(e){}s||(s=window._),e.exports=s},function(e,t,n){e.exports={default:n(740),__esModule:!0}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createEval=t.EvaluatorGeneric=t.EvaluatorFollowActor=t.EvaluatorFollowPath=t.EvaluatorFindAmmo=t.EvaluatorFindWeapon=t.EvaluatorRest=t.EvaluatorTreasureHunter=t.EvaluatorUseSkill=t.EvaluatorCommunicate=t.EvaluatorThief=t.EvaluatorGoHome=t.EvaluatorShopkeeper=t.EvaluatorCastSpell=t.EvaluatorOrders=t.EvaluatorGuardArea=t.EvaluatorGuard=t.EvaluatorPatrol=t.EvaluatorFlee=t.EvaluatorExplore=t.EvaluatorAttackActor=t.EvaluatorBase=t.Evaluator=void 0;const r=s(n(4)),a=n(72),o=n(460),i=n(461),l=n(9),c=n(27),u=n(30);a.Goal.Thief=o.GoalThief,a.Goal.TreasureHunter=i.GoalTreasureHunter,t.Evaluator={},t.Evaluator.hist={},t.Evaluator.NOT_POSSIBLE=r.default.BIAS.NOT_POSSIBLE,t.Evaluator.ALWAYS=r.default.BIAS.ALWAYS;const h=l.Random.getRNG();class d{constructor(e){this.actorBias=e,this.type="Base",this.evalCount=0,this.evalMaxCount=1,this.isOneShot=!1,this.wasLastChosen=!1}calculateDesirability(e){throw new Error("Pure virtual function")}setActorGoal(e,...n){const s=e.getBrain().getGoal();if(a.Goal[this.type]){const r=new a.Goal[this.type](e,...n);s.addGoal(r),++t.Evaluator.hist[this.type]}else r.default.err(`EvaluatorBase (${this.type})`,"setActorGoal",`No Goal.${this.type} found!`)}isOrder(){return!1}getType(){return this.type}setBias(e){this.actorBias=e}toJSON(){return{type:this.getType(),bias:this.actorBias}}setArgs(e){}}t.EvaluatorBase=d,t.Evaluator.Base=d;class p extends d{constructor(e){super(e),this.type="AttackActor"}calculateDesirability(e){const n=e.getBrain().findEnemyCellFast();if(n){const e=1;return this.enemyActor=n.getActors()[0],this.actorBias*e*2}return t.Evaluator.NOT_POSSIBLE}setActorGoal(e){super.setActorGoal(e,this.enemyActor)}}t.EvaluatorAttackActor=p,t.Evaluator.AttackActor=p,t.Evaluator.hist.AttackActor=0;class f extends d{constructor(e){super(e),this.type="Explore"}calculateDesirability(){return this.actorBias}}t.EvaluatorExplore=f,t.Evaluator.Explore=f,t.Evaluator.hist.Explore=0;class m extends d{constructor(e){super(e),this.type="Flee"}calculateDesirability(e){const n=e.get("Health").propLeft();if(n<this.actorBias){const t=e.getBrain().getSeenEnemies();if(t.length>0){let e=-1;this.enemyActor&&(e=t.findIndex(e=>e.getID()===this.enemyActor.getID())),-1===e&&(this.enemyActor=t[0]);const s=Math.pow(n,2);return this.actorBias*(1-n)/s}}return this.enemyActor=null,t.Evaluator.NOT_POSSIBLE}setActorGoal(e){if(this.enemyActor){const n=e.getBrain().getGoal(),s=new a.Goal.FleeFromActor(e,this.enemyActor);n.addGoal(s),++t.Evaluator.hist[this.type]}else r.default.err("EvaluatorFlee","setActorGoal","Enemy actor is null. Cannot flee.")}}t.EvaluatorFlee=m,t.Evaluator.Flee=m,t.Evaluator.hist.Flee=0;class g extends d{constructor(e,t=[]){super(e),this.type="Patrol",this.coords=t}setCoords(e){this.coords=e}calculateDesirability(){return this.actorBias}setActorGoal(e){const n=e.getBrain().getGoal(),s=this.coords;if(s.length>0){const r=new a.Goal.Patrol(e,s);n.addGoal(r),++t.Evaluator.hist[this.type]}else r.default.err("EvaluatorPatrol","setActorGoal","No guard points set with setCoords()")}setArgs(e){this.coords=e.coords}toJSON(){const e=super.toJSON();return e.args={coords:this.coords},e}}t.EvaluatorPatrol=g,t.Evaluator.Patrol=g,t.Evaluator.hist.Patrol=0;class y extends d{constructor(e,t){super(e),this.type="Guard",t&&this.setXY(t)}setXY(e){this.x=e[0],this.y=e[1]}setArgs(e){const{xy:t}=e;this.setXY(t)}calculateDesirability(){return this.actorBias}setActorGoal(e){const n=e.getBrain().getGoal(),s=new a.Goal.Guard(e,[this.x,this.y]);n.addGoal(s),++t.Evaluator.hist[this.type]}toJSON(){const e=super.toJSON();return e.args={xy:[this.x,this.y]},e}}t.EvaluatorGuard=y,t.Evaluator.Guard=y,t.Evaluator.hist.Guard=0;class v extends d{constructor(e,t){super(e),this.type="GuardArea",this.setBBox(t)}setBBox(e){this.bbox=e}setArgs(e){const{bbox:t}=e;this.setBBox(u.BBox.fromBBox(t))}calculateDesirability(e){return this.bbox.hasXY(e.getX(),e.getY())?t.Evaluator.NOT_POSSIBLE:this.actorBias}setActorGoal(e){const n=e.getBrain().getGoal(),s=new a.Goal.GuardArea(e,this.bbox);n.addGoal(s),++t.Evaluator.hist[this.type]}toJSON(){const e=super.toJSON();return e.args={bbox:this.bbox},e}}t.EvaluatorGuardArea=v,t.Evaluator.GuardArea=v,t.Evaluator.hist.GuardArea=0;class b extends d{constructor(e){super(e),this.type="Orders",this.goal=null}setArgs(e){this.goal=e.goal,this.srcActor=e.srcActor}calculateDesirability(){let e=this.goal.getCategory()===a.Goal.Types.Kill?.5:1;return e*=this.actorBias,this.acceptsOrdersFromSource()?1*e:0}acceptsOrdersFromSource(){return!!this.srcActor.has("Commander")||!!this.srcActor.isPlayer()}setActorGoal(e){if(this.goal){e.getBrain().getGoal().addGoal(this.goal),++t.Evaluator.hist[this.type]}else r.default.err("EvaluatorOrder","setActorGoal","this.goal must not be null")}isOrder(){return!0}}t.EvaluatorOrders=b,t.Evaluator.Orders=b,t.Evaluator.hist.Orders=0;class _ extends d{constructor(e){super(e),this.type="CastSpell",this._castingProb=.2}setCastingProbability(e){this._castingProb=e}getCastingProbability(){return this._castingProb}calculateDesirability(e){if(this.spell=this.getRandomSpell(e),!this.spell)return 0;if(this.canCastSpell(this.spell,e)&&this.shouldCastSpell(this.spell,e))return this.actorBias;const t=e.getBook();if(t){const n=t.getSpells();for(let t=0,s=n.length;t<s;t++){const s=n[t];if(s!==this.spell&&this.canCastSpell(s,e)&&this.shouldCastSpell(s,e))return this.spell=s,this.actorBias}}return 0}setActorGoal(e){if(this.spell){const n=e.getBrain().getGoal(),s=new a.Goal.CastSpell(e,this.spell,this.spellArgs);n.addGoal(s),++t.Evaluator.hist[this.type]}else r.default.err("EvaluatorFlee","setActorGoal","Enemy actor is null. Cannot flee.")}getRandomSpell(e){const t=e.getBook();if(t&&t.getSpells().length>0){return h.arrayGetRand(t.getSpells())}return null}canCastSpell(e,t){if(t.has("SpellPower")){if(t.get("SpellPower").getPP()>=e.getCastingPower()&&h.getUniform()<=this._castingProb)return!0}return!1}shouldCastSpell(e,t){const n=t.getBrain().findEnemyCellFast(),s={actor:t,actorCellsAround:c.Brain.getActorCellsAround(t)};if(n&&(s.enemy=n.getActors()[0]),e.aiShouldCastSpell)return e.aiShouldCastSpell(s,(e,t)=>{this.spellArgs=t});{let t=`Spell ${e.getName()} cannot be cast by AI`;t+=" no aiShouldCastSpell() defined for the spell",r.default.warn("Evaluator.CastSpell","shouldCastSpell",t)}return!1}}t.EvaluatorCastSpell=_,t.Evaluator.CastSpell=_,t.Evaluator.hist.CastSpell=0;class E extends d{constructor(e){super(e),this.type="Shopkeeper"}calculateDesirability(e){return e.has("Shopkeeper")?this.actorBias:(r.default.err("EvaluatorShopkeeper","calculateDesirability","An actor is not shopkeeper: "+e),0)}setActorGoal(e){const n=e.getBrain().getGoal(),s=new a.Goal.Shopkeeper(e,this.x,this.y);n.addGoal(s),++t.Evaluator.hist[this.type]}setArgs(e){const{xy:t}=e;this.x=t[0],this.y=t[1]}toJSON(){const e=super.toJSON();return e.args={xy:[this.x,this.y]},e}}t.EvaluatorShopkeeper=E,t.Evaluator.Shopkeeper=E,t.Evaluator.hist.Shopkeeper=0;class S extends d{constructor(e){super(e),this.type="GoHome",this.timeToHomeSick=h.getUniformInt(200,400),this.timeToStay=0,this.maxDistHome=5,this.x=-1,this.y=-1}calculateDesirability(e){if(this.timeToHomeSick>0)return this.timeToHomeSick-=1,0;if(0===this.timeToHomeSick&&(this.timeToHomeSick=-1,this.timeToStay=h.getUniformInt(20,40)),this.timeToStay>0){const t=[this.x,this.y];return r.default.withinRange(this.maxDistHome,t,e)&&(this.timeToStay-=1),this.actorBias}return 0===this.timeToStay&&(this.timeToStay=-1,this.timeToHomeSick=h.getUniformInt(20,40)),0}setActorGoal(e){const n=e.getBrain().getGoal(),s=new a.Goal.GoHome(e,this.x,this.y,this.maxDistHome);n.addGoal(s),++t.Evaluator.hist[this.type]}setArgs(e){const{xy:t}=e;this.x=t[0],this.y=t[1],this.timeToHomeSick=e.timeToHomeSick}toJSON(){const e=super.toJSON();return e.args={xy:[this.x,this.y],timeToHomeSick:this.timeToHomeSick},e}}t.EvaluatorGoHome=S,t.Evaluator.GoHome=S,t.Evaluator.hist.GoHome=0;class w extends d{constructor(e){super(e),this.type="Thief"}calculateDesirability(){return this.actorBias}}t.EvaluatorThief=w,t.Evaluator.Thief=w,t.Evaluator.hist.Thief=0;class C extends d{constructor(e){super(e),this.type="Communicate"}calculateDesirability(e){if(this.willCommunicate(e))return this.actorBias}willCommunicate(e){if(h.getUniform()<1-this.actorBias)return!1;const t=e.getBrain(),n=t.getSeenCells(),s=t.findFriendCell(n),a=t.getMemory();let o=null;return!r.default.isNullOrUndef([s])&&(o=s.getActors()[0],!a.hasCommunicatedWith(o)&&!o.has("Communication"))}}t.EvaluatorCommunicate=C,t.Evaluator.Communicate=C;class O extends d{constructor(e){super(e),this.type="UseSkill",this.maxCooldown=100,this.cooldown=h.getUniformInt(10,2*this.maxCooldown),this.aiType="aiCell"}calculateDesirability(e){return function(e,t){if("aiFreeCell"===e.aiType){return t.getBrain().getFreeCellsAround().length>0}return!1}(this,e)?0===this.cooldown?(this.cooldown=h.getUniformInt(10,2*this.maxCooldown),this.actorBias):(this.cooldown-=1,r.default.BIAS.NOT_POSSIBLE):r.default.BIAS.NOT_POSSIBLE}setArgs(e){this.cooldown=e.cooldown,this.maxCooldown=e.maxCooldown,this.aiType=e.aiType}toJSON(){const e=super.toJSON();return e.args={cooldown:this.cooldown,maxCooldown:this.maxCooldown,aiType:this.aiType},e}}t.EvaluatorUseSkill=O,t.Evaluator.UseSkill=O;class T extends d{constructor(e){super(e),this.type="TreasureHunter"}calculateDesirability(){return this.actorBias}}t.EvaluatorTreasureHunter=T,t.Evaluator.TreasureHunter=T;class M extends d{constructor(e){super(e),this.type="Rest"}calculateDesirability(){return this.actorBias}}t.EvaluatorRest=M,t.Evaluator.Rest=M;class A extends d{constructor(e){super(e),this.type="FindWeapon"}calculateDesirability(){return this.actorBias}}t.EvaluatorFindWeapon=A,t.Evaluator.FindWeapon=A;class N extends d{constructor(e){super(e),this.type="FindAmmo",this.ammoType="bow"}calculateDesirability(){return this.actorBias}setActorGoal(e){super.setActorGoal(e,this.ammoType)}}t.EvaluatorFindAmmo=N,t.Evaluator.FindAmmo=N;class x extends d{constructor(e){super(e),this.type="FollowPath"}calculateDesirability(){return this.actorBias}setActorGoal(e){super.setActorGoal(e,this.xy)}}t.EvaluatorFollowPath=x,t.Evaluator.FollowPath=x;class P extends d{constructor(e){super(e),this.type="FollowActor"}calculateDesirability(e){const n=e.getBrain();if(!n.findEnemyCellFast()&&!e.has("InBattle")){const e=n.getMemory(),t=e.getStairsUsed();if(t){const n=e.getLastAttacked();if(t[n]){const{level:e,x:s,y:r}=t[n],a=1;return this.actorBias*a*2}}}return t.Evaluator.NOT_POSSIBLE}setActorGoal(e){const n=e.getBrain().getGoal(),s=new a.Goal.ChangeLevel(e,this.stairsXY);n.addGoal(s),++t.Evaluator.hist[this.type]}}t.EvaluatorFollowActor=P,t.Evaluator.FollowActor=P,t.Evaluator.hist.FollowActor=0;class I extends d{constructor(e,t){super(e),this.type=t}calculateDesirability(){return this.actorBias}setActorGoal(e){this.args?super.setActorGoal(e,...this.args):super.setActorGoal(e)}}function D(e,t){return new I(t,e)}t.EvaluatorGeneric=I,t.Evaluator.Generic=I,t.createEval=D,t.Evaluator.create=D},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Book=t.Mineral=t.SpiritGem=t.GoldCoin=t.Gold=t.Container=t.Missile=t.Rune=t.Potion=t.Armour=t.Ammo=t.MissileWeapon=t.Weapon=t.Corpse=t.Food=t.ItemBase=t.Item=void 0;const i=o(n(4)),l=n(34),c=a(n(29)),u=a(n(133)),h=n(55),d=n(23),p=n(26),f=d.EventPool.getPool();t.Item={};class m extends h.Entity{constructor(e){super(),this._owner=null,this.isUsable=!1,this.add(new c.Typed(i.default.ITEM.BASE,i.default.TYPE_ITEM)),this.add(new c.Item),this.add(new c.Physical),this.add(new c.Location);const t=new c.Named;t.setName(e),this.add(t)}setOwner(e){this._owner=e}getTopOwner(){let e=this._owner;for(;e&&e.getOwner;)e=e.getOwner();return e}getOwner(){return this._owner}getX(){return this._owner?this._owner.getX():this.get("Location").getX()}getY(){return this._owner?this._owner.getY():this.get("Location").getY()}getZ(){return this.getCell().getZ()}getXY(){return this._owner?this._owner.getXY():this.get("Location").getXY()}setXY(e,t){this.get("Location").setXY(e,t)}isAtXY(e,t){return this.get("Location").isAtXY(e,t)}getCell(){return this._owner?this._owner.getCell():this.get("Location").getCell()}getLevel(){return this._owner?this._owner.getLevel():this.get("Location").getLevel()}unsetLevel(){this.get("Location").unsetLevel()}setLevel(e){return this.get("Location").setLevel(e)}setName(e){this.get("Named").setName(e)}getName(){return this.get("Named").getFullName()}setWeight(e){this.get("Physical").setWeight(e)}getWeight(){return this.get("Physical").getWeight()}setValue(e){this.get("Item").setValue(e)}getValue(){return this.get("Item").getValue()}incrCount(e){this.get("Item").incrCount(e)}decrCount(e){this.get("Item").decrCount(e)}getCount(){return this.get("Item").getCount()}setCount(e){this.get("Item").setCount(e)}getType(){return this.get("Typed").getObjType()}setType(e){return this.get("Typed").setObjType(e)}getPropType(){return this.get("Typed").getPropType()}setPropType(e){return this.get("Typed").setPropType(e)}setDamageType(e){this.get("Item").setDamageType(e)}getDamageType(){return this.get("Item").getDamageType()}getNameWithCount(){return`${this.getName()} (x${this.getCount()})`}toString(){let e=this.getName()+", "+this.getType()+", ";return e+=(this.getWeight()*this.getCount()).toFixed(2)+"kg",e=this.getCount()+" x "+e,this.has("GemBound")&&(e+=" (Bound)"),this.has("Stats")&&(e+=" "+this.get("Stats").toString()),e}copy(e){this.setName(e.getName()),this.setType(e.getType()),this.setWeight(e.getWeight()),this.setValue(e.getValue()),e.useArgs&&(this.useArgs=e.useArgs),e.isUsable&&(this.useItem=e.useItem.bind(this));Object.values(e.getComponents()).forEach(e=>{this.add(e.clone())})}useItem(e){return!1}clone(){const e=new m(this.getName());return e.copy(this),e}equals(e){if(this.getType()!==e.getType())return!1;if(this.getID()===e.getID())return!0;let t=this.getName()===e.getName();return t=t&&this.getWeight()===e.getWeight(),t=t&&!(this.has("GemBound")||e.has("GemBound")),t}toJSON(){const e={setID:this.getID(),setName:this.getName(),setType:this.getType(),isUsable:this.isUsable};return e.components=l.compsToJSON(this),e}}t.ItemBase=m,t.Item.Base=m;class g extends m{constructor(e){super(e),this.setType(i.default.ITEM.FOOD),this._energy=0,this.isUsable=!0}setEnergy(e){this._energy=e}getEnergy(){return this._energy}useItem(e){if(e.hasOwnProperty("target")){const t=e.target;if(t.hasActors()){const e=t.getProp("actors")[0];if(e.has("Hunger")){let t=this.getConsumedEnergy();if(e.has("NourishedOne")&&(t*=3),e.get("Hunger").addEnergy(t),1===this.getCount()){const t={item:this};f.emitEvent(i.default.EVT_DESTROY_ITEM,t),i.default.gameMsg(e.getName()+" consumes "+this.getName())}else this.decrCount(1);return!0}i.default.gameWarn(e.getName()+" is not interested in eating.")}else i.default.gameWarn("There's no one to give food to.")}else i.default.err("ItemFood","useItem","No target given in obj.");return!1}getConsumedEnergy(){return Math.round(this.getWeight()*this._energy/.1)}toJSON(){const e=super.toJSON();return e.setEnergy=this.getEnergy(),e}clone(){const e=new t.Item.Food(this.getName());return e.copy(this),e.setEnergy(this.getEnergy()),e}}t.Food=g,t.Item.Food=g;class y extends m{constructor(e){super(e),this.setType(i.default.ITEM.CORPSE)}setActorName(e){this.actorName=e}getActorName(){return this.actorName}}t.Corpse=y,t.Item.Corpse=y;class v extends(u.Damage(m)){constructor(e){super(e),this.setType(i.default.ITEM.WEAPON),this._weaponType=""}copy(e){super.copy(e),this._weaponType=e.getWeaponType()}clone(){const e=new v(this.getName());return e.copy(this),e}setWeaponType(e){this._weaponType=e}getWeaponType(){return this._weaponType}toJSON(){const e=super.toJSON();return e.setWeaponType=this._weaponType,e}}t.Weapon=v,t.Item.Weapon=v;class b extends v{constructor(e){super(e),this.setType(i.default.ITEM.MISSILE_WEAPON),this._fireRate=1}setFireRate(e){this._fireRate=e}getFireRate(){return this._fireRate}copy(e){super.copy(e),this.setFireRate(e.getFireRate())}clone(){const e=new b(this.getName());return e.copy(this),e}equals(e){return!!super.equals(e)&&this._fireRate===e.getFireRate()}toJSON(){const e=super.toJSON();return e.setFireRate=this._fireRate,e}}t.MissileWeapon=b,t.Item.MissileWeapon=b;class _ extends v{constructor(e){super(e),this.setType(i.default.ITEM.AMMUNITION),this.add(new c.Ammo),this._ammoType=""}setAmmoType(e){this._ammoType=e}getAmmoType(){return this._ammoType}copy(e){super.copy(e),this.setAmmoType(e.getAmmoType())}clone(){const e=new _(this.getName());return e.copy(this),e}equals(e){return!!super.equals(e)&&this._ammoType===e.getAmmoType()}toJSON(){const e=super.toJSON();return e.setAmmoType=this._ammoType,e}}t.Ammo=_,t.Item.Ammo=_;class E extends(u.Defense(m)){constructor(e){super(e),this.setType(i.default.ITEM.ARMOUR),this._armourType=""}setArmourType(e){this._armourType=e}getArmourType(){return this._armourType}copy(e){super.copy(e),this.setArmourType(e.getArmourType())}clone(){const e=new E(this.getName());return e.copy(this),e}equals(e){let t=super.equals(e);return t=t&&this._armourType===e.getArmourType(),t}toJSON(){const e=super.toJSON();return e.setArmourType=this.getArmourType(),e}}t.Armour=E,t.Item.Armour=E;class S extends m{constructor(e){super(e),this.setType(i.default.ITEM.POTION),this.isUsable=!0}useItem(e){if(e.hasOwnProperty("target")){const t=e.target;if(t.hasActors()){const e=t.getProp("actors")[0],n=new p.Dice(1,10,2).roll();if(e.has("Health")){e.get("Health").addHP(n);const t=this.getOwner().getOwner();if(i.default.isActor(t)){const n=new c.UseItem;return n.setTarget(e),n.setItem(this),n.setUseType(i.default.USE.DRINK),t.add(n),!1}i.default.err("Item.Potion","useItem","Non-actor user encountered: "+t)}}else i.default.gameWarn("Cannot see anyone there for using the potion.")}else i.default.err("ItemPotion","useItem","No target given in obj.");return!1}clone(){const e=new t.Item.Potion(this.getName());return e.copy(this),e}}t.Potion=S,t.Item.Potion=S;class w extends m{constructor(e){super(e),this.setType(i.default.ITEM.RUNE),this._charges=1}getCharges(){return this._charges}setCharges(e){this._charges=e}clone(){const e=new w(this.getName());return e.copy(this),e}copy(e){super.copy(e),this.setCharges(e.getCharges())}equals(e){let t=super.equals(e);return!!e.getCharges&&(t=t&&this.getCharges()===e.getCharges(),t)}toString(){let e=super.toString();return e+=" charges: "+this.getCharges(),e}toJSON(){const e=super.toJSON();return e.setCharges=this.getCharges(),e}}t.Rune=w,t.Item.Rune=w;class C extends v{constructor(e){super(e),this.setType(i.default.ITEM.MISSILE)}clone(){const e=new C(this.getName());return e.copy(this),e}}t.Missile=C,t.Item.Missile=C;class O extends m{constructor(e){super("container"),this.setOwner(e),this._items=[],this._iter=0,this._removedItem=null}_addItem(e){let t=!1;for(let n=0;n<this._items.length;n++)if(this._items[n].equals(e)){this._items[n].incrCount(e.getCount()),t=!0;break}t||(e.setOwner(this),this._items.push(e))}getWeight(){let e=0;for(let t=0;t<this._items.length;t++)e+=this._items[t].getWeight()*this._items[t].getCount();return e}addItem(e){if(e.getCount()<=0){const t=JSON.stringify(e);i.default.warn("Container","addItem","Possible bug. Tried to add item with count 0: "+t)}"container"===e.getType()?this.getOwner()!==e?this._addItem(e):i.default.err("Item","addItem","Added item is container's owner. Impossible."):this._addItem(e)}getItems(){return this._items.slice()}hasItemRef(e){return-1!==this._items.indexOf(e)}hasItem(e){if(this.hasItemRef(e))return!0;return this._getMatchingItemIndex(e)>=0}hasItemWith(e){return this._items.findIndex(e)>=0}getItemsWith(e){return this._items.filter(e)}removeItem(e){return this.hasItem(e)?this._removeItem(e):(this._removedItem=null,!1)}_getMatchingItemIndex(e){for(let t=0;t<this._items.length;t++)if(e.equals(this._items[t]))return t;return-1}_removeItem(e){const t=this._getMatchingItemIndex(e);return-1===t?(i.default.err("ItemContainer","_removeItem","Negative index found. Horribly wrong."),!1):(1===this._items[t].getCount()?(this._removedItem=e,this._items.splice(t,1)):(this._removedItem=i.default.removeStackedItems(this._items[t],1),0===this._items[t].getCount()&&this._items.splice(t,1)),!0)}getRemovedItem(){return this._removedItem}removeNItems(e,t){let n=0;for(;n<t&&this.removeItem(e);)++n;return null===this._removedItem?(i.default.err("ItemContainer","removeNItems","this._removedItem was null. It should be a valid item."),!1):(this._removedItem.setCount(n),n>0)}first(){return this._items.length>0?(this._iter=1,this._items[0]):null}next(){return this._iter<this._items.length?this._items[this._iter++]:null}last(){return this._items[this._items.length-1]}isEmpty(){return 0===this._items.length}toString(){let e="Container: "+this.getName()+"\n";const t=this.getItems();for(let n=0;n<t.length;n++)e+=t[n].toString()+"\n";return e}toJSON(){const e=[],t=this.getItems();for(let n=0;n<t.length;n++)e.push(t[n].toJSON());return e}}t.Container=O,t.Item.Container=O;class T extends m{constructor(e){super(e),this.setType(i.default.ITEM.GOLD),this._purity=1}getPurity(){return this._purity}setPurity(e){this._purity=e}toJSON(){const e=super.toJSON();return e.setType=this.getType(),e.setPurity=this._purity,e}}t.Gold=T,t.Item.Gold=T;class M extends T{constructor(e){super(e||i.default.GOLD_COIN_NAME),this.setType(i.default.ITEM.GOLD_COIN),this._purity=1,this.setWeight(i.default.GOLD_COIN_WEIGHT)}}t.GoldCoin=M,t.Item.GoldCoin=M;class A extends m{constructor(e){super(e),this.setType(i.default.ITEM.SPIRITGEM),this._spirit=null,this._hasSpirit=!1}getArmourType(){return this.getType()}hasSpirit(){return this._hasSpirit}getSpirit(){return this._spirit}setSpirit(e){this._hasSpirit?i.default.err("Item.SpiritGem","setSpirit","Tried to overwrite spirit"):(this._hasSpirit=!0,this._spirit=e)}useItem(e){const t=this.getOwner().getOwner();if(t){const n=new c.SpiritBind;return n.setTarget(e.target),n.setBinder(t),this.add(n),!0}{const t="binder is null. obj: "+JSON.stringify(e);i.default.err("Item.SpiritGem","useItem",t)}return!1}clone(){const e=new A(this.getName());return e.copy(this),e}copy(e){super.copy(e),e.hasSpirit()&&this.setSpirit(e.getSpirit())}equals(e){let t=super.equals(e);return t=t&&this.getSpirit()===e.getSpirit(),t}toString(){let e=super.toString();if(this.hasSpirit()){const t=this.getSpirit().get("Stats");e+="("+this.getSpirit().getName()+")",e+=" Str: "+t.getStrength(),e+=" Agi: "+t.getAgility(),e+=" Acc: "+t.getAccuracy(),e+=" Wil: "+t.getWillpower()}else e+="(Empty)";return e}toJSON(){const e=super.toJSON();return e.hasSpirit=this.hasSpirit(),e.hasSpirit&&(e.setSpirit=this.getSpirit().toJSON()),e}}t.SpiritGem=A,t.Item.SpiritGem=A;for(let e=0;e<i.default.GET_STATS.length;e++)A.prototype[i.default.GET_STATS[e]]=function(){return(()=>{const t=i.default.GET_STATS[e];return this._hasSpirit?this._spirit.get("Stats")[t]():0})()};class N extends m{constructor(e){super(e),this.setType(i.default.ITEM.MINERAL)}}t.Mineral=N,t.Item.Mineral=N;class x extends m{constructor(e){super(e),this.setType(i.default.ITEM.BOOK),this.text=[],this.metaData={}}addMetaData(e,t){this.metaData.hasOwnProperty[e]||(this.metaData[e]=[]),this.metaData[e].push(t)}setMetaData(e){this.metaData=e}getMetaData(e){return this.metaData[e]}useItem(){const e=this.getTopOwner();if(i.default.isActor(e)){const t=new c.Read;return t.setReadTarget(this),e.add(t),!0}return!1}getText(){return this.text}addText(e){this.text.push(e)}setText(e){this.text=e}clone(){const e=new x(this.getName());return e.copy(this),e}copy(e){super.copy(e);const t=e.getText().slice();this.setText(t),this.metaData=JSON.parse(JSON.stringify(e.metaData))}equals(e){return this.getID()===e.getID()}toJSON(){const e=super.toJSON();return e.setText=this.text,e.setMetaData=this.metaData,e}}t.Book=x,t.Item.Book=x},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(42);t.default=class{constructor(e=s.DEFAULT_WIDTH,t=s.DEFAULT_HEIGHT){this._width=e,this._height=t}_fillMap(e){const t=[];for(let n=0;n<this._width;n++){t.push([]);for(let s=0;s<this._height;s++)t[n].push(e)}return t}getCols(){return this._width}getRows(){return this._height}getCenterXY(){return[Math.floor(this._width/2),Math.floor(this._height/2)]}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=!("undefined"==typeof window||!window.document||!window.document.createElement),e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KEYS=t.DIRS=t.DEFAULT_HEIGHT=t.DEFAULT_WIDTH=void 0,t.DEFAULT_WIDTH=80,t.DEFAULT_HEIGHT=25,t.DIRS={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},t.KEYS={VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95}},function(e,t){var n,s,r=e.exports={};function a(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function i(e){if(n===setTimeout)return setTimeout(e,0);if((n===a||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:a}catch(e){n=a}try{s="function"==typeof clearTimeout?clearTimeout:o}catch(e){s=o}}();var l,c=[],u=!1,h=-1;function d(){u&&l&&(u=!1,l.length?c=l.concat(c):h=-1,c.length&&p())}function p(){if(!u){var e=i(d);u=!0;for(var t=c.length;t;){for(l=c,c=[];++h<t;)l&&l[h].run();h=-1,t=c.length}l=null,u=!1,function(e){if(s===clearTimeout)return clearTimeout(e);if((s===o||!s)&&clearTimeout)return s=clearTimeout,clearTimeout(e);try{s(e)}catch(t){try{return s.call(null,e)}catch(t){return s.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function m(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new f(e,t)),1!==c.length||u||i(p)},f.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=m,r.addListener=m,r.once=m,r.off=m,r.removeListener=m,r.removeAllListeners=m,r.emit=m,r.prependListener=m,r.prependOnceListener=m,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(e,t,n){var s=n(282),r="object"==typeof self&&self&&self.Object===Object&&self,a=s||r||Function("return this")();e.exports=a},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorldShop=t.WorldTop=t.BattleZone=t.CityQuarter=t.City=t.MountainSummit=t.MountainFace=t.Mountain=t.Area=t.AreaTile=t.Dungeon=t.Branch=t.SubZoneBase=t.ZoneBase=t.WorldBase=t.edgeHasConnections=t.addExitsToEdge=t.World=void 0;const i=n(15)("bitn:world"),l=o(n(4)),c=a(n(16)),u=n(23),h=n(9),d=n(28),p=a(n(11)),f=n(160),m=n(55),g=n(31),y=u.EventPool.getPool(),v=c.ElementStairs;t.World={};const b=h.Random.getRNG(),_={east:"west",north:"south",south:"north",west:"east"};function E(e,t,n){const s=e.getMap().getCell(t,n);if(s.hasConnection()){const r=s.getConnection();i(`world.js Removing conn@${t},${n}`),e.removeElement(r,t,n)||l.default.err("world.ts","removeExistingConnection",`Failed to remove conn @ ${t}, ${n}`)}}function S(e,t,n){const s=t.find(t=>t.getName()===e);if(s){const t=s.getLevels();if(t.length>n)return t[n];{const s="Name: "+e;l.default.err("world.js","findLevel",`${s} nLev ${n} out of bounds (${t.length-1})`)}}return null}function w(e){let t=e.getMap().getFree();t=b.shuffle(t);let n=t.shift();for(;n&&n.hasConnection();)n=t.shift();return n}function C(e){const t=e.length,n=[],s=[];for(let r=0;r<t;r++){const a=e[r];let o=null;if(a.hasExtras()&&(o=a.getExtras()),r<t-1){const t=e[r+1],s=new v("stairsDown",a,t),i=w(a);let[l,c]=[i.getX(),i.getY()];o&&o.endPoint&&([l,c]=o.endPoint),a.addStairs(s,l,c),n.push(s)}if(r>0){const t=e[r-1],n=new v("stairsUp",a,t),i=w(a);let[l,c]=[i.getX(),i.getY()];o&&o.startPoint&&([l,c]=o.startPoint),a.addStairs(n,l,c),s.push(n)}}for(let e=0;e<t;e++)e<t-1&&n[e].connect(s[e])}function O(e,t,n){let s=t,r=n;if("string"==typeof t&&"string"==typeof n){const a=e.find(e=>e.getName()===t),o=e.find(e=>e.getName()===n);a&&o?(s=a,r=o):l.default.err("world.ts","getSubZoneArgs",`No sub-zones found for ${t} and ${n}`)}return[s,r]}t.addExitsToEdge=(e,t="passage",n="any",s=!1)=>{const r=e.getMap(),a=r.cols,o=r.rows,i=[];for(let l=1;l<o-1;l++){if(("any"===n||"west"===n)&&(r.isPassable(0,l,1,l)||s)){const n=new v(t,e);E(e,0,l),s?e.addStairs(n,0,l):e.addElement(n,0,l),i.push(n)}if(("any"===n||"east"===n)&&(r.isPassable(a-1,l,a-2,l)||s)){const n=new v(t,e);E(e,a-1,l),s?e.addStairs(n,a-1,l):e.addElement(n,a-1,l),i.push(n)}}for(let l=1;l<a-1;l++){if(("any"===n||"north"===n)&&(r.isPassable(l,0,l,1)||s)){const n=new v(t,e);E(e,l,0),s?e.addStairs(n,l,0):e.addElement(n,l,0),i.push(n)}if(("any"===n||"south"===n)&&(r.isPassable(l,o-1,l,o-2)||s)){const n=new v(t,e);E(e,l,o-1),s?e.addStairs(n,l,o-1):e.addElement(n,l,o-1),i.push(n)}}return i},t.World.connectAreaConnToLevel=(e,t,n)=>{const s=t.getConnections();e.connect(s[0]);for(let t=1;t<s.length;t++)s[t].setTargetLevel(n),s[t].setTargetStairs(e)},t.edgeHasConnections=(e,t)=>{const n=e.getMap(),s=n.cols,r=n.rows;for(let e=1;e<r-1;e++){if(("any"===t||"west"===t)&&n.getCell(0,e).hasConnection())return!0;if(("any"===t||"east"===t)&&n.getCell(s-1,e).hasConnection())return!0}for(let e=1;e<s-1;e++){if(("any"===t||"north"===t)&&n.getCell(e,0).hasConnection())return!0;if(("any"===t||"south"===t)&&n.getCell(e,r-1).hasConnection())return!0}return!1},t.World.connectLevelsLinear=C,t.World.addExitsToEdge=t.addExitsToEdge,t.World.edgeHasConnections=t.edgeHasConnections;class T extends m.Entity{constructor(e){super(),this.name=e,this.type="base",this.parent=null}getName(){return this.name}getHierName(){return this.hierName}setHierName(e){this.hierName=e}getType(){return this.type}setType(e){this.type=e}getParent(){return this.parent}setParent(e){this.parent=e}toJSON(){const e={hierName:this.hierName,id:this.getID(),name:this.name,type:this.type};return this.parent&&(e.parent=this.parent.getID()),e.components=p.compsToJSON(this),e}}t.WorldBase=T,t.World.Base=T;class M extends T{constructor(e){super(e),this._subZones=[]}getSubZoneArgs(e,t){return O(this._subZones,e,t)}setTileXY(e,t){this.tileX=e,this.tileY=t}getTileXY(){return[this.tileX,this.tileY]}addSubZone(e){return e.getID()===this.getID()&&l.default.err("ZoneBase","addSubZone","Tried to add itself as sub zone: "+this.getName()),!l.default.isNullOrUndef([e])&&(e.setParent(this),this._subZones.push(e),!0)}hasSubZone(e){return this._subZones.indexOf(e)>=0}getLevels(){let e=[];return this._subZones.forEach(t=>{e=e.concat(t.getLevels())}),e}getPlaceEntities(){const e=[this];return this._subZones.forEach(t=>{e.push(t)}),e}connectSubZones(e,t,n,s){!function(e,t,n,s,r){l.default.isNullOrUndef([s,r])&&l.default.err("World","connectSubZones",`l1 (${s}) and l2 (${r}) must be non-null and integers.`);const[a,o]=O(e,t,n);l.default.isNullOrUndef([a,o])&&l.default.err("World","connectSubZones","Cannot connect null subZones. Check the names/refs.");let i=!0;s>r&&(i=!1);const c=new v(i?"stairsDown":"stairsUp"),u=o.getLevels();if(r<u.length){const e=w(u[r]);u[r].addStairs(c,e.getX(),e.getY()),c.setSrcLevel(u[r]),a.connectLevelToStairs(s,c)}else l.default.err("World","connectSubZones","Level "+r+" doesn't exist in sub-zone "+o.getName())}(this._subZones,e,t,n,s)}findLevel(e,t){return S(e,this._subZones,t)}findSubZone(e){return function(e,t){return t.find(t=>t.getName()===e)}(e,this._subZones)}getEntrances(){const e=[];return this._subZones.forEach(t=>{const n=t.getEntrance();n&&e.push(n)}),e}removeListeners(){this._subZones.forEach(e=>{e.removeListeners()})}toJSON(){const e=super.toJSON();return e.x=this.tileX,e.y=this.tileY,e}getID2Place(){const e={[this.getID()]:this};return this._subZones.forEach(t=>{e[t.getID()]=t}),e}}t.ZoneBase=M,t.World.ZoneBase=M;class A extends T{constructor(e){super(e),this._levelFeatures=new Map,this._levels=[],this._levelCount=0,this._entrance=null}getEntrance(){return function(e,t){if(null===t)return null;const{x:n,y:s}=t;return e[t.levelNumber].getMap().getCell(n,s).getStairs()}(this._levels,this._entrance)}setEntranceLocation(e){l.default.isNullOrUndef([e])?l.default.err("SubZoneBase","setEntranceLocation","Arg |entrance| is null/undef."):this._entrance=e}getLevelN(e){if(e<this._levels.length)return this._levels[e];{const t=this._levels.length;l.default.err("SubZoneBase","getLevels",`No nLevel ${e} found. Max: ${t}`)}return null}getLevels(){return this._levels.slice()}hasLevel(e){return this._levels.indexOf(e)>=0}connectLevelToStairs(e,t){(function(e,t,n){if(t<e.length){const s=e[t],r=n.getSrcLevel();if(!l.default.isNullOrUndef([r])){const e=!n.isDown(),t=new v(e?"stairsDown":"stairsUp",s,r),a=w(s);return s.addStairs(t,a.getX(),a.getY()),t.connect(n),!0}}else l.default.err("world.js","connectLevelToStairs",`nLevel: ${t} out of bounds (${e.length})`);return!1})(this._levels,e,t)||l.default.err("SubZoneBase","connectLevelToStairs","Stairs must be first connected to other level.")}getStairsOther(){return function(e,t){const n=[];return t.forEach(t=>{t.getStairs().forEach(t=>{const s=t.getTargetLevel();if(s&&s.getParent){const r=s.getParent();r&&r.getName()!==e&&n.push(t)}})}),n}(this.getName(),this._levels)}addLevelFeature(e){const t=e.getType();this._levelFeatures.has(t)||(this._levelFeatures[t]=[]),this._levelFeatures[t].push(e)}removeListeners(){}getLevel(e){if(e<this._levels.length)return this._levels[e];{const t=`${this.getType()}, ${this.getName()}`,n=`Has ${this._levels.length} levels`;l.default.err("SubZoneBase","getLevel",`${t}, nLevel: ${e}, ${n}`)}return null}addLevel(e){if(l.default.isNullOrUndef([e]))l.default.err("SubZoneBase","addLevel","Level is not defined.");else if(this.hasLevel(e)){let t="Trying to add existing level. ";t+=" ID: "+e.getID(),l.default.err("SubZoneBase","addLevel",t)}else e.setLevelNumber(this._levelCount++),this._levels.push(e),e.setParent(this)}toJSON(){const e=super.toJSON();return e.nLevels=this._levels.length,e.levels=this._levels.map(e=>e.getID()),this._entrance&&(e.entrance=this._entrance),e}}t.SubZoneBase=A,t.World.SubZoneBase=A;class N extends A{constructor(e){super(e),this.setType("branch")}addEntrance(e){const t=new v("stairsUp");this.setEntrance(t,e)}setEntrance(e,t){if(t<this._levels.length){const n=this._levels[t],s=w(n);let[r,a]=s.getXY();if(n.hasExtras()){const e=n.getExtras();if(e.startPoint){[r,a]=e.startPoint;if(n.getMap().getCell(r,a).hasConnection()){let t=`@${r},${a} already has connection. `;t+=`start: ${e.startPoint} end: ${e.endPoint}`,l.default.err("Branch","setEntrance",t)}}}n.addStairs(e,r,a),this._entrance={levelNumber:t,x:r,y:a}}else l.default.err("World.Branch","setEntrance","Invalid level number. Must be < "+this._levels.length)}connectLevels(){C(this._levels)}}t.Branch=N,t.World.Branch=N;class x extends M{constructor(e){super(e),this.setType("dungeon"),this._entranceNames=[]}hasBranch(e){return this.hasSubZone(e)}getBranches(){return this._subZones}setEntrance(e){this._entranceNames="string"==typeof e?[e]:e}addBranch(e){return!this.hasBranch(e)&&(this._subZones.push(e),e.setParent(this),1===this._subZones.length&&this.setEntrance(e.getName()),!0)}getEntrances(){const e=[],t=this._subZones.length;for(let n=0;n<t;n++){const t=this._subZones[n];if(this._entranceNames.indexOf(t.getName())>=0){const n=t.getEntrance();l.default.isNullOrUndef([n])||e.push(n)}}return e}toJSON(){const e=super.toJSON(),t={branch:this._subZones.map(e=>e.toJSON()),entranceNames:this._entranceNames,nBranches:this._subZones.length};return Object.assign(t,e)}}t.Dungeon=x,t.World.Dungeon=x;class P{constructor(e,t,n){this._tileX=e,this._tileY=t,this._area=n,this.cols=null,this.rows=null,this._level=null,this.zones={Dungeon:[],Mountain:[],City:[],BattleZone:[]}}getLevel(){return this._level}getTileX(){return this._tileX}getTileY(){return this._tileY}isNorthEdge(){return 0===this._tileY}isSouthEdge(){return this._tileY===this._area.getSizeY()-1}isWestEdge(){return 0===this._tileX}isEastEdge(){return this._tileX===this._area.getSizeX()-1}isEdge(){return!!this.isNorthEdge()||(!!this.isSouthEdge()||(!!this.isWestEdge()||!!this.isEastEdge()))}setLevel(e){this._level=e,this.cols=this._level.getMap().cols,this.rows=this._level.getMap().rows}connect(e,t){const n=this.cols-1,s=this.rows-1;if(e){const t=e.getLevel(),r=this._level.getMap(),a=t.getMap();for(let e=1;e<=s-1;e++){const s=r.getCell(n,e),o=a.getCell(0,e);if(s.isFree()&&o.isFree()){const s=new v("passage",this._level,t),r=new v("passage",t,this._level);s.setTargetStairs(r),r.setTargetStairs(s),this._level.addStairs(s,n,e),t.addStairs(r,0,e)}}}if(t){const e=t.getLevel(),r=this._level.getMap(),a=e.getMap();for(let t=1;t<=n-1;t++){const n=r.getCell(t,s),o=a.getCell(t,0);if(n.isFree()&&o.isFree()){const n=new v("passage",this._level,e),r=new v("passage",e,this._level);n.setTargetStairs(r),r.setTargetStairs(n),this._level.addStairs(n,t,s),e.addStairs(r,t,0)}}}}addZone(e,t){l.default.isNullOrUndef([t.tileX,t.tileY])&&l.default.err("AreaTile","addZone","No tileX/tileY given!"),this.zones[e]||(this.zones[e]=[]),this.zones[e].push(t)}getZones(e){if(e)return this.zones[e];let t=[];return Object.keys(this.zones).forEach(e=>{t=t.concat(this.zones[e])}),t}getLevels(){let e=[this._level];if(Object.keys(this.zones).forEach(t=>{this.zones[t].forEach(t=>{e=e.concat(t.getLevels())})}),i.enabled){let t=this.toString();t=` Tile ${t} has ${e.length} levels from toJSON()`,1344===this._level.getID()&&(t+="\tLevels: "+e.map(e=>e.getID())),console.error(t)}return e}getPlaceEntities(){let e=[];return Object.keys(this.zones).forEach(t=>{this.zones[t].forEach(t=>{e=e.concat(t.getPlaceEntities())})}),e}toString(){let e=`${this._tileX},${this._tileY}, ID: ${this._level.getID()}`;return e+=" nZones: "+this.getZones().length,e}toJSON(){return{isJSON:!0,x:this._tileX,y:this._tileY,level:this._level.getID(),levels:this.getLevels().map(e=>e.toJSON()),nDungeons:this.zones.Dungeon.length,dungeon:this.getZones("Dungeon").map(e=>e.toJSON()),nMountains:this.zones.Mountain.length,mountain:this.getZones("Mountain").map(e=>e.toJSON()),nCities:this.zones.City.length,city:this.getZones("City").map(e=>e.toJSON()),nBattleZones:this.zones.BattleZone.length,battlezone:this.getZones("BattleZone").map(e=>e.toJSON())}}removeListeners(){Object.values(this.zones).forEach(e=>{e.forEach(e=>{e.removeListeners()})})}}t.AreaTile=P,t.World.AreaTile=P;class I extends T{constructor(e,t,n,s,r,a){super(e),this.setType("area"),this._sizeX=parseInt(t,10),this._sizeY=parseInt(n,10),this._cols=s||30,this._rows=r||30,this._tiles=[],this._conf=this.createAreaConfig(),this.zonesCreated={},this.tileStatus=[],this._init(a)}getSizeX(){return this._sizeX}getSizeY(){return this._sizeY}isLoaded(e,t){return this.tileStatus[e][t]===f.LoadStat.LOADED}isJSON(e,t){return this.tileStatus[e][t]===f.LoadStat.JSON}isOnDisk(e,t){return this.tileStatus[e][t]===f.LoadStat.ON_DISK}setLoaded(e,t){this.tileStatus[e][t]=f.LoadStat.LOADED}setUnloaded2JSON(e,t){this.tileStatus[e][t]=f.LoadStat.JSON}setOnDisk(e,t,n){this.setTile(e,t,n),this.tileStatus[e][t]=f.LoadStat.ON_DISK}markAllZonesCreated(){Object.keys(this.zonesCreated).forEach(e=>{this.zonesCreated[e]=!0})}markTileZonesCreated(e,t){this.zonesCreated[e+","+t]=!0}tileHasZonesCreated(e,t){return this.zonesCreated[e+","+t]}getTiles(){return this._tiles}setTile(e,t,n){this._tiles[e][t]=n}setConf(e){e?this._conf=e:l.default.err("World.Area","setConf","Null/undef conf was set")}getConf(){return this._conf}_init(e){for(let t=0;t<this._sizeX;t++){const n=[];this.tileStatus.push([]);for(let s=0;s<this._sizeY;s++){this.zonesCreated[t+","+s]=!1;const r=new P(t,s,this),a=l.default.getForestConf(this._cols,this._rows);let o=null;if(e)o=e[t][s];else{o=(new d.FactoryLevel).createLevel("forest",this._cols,this._rows,a)}o!==l.default.LEVEL_NOT_LOADED?(this.tileStatus[t][s]=f.LoadStat.LOADED,o.setParent(this),r.setLevel(o),n.push(r)):(this.tileStatus[t][s]=f.LoadStat.JSON,n.push(l.default.TILE_NOT_LOADED))}this._tiles.push(n)}e||this.connectTiles()}connectTiles(){!function(e,t,n){1!==t&&1!==n||l.default.err("world.js","connectTiles","sizeX or sizeY == 1 not implemented.");for(let s=0;s<t;s++)for(let r=0;r<n;r++)i(`Trying to connect tile ${s},${r} now`),s<t-1&&r<n-1?(i(`>> Connecting tile ${s},${r} now`),e[s][r].connect(e[s+1][r],e[s][r+1])):s<t-1?(i(`>> Connecting tile ${s},${r} now`),e[s][r].connect(e[s+1][r],null)):r<n-1&&(i(`>> Connecting tile ${s},${r} now`),e[s][r].connect(null,e[s][r+1]))}(this._tiles,this._sizeX,this._sizeY)}getLevels(){let e=[];for(let t=0;t<this._tiles.length;t++)for(let n=0;n<this._tiles[t].length;n++)this.isLoaded(t,n)&&(e=e.concat(this._tiles[t][n].getLevels()));return e}findTileXYById(e){for(let t=0;t<this._tiles.length;t++)for(let n=0;n<this._tiles[t].length;n++)if(this.isLoaded(t,n)){const s=this._tiles[t][n].getLevel().getID();try{if(s===e)return[t,n]}catch(e){let s=`Area ${this.getID()} ERROR`;throw s+=`\nFailed to call getLevel for tile ${t},${n}`,s+="Tile as JSON: ', this._tiles[x][y]",console.error(s),new Error(e)}}return this.printLevelIDs(),null}hasTileWithId(e){for(let t=0;t<this._tiles.length;t++)for(let n=0;n<this._tiles[t].length;n++)if(this.isLoaded(t,n)){if(this._tiles[t][n].getLevel().getID()===e)return!0}else if(this.isJSON(t,n)){if(this._tiles[t][n].level===e)return!0}else if(this._tiles[t][n].level===e)return!0;return!1}hasTiles(e){let t=e.length>0;return e.forEach(e=>{if("function"==typeof e.getID)t=t&&this.hasTileWithId(e.getID());else if(Number.isInteger(e))t=t&&this.hasTileWithId(e);else{const t=JSON.stringify(e);l.default.err("Area","hasTiles",`Invalid level given ${t}. Must be Map.Level/ID`)}}),t}getTileXY(e,t){if(e>=0&&e<this.getSizeX()&&t>=0&&t<this.getSizeY())return this._tiles[e][t];{const n=this.getSizeX(),s=this.getSizeY();l.default.err("Area","getTileXY",`Tile x,y (${e}, ${t}) is out of bounds (${n}, ${s}).`)}return null}addZone(e,t){if(l.default.isNullOrUndef([t.tileX,t.tileY])&&l.default.err("Area","addZone","No tileX/tileY given!"),this.isLoaded(t.tileX,t.tileY))this._tiles[t.tileX][t.tileY].addZone(e,t),t.setParent(this);else{const[e,n]=[t.tileX,t.tileY];l.default.err("Area","addZone",`Tried to add zone@${e},${n} to unloaded/onDisk tile`)}}getZones(e){let t=[];for(let n=0;n<this._tiles.length;n++)for(let s=0;s<this._tiles[n].length;s++)if(this.isLoaded(n,s)){const r=this._tiles[n][s];t=t.concat(r.getZones(e))}return t}createAreaConfig(){return{name:this.getName(),maxX:this._sizeX,maxY:this._sizeY,cols:this._cols,rows:this._rows,city:[],dungeon:[],mountain:[]}}toJSON(){const e=super.toJSON(),t=[];this._tiles.forEach((e,n)=>{const s=e.map((e,t)=>this.isLoaded(n,t)?e.toJSON():e);t.push(s)});const n={isJSON:!0,conf:this.getConf(),maxX:this._sizeX,maxY:this._sizeY,cols:this._cols,rows:this._rows,tiles:t,tileStatus:this.tileStatus,zonesCreated:this.zonesCreated};return n.conf||l.default.err("World.Area","toJSON","Null conf in Area"),Object.assign(n,e)}forEachTileLoaded(e){for(let t=0;t<this._tiles.length;t++)for(let n=0;n<this._tiles[t].length;n++)this.isLoaded(t,n)&&e(t,n,this._tiles[t][n])}forEachTile(e){for(let t=0;t<this._tiles.length;t++)for(let n=0;n<this._tiles[t].length;n++)e(t,n,this._tiles[t][n])}getPlaceEntities(){let e=[this];return this.forEachTileLoaded((t,n,s)=>{e=e.concat(s.getPlaceEntities())}),e}printLevelIDs(){const e=[];this.forEachTile((t,n,s)=>{if(this.isLoaded(t,n)){const s=this._tiles[t][n];e.push(s.getLevel().getID())}else if(this.isJSON(t,n)){const s=this._tiles[t][n];e.push(s.level)}})}printDebugInfo(){const e=[],t=[],n=[];this.forEachTile((s,r,a)=>{a.isJSON?e.push([s,r]):this.isLoaded(s,r)?t.push([s,r]):n.push([s,r])});let s=`Area ID ${this.getID()} debug info:\n`;s+="\t\nTiles as JSON: "+e.join(" | "),s+="\t\nTiles LOADED: "+t.join(" | "),s+="\t\nTiles OTHER: "+n.join(" | "),this.printLevelIDs(),console.log(s)}}t.Area=I,t.World.Area=I;class D extends M{constructor(e){super(e),this.setType("mountain")}findLevel(e,t){const n=this.getFaces(),s=this.getSummits();let r=S(e,n,t);return r||(r=S(e,s,t)),r}addSummit(e){this.addSubZone(e)}addFace(e){this.addSubZone(e)}getFaces(){return this._subZones.filter(e=>"face"===e.getType())}getSummits(){return this._subZones.filter(e=>"summit"===e.getType())}connectFaceAndSummit(e,t,n,s){const[r,a]=this.getSubZoneArgs(e,t);if("summit"!==a.getType()){const e=a.getType();l.default.err("World.Mountain","connectFaceAndSummit","Expected 2nd arg summit, got: "+e)}const o=r.getLevelN(n),i=a.getLevelN(s);!function(e,t){const n=e.level,s=t.level;let r=Math.floor(n.getMap().cols/2),a=e.y();const o=n.getMap();let i=o.getCell(r,a);for(;i.hasConnection()||!i.isFree();)r+=1,r===o.cols&&(r=0,++a),i=o.getCell(r,a);const l=w(s),[c,u]=[l.getX(),l.getY()],h=new v("stairsUp",n,s),d=new v("stairsDown",s,n);h.connect(d),n.addStairs(h,r,a),s.addStairs(d,c,u)}({y:()=>0,level:o},{level:i}),g.MountainGenerator.connectFaceAndSummit(o,i)}connectSubZones(e,t,n,s){const[r,a]=this.getSubZoneArgs(e,t);if("face"===r.getType()){if("summit"===a.getType())return void this.connectFaceAndSummit(r,a,n,s)}else if("summit"===r.getType()&&"face"===a.getType())return void this.connectFaceAndSummit(a,r,s,n);super.connectSubZones(e,t,n,s)}toJSON(){const e=super.toJSON(),t={nFaces:this.getFaces().length,face:this.getFaces().map(e=>e.toJSON()),nSummits:this.getSummits().length,summit:this.getSummits().map(e=>e.toJSON())};return Object.assign(t,e)}}t.Mountain=D,t.World.Mountain=D;class k extends A{constructor(e){super(e),this.setType("face")}setEntrance(e){this._entrance=e}addEntrance(e){if(null===this._entrance){const t=this._levels[e],n=new v("stairsDown",t),s=t.getMap(),r=Math.floor(s.cols/2);let a=r,o=s.rows-1;for(;!s.getCell(a,o).isFree();)0===a&&(a=r+1),a<=r&&--a,a>r&&++a,a===s.cols-1&&(a=r,--o);t.addStairs(n,a,o),this._entrance={levelNumber:e,x:a,y:o}}else l.default.err("MountainFace","addEntrance","Entrance already added.")}}t.MountainFace=k,t.World.MountainFace=k;class L extends A{constructor(e){super(e),this.setType("summit")}getEntrance(){return null}addEntrance(e){if(null===this._entrance){const t=this._levels[e],n=new v("stairsDown",t),s=t.getMap(),r=Math.floor(s.cols/2),a=s.rows-1;t.addStairs(n,r,a)&&(this._entrance={levelNumber:e,x:r,y:a})}}}t.MountainSummit=L,t.World.MountainSummit=L;class R extends M{constructor(e){super(e),this.setType("city")}getQuarters(){return this._subZones}abutQuarters(e,n,s,r){return function(e,n,s,r,a){const o=b.arrayGetRand(["north","south","east","west"]),i=_[o],[c,u]=O(e,n,s);l.default.isNullOrUndef([r,a])&&l.default.err("World","connectSubZonesEdges",`l1 (${r}) and l2 (${a}) must be non-null and integers.`);const h=c.getLevel(r),d=u.getLevel(a);h||l.default.err("world.ts","connectSubZoneEdges",`No level |${r}| in subzone ${JSON.stringify(c)}`),d||l.default.err("world.ts","connectSubZoneEdges",`No level |${a}| in subzone ${JSON.stringify(u)}`);const p=t.addExitsToEdge(h,"exit",o,!0),f=t.addExitsToEdge(d,"exit",i,!0);if(0===p.length||0===f.length)return!1;const m=p,g=f,y=m.length,v=g.length,E=y<=v?y:v;for(let e=0;e<E;e++)m[e].connect(g[e]);return!0}(this._subZones,e,n,s,r)}toJSON(){const e=super.toJSON(),t={nQuarters:this._subZones.length,quarter:this._subZones.map(e=>e.toJSON())};return Object.assign(t,e)}}t.City=R,t.World.City=R;class B extends A{constructor(e){super(e),this.setType("quarter"),this._shops=[]}removeListeners(){this._shops.forEach(e=>{e.isAbandoned()||y.removeListener(e)})}addShop(e){this._shops.push(e)}getShops(){return this._shops}addEntrance(e){if(null===this._entrance){const t=this._levels[e],n=new v("stairsDown",t);t.addStairs(n,1,1),this._entrance={levelNumber:e,x:1,y:1}}else l.default.err("CityQuarter","addEntrance","Entrance already added.")}connectLevels(){C(this._levels)}toJSON(){const e=super.toJSON(),t={shops:this._shops.map(e=>e.toJSON())};return Object.assign(t,e)}}t.CityQuarter=B,t.World.CityQuarter=B;class F extends M{constructor(e){super(e),this.setType("battlezone"),this._levels=[]}setBattle(e){this._battle=e,e.setParent(this)}getBattle(){return this._battle}addLevel(e){this._levels.push(e)}getLevels(){return this._levels}toJSON(){const e=super.toJSON(),t=this._levels.length,n={nLevels:t,levels:this._levels.map(e=>e.getID())};return 0===t&&l.default.err("World.BattleZone","toJSON",`Bz ${this.getName()} called without levels`),Object.assign(n,e)}}t.BattleZone=F,t.World.BattleZone=F;class G extends T{constructor(e){super(e),this.setType("world"),this._areas=[],this.currAreaIndex=0,this._conf={name:e,area:[],nAreas:0}}getConf(){return this._conf}setConf(e){this._conf=e}addArea(e){e.setParent(this),this._areas.push(e)}getLevels(){let e=[];return this._areas.map(t=>{e=e.concat(t.getLevels())}),e}getAreas(){return this._areas}getZones(e){let t=[];return this._areas.forEach(n=>{t=t.concat(n.getZones(e))}),t}findZone(e){return this.getZones().filter(e)}getStairs(){const e=[];return this.getZones().forEach(t=>t.getLevels().forEach(t=>t.getStairs().forEach(t=>e.push(t)))),e}getPlaceEntities(){let e=[this];return this._areas.map(t=>{e=e.concat(t.getPlaceEntities())}),e}getCurrentArea(){return this._areas[this.currAreaIndex]}toJSON(){const e=super.toJSON(),t=this._areas.map(e=>e.toJSON());let n=!0;this.getConf().hasOwnProperty("createAllZones")&&(n=!!this.getConf().createAllZones);const s={conf:this.getConf(),nAreas:this._areas.length,area:t,createAllZones:n};return s.conf.area||(s.conf.area=this.createAreaConfig()),Object.assign(s,e)}createAreaConfig(){const e=[];return this._areas.forEach(t=>{e.push(t.createAreaConfig())}),e}getID2Place(){let e={[this.getID()]:this};this._areas.forEach(t=>{e[t.getID()]=t});return this.getZones().forEach(t=>{e[t.getID()]=t;const n=t.getID2Place();e=Object.assign(e,n)}),e}}t.WorldTop=G,t.World.WorldTop=G;class j{constructor(){this._shopkeeper=null,this._level=null,this._coord=[],this._isAbandoned=!1,this.hasNotify=!0}setLevel(e){this._level=e}setCoord(e){this._coord=e}isAbandoned(){return this._isAbandoned}notify(e,t){this._shopkeeper&&t.actor.getID()===this._shopkeeper.getID()&&(this.setShopAbandoned(),y.removeListener(this))}getLevel(){return this._level}getShopkeeper(){return this._shopkeeper}setShopkeeper(e){e?(this._shopkeeper=e,y.listenEvent(l.default.EVT_ACTOR_KILLED,this)):l.default.err("WorldShop","setShopkeeper","Tried to set null shopkeeper")}setShopAbandoned(){this._isAbandoned=!0,this._shopkeeper=null,this._coord.forEach(e=>{const t=this.getCell(e);t.getShop().abandonShop();const n=t.getItems();n&&n.forEach(e=>{e.has("Unpaid")&&e.remove("Unpaid")})})}getCell(e){return this._level.getMap().getCell(e[0],e[1])}reclaimShop(e){this._isAbandoned&&(this._isAbandoned=!1,this.setShopkeeper(e),this._coord.forEach(t=>{const n=this.getCell(t);n.getShop().reclaim(e);const s=n.getItems();s&&s.forEach(e=>{e.has("Unpaid")||e.add(new p.Unpaid)})}))}emptyCells(){const e=[];return this._coord.forEach(t=>{const n=this._level.getMap().getCell(t[0],t[1]);n.hasItems()||e.push(n)}),e}refreshShopItems(e){let t=0;this._coord.forEach(n=>{this._level.getMap().getCell(n[0],n[1]).hasItems()||t<e.length&&(e[t].add(new p.Unpaid),this._level.addItem(e[t],n[0],n[1]),++t)})}toJSON(){const e={isAbandoned:this._isAbandoned,level:this._level.getID(),coord:this._coord};return this._isAbandoned||(e.shopkeeper=this._shopkeeper.getID()),e}}t.WorldShop=j,t.World.WorldShop=j,t.World.isZone=function(e){if(e.getType){const t=e.getType();return/(city|battlezone|mountain|dungeon)/.test(t)}return!1}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CellMap=void 0;const r=s(n(4)),a=n(223),o=n(16),i=n(18),l=n(693),c=new o.ElementBase("floor"),u=new o.ElementWall("wall");class h{constructor(e,t,n=c){this._map=[],this.cols=e,this.rows=t,this._isRowOptimized=!1,"number"==typeof this.cols&&"number"==typeof this.rows||r.default.err("Map.CellList","constructor","Map.CellList(rows, cols) expects 2 integers."),this._map=new Array(this.cols);for(let e=0;e<this.cols;e++){this._map[e]=new Array(this.rows);for(let t=0;t<this.rows;t++)this._map[e][t]=new a.Cell(e,t,n)}this.fov=new l.Fov3D(this,this.lightPasses.bind(this)),this.passableCallback=this.passableCallback.bind(this),this.passableCallbackFlying=this.passableCallbackFlying.bind(this),this.debugShowAll=!1}static invertMap(e){for(let t=0;t<e.cols;t++)for(let n=0;n<e.rows;n++){const s=e._map[t][n].getBaseElem().getType();"wall"===s?e._map[t][n].setBaseElem(c):"floor"===s&&e._map[t][n].setBaseElem(u)}}static createWithoutCells(e,t){const n=new h(0,0);n._map=new Array(e);for(let s=0;s<e;s++)n._map[s]=new Array(t);return n.cols=e,n.rows=t,n}static multiplyMap(e,t,n){const s=new h(t*e.cols,n*e.rows);for(let r=0;r<s.cols;r++)for(let a=0;a<s.rows;a++){const o=Math.floor(r/t),i=Math.floor(a/n);s.setBaseElemXY(r,a,e.getBaseElemXY(o,i))}return s}setDebugShowAll(){this.debugShowAll=!0,this.exploreAll()}hasXY(e,t){return e>=0&&e<this.cols&&t>=0&&t<this.rows}setProp(e,t,n,s){this._map[e][t].setProp(n,s)}removeProp(e,t,n,s){return this._map[e][t].removeProp(n,s)}moveProp(e,t,n,s){return!!this.removeProp(e[0],e[1],n,s)&&(this.setProp(t[0],t[1],n,s),!0)}setElemXY(e,t,n){this.setProp(e,t,r.default.TYPE_ELEM,n)}setBaseElemXY(e,t,n){this._map[e][t].setBaseElem(n)}getBaseElemXY(e,t){return this._map[e][t].getBaseElem()}getCell(e,t){return this._map[e][t]}isExplored(e,t){return this._map[e][t].isExplored()}getBaseElemRow(e){const t=[];for(let n=0;n<this.cols;++n)t.push(this._map[n][e].getBaseElem());return t}getCellRow(e){const t=[];for(let n=0;n<this.cols;++n)t.push(this._map[n][e]);return t}getFree(){const e=[];for(let t=0;t<this.cols;t++)for(let n=0;n<this.rows;n++)this._map[t][n].isFree()&&e.push(this._map[t][n]);return e}getFreeNotOnEdge(){return this.getFree().filter(e=>e.getX()>0&&e.getX()<this.cols-1&&e.getY()>0&&e.getY()<this.rows-1)}getFirstFreeFromRight(e=0,t=this.rows-1){for(let n=this.cols-1;n>=0;n--)for(let s=e;s<=t;s++)if(this._map[n][s].isFree())return this._map[n][s];return null}getFreeInBbox(e){const t=[];for(let n=e.ulx;n<=e.lrx;n++)for(let s=e.uly;s<e.lry;s++)this._map[n][s].isFree()&&t.push(this._map[n][s]);return t}getEmptyCells(){const e=[];for(let t=0;t<this.cols;t++)for(let n=0;n<this.rows;n++)this._map[t][n].hasProps()||e.push(this._map[t][n]);return e}getCellsWithPropType(e){const t=[];for(let n=0;n<this.cols;n++)for(let s=0;s<this.rows;s++)this._map[n][s].hasPropType(e)&&t.push(this._map[n][s]);return t}lightPasses(e,t,n){if(this.hasXY(e,t)){if(n>=this.getZ(e,t))return this._map[e][t].lightPasses()}return!1}hasObstacle(e,t){return!!this.hasXY(e,t)&&this._map[e][t].hasObstacle()}isPassable(e,t,n,s){if(this.hasXY(e,t)&&this._map[e][t].isPassable()&&void 0!==n&&void 0!==s){if(this.hasXY(n,s)){return this.getElemDzAbs(e,t,n,s)<=1}return!0}return!1}getZ(e,t){return this._map[e][t].getBaseElem().getZ()}getElemDzAbs(e,t,n,s){const r=this.getZ(e,t),a=this.getZ(n,s);return Math.abs(r-a)}isPassableByAir(e,t){return!!this.hasXY(e,t)&&this._map[e][t].isPassableByAir()}getCellsInFOV(e){const t=[];if(e.has("Blindness"))return[e.getCell()];if(e.isLocated()&&e.getLevel().getMap()===this){const[n,s,a]=e.getXYZ(),o=r.default.getFOVRange(e);this.fov.compute(n,s,a,o,(e,n,s,r)=>{r&&this.hasXY(e,n)&&t.push(this._map[e][n])})}return t}canSeeCell(e,t){const n=r.default.getFOVRange(e);return this.fov.canSeeCell(e.getXYZ(),n,t.getXYZ())}getCellsInFOVPlus(e,t){const n=[],s=[],[a,o,i]=e.getXYZ(),l=r.default.getFOVRange(e),c=l+t;return e.isLocated()&&e.getLevel().getMap()===this&&this.fov.compute(a,o,i,c,(e,t,r,a)=>{a&&this.hasXY(e,t)&&(r<=l?n.push(this._map[e][t]):s.push(this._map[e][t]))}),[n,s]}getExploredCells(){const e=[];for(let t=0;t<this.cols;t++)for(let n=0;n<this.rows;n++)this._map[t][n].isExplored()&&e.push(this._map[t][n]);return e}exploreAll(){for(let e=0;e<this.cols;e++)for(let t=0;t<this.rows;t++)this._map[e][t].setExplored()}isEdgeXY(e,t){return 0===e||(0===t||(e===this.cols-1||t===this.rows-1))}debugPrintInASCII(){let e="";for(let t=0;t<this.rows;t++){let n="";for(let e=0;e<this.cols;e++){const s=this._map[e][t],a=s.getBaseElem();if(!a){n+="X";continue}const o=a.getType();if(s.hasActors())s.getFirstActor().isPlayer()?n+="@":n+="A";else if(s.hasItems())n+="I";else if(null!==s.getStairs())n+=">";else if(s.hasConnection())n+="c";else if(s.hasElements()){const e=s.getElements()[0];if("marker"===e.getType()){n+=e.char}else"door"===e.getType()?n+="+":n+="E"}else if(/floor/.test(o))n+=".";else if(/water|chasm|lava/.test(o))n+="~";else if(/wall/.test(o))n+="#";else if(/tree/.test(o))n+="T";else if(/grass/.test(o))n+='"';else if(/highrock/.test(o))n+="^";else if(/stone/.test(o))n+=":";else if(/steep cliff/.test(o))n+="โฎ";else if(/cliff/.test(o))n+="โฆ";else if(/road/.test(o))n+="R";else if(/arctic/.test(o))n+=".";else{const e=r.default.getCharFullMap(s);n+=e||"?"}}e+=n+"\n"}r.default.diag(e)}getCellRowFast(e){return this._isRowOptimized||this._optimizeForRowAccess(),this._rowMap[e]}findObj(e){let t=[];for(let n=0;n<this.cols;n++)for(let s=0;s<this.rows;s++)t=t.concat(this._map[n][s].findObj(e));return t}getCells(e=(e=>!0)){const t=[];for(let n=0;n<this.cols;n++)for(let s=0;s<this.rows;s++)e(this._map[n][s])&&t.push(this._map[n][s]);return t}forEachCell(e){r.default.forEach2D(this._map,e)}getCellsWithCoord(e){const t=[];return e.forEach(e=>{this.hasXY(e[0],e[1])&&t.push(this._map[e[0]][e[1]])}),t}setBaseElems(e,t){e.forEach(e=>{this._map[e[0]][e[1]].setBaseElem(t)})}has(e,t){const[n,s]=e;if(this.hasXY(n,s)){const e=this.getCell(n,s);if("string"==typeof t){if(e.getBaseElem().getType()===t)return!0}}return!1}_optimizeForRowAccess(){this._rowMap=[];for(let e=0;e<this.rows;e++){this._rowMap[e]=[];for(let t=0;t<this.cols;t++)this._rowMap[e][t]=this._map[t][e]}this._isRowOptimized=!0}toJSON(){const e=new Array(this.cols),t={},n=[],s={};for(let r=0;r<this.cols;r++){e[r]=new Array(this.rows);for(let a=0;a<this.rows;a++){const o=this.getCell(r,a).toJSON();e[r][a]=o.t,s[o.t]=0,o.ex&&n.push([r,a]),o.elements&&(t[r+","+a]=t)}}return{cols:this.cols,rows:this.rows,cells:e,explored:n,elements:t,baseTypes:s}}toJSONEncoded(){const e=this.toJSON(),{cells:t,baseTypes:n}=e;for(let e=0;e<this.cols;e++)for(let s=0;s<this.rows;s++)n[t[e][s]]+=1;let s=-1,r=0;Object.keys(n).forEach(e=>{n[e]>r&&(r=n[e],s=parseInt(e,10))});const a={};for(let e=0;e<this.cols;e++)for(let n=0;n<this.rows;n++)t[e][n]!==s&&(a[e]||(a[e]=[]),a[e].push([n,t[e][n]]));return delete e.cells,e.defaultType=s,e.cellsXY=a,e.encoded=!0,e}passableCallback(e,t,n,s,r,a){let o=this.isPassable(n,s,r,a);return o||(o=n===e&&s===t),o}passableCallbackFlying(e,t,n,s){let r=this.isPassableByAir(n,s);return r||(r=n===e&&s===t),r}moveCellUnsafe(e,t,n){n.setXY([e,t]),this._map[e][t]=n}getEdgeCells(e){const t=[];let n=0,s=0;e===r.default.DIR.S?s=this.rows-1:e===r.default.DIR.N?s=0:e===r.default.DIR.E?n=this.cols-1:e===r.default.DIR.W?n=0:r.default.err("Map","getEdgeCells","Invalid edge: "+e);for(let e=0;e<this.cols;e++)for(let r=0;r<this.rows;r++)e===n&&r===s&&t.push(this._map[e][r]);return t}}t.CellMap=h,h.fromJSON=function(e){if(e.encoded){const{defaultType:t}=e,n=i.ELEM_MAP.elemIndexToElemObj[t],s=new h(e.cols,e.rows,n);return Object.keys(e.cellsXY).forEach(t=>{const n=e.cellsXY[t],r=parseInt(t,10);n.forEach(e=>{const t=i.ELEM_MAP.elemIndexToElemObj[e[1]];s.setBaseElemXY(r,e[0],t)})}),e.explored.forEach(e=>{const[t,n]=e;s._map[t][n].setExplored()}),s}return null}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.verifyLevelCache=t.traverseObj=t.verifySaveData=t.Conf=t.verifyStairsConnections=void 0;const r=s(n(4));t.verifyStairsConnections=function(e,t){e.getLevels().map(e=>e.getStairs()).forEach(e=>{e.forEach(e=>{if("function"!=typeof e.isConnected)r.default.err("verify.js","verifyStairsConnections","stairs not correct type: "+JSON.stringify(e));else if(!e.isConnected()){let n="|"+t+"| stairs: "+JSON.stringify(e);const s=e.getSrcLevel();n+=s?" srcLevel parent "+s.getParent()+",":" srcLevel missing,";const a=e.getTargetStairs();n+=a?" targetLevel parent: "+a.getParent():" targetLevel missing,",e.getTargetStairs()||(n+=" targetStairs missing"),r.default.err("verify.js","verifyConnections",n)}})})};t.Conf=class{constructor(e){this._name=e}verifyConf(e,t,n){let s=!0,a="";return n.forEach(e=>{this.verifyReq(t,e)?function(e,t){const n=t.split("|"),s=n.length>0;let a=!1;for(const t of n)e.hasOwnProperty(t)&&r.default.isNullOrUndef([e[t]])&&(a=!0);return!s&&a}(t,e)&&(s=!1,a+=" Undef/null value in: "+e):(s=!1,a+=" Missing: "+e)}),s||r.default.err(this._name,"verifyConf",`${e} ${a}`),s}verifyReq(e,t){const n=t.split("|");let s=!1;return n.forEach(n=>{if(e.hasOwnProperty(n))if(s){const n=JSON.stringify(e),s=`Req ${t} is mutex. Conf: ${n}`;r.default.err(this._name,"verifyReq",s)}else s=!0}),s}},t.verifySaveData=function(e,t=!0){o(e,t)};const a=[];function o(e,t,n=30){const s=[];for(const r in e)if(e.hasOwnProperty(r)){if(a.push(r),a.length<n)if("object"==typeof e[r])o(e[r]);else if("function"==typeof e[r]){let n="Error. Func in "+JSON.stringify(a);if(n+="\n\tProp: "+r,n+="\n\tValue: "+e[r].toString(),t)throw new Error(n);s.push(n)}else if("string"==typeof e[r]&&/function/.test(e[r])){let t=`function in string <<${e[r]}>>\n`;throw t+="\tStack is "+a.join("."),new Error(t)}a.pop()}if(s.length>0){const e=s.join("\n");throw new Error(e)}}t.traverseObj=o,t.verifyLevelCache=function(e){const t=e.getItems(),n=e.getMap().getCells(),s={};n.forEach(e=>{if(e.hasItems()){e.getItems().forEach(e=>{s[e.getID()]=e})}});const r={};t.forEach(e=>{r[e.getID()]=e});const a=Object.keys(s).length,o=Object.keys(r).length;if(o!==a){let e="nCellItems: "+a;e+=", nLevelItems: "+o,console.error("Mismatch in cell/level item length:",e)}const i=[];Object.keys(s).forEach(e=>{r.hasOwnProperty(e)?delete r[e]:i.push(s[e])});const l=[];Object.keys(r).forEach(e=>{s.hasOwnProperty(e)?delete s[e]:l.push(r[e])}),i.forEach(e=>{console.error("\tIn cells but NOT level: ",e.getName())}),l.forEach(e=>{console.error("\tIn level but NOT cells: ",e.getName())})}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Placer=void 0;const r=s(n(4)),a=n(9),o=n(30),i=a.Random.getRNG();class l{static addPropsToFreeCells(e,t){const n=e.getMap().getFree();return l.addPropsToCells(e,n,t)}static addPropsToCells(e,t,n){let s=n.length>0&&t.length>0;for(let a=0;a<n.length;a++)if(t.length>0){const o=i.randIndex(t),l=t[o];r.default.isActor(n[a])?s=s&&e.addActor(n[a],l.getX(),l.getY()):r.default.isItem(n[a])?s=s&&e.addItem(n[a],l.getX(),l.getY()):r.default.isElement(n[a])?s=s&&e.addElement(n[a],l.getX(),l.getY()):r.default.err("Placer","addPropsToCells",`Type ${n[a].getPropType()} not supported`),t.splice(o,1)}return s}static addPropsToRoom(e,t,n){Array.isArray(n)||r.default.err("Placer","addPropsToRoom","props must be an array. Got: "+n);const s=o.BBox.fromBBox(t.getBbox()),a=n[0];return r.default.isActor(a)?l.addActorsToBbox(e,s,n):r.default.isItem(a)?l.addItemsToBbox(e,s,n):(r.default.err("Placer","addPropsToRoom","Prop type not supported: "+a),!1)}static addActorsToBbox(e,t,n){let s=n.length;const a=e.getMap().getFreeInBbox(t);return a.length<s&&r.default.warn("Placer","addActorsToBbox",`No ${s} free cells. Placing only ${a.length} actors`),s=a.length,l.addPropsToCells(e,a,n)}static addActorsToCoord(e,t,n){let s=n.length;const a=e.getMap().getCellsWithCoord(t);return a.length<s&&r.default.warn("Placer","addActorsToCoord",`No ${s} free cells. Placing only ${a.length} actors`),s=a.length,l.addPropsToCells(e,a,n)}static addElemsToCoord(e,t,n){const s=n.length,a=e.getMap().getCellsWithCoord(t);return a.length<s&&r.default.warn("Placer","addElemsToCoord",`No ${s} free cells. Placing only ${a.length} elements`),l.addPropsToCells(e,a,n)}static addItemsToBbox(e,t,n){const s=e.getMap().getFreeInBbox(t);return l.addPropsToCells(e,s,n)}static addEntityToCellType(e,t,n){let s=!1;const a=t.getMap().getCells(n);if(0===a.length)return!1;const o=i.arrayGetRand(a),[l,c]=o.getXY();return r.default.isActor(e)?s=t.addActor(e,l,c):r.default.isItem(e)?s=t.addItem(e,l,c):r.default.isElement(e)&&(s=t.addElement(e,l,c)),s}static findCellArea(e,t,n,s,r=0){const{cols:a,rows:i}=e;let[l,c]=[r,r];const u=[],h={},d=(o,l,c)=>{for(let u=o;u<o+t;u++){if(!(u<a-r))return!1;for(let t=l;t<l+n;t++){if(!(t<i-r))return!1;if(h[u+","+t])return!1;if(!s(e.getCell(u,t)))return!1;c.push([u,t])}}return c.forEach(e=>{h[e[0]+","+e[1]]=!0}),!0};let p=!1,f=[];for(;!p;){if(f=[],p=d(l,c,f),p){const e=new o.BBox(l,c,l+t-1,c+n-1);u.push(e)}if(u.length<5&&(p=!1),!p&&(++l,l===a-r&&(l=r,++c),c===i-r))break}return u}}t.Placer=l},function(e,t){var n=e.exports={version:"2.5.3"};"number"==typeof __e&&(__e=n)},function(e,t,n){var s=n(233)("wks"),r=n(161),a=n(66).Symbol,o="function"==typeof a;(e.exports=function(e){return s[e]||(s[e]=o&&a[e]||(o?a:r)("Symbol."+e))}).store=s},function(e,t){
/*!
 * Chai - flag utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t,n){var s=e.__flags||(e.__flags=Object.create(null));if(3!==arguments.length)return s[t];s[t]=n}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return e&&e.ownerDocument||document},e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s,r=n(742),a=(s=r)&&s.__esModule?s:{default:s};t.default=(0,a.default)({shouldComponentUpdate:function(){return!this._notifying}},(function(e,t,n,s,r){n&&(e._notifying=!0,n.call.apply(n,[e,s].concat(r)),e._notifying=!1),e._values[t]=s,e.unmounted||e.forceUpdate()})),e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MenuWithState=t.PlayerMissileMenu=t.MenuConfirm=t.MenuSelectDir=t.MenuSelectTarget=t.MenuSelectCell=t.MenuSelectRequired=t.MenuWithQuit=t.MenuInfoOnly=t.MenuBase=t.Menu=void 0;const r=s(n(4)),a=n(25),{KeyMap:o}=a.Keys;t.Menu={},t.Menu.EXIT_MENU=null,t.Menu.NO_ACTION="NO_ACTION",t.Menu.NEXT_STATE="NEXT_STATE";const i=function(e){const t={};return e.forEach((e,n)=>{const s=a.Keys.menuIndices[n];if(e.key){const n=e,s=a.Keys.codeToIndex(n.key);n.menu?t[s]=n.menu:n.func?t[s]=n.func:n.funcToCall&&(t[s]={funcToCall:n.funcToCall})}else if(2===e.length)t[s]=e;else{let e="Each item must have 2 values: menu msg and ret val";e+="\nItem can also be {key: , menu: } for nested menus",r.default.err("menu.js","createMenuTable",e)}}),t};t.Menu.isSelectionDone=function(e){return"function"==typeof e},t.Menu.isMenuItem=function(e){return e&&"object"==typeof e};class l{constructor(e=[]){this.table=i(e),this.msg="",this.pre=[],this.post=[],this._showMenu=!0,this.parent=null}createTable(e){this.table=i(e)}setName(e){this.name=e}setMsg(e){this.msg=e}showMsg(){this.msg.length>0&&r.default.gameMsg(this.msg)}setParent(e){this.parent=e}getParent(){return this.parent}addItem(e,t){const n=a.Keys.codeToIndex(e);this.table[n]=t}showMenu(){return this._showMenu}setCallback(e){this.callback=e}getMenu(){const e={pre:[],post:[]};return Object.keys(this.table).forEach(t=>{const n=a.Keys.menuIndices[t];e[n]=this.table[t][0]}),e.pre=this.pre,e.post=this.post,e}addPost(e){Array.isArray(e)?this.post=this.post.concat(e):this.post.push(e)}addPre(e){Array.isArray(e)?this.pre=this.pre.concat(e):e?this.pre.push(e):r.default.err("MenuBase","addPre","Null/undef/misc given. Exp str|str[]")}dbg(...e){console.log("MENU "+this.name,...e)}select(e){const n=a.Keys.codeToIndex(e);if(this.table.hasOwnProperty(n)){const e=this.table[n];return 2===e.length?e[1]:e.funcToCall?e.funcToCall:e}return t.Menu.EXIT_MENU}onSelectCallback(e){console.log("onSelectCallback in menu",this.name)}}t.MenuBase=l,t.Menu.Base=l;class c extends l{constructor(){super()}select(e){return 0===a.Keys.codeToIndex(e)?t.Menu.EXIT_MENU:this}getMenu(){return{0:"Back to game.",pre:this.pre,post:this.post}}}t.MenuInfoOnly=c,t.Menu.InfoOnly=c;class u extends l{constructor(e=[]){super(e);const n=a.Keys.codeToIndex(a.Keys.KEY.QUIT_MENU);this.table[n]=["Quit menu",t.Menu.EXIT_MENU]}select(e){const n=a.Keys.codeToIndex(e);if(this.table.hasOwnProperty(n)){const e=this.table[n][1];return e===t.Menu.EXIT_MENU&&this.onQuit&&this.onQuit(),e}return this}}t.MenuWithQuit=u,t.Menu.WithQuit=u;class h extends l{constructor(e=[]){super(e)}select(e){const t=a.Keys.codeToIndex(e);return this.table.hasOwnProperty(t)?this.table[t][1]:this}}t.MenuSelectRequired=h,t.Menu.SelectRequired=h;class d extends l{constructor(e=[]){super(e),this._enableSelectAll=!1,this._showMenu=!1}enableSelectAll(){this._enableSelectAll=!0}select(e){if(o.inMoveCodeMap(e))return this.callback(e),this;if(o.isSelect(e)){const t=a.Keys.codeToIndex(e),n=this.table[t];if(n)return n.funcToCall?n.funcToCall:n}else if(this._enableSelectAll&&o.isSelectAll(e))return this.callback(e),this;return t.Menu.EXIT_MENU}}t.MenuSelectCell=d,t.Menu.SelectCell=d;class p extends d{constructor(e=[]){super(e),this.targetCallback=null}select(e){const n=super.select(e);if(n===t.Menu.EXIT_MENU){if(o.isNextTarget(e))return this.targetCallback&&this.targetCallback(e),this;if(o.isPrevTarget(e))return this.targetCallback&&this.targetCallback(e),this;if(e===a.Keys.KEY.TARGET){const t=a.Keys.codeToIndex(e),n=this.table[t];return n.funcToCall?n.funcToCall:n}return t.Menu.EXIT_MENU}return n}}t.MenuSelectTarget=p,t.Menu.SelectTarget=p;class f extends l{constructor(e=[]){super(e),this._showMenu=!1}select(e){if(o.inMoveCodeMap(e)){const t=a.Keys.KeyMap.getDir(e);if(this.callback)return this.callback.bind(null,t);if(this.returnMenu)return this.returnMenu.onSelectCallback(t),this.returnMenu}return t.Menu.EXIT_MENU}}t.MenuSelectDir=f,t.Menu.SelectDir=f;class m extends l{constructor(e=[]){super(e),this._showMenu=!1,this.msg="Do you want to confirm the action [y/n]?"}select(e){return o.isConfirmYes(e)?this.callback?this.callback:this.returnMenu?(this.returnMenu.onSelectCallback(),this.returnMenu):t.Menu.EXIT_MENU:o.isConfirmNo(e)?t.Menu.EXIT_MENU:this}}t.MenuConfirm=m,t.Menu.Confirm=m;t.PlayerMissileMenu=class extends d{constructor(e=[],t){super(e),this.actor=t,this._showMenu=!1;const n=this.actor.getBrain();if(n.selectCell){const e=n.selectCell.bind(n);this.setCallback(e)}else r.default.err("PlayerMissileMenu","constructor","brain does not have selectCell() function");n.startTargeting(),n.hasTargetSelected()?console.log("Brain has target selected"):(n.selectCell(),console.log("Brain no target selected. Using cell."))}select(e){const n=super.select(e);if(n!==t.Menu.EXIT_MENU)return n;switch(e){case a.Keys.KEY.NEXT:return this.actor.getBrain().nextTarget(),this;case a.Keys.KEY.PREV:return this.actor.getBrain().prevTarget(),this;case a.Keys.KEY.TARGET:{const t=a.Keys.codeToIndex(e);return this.table[t]}default:return t.Menu.EXIT_MENU}}};class g extends u{constructor(e){super(e),this._showMenu=!0,this.keyToState={},this.stateToTable={},this.stateToPost={},this.stateToPre={},this.menuState=""}select(e){if(this.keyToState.hasOwnProperty(e))return this.menuState=this.keyToState[e],this;{const n=a.Keys.codeToIndex(e);if(this.table.hasOwnProperty(n)){const e=this.table[n][1];return e===t.Menu.EXIT_MENU&&this.onQuit&&this.onQuit(),e}const s=this.stateToTable[this.menuState];if(s.hasOwnProperty(n)){return s[n][1]}return this}}addState(e,t){this.stateToTable[e]=i(t)}addTransition(e,t){this.keyToState[t]=e}getMenu(){const e=u.prototype.getMenu.call(this),t=this.menuState,n=this.stateToTable[t];let s={pre:this.pre,post:this.post};return Object.keys(n).forEach(e=>{const t=a.Keys.menuIndices[e];s[t]=n[e][0]}),s=Object.assign(s,e),this.stateToPre[t]&&s.pre.push(this.stateToPre[t]),this.stateToPost[t]&&s.post.push(this.stateToPost[t]),s}addPreState(e,t){t?this.stateToPre[t]=e:u.prototype.addPre.call(this,e)}addPostState(e,t){t?this.stateToPost[t]=e:u.prototype.addPost.call(this,e)}}t.MenuWithState=g,t.Menu.WithState=g},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Entity=void 0;const r=s(n(4)),a=n(135),o=n(23),i=n(181),l={OnAddCb:!0,OnRemoveCb:!0,Movement:!0};class c extends a.GameObject{constructor(...e){super(),this.comps={},this.compsByType={}}static createEntityID(){return a.GameObject.createObjectID()}static getPool(){return c.POOL}static setPool(e){c.POOL=e}static getIDCount(){return a.GameObject.ID}remove(e){if(++c.num.remove,"object"==typeof e){const t=e.getID();if(this.comps.hasOwnProperty(t)){const e=this.comps[t],n=e.getType();if(e.entityRemoveCallback(this),c.enableOnAddRemoveCbsFor[n]){const t=new i.OnRemoveCb;t.setCompName(n),t.setComp(e),this.add(t)}delete this.comps[t];const s=this.compsByType[n].indexOf(e);!function(e,t){const n=e.length;if(n){for(;t<n;)e[t]=e[t+1],t++;e.length--}}(this.compsByType[n],s),0===this.compsByType[n].length&&(l[n]||delete this.compsByType[n]),c.POOL.emitEvent(n,{entity:this,remove:!0})}}else if(Number.isInteger(e)){const t=e;this.comps[t]&&this.remove(this.comps[t])}else{const t=this.get(e);if(t)this.remove(t);else{const t=parseInt(e,10);if(t)this.remove(t);else{const t=typeof e;r.default.warn("Entity","remove",`No comp found ->  |${e}|, type: ${t}`)}}}}equals(e){return this.getID()===e.getID()}get(e){return++c.num.get,this.compsByType[e]?this.compsByType[e][0]:null}getByID(e){return this.comps[e]}getList(e){return++c.num.getList,this.compsByType[e]?this.compsByType[e].slice():[]}add(e){++c.num.add;const t=e.getType();if(e.isUnique()&&this.has(t)&&this.removeAll(t),this.comps[e.getID()]=e,this.compsByType.hasOwnProperty(t)?this.compsByType[t].push(e):this.compsByType[t]=[e],e.entityAddCallback(this),c.POOL.emitEvent(t,{entity:this,add:!0}),c.enableOnAddRemoveCbsFor[t]){const n=new i.OnAddCb;n.setCompName(t),n.setComp(e),this.add(n)}}has(e){return++c.num.has,this.compsByType.hasOwnProperty(e)?this.compsByType[e].length>0:this.comps.hasOwnProperty(e)}hasAny(e){++c.num.hasAny;for(const t of e)if(this.compsByType.hasOwnProperty(t)&&this.compsByType[t].length>0)return!0;return!1}hasNone(e){return!this.hasAny(e)}hasAll(e){for(const t of e){if(!this.compsByType.hasOwnProperty(t))return!1;if(0===this.compsByType[t].length)return!1}return!0}removeAll(e){++c.num.removeAll;let t=e;if("object"==typeof e&&(t=e.getType()),this.has(t)){this.compsByType[t].slice().forEach(e=>{this.remove(e)})}}getComponents(){return this.comps}getCompList(){return Object.keys(this.compsByType)}copy(e){throw new Error("copy() not implemented in Entity")}clone(){throw new Error("clone() not implemented in Entity")}toJSON(){throw new Error("toJSON() not implemented in Entity")}}t.Entity=c,c.setPool(o.EventPool.getPool()),c.enableOnAddRemoveCbsFor={Explosion:!0,Paralysis:!0,Flying:!0},c.num={},c.num.add=0,c.num.get=0,c.num.getList=0,c.num.has=0,c.num.hasAny=0,c.num.hasAll=0,c.num.remove=0,c.num.removeAll=0},function(e,t){e.exports=function(e){return null!=e&&"object"==typeof e}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.removeStatsModsOnLeave=t.addRegenEffects=t.executeCompCb=t.emitZoneEvent=t.setCbDebug=void 0;const i=o(n(4)),l=n(137),c=a(n(11));let u=!0;t.setCbDebug=function(e){u=e},t.emitZoneEvent=function(e,t,n){const s=e.getParentZone();if(s){const e=new c.ZoneEvent;e.setEventType(t),n&&e.setEventData(n),s.add(e)}i.default.debugZoneEvents};new l.ObjectShellComps({debug:!1});t.executeCompCb=function(e,t){if(t.addComp){let n=[];n="string"==typeof t.addComp?[{comp:t.addComp}]:t.addComp,n.forEach(n=>{const s={name:n.comp,target:e,effectType:"AddComp",targetType:i.default.PROP_TYPES};n.duration&&(s.duration=t.addComp.duration),n.func&&(s.setters=t.addComp.func),n.expireMsg&&(s.expireMsg=t.addComp.expireMsg),n.area&&(s.area=n.area),n.anim&&(s.anim=n.anim),n.applyToAllTargets&&(s.applyToAllTargets=!0),t.level&&(s.level=t.level);const r=new c.Effects(s);if(e.add(r),u){const t=e.getID(),n=e;console.log(`addComp Cb exec for @${t} |${n.getName()}|`)}})}if(t.removeComp&&t.removeComp.forEach(t=>{e.has(t.comp)&&e.remove(t.comp)}),t.modifyComp){const n={name:t.modifyComp.comp,target:e,get:t.modifyComp.get,set:t.modifyComp.set,value:t.modifyComp.value,effectType:"ModifyCompValue"},s=new c.Effects(n);e.add(s)}if(t.changeElement&&i.default.err("system.on-cb.ts","executeCompCb","changelement not supported yet. Need to write some code"),t.addEntity){const n=e.get("Location");if(n&&n.isValid()){const s={name:t.modifyComp.comp,target:{target:n.getCell()},entityName:t.addEntity.entityName,effectType:"AddEntity"};t.addEntity.duration&&(s.duration=t.addEntity.duration);const r=new c.Effects(s);e.add(r)}else i.default.err("system.on-cb.ts","executeCompCb","In addEntity, no valid location for adding.")}if(t.removeEntity){const n={effectType:"RemoveEntity",target:t.removeEntity.target,targetType:["self"]},s=new c.Effects(n);if(e.add(s),u){const t=e.getID(),n=e;console.log(`removeEnt Cb exec for @${t} |${n.getName()}|`)}}t.addElement&&i.default.err("system.on-cb.ts","executeCompCb","addElement not supported yet. Need to write some code"),t.removeElement&&i.default.err("system.on-cb.ts","executeCompCb","removelement not supported yet. Need to write some code")},t.addRegenEffects=function(e){const t=e.getList("Regeneration"),n=e.getList("RegenEffect");t.forEach(t=>{const s=t.getID();if(n.findIndex(e=>e.getRegenID()===s)<0){const n=new c.RegenEffect;n.initEffect(t),e.add(n)}})},t.removeStatsModsOnLeave=function(e,t){const n=e.getList("StatsMods"),s=e.getList("CombatMods");n.forEach(n=>{n.getTag()===t&&e.remove(n)}),s.forEach(n=>{n.getTag()===t&&e.remove(n)})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,r=n(41),a=(s=r)&&s.__esModule?s:{default:s};function o(e,t){if(t)do{if(t===e)return!0}while(t=t.parentNode);return!1}t.default=a.default?function(e,t){return e.contains?e.contains(t):e.compareDocumentPosition?e===t||!!(16&e.compareDocumentPosition(t)):o(e,t)}:o,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=E(n(0)),a=E(n(1)),o=E(n(131)),i=n(17),l=E(n(429)),c=E(n(260)),u=E(n(449)),h=E(n(452)),d=E(n(453)),p=E(n(454)),f=E(n(455)),m=E(n(262)),g=E(n(52)),y=E(n(41)),v=E(n(105)),b=E(n(67)),_=E(n(90));function E(e){return e&&e.__esModule?e:{default:e}}var S={},w="modal",C=void 0;function O(e){return a.default.createElement(u.default,s({},e,{timeout:M.TRANSITION_DURATION}))}function T(e){return a.default.createElement(u.default,s({},e,{timeout:M.BACKDROP_TRANSITION_DURATION}))}var M=function(e){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.call(this));return n.handleEntering=n.handleEntering.bind(n),n.handleExiting=n.handleExiting.bind(n),n.state={classes:""},n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.getDefaultPrefix=function(){return w},t.prototype.getChildContext=function(){return this._context||(this._context={onModalHide:this.props.onHide})},t.prototype.componentDidMount=function(){var e,t,n,s=this;C=C||(t=document.createElement("div"),n=document.createElement("div"),t.className="modal hide",n.className="modal-backdrop hide",document.body.appendChild(t),document.body.appendChild(n),S.modal=+(0,b.default)(t,"z-index"),S.backdrop=+(0,b.default)(n,"z-index"),e=S.modal-S.backdrop,document.body.removeChild(t),document.body.removeChild(n),function(t){return S[t]+e*(s.props.manager.modals.length-1)})},t.prototype.handleEntering=function(){this._show.apply(this,arguments),this.props.onEntering&&this.props.onEntering()},t.prototype.handleExiting=function(){this._removeAttentionClasses(),this.props.onExiting&&this.props.onExiting()},t.prototype.render=function(){var e=this,n=this.props,r=n.className,o=n.children,i=n.keyboard,c=n.transition,u=n.modalPrefix,h=n.dialogClassName,d=n.container,p=n.onEnter,f=n.onEntered,m=n.onExit,g=n.onExited,y=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(n,["className","children","keyboard","transition","modalPrefix","dialogClassName","container","onEnter","onEntered","onExit","onExited"]),v=this.state,b=v.dialog,E=v.classes,S=v.backdrop;delete y.manager;var w,C,M=(w=y,C=Object.keys(t.propTypes),Object.keys(w).reduce((function(e,t){return-1===C.indexOf(t)&&(e[t]=w[t]),e}),{})),A=u||t.getDefaultPrefix();!0===c&&(c=O);var N=a.default.createElement("div",s({},M,{ref:function(t){return e.dialog=t},style:b,className:(0,_.default)(r,A,{in:y.show&&!c}),onClick:this.props.backdrop?function(t){return e.handleBackdropClick(t)}:null}),a.default.createElement("div",{key:"modal",ref:function(t){return e.innerRef=t},className:(0,_.default)(A+"-dialog",h,E,(y.small||y.sm)&&A+"-sm",(y.large||y.lg)&&A+"-lg")},a.default.createElement("div",{className:A+"-content"},o)));return a.default.createElement(l.default,{keyboard:i,ref:function(t){e.modal=t&&t.modal,e.backdrop=t&&t.backdrop},container:d,backdrop:y.backdrop,show:y.show,backdropStyle:S,backdropClassName:A+"-backdrop",containerClassName:A+"-open",transition:c||void 0,backdropTransition:c?T:void 0,onHide:this.props.onHide,onEnter:p,onEntering:this.handleEntering,onEntered:f,onExit:m,onExiting:this.handleExiting,onExited:g},N)},t.prototype.attention=function(){var e=this,t=this.props.attentionClass;t&&this.setState({classes:""},(function(){e.props.show&&(e.innerRef.offsetWidth,e.setState({classes:t+" animated"}))}))},t.prototype.handleBackdropClick=function(e){if(e.target===e.currentTarget)return"static"===this.props.backdrop?this.attention():void this.props.onHide()},t.prototype._show=function(){this.props.show&&this.setState(this._getStyles())},t.prototype._getStyles=function(){if(!y.default)return{};var e=(0,i.findDOMNode)(this.dialog),t=(0,g.default)(e),n=e.scrollHeight,s=(0,c.default)(this.props.container||t.body),r=n>t.documentElement.clientHeight;return{dialog:{zIndex:C("modal"),paddingRight:s&&!r?(0,v.default)():void 0,paddingLeft:!s&&r?(0,v.default)():void 0},backdrop:{zIndex:C("backdrop")}}},t.prototype._removeAttentionClasses=function(){this.setState({classes:""})},t}(a.default.Component);function A(){return w}M.propTypes={show:r.default.bool,small:r.default.bool,sm:r.default.bool,large:r.default.bool,lg:r.default.bool,backdrop:r.default.oneOf(["static",!0,!1]),keyboard:r.default.bool,animate:r.default.bool,transition:r.default.any,container:r.default.oneOfType([o.default,r.default.func]),onHide:r.default.func,onEnter:r.default.func,onEntering:r.default.func,onEntered:r.default.func,onExit:r.default.func,onExiting:r.default.func,onExited:r.default.func,modalPrefix:r.default.string,dialogClassName:r.default.string,attentionClass:r.default.string},M.defaultProps={backdrop:!0,keyboard:!0,animate:!0,transition:!0,container:y.default?document.body:null,attentionClass:"shake",manager:(l.default.getDefaultProps?l.default.getDefaultProps():l.default.defaultProps).manager},M.childContextTypes={onModalHide:r.default.func},M.injectCSSPrefix=function(e){w=e},h.default.getDefaultPrefix=A,d.default.getDefaultPrefix=A,p.default.getDefaultPrefix=A,f.default.getDefaultPrefix=A,M.Body=h.default,M.Header=d.default,M.Title=p.default,M.Footer=f.default,M.Dismiss=m.default,M.BaseModal=M,M.TRANSITION_DURATION=300,M.BACKDROP_TRANSITION_DURATION=150,t.default=M,e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Constraints=void 0;const r=s(n(4));function a(e,t,n){const s=t.split(".");let r=e;return s.forEach(e=>{r=r[e](...n)}),r}t.Constraints=class{constructor(e="and"){this.aggrFunc=e}static toJSON(e){const t=e.constraint,n={op:t.op,value:t.value};return t.comp&&(n.comp=t.comp),t.func&&(n.func=t.func),t.prop&&(n.prop=t.prop),t.args&&(n.args=t.args),n}getConstraints(e){if(Array.isArray(e)){const t=e.map(e=>{const{op:t,prop:n,func:s,value:r,args:a,comp:o}=e;return n?this.getFunc(t,n,r):s?this.getFuncWithGetter(t,s,r,a):o?this.getFuncWithComp(t,o,r,a):void 0});let n=null;return n="and"===this.aggrFunc?function(e){let n=!0;return t.forEach(t=>{n=n&&t(e)}),n}:function(e){let n=!1;return t.forEach(t=>{n=n||t(e)}),n},n.constraint=e,n}if("object"==typeof e){const{op:t,prop:n,func:s,value:r,args:a,comp:o}=e;if(n)return this.getFunc(t,n,r);if(s)return this.getFuncWithGetter(t,s,r,a);if(o)return this.getFuncWithComp(t,o,r,a)}else{const t="Param must be array/object. Got: "+e;r.default.err("Constrains","getConstraints",t)}return null}getFunc(e,t,n){if(Array.isArray(n)){const s=n.map(n=>this.getFunc(e,t,n)),r=function(e){let t=!1;return s.forEach(n=>{t=t||n(e)}),t};return r.constraint={op:e,prop:t,value:n},r}{let s=()=>!1;switch(e){case"==":case"===":case"eq":s=e=>e[t]===n;break;case"!=":case"!==":case"neq":s=e=>e[t]!==n;break;case">=":case"gte":s=e=>e[t]>=n;break;case"<=":case"lte":s=e=>e[t]<=n;break;case">":case"gt":s=e=>e[t]>n;break;case"<":case"lt":s=e=>e[t]<n;break;case"match":s=e=>new RegExp(n).test(e[t]);break;default:r.default.err("Constraints","getFunc",`Unsupported op ${e} given`)}return s.constraint={op:e,prop:t,value:n},s}}getFuncWithGetter(e,t,n,s=[]){if(Array.isArray(n)){const r=n.map(n=>this.getFuncWithGetter(e,t,n,s)),a=function(e){let t=!1;return r.forEach(n=>{t=t||n(e)}),t};return a.constraint={op:e,func:t,value:n,args:s},a}{let o=()=>!1;switch(e){case"==":case"===":case"eq":o=e=>a(e,t,s)===n;break;case"!=":case"!==":case"neq":o=e=>a(e,t,s)!==n;break;case">=":case"gte":o=e=>a(e,t,s)>=n;break;case"<=":case"lte":o=e=>a(e,t,s)<=n;break;case">":case"gt":o=e=>a(e,t,s)>n;break;case"<":case"lt":o=e=>a(e,t,s)<n;break;case"match":o=e=>new RegExp(n).test(a(e,t,s));break;default:r.default.err("Constraints","getFunc",`Unsupported op ${e} given`)}return o.constraint={op:e,func:t,value:n,args:s},o}}getFuncWithComp(e,t,n,s=[]){if(Array.isArray(n)){const r=n.map(n=>this.getFuncWithComp(e,t,n,s)),a=function(e){let t=!1;return r.forEach(n=>{t=t||n(e)}),t};return a.constraint={op:e,comp:t,value:n,args:s},a}{if(!Array.isArray(t)||t.length<=1){const e=JSON.stringify(t);r.default.err("Constraints","getFuncWithComp","comp must be an array [CompName, getterName]. Got: "+e)}const[a,o]=t;let i=()=>!1;switch(e){case"==":case"===":case"eq":i=e=>e.get(a)[o](...s)===n;break;case"!=":case"!==":case"neq":i=e=>e.get(a)[o](...s)!==n;break;case">=":case"gte":i=e=>e.get(a)[o](...s)>=n;break;case"<=":case"lte":i=e=>e.get(a)[o](...s)<=n;break;case">":case"gt":i=e=>e.get(a)[o](...s)>n;break;case"<":case"lt":i=e=>e.get(a)[o](...s)<n;break;case"m/":case"match":i=e=>new RegExp(n).test(e.get(a)[o](...s));break;default:r.default.err("Constraints","getFunc",`Unsupported op ${e} given`)}return i.constraint={op:e,comp:t,value:n,args:s},i}}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SentientActor=t.BaseActor=t.ACTOR_NO_ACTION=t.Actor=void 0;const i=o(n(4)),l=n(55),c=a(n(29)),u=n(34),h=n(27),d=n(178),p=n(182),f=a(n(136));t.Actor={},t.ACTOR_NO_ACTION=Object.freeze(()=>{});const m=i.default.BASE_SPEED*i.default.ACTION_DUR;class g extends l.Entity{constructor(e,t=!0){super(),this.add(new c.Action);const n=new c.Named;n.setName(e),this.add(n),t&&this.build()}build(){this.add(new c.Location),this.add(new c.Typed("BaseActor",i.default.TYPE_ACTOR))}getType(){return this.get("Typed").getObjType()}setType(e){return this.get("Typed").setObjType(e)}getPropType(){return this.get("Typed").getPropType()}setPropType(e){return this.get("Typed").setPropType(e)}getCell(){return this.get("Location").getCell()}isLocated(){return this.get("Location").isLocated()}unsetLevel(){this.get("Location").unsetLevel()}setLevel(e){return this.get("Location").setLevel(e)}getLevel(){return this.get("Location").getLevel()}getX(){return this.get("Location").getX()}getY(){return this.get("Location").getY()}getXY(){return this.get("Location").getXY()}setXY(e,t){this.get("Location").setXY(e,t)}isAtXY(e,t){return this.get("Location").isAtXY(e,t)}getZ(){return this.getCell().getZ()}getXYZ(){const[e,t]=this.getXY();return[e,t,this.getCell().getBaseElem().getZ()]}isPlayer(){return this.has("Player")||this.has("PlayerControlled")}isEnemy(e){return!1}addEnemy(e){}addEnemyType(e){}setName(e){this.get("Named").setName(e)}getName(){return this.get("Named").getFullName()}getBrain(){return this._brain}setBrain(e){this._brain=e,this._brain.setActor(this)}getSpeed(){return i.default.BASE_SPEED}getEquipProtection(){return 0}nextAction(e){const n=this._brain.decideNextAction(e);let s=null;if(null!==n){const e=Math.round(m/this.getSpeed());if(s=new f.Action(e,n),this._brain.hasOwnProperty("energy")){const e=this._brain;s.energy=e.energy}}else s=new f.Action(0,t.ACTOR_NO_ACTION);return s.actor=this,s}toJSON(){let e=null;this.getLevel()&&(e=this.getLevel().getID());const t={id:this.getID(),type:this.getType(),levelID:e,brain:this._brain.toJSON(),new:"Base"};return t.components=u.compsToJSON(this),null===t.type&&i.default.err("Actor.Virtual","toJSON","Type null for "+JSON.stringify(t)),t}}t.BaseActor=g,t.Actor.Base=g;class y extends g{constructor(e,t=!0){super(e,t)}build(){super.build(),this._brain=new h.BrainGoalOriented(this),this._invEq=new p.Inventory(this),this._maxWeight=17,this.add(new c.Experience),this.add(new c.Combat),this.add(new c.Stats),this.add(new c.Health(50)),this.add(new c.Corporeal);const e=new c.Perception;e.setFOVRange(i.default.NPC_FOV_RANGE),this.add(e)}getFOVRange(){let e=this.get("Perception").getFOVRange();return this.has("EagleEye")&&(e+=2),e}setFOVRange(e){this.get("Perception").setFOVRange(e)}addEnemyType(e){this._brain.getMemory().addEnemyType(e)}addEnemy(e){this._brain.addEnemy(e)}addFriend(e){this._brain.addFriend(e)}isEnemy(e){return this._brain.getMemory().isEnemy(e)}isFriend(e){return this._brain.getMemory().isFriend(e)}getInvEq(){return this._invEq}getWeapon(){return this._invEq.getWeapon()}getMissileWeapon(){return this._invEq.getMissileWeapon()}getMissile(){return this._invEq.getEquipment().getItem("missile")}getEquipAttack(){let e=this._invEq.getEquipment().getAttack();return e+=i.default.getSkillLevel(this,i.default.SKILLS.MELEE),e}getEquipDefense(){let e=this._invEq.getEquipment().getDefense();return e+=i.default.getSkillLevel(this,i.default.SKILLS.SHIELDS),e}getEquipProtection(){let e=this._invEq.getEquipment().getProtection();return e+=i.default.getSkillLevel(this,i.default.SKILLS.ARMOUR),e}getShieldDefense(){const e=this._invEq.getEquipment().getEquipped("shield");let t=0;if(e){t=e.getDefense(),this.has("Skills")&&(t+=this.get("Skills").getLevel("Shields"))}return t}setActorClass(e){this._actorClass=e}getActorClass(){return this._actorClass}setBook(e){this._spellbook=e}getBook(){return this._spellbook}getMaxWeight(){return 2*this.get("Stats").getStrength()+2*this._invEq.getEquipment().getStrength()+this._maxWeight}setIsPlayer(e){e?(this._brain=new d.BrainPlayer(this),b(this),this.add(new c.Player),this.has("SpellPower")||this.add(new c.SpellPower)):i.default.err("Actor.Sentient","setIsPlayer","Actor cannot be changed from player to mob.")}setPlayerCtrl(e){var t;e?(this.add(new c.PlayerControlled),this._actualBrain=this._brain,this._brain=new d.BrainPlayer(this),b(this),this.add(new c.Possessed)):(this.remove("PlayerControlled"),this.remove("Possessed"),t=this,v.forEach(e=>{let n=-1;t.has(e)&&t.getList(e).forEach(e=>{"brain-player"===e.getTag()&&(n=e.getID())}),-1!==n&&t.remove(n)}),this._brain=this._actualBrain,delete this._actualBrain)}getCell(){const e=this.getX(),t=this.getY(),n=this.getLevel();return n?n.getMap().getCell(e,t):null}isInLevel(e){return!!this.getLevel()&&this.getLevel().getID()===e.getID()}toJSON(){let e=null;this.getLevel()&&(e=this.getLevel().getID());const t={id:this.getID(),name:this.getName(),type:this.getType(),brain:this._brain.toJSON(),new:"Sentient",components:u.compsToJSON(this)},n=this.getInvEq().getInventory().toJSON();n.length>0&&(t.inventory=n);const s=this.getInvEq().getEquipment().toJSON();return s.length>0&&(t.equipment=s),null===t.type&&i.default.err("Actor.Sentient","toJSON","Type null for "+JSON.stringify(t)),this._spellbook&&(t.spellbook=this._spellbook.toJSON()),this.has("Player")&&(t.isPlayer=!0,t.x=this.getX(),t.y=this.getY(),t.levelID=e),this._actualBrain&&(t.brain=this._actualBrain.toJSON()),t}getAttack(){let e=this.get("Combat").getAttack();return e+=this.getEquipAttack(),e+=this._addFromCompList("CombatMods","getAttack"),e+=i.default.accuracyToAttack(this.getStatVal("Accuracy")),e}getDefense(){let e=this.get("Combat").getDefense();return e+=this.getEquipDefense(),e+=this._addFromCompList("CombatMods","getDefense"),e+=i.default.agilityToDefense(this.getStatVal("Agility")),e}getProtection(){let e=this.get("Combat").getProtection();return e+=this.getEquipProtection(),e+=this._addFromCompList("CombatMods","getProtection"),e}getDamage(){let e=this.get("Combat").rollDamage();const t=this.getWeapon();if(t){const n=i.default.getItemDamage(t);n>e&&(e=n)}const n=this.getStatVal("Strength");return e+=i.default.strengthToDamage(n),e+=this._addFromCompList("CombatMods","getDamage"),e}getCombatBonus(e){return this._addFromCompList("CombatMods",e)}_addFromCompList(e,t){const n=this.getList(e);return n.length>0?n.reduce((e,n)=>e+n[t](),0):0}getSpeed(){const e=this.getStatVal("Speed");return 0===e?1:e}getStatVal(e){const t=i.default.formatGetterName(e);let n=this.get("Stats")[t]();return n+=this.getInvEq().getEquipment()[t](),n+=this._addFromCompList("StatsMods",t),n}getStatBonus(e){return this._addFromCompList("StatsMods",e)}}t.SentientActor=y,i.default.STATS.forEach(e=>{y.prototype[i.default.formatGetterName(e)]=function(){return this.getStatVal(e)}});const v=["StatsMods","CombatMods"];function b(e){v.forEach(t=>{let n=!1;if(e.has(t)){e.getList(t).forEach(e=>{"brain-player"===e.getTag()&&(n=!0)})}if(!n){const n=new c[t];n.setTag("brain-player"),e.add(n)}})}t.Actor.Sentient=y,y.getFormattedStats=function(e){const t=e.getLevel().getLevelNumber(),n=i.default.formatLocationName(e.getLevel());let s=null;e.has("SpellPower")&&(s=e.get("SpellPower").getPP()+"/"+e.get("SpellPower").getMaxPP());let r={HP:e.get("Health").getHP()+"/"+e.get("Health").getMaxHP(),PP:s,Att:[e.getAttack(),e.getCombatBonus("getAttack")],Def:[e.getDefense(),e.getCombatBonus("getDefense")],Pro:[e.getProtection(),e.getCombatBonus("getProtection")]};return Object.keys(i.default.STATS_ABBR2STAT).forEach(t=>{const n=i.default.STATS_ABBR2STAT[t],s=i.default.formatGetterName(n);r[t]=[e[s](),e.getStatBonus(s)]}),r=Object.assign(r,{Speed:[e.getSpeed(),e.getStatBonus("getSpeed")],XP:e.get("Experience").getExp(),XL:e.get("Experience").getExpLevel(),DL:t,Loc:n}),e.has("Hunger")&&(r.E=e.get("Hunger").getEnergy()),r}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LevelGenerator=void 0;const r=s(n(4)),a=n(16),o=n(92);t.LevelGenerator=class{constructor(){this.shouldRemoveMarkers=!0,this._debug=!1}static getOptions(){return{addActors:!1,actorFunc:e=>e.danger<=5,addItems:!0,cellsAround:{N:"wallmount",S:"tree",E:"grass",W:"snow",NW:"water",SE:"water"},surroundX:10,surroundY:10,maxValue:100,maxDanger:5,maxRarity:1,shouldRemoveMarkers:!0,preserveMarkers:!1,nestProbability:.2}}static addStartAndEndPointMarker(e,t,n){if(t){const[n,s]=t,r=new a.ElementMarker("<");r.setTag("start_point"),e.addElement(r,n,s)}else r.default.err("LevelGenerator","addStartAndEndPointMarker","start point coord not defined");if(n){const[t,s]=n,r=new a.ElementMarker(">");r.setTag("end_point"),e.addElement(r,t,s)}}static markersToDoor(e){const t=e.getMap(),n=t.getCells(e=>e.hasElements()),s=[];return n.forEach(n=>{if(n.hasMarker("door")){const[o,i]=n.getXY(),l=new a.ElementDoor(!0);t.getCell(o,i).removeProps(r.default.TYPE_ELEM),e.addElement(l,o,i),s.push([o,i])}}),s}static removeOneMarkerType(e,t,n){const s=e.getMap().getCells(e=>e.hasElements()),r=[];return s.forEach(s=>{if(s.hasMarker(n)){s.getMarkers().forEach(n=>{if(n.getChar()===t){const[t,s]=n.getXY();e.removeElement(n,t,s),r.push([t,s])}})}}),r}static tilesToRooms(e,t){const n=[],s=[],r=t.tiles;Object.values(r).forEach(e=>{if("FILLER"!==e.name){const t=new o.Room(e.llx,e.ury,e.urx,e.lly);n.push(t),"term"===e.name&&s.push(t)}}),e.addExtras("rooms",n),e.addExtras("terms",s)}removeMarkers(e,t){let n=0,s=["start_point","end_point","critical_path"];return t.markersPreserved?s=s.concat(t.markersPreserved):!1===t.markersPreserved&&(s=[]),r.default.isNullOrUndef([t.shouldRemoveMarkers])||(this.shouldRemoveMarkers=t.shouldRemoveMarkers),this.shouldRemoveMarkers&&e.removeElements(e=>{if(e.getTag){const t=e.getTag();if(s.indexOf(t)<0)return++n,!0}return!1}),n}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MapGenerator=void 0;const i=o(n(4)),l=o(n(279)),c=n(46),u=n(19),h=n(118),d=n(13),p=a(n(16)),f=n(335),m=n(9),g=n(337),y=n(336),v=n(158),b=n(695),_=n(18),E=n(696),S=(l.default,p.ElementMarker),w=m.Random.getRNG(),C=function(e,t,n){return e>=t&&e<=n},O=function(e,t,n,s,r){let a=!0;if(r.exclude){if(r.exclude.bbox){const{ulx:o,uly:i,lrx:l,lry:c}=r.exclude.bbox;C(e,o,l)&&C(t,i,c)&&(a=!1),C(n,o,l)&&C(s,i,c)&&(a=!1)}}else r.maxY&&(a=s<=r.maxY);return a};class T{constructor(){this.cols=i.default.LEVEL_MEDIUM_X,this.rows=i.default.LEVEL_MEDIUM_Y,this._mapGen=new l.default.Arena(this.cols,this.rows),this._mapType=null,this._wallID=1,this.defaultMapElem=_.ELEM.FLOOR}static getAndSetRNG(e){if(e){if(e.rng)return e.rng;e.rng=w}return w}static addRandomSnow(e,t,n){const s=e.getFree().filter(e=>e.isOutdoors()),r=T.getAndSetRNG(n);let a=0;for(let e=0;e<s.length;e++){const n=r.getUniform(),o=s[e];if(n<=t){const t=o.getBaseElem().getType();if(_.snowElemMap[t]){const n=_.snowElemMap[t];++a,s[e].setBaseElem(n)}}}return a}static fromAsciiMap(e,t){const n=e.length,s=e[0].length,r=new c.CellMap(n,s);for(let a=0;a<n;a++)for(let n=0;n<s;n++){const s=e[a][n];if(t.hasOwnProperty(s)){const e=t[s];"function"!=typeof e?r.setBaseElemXY(a,n,e):(r.setBaseElemXY(a,n,t["."]),e(r,a,n))}else if("+"===s){const e=new S("+");e.setTag("door"),r.setBaseElemXY(a,n,t["."]),r.setElemXY(a,n,e)}else if("?"===s){const e=new S("?");e.setTag("loot"),r.setElemXY(a,n,e)}}return{map:r}}static getWallElem(e){const t=_.getElem(e);return t||_.ELEM.WALL}static getFloorElem(e){const t=_.getElem(e);return t||_.ELEM.FLOOR}static createSplashes(e,t,n){const s=n.elem||_.ELEM.WATER,r=new c.CellMap(e,t);return new E.MapForest(e,t,n).create((e,t,n)=>{r.setBaseElemXY(e,t,_.ELEM.FLOOR),1===n&&r.setBaseElemXY(e,t,s)}),{map:r}}static getOptions(e){return T.options[e]?Object.assign({},T.options[e]):(i.default.warn("MapGenerator","getOptions","Unknown map type "+e),{})}createEmptyMap(){return{map:new c.CellMap(this.cols,this.rows,this.defaultMapElem)}}getMap(e={}){const t={};if("function"==typeof this._mapGen)t.map=this._mapGen();else{const n=T.getWallElem(e.wallType),s=T.getFloorElem(e.floorType),r=new c.CellMap(this.cols,this.rows,this.defaultMapElem);this._mapGen.create((e,t,a)=>{a===this._wallID?r.setBaseElemXY(e,t,n):r.setBaseElemXY(e,t,s)}),t.map=r,"uniform"!==this._mapType&&"digger"!==this._mapType||(t.rooms=this._mapGen.getRooms(),t.corridors=this._mapGen.getCorridors())}return t}createRuins(e,t,n={}){let s={born:[4,5,6,7,8],survive:[2,3,4,5],connected:!0};s=Object.assign(s,n);const r=new l.default.Cellular(e,t,s);r.randomize(.9);for(let e=0;e<5;e++)r.create();return r.connect(null,1),this._wallID=0,r}createCellular(e,t){const n=new l.default.Cellular(e,t,{});n.randomize(.52);for(let e=0;e<5;e++)n.create();return n.connect(null,1),this._wallID=0,n}createRooms(e,t){return new l.default.Digger(e,t,{roomWidth:[5,20],dugPercentage:.7})}createTownBSP(e,t,n){const s=n.maxHouseX||100,r=n.maxHouseY||100,a=T.getAndSetRNG(n),o=new E.BSP.BSPGen({rng:a}),i=e-2,l=t-2,u=new E.BSP.Container(0,0,i,l),h=o.splitContainer(u,7).getLeafs();h.forEach(e=>{e.x+=1,e.y+=1}),a.shuffle(h);const d=T.getFloorElem(n.floorType),p=new c.CellMap(e,t,d),f=[],m=[],y=new g.HouseGenerator;return h.forEach(a=>{const{w:o,h:i}=a;let l=o-1,c=i-1;if(l>s&&(l=Math.round(l/2)),c>r&&(c=Math.round(c/2)),1===a.x?(a.x+=1,a.w-=1,l-=1):a.x===e-1&&(a.x-=1,a.w-=1,l-=1),1===a.y?(a.y+=1,a.h-=1,c-=1):a.y===t-1&&(a.y-=1,a.h-=1,c-=1),l>=5&&c>=5){l>10&&l%2!=0&&(l-=1),c>10&&c%2!=0&&(c-=1);const e={cols:l,rows:c};e.addWindows=n.addWindows;const t=y.createHouse(e);t&&(this.placeHouse(t,p,a.x,a.y,n),m.push(t))}else f.push(a)}),{map:p,houses:m,unused:f}}placeHouse(e,t,n,s,r){const a=e.coord,o=Object.keys(a),i=T.getWallElem(r.wallType);o.forEach(e=>{"#"===e?a[e].forEach(e=>{const r=e[0]+n,a=e[1]+s;t.setBaseElemXY(r,a,i)}):"+"===e||(":"===e?a[e].forEach(e=>{const r=e[0]+n,a=e[1]+s;t.setBaseElemXY(r,a,_.ELEM.FLOOR_HOUSE)}):"windows"===e&&a[e].forEach(e=>{const r=e[0]+n,a=e[1]+s;t.setBaseElemXY(r,a,_.ELEM.WINDOW)}))}),e.adjustCoord(n,s)}createForest(e){const t=new c.CellMap(this.cols,this.rows,this.defaultMapElem);return this.addForestToMap(t,e),{map:t}}addForestToMap(e,t){const n=t.ratio,{freeOnly:s}=t,r=T.getAndSetRNG(t);this._mapGen=new E.MapForest(this.cols,this.rows,t),s?this._mapGen.create((t,s,a)=>{const o=r.getUniform()<=n;1===a&&o?e.getCell(t,s).isFree()&&e.setBaseElemXY(t,s,_.ELEM.TREE):1===a&&e.getCell(t,s).isFree()&&e.setBaseElemXY(t,s,_.ELEM.GRASS)}):this._mapGen.create((t,s,a)=>{const o=r.getUniform()<=n;1===a&&o?e.setBaseElemXY(t,s,_.ELEM.TREE):1===a&&e.setBaseElemXY(t,s,_.ELEM.GRASS)})}createLakes(e){const t=new c.CellMap(this.cols,this.rows,this.defaultMapElem);return this._mapGen=new E.MapForest(this.cols,this.rows,e),this.addLakesToMap(t,e),{map:t}}addLakesToMap(e,t){t.freeOnly?this._mapGen.create((t,n,s)=>{1===s&&e.getCell(t,n).isFree()&&e.setBaseElemXY(t,n,_.ELEM.WATER)}):this._mapGen.create((t,n,s)=>{e.setBaseElemXY(t,n,_.ELEM.FLOOR),1===s&&e.setBaseElemXY(t,n,_.ELEM.WATER)})}addLakes(e,t,n){const s=n.lrx-n.ulx,r=n.lry-n.uly;this.setGen("lakes",s,r);const a=this.createLakes(t).map;this.addElementsToMap(e,a,"water",t,n)}addForest(e,t,n){this.cols=n.lrx-n.ulx,this.rows=n.lry-n.uly;const s=this.createForest(t).map;this.addElementsToMap(e,s,"tree",t,n)}addSplashes(e,t,n,s){this.cols=n.lrx-n.ulx,this.rows=n.lry-n.uly,this.setGen("splashes",this.cols,this.rows),this._mapGen=new E.MapForest(this.cols,this.rows,t);const r=new c.CellMap(this.cols,this.rows,this.defaultMapElem),a=s.map(e=>_.getElem(e));this._mapGen.create((e,t,n)=>{1===n?r.setBaseElemXY(e,t,a[0]):1===n&&r.setBaseElemXY(e,t,_.ELEM.GRASS)}),s.forEach(s=>{this.addElementsToMap(e,r,s,t,n)})}addCliffs(e,t,n){const s=e.cols,r=e.rows,a=this.createMountain(s,r,t).map;["cliff","stone","steep cliff","highrock"].forEach(s=>{this.addElementsToMap(e,a,s,t,n)})}addElementsToMap(e,t,n,s,r){i.default.forEach2D(t._map,(a,o)=>{const i=a+r.ulx,l=o+r.uly;if(d.Geometry.isInBbox(i,l,r)&&e.hasXY(i,l)){const r=t.getBaseElemXY(a,o);if(r.getType()===n)if(s.skipTypes){const t=e.getBaseElemXY(i,l).getType();s.skipTypes.hasOwnProperty(t)||e.setBaseElemXY(i,l,r)}else e.setBaseElemXY(i,l,r)}})}createWall(e,t,n){const s=new c.CellMap(e,t,this.defaultMapElem);let r=n.wallElem||_.ELEM.WALL;return n.wallType&&(r=T.getWallElem(n.wallType)),this._mapGen=new E.MapWall(e,t,n),this._mapGen.create((e,t,n)=>{1===n&&s.setBaseElemXY(e,t,r)}),{map:s}}createMountain(e,t,n){const s=new c.CellMap(e,t,this.defaultMapElem);n||(n=T.getOptions("mountain"));const r=(n.highRockThr-n.stoneThr)/3,a=T.getAndSetRNG(n);this._mapGen=new E.MapMountain(e,t,n),this._mapGen.create((e,t,o)=>{if(o>n.highRockThr)s.setBaseElemXY(e,t,_.ELEM.HIGH_ROCK);else if(o>n.stoneThr)o<n.stoneThr+r?s.setBaseElemXY(e,t,_.ELEM.CLIFF):o<n.stoneThr+2*r?s.setBaseElemXY(e,t,_.ELEM.STONE):s.setBaseElemXY(e,t,_.ELEM.STEEP_CLIFF);else if(o<n.chasmThr)o<n.chasmThr-.4?s.setBaseElemXY(e,t,_.ELEM.DEEP_CHASM):o<n.chasmThr-.2?s.setBaseElemXY(e,t,_.ELEM.CHASM):s.setBaseElemXY(e,t,_.ELEM.SHALLOW_CHASM);else{a.getUniform()<n.snowRatio?s.setBaseElemXY(e,t,_.ELEM.SNOW):s.setBaseElemXY(e,t,_.ELEM.FLOOR)}});let o=[];return n.nRoadTurns>0&&(o=this.createMountainPath(s,n)),{map:s,paths:o}}createMountainPath(e,t){const n=[],s=t.nRoadTurns||10;let r=Math.floor(e.rows/s);t.yPerTurn&&(r=t.yPerTurn),r<4&&(r=4);const a=[2,e.cols-3,Math.floor(e.cols/2)];let o=!0,i=-1,l=-1;const c=[(t,n)=>e.hasXY(t,n)&&e.getCell(t,n).isFree(),(t,n)=>e.hasXY(t,n)&&e.getCell(t,n).getBaseElem().getZ()<=1],d=T.getAndSetRNG(t);for(let p=0;o&&p<s;p++){o=!1;let s=i,f=l;0===p&&(s=Number.isInteger(t.startX)?t.startX:d.arrayGetRand(a),f=t.startY?t.startY:0);const m=d.arrayGetRand(a),g=(p+1)*r+f;if(O(s,f,m,g,t)){const t=u.Path.getMinWeightOrShortest(e,s,f,m,g,c);if(t){const s=h.Builder.addPathToMap(e,t);s.length>0&&(o=!0),n.push(s),i=m,l=g}else o=!0}else o=!0}if(t.maxY&&n.length>0){const s=n[n.length-1];if(s.length>0){const r=s[s.length-1],[o,i]=[r.x,r.y];let l=d.arrayGetRand(a);const p=t.maxY;if(t.endX&&(l=t.endX),p>i&&O(o,i,l,p,t)){const t=u.Path.getMinWeightOrShortest(e,o,i,l,p,c);if(t){const s=h.Builder.addPathToMap(e,t);n.push(s)}}}}return n}createSummit(e,t,n){const s=new c.CellMap(e,t,_.ELEM.SKY),r=n.ratio||.3;let[a,o]=[Math.floor(e/2),Math.floor(t/2)];const i=e*t,l=[[a,o]];s.setBaseElemXY(a,o,_.ELEM.FLOOR);let u=1;const h=T.getAndSetRNG(n);let d=1e4;for(;u/i<r;){[a,o]=h.arrayGetRand(l);const[e,t]=h.getRandDir();if(a+=e,o+=t,s.hasXY(a,o)&&"sky"===s.getBaseElemXY(a,o).getType()&&(l.push([a,o]),++u,s.setBaseElemXY(a,o,_.ELEM.FLOOR)),--d,d<=0)break}const p=T.getOptions("mountain");p.nRoadTurns=0,p.chasmThr=-10,p.stoneThr=.35,p.snowRatio=w.getUniformRange(.1,.4);const f=this.createMountain(e,t,p);for(let n=0;n<e;n++)for(let e=0;e<t;e++)s._map[n][e].getBaseElem()!==_.ELEM.SKY&&s._map[n][e].setBaseElem(f.map._map[n][e].getBaseElem());return{map:s}}createCave(e,t,n){this._mapGen=new E.MapMiner(e,t,n);const s=new c.CellMap(e,t,this.defaultMapElem),r=n.wallElem||_.ELEM.WALL_CAVE,a=n.floorElem||_.ELEM.FLOOR_CAVE;return this._mapGen.create((e,t,n)=>{1===n?s.setBaseElemXY(e,t,r):s.setBaseElemXY(e,t,a)}),{map:s,mapGen:this._mapGen}}createCryptNew(e,t,n={}){const s=n.tilesX||12,r=n.tilesY||7,a=new f.TemplateLevel(s,r);a.use(y.Crypt);const o=n.genParams||[2,2,2,2],i=n.roomCount||40;a.setGenParams(o),a.setRoomCount(i),a.create();const l={"#":_.ELEM.WALL_CRYPT,".":_.ELEM.FLOOR_CRYPT},c=T.fromAsciiMap(a.map,l);return c.tiles=a.getPlacedData(),c}createNest(e,t,n={}){const s=n.tilesX||12,r=n.tilesY||7,a=new f.TemplateLevel(s,r),o=n.genParams||[1,1,1,1,1,1];a.weights=b.Nests.weights,a.customMatchFilter=b.Nests.matchFilter,a.setStartRoomFunc(b.Nests.startRoomFuncNx3),a.setTemplates(b.Nests.templates),a.setGenParams(o),a.setRoomCount(-1),a.create();let l=_.ELEM.WALL,c=_.ELEM.FLOOR;n.wallType&&(l=T.getWallElem(n.wallType)),n.floorType&&(c=T.getFloorElem(n.floorType));const u={"#":l,".":c,"?":(e,t,n)=>{const s=new S("?");s.setXY(t,n),s.setTag("nest_loot"),e.getCell(t,n).setProp(i.default.TYPE_ELEM,s)}},h=T.fromAsciiMap(a.map,u);return h.tiles=a.getPlacedData(),h}createCastle(e,t,n={}){const s=n.genParams||[1,1,1,1];let r=5,a=5;Array.isArray(s)?s.forEach((e,t)=>{t<s.length/2?r+=e:a+=e}):i.default.err("MapGenerator","createCastle","GenParamsXY {x: [...], y: [...]} not supported yet!");const o=n.tilesX||Math.ceil(e/r),l=n.tilesY||Math.ceil(t/a),c=new f.TemplateLevel(o,l);c.use(v.Castle),n.models||n.templates?"string"==typeof n.models?c.setTemplates(v.Castle.Models[n.models]):"string"==typeof n.templates?c.setTemplates(v.Castle.templates[n.templates]):c.setTemplates(n.models):c.setTemplates(v.Castle.Models.full),2===n.nGates?c.setStartRoomFunc(v.Castle.startFuncTwoGates):4===n.nGates?c.setStartRoomFunc(v.Castle.startFuncFourGates):n.startRoomFunc&&c.setStartRoomFunc(n.startRoomFunc),n.constraintFunc&&c.setConstraintFunc(n.constraintFunc);const u=n.roomCount||40;c.setGenParams(s),c.setRoomCount(u),c.tryToMatchAllExits=!0,n.callbacks&&Object.keys(n.callbacks).forEach(e=>{c.addCallback(e,n.callbacks[e])}),c.create();return this.createCastleMapObj(c,n)}createCastleWall(e,t,n={}){const s=n.tilesX||Math.ceil(e/7),r=n.tilesY||Math.ceil(t/7),a=new f.TemplateLevel(s,r);a.use(v.Castle),a.setTemplates(v.Castle.Models.outerWall),a.setFiller(v.Castle.tiles.fillerFloor),2===n.nGates?a.setStartRoomFunc(v.Castle.startFuncTwoGates):n.startRoomFunc&&a.setStartRoomFunc(n.startRoomFunc),n.constraintFunc&&a.setConstraintFunc(n.constraintFunc),a.create();const o={"#":T.getWallElem(n.wallType),".":T.getFloorElem(n.floorType)},i=T.fromAsciiMap(a.map,o);return i.tiles=a.getPlacedData(),i}createCastleMapObj(e,t){const n=[],s={"#":T.getWallElem(t.wallType),".":T.getFloorElem(t.floorType),"&":(e,s,r)=>{if(e.setBaseElemXY(s,r,T.getFloorElem(t.floorType)),t.preserveMarkers){const t=new S("&");t.setTag("lever"),e.getCell(s,r).setProp(i.default.TYPE_ELEM,t),t.setXY(s,r),n.push(t)}},"|":(e,s,r)=>{if(e.setBaseElemXY(s,r,T.getFloorElem(t.floorType)),t.preserveMarkers){const t=new S("|");t.setTag("leverdoor"),e.getCell(s,r).setProp(i.default.TYPE_ELEM,t),t.setXY(s,r),n.push(t)}},":":(e,s,r)=>{if(e.setBaseElemXY(s,r,_.ELEM.FLOOR_HOUSE),t.preserveMarkers){const t=new S(":");t.setTag("living_quarter"),e.getCell(s,r).setProp(i.default.TYPE_ELEM,t),t.setXY(s,r),n.push(t)}},"+":(e,s,r)=>{if(e.setBaseElemXY(s,r,T.getFloorElem(t.floorType)),t.preserveMarkers){const t=new S("+");t.setTag("door"),e.getCell(s,r).setProp(i.default.TYPE_ELEM,t),t.setXY(s,r),n.push(t)}}},r=T.fromAsciiMap(e.map,s);return r.tiles=e.getPlacedData(),r.elements=n,r}createTownWithWall(e,t,n={}){const s=Math.ceil(e/7),r=Math.ceil(t/7),a=this.createCastleWall(e,t,n);n.levelType="empty";const o=7*(s-2),i=7*(r-2),l=this.createTownBSP(o,i,n),c=a.map;d.Geometry.mergeMapBaseElems(c,l.map,7,7);const u=l.houses;u.forEach(e=>{e.moveHouse(7,7)});const h=l.unused;return h&&h.forEach(e=>{e.x+=7,e.y+=7}),{map:c,houses:u,unused:h,tiles:a.tiles}}createArctic(e,t,n={}){const s=n.snowRatio||1;this.setGen("empty",e,t);const r=new c.CellMap(e,t,this.defaultMapElem);return T.addRandomSnow(r,s),{map:r}}setGen(e,t,n,s={}){switch(this.cols=t,this.rows=n,e=e.toLowerCase(),this._mapType=e,e){case"arctic":this._mapGen=this.createEmptyFunc("arctic",t,n);break;case"arena":this._mapGen=new l.default.Arena(t,n);break;case"cave":this._mapGen=new E.MapMiner(t,n);break;case"cellular":this._mapGen=this.createCellular(t,n);break;case"castle":break;case"crypt":this._mapGen=new l.default.Uniform(t,n,s);break;case"digger":this._mapGen=new l.default.Digger(t,n);break;case"divided":this._mapGen=new l.default.DividedMaze(t,n);break;case"dungeon":this._mapGen=new l.default.Rogue(t,n,s);break;case"empty":this._mapGen=this.createEmptyFunc("empty",t,n);break;case"eller":this._mapGen=new l.default.EllerMaze(t,n);break;case"forest":case"lakes":this._mapGen=new E.MapForest(t,n);break;case"labyrinth":this._mapGen=new l.default.DividedMaze(t,n);break;case"miner":this._mapGen=new E.MapMiner(t,n);break;case"mountain":this._mapGen=new E.MapMountain(t,n);break;case"icey":this._mapGen=new l.default.IceyMaze(t,n);break;case"rogue":this._mapGen=new l.default.Rogue(t,n,s);break;case"uniform":this._mapGen=new l.default.Uniform(t,n,s);break;case"ruins":this._mapGen=this.createRuins(t,n);break;case"rooms":this._mapGen=this.createRooms(t,n);break;case"town":this._mapGen=new l.default.Arena(t,n);break;case"townwithwall":case"summit":break;case"splashes":this._mapGen=new E.MapForest(t,n);break;case"wall":this._mapGen=new E.MapWall(t,n);break;default:i.default.err("MapGen","setGen","this._mapGen type "+e+" is unknown")}}createEmptyFunc(e,t,n){return"empty"===e&&(this.defaultMapElem=_.ELEM.FLOOR),()=>this.createEmptyMap().map}}t.MapGenerator=T,T.options={},T.options.mountain=Object.freeze({noiseMult:1,noiseDivider:20,highRockThr:.75,stoneThr:.5,chasmThr:-.4,nRoadTurns:8,snowRatio:0})},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryItem=t.ItemRandomizer=void 0;const i=o(n(4)),l=n(9),c=n(48),u=n(12),h=n(26),d=a(n(11)),p=l.Random.getRNG();class f{constructor(){this._foodWeights=i.default.getFoodWeightDistr(),this._runeWeights=i.default.getRuneChargeDistr(),this._adjustFunctions={food:this._adjustFoodItem.bind(this),goldcoin:this._adjustGoldCoin.bind(this),missile:this._adjustMissile.bind(this),weapon:this._adjustWeapon.bind(this),armour:this._adjustArmour.bind(this),ammo:this._adjustMissile.bind(this),rune:this._adjustRune.bind(this),tool:this._adjustTool.bind(this)}}adjustItem(e,t){const n=e.getType();this._adjustFunctions.hasOwnProperty(n)&&this._adjustFunctions[n](e,t)}_adjustFoodItem(e){const t=p.getWeighted(this._foodWeights);e.setWeight(parseFloat(t))}_adjustGoldCoin(e,t){if(i.default.isNullOrUndef([t]))i.default.err("ItemRandomizer","_adjustGoldCoin","nLevel is not defined.");else{const n=i.default.getGoldCoinCountDistr(t),s=p.getWeighted(n);e.setCount(parseInt(s,10))}}_adjustMissile(e,t){const n=Math.round(t/e.getValue());if(n>0){const t=p.getUniformInt(1,n);e.setCount(t)}else e.setCount(0)}_adjustTool(e){if(/seeds/.test(e.getName())){const t=e.getValue();let n=1;t<=5?n=p.getUniformInt(5,15):t<=10?n=p.getUniformInt(3,10):t<=20&&(n=p.getUniformInt(1,5)),e.setCount(n)}}_isCombatMod(e){return e>=0&&e<=.02}_isStatsMod(e){return e>=.1&&e<=.12}_getRandStat(){return p.arrayGetRand(i.default.STATS)}_adjustWeapon(e){const t=p.getUniform();if(this._isCombatMod(t)){const t=p.getUniformInt(1,5);switch(p.getUniformInt(0,4)){case 0:case 1:e.setAttack(e.getAttack()+t);break;case 2:case 3:e.setDefense(e.getDefense()+t);break;case 4:e.setProtection(e.getProtection()+t)}i.default.scaleItemValue("combat",t,e)}else if(this._isStatsMod(t)){const t=p.getUniformInt(1,3);let n=null;e.has("Stats")?n=e.get("Stats"):(n=new d.Stats,n.clearValues(),e.add(n));const s=this._getRandStat(),r="get"+s;n["set"+s](n[r]()+t),i.default.scaleItemValue("stats",t,e)}}_adjustArmour(e){this._adjustWeapon(e)}_adjustRune(e){const t=p.getWeighted(this._runeWeights);e.setCharges(t)}}t.ItemRandomizer=f;class m{constructor(){this._itemRandomizer=new f}static addItemsToActor(e,t){let n=null;t.forEach(t=>{n=m.createItemFromConstr(t),n&&e.getInvEq().addItem(n)})}static equipFullGearType(e,t){const n=u.ObjectShell.getParser(),s=new RegExp(t),r=n.filterItems(e=>"armour"===e.type&&s.test(e.name));return m.equipItemsToActor(e,r)}static equipWeaponOfType(e,t){const n=u.ObjectShell.getParser(),s=new RegExp(t),r=n.filterItems(e=>"weapon"===e.type&&s.test(e.name)),a=p.arrayGetRand(r);return m.equipItemsToActor(e,[a])}static equipItemsToActor(e,t){let n=null,s=!0;return t.forEach(t=>{if(n=m.createItemFromConstr(t),n){const t=n.getCount();e.getInvEq().addItem(n),s=s&&e.getInvEq().equipNItems(n,t)}}),s}static createItemFromConstr(e){const t=u.ObjectShell.getParser();let n=null;return"string"==typeof e?n=t.createItem(e):"object"==typeof e&&(e.func?n=t.createRandomItem({func:e.func}):e.name&&(n=t.createItem(e.name)),n&&e.count&&n.setCount(h.Dice.getValue(e.count))),n}_doItemSpecificAdjustments(e,t){this._itemRandomizer.adjustItem(e,t)}createItem(e){return u.ObjectShell.getParser().createRandomItem(e)}addNRandItems(e,t){const n=this.generateItems(t),s=u.ObjectShell.getParser();if(t.food){const e=s.createRandomItem({func:e=>"food"===e.type});e?(this._doItemSpecificAdjustments(e,t.maxValue),n.push(e)):i.default.warn("FactoryItem","addNRandItems","Item.Food was not created properly.")}return c.Placer.addPropsToFreeCells(e,n),n.length}generateItems(e){const t=e.itemsPerLevel||e.nItems,n=[];if(!t)return n;const s=u.ObjectShell.getParser();if(e.typeWeights)for(let r=0;r<t;r++){const t=p.getWeighted(e.typeWeights),r=n=>e.item(n)&&n.type===t,a=s.createRandomItem({func:r});a&&(this._doItemSpecificAdjustments(a,e.maxValue),n.push(a))}else for(let r=0;r<t;r++){const t=s.createRandomItem({func:e.item});t&&(this._doItemSpecificAdjustments(t,e.maxValue),t.getCount()>0&&n.push(t))}return n}generateGold(e){const t=e.goldPerLevel||e.nGold,n=u.ObjectShell.getParser(),s=[];if(!t)return s;for(let r=0;r<t;r++){const t=n.createItem(i.default.GOLD_COIN_NAME);i.default.isNullOrUndef([e.nLevel])?i.default.warn("FactoryItem","generateGold","nLevel null/undef in conf "+JSON.stringify(e)):this._doItemSpecificAdjustments(t,e.nLevel),s.push(t)}return s}addRandomGold(e,t,n){const s=this.generateGold(n);c.Placer.addPropsToFreeCells(e,s)}getShopItem(e,t){let n=null;return t.shopFunc?"function"==typeof t.shopFunc[e]?n=t.parser.createRandomItem({func:t.shopFunc[e]}):i.default.err("FactoryItem","createShop -> getShopItem","shopFunc must be a function."):Array.isArray(t.shopType)?t.shopType.length<e?n=t.parser.createRandomItem({func:n=>n.type===t.shopType[e]}):i.default.err("FactoryItem","getShopItem",`${e} out of bounds in conf. ${JSON.stringify(t.shopType)}`):n="string"==typeof t.shopType?t.parser.createRandomItem({func:e=>e.type===t.shopType}):t.parser.createRandomItem({func:t=>t.value<=50+100*e&&"goldcoin"!==t.type}),n&&this._doItemSpecificAdjustments(n,50+100*e),n}addItemsToCells(e,t,n,s){s.maxValue||i.default.err("FactoryItem","addItemsToCells","conf is missing maxValue");const r=this.generateItems(s);c.Placer.addPropsToCells(e,n,r)}}t.FactoryItem=m},function(e,t,n){var s=n(66),r=n(49),a=n(227),o=n(98),i=function(e,t,n){var l,c,u,h=e&i.F,d=e&i.G,p=e&i.S,f=e&i.P,m=e&i.B,g=e&i.W,y=d?r:r[t]||(r[t]={}),v=y.prototype,b=d?s:p?s[t]:(s[t]||{}).prototype;for(l in d&&(n=t),n)(c=!h&&b&&void 0!==b[l])&&l in y||(u=c?b[l]:n[l],y[l]=d&&"function"!=typeof b[l]?n[l]:m&&c?a(u,s):g&&b[l]==u?function(e){var t=function(t,n,s){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,n)}return new e(t,n,s)}return e.apply(this,arguments)};return t.prototype=e.prototype,t}(u):f&&"function"==typeof u?a(Function.call,u):u,f&&((y.virtual||(y.virtual={}))[l]=u,e&i.R&&v&&!v[l]&&o(v,l,u)))};i.F=1,i.G=2,i.S=4,i.P=8,i.B=16,i.W=32,i.U=64,i.R=128,e.exports=i},function(e,t){var n=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n){var c="",u="",h=t;if("string"==typeof t){if(void 0===n)return e.style[(0,s.default)(t)]||(0,a.default)(e).getPropertyValue((0,r.default)(t));(h={})[t]=n}Object.keys(h).forEach((function(t){var n=h[t];n||0===n?(0,l.default)(t)?u+=t+"("+n+") ":c+=(0,r.default)(t)+": "+n+";":(0,o.default)(e,(0,r.default)(t))})),u&&(c+=i.transform+": "+u+";");e.style.cssText+=";"+c};var s=c(n(258)),r=c(n(438)),a=c(n(440)),o=c(n(441)),i=n(259),l=c(n(442));function c(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];function s(){for(var e=arguments.length,n=Array(e),s=0;s<e;s++)n[s]=arguments[s];var r=null;return t.forEach((function(e){if(null==r){var t=e.apply(void 0,n);null!=t&&(r=t)}})),r}return(0,a.default)(s)};var s,r=n(107),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return function(t,n,s,r,a){var o=s||"<<anonymous>>",i=a||n;if(null==t[n])return new Error("The "+r+" `"+i+"` is required to make `"+o+"` accessible for users of assistive technologies such as screen readers.");for(var l=arguments.length,c=Array(l>5?l-5:0),u=5;u<l;u++)c[u-5]=arguments[u];return e.apply(void 0,[t,n,s,r,a].concat(c))}},e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(1));t.default=e=>o.createElement("div",{className:"modal-header"},o.createElement("button",{"aria-label":"Close",className:"close","data-dismiss":"modal",type:"button"},o.createElement("span",{"aria-hidden":"true"},"ร")),o.createElement("h4",{className:"modal-title",id:e.id},e.text))},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BrainSentient=t.BrainNonSentient=t.Brain=t.NO_ACTION_TAKEN=t.ACTION_ALREADY_DONE=void 0;const i=o(n(4)),l=a(n(11)),c=n(13),u=n(134),h=n(176),d=n(9),p=n(19);t.ACTION_ALREADY_DONE=Object.freeze(()=>{}),t.NO_ACTION_TAKEN=Object.freeze(()=>{});const f=d.Random.getRNG();t.Brain={},t.Brain.getCellsAroundActor=(e,t=1)=>{const n=e.getLevel().getMap(),[s,r]=e.getXY(),a=[];for(let e=s-t;e<=s+t;e++)for(let o=r-t;o<=r+t;o++)n.hasXY(e,o)&&(e===s&&o===r||a.push(n.getCell(e,o)));return a},t.Brain.getBoxOfFreeCellsAround=(e,t)=>{const n=e.getLevel().getMap(),[s,r]=e.getXY();let a=c.Geometry.getBoxAround(s,r,t);a=a.filter(e=>n.hasXY(e[0],e[1]));let o=a.map(e=>n.getCell(e[0],e[1]));return o=o.filter(e=>e.isFree()),o},t.Brain.findCellsWithActors=(e,t,n)=>{const s=[];for(let r=0,a=t.length;r<a;r++)if(t[r].hasActors()){const a=t[r].getActors();a[0].getID()!==e.getID()&&(n&&n(a)?s.push(t[r]):n||s.push(t[r]))}return s},t.Brain.getActorsInCells=(e,t)=>{const n=[];for(let s=0,r=e.length;s<r;s++)if(e[s].hasActors()){const r=e[s].getActors();1===r.length?t?t(r[0])&&n.push(r[0]):n.push(r[0]):r.forEach(e=>{t?t(e)&&n.push(e):n.push(e)})}return n},t.Brain.getSeenHostiles=e=>{const n=e.getBrain().getSeenCells();return t.Brain.getActorsInCells(n,t=>t.isEnemy(e))},t.Brain.findCellsWithFriends=(e,t)=>{const n=[];for(let s=0,r=t.length;s<r;s++)if(t[s].hasActors()){t[s].getSentientActors().forEach(r=>{r.getID()!==e.getID()&&(r.isEnemy(e)||n.push(t[s]))})}return n},t.Brain.getActorCellsAround=e=>t.Brain.getCellsAroundActor(e).filter(e=>e.hasActors()),t.Brain.getActorsAround=e=>{const n=t.Brain.getCellsAroundActor(e);let s=[];return n.forEach(e=>{e.hasActors()&&(s=s.concat(e.getActors()))}),s},t.Brain.getEnemyCellsAround=e=>t.Brain.getCellsAroundActor(e).filter(t=>t.hasActors()&&e.getBrain().getMemory().isEnemy(t.getActors()[0])),t.Brain.getFriendCellsAround=e=>t.Brain.getCellsAroundActor(e).filter(t=>t.hasActors()&&e.getBrain().getMemory().isFriend(t.getActors()[0])),t.Brain.distToActor=(e,t)=>{const[n,s]=e.getXY(),[r,a]=t.getXY();return function(e,t,n,s){const r=c.Geometry.getBresenham(e,t,n,s).length-1;return r>0?r:0}(n,s,r,a)},t.Brain.getTelepathyCells=function(e){const t=e.getLevel().getID(),n=e.getList("Telepathy");let s=[];return n.forEach(e=>{const n=e.getTarget(),r=n.getLevel();if(i.default.isActorActive(n)&&r.getID()===t){const e=r.getMap().getCellsInFOV(n);s=s.concat(e)}}),s};class m extends u.BrainBase{constructor(e){super(e),this.setType("NonSentient")}decideNextAction(e){return t.NO_ACTION_TAKEN}}t.BrainNonSentient=m,t.Brain.NonSentient=m;class g extends u.BrainBase{constructor(e){super(e),this._explored={},this._type="Sentient",this._memory=new h.Memory,this._cache={seen:[]}}getMemory(){return this._memory}addEnemy(e){this._memory.addEnemy(e)}addFriend(e){this._memory.addFriend(e)}addEnemyType(e){this._memory.addEnemyType(e)}decideNextAction(e){return this._cache.seen=[],i.default.err("BrainSentient","decideNextAction","Not implemented in this class"),null}getSeenCells(){if(this._cache.seen)return this._cache.seen;const e=this._actor.getLevel().getMap();if(i.default.isSentient(this._actor)){if(this._cache.seen=e.getCellsInFOV(this._actor),this._actor.has("Telepathy")){const e=t.Brain.getTelepathyCells(this._actor);this._cache.seen=this._cache.seen.concat(e)}return this._cache.seen}return i.default.warn("Brain","Sentient","Called with non-sentient actor "+this._actor.getName()),[]}canSeeCell(e){if(this._cache.seen)return this._cache.seen.indexOf(e)>=0;const t=this._actor.getLevel().getMap();return!!i.default.isSentient(this._actor)&&t.canSeeCell(this._actor,e)}canMeleeAttack(e,t){const n=this._actor.get("Combat").getAttackRange(),[s,r]=i.default.dXdYAbs([e,t],this._actor);return s<=n&&r<=n}findSeenCell(e){return this.getSeenCells().filter(e)}canSeeActor(e){const n=this.getSeenCells(),s=t.Brain.findCellsWithActors(this._actor,n);let r=!1;return s.forEach(t=>{const n=t.getActors();n&&n.forEach(t=>{t.getID()===e.getID()&&(r=!0)})}),r}findEnemyCell(e){const n=[],s=t.Brain.findCellsWithActors(this._actor,e);for(let e=0;e<s.length;e++){const t=s[e].getSentientActors();for(let r=0;r<t.length;r++)if(this._memory.isEnemy(t[r])){if(this._memory.addEnemySeenCell(t[r]),this._memory.wasLastAttacked(t[r]))return s[e];n.push(s[e])}}return n.length>0?f.arrayGetRand(n):null}findEnemyCellFast(){const[e,t]=this._actor.getXY(),n=i.default.getFOVRange(this._actor),s=c.Geometry.getBoxAround(e,t,n);let r=null;const a=this._actor.getLevel().getMap();for(let e=0;e<s.length;e++){const[t,n]=s[e];if(null!==r)break;if(a.hasXY(t,n)){const e=a.getCell(t,n);if(e.hasActors()){const t=e.getFirstActor();if(this._actor.isEnemy(t)&&(r=e,this._memory.wasLastAttacked(t)))return r}}}if(null===r)return r;const o=this.getSeenCells();return this.findEnemyCell(o)}findFriendCell(e){const n=this.getMemory(),s=t.Brain.findCellsWithActors(this._actor,e);for(let e=0;e<s.length;e++){const t=s[e].getActors();if(!n.isEnemy(t[0]))return s[e]}return null}toJSON(){return{type:this.getType(),memory:this.getMemory().toJSON()}}canPickupItem(){const e=this._actor.getCell();if(e&&e.hasItems()){const t=e.getItems()[0];return this._actor.getInvEq().canCarryItem(t)}return!1}pickupItem(){return()=>{const e=new l.Pickup;this._actor.add(e)}}tryToMoveTowardsCell(e){const n=this._actor.getLevel(),[s,r]=this._actor.getXY(),[a,o]=[e.getX(),e.getY()];let[i,c]=[a-s,o-r];i=0!==i?i/Math.abs(i):0,c=0!==c?c/Math.abs(c):0;const[u,h]=[s+i,r+c];if(n.getMap().getCell(u,h).isPassable())return()=>{const e=new l.Movement(u,h,n);this._actor.add(e)};const d=this.getShortestPathTo(e);if(d.length>1){const e=d[1].getX(),t=d[1].getY();return()=>{const s=new l.Movement(e,t,n);this._actor.add(s)}}return t.NO_ACTION_TAKEN}getSeenFriends(){const e=[],n=this.getMemory(),s=this.getSeenCells(),r=t.Brain.findCellsWithActors(this._actor,s);for(let t=0;t<r.length;t++){const s=r[t].getActors();n.isFriend(s[0])&&e.push(s[0])}return e}getSeenEnemies(){const e=this.getMemory(),n=this.getSeenCells();return t.Brain.getActorsInCells(n,t=>e.isEnemy(t))}getShortestPathTo(e){const[t,n]=e.getXY(),[s,r]=this._actor.getXY(),a=this._actor.getLevel().getMap();return p.Path.getShortestActorPath(a,s,r,t,n).map(e=>a.getCell(e.x,e.y))}getFreeCellsAround(){return t.Brain.getCellsAroundActor(this._actor).filter(e=>e.isFree())}getRandAdjacentFreeCell(){const e=this.getFreeCellsAround();return e.length>0?f.arrayGetRand(e):null}}t.BrainSentient=g,t.Brain.Sentient=g},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.statusToString=t.GoalRest=t.GoalChangeLevel=t.GoalEquip=t.GoalUseSkill=t.GoalCommunicate=t.GoalMonitor=t.GoalGoHome=t.GoalShopkeeper=t.GoalOrders=t.GoalFindMissile=t.GoalFindAmmo=t.GoalFindGold=t.GoalFindFood=t.GoalFindWeapon=t.GoalFindItem=t.GoalGetItem=t.GoalFollow=t.GoalCastSpell=t.GoalFleeFromActor=t.GoalExplore=t.GoalShootActor=t.GoalHitActor=t.GoalAttackActor=t.GoalPatrol=t.GoalGuardArea=t.GoalGuard=t.GoalGotoSeenActor=t.GoalGotoActor=t.GoalMoveUntilEnemy=t.GoalFollowPath=t.GoalBase=t.GoalStatus=t.GoalType=t.Goal=void 0;const i=o(n(15)).default("bitn:Goal"),l=o(n(4)),c=a(n(11)),u=n(27),h=n(19),d=n(9),p=n(60),f=d.Random.getRNG();var m;t.Goal={},t.Goal.ACTOR_FILTER="",t.Goal.StatusStrings={1:"GOAL_ACTIVE",2:"GOAL_COMPLETED",3:"GOAL_INACTIVE",4:"GOAL_FAILED"},function(e){e[e.NORMAL=1]="NORMAL",e[e.MOVE=2]="MOVE",e[e.KILL=3]="KILL",e[e.FIND=4]="FIND",e[e.AGGRESSION=5]="AGGRESSION"}(m=t.GoalType||(t.GoalType={})),t.Goal.Types=m;var g;!function(e){e[e.GOAL_ACTIVE=1]="GOAL_ACTIVE",e[e.GOAL_COMPLETED=2]="GOAL_COMPLETED",e[e.GOAL_INACTIVE=3]="GOAL_INACTIVE",e[e.GOAL_FAILED=4]="GOAL_FAILED"}(g=t.GoalStatus||(t.GoalStatus={}));let y=0;class v{constructor(e){this.subGoals=null,this.actor=e,this.status=g.GOAL_INACTIVE,this.type="",this.category=m.NORMAL,this.planBGoal=null,this._debug=!1}setDebug(e){this._debug=e}dbg(e){if(i.enabled||this._debug){let n=!1;if(t.Goal.ACTOR_FILTER||(n=!0),!n){n=new RegExp(t.Goal.ACTOR_FILTER).test(this.actor.getName())}if(n){const t="  ".repeat(y),n=this.actor.getName(),s=J(this.status),r=`[${this.getType()}] st: ${s}`;console.log(`${t}${r} ${n} ${e}`)}}}setCategory(e){this.category=e}getCategory(){return this.category}setType(e){this.type=e}getType(){return this.type}hasPlanB(){return null!==this.planBGoal}getPlanB(){return this.planBGoal}activate(){throw new Error("Pure virtual method")}activateIfInactive(){this.isInactive()&&(this.dbg("Activating inactive"),this.activate())}reactivateIfFailed(){this.hasFailed()&&(this.dbg("Re-Activating failed"),this.status=g.GOAL_INACTIVE)}process(){if(Array.isArray(this.subGoals)){return this.subGoals[0].process()}return this.status}terminate(){this.dbg("Goal terminated!"),this.status=g.GOAL_COMPLETED}handleMsg(e){Array.isArray(this.subGoals)&&this.subGoals[this.subGoals.length-1].handleMsg(e)}processSubGoals(){++y;let e=g.GOAL_FAILED;if(this.dbg("Start processSubGoals()"),!Array.isArray(this.subGoals)){const e=this.actor.getName(),t=`Type: ${this.type}, actor: ${e}`;throw new Error(t+" No subgoals in non-terminal goal")}if(this.removeFinishedOrFailed(),this.subGoals.length>0){const t=this.subGoals[0];e=t.process(),e===g.GOAL_COMPLETED&&this.subGoals.length>1?e=g.GOAL_ACTIVE:e===g.GOAL_FAILED&&t.hasPlanB()&&(this.subGoals[0]=t.getPlanB(),this.subGoals[0].setType(t.getType()),e=g.GOAL_ACTIVE)}else e=g.GOAL_COMPLETED;return--y,this.dbg("End processSubGoals() with status "+J(e)),i.enabled&&this.dbg("  subGoals left: "+this.subGoals.map(e=>e.getType())),e}removeFinishedOrFailed(){this.subGoals=this.subGoals.filter(e=>!e.isCompleted()&&!e.hasFailed())}removeAllSubGoals(){Array.isArray(this.subGoals)&&(this.subGoals.forEach(e=>{e.terminate()}),this.subGoals=[]),this.dbg("Removed all subGoals")}removeSubGoalsOfType(e){let t=0;if(Array.isArray(this.subGoals)){let n=this.subGoals.findIndex(t=>t.type===e);for(;n>=0;)this.subGoals[n].terminate(),this.subGoals.splice(n,1),++t,n=this.subGoals.findIndex(t=>t.type===e)}return t}getSubGoals(){return this.subGoals}hasSubGoals(e){if(Array.isArray(this.subGoals)){if(e){return this.subGoals.findIndex(t=>t.type===e)>=0}return this.subGoals.length>0}return!1}addSubGoal(e){if(Array.isArray(this.subGoals)||(this.subGoals=[]),this.subGoals.unshift(e),i.enabled){this.dbg("Added subGoal "+e.getType());const t=this.subGoals.map(e=>e.getType());this.dbg("   Subgoals are now: "+t)}this._debug&&(e._debug=!0)}isInactive(){return this.status===g.GOAL_INACTIVE}isActive(){return this.status===g.GOAL_ACTIVE}hasFailed(){return this.status===g.GOAL_FAILED}isCompleted(){return this.status===g.GOAL_COMPLETED}isGoalPresent(e){if(Array.isArray(this.subGoals)){const t=this.subGoals.find(t=>t.getType()===e);if(t&&!t.hasFailed()&&!t.isCompleted())return i.enabled&&(this.dbg(`subGoal ${e} already present.`),this.dbg("  SubGoal status: "+t.status)),!0}return!1}}t.GoalBase=v,t.Goal.Base=v;class b extends v{constructor(e,t){super(e),this.setType("GoalFollowPath"),this.path=[],this.xy=t}activate(){const[e,t]=this.xy,[n,s]=[this.actor.getX(),this.actor.getY()];this.dbg(`Calc path ${n},${s} -> ${e},${t}`);const r=this.actor.getLevel().getMap(),a=h.Path.getShortestActorPath(r,n,s,e,t);this.path=a,this.status=g.GOAL_ACTIVE,this.dbg("activate() path length: "+this.path.length)}process(){return this.activateIfInactive(),this.path.length>0?(this.status=this.followPath(),this.status):(this.dbg("process() ret GoalStatus.GOAL_COMPLETED"),this.status=g.GOAL_COMPLETED,this.status)}followPath(){const e=this.actor.getLevel(),[t,n]=this.actor.getXY(),{x:s,y:r}=this.path[0],[a,o]=[s,r],i=this.path.length;if(this.dbg(`followPath() test move ${t},${n} -> ${s},${r}, path ${i} `),e.getMap().isPassable(a,o,t,n)){const l=Math.abs(t-s),u=Math.abs(n-r);if(l<=1&&u<=1){const t=new c.Movement(a,o,e);return this.actor.add(t),this.path.shift(),0===this.path.length?(this.dbg("followPath() ret GOAL_COMPL, path "+i),this.status=g.GOAL_COMPLETED,g.GOAL_COMPLETED):(this.dbg("followPath() ret GoalStatus.GOAL_ACTIVE, path "+i),this.status=g.GOAL_ACTIVE,g.GOAL_ACTIVE)}return this.dbg("followPath() strayed, ret GoalStatus.GOAL_FAILED, path "+i),this.status=g.GOAL_FAILED,g.GOAL_FAILED}return this.dbg("followPathl() next NOT passable ret GoalStatus.GOAL_FAILED"),this.status=g.GOAL_FAILED,g.GOAL_FAILED}}t.GoalFollowPath=b,t.Goal.FollowPath=b;class _ extends v{constructor(e,t){super(e),this.setType("GoalMoveUntilEnemy"),this.dir=t}activate(){this.timeout=100,this.status=g.GOAL_ACTIVE}process(){this.activateIfInactive();const e=this.actor.getBrain(),t=e.getSeenCells(),n=e.findEnemyCell(t),[s,r]=this.actor.getXY(),[a,o]=function(e,t){const[n,s]=e.getXY();return[n+t[0],s+t[1]]}(this.actor,this.dir),l=this.actor.getLevel().getMap();if(n){const[e,t]=[n.getX(),n.getY()];i.enabled&&this.dbg(`Has moved enough. Enemy found @${e},${t}`),this.status=g.GOAL_COMPLETED}else if(l.hasObstacle(a,o))this.status=g.GOAL_FAILED,i.enabled&&this.dbg("OBSTACLE ENCOUNTERED");else if(0===this.timeout)this.status=g.GOAL_FAILED,i.enabled&&this.dbg("TIMEOUT REACHED");else if(l.isPassable(a,o,s,r)){const e=this.actor.getLevel(),t=new c.Movement(a,o,e);this.actor.add(t);const n=this.actor.getName();i.enabled&&this.dbg(`Moving ${n} to ${a},${o}`)}return--this.timeout,this.status}}t.GoalMoveUntilEnemy=_,t.Goal.MoveUntilEnemy=_;class E extends b{constructor(e,t){super(e,[0,0]),this.setType("GoalGotoActor"),this.xy=t.getXY(),this.targetActor=t,this.pathFunc=h.Path.getActorToActorPath}activate(){const e=this.getPath();this.dbg("activate() path length: "+e.length),this.path=e,this.status=g.GOAL_ACTIVE,this.dbg("activate() path length: "+this.path.length)}getPath(){const e=this.actor.getLevel().getMap(),[t,n]=this.xy,[s,r]=[this.actor.getX(),this.actor.getY()];return this.dbg(`${this.getType()} ${s},${r} -> ${t},${n}`),h.Path.getActorToActorPath(e,s,r,t,n)}process(){this.activateIfInactive();const[e,t]=[this.targetActor.getX(),this.targetActor.getY()],[n,s]=this.xy,r=Math.abs(e-n),a=Math.abs(t-s);return r>2||a>2?(this.followPath(),this.status=g.GOAL_FAILED,g.GOAL_FAILED):this.path.length>0?this.followPath():(this.dbg("process() ret GoalStatus.GOAL_COMPLETED"),this.status=g.GOAL_COMPLETED,g.GOAL_COMPLETED)}}t.GoalGotoActor=E,t.Goal.GotoActor=E;class S extends E{constructor(e,t){super(e,t),this.setType("GoalGotoSeenActor")}getPath(){const e=this.actor.getLevel().getMap(),[t,n]=this.xy;return h.Path.getShortestSeenPath(this.actor,e,t,n)}}t.GoalGotoSeenActor=S,t.Goal.GotoSeenActor=S;class w extends v{constructor(e,t,n=1){super(e),this.setType("GoalGuard"),this.dist=n,this.x=t[0],this.y=t[1],this.subGoals=[]}activate(){this.checkDistToGuardPoint()}process(){if(this.activateIfInactive(),this.status=this.processSubGoals(),this.subGoals.length>0){this.subGoals[0].hasFailed()&&this.checkDistToGuardPoint()}else this.checkDistToGuardPoint();return this.status}checkDistToGuardPoint(){const[e,t]=l.default.dXdYAbs([this.x,this.y],this.actor.getXY());(e>this.dist||t>this.dist)&&this.addSubGoal(new b(this.actor,[this.x,this.y]))}}t.GoalGuard=w,t.Goal.Guard=w;class C extends v{constructor(e,t,n=1){super(e),this.setType("GoalGuardArea"),this.dist=n,this.bbox=t,this.subGoals=[]}activate(){this.checkDistToGuardArea()}process(){if(this.activateIfInactive(),this.status=this.processSubGoals(),this.subGoals.length>0){this.subGoals[0].hasFailed()&&this.checkDistToGuardArea()}else this.checkDistToGuardArea();return this.status}checkDistToGuardArea(){const[e,t]=this.actor.getXY();if(!this.bbox.hasXY(e,t)){const[e,t]=this.bbox.getDist(this.actor.getXY());if(e>this.dist||t>this.dist){const[e,t]=this.bbox.getRandXY();this.addSubGoal(new b(this.actor,[e,t]))}}}}t.GoalGuardArea=C,t.Goal.GuardArea=C;class O extends v{constructor(e,t){super(e),this.setType("GoalPatrol"),this.coords=t,this.coords.length<2&&l.default.err("GoalPatrol","constructor","Provide >= 2 coords for patrolling. Got "+t),this.currIndex=0,this.currTarget=t[this.currIndex],this.patrolDist=3}activate(){this.dbg(this.getType()+" activate()"),this.recomputePatrolPath()}process(){this.activateIfInactive(),this.status=this.processSubGoals(),this.dbg("GoalPatrol process(), got subStatus: "+J(this.status));const e=this.subGoals[0];if(e.isCompleted())this.nextPatrolPoint();else if(e.hasFailed()){this.dbg(this.getType()+" process() path failed");const[e,t]=this.actor.getXY(),[n,s]=this.currTarget;h.Path.shortestDist(e,t,n,s)<=this.patrolDist?this.nextPatrolPoint():this.recomputePatrolPath()}else this.dbg(this.getType()+" XXX NOT HERE!");return this.status}nextPatrolPoint(){++this.currIndex,this.currIndex>=this.coords.length&&(this.currIndex=0),this.currTarget=this.coords[this.currIndex],this.addSubGoal(new b(this.actor,this.currTarget)),this.dbg(`${this.getType()} next patrol point ${this.currTarget}`),this.status=g.GOAL_ACTIVE}recomputePatrolPath(){this.addSubGoal(new b(this.actor,this.currTarget)),this.dbg(`${this.getType()} recompute to point ${this.currTarget}`),this.status=g.GOAL_ACTIVE}}t.GoalPatrol=O,t.Goal.Patrol=O;class T extends v{constructor(e,t){super(e),this.setType("GoalAttackActor"),this.targetActor=t}activate(){this.dbg("activate() called"),this.selectSubGoal(),this.isCompleted()||(this.status=g.GOAL_ACTIVE)}process(){this.activateIfInactive();const e=this.actor.getBrain(),t=e.getSeenCells(),n=e.findEnemyCell(t);if(n){const t=n.getActors()[0];if(this.targetActor.getID()!==t.getID()){if(this.print){const e=this.actor.getName(),n=this.targetActor.getName(),s=t.getName();l.default.log(`${e}:: Recomp target ${n} -> ${s}`)}this.targetActor=t,e.getMemory().setLastAttacked(t),this.selectSubGoal()}}else this.checkTargetStatus();return this.isCompleted()||this.hasFailed()||(this.status=this.processSubGoals()),this.status}terminate(){this.dbg("Terminating completed attack actor task"),this.status=g.GOAL_COMPLETED}canMissileAttack(){const[e,t]=this.targetActor.getXY(),[n,s]=this.actor.getXY(),r=this.actor.getInvEq().getMissile();if(r){const a=l.default.getMissileRange(this.actor,r);if(h.Path.shortestDist(e,t,n,s)<=a)return!0}return!1}selectSubGoal(){const e=this.actor.getBrain();if(this.checkTargetStatus(),!this.isCompleted()){const[t,n]=this.targetActor.getXY();if(e.canMeleeAttack(t,n)){this.removeAllSubGoals(),this.dbg("canMeleeAttack() OK");const e=new M(this.actor,this.targetActor);this.addSubGoal(e)}else if(this.canMissileAttack()){this.removeAllSubGoals(),this.dbg("canMissileAttack() OK");const e=new A(this.actor,this.targetActor);this.addSubGoal(e)}else if(e.canSeeActor(this.targetActor)){this.removeAllSubGoals(),this.dbg("canSeeActor subGoal GoalGotoActor");const e=new S(this.actor,this.targetActor);this.addSubGoal(e)}else{this.removeAllSubGoals(),this.dbg("Moving blind subGoal GoalGotoActor");const e=new E(this.actor,this.targetActor);this.addSubGoal(e)}}}checkTargetStatus(){const e=this.targetActor.get("Health");if(!e){const e=JSON.stringify(this.targetActor),t=JSON.stringify(this.actor);l.default.log("Attacker: "+t),l.default.err("GoalAttackActor","checkTargetStatus","target has no health: "+e)}e.isDead()?(this.removeAllSubGoals(),this.status=g.GOAL_COMPLETED,this.dbg("Enemy is dead. Goal completed")):l.default.inSameLevel(this.actor,this.targetActor)||(this.removeAllSubGoals(),this.status=g.GOAL_COMPLETED,this.dbg("Enemy not in this level. Goal completed"))}}t.GoalAttackActor=T,t.Goal.AttackActor=T;class M extends v{constructor(e,t){super(e),this.setType("GoalHitActor"),this.targetActor=t}activate(){const e=this.actor.getLevel(),[t,n]=this.targetActor.getXY(),s=e.getMap().getCell(t,n).getProp("actors")[0],r=new c.Attack({target:s});this.actor.add(r),this.dbg(this.getType()+" added Attack comp"),this.status=g.GOAL_ACTIVE}process(){return this.activateIfInactive(),this.status=g.GOAL_COMPLETED,this.status}}t.GoalHitActor=M;class A extends v{constructor(e,t){super(e),this.setType("GoalShootActor"),this.targetActor=t}activate(){const e=new c.AttackRanged;e.setAttacker(this.actor),e.setTarget(this.targetActor),this.actor.add(e),this.dbg(this.getType()+" added Missile comp"),this.status=g.GOAL_ACTIVE}process(){return this.activateIfInactive(),this.status=g.GOAL_COMPLETED,this.status}}t.GoalShootActor=A;class N extends v{constructor(e,t=-1){super(e),this.setType("GoalExplore"),this.dur=t}activate(){this.setNewPassableDir(),this.dbg(`activate Explore dX,dY: ${this.dX},${this.dY}`),this.status=g.GOAL_ACTIVE}setCallback(e){this.exploreCb=e}setNewPassableDir(){let e=5,[t,n]=f.getRandDir();for(;e>0&&!this.isDirPassable(t,n);)[t,n]=f.getRandDir(),--e;this.dX=t,this.dY=n}isDirPassable(e,t){const[n,s]=this.actor.getXY(),r=n+e,a=s+t;return this.actor.getLevel().getMap().isPassable(r,a,n,s)}shouldMoveTo(e,t,n){const[s,r]=this.actor.getXY();let a=e.isPassable(t,n,s,r);if(this.actor.has("Flying")&&(a=e.isPassableByAir(t,n)),a){return!e.getCell(t,n).isDangerous()}return!1}process(){this.activateIfInactive(),this.checkChangeDir(),--this.dur;const[e,t]=this.actor.getXY(),n=e+this.dX,s=t+this.dY,r=this.actor.getLevel(),a=r.getMap();if(a.hasXY(n,s))if(this.shouldMoveTo(a,n,s)){const e=new c.Movement(n,s,r);this.actor.add(e)}else this.canOpenDoorAt(a,n,s)||this.setNewPassableDir();else this.setNewPassableDir();return 0===this.dur&&(this.status=g.GOAL_COMPLETED),this.exploreCb&&this.exploreCb(n,s),this.status}canOpenDoorAt(e,t,n){const s=e.getCell(t,n);if(s.hasDoor()){const e=s.getPropType("door")[0];if(e.canToggle()){const t=new c.OpenDoor;return t.setDoor(e),this.actor.add(t),!0}}return!1}checkChangeDir(){const e=f.getUniform();if(e<=.07){const e=this.changeDir(this.dX);this.isDirPassable(e,this.dY)&&(0===e&&0===this.dY||(this.dX=e))}else if(e<=.14){const e=this.changeDir(this.dY);this.isDirPassable(this.dX,e)&&(0===e&&0===this.dX||(this.dY=e))}}changeDir(e){switch(e){case 0:return f.arrayGetRand([-1,1]);case 1:case-1:return 0;default:return e}}terminate(){this.status=g.GOAL_COMPLETED}}t.GoalExplore=N,t.Goal.Explore=N;class x extends v{constructor(e,t){super(e),this.setType("GoalFleeFromActor"),this.targetActor=t}activate(){const e=this.actor.getBrain().getSeenCells(),n=u.Brain.findCellsWithActors(this.actor,e);let s=null;if(n.forEach(e=>{const t=e.getActors();t&&t.forEach(t=>{t.getID()===this.targetActor.getID()&&(s=e)})}),s){const e=this.actor.getX(),n=this.actor.getY(),s=l.default.dXdYUnit(this.actor,this.targetActor);this.dbg("Got dXdY "+s);const r=e+s[0],a=n+s[1],o=[[r,a],[e,a],[r,n]];if(this.tryFleeOptions(o),this.status!==g.GOAL_COMPLETED){const e=u.Brain.getBoxOfFreeCellsAround(this.actor,1).map(e=>e.getXY());this.tryFleeOptions(e)}this.status!==g.GOAL_COMPLETED&&(this.status=g.GOAL_FAILED,this.planBGoal=new t.Goal.AttackActor(this.actor,this.targetActor))}else this.status=g.GOAL_FAILED;this.status===g.GOAL_FAILED&&this.dbg(`Goal failed. foundCell |${s}|`)}process(){return this.activateIfInactive(),this.status}tryFleeOptions(e){const t=this.actor.getLevel(),[n,s]=this.actor.getXY();f.shuffle(e);for(let r=0;r<e.length;r++){const[a,o]=e[r];if(t.getMap().isPassable(a,o,n,s)){const e=new c.Movement(a,o,t);this.dbg(`${this.getType()} movComp to ${a},${o}`),this.actor.add(e),this.status=g.GOAL_COMPLETED;break}this.dbg(`Cell ${a},${o} not passable`)}}}t.GoalFleeFromActor=x,t.Goal.FleeFromActor=x;class P extends v{constructor(e,t,n){super(e),this.setType("GoalCastSpell"),this.spell=t,this.spellArgs=n}activate(){this.spell.getCastFunc(this.actor,this.spellArgs)(),this.status=g.GOAL_COMPLETED}process(){return this.activateIfInactive(),this.status}}t.GoalCastSpell=P,t.Goal.CastSpell=P;class I extends v{constructor(e,t){super(e),this.setType("GoalFollow"),this.targetActor=t}activate(){this.actor.getBrain().canSeeActor(this.targetActor)&&(this.status=g.GOAL_ACTIVE)}process(){this.activateIfInactive();const e=this.actor.getBrain(),[t,n]=this.actor.getXY();if(e.canSeeActor(this.targetActor)){const[e,s]=l.default.dXdYUnit(this.targetActor,this.actor),[r,a]=l.default.dXdY(this.targetActor,this.actor);let o=t+e,i=n+s;const u=this.targetActor.getLevel(),d=u.getMap();if(Math.abs(r)<=1&&Math.abs(a)<=1)this.status=g.GOAL_ACTIVE;else if(d.isPassable(o,i,t,n)){const e=new c.Movement(o,i,u);this.actor.add(e)}else{const[e,s]=this.targetActor.getXY(),r=h.Path.getActorToActorPath(d,t,n,e,s);if(r.length>0)if([o,i]=[r[0].x,r[0].y],d.isPassable(o,i,t,n)){const e=new c.Movement(o,i,u);this.actor.add(e)}else this.status=g.GOAL_FAILED;else this.status=g.GOAL_FAILED}}else this.status=g.GOAL_FAILED;return this.status}}t.GoalFollow=I,t.Goal.Follow=I;class D extends v{constructor(e,t){super(e),this.setType("GoalGetItem"),this.targetItem=t}activate(){this.status=g.GOAL_ACTIVE;const e=this.targetItem.getID(),t=this.actor.getBrain().getSeenCells();let n=null;if(t.forEach(t=>{if(t.hasItems()){t.getItems().find(t=>t.getID()===e)&&(n=t)}}),n){const[e,t]=this.actor.getXY(),[s,r]=n.getXY();if(e===s&&t===r)this.pickupItem();else{const e=new b(this.actor,[s,r]);this.removeAllSubGoals(),this.addSubGoal(e)}}else this.status=g.GOAL_FAILED}process(){return this.activateIfInactive(),this.hasSubGoals()?(this.status=this.processSubGoals(),this.status===g.GOAL_COMPLETED&&(this.status=g.GOAL_ACTIVE)):this.isActive()&&this.pickupItem(),this.status}pickupItem(){const e=new c.Pickup;this.actor.add(e),this.status=g.GOAL_COMPLETED}}t.GoalGetItem=D,t.Goal.GetItem=D;class k extends v{constructor(e,t,n){super(e),this.setType("GoalFindItem"),this.constraint=t,this._foundItem=null,this._cbFound=n}activate(){this.status=g.GOAL_ACTIVE}process(){return this.activateIfInactive(),this.checkForItems(),this.hasSubGoals()&&(this.status=this.processSubGoals()),this.status}checkForItems(){if(this._foundItem)return;let e;this.actor.getBrain().getSeenCells().forEach(t=>{!e&&t.hasItems()&&(e=t)});let t=null;if(e){const n=new p.Constraints,s=e.getItems(),r=n.getConstraints(this.constraint);let a=!1;s.forEach(e=>{!a&&r(e)&&(a=!0,this._foundItem=e,t=new D(this.actor,e),this.removeAllSubGoals(),this.addSubGoal(t))})}if(!this.hasSubGoals()){const e=100;t=new N(this.actor,e),this.removeAllSubGoals(),this.addSubGoal(t)}}}t.GoalFindItem=k,t.Goal.FindItem=k;const L=()=>!0;class R extends k{constructor(e){super(e,{op:"eq",func:"getType",value:"weapon"},L)}}t.GoalFindWeapon=R,t.Goal.FindWeapon=R;class B extends k{constructor(e){super(e,{op:"eq",func:"getType",value:"food"},L)}}t.GoalFindFood=B,t.Goal.FindFood=B;class F extends k{constructor(e){super(e,{op:"eq",func:"getType",value:"gold"},L)}}t.GoalFindGold=F,t.Goal.FindGold=F;class G extends k{constructor(e,t){super(e,{op:"eq",func:"getAmmoType",value:t},L)}}t.GoalFindAmmo=G,t.Goal.FindAmmo=G;class j extends k{constructor(e){super(e,{op:"eq",func:"getType",value:"missile"},L)}}t.GoalFindMissile=j,t.Goal.FindMissile=j;class W extends v{constructor(e){super(e),this.setType("GoalOrders")}activate(){this.status=g.GOAL_ACTIVE}process(){return this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}t.GoalOrders=W,t.Goal.Orders=W;class Y extends v{constructor(e,t,n){super(e),this.setType("GoalShopkeeper"),this.x=t,this.y=n,this.hasShouted=!1,this.subGoals=[]}activate(){this.status=g.GOAL_ACTIVE;const e=this.actor.getCell();if(e.hasShop())if(l.default.isSuccess(.6))U(this.actor);else if(this.hasShouted)e.hasItems();else{const e=new c.Communication;e.addMsg({src:this.actor,type:"Shout",shout:"Hello traveller!"}),this.actor.add(e)}else{if(!this.actor.getLevel().getMap().getCell(this.x,this.y).hasShop()){const e=`@${this.x},${this.y} | ${this.actor.getName()}`;l.default.err("GoalShopkeeper","activate","No shop in the target cell. Bug in initialisation! "+e)}this.dbg(`${this.x},${this.y} has the shop`);const e=new b(this.actor,[this.x,this.y]);this.addSubGoal(e),this.status=this.processSubGoals()}}process(){return this.dbg(`process(), x,y is ${this.x},${this.y}`),this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}t.GoalShopkeeper=Y,t.Goal.Shopkeeper=Y;class X extends v{constructor(e,t,n,s){super(e),this.setType("GoalGoHome"),this.x=t,this.y=n,this.maxDist=s,this.subGoals=[],this.timeToFindPath=f.getUniformInt(100,200)}activate(){this.status=g.GOAL_ACTIVE;const e=this.actor.getCell();if(this.timeToFindPath--,"floorhouse"===e.getBaseElem().getType())if(l.default.isSuccess(.03)){const e=new c.Communication;e.addMsg({src:this.actor,type:"Shout",shout:"Home sweet home!"}),this.actor.add(e)}else U(this.actor);else if(l.default.withinRange(this.maxDist,[this.x,this.y],this.actor))U(this.actor);else if(this.timeToFindPath<=0){const e=new b(this.actor,[this.x,this.y]);this.addSubGoal(e),this.status=this.processSubGoals(),this.timeToFindPath=f.getUniformInt(100,200)}else U(this.actor)}process(){return this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}function U(e){const t=e.getLevel(),n=t.getMap();let s=f.getRandDir(),r=l.default.newXYFromDir(s,e),a=10;for(;!n.hasXY(r[0],r[1])&&(s=f.getRandDir(),r=l.default.newXYFromDir(s,e),0!=--a););if(a>0){const n=new c.Movement(r[0],r[1],t);e.add(n)}}t.GoalGoHome=X,t.Goal.GoHome=X,t.Goal.moveToRandomDir=U,t.Goal.moveActorTo=function(e,t){const[n,s]=e.getXY(),r=t.getXY(),a=e.getLevel();if(a.getMap().isPassable(r[0],r[1],n,s)){const t=new c.Movement(r[0],r[1],a);e.add(t)}};class ${constructor(e){this.goal=e}}t.GoalMonitor=$,t.Goal.Monitor=$;class H extends v{constructor(e){super(e),this.setType("GoalCommunicate")}activate(){this.communicateEnemies()}process(){return this.activateIfInactive(),this.status=g.GOAL_COMPLETED,this.status}communicateEnemies(){const e=this.actor.getBrain(),t=e.getMemory(),n=t.getEnemyActors(),s=e.getSeenCells(),r=e.findFriendCell(s);if(!r)return;const a=r.getActors()[0],o=new c.Communication,i={type:"Enemies",enemies:n,src:this.actor};o.addMsg(i),a.add(o),t.addCommunicationWith(a)}}t.GoalCommunicate=H,t.Goal.Communicate=H;class V extends v{constructor(e){super(e),this.setType("GoalUseSkill")}activate(){this.useActorSkill()}process(){return this.activateIfInactive(),this.status=g.GOAL_COMPLETED,this.status}useActorSkill(){const e=u.Brain.getCellsAroundActor(this.actor),t={target:f.arrayGetRand(e)};this.actor.useSkill?this.actor.useSkill(t,0):l.default.err("GoalUseSkill","useActorSkill","Tried to use a skill but no actor.useSkill() found")}}t.GoalUseSkill=V,t.Goal.UseSkill=V;class K extends v{constructor(e){super(e),this.setType("GoalEquip")}activate(){this.equipSomething()}process(){return this.activateIfInactive(),this.status=g.GOAL_COMPLETED,this.status}equipSomething(){const e=this.actor.getInvEq().getInventory().getItems(),t=f.arrayGetRand(e);if(t){const e=new c.Equip;e.setIsRemove(!1),e.setArgs({item:t}),this.actor.add(e)}else{const e=JSON.stringify(this.actor);l.default.err("GoalEquip","equipSomething","GoalEquip issued although no items to equip "+e)}}}t.GoalEquip=K,t.Goal.Equip=K;class q extends v{constructor(e,t){super(e),this.setType("GoalChangeLevel"),this.coord=t}activate(){this.status=g.GOAL_ACTIVE,this.tryToFindStairs()}process(){return this.status=g.GOAL_ACTIVE,this.tryToFindStairs(),this.hasSubGoals()?(this.status=this.processSubGoals(),this.status===g.GOAL_COMPLETED&&(this.status=g.GOAL_ACTIVE)):this.isActive()&&this.useStairs(),this.status}tryToFindStairs(){if(this.coord){const[e,n]=this.actor.getXY(),[s,r]=this.coord;if(e===s&&n===r)console.log("Found stairs @",s,r),this.useStairs();else if(!this.hasSubGoals()){const e=new t.Goal.FollowPath(this.actor,this.coord);this.removeAllSubGoals(),this.addSubGoal(e)}}else if(!this.hasSubGoals()){const e=new t.Goal.Explore(this.actor,100);e.setCallback(this.exploreCallback.bind(this)),this.removeAllSubGoals(),this.addSubGoal(e)}}useStairs(){const e=new c.UseStairs;this.actor.add(e),this.removeAllSubGoals(),this.status=g.GOAL_COMPLETED}exploreCallback(e,t){const n=this.actor.getLevel().getMap();if(n.hasXY(e,t)){n.getCell(e,t).hasConnection()&&(this.coord=[e,t])}}}t.GoalChangeLevel=q,t.Goal.ChangeLevel=q;class z extends v{constructor(e){super(e),this.setType("GoalRest")}activate(){this.rest()}process(){return this.activateIfInactive(),this.status=g.GOAL_COMPLETED,this.status}rest(){this.actor.add(new c.Rest)}}function J(e){return t.Goal.StatusStrings[e]}t.GoalRest=z,t.Goal.Rest=z,t.statusToString=J},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.mixNewShell=t.color=t.attackPenalty=t.defensePenalty=t.combatPenalty=t.speedPenalty=t.statsPenalty=t.resistance=t.directDamage=t.meleeHitDamage=void 0;const r=s(n(4)),a=n(26);function o(e,t,n){const s={value:-t,srcComp:"Stats",srcFunc:r.default.formatGetterName(e.toLowerCase()),targetComp:"StatsMods",targetFunc:r.default.formatSetterName(e.toLowerCase())};return n&&(s.dontApplyTo=n.slice()),s}function i(e,t,n){const s={value:-t,srcComp:"Combat",srcFunc:r.default.formatGetterName(e.toLowerCase()),targetComp:"CombatMods",targetFunc:r.default.formatSetterName(e.toLowerCase())};return n&&(s.dontApplyTo=n.slice()),s}t.meleeHitDamage=(e,t,n,s)=>{const a={addComp:"DirectDamage",func:[{setter:"setDamage",value:e},{setter:"setDamageType",value:r.default.DMG[n]},{setter:"setDamageCateg",value:r.default.DMG.MELEE}],duration:t};return s&&(a.expireMsg=s),a},t.directDamage=(e,n,s,a,o)=>{const i=t.meleeHitDamage(e,n,s),l=i.func;return l[2].value=r.default.DMG.DIRECT,a&&l.push({setter:"setProb",value:a}),o&&(i.expireMsg=o),i},t.resistance=function(e,t){const n=e.toUpperCase(),s=t.toUpperCase();return r.default.DMG.hasOwnProperty(n)||r.default.err("actors.ts","resistance",`No dmg type |${n}| in ${Object.keys(r.default.DMG)}`),r.default.RESISTANCE.hasOwnProperty(s)||r.default.err("actors.ts","resistance",`No dmg type |${s}| in ${Object.keys(r.default.RESISTANCE)}`),{comp:"Resistance",func:{setEffect:r.default.DMG[n],setLevel:r.default.RESISTANCE[s]}}},t.statsPenalty=o,t.speedPenalty=function(e,t){return o("speed",e,t)},t.combatPenalty=i,t.defensePenalty=function(e,t){return i("defense",e,t)},t.attackPenalty=function(e,t){return i("attack",e,t)},t.color=function(e,t){return{fg:e,bg:t}};const l=new Set(["addComp","spells","inv","equip","onAttackHit"]),c=new Set(["hp","maxHP","pp","maxPP","defense","protection","attack","danger","speed","rarity"].concat(r.default.STATS_LC)),u={damage:function(e,t,n){const s=t[e];if(n[e]){const t=n[e],r=a.Dice.create(s),o=a.Dice.create(t),i=a.Dice.combine(r,o);n[e]=i.toString()}else n[e]=s},addDamage:function(e,t,n){const s=t[e];if(n.damage){const e=a.Dice.create(s),t=a.Dice.create(n.damage),r=a.Dice.addDice(e,t);n.damage=r.toString()}}},h=new Set(["weight","value","rarity"]);function d(e,t,n,s){l.has(e)?n.hasOwnProperty(e)?n[e]=n[e].concat(t[e]):n[e]=t[e].slice():Array.isArray(t[e])?n[e]=t[e].slice():"object"==typeof t[e]?n[e]=JSON.parse(JSON.stringify(t[e])):c.has(e)?function(e,t,n){"number"==typeof t[e]?n.hasOwnProperty(e)?n[e]+=t[e]:n[e]=t[e]:m(e,t,n)}(e,t,n):h.has(e)?function(e,t,n){"number"==typeof t[e]?n.hasOwnProperty(e)?n[e]=n[e]*t[e]:n[e]=t[e]:m(e,t,n)}(e,t,n):u.hasOwnProperty(e)?u[e](e,t,n):n[e]=t[e]}t.mixNewShell=function(e,t){const n={};return e.forEach(e=>{for(const s in e)e.hasOwnProperty(s)&&d(s,e,n,t)}),n};const p=/(\*|\/)\s*(\d+(.\d+)?)/,f=/(\+|-)\s*(\d+(.\d+)?)/;function m(e,t,n){const s=function(e){let t=p.exec(e);if(t)return[t[1],parseFloat(t[2])];if(t=f.exec(e),t)return[t[1],parseFloat(t[2])];return null}(t[e]);if(!s)return void r.default.err("shell-utils.ts","checkStringExpression",`Not legal expression |${t[e]}|`);const[a,o]=s;n.hasOwnProperty(e)?"+"===a?n[e]+=o:"-"===a?n[e]-=o:"*"===a?n[e]=Math.round(n[e]*o):"/"===a?n[e]=Math.round(n[e]/o):r.default.err("shell-utils.ts","incrShellProp",`Prop ${e} value illegal: ${t[e]}`):n[e]=o}},function(e,t,n){var s=n(504),r=n(509);e.exports=function(e,t){var n=r(e,t);return s(n)?n:void 0}},function(e,t){e.exports=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}},function(e,t,n){var s=n(287),r=n(204),a=n(77);e.exports=function(e){return a(e)?s(e):r(e)}},function(e,t,n){var s=n(143),r=n(201);e.exports=function(e){return null!=e&&r(e.length)&&!s(e)}},function(e,t){"function"==typeof Object.create?e.exports=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:e.exports=function(e,t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}},function(e,t,n){"use strict";var s=n(154),r=Object.keys||function(e){var t=[];for(var n in e)t.push(n);return t};e.exports=h;var a=n(116);a.inherits=n(78);var o=n(322),i=n(218);a.inherits(h,o);for(var l=r(i.prototype),c=0;c<l.length;c++){var u=l[c];h.prototype[u]||(h.prototype[u]=i.prototype[u])}function h(e){if(!(this instanceof h))return new h(e);o.call(this,e),i.call(this,e),e&&!1===e.readable&&(this.readable=!1),e&&!1===e.writable&&(this.writable=!1),this.allowHalfOpen=!0,e&&!1===e.allowHalfOpen&&(this.allowHalfOpen=!1),this.once("end",d)}function d(){this.allowHalfOpen||this._writableState.ended||s.nextTick(p,this)}function p(e){e.end()}Object.defineProperty(h.prototype,"destroyed",{get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed&&this._writableState.destroyed)},set:function(e){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=e,this._writableState.destroyed=e)}}),h.prototype._destroy=function(e,t){this.push(null),this.end(),s.nextTick(t,e)}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.verifyDirs=t.verifyTiles=t.ElemTemplate=t.Template=void 0;const r=s(n(4));t.Template={},t.Template.$DEBUG=0;const a=/[A-Z]/,o=/\s*=\s*/,i=/\s*:\s*/,l=e=>{t.Template.$DEBUG&&console.log("[DEBUG "+e)};function c(e){const t=e.length,n={},s=[1];let r="",o="",i=0;for(let l=1;l<t;l++)o=e[l],a.test(o)?i>0?r===o?++i:(n[s.length]=i,s.push(i),i=1):++i:i>0?(n[s.length]=i,s.push(i),s.push(1),i=0):s.push(1),r=o;return i>0&&(n[s.length]=i,s.push(i)),{genPos:n,widths:s}}t.Template.createTemplate=function(e){const n=e.split("\n");let s=0,a=n[0];0===a.length&&(a=n[++s]);const u={},h={};for(;a&&a.length>0;){if(o.test(a)){const e=a.split(o);if(2===e.length){const t=e[0],n=e[1];t.length===n.length?u[e[0]]=e[1]:r.default.err("Template","createTemplate",`Key ${t}, val ${n} have different len`)}}else if(i.test(a)){const e=a.split(i);if(2===e.length){const t=e[0],n=e[1];h[t]=n}else r.default.warn("Template","createTemplate","Prop must be key:val. Ignoring line "+a)}++s,a=n[s]}s===n.length&&r.default.err("Template","createTemplate","No empty line between header and template section."),++s;const d=[];for(;s<n.length;)d.push(n[s]),++s;let p=d[0].split("");const{genPos:f,widths:m}=c(p);l(JSON.stringify(f)),l(JSON.stringify(m));const g=[],y=[];let v=0;for(let e=0;e<d.length;e++){let t=0,n=0;y.push([]),p=d[e].split(""),l(JSON.stringify(`y: ${v} currLineArr: ${p}`)),g.push(p[0]);for(let e=0;e<m.length;e++){const s=m[e],r=p.slice(t,t+s);l(`x: ${t}, w: ${s}, elem: ${r}`),r&&(y[v][n]=r),t+=s,++n}++v}y.forEach((e,t)=>{l(`Row[${t}]: ${JSON.stringify(e)}`)}),l("firstCols is: "+JSON.stringify(g));const{genPos:b,widths:_}=c(g);l("@yGenPos: "+JSON.stringify(b)),l("@yWidths: "+JSON.stringify(_));const E={xGenPos:f,yGenPos:b,xWidths:m,yWidths:_,rows:y,elemMap:u},S=new t.ElemTemplate(E);return S.setProps(h),S},t.ElemTemplate=function(e){if(e&&(this.elemMap=e.elemMap,this.nMaps=Object.keys(this.elemMap).length,this.sizeX=e.xWidths.length,this.sizeY=e.rows.length,this.xWidths=e.xWidths,this.yWidths=e.yWidths,this.xGenPos=e.xGenPos,this.yGenPos=e.yGenPos),this.elemPropMap={},this.elemArr=[],this.hasGenRow={},e){for(let t=0;t<this.sizeX;t++){this.elemArr[t]=[];for(let n=0;n<this.sizeY;n++)this.elemArr[t][n]=e.rows[n][t].join("")}Object.keys(this.xGenPos).forEach(e=>{for(let t=0;t<this.sizeY;t++){const n=this.elemArr[e][t];this.elemArr[e][t]=new u(n)}})}this.setProps=function(e){this.elemPropMap=e},this.getProp=function(e){return this.elemPropMap[e]},this.getDir=function(){const e=this.getProp("dir");return e?e.split("").sort().join(""):""},this.setProp=function(e,t){this.elemPropMap[e]=t},this.getChars=function(e){if(e){if(Number.isInteger(e)){const t=e;e=[];for(let n=0;n<this.nMaps;n++)e.push(t)}}else{e=[];for(let t=0;t<this.nMaps;t++)e.push(1)}if(!(e.length>0&&e.length<this.nMaps)){let t=0,n=!1;const s=[];for(let r=0;r<this.sizeX;r++){s[r]=[];for(let a=0;a<this.sizeY;a++)if("object"==typeof this.elemArr[r][a]){const o=e[t];s[r][a]=this.elemArr[r][a].getChars(o),n=!0}else s[r][a]=this.elemArr[r][a];n&&(++t,n=!1)}this.substituteXMaps(s),l("X before split: "+JSON.stringify(s));const a=this.splitMultiElements(s);if(l("After-X, Before-Y: "+JSON.stringify(a)),Object.keys(this.yGenPos).length>0){const n=[];for(let e=0;e<this.sizeX;e++){n[e]=[];let t=0,r=0;this.yWidths.forEach(a=>{n[e][t]=s[e].slice(r,r+a),++t,r+=a})}l("y after widths "+JSON.stringify(n)),Object.keys(this.yGenPos).forEach(s=>{for(let r=0;r<this.sizeX;r++)n[r][s]=this.expandYGen(e[t],n[r][s]);++t});const a=r.default.flattenTo2D(n);l("y after flatten "+JSON.stringify(a));const o=this.splitMultiElements(a);return l("y after flatten "+JSON.stringify(o)),this.substituteYMaps(o),o}return l("X-Before subst: "+JSON.stringify(s)),l("X-After, split: "+JSON.stringify(a)),a}return r.default.err("ElemTemplate","getChars",`Input array length must be ${this.nMaps}.`),[]},this.expandYGen=(e,t)=>{l(`expandYGen ${e} -> ${t}`);const n=[];for(let s=0;s<e;s++)n.push(t);return n},this.substituteXMaps=function(e){const t=e.length;Object.keys(this.elemMap).forEach(n=>{const s=new RegExp(n,"g");for(let r=0;r<t;r++)e[r][0]=e[r][0].replace(s,this.elemMap[n])})},this.substituteYMaps=function(e){let n=[];const s=e[0].length;for(let t=0;t<s;t++)n.push(e[0][t]);l("firstCol is now: "+JSON.stringify(n));let a=n.join("");Object.keys(this.elemMap).forEach(e=>{const t=new RegExp(e,"g");a=a.replace(t,this.elemMap[e])}),n=a.split(""),l("firstCol END: "+JSON.stringify(n)),t.Template.$DEBUG&&r.default.printMap(e);for(let t=0;t<s;t++)e[0][t]=n[t]},this.splitMultiElements=e=>{const t=e.length,n=[];let s=0;for(let r=0;r<t;r++){const t=e[r],a=t[0].length;if(a>1){l(`Splitting ${a} nChars: ${t}`);for(let e=0;e<t.length;e++){const r=t[e];let a=s;r.split("").forEach(t=>{0===e?(n.push([t]),l("\tres push "+JSON.stringify(n))):(n[a++].push(t),l("\tres[x] push "+JSON.stringify(n)))})}s+=a}else++s,n.push(t)}return n},this.clone=()=>{const e=new t.ElemTemplate,n=JSON.parse(JSON.stringify(this));return Object.keys(n).forEach(t=>{e[t]=n[t]}),Object.keys(this.xGenPos).forEach(t=>{for(let n=0;n<this.sizeY;n++){const s=e.elemArr[t][n].genX;e.elemArr[t][n]=new u(s)}}),e}},t.Template.ElemTemplate=t.ElemTemplate;class u{constructor(e){this.str=e,this.len=e.length,this.str=e}length(){return this.len}getChars(e=1){return this.str.repeat(e)}toJSON(){return{genX:this.str}}}t.Template.ElemGenX=u;const h=/(\.|\+)/;function d(e,t){const n=e.getDir();if(""===n)return!0;const s=e.getChars(t),a=r.default.colsToRows(s);let o=!1;return/N/.test(n)&&a[0].forEach(e=>{let t=e;"string"!=typeof t&&(t=e.getChars()),h.test(t)&&(o=!0)}),/S/.test(n)&&(o=!1,a[a.length-1].forEach(e=>{let t=e;"string"!=typeof t&&(t=e.getChars()),h.test(t)&&(o=!0)})),/W/.test(n)&&s[0].forEach(e=>{let t=e;"string"!=typeof t&&(t=e.getChars()),h.test(t)&&(o=!0)}),/E/.test(n)&&(o=!1,s[s.length-1].forEach(e=>{let t=e;"string"!=typeof t&&(t=e.getChars()),h.test(t)&&(o=!0)})),o}t.verifyTiles=function(e,t,n,s=[1,1,1,1]){n.forEach(n=>{if(!d(n,s)){const a=JSON.stringify(n),o=n.getProp("name"),i=n.getChars(s);r.default.printMap(i),r.default.err(e,t,`Tile ${o} failed the checks: ${a}`)}})},t.verifyDirs=d;const p={N:"E",E:"S",S:"W",W:"N"},f={rotate90:p,rotate180:p,rotate270:p};t.Template.rotateR90=function(e,t=p){const n=e.clone();g(n,t);const s=[];let r=Object.keys(n.xGenPos).length;r+=Object.keys(n.yGenPos).length;for(let e=0;e<r;e++)s.push(1);const a=n.getChars(s),o=a[0].length,i=new Array(o);for(let e=0;e<o;e++)i[e]=[];for(let e=0;e<a.length;e++)for(let t=0;t<o;t++)i[o-1-t].push(a[e][t]);n.yGenPos=Object.assign({},e.xGenPos);const l=i.length;return n.xGenPos={},Object.keys(e.yGenPos).forEach(t=>{const s=l-1-parseInt(t,10);n.xGenPos[s]=e.yGenPos[t]}),n.elemArr=i,Object.keys(n.xGenPos).forEach(e=>{for(let t=0;t<n.sizeY;t++)try{n.elemArr[e][t]=new u(n.elemArr[e][t])}catch(e){throw console.log("Template:",n.getProp("name")),console.log("xGenPos: ",n.xGenPos),new Error(e)}}),n},t.Template.rotateR180=function(e,n=p){const s=t.Template.rotateR90(e,n);return t.Template.rotateR90(s,n)},t.Template.rotateR270=function(e,n=p){const s=t.Template.rotateR180(e,n);return t.Template.rotateR90(s,n)};const m={E:"W",W:"E"};function g(e,t){const n=e.getProp("dir");if(n){const s=n.split("");s.forEach((e,n)=>{t.hasOwnProperty(e)&&(s[n]=t[e])}),e.setProp("dir",s.join(""))}}function y(e,t){let n=t.getProp("name");switch(e){case"rotateR90":n+="_r90";break;case"rotateR180":n+="_r180";break;case"rotateR270":n+="_r270";break;case"flipVer":n+="_flip"}t.setProp("name",n)}f.flipVer=m,t.Template.flipVer=function(e,t=m){const n=e.clone();g(n,t);const s=[];let r=Object.keys(n.xGenPos).length;r+=Object.keys(n.yGenPos).length;for(let e=0;e<r;e++)s.push(1);const a=n.sizeX,o=new Array(a);for(let e=0;e<a;e++)o[e]=[];const i=n.sizeY,l=n.getChars(s);for(let e=0;e<a;e++)for(let t=0;t<i;t++)o[a-1-e][t]=l[e][t];const c=o.length;return n.xGenPos={},Object.keys(e.xGenPos).forEach(t=>{if(parseInt(t,10)<c-1){const s=c-1-parseInt(t,10);n.xGenPos[s]=e.xGenPos[t]}else{const s=t;n.xGenPos[s]=e.xGenPos[t]}}),n.elemArr=o,Object.keys(n.xGenPos).forEach(e=>{for(let t=0;t<n.sizeY;t++)n.elemArr[e][t]=new u(n.elemArr[e][t])}),n},t.Template.transformList=function(e,n,s){r.default.isNullOrUndef([e])&&r.default.err("Template","transformList","Input list templates is null");let a=[];return n||(n={all:"*",flipVer:[],rotateR90:[],rotateR180:[],rotateR270:[]}),Object.keys(n).forEach(r=>{if("all"!==r){const o=[];let i=n[r];i="*"===n.all?e.map(e=>e.getProp("name")):i.concat(n.all),i.forEach(a=>{const i=e.find(e=>e.getProp("name")===a);if(i){const e=s?s[r]:f[r],l=t.Template[r](i,e);if(y(r,l),o.push(l),"flipVer"===r){(function(e,t){const n=[];return["rotateR90","rotateR180","rotateR270"].forEach(s=>{(e[s].indexOf(t)>=0||"*"===e.all)&&n.push(s)}),n})(n,a).forEach(e=>{const n=s?s[e]:f[e],r=t.Template[e](l,n);y(e,r),o.push(r)})}}}),a=a.concat(o)}}),a}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DungeonPopulate=void 0;const i=o(n(4)),l=n(9),c=n(13),u=n(38),h=n(48),d=n(64),p=n(119),f=a(n(11)),m=n(45),g=a(n(39)),y=a(n(16)),v=n(12),b=n(224),_=n(138),E=n(97),S=n(30),w=l.Random.getRNG(),C=["NOTHING","LOOT","GOLD","GUARDIAN","ELEMENT","CORPSE","HINT"];t.DungeonPopulate=class{constructor(e={}){this.theme=e.theme||"",this.maxDanger=e.maxDanger||5,this.maxValue=e.maxValue||50,this.maxRarity=e.maxRarity||1,this.actorRoomDensity=e.actorRoomDensity||30,this.itemRoomDensity=e.itemRoomDensity||60,this.bigRoomActorDensity=e.bigRoomActorDensity||18,this._itemFact=new d.FactoryItem,this._actorFact=new p.FactoryActor,e.actorFunc?this.actorFunc=e.actorFunc:this.actorFunc=e=>!!e&&!0,e.itemFunc?this.itemFunc=e.itemFunc:this.itemFunc=e=>!!e&&!0}populateLevel(e){const t=e.getExtras(),n=this.maxDanger,s=this.maxValue,r=this.maxRarity;let a=!1;const o={};t.bigRooms&&t.bigRooms.forEach(t=>{const{room:r,type:l}=t,c=S.BBox.fromBBox(r.getBbox()),u=r.getAreaSize(),h={maxDanger:n,actor:e=>e.danger<=n+2,nActors:0};let d=!1;if(/cross/.test(l)?(h.nActors=Math.floor(u/(2*this.bigRoomActorDensity)),d=this.addActorsToBbox(e,c,h)):(h.nActors=Math.floor(u/this.bigRoomActorDensity),d=this.addActorsToBbox(e,c,h)),!d){const e="Failed to add actors to bbox ";i.default.warn("DungeonPopulate","populateLevel",e+JSON.stringify(c))}if(!a){const t=r.getCenter();a=this.addMainLoot(e,t,s)}o[r.getID()]=!0}),t.terms&&t.terms.forEach(t=>{if(!t.hasStairsUp()){const n=t.getBbox();if(!a){const n=t.getCenter();a=this.addMainLoot(e,n,s)}const o=t.getAreaSize(),i=Math.ceil(o/this.itemRoomDensity),l={maxValue:s,itemsPerLevel:i,item:e=>this.itemFunc(e)&&e.value<=s&&e.rarity<=r};this.addItemsToBbox(e,n,l);c.Geometry.getCoordBbox(n).forEach(t=>{const n=new y.ElementMarker("e");n.setTag("enemy"),e.addElement(n,t[0],t[1])})}o[t.getID()]=!0}),t.rooms&&t.rooms.forEach(t=>{const a=t.getBbox(),i=t.getAreaSize(),l={maxDanger:n,actor:e=>this.actorFunc(e)&&e.danger<=n,nActors:Math.floor(i/this.actorRoomDensity)};l.nActors<2&&(l.nActors=2),this.addActorsToBbox(e,a,l);const c=Math.ceil(i/this.itemRoomDensity),u={maxValue:s,itemsPerLevel:c,item:e=>this.itemFunc(e)&&e.value<=s&&e.rarity<=r};this.addItemsToBbox(e,a,u),o[t.getID()]=!0}),t.endPoint&&this.addPointGuardian(e,t.endPoint,n)}setActorFunc(e){"function"==typeof e?this.actorFunc=e:i.default.err("DungeonPopulate","setActorFunc",`Tried to set non-function ${e} as actorFunc`)}addPointGuardian(e,t,n){const s=t;(i.default.isNullOrUndef([n])||n<1)&&i.default.err("DungeonPopulate","addPointGuardian",`maxDanger must be > 0. Got: |${n}|`);const r=this.getEndPointGuardian(n);if(r){const t=r.getBrain();if(t.getGoal){const e=new u.Evaluator.Guard(i.default.BIAS.Guard,s);t.getGoal().addEvaluator(e)}return e.addActor(r,s[0],s[1])}{const e="Could not get guardian for endpoint: "+t;i.default.warn("DungeonPopulate","addPointGuardian",e)}return!1}getEndPointGuardian(e){let t=e,n=null,s=t=>n=>n.danger<=e&&n.danger>=t;for(this.actorFunc&&(s=e=>n=>this.actorFunc(n)&&n.danger<=t&&n.danger>=e);!n&&t>0;)n=this._actorFact.createRandomActor({func:s(t)}),--t;return n}addMainLoot(e,t,n){const[s,r]=t,a=w.getUniformInt(2,3),o=a*n,l=(a-1)*n,c=e=>e.value>=l&&e.value<=o;let u=null;if(i.default.isSuccess(.5)){const e=v.ObjectShell.getParser(),t=b.ItemGen.genRandShellWith(c);u=e.createFromShell(i.default.TYPE_ITEM,t)}else u=this._itemFact.createItem({func:c});return!!u&&(e.addItem(u,s,r),!0)}populatePoint(e,t,n){const{maxDanger:s}=n;switch(w.arrayGetRand(C)){case"NOTHING":break;case"LOOT":this.addLootToPoint(e,t);break;case"GUARDIAN":this.addPointGuardian(e,t,s);break;case"ELEMENT":this.addElementToPoint(e,t,n);break;case"CORPSE":this.addCorpseToPoint(e,t,n);break;case"GOLD":this.addGoldToPoint(e,t);break;case"HINT":this.addHintToPoint(e,t,n)}}addElementToPoint(e,t,n){n.true}addCorpseToPoint(e,t,n){n.true}addLootToPoint(e,t){const n=this.maxValue,s=[i.default.ITEM.POTION,i.default.ITEM.SPIRITGEM,i.default.ITEM.AMMUNITION,i.default.ITEM.POTION,i.default.ITEM.RUNE,i.default.ITEM.MISSILE],r=w.arrayGetRand(s),a=v.ObjectShell.getParser().createRandomItem({func:e=>e.type>=r&&e.value<=n&&e.value>=Math.round(n/2)});if(a){const[n,s]=t;return e.addItem(a,n,s),!0}return!1}addGoldToPoint(e,t){const n=this.maxValue,s=new g.GoldCoin;s.setCount(n);const[r,a]=t;return e.addItem(s,r,a)}addHintToPoint(e,t,n){n.true}createShops(e,t){const n=e.getExtras(),s=[];if(!n.hasOwnProperty("houses"))return i.default.err("DungeonPopulate","createShops","No houses in extras."),s;const r=n.houses,a=[];let o=0;n.shops=[];for(let l=0;l<t.nShops;l++){let c=w.randIndex(r);for(;a.indexOf(c)>=0;)c=w.randIndex(r),++o,o===2*r.length&&i.default.err("DungeonPopulate","createShops","WatchDog reached max houses");a.push(c);const h=n.houses[c];if(!h.door&&(h.door=h.findDoorPlace(),!h.door)){i.default.warn("DungeonPopulate","createShops",`No door found from house ${JSON.stringify(h)}. Cannot add shop`);continue}s.push(h);const d=h.floor,[p,g]=h.door,b=e.getMap().getCell(p,g);if(!b.hasDoor()){const t=new y.ElementDoor(!0);e.addElement(t,p,g)}const _=this.createShopkeeper(t),E=[];let S=!1;for(let n=0;n<d.length;n++){const s=d[n],r=new y.ElementShop;r.setShopkeeper(_),e.addElement(r,s[0],s[1]),0===n&&(S=!0,e.addActor(_,s[0],s[1])),t.parser||(t.parser=v.ObjectShell.getParser());const a=this._itemFact.getShopItem(l,t);if(a)a.add(new f.Unpaid),e.addItem(a,s[0],s[1]),E.push(s);else{const e="item null. conf: "+JSON.stringify(t);i.default.err("DungeonPopulate","createShop",`${e} shopFunc/type${l} not well defined.`)}}if(!S){const e=JSON.stringify(h);i.default.err("DungeonPopulate","createShops","Could not add keeper to "+e)}if(_.has("Shopkeeper")){const t=_.get("Shopkeeper");t.setCoord(E),t.setLevelID(e.getID()),t.setDoorXY(b.getXY());const n=_.getType()+" shopkeeper";_.setName(n),i.default.addCellStyle(i.default.TYPE_ACTOR,n,"cell-actor-shopkeeper");const s=w.arrayGetRand(E);if(_.getBrain().getGoal){const e=new u.Evaluator.Shopkeeper(1.5);e.setArgs({xy:s}),_.getBrain().getGoal().addEvaluator(e)}}this.addShopLoreItem(e,_);const C=new m.WorldShop;C.setShopkeeper(_),C.setLevel(e),C.setCoord(E),n.shops.push(C)}return s}createShopkeeper(e){let t=null;if(e.parser)if(e.actor){if(t=e.parser.createRandomActor({func:e.actor}),!t){let t="conf.actor given but no actor found";"function"==typeof e.actor?t+=" conf.actor |\n"+e.actor.toString()+"|":t+=" conf.actor must be function",i.default.err("Factory","createShopkeeper",t)}const n=t.getType()+" shopkeeper";t.setName(n),i.default.addCellStyle(i.default.TYPE_ACTOR,n,"cell-actor-shopkeeper")}else t=e.parser.createActor("shopkeeper");else t=this._actorFact.createActor("shopkeeper",{brain:"GoalOriented"});t.add(new f.Shopkeeper);const n=new g.GoldCoin(i.default.GOLD_COIN_NAME);n.setCount(w.getUniformInt(150,500)),t.getInvEq().addItem(n);t.get("Named").setUniqueName(E.Names.getActorName());let s=10;return e.maxDanger>=6&&(s=2*e.maxDanger),i.default.levelUpActor(t,s),t}addShopLoreItem(e,t){const n=t.get("Named"),s=e.get("Lore"),r=t.get("Shopkeeper"),a={name:n.getFullName(),xy:r.getDoorXY()};s.addTopic("shops",a)}createTrainers(e,t){const n=e.getExtras().houses;if(i.default.isSuccess(i.default.TRAINER_PROB)){let s=null;if(t.parser)s=t.parser.createActor("trainer");else{const e={maxDanger:5,actorFunc:e=>i.default.ALL_RACES.indexOf(e.type)>=0};s=this.createActor(e)}const r=new f.Trainer;s.add(r);const a=e.getFreeRandCell();if(e.addActor(s,a.getX(),a.getY()),n){const e=w.arrayGetRand(n);if(s.getBrain().getGoal){const t=new u.Evaluator.GoHome(i.default.BIAS.GoHome),n=e.getCenter();return t.setArgs({xy:n}),s.getBrain().getGoal().addEvaluator(t),[e]}}}return[]}populateHouse(e,t,n){const s=t.numFloor;let r=Math.round(s/9);0===r&&(r=1);for(let s=0;s<r;s++){const s=this.createActor(n),r=s.getBrain();if(r.getGoal){const n=new u.Evaluator.GoHome(i.default.BIAS.GoHome),s=t.getFloorCenter();n.setArgs({xy:s}),r.getGoal().addEvaluator(n);const a=new y.ElementMarker("H");a.setTag("home"),e.addElement(a,s[0],s[1])}const a=w.arrayGetRand(t.floor);e.addActor(s,a[0],a[1])}}createActor(e){const t=v.ObjectShell.getParser(),n=e.maxDanger||this.maxDanger;let s=null;if(n>0){let r=e=>e.danger<=n;this.actorFunc?r=e=>this.actorFunc(e)&&e.danger<=n:e.actorFunc&&(r=t=>e.actorFunc(t)&&t.danger<=n),s=t.createRandomActor({func:r})}else i.default.err("DungeonPopulate","createActor","maxDanger must be > 0");return s}addActorsToBbox(e,t,n){const s=n.nActors||4,{maxDanger:r}=n,a=n.actor;let o=n.actors;return o||(o=this._actorFact.generateNActors(s,a,r)),h.Placer.addActorsToBbox(e,t,o)}addItemsToBbox(e,t,n){const s=n.nItems||4,r=Object.assign({itemsPerLevel:s},n),a=this._itemFact.generateItems(r);return h.Placer.addItemsToBbox(e,t,a)}addToughAdventurer(e,t,n){const{maxDanger:s}=n.maxDanger,r=s-1,a=_.ActorGen.genRandShellWith(e=>e.danger<=s+4&&e.danger>=r);if(a){const[n,s]=t,r=v.ObjectShell.getParser().createFromShell(i.default.TYPE_ACTOR,a);if(r&&e.addActor(r,n,s))return!0}return!1}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.SpawnerActor=t.WeatherActor=t.VirtualActor=void 0;const o=n(61),i=n(111),l=n(180),c=a(n(29));class u extends o.BaseActor{constructor(e,t=!0){super(e,t),t&&(this._brain=new i.BrainVirtual(this))}}t.VirtualActor=u;class h extends o.BaseActor{constructor(e,t=!0){super(e,t),t&&(this._brain=new l.BrainWeather(this))}}t.WeatherActor=h;class d extends o.BaseActor{constructor(e,t=!0){super(e,t),t&&(this._brain=new i.BrainSpawner(this),this.add(new c.Stats),this.get("Stats").setSpeed(10))}getSpeed(){return this.get("Stats").getSpeed()}}t.SpawnerActor=d},function(e,t,n){var s=n(99),r=n(345),a=n(228),o=Object.defineProperty;t.f=n(101)?Object.defineProperty:function(e,t,n){if(s(e),t=a(t,!0),s(n),r)try{return o(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(e[t]=n.value),e}},function(e,t){var n={}.hasOwnProperty;e.exports=function(e,t){return n.call(e,t)}},function(e,t,n){var s=n(348),r=n(230);e.exports=function(e){return s(r(e))}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryBase=t.Factory=void 0;const i=o(n(4)),l=n(223),c=a(n(47)),u=n(48),h=n(119),d=n(64),p=n(28),f=n(23),m=n(9),g=a(n(16)),y=n(18),v=f.EventPool.getPool(),b=m.Random.getRNG(),_=g.ElementStairs;t.Factory={},t.Factory.cityConfBase=e=>{const t=e||{},n={nShops:1,shopFunc:[e=>e.type===b.arrayGetRand(i.default.SHOP_TYPES)],shopType:"",levelType:"arena"};return Object.assign(n,t)};t.FactoryBase=class{constructor(){this._verif=new c.Conf("FactoryBase"),this._actorFact=new h.FactoryActor,this._itemFact=new d.FactoryItem,this._levelFact=new p.FactoryLevel}createPlayer(e,t){return this._actorFact.createPlayer(e,t)}createActor(e,t={}){return this._actorFact.createActor(e,t)}createBrain(e,t){return this._actorFact.createBrain(e,t)}createSpell(e){return this._actorFact.createSpell(e)}createElement(e){if(y.ELEM_MAP.elemTypeToObj[e])return y.ELEM_MAP.elemTypeToObj[e];switch(e){case"door":return new g.ElementDoor(!0);case"opendoor":return new g.ElementDoor(!1);case"stairsUp":case"stairsDown":return new _(e);default:return null}}createFloorCell(e,t){return new l.Cell(e,t,new g.ElementBase("floor"))}createWallCell(e,t){return new l.Cell(e,t,new g.ElementWall("wall"))}createLevel(e,t,n,s){return this._levelFact.createLevel(e,t,n,s)}addNRandItems(e,t,n){return this._verif.verifyConf("addNRandItems",n,["item","maxValue"]),this._itemFact.addNRandItems(e,n)}addNRandActors(e,t,n){this._verif.verifyConf("addNRandActors",n,["maxDanger","actorsPerLevel"]);const s=n.maxDanger,r=this.generateNActors(n.actorsPerLevel,n.actor,s);return r?(u.Placer.addPropsToFreeCells(e,r),r.length):0}setParser(e){this._parser=e}generateNActors(e,t,n){return this._actorFact.generateNActors(e,t,n)}addRandomGold(e,t,n){this._itemFact.addRandomGold(e,t,n)}createHumanArmy(e,t){for(let n=0;n<2;n++){for(let s=0;s<20;s++){const r=t.createActor("fighter");e.addActor(r,s+1,4+n)}const s=t.createActor("warlord");e.addActor(s,10,n+7)}}createDemonArmy(e,t){for(let n=0;n<2;n++)for(let s=0;s<10;s++){const r=t.createActor("winter demon");e.addActor(r,s+10,14+n),v.emitEvent(i.default.EVT_ACTOR_CREATED,{actor:r,level:e,msg:"DemonSpawn"})}}createBeastArmy(e,t){const n=e.getMap().cols/2,s=e.getMap().rows/2;for(let r=s;r<s+2;r++)for(let s=n;s<n+10;s++){const n=t.createActor("blizzard beast"),a=s+10,o=r+14;e.getMap().hasXY(a,o)?(e.addActor(n,a,o),v.emitEvent(i.default.EVT_ACTOR_CREATED,{actor:n,level:e,msg:"DemonSpawn"})):i.default.warn("FactoryBase","createBeastArmy",`Cannot put beast to ${a}, ${o}.`)}}addActorsToBbox(e,t,n){const s=n.nActors||4,{maxDanger:r,func:a}=n,o=this.generateNActors(s,a,r);u.Placer.addActorsToBbox(e,t,o)}addItemsToBbox(e,t,n){const s=n.nItems||4,r=Object.assign({itemsPerLevel:s},n),a=(new d.FactoryItem).generateItems(r),o=e.getMap().getFreeInBbox(t);u.Placer.addPropsToCells(e,o,a)}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryWorld=void 0;const i=o(n(4)),l=n(779),c=n(138),u=n(60),h=n(15),d=h("bitn:Factory.World"),p=h("bitn:Factory.World-verb"),f=a(n(47)),m=n(370),g=a(n(45)),y=n(86),v=n(164),b=n(28),_=n(119),E=n(12),S=n(137),w=n(31),C=n(243),O=n(780),T=a(n(16)).ElementStairs,M=["City","Mountain","Dungeon","BattleZone"],A={tile:{Small:{x:40,y:20},Medium:{x:60,y:30},Large:{x:80,y:40},Huge:{x:140,y:60}},mountain:{Small:{x:40,y:20},Medium:{x:60,y:30},Large:{x:80,y:40},Huge:{x:140,y:60}},dungeon:{Small:{x:40,y:20},Medium:{x:60,y:30},Large:{x:80,y:40},Huge:{x:140,y:60}},city:{Small:{x:40,y:20},Medium:{x:60,y:30},Large:{x:80,y:40},Huge:{x:140,y:60}}};function N(e,t,n){if("Iron hills"===e.name){i.default.diag(n+" Creating iron hills connection now");const e=t.getConnections().filter(e=>"mountain"===e.getName());if(i.default.diag("\t## Ex. conns: "+JSON.stringify(e)),e.length>0){const t=e[0].getTargetLevel();i.default.diag("\t## Parent: "+t.getParent().getName())}}}t.FactoryWorld=class{constructor(){this._verif=new f.Conf("FactoryWorld"),this.factZone=new v.FactoryZone,this.createAllZones=!0,this.worldElemByID={},this.presetLevels={},this._conf=new m.ConfStack,this.id2level={},this.id2levelSet=!1,this.id2entity={},this.fromJSON=null,this.overworld=null}setRNG(e){this.factZone.setRNG(e)}setPresetLevels(e){this.presetLevels=e,this.debug("PresetLevels were set.")}setId2Level(e){0===Object.keys(e).length&&i.default.warn("FactoryWorld","setId2Level","There are no levels/keys present in id2level map. Bug?"),this.id2level=e,this.id2levelSet=!0,this.debug("Id2Level was set OK.")}pushScope(e){e?this._conf.pushScope(e):i.default.err("FactoryWorld","pushScope","Null/undef conf given")}popScope(e){this._conf.popScope(e)}setGlobalConf(e={}){const t=e.levelSize||"Medium",n=e.sqrPerActor||i.default.ACTOR_MEDIUM_SQR,s={levelSize:t,dungeonX:A.dungeon[t].x,dungeonY:A.dungeon[t].y,sqrPerActor:n,sqrPerItem:e.sqrPerItem||i.default.LOOT_MEDIUM_SQR,set:!0};this._conf.setGlobalConf(s),this.debug("globalConf set to "+JSON.stringify(s))}getGlobalConf(){return this._conf.getGlobalConf()}getConf(e){return this._conf.getConf(e)}setOverWorld(e){this.overworld=e}getHierName(){return this._conf.getScope().join(".")}createWorld(e){this._verif.verifyConf("createWorld",e,["name","nAreas"]),this.getGlobalConf().set||this.setGlobalConf({}),e.hasOwnProperty("createAllZones")&&(this.createAllZones=e.createAllZones,this.debug("createAllZones set to "+this.createAllZones)),this.pushScope(e);const t=new g.WorldTop(e.name);t.setConf(e);for(let n=0;n<e.nAreas;n++){const s=e.area[n],r=this.createArea(s);s.zonesCreated&&this.restoreCreatedZones(t,r,s),t.addArea(r),this.addWorldID(s,r)}return this.popScope(e),this.addWorldID(e,t),t}createArea(e){this._verif.verifyConf("createArea",e,["name","maxX","maxY"]),this.pushScope(e);const t=this.getHierName();let n=null;this.id2levelSet?n=this.getAreaLevels(e):(n=this.getPresetLevels(t,e),n&&0!==n.length||(n=null));const s=new g.Area(e.name,e.maxX,e.maxY,e.cols,e.rows,n);return s.setConf(e),s.setHierName(this.getHierName()),this.createAllZones?(this._createAllZones(s,e),s.markAllZonesCreated()):this.debug("Skipping the zone creating due to createZones=false"),this.popScope(e),s}restoreCreatedZones(e,t,n){Object.keys(n.zonesCreated).forEach(s=>{const[r,a]=s.split(","),[o,i]=[parseInt(r,10),parseInt(a,10)];n.zonesCreated[s]&&(this.debug(`\tRestoring created zones for tile ${o},${i}`),this.createZonesForTile(e,t,o,i))})}createZonesForTile(e,t,n,s){if(t.tileHasZonesCreated(n,s))this.debug(`Area ${n},${s} zones already created`);else{this.debug(`Creating Area ${n},${s} zones (not created yet)`);const r=e.getConf();this.pushScope(r);const a=t.getConf();this.pushScope(a),this.populateAreaLevel(t,n,s),this._createAllZones(t,a,n,s),t.markTileZonesCreated(n,s),this.createQuests(e,t,n,s),this.popScope(a),this.popScope(r)}}populateAreaLevel(e,t,n){const s=Math.floor(e.getSizeX()/2),r=e.getSizeY()-1,a=E.ObjectShell.getParser();e.isLoaded(t,n)||i.default.err("FactoryWorld","populateAreaLevel",`Cannot populate unloaded Tile ${t},${n}`);const o=e.getTileXY(t,n).getLevel(),l=Math.abs(s-t),c=r-n,u=7+l+2*c,h=10*(c+1)+2*l+10,d=new y.FactoryBase;d.setParser(a);const p=i.default.getMaxValue(l,c),f=i.default.getMaxDanger(l,c),m={itemsPerLevel:u,item:e=>e.value<=p&&"food"!==e.type,actor:e=>e.danger<=f,gold:()=>!1,food:()=>!1,maxValue:p,actorsPerLevel:h,maxDanger:f};this.setAreaLevelConstraints(m,t,n),m.item=m.item,d.addNRandItems(o,a,m),m.actor=m.actor,d.addNRandActors(o,a,m),this.addActorSpawner(o,a,m)}_createAllZones(e,t,n=-1,s=-1){if(this.debug(`_createAllZones ${n}, ${s}`),t.tiles)if(n<0||s<0)this.createZonesFromArea(e,t,n,s);else{const r=t.tiles[n][s];this.createZonesFromTile(e,r,n,s)}else this.createZonesFromArea(e,t,n,s)}createZonesFromArea(e,t,n=-1,s=-1){this.debug(`createZonesFromArea ${n}, ${s}`),M.forEach(r=>{const a=r.toLowerCase(),o="create"+r;let i=0;Array.isArray(t[a])&&(i=t[a].length),this.debug(`\tnZones (${r}) is now ${i}`);for(let l=0;l<i;l++){const i=t[a][l],{x:c,y:u}=i;if(!(-1!==n&&n!==c||-1!==s&&s!==u)){const t=this[o](i);t.setTileXY(c,u),e.addZone(r,t),this.addWorldID(i,t),this.id2levelSet||this.createAreaZoneConnection(e,t,i),this.addZoneComps(t,i)}}})}createZonesFromTile(e,t,n,s){M.forEach(r=>{const a=r.toLowerCase(),o="create"+r;let i=0;Array.isArray(t[a])&&(i=t[a].length),this.debug(`\t[${n}][${s}]: nZones (${r}) is now ${i}`);for(let l=0;l<i;l++){const i=t[a][l],{x:c,y:u}=i;if(!(-1!==n&&n!==c||-1!==s&&s!==u)){const t=this[o](i);t.setTileXY(c,u),e.addZone(r,t),this.addWorldID(i,t),this.id2levelSet||this.createAreaZoneConnection(e,t,i),this.addZoneComps(t,i)}}})}getAreaLevels(e){const t=[];return e.tiles?e.tiles.forEach(e=>{const n=[];e.forEach(e=>{const t=this.id2level[e.level];t?n.push(t):i.default.err("FactoryWorld","getAreaLevels",`No level ID ${e.level} in id2level`)}),t.push(n)}):i.default.err("FactoryWorld","getAreaLevels","conf.tiles null/undefined, but id2levelSet true"),t}createDungeon(e){this._verif.verifyConf("createDungeon",e,["name","nBranches"]),this.pushScope(e);const t=new g.Dungeon(e.name);if(t.setHierName(this.getHierName()),e.nBranches!==e.branch.length){const t=e.branch.length;i.default.err("Factory.World","createDungeon",`Branch number mismatch [] = ${t}, n: ${e.nBranches}`)}for(let n=0;n<e.nBranches;n++){const s=e.branch[n],r=this.createBranch(s);t.addBranch(r),this.addWorldID(s,r)}return e.entrance&&t.setEntrance(e.entrance),this.id2levelSet||e.nBranches>1&&(e.connectLevels?e.connectLevels.forEach(e=>{4===e.length?t.connectSubZones(...e):i.default.err("Factory.World","createDungeon","Each connection.length must be 4.")}):i.default.err("Factory.World","createDungeon","nBranches > 1, but no conf.connectLevels.")),this.popScope(e),t}createBranch(e){this._verif.verifyConf("createBranch",e,["name","nLevels"]),this.pushScope(e);const t=new g.Branch(e.name),n=this.getHierName();t.setHierName(n);const s=this.getPresetLevels(n,e);for(let n=0;n<e.nLevels;n++){const r=this.getConf("maxDanger"),a=this.getConf("maxValue"),o=this.getConf("maxRarity"),l=Math.floor(n/2),c={x:this.getConf("dungeonX"),y:this.getConf("dungeonY"),sqrPerActor:this.getConf("sqrPerActor"),sqrPerItem:this.getConf("sqrPerItem"),maxValue:a?a+20*n:20*(n+1),maxDanger:r?r+n:3+n,maxRarity:o?o+l:1+l,nLevel:n},u=this.getConf("dungeonType");u&&(c.dungeonType=u),this.setLevelConstraints(c);let h=this.getFromPresetLevels(n,s);if(h)e.createPresetLevels&&e.create&&this.addFixedFeatures(n,h,t);else if(e.levels)h=this.id2level[e.levels[n]];else{const[s,r]=[c.x,c.y];if(c.markersPreserved=!1,/(crypt)/i.test(u)){const e=new w.CryptGenerator;e.factZone=this.factZone,c.shouldRemoveMarkers=!0,h=e.create(s,r,c);const t=h.getElements().filter(e=>"marker"===e.getType());t.length>0&&i.default.err("FactoryWorld","createBranch",`${t.length} left inside level: ${JSON.stringify(t)}`)}else if(/cave/.test(u)){h=(new w.CaveGenerator).create(s,r,c),c.item&&(c.item=e=>"food"!==e.type&&c.item(e)&&e.rarity<=c.maxRarity),this.factZone.addItemsAndActors(h,c),this.factZone.addExtraDungeonFeatures(h,c)}else if(/(fort|castle)/.test(u)){h=(new w.CastleGenerator).create(s,r,c)}else{const e=new w.DungeonGenerator,t=c;t.wallType="walldungeon",t.floorType="floordungeon",t.shouldRemoveMarkers=!0,h=e.create(s,r,t);const n=h.getElements().filter(e=>"marker"===e.getType());n.length>0&&i.default.err("FactoryWorld","createBranch",`${n.length} left inside level: ${JSON.stringify(n)}`)}this.addFixedFeatures(n,h,t);const a=new O.DungeonFeatures("dungeon");n===e.nLevels-1&&a.addLastLevelFeatures(n,h,c),h.get("Place").setDepth(n+1)}t.addLevel(h)}return this.id2levelSet?e.hasOwnProperty("entrance")&&t.setEntranceLocation(e.entrance):(t.connectLevels(),e.hasOwnProperty("entranceLevel")&&t.addEntrance(e.entranceLevel)),this.popScope(e),t}getFromPresetLevels(e,t){let n=null;if(t.length>0){const s=t.find(t=>t.nLevel===e);s&&(n=s.level)}return n}_errorOnFunc(e){"function"==typeof e&&i.default.err("Factory","_errorOnFunc","Function constraint not supported anymore: "+e.toString())}setLevelConstraints(e){const t=this.getConf("constraint"),n=new u.Constraints;if(t){const s=this.getHierName();if(t.actor){this._errorOnFunc(t.actor),e.actor=n.getConstraints(t.actor);const r=JSON.stringify(t.actor);this.debug(`Found actor constraint for ${s}: ${r}`)}if(t.item){this._errorOnFunc(t.item),e.item=n.getConstraints(t.item);const r=JSON.stringify(t.item);this.debug(`Found item constraint for ${s}: ${r}`)}if(t.food){this._errorOnFunc(t.food),e.food=n.getConstraints(t.food);const r=JSON.stringify(t.food);this.debug(`Found food constraint for ${s}: ${r}`)}if(t.gold){this._errorOnFunc(t.gold),e.gold=n.getConstraints(t.gold);const r=JSON.stringify(t.gold);this.debug(`Found gold constraint for ${s}: ${r}`)}if(t.shop){const r=[];t.shop.forEach(e=>{r.push(n.getConstraints(e))}),e.shopFunc=r;const a=JSON.stringify(t.shop);this.debug(`Found shop constraint for ${s}: ${a}`)}if(t.disposition){t.disposition;e.disposition=t.disposition}if(t.cellsAround){const{cellsAround:n}=t;e.cellsAround=n}}const s=this.getConf("groupType"),r=this.getConf("cityType"),a=this.getConf("quarterType"),o=this.getConf("alignment"),i=this.getConf("wallType"),l=this.getConf("floorType"),c=this.getConf("friendly");s&&(e.groupType=s),r&&(e.cityType=r),a&&(e.cityType=a),o&&(e.alignment=o),i&&(e.wallType=i),l&&(e.floorType=l),c&&(e.friendly=!0)}_verifyConstraintKeys(e){const t=new Set(["actor","item","food","gold","shop","disposition"]);Object.keys(e).forEach(n=>{if(!t.has(n)){const t=JSON.stringify(e);i.default.err("Factory.World","_verifyConstraintKeys",`Unsupported key ${n} in ${t}`)}})}setAreaLevelConstraints(e,t,n){const s=t+","+n,r=this.getConf("constraint");if(r&&r.hasOwnProperty(s)){const t={name:"AreaLevel["+s+"]",constraint:r[s]};this.pushScope(t),this.setLevelConstraints(e),this.popScope(t)}}addFixedFeatures(e,t,n){const s=this.getConf("create");if(s&&s.actor){s.actor.forEach(s=>{if(s.nLevel===e){const e=s.name;let r=1;s.num&&(r=s.num);for(let a=0;a<r;a++)s.hasOwnProperty("target")&&(n.getName(),s.target),this.factZone.addActorToLevel(e,t)}})}if(s&&s.stairs){s.stairs.forEach(n=>{if(n.nLevel===e){const{x:e,y:s,isDown:r}=n,a=new T(r?"stairsDown":"stairsUp",t);t.addStairs(a,e,s)}})}}getPresetLevels(e,t){const n=this.getConf("presetLevels");if(n){const t=Object.keys(n).find(t=>new RegExp(t+"$").test(e));if(t)return n[t]}const s=Object.keys(this.presetLevels).find(t=>new RegExp(t+"$").test(e));if(s)return this.presetLevels[s];if(t&&t.createPresetLevels){const{createPresetLevels:e}=t,n=new l.LevelFactory(new b.FactoryLevel).create(e.new,e.args);if(!n){let e="Found createPresetLevels but no levels created";e+=" conf: "+JSON.stringify(t),i.default.err("Factory","getPresetLevels",e)}return n}return[]}createMountain(e){this._verif.verifyConf("createMountain",e,["name","nFaces","face"]),this.pushScope(e);const t=new g.Mountain(e.name);if(t.setHierName(this.getHierName()),e.nFaces!==e.face.length){const t=e.face.length;i.default.err("Factory.World","createMountain",`Face number mismatch [] = ${t}, n: ${e.nFaces}`)}for(let n=0;n<e.nFaces;n++){const s=e.face[n],r=this.createMountainFace(s);t.addSubZone(r),this.addWorldID(s,r)}for(let n=0;n<e.nSummits;n++){const s=e.summit[n],r=this.createSummit(s);t.addSubZone(r),this.addWorldID(s,r)}return this.id2levelSet||(e.nFaces>1||1===e.nFaces&&e.nSummits>0)&&(e.connectLevels&&e.connectLevels.length>0?e.connectLevels.forEach(e=>{4===e.length?t.connectSubZones(...e):i.default.err("Factory.World","createMountain","Each connection.length must be 4.")}):i.default.err("Factory.World","createMountain","nFaces > 1, but no conf.connectLevels.")),this.popScope(e),t}createMountainFace(e){this.id2levelSet?this._verif.verifyConf("createMountainFace",e,["name","nLevels"]):this._verif.verifyConf("createMountainFace",e,["name","nLevels","x","y"]);const t=e.name;this.pushScope(e);const n=new g.MountainFace(t),s={x:e.x,y:e.y,maxValue:e.maxValue,maxDanger:e.maxDanger,maxRarity:e.maxRarity};this.setLevelConstraints(s);for(let t=0;t<e.nLevels;t++){let r=null;if(this.id2levelSet){const n=e.levels[t];r=this.id2level[n]}else r=this.factZone.createMountainLevel(s);r.get("Place").setElevation(t+1),n.addLevel(r)}return this._addEntranceToSubZone(n,e),this.popScope(e),n}createSummit(e){this._verif.verifyConf("createSummit",e,["name","nLevels"]),this.pushScope(e);const t=new g.MountainSummit(e.name),n=Object.assign({},e);this.setLevelConstraints(n),this.addMaxDangerIfMissing(n);for(let s=0;s<e.nLevels;s++){let r=null;if(this.id2levelSet){const t=e.levels[s];r=this.id2level[t]}else{n.maxDanger||(n.maxDanger=4),r=this.factZone.createSummitLevel(n),r.get("Place").setElevation(5+s);const t=new O.DungeonFeatures("mountain");s===e.nLevels-1&&t.addLastLevelFeatures(s,r,n)}t.addLevel(r)}return this._addEntranceToSubZone(t,e),this.popScope(e),t}addMaxDangerIfMissing(e){if(Number.isInteger(e.maxDanger)||(e.maxDanger=this.getConf("maxDanger")),!Number.isInteger(e.maxValue)){const t=this.getConf("maxValue");t&&(e.maxValue=t)}Number.isInteger(e.maxRarity)||(e.maxRarity=this.getConf("maxRarity"))}_addEntranceToSubZone(e,t){t.hasOwnProperty("entranceLevel")?e.addEntrance(t.entranceLevel):t.hasOwnProperty("entrance")&&e.setEntranceLocation(t.entrance)}createCity(e){this._verif.verifyConf("createCity",e,["name","nQuarters"]),this.pushScope(e),p("createCity",e.name,"addComp is ",e.addComp);const t=new g.City(e.name);if(t.setHierName(this.getHierName()),e.nQuarters!==e.quarter.length){const t=e.quarter.length;i.default.err("Factory.World","createCity",`Quarter number mismatch [] = ${t}, n: ${e.nQuarters}`)}for(let n=0;n<e.nQuarters;n++){const s=e.quarter[n],r=this.createCityQuarter(s);t.addSubZone(r),this.addWorldID(s,r)}if(!this.id2levelSet&&e.nQuarters>1)if(e.connectLevels)e.connectLevels.forEach(e=>{4===e.length?t.abutQuarters(...e):i.default.err("Factory.World","createCity","Each connection.length must be 4.")});else{let t="nQuarters > 1, but no conf.connectLevels.";t+="cityConf: "+JSON.stringify(e),i.default.err("Factory.World","createCity",t)}return this.popScope(e),t}createCityQuarter(e){this._verif.verifyConf("createCityQuarter",e,["name","nLevels"]),this.pushScope(e);const t=new g.CityQuarter(e.name),n=this.getHierName();t.setHierName(n);const s=this.getPresetLevels(n,e),r={x:e.x||80,y:e.y||40,maxDanger:e.maxDanger,nShops:e.nShops||1,shopFunc:e.shop||[t=>t.value<=50+50*e.nLevels]};0===e.nShops&&(r.nShops=0),this.setLevelConstraints(r);for(let a=0;a<e.nLevels;a++){let o=this.getFromPresetLevels(a,s);if(o)if(o.stub){const e=o,t=new l.LevelFactory(new b.FactoryLevel).create(e.new,e.args);t&&(o=t[0].level,o||i.default.err("Factory","createCityQuarter","Stub found but cannot create level")),d.enabled&&this.debug("Creating level from stub "+JSON.stringify(e.stub))}else e.createPresetLevels&&e.create?this.addFixedFeatures(a,o,t):this.debug(`cityQuarter ${n} ${a} from preset level`);else if(this.id2levelSet){const t=e.levels[a];o=this.id2level[t]}else o=this.factZone.createCityLevel(a,r),this.addFixedFeatures(a,o,t);if(o=o,!this.id2levelSet&&o.hasExtras()){const e=o.getExtras();Array.isArray(e.shops)&&e.shops.forEach(e=>{t.addShop(e)})}t.addLevel(o)}return this.id2levelSet||t.connectLevels(),this._addEntranceToSubZone(t,e),e.hasOwnProperty("shops")&&e.shops.forEach(e=>{const n=new g.WorldShop;if(n.setLevel(this.id2level[e.level]),n.setCoord(e.coord),n._isAbandoned=e.isAbandoned,!e.isAbandoned){const t=this.id2entity[e.shopkeeper];if(t)n.setShopkeeper(t);else{const t=e.shopkeeper,n="Possible IDs: "+Object.keys(this.id2entity);i.default.err("Factory","createCityQuarter",`Cannot find shopkeeper ID ${t}. ${n}`)}}t.addShop(n)}),this.popScope(e),t}createBattleZone(e){this.pushScope(e);const t=new g.BattleZone(e.name);this.id2levelSet||i.default.err("Factory","createBattleZone","Can create BattleZones only during restore");for(let n=0;n<e.nLevels;n++){const s=e.levels[n],r=this.id2level[s];r?t.addLevel(r):i.default.err("Factory","createBattleZone",`Cannot find level ID ${s} for BattleZone`)}return this.popScope(e),t}getConnectionName(e,t,n){let s="";if("city"===t)s="town",e.groupType&&"fort"===e.groupType&&(s="cityfort");else if("mountain"===t)s="mountain";else if(Array.isArray(n)){s=!n[0].isDown()?"stairsDown":"stairsUp"}else{s=!n.isDown()?"stairsDown":"stairsUp"}return s}getTileStairsXY(e,t){let[n,s]=[t.levelX,t.levelY];if(i.default.isNullOrUndef([n,s])){const t=e.getEmptyRandCell();t&&(n=t.getX(),s=t.getY())}let r=e.getMap().getCell(n,s),a=i.default.WATCHDOG;for(;r.hasConnection();){const t=e.getEmptyRandCell();if(t&&(n=t.getX(),s=t.getY()),r=e.getMap().getCell(n,s),--a<=0)break}return[n,s]}getEntryStairs(e,t,n){if(n.length>0){const s=t.getX(),r=t.getY();return e.getElements().indexOf(t)>=0&&(e.removeElement(t,s,r)||i.default.err("Factory.World","getEntryStairs","Cannot remove entryStairs")),n}return t}processConnObject(e,t,n){const s=e.nLevel,r=e.levelX,a=e.levelY,o=e.name;this.debug(`Processing connection obj ${o}: ${r},${a}`);const l=t.findLevel(o,s);if(l){let s=e.stairs||null;if(s&&!i.default.isNullOrUndef([s.getStairs])){const e=s.getStairs;if(s=l.getStairs()[e],s)this.debug("conn found via getStairs connObject");else{let t="zoneStairs null, index: "+e;t+="\tPoss: "+JSON.stringify(l.getStairs()),i.default.err("Factory.World","processConnObject",t)}}if(s){if("function"!=typeof s.getSrcLevel){const e=JSON.stringify(s);i.default.err("Factory.World","processConnObject","zoneStairs not a proper stairs object "+e)}}else s=this.createNewZoneConnects(t,l);let o="stairsDown";"city"===t.getType()?o="town":"mountain"===t.getType()&&(o="mountain");const c=new T(o,n,l);n.addStairs(c,r,a);try{c.connect(s)}catch(e){console.error(e);let t="zoneLevel: "+JSON.stringify(l,null,1);t+="\n\tzoneStairs: "+JSON.stringify(s),i.default.err("Factory.World","createAreaZoneConnection",t)}}else{let n="connectToAreaXY: "+JSON.stringify(e);n+="zone: "+JSON.stringify(t),i.default.err("Factory.World","createAreaZoneConnection","No level found. "+n)}}createNewZoneConnects(e,t){let n=null;return"dungeon"===e.getType()?n=this.createDungeonZoneConnect(e,t):"city"===e.getType()?n=this.createCityZoneConnect(e,t):"mountain"===e.getType()&&(this.debug("Creating new mountain south connection"),n=g.addExitsToEdge(t,"passage","south",!0)),n}createDungeonZoneConnect(e,t){this.debug("Creating dungeon connection");let n=0,s=0;if(t.hasExtras()){const r=t.getExtras();if(r.startPoint)[n,s]=r.startPoint;else if(r.connectEdges)return this.createCityZoneConnect(e,t)}else{const e=t.getFreeRandCell();[n,s]=e.getXY()}const r=new T("stairsUp",t);return t.addStairs(r,n,s),r}createCityZoneConnect(e,t){let n=null;this.debug("Creating new city edge connection");let s=[];if(i.default.CARDINAL_DIR.forEach(e=>{if(!g.edgeHasConnections(t,e)){const n=g.addExitsToEdge(t,"passage",e);n.length>0&&(s=s.concat(n))}}),n=s,0===n.length){const e=t.getFreeRandCell(),s=e.getX(),r=e.getY();n=new T("stairsUp",t),t.addStairs(n,s,r),n=[n],this.debug("City edge connection failed. Added stairs")}return n}debugPrintCityConns(e,t){if(d.enabled&&"city"===e){const e=t.getConnections();let n=JSON.stringify(e[0],null,1);e.length>1&&(n+=JSON.stringify(e[e.length-1],null,1)),this.debug("First/last conn: "+n),this.debug("conn length after: "+e.length)}}addWorldID(e,t){i.default.isNullOrUndef([e.id])||t.setID(e.id),this.worldElemByID[t.getID()]=t}createQuests(e,t,n,s){(new C.QuestPopulate).createQuests(e,t,n,s)}createAreaZoneConnection(e,t,n){this._verif.verifyConf("createAreaZoneConnection",n,["x","y"]),this.debug("Creating area-zone connections");const{x:s,y:r}=n,a=e.getTileXY(s,r);if(!a||!a.getLevel)return void i.default.err("FactoryWorld","createAreaZoneConnection","Tile does not exist, or getLevel not usable");const o=a.getLevel();N(n,o," CALL 1"),"function"!=typeof t.getEntrances&&i.default.err("Factory.World","createAreaZoneConnection","No getEntrances method for zone.");const l=t.getEntrances();if(l.length>0){const e=l[0];let s=e;const r=e.getSrcLevel(),a=t.getType();this.debug("Connecting area-zone by entrance");let c=null;if(a.match(/(city|mountain)/)||n.connectEdges){d.enabled&&(c=r.getConnections(),this.debug("conn length before: "+c.length));const n=this.createNewZoneConnects(t,r);s=this.getEntryStairs(r,e,n)}const u=this.getConnectionName(n,a,s);N(n,o," CALL 2");const h=new T(u,o,r),[p,f]=this.getTileStairsXY(o,n);try{o.addStairs(h,p,f),h.connect(s)}catch(e){throw i.default.log("Given conf: "+JSON.stringify(n)),e}this.debugPrintCityConns(a,r)}else if(!n.hasOwnProperty("connectToAreaXY")){const e=`No entrances in ${t.getHierName()}.`;i.default.err("Factory.World","createAreaZoneConnection",e+". Cannot connect to tile.")}if(n.hasOwnProperty("connectToAreaXY")){n.connectToAreaXY.forEach(e=>{this.processConnObject(e,t,o)})}}addActorSpawner(e,t,n){const s=n.maxDanger+1,r=[{op:"eq",prop:"type",value:c.ActorGen.getRaces()}],a=[{op:"eq",func:"getX",value:[0,e.getMap().cols-1]},{op:"eq",func:"getY",value:[0,e.getMap().rows-1]}],o=(new _.FactoryActor).createActorSpawner(s,r,a);e.addVirtualProp(i.default.TYPE_ACTOR,o)}addZoneComps(e,t){if(p("addZoneComps called with ",t.name),t.addComp){(new S.ObjectShellComps).addComponents(t,e),p("addZoneComps added comps to",t.name,",",t.addComp)}else t.components&&(this.fromJSON?(p.enabled&&(p("addZoneComps restoring comps for",t.name),p("Comps are",t.components)),this.fromJSON.addCompsToEntity(e,t.components)):i.default.err("FactoryWorld","addZoneComps","Failed to restore zone comps: fromJSON not set"))}debug(e){if(d.enabled){let t=this.getHierName();t||(t="EMPTY"),d(`|${t}| ${e}`)}}}},function(e,t,n){
/*!
 * chai
 * Copyright(c) 2011-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
var s=[];
/*!
 * Chai version
 */t.version="4.2.0",
/*!
 * Assertion Error
 */
t.AssertionError=n(414);
/*!
 * Utils for plugins (not exported)
 */
var r=n(809);t.use=function(e){return~s.indexOf(e)||(e(t,r),s.push(e)),t},
/*!
 * Utility Functions
 */
t.util=r;
/*!
 * Configuration
 */
var a=n(104);t.config=a;
/*!
 * Primary `Assertion` prototype
 */
var o=n(826);t.use(o);
/*!
 * Core Assertions
 */
var i=n(827);t.use(i);
/*!
 * Expect interface
 */
var l=n(828);t.use(l);
/*!
 * Should interface
 */
var c=n(829);t.use(c);
/*!
 * Assert interface
 */
var u=n(830);t.use(u)},function(e,t){
/*!
 * Chai - transferFlags utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t,n){var s=e.__flags||(e.__flags=Object.create(null));for(var r in t.__flags||(t.__flags=Object.create(null)),n=3!==arguments.length||n,s)(n||"object"!==r&&"ssfi"!==r&&"lockSsfi"!==r&&"message"!=r)&&(t.__flags[r]=s[r])}},function(e,t,n){var s;
/*!
  Copyright (c) 2017 Jed Watson.
  Licensed under the MIT License (MIT), see
  http://jedwatson.github.io/classnames
*/!function(){"use strict";var n={}.hasOwnProperty;function r(){for(var e=[],t=0;t<arguments.length;t++){var s=arguments[t];if(s){var a=typeof s;if("string"===a||"number"===a)e.push(s);else if(Array.isArray(s)&&s.length){var o=r.apply(null,s);o&&e.push(o)}else if("object"===a)for(var i in s)n.call(s,i)&&s[i]&&e.push(i)}}return e.join(" ")}e.exports?(r.default=r,e.exports=r):void 0===(s=function(){return r}.apply(t,[]))||(e.exports=s)}()},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ACTOR_CLASSES_NO_ADV=t.ACTOR_CLASSES=t.Miner=t.Courtier=t.Spiritcrafter=t.Spellsinger=t.Marksman=t.Cryomancer=t.Blademaster=t.Adventurer=t.Alpinist=t.ActorClassBase=t.ActorClass=void 0;const i=o(n(4)),l=n(54),c=a(n(11)),u=n(270),h=n(9),d=n(186),p=n(183),f=n(12),{Abilities:m}=d.Ability,g=h.Random.getRNG();t.ActorClass={},t.ActorClass.create=function(e,n){if(t.ActorClass.hasOwnProperty(e)){return new t.ActorClass[e](n)}return i.default.diag("Called with entity:"),i.default.diag(n),i.default.err("ActorClass","create",`No class ${e} in ActorClass`),null},t.ActorClass.getLevelUpObject=function(e,t){const n=new l.MenuInfoOnly,s=t.getActor(),r=t.getClassName(),a=t.getLevelUpMsg(e),o=`${s.getName()} is now level ${e} ${r}`;return n.addPre(["Congratulations! "+o]),n.addPre(a),n},t.ActorClass.addAbility=function(e,t){let n=null;if(n=t.has("Abilities")?t.get("Abilities").abilities:new m,d.Ability.hasOwnProperty(e)){const t=new d.Ability[e];n.addAbility(t)}else i.default.err("ActorClass","addAbility",`Cannot find Ability.${e} for new`)};t.ActorClass.startingItems={Alpinist:[{name:"Ration",count:1},{name:"rope",count:1},{func:e=>"mineral"===e.type,count:2}],Adventurer:[{name:"Ration",count:2},{name:"firemaking kit",count:1},{func:e=>"potion"===e.type,count:1}],Cryomancer:[{name:"Ration",count:1},{name:"Potion of power",count:1}],Marksman:[{name:"Ration",count:1}],Miner:[{name:"Rye bread",count:2},{name:"small bomb",count:1},{name:"shovel",count:1}],Blademaster:[{name:"Ration",count:1}],Spiritcrafter:[{name:"Ration",count:1},{name:"Ordinary spirit gem"},{name:"Potion of spirit form"}],Spellsinger:[{name:"Rye bread",count:2},{name:"Potion of eagle",count:1}],Courtier:[{name:"Dried fruit",count:4},{name:"Gold coin",count:100}]};t.ActorClass.equipment={Alpinist:[{name:"Piolet",count:1},{name:"Spiked boots",count:1}],Adventurer:[{name:"Short sword",count:1},{name:"Leather armour",count:1}],Cryomancer:[{name:"Robe",count:1},{name:"Wooden staff",count:1}],Marksman:[{name:"Leather armour",count:1},{name:"Wooden bow",count:1},{name:"Wooden arrow",count:15}],Miner:[{name:"Pick-axe",count:1},{name:"Rock",count:6}],Blademaster:[{name:"Longsword",count:1},{name:"Chain helmet",count:1},{name:"Chain armour",count:1}],Spiritcrafter:[{name:"Robe",count:1},{name:"Mace",count:1}],Spellsinger:[{name:"Iron staff",count:1},{name:"Leather armour",count:1}],Courtier:[]},t.ActorClass.getEquipment=function(e){return M(t.ActorClass.equipment[e])},t.ActorClass.getStartingItems=function(e){return M(t.ActorClass.startingItems[e])};class y{constructor(e,t){this._actor=e,e.setActorClass(this),this._className=t}getActor(){return this._actor}getClassName(){return this._className}getLevelUpMsg(e){let t="";return this._messages.hasOwnProperty(e)&&(t+=this._messages[e]),t+="\n"+this._lastStateIncr,t}advanceLevel(){const e=this._actor.get("Experience").getExpLevel();if(this._messages.hasOwnProperty(e)){const t=this._actor.getCell();t&&i.default.gameMsg({cell:t,msg:this._messages[e]})}this._advances.hasOwnProperty(e)&&this._advances[e](),this.incrStats(e)}incrStats(e){const t=this._actor;this._lastStateIncr="";const n=t.get("Health"),s=Math.ceil(t.getStatVal("Strength")/2);if(n.setMaxHP(n.getMaxHP()+s),n.setHP(n.getHP()+s),t.has("SpellPower")){const e=Math.ceil(t.getStatVal("Magic")/2),n=t.get("SpellPower");n.setMaxPP(n.getMaxPP()+e),n.addPP(e)}const r=g.arrayGetRand(i.default.STATS);this._lastStateIncr=r+" was increased",t.get("Stats").incrStat(r,1),i.default.levelUpCombatStats(t,e)}setSkill(e,t){this._actor.has("Skills")||this._actor.add(new c.Skills),this._actor.get("Skills").addSkill(e),this._actor.get("Skills").setLevel(e,t)}}t.ActorClassBase=y;class v extends y{constructor(e){super(e,"Alpinist");const n=e.getName();this._messages={4:n+" can climb on difficult terrain now",8:n+" can jump over obstacles such as chasms now",12:n+" can now hide from enemies using terrain"},this._advances={1:()=>{t.ActorClass.addAbility("Camouflage",this._actor)},4:()=>{this._actor.add(new c.Climber)},8:()=>{this._actor.add(new c.Jumper)},12:()=>{},16:()=>{},20:()=>{},24:()=>{},28:()=>{},32:()=>{}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("perception",3),e.incrStat("agility",3),e.incrStat("magic",-2),this.setSkill(i.default.SKILLS.CLIMBING,2)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("perception",1),this._lastStateIncr+="\nPerception was increased."),e%3!=1&&(t.incrStat("agility",1),this._lastStateIncr+="\nAgility was increased.")}}t.Alpinist=v,t.ActorClass.Alpinist=v;class b extends y{constructor(e){super(e,"Adventurer");const t=e.getName();this._messages={4:"Food is now more nourishing for "+t},this._advances={1:()=>{const e=new u.Spell.SpellBook(this._actor);this._actor.setBook(e)},4:()=>{this._actor.add(new c.NourishedOne)}}}advanceLevel(){super.advanceLevel();const e=this._actor.get("Experience").getExpLevel();if(e%4==0&&!this._advances.hasOwnProperty(e)){const n=g.arrayGetRand(t.ACTOR_CLASSES_NO_ADV),s=new t.ActorClass[n](this.getActor());s.advanceLevel(),this._messages[e]=s._messages[e]}}setStartingStats(){const e=this._actor.get("Stats");for(let t=0;t<3;t++){let t=g.arrayGetRand(i.default.STATS);t=t.toLowerCase(),e.incrStat(t,g.getUniformInt(1,3))}}incrStats(e){super.incrStats(e);const t=g.arrayGetRand(i.default.STATS);this._lastStateIncr+=`\n${t} was increased.`,this._actor.get("Stats").incrStat(t,1)}}t.Adventurer=b,t.ActorClass.Adventurer=b;class _ extends y{constructor(e){super(e,"Blademaster");const n=e.getName();this._messages={4:n+" knows now how to defend more skillfully",8:n+" knows now how to hit enemies more accurately",12:n+" knows now how to handle equipment better",16:n+" can now strike in two directions",20:n+" can now keep the weapons sharp",24:n+" can now wield two blades at once",28:n+" can now strike back immediately when attacked",32:n+" has become a True Blademaster"},this._advances={1:()=>{},4:()=>{this._actor.add(new c.Defender)},8:()=>{this._actor.add(new c.Attacker)},12:()=>{this._actor.add(new c.MasterEquipper)},16:()=>{this._actor.add(new c.BiDirStrike)},20:()=>{this._actor.add(new c.Sharpener),t.ActorClass.addAbility("Sharpener",this._actor)},24:()=>{this._actor.add(new c.Ambidexterity)},28:()=>{this._actor.add(new c.CounterAttack)},32:()=>{this._actor.get("Combat").setAttackRange(2),this._actor.add(new c.LongReach)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("strength",3),e.incrStat("magic",-3),this.setSkill(i.default.SKILLS.MELEE,2)}getLevelUpMsg(e){return super.getLevelUpMsg(e)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("strength",1),this._lastStateIncr+="\nStrength was increased."),e%3==0&&(t.incrStat("accuracy",1),this._lastStateIncr+="\nAccuracy was increased."),i.default.levelUpCombatStats(this._actor,e)}}t.Blademaster=_,t.ActorClass.Blademaster=_;class E extends y{constructor(e){super(e,"Cryomancer");const t=e.getName();this._messages={4:t+" learns a protection spell",8:t+" learns a spell to attack enemies from distance",12:t+" can freeze enemies on their tracks",16:t+" can summon an ice companion now",20:t+" can drain power from other spellcasters",24:t+" can fire ice arrows towards enemies",28:t+" can control their enemies now",32:t+" has become a True Cryomancer, Harbinger of Blizzard"},this._advances={1:()=>{const e=new u.Spell.SpellBook(this._actor),t=new u.Spell.GraspOfWinter;e.addSpell(t),this._actor.setBook(e)},4:()=>{this._actor.getBook().addSpell(new u.Spell.IceShield)},8:()=>{this._actor.getBook().addSpell(new u.Spell.FrostBolt)},12:()=>{this._actor.getBook().addSpell(new u.Spell.IcyPrison)},16:()=>{this._actor.getBook().addSpell(new u.Spell.SummonIceMinion)},20:()=>{this._actor.getBook().addSpell(new u.Spell.PowerDrain)},24:()=>{this._actor.getBook().addSpell(new u.Spell.IceArrow)},28:()=>{this._actor.getBook().addSpell(new u.Spell.MindControl)},32:()=>{this._actor.getBook().addSpell(new u.Spell.Blizzard)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("strength",-2),e.incrStat("magic",3),this.setSkill(i.default.SKILLS.SPELLCASTING,2)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("magic",1),this._lastStateIncr+="\nMagic was increased."),e%3==0&&(t.incrStat("willpower",1),this._lastStateIncr+="\nWillpower was increased.")}}t.Cryomancer=E,t.ActorClass.Cryomancer=E;class S extends y{constructor(e){super(e,"Marksman");const t=e.getName();this._messages={4:t+" can now see and shoot further",8:t+" deals now more damage with each shot",12:t+" can bypass enemies with ranged attacks",16:t+" can use arrows/bolts interchangeably",20:t+" can shoot even further",24:t+" can evade ranged attacks",28:t+" can shoot enemies critically",32:t+" has become a True Marksman"},this._advances={1:()=>{},4:()=>{this._actor.add(new c.EagleEye)},8:()=>{this._actor.add(new c.StrongShot)},12:()=>{this._actor.add(new c.ThroughShot)},16:()=>{this._actor.add(new c.MixedShot)},20:()=>{this._actor.add(new c.LongRangeShot)},24:()=>{this._actor.add(new c.RangedEvasion)},28:()=>{this._actor.add(new c.CriticalShot)},32:()=>{this._actor.add(new c.DoubleShot)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("accuracy",3),e.incrStat("perception",2),e.incrStat("magic",-3),this.setSkill(i.default.SKILLS.ARCHERY,2)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("accuracy",1),this._lastStateIncr+="\nAccuracy was increased."),e%3==0&&(t.incrStat("perception",1),this._lastStateIncr+="\nPerception was increased."),e%3==1&&(t.incrStat("agility",1),this._lastStateIncr+="\nAgility was increased."),e%2==0&&i.default.levelUpCombatStats(this._actor,e)}}t.Marksman=S,t.ActorClass.Marksman=S;class w extends y{constructor(e){super(e,"Spellsinger");const t=e.getName();this._messages={4:t+" can now summon animals",8:t+" can heal wounds",12:t+" can fly like an eagle",16:t+" can now paralyse enemies",20:t+" can summon lightning on enemies",24:t+" controls powers of the sky",28:t+" can attack enemies in multiple directions",32:t+" has become a Mighty Spellsinger"},this._advances={1:()=>{const e=new u.Spell.SpellBook(this._actor);this._actor.setBook(e),this._actor.getBook().addSpell(new u.Spell.MagicArmor)},4:()=>{this._actor.getBook().addSpell(new u.Spell.SummonAnimal)},8:()=>{this._actor.getBook().addSpell(new u.Spell.Heal)},12:()=>{this._actor.getBook().addSpell(new u.Spell.Flying)},16:()=>{this._actor.getBook().addSpell(new u.Spell.Paralysis)},20:()=>{this._actor.getBook().addSpell(new u.Spell.LightningArrow)},24:()=>{const e=new u.Spell.SummonAirElemental;this._actor.getBook().addSpell(e)},28:()=>{this._actor.getBook().addSpell(new u.Spell.CrossBolt)},32:()=>{this._actor.getBook().addSpell(new u.Spell.RockStorm)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("perception",2),e.incrStat("magic",2),this.setSkill(i.default.SKILLS.SPELLCASTING,2)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("magic",1),this._lastStateIncr+="\nMagic was increased."),e%3==0&&(t.incrStat("perception",1),this._lastStateIncr+="\nPerception was increased.")}}t.Spellsinger=w,t.ActorClass.Spellsinger=w;class C extends y{constructor(e){super(e,"Spiritcrafter");const t=e.getName();this._messages={4:t+" can now equip 2 spirit gems",8:t+" learns to project small amounts of energy",12:t+" learns to create protective forcefields",16:t+" can now equip 3 spirit gems",20:t+" can now bind spirit gems to items",24:t+" can take a spirit form now",28:t+" gains new skill",32:t+" has become a Mighty Spiritcrafter"},this._advances={1:()=>{const e=new u.Spell.SpellBook(this._actor);this._actor.setBook(e)},4:()=>{this.getActor().getInvEq().getEquipment().addSlot("spiritgem",new p.EquipSlot("spiritgem"))},8:()=>{this._actor.getBook().addSpell(new u.Spell.EnergyArrow)},12:()=>{this._actor.getBook().addSpell(new u.Spell.ForceField)},16:()=>{this.getActor().getInvEq().getEquipment().addSlot("spiritgem",new p.EquipSlot("spiritgem"))},20:()=>{this._actor.add(new c.SpiritItemCrafter)},24:()=>{this._actor.getBook().addSpell(new u.Spell.SpiritForm)},28:()=>{this._actor.getBook().addSpell(new u.Spell.EnergyStorm)},32:()=>{this.getActor().getInvEq().getEquipment().addSlot("spiritgem",new p.EquipSlot("spiritgem")),this._actor.getBook().addSpell(new u.Spell.RingOfEnergy)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("willpower",4),e.incrStat("magic",2),this.setSkill(i.default.SKILLS.SPELLCASTING,2)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("willpower",1),this._lastStateIncr+="\nWillpower was increased."),e%3==0&&(t.incrStat("magic",1),this._lastStateIncr+="\nMagic was increased.")}}t.Spiritcrafter=C,t.ActorClass.Spiritcrafter=C;class O extends y{constructor(e){super(e,"Courtier");e.getName();this._messages={},this._advances={1:()=>{t.ActorClass.addAbility("Bribery",this._actor),this._actor.add(new c.Charm)},4:()=>{this._actor.has("Charm")&&this._actor.get("Charm").setLevel(2)},8:()=>{this._actor.has("Charm")&&this._actor.get("Charm").setLevel(3)},12:()=>{this._actor.has("Charm")&&this._actor.get("Charm").setLevel(4)},16:()=>{this._actor.has("Charm")&&this._actor.get("Charm").setLevel(5)},20:()=>{this._actor.has("Charm")&&this._actor.get("Charm").setLevel(6)},24:()=>{this._actor.has("Charm")&&this._actor.get("Charm").setLevel(7)},28:()=>{this._actor.has("Charm")&&this._actor.get("Charm").setLevel(8)},32:()=>{this._actor.has("Charm")&&this._actor.get("Charm").setLevel(10)}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("perception",3),e.incrStat("agility",-2),e.incrStat("strength",-3),e.incrStat("willpower",4),this.setSkill(i.default.SKILLS.TRADING,3)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("perception",1),this._lastStateIncr+="\nPerception was increased."),e%3!=1&&(t.incrStat("willpower",1),this._lastStateIncr+="\nWillpower was increased.")}}t.Courtier=O,t.ActorClass.Courtier=O;class T extends y{constructor(e){super(e,"Miner");e.getName();this._messages={},this._advances={1:()=>{},4:()=>{},8:()=>{},12:()=>{},16:()=>{},20:()=>{},24:()=>{},28:()=>{},32:()=>{}}}setStartingStats(){const e=this._actor.get("Stats");e.incrStat("perception",2),e.incrStat("agility",2),e.incrStat("strength",3),this.setSkill(i.default.SKILLS.MINING,2)}incrStats(e){const t=this._actor.get("Stats");super.incrStats(e),e%3!=0&&(t.incrStat("strength",1),this._lastStateIncr+="\nStrength was increased."),e%3!=1&&(t.incrStat("agility",1),this._lastStateIncr+="\nAgility was increased."),e%3==0&&i.default.levelUpCombatStats(this._actor,e)}}function M(e){const t=f.ObjectShell.getParser(),n=[];return e.forEach(e=>{if("function"==typeof e){const s=t.createRandomItem(e);n.push({name:s.getName(),count:1})}else if(e.func){const s=t.createRandomItem(e.func);e.count?n.push({name:s.getName(),count:e.count}):n.push({name:s.getName(),count:1})}else n.push(e)}),n}t.Miner=T,t.ActorClass.Miner=T,t.ACTOR_CLASSES=["Cryomancer","Blademaster","Marksman","Spiritcrafter","Adventurer","Alpinist","Spellsinger","Courtier","Miner"],t.ACTOR_CLASSES_NO_ADV=t.ACTOR_CLASSES.filter(e=>"Adventurer"!==e)},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RoomGraph=t.Corridor=t.Room=t.Feature=void 0;const r=s(n(22)),a=n(490),o={floor:".",wall:"#",door:"+"};class i{}t.Feature=i;class l extends i{constructor(e,t,n,s,r,a){super(),this._x1=e,this._y1=t,this._x2=n,this._y2=s,this._doors={},this._feats={},this._stairs={},void 0!==r&&void 0!==a&&this.addDoor(r,a),this._roomID=l.id++}static createRandomAt(e,t,n,s,a){let o=a.roomWidth[0],i=a.roomWidth[1];const l=r.default.getUniformInt(o,i);o=a.roomHeight[0],i=a.roomHeight[1];const c=r.default.getUniformInt(o,i);if(1===n){const n=t-Math.floor(r.default.getUniform()*c);return new this(e+1,n,e+l,n+c-1,e,t)}if(-1===n){const n=t-Math.floor(r.default.getUniform()*c);return new this(e-l,n,e-1,n+c-1,e,t)}if(1===s){const n=e-Math.floor(r.default.getUniform()*l);return new this(n,t+1,n+l-1,t+c,e,t)}if(-1===s){const n=e-Math.floor(r.default.getUniform()*l);return new this(n,t-c,n+l-1,t-1,e,t)}throw new Error("dx or dy must be 1 or -1")}static createCenter(e,t,n){let s=n.roomWidth[0],a=n.roomWidth[1];const o=r.default.getUniformInt(s,a);s=n.roomHeight[0],a=n.roomHeight[1];const i=r.default.getUniformInt(s,a),l=e-Math.floor(o/2),c=t-Math.floor(i/2);return new this(l,c,l+o-1,c+i-1)}static createRandomCenter(e,t,n){let s=n.roomWidth[0],a=n.roomWidth[1];const o=r.default.getUniformInt(s,a);s=n.roomHeight[0],a=n.roomHeight[1];const i=r.default.getUniformInt(s,a),l=e-Math.floor(r.default.getUniform()*o),c=t-Math.floor(r.default.getUniform()*i);return new this(l,c,l+o-1,c+i-1)}static createRandom(e,t,n){let s=n.roomWidth[0],a=n.roomWidth[1];const o=r.default.getUniformInt(s,a);s=n.roomHeight[0],a=n.roomHeight[1];const i=r.default.getUniformInt(s,a),l=e-o-1,c=t-i-1,u=1+Math.floor(r.default.getUniform()*l),h=1+Math.floor(r.default.getUniform()*c);return new this(u,h,u+o-1,h+i-1)}hasDoor(){return Object.keys(this._doors).length>0}addDoor(e,t){return this._doors[e+","+t]=1,this}addStairs(e,t,n){return this._stairs[e+","+t]=n,this}hasStairs(e,t){return Object.keys(this._stairs).length>0}moveRoom(e,t){this._x1+=e,this._x2+=e,this._y1+=t,this._y2+=t,this._moveFeats(e,t,this._doors),this._moveFeats(e,t,this._feats),this._moveFeats(e,t,this._stairs)}_moveFeats(e,t,n){Object.keys(n).forEach(s=>{const[r,a]=s.split(","),o=parseInt(r,10)+e,i=parseInt(a,10)+t;n[o+","+i]=n[s],delete n[s]})}hasStairsUp(e,t){const n=Object.values(this._stairs);for(let e=0;e<n.length;e++)if(!1===n[e])return!0;return!1}add(e,t,n){this._feats[t+","+n]||(this._feats[t+","+n]=[]),this._feats[t+","+n].push(e)}getDoors(e){for(const t in this._doors){const n=t.split(",");e(parseInt(n[0]),parseInt(n[1]))}return this}clearDoors(){return this._doors={},this}addDoors(e){const t=this._x1-1,n=this._x2+1,s=this._y1-1,r=this._y2+1;for(let a=t;a<=n;a++)for(let o=s;o<=r;o++)a!=t&&a!=n&&o!=s&&o!=r||e(a,o)||this.addDoor(a,o);return this}debug(){console.log("room",this._x1,this._y1,this._x2,this._y2)}isValid(e,t){const n=this._x1-1,s=this._x2+1,r=this._y1-1,a=this._y2+1;for(let o=n;o<=s;o++)for(let i=r;i<=a;i++)if(o===n||o===s||i===r||i===a){if(!e(o,i))return!1}else if(!t(o,i))return!1;return!0}create(e){const t=this._x1-1,n=this._x2+1,s=this._y1-1,r=this._y2+1;let a=0;for(let o=t;o<=n;o++)for(let i=s;i<=r;i++)a=o+","+i in this._doors?2:o==t||o==n||i==s||i==r?1:0,e(o,i,a)}getCenter(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]}getLeft(){return this._x1}getRight(){return this._x2}getTop(){return this._y1}getBottom(){return this._y2}getWidth(){return this._x2-this._x1}getHeight(){return this._y2-this._y1}getCorners(){return{nw:[this._x1,this._y1],ne:[this._x2,this._y1],sw:[this._x1,this._y2],se:[this._x2,this._y2]}}isTerm(){return 1===Object.keys(this._doors).length}getName(){return"room_"+this._roomID}getID(){return this._roomID}setID(e){this._roomID=e}getBbox(){return{ulx:this._x1,uly:this._y1,lrx:this._x2,lry:this._y2}}getOuterBbox(){return{ulx:this._x1-1,uly:this._y1-1,lrx:this._x2+1,lry:this._y2+1}}getInnerBbox(e=1){const t=this._x1+e,n=this._x2-e;if(t>n)return null;const s=this._y1+e,r=this._y2-e;return s>r?null:{ulx:t,uly:s,lrx:n,lry:r}}getXY(){const e=[],{ulx:t,uly:n,lrx:s,lry:r}=this.getInnerBbox(1);for(let a=t;a<=s;++a)for(let t=n;t<=r;++t)e.push([a,t]);return Object.keys(this._doors).forEach(t=>{const[n,s]=t.split(",");e.push([n,s])}),e}getAreaSize(){return(this._x2-this._x1)*(this._y2-this._y1)}toMap(e=o){const t=[];for(let n=this._x1;n<=this._x2;++n){const s=n-this._x1;t.push([]);for(let r=this._y1;r<=this._y2;++r){let a=e.wall;const o=e.floor,i=n+","+r;this._doors[i]&&(a=e.door),n!==this._x1&&n!==this._x2&&r!==this._y1&&r!==this._y2?t[s].push(o):t[s].push(a)}}return t}}t.Room=l;class c extends i{constructor(e,t,n,s){super(),this._startX=e,this._startY=t,this._endX=n,this._endY=s,this._endsWithAWall=!0,this._corrID=c.id++}getID(){return this._corrID}getName(){return"corr_"+this._corrID}static createRandomAt(e,t,n,s,a){const o=a.corridorLength[0],i=a.corridorLength[1],l=r.default.getUniformInt(o,i);return new this(e,t,e+n*l,t+s*l)}debug(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)}isValid(e,t){const n=this._startX,s=this._startY;let r=this._endX-n,a=this._endY-s,o=1+Math.max(Math.abs(r),Math.abs(a));r&&(r/=Math.abs(r)),a&&(a/=Math.abs(a));const i=a,l=-r;let c=!0;for(let u=0;u<o;u++){const h=n+u*r,d=s+u*a;if(t(h,d)||(c=!1),e(h+i,d+l)||(c=!1),e(h-i,d-l)||(c=!1),!c){o=u,this._endX=h-r,this._endY=d-a;break}}if(0==o)return!1;if(1==o&&e(this._endX+r,this._endY+a))return!1;const u=!e(this._endX+r+i,this._endY+a+l),h=!e(this._endX+r-i,this._endY+a-l);return this._endsWithAWall=e(this._endX+r,this._endY+a),!u&&!h||!this._endsWithAWall}create(e){const t=this.getXY();for(let n=0;n<t.length;n++){const[s,r]=t[n];e(s,r,0)}return!0}getXY(){const e=[],t=this._startX,n=this._startY;let s=this._endX-t,r=this._endY-n;const a=1+Math.max(Math.abs(s),Math.abs(r));s&&(s/=Math.abs(s)),r&&(r/=Math.abs(r));for(let o=0;o<a;o++){const a=t+o*s,i=n+o*r;e.push([a,i])}return e}createPriorityWalls(e){if(!this._endsWithAWall)return;const t=this._startX,n=this._startY;let s=this._endX-t,r=this._endY-n;s&&(s/=Math.abs(s)),r&&(r/=Math.abs(r));const a=r,o=-s;e(this._endX+s,this._endY+r),e(this._endX+a,this._endY+o),e(this._endX-a,this._endY-o)}}t.Corridor=c,l.id=0,c.id=0;t.RoomGraph=class{constructor(){this.graph=new a.Graph({directed:!1})}addRoom(e){this.graph.setNode(e.getName(),e)}connectRooms(e,t){this.graph.setEdge(e.getName(),t.getName())}isTerm(e){const t=this.graph.nodeEdges(e.getName());return!!t&&1===t.length}}},function(e,t,n){var s=n(94),r=n(505),a=n(506),o=s?s.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":o&&o in Object(e)?r(e):a(e)}},function(e,t,n){var s=n(44).Symbol;e.exports=s},function(e,t,n){var s=n(536),r=n(197),a=n(537),o=n(295),i=n(538),l=n(93),c=n(283),u=c(s),h=c(r),d=c(a),p=c(o),f=c(i),m=l;(s&&"[object DataView]"!=m(new s(new ArrayBuffer(1)))||r&&"[object Map]"!=m(new r)||a&&"[object Promise]"!=m(a.resolve())||o&&"[object Set]"!=m(new o)||i&&"[object WeakMap]"!=m(new i))&&(m=function(e){var t=l(e),n="[object Object]"==t?e.constructor:void 0,s=n?c(n):"";if(s)switch(s){case u:return"[object DataView]";case h:return"[object Map]";case d:return"[object Promise]";case p:return"[object Set]";case f:return"[object WeakMap]"}return t}),e.exports=m},function(e,t,n){"use strict";(function(e){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <http://feross.org>
 * @license  MIT
 */
var s=n(630),r=n(631),a=n(632);function o(){return l.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function i(e,t){if(o()<t)throw new RangeError("Invalid typed array length");return l.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=l.prototype:(null===e&&(e=new l(t)),e.length=t),e}function l(e,t,n){if(!(l.TYPED_ARRAY_SUPPORT||this instanceof l))return new l(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return h(this,e)}return c(this,e,t,n)}function c(e,t,n,s){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,s){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(s||0))throw new RangeError("'length' is out of bounds");t=void 0===n&&void 0===s?new Uint8Array(t):void 0===s?new Uint8Array(t,n):new Uint8Array(t,n,s);l.TYPED_ARRAY_SUPPORT?(e=t).__proto__=l.prototype:e=d(e,t);return e}(e,t,n,s):"string"==typeof t?function(e,t,n){"string"==typeof n&&""!==n||(n="utf8");if(!l.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var s=0|f(t,n),r=(e=i(e,s)).write(t,n);r!==s&&(e=e.slice(0,r));return e}(e,t,n):function(e,t){if(l.isBuffer(t)){var n=0|p(t.length);return 0===(e=i(e,n)).length||t.copy(e,0,0,n),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(s=t.length)!=s?i(e,0):d(e,t);if("Buffer"===t.type&&a(t.data))return d(e,t.data)}var s;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function u(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function h(e,t){if(u(t),e=i(e,t<0?0:0|p(t)),!l.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function d(e,t){var n=t.length<0?0:0|p(t.length);e=i(e,n);for(var s=0;s<n;s+=1)e[s]=255&t[s];return e}function p(e){if(e>=o())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o().toString(16)+" bytes");return 0|e}function f(e,t){if(l.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var s=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return j(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return W(e).length;default:if(s)return j(e).length;t=(""+t).toLowerCase(),s=!0}}function m(e,t,n){var s=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return N(this,t,n);case"utf8":case"utf-8":return T(this,t,n);case"ascii":return M(this,t,n);case"latin1":case"binary":return A(this,t,n);case"base64":return O(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return x(this,t,n);default:if(s)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),s=!0}}function g(e,t,n){var s=e[t];e[t]=e[n],e[n]=s}function y(e,t,n,s,r){if(0===e.length)return-1;if("string"==typeof n?(s=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=r?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(r)return-1;n=e.length-1}else if(n<0){if(!r)return-1;n=0}if("string"==typeof t&&(t=l.from(t,s)),l.isBuffer(t))return 0===t.length?-1:v(e,t,n,s,r);if("number"==typeof t)return t&=255,l.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?r?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):v(e,[t],n,s,r);throw new TypeError("val must be string, number or Buffer")}function v(e,t,n,s,r){var a,o=1,i=e.length,l=t.length;if(void 0!==s&&("ucs2"===(s=String(s).toLowerCase())||"ucs-2"===s||"utf16le"===s||"utf-16le"===s)){if(e.length<2||t.length<2)return-1;o=2,i/=2,l/=2,n/=2}function c(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(r){var u=-1;for(a=n;a<i;a++)if(c(e,a)===c(t,-1===u?0:a-u)){if(-1===u&&(u=a),a-u+1===l)return u*o}else-1!==u&&(a-=a-u),u=-1}else for(n+l>i&&(n=i-l),a=n;a>=0;a--){for(var h=!0,d=0;d<l;d++)if(c(e,a+d)!==c(t,d)){h=!1;break}if(h)return a}return-1}function b(e,t,n,s){n=Number(n)||0;var r=e.length-n;s?(s=Number(s))>r&&(s=r):s=r;var a=t.length;if(a%2!=0)throw new TypeError("Invalid hex string");s>a/2&&(s=a/2);for(var o=0;o<s;++o){var i=parseInt(t.substr(2*o,2),16);if(isNaN(i))return o;e[n+o]=i}return o}function _(e,t,n,s){return Y(j(t,e.length-n),e,n,s)}function E(e,t,n,s){return Y(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,s)}function S(e,t,n,s){return E(e,t,n,s)}function w(e,t,n,s){return Y(W(t),e,n,s)}function C(e,t,n,s){return Y(function(e,t){for(var n,s,r,a=[],o=0;o<e.length&&!((t-=2)<0);++o)n=e.charCodeAt(o),s=n>>8,r=n%256,a.push(r),a.push(s);return a}(t,e.length-n),e,n,s)}function O(e,t,n){return 0===t&&n===e.length?s.fromByteArray(e):s.fromByteArray(e.slice(t,n))}function T(e,t,n){n=Math.min(e.length,n);for(var s=[],r=t;r<n;){var a,o,i,l,c=e[r],u=null,h=c>239?4:c>223?3:c>191?2:1;if(r+h<=n)switch(h){case 1:c<128&&(u=c);break;case 2:128==(192&(a=e[r+1]))&&(l=(31&c)<<6|63&a)>127&&(u=l);break;case 3:a=e[r+1],o=e[r+2],128==(192&a)&&128==(192&o)&&(l=(15&c)<<12|(63&a)<<6|63&o)>2047&&(l<55296||l>57343)&&(u=l);break;case 4:a=e[r+1],o=e[r+2],i=e[r+3],128==(192&a)&&128==(192&o)&&128==(192&i)&&(l=(15&c)<<18|(63&a)<<12|(63&o)<<6|63&i)>65535&&l<1114112&&(u=l)}null===u?(u=65533,h=1):u>65535&&(u-=65536,s.push(u>>>10&1023|55296),u=56320|1023&u),s.push(u),r+=h}return function(e){var t=e.length;if(t<=4096)return String.fromCharCode.apply(String,e);var n="",s=0;for(;s<t;)n+=String.fromCharCode.apply(String,e.slice(s,s+=4096));return n}(s)}t.Buffer=l,t.SlowBuffer=function(e){+e!=e&&(e=0);return l.alloc(+e)},t.INSPECT_MAX_BYTES=50,l.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=o(),l.poolSize=8192,l._augment=function(e){return e.__proto__=l.prototype,e},l.from=function(e,t,n){return c(null,e,t,n)},l.TYPED_ARRAY_SUPPORT&&(l.prototype.__proto__=Uint8Array.prototype,l.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&l[Symbol.species]===l&&Object.defineProperty(l,Symbol.species,{value:null,configurable:!0})),l.alloc=function(e,t,n){return function(e,t,n,s){return u(t),t<=0?i(e,t):void 0!==n?"string"==typeof s?i(e,t).fill(n,s):i(e,t).fill(n):i(e,t)}(null,e,t,n)},l.allocUnsafe=function(e){return h(null,e)},l.allocUnsafeSlow=function(e){return h(null,e)},l.isBuffer=function(e){return!(null==e||!e._isBuffer)},l.compare=function(e,t){if(!l.isBuffer(e)||!l.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,s=t.length,r=0,a=Math.min(n,s);r<a;++r)if(e[r]!==t[r]){n=e[r],s=t[r];break}return n<s?-1:s<n?1:0},l.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},l.concat=function(e,t){if(!a(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return l.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var s=l.allocUnsafe(t),r=0;for(n=0;n<e.length;++n){var o=e[n];if(!l.isBuffer(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(s,r),r+=o.length}return s},l.byteLength=f,l.prototype._isBuffer=!0,l.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)g(this,t,t+1);return this},l.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)g(this,t,t+3),g(this,t+1,t+2);return this},l.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)g(this,t,t+7),g(this,t+1,t+6),g(this,t+2,t+5),g(this,t+3,t+4);return this},l.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?T(this,0,e):m.apply(this,arguments)},l.prototype.equals=function(e){if(!l.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===l.compare(this,e)},l.prototype.inspect=function(){var e="",n=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,n).match(/.{2}/g).join(" "),this.length>n&&(e+=" ... ")),"<Buffer "+e+">"},l.prototype.compare=function(e,t,n,s,r){if(!l.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===s&&(s=0),void 0===r&&(r=this.length),t<0||n>e.length||s<0||r>this.length)throw new RangeError("out of range index");if(s>=r&&t>=n)return 0;if(s>=r)return-1;if(t>=n)return 1;if(this===e)return 0;for(var a=(r>>>=0)-(s>>>=0),o=(n>>>=0)-(t>>>=0),i=Math.min(a,o),c=this.slice(s,r),u=e.slice(t,n),h=0;h<i;++h)if(c[h]!==u[h]){a=c[h],o=u[h];break}return a<o?-1:o<a?1:0},l.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},l.prototype.indexOf=function(e,t,n){return y(this,e,t,n,!0)},l.prototype.lastIndexOf=function(e,t,n){return y(this,e,t,n,!1)},l.prototype.write=function(e,t,n,s){if(void 0===t)s="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)s=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===s&&(s="utf8")):(s=n,n=void 0)}var r=this.length-t;if((void 0===n||n>r)&&(n=r),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");s||(s="utf8");for(var a=!1;;)switch(s){case"hex":return b(this,e,t,n);case"utf8":case"utf-8":return _(this,e,t,n);case"ascii":return E(this,e,t,n);case"latin1":case"binary":return S(this,e,t,n);case"base64":return w(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,e,t,n);default:if(a)throw new TypeError("Unknown encoding: "+s);s=(""+s).toLowerCase(),a=!0}},l.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function M(e,t,n){var s="";n=Math.min(e.length,n);for(var r=t;r<n;++r)s+=String.fromCharCode(127&e[r]);return s}function A(e,t,n){var s="";n=Math.min(e.length,n);for(var r=t;r<n;++r)s+=String.fromCharCode(e[r]);return s}function N(e,t,n){var s=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>s)&&(n=s);for(var r="",a=t;a<n;++a)r+=G(e[a]);return r}function x(e,t,n){for(var s=e.slice(t,n),r="",a=0;a<s.length;a+=2)r+=String.fromCharCode(s[a]+256*s[a+1]);return r}function P(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function I(e,t,n,s,r,a){if(!l.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>r||t<a)throw new RangeError('"value" argument is out of bounds');if(n+s>e.length)throw new RangeError("Index out of range")}function D(e,t,n,s){t<0&&(t=65535+t+1);for(var r=0,a=Math.min(e.length-n,2);r<a;++r)e[n+r]=(t&255<<8*(s?r:1-r))>>>8*(s?r:1-r)}function k(e,t,n,s){t<0&&(t=4294967295+t+1);for(var r=0,a=Math.min(e.length-n,4);r<a;++r)e[n+r]=t>>>8*(s?r:3-r)&255}function L(e,t,n,s,r,a){if(n+s>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function R(e,t,n,s,a){return a||L(e,0,n,4),r.write(e,t,n,s,23,4),n+4}function B(e,t,n,s,a){return a||L(e,0,n,8),r.write(e,t,n,s,52,8),n+8}l.prototype.slice=function(e,t){var n,s=this.length;if((e=~~e)<0?(e+=s)<0&&(e=0):e>s&&(e=s),(t=void 0===t?s:~~t)<0?(t+=s)<0&&(t=0):t>s&&(t=s),t<e&&(t=e),l.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=l.prototype;else{var r=t-e;n=new l(r,void 0);for(var a=0;a<r;++a)n[a]=this[a+e]}return n},l.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||P(e,t,this.length);for(var s=this[e],r=1,a=0;++a<t&&(r*=256);)s+=this[e+a]*r;return s},l.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||P(e,t,this.length);for(var s=this[e+--t],r=1;t>0&&(r*=256);)s+=this[e+--t]*r;return s},l.prototype.readUInt8=function(e,t){return t||P(e,1,this.length),this[e]},l.prototype.readUInt16LE=function(e,t){return t||P(e,2,this.length),this[e]|this[e+1]<<8},l.prototype.readUInt16BE=function(e,t){return t||P(e,2,this.length),this[e]<<8|this[e+1]},l.prototype.readUInt32LE=function(e,t){return t||P(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},l.prototype.readUInt32BE=function(e,t){return t||P(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},l.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||P(e,t,this.length);for(var s=this[e],r=1,a=0;++a<t&&(r*=256);)s+=this[e+a]*r;return s>=(r*=128)&&(s-=Math.pow(2,8*t)),s},l.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||P(e,t,this.length);for(var s=t,r=1,a=this[e+--s];s>0&&(r*=256);)a+=this[e+--s]*r;return a>=(r*=128)&&(a-=Math.pow(2,8*t)),a},l.prototype.readInt8=function(e,t){return t||P(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},l.prototype.readInt16LE=function(e,t){t||P(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},l.prototype.readInt16BE=function(e,t){t||P(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},l.prototype.readInt32LE=function(e,t){return t||P(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},l.prototype.readInt32BE=function(e,t){return t||P(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},l.prototype.readFloatLE=function(e,t){return t||P(e,4,this.length),r.read(this,e,!0,23,4)},l.prototype.readFloatBE=function(e,t){return t||P(e,4,this.length),r.read(this,e,!1,23,4)},l.prototype.readDoubleLE=function(e,t){return t||P(e,8,this.length),r.read(this,e,!0,52,8)},l.prototype.readDoubleBE=function(e,t){return t||P(e,8,this.length),r.read(this,e,!1,52,8)},l.prototype.writeUIntLE=function(e,t,n,s){(e=+e,t|=0,n|=0,s)||I(this,e,t,n,Math.pow(2,8*n)-1,0);var r=1,a=0;for(this[t]=255&e;++a<n&&(r*=256);)this[t+a]=e/r&255;return t+n},l.prototype.writeUIntBE=function(e,t,n,s){(e=+e,t|=0,n|=0,s)||I(this,e,t,n,Math.pow(2,8*n)-1,0);var r=n-1,a=1;for(this[t+r]=255&e;--r>=0&&(a*=256);)this[t+r]=e/a&255;return t+n},l.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,1,255,0),l.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},l.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,2,65535,0),l.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):D(this,e,t,!0),t+2},l.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,2,65535,0),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):D(this,e,t,!1),t+2},l.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,4,4294967295,0),l.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):k(this,e,t,!0),t+4},l.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,4,4294967295,0),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):k(this,e,t,!1),t+4},l.prototype.writeIntLE=function(e,t,n,s){if(e=+e,t|=0,!s){var r=Math.pow(2,8*n-1);I(this,e,t,n,r-1,-r)}var a=0,o=1,i=0;for(this[t]=255&e;++a<n&&(o*=256);)e<0&&0===i&&0!==this[t+a-1]&&(i=1),this[t+a]=(e/o>>0)-i&255;return t+n},l.prototype.writeIntBE=function(e,t,n,s){if(e=+e,t|=0,!s){var r=Math.pow(2,8*n-1);I(this,e,t,n,r-1,-r)}var a=n-1,o=1,i=0;for(this[t+a]=255&e;--a>=0&&(o*=256);)e<0&&0===i&&0!==this[t+a+1]&&(i=1),this[t+a]=(e/o>>0)-i&255;return t+n},l.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,1,127,-128),l.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},l.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,2,32767,-32768),l.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):D(this,e,t,!0),t+2},l.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,2,32767,-32768),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):D(this,e,t,!1),t+2},l.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,4,2147483647,-2147483648),l.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):k(this,e,t,!0),t+4},l.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||I(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),l.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):k(this,e,t,!1),t+4},l.prototype.writeFloatLE=function(e,t,n){return R(this,e,t,!0,n)},l.prototype.writeFloatBE=function(e,t,n){return R(this,e,t,!1,n)},l.prototype.writeDoubleLE=function(e,t,n){return B(this,e,t,!0,n)},l.prototype.writeDoubleBE=function(e,t,n){return B(this,e,t,!1,n)},l.prototype.copy=function(e,t,n,s){if(n||(n=0),s||0===s||(s=this.length),t>=e.length&&(t=e.length),t||(t=0),s>0&&s<n&&(s=n),s===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(s<0)throw new RangeError("sourceEnd out of bounds");s>this.length&&(s=this.length),e.length-t<s-n&&(s=e.length-t+n);var r,a=s-n;if(this===e&&n<t&&t<s)for(r=a-1;r>=0;--r)e[r+t]=this[r+n];else if(a<1e3||!l.TYPED_ARRAY_SUPPORT)for(r=0;r<a;++r)e[r+t]=this[r+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+a),t);return a},l.prototype.fill=function(e,t,n,s){if("string"==typeof e){if("string"==typeof t?(s=t,t=0,n=this.length):"string"==typeof n&&(s=n,n=this.length),1===e.length){var r=e.charCodeAt(0);r<256&&(e=r)}if(void 0!==s&&"string"!=typeof s)throw new TypeError("encoding must be a string");if("string"==typeof s&&!l.isEncoding(s))throw new TypeError("Unknown encoding: "+s)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var a;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(a=t;a<n;++a)this[a]=e;else{var o=l.isBuffer(e)?e:j(new l(e,s).toString()),i=o.length;for(a=0;a<n-t;++a)this[a+t]=o[a%i]}return this};var F=/[^+\/0-9A-Za-z-_]/g;function G(e){return e<16?"0"+e.toString(16):e.toString(16)}function j(e,t){var n;t=t||1/0;for(var s=e.length,r=null,a=[],o=0;o<s;++o){if((n=e.charCodeAt(o))>55295&&n<57344){if(!r){if(n>56319){(t-=3)>-1&&a.push(239,191,189);continue}if(o+1===s){(t-=3)>-1&&a.push(239,191,189);continue}r=n;continue}if(n<56320){(t-=3)>-1&&a.push(239,191,189),r=n;continue}n=65536+(r-55296<<10|n-56320)}else r&&(t-=3)>-1&&a.push(239,191,189);if(r=null,n<128){if((t-=1)<0)break;a.push(n)}else if(n<2048){if((t-=2)<0)break;a.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;a.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;a.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return a}function W(e){return s.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(F,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function Y(e,t,n,s){for(var r=0;r<s&&!(r+n>=t.length||r>=e.length);++r)t[r+n]=e[r];return r}}).call(this,n(35))},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Names=void 0,t.Names={};const r=s(n(4)),a=n(9),o=n(699),i=a.Random.getRNG();t.Names.place={},t.Names.place.generic={branch:["Hand","Foot","Small","Large"],dungeon:["Crypt","Catacombs","Tombs","Dungeon","Cells","Cave","Grotto","Cavern","Lair","Labyrinth","Maze"],mountain:["Summit","Volcano","Tops","Peaks","Bluff","Highlands","Pinnacle","Rise","Needle","Hills","Slopes"],face:["Face","Buttress","Ridge","Shoulder","Crag","Crest","Brink","Cairn","Col","Pass","Crown","Scree","Watershed"],forest:["Grove","Wilds","Woodlands","Timberland","Forest","Covert","Woods","Thicket","Glade"],city:["Town","Village","Fort","City"],lake:["Basin","Cove","Reservoir","Depths","Gorge","Lagoon","Domain","Pond","Expanse","Lake","Shallows","Loch","Falls","Rapids"],quarter:["Market","Bazaar","Plaza","Row","Works","Side","Acre","Garden","Park","Temple","Necropolis","Cemetery","Library","Arcane","Royal","Slum","Living","Arena","Military","Barracks"],area:[]},t.Names.place.prefix={dungeon:["Winding","Dark","Ominous","Tranquil"]},t.Names.place.suffix={dungeon:[]},t.Names.place.unique={city:{first:["Stag","Small","Mud","Ebon","Silk","Spirit","Basin","Shadow","Gold","Silver","Snow","Frost","Ice","Hound","Moon","Dire","Ever","Iron","Ruby","Star","Crystal","Glimmer","Winters","Raven","Pine","Ever","Never","Rune","Glace","Lumen","Confer","Flamen","Jotun","Troll","Winds","Oaken","Willow","Anvil","Ashen","Kosken","Storm"],second:["guard","point","fell","mire","shield","crest","yard","minster","swallow","grasp","cliff","cross","host","barrow","vein","view","home","gard","wall","heim","creek","gasp","mane","thorne","keep"]}},t.Names.place.unique.mountain={first:t.Names.place.unique.city.first,second:t.Names.place.generic.mountain.map(e=>" "+e.toLowerCase())},t.Names.place.unique.dungeon={first:t.Names.place.unique.city.first,second:t.Names.place.generic.dungeon.map(e=>" "+e.toLowerCase())},t.Names.actor={},t.Names.item={steal:{adjective:["emerald","exquisite","golden","silver","bronze","ruby","diamond"],substantive:["ring","amulet","plate","vase","goblet"],char:{ring:"=",amulet:"^",plate:"_",vase:"]",goblet:"]"}},gather:{adjective:[],substantive:[]}},t.Names.getItemToStealName=()=>{const e=t.Names.item.steal,n=i.arrayGetRand(e.adjective),s=i.arrayGetRand(e.substantive);return n.capitalize()+" "+s},t.Names.getItemToGather=()=>{const e=t.Names.item.gather,n=i.arrayGetRand(e.adjective),s=i.arrayGetRand(e.substantive);return n.capitalize()+" "+s},t.Names.getVillageType=()=>i.arrayGetRand(["Village","Hamlet","Town","Township"]),t.Names.alreadyUsed=new Set([""]),t.Names.getUniqueName=e=>{const n=t.Names.place.unique[e];if(n){let e="";for(;t.Names.alreadyUsed.has(e);){e=i.arrayGetRand(n.first)+i.arrayGetRand(n.second)}return e}return r.default.err("name-gen.ts","Names.getUniqueName","No unique names for type "+e),""},t.Names.getSuffix=e=>{const n=t.Names.place.suffix[e];return n?i.arrayGetRand(n):""},t.Names.getPrefix=e=>{const n=t.Names.place.suffix[e];return n?i.arrayGetRand(n):""},t.Names.getGenericPlaceName=e=>{const n=t.Names.place.generic[e];return i.arrayGetRand(n)},t.Names.getActorName=()=>o.ActorNames.getName();const l=["old","ancient","dusty","worn","well-preserved","heavy","light","thick","thin"],c=["rune-covered","worm-ridden","leather","hard-cover","metal-plated","decorated","exquisite","engraved","plain","ordinary","aesthetic","ornamental","skeletal"],u=["tome","book","tract","codex","opus","handbook","volume","treatise","grimoire","rariora","compendium","epitome","manuscript"];t.Names.getBookName=()=>{let e="";for(;t.Names.alreadyUsed.has(e);){let t=i.arrayGetRand(l);t=t.capitalize();e=`${t} ${i.arrayGetRand(c)} ${i.arrayGetRand(u)}`}return e}},function(e,t,n){var s=n(83),r=n(121);e.exports=n(101)?function(e,t,n){return s.f(e,t,r(1,n))}:function(e,t,n){return e[t]=n,e}},function(e,t,n){var s=n(100);e.exports=function(e){if(!s(e))throw TypeError(e+" is not an object!");return e}},function(e,t){e.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},function(e,t,n){e.exports=!n(120)((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}))},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e){return(0,r.default)(s.default.findDOMNode(e))};var s=a(n(17)),r=a(n(52));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FromJSON=void 0;const i=n(15)("bitn:Game.FromJSON"),l=o(n(4)),c=n(125),u=n(226),h=n(114),d=n(38),p=n(185),f=n(135),m=n(243),g=n(787),y=n(24),v=n(91),b=n(23),_=n(26),E=n(113),S=n(18),w=n(12),C=n(11),O=n(39),T=n(182),M=n(61),A=n(46),N=a(n(16)),x=n(87),P=a(n(45)),I=n(9),D=n(126),k=n(167),L=n(55),R=n(27),B=n(178),F=n(111),G=n(373),j=n(160),W=b.EventPool.getPool();R.Brain.Player=B.BrainPlayer,R.Brain.Spawner=F.BrainSpawner;const Y=Symbol("OBJ_REF_REMOVED");t.FromJSON=class{constructor(){this._dungeonLevel=1,this._parser=w.ObjectShell.getParser(),this.id2level={},this.id2entity={},this.id2EntityJson={},this.id2Object={},this.id2Place={},this.actorsKilled={},this.id2Component={},this.id2CompJSON={},this.compsWithMissingRefs={},this.stairsInfo={},this.IND=0,this.chunkMode=!1}reset(){this.id2level={},this.id2entity={},this.id2EntityJson={},this.id2Object={},this.id2Component={},this.id2CompJSON={},this.id2Place={},this.stairsInfo={},this.compsWithMissingRefs={}}setChunkMode(e){this.chunkMode=e}getDungeonLevel(){return this._dungeonLevel}addObjRef(e,t,n){const s=t.getID();Number.isInteger(s)||l.default.err("FromJSON","addObjRef",`ID must be integer. Got: |${s}|`),this.id2entity[s]=t,this.id2Object[s]=t,n&&(this.id2EntityJson[s]=n),"level"===e?(this.id2level[s]=t,this.id2Place[s]=t):"element"===e||"entity"===e||l.default.err("FromJSON","addObjRef",`Unsupported type ${e} give`)}getObjByRef(e){let t=null;if(t=e.$objRef?e.$objRef:e,"entity"===t.type){const n=this.id2entity[t.id];if(!n){if(this.actorsKilled[t.id])return Y;{const n=JSON.stringify(e);l.default.err("FromJSON","getObjByRef",`No ID ${t.id} found. ReqObj: ${n}`)}}return n}return"level"===t.type?this.id2level[t.id]:"object"===t.type?this.id2Object[t.id]:"component"===t.type?this.id2Component[t.id]:"place"===t.type?this.id2Place[t.id]:null}createGame(e,t){"string"==typeof t&&l.default.err("Game.FromJSON","createGame","An object must be given instead of string"),this.dbg("createGame: Restoring now full game"),this.IND=1,this.setGlobalConfAndObjects(e,t),t.chunkManager&&this.setChunkMode(!0),C.Component.setIDCount(t.lastComponentID);const n=[];if(this.getLevelsToRestore(t).forEach(t=>{const s=this.restoreLevel(t);n.push(s),t.parent||(this.dbg(">> No parent. Adding directly "+s.getID()),e.addLevel(s))}),t.places&&Object.keys(t.places).forEach(n=>{const s=t.places[n],r=this.restorePlace(s);e.addPlace(r)}),t.overworld){const n=this.restoreOverWorld(t.overworld);e.setOverWorld(n)}if(t.worldSim){this.restoreWorldSim(e._worldSim,t.worldSim)}if(this.connectGameLevels(n),t.player){const n=this.restorePlayer(t.player);this.addRestoredPlayerToGame(n,e,t)}this.restoreEntityData(),this.restoreComponentData();const s=this.restoreGameMaster(e,t.gameMaster);if(e.setGameMaster(s),this.restoreChunkManager(e,t),this.checkNumOfLevels(e,t),f.GameObject.ID=t.gameObjectID,i.enabled&&this.dbg("Restored GameObject ID count to "+f.GameObject.ID),t.rng){const n=new I.Random(t.rng.seed);n.setState(t.rng.state),e.setRNG(n)}if(t.diceRng){const e=new I.Random(t.diceRng.seed);e.setState(t.diceRng.state),_.Dice.RNG=e}return this.restoreActiveLevels(e,t),this.IND=0,e.updateEventPoolRefs(),e}restorePlayer(e){const t=new M.SentientActor(e.name);return t.setIsPlayer(!0),t.remove("StatsMods"),t.remove("CombatMods"),t.setType(e.type),t.setID(e.id),this._dungeonLevel=e.dungeonLevel,this.addObjRef("entity",t,e),l.default.addCellStyle(l.default.TYPE_ACTOR,e.name,"cell-actor-player"),t}restorePlayerBrain(e,t){const n=e.getBrain(),s=n.getMemory(),r=t.memory;Object.keys(r).forEach(e=>{s[e](r[e])}),t.markList&&n._markList.fromJSON(t.markList)}addRestoredPlayerToGame(e,t,n){const s=n.player.levelID,r=t.getLevels().find(e=>e.getID()===s);if(r){const s=n.player.x,a=n.player.y;r.addActor(e,s,a),t.addPlayer(e)}else{const e="IDs available: "+t.getLevels().map(e=>e.getID());l.default.err("Game.FromJSON","addRestoredPlayerToGame",`Cannot find player level object with level ID ${s}. ${e}`)}}restoreEntity(e,t){l.default.isActor(t)?(this.createBrain(e.brain,t),this._addEntityFeatures(e,t),this.addEffectsToEntity(t)):l.default.isElement(t)?this.restoreElementEntity(e,t):l.default.isItem(t)||this.restoreLevelEntity(e,t)}_addEntityFeatures(e,t){this.addCompsToEntity(t,e.components),this.createInventoryItems(e,t),this.createEquippedItems(e,t),e.spellbook&&this.createSpells(e,t)}restoreElementEntity(e,t){"lever"===t.getType()&&e.addTarget.forEach(e=>{const n=e.$objRef,s=this.id2entity[n.id];s&&t.addTarget(s)}),e.components&&this.addCompsToEntity(t,e.components)}restoreLevelEntity(e,t){this.addCompsToEntity(t,e.components)}addCompsToEntity(e,t){for(const n in t)if(n){const s=t[n],r=s.setType;if(!r){const e='No "setType" in component: ';l.default.err("Game.FromJSON","addCompsToEntity",e+JSON.stringify(s))}const a=this.createComponent(r,s);e.add(a)}}addEffectsToEntity(e){if(e.has("UseEffects")){const t=e.get("UseEffects").getEffects();0===t.length&&l.default.err("Game.FromJSON","addEffectsToEntity","effects length was 0"),t.forEach(t=>{const n={use:t};this._parser.getCreator().addUseEffects(n,e)})}}createComponent(e,t){if(!C.Component.hasOwnProperty(e)){let n=`No |${e}| in Component.`;n+=" compJSON: "+JSON.stringify(t),l.default.err("Game.FromJSON","createComponent",n)}const n=C.Component.create(e);for(const s in t)if("function"==typeof n[s]){const e=t[s],r=this.getCompValue(n,t,s,e);n[s](r)}else{const n=JSON.stringify(t);l.default.err("FromJSON","createComponent",`${s} not function in ${e}. Comp: ${n}`)}const s=n.getID();return this.id2Component[s]=n,this.id2CompJSON[s]=t,n}getCompValue(e,t,n,s){if("string"==typeof s||"number"==typeof s)return s;if(l.default.isNullOrUndef([s])){const e=JSON.stringify(t);let r=`valueToSet |${s}|. setFunc |${n}|`;r+=`Comp |${t.setType}|, json: ${e}`,l.default.err("FromJSON","addCompsToEntity",r)}else{if(Array.isArray(s)){if(s.$objRefArray)return this.compsWithMissingRefs[t.setID]=e,s;const r=[];return s.forEach(s=>{const a=this.getCompValue(e,t,n,s);r.push(a)}),r}if(s.createFunc){return this[s.createFunc](s.value)}if(s.createComp){const e=s.createComp.setType;return this.createComponent(e,s.createComp)}if(!s.$objRef)return s;if("component"===s.$objRef.type)return this.compsWithMissingRefs[t.setID]=e,s;{const e=this.getObjByRef(s.$objRef);if(e)return e;{let e="Null obj for objRef "+JSON.stringify(s.$objRef);e+=" compJSON: "+JSON.stringify(t),l.default.err("FromJSON","getCompValue",e)}}}return null}createActorClass(e){const{className:t,actorRef:n}=e,s=this.getObjByRef(n);return s?v.ActorClass.create(t,s):(l.default.err("FromJSON","createActorClass",`No actor for class ${t} found`),null)}createQuestData(e){const t=new m.QuestData;return e.path.forEach(e=>{let n=null;if(n=e.target.$objRef?this.getObjByRef(e.target.$objRef):e.target,n===Y)n={msg:"Quest target missing/killed"};else if(!n){const t="Missing objRef: "+JSON.stringify(e.target);l.default.err("FromJSON","createQuest",t)}t.addTarget(e.type,n)}),t}createBrain(e,t){const n=e.type;if(R.Brain[n]){const s=new R.Brain[n](t);if(t.setBrain(s),"Player"===n)return void this.restorePlayerBrain(t,e);e.constraint&&s.setConstraint(e.constraint),e.placeConstraint&&s.setPlaceConstraint(e.placeConstraint),e.spawnProb&&(s.spawnProb=e.spawnProb),e.hasOwnProperty("spawnLeft")&&(s.spawnLeft=e.spawnLeft);const r=s.getMemory(),a=e.memory;if(a){if(a.enemyTypes.forEach(e=>{s.addEnemyType(e)}),a.lastAttackedID){const e=this.id2entity[a.lastAttackedID];r.setLastAttacked(e)}if(a.enemies&&a.enemies.forEach(e=>{const t=this.id2entity[e];t&&r.addEnemy(t)}),a.friends&&a.friends.forEach(e=>{const t=this.id2entity[e];t&&r.addFriend(t)}),a.seen&&(r._actors.seen=a.seen),e.goal){const n=this.createTopGoal(e.goal,t);s.setGoal(n)}}else"Rogue"===n&&s.getMemory().addEnemyType("player")}else l.default.err("FromJSON","createBrain",`Cannot find Brain.${n}, JSON: ${e}`)}createTopGoal(e,t){const n=new h.GoalsTop[e.type](t);return n.removeEvaluators(),e.evaluators.forEach(e=>{let s=null;if(d.Evaluator[e.type])s=new d.Evaluator[e.type](e.bias);else if(p.EvaluatorsBattle[e.type])s=new p.EvaluatorsBattle[e.type](e.bias);else{const n="Entity: "+JSON.stringify(t);l.default.err("FromJSON","createTopGoal",`Evaluator ${e.type} not found. ${n}`)}e.args&&s.setArgs(e.args),n.addEvaluator(s)}),n}createSpells(e,t){return t._spellbook=new E.Spell.SpellBook(t),e.spellbook.spells.forEach(e=>{if(E.Spell.hasOwnProperty(e.new)){const n=this.restoreSpell(e,t);t._spellbook.addSpell(n)}else l.default.err("FromJSON","createSpells",`No spell ${e.new} found in Spell`)}),t._spellbook}restoreSpell(e,t){const n=new E.Spell[e.new];if(n.setPower(e.power),e.range&&n.setRange(e.range),e.dice){const t={};Object.keys(e.dice).forEach(n=>{const s=e.dice[n];t[n]=_.Dice.create(s)}),n._dice=t}return e.spells&&(n.removeSpells(),e.spells.forEach(e=>{const s=this.restoreSpell(e,t);n.addSpell(s)})),n}createItem(e){const t=e;let n=null;if(this._parser.hasItem(e.setName))n=this._parser.createItem(e.setName);else{const s=this.getItemObjectType(t);if(O.Item[s])n=new O.Item[s];else{let t=`No RG.Item[${s}] found for new()`;t+=" JSON: "+JSON.stringify(e),l.default.err("FromJSON","createItem",t)}}for(const e in t)if("setSpirit"===e){const s=t[e],r=this.createActor(s);this.createBrain(s.brain,r),this._addEntityFeatures(s,r),n[e](r)}else if("function"==typeof n[e])n[e](t[e]);else if("components"!==e&&"isUsable"!==e){const t=JSON.stringify(n);l.default.err("Game.FromJSON","createItem",`${e} not func in ${t}`)}return this.addEntityInfo(n,e),t.components&&this.addCompsToEntity(n,e.components),n}createInventoryItems(e,t){if("Sentient"===e.new&&(t._invEq=new T.Inventory(t)),e.hasOwnProperty("inventory")){const n=e.inventory;for(let e=0;e<n.length;e++){const s=this.createItem(n[e]);t.getInvEq().addItem(s)}}}createEquippedItems(e,t){if(e.hasOwnProperty("equipment")){const n=e.equipment;for(let e=0;e<n.length;e++){const s=this.createItem(n[e]);t.getInvEq().restoreEquipped(s)}}}getItemObjectType(e){if("spiritgem"===e.setType)return"SpiritGem";if("goldcoin"===e.setType)return"GoldCoin";if("missileweapon"===e.setType)return"MissileWeapon";if(l.default.isNullOrUndef([e]))l.default.err("FromJSON","getItemObjectType","item is undefined");else{if(!l.default.isNullOrUndef([e.setType]))return e.setType.capitalize();{const t=JSON.stringify(e);l.default.err("FromJSON","getItemObjectType","item.setType is undefined. item: "+t)}}return null}restoreLevel(e){const t=this.createCellMap(e.map),n=new y.Level(t);return n.setID(e.id),n.setLevelNumber(e.levelNumber),this.addLevels([n],"restoreLevel",[e]),e.actors.forEach(e=>{const t=this.createActor(e.obj);null!==t?this.isVirtual(e)?n.addVirtualProp(l.default.TYPE_ACTOR,t):n.addActor(t,e.x,e.y):l.default.err("FromJSON","restoreLevel",`Actor ${JSON.stringify(e)} returned null`)}),e.elements.forEach(e=>{const t=this.createElement(e);null!==t?n.addElement(t,e.x,e.y):l.default.err("FromJSON","restoreLevel",`createElement ${JSON.stringify(e)} returned null`)}),e.items.forEach(e=>{const t=this.createItem(e.obj);null!==t?n.addItem(t,e.x,e.y):l.default.err("FromJSON","restoreLevel",`Actor ${JSON.stringify(e)} returned null`)}),n}isVirtual(e){return-1===e.x&&-1===e.y}createElement(e){const t=e.obj,n=t.type;let s=null;if("connection"===n)s=this.createUnconnectedStairs(e);else if("shop"===n){const e=new N.ElementShop;let n=null;l.default.isNullOrUndef([t.shopkeeper])||(n=this.id2entity[t.shopkeeper],n?e.setShopkeeper(n):l.default.err("Game.FromJSON","createElement",`Shopkeeper with ID ${t.shopkeeper} not found`)),e.setCostFactor(t.costFactorBuy,t.costFactorSell),t.isAbandoned&&e.abandonShop(),s=e}else if("door"===n)s=new N.ElementDoor(t.closed);else if("leverdoor"===n)s=new N.ElementLeverDoor(t.closed);else if("lever"===n)s=new N.ElementLever;else if("marker"===n)s=new N.ElementMarker(t.char),s.setTag(t.tag);else if("exploration"===n){const e=new N.ElementExploration;e.setExp(t.setExp),t.data&&e.setData(t.data),s=e}else"web"===n?s=new N.ElementWeb:"slime"===n?s=new N.ElementSlime:"hole"===n?s=new N.ElementHole:(s=new N.ElementXY(t.name),s.setType(t.type));if(t.msg&&s.setMsg(t.msg),s){const e=t.id;Number.isInteger(e)&&(s.setID(e),this.addObjRef("element",s,t))}return s}createActor(e){null===e.type&&l.default.err("FromJSON","createActor","json.type null, json: "+JSON.stringify(e));let t=null;if(e.new&&M.Actor[e.new])t=new M.Actor[e.new](e.name,!1);else{let t="";const n=JSON.stringify(e);if(e.new){const s=Object.keys(M.Actor);t=`Constr ${e.new} not in Actor: ${s}. JSON obj: `+n}else t="No json.new given. JSON obj: "+n;l.default.err("Game.FromJSON","createActor",t)}return t.add(new C.Component.Location),t.add(new C.Component.Typed("BaseActor",l.default.TYPE_ACTOR)),t.setType(e.type),t.setID(e.id),this.addEntityInfo(t,e),t}addEntityInfo(e,t){this.addObjRef("entity",e,t)}createUnconnectedStairs(e){const{x:t,y:n}=e,s=`${e.obj.srcLevel},${t},${n}`,r=e.obj,a=new N.ElementStairs(r.name);if(r.isOneway){const e=r.targetStairs;a.setTargetOnewayXY(e.x,e.y)}return this.stairsInfo[s]={targetLevel:r.targetLevel,targetStairs:r.targetStairs},a}createCellMap(e){if(e.encoded)return A.CellMap.fromJSON(e);const t=new A.CellMap(e.cols,e.rows);return e.cells.forEach((e,n)=>{e.forEach((e,s)=>{const r=this.createBaseElem(e);t.setBaseElemXY(n,s,r)})}),e.explored.forEach(e=>{t.getCell(e[0],e[1]).setExplored()}),t}createBaseElem(e){const t=S.ELEM_MAP.elemIndexToType[e];return S.ELEM_MAP.elemTypeToObj[t]?S.ELEM_MAP.elemTypeToObj[t]:(l.default.err("Game.fromJSON","createBaseElem","Unknown type "+t),null)}setGlobalConfAndObjects(e,t){t.globalConf&&(this.dbg("Setting globalConf for game: "+JSON.stringify(t.globalConf,null,1)),e.setGlobalConf(t.globalConf)),t.cellStyles&&(l.default.cellStyles=t.cellStyles),t.charStyles&&(l.default.charStyles=t.charStyles),t.actorsKilled&&(this.actorsKilled=t.actorsKilled,e.actorsKilled=t.actorsKilled),t.objectShellParser&&w.ObjectShell.restoreParser(t.objectShellParser),t.gameID&&(e.gameID=t.gameID);const n=t.engine;if(n.msgHandler){const t=n.msgHandler,s=e.getPool();e._engine._msg=G.MessageHandler.fromJSON(t,s)}t.gameOver&&e.setGameOver(!0)}connectGameLevels(e){e.forEach(e=>{e.getConnections().forEach(t=>{const n=this.stairsInfo[t.getConnID()],s=this.id2level[n.targetLevel];if(!s&&this.chunkMode)return void t.setConnObj(n);const r=n.targetStairs;r||(l.default.diag(JSON.stringify(e,null,1)),l.default.diag(n),l.default.diag("Parent: "+e.getParent().getName()),l.default.diag(JSON.stringify(t)));const a=r.x,o=r.y;if(s){if(t.setTargetLevel(s),t.isOneway)return;const e=s.getMap().getCell(a,o).getConnection();e?t.connect(e):l.default.err("Game.FromJSON","connectGameLevels","Target stairs was null. Cannot connect.")}else{const e=n.targetLevel;l.default.err("Game.FromJSON","connectGameLevels",`Target level ${e} null. Cannot connect.`)}})})}restoreGameMaster(e,t){++this.IND;const n=e.getGameMaster(),s={};return Object.keys(t.battles).forEach(e=>{t.battles[e].forEach(t=>{if(s[e]=[],this.id2level[e]){this.dbg("FromJSON Restoring Battle "+e);const n=this.restoreBattle(t);s[e].push(n)}else this.dbg(`FromJSON Battle ${e} not created`),this.dbg(JSON.stringify(t)),s[e].push(t)})}),n.setBattles(s),t.battlesDone&&(n.battlesDone=t.battlesDone),n.hasBattleSpawned=t.hasBattleSpawned,--this.IND,n}restoreBattle(e){const t=this.getLevelOrFatal(e.level,"restoreBattle");if(t){++this.IND,this.dbg("\trestoreBattle found level ID "+e.level);const n=new u.Battle(e.name);n.setID(e.id),n.setLevel(t),n.setStats(e.stats),n.finished=e.finished;const s=[];if(e.armies.forEach(e=>{s.push(this.restoreArmy(e))}),n.setArmies(s),n.finished&&(i(e.name+" finished. rm listeners"),W.removeListener(n),s.forEach(e=>{W.removeListener(e)})),e.parent){const t=this.id2Place[e.parent];if(t)l.default.isBattleZone(t)?t.setBattle(n):l.default.err("FromJSON","restoreBattle","Only battleZone can be parentZone of battle");else{const t=JSON.stringify(e);l.default.err("FromJSON","restoreBattle",`Could not find parent zone with ID ${e.parent}: ${t}`)}}return--this.IND,n}return l.default.err("Game.FromJSON","restoreBattle","No level for battle ID's "+e.level),null}restoreArmy(e){const t=new u.Army(e.name);return e.id&&t.setID(e.id),e.actors.forEach(e=>{if(this.id2entity[e]){const n=this.id2entity[e];l.default.isActor(n)&&t.addActor(n)}}),t.setDefeatThreshold(e.defeatThreshold),Object.entries(e.alignment).forEach(e=>{const[n,s]=e;t.addAlignment(n,s)}),t}restorePlace(e){const t=new g.WorldFromJSON(this.id2level,this.id2entity);t.fromJSON=this;const n=t.createPlace(e);return this.id2Place=Object.assign(this.id2Place,n.getID2Place()),n}restoreOverWorld(e){const t=c.OWMap.fromJSON(e),n=new D.OverWorld.CoordMap;for(const t in e.coordMap)e.coordMap.hasOwnProperty(t)&&(n[t]=e.coordMap[t]);return t.coordMap=n,t}restoreWorldSim(e,t){const n=k.WorldSimulation.fromJSON(t);return e.updateCount=n.updateCount,e.seasonMan=n.seasonMan,e.dayMan=n.dayMan,e}restoreEntityData(){const e=JSON.parse(JSON.stringify(L.Entity.num));if(Object.keys(this.id2EntityJson).forEach(e=>{const t=this.id2EntityJson[e],n=this.id2entity[e];if(t&&n)this.restoreEntity(t,n);else{let s=t?"":"|JSON is null/undef|";s+=n?"":"|entity is null/undef|",l.default.err("FromJSON","restoreEntityData",`ID: ${e} ${s}`)}}),i.enabled){const t=JSON.parse(JSON.stringify(L.Entity.num));Object.keys(t).forEach(n=>{console.log(`${n}: ${t[n]-e[n]}`)})}}restoreComponentData(){Object.keys(this.compsWithMissingRefs).forEach(e=>{const t=this.compsWithMissingRefs[e],n=this.id2CompJSON[e];this.restoreComponent(n,t)})}restoreComponent(e,t){Object.keys(e).forEach(n=>{const s=e[n];if(Array.isArray(s)){if(s.$objRefArray){const e=[];s.forEach(t=>{if(t.$objRef)e.push(this.getObjByRef(t.$objRef));else{const e=JSON.stringify(s);l.default.err("FromJSON","restoreComponent","$objRefArray found but no $objRefs inside: "+e)}}),t[n](e)}}else s.$objRef&&"component"===s.$objRef.type&&t[n](this.getObjByRef(s.$objRef))})}reportMissingLevel(e){let t="connObj: "+JSON.stringify(e);Object.keys(this.id2level).forEach(e=>{t+="\n\t"+e}),console.warn(t+"\n")}dbg(e){if(i.enabled){const t=">".repeat(this.IND);i(`${t} ${e}`)}}getLevelsToRestore(e){let t=[],n=0;return e.levels?e.levels:e.places?(Object.keys(e.places).forEach(s=>{const r=e.places[s];r.area&&r.area.forEach(e=>{e.tiles.forEach((s,r)=>{s.forEach((s,a)=>{e.tileStatus[r][a]===j.LoadStat.LOADED&&(n+=s.levels.length,t=t.concat(s.levels))})})})}),this.dbg(`Restoring ${t.length} out of ${n}`),t):t}createTiles(e,t){const n=e.getLevels();this.addLevels(n,"createTiles");let s=[];t.forEach(e=>{s=s.concat(e.levels)});const r=[];s.forEach(e=>{const t=this.restoreLevel(e);r.push(t),n.push(t)}),this.connectGameLevels(r),this.restoreEntityData(),this.restoreComponentData();const a=e.getCurrentWorld().getCurrentArea(),o=new x.FactoryWorld;o.setId2Level(this.id2level),o.id2entity=this.id2entity,t.forEach(t=>{const[n,s]=[t.x,t.y],r=new P.AreaTile(n,s,a),i=this.id2level[t.level];r.setLevel(i),e.addLevel(i);const l=JSON.parse(JSON.stringify(t));a.setTile(n,s,r),a.setLoaded(n,s),i.setParent(a),o.fromJSON=this,o.createZonesFromTile(a,l,n,s),this.restoreSerializedBattles(e,r)})}restoreSerializedBattles(e,t){const n=t.getLevel().getID(),s=e.getGameMaster();if(s.battles[n]){const e=s.battles[n];s.battles[n]=[],e.forEach(e=>{const t=this.restoreBattle(e);s.battles[n].push(t)})}}addLevels(e,t="",n=[]){e.forEach((e,s)=>{const r=e.getID();if(this.id2level.hasOwnProperty(r))l.default.log(e),l.default.err("Game.FromJSON","addLevels - "+t,"Duplicate level ID detected "+r);else{let a=null;s<n.length&&(a=n[s]),this.addObjRef("level",e,a),this.dbg(`Added level ${r} to this.id2level ${t}`)}})}connectTileLevels(e,t){t.forEach(e=>{const t=e.getID(),n=e.getTargetLevel();this.stairsInfo[t]={targetLevel:n,targetStairs:e.getTargetStairs()}}),this.addLevels(e,"connectTileLevels"),this.connectConnections(t)}connectConnections(e){e.forEach(e=>{const t=this.stairsInfo[e.getID()],n=this.id2level[t.targetLevel],s=t.targetStairs,{x:r,y:a}=s;if(n){e.setTargetLevel(n);const t=n.getMap().getCell(r,a).getConnection();t?e.connect(t):l.default.err("Game.FromJSON","connectConnections","Target stairs was null. Cannot connect.")}else{const e=t.targetLevel;l.default.err("Game.FromJSON","connectConnections",`Target level ${e} null. Cannot connect.`)}})}restoreChunkManager(e,t){if(t.chunkManager){const{chunkManager:n}=t;e.setEnableChunkUnload(!0),e._chunkManager.store.data=n.data,e._chunkManager.recordedTileMoves=n.recordedTileMoves}}checkNumOfLevels(e,t){const n=e.getLevels().length;if(t.levels&&n!==t.levels.length){const e=t.levels.length;l.default.err("Game.FromJSON","checkNumOfLevels",`Exp. ${e} levels, after restore ${n}`)}}getLevelOrFatal(e,t){if(!Number.isInteger(e)){const n="ID must be number. Got "+e;l.default.err("Game.FromJSON",t,n)}if(this.id2level.hasOwnProperty(e))return this.id2level[e];let n=`No level with ID ${e}.`;return n+=" Available: "+Object.keys(this.id2level),l.default.err("Game.FromJSON",t,n),null}restoreActiveLevels(e,t){t.engine.activeLevels.forEach(t=>{this.id2level[t]?e.addActiveLevel(this.id2level[t]):l.default.warn("FromJSON","restoreActiveLevels","Did not find active level ID "+t)})}}},function(e,t){e.exports={includeStack:!1,showDiff:!0,truncateThreshold:40,useProxy:!0,proxyExcludedKeys:["then","catch","inspect","toJSON"]}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){if((!o&&0!==o||e)&&a.default){var t=document.createElement("div");t.style.position="absolute",t.style.top="-9999px",t.style.width="50px",t.style.height="50px",t.style.overflow="scroll",document.body.appendChild(t),o=t.offsetWidth-t.clientWidth,document.body.removeChild(t)}return o};var s,r=n(41),a=(s=r)&&s.__esModule?s:{default:s};var o=void 0;e.exports=t.default},function(e,t,n){"use strict";e.exports=function(e,t,n,s,r,a,o,i){if(!e){var l;if(void 0===t)l=new Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var c=[n,s,r,a,o,i],u=0;(l=new Error(t.replace(/%s/g,(function(){return c[u++]})))).name="Invariant Violation"}throw l.framesToPop=1,l}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){function t(t,n,s,r,a,o){var i=r||"<<anonymous>>",l=o||s;if(null==n[s])return t?new Error("Required "+a+" `"+l+"` was not specified in `"+i+"`."):null;for(var c=arguments.length,u=Array(c>6?c-6:0),h=6;h<c;h++)u[h-6]=arguments[h];return e.apply(void 0,[n,s,i,a,l].concat(u))}var n=t.bind(null,!1);return n.isRequired=t.bind(null,!0),n},e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=S(n(171)),a=S(n(58)),o=S(n(41)),i=S(n(0)),l=S(n(162)),c=S(n(755)),u=S(n(10)),h=n(1),d=S(h),p=S(n(17)),f=S(n(32)),m=S(n(756)),g=S(n(357)),y=S(n(759)),v=S(n(356)),b=S(n(760)),_=S(n(163)),E=S(n(102));function S(e){return e&&e.__esModule?e:{default:e}}function w(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function C(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var O=new m.default,T=function(e){function t(){var n,s;w(this,t);for(var r=arguments.length,a=Array(r),o=0;o<r;o++)a[o]=arguments[o];return n=s=C(this,e.call.apply(e,[this].concat(a))),M.call(s),C(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.omitProps=function(e,t){var n=Object.keys(e),s={};return n.map((function(n){Object.prototype.hasOwnProperty.call(t,n)||(s[n]=e[n])})),s},t.prototype.render=function(){var e=this.props,n=e.show,r=e.container,a=e.children,o=e.transition,i=e.backdrop,l=e.dialogTransitionTimeout,c=e.className,u=e.style,p=e.onExit,f=e.onExiting,m=e.onEnter,v=e.onEntering,b=e.onEntered,_=d.default.Children.only(a),E=this.omitProps(this.props,t.propTypes);if(!(n||o&&!this.state.exited))return null;var S=_.props,w=S.role,C=S.tabIndex;return void 0!==w&&void 0!==C||(_=(0,h.cloneElement)(_,{role:void 0===w?"document":w,tabIndex:null==C?"-1":C})),o&&(_=d.default.createElement(o,{transitionAppear:!0,unmountOnExit:!0,in:n,timeout:l,onExit:p,onExiting:f,onExited:this.handleHidden,onEnter:m,onEntering:v,onEntered:b},_)),d.default.createElement(g.default,{ref:this.setMountNode,container:r,onRendered:this.onPortalRendered},d.default.createElement("div",s({ref:this.setModalNodeRef,role:w||"dialog"},E,{style:u,className:c}),i&&this.renderBackdrop(),d.default.createElement(y.default,{ref:this.setDialogRef},_)))},t.prototype.componentWillReceiveProps=function(e){e.show?this.setState({exited:!1}):e.transition||this.setState({exited:!0})},t.prototype.componentWillUpdate=function(e){!this.props.show&&e.show&&this.checkForFocus()},t.prototype.componentDidMount=function(){this._isMounted=!0,this.props.show&&this.onShow()},t.prototype.componentDidUpdate=function(e){var t=this.props.transition;!e.show||this.props.show||t?!e.show&&this.props.show&&this.onShow():this.onHide()},t.prototype.componentWillUnmount=function(){var e=this.props,t=e.show,n=e.transition;this._isMounted=!1,(t||n&&!this.state.exited)&&this.onHide()},t.prototype.autoFocus=function(){if(this.props.autoFocus){var e=this.getDialogElement(),t=(0,r.default)((0,E.default)(this));e&&!(0,a.default)(e,t)&&(this.lastFocus=t,e.hasAttribute("tabIndex")||((0,f.default)(!1,'The modal content node does not accept focus. For the benefit of assistive technologies, the tabIndex of the node is being set to "-1".'),e.setAttribute("tabIndex",-1)),e.focus())}},t.prototype.restoreLastFocus=function(){this.lastFocus&&this.lastFocus.focus&&(this.lastFocus.focus(),this.lastFocus=null)},t.prototype.getDialogElement=function(){return p.default.findDOMNode(this.dialog)},t.prototype.isTopModal=function(){return this.props.manager.isTopModal(this)},t}(d.default.Component);T.propTypes=s({},g.default.propTypes,{show:i.default.bool,container:i.default.oneOfType([l.default,i.default.func]),onShow:i.default.func,onHide:i.default.func,backdrop:i.default.oneOfType([i.default.bool,i.default.oneOf(["static"])]),renderBackdrop:i.default.func,onEscapeKeyDown:i.default.func,onEscapeKeyUp:(0,c.default)(i.default.func,"Please use onEscapeKeyDown instead for consistency"),onBackdropClick:i.default.func,backdropStyle:i.default.object,backdropClassName:i.default.string,containerClassName:i.default.string,keyboard:i.default.bool,transition:u.default,dialogTransitionTimeout:i.default.number,backdropTransitionTimeout:i.default.number,autoFocus:i.default.bool,enforceFocus:i.default.bool,restoreFocus:i.default.bool,onEnter:i.default.func,onEntering:i.default.func,onEntered:i.default.func,onExit:i.default.func,onExiting:i.default.func,onExited:i.default.func,manager:i.default.object.isRequired}),T.defaultProps={show:!1,backdrop:!0,keyboard:!0,autoFocus:!0,enforceFocus:!0,restoreFocus:!0,onHide:function(){},manager:O,renderBackdrop:function(e){return d.default.createElement("div",e)}};var M=function(){var e=this;this.state={exited:!this.props.show},this.renderBackdrop=function(){var t=e.props,n=t.backdropStyle,s=t.backdropClassName,r=t.renderBackdrop,a=t.transition,o=t.backdropTransitionTimeout,i=r({ref:function(t){return e.backdrop=t},style:n,className:s,onClick:e.handleBackdropClick});return a&&(i=d.default.createElement(a,{transitionAppear:!0,in:e.props.show,timeout:o},i)),i},this.onPortalRendered=function(){e.autoFocus(),e.props.onShow&&e.props.onShow()},this.onShow=function(){var t=(0,E.default)(e),n=(0,_.default)(e.props.container,t.body);e.props.manager.add(e,n,e.props.containerClassName),e._onDocumentKeydownListener=(0,v.default)(t,"keydown",e.handleDocumentKeyDown),e._onDocumentKeyupListener=(0,v.default)(t,"keyup",e.handleDocumentKeyUp),e._onFocusinListener=(0,b.default)(e.enforceFocus)},this.onHide=function(){e.props.manager.remove(e),e._onDocumentKeydownListener.remove(),e._onDocumentKeyupListener.remove(),e._onFocusinListener.remove(),e.props.restoreFocus&&e.restoreLastFocus()},this.setMountNode=function(t){e.mountNode=t?t.getMountNode():t},this.setModalNodeRef=function(t){e.modalNode=t},this.setDialogRef=function(t){e.dialog=t},this.handleHidden=function(){var t;(e.setState({exited:!0}),e.onHide(),e.props.onExited)&&(t=e.props).onExited.apply(t,arguments)},this.handleBackdropClick=function(t){t.target===t.currentTarget&&(e.props.onBackdropClick&&e.props.onBackdropClick(t),!0===e.props.backdrop&&e.props.onHide())},this.handleDocumentKeyDown=function(t){e.props.keyboard&&27===t.keyCode&&e.isTopModal()&&(e.props.onEscapeKeyDown&&e.props.onEscapeKeyDown(t),e.props.onHide())},this.handleDocumentKeyUp=function(t){e.props.keyboard&&27===t.keyCode&&e.isTopModal()&&e.props.onEscapeKeyUp&&e.props.onEscapeKeyUp(t)},this.checkForFocus=function(){o.default&&(e.lastFocus=(0,r.default)())},this.enforceFocus=function(){if(e.props.enforceFocus&&e._isMounted&&e.isTopModal()){var t=e.getDialogElement(),n=(0,r.default)((0,E.default)(e));t&&!(0,a.default)(t,n)&&t.focus()}}};T.Manager=m.default,t.default=T,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return e===e.window?e:9===e.nodeType&&(e.defaultView||e.parentWindow)},e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,r=n(41);var a=function(){};((s=r)&&s.__esModule?s:{default:s}).default&&(a=document.addEventListener?function(e,t,n,s){return e.addEventListener(t,n,s||!1)}:document.attachEvent?function(e,t,n){return e.attachEvent("on"+t,(function(t){(t=t||window.event).target=t.target||t.srcElement,t.currentTarget=e,n.call(e,t)}))}:void 0),t.default=a,e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BrainSpawner=t.BrainVirtual=void 0;const r=s(n(4)),a=n(60),o=n(134),i=n(12),l=n(9),c=l.Random.getRNG(),u=()=>{};class h extends o.BrainBase{constructor(e){super(e),this.setType("Virtual")}}t.BrainVirtual=h;t.BrainSpawner=class extends h{constructor(e){super(e),this.setType("Spawner"),this.constraint=null,this._constraintFunc=null,this.placeConstraint=null,this._placeConstraintFunc=null,this.spawnProb=.05,this.spawnLeft=100}setConstraint(e){Array.isArray(e)?this.constraint=e:this.constraint=[e],this._constraintFunc=(new a.Constraints).getConstraints(e)}setPlaceConstraint(e){const t=new a.Constraints("or");Array.isArray(e)?this.placeConstraint=e:this.placeConstraint=[e],this._placeConstraintFunc=t.getConstraints(e),this.placeConstraint.forEach(e=>{"danger"===e.prop&&r.default.err("BrainSpawner","setPlaceConstraint","danger not supported in place. "+JSON.stringify(e))})}decideNextAction(){return 0!==this.spawnLeft&&r.default.isSuccess(this.spawnProb)?()=>{const e=this.getActor().getLevel();let t=null;if(this.placeConstraint){const n=e.getMap().getFree().filter(e=>this._placeConstraintFunc(e));if(n.length>0)t=c.arrayGetRand(n);else{const e=JSON.stringify(this.placeConstraint);r.default.warn("BrainSpawner","decideNextAction","No cell found for constr "+e)}}else t=e.getFreeRandCell();if(t){const[n,s]=t.getXY(),a=i.ObjectShell.getParser().createRandomActor({func:this._constraintFunc});if(a)e.addActor(a,n,s)&&(--this.spawnLeft,this.emitSpawnMsg(a));else{const e=JSON.stringify(this.constraint);r.default.err("BrainSpawner","decideNextAction","No actor found for constr "+e)}}}:u}emitSpawnMsg(e){const t=e.getLevel(),n=e.getCell(),s=r.default.getCardinalDirection(t,n),a=`${e.getName()} appears from path coming from ${s}`;r.default.gameMsg({cell:n,msg:a})}toJSON(){const e={type:this.getType(),constraint:this.constraint,spawnProb:this.spawnProb,spawnLeft:this.spawnLeft};return this.placeConstraint&&(e.placeConstraint=this.placeConstraint),e}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BypassComp=t.adjustActorValues=t.Actors=t.ActorsData=void 0;const r=s(n(4)),a=n(73),o="GoalOriented",i=[],l="DarkSlateGray";function c(e){return{comp:"BypassProtection",func:{setChance:e}}}t.ActorsData=[{name:"animal",dontCreate:!0,type:"animal",className:"cell-actor-animal",attack:1,defense:1,hp:5,protection:0,range:1,danger:1,speed:100,brain:"Animal",enemies:r.default.ACTOR_RACES},{name:"chicken",char:"c",base:"animal",color:a.color("Red","White"),damage:"1d1",hp:1,noRandom:!0,enemies:i,ability:{addEntity:{entityName:"Chicken egg",endMsg:"Chicken lays an egg onto the ground!"}},inv:[{name:"Poultry",count:1}]},{name:"pig",char:"p",base:"animal",color:a.color("Pink","White"),damage:"1d1",hp:5,noRandom:!0,enemies:i,inv:[{name:"Pork",count:2}]},{name:"cow",char:"c",base:"animal",color:a.color("Brown","White"),damage:"1d2",hp:7,noRandom:!0,enemies:i,inv:[{name:"Beef",count:2}]},{name:"reindeer",char:"R",base:"animal",color:a.color("Brown","White"),damage:"1d2",hp:7,enemies:i,inv:[{name:"Reindeer meat",count:2}]},{name:"elk",char:"E",base:"animal",color:a.color("Brown","White"),damage:"1d6",hp:7,enemies:i,inv:[{name:"Elk meat",count:3}]},{name:"rat",char:"r",base:"animal"},{name:"cockroach",char:"c",base:"animal",color:a.color("red","black"),attack:15,damage:"1d1",speed:200,addComp:[c(1)]},{name:"cloud of insects",char:"i",base:"animal",color:a.color("Green","black"),damage:"1d1",defense:2,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1"}]},{name:"bat",char:"b",base:"animal",defense:2,addComp:"Flying"},{name:"giant ant",char:"a",base:"animal",defense:2,hp:7},{name:"badger",char:"c",base:"animal",attack:1,defense:4,damage:"1d4",hp:10,danger:2},{name:"coyote",char:"c",base:"animal",colorfg:"Yellow",attack:3,defense:3,damage:"1d4",hp:12,danger:2},{name:"lynx",char:"f",base:"animal",colorfg:"Orange",attack:5,defense:1,damage:"1d6",hp:12,danger:3},{name:"hawk",char:"H",base:"animal",attack:4,defense:1,damage:"1d5",hp:9,danger:3,addComp:"Flying"},{name:"cloud of horseflies",char:"i",base:"animal",color:a.color("Orange","black"),damage:"1d3",speed:115,defense:10,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1"}],danger:3},{name:"wolf",char:"w",base:"animal",attack:4,defense:2,damage:"1d6",hp:15,danger:3},{name:"rattlesnake",char:"s",base:"animal",attack:2,defense:3,damage:"1d3",hp:10,danger:3,poison:{duration:"1d6",damage:"1d10",prob:"0.1"}},{name:"cave spider",char:"S",base:"animal",attack:2,defense:4,damage:"1d5",hp:15,danger:4,poison:{duration:"3d6",damage:"1d4 + 1",prob:"0.15"}},{name:"woolly spider",char:"S",base:"animal",attack:4,defense:4,damage:"1d6 + 2",hp:20,danger:4,poison:{duration:"3d6",damage:"1d4 + 1",prob:"0.15"},onHit:[{addComp:"Paralysis",duration:"1"}]},{name:"wolverine",char:"W",base:"animal",attack:4,defense:4,damage:"1d7",hp:20,danger:4},{name:"auroch",char:"A",base:"animal",attack:2,defense:4,protection:5,damage:"1d7",hp:23,danger:4},{name:"eagle",char:"E",base:"animal",attack:4,defense:4,damage:"1d7",hp:20,danger:4,addComp:"Flying"},{name:"dire wolf",char:"w",base:"animal",colorfg:"Gray",attack:6,defense:2,damage:"1d8 + 2",hp:23,danger:5},{name:"giant spider",char:"S",base:"animal",colorfg:"Green",attack:6,defense:3,damage:"1d8 + 2",hp:17,danger:5,poison:{duration:"4d6",damage:"1d4 + 2",prob:"0.20"}},{name:"black vulture",char:"V",base:"animal",attack:5,defense:5,damage:"1d7",hp:25,danger:5,addComp:"Flying"},{name:"giant scorpion",char:"S",base:"animal",attack:5,defense:5,damage:"1d6 + 1",hp:19,danger:5,brain:"SpellCaster",spells:["ScorpionsTail"],maxPP:1,pp:1,poison:{duration:"4d6",damage:"1d4 + 2",prob:"0.20"}},{name:"bear",char:"B",base:"animal",attack:5,defense:5,damage:"1d9",hp:30,danger:5,inv:[{name:"Bear meat",count:3}]},{name:"mountain lion",char:"f",base:"animal",attack:6,defense:3,damage:"2d4",hp:25,danger:5},{name:"sabretooth tiger",char:"f",base:"animal",attack:8,defense:3,damage:"3d3",colorfg:"Red",hp:25,danger:5,speed:110},{name:"dire bear",char:"B",base:"animal",colorfg:"Gray",attack:8,defense:5,damage:"4d4",hp:40,danger:6,inv:[{name:"Bear meat",count:3}]},{name:"griffin",char:"G",base:"animal",attack:7,defense:7,damage:"3d3 + 3",hp:35,danger:7,addComp:"Flying",speed:130},{name:"polar bear",char:"B",base:"animal",color:a.color("blue","white"),attack:10,defense:5,protection:7,damage:"4d4 + 5",hp:50,danger:8,onHit:[{addComp:"Stun",duration:"1d2 + 1"}],addComp:[a.resistance("ICE","STRONG")],inv:[{name:"Bear meat",count:3}]},{name:"giant horsefly",char:"I",base:"animal",color:a.color("Orange","black"),attack:10,defense:15,damage:"3d3",hp:25,speed:110,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1"}],danger:8},{name:"mammoth",char:"M",base:"animal",attack:4,defense:4,protection:7,damage:"1d9",strength:30,hp:40,danger:8,addComp:[a.resistance("ICE","MEDIUM")]},{name:"dire mammoth",char:"M",base:"animal",attack:4,defense:4,protection:10,damage:"1d15",strength:35,hp:50,danger:9,colorfg:"Gray",addComp:[a.resistance("ICE","MEDIUM")]},{name:"polar bear king",char:"B",base:"animal",color:a.color("cyan","white"),attack:15,defense:7,damage:"5d5 + 5",hp:75,danger:10,onHit:[{addComp:"Stun",duration:"1d2 + 1"}],addComp:[a.resistance("ICE","IMMUNITY")]},{name:"thunderbird",char:"G",base:"animal",attack:7,defense:7,damage:"2d8",hp:45,danger:10,addComp:"Flying",brain:"SpellCaster",spells:["LightningArrow"],maxPP:30,pp:30},{name:"manticore",char:"M",base:"animal",attack:7,defense:7,damage:"2d10",hp:50,danger:10,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1d4 + 1"}]},{name:"forest wurm",char:"W",base:"animal",color:a.color("Green","Brown"),attack:12,defense:7,protection:15,damage:"3d10",hp:70,danger:10},{name:"spider queen",char:"S",base:"animal",color:a.color("Purple","Green"),attack:7,defense:7,protection:7,damage:"2d8 + 7",hp:45,danger:11,brain:"SpellCaster",spells:["SummonSpiders","ArrowOfWebs"],maxPP:40,pp:40,poison:{duration:"10d6",damage:"1d5 + 3",prob:"0.20"}},{name:"ancient manticore",char:"M",base:"animal",color:a.color("Gray","Brown"),attack:15,defense:10,protection:10,damage:"2d10 + 10",hp:75,danger:15,addComp:"Flying",onHit:[{addComp:"Paralysis",duration:"1d6 + 1"}],spells:["SummonKin"],maxPP:30,pp:30},{name:"BeastBase",type:"beast",dontCreate:!0,enemies:r.default.ACTOR_RACES},{name:"imp",base:"BeastBase",char:"I",color:a.color("Black","Red"),attack:3,defense:3,protection:3,damage:"1d7 + 2",hp:10,danger:3,brain:"SpellCaster",spells:["SlimeBolt"],addComp:["Flying"],maxPP:12,pp:12},{name:"chasm fiend",base:"BeastBase",char:"I",color:a.color("Black","OrangeRed"),attack:6,defense:3,protection:3,damage:"1d8 + 3",hp:20,danger:3,addComp:["Flying"]},{name:"cave dweller",base:"BeastBase",char:"C",color:a.color("Black","Red"),attack:5,defense:5,protection:5,damage:"1d10 + 2",hp:30,danger:5,brain:"SpellCaster",spells:["SlimeBolt"],maxPP:18,pp:18},{name:"cave lurker",base:"BeastBase",char:"C",color:a.color("Black","OrangeRed"),attack:8,defense:8,protection:5,damage:"2d10 + 2",hp:50,danger:9,brain:"SpellCaster",spells:["SlimeBolt"],maxPP:30,pp:30},{name:"hezrou",base:"BeastBase",char:"B",className:"cell-actor-poison",attack:5,defense:5,protection:3,hp:50,danger:11,damage:"4d4",addComp:[a.resistance("POISON","IMMUNITY")],brain:"SpellCaster",spells:["PoisonCloud"],maxPP:40,pp:40},{name:"ConstructBase",type:"construct",dontCreate:!0,enemies:r.default.ACTOR_RACES},{name:"fireroach",base:"ConstructBase",char:"c",className:"cell-actor-fire",attack:15,defense:1,damage:"1d2",speed:170,danger:1,hp:5,type:"construct",addComp:[c(.95)],onHit:[a.meleeHitDamage(1,"1d2","FIRE")]},{name:"water golem",base:"ConstructBase",char:"Y",className:"cell-actor-water",addComp:"Amphibious",attack:3,defense:6,protection:6,hp:25,danger:6,damage:"3d4",brain:"SpellCaster",spells:["WaterBolt"],maxPP:10,pp:10},{name:"earth golem",base:"ConstructBase",char:"Y",className:"cell-actor-earth",equip:[{name:"Large rock",count:6}],attack:6,defense:3,protection:8,hp:25,danger:7,damage:"3d4"},{name:"fire golem",base:"ConstructBase",color:a.color("Red","Black"),char:"Y",attack:7,defense:4,protection:4,hp:35,danger:8,damage:"4d4",addComp:[a.resistance("FIRE","MEDIUM")],brain:"SpellCaster",spells:["RingOfFire"],maxPP:20,pp:20},{name:"void golem",base:"ConstructBase",color:a.color("Purple","Black"),char:"Y",className:"cell-actor-void",attack:7,defense:7,protection:7,hp:30,danger:8,damage:"3d4+4",addComp:["SpellStop",a.resistance("MAGIC","IMMUNITY"),a.resistance("VOID","MEDIUM")]},{name:"water elemental",base:"ConstructBase",char:"E",className:"cell-actor-water",attack:5,defense:5,protection:3,hp:45,danger:10,damage:"4d4",addComp:"Amphibious",brain:"SpellCaster",spells:["WaterBolt"],maxPP:40,pp:40},{name:"air elemental",base:"ConstructBase",char:"E",className:"cell-actor-air",attack:5,defense:5,protection:3,hp:45,danger:10,damage:"4d4",addComp:"Flying",brain:"SpellCaster",spells:["LightningBolt"],maxPP:40,pp:40},{name:"earth elemental",base:"ConstructBase",char:"E",className:"cell-actor-earth",attack:6,defense:3,protection:12,hp:60,danger:12,damage:"4d4",brain:"SpellCaster",spells:["RockStorm"],equip:[{name:"Huge rock",count:6}],maxPP:70,pp:70},{name:"fire elemental",base:"ConstructBase",char:"E",className:"cell-actor-fire",attack:9,defense:6,protection:8,hp:55,danger:14,damage:"4d4",brain:"SpellCaster",spells:["FireBolt","RingOfFire"],addComp:[a.resistance("FIRE","IMMUNITY")],maxPP:60,pp:60},{name:"void elemental",base:"ConstructBase",color:a.color("Purple","Black"),char:"E",className:"cell-actor-void",attack:7,defense:7,protection:7,hp:70,danger:15,damage:"5d4",brain:"SpellCaster",spells:["PowerDrain"],addComp:["SpellStop",a.resistance("MAGIC","ABSORB"),a.resistance("VOID","IMMUNITY")],maxPP:70,pp:70},{name:"ancient void elemental",base:"ConstructBase",color:a.color("Purple","Black"),char:"E",className:"cell-actor-void",attack:20,defense:20,protection:20,hp:100,danger:25,damage:"7d4",brain:"SpellCaster",spells:["VoidBolt","PowerDrain"],addComp:["SpellStop",a.resistance("MAGIC","ABSORB"),a.resistance("VOID","IMMUNITY")],maxPP:100,pp:100},{name:"goblin",char:"g",type:"goblin",className:"cell-actor-goblin",attack:1,defense:1,damage:"1d6",range:1,hp:7,protection:1,danger:2,enemies:["human"],brain:o},{name:"goblin slinger",base:"goblin",attack:2,defense:1,hp:10,damage:"1d6",equip:[{name:"Rock",count:10}]},{name:"goblin fighter",base:"goblin",color:a.color("LightBlue",l),attack:2,defense:3,protection:1,hp:12,damage:"2d5",danger:2},{name:"goblin healer",base:"goblin",attack:2,defense:4,protection:2,hp:15,danger:3,damage:"1d6 + 2",brain:"SpellCaster",pp:18,maxPP:18,spells:["Heal"],color:a.color("Red","White")},{name:"goblin sergeant",base:"goblin",damage:"3d4+2",attack:4,defense:4,protection:2,hp:21,danger:4},{name:"goblin summoner",base:"goblin",attack:2,defense:4,protection:2,hp:25,maxPP:20,pp:20,damage:"1d8",brain:"SpellCaster",spells:["SummonAnimal"],danger:5},{name:"goblin lord",base:"goblin",attack:5,defense:4,protection:3,hp:30,danger:7,damage:"4d4",colorfg:"pink"},{name:"goblin king",base:"goblin",attack:7,defense:7,protection:3,hp:40,danger:10,damage:"4d4+6",brain:"SpellCaster",spells:["SummonKin"],colorfg:"red"},{name:"HyrmBase",char:"Y",type:"hyrm",color:a.color("Black","Purple"),dontCreate:!0,attack:1,defense:1,damage:"1d4",range:1,hp:10,danger:2,brain:o,enemies:r.default.ACTOR_RACES},{name:"hyrm warrior",base:"HyrmBase",attack:3,defense:3,damage:"2d6+2",hp:20,danger:3},{name:"hyrm catapulter",base:"HyrmBase",attack:3,defense:3,damage:"1d8",hp:25,danger:4,equip:[{name:"Large rock",count:4}]},{name:"hyrm runemage",base:"HyrmBase",color:a.color("Black","Pink"),attack:3,defense:3,damage:"1d8",hp:25,danger:5,brain:"SpellCaster",spells:["SummonKin","StunningTouch"],maxPP:20,pp:20},{name:"hyrm hulk",base:"HyrmBase",color:a.color("Black","Pink"),attack:6,defense:3,damage:"2d8",hp:40,strength:15,speed:90,danger:7},{name:"humanoid",char:"h",type:"humanoid",attack:1,defense:1,damage:"1d4",range:1,hp:10,danger:2,brain:o,enemies:r.default.ACTOR_RACES},{name:"dark warrior",char:"h",type:"humanoid",className:"cell-actor-void",attack:6,defense:4,protection:2,damage:"2d5 + 3",range:1,hp:25,enemies:r.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes"],maxPP:16,pp:16,danger:5},{name:"dark archer",char:"h",type:"humanoid",className:"cell-actor-void",attack:8,defense:3,protection:4,damage:"2d5",range:1,hp:30,enemies:r.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes"],maxPP:16,pp:16,danger:7,equip:["Iron bow",{name:"Steel arrow",count:8}],addComp:["LongRangeShot"]},{name:"dark assassin",char:"h",type:"humanoid",className:"cell-actor-void",attack:10,defense:5,protection:6,damage:"3d5 + 3",range:1,hp:50,enemies:r.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes"],maxPP:30,pp:30,danger:10,addComp:[a.resistance("POISON","IMMUNITY")],poison:{duration:"4d6",damage:"1d4 + 2",prob:"0.20"}},{name:"dark lord",char:"h",type:"humanoid",color:a.color("Yellow","Purple"),attack:12,defense:10,protection:8,damage:"4d5 + 5",range:1,hp:75,enemies:r.default.ACTOR_RACES,brain:"SpellCaster",spells:["SummonFlyingEyes","PoisonArrow"],maxPP:60,pp:60,danger:15,addComp:[a.resistance("POISON","IMMUNITY")],poison:{duration:"4d6",damage:"2d4 + 2",prob:"0.25"}},{name:"necromancer",char:"@",type:"humanoid",color:a.color("Black","Red"),attack:9,defense:9,protection:5,damage:"4d5 + 5",hp:45,enemies:r.default.ACTOR_RACES,brain:"SpellCaster",danger:10,pp:25,maxPP:25,addComp:[a.resistance("NECRO","STRONG"),a.resistance("ICE","MEDIUM")],spells:["AnimateDead"]},{name:"AvianFolkBase",char:"A",className:"cell-actor-avianfolk",type:"avianfolk",dontCreate:!0,enemies:["human","catfolk","dogfolk","wolfclan"],brain:o,addComp:"Flying",attack:2,defense:2,damage:"1d6",range:1,protection:1,hp:15,danger:2},{name:"avian townsfolk",base:"AvianFolkBase",danger:1,attack:1,defense:1,damage:"1d4",hp:10},{name:"avian scout",base:"AvianFolkBase",danger:2,attack:3,defense:3,damage:"2d4",hp:20,speed:110,fovrange:6},{name:"avian fighter",base:"AvianFolkBase",danger:4,attack:6,defense:7,damage:"3d4",hp:30,color:a.color("LightBlue",l)},{name:"avian arbalist",base:"AvianFolkBase",danger:5,attack:6,defense:7,damage:"3d4",hp:30,equip:["Wooden crossbow",{name:"Wooden bolt",count:10}]},{name:"avian duelist",base:"AvianFolkBase",danger:8,attack:7,defense:10,damage:"3d5",hp:40,addComp:["CounterAttack","Flying"]},{name:"avian judicator",base:"AvianFolkBase",danger:9,attack:7,defense:10,damage:"4d4",hp:45,addComp:["FirstStrike","Flying"]},{name:"avian archmage",base:"AvianFolkBase",danger:11,attack:5,defense:10,damage:"3d4",hp:45,brain:"SpellCaster",spells:["SummonAirElemental"],pp:40,maxPP:40,color:a.color("Purple",l)},{name:"avian emperor",base:"AvianFolkBase",danger:16,attack:8,defense:14,damage:"5d5",hp:85,addComp:["Flying",c(.15)],color:a.color("Purple",l)},{name:"BearfolkBase",char:"B",className:"cell-actor-bearfolk",dontCreate:!0,type:"bearfolk",attack:1,defense:1,damage:"1d5 + 1",range:1,hp:10,danger:1,enemies:["goblin","dwarf","undead","demon"],brain:o},{name:"bearfolk villager",base:"BearfolkBase",damage:"1d5 + 1",attack:1,defense:1,protection:1,hp:10,danger:1,color:a.color("Brown",l)},{name:"bearfolk thief",base:"BearfolkBase",color:a.color("Brown",l),damage:"1d7",brain:"Thief",attack:1,defense:1,danger:2,hp:12},{name:"bearfolk fighter",base:"BearfolkBase",damage:"1d8",color:a.color("LightBlue",l),attack:2,defense:2,danger:2,hp:15},{name:"bearfolk archer",base:"BearfolkBase",damage:"1d6",color:a.color("SpringGreen",l),attack:2,defense:2,danger:3,hp:13,equip:["Wooden bow",{name:"Wooden arrow",count:10}]},{name:"bearfolk mage",base:"BearfolkBase",damage:"1d6",color:a.color("Chartreuse",l),attack:2,defense:2,danger:4,hp:15,equip:["Robe","Wooden staff"],brain:"SpellCaster",spells:["SummonKin"],pp:20,maxPP:20},{name:"bearfolk magistrate",base:"BearfolkBase",damage:"1d10 + 2",color:a.color("Salmon",l),attack:4,defense:4,danger:5,hp:30,equip:["Leather armour"]},{name:"bearfolk elite",base:"BearfolkBase",damage:"3d6+2",color:a.color("Cyan",l),attack:5,defense:5,hp:37,danger:8,onHit:[{addComp:"Stun",duration:"1d4 + 1"}]},{name:"bearfolk king",base:"BearfolkBase",damage:"4d6+4",strength:16,color:a.color("Red",l),attack:7,defense:7,protection:5,danger:10,hp:75},{name:"UndeadBase",className:"cell-actor-undead",dontCreate:!0,addComp:"Undead",brain:"GoalOriented",attack:1,defense:1,protection:0,range:1,enemies:r.default.ACTOR_RACES,type:"undead"},{name:"skeletal dog",char:"d",base:"UndeadBase",damage:"1d6",danger:1,brain:"Animal",hp:6},{name:"skeletal spider",char:"S",base:"UndeadBase",attack:2,defense:1,damage:"1d4",danger:1,hp:5,brain:"Animal",poison:{duration:"2d10",damage:"1d2",prob:"0.2"}},{name:"necrocentipede",char:"w",base:"UndeadBase",attack:1,defense:1,damage:"1d7",danger:2,brain:"Animal",speed:125,hp:6},{name:"skeleton",char:"z",base:"UndeadBase",attack:2,defense:1,damage:"1d5",danger:1,hp:9},{name:"skeleton mauler",char:"z",base:"UndeadBase",attack:4,defense:0,damage:"2d5+4",danger:2,color:a.color("Red","Black"),hp:2},{name:"zombie",char:"z",base:"UndeadBase",color:a.color("Brown","Black"),attack:2,defense:2,damage:"1d6+2",danger:2,hp:12},{name:"skeleton archer",char:"z",base:"UndeadBase",color:a.color("Yellow","Black"),attack:4,defense:2,damage:"1d8",danger:4,hp:15,equip:["Wooden bow",{name:"Wooden arrow",count:5}]},{name:"skeleton warrior",char:"z",base:"UndeadBase",attack:3,defense:3,damage:"1d8 + 4",danger:4,color:a.color("LightBlue","Black"),hp:20},{name:"necrowurm",char:"W",base:"UndeadBase",attack:4,defense:4,damage:"1d10 + 5",danger:5,brain:"Animal",speed:115,hp:21},{name:"skeleton berserker",char:"z",base:"UndeadBase",color:a.color("Pink","Black"),attack:9,defense:1,damage:"2d8 + 4",danger:5,hp:10},{name:"ghoul",char:"z",base:"UndeadBase",color:a.color("LightGray","Black"),attack:3,defense:3,damage:"1d7 + 2",danger:5,hp:15,onHit:[{addComp:"Paralysis",duration:"1d4"}]},{name:"crypt zombie",char:"z",base:"UndeadBase",color:a.color("Cyan","Black"),attack:2,defense:2,protection:4,damage:"3d5",danger:6,hp:30},{name:"ghost",char:"G",base:"UndeadBase",attack:4,defense:4,damage:"2d5 + 2",danger:6,onHit:[{addComp:"StatsMods",func:[{setter:"setSpeed",value:-5}],duration:"3d10"}],hp:25},{name:"wraith",char:"Z",base:"UndeadBase",color:a.color("Cyan","Black"),attack:5,defense:5,damage:"2d5 + 2",danger:6,onHit:[{addComp:"StatsMods",func:[{setter:"setStrength",value:-1}],duration:"2d10"}],hp:25},{name:"specter",char:"Z",base:"UndeadBase",color:a.color("Blue","Black"),attack:6,defense:6,damage:"2d5 + 5",danger:7,onHit:[{addComp:"StatsMods",func:[{setter:"setMagic",value:-1}],duration:"10d10"}],hp:25,addComp:["Flying",a.resistance("ICE","STRONG")]},{name:"boneclaw",char:"B",base:"UndeadBase",attack:12,defense:4,damage:"2d7 + 2",danger:9,speed:100,onAttackHit:[{addComp:"DirectDamage",func:[{setter:"setDamage",value:2},{setter:"setDamageType",value:r.default.DMG.NECRO},{setter:"setDamageCateg",value:r.default.DMG.DIRECT}],duration:"1d8 + 2"}],hp:35},{name:"ghost lord",char:"G",base:"UndeadBase",colorfg:"Yellow",attack:7,defense:7,damage:"2d5 + 2",danger:8,onHit:[{addComp:"StatsMods",func:[{setter:"setSpeed",value:-7}],duration:"3d10"}],hp:35},{name:"skeleton king",char:"Z",base:"UndeadBase",color:a.color("Red","Black"),attack:6,defense:6,damage:"3d5 + 5",danger:9,hp:45,addComp:[a.resistance("PIERCE","STRONG"),a.resistance("SLASH","STRONG"),a.resistance("ICE","STRONG")]},{name:"vampire",char:"V",base:"UndeadBase",color:a.color("Purple","Black"),attack:6,defense:6,damage:"3d5 + 2",danger:9,strength:15,speed:120,onHit:[{addComp:"StatsMods",func:[{setter:"setStrength",value:-2}],duration:"5d10"}],hp:40},{name:"undead unicorn",char:"U",base:"UndeadBase",color:a.color("GhostWhite","Black"),attack:7,defense:7,protection:7,damage:"2d5 + 5",danger:9,speed:102,hp:50,addComp:[c(.25)]},{name:"necrowyrm",char:"W",base:"UndeadBase",color:a.color("GhostWhite","Black"),attack:7,defense:7,protection:7,damage:"3d5",danger:10,brain:"Animal",speed:107,hp:50,addComp:["Flying"]},{name:"ghost king",char:"G",base:"UndeadBase",color:a.color("Red","Black"),attack:12,defense:12,protection:10,damage:"4d5 + 5",danger:12,brain:"SpellCaster",onHit:[{addComp:"StatsMods",func:[{setter:"setSpeed",value:-12}],duration:"3d10"}],hp:50,addComp:[c(.2)]},{name:"lich",char:"L",base:"UndeadBase",attack:4,defense:8,protection:4,color:a.color("Brown","Black"),damage:"1d8 + 6",danger:12,hp:50,brain:"SpellCaster",spells:["GraspOfWinter","SummonDead"],maxPP:50,pp:50,addComp:[a.resistance("ICE","MEDIUM")]},{name:"lich king",char:"L",base:"UndeadBase",color:a.color("Red","Black"),attack:15,defense:15,protection:6,damage:"2d8 + 2",danger:17,hp:75,brain:"SpellCaster",spells:["SummonDead","AnimateDead"],maxPP:75,pp:75,onHit:[a.meleeHitDamage(4,"1d6","NECRO")],addComp:[a.resistance("ICE","MEDIUM"),a.resistance("POISON","IMMUNITY"),a.resistance("NECRO","IMMUNITY"),"Regeneration","RangedEvasion"]},{name:"ghost emperor",char:"G",base:"UndeadBase",color:a.color("Fuchsia","Black"),attack:20,defense:20,protection:10,damage:"5d5 + 5",danger:18,brain:"SpellCaster",onHit:[{addComp:"StatsMods",func:[{setter:"setSpeed",value:-20}],duration:"3d10"}],addComp:[a.resistance("ICE","MEDIUM"),a.resistance("NECRO","IMMUNITY"),"Regeneration","RangedEvasion",c(.5)],hp:75},{name:"lich emperor",char:"L",base:"UndeadBase",color:a.color("Fuchsia","Black"),attack:25,defense:25,protection:15,damage:"4d8 + 2",danger:20,hp:99,brain:"SpellCaster",spells:["SummonDead","AnimateDead","ShadowRay"],maxPP:120,pp:120,onHit:[a.meleeHitDamage(4,"2d6","NECRO"),{addComp:"Stun",duration:"1d4 + 1"}],addComp:[a.resistance("ICE","MEDIUM"),a.resistance("POISON","IMMUNITY"),a.resistance("NECRO","IMMUNITY"),"Regeneration","RangedEvasion"]},{name:"WinterBeingBase",dontCreate:!0,enemies:r.default.ACTOR_RACES,color:a.color("Blue","White"),addComp:["SnowWalk",a.resistance("ICE","MEDIUM")]},{name:"Crevasse worm",char:"w",base:"WinterBeingBase",attack:1,defense:1,damage:"1d4",speed:110,danger:1,hp:5,type:"animal"},{name:"frostroach",char:"c",base:"WinterBeingBase",attack:15,defense:1,damage:"1d2",speed:170,danger:1,hp:5,type:"animal",addComp:[c(.95)],onHit:[a.meleeHitDamage(1,"1d2","COLD")]},{name:"ice bat",char:"b",base:"WinterBeingBase",attack:1,defense:1,damage:"1d6",speed:110,danger:2,hp:8,brain:"Animal",addComp:["Flying",a.resistance("ICE","MEDIUM")],type:"animal"},{name:"arctic fox",char:"f",base:"WinterBeingBase",attack:4,defense:1,damage:"1d7 + 3",speed:105,danger:3,hp:12,brain:"Animal",type:"animal"},{name:"frost goblin",char:"g",base:"WinterBeingBase",attack:3,defense:3,protection:1,damage:"1d7",hp:12,danger:3,type:"icebeing",brain:o},{name:"frost viper",char:"s",base:"WinterBeingBase",attack:3,defense:3,protection:3,damage:"1d7",hp:18,danger:4,type:"animal",poison:{duration:"1d6 + 5",damage:"1d6",prob:"0.1"}},{name:"arctic Wolf",char:"w",base:"WinterBeingBase",attack:4,defense:2,damage:"1d8",brain:"Animal",hp:21,danger:5,type:"animal"},{name:"glacial shaman",char:"@",base:"WinterBeingBase",colorfg:"CadetBlue",attack:4,defense:4,protection:3,damage:"1d7 + 2",type:"icebeing",danger:5,hp:25,spells:["IcyPrison"],maxPP:22,pp:21,brain:"SpellCaster"},{name:"glacial golem",char:"G",base:"WinterBeingBase",attack:4,defense:4,protection:3,damage:"2d4",speed:90,danger:5,hp:30,type:"construct"},{name:"ice minion",base:"WinterBeingBase",char:"m",attack:4,defense:4,protection:2,damage:"2d4",hp:20,danger:5,type:"demon",onHit:[{addComp:"Coldness",duration:"10d10"}]},{name:"mighty raven",base:"WinterBeingBase",char:"R",attack:4,defense:10,damage:"2d4 + 2",range:1,hp:20,danger:5,brain:"Animal",addComp:["Flying",a.resistance("ICE","MEDIUM")]},{name:"snow leopard",base:"WinterBeingBase",char:"f",attack:8,defense:4,damage:"1d6 + 5",range:1,hp:25,danger:5,brain:"Animal",type:"animal",speed:120},{name:"cryomancer",base:"WinterBeingBase",char:"@",type:"icebeing",attack:4,defense:4,damage:"1d6",range:1,hp:30,danger:5,spells:["FrostBolt"],maxPP:22,pp:21,brain:"SpellCaster"},{name:"winter demon",type:"demon",char:"&",colorfg:"CadetBlue",attack:5,defense:5,protection:2,damage:"3d3",range:1,hp:30,danger:10,brain:"GoalOriented",base:"WinterBeingBase"},{name:"harbinger of winter",type:"demon",char:"@",colorfg:"DarkBlue",attack:5,defense:5,protection:2,damage:"3d3",range:1,hp:35,danger:10,brain:"SpellCaster",base:"WinterBeingBase",spells:["GraspOfWinter"],maxPP:30,pp:30},{name:"stormrider",type:"demon",char:"&",colorfg:"DarkBlue",attack:6,defense:6,protection:3,damage:"4d3",range:1,hp:40,danger:12,brain:"GoalOriented",base:"WinterBeingBase",equip:["Permaice short sword"]},{name:"ice archon",type:"demon",char:"A",attack:6,defense:6,protection:3,damage:"4d3",range:1,hp:40,danger:12,base:"WinterBeingBase",brain:"SpellCaster",pp:30,maxPP:30,spells:["RingOfFrost"]},{name:"ice djinn",type:"demon",char:"&",attack:7,defense:6,protection:6,damage:"3d5+5",range:1,hp:45,danger:14,brain:"GoalOriented",base:"WinterBeingBase"},{name:"blizzard beast",type:"demon",char:"B",colorfg:"CadetBlue",attack:7,defense:6,protection:8,damage:"3d5+5",range:1,hp:50,danger:16,brain:"GoalOriented",base:"WinterBeingBase"},{name:"ice behemoth",type:"demon",char:"B",colorfg:"DarkBlue",attack:10,defense:3,protection:8,damage:"4d5+5",range:2,hp:65,danger:16,brain:"GoalOriented",base:"WinterBeingBase",onHit:[{addComp:"Coldness"}]},{name:"frost Titan",type:"giant",char:"H",attack:8,defense:7,protection:12,damage:"5d5",range:1,hp:80,danger:18,brain:"GoalOriented",base:"WinterBeingBase",onHit:[{addComp:"Stun",duration:"1d8"}]},{name:"frostburn monarch",type:"demon",char:"M",attack:10,defense:10,protection:10,damage:"4d5",range:1,hp:70,danger:20,brain:"SpellCaster",base:"WinterBeingBase",onHit:[{addComp:"Coldness"}],spells:["FrostBolt","SummonIceMinion"],pp:50,maxPP:50},{name:"dwarf",char:"h",type:"dwarf",className:"cell-actor-dwarf",attack:2,defense:2,protection:1,damage:"1d4",range:1,hp:20,danger:3,enemies:["human","undead","demon"],brain:o},{name:"dwarven fighter",base:"dwarf",attack:4,defense:4,protection:2,damage:"1d7",range:1,hp:30,danger:4,color:a.color("LightBlue",l),equip:["Spear"]},{name:"dwarven axeman",base:"dwarf",attack:4,defense:4,protection:3,damage:"1d8",range:1,hp:40,danger:5,color:a.color("DarkMagenta","GoldenRod"),equip:["Battle axe","Chain armour"]},{name:"dwarven priest",base:"dwarf",attack:7,defense:3,damage:"1d8",range:1,hp:40,danger:7,brain:"SpellCaster",spells:["Heal"],color:a.color("Chartreuse",l),pp:50,maxPP:50},{name:"dwarven hammerer",base:"dwarf",attack:4,defense:6,protection:4,damage:"1d10",range:1,hp:45,danger:6,equip:["Dwarven pick-axe","Leather armour"]},{name:"dwarven bolter",base:"dwarf",attack:7,defense:3,damage:"1d8",range:1,hp:40,danger:7,fovrange:7,color:a.color("DarkBlue","GoldenRod"),equip:["Steel crossbow",{name:"Steel bolt",count:7}]},{name:"dwarven rifleman",base:"dwarf",attack:4,defense:4,damage:"1d8",range:1,hp:40,danger:8,fovrange:7,equip:["Rifle",{name:"Steel bullet",count:10}],color:a.color("SpringGreen",l)},{name:"dwarven elite",base:"dwarf",attack:5,defense:6,damage:"3d5 + 3",range:1,hp:50,danger:9,color:a.color("Cyan","Black"),equip:["Steel armour"]},{name:"dwarven commander",base:"dwarf",attack:8,defense:8,protection:7,damage:"2d5",range:1,hp:60,danger:10,color:a.color("Orange",l),equip:["Great battle axe","Steel armour"]},{name:"dwarven king",base:"dwarf",color:a.color("Red","Black"),attack:12,defense:12,protection:10,damage:"4d5 + 5",range:1,hp:75,danger:15,equip:["Mithril armour"]},{name:"human",char:"@",type:"human",className:"cell-actor-human",attack:2,defense:2,damage:"1d4",range:1,hp:20,danger:3,brain:o},{name:"townsfolk",base:"human",attack:1,defense:1,damage:"1d4",range:1,hp:10,danger:1},{name:"robber",base:"human",attack:2,defense:4,danger:3,enemies:["player"]},{name:"miner",base:"human",attack:4,danger:4,damage:"1d5",equip:["Pick-axe"]},{name:"fighter",base:"human",hp:25,attack:4,defense:4,damage:"1d8",color:a.color("LightBlue",l),danger:5},{name:"treasure hunter",base:"human",hp:25,attack:4,defense:4,damage:"1d8",danger:5,goals:[{name:"TreasureHunter",bias:.9}]},{name:"warlord",char:"W",base:"human",hp:35,attack:5,defense:6,damage:"3d3",danger:6},{name:"trainer",char:"@",base:"human",hp:50,attack:10,defense:10,protection:5,damage:"3d3",className:"cell-actor-trainer",noRandom:!0,danger:6,inv:[{name:"Gold coin",count:50}],addComp:"Trainer"},{name:"shopkeeper",char:"@",base:"human",hp:50,attack:10,defense:10,protection:5,damage:"3d3",className:"cell-actor-shopkeeper",noRandom:!0,danger:6,inv:[{name:"Gold coin",count:100}]},{name:"summoner",char:"@",base:"human",hp:50,attack:7,defense:7,protection:3,damage:"2d4",brain:"SpellCaster",spells:["SummonKin"],maxPP:30,pp:30,danger:10},{name:"traveller",char:"t",base:"human",hp:35,attack:5,defense:6,damage:"3d3",danger:6,brain:"NeedDriven",addComp:["Hunger"]},{name:"wildling",char:"I",className:"cell-actor-wildling",type:"wildling",brain:o,attack:2,defense:1,damage:"1d6",range:1,hp:15,danger:3,enemies:["human"]},{name:"wildling tribefolk",base:"wildling",attack:2,defense:1,damage:"1d6",hp:10,danger:1,color:a.color("Brown",l)},{name:"wildling hunter",base:"wildling",attack:3,defense:3,damage:"1d6 + 2",hp:20,danger:3,equip:["Tomahawk"],color:a.color("LightBlue",l)},{name:"wildling archer",base:"wildling",attack:3,defense:3,damage:"1d6 + 2",hp:20,danger:4,equip:["Wooden bow",{name:"Wooden arrow",count:10}],color:a.color("SpringGreen",l),brain:o},{name:"wildling fighter",base:"wildling",attack:4,defense:3,damage:"1d9 + 3",hp:25,danger:5,color:a.color("LightBlue",l)},{name:"wildling elite",base:"wildling",attack:5,defense:3,damage:"1d10 + 4",hp:32,danger:6,color:a.color("Cyan",l)},{name:"wildling warlord",base:"wildling",attack:6,defense:3,damage:"1d12 + 5",hp:40,danger:7,color:a.color("Black",l)},{name:"wildling king",base:"wildling",attack:8,defense:5,damage:"1d15 + 6",hp:50,danger:10,color:a.color("Red",l)},{name:"CatfolkBase",char:"f",className:"cell-actor-catfolk",type:"catfolk",dontCreate:!0,attack:1,defense:1,protection:1,damage:"1d6",range:1,hp:10,danger:1,enemies:["human","dogfolk","wolfclan"],brain:o},{name:"catfolk townsfolk",base:"CatfolkBase",attack:1,defense:1,hp:10,danger:1,color:a.color("Brown",l)},{name:"catfolk hunter",base:"CatfolkBase",attack:1,defense:4,damage:"3d2",hp:15,danger:2,color:a.color("LightBlue",l)},{name:"catfolk darter",base:"CatfolkBase",attack:1,defense:4,damage:"3d2",hp:15,danger:3,brain:o,equip:[{name:"Iron dart",count:9}],color:a.color("SpringGreen",l)},{name:"catfolk warrior",base:"CatfolkBase",attack:2,defense:5,damage:"4d2",hp:20,danger:4,color:a.color("Blue",l)},{name:"catfolk elite",base:"CatfolkBase",attack:3,defense:7,damage:"5d2",hp:27,danger:5,color:a.color("Cyan",l),addComp:"CounterAttack"},{name:"catfolk wizard",base:"CatfolkBase",attack:3,defense:6,damage:"4d2",hp:25,danger:6,brain:"SpellCaster",color:a.color("Chartreuse",l),spells:["EnergyArrow"],maxPP:20,pp:20},{name:"catfolk warlord",base:"CatfolkBase",attack:4,defense:8,damage:"6d2",hp:35,danger:7,color:a.color("Black",l)},{name:"catfolk queen",base:"CatfolkBase",attack:6,defense:15,damage:"7d3",hp:45,danger:10,addComp:"FirstStrike",color:a.color("Yellow",l)},{name:"catfolk king",base:"CatfolkBase",attack:10,defense:12,protection:6,damage:"7d3 + 5",hp:60,danger:13,color:a.color("Red",l)},{name:"WolfclanBase",dontCreate:!0,danger:1,attack:1,defense:1,damage:"1d4",range:1,protection:2,className:"cell-actor-wolfclan",char:"w",type:"wolfclan",enemies:["human","catfolk","dogfolk","bearfolk"],brain:o},{name:"wolfclan folk",base:"WolfclanBase",danger:1,hp:12,attack:2,defense:1,damage:"1d6",range:1,color:a.color("Brown",l)},{name:"wolfclan brave",base:"WolfclanBase",danger:4,attack:4,defense:3,damage:"2d4",hp:25,color:a.color("LightBlue",l)},{name:"wolfclan skirmisher",base:"WolfclanBase",danger:5,attack:5,defense:4,damage:"2d4+3",hp:30,color:a.color("SteelBlue",l)},{name:"wolfclan scourger",base:"WolfclanBase",danger:6,attack:7,defense:5,damage:"2d4+7",hp:35,color:a.color("Blue",l)},{name:"wolfclan mage",base:"WolfclanBase",danger:7,attack:7,defense:5,damage:"2d4+7",hp:35,spells:["PowerDrain"],maxPP:30,pp:30,brain:"SpellCaster",color:a.color("Chartreuse",l)},{name:"wolfclan elite",base:"WolfclanBase",danger:8,attack:8,defense:5,protection:5,damage:"2d4+10",hp:50,addComp:"CounterAttack",color:a.color("Cyan",l)},{name:"wolfclan judicator",base:"WolfclanBase",danger:9,attack:8,defense:8,damage:"3d4+6",hp:55,addComp:"FirstStrike",color:a.color("Black",l)},{name:"wolfclan commander",base:"WolfclanBase",danger:10,attack:10,defense:5,damage:"4d4+10",hp:60,color:a.color("orange",l)},{name:"wolfclan king",base:"WolfclanBase",danger:14,attack:10,defense:10,damage:"5d4+10",hp:75,color:a.color("Red",l)},{name:"DogfolkBase",dontCreate:!0,className:"cell-actor-dogfolk",char:"d",type:"dogfolk",protection:1,enemies:["catfolk","wolfclan"],brain:o},{name:"dogfolk gatherer",base:"DogfolkBase",attack:1,defense:3,damage:"1d4 + 1",hp:10,danger:1,color:a.color("Brown",l)},{name:"dogfolk hunter",base:"DogfolkBase",color:a.color("LightBlue",l),attack:2,defense:3,damage:"6d1",hp:15,danger:2},{name:"dogfolk thrower",base:"DogfolkBase",attack:2,defense:3,damage:"6d1+1",hp:15,danger:3,equip:[{name:"Throwing axe",count:7}],color:a.color("SpringGreen",l)},{name:"dogfolk warrior",base:"DogfolkBase",danger:4,attack:3,defense:3,damage:"7d1+3",hp:20,color:a.color("Blue",l)},{name:"dogfolk skirmisher",base:"DogfolkBase",danger:5,attack:4,defense:3,damage:"9d1+3",hp:25},{name:"dogfolk spellsinger",base:"DogfolkBase",danger:8,attack:6,defense:6,damage:"10d2+4",hp:40,spells:["SummonKin","RingOfEnergy"],maxPP:30,pp:30,brain:"SpellCaster",color:a.color("Chartreuse",l)},{name:"dogfolk elite",base:"DogfolkBase",danger:8,attack:6,defense:6,damage:"8d2+4",hp:50,addComp:"CounterAttack",color:a.color("Cyan",l)},{name:"dogfolk commander",base:"DogfolkBase",danger:10,attack:8,defense:8,damage:"8d3+4",hp:65,color:a.color("orange",l)},{name:"dogfolk king",base:"DogfolkBase",danger:13,colorfg:"red",colorbg:"white",attack:12,defense:8,damage:"8d3+8",hp:75,color:a.color("red",l)},{name:"SpiritBase",char:"Q",className:"cell-actor-spirit",type:"spirit",dontCreate:!0,addComp:["Ethereal"],brain:"Spirit"},{name:"Rat spirit",base:"SpiritBase",strength:0,accuracy:0,agility:1,willpower:0,power:1,danger:1},{name:"Wolf spirit",base:"SpiritBase",strength:1,accuracy:0,agility:1,willpower:0,power:2,danger:2},{name:"Bear spirit",base:"SpiritBase",strength:2,accuracy:0,agility:1,willpower:0,power:3,danger:3},{name:"Fighter spirit",base:"SpiritBase",strength:2,accuracy:2,agility:1,willpower:0,power:4,color:a.color("LightBlue",l),danger:4},{name:"Shaman spirit",base:"SpiritBase",strength:0,accuracy:0,agility:0,willpower:6,power:5,danger:5},{name:"Winter demon spirit",base:"SpiritBase",strength:3,accuracy:3,agility:3,willpower:3,power:7,danger:7},{name:"Monarch spirit",base:"SpiritBase",strength:6,accuracy:0,agility:1,willpower:6,power:10,danger:12},{name:"HyrkhianBase",dontCreate:!0,className:"cell-actor-hyrkh",char:"y",enemies:["undead","demon","beast","animal"],damage:"1d6",type:"hyrkhian",brain:o},{name:"Hyrkhian townsfolk",base:"HyrkhianBase",damage:"1d6",attack:1,defense:1,protection:1,hp:7,danger:1,color:a.color("Brown",l)},{name:"Hyrkhian footman",base:"HyrkhianBase",attack:2,defense:2,protection:2,hp:15,danger:3,equip:["Longsword"],color:a.color("LightBlue",l)},{name:"Hyrkhian phalanx",base:"HyrkhianBase",attack:4,defense:4,protection:2,hp:25,danger:5,equip:["Chain armour","Spear"],color:a.color("Blue",l)},{name:"Hyrkhian archer",base:"HyrkhianBase",color:a.color("SpringGreen",l),attack:4,defense:4,protection:2,damage:"1d8",hp:20,equip:["Steel bow",{name:"Steel arrow",count:15}],danger:6},{name:"Hyrkhian adept",base:"HyrkhianBase",attack:4,defense:4,protection:2,hp:25,danger:7,maxPP:30,pp:30,brain:"SpellCaster",spells:["Heal","MagicArmor"],color:a.color("Chartreuse",l)},{name:"Hyrkhian elite",base:"HyrkhianBase",attack:6,defense:6,protection:3,hp:35,brain:o,strength:13,equip:["Mithril short sword","Chain armour","Chain helmet"],danger:8,color:a.color("Cyan",l)},{name:"Hyrkhian commander",base:"HyrkhianBase",attack:8,defense:8,protection:4,hp:50,brain:o,strength:15,equip:["Great battle axe","Steel armour","Steel helmet"],danger:10,color:a.color("Orange",l)},{name:"SpecialBase",noRandom:!0,actorType:"BaseActor",dontCreate:!0},{name:"Fire",className:"cell-actor-fire",base:"SpecialBase",char:"โ",type:"flame",brain:"Flame",addComp:["Ethereal","NonSentient",{comp:"Damaging",func:{setDamageType:r.default.DMG.FIRE}}]},{name:"Ice flame",className:"cell-actor-winter",base:"SpecialBase",char:"โ",type:"flame",brain:"Flame",addComp:["Ethereal","NonSentient",{comp:"Damaging",func:{setDamageType:r.default.DMG.ICE}}],onHit:[{addComp:"Coldness",duration:"10d10"}]},{name:"Ice wave",className:"cell-actor-winter",base:"SpecialBase",char:";",type:"wave",brain:"Wave",addComp:["Ethereal","NonSentient","Stats",{comp:"Damaging",func:{setDamageType:r.default.DMG.ICE}}],onHit:[{addComp:"Coldness",duration:"10d10"}]},{name:"Death wave",className:"cell-actor-undead",base:"SpecialBase",char:";",type:"wave",brain:"Wave",addComp:["Ethereal","NonSentient","Stats",{comp:"Damaging",func:{setDamageType:r.default.DMG.NECRO}}]},{name:"Poison gas",className:"cell-actor-poison",base:"SpecialBase",char:"โ",type:"flame",brain:"Cloud",color:a.color("Green","Gray"),addComp:["Ethereal","NonSentient",{comp:"Damaging",func:{setDamageType:r.default.DMG.POISON}}],poison:{duration:"1d10",damage:"1d10",prob:"0.1"}},{name:"Forcefield",className:"cell-actor-forcefield",base:"SpecialBase",char:"โ",type:"forcefield",brain:"NonSentient",speed:1,hp:25,defense:0,addComp:["Health","NonSentient","Combat","SpellStop","Breakable",{comp:"Weakness",func:{setEffect:r.default.DMG.MAGIC,setLevel:r.default.WEAKNESS.FATAL}}]},{name:"flying eye",className:"cell-actor-void",base:"SpecialBase",char:"e",type:"eye",addComp:["Ethereal"],brain:"Explorer",hp:1,speed:130,fovrange:3,actorType:"Sentient"},{name:"UniqueBase",dontCreate:!0,className:"cell-actor-unique",noRandom:!0,unique:!0,addComp:["Regeneration"],color:a.color("DarkViolet","Beige")},{name:"Thabba, Son of Ice",base:"UniqueBase",char:"@",danger:200,enemies:["human"],type:"finalboss",spells:["FrostBolt","RingOfFrost"],hp:266,pp:100,brain:"SpellCaster",damage:"4d5",strength:30,accuracy:15,agility:20,willpower:20,perception:15,magic:30,attack:30,defense:30,protection:10,equip:["Permaice katana","Permaice armour"],addComp:["SnowWalk",a.resistance("ICE","STRONG"),"Regeneration"]},{name:"Zamoned, Son of Frost",base:"UniqueBase",char:"@",danger:200,enemies:["human"],type:"finalboss",hp:200,pp:100,brain:o,strength:20,accuracy:25,agility:35,willpower:15,perception:25,magic:10,attack:30,defense:30,protection:10,damage:"4d5",equip:["Permaice axe","Permaice armour","Bow of Defense",{name:"Runed arrow",count:100}],addComp:["SnowWalk",a.resistance("ICE","STRONG"),"Regeneration"]},{name:"Hag of North",type:"wolfclan",base:"UniqueBase",char:"w",danger:100,damage:"4d4+5",hp:75,pp:50,brain:"SpellCaster",spells:["IcyPrison","FrostBolt"],strength:15,accuracy:15,agility:15,willpower:30,perception:25,magic:25,attack:15,defense:15,protection:5,equip:["Ruby glass armour","Ruby glass collar"],addComp:["SnowWalk",a.resistance("ICE","STRONG"),"Regeneration"]},{name:"Aime Aeon en Nev, Mighty spellsinger",type:"dogfolk",base:"UniqueBase",char:"d",danger:100,damage:"5d5 + 5",hp:100,pp:75,brain:"SpellCaster",spells:["Paralysis","Flying","Heal","LightningArrow"],strength:18,accuracy:19,agility:18,willpower:28,perception:15,magic:25,attack:20,defense:15,protection:5,equip:["Runed armour","Runed collar"],onHit:[{addComp:"Stun",duration:"1d4 + 1"}],addComp:["Regeneration"]},{name:"Aspelin Primoen, the Blacksmith",type:"dogfolk",base:"UniqueBase",char:"d",danger:75,damage:"3d7 + 3",hp:134,brain:o,strength:25,accuracy:20,agility:19,willpower:15,perception:19,magic:13,attack:25,defense:15,protection:10,equip:["Hammer of Void","Mithril armour"]},{name:"Elene Immolate Kinin, Queen of cats",type:"catfolk",base:"UniqueBase",char:"f",danger:100,damage:"10d3 + 3",hp:123,pp:50,brain:"SpellCaster",spells:["ScorpionsTail","EnergyArrow","SummonKin"],strength:15,accuracy:25,agility:25,willpower:17,perception:25,magic:17,attack:25,defense:15,protection:5,equip:["Steel armour","Runed collar"],addComp:["FirstStrike","RangedEvasion","Regeneration"]},{name:"Tajun Eon en Lotus, lich lord",type:"undead",base:"UniqueBase",char:"L",danger:85,color:{fg:"Red",bg:"Black"},enemies:r.default.ACTOR_RACES,damage:"2d9 + 4",hp:90,pp:100,maxPP:100,brain:"SpellCaster",strength:14,accuracy:15,agility:14,willpower:25,perception:19,magic:30,attack:25,defense:15,protection:10,equip:["Runed robe"],onHit:[a.meleeHitDamage(4,"2d8 + 2","NECRO")],spells:["SummonDead","FrostBolt","GraspOfWinter"],addComp:["Regeneration"]},{name:"Zargoth, undead sorcerer",type:"undead",base:"UniqueBase",char:"Z",danger:75,color:{fg:"DarkSalmon",bg:"Black"},enemies:r.default.ACTOR_RACES,damage:"2d9 + 4",hp:100,pp:75,maxPP:75,brain:"SpellCaster",strength:17,accuracy:20,agility:17,willpower:21,perception:19,magic:25,attack:25,defense:15,protection:10,fovrange:7,onHit:[a.meleeHitDamage(2,"1d8 + 2","NECRO")],spells:["SummonUndeadUnicorns","ShadowRay"],addComp:["Regeneration"]},{name:"Emption Agana Sunkist, Emperor bear",type:"bearfolk",base:"UniqueBase",char:"B",danger:75,color:a.color("Fuchsia","LightGreen"),damage:"4d7 + 3",hp:123,brain:o,strength:35,accuracy:17,agility:17,willpower:17,perception:17,magic:10,attack:35,defense:35,protection:15,equip:["Mithril armour","Mithril shield"],onHit:[a.meleeHitDamage(8,"1d2","LIGHTNING"),{addComp:"Stun",duration:"1d4 + 1"}],addComp:["Regeneration"]},{name:"Dvaling, dwarven sharpshooter",type:"dwarf",base:"UniqueBase",char:"h",danger:70,damage:"4d7 + 3",hp:123,brain:o,strength:35,accuracy:17,agility:17,willpower:17,perception:30,magic:10,attack:35,defense:35,protection:5,fovrange:9,equip:["Mithril armour","Mithril helmet","Mithril boots","Double crossbow",{name:"Void bolt",count:30}],addComp:["EagleEye","RangedEvasion","StrongShot","Regeneration"]},{name:"Sierra Lilith Hupoith Zoic, the arcavian",type:"avianfolk",base:"UniqueBase",char:"A",danger:77,damage:"4d7 + 3",hp:123,brain:o,strength:20,accuracy:21,agility:21,willpower:40,perception:23,magic:22,attack:25,defense:25,protection:7,fovrange:7,equip:["Ruby glass armour","Mithril helmet","Mithril shield"],addComp:["Flying","Regeneration","RangedEvasion"]},{name:"Elsa, the frozen queen",type:"human",color:a.color("White","DarkBlue"),base:"UniqueBase",char:"E",danger:80,damage:"3d7 + 3",hp:133,pp:78,brain:"SpellCaster",strength:17,accuracy:35,agility:15,willpower:30,perception:10,magic:22,attack:35,defense:35,protection:15,fovrange:5,enemies:r.default.ACTOR_RACES,addComp:["SnowWalk",a.resistance("ICE","IMMUNITY"),"Regeneration"],onHit:[a.meleeHitDamage(5,"1d8 + 4","ICE")],spells:["FrostBolt","GraspOfWinter"]},{name:"Horgth, the hyrkhian emperor",type:"hyrkhian",base:"UniqueBase",char:"H",danger:80,color:a.color("Purple","Black"),damage:"5d6 + 6",hp:133,brain:o,strength:30,accuracy:35,agility:15,willpower:15,perception:15,attack:55,defense:45,protection:20,fovrange:5,enemies:r.default.ACTOR_RACES,addComp:["SnowWalk",a.resistance("ICE","IMMUNITY"),"Regeneration"],onHit:[a.meleeHitDamage(5,"1d4 + 4","ICE"),{addComp:"Stun",duration:"1d2 + 1"}]},{name:"Morkoe, the ancient frost bogey",type:"creature",base:"UniqueBase",char:"B",danger:100,damage:"3d7 + 3",hp:167,pp:100,brain:"SpellCaster",strength:25,accuracy:25,agility:5,willpower:30,perception:10,magic:10,attack:35,defense:35,protection:25,fovrange:5,speed:90,enemies:r.default.ACTOR_RACES,addComp:["SnowWalk",a.resistance("ICE","IMMUNITY"),a.resistance("NECRO","STRONG"),a.resistance("VOID","STRONG"),"Regeneration"],onHit:[a.meleeHitDamage(5,"1d8 + 4","ICE")],spells:["FrostBolt","GraspOfWinter"]},{name:"Inferno Maelstrom, beingless being",type:"creature",base:"UniqueBase",char:"I",danger:666,damage:"16d6 + 6",hp:666,pp:666,brain:"SpellCaster",strength:128,accuracy:128,agility:128,willpower:128,perception:128,magic:128,attack:128,defense:64,protection:64,fovrange:12,speed:150,enemies:["animal"].concat(r.default.ACTOR_RACES),addComp:["SnowWalk",a.resistance("ICE","ABSORB"),a.resistance("NECRO","IMMUNITY"),a.resistance("VOID","IMMUNITY"),a.resistance("POISON","IMMUNITY"),"Regeneration"],onHit:[a.meleeHitDamage(5,"2d8 + 8","ICE")],spells:["FrostBolt","GraspOfWinter","Blizzard","IceArrow","RingOfFrost"]}],t.Actors={},t.Actors.scaleValue=function(e,t,n){e.forEach(e=>{Number.isInteger(e[t])&&(e[t]=Math.round(n*e[t]))})},t.Actors.addValue=function(e,t,n){e.forEach(e=>{Number.isInteger(e[t])&&(e[t]+=n)})},t.Actors.scale={attack:2,danger:1,hp:1.5},t.Actors.add={attack:4},t.Actors.modToFunc={scale:"scaleValue",add:"addValue"},t.Actors.modOrder=["scale","add"],t.adjustActorValues=(e,n=t.Actors.modOrder)=>{n.forEach(n=>{const s=t.Actors.modToFunc[n];Object.keys(t.Actors[n]).forEach(r=>{t.Actors[s](e,r,t.Actors[n][r])})})},t.BypassComp=c},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SpellBase=t.SpellBook=t.Spell=void 0;const i=o(n(4)),l=n(25),c=a(n(11)),u=n(9),h=n(26),d=n(12),p=n(27),f=n(13),m=n(19),g=n(54),y=u.Random.getRNG(),{KeyMap:v}=l.Keys,b=c.create;t.Spell={traceIDs:{}},t.Spell.addDebugTraceID=e=>{t.Spell.traceIDs[e]=!0};t.Spell.addPoisonEffect=(e,t)=>{const n=t.get("Experience").getExpLevel(),s=new h.Dice(1,n,Math.ceil(n/2));let r=.07*n;r>=.5&&(r=.5);const a=new h.Dice(2,n+5,Math.ceil(n/2)).roll();_(e,t,a,s,r)};const _=(e,t,n,s,r)=>{const a=new c.Poison;a.setDamageDie(s);const o=new c.Expiration;o.addEffect(a,n),a.setSource(t),a.setProb(r),e.add(a),e.add(o)},E=(e,t,n)=>{const s=n.getCaster();s.getLevel().addActor(e,t.getX(),t.getY());const r=new c.Fading,a=n.getDuration();r.setDuration(a),e.add(r);const o=new c.Created;o.setCreator(s),e.add(o)};t.Spell.addFadingActorToCell=E;const S=(e,t,n)=>{const s=[t.getX()-e.getX(),t.getY()-e.getY()];n(e,{dir:s,src:e})};t.Spell.aiSpellCellDone=S;t.Spell.aiSpellCellEnemy=(e,t)=>{const{actor:n,actorCellsAround:s}=e;let r=null;return s.forEach(t=>{t.getActors().forEach(t=>{if(n.isEnemy(t)){const n=t.get("Health");if(r)if(e.compFunc)e.compFunc(r,t)&&(r=t);else{n.getMaxHP()>r.get("Health").getMaxHP()&&(r=t)}else r=t}})}),!!r&&(S(n,r,t),!0)};t.Spell.aiSpellCellFriend=(e,t)=>{const{actor:n,actorCellsAround:s}=e;let r=null;return s.forEach(t=>{t.getActors().forEach(t=>{if(n.isFriend(t))if(r)if(e.compFunc)e.compFunc(r,t)&&(r=t);else{const e=r.get("Health");t.get("Health").hpLost()>e.hpLost()&&(r=t)}else r=t})}),!!r&&(S(n,r,t),!0)};t.Spell.aiSpellCellSelf=(e,t)=>{const{actor:n}=e;let s=!0;return e.compFunc&&(s=!!e.compFunc(n)),s&&S(n,n,t),s},t.Spell.getSelectionObjectSelf=(e,t)=>()=>{const n=new c.SpellCast;n.setSource(t),n.setSpell(e),n.setArgs({src:t}),t.add(n)},t.Spell.getSelectionObjectDir=(e,t,n)=>(i.default.gameMsg(n),{select:n=>{const s={dir:v.getDir(n)};return s.dir?(s.src=t,()=>{const n=new c.SpellCast;n.setSource(t),n.setSpell(e),n.setArgs(s),t.add(n)}):null},showMenu:()=>!1});const w=function(e,t){return{from:t.src.getXY(),dir:t.dir,spell:e,src:t.src}};t.Spell.getDirSpellArgs=w;class C{constructor(e){this._actor=e,this._spells=[],i.default.isNullOrUndef([this._actor])&&i.default.err("Spell.SpellBook","new","actor must be given.")}getActor(){return this._actor}addSpell(e){this._spells.push(e),e.setCaster(this.getActor())}getSpells(){return this._spells}equals(e){const t=e.getSpells();let n=!0;return this._spells.forEach((e,s)=>{n=n&&e.equals(t[s]),n||console.log("Spell",e.getName()," caused error")}),n}getSelectionObject(){const e=this._spells;return{select:t=>{const n=l.Keys.codeToIndex(t);return n>=0&&n<e.length?e[n].getSelectionObject(this._actor):null},getMenu:()=>{i.default.gameMsg("Please select a spell to cast:");const t=l.Keys.menuIndices.slice(0,this._spells.length),n={pre:["You know the following spells:"]};return e.forEach((e,s)=>{n[t[s]]=e.toString()}),n},showMenu:()=>!0}}toJSON(){return{spells:this._spells.map(e=>e.toJSON())}}}function O(e,t,n){const{actor:s,enemy:r}=e;if(!r)return!1;if(p.Brain.distToActor(s,r)<=n.getRange()){return t(s,{target:r,src:s}),!0}return!1}t.SpellBook=C,t.Spell.SpellBook=C,t.SpellBase=function(e,t){this._name=e,this._power=t||5,this._caster=null,this._dice={},this._range=0,this.setName(e)},t.SpellBase.prototype.setCaster=function(e){e||i.default.err("SpellBase","setCaster","Tried to set null caster"),this._caster=e},t.SpellBase.prototype.getCaster=function(){return this._caster},t.SpellBase.prototype.setName=function(e){const t=e.split(/\s+/),n=[];t.forEach(e=>{n.push(e.capitalize())}),this._new=n.join("")},t.SpellBase.prototype.getName=function(){return this._name},t.SpellBase.prototype.getPower=function(){return this._power},t.SpellBase.prototype.canCast=function(){return this._caster.get("SpellPower").getPP()>=this.getCastingPower()},t.SpellBase.prototype.getCastingPower=function(){let e=this._power;const t=this._caster.get("Experience").getExpLevel();e-=Math.ceil(t/3),e-=Math.floor(this.getCastSkillLevel()/2);const n=Math.round(.5*this._power);return e<n?n:e},t.SpellBase.prototype.getRange=function(){return this._range},t.SpellBase.prototype.setRange=function(e){this._range=e},t.SpellBase.prototype.getDuration=function(e=1){let t=0;if(this._dice.duration&&(t=this._dice.duration.roll()),e>0){const n=this._caster.get("Experience").getExpLevel();t+=Math.round(n/e),t+=Math.round(this.getCastSkillLevel()/e)}return t},t.SpellBase.prototype.getDamage=function(e=1){let t=0;this._dice.damage&&(t=this._dice.damage.roll());const n=this._caster.get("Experience").getExpLevel();return t+=Math.round(n/e),t+=this.getCastSkillLevel(),t},t.SpellBase.prototype.getCastSkillLevel=function(){return i.default.getSkillLevel(this._caster,i.default.SKILLS.SPELLCASTING)},t.SpellBase.prototype.setPower=function(e){this._power=e},t.SpellBase.prototype.getCastFunc=function(e,t){return t.dir||t.target||t.src?(t.src=e,()=>{const n=new c.SpellCast;n.setSource(e),n.setSpell(this),n.setArgs(t),e.add(n)}):null},t.SpellBase.prototype.toString=function(){const e=this.getCastingPower();let t=`${this.getName()} - ${e}PP`;const n=this.getCastSkillLevel();if(this._dice.damage){const e=n;t+=" Dmg: "+this._dice.damage.toString(),e>0&&(t+=" + "+e)}return this._dice.duration&&(t+=" Dur: "+this._dice.duration.toString()),this._range>0&&(t+=" R: "+this.getRange()),t},t.SpellBase.prototype.getCasterExpBonus=function(e){const t=this.getCaster().get("Experience").getExpLevel();return Math.round(t/e)},t.SpellBase.prototype.getCasterStatBonus=function(e,t){const n="get"+e.capitalize(),s=this.getCaster()[n]();return Math.round(s/t)},t.SpellBase.prototype.equals=function(e){let t=this.getName()===e.getName();return t=t&&this.getPower()===e.getPower(),t=t&&this.getRange()===e.getRange(),Object.keys(this._dice).forEach(n=>{t=!!e._dice[n]&&(t&&this._dice[n].equals(e._dice[n]))}),t},t.SpellBase.prototype.setDice=function(e,t){"string"==typeof t?this._dice[e]=h.Dice.create(t):t.roll&&(this._dice[e]=t)},t.SpellBase.prototype.getDice=function(e){return this._dice[e]},t.SpellBase.prototype.hasDice=function(e){return!(!this._dice.hasOwnProperty(e)||!this._dice[e])},t.SpellBase.prototype.removeDice=function(e){this._dice[e]=null},t.SpellBase.prototype.rollDice=function(e){return this._dice[e]?this._dice[e].roll():(i.default.err("SpellBase","rollDice",`No dice with name ${e} found`),0)},t.SpellBase.prototype.aiShouldCastSpell=function(e,t){return!1},t.SpellBase.prototype.toJSON=function(){const e={};return Object.keys(this._dice).forEach(t=>{i.default.isNullOrUndef([this._dice[t]])||(e[t]=this._dice[t].toJSON())}),{name:this.getName(),new:this._new,power:this.getPower(),dice:e,range:this._range}},t.Spell.AddComponent=function(e,n){t.SpellBase.call(this,e,n),this._compName="",this._dice.duration=h.Dice.create("1d6 + 3")},i.default.extend2(t.Spell.AddComponent,t.SpellBase),t.Spell.AddComponent.prototype.setDuration=function(e){this._dice.duration=e},t.Spell.AddComponent.prototype.setCompName=function(e){this._compName=e},t.Spell.AddComponent.prototype.getCompName=function(){return this._compName},t.Spell.AddComponent.prototype.cast=function(e){const t=w(this,e),n=b(this._compName);if(n.setSource&&n.setSource(e.src),t.addComp={comp:n},this.hasDice("duration")){const e=this.rollDice("duration");t.addComp.duration=e}const s=new c.SpellCell;s.setArgs(t),e.src.add(s)},t.Spell.AddComponent.prototype.getSelectionObject=function(e){return t.Spell.getSelectionObjectDir(this,e,"Select a direction for the spell:")},t.Spell.RemoveComponent=function(e,n){t.SpellBase.call(this,e,n),this._compNames=[],this.setCompNames=e=>{this._compNames="string"==typeof e?[e]:e},this.getCompNames=()=>this._compNames,this.cast=function(e){const t=w(this,e);t.removeComp=this._compNames;const n=new c.SpellCell;n.setArgs(t),e.src.add(n)},this.getSelectionObject=function(e){return t.Spell.getSelectionObjectDir(this,e,"Select a direction for the spell:")}},i.default.extend2(t.Spell.RemoveComponent,t.SpellBase),t.Spell.Ranged=function(e,n){t.SpellBase.call(this,e,n),this._dice.damage=h.Dice.create("4d4 + 4"),this._range=5},i.default.extend2(t.Spell.Ranged,t.SpellBase),t.Spell.BoltBase=function(e,n){t.Spell.Ranged.call(this,e,n),this.stopOnHit=!1,this.cast=function(e){const t=w(this,e);t.damageType=this.damageType,t.damage=this.rollDice("damage");const n=new c.SpellRay;n.setArgs(t),e.src.add(n)},this.getSelectionObject=function(e){return i.default.gameMsg("Select a direction for firing:"),{select:t=>{const n=v.getDir(t);return this.getCastFunc(e,{dir:n})},showMenu:()=>!1}},this.aiShouldCastSpell=(e,t)=>{const{actor:n,enemy:s}=e;if(!s)return!1;const[r,a]=[n.getX(),n.getY()],[o,l]=[s.getX(),s.getY()],c=f.Geometry.getStraightLine(r,a,o,l);if(c.length>1){const e={dir:[c[1][0]-c[0][0],c[1][1]-c[0][1]]};return"function"==typeof t?t(n,e):i.default.err("Spell.BoltBase","aiShouldCastSpell","No callback function given!"),!0}return!1}},i.default.extend2(t.Spell.BoltBase,t.Spell.Ranged),t.Spell.SummonBase=function(e,n){t.SpellBase.call(this,e,n),this.summonType="",this.nActors=1,this.summonFunc=null,this.setSummonType=e=>{this.summonType=e},this.cast=function(e){const t=w(this,e),n=h.Dice.getValue(this.nActors);t.callback=t=>{if(1===n)t.isFree()&&this._createAndAddActor(t,e);else{const t=e.src,s=t.getLevel().getMap(),[r,a]=t.getXY(),o=f.Geometry.getBoxAround(r,a,2);let l=0,c=30;for(;l<n;){const[t,n]=y.arrayGetRand(o);if(s.hasXY(t,n)){const r=s.getCell(t,n);r.isFree()&&(this._createAndAddActor(r,e),++l)}if(0==--c)break}if(l<n){const e=t.getName()+" has no space to summon";i.default.gameMsg({cell:t.getCell(),msg:e})}}};const s=new c.SpellCell;s.setArgs(t),e.src.add(s)},this.getSelectionObject=function(e){return t.Spell.getSelectionObjectDir(this,e,"Select a free cell for summoning:")},this.aiShouldCastSpell=(e,t)=>{const{actor:n,enemy:s}=e;if(0===p.Brain.getFriendCellsAround(n).length)if("function"==typeof t){const s=n.getBrain().getRandAdjacentFreeCell();if(s)return e.dir=i.default.dXdY(s,n),t(n,e),!0}else i.default.err("Spell."+this.getName(),"aiShouldCastSpell","No callback function given! enemy: "+s);return!1},this._createAndAddActor=(e,t)=>{const[n,s]=[e.getX(),e.getY()],r=t.src,a=r.getLevel(),o=d.ObjectShell.getParser();let l=null;if(""!==this.summonType?l=o.createActor(this.summonType):this.summonFunc&&(l=o.createRandomActor({func:this.summonFunc})),l){a.addActor(l,n,s),l.getBrain().getMemory().copyMemoryFrom(r),l.addFriend(r),r.addFriend(l);const o=`${r.getName()} summons ${l.getName()}!`;i.default.gameMsg({cell:e,msg:o}),"function"==typeof this.postSummonCallback&&this.postSummonCallback(e,t,l)}else{let e=`Failed to create summon type |${this.summonType}|`;if(this.summonFunc){e=`summonFunc ${this.summonFunc.toString()} gave no actors`}i.default.warn("Spell.SummonBase","_createAndActor",e)}}},i.default.extend2(t.Spell.SummonBase,t.SpellBase),t.Spell.Missile=function(e,n){t.Spell.Ranged.call(this,e,n),this.ammoName=""},i.default.extend2(t.Spell.Missile,t.Spell.Ranged),t.Spell.Missile.prototype.getAmmoName=function(){return this.ammoName},t.Spell.Missile.prototype.cast=function(e){const t={from:e.src.getXYZ(),target:e.target,spell:this,src:e.src,to:e.target.getXYZ()};t.damageType=this.damageType,t.damage=this.getDamage();const n=new c.SpellMissile;n.setArgs(t),e.src.add(n)},t.Spell.Missile.prototype.getSelectionObject=function(e){i.default.gameMsg("Select [n]ext/[p]rev target. [t] to fire. [s] to exit."),e.getBrain().startTargeting();const t=[{key:l.Keys.KEY.TARGET,func:()=>{const t=e.getBrain().getTarget();if(t){const n=new c.SpellCast;n.setSource(e),n.setSpell(this),n.setArgs({src:e,target:t}),e.add(n),e.getBrain().cancelTargeting()}}}];return new g.PlayerMissileMenu(t,e)},t.Spell.Missile.prototype.aiShouldCastSpell=function(e,t){const{actor:n,enemy:s}=e;if(s){const[e,r]=s.getXY(),[a,o]=n.getXY();if(m.Path.shortestDist(e,r,a,o)<=this.getRange()){return t(n,{target:s,src:n}),!0}}return!1},t.Spell.AreaBase=function(e,n){t.Spell.Ranged.call(this,e,n),this.getSelectionObject=function(e){return t.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=(e,t)=>O(e,t,this),this.cast=function(e){const t={src:e.src,range:this.getRange(),spell:this};t.damageType=this.damageType,t.damage=this.getDamage();const n=new c.SpellArea;n.setArgs(t),e.src.add(n);const s=e.src.getName(),r=`Huge ${this.getName()} emanates from ${s}`;i.default.gameMsg({msg:r,cell:e.src.getCell()})}},i.default.extend2(t.Spell.AreaBase,t.Spell.Ranged),t.Spell.RingBase=function(e,n){t.SpellBase.call(this,e,n),this._dice.duration=h.Dice.create("10d10"),this._range=2,this._createdActor="Fire",this.cast=function(e){const t=w(this,e);t.callback=this.castCallback.bind(this);const n=new c.SpellSelf;n.setArgs(t),e.src.add(n)},this.getSelectionObject=function(e){return t.Spell.getSelectionObjectSelf(this,e)},this.castCallback=()=>{const e=d.ObjectShell.getParser(),t=this._caster;p.Brain.getCellsAroundActor(t,this._range).forEach(t=>{if(t.isPassable()||t.hasActors()){const n=e.createActor(this._createdActor);E(n,t,this)}})},this.aiShouldCastSpell=(e,t)=>O(e,t,this)},i.default.extend2(t.Spell.RingBase,t.SpellBase),t.Spell.WaveBase=function(e,n){t.Spell.Missile.call(this,e,n),this._waveWidth=3,this._waveDepth=2,this._waveSpeed=100,this._waveActor="Ice wave",this.cast=this.cast.bind(this)},i.default.extend2(t.Spell.WaveBase,t.Spell.Missile),t.Spell.WaveBase.prototype.getWaveActor=function(){return this._waveActor},t.Spell.WaveBase.prototype.getWaveWidth=function(){return this._waveWidth},t.Spell.WaveBase.prototype.getWaveDepth=function(){return this._waveDepth},t.Spell.WaveBase.prototype.getWaveSpeed=function(){return this._waveSpeed},t.Spell.WaveBase.prototype.cast=function(e){const t={from:e.src.getXYZ(),target:e.target,spell:this,src:e.src,to:e.target.getXYZ()};t.damageType=this.damageType,t.damage=this.getDamage();const n=new c.SpellWave;n.setArgs(t),console.log("WaveBase adding SpellWave comp now:",t.from,"->",t.to),e.src.add(n)},t.Spell.MultiSpell=function(e,n){t.SpellBase.call(this,e,n),this._spells=[]},i.default.extend2(t.Spell.MultiSpell,t.SpellBase),t.Spell.MultiSpell.prototype.addSpell=function(e){this._spells.push(e)},t.Spell.MultiSpell.prototype.setCaster=function(e){t.SpellBase.prototype.setCaster.call(this,e),this._spells.forEach(t=>{t.setCaster(e)})},t.Spell.MultiSpell.prototype.removeSpells=function(){this._spells=[]},t.Spell.MultiSpell.prototype.canCast=function(){return this._caster.get("SpellPower").getPP()>=this.getCastingPower()},t.Spell.MultiSpell.prototype.cast=function(e){this._spells.forEach(t=>{t.cast(e)})},t.Spell.MultiSpell.prototype.getCastingPower=function(){return this._spells.map(e=>e.getCastingPower()).reduce((e,t)=>e+t,0)},t.Spell.MultiSpell.prototype.getPower=function(){return this._spells.map(e=>e.getPower()).reduce((e,t)=>e+t,0)},t.Spell.MultiSpell.prototype.aiShouldCastSpell=function(e,t){let n=!0;return this._spells.forEach(s=>{n=n&&s.aiShouldCastSpell(e,t)}),n},t.Spell.MultiSpell.prototype.equals=function(e){if(!e._spells)return!1;if(e._spells.length!==this._spells.length)return!1;let t=!0;return this._spells.forEach((n,s)=>{t=t&&n.equals(e._spells[s]),t||console.log("Spell",n.getName()," caused error")}),t},t.Spell.MultiSpell.prototype.toJSON=function(){const e=t.SpellBase.prototype.toJSON.call(this);return e.spells=this._spells.map(e=>e.toJSON()),e},t.Spell.override=!1,t.Spell.defineSpell=function(e,n){const s=class extends n{constructor(...t){super(e,0),this._init&&"function"==typeof this._init&&this._init(...t)}};return t.Spell.hasOwnProperty(e)&&!t.Spell.override&&i.default.err("Spell","defineSpell",`Tried to override spell |${e}|. Use Spell.override = true`),t.Spell[e]=s,s},t.Spell.undefineSpell=function(e){delete t.Spell[e]}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ThinkCommander=t.ThinkSpellcaster=t.ThinkBasic=t.GoalTop=t.GoalsTop=void 0;const r=s(n(4)),a=n(72),o=n(9),i=n(38),l=n(185),c=n(15)("bitn:goals-top"),{GOAL_COMPLETED:u,GOAL_INACTIVE:h,GOAL_FAILED:d}=a.GoalStatus,p=o.Random.getRNG();t.GoalsTop={};class f extends a.GoalBase{constructor(e){super(e),this.setType("GoalTop"),this.evaluators=[]}removeEvaluators(){this.evaluators=[]}removeEvaluatorsByType(e){this.evaluators=this.evaluators.filter(t=>t.getType()!==e)}addEvaluator(e){this.evaluators.push(e)}addEvalByName(e,t){const n=new i.Evaluator[e](t);this.evaluators.push(n)}hasEvalType(e){return this.evaluators.findIndex(t=>t.type===e)>=0}activate(){this.arbitrate()}getEvaluator(e){return this.evaluators.find(t=>t.getType()===e)}process(){this.activateIfInactive();const e=this.processSubGoals();if(e===u||e===d){if(this._debug){const t=a.statusToString(e);this.dbg("process() COMPL/FAILED got status "+t)}return h}return this.removeFinishedOrFailed(),this.dbg("process() got status "+a.statusToString(e)),e}setBias(e){Object.keys(e).forEach(t=>{const n=this.evaluators.find(e=>e.getType()===t);if(n)n.setBias(e[t]);else{const e=this.evaluators.map(e=>e.getType()),n=`Bias ${t} not matching any evaluator: ${e}`;r.default.warn("GoalTop","setBias",n)}})}toJSON(){const e=[];return this.evaluators.forEach(t=>{"Orders"!==t.getType()&&"UseSkill"!==t.getType()&&e.push(t.toJSON())}),{type:this.getType(),evaluators:e}}arbitrate(){this.dbg("arbitrate() started"),this.isActive()||0!==this.evaluators.length||r.default.err("GoalTop","arbitrate",`No evaluators in ${this.getType}, actor: ${this.actor}`);let e=0,t=null;const n=this.evaluators.length;for(let s=0;s<n;s++){const n=this.evaluators[s],r=n.calculateDesirability(this.actor);n.wasLastChosen=!1,(e<r||null===t)&&(t=n,e=r),this._debug&&this.dbg(`arbitr: eval ${n.getType()}: ${r}`)}t?e!==i.Evaluator.NOT_POSSIBLE&&(t.setActorGoal(this.actor),t.wasLastChosen=!0,t.isOneShot&&this.removeEvaluator(t)):this.isActive()||r.default.err("GoalTop","arbitrate","No next goal found"),this.dbg("arbitrate() finished")}removeEvaluator(e){const t=this.evaluators.indexOf(e);return t>=0&&(this.evaluators.splice(t,1),!0)}}t.GoalTop=f,t.GoalsTop.Top=f;class m extends f{constructor(e){super(e),this.setType("ThinkBasic");const[t,n]=[.75,1.5];this.bias={attack:p.getUniformRange(t,n),explore:r.default.BIAS.Explore,flee:r.default.BIAS.Flee,order:r.default.BIAS.Order,patrol:r.default.BIAS.Patrol,follow:r.default.BIAS.Follow},this.updateEvaluators()}updateEvaluators(){this.removeEvaluators(),this.evaluators.push(new i.Evaluator.AttackActor(this.bias.attack)),this.evaluators.push(new i.Evaluator.Flee(this.bias.flee)),this.evaluators.push(new i.Evaluator.Explore(this.bias.explore)),this.evaluators.push(new i.Evaluator.FollowActor(this.bias.follow))}giveOrders(e){this.dbg("Received an order!!"+JSON.stringify(e)),this.addEvaluator(e)}clearOrders(){this.evaluators.filter(e=>e.isOrder()).forEach(e=>{const t=e;t.goal.isActive()&&t.goal.terminate();const n=this.evaluators.indexOf(t);this.evaluators.splice(n,1)})}addGoal(e){const t=e.getType();this.dbg("addGoal() "+t),this.isGoalPresent(t)||(this.removeSubGoalsOfType(t),this.addSubGoal(e),c.enabled&&r.default.log("Actor subgoals are now: "+this.subGoals.map(e=>e.getType())))}}t.ThinkBasic=m,t.GoalsTop.ThinkBasic=m;class g extends m{constructor(e){super(e),this.setType("ThinkSpellcaster"),this.bias.castSpell=1,this.evaluators.push(new i.Evaluator.CastSpell(this.bias.castSpell))}}t.ThinkSpellcaster=g,t.GoalsTop.ThinkSpellcaster=g;class y extends m{constructor(e){super(e),this.setType("ThinkCommander"),this.bias.attack=.1,this.bias.winBattle=.8,this.bias.retreat=.3,this.updateEvaluators()}updateEvaluators(){super.updateEvaluators();const e=new l.EvaluatorsBattle.WinBattle(this.bias.winBattle);this.evaluators.push(e);const t=new l.EvaluatorsBattle.Retreat(this.bias.retreat);this.evaluators.push(t)}}t.ThinkCommander=y,t.GoalsTop.ThinkCommander=y},function(e,t,n){(function(e){var s=n(44),r=n(525),a=t&&!t.nodeType&&t,o=a&&"object"==typeof e&&e&&!e.nodeType&&e,i=o&&o.exports===a?s.Buffer:void 0,l=(i?i.isBuffer:void 0)||r;e.exports=l}).call(this,n(200)(e))},function(e,t,n){(function(e){function n(e){return Object.prototype.toString.call(e)}t.isArray=function(e){return Array.isArray?Array.isArray(e):"[object Array]"===n(e)},t.isBoolean=function(e){return"boolean"==typeof e},t.isNull=function(e){return null===e},t.isNullOrUndefined=function(e){return null==e},t.isNumber=function(e){return"number"==typeof e},t.isString=function(e){return"string"==typeof e},t.isSymbol=function(e){return"symbol"==typeof e},t.isUndefined=function(e){return void 0===e},t.isRegExp=function(e){return"[object RegExp]"===n(e)},t.isObject=function(e){return"object"==typeof e&&null!==e},t.isDate=function(e){return"[object Date]"===n(e)},t.isError=function(e){return"[object Error]"===n(e)||e instanceof Error},t.isFunction=function(e){return"function"==typeof e},t.isPrimitive=function(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e},t.isBuffer=e.isBuffer}).call(this,n(96).Buffer)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KeyCode=void 0,t.KeyCode={},t.KeyCode.getKeyCode=function(e){return"number"==typeof e.which?e.which:e.keyCode}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Builder=void 0;const r=s(n(4)),a=n(18),o=n(46),i=n(24),l=n(28);t.Builder=class{static addPathToMap(e,t){const n=[];for(let s=0;s<t.length;s++){const r=t[s];if(e.hasXY(r.x,r.y)){const t=e.getBaseElemXY(r.x,r.y).getType();t.match(/(chasm|water)/)?e.setBaseElemXY(r.x,r.y,a.ELEM.BRIDGE):/stone|highrock/.test(t)?e.setBaseElemXY(r.x,r.y,a.ELEM.PATH):e.setBaseElemXY(r.x,r.y,a.ELEM.ROAD),n.push(r)}}return n}static splitLevel(e,t){const n=[],s=e.getMap().cols/t.nLevelsX,a=e.getMap().rows/t.nLevelsY,c=e.getActors().slice(),u=e.getItems().slice(),h=c.length>0||u.length>0;for(let e=0;e<t.nLevelsX;e++){const e=[];for(let n=0;n<t.nLevelsY;n++){let t=null;if(h)t=(new l.FactoryLevel).createLevel("empty",s,a);else{const e=o.CellMap.createWithoutCells(s,a);t=new i.Level(e)}e.push(t)}n.push(e)}const d=(e,t)=>{const r=Math.floor(e/s),o=Math.floor(t/a);return n[r][o]},p=e=>e%s,f=e=>e%a,m=e.getMap();for(let e=0;e<m.cols;e++)for(let t=0;t<m.rows;t++){const n=d(e,t),s=p(e),r=f(t);h?n.getMap().setBaseElemXY(s,r,m.getBaseElemXY(e,t)):n.getMap().moveCellUnsafe(s,r,m.getCell(e,t))}c.forEach(t=>{const n=t.getX(),s=t.getY();if(e.removeActor(t)){const e=d(n,s),r=p(n),a=f(s);e.addActor(t,r,a)}else r.default.warn("Geometry","splitLevel","removeActor failed on "+JSON.stringify(t))}),u.forEach(t=>{const n=t.getX(),s=t.getY();e.removeItem(t,n,s);const r=d(n,s),a=p(n),o=f(s);r.addItem(t,a,o)});return e.getStairs().length>0&&r.default.warn("Geometry","splitLevel","Function does not move stairs correctly (yet)."),n}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryActor=t.ActorRandomizer=void 0;const i=o(n(4)),l=a(n(61)),c=a(n(27)),u=a(n(12)),h=n(342),d=n(113),p=a(n(11)),f=n(82),m=n(15)("bitn:FactoryActor"),g=(e,t)=>{const{hp:n,att:s,def:r,prot:a}=t;if(!i.default.isNullOrUndef([n])){const t=e.get("Health");t.setHP(n),t.setMaxHP(n)}let o=null;e.has("Combat")?o=e.get("Combat"):(o=new p.Combat,e.add(o)),i.default.isNullOrUndef([s])||o.setAttack(s),i.default.isNullOrUndef([r])||o.setDefense(r),i.default.isNullOrUndef([a])||o.setProtection(a)};class y{adjustActor(e){const t=e.getType();if(h.ActorMods.hasOwnProperty(t)){const{stats:n}=h.ActorMods[t];Object.keys(n).forEach(t=>{const s=i.default.formatSetterName(t),r=i.default.formatGetterName(t),a=e.get("Stats")[r]+n[t];e.get("Stats")[s](a)})}}}t.ActorRandomizer=y;t.FactoryActor=class{constructor(){this._randomizer=new y}dbg(...e){m.enabled&&m(...e)}createPlayer(e,t){const n=new l.SentientActor(e);return n.setIsPlayer(!0),g(n,t),this._randomizer.adjustActor(n),n}createRandomActor(e){return u.getParser().createRandomActor(e)}createActorByName(e){return u.getParser().createActor(e)}createActor(e,t={}){const n=new l.SentientActor(e);n.setType(e);const s=t.brain;if(g(n,t),this._randomizer.adjustActor(n),!i.default.isNullOrUndef([s]))if("object"==typeof s)n.setBrain(s);else{const e=this.createBrain(n,s);n.setBrain(e)}return n}createBrain(e,t){switch(t){case"Flame":return new c.BrainFlame(e);case"GoalOriented":if(i.default.isSentient(e))return new c.BrainGoalOriented(e);i.default.err("RG","createBrain","Can only create GoalOriented for sentient actor");case"NonSentient":return new c.BrainNonSentient(e);case"SpellCaster":return new c.BrainSpellCaster(e);case"Spirit":return new c.BrainSpirit(e);default:if(c[t])return new c[t](e);if(t&&""!==t){let e=`Warning. No brain type ${t} found`;e+="Using the default Brain.BrainSentient instead.",console.warn(e)}return new c.BrainSentient(e)}}createSpell(e){if(d.Spell.hasOwnProperty(e))return new d.Spell[e];{const t=Object.keys(d.Spell).join("\n\t");i.default.err("FactoryActor","createSpell",`No spell ${e} found in Spell: \n\t${t}`)}return null}generateNActors(e,t,n){(!Number.isInteger(n)||n<=0)&&i.default.err("Factory.Actor","generateNActors","maxDanger (> 0) must be given. Got: "+n),n<3&&(n=3);const s=u.getParser(),r=[],a={func:e=>e.danger<=n};for(let o=0;o<e;o++){let e=null;if(e=t?s.createRandomActor({func:e=>t(e)&&e.danger<=n}):s.createRandomActorWeighted(1,n,a),e){const t=s.dbGet({categ:i.default.TYPE_ACTOR,name:e.getName()}),a=n-t.danger;a>1&&i.default.levelUpActor(e,a),r.push(e)}else{let e="Factory Could not meet constraints for actor.";if(e+=" maxDanger: "+n,i.default.diag(e),t.constraint){const e=JSON.stringify(t.constraint);i.default.diag("Used constraints were: "+e)}else t||i.default.diag("No func was given, so used randomWeighted")}}return r}createActorSpawner(e,t,n){const s=new f.SpawnerActor("spawner"),r=s.getBrain();let a=[{op:"lte",prop:"danger",value:e}];return a=a.concat(t),r.setConstraint(a),n&&r.setPlaceConstraint(n),s}}},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t,n){var s=n(347),r=n(234);e.exports=Object.keys||function(e){return s(e,r)}},function(e,t){t.f={}.propertyIsEnumerable},function(e,t){e.exports={}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.OWMap=void 0;const r=n(15)("bitn:OW"),a=s(n(4)),o=n(30),i=n(46),l=n(19),c=n(13),u=n(166),h=n(9),d=n(371),p=n(244),f=n(16),m=h.Random.getRNG;class g{constructor(){this._baseMap=[],this._explored={},this._subLevels=[],this._hWalls=[],this._vWalls=[],this._features={},this._featureData={},this._featuresByXY={},this._biomeMap={},this._terrMap=null,this.debugMap={},this._paths={},this._pathsXY={}}static fromJSON(e){const t=new g;return t.setMap(e.baseMap),t._features=e.features,t._featuresByXY=e.featuresByXY,t._vWalls=e.vWalls,t._hWalls=e.hWalls,t._biomeMap=e.biomeMap,t._explored=e.explored,t._paths=e.paths,e.terrMap&&(t._terrMap=p.Territory.fromJSON(e.terrMap)),t}hasTerrMap(){return!!this._terrMap}getSizeXY(){return[this.getSizeX(),this.getSizeY()]}getCenterX(){return Math.round(this.getSizeX()/2)}getCenterY(){return Math.round(this.getSizeY()/2)}isWallTile(e,t){const n=this._baseMap[e][t];return u.OW.ALL_WALLS_LUT.hasOwnProperty(n)}isTerm(e,t){return this._baseMap[e][t]===u.OW.TERM}numTiles(e){let t=0;const[n,s]=this.getSizeXY();for(let r=0;r<n;r++)for(let n=0;n<s;n++)this._baseMap[r][n]===e&&++t;return t}numWallTiles(){let e=0;const[t,n]=this.getSizeXY();for(let s=0;s<t;s++)for(let t=0;t<n;t++)this.isWallTile(s,t)&&++e;return e}getBiomeMap(){return this._biomeMap}getBiome(e,t){const n=e+","+t;return this._biomeMap.hasOwnProperty(n)?this._biomeMap[e+","+t]:(a.default.err("OWMap","getBiome",`No biome set for x,y ${e},${t}`),"")}getMap(){return this._baseMap}getCell(e){return this._baseMap[e[0]][e[1]]}numHWalls(){return this._hWalls.length}numVWalls(){return this._vWalls.length}getHWall(e){return e<this._hWalls.length?this._hWalls[e]:null}getVWall(e){return e<this._vWalls.length?this._vWalls[e]:null}getHWalls(){return this._hWalls}getVWalls(){return this._vWalls}setMap(e){const t=e.length;this._baseMap=e;for(let e=0;e<t;e++)this._subLevels[e]=[]}setTerrMap(e){this._terrMap=e}getTerrMap(){return this._terrMap}addBiome(e,t,n){const s=e+","+t;this._biomeMap[s]=n}addVWall(e){e.type="vertical",this._vWalls.push(e)}addHWall(e){e.type="horizontal",this._hWalls.push(e)}hasFeatureAt(e){const t=a.default.toKey(e);return this._featuresByXY.hasOwnProperty(t)}addFeature(e,t){const n=e[0]+","+e[1];this._features.hasOwnProperty(t)||(this._features[t]=[]),this._featuresByXY.hasOwnProperty(n)||(this._featuresByXY[n]=[]),this._features[t].push(e),this._featuresByXY[n].push(t)}getFeatureData(e){return this.hasFeatureData(e)?this._featureData[a.default.toKey(e)]:[]}addFeatureData(e,t){const n=a.default.toKey(e);this._featureData.hasOwnProperty(n)||(this._featureData[n]=[]),this._featureData[n].push(t)}hasFeatureData(e){const t=a.default.toKey(e);return!!this._featureData[t]}hasFeatureDataWith(e,t){if(this.hasFeatureData(e)){const n=a.default.toKey(e),s=this._featureData[n];for(let e=0;e<s.length;e++)if(s[e].tags){if(s[e].tags.indexOf(t)>=0)return!0}}return!1}getXYForFeatureDataWith(e,t){let n=null;return Object.keys(this._featureData).forEach(s=>{this._featureData[s].forEach(r=>{if(!n&&r[e]){const o=r[e];(o===t||Array.isArray(o)&&o.indexOf(t)>=0)&&(n=a.default.fromKey(s))}})}),n}getFeaturesByType(e){return this._features.hasOwnProperty(e)?this._features[e]:[]}getFeaturesByXY(e){const t=a.default.toKey(e);return this._featuresByXY[t]}addPath(e,t){this._paths[e]=t,t.forEach(e=>{this._pathsXY[e.x+","+e.y]=t})}getPathAtXY(e){if(this.hasPathAt(e)){const t=a.default.toKey(e);return this._pathsXY[t]}return null}hasPathAt(e){const[t,n]=e,s=t+","+n;return this._pathsXY.hasOwnProperty(s)}getFeaturesOnPath(e){const t={};return e.forEach(e=>{const{x:n,y:s}=e;this.hasFeatureAt([n,s])&&(t[n+","+s]=this.getFeaturesByXY([n,s]))}),t}addSubLevel(e,t){this._subLevels[e[0]][e[1]]=t}getSubLevel(e){return this._subLevels[e[0]][e[1]]}clearSubLevels(){this._subLevels=[]}getSubLevelsWithFeature(e){return this.getFeaturesByType(e).map(e=>this.getSubLevel(e))}getAreaXY(){return this.getSizeX()*this.getSizeY()}getSizeX(){return this._baseMap.length}getSizeY(){return this._baseMap[0].length>0?this._baseMap[0].length:(a.default.warn("OWMap","getSizeY","Y-size requested but returning zero value"),0)}setExplored(e){this._explored[a.default.toKey(e)]=!0}isExplored(e){return this._explored[a.default.toKey(e)]}toJSON(){const e={baseMap:this._baseMap,biomeMap:this._biomeMap,features:this._features,featuresByXY:this._featuresByXY,vWalls:this._vWalls,hWalls:this._hWalls,explored:this._explored,paths:this._paths};return this.coordMap&&(e.coordMap=this.coordMap.toJSON()),this._terrMap&&(e.terrMap=this._terrMap.toJSON()),e}getOWMap(e=!1){const t=JSON.parse(JSON.stringify(this._baseMap)),n=t[0].length,s=t.length;if(Object.keys(this._features).forEach(e=>{this._features[e].forEach(n=>{t[n[0]][n[1]]=e})}),e)for(let e=0;e<s;e++)for(let s=0;s<n;s++)this._explored[e+","+s]||(t[e][s]="?");return Object.keys(this.debugMap).forEach(e=>{console.log("key is "+e);const[n,s]=e.split(","),r=parseInt(n,10),a=parseInt(s,10);t[r][a]=this.debugMap[e]}),t}getCellMap(){const e=this.getOWMap(),t=e[0].length,n=e.length,s=new i.CellMap(n,t);for(let r=0;r<n;r++)for(let n=0;n<t;n++){const t=new f.ElementMarker(e[r][n]);u.OW.classNames[e[r][n]]?t.setClassName(u.OW.classNames[e[r][n]]):t.setClassName(u.OW.classNames.default),s.setProp(r,n,a.default.TYPE_ELEM,t)}return s}mapToString(e=!1){const t=this.getOWMap(e),n=t[0].length,s=t.length,r=[];for(let e=0;e<n;e++){const n=[];for(let r=0;r<s;r++)n.push(t[r][e]);r.push(n)}return r.map(e=>e.join(""))}biomeMapToString(){const e=this.getSizeX()-1,t=this.getSizeY()-1,n=Object.keys(u.OW.biomeTypeMap),s={},r=n.map((e,t)=>(s[e]=""+t,`${t} - ${e}`));let a="";for(let n=0;n<t;n++){let t="";for(let r=0;r<e;r++){const e=r+","+n;t+=","+s[this._biomeMap[e]]}t+="\n",a+=t}return a+="\n"+r.join("\n"),a}filter(e){const t={},[n,s]=this.getSizeXY();for(let r=0;r<n;r++)for(let n=0;n<s;n++){const s=this.isWallTile(r,n),a=this.getFeaturesByXY([r,n]);e(r,n,a,s)&&(t[r+","+n]=a)}return t}addPathToDebug(e){e.forEach((t,n)=>{0===n?this.debugMap[t.x+","+t.y]="X":n===e.length-1?this.debugMap[t.x+","+t.y]="0":this.debugMap[t.x+","+t.y]="*"})}getPaths(){return this._paths}getPath(e){return this._paths[e]?this._paths[e]:[]}}function y(e,t,n,s=!1){const r=n.length;let a=!1;const o={y:t,x:[1]};n[0][t]=u.OW.TT_W,s||(n[r-1][t]=u.OW.TT_E);for(let e=1;e<r-1;e++)a||(n[e][t]!==u.OW.EMPTY?s?(a=!0,n[e][t]=u.OW.TT_E,o.x.push(e)):n[e][t]=u.OW.XX:n[e][t]=m().getWeighted(u.OW.LINE_WE_WEIGHT));a||(s&&(n[r-1][t]=u.OW.TT_E),o.x.push(r-1)),e.addHWall(o)}function v(e,t,n,s=!1){const r=n[0].length;let a=!1;const o={x:t,y:[1]};n[t][0]=u.OW.TT_N,s||(n[t][r-1]=u.OW.TT_S);for(let e=1;e<r-1;e++)a||(n[t][e]!==u.OW.EMPTY?s?(a=!0,n[t][e]=u.OW.TT_S,o.y.push(e)):n[t][e]=u.OW.XX:n[t][e]=m().getWeighted(u.OW.LINE_NS_WEIGHT));a||(s&&(n[t][r-1]=u.OW.TT_S),o.y.push(r-1)),e.addVWall(o)}function b(e,t,n){if(n[e][t]===u.OW.EMPTY){const s=function(e,t,n){const s=n[0].length,r=n.length,a=[];if(t>0){const s=u.OW.CAN_CONNECT[n[e][t-1]].N;a.push([n[e][t-1],s])}if(t<s-1){const s=u.OW.CAN_CONNECT[n[e][t+1]].S;a.push([n[e][t+1],s])}if(e<r-1){const s=u.OW.CAN_CONNECT[n[e+1][t]].E;a.push([n[e+1][t],s])}if(e>0){const s=u.OW.CAN_CONNECT[n[e-1][t]].W;a.push([n[e-1][t],s])}return a}(e,t,n).filter(e=>e[0]!==u.OW.EMPTY&&e[0]!==u.OW.TERM);1===s.length&&s[0][1].length>0?n[e][t]=m().arrayGetRand(s[0][1]):n[e][t]=u.OW.TERM}}function _(e,t){const{playerRace:n}=t;!function(e,t){const{playerX:n,playerY:s}=t,[r,i]=function(e){const t=e.owTilesX/e.nLevelsX,n=e.owTilesY/e.nLevelsY;return[t,n]}(t);if(a.default.isNullOrUndef([n,s,r,i]))return void a.default.warn("OWMap","addHomeTownTag","playerX/Y not found in OWMapConf: "+JSON.stringify(t));const l=n*r,c=s*i,u=l+r-1,h=c+i-1;let d=!1,p=r*i*2,f=null;for(;!d;)f=m().getRandInBbox(new o.BBox(l,c,u,h)),e.isWallTile(f[0],f[1])||(e.addFeatureData(f,{tags:["hometown"]}),d=!0),0==--p&&(console.log("Generated OWMap\n:"+e.mapToString().join("\n")),a.default.err("overworld.map.ts","addHomeTownTag","Failed to find owTileX/Y for player. Conf: "+JSON.stringify(t)))}(e,t);const s=e.getXYForFeatureDataWith("tags","hometown");if(!s)return void a.default.err("overworld.map.ts","createOverWorldTerritories","Unable to find owX/Y for player hometown");const r=d.TerritoryMap.create(e,n,s);e.setTerrMap(r)}function E(e,t){const n=e.getSizeX()*e.getSizeY(),s=e.numTiles(u.OW.TERM),r=e.numWallTiles(),o=t.nDungeonsSouth||Math.floor(r/12),i=t.nDungeonsCenter||Math.floor(r/24),l=t.nDungeonsNorth||Math.floor(r/24),h=t.nMountainsNorth||Math.floor(n/40),d=t.nMountainsMiddle||Math.floor(n/60),p=t.nMountainsSouth||Math.floor(n/60);!function(e,t,n,s){const r=e.getMap(),o=r[0].length,i=r.length;let l=x(t,n,i,o),c=1e3;for(;r[l[0]][l[1]]!==u.OW.TERM;){if(l=x(t,n,i,o),0===c){a.default.warn("OverWorld","addFeature","No empty cell to add "+s+", "+t);break}--c}e.addFeature(l,s)}(e,"NE",.5,u.OW.BTOWER);const f=e.numHWalls();if(f>1&&(S(e,e.getHWall(1),u.OW.WCAPITAL),S(e,e.getHWall(0),u.OW.WTOWER)),f>2)for(let t=2;t<f;t++)S(e,e.getHWall(t),u.OW.VTUNNEL);const m=e.numVWalls();m>0&&(S(e,e.getVWall(m-1),u.OW.BTOWER),S(e,e.getVWall(m-1),u.OW.BCAPITAL));const g={y:{start:["wall",0],end:["wall",1]}},y={y:{start:"N",end:"wall"}},v={y:{start:["wall",1],end:"S"}};w(e,y,u.OW.BIOME.ALPINE),w(e,{x:{start:["wall",0],end:"E"}},u.OW.BIOME.ARCTIC),w(e,g,u.OW.BIOME.TUNDRA),w(e,v,u.OW.BIOME.TAIGA),C(e,o,v),C(e,i,g),C(e,l,y);const b=t.nCitySouth||Math.floor(.5*s/80),E=t.nCityCenter||Math.floor(.2*s/100),A=t.nCityNorth||Math.floor(.2*s/80);O(e,p,v),O(e,d,g),O(e,h,y),t.createTerritory?(_(e,t),function(e){const t=e.getTerrMap(),n=t.getMap();a.default.forEach2D(n,(n,s)=>{const r=[n,s],o=t.getRival(r);let i=!1;if(e.hasFeatureDataWith(r,"hometown")&&(console.log("DBG addCitiesBasedOnTerritories found hometown at",r),i=!0),t.hasRival(r))if(a.default.isSuccess(.13)||i){M(e,r,i);const t=o+"_city";e.addFeatureData(r,{type:t})}else{const t=c.Geometry.getBoxAround(n,s,1);let r=!1;t.forEach(t=>{if(!r&&e.isWallTile(t[0],t[1])&&a.default.isSuccess(.09)){e.addFeature(t,u.OW.MFORT);const n=o+"_fort";e.addFeatureData(t,{type:n}),r=!0}})}else i&&a.default.err("overworld.map.ts","addCitiesBasedOnTerritories","isHome=true but no rival found at "+r)})}(e)):(T(e,b,v),T(e,E,g),T(e,A,y))}function S(e,t,n){const s=e.getMap();let a=null;if("horizontal"===t.type){const e=t.x[0],n=t.x[t.x.length-1];a=N(s,new o.BBox(e,t.y,n,t.y),u.OW.LL_WE)}if("vertical"===t.type){const e=t.y[0],n=t.y[t.y.length-1];a=N(s,new o.BBox(t.x,e,t.x,n),u.OW.LL_NS)}r(`Placed feature ${n} to ${a}`),e.addFeature(a,n)}function w(e,t,n){const s=P(e,t);for(let t=s.ulx;t<=s.lrx;t++)for(let r=s.uly;r<=s.lry;r++)e.addBiome(t,r,n)}function C(e,t,n){const s=P(e,n);for(let n=0;n<t;n++){const t=N(e.getMap(),s,u.OW.ALL_WALLS);e.addFeature(t,u.OW.WDUNGEON)}}function O(e,t,n){const s=P(e,n);for(let n=0;n<t;n++){const t=N(e.getMap(),s,[u.OW.TERM]);e.addFeature(t,u.OW.MOUNTAIN)}}function T(e,t,n){const s=P(e,n);for(let n=0;n<t;n++){const t=N(e.getMap(),s,[u.OW.TERM]);M(e,t,!1)}}function M(e,t,n){!n&&a.default.isSuccess(u.OW.PROB_BVILLAGE)?e.addFeature(t,u.OW.BVILLAGE):e.addFeature(t,u.OW.WVILLAGE)}function A(e,t){let n=t;"string"==typeof t&&(n=[t]);if(n.indexOf(u.OW.CELL_ANY)>=0)return!0;return n.indexOf(e)>=0}function N(e,t,n){const{ulx:s,uly:r,lrx:o,lry:i}=t;let l=s===o?s:m().getUniformInt(s,o),c=i===r?i:m().getUniformInt(r,i),u=100*(o-s+1)*(i-r+1),h=A(e[l][c],n);for(;!h;){if(l=s===o?s:m().getUniformInt(s,o),c=i===r?i:m().getUniformInt(r,i),h=A(e[l][c],n),0===u){const e=`(${s},${i}) -> (${o},${r})`;a.default.warn("OverWorld","findCellRandXYInBox",`No cells of type ${n} in ${e}`);break}--u}return[l,c]}function x(e,t,n,s){let r=0,a=0,o=0,i=0;return e.match(/N/)&&(i=0,a=Math.floor(.25*t*s)),e.match(/S/)&&(a=s-1,i=.75*s,i=Math.floor(i+(1-t)*(a-i))),e.match(/E/)&&(o=n-1,r=.75*n,r=Math.floor(r+(1-t)*(o-r))),e.match(/W/)&&(r=0,o=Math.floor(.25*t*n)),[m().getUniformInt(r,o),m().getUniformInt(i,a)]}function P(e,t){if(t.isBox)return t;let n=0,s=e.getSizeX()-1,r=0,a=e.getSizeY()-1;if(t.x){const r=t.x.start,a=t.x.end;if("W"===r)n=0;else if("wall"===r){const t=e.getVWalls();t.length>0&&(n=t[0].x)}else if(Array.isArray(r)&&"wall"===r[0]){const t=e.getVWalls();t.length>r[1]&&(n=t[r[1]].x)}if("E"===a)s=e.getSizeX()-1;else if("wall"===a){const t=e.getVWalls();t.length>0&&(s=t[0].x)}else if(Array.isArray(a)&&"wall"===a[0]){const t=e.getVWalls();t.length>a[1]&&(s=t[a[1]].x)}}if(t.y){const n=t.y.start,s=t.y.end;if("N"===n)r=0;else if("wall"===n){const t=e.getHWalls();t.length>0&&(r=t[0].y)}else if(Array.isArray(n)&&"wall"===n[0]){const t=e.getHWalls();t.length>n[1]&&(r=t[n[1]].y)}if("S"===s)a=e.getSizeY()-1;else if("wall"===s){const t=e.getHWalls();t.length>0&&(a=t[0].y)}else if(Array.isArray(s)&&"wall"===s[0]){const t=e.getHWalls();t.length>s[1]&&(a=t[s[1]].y)}}return{ulx:n,lrx:s,uly:r,lry:a}}t.OWMap=g,g.isPassable=function(e,t,n){if(t<0||t>=e.getSizeX())return!1;if(n<0||n>=e.getSizeY())return!1;if(e.isWallTile(t,n)){let s=!1;if(e.hasFeatureAt([t,n])){const r=e.getFeaturesByXY([t,n]),a=u.OW.PASSABLE_FORT;r.forEach(e=>{s=s||a.indexOf(e)>=0})}return s}return!0},g.getPath=function(e,t,n){const[s,r]=t,[a,o]=n;return l.Path.getShortestPath(s,r,a,o,(t,n)=>g.isPassable(e,t,n))},g.createOverWorld=function(e={}){const t=void 0===e.yFirst||e.yFirst,n=void 0===e.topToBottom||e.topToBottom,s=void 0!==e.printResult&&e.printResult,r=e.owTilesX||40,o=e.owTilesY||20,i=new g,l=function(e,t){const n=[];for(let s=0;s<e;s++){n[s]=[];for(let e=0;e<t;e++)n[s][e]=u.OW.EMPTY}return n}(r,o);return function(e){const t=e[0].length,n=e.length;e[0][0]=u.OW.CC_NW,e[0][t-1]=u.OW.CC_SW,e[n-1][t-1]=u.OW.CC_SE,e[n-1][0]=u.OW.CC_NE;for(let t=1;t<n-1;t++)e[t][0]=m().arrayGetRand(u.OW.N_BORDER);for(let s=1;s<n-1;s++)e[s][t-1]=m().arrayGetRand(u.OW.S_BORDER);for(let s=1;s<t-1;s++)e[n-1][s]=m().arrayGetRand(u.OW.E_BORDER);for(let n=1;n<t-1;n++)e[0][n]=m().arrayGetRand(u.OW.W_BORDER)}(l),function(e,t,n){const s=t[0].length,r=t.length;let a=void 0!==n.nHWalls?n.nHWalls:[.3,.5],o=void 0!==n.nVWalls?n.nVWalls:[];const i=void 0!==n.stopOnWall&&n.stopOnWall;if(Number.isInteger(n.nHWalls)){a=[];for(let e=0;e<n.nHWalls;e++){const e=m().getUniformInt(1,19);a.push(.05*e)}a=a.sort()}if(Number.isInteger(n.nVWalls)){o=[];for(let e=0;e<n.nVWalls;e++){const e=m().getUniformInt(1,19);o.push(.05*e)}o=a.sort()}for(let n=0;n<a.length;n++){let r=i;"random"===i&&(r=m().getUniform()>=.5),y(e,Math.floor(s*a[n]),t,r)}for(let n=0;n<o.length;n++){let s=i;"random"===i&&(s=m().getUniform()>=.5),v(e,Math.floor(r*o[n]),t,s)}}(i,l,e),function(e,t,n){const s=t[0].length,r=t.length,a=n.innerWallRatio||.05,o=Math.floor(r*s*a);for(let e=0;e<o;e++){const e=m().getUniformInt(2,r-2),n=m().getUniformInt(2,s-2);t[e][n]===u.OW.EMPTY&&(t[e][n]=m().arrayGetRand(u.OW.ALL_WALLS))}}(0,l,e),n?function(e,t=!0){const n=e[0].length,s=e.length;if(t)for(let t=0;t<s;t++)for(let s=0;s<n;s++)b(t,s,e);else for(let t=0;t<n;t++)for(let n=0;n<s;n++)b(n,t,e)}(l,t):function(e,t=!0){const n=e[0].length,s=e.length;if(t)for(let t=0;t<s;t++)for(let s=n-1;s>=0;s--)b(t,s,e);else for(let t=n-1;t>=0;t--)for(let n=0;n<s;n++)b(n,t,e)}(l,t),e.printResult&&a.default.printMap(l),i.setMap(l),E(i,e),function(e,t){const n=e.getFeaturesByType(u.OW.BTOWER),s=e.getFeaturesByType(u.OW.WCAPITAL),r=g.getPath(e,s[0],n[0]);e.addPath(u.OW.PATH_WCAP_BTOWER,r);const a=e.getFeaturesOnPath(r),o=(r.length,Object.keys(a).length,e.filter((t,n,s,r)=>{if(!s)return!1;if(n===e.getSizeY()-2){if(A(u.OW.WVILLAGE,s))return!0;if(A(u.OW.BVILLAGE,s))return!0;if(e.isTerm(t,n))return!0}return!1}));let i=m().arrayGetRand(Object.keys(o));if(!i){const t=e.filter((t,n,s,r)=>!!(n<e.getSizeY()-1&&n>=e.getSizeY()-3&&e.isTerm(t,n)));i=m().arrayGetRand(Object.keys(t))}if(i){const[t,n]=i.split(","),r=[parseInt(t,10),parseInt(n,10)],a=g.getPath(e,r,s[0]);e.addPath(u.OW.PATH_BEGIN_WCAP,a)}}(i),s&&a.default.log("\n",i.mapToString().join("\n")),e.verify&&function(e){let t="";const n=[u.OW.PATH_WCAP_BTOWER,u.OW.PATH_BEGIN_WCAP];n.forEach(n=>{const s=e.getPath(n);s&&0!==s.length||(t+=`Path ${n} not OK: |${JSON.stringify(s)}|\n`)}),""!==t&&(n.forEach(t=>{const n=e.getPath(t);e.addPathToDebug(n)}),console.log(e.mapToString()),a.default.err("overworld.map.ts","verifyOverWorld",t))}(i),i}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CoordMap=t.OWSubLevel=t.OWSubFeature=t.OWWall=t.OverWorld=void 0;const r=s(n(4)),a=n(97),o=n(372),i=n(19),l=n(118),c=(n(31),n(125)),u=n(783),h=n(785),d=n(166),p=n(18),f=n(9),m=n(28),g=n(13),y=n(245),v=n(30),b=n(15)("bitn:overworld");t.OverWorld={};const _=/(capital|city|abandoned fort|fort|village)/,E=/(dwarven city|abandoned fort|capital)/,S=p.ELEM.WALL_MOUNT.getType();let w=!1;const C=f.Random.getRNG;t.OverWorld.TILE_SIZE_X=100,t.OverWorld.TILE_SIZE_Y=100;const{TILE_SIZE_X:O,TILE_SIZE_Y:T}=t.OverWorld;class M{constructor(e){this.type=e,this.coord=[]}addWallCoord(e){this.coord.push(e)}getCoordAt(e){return this.coord[e]}getWallPos(){return"vertical"===this.type?this.coord[0][0][0]:"horizontal"===this.type?this.coord[0][0][1]:d.OW.ILLEGAL_POS}getWallStart(){return"vertical"===this.type?this.coord[0][0][1]:"horizontal"===this.type?this.coord[0][0][0]:d.OW.ILLEGAL_POS}getWallEnd(){const e=this.coord.length-1;return"vertical"===this.type?this.coord[e][0][1]:"horizontal"===this.type?this.coord[e][0][0]:-1}toString(){let e=`type: ${this.type} `;return e+=`Length: ${this.coord.length}\n`,e+=`Start: ${this.getWallStart()} End: ${this.getWallEnd()}\n`,e+="Tiles: "+JSON.stringify(this.coord),e}}t.OWWall=M;class A{constructor(e,t){this.type=e,this.coord=t,this.cellsAround={},Array.isArray(t)?0===t.length?r.default.err("OWSubFeature","new","coord len is 0."):Array.isArray(t[0])||r.default.err("OWSubFeature","new","Each coord must be [x, y] pair."):r.default.err("OWSubFeature","new","coord must be an array."),this.tags=[],this.alignment=""}getLastCoord(){return this.coord.length>0?this.coord[this.coord.length-1]:[-1,-1]}addTag(e){this.tags.push(e)}getTags(){return this.tags}hasTag(e){return this.tags.indexOf(e)>=0}hasTags(){return this.tags.length>0}}t.OWSubFeature=A;class N{constructor(e){this._level=e,this._hWalls=[],this._vWalls=[],this._subX=e.getMap().rows,this._subY=e.getMap().cols,this._features={},this._featuresByXY={}}getFeatures(){return this._features}getSubX(){return this._subX}getSubY(){return this._subY}addWall(e){"vertical"===e.type?this._vWalls.push(e):"horizontal"===e.type&&this._hWalls.push(e)}getWall(){const e=this._hWalls.length,t=this._vWalls.length;return 0===e&&0===t?null:0===e?this._vWalls[0]:(0===t||r.default.warn("OWSubLevel","getWall",`Return hor wall. Too many walls: vLen: ${t}, hLen: ${e}`),this._hWalls[0])}addFeature(e){const t=e.type;this._features.hasOwnProperty(t)||(this._features[t]=[]),this._features[t].push(e),e.coord.forEach(e=>{const n=e[0]+","+e[1];this._featuresByXY[n]=t})}getFeaturesByType(e){return this._features.hasOwnProperty(e)?this._features[e]:[]}}t.OWSubLevel=N;class x{constructor(e={}){this.worldCols=e.worldCols||0,this.worldRows=e.worldRows||0,this.nTilesX=e.nTilesX||0,this.nTilesY=e.nTilesY||0,this.xMap=e.xMap||0,this.yMap=e.yMap||0}setXYMap(e,t){this.xMap=e,this.yMap=t}getAreaLevelCols(){return this.worldCols/this.nTilesX}getAreaLevelRows(){return this.worldRows/this.nTilesY}toOwLevelXY(e,t){return[e[0]*this.xMap+t[0],e[1]*this.yMap+t[1]]}toOWTileXY(e,t){const n=this.getOWTileBboxFromAreaTileXY(e[0],e[1]);return[n.ulx+Math.floor(t[0]/this.xMap),n.uly+Math.floor(t[1]/this.yMap)]}getAreaXYFromOWTileXY(e,t){return[Math.floor(e/this.xMap),Math.floor(t/this.yMap)]}getOWTileBboxFromAreaTileXY(e,t){return Number.isInteger(e)&&Number.isInteger(t)?v.BBox.fromBBox({ulx:e*O/this.xMap,uly:t*T/this.yMap,lrx:(e+1)*O/this.xMap-1,lry:(t+1)*T/this.yMap-1}):(r.default.err("OverWorld.CoordMap","getOWTileBboxFromAreaTileXY",`Args (x,y) must be ints. Got ${e}, ${t}`),null)}toJSON(){return{worldCols:this.worldCols,worldRows:this.worldRows,nTilesX:this.nTilesX,nTilesY:this.nTilesY,xMap:this.xMap,yMap:this.yMap}}}function P(e,t,n,s,a){const o=e.getMap()[t][n],i=(e.getBiome(t,n),s),l=a,c=(new m.FactoryLevel).createLevel(r.default.LEVEL_EMPTY,i,l),u=new N(c);return e.addSubLevel([t,n],u),function(e,t,n,s,r,a){const o=a.getMap(),i=d.OW.N_HAS_CONN.findIndex(e=>e===s)>=0,l=d.OW.S_HAS_CONN.findIndex(e=>e===s)>=0,c=d.OW.E_HAS_CONN.findIndex(e=>e===s)>=0,u=d.OW.W_HAS_CONN.findIndex(e=>e===s)>=0,h=o.cols,f=o.rows,m=e.getSizeX(),g=e.getSizeY(),y=Math.floor(h/2),v=Math.floor(f/2);let b=null,_=-1,E=-1;i&&l?(_=0,E=f-1):i?(_=0,E=v-1):l&&(_=v,E=f-1);0===t?_=0:t===m-1&&(E=f-1);let S=D(E+1,5,3,h,3);if(i||l){const e=new M("vertical");for(let n=_;n<=E;n++){b=S[n-_];const s=[];1===b&&(b=5);let r=y-(b-1),a=y+(b-1);0===t&&(r=0),t===m-1&&(a=h-1);for(let e=r;e<=a;e++)s.push([e,n]);o.setBaseElems(s,p.ELEM.WALL_MOUNT),e.addWallCoord(s)}r.addWall(e)}let w=-1,C=-1;c&&u?(w=0,C=h-1):c?(w=y,C=h-1):u&&(w=0,C=y-1);0===n?w=0:n===g-1&&(C=h-1);if(S=D(C+1,5,3,h,3),c||u){const e=new M("horizontal");for(let t=w;t<=C;t++){b=S[t-w];const s=[];1===b&&(b=5);let r=v-(b-1),a=v+(b-1);0===n&&(r=0),n===g-1&&(a=f-1);for(let e=r;e<=a;e++)s.push([t,e]);o.setBaseElems(s,p.ELEM.WALL_MOUNT),e.addWallCoord(s)}r.addWall(e)}}(e,t,n,o,u,c),c}function I(e,t,n){let s=Math.floor(C().getNormal(e,t));return s>n/2?s=n/2-1:s<1&&(s=1),s}function D(e,t,n,s,r){const a=[];for(let r=0;r<e;r++)a.push(I(t,n,s));const o=[];for(let e=0;e<r;e++)o.push(a[e]);for(let t=r;t<e-r;t++){const e=k(a,t,r);o.push(e)}for(let t=e-r;t<e;t++)o.length<a.length&&o.push(a[t]);return o}function k(e,t,n){const s=2*n+1;let r=0;for(let s=t-n;s<=t+n;s++)r+=e[s];return Math.floor(r/s)}function L(e,t,n,s){const a=[t,n],o=e.getSubLevel(a),i=e.getFeaturesByXY(a),l=e.getCell(a);let c=!1;if(e.hasFeatureDataWith(a,"hometown")&&(c=!0,console.log("addSubLevelFeatures found xy with hometown:",a)),!i)return void(c&&r.default.err("overworld.ts","addSubLevelFeatures","isHome=true but no features found at "+a));let u=0;i.forEach(e=>{if(e===d.OW.WCAPITAL)R(e,o,s);else if(function(e,t){return!(e!==d.OW.LL_WE&&e!==d.OW.LL_NS||t!==d.OW.BTOWER&&t!==d.OW.WTOWER)}(l,e))R(e,o,s);else if(e===d.OW.BTOWER||e===d.OW.WTOWER)!function(e,t,n){let s=!1;const r=n.getMap().getFree().map(e=>e.getXY());let a=[],o=111;for(;9!==a.length&&(g.Geometry.getFreeArea(r,3,3,a)&&(s=!0),a.length<9&&(b("addTowerToSubLevel. Too few coords. Retrying."),s=!1,a=[]),!(--o<=0)););const i=e===d.OW.BTOWER?"blacktower":"whitetower";if(s){b("addTowerToSubLevel feat placed with "+JSON.stringify(a)),n.getMap().setBaseElems(a,p.ELEM.FORT);const s=new A(i,a);s.alignment=B(e),t.addFeature(s)}}(e,o,s);else if(e===d.OW.WDUNGEON)!function(e,t){const n=G(t);if(n&&n.length>0){const t=new A("dungeon",n);e.addFeature(t)}else console.log("No suitable place for Dungeon adding found!")}(o,s);else if(e===d.OW.WVILLAGE||e===d.OW.BVILLAGE){if(function(e,t,n){const s=n.getMap().getFreeNotOnEdge();if(s.length>0){const r=s.map(e=>e.getXY()),a=C().arrayGetRand(r),o=new A("village",[a]);o.alignment=B(e);const[i,l]=a;F(n,o,i,l),t.addFeature(o)}else n.debugPrintInASCII(),r.default.err("overworld.js","addVillageToSubLevel","No free cells found in the level.")}(e,o,s),c){const e=o.getFeaturesByType("village");console.log("Adding hometown tag to feature at owXY:",a),e[0].addTag("hometown")}}else if(e===d.OW.MOUNTAIN)!function(e,t){let n=!1;const s=t.getMap().getFreeNotOnEdge(),r=s.filter(e=>e.getZ()>=2).map(e=>[e.getX(),e.getY()]);if(0===r.length)return;let a=[],o=1110;for(;!n;){const e=C().arrayGetRand(r);if(a=[e],n=!0,--o<=0)break}if(n){const t=new A("mountain",a);e.addFeature(t)}}(o,s);else if(e===d.OW.VTUNNEL)!function(e,t){const n=t.getMap(),s=n.cols,r=C().getUniformInt(0,s-1);for(let e=0;e<n.rows;e++)n.setBaseElemXY(r,e,p.ELEM.FLOOR)}(0,s);else if(e===d.OW.MFORT)!function(e,t){const n=G(t,!1);if(n&&n.length>0){const s=new A("fort",n),[r,a]=n[0];F(t,s,r,a),e.addFeature(s)}}(o,s);else{b("addSubLevelFeat Skipped: "+`Base: ${l}, ${e}`),++u}}),u>0&&b(`Skipped ${u} features in addSubLevelFeatures`)}function R(e,t,n){const s=t.getWall(),a=s.getWallStart(),o=s.getWallEnd(),i=C().getUniformInt(a,o),l=s.getCoordAt(i);let c=null;switch(e){case d.OW.WTOWER:c="dwarven city";break;case d.OW.BTOWER:c="abandoned fort";break;case d.OW.WCAPITAL:c="capital";break;case d.OW.BCAPITAL:c="dark city";break;default:r.default.err("overworld.js","addMountainFortToSubLevel",`Type ${e} not supported`)}n.getMap().setBaseElems(l,p.ELEM.FORT);const u=new A(c,l);u.alignment=B(e),t.addFeature(u)}function B(e){switch(e){case d.OW.BCAPITAL:case d.OW.BTOWER:case d.OW.BVILLAGE:return r.default.ALIGN_EVIL;case d.OW.WCAPITAL:case d.OW.WTOWER:case d.OW.WVILLAGE:return r.default.ALIGN_GOOD;default:return r.default.ALIGN_NEUTRAL}}function F(e,t,n,s){const r=e.getMap();t.cellsAround=g.Geometry.getCellsAround(r,r.getCell(n,s))}function G(e,t=!0){let n=!1;const s=e.getMap();let a=s.getFree().map(e=>e.getXY());if(!t){const{cols:e,rows:t}=s;a=a.filter(n=>0!==n[0]&&n[0]!==e-1&&0!==n[1]&&n[1]!==t-1)}if(0===a.length)return[];let o=[],i=1110;for(;!n;){const e=C().arrayGetRand(a);let l=[];try{l=g.Geometry.getBoxAround(e[0],e[1],1)}catch(e){r.default.diag(e),r.default.diag(a),s.debugPrintInASCII()}if(!t){const{cols:e,rows:t}=s;l=l.filter(n=>0!==n[0]&&n[0]!==e-1&&0!==n[1]&&n[1]!==t-1)}if(l.forEach(e=>{if(!n&&s.hasXY(e[0],e[1])){s.getBaseElemXY(e[0],e[1]).getType()===S&&(o=[e],n=!0,s.setBaseElemXY(e[0],e[1],p.ELEM.FLOOR))}}),--i<=0)break}return o}function j(e,t,n,s,i,l){const c=e.getSubLevel([t,n]).getFeatures();if(0===Object.keys(c).length)return void l.addVisited([t,n]);const u=function(e,t,n,s){const a=[],o=[t,n],i=g.Geometry.getBoxAround(t,n,5);let l=!1;if(e.hasPathAt(o)){const c=e.getPathAtXY(o),u=c.findIndex(e=>e.x===t&&e.y===n);if(u>=0){const e=u+1;if(e<c.length){const t=c[e],n=r.default.getTextualDir([t.x,t.y],o),s=y.createDirNorthMsg(n);a.push(y.createLoreObj(s,"mainQuest")),l=!0}}i.forEach(e=>{s.addVisited(e),s.addXYKnownBy(o,e),s.addXYKnownBy(e,o)})}else i.forEach(t=>{if(e.hasPathAt(t)){const e=r.default.getTextualDir(t,o),n=y.createDirNorthMsg(e);a.push(y.createLoreObj(n,"mainQuest")),l=!0}s.addXYKnownBy(t,o),s.addXYKnownBy(o,t)});b(l?`${t},${n} lore was added`:`${t},${n} NO lore was added`);return a}(e,t,n,l);Object.keys(c).forEach(e=>{c[e].forEach(e=>{e.coord||r.default.err("OverWorld","createWorldConf","coord must exist. feat: "+JSON.stringify(e));let c=null;var h,d;"capital"===e.type?c=function(e,t,n){const s={name:"Blashyrkh",nQuarters:1,quarter:[{name:"Capital cave",nLevels:1,maxDanger:15}],owX:t.x,owY:t.y,maxDanger:15,maxRarity:5};s.presetLevels={"Blashyrkh.Capital cave":[{nLevel:0,level:{stub:!0,new:"Capital",args:[200,500,{}]}}]},$(e,t,s);const r={name:"Capital cave",levelX:s.levelX,levelY:s.levelY,nLevel:0,stairs:{getStairs:1}};return s.connectToAreaXY[0].stairs={getStairs:0},s.connectToAreaXY.push(r),n.nCities+=1,n.city.push(s),s}(e,s,i):"dwarven city"===e.type?c=function(e,t,n){const s={stub:!0,new:"DwarvenCity",args:[300,250,{}]},r={name:"Dwarven City",nQuarters:1,quarter:[{name:"Fort main level",nLevels:1,maxDanger:15}],owX:t.x,owY:t.y,maxDanger:15,maxRarity:7};r.presetLevels={"Dwarven City.Fort main level":[{nLevel:0,level:s}]},$(e,t,r);const a={name:"Fort main level",levelX:r.levelX,levelY:r.levelY,nLevel:0,stairs:{getStairs:1}};return r.connectToAreaXY[0].stairs={getStairs:0},r.connectToAreaXY.push(a),n.nCities+=1,n.city.push(r),r}(e,s,i):"abandoned fort"===e.type?c=function(e,t,n){const s={stub:!0,new:"AbandonedFort",args:[500,200,{}]},r={name:"Abandoned fort",maxDanger:15,nQuarters:1,quarter:[{name:"Fort ground level",nLevels:1,maxDanger:15}],owX:t.x,owY:t.y,maxRarity:7};r.presetLevels={"Abandoned fort.Fort ground level":[{nLevel:0,level:s}]},$(e,t,r,!1);const a={name:"Fort ground level",levelX:r.levelX,levelY:r.levelY,nLevel:0,stairs:{getStairs:0}};return r.connectToAreaXY[0].stairs={getStairs:1},r.connectToAreaXY.push(a),n.nCities+=1,n.city.push(r),r}(e,s,i):"dark city"===e.type||_.test(e.type)?c=U(e,s,i):"dungeon"===e.type?c=function(e,t,n){const[s,r]=H(t),i=e.coord,{x:l,y:c,aX:u,aY:h,slX:d,slY:p,subX:f,subY:m}=t;let g=Y(i[0][0],d,f),y=X(i[0][1],p,m);[g,y]=function(e){let[t,n]=e;0===t&&(t=1);t===O-1&&(t-=1);0===n&&(n=1);n===T-1&&(n-=1);return[t,n]}([g,y]);const v=a.Names.getGenericPlaceName("dungeon"),b=a.Names.getUniqueName("dungeon"),_=o.LevelGen.getDungeonConf(v);return _.uniqueName=b,Object.assign(_,{x:u,y:h,levelX:g,levelY:y,owX:l,owY:c,uniqueName:b}),n.nDungeons+=1,W(s,r,_),n.dungeon.push(_),_}(e,s,i):"mountain"===e.type?c=function(e,t,n){const[s,r]=H(t),i=e.coord,{x:l,y:c,aX:u,aY:h,slX:d,slY:p,subX:f,subY:m}=t,g=Y(i[0][0],d,f),y=X(i[0][1],p,m),v=a.Names.getUniqueName("mountain"),b=o.LevelGen.getMountainConf(v);return Object.assign(b,{x:u,y:h,levelX:g,levelY:y,owX:l,owY:c}),W(s,r,b),n.nMountains+=1,n.mountain.push(b),b}(e,s,i):"blacktower"===e.type&&(b("Adding final blacktower now"),c=function(e,t,n){const{slX:s,slY:a,aX:i,aY:l,subX:c,subY:u}=t,h=e.coord[7];if(r.default.isNullOrUndef([h])){const t="xy null/undef. feat: "+JSON.stringify(e);r.default.err("overworld.js","addBlackTowerConfToArea",t)}const d=Y(h[0],s,c),p=X(h[1],a,u),f=o.LevelGen.getDungeonConf("Elder raventhrone");Object.assign(f,{x:i,y:l,levelX:d,levelY:p});b(`BlackTower: ${i},${l}, x,y ${d},${p}`),f.connectEdges=!0,f.branch[0].entranceLevel=0,f.branch[0].nLevels=5;const m=f.branch[0].nLevels-1;return f.branch[0].createPresetLevels={stub:!1,new:"BlackTower",args:[180,90]},f.branch[0].create={actor:[{name:"Thabba, Son of Ice",nLevel:m},{name:"Zamoned, Son of Frost",nLevel:m}]},n.nDungeons+=1,n.dungeon.push(f),f}(e,s,i)),c?(d=u,(h=c).addComp?h.addComp=h.addComp.concat(d):h.addComp=d.slice(),l.addZone([t,n],c),c.uniqueName&&(c.name=c.uniqueName)):r.default.err("overworld.ts","processSubLevel",`[${t}][${n}]: No feat.type ${e.type} supported!`)})})}function W(e,t,n){const{x:s,y:a}=n,o=Math.abs(e-s),i=Math.abs(t-a),l=a<t;n.maxDanger=r.default.getMaxDanger(o,i),n.maxValue=r.default.getMaxValue(o,i),n.maxRarity=r.default.getMaxRarity(o,i,l),C().getUniform()<=r.default.EPIC_PROB&&(n.isEpic=!0,n.maxDanger*=2,n.maxValue*=3)}function Y(e,t,n){if(Number.isInteger(e)){const s=e+t*n;return s>=O&&console.warn(`WARNING mapX: ${s}, ${e}, ${t}, ${n}`),s}return r.default.err("overworld.js","mapX","x must be an integer. Got: "+e),null}function X(e,t,n){return Number.isInteger(e)?e+t*n:(r.default.err("overworld.js","mapY","y must be an integer. Got: "+e),null)}function U(e,t,n){const s=a.Names.getUniqueName("city"),i=o.LevelGen.getCityConf(s,e);return i.owX=t.x,i.owY=t.y,i.groupType=e.type,$(e,t,i),i.alignment=e.alignment||C().arrayGetRand(r.default.ALIGNMENTS),e.cellsAround&&(i.constraint||(i.constraint={}),i.constraint.cellsAround=e.cellsAround),e.hasTags()&&(i.tags=e.getTags()),n.nCities+=1,n.city.push(i),i}function $(e,t,n,s=!0){const{slX:r,slY:a,aX:o,aY:i,subX:l,subY:c}=t,u=e.coord,h=u.length-1;let d=Y(u[h][0],r,l),p=X(u[h][1],a,c);if(s||(d=Y(u[0][0],r,l)-1,p=X(u[0][1],a,c)),p>=T&&(p-=1),E.test(e.type)){let e=Y(u[0][0],r,l),t=X(u[0][1],a,c);s||(e=Y(u[h][0],r,l)+1,t=X(u[h][1],a,c));const o=n.nQuarters-1;n.connectToAreaXY=[{name:n.quarter[o].name,levelX:e,levelY:t,nLevel:0}]}n.x=o,n.y=i,n.levelX=d,n.levelY=p,b(`Feat: ${e.type}, ${o},${i} : ${d},${p}`)}function H(e){const{xMap:t,yMap:n,nSubLevelsX:s,nSubLevelsY:r}=e;return[Math.floor(s/t/2),r/n-1]}function V(e,t,n,s){const r=e*n,a=t*s;return[r,a+s-1,r+n-1,a]}t.CoordMap=x,t.OverWorld.CoordMap=x,t.OverWorld.createOverWorld=(e={})=>{const n=c.OWMap.createOverWorld(e);return t.OverWorld.createOverWorldLevel(n,e)},t.OverWorld.createOverWorldLevel=(e,n)=>{const s=new x;s.worldCols=n.worldX||400,s.worldRows=n.worldY||400,s.nTilesX=n.nTilesX||s.worldCols/O,s.nTilesY=n.nTilesY||s.worldRows/T,s.xMap=Math.floor(s.worldCols/e.getSizeX()),s.yMap=Math.floor(s.worldRows/e.getSizeY()),e.coordMap=s,w=n.addMainRoads||w;return function(e,n,s){const{worldCols:a,worldRows:o,xMap:c,yMap:u,nTilesX:p,nTilesY:f}=n,y=e.getSizeX(),v=e.getSizeY(),b=(new m.FactoryLevel).createLevel(r.default.LEVEL_EMPTY,a,o),_={};for(let t=0;t<y;t++)for(let n=0;n<v;n++){const s=P(e,t,n,c,u),a=t*c,o=n*u;g.Geometry.mergeLevels(b,s,a,o),_[r.default.toKey([t,n])]=s}h.OWBiomes.addBiomes(e,b);for(let t=0;t<y;t++)for(let n=0;n<v;n++){const s=_[r.default.toKey([t,n])],a=t*c,o=n*u;g.Geometry.copyBaseElems(b,s,a,o),L(e,t,n,s)}const E=t.OverWorld.createWorldConf(e,y,v,p,f,s);return function(e,t,n,s){const[a,o]=function(e,t){const n=Math.floor(e.getSizeX()/2-1)*O,s=t.worldRows-Math.floor(T/2);return[n,s]}(e,s),c=e.getFeaturesByType(d.OW.WCAPITAL)[0],u=e.getSubLevel(c).getFeaturesByType("capital")[0],h=u.getLastCoord(),[p,f]=s.toOwLevelXY(c,h);if(w){const e=i.Path.getWeightPathSegmented(t.getMap(),a,o,p,f,5);0===e.length&&r.default.err("overworld.js","addGlobalFeatures","No path from player to capital."),l.Builder.addPathToMap(t.getMap(),e)}const m=u.coord[0],g=s.toOwLevelXY(c,m),y=e.getFeaturesByType(d.OW.WTOWER)[0],v=e.getSubLevel(y),b=v.getFeaturesByType("dwarven city")[0].getLastCoord(),_=s.toOwLevelXY(y,b);if(w){const e=i.Path.getWeightPathSegmented(t.getMap(),g[0],g[1],_[0],_[1],5);l.Builder.addPathToMap(t.getMap(),e)}}(e,b,0,n),[b,E]}(e,s,n)},t.OverWorld.createWorldConf=function(e,t,n,s,a,o){const i={name:"The North",nAreas:1,area:[{cols:100,rows:100,name:"The Northern Realm",maxX:s,maxY:a,biome:{},dungeon:[],mountain:[],city:[],nDungeons:0,nMountains:0,nCities:0}]},l=i.area[0];if(!t||!n){const e=`levels in X: ${t}, Y: ${n}`;r.default.err("OverWorld","createWorldConf","Illegal num of sublevels: "+e)}const c=t/s,h=n/a;b(`nSubLevelsX: ${t}, nTilesX: ${s}`),b(`nSubLevelsY: ${n}, nTilesY: ${a}`),b(`MapX: ${c} levels to one tile`),b(`MapY: ${h} levels to one tile`),Number.isInteger(c)||r.default.err("OverWorld","createWorldConf",`xMap not int: ${c}, sub X :${t}, nTilesX: ${s}`),Number.isInteger(h)||r.default.err("OverWorld","createWorldConf",`yMap not int: ${h}, sub Y :${n}, nTilesY: ${a}`);const d=Date.now(),p=new u.OWLore;for(let s=0;s<t;s++)for(let r=0;r<n;r++){const a=s%c,o=r%h,i=Math.floor(s/c),u=Math.floor(r/h),d=e.getSubLevel([s,r]),f={xMap:c,yMap:h,nSubLevelsX:t,nSubLevelsY:n,x:s,y:r,slX:a,slY:o,aX:i,aY:u,subX:d.getSubX(),subY:d.getSubY()};b(`Processing subLevel[${s}][${r}] with ${JSON.stringify(f)}`),j(e,s,r,f,l,p)}p.buildLore();const f=Date.now()-d;return console.log("overworld.ts Processing subLevels took "+f+" ms"),function(e,t){const n=e.getSizeX(),s=e.getSizeY(),r=n/t.maxX,a=s/t.maxY;t.biome||(t.biome={});for(let n=0;n<t.maxX;n++)for(let s=0;s<t.maxY;s++){const o=V(n,s,r,a),i=n+","+s,l=e.getBiome(o[0],o[3]);t.biome[i]=l}}(e,l),i}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GameMain=t.Game=void 0;const i=o(n(4)),l=n(55),c=n(374),u=n(23),h=n(792),d=n(794),p=n(135),f=n(87),m=n(9),g=n(13),y=n(167),v=a(n(11)),b=a(n(45)),_=n(26),E=n(12),S=u.EventPool.getPool();t.Game={};t.GameMain=class{constructor(){this.hasNotify=!0,this.debugEnabled=!1,this.notify=this.notify.bind(this),this._players=[],this._places={},this._shownLevel=null,this._gameOver=!1,this.actorsKilled={},this.gameID=Date.now(),this._enableChunkUnload=!1,this._chunkManager=null,this._eventPool=S,S.reset(),this.currPlaceIndex=0,this._rng=new m.Random,this._engine=new h.Engine(this._eventPool),this._master=new d.GameMaster(this,this._eventPool),this._worldSim=new y.WorldSimulation(this._eventPool),this._engine.addRegularUpdate(this._worldSim),this._engine.setSystemArgs({worldSim:this._worldSim}),this.visibleCells=[],this.globalConf={},this._engine.playerCommandCallback=this.playerCommandCallback.bind(this),this._engine.isGameOver=this.isGameOver.bind(this),this._eventPool.listenEvent(i.default.EVT_ACTOR_KILLED,this),this._eventPool.listenEvent(i.default.EVT_LEVEL_CHANGED,this),this._eventPool.listenEvent(i.default.EVT_TILE_CHANGED,this),this._eventPool.listenEvent(i.default.EVT_TILE_ENTERED,this),this._eventPool.listenEvent(i.default.EVT_TILE_LEFT,this)}setGlobalConf(e){this.globalConf=e}getGlobalConf(){return this.globalConf}shownLevel(){return this._shownLevel}setShownLevel(e){this._shownLevel=e,this._worldSim.setLevel(e)}setGameOver(e){this._gameOver=e}addDebugTraceID(e){this._engine.addDebugTraceID(e)}getPool(){return this._eventPool}getMsgHistory(){return this._engine.getMsgHistory()}getTimeOfDayMins(){return this._worldSim.getTimeOfDayMins()}setGUICallbacks(e,t){this._engine.isGUICommand=e,this._engine.doGUICommand=t;const n=this.getPlayer();n&&n.getBrain().addGUICallback("GOTO",t)}setRNG(e){this._rng=e,m.Random.setRNG(this._rng),this._engine.setRNG(e)}playerCommandCallback(e){this.visibleCells=e.getBrain().getSeenCells(),this._engine.setVisibleArea(this.shownLevel(),this.visibleCells)}isGameOver(){return this._gameOver}getLevels(){return this._engine.getLevels()}getComponents(){return this._engine.getComponents()}getPlaces(){return this._places}getLevelsInAllPlaces(){let e=[];return Object.values(this._places).forEach(t=>{e=e.concat(t.getLevels())}),e}setEnableChunkUnload(e=!0){if(this._enableChunkUnload=e,e&&this.getArea(0)){const e=this.getArea(0);this._chunkManager=new c.ChunkManager(this,e)}}getPlayer(){return this._engine.getPlayer()}addPlayer(e,t){let n=!1;return this._master.setPlayer(e),n=!i.default.isNullOrUndef([e.getLevel()])||(i.default.isNullOrUndef([t])?this._addPlayerToFirstLevel(e,this.getLevels()):this._addPlayerToPlace(e,t)),n&&(this._engine.nextActor=e,this._engine.setPlayer(e),null===this._shownLevel&&this.setShownLevel(e.getLevel()),this._players.push(e),this._engine.addActiveLevel(e.getLevel()),e.getLevel().onEnter(),e.getLevel().onFirstEnter()),n&&this._gameOver&&(this._gameOver=!1),n}useAsPlayer(e){let t=e;Number.isInteger(e)&&(t=i.default.ent(e)),t||(t=i.default.CLICKED_ACTOR),t&&(t.setIsPlayer(!0),t.add(new v.Player),this.addPlayer(t))}movePlayer(e,t,n=0,s=0){const r=this.getPlayer(),a=this.getCurrentWorld().getAreas()[0];let o=null;this._enableChunkUnload?this._chunkManager?(this._chunkManager.isLoaded(e,t)||this._chunkManager.setPlayerTile(e,t,null,null),o=a.getTileXY(e,t)):i.default.err("GameMain","movePlayer","chunkUnload enabled, but no chunkManager created"):o=a.getTileXY(e,t);const l=o.getLevel(),c=r.getLevel(),[u,h]=[r.getX(),r.getY()];c.removeActor(r)?l.addActor(r,n,s)||l.addActorToFreeCell(r)?(S.emitEvent(i.default.EVT_LEVEL_CHANGED,{target:l,src:c,actor:r}),S.emitEvent(i.default.EVT_LEVEL_ENTERED,{actor:r,target:l})):c.addActor(r,u,h):console.error("Could not remove player from level")}_addPlayerToFirstLevel(e,t){let n=!1;return t.length>0?(n=t[0].addActorToFreeCell(e),n?this.checkIfTileChanged({actor:e,src:null,target:t[0]}):i.default.err("Game","addPlayer","Failed to add the player.")):i.default.err("Game","addPlayer","No levels exist. Cannot add player."),n}_addPlayerToPlace(e,t){if(t.hasOwnProperty("place")){const n=t.place;if(this._places.hasOwnProperty(n))if(t.hasOwnProperty("x")&&t.hasOwnProperty("y")){const s=this._places[n];if("world"===s.getType()){const n=s.getAreas()[0];if(n.isLoaded(t.x,t.y)){const s=[n.getTileXY(t.x,t.y).getLevel()];return this._addPlayerToFirstLevel(e,s)}i.default.err("GameMain","_addPlayerToPlace","Tried to add player to unloaded tile @"+t)}else i.default.err("GameMain","_addPlayerToPlace","Tried to add player to non-world: "+s.toJSON())}else{const t=this._places[n];if(t.getLevels){const n=t.getLevels();return this._addPlayerToFirstLevel(e,n)}}else i.default.err("GameMain","_addPlayerToPlace","No place |"+n+"| found.")}else i.default.err("GameMain","_addPlayerToPlace","obj.place must exist.");return!1}checkIfTileChanged(e){const{actor:t,src:n,target:s}=e,r=[s];i.default.isNullOrUndef([n])||r.push(n);const a=this.getArea(0);a&&2===r.length&&a.hasTiles(r)&&S.emitEvent(i.default.EVT_TILE_CHANGED,{actor:t,target:s,src:n}),this.isTileLevel(s)?S.emitEvent(i.default.EVT_TILE_ENTERED,{actor:t,target:s,src:n}):this.isTileLevel(n)&&S.emitEvent(i.default.EVT_TILE_LEFT,{actor:t,target:s,src:n})}isTileLevel(e){const t=this.getArea(0);return!!t&&t.hasTiles([e])}checkIfExploredZoneLeft(e){const{actor:t,src:n,target:s}=e;let r=!1;if(t.has("GameInfo")&&n&&s){const e=n.getParent();if(e)if(e.getID){const n=e.getID();t.get("GameInfo").hasZone(n)&&(r=this.isTileLevel(s))}else i.default.warn("GameMain","checkIfExploredZoneLeft","No getID: "+JSON.stringify(e))}r&&S.emitEvent(i.default.EVT_EXPLORED_ZONE_LEFT,{actor:t,target:s,src:n})}getMessages(){return this._engine.getMessages()}clearMessages(){this._engine.clearMessages()}hasNewMessages(){return this._engine.hasNewMessages()}addActor(e){this._engine.addActor(e)}removeActor(e){this._engine.removeActor(e)}addEvent(e){this._engine.addEvent(e)}addActiveLevel(e){this._engine.addActiveLevel(e)}addLevel(e){this._engine.hasLevel(e)?this.errorDuplicateLevel("addLevel",e):this._engine.addLevel(e)}addLevelUnlessExists(e){this._engine.hasLevel(e)||this._engine.addLevel(e)}removeLevels(e){this._engine.removeLevels(e)}addPlace(e){if("function"==typeof e.getLevels){const t=e.getName();if(this._places.hasOwnProperty(t))i.default.err("GameMain","addPlace","A place |"+t+"| exists.");else{const n=e.getLevels();if(n.length>0)for(const e of n)this.addLevel(e);else i.default.err("GameMain","addPlace",`Place ${t} has no levels!`);if(this._places[t]=e,this._engine.setSystemArgs({worldTop:e}),this.getArea(0)){const e=this.getCurrentWorld();if(e){const t=e.getCurrentArea();this._enableChunkUnload&&!this._chunkManager&&(this._chunkManager=new c.ChunkManager(this,t))}}}}else i.default.err("GameMain","addPlace","Added place must have getLevels()")}hasPlaces(){return Object.keys(this._places).length>0}getVisibleMap(){const e=this.getPlayer();return e?e.getLevel().getMap():this._engine.getFirstActiveLevel().getMap()}simulate(e){this.simulateGame(e)}simulateGame(e){this._engine.timeOfDay=this.getTimeOfDayMins(),this._worldSim.setLevel(this._engine.getFirstActiveLevel()),this._engine.simulateGame(e)}update(e){this._engine.timeOfDay=this.getTimeOfDayMins(),this._worldSim.setLevel(this.getPlayer().getLevel()),this._engine.update(e)}getArea(e){const t=this.getCurrentWorld();return t&&"function"==typeof t.getAreas?t.getAreas()[e]:null}notify(e,t){if(this.dbg(`Received event ${e} with args`,t),e===i.default.EVT_ACTOR_KILLED){if(this.actorsKilled[t.actor.getID()]=!0,t.actor.isPlayer()){const{actor:e}=t,n=this._players.indexOf(e);n>=0?(1===this._players.length&&(this.dbg("Setting the game to be over now"),this._gameOver=!0,i.default.gameMsg("GAME OVER!"),this._engine.getPlayer()),this._players.splice(n,1)):i.default.err("Game","notify","No player found from list: "+JSON.stringify(this._players))}}else if(e===i.default.EVT_LEVEL_CHANGED){const{actor:e}=t;e.isPlayer()&&(this.setShownLevel(e.getLevel()),this._overworld&&this._worldSim.setOwPos(this.getPlayerOwPos()),this.checkIfTileChanged(t),this.checkIfExploredZoneLeft(t))}else if(e===i.default.EVT_TILE_CHANGED){const{actor:e,target:n}=t;if(e.isPlayer()){const e=n.getID(),s=this.getCurrentWorld();if(s&&s.getAreas){const n=s.getAreas()[0],[r,a]=n.findTileXYById(e),o=new f.FactoryWorld;o.setGlobalConf(this.getGlobalConf());let i=null,l=null;if(t.src){const e=n.findTileXYById(t.src.getID());e&&([i,l]=e)}this._enableChunkUnload&&this._chunkManager.setPlayerTile(r,a,i,l),o.createZonesForTile(s,n,r,a);s.getLevels().forEach(e=>{this.addLevelUnlessExists(e)})}}}else e===i.default.EVT_TILE_ENTERED?this._worldSim.setUpdateRates(30):e===i.default.EVT_TILE_LEFT&&this._worldSim.setUpdateRates(5)}addBattle(e,t=-1,n=!1){const s=e.getLevel();this.addLevel(s),n&&this._engine.addActiveLevel(s),this.hasPlaces()&&t>-1&&this._addBattleZoneToArea(e,t)}_addBattleZoneToArea(e,t){const n=e.getLevel(),s="Zone of "+e.getName(),r=new b.BattleZone(s);r.addLevel(n);const a=this.getCurrentWorld().getAreas()[0],o=a.findTileXYById(t);o?(r.setTileXY(o[0],o[1]),a.addZone("BattleZone",r)):i.default.err("GameMain","_addBattleZoneToArea",`ID ${t} not found in area.`)}getChunkManager(){return this._chunkManager}getGameMaster(){return this._master}setGameMaster(e){this._master=e,this._master.setPlayer(this.getPlayer());const t=this.getCurrentWorld();t?(this._master.setWorld(t),this._master.setGame(this)):i.default.warn("GameMain","setGameMaster","Cannot set gameMaster without existing world")}getOverWorld(){return this._overworld}setOverWorld(e){this._overworld=e,this._worldSim.setOverWorld(e),this._engine.setSystemArgs({owMap:e})}setWorldSim(e){e.setPool(this._eventPool),this._engine.addRegularUpdate(this._worldSim),this._worldSim=e,this._engine.setSystemArgs({worldSim:this._worldSim})}updateEventPoolRefs(){this._worldSim.setPool(this._eventPool)}toJSON(){const e=E.ObjectShell.getParser(),t={gameID:this.gameID,gameOver:this._gameOver,engine:this._engine.toJSON(),gameMaster:this._master.toJSON(),gameObjectID:p.GameObject.ID,lastComponentID:v.getIDCount(),globalConf:this.globalConf,rng:this._rng.toJSON(),diceRng:_.Dice.RNG.toJSON(),charStyles:i.default.charStyles,cellStyles:i.default.cellStyles,actorsKilled:this.actorsKilled,enableChunkUnload:this._enableChunkUnload,objectShellParser:e.toJSON()};if(this.hasPlaces()){const e={};Object.keys(this._places).forEach(t=>{const n=this._places[t];e[t]=n.toJSON()}),t.places=e}else{const e=[];this._engine.getLevels().forEach(t=>{e.push(t.toJSON())}),t.levels=e,t.places={}}const n=this.getPlayer();return n&&(t.player=n.toJSON()),this._overworld&&(t.overworld=this._overworld.toJSON()),this._chunkManager&&(t.chunkManager=this._chunkManager.toJSON()),this._worldSim&&(t.worldSim=this._worldSim.toJSON()),t}isMenuShown(){return this._engine.isMenuShown()}getMenu(){const e=this.getPlayer();return e?e.getBrain().getMenu():null}setAnimationCallback(e){"function"==typeof e?this._engine.animationCallback=e:i.default.warn("GameMain","setAnimationCallback","Callback must be a function.")}hasAnimation(){return this._engine.hasAnimation()}finishAnimation(){return this._engine.finishAnimation()}getAnimationFrame(){return this._engine.animation?this._engine.animation.nextFrame():null}enableAnimations(){this._engine.enableAnimations()}disableAnimations(){this._engine.disableAnimations()}getPlayerOwPos(){const e=this.getPlayer(),t=this.getCurrentWorld();if(!this._overworld||!e||!t)return null;const n=this._overworld;let s=t.getAreas()[0].findTileXYById(e.getLevel().getID()),[r,a]=e.getXY();if(!s){if(s=this.tryToGetTileXY(),!s)return null;r=50,a=50}const{xMap:o,yMap:i}=n.coordMap,l=100*s[0]+r,c=100*s[1]+a;return[Math.floor(l/o),Math.floor(c/i)]}tryToGetTileXY(){let e=this.getPlayer().getLevel().getParent();for(;e;)if(e=e.getParent?e.getParent():null,e&&e.getTileXY)return e.getTileXY();return null}setOverWorldExplored(e){g.Geometry.getBoxAround(e[0],e[1],1,!0).forEach(e=>{this._overworld.setExplored(e)})}getCurrentWorld(){const e=Object.values(this.getPlaces());if(e.length>this.currPlaceIndex){const t=e[this.currPlaceIndex];if("world"===t.getType())return t}return null}find(e,t=-1,n="find"){const s=this._engine.getLevels();if(-1===t){return this.getPlayer().getLevel().getActors()[n](e)}if(Number.isInteger(t)){const r=s.find(e=>e.getID()===t);if(r)return r.getActors()[n](e)}else for(const t of s){const s=t.getActors()[n](e);if(s)return s}return null}errorDuplicateLevel(e,t){const n=t.getParent(),s=t.toJSON();delete s.elements,delete s.map.cells;let r="";if(n){r=`Parent: ${i.default.formatLocationName(t)}| `}r+="Duplicate level ID "+t.getID(),r+=" JSON: "+JSON.stringify(s,null,1),i.default.err("GameMain",e,r)}entityPrint(){i.default.diag(l.Entity.num)}dbg(...e){this.debugEnabled&&console.log("[Game DEBUG]: ",...e)}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemQuest=void 0;const i=o(n(4)),l=n(12),c=n(14),u=a(n(11)),h=n(57),d=l.ObjectShell.getParser();class p extends c.SystemBase{constructor(e,t){super(i.default.SYS.QUEST,e,t),this.compTypesAny=!0,this._eventTable={battle:this.onBattleEvent=this.onBattleEvent.bind(this),damage:this.onDamageEvent=this.onDamageEvent.bind(this),escort:this.onEscortEvent=this.onEscortEvent.bind(this),get:this.onGetEvent=this.onGetEvent.bind(this),give:this.onGiveEvent=this.onGiveEvent.bind(this),goto:this.onGotoEvent=this.onGotoEvent.bind(this),kill:this.onKillEvent=this.onKillEvent.bind(this),listen:this.onListenEvent=this.onListenEvent.bind(this),read:this.onReadEvent=this.onReadEvent.bind(this),report:this.onReportEvent=this.onReportEvent.bind(this)}}static addQuestEvent(e,t,n,s={}){const r=new u.QuestTargetEvent;r.setArgs(s),r.setEventType(n),r.setTargetComp(t),e.add(r)}updateEntity(e){if(e.has("GiveQuest")){const t=e.get("GiveQuest");this.processGiveQuestComp(e,t),e.remove(t)}if(e.has("QuestCompleted")){const t=e.get("QuestCompleted");this.processComplComp(e,t),e.remove(t)}if(e.has("QuestTargetEvent")){const t=e.get("QuestTargetEvent");this.processQuestEvent(e,t),e.remove(t)}}processGiveQuestComp(e,t){const n=t.getGiver(),s=n.get("QuestGiver");if(s.getHasGivenQuest())return;const r=s.getQuestTargets(),a=new u.Quest;a.setQuestID(s.getQuestID()),0===r.length&&i.default.err("SystemQuest","processGiveQuestComp","No keys in questData, giver: "+n.getName),r.forEach(e=>{const t=Object.assign({},e);t.isCompleted=!1,a.addTarget(t)}),s.giveQuest(e),a.setGiver({name:n.getName(),id:n.getID()}),a.setDescr(s.getDescr()),e.add(a),this.checkQuestMsgEmits(e,a)}checkQuestMsgEmits(e,t){const n=e.getLevel(),s=t.first("location");let r=`You accept the quest from ${t.getGiver().name}.`;s&&(n.getID()===s.id?(r+=" You are already in the first quest location",this.setTargetCompleted(s,t)):r+=" You should try to get to the first quest location"),f({cell:e.getCell(),msg:r})}processComplComp(e,t){const n=t.getGiver(),s=n.get("QuestGiver").getQuestID();if(e.getList("Quest").find(e=>e.getQuestID()===s).isCompleted()){const t=n.get("QuestGiver"),s=t.getQuestTargets().length,r=t.getDanger()*s,a=new u.ExpPoints(r);e.add(a),this.giveQuestReward(e,n,t),h.emitZoneEvent(n.getLevel(),i.default.ZONE_EVT.QUEST_COMPLETED,{questGiver:n})}else i.default.gameDanger({cell:e.getCell(),msg:"Quest is not completed!"})}giveQuestReward(e,t,n){if(n.hasReward())if(n.getHasGivenReward()){const t="Reward has already been given!";f({cell:e.getCell(),msg:t})}else{n.setHasGivenReward(!0);const s=n.getReward();let r=null;if("item"===s.type){const t=s.name;if(r=d.createItem(t),r){let t=`${e.getName()} receives ${r.getName()} as`;t+=" a reward for completing the quest",f({cell:e.getCell(),msg:t})}}else"generate"===s.type&&(r=this.generateQuestRewardItem(e,n,t));r&&e.getInvEq().getInventory().addItem(r)}}generateQuestRewardItem(e,t,n){const s=e.getInvEq().getEquipment().getFreeSlotTypes(),[r,a]=function(e){switch(e){case 1:return[75,150];case 2:return[90,190];case 3:return[100,220];case 4:return[120,250];default:return[120+30*(e-4),250+30*(e-4)]}}(t.numTargets()),o=e=>e.value>=r&&e.value<=a;if(s.length>0){const e=this.rng.arrayGetRand(s);let t=t=>t.armourType===e&&o(t),n=d.createRandomItem({func:t});if(n)return n;if("hand"===e?t=e=>o(e)&&"weapon"===e.type:"spiritgem"===e?t=e=>o(e)&&"spiritgem"===e.type:"missile"===e?t=e=>o(e)&&("missile"===e.type||"ammo"===e.type):"missileweapon"===e&&(t=e=>o(e)&&"missileweapon"===e.type),n=d.createRandomItem({func:t}),n)return n}else{const e=e=>o(e)&&("rune"===e.type||"potion"===e.type),t=d.createRandomItem({func:e});if(t)return t}return null}processQuestEvent(e,t){const n=t.getEventType(),s=e.getList("Quest");if("function"==typeof this._eventTable[n])s.forEach(s=>{(function(e,t){const n=e.getTargetComp();return t.isInThisQuest(n)})(t,s)&&this._eventTable[n](e,t,s)});else{const e=Object.keys(this._eventTable);i.default.err("SystemQuest","processQuestEvent",`No function for ${n} in eventTable. Found: ${e}`)}}onBattleEvent(e,t,n){const s=t.getArgs(),r=t.getTargetComp(),a=r.getTarget(),o=r.getTargetType(),i=function(e,t){const n=e.getQuestTargets();return n.find(e=>e.id===t.getID())}(n,a);if("winbattle"===o){if(s.isWon){this.setTargetCompleted(i,n);let t=e.getName()+" has won a battle as ";t+="as a quest objective!",f({cell:e.getCell(),msg:t})}}else if("finishbattle"===o){this.setTargetCompleted(i,n);let t=e.getName()+" has finished a battle as ";t+="as a quest objective!",f({cell:e.getCell(),msg:t})}}onDamageEvent(e,t,n){const s=t.getTargetComp().getTarget(),r=n.getQuestTargets().find(e=>e.id===s.getID());this.setTargetCompleted(r,n);let a=e.getName()+" has finished a quest objective ";a+="to damage "+s.getDamage(),f({cell:e.getCell(),msg:a})}onEscortEvent(e,t,n){const s=t.getTargetComp().getTarget(),r=n.getQuestTargets().find(e=>e.id===s.getID());this.setTargetCompleted(r,n);let a="";const o=e.getLevel().getParentZone();o&&(a=" to "+o.getName());let i=`${e.getName()} has escorted ${s.getName()} `;i+=`safely back${a} as a quest objective!`,f({cell:e.getCell(),msg:i})}onGetEvent(e,t,n){const s=t.getTargetComp().getTarget(),r=n.getQuestTargets().find(e=>e.id===s.getID());this.setTargetCompleted(r,n);let a=`${e.getName()} has found ${s.getName()} `;a+="as a quest objective!",f({cell:e.getCell(),msg:a})}onGiveEvent(e,t,n){const s=t.getArgs(),{actor:r,item:a}=s,o=n.getQuestTargets().find(e=>e.id===r.getID());this.setTargetCompleted(o,n);let i=`${e.getName()} has given ${a.getName()} `;i+=`to ${r.getName()} as quest objective!`,f({cell:e.getCell(),msg:i})}onGotoEvent(e,t,n){const s=t.getTargetComp().getTarget(),r=n.getQuestTargets().find(e=>e.id===s.getID());if(!r.isCompleted){this.setTargetCompleted(r,n);const t=e.getName()+" has arrived to a quest target location!";f({cell:e.getCell(),msg:t})}}onKillEvent(e,t,n){const s=t.getArgs();if(s&&s.corpse){const r=t.getTargetComp().getTarget();this.moveQuestTargetComp(r,s.corpse);const a=n.getQuestTargets().find(e=>e.id===r.getID());this.setTargetCompleted(a,n);let o=e.getName()+" has reached quest target of killing";o+=` ${r.getName()}.`,f({cell:e.getCell(),msg:o})}else i.default.err("SystemQuest","onKillEvent","Args must contain |corpse|. Got: "+JSON.stringify(s))}onListenEvent(e,t,n){const s=t.getArgs();if(s&&s.info){const t=s.info.getInfo(),r=s.src;e.add(s.info.clone());const a=r.getID(),o=n.getQuestTargets().find(e=>e.id===a);this.setTargetCompleted(o,n);f({msg:`${r.getName()} tells about ${t}`,cell:e.getCell()})}else i.default.err("SystemQuest","onListenEvent","Args must contain |info|. Got: "+JSON.stringify(s))}onReadEvent(e,t,n){const s=t.getTargetComp().getTarget(),r=n.getQuestTargets(),a=r.find(e=>e.id===s.getID());this.setTargetCompleted(a,n);const o=s.getMetaData("place");if(o){const t=o[0];if(t.levelID===e.getLevel().getID()){const e=r.find(e=>e.id===t.levelID&&!e.isCompleted);this.setTargetCompleted(e,n)}else{let n=e.getName()+" learns to travel to ";n+=t.placeName+" as part of the quest.",f({cell:e.getCell(),msg:n})}}}onReportEvent(e,t,n){const s=n.getQuestTargets(),r=t.getTargetComp(),a=r.getTarget(),o=a.getName();let i=!1;if(a.has("QuestReport")){const l=a.get("QuestReport"),c=t.getArgs().info;if(c)if(l.getExpectInfoFrom()===c.getGivenBy())i=!0;else{const t=o+" is not interested in this info";f({cell:e.getCell(),msg:t})}else if(n.isTargetInQuest(r)){i=s.filter(e=>e.id!==a.getID()).reduce((e,t)=>e&&t.isCompleted,!0)}}if(i){const t=s.find(e=>e.id===a.getID()),r=`${e.getName()} reports info to ${o}`;f({cell:e.getCell(),msg:r}),this.setTargetCompleted(t,n)}}moveQuestTargetComp(e,t){try{const n=e.get("QuestTarget");n.changeEntity(t),n.setIsCompleted(!0),n.setTarget(t)}catch(t){console.log("srcEnt is",e),console.log(t.message)}}setTargetCompleted(e,t){const n=t.getEntity();if(!1===e.isCompleted)e.isCompleted=!0;else{let n="targetObj: "+JSON.stringify(e);n+="targetQuest: "+JSON.stringify(t),i.default.err("SystemQuest","setTargetCompleted","Tried to set completed quest to completed again: "+n)}if(t.isCompleted()){let e=n.getName()+" has completed a quest!";e+=" now it is time to go collect the reward.",f({cell:n.getCell(),msg:e}),this.checkSubQuestCompletion(n,t)}}checkSubQuestCompletion(e,t){const n=t.getQuestID();e.getList("Quest").forEach(e=>{e.getTargetsByType("subquest").forEach(e=>{e.subQuestID===n&&(e.isCompleted=!0)})})}}function f(e){i.default.gameInfo(e)}t.SystemQuest=p},function(e,t,n){e.exports={default:n(738),__esModule:!0}},function(e,t){String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=o(n(1)),a=o(n(255));function o(e){return e&&e.__esModule?e:{default:e}}t.default=(0,a.default)((function(e,t,n,a,o){var i=e[t],l=void 0===i?"undefined":s(i);return r.default.isValidElement(i)?new Error("Invalid "+a+" `"+o+"` of type ReactElement supplied to `"+n+"`, expected a ReactComponent or a DOMElement. You can usually obtain a ReactComponent or DOMElement from a ReactElement by attaching a ref to it."):"object"===l&&"function"==typeof i.render||1===i.nodeType?null:new Error("Invalid "+a+" `"+o+"` of value `"+i+"` supplied to `"+n+"`, expected a ReactComponent or a DOMElement.")})),e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,r=n(41);var a=function(){};((s=r)&&s.__esModule?s:{default:s}).default&&(a=document.addEventListener?function(e,t,n,s){return e.removeEventListener(t,n,s||!1)}:document.attachEvent?function(e,t,n){return e.detachEvent("on"+t,n)}:void 0),t.default=a,e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Damage=t.Defense=t.DurationRoll=t.DamageRoll=t.Typed=t.Mixin=void 0;const r=s(n(4)),a=n(26);t.Mixin={},t.Typed=function(e){return class extends e{constructor(...e){super(...e),this.type=e.length>0?e[0].type:"",this._propType=e.length>0?e[0].propType:""}getPropType(){return this._propType}getType(){return this.type}setPropType(e){r.default.PROP_TYPES.indexOf(e)>=0?this._propType=e:r.default.err("Object.Typed","setPropType","Unknown prop type: |"+e+"|")}setType(e){this.type=e,r.default.nullOrUndefError("Object.Typed: setType","arg |type|",e)}}},t.DamageRoll=e=>class extends e{constructor(e){super(e),this.damageDie=a.Dice.create("1d4")}rollDamage(){if(this.getEntity().hasOwnProperty("getWeapon")){const e=this.getEntity().getWeapon();if(null!==e)return e.rollDamage()}return this.damageDie.roll()}getDamageDie(){return this.damageDie}setDamageDie(e){this.damageDie="string"==typeof e?a.Dice.create(e):e}copy(e){super.copy(e),this.damageDie=e.getDamageDie().clone()}toJSON(){const e=super.toJSON();return e.setDamageDie=this.damageDie.toString(),e}},t.DurationRoll=e=>class extends e{constructor(e){super(e)}rollDuration(){return this.duration.roll()}setDurationDie(e){this.duration="string"==typeof e?a.Dice.create(e):e}getDurationDie(){return this.duration}copy(e){super.copy(e),this.duration=e.getDurationDie().clone()}toJSON(){const e=super.toJSON();return e.setDurationDie=this.duration.toString(),e}},t.Defense=e=>class extends e{constructor(e){super(e),this._attack=1,this._defense=1,this._protection=0}getAttack(){return this._attack}setAttack(e){this._attack=e}getDefense(){return this._defense}setDefense(e){this._defense=e}getProtection(){return this._protection}setProtection(e){this._protection=e}copy(e){super.copy(e),this.setAttack(e.getAttack()),this.setDefense(e.getDefense()),this.setProtection(e.getProtection())}equals(e){let t=super.equals(e);return t&&(t=this.getAttack()===e.getAttack()&&this.getDefense()===e.getDefense()&&this.getProtection()===e.getProtection()),t}toString(){let e=super.toString();return e+=` A: ${this.getAttack()}, D: ${this.getDefense()}, `,e+=` P: ${this.getProtection()}, `,e}toJSON(){const e=super.toJSON();return e.setAttack=this.getAttack(),e.setDefense=this.getDefense(),e.setProtection=this.getProtection(),e}},t.Damage=e=>class extends(t.Defense(e)){constructor(e){super(e),this._damageDie=new a.Dice(1,4,0),this._range=1}setAttackRange(e){this._range=e}getAttackRange(){return this._range}rollDamage(){if(this.hasOwnProperty("getWeapon")){const e=this.getWeapon();if(!r.default.isNullOrUndef([e]))return e.rollDamage()}return this._damageDie.roll()}getDamageDie(){return this._damageDie}setDamageDie(e){this._damageDie=a.Dice.getDice(e)}copy(e){super.copy(e),this.setAttackRange(e.getAttackRange());const t=e.getDamageDie().clone();this.setDamageDie(t)}equals(e){let t=super.equals(e);return t&&(t=this.getDamageDie().equals(e.getDamageDie()),t=t&&this.getAttackRange()===e.getAttackRange()),t}toString(){let e=super.toString();return e+="Dmg: "+this.getDamageDie().toString(),e+=", R:"+this.getAttackRange(),e}toJSON(){const e=super.toJSON();return e.setAttackRange=this.getAttackRange(),e.setDamageDie=this.getDamageDie().toString(),e}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BrainBase=void 0;const r=s(n(4));t.BrainBase=class{constructor(e){r.default.isNullOrUndef([e])&&r.default.err("BrainSentient","constructor","Actor must not be null."),this._actor=e,this._type=null}setActor(e){this._actor=e}getActor(){return this._actor}getType(){return this._type}setType(e){this._type=e}getMemory(){return null}getSeenCells(){return[]}findEnemyCell(e){return null}findFriendCell(e){return null}canMeleeAttack(e,t){return!1}canSeeActor(e){return!1}getSeenFriends(){return[]}getSeenEnemies(){return[]}decideNextAction(e){return r.default.err("BrainBase","decideNextAction","Not implemented. Do in derived class"),null}toJSON(){return{type:this._type}}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameObject=void 0;class s{constructor(){this.$objID=s.ID++}static createObjectID(){return s.ID++}getID(){return this.$objID}setID(e){this.$objID=e}getObjRef(){return{$objRef:{type:"object",id:this.$objID}}}}t.GameObject=s,s.ID=1},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Scheduler=t.OneShotEvent=t.RegenPPEvent=t.RegenEvent=t.GameEvent=t.Action=void 0;const r=s(n(266)),a=s(n(4)),o=r.default.Action;class i{constructor(e,t){this._duration=e,this._cb=t,this._energy=0}setEnergy(e){this._energy=e}getEnergy(){return this._energy}getDuration(){return this._duration}doAction(){this._cb()}}t.Action=i;class l{constructor(e,t,n,s){this.isEvent=!0,this.dur=e,this.cb=t,this._repeat=n,this._offset=s,this._level=null}isPlayer(){return!1}nextAction(){return new i(this.dur,this.cb)}getRepeat(){return this._repeat}setRepeat(e){this._repeat=e}getOffset(){return this._offset}setOffset(e){this._offset=e}setLevel(e){this._level=e}getLevel(){return this._level}}t.GameEvent=l;t.RegenEvent=class extends l{constructor(e,t){super(t,()=>{e.get("Health").addHP(1)},!0,0)}};t.RegenPPEvent=class extends l{constructor(e,t){super(t,()=>{e.get("SpellPower").addPP(1)},!0,0)}};t.OneShotEvent=class extends l{constructor(e,t,n){super(0,()=>{a.default.isNullOrUndef([n])||a.default.gameMsg(n),e()},!1,t)}};t.Scheduler=class{constructor(){this._scheduler=new o,this._scheduler._defaultDuration=0,this._scheduler._duration=0,this._events=[],this._actors=[]}add(e,t,n){if(this._scheduler.add(e,t,n),e.hasOwnProperty("isEvent"))this._events.push(e);else{this._actors.indexOf(e)<0?this._actors.push(e):a.default.err("Scheduler","add","Tried to add actor second time: "+JSON.stringify(e))}}next(){return this._scheduler.next()}setAction(e){this._scheduler.setDuration(e.getDuration())}remove(e){if(e.hasOwnProperty("isEvent"))return this.removeEvent(e);{const t=this._actors.indexOf(e);-1!==t&&this._actors.splice(t,1)}return this._scheduler.remove(e)}removeEvent(e){let t=-1;return e.hasOwnProperty("isEvent")&&(t=this._events.indexOf(e),-1!==t&&this._events.splice(t,1)),this._scheduler.remove(e)}getTime(){return this._scheduler.getTime()}printIDs(){this._actors.forEach(e=>{})}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ObjectShellComps=void 0;const i=o(n(4)),l=a(n(11)),c=n(9),u=n(26),h=n(15)("bitn:objectshellcomps"),d=c.Random.getRNG();t.ObjectShellComps=class{constructor(e){this.debug=h.enabled,e&&e.debug&&(this.debug=e.debug)}addComponents(e,t){if("string"==typeof e.addComp)this._addCompFromString(e.addComp,t);else if(Array.isArray(e.addComp))e.addComp.forEach(e=>{let n=e;e&&"object"==typeof e&&e.random&&(n=d.arrayGetRand(e.random)),"string"==typeof n?this._addCompFromString(n,t):this._addCompFromObj(t,n)});else if("object"==typeof e.addComp){let n=e.addComp;e.addComp&&e.addComp.random&&(n=d.arrayGetRand(e.addComp.random)),this._addCompFromObj(t,n)}else i.default.err("Creator","addComponents","Giving up. shell.addComp must be string, array or object.")}addCompToObj(e,t,n){if(this.debug&&console.log(e.getName(),": compData with val",t,n),t.hasOwnProperty("func"))if(Array.isArray(t.func))t.func.forEach(s=>{const r=t.comp;if(e.has(r))"function"==typeof e.get(r)[s]?e.get(r)[s](n):this.noFuncError(r,s,t);else{const a=this.createComponent(r);"function"==typeof a[s]?(a[s](n),e.add(a)):this.noFuncError(r,s,t)}});else{const s=t.func,r=t.comp;if(e.has(r)&&"string"==typeof s){this.debug&&console.log("hasComp already KKK222 here now:",s);const t=e.get(r);"function"==typeof t[s]?t[s](n):i.default.err("ObjectShellComps","addCompToObj",`${s} is not a function on comp ${r}`)}else{let a=null;if(e.has(r)&&t.useOld||(a=this.createComponent(r),e.add(a)),a=e.get(r),"function"==typeof a[s])a[s](n),this.debug&&console.log("KKK333 new comp created and called",s,n);else if("object"==typeof s){Object.keys(t.func).forEach(n=>{const s={func:n,comp:r};t.useOld&&(s.useOld=t.useOld);const a=t.func[n];this.debug&&console.log("Calling addCompToObj recursively",s,a),this.addCompToObj(e,s,a)})}else i.default.log(JSON.stringify(s)),i.default.err("ObjectShellComps","addCompToObj",`No function ${s} in ${r}`)}}else e.has(t.comp)?(console.log("newObj: ",e,"compData: ",t),i.default.err("ObjectShellComps","addCompToObj","else-if branch Not implemented")):e.add(this.createComponent(t.comp,n))}createComponent(e,t){switch(e){case"Health":return new l.Health(t);default:if(l.hasOwnProperty(e))return new l[e];i.default.err("Creator","createComponent","Component |"+e+"| does not exist.")}return null}addPoison(e,t){const n=e.poison,s=JSON.parse(JSON.stringify(e));s.onHit=[{addComp:"DirectDamage",func:[{setter:"setDamage",value:n.damage},{setter:"setDamageType",value:i.default.DMG.POISON},{setter:"setDamageCateg",value:i.default.DMG.DIRECT},{setter:"setProb",value:n.prob}],duration:n.duration}],this.addOnHitProperties(s,t)}addOnHitProperties(e,t){e.onHit.forEach(e=>{this.processAddComp(e,t)})}addOnAttackHitProperties(e,t){e.onAttackHit.forEach(e=>{const n=this.processAddComp(e,t);n.setOnDamage(!1),n.setOnAttackHit(!0)})}addOnEquipProperties(e,t){e.onEquip.forEach(e=>{this.processAddComp(e,t,!0)})}processAddComp(e,t,n=!1){let s=null;if(s=n?new l.AddOnEquip:new l.AddOnHit,e.addComp){const n=this.createComponent(e.addComp);n.setSource&&i.default.isActor(t)&&n.setSource(t),Array.isArray(e.func)&&e.func.forEach(e=>{if("function"==typeof n[e.setter])n[e.setter](e.value);else{const t=n.toJSON();i.default.err("ObjectShellParser","addOnHitProperties",`Not a func: ${e.setter} in comp ${t}`)}});const r=n;if(e.duration){const t=u.Dice.create(e.duration),n=new l.Duration;n.setDurationDie(t),n.setComp(r),s.setComp(n),e.expireMsg&&n.setExpireMsg(e.expireMsg)}else s.setComp(r);return t.add(s),s}return e.transientComp?(s.setComp(JSON.parse(JSON.stringify(e))),t.add(s),s):null}addCallbacks(e,t){const n=e.callbacks;t.has("Callbacks")||t.add(new l.Callbacks),Object.keys(n).forEach(e=>{t.get("Callbacks").addCb(e,n[e])})}noFuncError(e,t,n){const s="compData "+JSON.stringify(n);i.default.err("ObjectShellComps","addCompToObj",`Comp: ${e} no func ${t}, ${s}`)}_addCompFromString(e,t){try{const n=new l[e];t.add(n)}catch(t){let n=`shell.addComp |${e}|`;n+="Component names are capitalized.",i.default.err("Creator","_addCompFromString",`${t.message} - ${n}`)}}_addCompFromObj(e,t){this.addCompToObj(e,t,null)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.shellProps=t.ActorGen=void 0;const r=s(n(4)),a=n(9),o=n(73),i=n(112);t.ActorGen={};const l=new a.Random;t.shellProps={races:{},ranks:{},roles:{},roleBases:{}};const c={range:1,danger:1,speed:100,brain:"GoalOriented",damage:"1d6",attack:1,defense:1,hp:5,protection:0,enemies:r.default.ACTOR_RACES,accuracy:5,agility:5,strength:5,magic:5,perception:5,willpower:5};t.shellProps.races={arborean:{strength:3,willpower:5,type:"arborean",prefix:"arborean",char:"a",colorbg:"white"},elf:{strength:-1,agility:4,accuracy:4,magic:3,type:"elf",prefix:"elven",char:"e",colorbg:"green"},fae:{type:"fae",prefix:"fae",char:"f",colorbg:"purple",speed:10,strength:-2,magic:3,addComp:["Flying"]},gnome:{strength:-1,magic:3,perception:5,type:"gnome",prefix:"gnomish",char:"n",colorbg:"beige"},naga:{strength:2,type:"naga",prefix:"naga",char:"N",colorbg:"darkgreen",addComp:[o.resistance("POISON","STRONG")]},ogre:{strength:4,magic:-3,willpower:-3,type:"ogre",prefix:"ogre",char:"O",colorbg:"darkseagreen"},orc:{strength:2,magic:-2,willpower:-2,type:"orc",prefix:"orc",char:"o",colorbg:"darkseagreen"},ratling:{agility:2,perception:4,type:"ratling",prefix:"ratling",char:"r",colorbg:"grey"},teradin:{agility:2,accuracy:3,type:"teradin",prefix:"teradin",char:"T",colorbg:"white",addComp:["Flying"]},vachefolk:{strength:2,type:"vachefolk",prefix:"vachefolk",char:"v",colorbg:"brown"},valkyr:{strength:3,type:"valkyr",prefix:"valkyr",char:"V",colorbg:"darkblue",addComp:[o.resistance("ICE","MEDIUM")]},viking:{strength:4,agility:3,type:"viking",prefix:"viking",char:"K",colorbg:"Azure",addComp:[o.resistance("ICE","MEDIUM")]}},g(t.shellProps.races,1.5,1);const u=Object.keys(t.shellProps.races);t.shellProps.ranks={commoner:{danger:1,hp:5,colorfg:"brown",damage:1},peon:{danger:1,hp:5,colorfg:"brown",damage:1},thrall:{danger:1,hp:7,damage:1},adventurer:{danger:2,hp:10,damage:2},sergeant:{danger:3,strength:1,hp:15,damage:3,colorfg:"lightblue"},lieutenant:{danger:4,damage:4,strength:3,hp:20,colorfg:"blue"},commander:{danger:5,damage:5,strength:5,hp:20,equip:["Great battle axe","Steel armour","Steel helmet"],colorfg:"orange"},steward:{colorfg:"steelblue",danger:5,hp:20,damage:5},lord:{colorfg:"LightGoldenRodYellow",danger:5,damage:5,strength:7,hp:20},hero:{colorfg:"green",danger:6,damage:6,strength:4,accuracy:4,agility:4,speed:7,hp:25},warlord:{danger:7,hp:25,colorfg:"black",damage:7},captain:{danger:7,hp:25,strength:7,agility:3,accuracy:3,colorfg:"salmon",damage:7},prince:{colorfg:"MediumPurple",danger:5,hp:20,damage:5},princess:{colorfg:"pink",danger:5,agility:5,magic:5,hp:20,damage:5},queen:{colorfg:"yellow",danger:10,hp:30,addComp:["FirstStrike"],damage:10},king:{colorfg:"red",strength:7,attack:7,defense:7,danger:12,hp:40,damage:12},emperor:{colorfg:"purple",danger:15,strength:10,attack:10,defense:10,hp:50,addComp:[i.BypassComp(.15)],damage:15},empress:{colorfg:"palevioletred",danger:17,damage:17,accuracy:10,agility:10,attack:10,defense:10,hp:45,addComp:[i.BypassComp(.25),"Charm"]},overlord:{colorfg:"orangered",danger:10,hp:35,damage:10,addComp:[i.BypassComp(.1)]}};const h=Object.keys(t.shellProps.ranks);g(t.shellProps.ranks,1.5,1),t.shellProps.roleBases={melee:{attack:2,defense:2,protection:2,danger:1,damage:"1d8"},magic:{magic:3,willpower:2,danger:2,brain:"SpellCaster",maxPP:10,PP:10,addComp:["Regeneration"],damage:"1d4"},ranged:{accuracy:3,agility:1,danger:2,addComp:[{random:["EagleEye","StrongShot","ThroughShot","LongRangeShot","RangedEvasion","CriticalShot"]}],damage:"1d6"},stealth:{defense:2,agility:3,perception:2,danger:0,damage:"1d5"}},g(t.shellProps.roleBases,1.5,1),t.shellProps.roles={melee:{soldier:{danger:1,hp:5,attack:1,defense:1,damage:"1d4"},axeman:{danger:2,hp:10,damage:"1d6"},brave:{danger:2,hp:7,strength:2,damage:"1d6"},duelist:{danger:3,hp:13,agility:3,strength:2,addComp:["RangedEvasion"],damage:"1d8"},elite:{danger:5,hp:23,strength:4,addComp:["CounterAttack"],damage:"2d6"},fighter:{danger:2,hp:12,agility:1,strength:1},footman:{danger:1,damage:"1d4",equip:["Longsword"]},knight:{danger:4,hp:15,strength:4},phalanx:{danger:1,hp:10,defense:4,equip:["Spear"],damage:"1d4"},scourger:{danger:4,hp:20,attack:4,defense:4,strength:6},judicator:{danger:5,hp:30,attack:5,defense:5,strength:7,addComp:["FirstStrike"],damage:"2d6"},skirmisher:{danger:3,hp:15,attack:3,defense:3,damage:"2d3"},hunter:{danger:2,hp:10,attack:3,defense:3,damage:"1d6"},warrior:{danger:2,hp:10,attack:3,defense:3,damage:"1d6"},berserker:{danger:5,hp:20,attack:8,defense:3,strength:6,addComp:["RangedEvasion",o.resistance("ICE","MEDIUM")],damage:"2d6"}},magic:{adept:{danger:1,pp:3,maxPP:3,hp:5,spells:["EnergyArrow"]},archmage:{danger:15,pp:50,maxPP:50,hp:30,spells:["PowerDrain",{random:["WaterBolt","SlimeBolt","FrostBolt"]},{random:["Heal","MagicArmor","Charm"]},{random:["IceArrow","PoisonArrow","ArrowOfWebs"]}]},bard:{danger:3,magic:5,pp:7,maxPP:7,hp:7,spells:["SummonAnimal"]},cleric:{danger:1,magic:2,willpower:3,pp:7,maxPP:7,spells:["Heal"]},healer:{danger:1,magic:2,pp:7,maxPP:7,spells:["Heal"]},mage:{danger:5,magic:5,willpower:5,hp:13,spells:[{random:["RingOfFire","RingOfFrost"]}]},telepath:{danger:4,pp:12,maxPP:12,hp:12,magic:4,willpower:4,spells:["SummonFlyingEyes","Telepathy"]},necromancer:{danger:5,pp:10,maxPP:10,hp:15,spells:["AnimateDead"]},runemage:{danger:3,pp:15,maxPP:15,hp:15,spells:["StunningTouch"]},shaman:{danger:3,pp:15,maxPP:15,hp:10,spells:["IcyPrison"]},summoner:{danger:7,pp:15,maxPP:15,hp:15,spells:[{random:["SummonKin","SummonAirElemental"]}]},wizard:{danger:10,maxPP:30,pp:30,hp:15,magic:7,willpower:7,spells:[{random:["CrossBolt","FrostBolt","LightningBolt"]},{random:["Heal","MagicArmor","Paralysis"]}]}},ranged:{arbalist:{danger:3,hp:10,equip:["Wooden crossbow",{name:"Wooden bolt",count:10}]},archer:{danger:3,hp:5,equip:["Wooden bow",{name:"Wooden arrow",count:10},"Steel bow",{name:"Steel arrow",count:15}]},bolter:{danger:4,hp:5,equip:["Steel crossbow",{name:"Steel bolt",count:7}]},rifleman:{danger:6,hp:15,equip:["Rifle",{name:"Steel bullet",count:7}]},darter:{danger:2,hp:5,speed:5,equip:[{name:"Iron dart",count:9}]},thrower:{danger:1,equip:[{name:"Throwing axe",count:7}]},catapulter:{danger:2,hp:15,strength:5,speed:-5,equip:[{name:"Large rock",count:4}]},sharpshooter:{danger:8,hp:20,accuracy:5,agility:5,equip:["Rifle",{name:"Steel bullet",count:10}],fovrange:7},slinger:{danger:1,hp:3,equip:[{name:"Rock",count:10}]}},stealth:{assassin:{danger:3,addComp:[o.resistance("POISON","MEDIUM")]},acrobat:{danger:2,brain:"Thief",speed:20},rogue:{},scout:{danger:2,speed:10,fovrange:7},thief:{danger:2,brain:"Thief"}}};const d=Object.keys(t.shellProps.roles);d.forEach(e=>{g(t.shellProps.roles[e],1.5,1)});const p=d.reduce((e,n,s,r)=>Object.assign(e,t.shellProps.roles[n]),{}),f=Object.keys(p).reduce((e,t,n,s)=>(e.push(t),e),[]);function m(e,t,n){const s=t.join(" ");let r="";return r="commoner"!==n?e.prefix+" "+s+" "+n:e.prefix+" "+s,r}function g(e,t,n){Object.keys(e).forEach(s=>{const a=e[s];r.default.STATS_LC.forEach(e=>{a.hasOwnProperty(e)&&(a[e]=Math.round(t*a[e])+n)})})}t.ActorGen.minNumRoles=1,t.ActorGen.maxNumRoles=2,t.ActorGen.genRandShell=function(){const e=l.getUniformInt(t.ActorGen.minNumRoles,t.ActorGen.maxNumRoles),n=l.arrayGetRand(u),s=t.shellProps.races[n],r=l.arrayGetRand(h),a=t.shellProps.ranks[r],i=l.getUniqueItems(d,e),p=i.map(e=>t.shellProps.roleBases[e]),f=[],g=i.map(e=>{const n=t.shellProps.roles[e],s=l.arrayGetRand(Object.keys(n));return f.push(s),n[s]}),y=[c,s,a].concat(p).concat(g),v=o.mixNewShell(y);return v.name=m(s,f,r),v.roleTypes=i,v.roles=f,v.race=n,v},t.ActorGen.genActors=function(e){const n=[];for(let s=0;s<e;s++)n.push(t.ActorGen.genRandShell());return n},t.ActorGen.getRandShellWith=function(e,n=100){let s=n,r=null;for(;s>=0&&(r=t.ActorGen.genRandShell(),!e(r));)--s;return r},t.ActorGen.getRaces=function(){return u},t.ActorGen.genShell=function(e){let n=null,s="";e.rank?(s=e.rank,n=t.shellProps.ranks[e.rank]):(s=l.arrayGetRand(h),n=t.shellProps.ranks[s]);let a=e.race;e.race||(a=l.arrayGetRand(u));const i=t.shellProps.races[a];let g=e.roleTypes;if(!e.roleTypes){const e=l.getUniformInt(1,2);g=l.getUniqueItems(d,e)}const y=g.map(e=>t.shellProps.roleBases[e]),v=e.roles||[];e.roles||g.forEach(e=>{const n=t.shellProps.roles[e],s=l.arrayGetRand(Object.keys(n));v.push(s)});const b=[];v.forEach(e=>{b.push(p[e])});const _=[c,i,n].concat(b).concat(y),E=o.mixNewShell(_);return E.name=m(i,v,s),E.roles=v,E.rank=s,E.race=a,E.color||E.colorfg||(E.colorfg=function(e){if(e.length>1){let t=f.indexOf(e[0]),n=f.indexOf(e[1]);t%=r.default.COLORS.length,n%=r.default.COLORS.length;const s=r.default.COLORS[t];r.default.COLORS[n];return s}let t=f.indexOf(e[0]);return t%=r.default.COLORS.length,r.default.COLORS[t]}(v)),E}},function(e,t,n){"use strict";function s(e){return e.charAt(0).toUpperCase()+e.substring(1)}function r(e,...t){const n=r.map;return e.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,(function(r,a,o,i){if("%"==e.charAt(i-1))return r.substring(1);if(!t.length)return r;let l=t[0];const c=(a||o).split(","),u=c.shift()||"",h=n[u.toLowerCase()];if(!h)return r;l=t.shift();let d=l[h].apply(l,c);const p=u.charAt(0);return p!=p.toLowerCase()&&(d=s(d)),d}))}Object.defineProperty(t,"__esModule",{value:!0}),t.format=t.capitalize=t.clamp=t.mod=void 0,t.mod=function(e,t){return(e%t+t)%t},t.clamp=function(e,t=0,n=1){return e<t?t:e>n?n:e},t.capitalize=s,t.format=r,r.map={s:"toString"}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.toHex=t.toRGB=t.hsl2rgb=t.rgb2hsl=t.randomize=t.lerpHSL=t.interpolateHSL=t.lerp=t.interpolate=t.multiply_=t.multiply=t.add_=t.add=t.fromString=void 0;const r=n(139),a=s(n(22));function o(e,t,n=.5){const s=e.slice();for(let r=0;r<3;r++)s[r]=Math.round(s[r]+n*(t[r]-e[r]));return s}function i(e,t,n=.5){const s=l(e),r=l(t);for(let e=0;e<3;e++)s[e]+=n*(r[e]-s[e]);return u(s)}function l(e){const t=e[0]/255,n=e[1]/255,s=e[2]/255,r=Math.max(t,n,s),a=Math.min(t,n,s);let o,i=0,l=(r+a)/2;if(r==a)o=0;else{const e=r-a;switch(o=l>.5?e/(2-r-a):e/(r+a),r){case t:i=(n-s)/e+(n<s?6:0);break;case n:i=(s-t)/e+2;break;case s:i=(t-n)/e+4}i/=6}return[i,o,l]}function c(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+(t-e)*(2/3-n)*6:e}function u(e){let t=e[2];if(0==e[1])return t=Math.round(255*t),[t,t,t];{const n=e[1],s=t<.5?t*(1+n):t+n-t*n,r=2*t-s,a=c(r,s,e[0]+1/3),o=c(r,s,e[0]),i=c(r,s,e[0]-1/3);return[Math.round(255*a),Math.round(255*o),Math.round(255*i)]}}t.fromString=function(e){let t,n;if(e in h)t=h[e];else{if("#"==e.charAt(0)){const n=(e.match(/[0-9a-f]/gi)||[]).map(e=>parseInt(e,16));if(3==n.length)t=n.map(e=>17*e);else{for(let e=0;e<3;e++)n[e+1]+=16*n[e],n.splice(e,1);t=n}}else t=(n=e.match(/rgb\(([0-9, ]+)\)/i))?n[1].split(/\s*,\s*/).map(e=>parseInt(e)):[0,0,0];h[e]=t}return t.slice()},t.add=function(e,...t){const n=e.slice();for(let e=0;e<3;e++)for(let s=0;s<t.length;s++)n[e]+=t[s][e];return n},t.add_=function(e,...t){for(let n=0;n<3;n++)for(let s=0;s<t.length;s++)e[n]+=t[s][n];return e},t.multiply=function(e,...t){const n=e.slice();for(let e=0;e<3;e++){for(let s=0;s<t.length;s++)n[e]*=t[s][e]/255;n[e]=Math.round(n[e])}return n},t.multiply_=function(e,...t){for(let n=0;n<3;n++){for(let s=0;s<t.length;s++)e[n]*=t[s][n]/255;e[n]=Math.round(e[n])}return e},t.interpolate=o,t.lerp=o,t.interpolateHSL=i,t.lerpHSL=i,t.randomize=function(e,t){t instanceof Array||(t=Math.round(a.default.getNormal(0,t)));const n=e.slice();for(let e=0;e<3;e++)n[e]+=t instanceof Array?Math.round(a.default.getNormal(0,t[e])):t;return n},t.rgb2hsl=l,t.hsl2rgb=u,t.toRGB=function(e){return`rgb(${e.map(e=>r.clamp(e,0,255)).join(",")})`},t.toHex=function(e){return"#"+e.map(e=>r.clamp(e,0,255).toString(16).padStart(2,"0")).join("")};const h={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]}},function(e,t,n){var s=n(494),r=n(495),a=n(496),o=n(497),i=n(498);function l(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var s=e[t];this.set(s[0],s[1])}}l.prototype.clear=s,l.prototype.delete=r,l.prototype.get=a,l.prototype.has=o,l.prototype.set=i,e.exports=l},function(e,t,n){var s=n(196);e.exports=function(e,t){for(var n=e.length;n--;)if(s(e[n][0],t))return n;return-1}},function(e,t,n){var s=n(93),r=n(75);e.exports=function(e){if(!r(e))return!1;var t=s(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}},function(e,t,n){var s=n(74)(Object,"create");e.exports=s},function(e,t,n){var s=n(518);e.exports=function(e,t){var n=e.__data__;return s(t)?n["string"==typeof t?"string":"hash"]:n.map}},function(e,t,n){var s=n(284),r=n(285);e.exports=function(e,t,n,a){var o=!n;n||(n={});for(var i=-1,l=t.length;++i<l;){var c=t[i],u=a?a(n[c],e[c],c,n,e):void 0;void 0===u&&(u=e[c]),o?r(n,c,u):s(n,c,u)}return n}},function(e,t,n){var s=n(524),r=n(56),a=Object.prototype,o=a.hasOwnProperty,i=a.propertyIsEnumerable,l=s(function(){return arguments}())?s:function(e){return r(e)&&o.call(e,"callee")&&!i.call(e,"callee")};e.exports=l},function(e,t,n){var s=n(526),r=n(202),a=n(203),o=a&&a.isTypedArray,i=o?r(o):s;e.exports=i},function(e,t){var n=Object.prototype;e.exports=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||n)}},function(e,t,n){var s=n(299),r=n(554)(s);e.exports=r},function(e,t){e.exports=function(e){return e}},function(e,t,n){var s=n(558),r=n(568),a=n(151),o=n(20),i=n(577);e.exports=function(e){return"function"==typeof e?e:null==e?a:"object"==typeof e?o(e)?r(e[0],e[1]):s(e):i(e)}},function(e,t,n){var s=n(212);e.exports=function(e){if("string"==typeof e||s(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}},function(e,t,n){"use strict";(function(t){!t.version||0===t.version.indexOf("v0.")||0===t.version.indexOf("v1.")&&0!==t.version.indexOf("v1.8.")?e.exports={nextTick:function(e,n,s,r){if("function"!=typeof e)throw new TypeError('"callback" argument must be a function');var a,o,i=arguments.length;switch(i){case 0:case 1:return t.nextTick(e);case 2:return t.nextTick((function(){e.call(null,n)}));case 3:return t.nextTick((function(){e.call(null,n,s)}));case 4:return t.nextTick((function(){e.call(null,n,s,r)}));default:for(a=new Array(i-1),o=0;o<a.length;)a[o++]=arguments[o];return t.nextTick((function(){e.apply(null,a)}))}}}:e.exports=t}).call(this,n(43))},function(e,t,n){var s=n(96),r=s.Buffer;function a(e,t){for(var n in e)t[n]=e[n]}function o(e,t,n){return r(e,t,n)}r.from&&r.alloc&&r.allocUnsafe&&r.allocUnsafeSlow?e.exports=s:(a(s,t),t.Buffer=o),a(r,o),o.from=function(e,t,n){if("number"==typeof e)throw new TypeError("Argument must not be a number");return r(e,t,n)},o.alloc=function(e,t,n){if("number"!=typeof e)throw new TypeError("Argument must be a number");var s=r(e);return void 0!==t?"string"==typeof n?s.fill(t,n):s.fill(t):s.fill(0),s},o.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return r(e)},o.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return s.SlowBuffer(e)}},function(e,t,n){"use strict";var s="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var n=t.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(var s in n)r(n,s)&&(e[s]=n[s])}}return e},t.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var a={arraySet:function(e,t,n,s,r){if(t.subarray&&e.subarray)e.set(t.subarray(n,n+s),r);else for(var a=0;a<s;a++)e[r+a]=t[n+a]},flattenChunks:function(e){var t,n,s,r,a,o;for(s=0,t=0,n=e.length;t<n;t++)s+=e[t].length;for(o=new Uint8Array(s),r=0,t=0,n=e.length;t<n;t++)a=e[t],o.set(a,r),r+=a.length;return o}},o={arraySet:function(e,t,n,s,r){for(var a=0;a<s;a++)e[r+a]=t[n+a]},flattenChunks:function(e){return[].concat.apply([],e)}};t.setTyped=function(e){e?(t.Buf8=Uint8Array,t.Buf16=Uint16Array,t.Buf32=Int32Array,t.assign(t,a)):(t.Buf8=Array,t.Buf16=Array,t.Buf32=Array,t.assign(t,o))},t.setTyped(s)},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ScreenBuffered=t.Screen=t.ALL_VISIBLE=void 0;const r=s(n(4)),a=n(672);t.ALL_VISIBLE="ALL";const o=function(e,n,s){const a=[],o=[];let i=-1,l=-1;if(null===s||Array.isArray(s)||(i=s.getX(),l=s.getY()),!e)return a.fill("cell-not-seen",0,n.length-1),o.fill("X",0,n.length-1),[a,o];for(let s=0;s<n.length;s++){const c=n[s];let u=!1;if(e===t.ALL_VISIBLE)u=!0;else{u=!(e.indexOf(c)<0)}let h=r.default.getCssClassForCell(c,u);const d=r.default.getCharForCell(c,u);i===c.getX()&&l===c.getY()&&(h="cell-target-selected"),u||c.isExplored()&&(h+=" cell-not-seen"),a.push(h),o.push(d)}return[a,o]},i=function(e,n,s,a,o={},i,l){let c=null,u=null,h=0,d=0;const p=[],f=[];i=i||r.default.getCssClassForCell.bind(r.default),l=l||r.default.getCharForCell.bind(r.default);let m=null;if(s&&(m=new Map,Array.isArray(s)?s.forEach(e=>{m.set(e.getX()+","+e.getY(),e)}):m.set(s.getX()+","+s.getY(),s)),!e)return p.fill("cell-not-seen",0,n.length-1),f.fill("X",0,n.length-1),[p,f];let g="",y="";for(let s=0;s<n.length;s++){const r=n[s],v=r.getX(),b=r.getY();let _=!1;if(e===t.ALL_VISIBLE)_=!0;else{_=!(e.indexOf(r)<0)}if(g=i(r,_),y=l(r,_),_&&a){const e=v+","+b;a[e]&&(g=a[e].className,y=a[e].char)}m&&m.has(r.getKeyXY())&&(g=o.selectedCell?o.selectedCell:"cell-target-selected"),_||r.isExplored()&&(g+=" cell-not-seen");g!==u&&u||y!==c&&c?(p.push([d,u]),d=1,f.push([h,c]),h=1):(++d,++h),c=y,u=g}return d>0&&p.push([d,g]),h>0&&f.push([h,y]),[p,f]},l=function(e,t){const n=[],s=[];let a=-1,o=-1;null===t||Array.isArray(t)||(a=t.getX(),o=t.getY());for(let t=0;t<e.length;t++){const i=e[t];let l=r.default.getCssClassFullMap(i);const c=r.default.getCharFullMap(i);a===i.getX()&&o===i.getY()&&(l="cell-target-selected"),n.push(l),s.push(c)}return[n,s]},c=function(e,t){let n="",s="",a=0,o=0;const i=[],l=[];let c=null;t&&Array.isArray(t)&&(c=new Map,t.forEach(e=>{c.set(e.getX()+","+e.getY(),e)}));let u="",h="";for(let t=0;t<e.length;t++){const d=e[t];if(u=r.default.getCssClassFullMap(d),h=r.default.getCharFullMap(d),c){const[e,t]=[d.getX(),d.getY()];c.has(e+","+t)&&(u="cell-target-selected")}u!==s&&s||h!==n&&n?(i.push([o,s]),o=1,l.push([a,n]),a=1):(++o,++a),n=h,s=u}return o>0&&i.push([o,u]),a>0&&l.push([a,h]),[i,l]};class u{constructor(e,t){this.viewportX=e,this.viewportY=t,this.selectedCell=null,this.styles={},this._charRows=[],this._classRows=[],this._mapShown=!1,this.isRLE=!1,this.viewport=new a.Viewport(e,t)}getStartX(){return this.viewport.startX}setSelectedCell(e){this.selectedCell=e}setViewportXY(e,t){this.viewportX=e,this.viewportY=t,this.viewport.setViewportXY(e,t),this._charRows=[],this._classRows=[];for(let e=0;e<t;e++)this._charRows.push([]),this._classRows.push([])}setMapShown(e){this._mapShown=e}getCharRows(){return this._charRows}getClassRows(){return this._classRows}_initRender(e,t,n){this._mapShown?this.setViewportXY(n.cols,n.rows):this.setViewportXY(this.viewportX,this.viewportY),this.viewport.initCellsInViewPort(e,t,n),this.startX=this.viewport.startX,this.endX=this.viewport.endX,this.startY=this.viewport.startY,this.endY=this.viewport.endY}render(e,t,n,s){this.isRLE=!1,this._initRender(e,t,n);let r=0;for(let e=this.viewport.startY;e<=this.viewport.endY;++e){const t=this.viewport.getCellRow(e),n=o(s,t,this.selectedCell);this._classRows[r]=n[0],this._charRows[r]=n[1],++r}}renderAllVisible(e,n,s){this.isRLE=!1,this.render(e,n,s,t.ALL_VISIBLE)}renderWithRLE(e,t,n,s,r,a,o){this.isRLE=!0,this._initRender(e,t,n);let l=0;for(let e=this.viewport.startY;e<=this.viewport.endY;++e){const t=this.viewport.getCellRow(e),n=i(s,t,this.selectedCell,r,this.styles,a,o);this._classRows[l]=n[0],this._charRows[l]=n[1],++l}}renderFullMap(e){this.isRLE=!1,this.startX=0,this.endX=e.cols-1,this.startY=0,this.endY=e.rows-1;for(let t=0;t<e.rows;++t){const n=l(e.getCellRowFast(t),this.selectedCell);this._classRows[t]=n[0],this._charRows[t]=n[1]}}renderFullMapWithRLE(e){this.isRLE=!0,this.startX=0,this.endX=e.cols-1,this.startY=0,this.endY=e.rows-1;for(let t=0;t<e.rows;++t){const n=c(e.getCellRowFast(t),this.selectedCell);this._classRows[t]=n[0],this._charRows[t]=n[1]}}clear(){this._classRows=[],this._charRows=[],this.selectedCell=null,this.startX=0,this.endX=-1,this.startY=0,this.endY=-1,this.styles={}}setStyle(e,t){this.styles[e]=t}printRenderedChars(){this._charRows.forEach(e=>{console.log(e.join(""))})}printRenderedClasses(){this._classRows.forEach(e=>{console.log(e.join(""))})}}t.Screen=u;t.ScreenBuffered=class extends u{constructor(e,t){super(e,t),this.isInitialized=!1,this.getCellChar=this.getCellChar.bind(this),this.getCellClass=this.getCellClass.bind(this),this.prevVisible=[],this.debugShowAll=!1}invalidate(){this.isInitialized=!1,this.prevVisible=[]}renderWithRLE(e,t,n,s,a,o,i){s||r.default.err("ScreenBuffered","renderWithRLE","undef visibleCells"),this.isInitialized||this.initializeFullMap(n,s);return this.getCellsInFirstOnly(this.prevVisible,s).forEach(e=>{const[t,n]=e.getXY(),s=r.default.getCssClassForCell(e,!1),a=r.default.getCharForCell(e,!1);this.fullMapClassRows[t][n]=s,this.fullMapCharRows[t][n]=a}),s.forEach(e=>{const[t,n]=e.getXY(),s=r.default.getCssClassForCell(e,!0),a=r.default.getCharForCell(e,!0);this.fullMapClassRows[t][n]=s,this.fullMapCharRows[t][n]=a}),this.prevVisible=s,(this.debugShowAll||n.debugShowAll)&&(s=n.getCells()).forEach(e=>{const[t,n]=e.getXY(),s=r.default.getCssClassForCell(e,!0),a=r.default.getCharForCell(e,!0);this.fullMapClassRows[t][n]=s,this.fullMapCharRows[t][n]=a}),super.renderWithRLE(e,t,n,s,a,this.getCellClass,this.getCellChar)}initializeFullMap(e,t){const n=e.getCells();this.fullMapClassRows=new Array(e.cols),this.fullMapCharRows=new Array(e.cols);for(let t=0;t<e.cols;t++)this.fullMapCharRows[t]=new Array(e.rows),this.fullMapClassRows[t]=new Array(e.rows);const s=new Map;t.forEach(e=>{s[e.getKeyXY()]=!0}),n.forEach(e=>{const[t,n]=e.getXY(),a=s[e.getKeyXY()],o=r.default.getCssClassForCell(e,a),i=r.default.getCharForCell(e,a);this.fullMapClassRows[t][n]=o,this.fullMapCharRows[t][n]=i}),this.isInitialized=!0}getCellsInFirstOnly(e,t){const n=[];return e.forEach(e=>{t.indexOf(e)<0&&n.push(e)}),n}getCellClass(e,t){const[n,s]=e.getXY();return this.fullMapClassRows[n][s]}getCellChar(e,t){const[n,s]=e.getXY();return this.fullMapCharRows[n][s]}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Castle=void 0;const s=n(9),r=n(80),a=n(338),o=s.Random.getRNG();t.Castle={},t.Castle.corridorDoorThr=.2,t.Castle.tiles={corner:[],term:[],entrance:[],entranceWall:[],corridor:[],corridorWithExit:[],branch:[],storerooms:[],residential:[],crossCenter:[],fillerWall:"",fillerFloor:""},t.Castle.tiles.corner=["\ndir:NW\nname:corner_se\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n......#\nY.....#\n......#\n#######","\ndir:NW\nname:corner_se1\nX=#\nY=#\n\n#X#+#X#\nY.....#\n+.....#\n+...#.#\n+..####\nY...###\n#######","\ndir:NE\nname:corner_sw\nX=.\nY=#\n\n#X...X#\n#.....#\nY......\n#......\nY......\n#.....#\n#######","\ndir:SW\nname:corner_ne\nX=#\nY=.\n\n#X###X#\nY.....#\n......#\n......#\n......#\nY.....#\n#.....#","\ndir:SE\nname:corner_nw\nX=#\nY=#\n\n#X###X#\n#......\nY......\n#......\nY......\n#......\n#.....#"],t.Castle.tiles.term=["\ndir:N\nname:term_n\nX=#\nY=#\n\n#X#+#X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n#######","\ndir:S\nname:term_s\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n###+###","\ndir:E\nname:term_e\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n#.....+\nY.....#\n#.....#\n#######","\ndir:W\nname:term_w\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n+.....#\nY.....#\n#.....#\n#######"],t.Castle.tiles.entrance=["\ndir:NEW\nname:entrance_n\nX=.\nY=#\n\n#X...X#\n##...##\nY##.###\n..#+#..\n.......\nY.....#\n#######","\ndir:SEW\nname:entrance_s\nX=#\nY=#\n\n#X###X#\nY......\n..#.#..\n.##+##.\nY#...##\n#.....#\n##...##","\ndir:NSW\nname:entrance_w\nX=#\nY=#\n\n##X..X#\nY.##..#\n...##.#\n....+.#\n...##.#\nY.##..#\n###...#","\ndir:NSE\nname:entrance_e\nX=#\nY=#\n\n#.X.X##\nY.#..##\n#.##.#.\n#....+.\n#..#.#.\nY.##.##\n#.....#","\ndir:SEW\nname:entrance_ne\nX=#\nY=#\n\n##X#X##\nY.#..##\n..##.#.\n.....+.\n...#.#.\nY.##.##\n#.....#","\ndir:NSW\nname:entrance_nw\nX=#\nY=#\n\n##X#.X#\nY###..#\n.####.#\n.+....#\n.####.#\nY###..#\n###...#","\ndir:NEW\nname:entrance_se\nX=#\nY=#\n\n##X.X##\nY....##\n.....#.\n.....+.\n...#.#.\nY.##.##\n#######","\ndir:NW\nname:entrance_sw\nX=#\nY=#\n\n##X..X#\nY##...#\n.#....#\n.+....#\n.#....#\nY###..#\n#######"],t.Castle.tiles.entranceWall=["\ndir:NEW\nname:entrance_n\nX=.\nY=#\n\n#X...X#\n##...##\nY##.###\n..#+#..\n.......\nY.....#\n##...##","\ndir:SEW\nname:entrance_s\nX=#\nY=#\n\n#X...X#\nY.....#\n..#.#..\n.##+##.\nY#...##\n#.....#\n#.....#","\ndir:NSW\nname:entrance_w\nX=#\nY=#\n\n##X..X#\nY.##..#\n...##.#\n....+.#\n...##.#\nY.##..#\n###...#","\ndir:NSE\nname:entrance_e\nX=.\nY=#\n\n#.#XX##\nY.##.##\n...#.#.\n.....+.\n...#.#.\nY.##.##\n#.....#"],t.Castle.tiles.corridor=["\ndir:NS\nname:corridor_east\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n#.....#","\ndir:NS\nname:corridor_west\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n#.....#\nY.....#\n#.....#\n#.....#","\ndir:EW\nname:corridor_north\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n.......\n#######","\ndir:EW\nname:corridor_south\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n.......\n#######"],t.Castle.tiles.corridorWithExit=["\ndir:NS\nname:corridor_east\nX=.\nY=#\n\n#X...X#\n#.....#\nY#....#\n......#\nY#....#\n#.....#\n#.....#","\ndir:NS\nname:corridor_west\nX=.\nY=#\n\n#X...X#\n#.....#\nY....##\n#......\nY....##\n#.....#\n#.....#","\ndir:EW\nname:corridor_north\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n..#.#..\n###.###","\ndir:EW\nname:corridor_south\nX=#\nY=.\n\n#X#.#X#\n..#.#..\nY......\n.......\nY......\n..#.#..\n#######"],t.Castle.tiles.branch=["\ndir:NSE\nname:corridor_nse\nX=.\nY=#\n\n#X...X#\n#.....#\nY.....#\n#.....+\nY.....#\n#.....#\n#.....#","\ndir:NSW\nname:corridor_nsw\nX=#\nY=#\n\n#X...X#\n#.....#\nY.....#\n+.....#\nY.....#\n#.....#\n##...##","\ndir:NEW\nname:corridor_new\nX=#\nY=.\n\n#X#+#X#\n.......\nY......\n.......\nY......\n.......\n#######","\ndir:SEW\nname:corridor_sew\nX=#\nY=.\n\n#X###X#\n.......\nY......\n.......\nY......\n.......\n###+###"],t.Castle.tiles.storerooms=["\ndir:S\nname:storeroom_s\nX=#\nY=#\n\n#X###X#\n#.....#\nY.....#\n#.....#\nY.....#\n###|###\n##..&##","\ndir:N\nname:storeroom_n\nX=#\nY=#\n\n#X&..X#\n###|###\nY.....#\n#.....#\nY.....#\n#######\n#######","\ndir:W\nname:storeroom_w\nX=#\nY=#\n\n##X#X##\nY#.#.##\n.#....#\n.|...##\n&#....#\nY#.#.##\n#######","\ndir:E\nname:storeroom_e\nX=#\nY=#\n\n##X#X##\nY#.#.##\n#....#&\n#....|.\n#....#.\nY..#.##\n#######"],t.Castle.tiles.residential=["\nname:living2x2\nX=#\nY=#\n\n#X+#+X#\n#::#::#\nY::#::#\n#######\nY::#::#\n#::#::#\n##+#+##","\nname:living2x2\ndir:NS\nX=#\nY=#\n\n#X#.#X#\n#:+.+:#\nY:#.#:#\n###.###\nY:#.#:#\n#:+.+:#\n###.###","\nname:living2x2\ndir:NS\nX=#\nY=#\n\n#X#.#X#\nY:#.#:#\n#:+.+:#\n###.###\n#:+.+:#\nY:#.#:#\n###.###","\nname:livingL2S\ndir:S\nX=#\nY=#\n\n#X###X#\n#:::::#\nY:::::#\n###+###\nY:#.#:#\n#:+.+:#\n###.###","\nname:livingL_corner\ndir:NE\nX=#\nY=#\n\n#X#..X#\n#:#+#..\nY:::##.\n#::::#.\nY::::##\n#:::::#\n#######","\nname:living_3dir\ndir:NSE\nX=#\nY=#\n\n#X#.X##\nY:#.#:#\n#:#.#+#\n#:#....\nY:#.###\n#:+.###\n###.###","\nname:living_corner\ndir:NE\nX=#\nY=#\n\n#X#.#X#\n#:#...#\nY:###.#\n#:::+..\nY:::###\n#:::+:#\n#######","\nname:living_corner2\ndir:NE\nX=#\nY=#\n\n#X#.#X#\n#:#...#\nY:###..\n#:::+#.\nY::::##\n#:::::#\n#######"],t.Castle.tiles.crossCenter=["\nname:cross_center1\ndir:NSEW\nX=.\nY=.\n\n#X...X#\n##...##\nY..#...\n..###..\nY..#...\n##...##\n##...##"],t.Castle.tiles.fillerFloor="\nname:FILLER\nX=.\nY=.\n\n.X...X.\nY......\n.......\n.......\n.......\nY......\n.......",t.Castle.tiles.fillerWall="\nname:FILLER\nX=#\nY=#\n\n#X###X#\nY######\n#######\n#######\n#######\nY######\n#######",t.Castle.startFuncs={},t.Castle.startRoomFunc=function(){const e=Math.floor(this.tilesX/2);let t=null,n=0;return o.getUniform()<=.5?t=this.findTemplate({name:"entrance_n"}):(t=this.findTemplate({name:"entrance_s"}),n=this.tilesY-1),{x:e,y:n,room:t}},t.Castle.startRoomFuncNorth=function(){return{x:Math.floor(this.tilesX/2),y:0,room:this.findTemplate({name:"entrance_n"})}},t.Castle.startFuncs.N=t.Castle.startRoomFuncNorth,t.Castle.startRoomFuncSouth=function(){const e=this.tilesY-1;return{x:Math.floor(this.tilesX/2),y:e,room:this.findTemplate({name:"entrance_s"})}},t.Castle.startFuncs.S=t.Castle.startRoomFuncSouth,t.Castle.startRoomFuncWest=function(){return{x:0,y:Math.floor(this.tilesY/2),room:this.findTemplate({name:"entrance_w"})}},t.Castle.startFuncs.W=t.Castle.startRoomFuncWest,t.Castle.startRoomFuncEast=function(){const e=Math.floor(this.tilesY/2);return{x:this.tilesX-1,y:e,room:this.findTemplate({name:"entrance_e"})}},t.Castle.startFuncs.E=t.Castle.startRoomFuncEast,t.Castle.startRoomFuncNorthEast=function(){return{x:this.tilesX-1,y:0,room:this.findTemplate({name:"entrance_ne"})}},t.Castle.startFuncs.NE=t.Castle.startRoomFuncNorthEast,t.Castle.startRoomFuncNorthWest=function(){return{x:0,y:0,room:this.findTemplate({name:"entrance_nw"})}},t.Castle.startFuncs.NW=t.Castle.startRoomFuncNorthWest,t.Castle.startRoomFuncSouthEast=function(){const e=this.tilesY-1;return{x:this.tilesX-1,y:e,room:this.findTemplate({name:"entrance_se"})}},t.Castle.startFuncs.SE=t.Castle.startRoomFuncSouthEast,t.Castle.startRoomFuncSouthWest=function(){return{x:0,y:this.tilesY-1,room:this.findTemplate({name:"entrance_sw"})}},t.Castle.startFuncs.SW=t.Castle.startRoomFuncSouthWest,t.Castle.startFuncTwoGates=function(){const e=Math.floor(this.tilesX/2),t=this.findTemplate({name:"entrance_n"}),n=this.findTemplate({name:"entrance_s"});return this.addRoom(t,e,0),{x:e,y:this.tilesY-1,room:n}},t.Castle.startFuncFourGates=function(){const e=Math.floor(this.tilesX/2),t=Math.floor(this.tilesY/2),n=this.findTemplate({name:"entrance_n"}),s=this.findTemplate({name:"entrance_s"}),r=this.findTemplate({name:"entrance_e"}),a=this.findTemplate({name:"entrance_w"});return this.addRoom(n,e,0),this.addRoom(r,this.tilesX-1,t),this.addRoom(a,0,t),{x:e,y:this.tilesY-1,room:s}},t.Castle.constraintFunc=function(e,n,s){if(0===e&&0===n)return this.findTemplate({name:"corner_nw"});if(0===e&&n===this.tilesY-1)return this.findTemplate({name:"corner_sw"});if(e===this.tilesX-1&&0===n)return this.findTemplate({name:"corner_ne"});if(e===this.tilesX-1&&n===this.tilesY-1)return this.findTemplate({name:"corner_se"});if(0===n){const e=this.findTemplate({name:"corridor_north"}),n=this.findTemplate({name:"corridor_sew"});if(n){if("S"===s)return n;if(o.getUniform()<t.Castle.corridorDoorThr)return n}return e}if(n===this.tilesY-1){const e=this.findTemplate({name:"corridor_south"}),n=this.findTemplate({name:"corridor_new"});if(n){if("N"===s)return n;if(o.getUniform()<t.Castle.corridorDoorThr)return n}return e}if(0===e){const e=this.findTemplate({name:"corridor_west"}),n=this.findTemplate({name:"corridor_nse"});if(n){if("E"===s)return n;if(o.getUniform()<t.Castle.corridorDoorThr)return n}return e}if(e===this.tilesX-1){const e=this.findTemplate({name:"corridor_east"}),n=this.findTemplate({name:"corridor_nsw"});if(n){if("W"===s)return n;if(o.getUniform()<t.Castle.corridorDoorThr)return n}return e}return null},t.Castle.constraintFuncCross=function(e,n,s){const a=t.Castle.constraintFunc.call(this,e,n,s),i=Math.floor(this.tilesX/2),l=Math.floor(this.tilesY/2);if(null===a||e===i||n===l){if(0===e&&n===l)return this.findTemplate({name:"corridor_nse"});if(e===this.tilesX-1&&n===l)return this.findTemplate({name:"corridor_nsw"});if(0===n&&e===i)return this.findTemplate({name:"corridor_sew"});if(n===this.tilesY-1&&e===i)return this.findTemplate({name:"corridor_new"});if(e===i&&n===l){const e=o.arrayGetRand(t.Castle.tiles.crossCenter);return r.Template.createTemplate(e)}if(e===i){if("E"===s)return this.findTemplate({name:"corridor_nse"});if("W"===s)return this.findTemplate({name:"corridor_nsw"});const e=this.findTemplate({name:"corridor_east"}),t=this.findTemplate({name:"corridor_nsw"}),n=this.findTemplate({name:"corridor_west"}),r=this.findTemplate({name:"corridor_nse"});return o.arrayGetRand([e,t,n,r])}if(n===l){if("S"===s)return this.findTemplate({name:"corridor_sew"});if("N"===s)return this.findTemplate({name:"corridor_new"});const e=this.findTemplate({name:"corridor_north"}),t=this.findTemplate({name:"corridor_sew"}),n=this.findTemplate({name:"corridor_south"}),r=this.findTemplate({name:"corridor_new"});return o.arrayGetRand([e,t,n,r])}}return a},t.Castle.roomCount=-1,t.Castle.Models={},t.Castle.Models.full=[].concat(t.Castle.tiles.branch).concat(t.Castle.tiles.corner).concat(t.Castle.tiles.term).concat(t.Castle.tiles.entrance).concat(t.Castle.tiles.corridor).concat(t.Castle.tiles.storerooms).concat(a.Vault.tiles.vault).concat(a.Vault.tiles.corner),t.Castle.Models.residential=t.Castle.tiles.residential.concat(t.Castle.Models.full),t.Castle.Models.outerWall=[].concat(t.Castle.tiles.entranceWall).concat(t.Castle.tiles.corner).concat(t.Castle.tiles.corridor).concat(t.Castle.tiles.corridorWithExit),t.Castle.templates={},t.Castle.templates.all=t.Castle.Models.full.map(e=>r.Template.createTemplate(e));let i=r.Template.transformList(t.Castle.templates.all);t.Castle.templates.all=t.Castle.templates.all.concat(i),t.Castle.templates.livingOnly=t.Castle.tiles.residential.map(e=>r.Template.createTemplate(e)),i=r.Template.transformList(t.Castle.templates.livingOnly),t.Castle.templates.livingOnly=t.Castle.templates.livingOnly.concat(i),t.Castle.templates.residential=t.Castle.templates.livingOnly.concat(t.Castle.templates.all),r.verifyTiles("tiles.castle.ts","Castle.templates.all",t.Castle.templates.all)},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LevelSurroundings=void 0;const r=s(n(4)),a=n(13),o=n(9),i=n(24),l=n(46),c=n(31),u=n(18),h=o.Random.getRNG(),d=/\b(cliff|stone|steep cliff)\b/;function p(e){switch(e){case"wallmount":return!0;default:return!1}}t.LevelSurroundings=class{surround(e,t){if(t.cellsAround)return this.surroundWithCellsAround(e,t);const n=JSON.stringify(t);return r.default.err("LevelSurroundings","surround","No conf given for surround. Got: "+n),null}surroundWithCellsAround(e,t){const n=2*t.surroundX||20,s=2*t.surroundY||20,{cols:o,rows:h}=e.getMap(),p=o+n,f=h+s,{cellsAround:m}=t,g=new c.MapGenerator;let y=null;if(this.hasNMountains(m)>0){const e={skip:{floor:!0}},r=this.getWallConfFromCells(t,n,s);if(y=g.createWall(p,f,r).map,"wallmount"===m.S){const t={cellsAround:{S:"wallmount"}},r=this.getWallConfFromCells(t,n,s),o=g.createWall(p,f,r);a.Geometry.mergeMapBaseElems(y,o.map,0,0,e)}if("wallmount"===m.W){const t={cellsAround:{W:"wallmount"}},r=this.getWallConfFromCells(t,n,s),o=g.createWall(p,f,r);a.Geometry.mergeMapBaseElems(y,o.map,0,0,e)}}else{y=new l.CellMap(p,f)}const v=new i.Level(y),b={wallmount:!0},_={};Object.keys(m).forEach(e=>{let t=m[e];t.match(d)&&(t="cliffs");const n=a.Geometry.dirToBbox(p,f,e);n?(_[t]||(_[t]=[]),_[t].push(n)):r.default.err("LevelSurroundings","surroundWithCellsAround",`Received null bbox from dir ${e}, type ${t}`)});const E=[];Object.keys(_).forEach(e=>{const t=_[e],n=a.Geometry.combineAdjacent(t);E.push([e,n])}),E.forEach(e=>{const[t,n]=e;n.forEach(e=>{if("water"===t){const t={ratio:.6,skipTypes:b,forestSize:300,nForests:10};g.addLakes(v.getMap(),t,e)}else if("tree"===t){const t={ratio:1,skipTypes:b,nForests:10};g.addForest(v.getMap(),t,e)}else if("cliffs"===t){const t=c.MapGenerator.getOptions("mountain");t.nRoadTurns=0,t.highRockThr=100,t.snowRatio=0,t.chasmThr=-100,t.skipTypes=b,g.addCliffs(v.getMap(),t,e)}else if("wallmount"!==t&&"floor"!==t){const n={ratio:.85,skipTypes:b,forestSize:200,nForests:10},s=[t];g.addSplashes(v.getMap(),n,e,s)}})}),function(e,t,n){let s=!0;return t.forEach(t=>{e[t]!==n&&(s=!1)}),s}(m,r.default.DIR_NSEW,"wallmount")&&r.default.DIAG_DIR_ABBR.forEach(e=>{if("wallmount"!==m[e]){const t=a.Geometry.dirToBbox(p,f,e);if(t){const[n,s]=[t.ulx,t.lrx];let[r,o]=[t.uly,t.lry];"SW"!==e&&"NE"!==e||([r,o]=[o,r]);const i=a.Geometry.getCaveConnLine(n,r,s,o),l=v.getMap();i.forEach(e=>{l.hasXY(e[0],e[1])&&l.setBaseElemXY(e[0],e[1],u.ELEM.FLOOR)})}}});return a.Geometry.mergeLevels(v,e,n/2,s/2,{skip:{floor:!0}}),this.offsetFunc=(e,t)=>[e+n/2,t+s/2],this.adjustCoord=e=>e.map(e=>this.offsetFunc(e[0],e[1])),this.lastLevelID=v.getID(),v}getWallConfFromCells(e,t,n){const{cellsAround:s}=e,r={};return"wallmount"===s.E?(r.alignHorizontal="right",r.east=!1,r.west=!1,r.north=!0,r.south=!0):"wallmount"===s.W&&(r.alignHorizontal="left",r.east=!1,r.west=!1,r.north=!0,r.south=!0),"wallmount"===s.N?(r.alignVertical="top",r.east=!0,r.west=!0):"wallmount"===s.S&&(r.alignVertical="bottom",r.east=!0,r.west=!0),r.meanWx=h.getUniformInt(5,t),r.meanWy=h.getUniformInt(5,n),r.wallElem=u.ELEM.WALL_MOUNT,r}hasNMountains(e){const t=Object.values(e);let n=0;return t.forEach(e=>{"wallmount"===e&&++n}),n}scaleExtras(e){this.lastLevelID!==e.getID()&&r.default.err("LevelSurroundings","scaleExtras","Previous surrounded level not given. Scaling will not work");const t=e.getExtras();["corridor","entrance","room","storeroom","vault"].forEach(e=>{e in t&&this.scaleRooms(t[e])}),t.houses&&t.houses.forEach(e=>{const t=e.getBbox(),[n,s]=this.offsetFunc(t.ulx,t.uly);e.adjustCoord(n,s)})}scaleRooms(e){e.forEach(e=>{[e._x1,e._y1]=this.offsetFunc(e._x1,e._y1),[e._x2,e._y2]=this.offsetFunc(e._x2,e._y2)})}getNonBlockedDirs(e){const t=[],n={};return["N","S","E","W"].forEach(s=>{p(e[s])?n[s]=!0:t.push(s)}),n.E||n.N||p(e.NE)||t.push("NE"),n.W||n.N||p(e.NW)||t.push("NW"),n.E||n.S||p(e.SE)||t.push("SE"),n.W||n.S||p(e.SW)||t.push("SW"),t}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CreateStat=t.LoadStat=void 0,function(e){e.EMPTY="EMPTY",e.LOADED="LOADED",e.JSON="JSON",e.ON_DISK="ON_DISK",e.JSON2LOADED="JSON2LOADED",e.LOADED2JSON="LOADED2JSON",e.JSON2ON_DISK="JSON2ON_DISK",e.ON_DISK2JSON="ON_DISK2JSON"}(t.LoadStat||(t.LoadStat={})),function(e){e.EMPTY="EMPTY",e.CREATED="CREATED",e.POPULATED="POPULATED"}(t.CreateStat||(t.CreateStat={}))},function(e,t){var n=0,s=Math.random();e.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++n+s).toString(36))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=o(n(1)),a=o(n(107));function o(e){return e&&e.__esModule?e:{default:e}}t.default=(0,a.default)((function(e,t,n,a,o){var i=e[t],l=void 0===i?"undefined":s(i);return r.default.isValidElement(i)?new Error("Invalid "+a+" `"+o+"` of type ReactElement supplied to `"+n+"`, expected a ReactComponent or a DOMElement. You can usually obtain a ReactComponent or DOMElement from a ReactElement by attaching a ref to it."):"object"===l&&"function"==typeof i.render||1===i.nodeType?null:new Error("Invalid "+a+" `"+o+"` of value `"+i+"` supplied to `"+n+"`, expected a ReactComponent or a DOMElement.")})),e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t){return e="function"==typeof e?e():e,a.default.findDOMNode(e)||t};var s,r=n(17),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryZone=void 0;const i=o(n(4)),l=n(15)("bitn:FactoryZone"),c=a(n(47)),u=n(86),h=n(64),d=n(28),p=n(31),f=n(9),m=n(12),g=a(n(16)),y=f.Random.getRNG();t.FactoryZone=class{constructor(){this._verif=new c.Conf("FactoryZone"),this._parser=m.ObjectShell.getParser(),this._levelFact=new d.FactoryLevel,this._factBase=new u.FactoryBase,this.rng=y}getRandLevelType(){const e=["uniform","rooms","rogue","digger"];return e[this.rng.randIndex(e)]}setRNG(e){this.rng=e}addItemsAndActors(e,t){this._verif.verifyConf("addItemsAndActors",t,["nLevel","sqrPerItem","sqrPerActor","maxValue"]);const n=e.getMap().getFree().length,s=Math.round(n/t.sqrPerActor),r=Math.round(n/t.sqrPerItem),a=r;l(`Adding ${s} monsters and items `+r+" to the level");const o=(e,t)=>n=>n.value>=e&&n.value<=t,c={nLevel:t.nLevel,itemsPerLevel:r,item:o(0,t.maxValue),maxValue:t.maxValue||100,food:!0,gold:!0};t.hasOwnProperty("food")&&(c.food=t.food),t.hasOwnProperty("gold")&&(c.gold=t.gold),t.item?(c.item=t.item,l("Set itemConf.func to "+t.item.toString())):t.minValue&&(c.item=o(t.minValue,t.maxValue)),this._factBase.addNRandItems(e,this._parser,c);const u={actorsPerLevel:t.actorsPerLevel||s,maxDanger:t.maxDanger||t.nLevel+1};if(t.actor&&("function"==typeof t.actor?u.actor=t.actor:i.default.err("FactoryZone","addItemsAndActors","conf.actor must be a function")),this._factBase.addNRandActors(e,this._parser,u),c.gold){const n={goldPerLevel:a,nLevel:t.nLevel+1,maxValue:c.maxValue,item:()=>!0};this._factBase.addRandomGold(e,this._parser,n)}}createMountainLevel(e){let t=Object.assign(p.MountainGenerator.getFaceOptions(),{maxValue:100,sqrPerActor:50,sqrPerItem:200,nLevel:4});t=Object.assign(t,e),l("Creating mountain level with "+e);const n=(new p.MountainGenerator).createFace(e.x,e.y,t);return this.addItemsAndActors(n,t),n}createSummitLevel(e){this._verif.verifyConf("createSummitLevel",e,["cols","rows"]);let t={maxValue:100,sqrPerActor:20,sqrPerItem:200,nLevel:4,maxDanger:3};t=Object.assign(t,e);const n=(new p.MountainGenerator).createSummit(e.cols,e.rows,t);return l("Creating summit level with "+e),this.addItemsAndActors(n,t),e.maxValue||(e.maxValue=t.maxValue),n}createCityLevel(e,t){const n=u.Factory.cityConfBase(t);n.parser=this._parser;let s=null;const{x:r,y:a}=t;if(n.groupType)switch(n.groupType){case"village":s=this.createVillageLevel(r,a,n);break;case"capital":s=this.createCapitalLevel(e,r,a,n);break;case"stronghold":s=this.createStrongholdLevel(r,a,n);break;case"fort":s=this.createFortLevel(r,a,n)}if(null===s&&(s=this._levelFact.createLevel("town",r,a,n),this.populateCityLevel(s,n)),t.friendly){s.getActors().forEach(e=>{e.has("NonSentient")||e.getBrain().getMemory().removeEnemyType("player")})}if(t.disposition){const{disposition:e}=t;s.getActors().forEach(t=>{Object.keys(e).forEach(n=>{"enemy"===e[n]&&t.getBrain().getMemory().addEnemyType(n)})})}return s}createVillageLevel(e,t,n){n.levelType="empty",n.wallType="wooden",n.actorsPerLevel||(n.actorsPerLevel=30),n.maxDanger||(n.maxDanger=3),n.itemsPerLevel||(n.itemsPerLevel=2*n.maxDanger);const s=(new p.CityGenerator).create(e,t,n);return this.populateCityLevel(s,n),this.addItemsToCityLevel(s,n),s}createFortLevel(e,t,n){const s=new p.CastleGenerator;n.roomCount=-1,n.maxDanger||(n.maxDanger=6);const r=s.create(100,84,n);return this.populateCityLevel(r,n),r}createCapitalLevel(e,t,n,s){s.levelType="miner";let r=null;return 0===e?(s.levelType="townwithwall",r=this._levelFact.createLevel("townwithwall",200,84,s)):r=this._levelFact.createLevel("town",100,84,s),this.populateCityLevel(r,s),r}createStrongholdLevel(e,t,n){n.levelType="miner";const s=this._levelFact.createLevel("town",100,84,n);return this.populateCityLevel(s,n),s}populateCityLevel(e,t){let n=t.alignment;n||(n=this.rng.arrayGetRand(i.default.ALIGNMENTS)),t.actor?this.populateWithActors(e,t):n===i.default.ALIGN_GOOD?this.populateWithHumans(e,t):n===i.default.ALIGN_EVIL?this.populateWithEvil(e,t):this.populateWithNeutral(e,t)}addItemsToCityLevel(e,t){const n=e.getMap().getCells(e=>"floorhouse"===e.getBaseElem().getType()),s=new h.FactoryItem,r=m.ObjectShell.getParser(),a={item:e=>e.value<=10*t.maxDanger,maxValue:50*t.maxDanger};i.default.isNullOrUndef([t.itemsPerLevel])||(a.itemsPerLevel=t.itemsPerLevel),s.addItemsToCells(e,r,n,a)}populateWithActors(e,t){const n={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,actor:t.actor};if(0===this._factBase.addNRandActors(e,this._parser,n)){const t=e.getParent();let s="No actors added to level.";s+="\nUsed conf was "+JSON.stringify(n),t&&(s+="\nLevel parent: "+t.getName()),i.default.err("FactoryZone","populateWithActors",s)}}populateWithHumans(e,t){const n={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,actor:e=>"human"===e.type&&"shopkeeper"!==e.name};t.actor&&(n.actor=t.actor),this._factBase.addNRandActors(e,this._parser,n)}populateWithEvil(e,t){let n=!1;for(;!n;){const s=this.rng.arrayGetRand(i.default.EVIL_RACES),r={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,actor:e=>e.type===s};t.actor&&(r.actor=t.actor);this._factBase.addNRandActors(e,this._parser,r)>0&&(n=!0)}}populateWithNeutral(e,t){const n=this.rng.arrayGetRand(i.default.NEUTRAL_RACES),s={actorsPerLevel:t.actorsPerLevel||100,maxDanger:t.maxDanger||10,actor:e=>e.type===n};t.actor&&(s.actor=t.actor),this._factBase.addNRandActors(e,this._parser,s)}addActorToLevel(e,t){const n=this._parser.createActor(e),s=t.getFreeRandCell();t.addActor(n,s.getX(),s.getY())}addExtraDungeonFeatures(e,t){const n=e.getExtras();if(n.rooms){n.rooms.forEach(t=>{t.getDoors((t,n)=>{e.addElement(new g.ElementDoor(!0),t,n)})});const s=this.rng.arrayGetRand(n.rooms).getBbox();(new u.FactoryBase).addActorsToBbox(e,s,t)}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorldCreator=t.WorldConf=void 0;const r=s(n(4)),a=n(9),o=n(97),i=a.Random.getRNG(),l={seed:0,difficulty:"Medium",items:"Medium",monsters:"Medium",worldSize:"Medium",areaSize:"Medium",climate:"Medium",elevation:"Medium",mountainSize:"Medium",excavation:"Medium",dungeonSize:"Medium",forestation:"Medium",population:"Medium",citySize:"Medium",size:"Medium",water:"Sparse"},c={Small:1,Medium:2,Large:4,Huge:8},u={Small:.7,Medium:1,High:1.3,Huge:1.7},h={Small:{x:3,y:3},Medium:{x:5,y:5},Large:{x:5,y:7},Huge:{x:7,y:9}};t.WorldConf={},t.WorldConf.featCoeff=.3;const d=(e,t)=>i.getUniformInt(e,t);t.WorldConf.getBaseConf=e=>{let n=null;switch(e){case"branch":n=t.WorldConf.createSingleBranchConf();break;case"city":n={name:"city",nQuarters:1,quarter:[t.WorldConf.createSingleQuarterConf()]};break;case"dungeon":n={name:"dungeon",nBranches:1,branch:[t.WorldConf.createSingleBranchConf()]};break;case"face":n=t.WorldConf.createSingleFaceConf();break;case"mountain":n={name:"mountain",nFaces:1,face:[t.WorldConf.createSingleFaceConf()]};break;case"quarter":n=t.WorldConf.createSingleQuarterConf();break;default:console.log("No legal featureType given")}return n},t.WorldConf.createQuarterConnections=e=>{if(1===e.length)return null;const t=[];for(let n=1;n<e.length;n++){const s=e[n-1],a=e[n];let o=i.getWeightedLinear(s.nLevels-1);const l=0;r.default.isNullOrUndef([o])&&(o=s.nLevels-1),r.default.isNullOrUndef([o,l])&&r.default.err("WorldConf","createQuarterConnections",`l0 ${o} or l1 ${l} is undef`);const c=[s.name,a.name,o,l];t.push(c)}return t},t.WorldConf.createFaceConnections=(e,t)=>{if(1===t.length)return null;const n=[];for(let e=1;e<t.length;e++){const s=t[e-1],a=t[e];let o=i.getWeightedLinear(s.nLevels-1);const l=0;r.default.isNullOrUndef([o])&&(o=s.nLevels-1);const c=[s.name,a.name,o,l];n.push(c)}return n},t.WorldConf.createBranchConnections=(e,t)=>{if(1===t.length)return null;const n=[];for(let e=1;e<t.length;e++){const s=t[e-1],a=t[e];let o=i.getWeightedLinear(s.nLevels-1);const l=0;r.default.isNullOrUndef([o])&&(o=s.nLevels-1);const c=[s.name,a.name,o,l];n.push(c)}return n},t.WorldConf.setDistFromStart=(e,t)=>{const n=Math.floor(t.maxX/2),s=t.maxY;e.distX=Math.abs(e.x-n),e.distY=Math.abs(e.y-s),e.distSqr=Math.sqrt(Math.pow(e.distX,2)+Math.pow(e.distY,2))},t.WorldConf.getPlayerStart=(e,t)=>{const n=e.maxY-1,s=Math.floor(e.maxX/2);return{place:t.name,x:s,y:n}},t.WorldConf.getXYInArea=e=>({x:d(0,e.maxX-1),y:d(0,e.maxY-1)}),t.WorldConf.getNumBranches=(e,t)=>{switch(t.dungeonSize){case"Small":return 1;case"Medium":return d(1,2);case"Large":return d(1,3);case"Huge":return d(1,4);default:return 1}},t.WorldConf.getNumQuarters=(e,t)=>{switch(t.citySize){case"Small":return 1;case"Medium":return d(1,2);case"Large":return d(1,3);case"Huge":return d(1,4);default:return 1}},t.WorldConf.getNumFaces=(e,t)=>{switch(t.mountainSize){case"Small":return 1;case"Medium":return d(1,2);case"Large":return d(1,3);case"Huge":return d(1,4);default:return 1}},t.WorldConf.getNumLevels=e=>{switch(e){case"dungeon":return d(1,10);case"city":case"mountain":return d(1,3);default:return 1}},t.WorldConf.scaleNumFeatures=(e,t)=>{switch(e){case"dungeon":return u[t.excavation];case"mountain":return u[t.elevation];case"city":return u[t.population];default:r.default.err("Creator","scaleNumFeatures","Unknown feat type "+e)}return 1},t.WorldConf.getNumFeatures=(e,n,s)=>{let r=(n.maxX+1)*(n.maxY+1);return r=Math.ceil(r*t.WorldConf.scaleNumFeatures(e,s)),r=i.getNormal(r,t.WorldConf.featCoeff*r),r},t.WorldConf.createDungeonsConf=(e,n)=>{const s=t.WorldConf.getNumFeatures("dungeon",e,n),r=[];for(let a=0;a<s;a++){const s=t.WorldConf.createSingleDungeonConf(e,n);r.push(s)}return r},t.WorldConf.createSingleDungeonConf=(e,n)=>{const s=t.WorldConf.getXYInArea(e),r=Object.assign({},e);r.x=s.x,r.y=s.y,t.WorldConf.setDistFromStart(r,e);const a=t.WorldConf.createBranchesConf(r,n),i=t.WorldConf.createBranchConnections("branch",a),l={name:o.Names.getGenericPlaceName("dungeon"),x:s.x,y:s.y,nBranches:a.length,branch:a,maxDanger:5,maxRarity:2};return i&&(l.connectLevels=i),l},t.WorldConf.createBranchesConf=(e,n)=>{const s=t.WorldConf.getNumBranches(e,n),r=[];for(let e=0;e<s;e++){const n=t.WorldConf.createSingleBranchConf();r.push(n),0===e&&(n.entranceLevel=0)}return r},t.WorldConf.createSingleBranchConf=()=>{const e=t.WorldConf.getNumLevels("dungeon");return{dungeonX:80,dungeonY:28,sqrPerItem:40,sqrPerActor:40,maxDanger:2,maxValue:100,dungeonType:"digger",name:o.Names.getGenericPlaceName("branch"),nLevels:e}},t.WorldConf.createSingleQuarterConf=()=>({nLevels:t.WorldConf.getNumLevels("city"),name:o.Names.getGenericPlaceName("quarter"),maxDanger:5}),t.WorldConf.createSingleFaceConf=()=>{const e=t.WorldConf.getNumLevels("mountain");return{maxDanger:5,x:100,y:200,name:o.Names.getGenericPlaceName("face"),nLevels:e}};class p{constructor(){this.nCreated={}}createWorldConf(e){e.name||r.default.err("Creator","createWorldConf","conf.name must be specified."),Object.keys(l).forEach(t=>{e.hasOwnProperty(t)||(e[t]=l[t])}),this.rand=new a.Random,this.rand.setSeed(e.seed);const n=this.createAreasConf(e),s=t.WorldConf.getPlayerStart(n[0],e);return{name:e.name,nAreas:n.length,area:n,playerStart:s}}createAreasConf(e){const t=c[e.worldSize],n=[];for(let s=0;s<t;s++){const t=this.createSingleAreaConf(s,e);n.push(t)}return n}createSingleAreaConf(e,n){const s=h[n.areaSize],a=n.maxX||s.x,o=n.maxY||s.y,i={maxX:a,maxY:o,areaNum:e},l=t.WorldConf.createDungeonsConf(i,n),c=this.createCitiesConf(i,n),u=this.createMountainsConf(i,n);return{name:this.getName("area"),cols:r.default.AREA_LEVEL_COLS,rows:r.default.AREA_LEVEL_ROWS,maxX:a,maxY:o,nDungeons:l.length,nCities:c.length,nMountains:u.length,dungeon:l,city:c,mountain:u}}createCitiesConf(e,n){const s=t.WorldConf.getNumFeatures("city",e,n),r=[];for(let t=0;t<s;t++){const t=this.createSingleCityConf(e,n);r.push(t)}return r}createSingleCityConf(e,n){const s=t.WorldConf.getXYInArea(e),r=Object.assign({},e);r.x=s.x,r.y=s.y,t.WorldConf.setDistFromStart(r,e);const a=this.createQuartersConf(r,n),o=t.WorldConf.createQuarterConnections(a),i={name:"",x:s.x,y:s.y,nQuarters:a.length,quarter:a,maxDanger:5,maxRarity:2};return o&&(i.connectLevels=o),i}createQuartersConf(e,n){const s=t.WorldConf.getNumQuarters(e,n),r=[];for(let e=0;e<s;e++){const n=t.WorldConf.createSingleQuarterConf();0===e&&(n.entranceLevel=0),r.push(n)}return r}createMountainsConf(e,n){const s=t.WorldConf.getNumFeatures("mountain",e,n),r=[];for(let t=0;t<s;t++){const t=this.createSingleMountainConf(e,n);r.push(t)}return r}createSingleMountainConf(e,n){const s=t.WorldConf.getXYInArea(e),r=Object.assign({},e);r.x=s.x,r.y=s.y,t.WorldConf.setDistFromStart(r,e);const a=this.createFacesConf(r,n),o=t.WorldConf.createFaceConnections("mountain",a),i={name:"",x:s.x,y:s.y,nFaces:a.length,face:a,maxDanger:5,maxRarity:2};return o&&(i.connectLevels=o),i}createFacesConf(e,n){const s=t.WorldConf.getNumFaces(e,n),r=[];for(let e=0;e<s;e++){const n=t.WorldConf.createSingleFaceConf();r.push(n),0===e&&(n.entranceLevel=0)}return r}getName(e){return this.nCreated.hasOwnProperty(e)||(this.nCreated[e]=0),this.nCreated[e]+=1,`${e} ${this.nCreated[e]}`}}t.WorldCreator=p,t.WorldConf.Creator=p},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.OW=void 0;const r=s(n(4));t.OW={},t.OW.LL_WE="โ",t.OW.LL_NS="โ",t.OW.CC_NW="โ",t.OW.CC_NE="โ",t.OW.CC_SW="โ",t.OW.CC_SE="โ",t.OW.XX="โฌ",t.OW.EMPTY="e",t.OW.TT_W="โ",t.OW.TT_E="โฃ",t.OW.TT_N="โฆ",t.OW.TT_S="โฉ",t.OW.TERM=".",t.OW.WCAPITAL="โ",t.OW.BCAPITAL="โ",t.OW.BTOWER="โ",t.OW.WTOWER="โ",t.OW.WDUNGEON="โ",t.OW.MOUNTAIN="^",t.OW.BVILLAGE="โฒ",t.OW.WVILLAGE="โณ",t.OW.VTUNNEL="|",t.OW.HTUNNEL="-",t.OW.MFORT="โ",t.OW.PROB_BVILLAGE=.25,t.OW.biomeTypeMap={arctic:0,alpine:1,tundra:2,taiga:3,forest:4,grassland:5},t.OW.PATH_WCAP_BTOWER="PATH_WCAP_BTOWER",t.OW.PATH_BEGIN_WCAP="PATH_BEGIN_WCAP";const a=r.default.cellStyles.elements;t.OW.classNames={[t.OW.TERM]:a.floor,[t.OW.MOUNTAIN]:a.highrock,[t.OW.LL_WE]:a.mountain,[t.OW.LL_NS]:a.mountain,[t.OW.CC_NW]:a.mountain,[t.OW.CC_NE]:a.mountain,[t.OW.CC_SW]:a.mountain,[t.OW.CC_SE]:a.mountain,[t.OW.XX]:a.mountain,[t.OW.TT_W]:a.mountain,[t.OW.TT_E]:a.mountain,[t.OW.TT_N]:a.mountain,[t.OW.TT_S]:a.mountain,default:"cell-element-ow"},t.OW.PASSABLE_FORT=[t.OW.WCAPITAL,t.OW.WTOWER,t.OW.BTOWER,t.OW.BCAPITAL],t.OW.BIOME={},t.OW.BIOME.ALPINE="alpine",t.OW.BIOME.ARCTIC="arctic",t.OW.BIOME.TUNDRA="tundra",t.OW.BIOME.TAIGA="taiga",t.OW.ILLEGAL_POS=-1,t.OW.CELL_ANY="OW.CELL_ANY",t.OW.E_HAS_CONN=[t.OW.XX,t.OW.TT_W,t.OW.TT_N,t.OW.TT_S,t.OW.CC_NW,t.OW.CC_SW,t.OW.LL_WE],t.OW.W_HAS_CONN=[t.OW.XX,t.OW.TT_E,t.OW.TT_N,t.OW.TT_S,t.OW.CC_NE,t.OW.CC_SE,t.OW.LL_WE],t.OW.N_HAS_CONN=[t.OW.XX,t.OW.TT_S,t.OW.TT_W,t.OW.TT_E,t.OW.CC_SW,t.OW.CC_SE,t.OW.LL_NS],t.OW.S_HAS_CONN=[t.OW.XX,t.OW.TT_N,t.OW.TT_W,t.OW.TT_E,t.OW.CC_NW,t.OW.CC_NE,t.OW.LL_NS],t.OW.N_BORDER=[t.OW.LL_WE,t.OW.TT_N],t.OW.S_BORDER=[t.OW.LL_WE,t.OW.TT_S],t.OW.E_BORDER=[t.OW.LL_NS,t.OW.TT_E],t.OW.W_BORDER=[t.OW.LL_NS,t.OW.TT_W],t.OW.ALL_WALLS=[t.OW.XX,t.OW.TT_N,t.OW.TT_S,t.OW.TT_E,t.OW.TT_W,t.OW.CC_SW,t.OW.CC_NW,t.OW.CC_SE,t.OW.CC_NE,t.OW.LL_WE,t.OW.LL_NS],t.OW.ALL_WALLS_LUT={},t.OW.ALL_WALLS.forEach(e=>{t.OW.ALL_WALLS_LUT[e]=e}),t.OW.LINE_WE_WEIGHT={[t.OW.LL_WE]:10,[t.OW.TT_N]:3,[t.OW.TT_S]:3,[t.OW.XX]:1},t.OW.LINE_NS_WEIGHT={[t.OW.LL_NS]:10,[t.OW.TT_E]:3,[t.OW.TT_W]:3,[t.OW.XX]:1},t.OW.CAN_CONNECT={[t.OW.LL_WE]:{N:[],S:[],E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.LL_NS]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:[],W:[]},[t.OW.CC_NW]:{N:t.OW.N_HAS_CONN,S:[],E:[],W:t.OW.W_HAS_CONN},[t.OW.CC_NE]:{N:t.OW.N_HAS_CONN,S:[],E:t.OW.E_HAS_CONN,W:[]},[t.OW.CC_SW]:{N:[],S:t.OW.S_HAS_CONN,E:[],W:t.OW.W_HAS_CONN},[t.OW.CC_SE]:{N:[],S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:[]},[t.OW.XX]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.EMPTY]:{N:[],S:[],E:[],W:[]},[t.OW.TT_W]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:[],W:t.OW.W_HAS_CONN},[t.OW.TT_E]:{N:t.OW.N_HAS_CONN,S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:[]},[t.OW.TT_N]:{N:t.OW.N_HAS_CONN,S:[],E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.TT_S]:{N:[],S:t.OW.S_HAS_CONN,E:t.OW.E_HAS_CONN,W:t.OW.W_HAS_CONN},[t.OW.TERM]:{N:[],S:[],E:[],W:[]}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorldSimulation=t.WS_EVENT=void 0;const i=o(n(15)).default("bitn:WorldSimulation"),l=o(n(4)),c=n(788),u=n(789),h=a(n(29)),d=n(61),p=n(82);var f;!function(e){e[e.PHASE_CHANGED=0]="PHASE_CHANGED",e[e.DAY_CHANGED=1]="DAY_CHANGED",e[e.MONTH_CHANGED=2]="MONTH_CHANGED",e[e.SEASON_CHANGED=3]="SEASON_CHANGED",e[e.YEAR_CHANGED=4]="YEAR_CHANGED"}(f=t.WS_EVENT||(t.WS_EVENT={}));class m{constructor(e){this.dayMan=new u.DayManager(e),this.seasonMan=new c.SeasonManager(e),this.seasonMan._debug=i.enabled,this.worldEntity=new d.BaseActor("WorldEntity"),this.worldEntity.add(new h.Location),this.updateCount=0}setLevel(e){if(!e)throw new Error("WorldSim: Tried to set null level");this.worldEntity.get("Location").setLevel(e)}getLevel(){return this.worldEntity.get("Location").getLevel()}setOwPos(e){this.seasonMan.setOwPos(e)}update(){if(this.dayMan.update(),this.dayMan.phaseChanged()&&this.processPhaseChanged(),this.dayMan.dayChanged()){this.dbg(this.updateCount,"dayChange detected"),this.seasonMan.update();const e=new h.WorldSimEvent;e.setEventType(f.DAY_CHANGED),this.worldEntity.add(e),this.seasonMan.monthChanged()&&(this.emitMonthChanged(),this.dbg(this.updateCount,"monthChange detected"),this.seasonMan.seasonChanged()&&(this.emitSeasonChanged(),this.seasonMan.yearChanged()&&this.emitYearChanged()))}this.changed("weather")&&(this.seasonMan.resetWeatherChanged(),this.processWeatherChanged()),++this.updateCount}getTimeOfDayMins(){return this.dayMan.getTimeMins()}getSeason(){return this.seasonMan.getSeason()}getWeather(){return this.seasonMan.getWeather()}getTemperature(){return this.seasonMan.getTemperature()}getHumidity(){return this.seasonMan.getHumidity()}getVisibility(){return this.dayMan.getVisibility()}setUpdateRates(e){this.dayMan.setUpdateRate(e)}setPool(e){this.dayMan.setPool(e),this.seasonMan.setPool(e)}setOverWorld(e){this.seasonMan.setBiomeMap(e.getBiomeMap())}toJSON(){return{dayManager:this.dayMan.toJSON(),seasonManager:this.seasonMan.toJSON(),updateCount:this.updateCount}}toString(){return"Day:    "+this.dayMan.toString()+"\nSeason: "+this.seasonMan.toString()}dbg(...e){if(i.enabled){const t=this.getSeason(),n=this.getTemperature();i(`|${t}, T${n}`,...e)}}emitMonthChanged(){const e=new h.WorldSimEvent;e.setEventType(f.MONTH_CHANGED),e.setEventData({season:this.seasonMan.getSeason()}),this.worldEntity.add(e)}emitSeasonChanged(){const e=new h.WorldSimEvent;e.setEventType(f.SEASON_CHANGED),e.setEventData({season:this.seasonMan.getSeason()}),this.worldEntity.add(e)}emitYearChanged(){const e=new h.WorldSimEvent;e.setEventType(f.YEAR_CHANGED),e.setEventData({season:this.seasonMan.getSeason()}),this.worldEntity.add(e)}changed(e){switch(e){case"day":return this.dayMan.dayChanged();case"month":return this.seasonMan.monthChanged();case"season":return this.seasonMan.seasonChanged();case"year":return this.seasonMan.yearChanged();case"weather":return this.seasonMan.weatherChanged();default:throw new Error("No change for "+e)}return!1}processPhaseChanged(){const e=new h.WorldSimEvent;e.setEventType(f.PHASE_CHANGED);const t=this.dayMan.getPhaseEntry();e.setEventData({currPhase:this.dayMan.getCurrPhase(),entry:t}),this.dbg("updateCount:",this.updateCount,"phaseChange detected",t),this.worldEntity.add(e),this.seasonMan.changeWeather();const n=this.getLevel();n&&n.has("Weather")&&n.get("Weather").setVisibility(this.getVisibility())}processWeatherChanged(){const e=this.getWeather(),t=this.getLevel();if(t){this.dbg(this.updateCount,"weather change detected -> ",e),t.removeAll("Weather");const n=new h.Weather;if(n.setWeatherType(e),n.setTemperature(this.getTemperature()),n.setHumidity(this.getHumidity()),n.setVisibility(this.getVisibility()),t.getActors().findIndex(e=>"WeatherActor"===e.getName())<0){const e=new p.WeatherActor("WeatherActor");t.addVirtualProp(l.default.TYPE_ACTOR,e)}t.add(n)}}}t.WorldSimulation=m,m.fromJSON=function(e){const t=new m;return t.dayMan=u.DayManager.fromJSON(e.dayManager),t.seasonMan=c.SeasonManager.fromJSON(e.seasonManager),t.updateCount=e.updateCount,t}},function(e,t,n){var s=n(104);
/*!
 * Chai - isProxyEnabled helper
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */e.exports=function(){return s.useProxy&&"undefined"!=typeof Proxy&&"undefined"!=typeof Reflect}},function(e,t){var n=Object.getOwnPropertyDescriptor((function(){}),"length");
/*!
 * Chai - addLengthGuard utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */e.exports=function(e,t,s){return n.configurable?(Object.defineProperty(e,"length",{get:function(){if(s)throw Error("Invalid Chai property: "+t+'.length. Due to a compatibility issue, "length" cannot directly follow "'+t+'". Use "'+t+'.lengthOf" instead.');throw Error("Invalid Chai property: "+t+'.length. See docs for proper usage of "'+t+'".')}}),e):e}},function(e,t,n){var s=n(104),r=n(51),a=n(418),o=n(168),i=["__flags","__methods","_obj","assert"];e.exports=function(e,t){return o()?new Proxy(e,{get:function e(n,o){if("string"==typeof o&&-1===s.proxyExcludedKeys.indexOf(o)&&!Reflect.has(n,o)){if(t)throw Error("Invalid Chai property: "+t+"."+o+'. See docs for proper usage of "'+t+'".');var l=null,c=4;throw a(n).forEach((function(e){if(!Object.prototype.hasOwnProperty(e)&&-1===i.indexOf(e)){var t=function(e,t,n){if(Math.abs(e.length-t.length)>=n)return n;for(var s=[],r=0;r<=e.length;r++)s[r]=Array(t.length+1).fill(0),s[r][0]=r;for(var a=0;a<t.length;a++)s[0][a]=a;for(r=1;r<=e.length;r++){var o=e.charCodeAt(r-1);for(a=1;a<=t.length;a++)Math.abs(r-a)>=n?s[r][a]=n:s[r][a]=Math.min(s[r-1][a]+1,s[r][a-1]+1,s[r-1][a-1]+(o===t.charCodeAt(a-1)?0:1))}return s[e.length][t.length]}(o,e,c);t<c&&(l=e,c=t)}})),null!==l?Error("Invalid Chai property: "+o+'. Did you mean "'+l+'"?'):Error("Invalid Chai property: "+o)}return-1!==i.indexOf(o)||r(n,"lockSsfi")||r(n,"ssfi",e),Reflect.get(n,o)}}):e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,a.default)();try{return e.activeElement}catch(e){}};var s,r=n(52),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=o(n(710)),r=o(n(721)),a="function"==typeof r.default&&"symbol"==typeof s.default?function(e){return typeof e}:function(e){return e&&"function"==typeof r.default&&e.constructor===r.default&&e!==r.default.prototype?"symbol":typeof e};function o(e){return e&&e.__esModule?e:{default:e}}t.default="function"==typeof r.default&&"symbol"===a(s.default)?function(e){return void 0===e?"undefined":a(e)}:function(e){return e&&"function"==typeof r.default&&e.constructor===r.default&&e!==r.default.prototype?"symbol":void 0===e?"undefined":a(e)}},function(e,t,n){"use strict";t.__esModule=!0,t.EXITING=t.ENTERED=t.ENTERING=t.EXITED=t.UNMOUNTED=void 0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=u(n(3)),a=u(n(110)),o=u(n(259)),i=u(n(0)),l=u(n(1)),c=u(n(17));function u(e){return e&&e.__esModule?e:{default:e}}var h=o.default.end,d=t.UNMOUNTED=0,p=t.EXITED=1,f=t.ENTERING=2,m=t.ENTERED=3,g=t.EXITING=4,y=function(e){function t(n,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.call(this,n,s));r.updateStatus=function(){if(null!==r.nextStatus){r.cancelNextCallback();var e=c.default.findDOMNode(r);r.nextStatus===f?(r.props.onEnter(e),r.safeSetState({status:f},(function(){r.props.onEntering(e),r.onTransitionEnd(e,(function(){r.safeSetState({status:m},(function(){r.props.onEntered(e)}))}))}))):(r.props.onExit(e),r.safeSetState({status:g},(function(){r.props.onExiting(e),r.onTransitionEnd(e,(function(){r.safeSetState({status:p},(function(){r.props.onExited(e)}))}))}))),r.nextStatus=null}else r.props.unmountOnExit&&r.state.status===p&&r.setState({status:d})},r.cancelNextCallback=function(){null!==r.nextCallback&&(r.nextCallback.cancel(),r.nextCallback=null)},r.safeSetState=function(e,t){r.setState(e,r.setNextCallback(t))},r.setNextCallback=function(e){var t=!0;return r.nextCallback=function(n){t&&(t=!1,r.nextCallback=null,e(n))},r.nextCallback.cancel=function(){t=!1},r.nextCallback},r.onTransitionEnd=function(e,t){r.setNextCallback(t),e?((0,a.default)(e,h,r.nextCallback),setTimeout(r.nextCallback,r.props.timeout)):setTimeout(r.nextCallback,0)};var o=void 0;return r.nextStatus=null,n.in?n.transitionAppear?(o=p,r.nextStatus=f):o=m:o=n.unmountOnExit||n.mountOnEnter?d:p,r.state={status:o},r.nextCallback=null,r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this.updateStatus()},t.prototype.componentWillReceiveProps=function(e){var t=this.state.status;e.in?(t===d&&this.setState({status:p}),t!==f&&t!==m&&(this.nextStatus=f)):t!==f&&t!==m||(this.nextStatus=g)},t.prototype.componentDidUpdate=function(){this.updateStatus()},t.prototype.componentWillUnmount=function(){this.cancelNextCallback()},t.prototype.render=function(){var e=this.state.status;if(e===d)return null;var n=this.props,a=n.children,o=n.className,i=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(n,["children","className"]);Object.keys(t.propTypes).forEach((function(e){return delete i[e]}));var c=void 0;e===p?c=this.props.exitedClassName:e===f?c=this.props.enteringClassName:e===m?c=this.props.enteredClassName:e===g&&(c=this.props.exitingClassName);var u=l.default.Children.only(a);return l.default.cloneElement(u,s({},i,{className:(0,r.default)(u.props.className,o,c)}))},t}(l.default.Component);function v(){}y.propTypes={in:i.default.bool,mountOnEnter:i.default.bool,unmountOnExit:i.default.bool,transitionAppear:i.default.bool,timeout:i.default.number,exitedClassName:i.default.string,exitingClassName:i.default.string,enteredClassName:i.default.string,enteringClassName:i.default.string,onEnter:i.default.func,onEntering:i.default.func,onEntered:i.default.func,onExit:i.default.func,onExiting:i.default.func,onExited:i.default.func},y.displayName="Transition",y.defaultProps={in:!1,unmountOnExit:!1,transitionAppear:!1,timeout:5e3,onEnter:v,onEntering:v,onEntered:v,onExit:v,onExiting:v,onExited:v},t.default=y},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t){return e="function"==typeof e?e():e,a.default.findDOMNode(e)||t};var s,r=n(17),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e){return(0,r.default)(s.default.findDOMNode(e))};var s=a(n(17)),r=a(n(52));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Memory=void 0;const r=s(n(4)),a=[];t.Memory=class{constructor(){this._actors={},this._enemyTypes={},this._communications=[],this._lastAttackedID=null}addEnemyType(e){this._enemyTypes[e]=!0}hasEnemyType(e){return this._enemyTypes[e]}removeEnemyType(e){this._enemyTypes[e]&&delete this._enemyTypes[e]}removeEnemyTypes(){Object.keys(this._enemyTypes).forEach(e=>{this.removeEnemyType(e)})}addEnemyGroup(e){this._actors.enemyGroups||(this._actors.enemyGroups=[]),this._actors.enemyGroups.push(e)}addUsedStairs(e,t){this._actors.usedStairs||(this._actors.usedStairs={}),this._actors.usedStairs[e]=t}getStairsUsed(){return this._actors.usedStairs}addFriendGroup(e){this._actors.friendGroups||(this._actors.friendGroups=[]),this._actors.friendGroups.push(e)}isEnemyOrFriend(e){return this.isEnemy(e)||this.isFriend(e)}isEnemy(e){if(this._actors.hasOwnProperty("enemies")){if(this._actors.enemies.indexOf(e)>=0)return!0}if(this._actors.enemyGroups&&e.has("Groups")&&e.get("Groups").hasGroupId(this._actors.enemyGroups))return!0;if(!this.isFriend(e)){if(this._enemyTypes[e.getType()])return!0;if(e.isPlayer())return this._enemyTypes.player}return!1}isFriend(e){if(this._actors.hasOwnProperty("friends")){if(this._actors.friends.indexOf(e)>=0)return!0}return!!(this._actors.friendGroups&&e.has("Groups")&&e.get("Groups").hasGroupId(this._actors.friendGroups))}addFriend(e){this.isEnemy(e)&&this.removeEnemy(e),this._actors.hasOwnProperty("friends")||(this._actors.friends=[]),this.isFriend(e)||this._actors.friends.push(e)}addEnemySeenCell(e){this._actors.seen||(this._actors.seen={}),this._actors.seen[e.getID()]={x:e.getX(),y:e.getY(),level:e.getLevel().getID()}}hasSeen(e){return!(!this._actors.seen||!this._actors.seen[e])}getLastSeen(e){let t=e;return r.default.isActor(e)&&(t=e.getID()),this._actors.seen&&this._actors.seen[t]?this._actors.seen[t]:null}addEnemy(e){if(!r.default.isActor(e)){const t=JSON.stringify(e);r.default.err("Memory","addEnemy","Only actors can be added. Got: "+t)}this.isEnemy(e)||(this.isFriend(e)&&this.removeFriend(e),this._actors.hasOwnProperty("enemies")||(this._actors.enemies=[]),this._actors.enemies.push(e),this._communications.length>0&&(this._communications=[]))}removeEnemy(e){if(this._actors.hasOwnProperty("enemies")){const t=this._actors.enemies.indexOf(e);t>=0&&this._actors.enemies.splice(t,1)}}removeFriend(e){if(this._actors.hasOwnProperty("friends")){const t=this._actors.friends.indexOf(e);t>=0&&this._actors.friends.splice(t,1)}}getEnemyActors(){return this._actors.enemies||a}getFriendActors(){return this._actors.friends||a}copyMemoryFrom(e){const t=e.getBrain().getMemory(),n=t.getEnemyActors().slice();this._actors.enemies=n;const s=t.getFriendActors().slice();this._actors.friends=s,this._enemyTypes=Object.assign({},t._enemyTypes)}addCommunicationWith(e){this.hasCommunicatedWith(e)||this._communications.push(e)}getLastAttacked(){return this._lastAttackedID}wasLastAttacked(e){return this._lastAttackedID===e.getID()}setLastAttacked(e){this._lastAttackedID=e?e.getID():null}hasCommunicatedWith(e){return-1!==this._communications.indexOf(e)}toJSON(){const e={enemyTypes:Object.keys(this._enemyTypes)};return this._actors.hasOwnProperty("enemies")&&(e.enemies=this._actors.enemies.map(e=>e.getID())),this._actors.hasOwnProperty("friends")&&(e.friends=this._actors.friends.map(e=>e.getID())),this._lastAttackedID>=0&&(e.lastAttackedID=this._lastAttackedID),this._actors.hasOwnProperty("seen")&&(e.seen=this._actors.seen),e}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(42);t.default=class{constructor(e,t,n,r={}){this._toX=e,this._toY=t,this._passableCallback=n,this._options=Object.assign({topology:8},r),this._dirs=s.DIRS[this._options.topology],8===this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])}_getNeighbors(e,t){const n=[];for(let s=0;s<this._dirs.length;s++){const r=this._dirs[s],a=e+r[0],o=t+r[1];this._passableCallback(a,o,e,t)&&n.push([a,o])}return n}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BrainPlayer=t.MemoryPlayer=void 0;const i=o(n(4)),l=n(54),c=n(25),u=a(n(179)),h=a(n(462)),d=a(n(29)),p=n(9),f=n(13),m=n(71),g=n(176),y=p.Random.getRNG(),v=c.Keys.KeyMap,{ACTION_ALREADY_DONE:b,ACTION_ZERO_ENERGY:_}=h;class E extends g.Memory{constructor(e){super(),this._lastAttackedID=null,this._player=e}setLastAttacked(e){Number.isInteger(e)?this._lastAttackedID=e:e&&(this._lastAttackedID=e.getID())}getLastAttacked(){return this._lastAttackedID}wasLastAttacked(e){return this._lastAttackedID===e.getID()}isEnemy(e){return!e.isPlayer()&&(!e.has("NonSentient")&&e.getBrain().getMemory().isEnemy(this._player))}toJSON(){const e={};return i.default.isNullOrUndef([this._lastAttackedID])||(e.setLastAttacked=this._lastAttackedID),e}}t.MemoryPlayer=E;class S{constructor(e){this._brain=e,this._targetList=[],this.targetIndex=-1,this._state="S_IDLE"}getActor(){return this._brain._actor}isTargeting(){return"S_TARGETING"===this._state}isLooking(){return"S_LOOKING"===this._state}nextTarget(){this.hasTargets()&&(++this.targetIndex,this.targetIndex>=this._targetList.length&&(this.targetIndex=0),this.setSelectedCells(this._targetList[this.targetIndex]))}prevTarget(){this.hasTargets()&&(--this.targetIndex,this.targetIndex<0&&(this.targetIndex=this._targetList.length-1),this.setSelectedCells(this._targetList[this.targetIndex]))}startLooking(){this._state="S_LOOKING"}stopLooking(){this._state="S_IDLE",this.selectedCells=null}startTargeting(){this._state="S_TARGETING",this._targetList=this.getTargetList(),this.targetIndex=this.getCellIndexToTarget(this._targetList),this.setSelectedCells(this._targetList[this.targetIndex])}cancelTargeting(){this._targetList=[],this._state="S_IDLE",this.selectedCells=null,this.targetIndex=-1}getTargetList(){const e={},t=this._brain.getSeenCells(),n=this._brain._actor;return i.default.findEnemyCellForActor(n,t).forEach(t=>{e[t.getX()+","+t.getY()]=t}),Object.values(e)}setSelectedCells(e){if(e)if(Array.isArray(e))this.selectedCells=e;else{const t=e;if(this.selectedCells=[t],this.isTargeting()){const e=this.getActor(),[n,s]=[t.getX(),t.getY()],[r,a]=[e.getX(),e.getY()],o=f.Geometry.getBresenham(r,a,n,s).map(t=>e.getLevel().getMap().getCell(t[0],t[1]));this.selectedCells=this.selectedCells.concat(o)}}}getSelectedCells(){return this.selectedCells}getTarget(){return(this.isLooking()||this.isTargeting())&&this.selectedCells&&this.selectedCells.length>0?this.selectedCells[0]:this.selectedCells}getTargetCell(){return this.selectedCells.length>0?this.selectedCells[0]:null}getCellIndexToTarget(e){const t=this._brain.getMemory().getLastAttacked();for(let n=0;n<e.length;n++){const s=e[n].getProp("actors");for(let e=0;e<s.length;e++)if(s[e].getID()===t)return n}return 0}selectCell(e){const t=this._brain._actor,n=this._brain.getSeenCells();if(i.default.isNullOrUndef([e]))this.setSelectedCells(t.getCell());else if(e===c.Keys.KEY.SELECT_ALL){const e=m.Brain.findCellsWithFriends(t,n);this.setSelectedCells(e)}else{const s=this.selectedCells[0],r=t.getLevel().getMap(),[a,o]=[s.getX(),s.getY()],[l,c]=v.getDiff(e,a,o);if(r.hasXY(l,c)&&this.setSelectedCells(r.getCell(l,c)),this.isLooking()){const e=this.getTarget(),t=n.indexOf(e);let s="You cannot see there.";if(t>=0){const t=e.getPropNames();s="",t.forEach(e=>{s+=`You see ${e}. `}),i.default.gameMsg(s)}else i.default.gameMsg(s)}}}hasTargetSelected(){return!!this.selectedCells||!!this._targetList&&this.hasTargets()}hasTargets(){return this._targetList.length>0}processKey(e){if(v.isTargetMode(e)){if(this.isTargeting()){const e=this.getTarget();return this.cancelTargeting(),e?this._brain.handleCommand({cmd:"missile",target:e}):(i.default.gameMsg("No valid targets to attack."),this._brain.noAction())}{const e="Press [n/p] for next/prev target. [t] to fire.";return i.default.gameMsg(e),this.startTargeting(),this._brain.noAction()}}return this.isTargeting()?(v.isNextTarget(e)?this.nextTarget():v.isPrevTarget(e)?this.prevTarget():this.cancelTargeting(),this._brain.noAction()):256}isTargetInRange(){const e=this.getTarget(),t=this._brain._actor;if(e&&e.getX){const[n,s]=[e.getX(),e.getY()],[r,a]=[t.getX(),t.getY()],o=f.Geometry.getBresenham(r,a,n,s),l=t.getInvEq().getMissile();if(l){const e=i.default.getMissileRange(t,l);if(o.length-1<=e)return!0}}return!1}}class w{constructor(e){this._brain=e,this._actor=e._actor,this._marks={}}addMark(e){const[t,n]=this._actor.getXY(),s=this._actor.getLevel().getID(),r={id:s,x:t,y:n};e&&(r.tag=e),this._marks[s]||(this._marks[s]=[]),this.markExists(s,t,n)||(this._marks[s].push(r),i.default.gameMsg('Added a mark to the current location. Press "g" to view them'))}getMenu(){const e=this._actor.getLevel().getID(),t=this._marks[e]||[],n=t.map(e=>{const{x:t,y:n}=e,s=this._brain._guiCallbacks.GOTO.bind(null,c.Keys.KEY.GOTO,t,n);return[this.getMarkListMsg(e),s]}),s=t.map(e=>{const{x:t,y:n}=e,s=e.id;return[this.getMarkListMsg(e),this.deleteMark.bind(this,s,t,n)]}),r=new l.MenuWithState;return r.addPre("Choose a mark for travelling:"),r.addItem(c.Keys.KEY.DELETE,["Delete mark",l.Menu.NEXT_STATE]),r.addState("",n),r.addState("DELETE",s),r.addTransition("DELETE",c.Keys.KEY.DELETE),r.addPreState("Choose a mark to delete","DELETE"),r}deleteMark(e,t,n){if(this._marks[e]){const s=this._marks[e].findIndex(s=>s.id===e&&s.x===t&&s.y===n);s>=0&&this._marks[e].splice(s,1)}}getMarkListMsg(e){const{x:t,y:n}=e;let s=`${t}, ${n}`;if(e.tag)s+=" "+e.tag;else{const e=this._actor.getLevel().getMap().getCell(t,n);if(e.hasElements()){if(s+=" "+e.getElements()[0].getName(),e.hasConnection()){const t=e.getConnection().getTargetLevel();if(t){const e=t.getParent();e&&(s+=" - "+e.getName())}}}else e.hasItems()&&(s+=" "+e.getItems()[0].getName())}return s}markExists(e,t,n){return this._marks[e].findIndex(e=>e.x===t&&e.y===n)>=0}toJSON(){return this._marks}fromJSON(e){this._marks=e}}class C extends m.BrainSentient{constructor(e){super(e),this._confirmCallback=null,this._guiCallbacks={},this._type="Player",this._memory=new E(e),this.energy=0,this._confirmCallback=null,this._wantConfirm=!1,this._confirmEnergy=0,this._wantSelection=!1,this._selectionObject=null,this._runModeEnabled=!1,this._fightMode=i.default.FMODE_NORMAL,this._fsm=new S(this),this._markList=new w(this),this._cache={seen:null},this._statBoosts={CombatMods:{setAttack:0,setDefense:0,setProtection:0},StatsMods:{setAccuracy:0,setAgility:0,setMagic:0,setPerception:0,setSpeed:0,setStrength:0,setWillpower:0}}}getType(){return this._type}setType(e){}getActor(){return this._actor}setActor(e){this._actor=e}addGUICallback(e,t){this._guiCallbacks[e]=t}getMemory(){return this._memory}_restoreBaseSpeed(){this._runModeEnabled=!1,this._actor.has("StatsMods")&&this._actor.get("StatsMods").setSpeed(0)}isRunModeEnabled(){return this._runModeEnabled}cmdNotPossible(e){return this.energy=0,i.default.gameWarn(e),_}isMenuShown(){return!!this._selectionObject&&this._selectionObject.showMenu()}getMenu(){return this._selectionObject&&this._selectionObject.showMenu()?this._selectionObject.getMenu():null}noAction(){return _}getFightMode(){return this._fightMode}toggleRunMode(){if(this.energy=0,this._runModeEnabled)this._restoreBaseSpeed();else{this._runModeEnabled=!0;const e=this._actor.get("Stats").getSpeed(),t=Math.floor(.2*e);this._actor.get("StatsMods").setSpeed(t)}}toggleFightMode(){this._fightMode+=1,this._fightMode>=i.default.FMODES.length&&(this._fightMode=i.default.FMODE_NORMAL)}_createBuyConfirmCallback(e){const t=e.getProp("items")[0],n=e.getPropType("shop")[0],s=n.getItemPriceForBuying(t);this._confirmEnergy=0,this._wantConfirm=!0,this._confirmCallback=()=>{const e=new d.Transaction;e.setArgs({item:t,buyer:this._actor,shop:n,seller:n.getShopkeeper()}),this._actor.add(e)},i.default.gameMsg("Press 'y' to buy "+t.getName()+" for "+s+" gold coins")}_setAttackStats(){const e=this._actor.get("Stats"),t=this._actor.get("Combat");let n=0,s=0,r=0;this._fightMode===i.default.FMODE_FAST?(n=Math.round(.2*e.getSpeed()),s=-Math.round(.2*t.getAttack()),s=s<=0?-1:s,r=-1):this._fightMode===i.default.FMODE_SLOW&&(n=-Math.round(.2*e.getSpeed()),s=Math.round(.2*t.getAttack()),s=0===s?1:s,r=2),this._actor.get("StatsMods").setSpeed(n),this._actor.get("CombatMods").setAttack(s),this._actor.get("CombatMods").setDamage(r)}handleCommand(e){switch(this._restoreBaseSpeed(),e.cmd){case"attack":return new h.CmdAttack(this).execute(e);case"buy":return new h.CmdBuy(this).execute(e);case"sell":return new h.CmdSell(this).execute(e);case"craft":return new h.CmdCraft(this).execute(e);case"missile":return new h.CmdMissile(this).execute(e);case"use":return new h.CmdUseItem(this).execute(e);case"drop":return new h.CmdDropItem(this).execute(e);case"displace":return new h.CmdDisplace(this).execute(e);case"equip":return new h.CmdEquipItem(this).execute(e);case"unequip":return new h.CmdUnequipItem(this).execute(e);case"use-element":return new h.CmdUseElement(this).execute(e);default:return()=>{}}}resetBoosts(){this.energy=0;for(const e in this._statBoosts)if(e){const t=this._statBoosts[e];for(const n in t)if(n){const s=t[n];this._actor.has(e)&&this._actor.get(e)[n](s)}}}tryToToggleDoor(){const e=m.Brain.getCellsAroundActor(this._actor).filter(e=>e.hasDoor());if(1===e.length)return this.openDoorFromCell(e[0]);if(e.length>1){const t=y.arrayGetRand(e);return this.openDoorFromCell(t)}return this.cmdNotPossible("There are no doors to open or close")}openDoorFromCell(e){if(e){const t=e.getPropType("door")[0];if(t){const e=new d.OpenDoor;return e.setDoor(t),this._actor.add(e),b}}return this.cmdNotPossible("There are no doors to open or close")}getSeenCells(){if(null===this._cache.seen){let e=this._actor.getLevel().exploreCells(this._actor);if(this._actor.has("Telepathy")){const t=this._actor.getLevel().getID();this._actor.getList("Telepathy").forEach(n=>{const s=n.getTarget(),r=s.getLevel();if(i.default.isActorActive(s)&&r.getID()===t){const t=r.exploreCells(s);e=e.concat(t)}})}this._cache.seen=e}return this._cache.seen}getTargetActor(){const e=this.getTarget();if(Array.isArray(e)){const t=e;if(t.length>0)return t[0].getFirstActor()}else if(e.getFirstActor)return e.getFirstActor();return null}setSelectionObject(e){this._wantSelection=!0,this._selectionObject=e}selectionDone(){this._wantSelection=!1,this._selectionObject=null}decideNextAction(e){if(this._cache.seen=null,e.hasOwnProperty("cmd"))return this.resetBoosts(),this.handleCommand(e);const t=e.code;if(i.default.isNullOrUndef([t])&&i.default.err("Brain.Player","decideNextAction","obj.code or obj.cmd must exist. Got obj: "+JSON.stringify(e)),this._wantConfirm&&null!==this._confirmCallback)return this.processConfirm(t);if(this._wantSelection)return this.processMenuSelection(t);const n=this._fsm.processKey(t);if(256!==n)return n;if(v.isMark(t))return this._markList.addMark(),this.noAction();if(v.isGoto(t))return this.setSelectionObject(this._markList.getMenu()),this.noAction();if(this._guiCallbacks.hasOwnProperty(t))return this._guiCallbacks[t](t);if(v.isRunMode(t))return this.toggleRunMode(),this.noAction();if(v.isFightMode(t))return this.toggleFightMode(),this.noAction();if(v.isIssueOrder(t))return this.issueOrderCmd(),this.noAction();if(v.isLook(t))return this.lookCmd(),this.noAction();if(v.isJump(t))return this.jumpCmd(),this.noAction();if(v.isUseAbility(t))return this.useAbility(),this.noAction();if(v.isGive(t))return this.giveCmd(),this.noAction();const s=this._actor.getLevel();let r=this._actor.getX(),a=this._actor.getY();const o=s.getMap(),l=o.getCell(r,a);if(v.isNextItem(t))return function(e){if(e.hasItems()){const t=e.getItems();let n=t[0].getName();if(t.length>1){const e=t.shift();t.push(e),n=t[0].getName(),i.default.gameMsg("You see now "+n+" on top of the heap.")}else i.default.gameMsg("You see only "+n+" here")}else i.default.gameMsg("There are no items here to look through")}(l),this.noAction();let c="NULL";if(v.inMoveCodeMap(t)){const e=v.getDiff(t,r,a);r=e[0],a=e[1],c="MOVE"}else this._restoreBaseSpeed();if("NULL"===c){if(this.resetBoosts(),v.isRest(t)&&(c="REST"),v.isPickup(t)){if(c="PICKUP",l.hasProp("items")){if(l.hasShop()){return l.getShop().isAbandoned()?(this.energy=i.default.energy.PICKUP,()=>{const e=new d.Pickup;this._actor.add(e)}):(this._createBuyConfirmCallback(l),this.noAction())}return this.energy=i.default.energy.PICKUP,()=>{const e=new d.Pickup;this._actor.add(e)}}return this.cmdNotPossible("There are no items to pick up.")}if(v.isUseStairs(t))return c="STAIRS",()=>{const e=new d.UseStairs;this._actor.add(e)};if(v.isToggleDoor(t))return this.tryToToggleDoor();if(v.isUsePower(t))return this.hasPowers()?(this._wantSelection=!0,this._selectionObject=this._actor.getBook().getSelectionObject(),i.default.gameMsg("Press 0-9a-z to make a selection.")):i.default.gameMsg("You have no powers to use."),this.noAction();if(v.isChat(t)&&(this._wantSelection=!0,this._selectionObject=(u=this._actor,i.default.gameMsg("Select direction for chatting:"),{select:e=>{const t={dir:v.getDir(e),src:null};return t.dir?(t.src=u,()=>{const e=new d.Chat;e.setArgs(t),u.add(e)}):null},showMenu:()=>!1})),v.isRead(t)){const e=new d.Read;return this._actor.add(e),b}}var u;return"MOVE"===c?this.moveCmd(s,o,r,a):"REST"===c?(this.energy=i.default.energy.REST,this._actor.add(new d.Rest),b):this.noAction()}hasPowers(){return!!this._actor.getBook()}processConfirm(e){return this._wantConfirm=!1,v.isConfirmYes(e)?(this.energy=this._confirmEnergy,this._confirmCallback):(i.default.gameMsg("You cancel the action."),this.noAction())}processMenuSelection(e){if(l.Menu.isMenuItem(this._selectionObject)){this._selectionObject.showMsg&&this._selectionObject.showMsg();const t=this._selectionObject.select(e);if(l.Menu.isSelectionDone(t))return this.selectionDone(),t;if(l.Menu.isMenuItem(t)){this._selectionObject=t;const e=t;return e.funcToCall?(this.selectionDone(),e.funcToCall()):this.noAction()}}return this.selectionDone(),i.default.gameMsg("You cancel the action."),this.noAction()}moveCmd(e,t,n,s){if(!t.hasXY(n,s)){if(this._actor.getCell().hasPassage()){const e=()=>{const e=new d.UseStairs;this._actor.add(e)},t="Press 'y' to move to another area";return this.setWantConfirm(i.default.energy.MOVE,e,t),this.noAction()}{const e="You cannot move there.";return this.cmdNotPossible(e)}}const[r,a]=this._actor.getXY();if(t.isPassable(n,s,r,a))return this.moveToCell(n,s,e);if(t.getCell(n,s).hasClosedDoor())return this.tryToToggleDoor();if(t.getCell(n,s).hasActors()){this._restoreBaseSpeed();const e=function(e,t,n){const s=e.getCell(t,n).getProp("actors");for(let e=0;e<s.length;e++)if(!s[e].has("Ethereal"))return s[e];return null}(t,n,s);null===e&&i.default.err("Brain.Player","decideNextAction","Null target for attack x,y: "+n+","+s);const r=()=>{this._setAttackStats();const t=new d.Attack({target:e});this._actor.add(t)};if(e.isEnemy(this._actor))return this.energy=i.default.energy.ATTACK,r;{const t="Press 'y' to attack non-hostile "+e.getName();return this.setWantConfirm(i.default.energy.ATTACK,r,t),this.noAction()}}if(this._actor.has("Flying")&&t.isPassableByAir(n,s))return this._restoreBaseSpeed(),this.moveToCell(n,s,e);{const e=i.default.getImpassableMsg(this._actor,t.getCell(n,s),"You");return this.cmdNotPossible(e)}}moveToCell(e,t,n){return this._runModeEnabled?this.energy=i.default.energy.RUN:(this.resetBoosts(),this.energy=i.default.energy.MOVE),()=>{const s=new d.Movement(e,t,n);this._actor.add(s)}}setWantConfirm(e,t,n){this._confirmEnergy=e,this._wantConfirm=!0,this._confirmCallback=t,n&&i.default.gameMsg(n)}issueOrderCmd(){const e=[["Follow me",this.giveOrder.bind(this,"Follow")],["Attack enemy",this.giveOrder.bind(this,"Attack")],["Pickup an item",this.giveOrder.bind(this,"Pickup")],["Forget my orders",this.giveOrder.bind(this,"Forget")]],t=new l.Menu.WithQuit(e);t.onQuit=this.cancelTargeting.bind(this);const n=[{key:c.Keys.KEY.SELECT,menu:t}];i.default.gameMsg('Select a target (all with "A"), then press "s" to choose it');const s=new l.Menu.SelectCell(n);s.enableSelectAll(),s.setCallback(this.selectCell.bind(this)),this.setSelectionObject(s),this.selectCell()}lookCmd(){const e=[{key:c.Keys.KEY.SELECT,funcToCall:this.showSelectedCellInfo.bind(this)}];i.default.gameMsg('Select a target with movement keys, then press "s" to choose it');const t=new l.Menu.SelectCell(e);t.setCallback(this.selectCell.bind(this)),this.setSelectionObject(t),this._fsm.startLooking(),this.selectCell()}giveCmd(){const e=new l.Menu.SelectDir;e.setCallback(this.giveCallback.bind(this)),this.setSelectionObject(e),i.default.gameMsg("Please select direction to giving an item:")}giveCallback(e){const[t,n]=i.default.newXYFromDir(e,this._actor),s=this._actor.getLevel().getMap().getCell(t,n);if(s.hasActors()){const e=s.getFirstActor(),t=this._actor.getInvEq().getInventory().getItems().map(t=>[t.toString(),this.giveItemToActor.bind(this,t,e)]),n=new l.Menu.WithQuit(t);n.addPre("Select an item to give:"),this.setSelectionObject(n)}else i.default.gameDanger("There is no one there")}giveItemToActor(e,t){const n=new d.Give;n.setGiveTarget(t),n.setItem(e),this._actor.add(n)}jumpCmd(){const e=new l.Menu.SelectDir;e.setCallback(this.jumpCallback.bind(this)),this.setSelectionObject(e),i.default.gameMsg("Please select direction to jump"),this.energy=i.default.energy.JUMP}jumpCallback(e){const[t,n]=e,s=new d.Jump;s.setX(t),s.setY(n),this._actor.add(s)}giveOrder(e){const t=this.getTarget();t.forEach(n=>{if(n.hasActors()){const t=n.getActors()[0];if(i.default.isSentient(t)){const n=t,s=n.getBrain();if(n&&s.getGoal)switch(e){case"Follow":this.giveFollowOrder(n);break;case"Forget":this.forgetOrders(n);break;case"Attack":this.giveOrderAttack(n);break;case"Pickup":this.giveOrderPickup(n)}}else i.default.gameDanger("This cell has no valid targets")}else 1===t.length&&i.default.gameDanger("This cell has no valid targets")}),this.setSelectedCells(null)}giveFollowOrder(e){const t=e.getName(),n={bias:.7,src:this._actor};u.giveFollowOrder(e,n),i.default.gameMsg(`You tell ${t} to follow you`)}forgetOrders(e){const t={bias:.7,src:this._actor};u.giveClearOrders(e,t),i.default.gameMsg(`You tell ${name} to forget your orders`)}giveOrderAttack(e){const t=this.getSeenCells(),n=i.default.findEnemyCellForActor(this._actor,t);if(0===n.length)return void i.default.gameMsg("There are no enemies around.");const s=n[this.getCellIndexToTarget(n)];if(s){const t=e.getName(),n=s.getActors()[0],r=n.getName(),a={bias:this.getOrderBias(),enemy:n,src:this._actor};u.giveAttackOrder(e,a),i.default.gameMsg(`You tell ${t} to attack ${r}`)}else i.default.gameMsg("There are no enemies around.")}giveOrderPickup(e){const t=this.getItemInSight(),n=e.getName();if(t){const s=t.getName(),r={bias:this.getOrderBias(),item:t,src:this._actor};u.givePickupOrder(e,r),i.default.gameMsg(`You tell ${n} to pickup ${s}`)}else i.default.gameMsg(`There are no items for ${n} to pickup`)}getOrderBias(){return this._actor.has("Leader")?1:this._actor.has("Commander")?1.5:.7}useAbility(){if(this._actor.has("Abilities")){const e=this._actor.get("Abilities").createMenu();this.setSelectionObject(e)}else i.default.gameMsg("You have no abilities to use")}addMark(e){this._markList.addMark(e)}getItemInSight(){const e=this.getSeenCells().filter(e=>e.hasItems());if(e.length>0){return y.arrayGetRand(e).getItems()[0]}return null}toJSON(){return{type:this.getType(),memory:this._memory.toJSON(),markList:this._markList.toJSON()}}addEnemy(){}addFriend(){}hasTargetSelected(){return this._fsm.hasTargetSelected()}startTargeting(){this._fsm.startTargeting()}nextTarget(){this._fsm.nextTarget()}getTargetList(){return this._fsm.getTargetList()}getSelectedCells(){return this._fsm.getSelectedCells()}prevTarget(){this._fsm.prevTarget()}getTarget(){return this._fsm.getTarget()}isTargetInRange(){return this._fsm.isTargetInRange()}cancelTargeting(){this._fsm.cancelTargeting()}isTargeting(){return this._fsm.isTargeting()}getCellIndexToTarget(e){return this._fsm.getCellIndexToTarget(e)}setSelectedCells(e){e?this._fsm.setSelectedCells(e):this.cancelTargeting()}selectCell(e){this._fsm.selectCell(e)}showSelectedCellInfo(){this._fsm.stopLooking()}}t.BrainPlayer=C},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GoalRetreat=t.GoalHoldPosition=t.GoalEngageEnemy=t.GoalFindEnemyArmy=t.LevelGrid=t.GoalFollowArmy=t.GoalWinBattle=t.giveClearOrders=t.givePickupOrder=t.giveAttackOrder=t.giveFollowOrder=t.injectOrderEval=t.orderWithGoal=t.GoalsBattle=void 0;const i=o(n(4)),l=n(72),c=n(38),u=a(n(11)),{GOAL_ACTIVE:h,GOAL_COMPLETED:d}=l.GoalStatus;t.GoalsBattle={},t.orderWithGoal=(e,t)=>{const{bias:n}=t,s=new c.Evaluator.Orders(n);if(s.setArgs({srcActor:t.src,goal:t.goal}),e.isPlayer()){const n=new u.BattleOrder,s={srcActor:t.src};n.setArgs(s),e.add(n)}else{const t=e.getBrain();if("function"==typeof t.getGoal){const e=t.getGoal();e.clearOrders?(e.clearOrders(),e.giveOrders(s)):i.default.err("goals-battle.ts","orderWithGoal","No clearOrders found from the top goal")}else{const t="Actor without getGoal: "+JSON.stringify(e);i.default.warn("goals-battle.js","orderWithGoal",t)}}},t.GoalsBattle.orderWithGoal=t.orderWithGoal,t.injectOrderEval=(e,t,n)=>{if(i.default.isSentient(e)){const s=new c.Evaluator.Orders(n.bias);s.setArgs({srcActor:n.src,goal:t});const r=e.getBrain().getGoal();r.clearOrders&&(r.clearOrders(),r.giveOrders(s))}},t.giveFollowOrder=(e,n)=>{if(i.default.isSentient(e)){const s=new l.Goal.Follow(e,n.src);t.injectOrderEval(e,s,n)}},t.GoalsBattle.giveFollowOrder=t.giveFollowOrder,t.giveAttackOrder=(e,n)=>{if(i.default.isSentient(e)){const s=new l.Goal.AttackActor(e,n.enemy);t.injectOrderEval(e,s,n)}},t.GoalsBattle.giveAttackOrder=t.giveAttackOrder,t.givePickupOrder=(e,n)=>{if(i.default.isSentient(e)){const s=new l.Goal.GetItem(e,n.item);t.injectOrderEval(e,s,n)}},t.GoalsBattle.givePickupOrder=t.givePickupOrder,t.giveClearOrders=(e,t)=>{if(i.default.isSentient(e)){const{src:n}=t;if(!e.isEnemy(n)){const t=e.getBrain().getGoal();t.clearOrders&&t.clearOrders()}}},t.GoalsBattle.giveClearOrders=t.giveClearOrders;class p extends l.GoalBase{constructor(e){super(e),this.setType("GoalWinBattle")}activate(){const e=this.actor.getBrain(),t=e.getSeenCells();e.findEnemyCell(t)?(this.addSubGoal(new y(this.actor)),this.dbg("Activated goal. Added EngageEnemy")):(this.addSubGoal(new g(this.actor)),this.dbg("Activated goal. Added FindEnemyArmy")),this.status=h}process(){return this.dbg("process() begin"),this.activateIfInactive(),this.status=this.processSubGoals(),this.status}}t.GoalWinBattle=p,t.GoalsBattle.WinBattle=p;class f extends l.GoalBase{constructor(e){super(e),this.setType("GoalFollowArmy")}activate(){}process(){return this.activateIfInactive(),this.status=d,this.status}}t.GoalFollowArmy=f,t.GoalsBattle.FollowArmy=f;class m{constructor(e,t,n){const s=e.getMap(),[r,a]=[s.cols,s.rows];let o=Math.floor(r/t),i=Math.floor(a/n);r%t!=0&&++o,a%n!=0&&++i,this.grid=[];for(let e=0;e<o;e++){this.grid[e]=[];for(let t=0;t<i;t++)this.grid[e][t]={data:[e,t]}}this.gridCols=o,this.gridRows=i,this.xMap=t,this.yMap=n,this.xMapHalf=Math.floor(t/2),this.yMapHalf=Math.floor(n/2)}getCenterLevelXY(e){const[t,n]=e;return[t*this.xMap+this.xMapHalf,n*this.yMap+this.yMapHalf]}getGridXY(e){const[t,n]=e;return[Math.floor(t/this.xMap),Math.floor(n/this.yMap)]}setDataLevelXY(e,t,n){const[s,r]=this.getGridXY(e);this.grid[s][r][t]=n}setDataGridXY(e,t,n){const[s,r]=e;this.grid[s][r][t]=n}isTrue(e,t){const[n,s]=e;return!0===this.grid[n][s][t]}hasProp(e,t){const[n,s]=e;return this.grid[n][s].hasOwnProperty(t)}getDataGridXY(e){const[t,n]=e;return this.grid[t][n]}getDataLevelXY(e){const[t,n]=this.getGridXY(e);return this.grid[t][n]}debugPrint(){for(let e=0;e<this.gridRows;e++){let t="||";for(let n=0;n<this.gridCols;n++)t+=JSON.stringify(this.grid[n][e])+" ||";i.default.diag(t),i.default.diag("=".repeat(t.length))}}}t.LevelGrid=m;class g extends l.GoalBase{constructor(e){super(e),this.setType("GoalFindEnemyArmy");const t=e.getLevel();this.gridSeen=new m(t,10,10);const[n,s]=this.actor.getXY();this.gridSeen.setDataLevelXY([n,s],"seen",!0),this.adjustRate=50}activate(){this.selectDirToMove(),this.status=h}process(){return this.activateIfInactive(),this.adjustRate>0?--this.adjustRate:(this.selectDirToMove(),this.adjustRate=50),this.status=this.processSubGoals(),this.status}selectDirToMove(){const e=this.actor.getBrain(),n=[0,0],s=this.actor.getLevel(),[r,a]=this.actor.getXY(),o=s.getMap().cols/2,i=s.getMap().rows/2;r<o?n[0]=1:r>o&&(n[0]=-1),a<i?n[1]=1:a>i&&(n[1]=-1),this.dbg("Cmd army to move to dir "+n);const c=e.getSeenFriends();this.dbg(c.length+" friends found for command"),c.forEach(e=>{const s=new l.Goal.MoveUntilEnemy(e,n);t.orderWithGoal(e,{src:this.actor,bias:1,goal:s})}),this.dbg("Issued Move order to "+c.length+" actors");const u=new l.Goal.MoveUntilEnemy(this.actor,n);this.removeAllSubGoals(),this.addSubGoal(u)}}t.GoalFindEnemyArmy=g,t.GoalsBattle.FindEnemyArmy=g;class y extends l.GoalBase{constructor(e){super(e),this.setType("GoalEngageEnemy")}activate(){this.dbg("ATTACK ENEMY activate()");const e=this.actor.getBrain(),n=e.getSeenEnemies();if(0===n.length)return;e.getSeenFriends().forEach(e=>{const s=new l.Goal.AttackActor(e,n[0]);t.orderWithGoal(e,{src:this.actor,bias:2,goal:s})}),this.enemy=n[0];const s=new l.Goal.AttackActor(this.actor,n[0]);this.addSubGoal(s),this.status=h}process(){return this.activateIfInactive(),this.dbg("ATTACK ENEMY process()"),this.status=this.processSubGoals(),this.status}}t.GoalEngageEnemy=y,t.GoalsBattle.EngageEnemy=y;class v extends l.GoalBase{constructor(e){super(e),this.setType("GoalHoldPosition")}}t.GoalHoldPosition=v,t.GoalsBattle.HoldPosition=v;class b extends l.GoalBase{constructor(e){super(e),this.setType("GoalRetreat")}}t.GoalRetreat=b,t.GoalsBattle.Retreat=b},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.BrainWeather=void 0;const o=n(71),i=n(134),l=a(n(29));class c extends i.BrainBase{constructor(e){super(e),this.setType("Weather"),this.updateFreq=10}decideNextAction(e){--this.updateFreq;const t=this._actor.getLevel();if(0===this.updateFreq&&t.has("Weather")){const e=t.get("Weather"),n=e.getWeatherType(),s=new l.WeatherEffect;s.setEffectType(n),s.setTemperature(e.getTemperature()),s.setHumidity(e.getHumidity()),this._actor.add(s),this.updateFreq=10}return o.ACTION_ALREADY_DONE}}t.BrainWeather=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OnRemoveCb=t.OnAddCb=void 0;const s=n(34).Component.TransientDataComponent;t.OnAddCb=s("OnAddCb",{compName:"",comp:null}),t.OnRemoveCb=s("OnRemoveCb",{compName:"",comp:null})},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Inventory=void 0;const i=o(n(4)),l=a(n(39)),c=n(183);t.Inventory=class{constructor(e){this._actor=e,this._inv=new l.Container(e),this._eq=new c.Equipment(e)}static equipAnyItem(e,t){const n=e.getInvEq();n.hasItem(t)||n.addItem(t),n.equipItem(t)}addItem(e){this._inv.addItem(e)}hasItem(e){return this._inv.hasItem(e)}removeItem(e){return this._inv.removeItem(e)}removeNItems(e,t){return this._inv.removeNItems(e,t)}getRemovedItem(){return this._inv.getRemovedItem()}hasItemNamed(e){return this._inv.hasItemWith(t=>t.getName()===e)}getItemsNamed(e){return this._inv.getItemsWith(t=>t.getName()===e)}useItem(e,t){if(this._inv.hasItem(e)){if(e.useItem)return e.useItem(t),!0}else i.default.err("Inv.Inventory","useItem","Not in inventory, cannot use!");return!1}canCarryItem(e){return!(this._eq.getWeight()+this._inv.getWeight()+e.getWeight()>this._actor.getMaxWeight())}dropItem(e){if(this._inv.removeItem(e)){const e=this._actor.getLevel(),t=this.getRemovedItem();if(t){const[n,s]=this._actor.getXY();if(e.addItem(t,n,s))return!0;this._inv.addItem(t)}}return!1}dropNItems(e,t){if(this.removeNItems(e,t)){const e=this._actor.getLevel(),t=this.getRemovedItem();if(t){const[n,s]=this._actor.getXY();if(e.addItem(t,n,s))return!0;this._inv.addItem(t)}}return!1}removeAndGetItem(e){return this._inv.removeItem(e)?this.getRemovedItem():null}getInventory(){return this._inv}getEquipment(){return this._eq}equipItem(e){if(this._inv.hasItem(e)){const t=this._getItemToEquip(e);if(i.default.isNullOrUndef([t]))return i.default.err("Inv.Inventory","equipItem","equippedItem is null. Should not happen"),!1;if(this._eq.equipItem(t))return!0;this._inv.addItem(t)}else i.default.err("Inv.Inventory","equipItem","Cannot equip. Not in inventory.");return!1}_getItemToEquip(e){if(this._inv.removeItem(e)){return this._inv.getRemovedItem()}return null}equipNItems(e,t){if(this._inv.hasItem(e)){if(this._inv.removeNItems(e,t)){const e=this._inv.getRemovedItem();if(this._eq.equipItem(e))return!0;this._inv.addItem(e)}}return!1}unequipItem(e,t,n){if(i.default.isNullOrUndef([e])){let s="Some params null/undef: ";s+=`type: |${e}| n: |${t}| number: |${n}|`,i.default.err("InvInventory","unequipItem",s)}const s=this._eq.getItem(e);if(!i.default.isNullOrUndef([s])&&this._eq.unequipItem(e,t,n)){const t=this._eq.getUnequipped(e,n);if(null!==t)return this.addItem(t),!0}return!1}unequipAndGetItem(e,t,n){const s=this._eq.getItem(e);return!i.default.isNullOrUndef([s])&&this._eq.unequipItem(e,t)?this._eq.getUnequipped(e,n):null}getWeapon(){const e=this._eq.getItem("hand");return i.default.isNullOrUndef([e])?null:Array.isArray(e)?e[0]:e}getMissileWeapon(){const e=this._eq.getItem("missileweapon");if(!i.default.isNullOrUndef([e])){return e}return null}getMissile(){const e=this._eq.getItem("missile");if(e){return e}return null}getEquipped(e){return this._eq.getItem(e)}getFreeEquipSlots(){return this._eq.getFreeSlotTypes()}restoreEquipped(e){return this._eq.equipItem(e)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Equipment=t.EquipSlot=void 0;const r=s(n(4));class a{constructor(e,t){this._type=e,this._item=null,this._hasItem=!1,this._unequipped=null,this._stacked=!1,this._reduceFactor=.5,r.default.isNullOrUndef([t])||(this._stacked=t)}isStacked(){return this._stacked}getWeight(){if(!this._hasItem)return 0;let e=this._item.getWeight()*this._item.getCount();return"hand"!==this._type&&"missile"!==this._type&&(e*=this._reduceFactor),e}getUnequipped(){return this._unequipped}getItem(){return this._hasItem?this._item:null}hasItem(){return this._hasItem}equipItem(e,t){return!!this.canEquip(e)&&(this._stacked&&this._hasItem?r.default.addStackedItems(this._item,e)&&(this._hasItem=!0):(e.setOwner(this),t&&e.setOwner(t),this._item=e,this._hasItem=!0),this._hasItem)}unequipItem(e){if(this._hasItem){if(!this._stacked)return this._hasItem=!1,this._unequipped=this._item,!0;if(e>0)return 1===e&&1===this._item.getCount()||e===this._item.getCount()?(this._hasItem=!1,this._unequipped=this._item):this._unequipped=r.default.removeStackedItems(this._item,e),!0}return!1}canEquip(e){return!this._hasItem||!!this._stacked&&e.equals(this._item)}}t.EquipSlot=a;const o=["getDefense","getAttack","getProtection","getSpeed"].concat(r.default.GET_STATS);class i{constructor(e){this._actor=e,this.equipReduceWeightFactor=1,this._slots={[r.default.EQUIP.HEAD]:new a(r.default.EQUIP.HEAD),[r.default.EQUIP.NECK]:new a(r.default.EQUIP.NECK),[r.default.EQUIP.CLOAK]:new a(r.default.EQUIP.CLOAK),[r.default.EQUIP.CHEST]:new a(r.default.EQUIP.CHEST),[r.default.EQUIP.HAND]:new a(r.default.EQUIP.HAND),[r.default.EQUIP.SHIELD]:new a(r.default.EQUIP.SHIELD),[r.default.EQUIP.LEGS]:new a(r.default.EQUIP.LEGS),[r.default.EQUIP.FEET]:new a(r.default.EQUIP.FEET),[r.default.EQUIP.MISSILE]:new a(r.default.EQUIP.MISSILE,!0),[r.default.EQUIP.MISSILEWEAPON]:new a(r.default.EQUIP.MISSILEWEAPON),[r.default.EQUIP.SPIRITGEM]:new a(r.default.EQUIP.SPIRITGEM),[r.default.EQUIP.TOOL]:new a(r.default.EQUIP.TOOL)}}addSlot(e,t){if(this._hasSlot(e))if(Array.isArray(this._slots[e]))this._slots[e].push(t);else{const n=[this._slots[e]];n.push(t),this._slots[e]=n}else this._slots[e]=t}getWeight(){let e=0;return Object.values(this._slots).forEach(t=>{e+=t.getWeight()}),e*=this.equipReduceWeightFactor,this._actor.has("MasterEquipper")&&(e*=this._actor.get("MasterEquipper").getFactor()),e}getNumSlots(e){return this._hasSlot(e)?Array.isArray(this._slots[e])?this._slots[e].length:1:0}getSlotTypes(){return Object.keys(this._slots)}getFreeSlotTypes(){const e=[];return this.getSlotTypes().forEach(t=>{if(Array.isArray(this._slots[t])){this._slots[t][0].hasItem()||e.push(t)}else this._slots[t].hasItem()||e.push(t)}),e}getItems(e){return e&&this._hasSlot(e)?Array.isArray(this._slots[e])?this._slots[e]:[this._slots[e]]:this.getEquippedItems()}getUnequipped(e,t){if(this._hasSlot(e)){const n=this._slots[e];if(!Array.isArray(n))return this._slots[e].getUnequipped();if("number"==typeof t)return n[t].getUnequipped();r.default.err("Equipment","getUnequipped",`No slot index for slotType ${e} given!`)}else r.default.err("Equipment","getUnequipped","No slot type: "+e);return null}getItem(e){if(this._hasSlot(e)){const t=this._slots[e];return Array.isArray(t)?t.map(e=>e.getItem()):this._slots[e].getItem()}return null}equipItem(e){let t=!1;if(e.getArmourType)t=this.equipToSlotType(e.getArmourType(),e);else if(/^(missile|ammo)$/.test(e.getType())){this._slots.missile.equipItem(e)&&(t=!0)}else t="missileweapon"===e.getType()?this.equipToSlotType(r.default.EQUIP.MISSILEWEAPON,e):this.equipToSlotType(r.default.EQUIP.HAND,e);return t}equipToSlotType(e,t){const n=this._slots[e];if(Array.isArray(n)){for(let e=0;e<n.length;e++)if(n[e].equipItem(t,this._actor))return!0}else if(n.equipItem(t,this._actor))return!0;return!1}isEquipped(e){return-1!==this.getItems().indexOf(e)}getEquipped(e){return this.getItem(e)}getEquippedItems(){const e=[];return Object.values(this._slots).forEach(t=>{Array.isArray(t)?t.forEach(t=>{t.hasItem()&&e.push(t.getItem())}):t.hasItem()&&e.push(t.getItem())}),e}unequipItem(e,t,n){if(this._hasSlot(e)){const s=this._slots[e];if(!Array.isArray(s))return this._slots[e].unequipItem(t);if("number"==typeof n&&n>=0){if(s[n].unequipItem(t))return!0}else for(let e=0;e<s.length;e++)if(s[e].unequipItem(t))return!0}else{const t="Non-existing slot type "+e;r.default.err("Equipment","unequipItem",t)}return!1}toJSON(){const e=[],t=this.getEquippedItems();for(let n=0;n<t.length;n++)e.push(t[n].toJSON());return e}propertySum(e){let t=0;return Object.keys(this._slots).forEach(n=>{let s=this._slots[n];Array.isArray(s)||(s=[s]),s.forEach(n=>{const s=n.getItem();t+=r.default.getItemStat(e,s)})}),t}_hasSlot(e){return this._slots.hasOwnProperty(e)}}t.Equipment=i;for(let e=0;e<o.length;e++)i.prototype[o[e]]=function(){return this.propertySum(o[e])}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(464);t.default=class{constructor(){this._queue=new s.EventQueue,this._repeat=[],this._current=null,this.traceIDs={},this.debugEnabled=!1}setTraceID(e){this.traceIDs[e]=!0,this.debugEnabled=!0}getTime(){return this._queue.getTime()}add(e,t){return t&&this._repeat.push(e),this}clear(){return this._queue.clear(),this._repeat=[],this._current=null,this}remove(e){let t=!1;const n=this._repeat.indexOf(e);return-1!==n&&this._repeat.splice(n,1),this._current===e?(this._current=null,t=!0):t=this._queue.remove(e),t}next(){return this._current=this._queue.get(),this._current}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EvaluatorRetreat=t.EvaluatorWinBattle=t.EvaluatorsBattle=void 0;const s=n(179),r=n(38);t.EvaluatorsBattle={};class a extends r.EvaluatorBase{constructor(e){super(e),this.type="WinBattle"}calculateDesirability(e){return e.has("InBattle")?this.actorBias:r.Evaluator.NOT_POSSIBLE}setActorGoal(e){const t=e.getBrain().getGoal(),n=new s.GoalsBattle.WinBattle(e);t.addGoal(n)}}t.EvaluatorWinBattle=a,t.EvaluatorsBattle.WinBattle=a;class o extends r.EvaluatorBase{constructor(e){super(e),this.cooldown=5,this.type="Retreat"}calculateDesirability(){return 0===this.cooldown?this.actorBias:(--this.cooldown,0)}setActorGoal(e){const t=e.getBrain().getGoal(),n=new s.GoalsBattle.Retreat(e);t.addGoal(n)}}t.EvaluatorRetreat=o,t.EvaluatorsBattle.Retreat=o},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.addAllAbilities=t.Abilities=t.Bribery=t.Sharpener=t.Item=t.Area=t.Direction=t.Camouflage=t.AbilityBase=t.Ability=void 0;const i=o(n(4)),l=n(9),c=n(13),u=a(n(54)),h=a(n(29)),d=l.Random.getRNG();t.Ability={};class p{constructor(e){this.name=e}getName(){return this.name}getMenuItem(){return[this.getName(),this.activate.bind(this)]}activate(e){const t=this.getName();i.default.err("Ability.Base","activate",`${t} should implement activate(), given obj ${e}`)}}t.AbilityBase=p,t.Ability.Base=p;class f extends p{constructor(e){super("Camouflage")}activate(){this.actor.add(new h.Camouflage)}}t.Camouflage=f,t.Ability.Camouflage=f;class m extends p{constructor(e){super(e)}getMenuItem(){return[this.getName(),new u.MenuSelectDir([])]}}t.Direction=m;class g extends p{constructor(e){super(e),this.range=1}activate(e){}getCells(){const[e,t]=this.actor.getXY(),n=this.actor.getLevel().getMap(),s=c.Geometry.getBoxAround(e,t,this.range);return n.getCellsWithCoord(s)}getMenuItem(){const e=this.getCells();return[this.getName(),this.activate.bind(this,e)]}}t.Area=g,t.Ability.Area=g;class y extends p{constructor(e){super(e)}activate(e){const t=JSON.stringify(e);i.default.err("Ability.Item","activate","Not impl. in base class. Called with: "+t)}getMenuItem(){const e=this.actor.getInvEq().getInventory().getItems().map(e=>[e.toString(),this.activate.bind(this,e)]),t=new u.MenuWithQuit(e);return t.addPre("Select an item to sharpen:"),[this.getName(),t]}}t.Item=y,t.Ability.Item=y;class v extends t.Ability.Item{constructor(){super("Sharpener")}activate(e){const t=e.getName();if(e.has("Sharpened"))i.default.gameMsg(t+" has already been sharpened");else if(e.getDamageDie){e.add(new h.Sharpened);const n=d.getUniformInt(1,3),s=e.getDamageDie();s.setMod(s.getMod()+n),e.setValue(e.getValue()+10*n),i.default.gameMsg("You sharpen "+t)}else i.default.gameMsg("It's useless to sharpen "+t)}}t.Sharpener=v,t.Ability.Sharpener=v;class b extends m{constructor(){super("Bribery")}getMenuItem(){const e=super.getMenuItem(),t=new u.MenuConfirm([]);return e[1].returnMenu=t,t.onSelectCallback=e=>{const n=function(e,t){const[n,s]=i.default.newXYFromDir(e,t),r=t.getLevel().getMap().getCell(n,s);if(r.hasActors())return r.getFirstActor();return null}(e,this.actor);t.callback=()=>{n&&this.bribeActor(n)};let s=1;n.has("Experience")&&(s=n.get("Experience").getDanger(),s<=0&&(s=1));const r=`Bribing ${n.getName()} will cost ${s}.`+" "+t.msg;i.default.gameMsg(r),t.setMsg(r)},i.default.gameMsg("Select a direction for bribing an actor:"),e}bribeActor(e){const t=this.actor.getName();let n=`${e.getName()} seems to be friendly towards ${t}.`;this.canBribe(e)?e.isEnemy(this.actor)?(n=`${e.getName()} seems not to be hostile anymore towards ${t}.`,e.removeEnemyType("player"),e.removeEnemy(this.actor)):e.addFriend(this.actor):n=e.getName()+" cannot be bribed.";const s=this.actor.getCell();i.default.gameMsg({cell:s,msg:n})}canBribe(e){return i.default.CANNOT_BRIBE.indexOf(e.getType())<0}}t.Bribery=b,t.Ability.Bribery=b;class _{constructor(e){this.actor=e,this.abilities={}}getMenu(){const e=Object.values(this.abilities).map(e=>e.getMenuItem());this.actor.useFuncs&&this.actor.useFuncs.forEach((t,n)=>{const s=this.actor.get("UseEffects").getEffects();e.push(this.getMenuItemForUseFunc(t,s[n]))});const t=new u.MenuWithQuit(e);return t.setName("MenuAbilities"),t.addPre("Select an ability to use:"),t}addAbility(e){this.abilities[e.getName()]=e,e.actor=this.actor}getMenuItemForUseFunc(e,t){const n=new u.MenuSelectDir([]);return n.setCallback(t=>{const[n,s]=i.default.newXYFromDir(t,this.actor),r=this.actor.getLevel().getMap().getCell(n,s);e.call(this.actor,{target:r})}),[this.getEffName(t),n]}getEffName(e){for(const t in e)if(e[t].name)return e[t].name;return"<ERROR: No effect name given >"}toJSON(){return Object.keys(this.abilities)}}t.Abilities=_,t.Ability.Abilities=_;const E=["Bribery","Camouflage","Sharpener"];function S(e){const n=e.get("Abilities");n&&E.forEach(e=>{const s=new t.Ability[e];n.addAbility(s)})}t.addAllAbilities=S,t.Ability.addAllAbilities=S},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ChatWizard=t.ChatTrainer=t.ChatQuest=t.ChatBase=t.Chat=void 0;const i=o(n(4)),l=n(25),c=a(n(54)),u=a(n(39)),h=a(n(188));t.Chat={};const d=i.default.STATS,p=c.Menu.EXIT_MENU,f="Say goodbye";t.Chat.TOP_MENU="TOP_MENU",t.Chat.tradeGoldWeightFromTo=(e,t,n)=>{const s=i.default.getGoldInCoins(e),r=new u.GoldCoin,a=i.default.removeNCoins(t,s);r.setCount(a),n.getInvEq().addItem(r)};class m{constructor(){this.options=[],this.parent=null,this.name=""}setName(e){this.name=e}getName(){return this.name}add({name:e,option:t}){this.options.push({name:e,option:t}),t&&t.setParent&&t.setParent(this)}clearOptions(){this.options=[]}setParent(e){this.parent=e}getParent(){return this.parent}getSelectionObject(){return{showMenu:()=>!0,getMenu:()=>{const e={pre:[],post:[]};return this.options.forEach((t,n)=>{e[l.Keys.menuIndices[n]]=t.name}),this.pre&&(e.pre=this.pre),this.post&&(e.post=this.post),b(e),e},select:e=>{const t=l.Keys.codeToIndex(e);if(t<this.options.length){const e=this.options[t].option;return e!==p&&e.getSelectionObject?e.getSelectionObject():e}return p}}}}t.ChatBase=m,t.Chat.ChatBase=m;class g extends m{constructor(){super();const e={name:"Accept the quest",option:this.questCallback.bind(this)},t={name:"Refuse the quest",option:p};this.add(e),this.add(t)}setQuestGiver(e){this.questGiver=e}setTarget(e){const t=this.questGiver;this.chatter=e;const n=this.questGiver.get("QuestGiver");if(n.getHasGivenQuest()){this.pre=[t.getName()+" has already given this quest:",""+n.getDescr(),"What do you want to do?"],this.clearOptions();const e={name:"Claim the reward",option:this.rewardCallback.bind(this)};this.add(e)}else this.pre=[t.getName()+" wants to offer a lengthy quest:",""+n.getDescr(),"What do you want to do?"]}questCallback(){i.default.isNullOrUndef([this.chatter,this.questGiver])&&i.default.err("ChatQuest","questCallback","target and questGiver must be defined");const e=new h.GiveQuest;e.setTarget(this.chatter),e.setGiver(this.questGiver),this.chatter.add(e)}rewardCallback(){const e=new h.QuestCompleted;e.setGiver(this.questGiver),this.chatter.add(e)}}t.ChatQuest=g,t.Chat.Quest=g;class y extends m{constructor(){super(),this.selectionObject={showMenu:()=>!0,getMenu:()=>{const e=l.Keys.menuIndices.slice(0,d.length),t={pre:["Please select a stat to train:"]};return d.forEach((n,s)=>{t[e[s]]=d[s],t[e[s]]+=` (${this.costs[s]} gold)`}),b(t),t},select:e=>{const t=l.Keys.codeToIndex(e);if(t<d.length){const e=d[t],n=this.costs[t];return this.trainCallback(e,n)}return p}},this.trainCallback=this.trainCallback.bind(this)}setTrainer(e){this.trainer=e}setTarget(e){this.chatter=e,this.costs=[],d.forEach(t=>{const n="get"+t;let s=100-2*i.default.getSkillLevel(e,i.default.SKILLS.TRADING);s<50&&(s=50),this.costs.push(s*e.get("Stats")[n]())})}getSelectionObject(){return this.selectionObject}trainCallback(e,n){return()=>{const s=i.default.valueToGoldWeight(n),r=this.chatter.getName();if(!i.default.hasEnoughGold(this.chatter,s)){const e=r+" does not have enough gold.";return void i.default.gameMsg({cell:this.chatter.getCell(),msg:e})}const a=this.chatter.get("Stats"),o=this.trainer.get("Stats"),l="get"+e,c="set"+e,u=a[l](),h=o[l](),d=this.trainer.getName();if(u<h){const n=u+1;a[c](n);const o=`${d} trains ${e} of ${r}`;i.default.gameMsg({cell:this.chatter.getCell(),msg:o}),t.Chat.tradeGoldWeightFromTo(s,this.chatter,this.trainer)}else{const e=d+" doesn't have skill to train that stat";i.default.gameMsg({cell:this.chatter.getCell(),msg:e})}}}}t.ChatTrainer=y,t.Chat.Trainer=y;class v extends m{constructor(){super(),this.costs={0:10,1:45,2:50},this.selectionObject={showMenu:()=>!0,getMenu:()=>{i.default.gameMsg("Please select a magical service to buy:");const e=this.wizard.get("SpellPower").getPP(),t={};e>=10&&(t[0]="Restore 10pp - 10 gold coins"),e>=50&&(t[1]="Restore 50pp - 45 gold coins"),e>=25&&(t[2]="Add one charge to rune - 50 gold coins")},select:e=>{const t=l.Keys.codeToIndex(e);return this.wizardCallback(t)}},this.wizardCallback=this.wizardCallback.bind(this)}setWizard(e){this.wizard=e}getSelectionObject(){return this.selectionObject}wizardCallback(e){const t=this.costs[e];return()=>{if(i.default.hasEnoughGold(this.chatter,t))switch(e){case 0:this.restorePP(10);break;case 1:this.restorePP(50);break;case 2:this.setRuneSelectionObject()}}}restorePP(e){this.wizard.get("SpellPower").decrPP(e);this.chatter.get("SpellPower").addPP(e)}setRuneSelectionObject(){this.chatter.getBrain().setSelectionObject({})}}t.ChatWizard=v,t.Chat.Wizard=v;function b(e){e.Q=f}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getQuestVerb=t.QuestTargetEvent=t.GiveQuest=t.QuestCompleted=t.QuestReport=t.QuestInfo=t.Quest=t.QuestEscortTarget=t.QuestTarget=t.QuestGiver=void 0;const r=s(n(4)),a=n(187),o=n(34),i=o.Component.UniqueDataComponent,l=o.Component.DataComponent,c=o.Component.TransientDataComponent,u=o.ComponentBase.prototype;function h(e){const t=e.toLowerCase();switch(t){case"location":return"Find location";case"reportlisten":return"Talk to";case"report":return"Report info to";case"give":return"Give item to";case"explore":return"Explore";case"get":return"Find item";case"listen":return"Get info from";case"winbattle":return"Defeat enemy army in";case"finishbattle":return"Fight battle until end in";case"kill":return"Kill";case"read":return"Read";case"damage":return"Do some damage to";default:return console.log("getQuestVerb ret default for",e),t.toUpperCase()}}t.QuestGiver=i("QuestGiver",{hasGivenQuest:!1,descr:"",questID:-1,danger:1,reward:-1,hasGivenReward:!1,questTargets:null}),t.QuestGiver.prototype._init=function(e){this.chatObj=new a.ChatQuest,this.descr=e,this.questID=this.getID(),this.questTargets=[];this.addCallback("onAdd",()=>{this.chatObj.setQuestGiver(this.getEntity())})},t.QuestGiver.prototype.hasReward=function(){return this.reward&&-1!==this.reward},t.QuestGiver.prototype.giveQuest=function(e){e?(this.questGivenTo=e,this.hasGivenQuest=!0):this.hasGivenQuest=!1},t.QuestGiver.prototype.numTargets=function(){return this.questTargets.length},t.QuestGiver.prototype.addTarget=function(e,t){t||r.default.err("QuestGiver","addTarget","No target given. Type "+e);const n=r.default.getNameForQuest(t);if(r.default.isEmpty(n))r.default.err("QuestGiver","addTarget","Empty name got for target "+JSON.stringify(t));else{const s={id:t.getID(),name:n,targetType:e,subQuestID:-1,isCompleted:!1},r=t.get("QuestTarget");-1!==r.getSubQuestID()&&(s.subQuestID=r.getSubQuestID()),this.questTargets.push(s)}},t.QuestGiver.prototype.toJSON=function(){const e=u.toJSON.call(this);return this.questGivenTo&&(e.giveQuest=r.default.getObjRef("entity",this.questGivenTo)),e},t.QuestGiver.prototype.getChatObj=function(){return this.chatObj},t.QuestTarget=l("QuestTarget",{targetType:"",target:null,isCompleted:!1,targetID:-1,questID:-1,subQuestID:-1}),t.QuestTarget.prototype.isKill=function(){return"kill"===this.targetType},t.QuestTarget.prototype.toString=function(){let e="";if(this.target.getName)e=this.target.getName();else if(this.target.getParent){const t=this.target.getParent();if(t&&(e=t.getName()),t.getParent){e+=" of "+t.getParent().getName()}}return`${this.targetType} ${e}`},t.QuestTarget.prototype.toJSON=function(){const e=u.toJSON.call(this);return e.setTargetType=this.targetType,this.target.$objID?e.setTarget=r.default.getObjRef("object",this.target):e.setTarget=r.default.getObjRef("entity",this.target),e},t.QuestEscortTarget=l("QuestEscortTarget",{escortTo:-1,question:"Can I help you safely somewhere?"}),t.QuestEscortTarget.prototype.toJSON=function(){const e=u.toJSON.call(this);return e.setEscortTo=r.default.getObjRef("entity",this.escortTo),e},t.Quest=l("Quest",{giver:null,questTargets:null,questID:-1,descr:""}),t.Quest.prototype._init=function(){this.questTargets=[]},t.Quest.prototype.addTarget=function(e){this.questTargets.push(e)},t.Quest.prototype.isInThisQuest=function(e){return this.getQuestID()===e.getQuestID()},t.Quest.prototype.getTargetsByType=function(e){return this.questTargets.filter(t=>t.targetType===e)},t.Quest.prototype.first=function(e){const t=this.questTargets.find(t=>t.targetType===e);return t||null},t.Quest.prototype.next=function(){for(let e=0,t=this.questTargets.length;e<t;e++)if(!this.questTargets[e].isCompleted)return this.questTargets[e];return null},t.Quest.prototype.isCompleted=function(){return this.questTargets.reduce((e,t)=>e&&t.isCompleted,!0)},t.Quest.prototype.isTargetInQuest=function(e){const t=e.getTarget();for(let e=0;e<this.questTargets.length;e++){if(this.questTargets[e].id===t.getID())return!0}return!1},t.Quest.prototype.toString=function(){let e="";return this.questTargets.forEach((t,n)=>{n>0&&(e+=". "),"subquest"===t.targetType?e+="Talk to "+t.name:e+=h(t.targetType)+" "+t.name}),e},t.QuestInfo=l("QuestInfo",{question:"",info:"",givenBy:-1}),t.QuestReport=l("QuestReport",{expectInfoFrom:-2}),t.QuestCompleted=c("QuestCompleted",{giver:null}),t.GiveQuest=c("GiveQuest",{target:null,giver:null}),t.QuestTargetEvent=c("QuestTargetEvent",{targetComp:null,args:null,eventType:""}),t.QuestTargetEvent.prototype.setTargetComp=function(e){r.default.assertType(e,"QuestTarget"),this.targetComp=e},t.getQuestVerb=h},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=a(n(1)),l=o(n(475)),c=a(n(190)),u=(e,t,n,s)=>{const r=e.clientX,a=e.clientY,o=n.sizeX,i=n.startX,l=n.startY;if(!t)return[0,0];const c=t.getBoundingClientRect(),u=t.getElementsByClassName(s)[0];if(u){const e=u.clientWidth/o,t=u.clientHeight,n=r-c.left,s=a-c.top;return[Math.floor(n/e)+i,Math.floor(s/t)+l]}return[0,0]};class h extends i.Component{constructor(e){super(e),this.onCellClick=this.onCellClick.bind(this),this.onMouseOverCell=this.onMouseOverCell.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseOver=this.onMouseOver.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.fgColorCache=null,this.bgColorCache=null}componentDidMount(){this.props.onMouseOverCell&&this.board.addEventListener("contextmenu",this.onMouseOverCell,!0),this.props.onMouseDown&&this.board.addEventListener("mousedown",this.onMouseDown,!0),this.props.onMouseUp&&this.board.addEventListener("mouseup",this.onMouseUp,!0),this.props.onMouseOver&&this.board.addEventListener("mouseover",this.onMouseOver,!0)}componentWillUnmount(){this.props.onMouseOverCell&&this.board.removeEventListener("contextmenu",this.onMouseOverCell),this.props.onMouseDown&&this.board.removeEventListener("mousedown",this.onMouseDown,!0),this.props.onMouseUp&&this.board.removeEventListener("mouseup",this.onMouseUp,!0),this.props.onMouseOver&&this.board.removeEventListener("mouseover",this.onMouseOver,!0)}onCellClick(e){const t=u(e,this.board,this.props,"game-board-row");t&&this.props.onCellClick(t[0],t[1])}onMouseOver(e){if(this.props.onMouseOver){e.preventDefault();const t=u(e,this.board,this.props,"game-board-row");this.props.onMouseOver(t[0],t[1])}}onMouseUp(e){if(this.props.onMouseUp){e.preventDefault();const t=u(e,this.board,this.props,"game-board-row");this.props.onMouseUp(t[0],t[1])}}onMouseDown(e){if(this.props.onMouseDown){e.preventDefault();const t=u(e,this.board,this.props,"game-board-row");this.props.onMouseDown(t[0],t[1])}}getCellXY(e){return u(e,this.board,this.props,"game-board-row")}render(){if(!this.props.renderInAscii)return this.renderTiles();const e=[];for(let t=this.props.startY;t<=this.props.endY;++t){const n=t-this.props.startY,s=this.props.startX+","+t;e.push(i.createElement(l.default,{key:s,rowChars:this.props.charRows[n],rowClass:this.props.rowClass,rowClasses:this.props.classRows[n],startX:this.props.startX,useRLE:!!this.props.useRLE,y:t}))}return i.createElement("div",{className:"game-board "+this.props.boardClassName,onClick:this.onCellClick,ref:e=>{this.board=e}},e)}renderTiles(){if(!this.display){const e=document.createElement("img");e.src="public/battles_tileset.png",this.display=new c.Display({layout:"tile",width:this.props.sizeX,height:this.props.endY-this.props.startY+1,tileWidth:16,tileHeight:16,tileSet:e,tileMap:{"#":[0,0]},fontFamily:"Everson Mono",fontSize:16,forceSquareRatio:!0})}this.fgColorCache||this.buildColorCache();const e=this.display.getContainer(),t=document.getElementById("battles-tile-displays");t?t.appendChild(e):console.log("ERR. No divElem found!");for(let e=0;e<this.props.charRows.length;++e){const t=e,n=d(this.props.charRows[t]),s=this.decodeColors(this.props.classRows[t]);let r=0;n.forEach(t=>{const n=s[r][0],a=s[r][1];this.display.draw(r,e,t,n,a),r+=1})}return i.createElement("div",{id:"battles-tile-displays",onClick:this.onCellClick,ref:e=>{this.board=e}})}buildColorCache(){const e=document.styleSheets[1].cssRules;this.fgColorCache={},this.bgColorCache={};for(let t=0;t<e.length;t++){const n=e[t];console.log("cssRule is now",n);const s=n.style;if(s){const e=s.color,t=s.backgroundColor;e&&(this.fgColorCache[n.selectorText]=e),t&&(this.bgColorCache[n.selectorText]=t)}}}decodeColors(e){const t=[];return e.forEach(e=>{const n=e[0],s=e[1].split(" ");let r="",a="";s.forEach(e=>{"cell-not-seen"!==e&&(r=this.fgColorCache["."+e],a=this.bgColorCache["."+e])});const o=[r,a];for(let e=0;e<n;e++)t.push(o)}),t}onMouseOverCell(e){if(this.props.onMouseOverCell){e.preventDefault(),console.log("<GameBoard> onMouseOverCell"),console.log(e);const t=u(e,this.board,this.props,"game-board-row");return console.log("<GameBoard> xy is "+t),this.props.onMouseOverCell(t[0],t[1]),!1}return!0}}function d(e){const t=[];return e.forEach(e=>{const n=parseInt(e[0],10),s=e[1];for(let e=0;e<n;e++)t.push(s)}),t}t.default=h},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Text=t.Color=t.Util=t.KEYS=t.DIRS=t.DEFAULT_HEIGHT=t.DEFAULT_WIDTH=t.Lighting=t.Engine=t.Path=t.Noise=t.Map=t.FOV=t.Scheduler=t.EventQueue=t.StringGenerator=t.Display=t.RNG=void 0;var i=n(22);Object.defineProperty(t,"RNG",{enumerable:!0,get:function(){return o(i).default}});var l=n(476);Object.defineProperty(t,"Display",{enumerable:!0,get:function(){return o(l).default}});var c=n(482);Object.defineProperty(t,"StringGenerator",{enumerable:!0,get:function(){return o(c).default}});var u=n(483);Object.defineProperty(t,"EventQueue",{enumerable:!0,get:function(){return o(u).default}});var h=n(266);Object.defineProperty(t,"Scheduler",{enumerable:!0,get:function(){return o(h).default}});var d=n(485);Object.defineProperty(t,"FOV",{enumerable:!0,get:function(){return o(d).default}});var p=n(279);Object.defineProperty(t,"Map",{enumerable:!0,get:function(){return o(p).default}});var f=n(666);Object.defineProperty(t,"Noise",{enumerable:!0,get:function(){return o(f).default}});var m=n(668);Object.defineProperty(t,"Path",{enumerable:!0,get:function(){return o(m).default}});var g=n(670);Object.defineProperty(t,"Engine",{enumerable:!0,get:function(){return o(g).default}});var y=n(671);Object.defineProperty(t,"Lighting",{enumerable:!0,get:function(){return o(y).default}});var v=n(42);Object.defineProperty(t,"DEFAULT_WIDTH",{enumerable:!0,get:function(){return v.DEFAULT_WIDTH}}),Object.defineProperty(t,"DEFAULT_HEIGHT",{enumerable:!0,get:function(){return v.DEFAULT_HEIGHT}}),Object.defineProperty(t,"DIRS",{enumerable:!0,get:function(){return v.DIRS}}),Object.defineProperty(t,"KEYS",{enumerable:!0,get:function(){return v.KEYS}});const b=a(n(139));t.Util=b;const _=a(n(140));t.Color=_;const E=a(n(278));t.Text=E},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(192));class a extends r.default{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(e){requestAnimationFrame(e)}getContainer(){return this._ctx.canvas}setOptions(e){super.setOptions(e);const t=`${e.fontStyle?e.fontStyle+" ":""} ${e.fontSize}px ${e.fontFamily}`;this._ctx.font=t,this._updateSize(),this._ctx.font=t,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height)}eventToPosition(e,t){const n=this._ctx.canvas,s=n.getBoundingClientRect();return e-=s.left,t-=s.top,e*=n.width/s.width,t*=n.height/s.height,e<0||t<0||e>=n.width||t>=n.height?[-1,-1]:this._normalizedEventToPosition(e,t)}}t.default=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{getContainer(){return null}setOptions(e){this._options=e}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(42);t.default=class{constructor(e,t={}){this._lightPasses=e,this._options=Object.assign({topology:8},t)}_getCircle(e,t,n){const r=[];let a,o,i;switch(this._options.topology){case 4:o=1,i=[0,1],a=[s.DIRS[8][7],s.DIRS[8][1],s.DIRS[8][3],s.DIRS[8][5]];break;case 6:a=s.DIRS[6],o=1,i=[-1,1];break;case 8:a=s.DIRS[4],o=2,i=[-1,1];break;default:throw new Error("Incorrect topology for FOV computation")}let l=e+i[0]*n,c=t+i[1]*n;for(let e=0;e<a.length;e++)for(let t=0;t<n*o;t++)r.push([l,c]),l+=a[e][0],c+=a[e][1];return r}}},function(e,t,n){"use strict";var s=n(36);e.exports=r;function r(e){this._isDirected=!s.has(e,"directed")||e.directed,this._isMultigraph=!!s.has(e,"multigraph")&&e.multigraph,this._isCompound=!!s.has(e,"compound")&&e.compound,this._label=void 0,this._defaultNodeLabelFn=s.constant(void 0),this._defaultEdgeLabelFn=s.constant(void 0),this._nodes={},this._isCompound&&(this._parent={},this._children={},this._children["\0"]={}),this._in={},this._preds={},this._out={},this._sucs={},this._edgeObjs={},this._edgeLabels={}}function a(e,t){e[t]?e[t]++:e[t]=1}function o(e,t){--e[t]||delete e[t]}function i(e,t,n,r){var a=""+t,o=""+n;if(!e&&a>o){var i=a;a=o,o=i}return a+""+o+""+(s.isUndefined(r)?"\0":r)}function l(e,t,n,s){var r=""+t,a=""+n;if(!e&&r>a){var o=r;r=a,a=o}var i={v:r,w:a};return s&&(i.name=s),i}function c(e,t){return i(e,t.v,t.w,t.name)}r.prototype._nodeCount=0,r.prototype._edgeCount=0,r.prototype.isDirected=function(){return this._isDirected},r.prototype.isMultigraph=function(){return this._isMultigraph},r.prototype.isCompound=function(){return this._isCompound},r.prototype.setGraph=function(e){return this._label=e,this},r.prototype.graph=function(){return this._label},r.prototype.setDefaultNodeLabel=function(e){return s.isFunction(e)||(e=s.constant(e)),this._defaultNodeLabelFn=e,this},r.prototype.nodeCount=function(){return this._nodeCount},r.prototype.nodes=function(){return s.keys(this._nodes)},r.prototype.sources=function(){var e=this;return s.filter(this.nodes(),(function(t){return s.isEmpty(e._in[t])}))},r.prototype.sinks=function(){var e=this;return s.filter(this.nodes(),(function(t){return s.isEmpty(e._out[t])}))},r.prototype.setNodes=function(e,t){var n=arguments,r=this;return s.each(e,(function(e){n.length>1?r.setNode(e,t):r.setNode(e)})),this},r.prototype.setNode=function(e,t){return s.has(this._nodes,e)?(arguments.length>1&&(this._nodes[e]=t),this):(this._nodes[e]=arguments.length>1?t:this._defaultNodeLabelFn(e),this._isCompound&&(this._parent[e]="\0",this._children[e]={},this._children["\0"][e]=!0),this._in[e]={},this._preds[e]={},this._out[e]={},this._sucs[e]={},++this._nodeCount,this)},r.prototype.node=function(e){return this._nodes[e]},r.prototype.hasNode=function(e){return s.has(this._nodes,e)},r.prototype.removeNode=function(e){var t=this;if(s.has(this._nodes,e)){var n=function(e){t.removeEdge(t._edgeObjs[e])};delete this._nodes[e],this._isCompound&&(this._removeFromParentsChildList(e),delete this._parent[e],s.each(this.children(e),(function(e){t.setParent(e)})),delete this._children[e]),s.each(s.keys(this._in[e]),n),delete this._in[e],delete this._preds[e],s.each(s.keys(this._out[e]),n),delete this._out[e],delete this._sucs[e],--this._nodeCount}return this},r.prototype.setParent=function(e,t){if(!this._isCompound)throw new Error("Cannot set parent in a non-compound graph");if(s.isUndefined(t))t="\0";else{for(var n=t+="";!s.isUndefined(n);n=this.parent(n))if(n===e)throw new Error("Setting "+t+" as parent of "+e+" would create a cycle");this.setNode(t)}return this.setNode(e),this._removeFromParentsChildList(e),this._parent[e]=t,this._children[t][e]=!0,this},r.prototype._removeFromParentsChildList=function(e){delete this._children[this._parent[e]][e]},r.prototype.parent=function(e){if(this._isCompound){var t=this._parent[e];if("\0"!==t)return t}},r.prototype.children=function(e){if(s.isUndefined(e)&&(e="\0"),this._isCompound){var t=this._children[e];if(t)return s.keys(t)}else{if("\0"===e)return this.nodes();if(this.hasNode(e))return[]}},r.prototype.predecessors=function(e){var t=this._preds[e];if(t)return s.keys(t)},r.prototype.successors=function(e){var t=this._sucs[e];if(t)return s.keys(t)},r.prototype.neighbors=function(e){var t=this.predecessors(e);if(t)return s.union(t,this.successors(e))},r.prototype.isLeaf=function(e){return 0===(this.isDirected()?this.successors(e):this.neighbors(e)).length},r.prototype.filterNodes=function(e){var t=new this.constructor({directed:this._isDirected,multigraph:this._isMultigraph,compound:this._isCompound});t.setGraph(this.graph());var n=this;s.each(this._nodes,(function(n,s){e(s)&&t.setNode(s,n)})),s.each(this._edgeObjs,(function(e){t.hasNode(e.v)&&t.hasNode(e.w)&&t.setEdge(e,n.edge(e))}));var r={};return this._isCompound&&s.each(t.nodes(),(function(e){t.setParent(e,function e(s){var a=n.parent(s);return void 0===a||t.hasNode(a)?(r[s]=a,a):a in r?r[a]:e(a)}(e))})),t},r.prototype.setDefaultEdgeLabel=function(e){return s.isFunction(e)||(e=s.constant(e)),this._defaultEdgeLabelFn=e,this},r.prototype.edgeCount=function(){return this._edgeCount},r.prototype.edges=function(){return s.values(this._edgeObjs)},r.prototype.setPath=function(e,t){var n=this,r=arguments;return s.reduce(e,(function(e,s){return r.length>1?n.setEdge(e,s,t):n.setEdge(e,s),s})),this},r.prototype.setEdge=function(){var e,t,n,r,o=!1,c=arguments[0];"object"==typeof c&&null!==c&&"v"in c?(e=c.v,t=c.w,n=c.name,2===arguments.length&&(r=arguments[1],o=!0)):(e=c,t=arguments[1],n=arguments[3],arguments.length>2&&(r=arguments[2],o=!0)),e=""+e,t=""+t,s.isUndefined(n)||(n=""+n);var u=i(this._isDirected,e,t,n);if(s.has(this._edgeLabels,u))return o&&(this._edgeLabels[u]=r),this;if(!s.isUndefined(n)&&!this._isMultigraph)throw new Error("Cannot set a named edge when isMultigraph = false");this.setNode(e),this.setNode(t),this._edgeLabels[u]=o?r:this._defaultEdgeLabelFn(e,t,n);var h=l(this._isDirected,e,t,n);return e=h.v,t=h.w,Object.freeze(h),this._edgeObjs[u]=h,a(this._preds[t],e),a(this._sucs[e],t),this._in[t][u]=h,this._out[e][u]=h,this._edgeCount++,this},r.prototype.edge=function(e,t,n){var s=1===arguments.length?c(this._isDirected,arguments[0]):i(this._isDirected,e,t,n);return this._edgeLabels[s]},r.prototype.hasEdge=function(e,t,n){var r=1===arguments.length?c(this._isDirected,arguments[0]):i(this._isDirected,e,t,n);return s.has(this._edgeLabels,r)},r.prototype.removeEdge=function(e,t,n){var s=1===arguments.length?c(this._isDirected,arguments[0]):i(this._isDirected,e,t,n),r=this._edgeObjs[s];return r&&(e=r.v,t=r.w,delete this._edgeLabels[s],delete this._edgeObjs[s],o(this._preds[t],e),o(this._sucs[e],t),delete this._in[t][s],delete this._out[e][s],this._edgeCount--),this},r.prototype.inEdges=function(e,t){var n=this._in[e];if(n){var r=s.values(n);return t?s.filter(r,(function(e){return e.v===t})):r}},r.prototype.outEdges=function(e,t){var n=this._out[e];if(n){var r=s.values(n);return t?s.filter(r,(function(e){return e.w===t})):r}},r.prototype.nodeEdges=function(e,t){var n=this.inEdges(e,t);if(n)return n.concat(this.outEdges(e,t))}},function(e,t,n){var s=n(141),r=n(499),a=n(500),o=n(501),i=n(502),l=n(503);function c(e){var t=this.__data__=new s(e);this.size=t.size}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=o,c.prototype.has=i,c.prototype.set=l,e.exports=c},function(e,t){e.exports=function(e,t){return e===t||e!=e&&t!=t}},function(e,t,n){var s=n(74)(n(44),"Map");e.exports=s},function(e,t,n){var s=n(510),r=n(517),a=n(519),o=n(520),i=n(521);function l(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var s=e[t];this.set(s[0],s[1])}}l.prototype.clear=s,l.prototype.delete=r,l.prototype.get=a,l.prototype.has=o,l.prototype.set=i,e.exports=l},function(e,t){e.exports=function(e,t){for(var n=-1,s=null==e?0:e.length;++n<s&&!1!==t(e[n],n,e););return e}},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t){e.exports=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}},function(e,t){e.exports=function(e){return function(t){return e(t)}}},function(e,t,n){(function(e){var s=n(282),r=t&&!t.nodeType&&t,a=r&&"object"==typeof e&&e&&!e.nodeType&&e,o=a&&a.exports===r&&s.process,i=function(){try{var e=a&&a.require&&a.require("util").types;return e||o&&o.binding&&o.binding("util")}catch(e){}}();e.exports=i}).call(this,n(200)(e))},function(e,t,n){var s=n(149),r=n(527),a=Object.prototype.hasOwnProperty;e.exports=function(e){if(!s(e))return r(e);var t=[];for(var n in Object(e))a.call(e,n)&&"constructor"!=n&&t.push(n);return t}},function(e,t,n){var s=n(287),r=n(529),a=n(77);e.exports=function(e){return a(e)?s(e,!0):r(e)}},function(e,t,n){var s=n(290),r=n(291),a=Object.prototype.propertyIsEnumerable,o=Object.getOwnPropertySymbols,i=o?function(e){return null==e?[]:(e=Object(e),s(o(e),(function(t){return a.call(e,t)})))}:r;e.exports=i},function(e,t){e.exports=function(e,t){for(var n=-1,s=t.length,r=e.length;++n<s;)e[r+n]=t[n];return e}},function(e,t,n){var s=n(289)(Object.getPrototypeOf,Object);e.exports=s},function(e,t,n){var s=n(296);e.exports=function(e){var t=new e.constructor(e.byteLength);return new s(t).set(new s(e)),t}},function(e,t){e.exports=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}},function(e,t,n){var s=n(20),r=n(212),a=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,o=/^\w*$/;e.exports=function(e,t){if(s(e))return!1;var n=typeof e;return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=e&&!r(e))||(o.test(e)||!a.test(e)||null!=t&&e in Object(t))}},function(e,t,n){var s=n(93),r=n(56);e.exports=function(e){return"symbol"==typeof e||r(e)&&"[object Symbol]"==s(e)}},function(e,t){e.exports=function(e,t){for(var n=-1,s=null==e?0:e.length,r=Array(s);++n<s;)r[n]=t(e[n],n,e);return r}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t,n){this.entity=e+"",this.__uniqid__=n,this.load(t||{})}return e.prototype.load=function(e){var t=Object.create(null);return Object.keys(e).forEach((function(n){t[n]=e[n]})),this.properties=t,this},e.prototype.set=function(e,t){return this.properties[e]=t},e.prototype.unset=function(e){return delete this.properties[e]},e.prototype.has=function(e){return Object.prototype.hasOwnProperty.call(this.properties,e)},e.prototype.get=function(e){return this.properties[e]},e.prototype.toString=function(){return[this.constructor.name," (",this.entity," ",JSON.stringify(this.properties),")"].join("")},e.prototype.valueOf=function(){return this.toString()},e.prototype.toJSON=function(){return[this.entity,this.properties,this.__uniqid__]},e}();t.Unit=s,t.default=function(){return s}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=n(319),r=function(){function e(e){this._name=e,this._units=[],this._indices=Object.create(null),this._indicesList=[]}return e.prototype.name=function(){return this._name},e.prototype.indices=function(){return this._indicesList.slice()},e.prototype.toJSON=function(){return[this._name,this._indicesList.slice()]},e.prototype.createIndex=function(e){return this.createIndices([e])},e.prototype.createIndices=function(e){this._indicesList=this._indicesList.concat(e);for(var t=this._indices,n=this._units,s=0,r=e.length;s<r;s++)for(var a=e[s],o=t[a]=Object.create(null),i=0,l=n.length;i<l;i++){var c=n[i],u=c.get(a);u&&(o[u]=c)}return this},e.prototype._add=function(e){if(e){this._units.push(e);for(var t=this._indicesList,n=t.length,s=this._indices,r=0;r<n;r++){var a=t[r],o=s[a],i=e.get(a);i&&(o[i]=e)}}return e},e.prototype._remove=function(e){if(e){var t=this._units.indexOf(e);t>-1&&this._units.splice(t,1);for(var n=this._indicesList,s=n.length,r=this._indices,a=0;a<s;a++){var o=n[a];delete r[o][e.get(o)]}}return e},e.prototype.find=function(e,t){t||(t=e,e=this._indicesList[0]);var n=this._indices[e];return n&&n[t]},e.prototype.destroy=function(e,t){t||(t=e,e=this._indicesList[0]);var n=this._indices[e];return n&&this._remove(n[t])},e.prototype.query=function(){return new s.Query(this._units)},e}();t.Collection=r,t.default=function(){return r}},function(e,t,n){"use strict";var s,r="object"==typeof Reflect?Reflect:null,a=r&&"function"==typeof r.apply?r.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};s=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function i(){i.init.call(this)}e.exports=i,e.exports.once=function(e,t){return new Promise((function(n,s){function r(){void 0!==a&&e.removeListener("error",a),n([].slice.call(arguments))}var a;"error"!==t&&(a=function(n){e.removeListener(t,r),s(n)},e.once("error",a)),e.once(t,r)}))},i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var l=10;function c(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function u(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function h(e,t,n,s){var r,a,o,i;if(c(n),void 0===(a=e._events)?(a=e._events=Object.create(null),e._eventsCount=0):(void 0!==a.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),a=e._events),o=a[t]),void 0===o)o=a[t]=n,++e._eventsCount;else if("function"==typeof o?o=a[t]=s?[n,o]:[o,n]:s?o.unshift(n):o.push(n),(r=u(e))>0&&o.length>r&&!o.warned){o.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=o.length,i=l,console&&console.warn&&console.warn(i)}return e}function d(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,n){var s={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},r=d.bind(s);return r.listener=n,s.wrapFn=r,r}function f(e,t,n){var s=e._events;if(void 0===s)return[];var r=s[t];return void 0===r?[]:"function"==typeof r?n?[r.listener||r]:[r]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(r):g(r,r.length)}function m(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function g(e,t){for(var n=new Array(t),s=0;s<t;++s)n[s]=e[s];return n}Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");l=e}}),i.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},i.prototype.getMaxListeners=function(){return u(this)},i.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var s="error"===e,r=this._events;if(void 0!==r)s=s&&void 0===r.error;else if(!s)return!1;if(s){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var i=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw i.context=o,i}var l=r[e];if(void 0===l)return!1;if("function"==typeof l)a(l,this,t);else{var c=l.length,u=g(l,c);for(n=0;n<c;++n)a(u[n],this,t)}return!0},i.prototype.addListener=function(e,t){return h(this,e,t,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(e,t){return h(this,e,t,!0)},i.prototype.once=function(e,t){return c(t),this.on(e,p(this,e,t)),this},i.prototype.prependOnceListener=function(e,t){return c(t),this.prependListener(e,p(this,e,t)),this},i.prototype.removeListener=function(e,t){var n,s,r,a,o;if(c(t),void 0===(s=this._events))return this;if(void 0===(n=s[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(r=-1,a=n.length-1;a>=0;a--)if(n[a]===t||n[a].listener===t){o=n[a].listener,r=a;break}if(r<0)return this;0===r?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,r),1===n.length&&(s[e]=n[0]),void 0!==s.removeListener&&this.emit("removeListener",e,o||t)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(e){var t,n,s;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var r,a=Object.keys(n);for(s=0;s<a.length;++s)"removeListener"!==(r=a[s])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this},i.prototype.listeners=function(e){return f(this,e,!0)},i.prototype.rawListeners=function(e){return f(this,e,!1)},i.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):m.call(e,t)},i.prototype.listenerCount=m,i.prototype.eventNames=function(){return this._eventsCount>0?s(this._events):[]}},function(e,t,n){(t=e.exports=n(322)).Stream=t,t.Readable=t,t.Writable=n(218),t.Duplex=n(79),t.Transform=n(326),t.PassThrough=n(643)},function(e,t,n){"use strict";(function(t,s,r){var a=n(154);function o(e){var t=this;this.next=null,this.entry=null,this.finish=function(){!function(e,t,n){var s=e.entry;e.entry=null;for(;s;){var r=s.callback;t.pendingcb--,r(n),s=s.next}t.corkedRequestsFree?t.corkedRequestsFree.next=e:t.corkedRequestsFree=e}(t,e)}}e.exports=v;var i,l=!t.browser&&["v0.10","v0.9."].indexOf(t.version.slice(0,5))>-1?s:a.nextTick;v.WritableState=y;var c=n(116);c.inherits=n(78);var u={deprecate:n(642)},h=n(323),d=n(155).Buffer,p=r.Uint8Array||function(){};var f,m=n(324);function g(){}function y(e,t){i=i||n(79),e=e||{};var s=t instanceof i;this.objectMode=!!e.objectMode,s&&(this.objectMode=this.objectMode||!!e.writableObjectMode);var r=e.highWaterMark,c=e.writableHighWaterMark,u=this.objectMode?16:16384;this.highWaterMark=r||0===r?r:s&&(c||0===c)?c:u,this.highWaterMark=Math.floor(this.highWaterMark),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var h=!1===e.decodeStrings;this.decodeStrings=!h,this.defaultEncoding=e.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){!function(e,t){var n=e._writableState,s=n.sync,r=n.writecb;if(function(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}(n),t)!function(e,t,n,s,r){--t.pendingcb,n?(a.nextTick(r,s),a.nextTick(C,e,t),e._writableState.errorEmitted=!0,e.emit("error",s)):(r(s),e._writableState.errorEmitted=!0,e.emit("error",s),C(e,t))}(e,n,s,t,r);else{var o=S(n);o||n.corked||n.bufferProcessing||!n.bufferedRequest||E(e,n),s?l(_,e,n,o,r):_(e,n,o,r)}}(t,e)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.bufferedRequestCount=0,this.corkedRequestsFree=new o(this)}function v(e){if(i=i||n(79),!(f.call(v,this)||this instanceof i))return new v(e);this._writableState=new y(e,this),this.writable=!0,e&&("function"==typeof e.write&&(this._write=e.write),"function"==typeof e.writev&&(this._writev=e.writev),"function"==typeof e.destroy&&(this._destroy=e.destroy),"function"==typeof e.final&&(this._final=e.final)),h.call(this)}function b(e,t,n,s,r,a,o){t.writelen=s,t.writecb=o,t.writing=!0,t.sync=!0,n?e._writev(r,t.onwrite):e._write(r,a,t.onwrite),t.sync=!1}function _(e,t,n,s){n||function(e,t){0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}(e,t),t.pendingcb--,s(),C(e,t)}function E(e,t){t.bufferProcessing=!0;var n=t.bufferedRequest;if(e._writev&&n&&n.next){var s=t.bufferedRequestCount,r=new Array(s),a=t.corkedRequestsFree;a.entry=n;for(var i=0,l=!0;n;)r[i]=n,n.isBuf||(l=!1),n=n.next,i+=1;r.allBuffers=l,b(e,t,!0,t.length,r,"",a.finish),t.pendingcb++,t.lastBufferedRequest=null,a.next?(t.corkedRequestsFree=a.next,a.next=null):t.corkedRequestsFree=new o(t),t.bufferedRequestCount=0}else{for(;n;){var c=n.chunk,u=n.encoding,h=n.callback;if(b(e,t,!1,t.objectMode?1:c.length,c,u,h),n=n.next,t.bufferedRequestCount--,t.writing)break}null===n&&(t.lastBufferedRequest=null)}t.bufferedRequest=n,t.bufferProcessing=!1}function S(e){return e.ending&&0===e.length&&null===e.bufferedRequest&&!e.finished&&!e.writing}function w(e,t){e._final((function(n){t.pendingcb--,n&&e.emit("error",n),t.prefinished=!0,e.emit("prefinish"),C(e,t)}))}function C(e,t){var n=S(t);return n&&(!function(e,t){t.prefinished||t.finalCalled||("function"==typeof e._final?(t.pendingcb++,t.finalCalled=!0,a.nextTick(w,e,t)):(t.prefinished=!0,e.emit("prefinish")))}(e,t),0===t.pendingcb&&(t.finished=!0,e.emit("finish"))),n}c.inherits(v,h),y.prototype.getBuffer=function(){for(var e=this.bufferedRequest,t=[];e;)t.push(e),e=e.next;return t},function(){try{Object.defineProperty(y.prototype,"buffer",{get:u.deprecate((function(){return this.getBuffer()}),"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(e){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(f=Function.prototype[Symbol.hasInstance],Object.defineProperty(v,Symbol.hasInstance,{value:function(e){return!!f.call(this,e)||this===v&&(e&&e._writableState instanceof y)}})):f=function(e){return e instanceof this},v.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe, not readable"))},v.prototype.write=function(e,t,n){var s,r=this._writableState,o=!1,i=!r.objectMode&&(s=e,d.isBuffer(s)||s instanceof p);return i&&!d.isBuffer(e)&&(e=function(e){return d.from(e)}(e)),"function"==typeof t&&(n=t,t=null),i?t="buffer":t||(t=r.defaultEncoding),"function"!=typeof n&&(n=g),r.ended?function(e,t){var n=new Error("write after end");e.emit("error",n),a.nextTick(t,n)}(this,n):(i||function(e,t,n,s){var r=!0,o=!1;return null===n?o=new TypeError("May not write null values to stream"):"string"==typeof n||void 0===n||t.objectMode||(o=new TypeError("Invalid non-string/buffer chunk")),o&&(e.emit("error",o),a.nextTick(s,o),r=!1),r}(this,r,e,n))&&(r.pendingcb++,o=function(e,t,n,s,r,a){if(!n){var o=function(e,t,n){e.objectMode||!1===e.decodeStrings||"string"!=typeof t||(t=d.from(t,n));return t}(t,s,r);s!==o&&(n=!0,r="buffer",s=o)}var i=t.objectMode?1:s.length;t.length+=i;var l=t.length<t.highWaterMark;l||(t.needDrain=!0);if(t.writing||t.corked){var c=t.lastBufferedRequest;t.lastBufferedRequest={chunk:s,encoding:r,isBuf:n,callback:a,next:null},c?c.next=t.lastBufferedRequest:t.bufferedRequest=t.lastBufferedRequest,t.bufferedRequestCount+=1}else b(e,t,!1,i,s,r,a);return l}(this,r,i,e,t,n)),o},v.prototype.cork=function(){this._writableState.corked++},v.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.finished||e.bufferProcessing||!e.bufferedRequest||E(this,e))},v.prototype.setDefaultEncoding=function(e){if("string"==typeof e&&(e=e.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((e+"").toLowerCase())>-1))throw new TypeError("Unknown encoding: "+e);return this._writableState.defaultEncoding=e,this},v.prototype._write=function(e,t,n){n(new Error("_write() is not implemented"))},v.prototype._writev=null,v.prototype.end=function(e,t,n){var s=this._writableState;"function"==typeof e?(n=e,e=null,t=null):"function"==typeof t&&(n=t,t=null),null!=e&&this.write(e,t),s.corked&&(s.corked=1,this.uncork()),s.ending||s.finished||function(e,t,n){t.ending=!0,C(e,t),n&&(t.finished?a.nextTick(n):e.once("finish",n));t.ended=!0,e.writable=!1}(this,s,n)},Object.defineProperty(v.prototype,"destroyed",{get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(e){this._writableState&&(this._writableState.destroyed=e)}}),v.prototype.destroy=m.destroy,v.prototype._undestroy=m.undestroy,v.prototype._destroy=function(e,t){this.end(),t(e)}}).call(this,n(43),n(640).setImmediate,n(35))},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(667)),a=s(n(22)),o=n(139),i=.5*(Math.sqrt(3)-1),l=(3-Math.sqrt(3))/6;class c extends r.default{constructor(e=256){super(),this._gradients=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];let t=[];for(let n=0;n<e;n++)t.push(n);t=a.default.shuffle(t),this._perms=[],this._indexes=[];for(let n=0;n<2*e;n++)this._perms.push(t[n%e]),this._indexes.push(this._perms[n]%this._gradients.length)}get(e,t){const n=this._perms,s=this._indexes,r=n.length/2;let a,c=0,u=0,h=0;const d=(e+t)*i,p=Math.floor(e+d),f=Math.floor(t+d),m=(p+f)*l,g=e-(p-m),y=t-(f-m);let v,b;g>y?(v=1,b=0):(v=0,b=1);const _=g-v+l,E=y-b+l,S=g-1+2*l,w=y-1+2*l,C=o.mod(p,r),O=o.mod(f,r);let T=.5-g*g-y*y;if(T>=0){T*=T,a=s[C+n[O]];const e=this._gradients[a];c=T*T*(e[0]*g+e[1]*y)}let M=.5-_*_-E*E;if(M>=0){M*=M,a=s[C+v+n[O+b]];const e=this._gradients[a];u=M*M*(e[0]*_+e[1]*E)}let A=.5-S*S-w*w;if(A>=0){A*=A,a=s[C+1+n[O+1]];const e=this._gradients[a];h=A*A*(e[0]*S+e[1]*w)}return 70*(c+u+h)}}t.default=c},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GameItems=void 0;const i=a(n(1)),l=o(n(677));class c extends i.Component{render(){const e=this.props.inv,t=this.props.filter,n=[],s=this.props.setSelectedItem;let r=0;e.getWeight&&(r=e.getWeight()+this.props.eqWeight);const a=r.toFixed(2),o=this.props.maxWeight;let c=null;c=e.first?e.first():e;let u=0;if(e.next)for(;null!=c;)"All"!==t&&c.getType()!==t||n.push(i.createElement(l.default,{item:c,key:u,setSelectedItem:s})),c=e.next(),++u;else e.forEach(e=>{"All"!==t&&e.getType()!==t||n.push(i.createElement(l.default,{item:e,key:u,setSelectedItem:s})),++u});return i.createElement("div",null,this.props.maxWeight>=0&&i.createElement("p",null,"Items: ",a," kg (max ",o," kg)"),-1===this.props.maxWeight&&i.createElement("p",null,this.props.textToShow),n)}}t.GameItems=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.canUseDOM=void 0;var s,r=n(689);var a=((s=r)&&s.__esModule?s:{default:s}).default,o=a.canUseDOM?window.HTMLElement:{};t.canUseDOM=a.canUseDOM;t.default=o},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryBattle=void 0;const i=n(60),l=o(n(4)),c=n(45),u=n(226),h=n(9),d=n(28),p=n(12),f=a(n(27)),m=a(n(11)),g=a(n(114)),y=a(n(16)),v=n(159),b=n(13),_=y.ElementStairs,E=h.Random.getRNG(),S=["avianfolk","human","dwarf","dogfolk","wolfclan","goblin","catfolk","bearfolk","wildling","undead"];t.FactoryBattle=class{constructor(){this.minCommDanger=5}createBattle(e,t={}){const n=t.cols||80,s=t.rows||40,r=e?e.getID():0,a=t.name||"Battle of level "+r;let o=this.createBattleLevel(n,s,t);if(e){const n=new _("battle",e),s=e.getMap();if(t.bbox){const{bbox:r}=t;let a=E.getRandInBbox(r),i=s.getCell(a[0],a[1]),c=l.default.WATCHDOG;for(;i.hasProps()&&(a=E.getRandInBbox(r),i=s.getCell(a[0],a[1]),0!=--c););e.addStairs(n,a[0],a[1]);const u=b.Geometry.getCellsAround(s,i);o=(new v.LevelSurroundings).surround(o,{cellsAround:u})}else e.addStairs(n,4,4);c.World.addExitsToEdge(o),c.World.connectAreaConnToLevel(n,o,e)}const i=new u.Battle(a);i.setLevel(o);const[h,d]=this.getFactions(t);let p=t.numRows||2;const f=t.armySize||20,m=t.numArmies||2,g=t.armies||[h,d];let y=Math.ceil(f/p);for(;y>n;)++p,y=Math.ceil(f/p);const S=[];for(let e=0;e<m;e++){const r=this.createArmy(i,g[e],t);let a=E.getUniformInt(0,n-1),o=E.getUniformInt(0,s-1);a+y>n-1&&(a=n-y),o+p>s-1&&(o=s-1-p),t.centerX&&(a=Math.floor(n/2),a-=Math.floor(f/p/2)),t.centerY&&(o=Math.floor(s/2),o-=e*(p+2)),(a>n-1||a<0)&&l.default.err("FactoryBattle","createBattle",`armyX ${a} out of bounds 0-${n-1}`),(o>s-1||o<0)&&l.default.err("FactoryBattle","createBattle",`armyY ${o} out of bounds 0-${s-1}`);const c={horizontal:!0,numRows:p};i.addArmy(r,a,o,c),S.push(r)}return this.makeArmiesAsEnemies(S),i}getFactions(e){let t=null,n=null;if(e.factions)[t,n]=e.factions;else for(t=E.arrayGetRand(S),n=E.arrayGetRand(S);t===n;)n=E.arrayGetRand(S);return[t,n]}createArmy(e,t,n){const s=p.ObjectShell.getParser(),r=n.armySize||20,a=n.danger||5,o=new u.Army(t),c=o.getID();o.addAlignment(t,1);const h=[{op:"eq",prop:"type",value:t},{op:"lte",prop:"danger",value:a}],d=(new i.Constraints).getConstraints(h);for(let t=0;t<r-1;t++){const t=s.createRandomActor({func:d});if(t){const n=new m.InBattle;n.setData({name:e.getName(),army:o.getName()}),t.add(n),t.has("Groups")||t.add(new m.Groups),t.get("Groups").addGroup(c),o.addActor(t)}}const f=s.createRandomActor({func:e=>e.type===t&&e.danger>=this.minCommDanger});if(f){this.addCommanderAbilities(f);const t=new m.InBattle;t.setData({name:e.getName(),army:o.getName()}),f.add(t),o.addActor(f)}else l.default.warn("FactoryBattle","createArmy","No commander for army generated");return o.setDefeatThreshold(Math.round(.1*r)),o}makeArmiesAsEnemies(e){e.forEach(t=>{e.forEach(e=>{if(t.getID()!==e.getID()){const n=e.getID();t.getActors().forEach(e=>{e.getBrain().getMemory().addEnemyGroup(n)})}}),t.getActors().forEach(e=>{e.getBrain().getMemory().addFriendGroup(t.getID())})})}createBattleLevel(e,t,n){const s=n.levelType||"forest",r=l.default.getForestConf(e,t);return d.FactoryLevel.createLevel(s,e,t,r)}addCommanderAbilities(e){const t=new f.BrainGoalOriented(e),n=new g.ThinkCommander(e);e.setBrain(t),t.setGoal(n),e.add(new m.Commander),e.setFOVRange(10)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Cell=void 0;const r=s(n(4)),a=n(18),{TYPE_ACTOR:o,TYPE_ITEM:i,TYPE_ELEM:l}=r.default,c=4294901760;t.Cell=class{constructor(e,t,n){this._baseElem=n,this._xy=65535&e|t<<16&c,this._state=0,this.setStateBit(1,n.lightPasses()),this.setStateBit(2,n.isPassable())}getNumActors(){const e=this.getActors();return e?e.length:0}hasActor(e){const t=this.getActors();if(t)for(let n=0;n<t.length;n++)if(t[n].getName()===e)return!0;return!1}getActor(e){const t=this.getActors();if(t)for(let n=0;n<t.length;n++)if(t[n].getName()===e)return t[n];return null}getX(){return 65535&this._xy}getY(){return(this._xy&c)>>>16}getXY(){return[65535&this._xy,(this._xy&c)>>>16]}setX(e){this._xy=65535&e}setY(e){this._xy=e<<16&c}getCell(){return this}getZ(){return this._baseElem.getZ()}getXYZ(){return[this.getX(),this.getY(),this._baseElem.getZ()]}setXY(e){this._xy=65535&e[0]|e[1]<<16&c}isAtXY(e,t){return e===this.getX()&&t===this.getY()}getKeyXY(){return this.getX()+","+this.getY()}setBaseElem(e){this._baseElem=e,this.setStateBit(1,e.lightPasses()),this.setStateBit(2,e.isPassable())}getBaseElem(){return this._baseElem}hasProp(e){return!!this._p&&this._p.hasOwnProperty(e)}getProp(e){return this._p&&this._p[e]?this._p[e]:null}hasElements(){return this.hasProp(l)}getElements(){return this.getProp(l)}hasActors(){return this.hasProp(o)}getActors(){return this.getProp(o)}getFirstActor(){const e=this.getProp(o);return e&&e.length>0?e[0]:null}getSentientActors(){const e=this.getActors();return e?e.filter(e=>!e.has("NonSentient")):[]}hasItems(){return this.hasProp(i)}getItems(){return this.getProp(i)}getMarkers(){const e=this.getElements(),t=[];if(e)for(let n=0;n<e.length;n++)"marker"===e[n].getType()&&t.push(e[n]);return t}isAdjacent(e){return r.default.withinRange(1,this,e)}hasMarker(e){if(this.hasElements()){const t=this.getElements();for(let n=0;n<t.length;n++)if("marker"===t[n].getType()&&t[n].getTag()===e)return!0}return!1}hasProps(){return!!this._p&&Object.keys(this._p).length>0}getProps(){let e=[];return this._p?(Object.keys(this._p).forEach(t=>{e=e.concat(this._p[t].slice())}),e):e}hasStairs(){const e=this.getConnection();if(e){const t=e.getName();return/stairs(Up|Down)/.test(t)}return!1}hasPassage(){const e=this.getConnection();return!!e&&"passage"===e.getName()}hasShop(){return this.hasPropType("shop")}getShop(){return this.getPropType("shop")[0]}hasDoor(){return this.hasPropType("door")}hasClosedDoor(){if(this.hasDoor()){return this.getPropType("door")[0].isClosed()}return!1}hasConnection(){return this.hasPropType("connection")}hasHouse(){return"floorhouse"===this._baseElem.getType()}hasConnectionType(e){if(this.hasConnection()){return this.getConnection().getName()===e}return!1}hasTown(){return this.hasConnectionType("town")}hasBattle(){return this.hasConnectionType("battle")}hasMountain(){return this.hasConnectionType("mountain")}getStairs(){return this.hasStairs()?this.getConnection():null}getConnection(){if(this.hasPropType("connection")){return this.getPropType("connection")[0]}return null}getPassage(){return this.hasPassage()?this.getConnection():null}lightPasses(){if(!this.getBit(1))return!1;if(!this._p)return!0;const e=this._p.elements;if(e)if(1===e.length){if(e[0].has("Opaque"))return!1}else for(let t=0;t<e.length;t++)if(e[t].has("Opaque"))return!1;return!0}isPassable(){return this.isFree()}isPassableByAir(e=10){return e>=this._baseElem.getZ()&&this._baseElem.isPassableByAir()}isDangerous(){if(this._p&&this._p.actors){const e=this.getProp(o);if(e)return e[0].has("Damaging")}return!1}hasObstacle(){return this._baseElem.isObstacle()}isSpellPassable(){return this._baseElem.isSpellPassable()}setExplored(){this.setStateBit(0,!0)}isExplored(){return this.getBit(0)}isFree(e=!1){if(!e&&!this.getBit(2))return!1;if(this.hasProp(o)){for(let e=0;e<this._p.actors.length;e++)if(!this._p.actors[e].has("Ethereal"))return!1;return!0}if(this.hasProp(l)){if(this.hasPropType("door")){return this.getDoor().isOpen()}if(this.hasPropType("leverdoor")){return this.getLeverDoor().isOpen()}if(this.hasElemWith("Impassable"))return!1}return!e||this._baseElem.isPassableByAir()}getDoor(){if(this.hasPropType("door")){return this.getPropType("door")[0]}return null}getLeverDoor(){if(this.hasPropType("leverdoor")){return this.getPropType("leverdoor")[0]}return null}setProp(e,t){if("connection"===t.getType()&&this.hasConnection()){let e=`${this.getX()},${this.getY()}`;e+="\nExisting: "+JSON.stringify(this.getConnection()),e+="\nTried to add: "+JSON.stringify(t),r.default.err("Cell","setProp","Tried to add 2nd connection: "+e)}this._p||(this._p={}),this._p.hasOwnProperty(e)?e===o?t.has("NonSentient")||t.has("Ethereal")?this._p[e].push(t):this._p[e].unshift(t):this._p[e].push(t):(this._p[e]=[],this._p[e].push(t)),t.has("Item")&&t.setOwner(r.default.NO_OWNER)}removeProps(e){delete this._p[e]}removeProp(e,t){if(this.hasProp(e)){const n=this._p[e].indexOf(t);return-1!==n&&(this._p[e].splice(n,1),0===this._p[e].length&&(delete this._p[e],0===Object.keys(this._p).length&&(this._p=void 0)),!0)}return!1}toString(){let e="Map.Cell "+this.getX()+", "+this.getY();return e+=" explored: "+this.isExplored(),e+=" passes light: "+this.lightPasses(),this._p?(Object.keys(this._p).forEach(t=>{const n=this._p[t];for(let t=0;t<n.length;t++)n[t].hasOwnProperty("toString")?e+=n[t].toString():n[t].hasOwnProperty("toJSON")&&(e+=JSON.stringify(n[t].toJSON()))}),e):e}hasUsable(){const e=this.getProp(r.default.TYPE_ELEM);if(e)for(let t=0;t<e.length;t++)if(e[t].onUse)return!0;return!1}toJSON(){const e={t:a.ELEM_MAP.elemTypeToIndex[this._baseElem.getType()]};return this.getBit(0)&&(e.ex=1),e}getPropNames(){const e=[this._baseElem.getType()];if(!this._p)return e;return Object.keys(this._p).forEach(t=>{this.getProp(t).forEach(t=>{e.push(t.getName())})}),e}hasPropType(e){if(this._baseElem.getType()===e)return!0;if(!this._p)return!1;const t=Object.keys(this._p);for(let n=0;n<t.length;n++){const s=t[n],r=this._p[s];for(let t=0;t<r.length;t++)if(r[t].getType()===e)return!0}return!1}getPropType(e){const t=[];return this._p?this._baseElem.getType()===e?[this._baseElem]:(Object.keys(this._p).forEach(n=>{const s=this._p[n];for(let n=0;n<s.length;n++)s[n].getType()===e&&t.push(s[n])}),t):t}findObj(e){const t=[];return this._p?(Object.keys(this._p).forEach(n=>{this._p[n].forEach(n=>{e(n)&&t.push(n)})}),t):t}isOutdoors(){return!this._baseElem.has("Indoor")}hasBaseElemWithComp(e){return this._baseElem.has(e)}hasElemWith(e){const t=this.getElements();for(let n=0,s=t.length;n<s;n++)if(t[n].has(e))return!0;return!1}getBit(e){return!!(this._state&1<<e)}setStateBit(e,t){t?this._state=1<<e|this._state:this._state&=~(1<<e)}toggleBit(e){this._state^=1<<e}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ItemGen=void 0;const r=s(n(4)),a=n(73),o=n(9),i=n(73),l=o.Random.getRNG();t.ItemGen={};const c={};t.ItemGen.shellProps=c;const u={};u.weaponTypes=Object.keys({melee:["dagger","sword","staff","whip","axe","mace","saber","spear","morningstar","battle axe","warhammer","pick-axe","hammer","katana","falchion","scimitar","war scythe"],missileweapon:["sling","short bow","warbow","crossbow","musket","rifle"],ammo:["arrow","bolt","bullet"],missile:["rock","dart","throwing axe","throwing dagger","throwing knife","throwing spear","shuriken"]}),t.ItemGen.names=u;const h={weapon:{heavy:{weight:1.5,value:1.2,damage:"2d3 + 4",rarity:1.5},light:{weight:.6,value:1.2,rarity:2},poisoned:{value:3,rarity:3,onAttackHit:[a.meleeHitDamage(2,"1d4 + 1","POISON")],colorfg:"Green"},sharp:{damage:"4",value:1.1,rarity:1.5},balanced:{attack:6,damage:"2",value:1.2,rarity:1.5},serrated:{value:2,rarity:2,onAttackHit:[a.meleeHitDamage(1,"1d4 + 2","PIERCE")]},icy:{value:2.5,rarity:2.5,onAttackHit:[a.meleeHitDamage(1,"1d6 + 4","ICE")]},flaming:{value:2.5,rarity:2.5,onAttackHit:[a.meleeHitDamage(1,"1d6 + 4","FIRE")]}},missileweapon:{},ammo:{},missile:{}};h.ammo=Object.assign(h.ammo,h.weapon),h.missile=Object.assign(h.missile,h.weapon),h.armour={light:h.weapon.light,heavy:{weight:1.5,value:1.2,protection:2,rarity:1.5},plated:{weight:1.2,value:1.3,protection:3,rarity:1.3},spiked:{weight:1.2,value:1.4,protection:1,attack:3,rarity:2},flexible:{weight:.9,value:1.4,protection:2,attack:2,rarity:2}},t.ItemGen.prefix=h,u.prefix={weapon:Object.keys(h.weapon),armour:Object.keys(h.armour),missileweapon:Object.keys(h.missileweapon),missile:Object.keys(h.missile),ammo:Object.keys(h.ammo)};const d={weapon:{ofAccuracy:{name:"of Accuracy",accuracy:5,rarity:2.5,value:2.5},ofAgility:{name:"of Agility",agility:5,rarity:2.5,value:2.5},ofDefense:{name:"of Defense",defense:5,rarity:3,value:3},ofFire:{name:"of Fire",onAttackHit:[a.meleeHitDamage(2,"1d6 + 1","FIRE")],rarity:3,value:3},ofMight:{name:"of Might",strength:4,rarity:3,value:3},ofNecropotence:{name:"of Necropotence",onAttackHit:[{transientComp:"DrainStat",func:[{setter:"setDrainAmount",value:1},{setter:"setSourceComp",value:"Health"},{setter:"setSourceGetter",value:"getHP"},{setter:"setSourceSetter",value:"setHP"},{setter:"setTargetComp",value:"SpellPower"},{setter:"setTargetGetter",value:"getPP"},{setter:"setTargetSetter",value:"setPP"},{setter:"setDrainMsg",value:"drains life from"}]}],onEquip:[a.directDamage(1,"1d1 + 3","NECRO",1,"You feel slightly easier"),{addComp:"DirectDamage",func:[{setter:"setDamage",value:1},{setter:"setDamageType",value:r.default.DMG.NECRO},{setter:"setDamageCateg",value:r.default.DMG.DIRECT},{setter:"setProb",value:.05},{setter:"setMsg",value:"Necropotence demands blood!"}]}],rarity:4,value:4},ofFrost:{name:"of Frost",onAttackHit:[a.meleeHitDamage(2,"1d6 + 1","ICE")],rarity:3,value:3},ofSerpent:{name:"of Serpent",addComp:[a.resistance("POISON","MEDIUM")],rarity:2,value:2},ofHoly:{name:"of Holy",addComp:[a.resistance("NECRO","MEDIUM")],rarity:2,value:2},ofMagic:{name:"of Magic",magic:5,rarity:2.5,value:2.5},ofPerception:{name:"of Perception",perception:5,rarity:3,value:3},ofProtection:{name:"of Protection",protection:5,rarity:3,value:3},ofSpeed:{name:"of Speed",speed:10,rarity:3,value:3},ofVoid:{name:"of Void",onAttackHit:[a.meleeHitDamage(2,"1d8 + 1","VOID")],rarity:4,value:4},ofSpirit:{name:"of Spirit",spirituality:6,rarity:3,value:3},ofWillpower:{name:"of Willpower",willpower:6,rarity:3,value:3}}};d.armour={ofAccuracy:d.weapon.ofAccuracy,ofAgility:d.weapon.ofAgility,ofDefense:d.weapon.ofProtection,ofMagic:d.weapon.ofMagic,ofMight:d.weapon.ofMight,ofPerception:d.weapon.ofPerception,ofProtection:d.weapon.ofProtection,ofSpeed:d.weapon.ofSpeed,ofSerpent:d.weapon.ofSerpent,ofHoly:d.weapon.ofHoly,ofLevitation:{onEquip:[{addComp:"Flying"}],rarity:5,value:5},ofNecropotence:{rarity:4,value:4,onEquip:[{addComp:"Regeneration",func:[{setter:"setHP",value:0},{setter:"setMaxWaitPP",value:25},{setter:"setPP",value:2}]},{addComp:"DirectDamage",func:[{setter:"setDamage",value:1},{setter:"setDamageType",value:r.default.DMG.NECRO},{setter:"setDamageCateg",value:r.default.DMG.DIRECT},{setter:"setProb",value:.05},{setter:"setMsg",value:"Necropotence demands blood!"}]}]},ofSpirituality:d.weapon.ofSpirit,ofWillpower:d.weapon.ofWillpower},d.missile={ofParalysis:{name:"of paralysis",rarity:3,value:2,onAttackHit:[{addComp:"Paralysis",duration:"1"}]},ofStunning:{name:"of stunning",rarity:3,value:2,onAttackHit:[{addComp:"Stun",duration:"1"}]},ofSlowness:{name:"of slowness",rarity:3,value:3,onAttackHit:[{addComp:"StatsMods",func:[{setter:"setSpeed",value:-10}],duration:"3d10"}]}},d.missileweapon={},d.ammo=d.missile,t.ItemGen.suffix=d,u.suffix={weapon:Object.keys(d.weapon),armour:Object.keys(d.armour),missileweapon:Object.keys(d.missileweapon),missile:Object.keys(d.missile),ammo:Object.keys(d.ammo)};const p={weapon:{type:"weapon",range:1,value:1,attack:0,defense:0,char:"(",speed:0,strength:0,accuracy:0,agility:0,willpower:0,perception:0,magic:0,spirituality:0},armour:{type:"armour",value:1,attack:0,defense:0,protection:0,char:"[",speed:0,strength:0,accuracy:0,agility:0,willpower:0,perception:0,magic:0,spirituality:0},missile:{type:"missile",value:1,attack:0,defense:0,char:"/"},missileweapon:{type:"missileweapon",value:1,attack:0,defense:0,char:"{",fireRate:1},ammo:{type:"ammo",value:1,attack:0,defense:0,char:"/"}};c.weapon={dagger:{damage:"1d6",attack:1,weight:.2,rarity:1,value:10,weaponType:"dagger"},sword:{damage:"1d8 + 2",attack:2,defense:1,weight:.8,rarity:2,value:20,weaponType:"sword"},spear:{damage:"1d9 + 1",attack:1,defense:3,weight:1,rarity:3,value:25,weaponType:"spear"},mace:{damage:"1d10",attack:2,weight:1.3,rarity:3,value:25,weaponType:"mace"},axe:{damage:"2d6",attack:2,weight:1.1,rarity:3,value:35,weaponType:"axe"},warhammer:{damage:"1d10",attack:2,weight:1.1,rarity:2,value:30,weaponType:"hammer"},staff:{damage:"1d8",attack:2,defense:2,weight:.9,rarity:4,value:30},"war scythe":{damage:"1d10+2",attack:4,weight:1.5,rarity:4,value:50,weaponType:"polearm",damageType:r.default.DMG.SLASH},halberd:{damage:"1d12+3",attack:5,weight:1.9,rarity:5,value:55,weaponType:"polearm",damageType:r.default.DMG.SLASH}},u.weapon=Object.keys(c.weapon),c.armour={robe:{armourType:"chest",weight:1,protection:0,defense:0,value:15},cuirass:{armourType:"chest",weight:2,protection:4,defense:-1,attack:-1,value:40,no:{material:["wooden"]}},mail:{armourType:"chest",weight:1.7,protection:3,defense:1,attack:0,value:30,no:{material:["leather","wooden"]}},brigandine:{armourType:"chest",weight:1.5,protection:5,defense:1,attack:0,value:50,no:{material:["leather","wooden"]}},"full plate":{armourType:"chest",weight:2.5,protection:8,defense:0,attack:-2,value:80,no:{material:["leather","wooden","cloth"]}},cloak:{armourType:"cloak",weight:.2,protection:0,defense:0,attack:0,value:15,only:{material:["cloth","leather"]}},boots:{armourType:"feet",weight:.5,protection:1,defense:0,attack:0,value:15,no:{material:"wooden"}},greaves:{armourType:"legs",weight:1,protection:2,defense:0,attack:1,value:20,no:{material:"wooden"}},helmet:{armourType:"head",weight:.3,protection:1,defense:0,attack:0,value:15},collar:{armourType:"neck",weight:.2,protection:1,defense:0,attack:0,value:15,no:{material:"wooden"}},shield:{armourType:"shield",weight:.8,protection:2,defense:1,attack:0,value:15,no:{material:["cloth","leather"]}},buckler:{armourType:"shield",weight:.4,protection:0,defense:3,attack:1,value:20,no:{material:["cloth","leather"]}}},u.armour=Object.keys(c.armour),c.missile={shuriken:{char:"*",damage:"1d6",range:3,value:10,weaponType:"shuriken",weight:.1},dart:{char:"/",damage:"1d6 + 1",range:3,value:13,weaponType:"dart",weight:.1},"throwing knife":{char:"/",damage:"1d6",range:3,weight:.2,value:13,attack:1,weaponType:"dagger"},"throwing spear":{attack:2,damage:"1d7 + 1",range:3,value:30,weight:.4,weaponType:"spear"},"throwing axe":{attack:2,damage:"1d8 + 1",range:3,value:35,weight:.3}},u.missile=Object.keys(c.missile),c.missileweapon={sling:{weaponType:"sling",value:15,damage:"1d4",range:3,weight:.3},"short bow":{weaponType:"bow",value:25,damage:"1d6",range:4,weight:.6},warbow:{weaponType:"bow",value:35,damage:"1d9",range:6,weight:.9},"light crossbow":{weaponType:"crossbow",value:30,damage:"1d8",range:5,weight:1},crossbow:{weaponType:"crossbow",value:40,damage:"2d6",range:6,weight:1.5},musket:{weaponType:"rifle",value:50,damage:"2d6",range:6,no:{material:["wooden"]},weight:2.5},rifle:{weaponType:"rifle",value:75,damage:"3d6",range:7,no:{material:["wooden"]},weight:3.5}},u.missileweapon=Object.keys(c.missileweapon),c.ammo={arrow:{ammoType:"bow",damage:"1d6",value:5,range:1,weight:.1},bolt:{ammoType:"crossbow",damage:"1d8",value:8,range:1,weight:.1},bullet:{ammoType:"rifle",damage:"1d8",value:15,no:{material:["wooden"]},range:1,weight:.1}},u.ammo=Object.keys(c.ammo),c.material={cloth:{weight:.5,value:.5,rarity:1,armour:{onEquip:[a.resistance("BLUNT","MEDIUM")]}},leather:{weight:1,value:1,rarity:1,armour:{protection:1}},wooden:{weight:1,value:1,rarity:1},iron:{weight:1.7,value:1.2,rarity:1,weapon:{damage:"1d2 + 1"},armour:{protection:"* 1.3",attack:-1}},steel:{weight:1.5,value:1.4,rarity:1.5,weapon:{damage:"1d4 + 2"},armour:{protection:"* 1.5",attack:-1}},mithril:{className:"cell-item-mithril",weight:.75,value:3,rarity:2.3,weapon:{damage:"2d3 + 3"},armour:{protection:"* 1.7",attack:-1}},adamantium:{className:"cell-item-adamantium",weight:1,value:4,rarity:2.7,weapon:{damage:"3d3 + 4"},armour:{protection:"* 2.0",attack:0}},rubyglass:{className:"cell-item-ruby-glass",weight:.5,value:5,rarity:3,weapon:{damage:"2d4 + 3"},armour:{protection:"* 2.2",defense:2}},permaice:{className:"cell-item-ice",weight:3,value:8,rarity:4,weapon:{damage:"3d4 + 6"},armour:{protection:"* 3.0",defense:-2,attack:-2}},forium:{className:"cell-item-magic",weight:1.2,value:7,rarity:5,weapon:{damage:"2d4 + 4"},armour:{protection:"* 2.2",defense:1}},netherium:{className:"cell-item-nether",weight:2,value:7,rarity:5,weapon:{damage:"2d4 + 2",attack:5},armour:{protection:"* 2.2",defense:-1,attack:-1}},void:{className:"cell-item-void",weight:1.4,value:10,rarity:8,weapon:{damage:"2d6 + 6",onAttackHit:[a.meleeHitDamage(2,"1d6 + 1","VOID")]},armour:{protection:"* 2.0",addComp:[a.resistance("VOID","MEDIUM")]}}},v(c.material,"weapon","missileweapon"),v(c.material,"weapon","missile"),v(c.material,"weapon","ammo"),u.materials=Object.keys(c.material);const f={weapon:u.materials.filter(e=>!/(wooden|leather|cloth)/.test(e)),armour:u.materials.slice(),missileweapon:u.materials.filter(e=>!/(leather|cloth)/.test(e)),missile:u.materials.filter(e=>!/(leather|cloth)/.test(e)),ammo:u.materials.filter(e=>!/(leather|cloth)/.test(e))},m=["armour","weapon","ammo","missile","missileweapon"];function g(e,t,n){let s=e;return s=n.name?n.name+" "+e:t+" "+e,s}function y(e,t,n){let s=e;return s=n.name?e+" "+n.name:e+" "+t,s}function v(e,t,n){Object.keys(e).forEach(s=>{const r=e[s];r[t]&&(r[n]=r[t])})}t.ItemGen.genRandShell=function(e){const t=r.default.isSuccess(r.default.ITEM_PREFIX_CHANCE),n=r.default.isSuccess(r.default.ITEM_SUFFIX_CHANCE);let s="",a="";const o=f[e],m=l.arrayGetRand(o),v=c.material[m];let b=null;v[e]&&(b=v[e]);const _=function(e,t,n){return n.filter(n=>{const s=c[e][n];if(s.no){const e=s.no;if(e.material===t)return!1;if(e.material.indexOf(t)>=0)return!1}if(s.only){const e=s.only;if(Array.isArray(e.material)){if(e.material.indexOf(t)<0)return!1}else if(e.material!==t)return!1}return!0})}(e,m,u[e]),E=l.arrayGetRand(_),S=c[e][E],w=[p[e],S,v];b&&w.push(b);let C=m+" "+E;if(t&&u.prefix[e].length>0){s=l.arrayGetRand(u.prefix[e]);const t=h[e][s];w.push(t),C=g(C,s,t)}if(n&&u.suffix[e].length>0){a=l.arrayGetRand(u.suffix[e]);const t=d[e][a];w.push(t),C=y(C,a,t)}const O=i.mixNewShell(w);return O.name=C,O},t.ItemGen.buildShell=function(e){const{type:t}=e;t||r.default.err("ItemGen","buildShell","No type was given");const n=p[t],s=c.material[e.material];let a=null;s[t]&&(a=s[t]);const o=h[t][e.prefix],l=d[t][e.suffix],u=[n,s,c[t][e.name]];a&&u.push(a);let f=e.material+" "+e.name;o&&(u.push(o),f=g(f,e.prefix,o)),l&&(u.push(l),f=y(f,e.suffix,l));const m=i.mixNewShell(u);return m.name=f,m},t.ItemGen.genItems=function(e){const n=[];for(let s=0;s<e;s++){const e=l.arrayGetRand(m);n.push(t.ItemGen.genRandShell(e))}return n},t.ItemGen.genRandShellWith=function(e){let n=100,s=null;for(;n>=0;){const r=l.arrayGetRand(m);if(--n,s=t.ItemGen.genRandShell(r),e(s))break}return s}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NestGenerator=void 0;const r=s(n(4)),a=n(62),o=s(n(15)),i=n(63),l=n(24),c=n(48),u=n(13),h=n(9),d=n(18),p=n(138),f=n(12),m=n(38),g=n(224),y=h.Random.getRNG(),v=o.default("bitn:nest");class b extends a.LevelGenerator{constructor(){super(),this._debug=v.enabled||!0,this.squaresPerActor=9}static getOptions(){const e=a.LevelGenerator.getOptions();return e.actorConstr={race:"orc"},e.mapConf={tilesX:3,tilesY:3,genParams:{x:[1,1,1],y:[1,1,1]},wallType:"wall",floorType:"floor"},e}dbg(...e){this._debug&&v(...e)}create(e,t,n){const s=(new i.MapGenerator).createNest(e,t,n.mapConf),r=new l.Level(s.map);return r.updateLevelFromMap(),r}createAndEmbed(e,t,n){n.embedOpts&&n.embedOpts.level||r.default.err("NestGenerator","createAndEmbed","No level in conf.embedOpts. Got: "+JSON.stringify(n));const s=this.create(e,t,n);return n.removeBorderWall&&this.removeBorderWall(s,n),this.embedIntoLevel(s,n)}embedIntoLevel(e,t){if(!t.embedOpts)return r.default.err("NestGenerator","embedIntoLevel","conf.embedOpts must exist. Got: "+JSON.stringify(t)),!1;t.maxDanger||(t.maxDanger=5);const n=t.embedOpts.level,s=n.getMap(),a=e=>!e.isFree(),[o,i]=e.getSizeXY();let l=null;if(t.embedOpts.bbox)l=t.embedOpts.bbox;else{const e=1;let n=c.Placer.findCellArea(s,o,i,a,e);if(0===n.length){if(t.embedOpts.alwaysEmbed){const t=e=>!0;n=c.Placer.findCellArea(s,o,i,t,e)}if(0===n.length)return!1}l=y.arrayGetRand(n)}if(l.getArea()>0){u.Geometry.mergeLevels(n,e,l.ulx,l.uly);const s=this.connectNestToParentLevel(n,l,t);if(s.length>0)return this.addElemsToNestArea(n,l,t),this.populateNestArea(n,l,t),this.addLootToNestArea(n,l,t),this.populateTunnel(n,t,s),!0;r.default.warn("NestGenerator","embedIntoLevel","Nest was merged into parent, but no connection was done")}return!1}connectNestToParentLevel(e,t,n){if(n.scanForDoors){const s=this.scanAndConnect(e,t,n);if(s.length>0)return s}const s=e.getMap();let r="";const[a,o]=e.getSizeXY();t.uly<o/2?r+="S":t.uly>=o/2&&(r+="N"),t.ulx<a/2?r+="E":t.ulx>=a/2&&(r+="W");const i=r.split("");for(i.push(r);i.length>0;){const e=y.arrayGetRand(i);i.splice(i.indexOf(e),1);let r=[],a=[],o=0;const l=5;for(;0===r.length&&(a=t.getBorderXY(e,o++),r=s.getCellsWithCoord(a),r=r.filter(e=>e.isFree()),!(o>l)););if(r.length>0){let t=[];if(this.dbg("Tunneling to",e,"using",t),this.getCoordForTunnel(r,s,e,t)){t=t.filter(e=>{const[t,n]=e;return!(t<1||n<1)&&!(t>=s.cols-1||n>=s.rows-1)});let e=d.ELEM.FLOOR;return n.mapConf.floorType&&(e=d.getElem(n.mapConf.floorType)),s.setBaseElems(t,e),t}}}return[]}getCoordForTunnel(e,t,n,s){let a=null;const o=e;if(!(o.length>0))return!1;if(a=y.arrayGetRand(o),o.splice(o.indexOf(a),1),!a.isFree())return!1;{let[e,i]=a.getXY();const l=r.default.dirTodXdY(n);if(l){if([e,i]=r.default.newXYFromDir(l,[e,i]),!t.hasXY(e,i))return!1;a=t.getCell(e,i),s.push([e,i]);let n=0;for(;!a.isFree();){if([e,i]=r.default.newXYFromDir(l,[e,i]),t.hasXY(e,i)){a=t.getCell(e,i),s.push([e,i]);let n=u.Geometry.getCrossCaveConn(e,i,1);n=n.map(e=>y.shiftCoord(e)),s.push(...n)}else if(s.length=0,o.length>0){a=y.arrayGetRand(o),o.splice(o.indexOf(a),1),[e,i]=a.getXY(),[e,i]=r.default.newXYFromDir(l,[e,i]),a=t.getCell(e,i),s.push([e,i]),n=0;let c=u.Geometry.getCrossCaveConn(e,i,1);c=c.map(e=>y.shiftCoord(e)),s.push(...c)}if(250==++n)return!1}}else r.default.err("NestGenerator","connectNestToParentLevel",`No dXdY for dir ${n} found`)}return!0}addElemsToNestArea(e,t,n){a.LevelGenerator.markersToDoor(e)}populateNestArea(e,t,n){const{actorConstr:s}=n;if(s){const n=t.getArea(),r=this.getActorsForNest(s,n);c.Placer.addActorsToBbox(e,t,r)&&r.forEach(e=>{const n=new m.EvaluatorGuardArea(.7,t);e.getBrain().getGoal().addEvaluator(n)})}}getActorsForNest(e,t){const n=[],s=[],a=f.ObjectShell.getParser(),o=y.getUniformInt(3,8);let i=0;const l=Math.round(t/this.squaresPerActor);for(let t=0;t<o;t++){let t=p.ActorGen.genShell(e),n=35;for(;t.danger>e.maxDanger+2;)if(t=p.ActorGen.genShell(e),--n,0===n){t=null;break}t?s.push(t):r.default.warn("NestGenerator","getActorsForNest","Failed to create shell with "+JSON.stringify(e))}for(;i<l;){const e=y.arrayGetRand(s);n.push(a.createFromShell(r.default.TYPE_ACTOR,e)),++i}return n}addLootToNestArea(e,t,n){let{maxValue:s}=n;s||(s=100),s*=1.5;const o=f.ObjectShell.getParser(),i=a.LevelGenerator.removeOneMarkerType(e,"?","nest_loot"),l=e=>e.value<=s&&e.value>=.5*s;i.forEach(t=>{const n=o.createRandomItem(l);e.addItem(n,t[0],t[1])});const c=g.ItemGen.genItems(1)[0],u=o.createFromShell(r.default.TYPE_ITEM,c);if(u){const[t,n]=y.arrayGetRand(i);e.addItem(u,t,n)}}removeBorderWall(e,t){const{cols:n,rows:s}=e.getMap();let r=d.ELEM.FLOOR;t.borderElem&&(r=t.borderElem),t.mapConf.floorType&&(r=d.getElem(t.mapConf.floorType));for(let t=0;t<n;++t)e.getMap().setBaseElemXY(t,0,r);for(let t=0;t<s;++t)e.getMap().setBaseElemXY(0,t,r);for(let t=0;t<n;++t)e.getMap().setBaseElemXY(t,s-1,r);for(let t=0;t<s;++t)e.getMap().setBaseElemXY(n-1,t,r)}scanAndConnect(e,t,n){const s=[];for(let a=t.uly;a<=t.lry;a++){const o=t.lrx,i=e.getMap(),l=u.Geometry.getCrossAround(o,a,1,!0),c=u.Geometry.coordToDirMap([o,a],l);if(c.E){const[t,l]=c.E[0],u=i.getCell(t,l);if(u&&u.isFree()){const t=this.tunnelUntilFloor(e,o,a,r.default.DIR_XY.W,n);s.push(...t)}}}for(let a=t.uly;a<=t.lry;a++){const o=t.ulx,i=e.getMap(),l=u.Geometry.getCrossAround(o,a,1,!0),c=u.Geometry.coordToDirMap([o,a],l);if(c.W){const[t,l]=c.W[0],u=i.getCell(t,l);if(u&&u.isFree()){console.log("scanAndConnect free west cell at",t,l);const i=this.tunnelUntilFloor(e,o,a,r.default.DIR_XY.E,n);s.push(...i)}}}for(let a=t.ulx;a<=t.lrx;a++){const o=t.lry,i=e.getMap(),l=u.Geometry.getCrossAround(a,o,1,!0),c=u.Geometry.coordToDirMap([a,o],l);if(c.S){const[t,l]=c.S[0],u=i.getCell(t,l);if(u&&u.isFree()){console.log("scanAndConnect south cell at",t,l);const i=this.tunnelUntilFloor(e,a,o,r.default.DIR_XY.N,n);s.push(...i)}}}for(let a=t.ulx;a<=t.lrx;a++){const o=t.uly,i=e.getMap(),l=u.Geometry.getCrossAround(a,o,1,!0),c=u.Geometry.coordToDirMap([a,o],l);if(c.N){const[t,l]=c.N[0],u=i.getCell(t,l);if(u&&u.isFree()){console.log("scanAndConnect north cell at",t,l);const i=this.tunnelUntilFloor(e,a,o,r.default.DIR_XY.S,n);s.push(...i)}}}return s}tunnelUntilFloor(e,t,n,s,r){const[a,o]=s,i=[];let l=!1;const c=e.getMap();let u=0,h=d.ELEM.FLOOR;r.mapConf.floorType&&(h=d.getElem(r.mapConf.floorType)),c.setBaseElems([[t,n]],h);let p=!1,f=!1;for(;!l;){const[e,s]=[t+u*a,n+u*o];if(!c.hasXY(e,s)){l=!1;break}c.getCell(e,s).isFree()?p&&(f=!0):(p=!0,i.push([e,s]),c.setBaseElemXY(e,s,h)),++u,l=p&&f}return l?i:[]}populateTunnel(e,t,n){const s=[n[0],n[n.length-1]],{actorConstr:r}=t;if(r){const t=Math.round(n.length/5),a=this.getActorsForNest(r,t);c.Placer.addActorsToCoord(e,n,a)&&a.forEach(e=>{const t=new m.EvaluatorPatrol(.7,s);e.getBrain().getGoal().addEvaluator(t)})}}}t.NestGenerator=b},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Battle=t.Army=void 0;const r=s(n(4)),a=n(23),o=n(18),i=n(55),l=n(15)("bitn:game.battle"),c=a.EventPool.getPool();class u extends i.Entity{constructor(e){super(),this._name=e,this._actors=[],this._battle=null,this._casualties=0,this._defeatThreshold=0,this.hasNotify=!0,this._alignment={},c.listenEvent(r.default.EVT_ACTOR_KILLED,this)}getName(){return this._name}addAlignment(e,t){this._alignment[e]=t}setDefeatThreshold(e){this._defeatThreshold=e}isDefeated(){return this._actors.length<=this._defeatThreshold}setBattle(e){this._battle=e}getBattle(){return this._battle}getCasualties(){return this._casualties}getActors(){return this._actors.slice()}hasActor(e){const t=e.getID();return this._actors.findIndex(e=>e.getID()===t)>=0}addActor(e){return this.hasActor(e)?(r.default.err("Game.Army","addActor","Actor already in army "+this.getName()),!1):(this._actors.push(e),!0)}removeActor(e){const t=this._actors.findIndex(t=>t.getID()===e.getID());return t>=0&&(this._actors.splice(t,1),!0)}removeAllActors(){this._actors=[]}notify(e,t){if(e===r.default.EVT_ACTOR_KILLED){l(this._name+" got EVT_ACTOR_KILLED");const e=t.actor;if(this.hasActor(e))if(this.removeActor(e)){++this._casualties;let t=`Battle: ${this.getBattle().getName()}, Army ${this._name}`;t+=" Actor: "+e.getID(),l(`\tCasualties: ${this._casualties} ${t}`);const n={type:"Actor killed",army:this};l(this._name+" emit EVT_ARMY_EVENT"),c.emitEvent(r.default.EVT_ARMY_EVENT,n),0===this._actors.length&&(l("<>Army<> "+this._name+" decimated"),l("\tCasualties: "+this._casualties),c.removeListener(this))}else{let t="Battle: "+this.getBattle().getName();t+="Couldn't remove the actor "+e.getName(),r.default.err("Game.Army","notify",t)}}}toJSON(){return{id:this.getID(),name:this._name,actors:this._actors.map(e=>e.getID()),defeatThreshold:this._defeatThreshold,alignment:this._alignment}}}t.Army=u;class h extends i.Entity{constructor(e){super(),this._name=e,this._armies=[],this._level=null,this.finished=!1,this._stats={duration:0,casualties:0,survivors:0},this.hasNotify=!0,c.listenEvent(r.default.EVT_ARMY_EVENT,this)}setParent(e){this._parent=e}getParent(){return this._parent}getType(){return"battle"}getArmies(){return this._armies.slice()}setArmies(e){this._armies=e,this._armies.forEach(e=>{e.setBattle(this)})}getName(){return this._name}setLevel(e){this._level=e,this._level.setParent(this)}getLevel(){return this._level}getStats(){return this._stats}setStats(e){this._stats=e}addArmy(e,t,n,s){const a=!!s.horizontal,o=s.numRows>0?s.numRows:1;if(r.default.isNullOrUndef([this._level]))r.default.err("Game.Battle","addArmy","Level must exist before adding army.");else{this._armies.push(e);const s=e.getActors(),r=Math.ceil(s.length/o);if(a){let e=0;for(let a=0;a<o;a++)for(let o=0;o<r;o++)e<s.length&&this.addActor(s[e++],t+o,n+a)}else{let e=0;for(let a=0;a<o;a++)for(let o=0;o<r;o++)e<s.length&&this.addActor(s[e++],t+a,n+o)}}e.setBattle(this)}addActor(e,t,n){const s=this._level.getMap().getCell(t,n);s.isPassable()||s.setBaseElem(o.ELEM.FLOOR),this._level.addActor(e,t,n)||r.default.err("Game.Battle","addActor",`Cannot add ${e} to ${t},${n}`)}armyInThisBattle(e){return this._armies.indexOf(e)>=0}isOver(){if(this._armies.length>1){let e=0;if(this._armies.forEach(t=>{t.isDefeated()||++e}),e<=1)return!0}else r.default.err("Game.Battle","isOver","Battle should have >= 2 armies.");return!1}notify(e,t){if(e===r.default.EVT_ARMY_EVENT){const e=this.getName();l(e+" got EVT_ARMY_EVENT");const{type:n,army:s}=t;if(this.armyInThisBattle(s)&&"Actor killed"===n&&!this.finished&&this.isOver()){l(`Battle |${e}| is over!`),l("\tRemoving all event listeners"),c.removeListener(this);const t={battle:this};l(e+" emit EVT_BATTLE_OVER"),c.emitEvent(r.default.EVT_BATTLE_OVER,t),this.finished=!0}}}toJSON(){const e={isJSON:!0,id:this.getID(),name:this._name,level:this._level.getID(),armies:this._armies.map(e=>e.toJSON()),stats:this._stats,finished:this.finished};return this._parent&&(e.parent=this._parent.getID()),e}removeListeners(){this._armies.forEach(e=>{c.removeListener(e)}),c.removeListener(this)}}t.Battle=h},function(e,t,n){var s=n(706);e.exports=function(e,t,n){if(s(e),void 0===t)return e;switch(n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,s){return e.call(t,n,s)};case 3:return function(n,s,r){return e.call(t,n,s,r)}}return function(){return e.apply(t,arguments)}}},function(e,t,n){var s=n(100);e.exports=function(e,t){if(!s(e))return e;var n,r;if(t&&"function"==typeof(n=e.toString)&&!s(r=n.call(e)))return r;if("function"==typeof(n=e.valueOf)&&!s(r=n.call(e)))return r;if(!t&&"function"==typeof(n=e.toString)&&!s(r=n.call(e)))return r;throw TypeError("Can't convert object to primitive value")}},function(e,t){var n={}.toString;e.exports=function(e){return n.call(e).slice(8,-1)}},function(e,t){e.exports=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e}},function(e,t){var n=Math.ceil,s=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?s:n)(e)}},function(e,t,n){var s=n(233)("keys"),r=n(161);e.exports=function(e){return s[e]||(s[e]=r(e))}},function(e,t,n){var s=n(66),r=s["__core-js_shared__"]||(s["__core-js_shared__"]={});e.exports=function(e){return r[e]||(r[e]={})}},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t,n){var s=n(230);e.exports=function(e){return Object(s(e))}},function(e,t){e.exports=!0},function(e,t,n){var s=n(99),r=n(714),a=n(234),o=n(232)("IE_PROTO"),i=function(){},l=function(){var e,t=n(346)("iframe"),s=a.length;for(t.style.display="none",n(715).appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),l=e.F;s--;)delete l.prototype[a[s]];return l()};e.exports=Object.create||function(e,t){var n;return null!==e?(i.prototype=s(e),n=new i,i.prototype=null,n[o]=e):n=l(),void 0===t?n:r(n,t)}},function(e,t,n){var s=n(83).f,r=n(84),a=n(50)("toStringTag");e.exports=function(e,t,n){e&&!r(e=n?e:e.prototype,a)&&s(e,a,{configurable:!0,value:t})}},function(e,t,n){t.f=n(50)},function(e,t,n){var s=n(66),r=n(49),a=n(237),o=n(240),i=n(83).f;e.exports=function(e){var t=r.Symbol||(r.Symbol=a?{}:s.Symbol||{});"_"==e.charAt(0)||e in t||i(t,e,{value:o.f(e)})}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FactoryGame=void 0;const i=o(n(4)),l=a(n(11)),c=a(n(47)),u=a(n(45)),h=n(91),d=n(112),p=n(342),f=n(774),m=n(782),g=n(55),y=n(23),v=n(86),b=n(64),_=n(87),E=n(103),S=n(127),w=n(13),C=n(118),O=n(125),T=n(12),M=n(126),A=n(9),N=n(371),x=n(165),P=n(24),I=n(91),D=y.EventPool.getPool(),k=A.Random.getRNG(),L={Weak:{att:1,def:1,prot:1,hp:15},Medium:{att:2,def:4,prot:2,hp:25},Strong:{att:5,def:6,prot:3,hp:40},Inhuman:{att:10,def:10,prot:4,hp:80}};class R{constructor(){this._verif=new c.Conf("Factory.Game"),this._parser=T.ObjectShell.getParser(),this.presetLevels={},this.callbacks={},this._factBase=new v.FactoryBase}static getOwConf(e=1,t={}){const n=t.xMult||1,s=t.yMult||1,r={yFirst:!1,topToBottom:!1,stopOnWall:!0,nVWalls:[.8],owTilesX:n*e*40,owTilesY:s*e*40,worldX:n*e*400,worldY:s*e*400,nLevelsX:n*e*4,nLevelsY:s*e*4,nTilesX:n*e*4,nTilesY:s*e*4,verify:!0};return t.owConf&&Object.keys(t.owConf).forEach(e=>{r[e]=t.owConf[e]}),r}static getGameConf(){return{cols:60,rows:30,levels:2,seed:(new Date).getTime(),playerLevel:"Medium",levelSize:"Medium",playerClass:I.ACTOR_CLASSES[0],playerRace:i.default.ACTOR_RACES[0],sqrPerActor:120,sqrPerItem:120,playMode:"OverWorld",loadedPlayer:null,loadedLevel:null,playerName:"Player",world:x.WorldConf,xMult:1,yMult:1}}restoreGame(e){const t=new E.FromJSON,n=new S.GameMain;return t.createGame(n,e)}createNewGame(e){this._verif.verifyConf("createNewGame",e,["sqrPerItem","sqrPerActor","playMode"]);const t=new S.GameMain;if(Number.isInteger(e.seed)){const n=new A.Random(e.seed);t.setRNG(n)}const n=this.createPlayerUnlessLoaded(e);switch(this.createPlayerRegenEvents(t,n),e.playMode){case"Arena":return this.createArenaDebugGame(e,t,n);case"Battle":return this.createDebugBattle(e,t,n);case"World":return this.createFullWorld(e,t,n);case"OverWorld":return this.createOverWorldGame(e,t,n);case"Quests":return this.createQuestsDebugGame(e,t,n);case"Sandbox":return this.createSandboxGame(e,t,n);default:return this.createEmptyGame(e,t,n)}}createEmptyGame(e,t,n){return e.levels&&(e.levels.forEach(e=>{const s=e.getExtras();if(t.addLevel(e),s.startPoint){const[t,r]=s.startPoint;e.addActor(n,t,r)}}),t.addPlayer(n)),t}createPlayerUnlessLoaded(e){let t=e.loadedPlayer;if(i.default.isNullOrUndef([t])){this._verif.verifyConf("createPlayerUnlessLoaded",e,["playerLevel","playerRace","playerName"]);const n=e.playerLevel,s=L[n];t=this._factBase.createPlayer(e.playerName,{att:s.att,def:s.def,prot:s.prot}),t.setType(e.playerRace),t.add(new l.Health(s.hp)),this.addActorClass(e,t),this.addRaceStuff(e,t),t.add(new l.Skills),t.add(new l.GameInfo),t.add(new l.BodyTemp),t.add(new l.Abilities);this._parser.createItem("Gold coin").get("Item").setCount(k.getUniformInt(30,100))}if(t.has("Hunger")){const e=t.get("Hunger");t.remove("Hunger"),t.add(e)}else{const e=new l.Hunger(2e4);t.add(e)}return i.default.addCellStyle(i.default.TYPE_ACTOR,t.getName(),"cell-actor-player"),"Emilia"===e.playerName?i.default.addCharStyle(i.default.TYPE_ACTOR,t.getName(),"E"):"Oliver"===e.playerName&&i.default.addCharStyle(i.default.TYPE_ACTOR,t.getName(),"O"),t}createPlayerRegenEvents(e,t){if(!t.has("Regeneration")){const e=new l.Regeneration;e.setMaxWaitPP(i.default.PLAYER_PP_REGEN_PERIOD),e.setMaxWaitHP(i.default.PLAYER_HP_REGEN_PERIOD),e.setHP(1),e.setPP(1),t.add(e)}}addActorClass(e,t){if(e.playerClass)if(h.ActorClass.hasOwnProperty(e.playerClass)){const n=new l.ActorClass,s=h.ActorClass.create(e.playerClass,t);n.setClassName(e.playerClass),n.setActorClass(s),t.add(n);const r=e.playerClass,a=h.ActorClass.getStartingItems(r),o=h.ActorClass.getEquipment(r);b.FactoryItem.addItemsToActor(t,a),b.FactoryItem.equipItemsToActor(t,o),s.setStartingStats(),s.advanceLevel()}else i.default.err("Factory.Game","addActorClass",e.playerClass+" not found in ActorClass.")}addRaceStuff(e,t){const{playerRace:n}=e;if(!p.ActorMods[n])return;const s=p.ActorMods[n].player,r=s.startingItems,a=s.equipment;b.FactoryItem.addItemsToActor(t,r),b.FactoryItem.equipItemsToActor(t,a),this.adjustStats(p.ActorMods[n].stats,t);const{playerClass:o}=e;if(s.hasOwnProperty(o)){const e=s[o],n=e.startingItems,r=e.equipment;n&&b.FactoryItem.addItemsToActor(t,n),r&&b.FactoryItem.equipItemsToActor(t,r)}}adjustStats(e,t){Object.keys(e).forEach(n=>{t.get("Stats").incrStat(n,e[n])})}setCallback(e,t){this.callbacks[e]=t}createOverWorldGame(e,t,n){const s=e.owMultiplier||1,r=R.getOwConf(s,e),a=Math.floor(r.nLevelsX/2),o=r.nLevelsY-1;r.playerX=a,r.playerY=o,r.playerRace=e.playerRace,r.createTerritory=!0;const l=(new Date).getTime();this.progress("Creating Overworld Tile Map...");const c=O.OWMap.createOverWorld(r);if(this.progress("DONE"),!c.hasTerrMap()){this.progress("Generating territory for clans/races...");const t=this.createTerritoryMap(c,e.playerRace,a,o);c.setTerrMap(t),this.progress("DONE")}this.progress("Creating Overworld Level Map...");const h=M.OverWorld.createOverWorldLevel(c,r),[d,p]=h;this.progress("DONE"),this.progress("Mapping settlements into territory areas.."),this.mapZonesToTerritoryMap(c.getTerrMap(),p),this.progress("DONE"),this.progress("Splitting Overworld Level Map into AreaTiles...");const f=C.Builder.splitLevel(d,r);this.progress("DONE"),this.progress("Creating and connecting World.Area tiles...");new u.Area("Ravendark",r.nLevelsX,r.nLevelsY,100,100,f).connectTiles(),this.progress("DONE");const m=new _.FactoryWorld;m.setOverWorld(c),m.setGlobalConf(e),t.setGlobalConf(e),m.setPresetLevels({Realm:f}),p.createAllZones=!1,this.progress("Creating places and local zones...");const g=f[a][o];this.modifyConfForHometown(p,n,g),this.createAreaLevelConstraints(p,c.getTerrMap());const y=m.createWorld(p);t.addPlace(y),c.clearSubLevels(),t.setOverWorld(c),t.setEnableChunkUnload(!0),this.progress("DONE"),this.progress("Adding player to the game..."),this.placePlayer(n,g),D.emitEvent(i.default.EVT_TILE_CHANGED,{actor:n,target:g}),n.setFOVRange(i.default.PLAYER_FOV_RANGE),t.addPlayer(n);let v="You have decided to venture outside your home village.";v+=" You feel there is something drawing you towards the North.",i.default.gameMsg("You have decided to venture outside your home village. You feel there is something drawing you towards the North."),this.progress("DONE");const b=(new Date).getTime()-l;return this.progress("World generation took "+b+" ms."),t}progress(e){const t=(new Date).getTime();let n=0;this.timePrev&&(n=(t-this.timePrev)/1e3),this.timePrev=t,this.callbacks.progress&&this.callbacks.progress(e),"DONE"===e&&i.default.log(`${this.prevMsg} - Time: ${n} sec`),this.prevMsg=e}placePlayer(e,t){const[n,s]=e.getXY();if(n>=0&&s>=0)return void t.addActor(e,n,s);const r=t.getMap().getFree(),a={};r.forEach(e=>{a[e.getKeyXY()]=!0});let o=null,l=!1,c=1e3;const u=Math.pow(5,2)-1;for(;!l;){o=k.arrayGetRand(r);const[e,t]=o.getXY(),n=w.Geometry.getBoxAround(e,t,2);n.length===u&&(l=!0);for(let e=0;e<n.length;e++){const[t,s]=n[e];l=l&&a[t+","+s]}if(--c<=0){i.default.log("Timeout reached");break}}l&&o?t.addActor(e,o.getX(),o.getY()):t.addActorToFreeCell(e)}createTerritoryMap(e,t,n,s){return N.TerritoryMap.create(e,t,[n,s])}mapZonesToTerritoryMap(e,t){const n=d.ActorsData.filter(e=>"UniqueBase"===e.base),s={};const r=this.getDisposition(),a=e.getMap();t.area[0].city.forEach(t=>{const{owX:o,owY:l}=t,c=a[o][l];let u=e.getName(c),h=null;if(u){if(h=[{op:"eq",prop:"type",value:[u]},{op:"neq",prop:"base",value:["WinterBeingBase"]}],"winterbeing"===u&&(h={op:"eq",prop:"base",value:["WinterBeingBase"]}),i.default.isSuccess(.07)){const e=n.filter(e=>e.type===u);if(e.length>0){const n=k.arrayGetRand(e);if(!s.hasOwnProperty(n.name)){const e={name:n.name,nLevel:0};let r=t.quarter[0].create;r||(r={}),r.actor||(r.actor=[]),r.actor.push(e),s[n.name]=n,t.hasUniques=!0,t.quarter[0].create=r}}}}else{const[t,n]=this.getAreaXYFromOWTileXY(o,l),s=this.getConstrWeightsForAreaXY(t,n,e),r=Object.keys(s);if(s.hasOwnProperty("winterbeing"))h={op:"eq",prop:"base",value:["WinterBeingBase"]};else if(r.length>0)u=k.getWeighted(s),h=[{op:"eq",prop:"type",value:[u]},{op:"neq",prop:"base",value:["WinterBeingBase"]}];else if(0===r.length){i.default.log("factory.game.js",e.mapToString());const s=`owX: ${o}, owY: ${l}`;i.default.err("FactoryGame","mapZonesToTerritoryMap",`No values for AreaTile ${t},${n}, ${s} found`)}}t.constraint||(t.constraint={}),t.constraint.actor=h,t.constraint.disposition=r[u],t.quarter.forEach(e=>{e.constraint||(e.constraint={}),e.constraint.actor=h,e.constraint.disposition=r[u],t.constraint.cellsAround&&(e.constraint.cellsAround=t.constraint.cellsAround)})})}getDisposition(){const e=new m.Disposition(i.default.ALL_RACES,{});return e.randomize(),e.getTable()}getAreaXYFromOWTileXY(e,t){return new M.OverWorld.CoordMap({xMap:10,yMap:10}).getAreaXYFromOWTileXY(e,t)}modifyConfForHometown(e,t,n){const s=e.area[0],r=s.city.find(e=>e.tags&&e.tags.indexOf("hometown")>=0);if(!r)return console.log(JSON.stringify(s.city,null,1)),void i.default.err("FactoryGame","modifyConfForHometown",'Unable to find city conf with "hometown" tag.');r.friendly=!0,r.quarter[0].create={actor:[{name:"chicken",num:15,nLevel:0}]},t.setXY(r.levelX,r.levelY),r.constraint?(r.constraint.actor=[{op:"eq",prop:"type",value:[t.getType()]},{op:"neq",prop:"base",value:["WinterBeingBase"]}],r.constraint.shop=[{op:"<=",prop:"value",value:50}],r.quarter[0].create||(r.quarter[0].create={}),r.quarter[0].create=Object.assign(r.quarter[0].create,{actor:[{name:"chicken",num:15,nLevel:0}]}),r.name+=", home town of "+t.getName()):i.default.err("FactoryGame","modifyConfForHometown","No homeConf.constraint found. Something went wrong in ow generation")}createAreaLevelConstraints(e,t){const n=e.area[0],s={};for(let e=0;e<n.maxX;e++)for(let r=0;r<n.maxY;r++){const n=this.getConstrWeightsForAreaXY(e,r,t),a=Object.keys(n);a.push("animal"),s[e+","+r]={actor:{op:"eq",prop:"type",value:a}},n.hasOwnProperty("winterbeing")&&(s[e+","+r].actor={op:"eq",prop:"base",value:"WinterBeingBase"})}n.constraint=s}getConstrWeightsForAreaXY(e,t,n){const s=n.getMap(),r=new M.CoordMap({xMap:10,yMap:10}).getOWTileBboxFromAreaTileXY(e,t),a=w.Geometry.getCellsInBbox(s,r),o=w.Geometry.histArrayVals(a);let i=Object.keys(o);i=i.filter(e=>"#"!==e&&"."!==e);const l={};return i.forEach(e=>{const t=n.getName(e);l[t]=o[e]}),l}createFullWorld(e,t,n){const s=e.world;if(this.processPresetLevels(s),!s)return i.default.err("Factory","createFullWorld","obj.world must exist!"),null;s.levelSize=e.levelSize;const r=new _.FactoryWorld;r.setGlobalConf(e),r.setPresetLevels(this.presetLevels);const a=r.createWorld(s),o=a.getLevels();let l={place:s.name,x:0,y:0};return s.playerStart&&(l=s.playerStart),o.length>0?(t.addPlace(a),t.addPlayer(n,l),t):(i.default.err("Factory","createFullWorld","There are no levels in the world!"),null)}processPresetLevels(e){if(this.presetLevels={},e.hasOwnProperty("presetLevels")){Object.keys(e.presetLevels).forEach(t=>{this.presetLevels[t]=this.createPresetLevels(e.presetLevels[t]),e.presetLevels[t]=this.presetLevels[t]})}}createPresetLevels(e){const t=new E.FromJSON;return e.map(e=>{if("function"==typeof e.level.getID)return e;const n=t.restoreLevel(e.level);return n.getID()<i.default.LEVEL_ID_ADD&&n.setID(P.Level.createLevelID()),n.getActors().forEach(e=>{e.getID()<i.default.ENTITY_ID_ADD&&e.setID(g.Entity.createEntityID())}),n.getItems().forEach(e=>{e.getID()<i.default.ENTITY_ID_ADD&&e.setID(g.Entity.createEntityID())}),i.default.setAllExplored(n),{nLevel:e.nLevel,level:n}})}createArenaDebugGame(e,t,n){return new f.DebugGame(this,this._parser).createArena(e,t,n)}createQuestsDebugGame(e,t,n){return new f.DebugGame(this,this._parser).createQuestsDebug(e,t,n)}createDebugBattle(e,t,n){return new f.DebugGame(this,this._parser).createDebugBattle(e,t,n)}createOneDungeonAndBoss(e,t,n){return new f.DebugGame(this,this._parser).createOneDungeonAndBoss(e,t,n)}createSandboxGame(e,t,n){return new f.DebugGame(this,this._parser).createSandboxGame(e,t,n)}}t.FactoryGame=R},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),r(n(367),t),r(n(368),t),r(n(369),t),r(n(777),t)},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Territory=void 0;const r=s(n(4)),a=n(13),o=n(9).Random.getRNG();class i{constructor(e,t,n={}){this.map=new Array(e),this.cols=e,this.rows=t,this.rivals=[],this.currRivals=[],this.empty={},this.occupied={},this.occupiedBy={},this.numEmpty=0,this.numCells=e*t,this.terrData={},this.rng=o,this.doPostProcess=!0,this.maxNumPos=1,this.startSize=1,this.maxFillRatio=1,this.dirs=r.default.DIR_NSEW_XY.concat(r.default.DIR_DIAG_XY);["maxNumPos","startSize","dirs","doPostProcess","maxFillRatio","rng"].forEach(e=>{n.hasOwnProperty(e)&&(this[e]=n[e])});for(let n=0;n<e;n++){this.map[n]=new Array(t);for(let e=0;e<t;e++)this._markEmpty(n,e)}this.infoTags={}}static fromJSON(e){const t=new i(0,0,{});return Object.keys(e).forEach(n=>{t[n]=e[n]}),t}setRNG(e){this.rng=e}getMap(){return this.map}getData(){return this.terrData}addTag(e,t){const n=r.default.toKey(e);this.infoTags[n]||(this.infoTags[n]=[]),this.infoTags[n].push(t)}getRivalData(e){return this.terrData[e]?this.terrData[e]:null}_markEmpty(e,t){this.map[e][t]=".",this.empty[e+","+t]=[e,t],++this.numEmpty}hasRival(e){return!this.isEmpty(e)&&!this.isFull(e)}getRival(e){const[t,n]=e,s=this.map[t][n];return this.getName(s)}findTag(e){const t=[];return Object.keys(this.infoTags).forEach(n=>{this.infoTags[n].indexOf(e)>=0&&t.push(r.default.fromKey(n))}),t}useMap(e,t){this.numEmpty=0;for(let n=0;n<e.length;n++)for(let s=0;s<e[0].length;s++)t[e[n][s]]?this._markEmpty(n,s):(this.map[n][s]="#",delete this.empty[n+","+s])}addRival(e){this._initRival(e)}generate(e=-1){this.currRivals=this.rivals.slice(),this.rng.shuffle(this.currRivals);let t=0;for(;this._hasTurnsLeftToProcess(t,e);){const e=this.currRivals.shift(),{name:n}=e,s=this.terrData[n],{open:r,currPos:a,maxNumPos:o}=s;if(a<o){const t=this._getStartPosition(n);this._addStartPosition(n,t),this.currRivals.push(e)}else if(Object.keys(r).length>0){const t=this.getRandOpenXY(n),s=this.getEmptyAdjacentXY(t);s?(this._addOccupied(n,s),this.currRivals.push(e)):(this._closeCell(n,t),Object.keys(r).length>0&&this.currRivals.push(e))}++t}this.doPostProcess&&this.postProcessData()}update(){this.currRivals=this.rivals.slice(),this.rng.shuffle(this.currRivals),this.currRivals.forEach(e=>{const{name:t}=e,n=this.getRandOpenXY(t),s=this.getEmptyAdjacentXY(n);s?this._addOccupied(t,s):this._closeCell(t,n)}),this.currRivals=[]}getName(e){const t=this.rivals.find(t=>t.char===e);return t?t.name:null}getFillRatio(){return(this.numCells-this.numEmpty)/this.numCells}_hasTurnsLeftToProcess(e,t){return this.hasEmpty()&&this.currRivals.length>0&&e!==t&&this.getFillRatio()<this.maxFillRatio}_getStartPosition(e){const t=this.terrData[e],{currPos:n}=t,s=this.getRandEmptyXY();t.startX.length>n?s[0]=t.startX[n]:t.startX.push(s[0]),t.startY.length>n?s[1]=t.startY[n]:t.startY.push(s[1]);const a=r.default.toKey(s);return this.empty.hasOwnProperty(a)||"#"!==this.map[s[0]][s[1]]&&r.default.warn("Territory","_getStartPosition",`${e} overriding another position @ ${s}`),t.currPos+=1,s}_addOccupied(e,t){const n=r.default.toKey(t);this.occupied[n]=t,this.occupiedBy[e].push(t),this.terrData[e].open[n]=t,this.terrData[e].occupied[n]=t,this.map[t[0]][t[1]]=this.terrData[e].char,this.empty[n]&&(--this.numEmpty,delete this.empty[n])}_addStartPosition(e,t){const n=this.getRivalData(e);if(!n)return void r.default.err("Territory","_addStartPosition",`TerrData for name |${e}| is null`);const s=n.startSize-1,o=a.Geometry.getBoxAround(t[0],t[1],s,!0);o.forEach(t=>{this.isEmpty(t)&&this._addOccupied(e,t)}),0===o.length&&r.default.err("Territory","_addStartPosition","No startCoord found!")}getRandEmptyXY(){return this.rng.arrayGetRand(Object.values(this.empty))}isFull(e){const[t,n]=e;return"#"===this.map[t][n]}isEmpty(e){const t=r.default.toKey(e);return this.empty.hasOwnProperty(t)}getRandOpenXY(e){const{open:t}=this.terrData[e];return this.rng.arrayGetRand(Object.values(t))}getEmptyAdjacentXY(e){const t=this.dirs.slice();for(this.rng.shuffle(t);t.length>0;){const n=t.shift(),[s,a]=r.default.newXYFromDir(n,e);if(this.hasXY(s,a)&&"."===this.map[s][a])return[s,a]}return null}hasXY(e,t){return e>=0&&t>=0&&e<this.map.length&&t<this.map[0].length}_closeCell(e,t){const n=r.default.toKey(t);this.terrData[e].closed[n]=t,delete this.terrData[e].open[n]}hasEmpty(){return this.numEmpty>0}mapToString(){const e=this.map[0].length,t=this.map.length,n=[];for(let s=0;s<e;s++){const e=[];for(let n=0;n<t;n++)e.push(this.map[n][s]);n.push(e)}return n.map(e=>e.join(""))}getAreaProportions(){const e={};return Object.keys(this.occupiedBy).forEach(t=>{e[t]=this.occupiedBy[t].length}),e}_initRival(e){this.rivals.push(e);const{name:t,char:n}=e;this.terrData[t]={currPos:0,maxNumPos:this.maxNumPos,char:n,occupied:{},closed:{},open:{},startX:[],startY:[],startSize:this.startSize},Array.isArray(e.startX)?this.terrData[t].startX=e.startX:e.startX>=0&&(this.terrData[t].startX=[e.startX]),Array.isArray(e.startY)?this.terrData[t].startY=e.startY:e.startY>=0&&(this.terrData[t].startY=[e.startY]),e.numPos?this.terrData[t].maxNumPos=e.numPos:e.maxNumPos&&(this.terrData[t].maxNumPos=e.maxNumPos),e.startSize&&(this.terrData[t].startSize=e.startSize),this.occupiedBy[t]=[]}postProcessData(){const e=this.dirs.length>4;Object.keys(this.terrData).forEach(t=>{const n=this.terrData[t],{startX:s,startY:o,char:i}=n;n.numOccupied=Object.keys(n.occupied).length,n.areas={},s.forEach((t,s)=>{const l=[t,o[s]],c=a.Geometry.floodfill2D(this.map,l,i,{},e);n.areas[r.default.toKey(l)]=c})})}toJSON(){return{terrData:this.terrData,map:this.map,cols:this.cols,rows:this.rows,currRivals:this.currRivals,empty:this.empty,occupied:this.occupied,occupiedBy:this.occupiedBy,numEmpty:this.numEmpty,dirs:this.dirs}}}t.Territory=i},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createLoreObj=t.createLoreMsg=t.createDirNorthMsg=t.formatMsg=t.compile=t.prep=t.Lore=void 0;const r=n(784),a=s(n(4)),o=n(9).Random.getRNG();t.Lore={generic:[],mainQuest:[],directions:[],northDirections:[],genericTopics:["generic","mainQuest"],typesDirections:[]},t.Lore.getRand=e=>{d(e);const n=t.Lore[e];return console.log("WWW:",n),o.arrayGetRand(n)},t.Lore.getRandText=e=>{d(e);const n=t.Lore[e],s=o.arrayGetRand(n);return o.arrayGetRand(s.text)};const i=new RegExp("[().]+");function l(e,...t){let n=e[0];for(let s=0;s<t.length;s++)h(t[s])||(n+=c(t[s],"Pre")),n+="<%= "+t[s]+" %>",h(t[s])||(n+=c(t[s],"Post")),n+=e[s+1];return n}function c(e,t){const n=`${e}${t}`;return`<% if (typeof ${n} !== "undefined") { %><%= ${n} %><% } %>`}function u(e,t){return r.compile(e)(t)}function h(e){return i.test(e)}function d(e){t.Lore.hasOwnProperty(e)||a.default.err("lore.ts","checkKeyError",`Key ${e} does not exist`)}t.Lore.generic=[{level:[{op:"match",func:"getParentZone.getName",value:"Home town"}],text:[l`Welcome home ${"asker.getName()"}!`,l`Are you returning home from an adventure, ${"asker.getName()"}?`]},{text:["An instant of one second is a luxury amidst the heat of the battle","One day, all matter will be frozen and all movement will cease"]}],t.Lore.mainQuest=[{text:["There is something evil gathering its troops in the northern arctics","To reach the north, you need to pass through several great mountain walls"]},{text:["I've heard rumors of a great northern city carved into the mountainside"]},{text:["Hyrkhians who are natives of this land have a built a great city into the mountain","They say you need to pass through mighty dwarven fortress to reach the cold north"]},{text:["Adventurers have seen strange and cold-looking creatures gathering near an abandoned fort"]},{text:["A traveller had seen a gigantic black tower rising into the sky from beneath the icy arctic."]}],t.Lore.directions=[{text:[l`There might be something interesting in ${"dir"} to explore`]},{text:[l`Travel ${"dir"} if you are looking for adventures`]},{text:[l`I've heard rumors of something going on in ${"dir"} from here`]}],t.Lore.typesDirections=[{text:[l`There is ${"name"} ${"dir"} from here.`]},{text:[l`If you travel ${"dir"}, you should find a ${"name"} there.`]}],t.Lore.northDirections=t.Lore.directions,t.prep=l,t.compile=function(e){return r.compile(e)},t.formatMsg=u,t.createDirNorthMsg=function(e){const n=o.arrayGetRand(t.Lore.northDirections);return u(o.arrayGetRand(n.text),{dir:e})},t.createLoreMsg=function(e){const n=o.arrayGetRand(t.Lore.northDirections);return u(o.arrayGetRand(n.text),{dir:e})},t.createLoreObj=function(e,t,n){const s={comp:"Lore",func:{addEntry:{topic:t,respMsg:e}}};return n&&(s.func.addEntry.metaData=n),s}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemEffects=void 0;const i=o(n(4)),l=n(14),c=n(26),u=a(n(11)),h=n(18),d=n(12),p=n(16),f=n(13),m=n(54),g={AddComp:!0,ModifyCompValue:!0,AddEntity:!0,RemoveEntity:!0,AddElement:!0,RemoveElement:!0,ChangeElement:!0,RemoveComp:!0};let y=Object.keys(g);class v extends l.SystemBase{constructor(e,t){super(i.default.SYS.EFFECTS,e,t),this._dtable={},Object.keys(g).forEach(e=>{if(g[e]){const t="handle"+e.capitalize();this._dtable[e]=this[t].bind(this)}})}static addEffect(e,t){if(!g.hasOwnProperty(e)){const n="handle"+e.capitalize();return v.prototype[n]=t,g[e]=!0,y=Object.keys(g),!0}return i.default.err("SystemEffects","addEffect",`Effect ${e} already exists.`),!1}static getEffectTargets(e){const t=e.target;if(!t){const e="Possibly missing args for useItem().";i.default.err("system.effects.js","getEffectTargets","Given object was null/undefined. "+e)}if(e.applyToAllTargets)return v.getAllTargetsFromObj(t,e.targetType);const n=v.getTargetFromObj(t,e.targetType);return n?[n]:[]}static getTargetFromObj(e,t){if(!e.hasOwnProperty("target"))return e;{const n=e.target;let s=t;if(s||(s=["actors","items","elements","baseElem"]),Array.isArray(s)||(s=[s]),"cell"===s[0])return n;for(let e=0;e<s.length;e++){if(n.hasProp(s[e]))return n.getProp(s[e])[0];if(/base/.test(s[e]))return n.getBaseElem()}}return null}static getAllTargetsFromObj(e,t){let n=[],s=e;e.hasOwnProperty("target")&&(s=e.target);let r=t;r||(r=["actors","items","elements","baseElem"]),Array.isArray(r)||(r=[r]);for(let e=0;e<r.length;e++)if(s.hasProp(r[e])){const t=s.getProp(r[e]);n=n.concat(t)}else/base/.test(r[e])&&n.push(s.getBaseElem());return n}updateEntity(e){e.getList("Effects").forEach(t=>{const n=t.getEffectType(),s=t.getArgs();let r=[];s.area?(r=function(e,t){const n=e.get("Location").getLevel(),[s,r]=e.get("Location").getXY(),[a,o]=S(t);a!==o&&i.default.err("system.effects.ts","getTargetCellsFromArea","Only NxN format supported. Got "+t);const l=Math.round((a-1)/2),c=f.Geometry.getBoxAround(s,r,l,!0);return n.getMap().getCellsWithCoord(c)}(e,s.area),s.anim&&function(e,t){const[n,s]=S(t.area),r=t.anim,[a,o]=e.get("Location").getXY(),i=e.get("Location").getLevel(),l={range:1,cX:a,cY:o,className:r.className,level:i},c=new u.Animation(l);e.add(c)}(e,s)):r=[s.target],n&&""!==n?this._dtable.hasOwnProperty(n)?r.forEach(r=>{s.target=r,this._checkStartMsgEmits(e,t);const a=this._dtable[n](e,t);this._checkEndMsgEmits(e,t,a),this._postEffectChecks(e,t,a)}):i.default.err("SystemEffects","updateEntity",`Effect |${n}| not in handler list: ${y}`):i.default.err("SystemEffects","updateEntity","No effect type in Effects comp"),e.remove(t)})}_checkStartMsgEmits(e,t){const n=t.getArgs();n.startMsg&&i.default.gameMsg({cell:e.getCell(),msg:n.startMsg})}_checkEndMsgEmits(e,t,n){const s=t.getArgs();s.endMsg&&i.default.gameMsg({cell:e.getCell(),msg:s.endMsg}),n&&s.successMsg&&i.default.gameMsg({cell:e.getCell(),msg:s.successMsg}),!n&&s.failureMsg&&i.default.gameWarn({cell:e.getCell(),msg:s.failureMsg})}_postEffectChecks(e,t,n){t.getArgs();if(!n)return;const s=t.getItem();s&&i.default.reduceCountOrCharge(s,e,this.pool)}handleAddComp(e,t){const n=t.getArgs(),s=v.getEffectTargets(n);let r=!1;return this._emitDbgMsg("handleAddComp start",e),s.forEach(s=>{if(n.applyToSelf)return;const a=b(n,s);let o=null;if(u.hasOwnProperty(a)?o=new u[a]:i.default.err("System.Effects","handleAddComp",`Failed to create comp |${a}|`),n.setters){const a=n.setters;Object.keys(a).forEach(l=>{if("$chooseArg"===l&&e.isPlayer()){const s=a[l],o=r=>{const o=i.default.clone(a);o[s.func]=r,delete o.$chooseArg;const l=Object.assign({},n);l.setters=o;const c=new u.Effects(l);c.setItem(t.getItem()),e.add(c)},c=a[l].args.map((e,t)=>[e,o.bind(this,e)]),h=new m.Menu.SelectRequired(c);return h.addPre(s.menuMsg),e.getBrain().setSelectionObject(h),void(r=!0)}if("function"==typeof o[l]){const e=a[l];if("$$target"===e)o[l](s);else if("$$item"===e)o[l](n.effectSource);else{const t=_(e);o[l](t)}}else{const e=JSON.stringify(o);i.default.err("useEffect","addComp",`No ${l} in comp ${e}`)}})}if(!r&&(o&&o.setSource&&(n.source?o.setSource(n.source):e.has("Created")?o.setSource(e.get("Created").getCreator()):o.setSource(e)),n.addOnUser&&(s=e),i.default.isEntity(s)))if(n.duration){const e=c.Dice.getValue(n.duration),t=n.expireMsg;u.addToExpirationComp(s,o,e,t)}else s.add(o)}),!0}handleAddElement(e,t){const n=t.getArgs(),s=E(n);n.elementName||i.default.err("System.Effects","handleAddElement","No elementName found in useArgs: "+JSON.stringify(n));let r=p.Element.create(n.elementName);if(!r){r=d.ObjectShell.getParser().createEntity(n.elementName)}if(r){const[t,a]=[s.getX(),s.getY()],o=e.getLevel(),i=s.getPropType(r.getType());return!(n.successCheck&&!this._successCheck(s,n.successCheck))&&((!i||i.length<n.numAllowed)&&(o.addElement(r,t,a)?("function"==typeof r.onSystemAdd&&r.onSystemAdd(s),n.setters&&this._applySetters(r,n.setters),!0):(console.error("Failed to add element "+n.elementName),!1)))}{const e="Failed to create elem: "+JSON.stringify(n);i.default.err("System.Effects","handleAddElement",e)}return!1}handleRemoveElement(e,t){const n=t.getArgs(),s=E(n);n.elementName||i.default.err("System.Effects","handleRemoveElement","No elementName found in useArgs: "+JSON.stringify(n));const r=s.getPropType(n.elementName);if(r.length>0){const t=r[0],[n,a]=[s.getX(),s.getY()];if(e.getLevel().removeElement(t,n,a))return"function"==typeof t.onSystemRemove&&t.onSystemRemove(s),!0}return!1}handleModifyCompValue(e,t){const n=t.getArgs(),s=v.getEffectTargets(n);let r=!1;return s.forEach(e=>{const t=b(n,e);if(i.default.isEntity(e)&&e.has(t)){const s=e.get(t),a=s[n.get](),o=n.value,i=_(o);s[n.set](a+i),r=!0}}),r}handleAddEntity(e,t){const n=t.getArgs(),s=E(n),r=d.ObjectShell.getParser().createEntity(n.entityName);if(r){const[t,a]=[s.getX(),s.getY()],o=n.level||e.getLevel();if(o||i.default.err("SystemEffects","handleAddEntity","level must exist for adding the entity"),o.addEntity(r,t,a)){if(n.duration){const e=new u.Fading,{duration:t}=n;e.setDuration(t),r.add(e)}const t=new u.Created;return t.setCreator(e),r.add(t),!0}}return!1}handleRemoveEntity(e,t){let n=!1;if("self"===t.getArgs().target)if(i.default.isItem(e)&&e.getTopOwner())i.default.err("system.effects.ts","handleRemoveEntity","Not supported for owned items (in inventory)");else{const[t,s]=e.get("Location").getXY();e.get("Location").getLevel().removeEntity(e,t,s)&&(n=!0)}else i.default.err("system.effects.ts","handleRemoveEntity",'Other targets than "self" unsupported for now');return n}handleChangeElement(e,t){const n=t.getArgs(),s=E(n),r=n.fromType,a=n.toType||h.ELEM.FLOOR;return s.getBaseElem().getType()===r&&(s.setBaseElem(a),!0)}handleRemoveComp(e,t){const n=t.getArgs(),s=v.getEffectTargets(n);let r=!1;return s.forEach(e=>{const t=b(n,e);i.default.isEntity(e)&&e.has(t)&&(n.all?e.removeAll(t):e.remove(t),r=!0)}),r}_successCheck(e,t){let n=!0;return t.forEach(t=>{i.default.PROP_TYPES.forEach(s=>{t[s]&&(["has","hasAll"].forEach(r=>{if(t[s][r])if(s===i.default.TYPE_ELEM||e.hasProp(s)){let a=e.getProp(s);a&&(a=a.slice()),s===i.default.TYPE_ELEM&&(a||(a=[]),a.push(e.getBaseElem()));let o=!1;a.forEach(e=>{const n=t[s][r];e[r](n)&&(o=!0)}),n=n&&o}else n=!1}),["hasNot","hasNone"].forEach(r=>{let a=e.getProp(s);a&&(a=a.slice()),s===i.default.TYPE_ELEM&&(a||(a=[]),a.push(e.getBaseElem())),a&&a.forEach(e=>{let a=!0;t[s][r]&&(e[r](t[s][r])||(a=!1)),n=n&&a})}))})}),n}_applySetters(e,t){let n=[];e.getCell();n=Array.isArray(t)?t:[t],n.forEach(t=>{let n=e;t.get&&(n=e.get(t.get)),Object.keys(t).forEach(e=>{if("get"!==e){const s=t[e];n[e](s)}})})}}function b(e,t){const n=e.name||e.comp;if(!n){let n="Unknown comp value. useArgs: "+JSON.stringify(e);t&&(n+=" targetEnt "+JSON.stringify(t)),i.default.err("SystemEffects","getCompName",n)}return n.capitalize()}t.SystemEffects=v,v.handlerTable=g;const _=function(e){if(Number.isInteger(e))return e;if("string"==typeof e){if(c.Dice.isDieSpec(e)){return c.Dice.create(e).roll()}const t=Number.parseFloat(e);if(!Number.isNaN(t))return t}return e};function E(e){if(e.target){const t=e.target;if(t.target)return t.target}const t=JSON.stringify(e);return i.default.err("system.effects.js","getTargetCellOrFail","Prop target must exist in useArgs. Got: |"+t),null}function S(e){const t=e.split("x");return 2!==t.length&&i.default.err("system.effects.ts","parseArea",`Wrong area spec given: ${e} (exp NxM)`),[parseInt(t[0],10),parseInt(t[1],10)]}},function(e,t,n){(function(t){var n;n=function(){"use strict";var e="function"==typeof Promise,n="object"==typeof self?self:t,s="undefined"!=typeof Symbol,r="undefined"!=typeof Map,a="undefined"!=typeof Set,o="undefined"!=typeof WeakMap,i="undefined"!=typeof WeakSet,l="undefined"!=typeof DataView,c=s&&void 0!==Symbol.iterator,u=s&&void 0!==Symbol.toStringTag,h=a&&"function"==typeof Set.prototype.entries,d=r&&"function"==typeof Map.prototype.entries,p=h&&Object.getPrototypeOf((new Set).entries()),f=d&&Object.getPrototypeOf((new Map).entries()),m=c&&"function"==typeof Array.prototype[Symbol.iterator],g=m&&Object.getPrototypeOf([][Symbol.iterator]()),y=c&&"function"==typeof String.prototype[Symbol.iterator],v=y&&Object.getPrototypeOf(""[Symbol.iterator]());return function(t){var s=typeof t;if("object"!==s)return s;if(null===t)return"null";if(t===n)return"global";if(Array.isArray(t)&&(!1===u||!(Symbol.toStringTag in t)))return"Array";if("object"==typeof window&&null!==window){if("object"==typeof window.location&&t===window.location)return"Location";if("object"==typeof window.document&&t===window.document)return"Document";if("object"==typeof window.navigator){if("object"==typeof window.navigator.mimeTypes&&t===window.navigator.mimeTypes)return"MimeTypeArray";if("object"==typeof window.navigator.plugins&&t===window.navigator.plugins)return"PluginArray"}if(("function"==typeof window.HTMLElement||"object"==typeof window.HTMLElement)&&t instanceof window.HTMLElement){if("BLOCKQUOTE"===t.tagName)return"HTMLQuoteElement";if("TD"===t.tagName)return"HTMLTableDataCellElement";if("TH"===t.tagName)return"HTMLTableHeaderCellElement"}}var c=u&&t[Symbol.toStringTag];if("string"==typeof c)return c;var h=Object.getPrototypeOf(t);return h===RegExp.prototype?"RegExp":h===Date.prototype?"Date":e&&h===Promise.prototype?"Promise":a&&h===Set.prototype?"Set":r&&h===Map.prototype?"Map":i&&h===WeakSet.prototype?"WeakSet":o&&h===WeakMap.prototype?"WeakMap":l&&h===DataView.prototype?"DataView":r&&h===f?"Map Iterator":a&&h===p?"Set Iterator":m&&h===g?"Array Iterator":y&&h===v?"String Iterator":null===h?"Object":Object.prototype.toString.call(t).slice(8,-1)}},e.exports=n()}).call(this,n(35))},function(e,t,n){var s=n(417),r=n(418),a=n(814),o=n(104);e.exports=function(e,t,n,s){return i({showHidden:t,seen:[],stylize:function(e){return e}},e,void 0===n?2:n)};function i(e,n,f){if(n&&"function"==typeof n.inspect&&n.inspect!==t.inspect&&(!n.constructor||n.constructor.prototype!==n)){var m=n.inspect(f,e);return"string"!=typeof m&&(m=i(e,m,f)),m}var g,y=function(e,t){switch(typeof t){case"undefined":return e.stylize("undefined","undefined");case"string":var n="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(n,"string");case"number":return 0===t&&1/t==-1/0?e.stylize("-0","number"):e.stylize(""+t,"number");case"boolean":return e.stylize(""+t,"boolean");case"symbol":return e.stylize(t.toString(),"symbol")}if(null===t)return e.stylize("null","null")}(e,n);if(y)return y;if(g=n,"object"==typeof HTMLElement?g instanceof HTMLElement:g&&"object"==typeof g&&"nodeType"in g&&1===g.nodeType&&"string"==typeof g.nodeName){if("outerHTML"in n)return n.outerHTML;try{if(document.xmlVersion)return(new XMLSerializer).serializeToString(n);var v=document.createElementNS("http://www.w3.org/1999/xhtml","_");v.appendChild(n.cloneNode(!1));var b=v.innerHTML.replace("><",">"+n.innerHTML+"<");return v.innerHTML="",b}catch(e){}}var _,E,S=a(n),w=e.showHidden?r(n):S;if(0===w.length||d(n)&&(1===w.length&&"stack"===w[0]||2===w.length&&"description"===w[0]&&"stack"===w[1])){if("function"==typeof n)return E=(_=s(n))?": "+_:"",e.stylize("[Function"+E+"]","special");if(u(n))return e.stylize(RegExp.prototype.toString.call(n),"regexp");if(h(n))return e.stylize(Date.prototype.toUTCString.call(n),"date");if(d(n))return l(n)}var C,O,T="",M=!1,A=!1,N=["{","}"];if("object"==typeof(C=n)&&/\w+Array]$/.test(p(C))&&(A=!0,N=["[","]"]),function(e){return Array.isArray(e)||"object"==typeof e&&"[object Array]"===p(e)}(n)&&(M=!0,N=["[","]"]),"function"==typeof n&&(T=" [Function"+(E=(_=s(n))?": "+_:"")+"]"),u(n)&&(T=" "+RegExp.prototype.toString.call(n)),h(n)&&(T=" "+Date.prototype.toUTCString.call(n)),d(n))return l(n);if(0===w.length&&(!M||0==n.length))return N[0]+T+N[1];if(f<0)return u(n)?e.stylize(RegExp.prototype.toString.call(n),"regexp"):e.stylize("[Object]","special");if(e.seen.push(n),M)O=function(e,t,n,s,r){for(var a=[],o=0,i=t.length;o<i;++o)Object.prototype.hasOwnProperty.call(t,String(o))?a.push(c(e,t,n,s,String(o),!0)):a.push("");return r.forEach((function(r){r.match(/^\d+$/)||a.push(c(e,t,n,s,r,!0))})),a}(e,n,f,S,w);else{if(A)return function(e){for(var t="[ ",n=0;n<e.length;++n){if(t.length>=o.truncateThreshold-7){t+="...";break}t+=e[n]+", "}-1!==(t+=" ]").indexOf(",  ]")&&(t=t.replace(",  ]"," ]"));return t}(n);O=w.map((function(t){return c(e,n,f,S,t,M)}))}return e.seen.pop(),function(e,t,n){if(e.reduce((function(e,t){return e+t.length+1}),0)>60)return n[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+n[1];return n[0]+t+" "+e.join(", ")+" "+n[1]}(O,T,N)}function l(e){return"["+Error.prototype.toString.call(e)+"]"}function c(e,t,n,s,r,a){var o,l,c=Object.getOwnPropertyDescriptor(t,r);if(c&&(c.get?l=c.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):c.set&&(l=e.stylize("[Setter]","special"))),s.indexOf(r)<0&&(o="["+r+"]"),l||(e.seen.indexOf(t[r])<0?(l=i(e,t[r],null===n?null:n-1)).indexOf("\n")>-1&&(l=a?l.split("\n").map((function(e){return"  "+e})).join("\n").substr(2):"\n"+l.split("\n").map((function(e){return"   "+e})).join("\n")):l=e.stylize("[Circular]","special")),void 0===o){if(a&&r.match(/^\d+$/))return l;(o=JSON.stringify(""+r)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.substr(1,o.length-2),o=e.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),o=e.stylize(o,"string"))}return o+": "+l}function u(e){return"object"==typeof e&&"[object RegExp]"===p(e)}function h(e){return"object"==typeof e&&"[object Date]"===p(e)}function d(e){return"object"==typeof e&&"[object Error]"===p(e)}function p(e){return Object.prototype.toString.call(e)}},function(e,t,n){"use strict";n.r(t),n.d(t,"ContextMenu",(function(){return V})),n.d(t,"ContextMenuTrigger",(function(){return Q})),n.d(t,"MenuItem",(function(){return R})),n.d(t,"SubMenu",(function(){return U})),n.d(t,"connectMenu",(function(){return ne})),n.d(t,"hideMenu",(function(){return A})),n.d(t,"showMenu",(function(){return M}));var s=n(1),r=n.n(s),a=n(0),o=n.n(a),i=n(3),l=n.n(i),c=n(21),u=n.n(c);function h(e){for(var t=arguments.length,n=Array(t>1?t-1:0),s=1;s<t;s++)n[s-1]=arguments[s];return"function"==typeof e&&e.apply(void 0,n)}function d(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var p="react-contextmenu",f="react-contextmenu--visible",m="react-contextmenu-wrapper",g="react-contextmenu-item",y="react-contextmenu-item--active",v="react-contextmenu-item--disabled",b="react-contextmenu-item--divider",_="react-contextmenu-item--selected",E="react-contextmenu-submenu",S={},w=Boolean("undefined"!=typeof window&&window.document&&window.document.createElement),C="REACT_CONTEXTMENU_SHOW",O="REACT_CONTEXTMENU_HIDE";function T(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:window,s=void 0;"function"==typeof window.CustomEvent?s=new window.CustomEvent(e,{detail:t}):(s=document.createEvent("CustomEvent")).initCustomEvent(e,!1,!0,t),n&&(n.dispatchEvent(s),u()(S,t))}function M(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments[1];T(C,u()({},e,{type:C}),t)}function A(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments[1];T(O,u()({},e,{type:O}),t)}var N=new function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.handleShowEvent=function(e){for(var n in t.callbacks)d(t.callbacks,n)&&t.callbacks[n].show(e)},this.handleHideEvent=function(e){for(var n in t.callbacks)d(t.callbacks,n)&&t.callbacks[n].hide(e)},this.register=function(e,n){var s=Math.random().toString(36).substring(7);return t.callbacks[s]={show:e,hide:n},s},this.unregister=function(e){e&&t.callbacks[e]&&delete t.callbacks[e]},this.callbacks={},w&&(window.addEventListener(C,this.handleShowEvent),window.addEventListener(O,this.handleHideEvent))},x=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},P=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();function I(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function D(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function k(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var L=function(e){function t(){var e,n,s;D(this,t);for(var r=arguments.length,a=Array(r),o=0;o<r;o++)a[o]=arguments[o];return n=s=k(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(a))),s.handleClick=function(e){0!==e.button&&1!==e.button&&e.preventDefault(),s.props.disabled||s.props.divider||(h(s.props.onClick,e,u()({},s.props.data,S.data),S.target),s.props.preventClose||A())},k(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),P(t,[{key:"render",value:function(){var e,t=this,n=this.props,s=n.attributes,a=n.children,o=n.className,i=n.disabled,c=n.divider,u=n.selected,h=l()(o,g,s.className,(I(e={},l()(v,s.disabledClassName),i),I(e,l()(b,s.dividerClassName),c),I(e,l()(_,s.selectedClassName),u),e));return r.a.createElement("div",x({},s,{className:h,role:"menuitem",tabIndex:"-1","aria-disabled":i?"true":"false","aria-orientation":c?"horizontal":null,ref:function(e){t.ref=e},onMouseMove:this.props.onMouseMove,onMouseLeave:this.props.onMouseLeave,onTouchEnd:this.handleClick,onClick:this.handleClick}),c?null:a)}}]),t}(s.Component);L.propTypes={attributes:o.a.object,children:o.a.node,className:o.a.string,data:o.a.object,disabled:o.a.bool,divider:o.a.bool,onClick:o.a.func,onMouseLeave:o.a.func,onMouseMove:o.a.func,preventClose:o.a.bool,selected:o.a.bool},L.defaultProps={attributes:{},children:null,className:"",data:{},disabled:!1,divider:!1,onClick:function(){return null},onMouseMove:function(){return null},onMouseLeave:function(){return null},preventClose:!1,selected:!1};var R=L;var B=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return F.call(n),n.seletedItemRef=null,n.state={selectedItem:null,forceSubMenuOpen:!1},n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t}(s.Component);B.propTypes={children:o.a.node.isRequired};var F=function(){var e=this;this.handleKeyNavigation=function(t){if(!1!==e.state.isVisible)switch(t.keyCode){case 37:case 27:t.preventDefault(),e.hideMenu(t);break;case 38:t.preventDefault(),e.selectChildren(!0);break;case 40:t.preventDefault(),e.selectChildren(!1);break;case 39:e.tryToOpenSubMenu(t);break;case 13:t.preventDefault(),e.tryToOpenSubMenu(t);var n=e.seletedItemRef&&e.seletedItemRef.props&&e.seletedItemRef.props.disabled;e.seletedItemRef&&e.seletedItemRef.ref instanceof HTMLElement&&!n?e.seletedItemRef.ref.click():e.hideMenu(t)}},this.handleForceClose=function(){e.setState({forceSubMenuOpen:!1})},this.tryToOpenSubMenu=function(t){e.state.selectedItem&&e.state.selectedItem.type===e.getSubMenuType()&&(t.preventDefault(),e.setState({forceSubMenuOpen:!0}))},this.selectChildren=function(t){var n=e.state.selectedItem,s=[],a=0,o={};if(r.a.Children.forEach(e.props.children,(function t(n,i){n&&([R,e.getSubMenuType()].indexOf(n.type)<0?r.a.Children.forEach(n.props.children,t):n.props.divider||(n.props.disabled&&(++a,o[i]=!0),s.push(n)))})),a!==s.length){var i=function(e){var n=e;do{t?--n:++n,n<0?n=s.length-1:n>=s.length&&(n=0)}while(n!==e&&o[n]);return n===e?null:n}(s.indexOf(n));null!==i&&e.setState({selectedItem:s[i],forceSubMenuOpen:!1})}},this.onChildMouseMove=function(t){e.state.selectedItem!==t&&e.setState({selectedItem:t,forceSubMenuOpen:!1})},this.onChildMouseLeave=function(){e.setState({selectedItem:null,forceSubMenuOpen:!1})},this.renderChildren=function(t){return r.a.Children.map(t,(function(t){var n={};return r.a.isValidElement(t)?[R,e.getSubMenuType()].indexOf(t.type)<0?(n.children=e.renderChildren(t.props.children),r.a.cloneElement(t,n)):(n.onMouseLeave=e.onChildMouseLeave.bind(e),t.type===e.getSubMenuType()&&(n.forceOpen=e.state.forceSubMenuOpen&&e.state.selectedItem===t,n.forceClose=e.handleForceClose,n.parentKeyNavigationHandler=e.handleKeyNavigation),t.props.divider||e.state.selectedItem!==t?(n.onMouseMove=function(){return e.onChildMouseMove(t)},r.a.cloneElement(t,n)):(n.selected=!0,n.ref=function(t){e.seletedItemRef=t},r.a.cloneElement(t,n))):t}))}},G=B,j=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},W=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();function Y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var X=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.getMenuPosition=function(){var e=window,t=e.innerWidth,s=e.innerHeight,r=n.subMenu.getBoundingClientRect(),a={};return r.bottom>s?a.bottom=0:a.top=0,r.right<t?a.left="100%":a.right="100%",a},n.getRTLMenuPosition=function(){var e=window.innerHeight,t=n.subMenu.getBoundingClientRect(),s={};return t.bottom>e?s.bottom=0:s.top=0,t.left<0?s.left="100%":s.right="100%",s},n.hideSubMenu=function(e){e.detail&&e.detail.id&&n.menu&&e.detail.id!==n.menu.id||(n.props.forceOpen&&n.props.forceClose(),n.setState({visible:!1,selectedItem:null}),n.unregisterHandlers())},n.handleClick=function(e){e.preventDefault(),n.props.disabled||(h(n.props.onClick,e,u()({},n.props.data,S.data),S.target),n.props.onClick&&!n.props.preventCloseOnClick&&A())},n.handleMouseEnter=function(){n.closetimer&&clearTimeout(n.closetimer),n.props.disabled||n.state.visible||(n.opentimer=setTimeout((function(){return n.setState({visible:!0,selectedItem:null})}),n.props.hoverDelay))},n.handleMouseLeave=function(){n.opentimer&&clearTimeout(n.opentimer),n.state.visible&&(n.closetimer=setTimeout((function(){return n.setState({visible:!1,selectedItem:null})}),n.props.hoverDelay))},n.menuRef=function(e){n.menu=e},n.subMenuRef=function(e){n.subMenu=e},n.registerHandlers=function(){document.removeEventListener("keydown",n.props.parentKeyNavigationHandler),document.addEventListener("keydown",n.handleKeyNavigation)},n.unregisterHandlers=function(e){document.removeEventListener("keydown",n.handleKeyNavigation),e||document.addEventListener("keydown",n.props.parentKeyNavigationHandler)},n.state=u()({},n.state,{visible:!1}),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),W(t,[{key:"componentDidMount",value:function(){this.listenId=N.register((function(){}),this.hideSubMenu)}},{key:"getSubMenuType",value:function(){return t}},{key:"shouldComponentUpdate",value:function(e,t){return this.isVisibilityChange=!(this.state.visible===t.visible&&this.props.forceOpen===e.forceOpen||this.state.visible&&e.forceOpen||this.props.forceOpen&&t.visible),!0}},{key:"componentDidUpdate",value:function(){var e=this;if(this.isVisibilityChange)if(this.props.forceOpen||this.state.visible){(window.requestAnimationFrame||setTimeout)((function(){var t=e.props.rtl?e.getRTLMenuPosition():e.getMenuPosition();e.subMenu.style.removeProperty("top"),e.subMenu.style.removeProperty("bottom"),e.subMenu.style.removeProperty("left"),e.subMenu.style.removeProperty("right"),d(t,"top")&&(e.subMenu.style.top=t.top),d(t,"left")&&(e.subMenu.style.left=t.left),d(t,"bottom")&&(e.subMenu.style.bottom=t.bottom),d(t,"right")&&(e.subMenu.style.right=t.right),e.subMenu.classList.add(f),e.registerHandlers(),e.setState({selectedItem:null})}))}else{this.subMenu.addEventListener("transitionend",(function t(){e.subMenu.removeEventListener("transitionend",t),e.subMenu.style.removeProperty("bottom"),e.subMenu.style.removeProperty("right"),e.subMenu.style.top=0,e.subMenu.style.left="100%",e.unregisterHandlers()})),this.subMenu.classList.remove(f)}}},{key:"componentWillUnmount",value:function(){this.listenId&&N.unregister(this.listenId),this.opentimer&&clearTimeout(this.opentimer),this.closetimer&&clearTimeout(this.closetimer),this.unregisterHandlers(!0)}},{key:"render",value:function(){var e,t=this.props,n=t.children,s=t.attributes,a=t.disabled,o=t.title,i=t.selected,c=this.state.visible,u={ref:this.menuRef,onMouseEnter:this.handleMouseEnter,onMouseLeave:this.handleMouseLeave,className:l()(g,E,s.listClassName),style:{position:"relative"}},h={className:l()(g,s.className,(e={},Y(e,l()(v,s.disabledClassName),a),Y(e,l()(y,s.visibleClassName),c),Y(e,l()(_,s.selectedClassName),i),e)),onMouseMove:this.props.onMouseMove,onMouseOut:this.props.onMouseOut,onClick:this.handleClick},d={ref:this.subMenuRef,style:{position:"absolute",transition:"opacity 1ms",top:0,left:"100%"},className:l()(p,this.props.className)};return r.a.createElement("nav",j({},u,{role:"menuitem",tabIndex:"-1","aria-haspopup":"true"}),r.a.createElement("div",j({},s,h),o),r.a.createElement("nav",j({},d,{role:"menu",tabIndex:"-1"}),this.renderChildren(n)))}}]),t}(G);X.propTypes={children:o.a.node.isRequired,attributes:o.a.object,title:o.a.node.isRequired,className:o.a.string,disabled:o.a.bool,hoverDelay:o.a.number,rtl:o.a.bool,selected:o.a.bool,onMouseMove:o.a.func,onMouseOut:o.a.func,forceOpen:o.a.bool,forceClose:o.a.func,parentKeyNavigationHandler:o.a.func},X.defaultProps={disabled:!1,hoverDelay:500,attributes:{},className:"",rtl:!1,selected:!1,onMouseMove:function(){return null},onMouseOut:function(){return null},forceOpen:!1,forceClose:function(){return null},parentKeyNavigationHandler:function(){return null}};var U=X,$=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();var H=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.registerHandlers=function(){document.addEventListener("mousedown",n.handleOutsideClick),document.addEventListener("touchstart",n.handleOutsideClick),n.props.preventHideOnScroll||document.addEventListener("scroll",n.handleHide),n.props.preventHideOnContextMenu||document.addEventListener("contextmenu",n.handleHide),document.addEventListener("keydown",n.handleKeyNavigation),n.props.preventHideOnResize||window.addEventListener("resize",n.handleHide)},n.unregisterHandlers=function(){document.removeEventListener("mousedown",n.handleOutsideClick),document.removeEventListener("touchstart",n.handleOutsideClick),document.removeEventListener("scroll",n.handleHide),document.removeEventListener("contextmenu",n.handleHide),document.removeEventListener("keydown",n.handleKeyNavigation),window.removeEventListener("resize",n.handleHide)},n.handleShow=function(e){if(e.detail.id===n.props.id&&!n.state.isVisible){var t=e.detail.position,s=t.x,r=t.y;n.setState({isVisible:!0,x:s,y:r}),n.registerHandlers(),h(n.props.onShow,e)}},n.handleHide=function(e){!n.state.isVisible||e.detail&&e.detail.id&&e.detail.id!==n.props.id||(n.unregisterHandlers(),n.setState({isVisible:!1,selectedItem:null,forceSubMenuOpen:!1}),h(n.props.onHide,e))},n.handleOutsideClick=function(e){n.menu.contains(e.target)||A()},n.handleMouseLeave=function(e){e.preventDefault(),h(n.props.onMouseLeave,e,u()({},n.props.data,S.data),S.target),n.props.hideOnLeave&&A()},n.handleContextMenu=function(e){e.preventDefault(),n.handleHide(e)},n.hideMenu=function(e){27!==e.keyCode&&13!==e.keyCode||A()},n.getMenuPosition=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s={top:t,left:e};if(!n.menu)return s;var r=window,a=r.innerWidth,o=r.innerHeight,i=n.menu.getBoundingClientRect();return t+i.height>o&&(s.top-=i.height),e+i.width>a&&(s.left-=i.width),s.top<0&&(s.top=i.height<o?(o-i.height)/2:0),s.left<0&&(s.left=i.width<a?(a-i.width)/2:0),s},n.getRTLMenuPosition=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s={top:t,left:e};if(!n.menu)return s;var r=window,a=r.innerWidth,o=r.innerHeight,i=n.menu.getBoundingClientRect();return s.left=e-i.width,t+i.height>o&&(s.top-=i.height),s.left<0&&(s.left+=i.width),s.top<0&&(s.top=i.height<o?(o-i.height)/2:0),s.left+i.width>a&&(s.left=i.width<a?(a-i.width)/2:0),s},n.menuRef=function(e){n.menu=e},n.state=u()({},n.state,{x:0,y:0,isVisible:!1}),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),$(t,[{key:"getSubMenuType",value:function(){return U}},{key:"componentDidMount",value:function(){this.listenId=N.register(this.handleShow,this.handleHide)}},{key:"componentDidUpdate",value:function(){var e=this,t=window.requestAnimationFrame||setTimeout;this.state.isVisible?t((function(){var n=e.state,s=n.x,r=n.y,a=e.props.rtl?e.getRTLMenuPosition(s,r):e.getMenuPosition(s,r),o=a.top,i=a.left;t((function(){e.menu&&(e.menu.style.top=o+"px",e.menu.style.left=i+"px",e.menu.style.opacity=1,e.menu.style.pointerEvents="auto")}))})):t((function(){e.menu&&(e.menu.style.opacity=0,e.menu.style.pointerEvents="none")}))}},{key:"componentWillUnmount",value:function(){this.listenId&&N.unregister(this.listenId),this.unregisterHandlers()}},{key:"render",value:function(){var e,t,n,s=this.props,a=s.children,o=s.className,i=s.style,c=this.state.isVisible,h=u()({},i,{position:"fixed",opacity:0,pointerEvents:"none"}),d=l()(p,o,(n=c,(t=f)in(e={})?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e));return r.a.createElement("nav",{role:"menu",tabIndex:"-1",ref:this.menuRef,style:h,className:d,onContextMenu:this.handleContextMenu,onMouseLeave:this.handleMouseLeave},this.renderChildren(a))}}]),t}(G);H.propTypes={id:o.a.string.isRequired,children:o.a.node.isRequired,data:o.a.object,className:o.a.string,hideOnLeave:o.a.bool,rtl:o.a.bool,onHide:o.a.func,onMouseLeave:o.a.func,onShow:o.a.func,preventHideOnContextMenu:o.a.bool,preventHideOnResize:o.a.bool,preventHideOnScroll:o.a.bool,style:o.a.object},H.defaultProps={className:"",data:{},hideOnLeave:!1,rtl:!1,onHide:function(){return null},onMouseLeave:function(){return null},onShow:function(){return null},preventHideOnContextMenu:!1,preventHideOnResize:!1,preventHideOnScroll:!1,style:{}};var V=H,K=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();function q(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function z(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var J=function(e){function t(){var e,n,s;q(this,t);for(var r=arguments.length,a=Array(r),o=0;o<r;o++)a[o]=arguments[o];return n=s=z(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(a))),s.touchHandled=!1,s.handleMouseDown=function(e){s.props.holdToDisplay>=0&&0===e.button&&(e.persist(),e.stopPropagation(),s.mouseDownTimeoutId=setTimeout((function(){return s.handleContextClick(e)}),s.props.holdToDisplay)),h(s.props.attributes.onMouseDown,e)},s.handleMouseUp=function(e){0===e.button&&clearTimeout(s.mouseDownTimeoutId),h(s.props.attributes.onMouseUp,e)},s.handleMouseOut=function(e){0===e.button&&clearTimeout(s.mouseDownTimeoutId),h(s.props.attributes.onMouseOut,e)},s.handleTouchstart=function(e){s.touchHandled=!1,s.props.holdToDisplay>=0&&(e.persist(),e.stopPropagation(),s.touchstartTimeoutId=setTimeout((function(){s.handleContextClick(e),s.touchHandled=!0}),s.props.holdToDisplay)),h(s.props.attributes.onTouchStart,e)},s.handleTouchEnd=function(e){s.touchHandled&&e.preventDefault(),clearTimeout(s.touchstartTimeoutId),h(s.props.attributes.onTouchEnd,e)},s.handleContextMenu=function(e){e.button===s.props.mouseButton&&s.handleContextClick(e),h(s.props.attributes.onContextMenu,e)},s.handleMouseClick=function(e){e.button===s.props.mouseButton&&s.handleContextClick(e),h(s.props.attributes.onClick,e)},s.handleContextClick=function(e){if(!(s.props.disable||s.props.disableIfShiftIsPressed&&e.shiftKey)){e.preventDefault(),e.stopPropagation();var t=e.clientX||e.touches&&e.touches[0].pageX,n=e.clientY||e.touches&&e.touches[0].pageY;s.props.posX&&(t-=s.props.posX),s.props.posY&&(n-=s.props.posY),A();var r=h(s.props.collect,s.props),a={position:{x:t,y:n},target:s.elem,id:s.props.id};r&&"function"==typeof r.then?r.then((function(t){a.data=u()({},t,{target:e.target}),M(a)})):(a.data=u()({},r,{target:e.target}),M(a))}},s.elemRef=function(e){s.elem=e},z(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),K(t,[{key:"render",value:function(){var e=this.props,t=e.renderTag,n=e.attributes,s=e.children,a=u()({},n,{className:l()(m,n.className),onContextMenu:this.handleContextMenu,onClick:this.handleMouseClick,onMouseDown:this.handleMouseDown,onMouseUp:this.handleMouseUp,onTouchStart:this.handleTouchstart,onTouchEnd:this.handleTouchEnd,onMouseOut:this.handleMouseOut,ref:this.elemRef});return r.a.createElement(t,a,s)}}]),t}(s.Component);J.propTypes={id:o.a.string.isRequired,children:o.a.node.isRequired,attributes:o.a.object,collect:o.a.func,disable:o.a.bool,holdToDisplay:o.a.number,posX:o.a.number,posY:o.a.number,renderTag:o.a.elementType,mouseButton:o.a.number,disableIfShiftIsPressed:o.a.bool},J.defaultProps={attributes:{},collect:function(){return null},disable:!1,holdToDisplay:1e3,renderTag:"div",posX:0,posY:0,mouseButton:2,disableIfShiftIsPressed:!1};var Q=J,Z=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},ee=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}();var te=[].concat(function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(Object.keys(Q.propTypes)),["children"]),ne=function(e){return function(t){return function(n){function s(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,s);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,t));return n.handleShow=function(t){if(t.detail.id===e){var s=t.detail.data,r={};for(var a in s)te.includes(a)||(r[a]=s[a]);n.setState({trigger:r})}},n.handleHide=function(){n.setState({trigger:null})},n.state={trigger:null},n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(s,n),ee(s,[{key:"componentDidMount",value:function(){this.listenId=N.register(this.handleShow,this.handleHide)}},{key:"componentWillUnmount",value:function(){this.listenId&&N.unregister(this.listenId)}},{key:"render",value:function(){return r.a.createElement(t,Z({},this.props,{id:e,trigger:this.state.trigger}))}}]),s}(s.Component)}}},function(e,t,n){e.exports={default:n(704),__esModule:!0}},function(e,t,n){"use strict";t.__esModule=!0;var s=c(n(58)),r=c(n(0)),a=c(n(1)),o=c(n(17)),i=c(n(356)),l=c(n(102));function c(e){return e&&e.__esModule?e:{default:e}}var u=function(e){function t(n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var a=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.call(this,n,r));return a.addEventListeners=function(){var e=a.props.event,t=(0,l.default)(a);a.documentMouseCaptureListener=(0,i.default)(t,e,a.handleMouseCapture,!0),a.documentMouseListener=(0,i.default)(t,e,a.handleMouse),a.documentKeyupListener=(0,i.default)(t,"keyup",a.handleKeyUp)},a.removeEventListeners=function(){a.documentMouseCaptureListener&&a.documentMouseCaptureListener.remove(),a.documentMouseListener&&a.documentMouseListener.remove(),a.documentKeyupListener&&a.documentKeyupListener.remove()},a.handleMouseCapture=function(e){var t;a.preventMouseRootClose=!!((t=e).metaKey||t.altKey||t.ctrlKey||t.shiftKey)||!function(e){return 0===e.button}(e)||(0,s.default)(o.default.findDOMNode(a),e.target)},a.handleMouse=function(e){!a.preventMouseRootClose&&a.props.onRootClose&&a.props.onRootClose(e)},a.handleKeyUp=function(e){27===e.keyCode&&a.props.onRootClose&&a.props.onRootClose(e)},a.preventMouseRootClose=!1,a}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this.props.disabled||this.addEventListeners()},t.prototype.componentDidUpdate=function(e){!this.props.disabled&&e.disabled?this.addEventListeners():this.props.disabled&&!e.disabled&&this.removeEventListeners()},t.prototype.componentWillUnmount=function(){this.props.disabled||this.removeEventListeners()},t.prototype.render=function(){return this.props.children},t}(a.default.Component);u.displayName="RootCloseWrapper",u.propTypes={onRootClose:r.default.func,children:r.default.element,disabled:r.default.bool,event:r.default.oneOf(["click","mousedown"])},u.defaultProps={event:"click"},t.default=u,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e){return(0,s.default)(e)||(t=e,t&&"body"===t.tagName.toLowerCase())?function(e){var t=(0,r.default)(e),n=(0,s.default)(t).innerWidth;if(!n){var a=t.documentElement.getBoundingClientRect();n=a.right-Math.abs(a.left)}return t.body.clientWidth<n}(e):e.scrollHeight>e.clientHeight;var t};var s=a(n(109)),r=a(n(52));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.listen=t.filter=t.off=t.on=void 0;var s=i(n(110)),r=i(n(132)),a=i(n(752)),o=i(n(754));function i(e){return e&&e.__esModule?e:{default:e}}t.on=s.default,t.off=r.default,t.filter=a.default,t.listen=o.default,t.default={on:s.default,off:r.default,filter:a.default,listen:o.default}},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=u(n(0)),a=u(n(10)),o=u(n(1)),i=u(n(357)),l=u(n(761)),c=u(n(251));function u(e){return e&&e.__esModule?e:{default:e}}var h=function(e){function t(n,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.call(this,n,s));return r.handleHidden=function(){var e;(r.setState({exited:!0}),r.props.onExited)&&(e=r.props).onExited.apply(e,arguments)},r.state={exited:!n.show},r.onHiddenListener=r.handleHidden.bind(r),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentWillReceiveProps=function(e){e.show?this.setState({exited:!1}):e.transition||this.setState({exited:!0})},t.prototype.render=function(){var e=this.props,t=e.container,n=e.containerPadding,s=e.target,r=e.placement,a=e.shouldUpdatePosition,u=e.rootClose,h=e.children,d=e.transition,p=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(e,["container","containerPadding","target","placement","shouldUpdatePosition","rootClose","children","transition"]);if(!(p.show||d&&!this.state.exited))return null;var f=h;if(f=o.default.createElement(l.default,{container:t,containerPadding:n,target:s,placement:r,shouldUpdatePosition:a},f),d){var m=p.onExit,g=p.onExiting,y=p.onEnter,v=p.onEntering,b=p.onEntered;f=o.default.createElement(d,{in:p.show,transitionAppear:!0,onExit:m,onExiting:g,onExited:this.onHiddenListener,onEnter:y,onEntering:v,onEntered:b},f)}return u&&(f=o.default.createElement(c.default,{onRootClose:p.onHide},f)),o.default.createElement(i.default,{container:t},f)},t}(o.default.Component);h.propTypes=s({},i.default.propTypes,l.default.propTypes,{show:r.default.bool,rootClose:r.default.bool,onHide:function(e){var t=r.default.func;e.rootClose&&(t=t.isRequired);for(var n=arguments.length,s=Array(n>1?n-1:0),a=1;a<n;a++)s[a-1]=arguments[a];return t.apply(void 0,[e].concat(s))},transition:a.default,onEnter:r.default.func,onEntering:r.default.func,onEntered:r.default.func,onExit:r.default.func,onExiting:r.default.func,onExited:r.default.func}),t.default=h,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){function t(t,n,s,r,a,o){var i=r||"<<anonymous>>",l=o||s;if(null==n[s])return t?new Error("Required "+a+" `"+l+"` was not specified in `"+i+"`."):null;for(var c=arguments.length,u=Array(c>6?c-6:0),h=6;h<c;h++)u[h-6]=arguments[h];return e.apply(void 0,[n,s,i,a,l].concat(u))}var n=t.bind(null,!1);return n.isRequired=t.bind(null,!0),n},e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hasClass=t.removeClass=t.addClass=void 0;var s=o(n(435)),r=o(n(436)),a=o(n(257));function o(e){return e&&e.__esModule?e:{default:e}}t.addClass=s.default,t.removeClass=r.default,t.hasClass=a.default,t.default={addClass:s.default,removeClass:r.default,hasClass:a.default}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return e.classList?!!t&&e.classList.contains(t):-1!==(" "+(e.className.baseVal||e.className)+" ").indexOf(" "+t+" ")},e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return(0,a.default)(e.replace(o,"ms-"))};var s,r=n(437),a=(s=r)&&s.__esModule?s:{default:s};var o=/^-ms-/;e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.animationEnd=t.animationDelay=t.animationTiming=t.animationDuration=t.animationName=t.transitionEnd=t.transitionDuration=t.transitionDelay=t.transitionTiming=t.transitionProperty=t.transform=void 0;var s,r=n(41);var a="transform",o=void 0,i=void 0,l=void 0,c=void 0,u=void 0,h=void 0,d=void 0,p=void 0,f=void 0,m=void 0,g=void 0;if(((s=r)&&s.__esModule?s:{default:s}).default){var y=function(){for(var e=document.createElement("div").style,t={O:function(e){return"o"+e.toLowerCase()},Moz:function(e){return e.toLowerCase()},Webkit:function(e){return"webkit"+e},ms:function(e){return"MS"+e}},n=Object.keys(t),s=void 0,r=void 0,a="",o=0;o<n.length;o++){var i=n[o];if(i+"TransitionProperty"in e){a="-"+i.toLowerCase(),s=t[i]("TransitionEnd"),r=t[i]("AnimationEnd");break}}!s&&"transitionProperty"in e&&(s="transitionend");!r&&"animationName"in e&&(r="animationend");return e=null,{animationEnd:r,transitionEnd:s,prefix:a}}();o=y.prefix,t.transitionEnd=i=y.transitionEnd,t.animationEnd=l=y.animationEnd,t.transform=a=o+"-"+a,t.transitionProperty=c=o+"-transition-property",t.transitionDuration=u=o+"-transition-duration",t.transitionDelay=d=o+"-transition-delay",t.transitionTiming=h=o+"-transition-timing-function",t.animationName=p=o+"-animation-name",t.animationDuration=f=o+"-animation-duration",t.animationTiming=m=o+"-animation-delay",t.animationDelay=g=o+"-animation-timing-function"}t.transform=a,t.transitionProperty=c,t.transitionTiming=h,t.transitionDelay=d,t.transitionDuration=u,t.transitionEnd=i,t.animationName=p,t.animationDuration=f,t.animationTiming=m,t.animationDelay=g,t.animationEnd=l,t.default={transform:a,end:i,property:c,timing:h,delay:d,duration:u}},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e){return(0,s.default)(e)||(t=e,t&&"body"===t.tagName.toLowerCase())?function(e){var t=(0,r.default)(e),n=(0,s.default)(t).innerWidth;if(!n){var a=t.documentElement.getBoundingClientRect();n=a.right-Math.abs(a.left)}return t.body.clientWidth<n}(e):e.scrollHeight>e.clientHeight;var t};var s=a(n(109)),r=a(n(52));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";function s(){var e=this.constructor.getDerivedStateFromProps(this.props,this.state);null!=e&&this.setState(e)}function r(e){this.setState(function(t){var n=this.constructor.getDerivedStateFromProps(e,t);return null!=n?n:null}.bind(this))}function a(e,t){try{var n=this.props,s=this.state;this.props=e,this.state=t,this.__reactInternalSnapshotFlag=!0,this.__reactInternalSnapshot=this.getSnapshotBeforeUpdate(n,s)}finally{this.props=n,this.state=s}}function o(e){var t=e.prototype;if(!t||!t.isReactComponent)throw new Error("Can only polyfill class components");if("function"!=typeof e.getDerivedStateFromProps&&"function"!=typeof t.getSnapshotBeforeUpdate)return e;var n=null,o=null,i=null;if("function"==typeof t.componentWillMount?n="componentWillMount":"function"==typeof t.UNSAFE_componentWillMount&&(n="UNSAFE_componentWillMount"),"function"==typeof t.componentWillReceiveProps?o="componentWillReceiveProps":"function"==typeof t.UNSAFE_componentWillReceiveProps&&(o="UNSAFE_componentWillReceiveProps"),"function"==typeof t.componentWillUpdate?i="componentWillUpdate":"function"==typeof t.UNSAFE_componentWillUpdate&&(i="UNSAFE_componentWillUpdate"),null!==n||null!==o||null!==i){var l=e.displayName||e.name,c="function"==typeof e.getDerivedStateFromProps?"getDerivedStateFromProps()":"getSnapshotBeforeUpdate()";throw Error("Unsafe legacy lifecycles will not be called for components using new component APIs.\n\n"+l+" uses "+c+" but also contains the following legacy lifecycles:"+(null!==n?"\n  "+n:"")+(null!==o?"\n  "+o:"")+(null!==i?"\n  "+i:"")+"\n\nThe above lifecycles should be removed. Learn more about this warning here:\nhttps://fb.me/react-async-component-lifecycle-hooks")}if("function"==typeof e.getDerivedStateFromProps&&(t.componentWillMount=s,t.componentWillReceiveProps=r),"function"==typeof t.getSnapshotBeforeUpdate){if("function"!=typeof t.componentDidUpdate)throw new Error("Cannot polyfill getSnapshotBeforeUpdate() for components that do not define componentDidUpdate() on the prototype");t.componentWillUpdate=a;var u=t.componentDidUpdate;t.componentDidUpdate=function(e,t,n){var s=this.__reactInternalSnapshotFlag?this.__reactInternalSnapshot:n;u.call(this,e,t,s)}}return e}n.r(t),n.d(t,"polyfill",(function(){return o})),s.__suppressDeprecationWarning=!0,r.__suppressDeprecationWarning=!0,a.__suppressDeprecationWarning=!0},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=o(n(1)),a=o(n(0));function o(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var c=function(e){function t(){return i(this,t),l(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.render=function(){var e,t,n=this.props,a=n.component,o=n.children,i=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(n,["component","children"]);return r.default.createElement(a,s({},i,{onClick:(e=i.onClick,t=this.context.onModalHide,function(){e&&e.apply(void 0,arguments),t&&t.apply(void 0,arguments)})}),o)},t}(r.default.Component);c.propTypes={component:a.default.oneOfType([a.default.string,a.default.func])},c.defaultProps={component:"button"},c.contextTypes={onModalHide:a.default.func},t.default=c,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Texts=void 0,t.Texts={},t.Texts.intro={},t.Texts.intro.chapter1="\nWelcome to the wintry realms!\nWinds are ever-blowing. Blowing off the\nglaciers.\nAre you ready to face the challenges of the\nicy north? Hunger, coldness, ravenous\nbeasts, glacial chasms and forthcoming\neternal winter are waiting for you in the\ndarkness.\n",t.Texts.intro.chapter2="\nYou have come a long way from your homelands\nseeking\nthe thrill of the adventure. Now, you must\nfight freezing battles in\nthe north against hordes of winter demons\nand blizzard beasts. Will you bring back the\npeace\nto the grim and frostbitten kingdoms. Or\nwill you\nbring the Winter of Ages upon its lands,\nreigning\nyour kingdom cold for all eternity? Or will\nyou\nperish\nnameless and forgotten on the icy wastes?\n",t.Texts.battle={},t.Texts.battle.eyeOfStorm="You see an eye of the storm approaching. Brace yourself now..",t.Texts.battle.beastsSlain="All beasts have been slain. The blizzard seems to calm down",t.Texts.battle.enemiesDead="All enemies are dead! You emerge victorious. Congratulations!",t.Texts.mainQuest=["Go north","Something is going on in the North","Some speak about ancient ice beasts waking up in the arctic!","Two huge mountain passes divide this realm into regions","If you follow the Great Road to north, you will reach a city carved into the mountain","Recently, the breezes from north have been colder than before","I heard dwarves hold their fort between middle valley and the North","The hordes of Death have been seen marching from the southern swamps!","You must pass through an abandoned fort to reach the Arctic valley","If you travel to cold north, remember to take food and a source of heat with you"]},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MindControl=void 0;const r=s(n(4)),a=n(34),o=n(27);t.MindControl=function(){a.ComponentBase.call(this,"MindControl");let e=null,t=null;this.getSource=()=>e,this.setSource=t=>{e=t};this.addCallback("onAdd",()=>{const e=this.getEntity();t=e.getBrain(),this.getSource().isPlayer()?e.setPlayerCtrl(!0):e.setBrain(new o.BrainMindControl(e))}),this.addCallback("onRemove",()=>{this.getSource().isPlayer()&&this.getEntity().setPlayerCtrl(!1),this.getEntity().setBrain(t)})},r.default.extend2(t.MindControl,a.ComponentBase),t.MindControl.prototype.toJSON=function(){const e=a.ComponentBase.prototype.toJSON.call(this);return r.default.isActorActive(this.getSource())&&(e.setSource=r.default.getObjRef("entity",this.getSource())),e}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(177));class a extends r.default{constructor(e,t,n,s={}){super(e,t,n,s),this._todo=[],this._done={}}compute(e,t,n){for(this._todo=[],this._done={},this._fromX=e,this._fromY=t,this._add(this._toX,this._toY,null);this._todo.length;){const n=this._todo.shift(),s=n.x+","+n.y;if(s in this._done)continue;if(this._done[s]=n,n.x===e&&n.y===t)break;const r=this._getNeighbors(n.x,n.y);for(let e=0;e<r.length;e++){const t=r[e],s=t[0],a=t[1];s+","+a in this._done||this._add(s,a,n)}}let s=this._done[e+","+t];if(s)for(;s;)n(s.x,s.y,s.prev),s=s.prev}_add(e,t,n){const s=this._distance(e,t),r={x:e,y:t,prev:n,g:n?n.g+1:0,h:s},a=r.g+r.h;for(let e=0;e<this._todo.length;e++){const t=this._todo[e],n=t.g+t.h;if(a<n||a===n&&s<t.h)return void this._todo.splice(e,0,r)}this._todo.push(r)}_distance(e,t){switch(this._options.topology){case 4:return Math.abs(e-this._fromX)+Math.abs(t-this._fromY);case 6:const n=Math.abs(e-this._fromX),s=Math.abs(t-this._fromY);return s+Math.max(0,(n-s)/2);case 8:return Math.max(Math.abs(e-this._fromX),Math.abs(t-this._fromY))}}}t.default=a},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(463)),a=s(n(465)),o=s(n(466));t.default={Simple:r.default,Speed:a.default,Action:o.default}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Effects=t.createUseItemComp=void 0;const i=o(n(4)),l=n(26),c=a(n(11)),u=["actors","items","elements"],h=e=>{if(!e){const e="Possibly missing args for useItem().";i.default.err("effects.js","getTargetActor","Given object was null/undefined. "+e)}if(e.hasOwnProperty("target")){const t=e.target;if(t.hasActors())return t.getProp("actors")[0]}return null},d=e=>e.getTopOwner?e.getTopOwner():e;t.createUseItemComp=(e,t,n)=>{const s=new c.UseItem;s.setTarget(t),s.setItem(e),n&&s.setEffect(n);const r=i.default.getEffectUseType(e,t);s.setUseType(r);d(e).add(s)};t.Effects={effects:[{name:"use",func(e,t=-1){if(this.getCharges&&0===this.getCharges()){const e=this.getName();return i.default.gameMsg(e+" does not have any charges left"),!1}if(t>=0)return this.useFuncs[t].call(this,e);for(let t=0;t<this.useFuncs.length;t++)if(this.useFuncs[t].call(this,e))return!0;return!1}},{name:"addComp",requires:["name"],optional:["addOnUser","area","duration","setters","targetType"],func(e){const n={duration:this.useArgs.duration,effectType:"AddComp",name:this.useArgs.name,target:e,targetType:["actors","items"]};return this.useArgs.area&&(n.area=this.useArgs.area),this.useArgs.setters&&(n.setters=this.useArgs.setters),this.useArgs.addOnUser&&(n.addOnUser=this.useArgs.addOnUser),this.useArgs.targetType&&(n.targetType=this.useArgs.targetType),t.createUseItemComp(this,e,n),!0}},{name:"removeComp",requires:["name"],optional:["all"],func(e){const n={all:this.useArgs.all,effectType:"RemoveComp",name:this.useArgs.name,target:e,targetType:u};return t.createUseItemComp(this,e,n),!0}},{name:"modifyCompValue",requires:["name","set","get","value"],optional:["op"],func(e){const n={target:e,targetType:u,name:this.useArgs.name,set:this.useArgs.set,get:this.useArgs.get,value:this.useArgs.value,effectType:"ModifyCompValue"};return t.createUseItemComp(this,e,n),!0}},{name:"cure",requires:["effect"],func(e){const n=h(e);if(n){const e=this.useArgs.effect.capitalize();return n.has(e)?(n.remove(e),i.default.gameMsg(n.getName()+" seems to be cured of "+e)):i.default.gameMsg(this.getName()+" was wasted"),t.createUseItemComp(this,n),!0}return!1}},{name:"digger",func(e){const n={effectType:"AddComp",name:"Mining",target:e,targetType:["cell"],effectSource:this,setters:{setTarget:"$$target",setItem:"$$item"},addOnUser:!0};return t.createUseItemComp(this,e,n),!0}},{name:"heal",requires:["hp"],func(e){const n=h(e);if(n){const e=l.Dice.create(this.useArgs.hp).roll();if(n.has("Health"))return n.get("Health").addHP(e),t.createUseItemComp(this,n),i.default.gameMsg(n.getName()+" drinks "+this.getName()),!0}else i.default.gameWarn("Cannot see anyone there for using the potion.");return!1}},{name:"poison",requires:["duration","damage","prob"],func(e){const n=l.Dice.parseDieSpec(this.useArgs.damage),s=new l.Dice(n[0],n[1],n[2]),r={target:e,targetType:["actors","items"],name:"Poison",duration:this.useArgs.duration,effectType:"AddComp",setters:{setDamageDie:s,setProb:this.useArgs.prob,setSource:d(this)}};return t.createUseItemComp(this,e,r),!0}},{name:"stun",requires:["duration"],func(e){const n=h(e);if(n){const e=function(e){const t=l.Dice.parseDieSpec(e);return new l.Dice(t[0],t[1],t[2]).roll()}(this.useArgs.duration),s=new c.Stun,r=new c.Expiration;r.addEffect(s,e);const a=d(this);return s.setSource(a),n.add(s),n.add(r),t.createUseItemComp(this,n),i.default.gameMsg(n.getName()+" is stunned by "+this.getName()),!0}return!1}},{name:"modifyStat",requires:["statName","value"],func(e){const n={target:e,targetType:["actors"],name:"Stats",set:"set"+this.useArgs.statName.capitalize(),get:"get"+this.useArgs.statName.capitalize(),value:this.useArgs.value,effectType:"ModifyCompValue"};return t.createUseItemComp(this,e,n),!0}},{name:"addEntity",requires:["entityName"],optional:["duration","endMsg"],func(e){const n={target:e,targetType:["cell"],entityName:this.useArgs.entityName,effectType:"AddEntity",duration:this.useArgs.duration,endMsg:this.useArgs.endMsg};return t.createUseItemComp(this,e,n),!0}},{name:"addElement",requires:["elementName"],optional:["duration","numAllowed","successMsg","failureMsg","successCheck","setters"],func(e){const n={target:e,targetType:["cell"],elementName:this.useArgs.elementName,effectType:"AddElement",duration:this.useArgs.duration,numAllowed:this.useArgs.numAllowed||1,successMsg:this.useArgs.successMsg,successCheck:this.useArgs.successCheck,failureMsg:this.useArgs.failureMsg,setters:this.useArgs.setters};return t.createUseItemComp(this,e,n),!0}},{name:"removeElement",requires:["elementName"],optional:["successMsg","failureMsg"],func(e){const n={target:e,targetType:["cell"],elementName:this.useArgs.elementName,effectType:"RemoveElement",successMsg:this.useArgs.successMsg,failureMsg:this.useArgs.failureMsg};return t.createUseItemComp(this,e,n),!0}}]}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getNewFgColor=t.colorsTooClose=t.ColorMap=t.Colors=void 0,t.Colors={},t.Colors.race={},t.Colors.race.animal={bg:"Brown"},t.Colors.race.avianfolk={bg:"GreenYellow"},t.Colors.race.bearfolk={bg:"GreenYellow"},t.Colors.race.catfolk={bg:"GreenYellow"},t.Colors.race.dark={bg:"Brown"},t.Colors.race.dogfolk={bg:"GreenYellow"},t.Colors.race.dwarven={fg:"White",bg:"Brown"},t.Colors.race.goblin={bg:"GreenYellow"},t.Colors.race.human={bg:"Brown"},t.Colors.race.hyrkhian={bg:"Brown"},t.Colors.race.hyrm={bg:"Brown"},t.Colors.race.spirit={bg:"White"},t.Colors.race.undead={bg:"Black"},t.Colors.race.wildling={bg:"Brown"},t.Colors.race.wolfclan={bg:"Brown"},t.Colors.role={},t.Colors.role.archer="Yellow",t.Colors.role.berserker="Pink",t.Colors.role.commander="Yellow",t.Colors.role.elite="Cyan",t.Colors.role.fighter="Blue",t.Colors.role.king="Red",t.Colors.role.mage="Purple",t.Colors.role.slinger="Purple",t.ColorMap={"#000000":{hex:"#000000",name:"black",rgb:[0,0,0]},black:{hex:"#000000",name:"black",rgb:[0,0,0]},"#C0C0C0":{hex:"#C0C0C0",name:"silver",rgb:[192,192,192]},silver:{hex:"#C0C0C0",name:"silver",rgb:[192,192,192]},"#808080":{hex:"#808080",name:"grey",rgb:[128,128,128]},gray:{hex:"#808080",name:"gray",rgb:[128,128,128]},"#FFFFFF":{hex:"#FFFFFF",name:"white",rgb:[255,255,255]},white:{hex:"#FFFFFF",name:"white",rgb:[255,255,255]},"#800000":{hex:"#800000",name:"maroon",rgb:[128,0,0]},maroon:{hex:"#800000",name:"maroon",rgb:[128,0,0]},"#FF0000":{hex:"#FF0000",name:"red",rgb:[255,0,0]},red:{hex:"#FF0000",name:"red",rgb:[255,0,0]},"#800080":{hex:"#800080",name:"purple",rgb:[128,0,128]},purple:{hex:"#800080",name:"purple",rgb:[128,0,128]},"#FF00FF":{hex:"#FF00FF",name:"magenta",rgb:[255,0,255]},fuchsia:{hex:"#FF00FF",name:"fuchsia",rgb:[255,0,255]},"#008000":{hex:"#008000",name:"green",rgb:[0,128,0]},green:{hex:"#008000",name:"green",rgb:[0,128,0]},"#00FF00":{hex:"#00FF00",name:"lime",rgb:[0,255,0]},lime:{hex:"#00FF00",name:"lime",rgb:[0,255,0]},"#808000":{hex:"#808000",name:"olive",rgb:[128,128,0]},olive:{hex:"#808000",name:"olive",rgb:[128,128,0]},"#FFFF00":{hex:"#FFFF00",name:"yellow",rgb:[255,255,0]},yellow:{hex:"#FFFF00",name:"yellow",rgb:[255,255,0]},"#000080":{hex:"#000080",name:"navy",rgb:[0,0,128]},navy:{hex:"#000080",name:"navy",rgb:[0,0,128]},"#0000FF":{hex:"#0000FF",name:"blue",rgb:[0,0,255]},blue:{hex:"#0000FF",name:"blue",rgb:[0,0,255]},"#008080":{hex:"#008080",name:"teal",rgb:[0,128,128]},teal:{hex:"#008080",name:"teal",rgb:[0,128,128]},"#00FFFF":{hex:"#00FFFF",name:"cyan",rgb:[0,255,255]},aqua:{hex:"#00FFFF",name:"aqua",rgb:[0,255,255]},"#F0F8FF":{hex:"#F0F8FF",name:"aliceblue",rgb:[240,248,255]},aliceblue:{hex:"#F0F8FF",name:"aliceblue",rgb:[240,248,255]},"#FAEBD7":{hex:"#FAEBD7",name:"antiquewhite",rgb:[250,235,215]},antiquewhite:{hex:"#FAEBD7",name:"antiquewhite",rgb:[250,235,215]},"#7FFFD4":{hex:"#7FFFD4",name:"aquamarine",rgb:[127,255,212]},aquamarine:{hex:"#7FFFD4",name:"aquamarine",rgb:[127,255,212]},"#F0FFFF":{hex:"#F0FFFF",name:"azure",rgb:[240,255,255]},azure:{hex:"#F0FFFF",name:"azure",rgb:[240,255,255]},"#F5F5DC":{hex:"#F5F5DC",name:"beige",rgb:[245,245,220]},beige:{hex:"#F5F5DC",name:"beige",rgb:[245,245,220]},"#FFE4C4":{hex:"#FFE4C4",name:"bisque",rgb:[255,228,196]},bisque:{hex:"#FFE4C4",name:"bisque",rgb:[255,228,196]},"#FFEBCD":{hex:"#FFEBCD",name:"blanchedalmond",rgb:[255,235,205]},blanchedalmond:{hex:"#FFEBCD",name:"blanchedalmond",rgb:[255,235,205]},"#8A2BE2":{hex:"#8A2BE2",name:"blueviolet",rgb:[138,43,226]},blueviolet:{hex:"#8A2BE2",name:"blueviolet",rgb:[138,43,226]},"#A52A2A":{hex:"#A52A2A",name:"brown",rgb:[165,42,42]},brown:{hex:"#A52A2A",name:"brown",rgb:[165,42,42]},"#DEB887":{hex:"#DEB887",name:"burlywood",rgb:[222,184,135]},burlywood:{hex:"#DEB887",name:"burlywood",rgb:[222,184,135]},"#5F9EA0":{hex:"#5F9EA0",name:"cadetblue",rgb:[95,158,160]},cadetblue:{hex:"#5F9EA0",name:"cadetblue",rgb:[95,158,160]},"#7FFF00":{hex:"#7FFF00",name:"chartreuse",rgb:[127,255,0]},chartreuse:{hex:"#7FFF00",name:"chartreuse",rgb:[127,255,0]},"#D2691E":{hex:"#D2691E",name:"chocolate",rgb:[210,105,30]},chocolate:{hex:"#D2691E",name:"chocolate",rgb:[210,105,30]},"#FF7F50":{hex:"#FF7F50",name:"coral",rgb:[255,127,80]},coral:{hex:"#FF7F50",name:"coral",rgb:[255,127,80]},"#6495ED":{hex:"#6495ED",name:"cornflowerblue",rgb:[100,149,237]},cornflowerblue:{hex:"#6495ED",name:"cornflowerblue",rgb:[100,149,237]},"#FFF8DC":{hex:"#FFF8DC",name:"cornsilk",rgb:[255,248,220]},cornsilk:{hex:"#FFF8DC",name:"cornsilk",rgb:[255,248,220]},"#DC143C":{hex:"#DC143C",name:"crimson",rgb:[220,20,60]},crimson:{hex:"#DC143C",name:"crimson",rgb:[220,20,60]},cyan:{hex:"#00FFFF",name:"cyan",rgb:[0,255,255]},"#00008B":{hex:"#00008B",name:"darkblue",rgb:[0,0,139]},darkblue:{hex:"#00008B",name:"darkblue",rgb:[0,0,139]},"#008B8B":{hex:"#008B8B",name:"darkcyan",rgb:[0,139,139]},darkcyan:{hex:"#008B8B",name:"darkcyan",rgb:[0,139,139]},"#B8860B":{hex:"#B8860B",name:"darkgoldenrod",rgb:[184,134,11]},darkgoldenrod:{hex:"#B8860B",name:"darkgoldenrod",rgb:[184,134,11]},"#A9A9A9":{hex:"#A9A9A9",name:"darkgrey",rgb:[169,169,169]},darkgray:{hex:"#A9A9A9",name:"darkgray",rgb:[169,169,169]},"#006400":{hex:"#006400",name:"darkgreen",rgb:[0,100,0]},darkgreen:{hex:"#006400",name:"darkgreen",rgb:[0,100,0]},darkgrey:{hex:"#A9A9A9",name:"darkgrey",rgb:[169,169,169]},"#BDB76B":{hex:"#BDB76B",name:"darkkhaki",rgb:[189,183,107]},darkkhaki:{hex:"#BDB76B",name:"darkkhaki",rgb:[189,183,107]},"#8B008B":{hex:"#8B008B",name:"darkmagenta",rgb:[139,0,139]},darkmagenta:{hex:"#8B008B",name:"darkmagenta",rgb:[139,0,139]},"#556B2F":{hex:"#556B2F",name:"darkolivegreen",rgb:[85,107,47]},darkolivegreen:{hex:"#556B2F",name:"darkolivegreen",rgb:[85,107,47]},"#FF8C00":{hex:"#FF8C00",name:"darkorange",rgb:[255,140,0]},darkorange:{hex:"#FF8C00",name:"darkorange",rgb:[255,140,0]},"#9932CC":{hex:"#9932CC",name:"darkorchid",rgb:[153,50,204]},darkorchid:{hex:"#9932CC",name:"darkorchid",rgb:[153,50,204]},"#8B0000":{hex:"#8B0000",name:"darkred",rgb:[139,0,0]},darkred:{hex:"#8B0000",name:"darkred",rgb:[139,0,0]},"#E9967A":{hex:"#E9967A",name:"darksalmon",rgb:[233,150,122]},darksalmon:{hex:"#E9967A",name:"darksalmon",rgb:[233,150,122]},"#8FBC8F":{hex:"#8FBC8F",name:"darkseagreen",rgb:[143,188,143]},darkseagreen:{hex:"#8FBC8F",name:"darkseagreen",rgb:[143,188,143]},"#483D8B":{hex:"#483D8B",name:"darkslateblue",rgb:[72,61,139]},darkslateblue:{hex:"#483D8B",name:"darkslateblue",rgb:[72,61,139]},"#2F4F4F":{hex:"#2F4F4F",name:"darkslategrey",rgb:[47,79,79]},darkslategray:{hex:"#2F4F4F",name:"darkslategray",rgb:[47,79,79]},darkslategrey:{hex:"#2F4F4F",name:"darkslategrey",rgb:[47,79,79]},"#00CED1":{hex:"#00CED1",name:"darkturquoise",rgb:[0,206,209]},darkturquoise:{hex:"#00CED1",name:"darkturquoise",rgb:[0,206,209]},"#9400D3":{hex:"#9400D3",name:"darkviolet",rgb:[148,0,211]},darkviolet:{hex:"#9400D3",name:"darkviolet",rgb:[148,0,211]},"#FF1493":{hex:"#FF1493",name:"deeppink",rgb:[255,20,147]},deeppink:{hex:"#FF1493",name:"deeppink",rgb:[255,20,147]},"#00BFFF":{hex:"#00BFFF",name:"deepskyblue",rgb:[0,191,255]},deepskyblue:{hex:"#00BFFF",name:"deepskyblue",rgb:[0,191,255]},"#696969":{hex:"#696969",name:"dimgrey",rgb:[105,105,105]},dimgray:{hex:"#696969",name:"dimgray",rgb:[105,105,105]},dimgrey:{hex:"#696969",name:"dimgrey",rgb:[105,105,105]},"#1E90FF":{hex:"#1E90FF",name:"dodgerblue",rgb:[30,144,255]},dodgerblue:{hex:"#1E90FF",name:"dodgerblue",rgb:[30,144,255]},"#B22222":{hex:"#B22222",name:"firebrick",rgb:[178,34,34]},firebrick:{hex:"#B22222",name:"firebrick",rgb:[178,34,34]},"#FFFAF0":{hex:"#FFFAF0",name:"floralwhite",rgb:[255,250,240]},floralwhite:{hex:"#FFFAF0",name:"floralwhite",rgb:[255,250,240]},"#228B22":{hex:"#228B22",name:"forestgreen",rgb:[34,139,34]},forestgreen:{hex:"#228B22",name:"forestgreen",rgb:[34,139,34]},"#DCDCDC":{hex:"#DCDCDC",name:"gainsboro",rgb:[220,220,220]},gainsboro:{hex:"#DCDCDC",name:"gainsboro",rgb:[220,220,220]},"#F8F8FF":{hex:"#F8F8FF",name:"ghostwhite",rgb:[248,248,255]},ghostwhite:{hex:"#F8F8FF",name:"ghostwhite",rgb:[248,248,255]},"#FFD700":{hex:"#FFD700",name:"gold",rgb:[255,215,0]},gold:{hex:"#FFD700",name:"gold",rgb:[255,215,0]},"#DAA520":{hex:"#DAA520",name:"goldenrod",rgb:[218,165,32]},goldenrod:{hex:"#DAA520",name:"goldenrod",rgb:[218,165,32]},"#ADFF2F":{hex:"#ADFF2F",name:"greenyellow",rgb:[173,255,47]},greenyellow:{hex:"#ADFF2F",name:"greenyellow",rgb:[173,255,47]},grey:{hex:"#808080",name:"grey",rgb:[128,128,128]},"#F0FFF0":{hex:"#F0FFF0",name:"honeydew",rgb:[240,255,240]},honeydew:{hex:"#F0FFF0",name:"honeydew",rgb:[240,255,240]},"#FF69B4":{hex:"#FF69B4",name:"hotpink",rgb:[255,105,180]},hotpink:{hex:"#FF69B4",name:"hotpink",rgb:[255,105,180]},"#CD5C5C":{hex:"#CD5C5C",name:"indianred",rgb:[205,92,92]},indianred:{hex:"#CD5C5C",name:"indianred",rgb:[205,92,92]},"#4B0082":{hex:"#4B0082",name:"indigo",rgb:[75,0,130]},indigo:{hex:"#4B0082",name:"indigo",rgb:[75,0,130]},"#FFFFF0":{hex:"#FFFFF0",name:"ivory",rgb:[255,255,240]},ivory:{hex:"#FFFFF0",name:"ivory",rgb:[255,255,240]},"#F0E68C":{hex:"#F0E68C",name:"khaki",rgb:[240,230,140]},khaki:{hex:"#F0E68C",name:"khaki",rgb:[240,230,140]},"#E6E6FA":{hex:"#E6E6FA",name:"lavender",rgb:[230,230,250]},lavender:{hex:"#E6E6FA",name:"lavender",rgb:[230,230,250]},"#FFF0F5":{hex:"#FFF0F5",name:"lavenderblush",rgb:[255,240,245]},lavenderblush:{hex:"#FFF0F5",name:"lavenderblush",rgb:[255,240,245]},"#7CFC00":{hex:"#7CFC00",name:"lawngreen",rgb:[124,252,0]},lawngreen:{hex:"#7CFC00",name:"lawngreen",rgb:[124,252,0]},"#FFFACD":{hex:"#FFFACD",name:"lemonchiffon",rgb:[255,250,205]},lemonchiffon:{hex:"#FFFACD",name:"lemonchiffon",rgb:[255,250,205]},"#ADD8E6":{hex:"#ADD8E6",name:"lightblue",rgb:[173,216,230]},lightblue:{hex:"#ADD8E6",name:"lightblue",rgb:[173,216,230]},"#F08080":{hex:"#F08080",name:"lightcoral",rgb:[240,128,128]},lightcoral:{hex:"#F08080",name:"lightcoral",rgb:[240,128,128]},"#E0FFFF":{hex:"#E0FFFF",name:"lightcyan",rgb:[224,255,255]},lightcyan:{hex:"#E0FFFF",name:"lightcyan",rgb:[224,255,255]},"#FAFAD2":{hex:"#FAFAD2",name:"lightgoldenrodyellow",rgb:[250,250,210]},lightgoldenrodyellow:{hex:"#FAFAD2",name:"lightgoldenrodyellow",rgb:[250,250,210]},"#D3D3D3":{hex:"#D3D3D3",name:"lightgrey",rgb:[211,211,211]},lightgray:{hex:"#D3D3D3",name:"lightgray",rgb:[211,211,211]},"#90EE90":{hex:"#90EE90",name:"lightgreen",rgb:[144,238,144]},lightgreen:{hex:"#90EE90",name:"lightgreen",rgb:[144,238,144]},lightgrey:{hex:"#D3D3D3",name:"lightgrey",rgb:[211,211,211]},"#FFB6C1":{hex:"#FFB6C1",name:"lightpink",rgb:[255,182,193]},lightpink:{hex:"#FFB6C1",name:"lightpink",rgb:[255,182,193]},"#FFA07A":{hex:"#FFA07A",name:"lightsalmon",rgb:[255,160,122]},lightsalmon:{hex:"#FFA07A",name:"lightsalmon",rgb:[255,160,122]},"#20B2AA":{hex:"#20B2AA",name:"lightseagreen",rgb:[32,178,170]},lightseagreen:{hex:"#20B2AA",name:"lightseagreen",rgb:[32,178,170]},"#87CEFA":{hex:"#87CEFA",name:"lightskyblue",rgb:[135,206,250]},lightskyblue:{hex:"#87CEFA",name:"lightskyblue",rgb:[135,206,250]},"#778899":{hex:"#778899",name:"lightslategrey",rgb:[119,136,153]},lightslategray:{hex:"#778899",name:"lightslategray",rgb:[119,136,153]},lightslategrey:{hex:"#778899",name:"lightslategrey",rgb:[119,136,153]},"#B0C4DE":{hex:"#B0C4DE",name:"lightsteelblue",rgb:[176,196,222]},lightsteelblue:{hex:"#B0C4DE",name:"lightsteelblue",rgb:[176,196,222]},"#FFFFE0":{hex:"#FFFFE0",name:"lightyellow",rgb:[255,255,224]},lightyellow:{hex:"#FFFFE0",name:"lightyellow",rgb:[255,255,224]},"#32CD32":{hex:"#32CD32",name:"limegreen",rgb:[50,205,50]},limegreen:{hex:"#32CD32",name:"limegreen",rgb:[50,205,50]},"#FAF0E6":{hex:"#FAF0E6",name:"linen",rgb:[250,240,230]},linen:{hex:"#FAF0E6",name:"linen",rgb:[250,240,230]},magenta:{hex:"#FF00FF",name:"magenta",rgb:[255,0,255]},"#66CDAA":{hex:"#66CDAA",name:"mediumaquamarine",rgb:[102,205,170]},mediumaquamarine:{hex:"#66CDAA",name:"mediumaquamarine",rgb:[102,205,170]},"#0000CD":{hex:"#0000CD",name:"mediumblue",rgb:[0,0,205]},mediumblue:{hex:"#0000CD",name:"mediumblue",rgb:[0,0,205]},"#BA55D3":{hex:"#BA55D3",name:"mediumorchid",rgb:[186,85,211]},mediumorchid:{hex:"#BA55D3",name:"mediumorchid",rgb:[186,85,211]},"#9370DB":{hex:"#9370DB",name:"mediumpurple",rgb:[147,112,219]},mediumpurple:{hex:"#9370DB",name:"mediumpurple",rgb:[147,112,219]},"#3CB371":{hex:"#3CB371",name:"mediumseagreen",rgb:[60,179,113]},mediumseagreen:{hex:"#3CB371",name:"mediumseagreen",rgb:[60,179,113]},"#7B68EE":{hex:"#7B68EE",name:"mediumslateblue",rgb:[123,104,238]},mediumslateblue:{hex:"#7B68EE",name:"mediumslateblue",rgb:[123,104,238]},"#00FA9A":{hex:"#00FA9A",name:"mediumspringgreen",rgb:[0,250,154]},mediumspringgreen:{hex:"#00FA9A",name:"mediumspringgreen",rgb:[0,250,154]},"#48D1CC":{hex:"#48D1CC",name:"mediumturquoise",rgb:[72,209,204]},mediumturquoise:{hex:"#48D1CC",name:"mediumturquoise",rgb:[72,209,204]},"#C71585":{hex:"#C71585",name:"mediumvioletred",rgb:[199,21,133]},mediumvioletred:{hex:"#C71585",name:"mediumvioletred",rgb:[199,21,133]},"#191970":{hex:"#191970",name:"midnightblue",rgb:[25,25,112]},midnightblue:{hex:"#191970",name:"midnightblue",rgb:[25,25,112]},"#F5FFFA":{hex:"#F5FFFA",name:"mintcream",rgb:[245,255,250]},mintcream:{hex:"#F5FFFA",name:"mintcream",rgb:[245,255,250]},"#FFE4E1":{hex:"#FFE4E1",name:"mistyrose",rgb:[255,228,225]},mistyrose:{hex:"#FFE4E1",name:"mistyrose",rgb:[255,228,225]},"#FFE4B5":{hex:"#FFE4B5",name:"moccasin",rgb:[255,228,181]},moccasin:{hex:"#FFE4B5",name:"moccasin",rgb:[255,228,181]},"#FFDEAD":{hex:"#FFDEAD",name:"navajowhite",rgb:[255,222,173]},navajowhite:{hex:"#FFDEAD",name:"navajowhite",rgb:[255,222,173]},"#FDF5E6":{hex:"#FDF5E6",name:"oldlace",rgb:[253,245,230]},oldlace:{hex:"#FDF5E6",name:"oldlace",rgb:[253,245,230]},"#6B8E23":{hex:"#6B8E23",name:"olivedrab",rgb:[107,142,35]},olivedrab:{hex:"#6B8E23",name:"olivedrab",rgb:[107,142,35]},"#FFA500":{hex:"#FFA500",name:"orange",rgb:[255,165,0]},orange:{hex:"#FFA500",name:"orange",rgb:[255,165,0]},"#FF4500":{hex:"#FF4500",name:"orangered",rgb:[255,69,0]},orangered:{hex:"#FF4500",name:"orangered",rgb:[255,69,0]},"#DA70D6":{hex:"#DA70D6",name:"orchid",rgb:[218,112,214]},orchid:{hex:"#DA70D6",name:"orchid",rgb:[218,112,214]},"#EEE8AA":{hex:"#EEE8AA",name:"palegoldenrod",rgb:[238,232,170]},palegoldenrod:{hex:"#EEE8AA",name:"palegoldenrod",rgb:[238,232,170]},"#98FB98":{hex:"#98FB98",name:"palegreen",rgb:[152,251,152]},palegreen:{hex:"#98FB98",name:"palegreen",rgb:[152,251,152]},"#AFEEEE":{hex:"#AFEEEE",name:"paleturquoise",rgb:[175,238,238]},paleturquoise:{hex:"#AFEEEE",name:"paleturquoise",rgb:[175,238,238]},"#DB7093":{hex:"#DB7093",name:"palevioletred",rgb:[219,112,147]},palevioletred:{hex:"#DB7093",name:"palevioletred",rgb:[219,112,147]},"#FFEFD5":{hex:"#FFEFD5",name:"papayawhip",rgb:[255,239,213]},papayawhip:{hex:"#FFEFD5",name:"papayawhip",rgb:[255,239,213]},"#FFDAB9":{hex:"#FFDAB9",name:"peachpuff",rgb:[255,218,185]},peachpuff:{hex:"#FFDAB9",name:"peachpuff",rgb:[255,218,185]},"#CD853F":{hex:"#CD853F",name:"peru",rgb:[205,133,63]},peru:{hex:"#CD853F",name:"peru",rgb:[205,133,63]},"#FFC0CB":{hex:"#FFC0CB",name:"pink",rgb:[255,192,203]},pink:{hex:"#FFC0CB",name:"pink",rgb:[255,192,203]},"#DDA0DD":{hex:"#DDA0DD",name:"plum",rgb:[221,160,221]},plum:{hex:"#DDA0DD",name:"plum",rgb:[221,160,221]},"#B0E0E6":{hex:"#B0E0E6",name:"powderblue",rgb:[176,224,230]},powderblue:{hex:"#B0E0E6",name:"powderblue",rgb:[176,224,230]},"#BC8F8F":{hex:"#BC8F8F",name:"rosybrown",rgb:[188,143,143]},rosybrown:{hex:"#BC8F8F",name:"rosybrown",rgb:[188,143,143]},"#4169E1":{hex:"#4169E1",name:"royalblue",rgb:[65,105,225]},royalblue:{hex:"#4169E1",name:"royalblue",rgb:[65,105,225]},"#8B4513":{hex:"#8B4513",name:"saddlebrown",rgb:[139,69,19]},saddlebrown:{hex:"#8B4513",name:"saddlebrown",rgb:[139,69,19]},"#FA8072":{hex:"#FA8072",name:"salmon",rgb:[250,128,114]},salmon:{hex:"#FA8072",name:"salmon",rgb:[250,128,114]},"#F4A460":{hex:"#F4A460",name:"sandybrown",rgb:[244,164,96]},sandybrown:{hex:"#F4A460",name:"sandybrown",rgb:[244,164,96]},"#2E8B57":{hex:"#2E8B57",name:"seagreen",rgb:[46,139,87]},seagreen:{hex:"#2E8B57",name:"seagreen",rgb:[46,139,87]},"#FFF5EE":{hex:"#FFF5EE",name:"seashell",rgb:[255,245,238]},seashell:{hex:"#FFF5EE",name:"seashell",rgb:[255,245,238]},"#A0522D":{hex:"#A0522D",name:"sienna",rgb:[160,82,45]},sienna:{hex:"#A0522D",name:"sienna",rgb:[160,82,45]},"#87CEEB":{hex:"#87CEEB",name:"skyblue",rgb:[135,206,235]},skyblue:{hex:"#87CEEB",name:"skyblue",rgb:[135,206,235]},"#6A5ACD":{hex:"#6A5ACD",name:"slateblue",rgb:[106,90,205]},slateblue:{hex:"#6A5ACD",name:"slateblue",rgb:[106,90,205]},"#708090":{hex:"#708090",name:"slategrey",rgb:[112,128,144]},slategray:{hex:"#708090",name:"slategray",rgb:[112,128,144]},slategrey:{hex:"#708090",name:"slategrey",rgb:[112,128,144]},"#FFFAFA":{hex:"#FFFAFA",name:"snow",rgb:[255,250,250]},snow:{hex:"#FFFAFA",name:"snow",rgb:[255,250,250]},"#00FF7F":{hex:"#00FF7F",name:"springgreen",rgb:[0,255,127]},springgreen:{hex:"#00FF7F",name:"springgreen",rgb:[0,255,127]},"#4682B4":{hex:"#4682B4",name:"steelblue",rgb:[70,130,180]},steelblue:{hex:"#4682B4",name:"steelblue",rgb:[70,130,180]},"#D2B48C":{hex:"#D2B48C",name:"tan",rgb:[210,180,140]},tan:{hex:"#D2B48C",name:"tan",rgb:[210,180,140]},"#D8BFD8":{hex:"#D8BFD8",name:"thistle",rgb:[216,191,216]},thistle:{hex:"#D8BFD8",name:"thistle",rgb:[216,191,216]},"#FF6347":{hex:"#FF6347",name:"tomato",rgb:[255,99,71]},tomato:{hex:"#FF6347",name:"tomato",rgb:[255,99,71]},"#40E0D0":{hex:"#40E0D0",name:"turquoise",rgb:[64,224,208]},turquoise:{hex:"#40E0D0",name:"turquoise",rgb:[64,224,208]},"#EE82EE":{hex:"#EE82EE",name:"violet",rgb:[238,130,238]},violet:{hex:"#EE82EE",name:"violet",rgb:[238,130,238]},"#F5DEB3":{hex:"#F5DEB3",name:"wheat",rgb:[245,222,179]},wheat:{hex:"#F5DEB3",name:"wheat",rgb:[245,222,179]},"#F5F5F5":{hex:"#F5F5F5",name:"whitesmoke",rgb:[245,245,245]},whitesmoke:{hex:"#F5F5F5",name:"whitesmoke",rgb:[245,245,245]},"#9ACD32":{hex:"#9ACD32",name:"yellowgreen",rgb:[154,205,50]},yellowgreen:{hex:"#9ACD32",name:"yellowgreen",rgb:[154,205,50]}};function s(e){return Math.sqrt(.299*Math.pow(e[0],2)+.587*Math.pow(e[1],2)+.114*Math.pow(e[2],2))}t.colorsTooClose=function(e,n){if(e===n)return!0;if(!t.ColorMap[e.toLowerCase()])throw Error(`Color ${e} not usable`);if(!t.ColorMap[n.toLowerCase()])throw Error(`Color ${n} not usable`);const r=t.ColorMap[e.toLowerCase()].rgb,a=t.ColorMap[n.toLowerCase()].rgb,o=s(r),i=s(a);return Math.abs(o-i)<36},t.getNewFgColor=function(e,n){const r=t.ColorMap[e.toLowerCase()].rgb,a=t.ColorMap[n.toLowerCase()].rgb,o=s(r),i=s(a);if(Math.abs(o-i)<36)return i<128?"White":"Black"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ELEV=void 0;const s=n(73);t.ELEV=["โ",":","โซถ"];const r=["โผ","โ","โ"],a=[{name:"bed",className:"cell-element-bed",char:"=",msg:{onEnter:"There is a bed here for resting"},addComp:["Indoor"]},{name:"bridge",className:"cell-element-bridge",char:"=",msg:{onEnter:"You are standing on a bridge."},addComp:[{comp:"Terrain",func:{setMods:[s.defensePenalty(.5,["Flying"])]}}]},{name:"shallow chasm",className:"cell-element-chasm",char:r[0],addComp:["Impassable"],z:-1,callbacks:{onRemoveFlyingEntity:{addComp:[{comp:"Paralysis"}]},onAddFlyingEntity:{removeComp:[{comp:"Paralysis"}]}}},{name:"chasm",className:"cell-element-chasm",char:r[1],addComp:["Impassable"],z:-2,callbacks:{onRemoveFlyingEntity:{addComp:[{comp:"Paralysis"}]},onAddFlyingEntity:{removeComp:[{comp:"Paralysis"}]}}},{name:"deep chasm",className:"cell-element-chasm",char:r[2],addComp:["Impassable"],z:-10},{name:"grass",className:"cell-element-grass",char:'"',msg:{onEnter:"You see some grass."},addComp:[{comp:"Terrain",func:{setMods:[s.speedPenalty(.1,["Flying"])]}}]},{name:"snowy grass",className:"cell-element-snowy-grass",char:'"',msg:{onEnter:"You see some snow-covered grass."},addComp:[{comp:"Terrain",func:{setMods:[s.speedPenalty(.15,["Flying"])]}}]},{name:"highrock",className:"cell-element-highrock",char:"^",addComp:["Impassable","Opaque"]},{name:"floor",className:"cell-element-floor",char:".",addComp:["Tillable"]},{name:"floorcastle",className:"cell-element-floor-castle",char:".",addComp:["Indoor"]},{name:"floordungeon",className:"cell-element-floor-dungeon",char:".",addComp:["Indoor"]},{name:"floorcave",className:"cell-element-floor-cave",char:".",addComp:["Indoor"]},{name:"floorcrypt",className:"cell-element-floor-crypt",char:".",addComp:["Indoor"]},{name:"floorhouse",className:"cell-element-floor-house",char:".",addComp:["Indoor"]},{name:"floorwooden",className:"cell-element-floor-wooden",char:".",addComp:["Indoor"]},{name:"fort",className:"cell-element-fort",char:"#",addComp:["Impassable"]},{name:"lava",className:"cell-element-lava",char:"~",addComp:["Impassable"]},{name:"path",className:"cell-element-path",char:".",z:1},{name:"road",className:"cell-element-road",char:".",msg:{onEnter:"You tread lightly on the road."}},{name:"sky",className:"cell-element-sky",char:"~",addComp:["Impassable"]},{name:"light snow",className:"cell-element-light-snow",char:".",addComp:["Snowy"],msg:{onEnter:"A thin layer of snow is on the ground"}},{name:"light snow with tracks",className:"cell-element-light-snow-tracks",char:".",addComp:["Snowy"],msg:{onEnter:"Someone has traversed this thin crust of snow"}},{name:"snow",className:"cell-element-snow",char:".",msg:{onEnter:"Ground is covered with snow."},addComp:["Snowy",{comp:"Terrain",func:{setMods:[s.speedPenalty(.1,["Flying","SnowWalk"])]}}]},{name:"snow with tracks",className:"cell-element-snow-tracks",char:".",addComp:["Snowy"],msg:{onEnter:"Someone has left their tracks on snow"}},{name:"deep snow",className:"cell-element-deep-snow",char:".",msg:{onEnter:"Snow is deep and difficult to traverse here"},addComp:["Snowy",{comp:"Terrain",func:{setMods:[s.speedPenalty(.25,["Flying","SnowWalk"])]}}]},{name:"deep snow with tracks",className:"cell-element-deep-snow-tracks",char:".",msg:{onEnter:"Snow is deep, but there are some tracks here"},addComp:["Snowy",{comp:"Terrain",func:{setMods:[s.speedPenalty(.1,["Flying","SnowWalk"])]}}]},{name:"cliff",className:"cell-element-stone",char:t.ELEV[0],z:1,msg:{onEnter:"Difficult rocky terrain slows you down."},addComp:[{comp:"Terrain",func:{setMods:[s.speedPenalty(.25,["Flying"])]}}]},{name:"stone",className:"cell-element-stone",char:t.ELEV[1],z:2,msg:{onEnter:"Difficult rocky terrain slows you down."},addComp:[{comp:"Terrain",func:{setMods:[s.speedPenalty(.25,["Flying"])]}}]},{name:"steep cliff",className:"cell-element-stone",char:t.ELEV[2],z:3,msg:{onEnter:"Difficult rocky terrain slows you down."},addComp:[{comp:"Terrain",func:{setMods:[s.speedPenalty(.25,["Flying"])]}}]},{name:"snowy cliff",className:"cell-element-snow-tree",char:t.ELEV[0],z:1,msg:{onEnter:"Difficult and slippery snowy terrain slows you down."},addComp:["Snowy",{comp:"Terrain",func:{setMods:[s.speedPenalty(.35,["Flying"])]}}]},{name:"snow-covered stone",className:"cell-element-snow-tree",char:t.ELEV[1],z:2,msg:{onEnter:"Difficult and slippery snowy terrain slows you down."},addComp:["Snowy",{comp:"Terrain",func:{setMods:[s.speedPenalty(.35,["Flying"])]}}]},{name:"frozen steep cliff",className:"cell-element-snow-tree",char:t.ELEV[2],z:3,msg:{onEnter:"Difficult and slippery snowy terrain slows you down."},addComp:["Snowy",{comp:"Terrain",func:{setMods:[s.speedPenalty(.35,["Flying"])]}}]},{name:"tree",className:"cell-element-tree",char:"T",addComp:["Opaque"],msg:{onEnter:"There is a tree here."}},{name:"large tree",className:"cell-element-tree-large",char:"T",addComp:["Impassable","Opaque"],msg:{onEnter:"There is a large tree here."}},{name:"snow-covered tree",className:"cell-element-snow-tree",char:"T",addComp:["Opaque","Snowy"],msg:{onEnter:"There is a snow-covered tree here."}},{name:"large frozen tree",className:"cell-element-tree-large-frozen",char:"T",addComp:["Impassable","Opaque"],msg:{onEnter:"There is a large frozen tree here."}},{name:"iron ore vein",className:"cell-element-iron",new:"XY",char:"~",addComp:[{comp:"Breakable",func:{setHardness:4,setDurability:50}}],callbacks:{onDestroy:{addEntity:{entityName:"iron ore",count:1}}}},{name:"wooden door",className:"cell-element-wall-wooden",char:{isClosed:"+",default:"/"},new:"Door"},{name:"iron door",className:"cell-element-iron",char:{isClosed:"+",default:"/"},new:"Door"},{name:"shallow water",className:"cell-element-water",char:r[0],msg:{onEnter:"Shallow water slows you down slightly"},addComp:[{comp:"Terrain",func:{setMods:[s.speedPenalty(.1,["Flying","Amphibious"]),s.defensePenalty(.1,["Flying","Amphibious"]),s.attackPenalty(.1,["Flying","Amphibious"])]}}],callbacks:{onEnter:{addComp:[{comp:"Drenched",useOld:!0,func:{incrLevel:1}}]}}},{name:"water",className:"cell-element-water",char:r[1],msg:{onEnter:"Water slows you down"},addComp:[{comp:"Terrain",func:{setMods:[s.speedPenalty(.25,["Flying","Amphibious"]),s.defensePenalty(.25,["Flying","Amphibious"]),s.attackPenalty(.25,["Flying","Amphibious"])]}}],callbacks:{onEnter:{addComp:[{comp:"Drenched",useOld:!0,func:{incrLevel:2}}]},onRemoveParalysisEntity:{removeComp:[{comp:"Drowning"}]},onAddParalysisEntity:{addComp:[{comp:"Drowning"}]}}},{name:"deep water",className:"cell-element-water",char:r[2],msg:{onEnter:"Deep water makes moving extremely difficult"},addComp:[{comp:"Terrain",func:{setMods:[s.speedPenalty(.5,["Flying","Amphibious"]),s.defensePenalty(.5,["Flying","Amphibious"]),s.attackPenalty(.5,["Flying","Amphibious"])]}}],callbacks:{onEnter:{addComp:[{comp:"Drenched",useOld:!0,func:{incrLevel:4}}]},onRemoveParalysisEntity:{removeComp:[{comp:"Drowning"}]},onAddParalysisEntity:{addComp:[{comp:"Drowning"}]}}},{name:"frozen shallow water",className:"cell-element-frozen-water",char:r[0],msg:{onEnter:"There is some ice here"},addComp:["Snowy",{comp:"Terrain",func:{setMods:[s.speedPenalty(.15,["Flying"])]}}]},{name:"frozen water",className:"cell-element-frozen-water",char:r[1],msg:{onEnter:"There is some ice here"},addComp:["Snowy",{comp:"Terrain",func:{setMods:[s.speedPenalty(.15,["Flying"])]}}]},{name:"frozen deep water",className:"cell-element-frozen-water",char:r[2],msg:{onEnter:"There is some ice here"},addComp:["Snowy",{comp:"Terrain",func:{setMods:[s.speedPenalty(.15,["Flying"])]}}]},{name:"wallcave",className:"cell-element-wall-cave",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]},{comp:"Breakable",func:{setHardness:4,setDurability:50}}]},{name:"walldungeon",className:"cell-element-wall-dungeon",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]},{comp:"Breakable",func:{setHardness:4,setDurability:75}}]},{name:"wallcrypt",className:"cell-element-wall-crypt",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]},{comp:"Breakable",func:{setHardness:4,setDurability:75}}]},{name:"wallwooden",className:"cell-element-wall-wooden",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]},{comp:"Breakable",func:{setHardness:2,setDurability:25}}]},{name:"wallice",className:"cell-element-wall-ice",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]},{comp:"Breakable",func:{setHardness:8,setDurability:100}}]},{name:"wallcastle",className:"cell-element-wall-castle",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]},{comp:"Breakable",func:{setHardness:8,setDurability:100}}]},{name:"wallruby",className:"style-ruby",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]},{comp:"Breakable",func:{setHardness:16,setDurability:150}}]},{name:"wallvoid",className:"style-void",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]},{comp:"Breakable",func:{setHardness:24,setDurability:200}}]},{name:"wallforium",className:"style-forium",char:"#",addComp:["Opaque",{comp:"Impassable",func:["setAllImpassable"]},{comp:"Breakable",func:{setHardness:32,setDurability:250}}]},{name:"closed window",className:"cell-element-window",char:"+",addComp:["Impassable",{comp:"Breakable",func:{setHardness:1,setDurability:10}}]},{name:"tilled soil",noRandom:!0,className:"cell-element-floor",char:"|"},{name:"planted soil",noRandom:!0,className:"cell-element-floor",char:"+"},{name:"swamp",className:"cell-element-swamp",char:'"',msg:{onEnter:"Swampy terrain makes it more difficult to move"},addComp:[{comp:"Terrain",func:{setMods:[s.speedPenalty(.25,["Flying"])]}}]},{name:"frozen swamp",className:"cell-element-frozen-swamp",char:'"',msg:{onEnter:"Frozen and swampy terrain makes it more difficult to move"},addComp:["Snowy",{comp:"Terrain",func:{setMods:[s.speedPenalty(.15,["Flying"])]}}]},{dontCreate:!0,name:"web",char:"|",className:"cell-element-web"},{dontCreate:!0,name:"slime",char:"|",className:"cell-element-slime"},{dontCreate:!0,name:"hole",char:"^",className:"cell-element-hole"},{dontCreate:!0,name:"mountain",char:"โฐ",className:"cell-element-mountain"},{dontCreate:!0,name:"town",char:"o",className:"cell-element-town"},{dontCreate:!0,name:"battle",char:"X",className:"cell-element-battle"},{dontCreate:!0,name:"cityfort",char:"o",className:"cell-element-fort"},{dontCreate:!0,name:"pathdown",char:"โ",className:"cell-element-stairs"},{dontCreate:!0,name:"wilderness",char:"X",className:"cell-element-tree"}];t.default=a},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Spell=void 0;const i=o(n(4)),l=n(113);Object.defineProperty(t,"Spell",{enumerable:!0,get:function(){return l.Spell}});const c=a(n(11)),u=n(26),h=n(12),d=n(27),p=n(9),f=a(n(16)),m=p.Random.getRNG(),{getDirSpellArgs:g,aiSpellCellEnemy:y,aiSpellCellFriend:v,aiSpellCellSelf:b,addPoisonEffect:_,addFadingActorToCell:E,aiSpellCellDone:S}=l.Spell;l.Spell.DispelMagic=function(){l.Spell.RemoveComponent.call(this,"DispelMagic",8),this.setCompNames("Duration")},i.default.extend2(l.Spell.DispelMagic,l.Spell.RemoveComponent),l.Spell.Charm=function(){l.SpellBase.call(this,"Charm",10),this._dice.duration=u.Dice.create("10d6 + 5")},i.default.extend2(l.Spell.Charm,l.SpellBase),l.Spell.Charm.prototype.cast=function(e){const t=g(this,e),n=new c.SpellCell;t.callback=this.charmCallback.bind(this),n.setArgs(t),e.src.add(n)},l.Spell.Charm.prototype.charmCallback=function(e){const t=e.getSentientActors();if(t&&t.length>0){const e=t[0];let n=1+this.getCasterExpBonus(3);n+=this.getCasterStatBonus("willpower",3);const s=new c.Charm;s.setTargetActor(e.getID()),s.setLevel(n);const r=this.getDuration();c.addToExpirationComp(this.getCaster(),s,r);const a=this.getCaster(),o=`${a.getName()} charms ${e.getName()}`;i.default.gameMsg({cell:a.getCell(),msg:o})}},l.Spell.Charm.prototype.getSelectionObject=function(e){return l.Spell.getSelectionObjectDir(this,e,"Select a direction for charming:")},l.Spell.Charm.prototype.aiShouldCastSpell=function(e,t){return y(e,t)},l.Spell.GraspOfWinter=function(){l.SpellBase.call(this,"Grasp of winter",6),this._dice.damage=u.Dice.create("4d4 + 4")},i.default.extend2(l.Spell.GraspOfWinter,l.SpellBase),l.Spell.GraspOfWinter.prototype.cast=function(e){const t=g(this,e);t.damageType=i.default.DMG.ICE,t.damage=this.getDamage();const n=new c.SpellCell;n.setArgs(t),e.src.add(n)},l.Spell.GraspOfWinter.prototype.getSelectionObject=function(e){return l.Spell.getSelectionObjectDir(this,e,"Select a direction for grasping:")},l.Spell.GraspOfWinter.prototype.aiShouldCastSpell=function(e,t){return y(e,t)},l.Spell.AnimateDead=function(){l.Spell.AddComponent.call(this,"AnimateDead",5),this.setCompName("Undead"),delete this._dice.duration},i.default.extend2(l.Spell.AnimateDead,l.Spell.AddComponent),l.Spell.AnimateDead.prototype.cast=function(e){l.Spell.AddComponent.prototype.cast.call(this,e);const{src:t}=e;t.get("SpellCell").getArgs().callback=this.animateCallback.bind(this)},l.Spell.AnimateDead.prototype.animateCallback=function(e){const t=["Stats","Combat","Experience"],n=this.getCaster();if(!e.hasItems())return;const s=e.getItems().find(e=>/corpse/.test(e.getName()));if(!s&&!n.isPlayer())return void i.default.warn("AnimateDead","animateCallback","No corpses found. Should not have cast the spell at all");const r=s;if(r.has("Undead")){const e=n.getName()+" fails to reanimate undead remains";i.default.gameMsg({cell:n.getCell(),msg:e})}else if(r){const e=h.getParser(),s=r.getActorName();if(!e.hasObj(i.default.TYPE_ACTOR,s)){const e=`${n.getName()} fails to reanimate corpse of ${s}`;return void i.default.gameWarn({cell:n.getCell(),msg:e})}const a=e.createActor(s);a.add(new c.Undead),t.forEach(e=>{const t=r.get(e);a.remove(e),t.changeEntity(a)}),a.get("Named").prepend("undead "),i.default.addCellStyle(i.default.TYPE_ACTOR,a.get("Named").getName(),"cell-actor-undead");const[o,l]=r.getXY(),u=n.getLevel(),d=new c.Created;d.setCreator(n),a.add(d),a.add(new c.Undead),u.removeItem(r,o,l)&&(u.addActor(a,o,l),a.has("NonSentient")||a.addFriend(n))}},l.Spell.AnimateDead.prototype.aiShouldCastSpell=(e,t)=>{const n=e.actor,s=d.Brain.getCellsAroundActor(n).filter(e=>e.hasItems()&&e.getItems().find(e=>"corpse"===e.getType()));if(0===s.length)return!1;const r=m.arrayGetRand(s);return S(n,r,t),!0},l.Spell.Flying=function(){l.Spell.AddComponent.call(this,"Flying",5),this.setCompName("Flying"),this._dice.duration=u.Dice.create("10d5 + 5"),this.aiShouldCastSpell=(e,t)=>v(e,t)},i.default.extend2(l.Spell.Flying,l.Spell.AddComponent),l.Spell.Telepathy=function(){l.Spell.AddComponent.call(this,"Telepathy",5),this.setCompName("Telepathy"),this._dice.duration=u.Dice.create("10d10 + 10"),this.aiShouldCastSpell=(e,t)=>{let n=v(e,t);return n||(n=y(e,t)),n}},i.default.extend2(l.Spell.Telepathy,l.Spell.AddComponent),l.Spell.Telepathy.prototype.cast=function(e){l.Spell.AddComponent.prototype.cast.call(this,e);const{src:t}=e;if(t){const n=t.get("SpellCell").getArgs(),{addComp:s}=n,r=s.comp;if("Telepathy"===r.getType()){const{duration:a}=s,o=r.clone();let i={dir:[0,0],src:this._caster,spell:null};i=g(this,i),i.addComp={comp:o,duration:a},n.postCallback=e=>{r.setSource(t),r.setTarget(e.getSentientActors()[0])},i.postCallback=()=>{o.setSource(r.getSource()),o.setTarget(r.getTarget())};const l=new c.SpellCell;l.setArgs(i),e.src.add(l)}}else{const t=JSON.stringify(e);i.default.err("Spell.Telepathy","cast","No src found in args: "+t)}},l.Spell.Paralysis=function(){l.Spell.AddComponent.call(this,"Paralysis",7),this.setCompName("Paralysis"),this.setDuration(u.Dice.create("1d6 + 2")),this.aiShouldCastSpell=(e,t)=>y(e,t)},i.default.extend2(l.Spell.Paralysis,l.Spell.AddComponent),l.Spell.StunningTouch=function(){l.Spell.AddComponent.call(this,"StunningTouch",7),this.setCompName("Stun"),this.setDuration(u.Dice.create("1d6 + 2")),this.aiShouldCastSpell=(e,t)=>y(e,t)},i.default.extend2(l.Spell.StunningTouch,l.Spell.AddComponent),l.Spell.SpiritForm=function(){l.Spell.AddComponent.call(this,"SpiritForm",10),this.setCompName("Ethereal"),this.setDuration(u.Dice.create("1d6 + 4")),this.aiShouldCastSpell=(e,t)=>v(e,t)},i.default.extend2(l.Spell.SpiritForm,l.Spell.AddComponent),l.Spell.FrostBolt=function(){l.Spell.BoltBase.call(this,"Frost bolt",5),this.setDice("damage",u.Dice.create("4d4 + 4")),this.setRange(5),this.damageType=i.default.DMG.ICE},i.default.extend2(l.Spell.FrostBolt,l.Spell.BoltBase),l.Spell.LightningBolt=function(){l.Spell.BoltBase.call(this,"Lightning bolt",8),this.damageType=i.default.DMG.LIGHTNING,this.setRange(6),this.setDice("damage",u.Dice.create("6d3 + 3"))},i.default.extend2(l.Spell.LightningBolt,l.Spell.BoltBase),l.Spell.FireBolt=function(){l.Spell.BoltBase.call(this,"Fire bolt",8),this.damageType=i.default.DMG.FIRE,this.setRange(6),this.setDice("damage",u.Dice.create("5d3 + 5"))},i.default.extend2(l.Spell.FireBolt,l.Spell.BoltBase),l.Spell.ScorpionsTail=function(){l.Spell.BoltBase.call(this,"Scorpions tail",1),this.damageType=i.default.DMG.MELEE,this.setRange(2),this.setDice("damage",u.Dice.create("2d4 + 2"))},i.default.extend2(l.Spell.ScorpionsTail,l.Spell.BoltBase),l.Spell.ScorpionsTail.prototype.onHit=function(e,t){_(e,t)},l.Spell.ShadowRay=function(){l.Spell.BoltBase.call(this,"Shadow ray",8),this.setDice("damage",u.Dice.create("6d4 + 4")),this.setRange(8),this.damageType=i.default.DMG.NECRO},i.default.extend2(l.Spell.ShadowRay,l.Spell.BoltBase),l.Spell.CrossBolt=function(){l.Spell.BoltBase.call(this,"Cross bolt",20),this.damageType=i.default.DMG.LIGHTNING,this.setRange(6),this.setDice("damage",u.Dice.create("6d3 + 3")),this.cast=function(e){const t=e.dir;let n=i.default.DIR_NSEW_XY;0!==t[0]&&0!==t[1]&&(n=i.default.DIR_DIAG_XY),n.forEach(t=>{const n=Object.assign({},e);n.dir=t;const s=g(this,n);s.damageType=this.damageType,s.damage=this.rollDice("damage");const r=new c.SpellRay;r.setArgs(s),e.src.add(r)})}},i.default.extend2(l.Spell.CrossBolt,l.Spell.BoltBase),l.Spell.PoisonBreath=function(){l.Spell.BoltBase.call(this,"PoisonBreath",8),this.setDice("damage",u.Dice.create("6d4 + 4")),this.setRange(8),this.damageType=i.default.DMG.POISON,this.nActors=2,this.stopOnHit=!0,this._createdActor="Poison gas",this._dice.duration=u.Dice.create("5d5 + 5")},i.default.extend2(l.Spell.PoisonBreath,l.Spell.BoltBase),l.Spell.PoisonBreath.prototype.onHit=function(e,t){_(e,t);const n=h.getParser(),s=d.Brain.getCellsAroundActor(e,1);for(let e=0;e<this.nActors;e++){const e=m.arrayGetRand(s);if(e.isPassable()||e.hasActors()){const t=n.createActor(this._createdActor);E(t,e,this)}}const r="Poison clouds spread from poison breath of "+t.getName();i.default.gameSuccess({cell:e.getCell(),msg:r})},l.Spell.WaterBolt=function(){l.Spell.BoltBase.call(this,"WaterBolt",10),this.setDice("damage",u.Dice.create("4d4 + 4")),this.setRange(5),this.damageType=i.default.DMG.WATER},i.default.extend2(l.Spell.WaterBolt,l.Spell.BoltBase),l.Spell.VoidBolt=function(){l.Spell.BoltBase.call(this,"VoidBolt",12),this.setDice("damage",u.Dice.create("5d4 + 4")),this.setRange(5),this.damageType=i.default.DMG.VOID},i.default.extend2(l.Spell.VoidBolt,l.Spell.BoltBase),l.Spell.SlimeBolt=function(){l.Spell.BoltBase.call(this,"SlimeBolt",10),this.setDice("damage",u.Dice.create("4d4 + 4")),this.setRange(5),this.damageType=i.default.DMG.SLIME,this.stopOnHit=!0},i.default.extend2(l.Spell.SlimeBolt,l.Spell.BoltBase),l.Spell.SlimeBolt.prototype.onHit=function(e,t){const n=e.getLevel();d.Brain.getCellsAroundActor(e,1).forEach(e=>{if(e.isPassable()||e.hasActors()){const t=new f.ElementSlime;n.addElement(t,e.getX(),e.getY())}}),e.add(new c.Entrapped);const s="Slime is spread around by "+t.getName();i.default.gameSuccess({cell:e.getCell(),msg:s})},l.Spell.IceShield=function(){l.SpellBase.call(this,"Ice shield",6),this._dice.duration=u.Dice.create("5d5 + 15"),this._dice.defense=u.Dice.create("1d6 + 3"),this.cast=e=>{const t=e.src,n=this.getDuration(),s=new c.CombatMods;s.setDefense(this.rollDice("defense")),c.addToExpirationComp(t,s,n),i.default.gameMsg({cell:t.getCell(),msg:t.getName()+" is surrounded by defensive aura"})},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=(e,t)=>v(e,t)},i.default.extend2(l.Spell.IceShield,l.SpellBase),l.Spell.IceShield.prototype.toString=function(){let e=l.SpellBase.prototype.toString.call(this);return e+=" Def: "+this._dice.defense.toString(),e},l.Spell.MagicArmor=function(){l.SpellBase.call(this,"MagicArmor",5),this._dice.duration=u.Dice.create("6d5 + 15"),this._dice.protection=u.Dice.create("2d6 + 2"),this.cast=e=>{const t=e.src,n=t.getName(),s={target:t,name:"CombatMods",setters:{setProtection:this.rollDice("protection")},duration:this._dice.duration,startMsg:n+" is surrounded by a protective aura",expireMsg:"Protective aura disappears from "+n},r=new c.Effects(s);r.setEffectType("AddComp"),t.add(r)},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=(e,t)=>v(e,t)},i.default.extend2(l.Spell.MagicArmor,l.SpellBase),l.Spell.MagicArmor.prototype.toString=function(){let e=l.SpellBase.prototype.toString.call(this);return e+=" Pro: "+this._dice.protection.toString(),e},l.Spell.IcyPrison=function(){l.SpellBase.call(this,"Icy prison",10),this._dice.duration=u.Dice.create("1d8 + 1"),this.cast=function(e){const t=g(this,e),n=this.getDuration(),s=new c.Paralysis;s.setSource(e.src),t.addComp={comp:s,duration:n};const r=new c.SpellCell;r.setArgs(t),e.src.add(r)},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectDir(this,e,"Select a direction for casting:")},this.aiShouldCastSpell=(e,t)=>y(e,t)},i.default.extend2(l.Spell.IcyPrison,l.SpellBase),l.Spell.SummonIceMinion=function(){l.Spell.SummonBase.call(this,"SummonIceMinion",14),this.summonType="ice minion"},i.default.extend2(l.Spell.SummonIceMinion,l.Spell.SummonBase),l.Spell.SummonAirElemental=function(){l.Spell.SummonBase.call(this,"SummonAirElemental",20),this.summonFunc=e=>"air elemental"===e.name},i.default.extend2(l.Spell.SummonAirElemental,l.Spell.SummonBase),l.Spell.SummonUndeadUnicorns=function(){l.Spell.SummonBase.call(this,"SummonUndeadUnicorns",15),this.nActors="1d4 + 1",this.summonFunc=e=>"undead unicorn"===e.name},i.default.extend2(l.Spell.SummonUndeadUnicorns,l.Spell.SummonBase),l.Spell.SummonAnimal=function(){l.Spell.SummonBase.call(this,"SummonAnimal",10),this.summonFunc=e=>{const t=this.getCaster().get("Experience").getExpLevel();let n=Math.round(t/3)||1;n>10&&(n=10);const s=Math.round(t/2);return"animal"===e.type&&e.danger>=n&&e.danger<=s}},i.default.extend2(l.Spell.SummonAnimal,l.Spell.SummonBase),l.Spell.SummonDead=function(){l.Spell.SummonBase.call(this,"SummonDead",15),this.nActors=4,this.summonFunc=e=>"undead"===e.type&&e.name!==this.getCaster().getName()},i.default.extend2(l.Spell.SummonDead,l.Spell.SummonBase),l.Spell.SummonSpiders=function(){l.Spell.SummonBase.call(this,"SummonSpiders",10),this.nActors="1d4 + 1",this.summonFunc=e=>{const t=this.getCaster().get("Experience"),n=t.getDanger(),s=t.getExpLevel(),r=n+Math.round(s/2),a=this.getCaster().getName();return/spider/.test(e.name)&&!/undead/.test(e.name)&&e.danger<=r&&a!==e.name}},i.default.extend2(l.Spell.SummonSpiders,l.Spell.SummonBase),l.Spell.SummonKin=function(){l.Spell.SummonBase.call(this,"SummonKin",10),this.summonFunc=e=>{const t=this.getCaster().getType(),n=this.getCaster().get("Experience"),s=n.getDanger(),r=n.getExpLevel(),a=s+Math.round(r/2);return e.type===t&&e.danger<=a}},i.default.extend2(l.Spell.SummonKin,l.Spell.SummonBase),l.Spell.SummonFlyingEyes=function(){l.Spell.SummonBase.call(this,"SummonFlyingEyes",4),this.summonType="flying eye",this.nActors="1d6 + 1",this._dice.duration=u.Dice.create("10d5 + 10"),this.postSummonCallback=(e,t,n)=>{const s=new c.Fading,r=this.getDuration();s.setDuration(r),n.add(s);const a=new c.Telepathy;a.setTarget(n),a.setSource(this._caster);const o=a.clone();c.addToExpirationComp(n,a,r),c.addToExpirationComp(this._caster,o,r)},this.aiShouldCastSpell=(e,t)=>{const{actor:n}=e;return!n.has("Telepathy")&&(e.dir=[0,0],t(n,e),!0)}},i.default.extend2(l.Spell.SummonFlyingEyes,l.Spell.SummonBase),l.Spell.PowerDrain=function(){l.SpellBase.call(this,"PowerDrain",15),this._dice.duration=u.Dice.create("20d5 + 10"),this.cast=e=>{const t=e.src,n=this.getDuration(),s=new c.PowerDrain;c.addToExpirationComp(t,s,n),i.default.gameMsg({cell:t.getCell(),msg:t.getName()+" is surrounded by purple aura"})},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectSelf(this,e)},this.aiShouldCastSpell=(e,t)=>(this.compFuncArgs={enemy:e.enemy},e.compFunc=this.aiCompFunc.bind(this),b(e,t)),this.aiCompFunc=e=>{const{enemy:t}=this.compFuncArgs;return!!t&&!(e.has("PowerDrain")||!t.has("SpellPower"))}},i.default.extend2(l.Spell.PowerDrain,l.SpellBase),l.Spell.IceArrow=function(){l.Spell.Missile.call(this,"IceArrow",16),this.setRange(9),this.damageType=i.default.DMG.ICE,this.ammoName="Ice arrow"},i.default.extend2(l.Spell.IceArrow,l.Spell.Missile),l.Spell.LightningArrow=function(){l.Spell.Missile.call(this,"LightningArrow",14),this.setRange(8),this.damageType=i.default.DMG.LIGHTNING,this.ammoName="Lightning arrow"},i.default.extend2(l.Spell.LightningArrow,l.Spell.Missile),l.Spell.EnergyArrow=function(){l.Spell.Missile.call(this,"EnergyArrow",2),this.setRange(5),this.setDice("damage",u.Dice.create("1d4 + 1")),this.damageType=i.default.DMG.ENERGY,this.ammoName="Energy arrow"},i.default.extend2(l.Spell.EnergyArrow,l.Spell.Missile),l.Spell.Kindle=function(){l.Spell.Missile.call(this,"Kindle",2),this.setRange(5),this.setDice("damage",u.Dice.create("1d4 + 2")),this.damageType=i.default.DMG.FIRE,this.ammoName="Fire bolt"},i.default.extend2(l.Spell.Kindle,l.Spell.Missile),l.Spell.PoisonArrow=function(){l.Spell.Missile.call(this,"PoisonArrow",20),this.setRange(10),this.setDice("damage",u.Dice.create("1d6 + 2")),this.damageType=i.default.DMG.POISON,this.ammoName="Poison arrow"},i.default.extend2(l.Spell.PoisonArrow,l.Spell.Missile),l.Spell.PoisonArrow.prototype.cast=function(e){l.Spell.Missile.prototype.cast.call(this,e);e.src.get("SpellMissile").onHit=this.onHit.bind(this)},l.Spell.PoisonArrow.prototype.onHit=function(e){const t=this._caster;_(e,t)},l.Spell.ArrowOfWebs=function(){l.Spell.Missile.call(this,"ArrowOfWebs",10),this.setRange(7),this.setDice("damage",u.Dice.create("1d6 + 2")),this.damageType=i.default.DMG.PIERCE,this.ammoName="Arrow of webs"},i.default.extend2(l.Spell.ArrowOfWebs,l.Spell.Missile),l.Spell.ArrowOfWebs.prototype.cast=function(e){l.Spell.Missile.prototype.cast.call(this,e);e.src.get("SpellMissile").onHit=this.onHit.bind(this)},l.Spell.ArrowOfWebs.prototype.onHit=function(e){const t=this._caster,n={target:{target:e.getCell()},targetType:["cell"],elementName:"Web",effectType:"AddElement",numAllowed:1},s=new c.Effects(n);t.add(s)},l.Spell.RockStorm=function(){l.Spell.Missile.call(this,"RockStorm",35),this.setRange(4),this.setDice("damage",u.Dice.create("5d4 + 1")),this.damageType=i.default.DMG.MELEE,this.ammoName="Huge rock",this.cast=function(e){const[t,n,s]=e.src.getXYZ();Object.values(i.default.DIR_XY).forEach(r=>{const a=t+this.getRange()*r[0],o=n+this.getRange()*r[1],i={from:[t,n,s],spell:this,src:e.src,to:[a,o,s]};i.damageType=this.damageType,i.damage=this.getDamage(),i.destroyItem=!1;const l=new c.SpellMissile;l.setArgs(i),e.src.add(l)})},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectSelf(this,e)}},i.default.extend2(l.Spell.RockStorm,l.Spell.Missile),l.Spell.MindControl=function(){l.SpellBase.call(this,"MindControl",25),this._dice.duration=u.Dice.create("1d6 + 3"),this.cast=function(e){const t=g(this,e),n=this.getDuration(),s=new c.MindControl;s.setSource(e.src),t.addComp={comp:s,duration:n};const r=new c.SpellCell;r.setArgs(t),e.src.add(r)},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectDir(this,e,"Select an actor to control:")},this.aiShouldCastSpell=(e,t)=>y(e,t)},i.default.extend2(l.Spell.MindControl,l.SpellBase),l.Spell.Blizzard=function(){l.Spell.AreaBase.call(this,"Blizzard",35),this.setDice("damage",u.Dice.create("5d5 + 5")),this.damageType=i.default.DMG.ICE,this.setRange(6)},i.default.extend2(l.Spell.Blizzard,l.Spell.AreaBase),l.Spell.Blizzard.prototype.onHit=function(e){e.add(new c.Coldness)},l.Spell.EnergyStorm=function(){l.Spell.AreaBase.call(this,"EnergyStorm",20),this.setDice("damage",u.Dice.create("3d4 + 3")),this.damageType=i.default.DMG.ENERGY},i.default.extend2(l.Spell.EnergyStorm,l.Spell.AreaBase),l.Spell.Heal=function(){l.SpellBase.call(this,"Heal",6),this._dice.healing=u.Dice.create("2d4"),this.cast=function(e){const t=g(this,e);t.targetComp="Health",t.set="addHP",t.value=this._dice.healing.roll();const n=new c.SpellCell;n.setArgs(t),e.src.add(n)},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectDir(this,e,"Select a direction for healing:")},this.aiShouldCastSpell=(e,t)=>v(e,t)},i.default.extend2(l.Spell.Heal,l.SpellBase),l.Spell.RingOfFire=function(){l.Spell.RingBase.call(this,"RingOfFire",10),this._dice.duration=u.Dice.create("10d10"),this._range=2,this._createdActor="Fire"},i.default.extend2(l.Spell.RingOfFire,l.Spell.RingBase),l.Spell.RingOfFrost=function(){l.Spell.RingBase.call(this,"RingOfFrost",10),this._dice.duration=u.Dice.create("10d10"),this._range=2,this._createdActor="Ice flame"},i.default.extend2(l.Spell.RingOfFrost,l.Spell.RingBase),l.Spell.RingOfEnergy=function(){l.Spell.RingBase.call(this,"RingOfEnergy",10),this._dice.duration=u.Dice.create("10d10"),this._range=3,this._createdActor="Forcefield"},i.default.extend2(l.Spell.RingOfEnergy,l.Spell.RingBase),l.Spell.PoisonCloud=function(){l.Spell.RingBase.call(this,"PoisonCloud",15),this._dice.duration=u.Dice.create("10d10"),this._range=1,this._createdActor="Poison gas"},i.default.extend2(l.Spell.PoisonCloud,l.Spell.RingBase),l.Spell.ForceField=function(){l.SpellBase.call(this,"ForceField",5),this._dice.duration=u.Dice.create("10d10"),this.cast=function(e){const t=g(this,e);t.callback=this.castCallback.bind(this,e);const n=new c.SpellSelf;n.setArgs(t),e.src.add(n)},this.getSelectionObject=function(e){return l.Spell.getSelectionObjectDir(this,e,"Select a direction for the forcefield:")},this.castCallback=e=>{const t=h.getParser(),n=this._caster.getLevel(),{dir:s}=e,[r,a]=this._caster.getXY(),[o,i]=[r+s[0],a+s[1]];(function(e,t,n,s){return 0===t[0]?[e.getCell(n-1,s),e.getCell(n,s),e.getCell(n+1,s)]:0===t[1]?[e.getCell(n,s-1),e.getCell(n,s),e.getCell(n,s+1)]:-1===t[0]?[e.getCell(n+1,s),e.getCell(n,s),e.getCell(n,s-t[1])]:[e.getCell(n-1,s),e.getCell(n,s),e.getCell(n,s-t[1])]})(n.getMap(),s,o,i).forEach(e=>{if(e.isPassable()||!e.hasActors()){const s=t.createActor("Forcefield");n.addActor(s,e.getX(),e.getY());const r=new c.Fading,a=this.getDuration();r.setDuration(a),s.add(r)}})}},i.default.extend2(l.Spell.ForceField,l.SpellBase);class w extends l.Spell.MultiSpell{constructor(){super("IcyTouch",5),this._spells.push(new l.Spell.GraspOfWinter),this._spells.push(new l.Spell.RingOfFrost)}getSelectionObject(e){return l.Spell.getSelectionObjectDir(this,e,"Select a direction for touching:")}}l.Spell.IcyTouch=w;class C extends l.Spell.WaveBase{constructor(){super("IcyWave",20),this.damageType=i.default.DMG.ICE,this._waveActor="Ice wave",this._waveWidth=3,this._waveDepth=2}}l.Spell.IcyWave=C;class O extends l.Spell.WaveBase{constructor(){super("DeathWave",24),this.damageType=i.default.DMG.NECRO,this._waveActor="Death wave",this._waveWidth=5,this._waveDepth=3,this._waveSpeed=95}}l.Spell.DeathWave=O,l.Spell.addAllSpells=e=>{e.addSpell(new l.Spell.AnimateDead),e.addSpell(new l.Spell.ArrowOfWebs),e.addSpell(new l.Spell.Blizzard),e.addSpell(new l.Spell.Charm),e.addSpell(new l.Spell.CrossBolt),e.addSpell(new l.Spell.DeathWave),e.addSpell(new l.Spell.DispelMagic),e.addSpell(new l.Spell.EnergyArrow),e.addSpell(new l.Spell.Flying),e.addSpell(new l.Spell.ForceField),e.addSpell(new l.Spell.FireBolt),e.addSpell(new l.Spell.FrostBolt),e.addSpell(new l.Spell.GraspOfWinter),e.addSpell(new l.Spell.Heal),e.addSpell(new l.Spell.IceArrow),e.addSpell(new l.Spell.IceShield),e.addSpell(new l.Spell.IcyPrison),e.addSpell(new l.Spell.IcyTouch),e.addSpell(new l.Spell.IcyWave),e.addSpell(new l.Spell.Kindle),e.addSpell(new l.Spell.LightningArrow),e.addSpell(new l.Spell.LightningBolt),e.addSpell(new l.Spell.MagicArmor),e.addSpell(new l.Spell.MindControl),e.addSpell(new l.Spell.Paralysis),e.addSpell(new l.Spell.PoisonArrow),e.addSpell(new l.Spell.PoisonBreath),e.addSpell(new l.Spell.PoisonCloud),e.addSpell(new l.Spell.PowerDrain),e.addSpell(new l.Spell.RingOfEnergy),e.addSpell(new l.Spell.RingOfFire),e.addSpell(new l.Spell.RingOfFrost),e.addSpell(new l.Spell.RockStorm),e.addSpell(new l.Spell.SlimeBolt),e.addSpell(new l.Spell.SpiritForm),e.addSpell(new l.Spell.SummonAirElemental),e.addSpell(new l.Spell.SummonAnimal),e.addSpell(new l.Spell.SummonDead),e.addSpell(new l.Spell.SummonFlyingEyes),e.addSpell(new l.Spell.SummonIceMinion),e.addSpell(new l.Spell.SummonKin),e.addSpell(new l.Spell.SummonUndeadUnicorns),e.addSpell(new l.Spell.Telepathy),e.addSpell(new l.Spell.VoidBolt)}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BrainWave=t.BrainMindControl=t.BrainCloud=t.BrainFlame=t.BrainCommander=t.BrainAnimal=t.BrainThief=t.BrainSpirit=t.BrainExplorer=t.BrainSpellCaster=t.BrainGoalOriented=void 0;const i=o(n(4)),l=a(n(114)),c=n(71),u=n(38),h=a(n(29)),d=n(9).Random.getRNG(),p={};class f extends c.BrainSentient{constructor(e){super(e),this.setType("GoalOriented"),this.goal=new l.ThinkBasic(e)}getGoal(){return this.goal}setGoal(e){this.goal=e}decideNextAction(){return this._cache.seen=null,this.goal.process(),this._cache.seen=null,c.ACTION_ALREADY_DONE}toJSON(){const e=super.toJSON();return e.goal=this.goal.toJSON(),e}}t.BrainGoalOriented=f,p.GoalOriented=f;class m extends f{constructor(e){super(e),this.setType("SpellCaster"),this.goal=new l.ThinkSpellcaster(e),this.goal.setBias({CastSpell:2,AttackActor:.7});this.goal.getEvaluator("CastSpell").setCastingProbability(.8)}}t.BrainSpellCaster=m,p.SpellCaster=m;class g extends f{constructor(e){super(e),this.setType("Explorer"),this.goal.removeEvaluators(),this.goal.addEvaluator(new u.Evaluator.Explore)}}t.BrainExplorer=g,p.Explorer=g;class y extends f{constructor(e){super(e),this.setType("Spirit"),this.goal.removeEvaluators(),this.goal.addEvaluator(new u.Evaluator.Explore)}}t.BrainSpirit=y,p.Spirit=y;class v extends f{constructor(e){super(e),this.setType("Thief"),this.goal.addEvaluator(new u.Evaluator.Thief(1.2)),this.goal.setBias({Thief:1.2,AttackActor:.7})}}t.BrainThief=v,p.Thief=v;class b extends f{constructor(e){super(e),this.setType("Animal")}}t.BrainAnimal=b,p.Animal=b;class _ extends f{constructor(e){super(e),this.setType("Commander"),this.goal=new l.ThinkCommander(e)}decideNextAction(){return this._cache.seen=null,this.goal.process(),this._cache.seen=null,c.ACTION_ALREADY_DONE}}t.BrainCommander=_,p.Commander=_;class E extends c.BrainSentient{constructor(e){super(e),this.setType("Flame")}decideNextAction(){return this._actor.getCell().getActors().forEach(e=>{const t=this.getActor().get("Damaging");if(t){const n=new h.Flame;n.setSource(this._actor),n.setDamageType(t.getDamageType()),e.add(n)}}),c.ACTION_ALREADY_DONE}}t.BrainFlame=E,p.Flame=E;class S extends E{constructor(e){super(e),this.setType("Cloud"),this.chanceToMove=.2}decideNextAction(){if(d.getUniform()<=this.chanceToMove){const e=d.getRandDir(),[t,n]=i.default.newXYFromDir(e,this._actor),s=this._actor.getLevel();if(s.getMap().hasXY(t,n)){const e=new h.Movement(t,n,s);this._actor.add(e)}}return super.decideNextAction.call(this)}}t.BrainCloud=S,p.Cloud=S;class w extends f{constructor(e){super(e),this.setType("MindControl"),this.goal=new l.ThinkBasic(e),this.getGoal=()=>this.goal,this.setGoal=e=>{this.goal=e}}decideNextAction(){return c.ACTION_ALREADY_DONE}}t.BrainMindControl=w,p.MindControl=w;class C extends f{constructor(e){super(e),this.setType("Wave"),this.idx=0,this.delay=0}decideNextAction(){if(this._actor.getCell().getActors().forEach(e=>{const t=this.getActor().get("Damaging");if(t&&e.getName()!==this._actor.getName()){const n=new h.Flame;n.setSource(this._actor),n.setDamageType(t.getDamageType()),e.add(n)}}),this.idx>=this.line.length){const e=new h.Fading;return this._actor.add(e),c.ACTION_ALREADY_DONE}if(this.delay>0)return this.delay-=1,c.ACTION_ALREADY_DONE;const[e,t,n]=this.line[this.idx];this.idx+=1;const s=this._actor.get("Location").getLevel(),r=new h.Movement(e,t,s);return this._actor.add(r),c.ACTION_ALREADY_DONE}}t.BrainWave=C,p.Wave=C},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.BrainNeedDriven=void 0;const o=a(n(114)),i=n(71),l=n(273),c=n(38);class u extends i.BrainSentient{constructor(e){super(e),this.setType("NeedDriven"),this.goal=new o.ThinkBasic(e),this.needs=new l.NeedsHierarchy(e),this.goal.removeEvaluators(),this.goal.addEvaluator(new c.Evaluator.AttackActor(1.5)),this.needUpdatePeriod=0}decideNextAction(e){return this._cache.seen=null,0===this.needUpdatePeriod?(this.needs.process(this.goal,e),this.needUpdatePeriod=0):this.needUpdatePeriod-=1,this.goal.process(),this._cache.seen=null,i.ACTION_ALREADY_DONE}getGoal(){return this.goal}setGoal(e){this.goal=e}toJSON(){const e=super.toJSON();return e.goal=this.goal.toJSON(),e}}t.BrainNeedDriven=u},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.NeedsHierarchy=t.processNeed=void 0;const r=s(n(15)).default("bitn:Needs"),a=s(n(4)),o=n(38),i=n(9),l=n(60),c=n(470),u=n(274),h=i.Random.getRNG(),d=new l.Constraints;function p(e){e.func||(e.func=d.getConstraints(e.constr))}t.processNeed=p;t.NeedsHierarchy=class{constructor(e){this.actor=e,this.weightedRand=!0,this._debug=r.enabled,this.needs=[],this.addNeedWithEval(u.Needs.Health),this.addNeedWithEval(u.Needs.Rest),this.addNeedWithEval(u.Needs.Hunger),e.has("SpellPower")&&this.addNeedWithEval(u.Needs.SpellPower),this._jobSchedule=null,this.addSchedule(new c.JobSchedule("testSchedule"))}addSchedule(e){this._jobSchedule=e}addNeedWithEval(e){e||a.default.err("NeedsHierarchy","addNeedWithEval","Tried to add null/undef need"),p(e),this.needs.push(e)}setDebug(e){this._debug=e}process(e,t){const{timeOfDay:n}=t,s=this.getEvaluators(this.actor,n);if(this.processJobSchedule(s,n),this.weightedRand&&s.length>0){const t={},n={};s.forEach(e=>{const[s,r,a]=e;t[s]?t[s]+=r:t[s]=r,a&&(n[s]?n[s]=Object.assign(n[s],a):n[s]=a)});const r=h.getWeighted(t),a=t[r];this.dbg(`Chose need [${r}], bias: ${a}`);let i=null;i=o.Evaluator[r]?new o.Evaluator[r](a):o.Evaluator.create(r,a),e.removeEvaluatorsByType(r),e.addEvaluator(i),n[r]&&Object.keys(n[r]).forEach(e=>{i[e]=n[r][e]})}else s.forEach(t=>{const n=t[0],s=new o.Evaluator[n](u.NEED_BIAS[n]);e.addEvaluator(s),t[2]&&t[2].isOneShot&&(s.isOneShot=!0)})}processJobSchedule(e,t){if(this._jobSchedule){const n=this._jobSchedule.getCurrentNeeds(this.actor,t);e.push(...n)}}getEvaluators(e,t){const n=[];for(let s=0;s<this.needs.length;s++){const r=this.needs[s];if(r.func&&r.func(e)){const e=[r.evalName,r.bias];if(r.only)return[e];if(n.push(e),r.last)return n}else if(r.script){const s=r.script(e,t);if(s.length>0){if(r.only)return s;if(n.push(...s),r.last)return n}}}return e.has("SpellPower")&&e.get("SpellPower").propLeft()<.2&&n.push(["Rest",.5*u.NEED_BIAS.Rest]),n}dbg(e){if(this._debug){const t=this.actor.getName(),n=this.actor.getID();r(`@${n} ${t} |${e}|`)}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Needs=t.NEED_BIAS=void 0;const r=s(n(4));t.NEED_BIAS={Equip:1,Flee:1.5,FindAmmo:1,FindMissile:1,FindFood:1,FindWeapon:1,Rest:1},t.Needs={};const a={constr:{op:"<",value:.2,comp:["Health","propLeft"]},evalName:"Flee",bias:t.NEED_BIAS.Flee};t.Needs.Health=a;const o={constr:{op:"<",value:.5,comp:["Health","propLeft"]},evalName:"Rest",bias:t.NEED_BIAS.Rest};t.Needs.Rest=o;const i={constr:{op:"eq",value:!0,comp:["Hunger","isStarving"]},evalName:"FindFood",bias:t.NEED_BIAS.FindFood};t.Needs.Hunger=i;const l={constr:{op:"<",value:.4,comp:["SpellPower","propLeft"]},evalName:"Rest",bias:.75*t.NEED_BIAS.Rest};t.Needs.SpellPower=l;const c={script:function(e){const n=e.getInvEq(),s=[],a=e.getBrain().getGoal();if(!n.getWeapon()){const e=n.getInventory().getItems();e.find(e=>e.getType()===r.default.ITEM.WEAPON)?(a.removeEvaluatorsByType("FindWeapon"),s.push(["Equip",t.NEED_BIAS.Equip,{isOneShot:!0}])):s.push(["FindWeapon",t.NEED_BIAS.FindWeapon,{isOneShot:!0}])}return s},evalName:"FindWeapon",bias:t.NEED_BIAS.FindWeapon};t.Needs.FindWeapon=c},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Abilities=void 0;const o=a(n(186)),i=n(34),l=i.Component.UniqueDataComponent;t.Abilities=l("Abilities",{}),t.Abilities.prototype._init=function(){this.addCallback("onAdd",()=>{const e=new o.Abilities(this.getEntity());Array.isArray(this.abilities)&&this.abilities.forEach(t=>{const n=new o[t];e.addAbility(n)}),this.abilities=e,this.removeCallbacks("onAdd")})},t.Abilities.prototype.setAbilities=function(e){this.abilities=e},t.Abilities.prototype.createMenu=function(){return this.abilities.getMenu()},t.Abilities.prototype.addAbility=function(e){this.abilities.addAbility(e)},t.Abilities.prototype.toJSON=function(){const e=i.ComponentBase.prototype.toJSON.call(this);return e.setAbilities=this.abilities.toJSON(),e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Trainer=void 0;const s=n(187),r=n(34).Component.UniqueDataComponent;t.Trainer=r("Trainer",{chatObj:null}),delete t.Trainer.prototype.setChatObj,t.Trainer.prototype._init=function(){this.chatObj=new s.ChatTrainer;this.addCallback("onAdd",()=>{this.chatObj.setTrainer(this.getEntity())})}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(1)),i=/[?!.]$/;class l extends o.Component{shouldComponentUpdate(e){return e.message.length>0}render(){const e=this.props.message,t=l.styleToClassName,n=this.props.visibleCells,s=this.props.showAll;let r=[o.createElement("span",null,"Saving the game...")];return this.props.saveInProgress||(r=e.map((e,r)=>{let a=t[e.style];a||(a=e.style);let l=1;s?e.seen=!0:e.hasOwnProperty("seen")||e.hasOwnProperty("cell")&&(l=n.indexOf(e.cell),l>=0&&(e.seen=!0));const c=1===e.count?"":` (x${e.count})`;let u=`${e.msg}${c}`;return u.match(i)||(u+="."),u+=" ",l>=0||e.seen?o.createElement("span",{className:a,key:r},u):null})),o.createElement("div",{className:"game-messages"},r)}}t.default=l,l.styleToClassName={prim:"text-primary",info:"text-info",descr:"text-muted",warn:"text-warning",danger:"text-danger",success:"text-success"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.tokenize=t.measure=t.TYPE_BG=t.TYPE_FG=t.TYPE_NEWLINE=t.TYPE_TEXT=void 0;const s=/%([bc]){([^}]*)}/g;function r(e,n){const r=[];let o=0;e.replace(s,(function(n,s,a,i){const l=e.substring(o,i);return l.length&&r.push({type:t.TYPE_TEXT,value:l}),r.push({type:"c"==s?t.TYPE_FG:t.TYPE_BG,value:a.trim()}),o=i+n.length,""}));const i=e.substring(o);return i.length&&r.push({type:t.TYPE_TEXT,value:i}),function(e,n){n||(n=1/0);let s=0,r=0,o=-1;for(;s<e.length;){const i=e[s];if(i.type==t.TYPE_NEWLINE&&(r=0,o=-1),i.type!=t.TYPE_TEXT){s++;continue}for(;0==r&&" "==i.value.charAt(0);)i.value=i.value.substring(1);const l=i.value.indexOf("\n");if(-1!=l){i.value=a(e,s,l,!0);const t=i.value.split("");for(;t.length&&" "==t[t.length-1];)t.pop();i.value=t.join("")}if(i.value.length){if(r+i.value.length>n){let t=-1;for(;;){const e=i.value.indexOf(" ",t+1);if(-1==e)break;if(r+e>n)break;t=e}if(-1!=t)i.value=a(e,s,t,!0);else if(-1!=o){const t=e[o],n=t.value.lastIndexOf(" ");t.value=a(e,o,n,!0),s=o}else i.value=a(e,s,n-r,!1)}else r+=i.value.length,-1!=i.value.indexOf(" ")&&(o=s);s++}else e.splice(s,1)}e.push({type:t.TYPE_NEWLINE});let i=null;for(let n=0;n<e.length;n++){const s=e[n];switch(s.type){case t.TYPE_TEXT:i=s;break;case t.TYPE_NEWLINE:if(i){const e=i.value.split("");for(;e.length&&" "==e[e.length-1];)e.pop();i.value=e.join("")}i=null}}return e.pop(),e}(r,n)}function a(e,n,s,r){const a={type:t.TYPE_NEWLINE},o={type:t.TYPE_TEXT,value:e[n].value.substring(s+(r?1:0))};return e.splice(n+1,0,a,o),e[n].value.substring(0,s)}t.TYPE_TEXT=0,t.TYPE_NEWLINE=1,t.TYPE_FG=2,t.TYPE_BG=3,t.measure=function(e,n){const s={width:0,height:1},a=r(e,n);let o=0;for(let e=0;e<a.length;e++){const n=a[e];switch(n.type){case t.TYPE_TEXT:o+=n.value.length;break;case t.TYPE_NEWLINE:s.height++,s.width=Math.max(s.width,o),o=0}}return s.width=Math.max(s.width,o),s},t.tokenize=r},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(489)),a=s(n(280)),o=s(n(661)),i=s(n(331)),l=s(n(662)),c=s(n(663)),u=s(n(664)),h=s(n(665));t.default={Arena:r.default,Uniform:a.default,Cellular:o.default,Digger:i.default,EllerMaze:l.default,DividedMaze:c.default,IceyMaze:u.default,Rogue:h.default}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(281)),a=n(92),o=s(n(22));class i extends r.default{constructor(e,t,n){super(e,t),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3,corridorLength:[3,10]},Object.assign(this._options,n),this._map=[],this._dug=0,this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)}startRoom(e){this._startRoom=e}create(e){const t=Date.now();for(;;){if(Date.now()-t>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._firstRoom(),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),this._startRoom&&(this._addRoom(this._startRoom),this._startRoom.create(this._digCallback)),!(this._rooms.length<2)&&this._generateCorridors())break}if(e)for(let t=0;t<this._width;t++)for(let n=0;n<this._height;n++)e(t,n,this._map[t][n]);return this}_generateRooms(){const e=this._width-2,t=this._height-2;let n;do{if(n=this._generateRoom(),this._dug/(e*t)>this._options.roomDugPercentage)break}while(n)}_generateRoom(){let e=0;for(;e<this._roomAttempts;){e++;const t=a.Room.createRandom(this._width,this._height,this._options);if(t.isValid(this._isWallCallback,this._canBeDugCallback))return t.create(this._digCallback),this._addRoom(t),t}return null}_generateCorridors(){let e=0;for(;e<this._corridorAttempts;){e++,this._corridors=[],this._map=this._fillMap(1);for(let e=0;e<this._rooms.length;e++){const t=this._rooms[e];t.clearDoors(),t.create(this._digCallback)}for(this._unconnected=o.default.shuffle(this._rooms.slice()),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){const e=o.default.getItem(this._connected);if(!e)break;const t=this._closestRoom(this._unconnected,e);if(!t)break;const n=this._closestRoom(this._connected,t);if(!n)break;if(!this._connectRooms(t,n))break;if(!this._unconnected.length)return!0}}return!1}_closestRoom(e,t){let n=1/0;const s=t.getCenter();let r=null;for(let t=0;t<e.length;t++){const a=e[t],o=a.getCenter(),i=o[0]-s[0],l=o[1]-s[1],c=i*i+l*l;c<n&&(n=c,r=a)}return r}_connectRooms(e,t){const n=e.getCenter(),s=t.getCenter(),r=s[0]-n[0],a=s[1]-n[1];let o,i,l,c,u,h,d;if(Math.abs(r)<Math.abs(a)?(l=a>0?2:0,c=(l+2)%4,u=t.getLeft(),h=t.getRight(),d=0):(l=r>0?1:3,c=(l+2)%4,u=t.getTop(),h=t.getBottom(),d=1),o=this._placeInWall(e,l),!o)return!1;if(o[d]>=u&&o[d]<=h){i=o.slice();let e=0;switch(c){case 0:e=t.getTop()-1;break;case 1:e=t.getRight()+1;break;case 2:e=t.getBottom()+1;break;case 3:e=t.getLeft()-1}i[(d+1)%2]=e,this._digLine([o,i])}else if(o[d]<u-1||o[d]>h+1){const e=o[d]-s[d];let n=0;switch(c){case 0:case 1:n=e<0?3:1;break;case 2:case 3:n=e<0?1:3}if(c=(c+n)%4,i=this._placeInWall(t,c),!i)return!1;const r=[0,0];r[d]=o[d];const a=(d+1)%2;r[a]=i[a],this._digLine([o,r,i])}else{const e=(d+1)%2;if(i=this._placeInWall(t,c),!i)return!1;const n=Math.round((i[e]+o[e])/2),s=[0,0],r=[0,0];s[d]=o[d],s[e]=n,r[d]=i[d],r[e]=n,this._digLine([o,s,r,i])}e.addDoor(o[0],o[1]),t.addDoor(i[0],i[1]),d=this._unconnected.indexOf(e),-1!==d&&(this._unconnected.splice(d,1),this._connected.push(e)),d=this._unconnected.indexOf(t),-1!==d&&(this._unconnected.splice(d,1),this._connected.push(t)),this._ngraph.addLink(e.getName(),t.getName(),{weight:1});const p=e.getName()+"->"+t.getName();return this._ugraph.createEdge(p).link(this._ugraph.nodes(e.getName()).query().first(),this._ugraph.nodes(t.getName()).query().first(),{weight:1}),!0}_placeInWall(e,t){let n=[0,0],s=[0,0],r=0;switch(t){case 0:s=[1,0],n=[e.getLeft(),e.getTop()-1],r=e.getRight()-e.getLeft()+1;break;case 1:s=[0,1],n=[e.getRight()+1,e.getTop()],r=e.getBottom()-e.getTop()+1;break;case 2:s=[1,0],n=[e.getLeft(),e.getBottom()+1],r=e.getRight()-e.getLeft()+1;break;case 3:s=[0,1],n=[e.getLeft()-1,e.getTop()],r=e.getBottom()-e.getTop()+1}const a=[];let i=-2;for(let e=0;e<r;e++){const t=n[0]+e*s[0],r=n[1]+e*s[1];a.push(null);1===this._map[t][r]?i!==e-1&&(a[e]=[t,r]):(i=e,e&&(a[e-1]=null))}for(let e=a.length-1;e>=0;e--)a[e]||a.splice(e,1);return a.length?o.default.getItem(a):null}_digLine(e){for(let t=1;t<e.length;t++){const n=e[t-1],s=e[t],r=new a.Corridor(n[0],n[1],s[0],s[1]);r.create(this._digCallback),this._corridors.push(r)}}_digCallback(e,t,n){this._map[e][t]=n,0===n&&this._dug++}_isWallCallback(e,t){return!(e<0||t<0||e>=this._width||t>=this._height)&&1===this._map[e][t]}_canBeDugCallback(e,t){return!(e<1||t<1||e+1>=this._width||t+1>=this._height)&&1===this._map[e][t]}}t.default=i},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(40)),a=n(92),o=n(627),i=n(629);class l extends r.default{constructor(e,t){super(e,t),this._rooms=[],this._corridors=[],this._ngraph=o(),this._ugraph=new i.Graph,this._digCallback=this._digCallback.bind(this)}startRoom(e){this._startRoom=e}_digCallback(e,t,n){throw Error("_digCallback must be done in derived class")}_firstRoom(){let e=this._startRoom;if(!e){const t=Math.floor(this._width/2),n=Math.floor(this._height/2);e=a.Room.createRandomCenter(t,n,this._options)}this._addRoom(e),e.create(this._digCallback),this._extraRooms&&this._extraRooms.forEach(t=>{this._addRoom(e),t.create(this._digCallback)})}_addRoom(e){this._rooms.push(e),this._ngraph.addNode(e.getName(),e),this._ugraph.createNode(e.getName(),e)}addRoom(e){this._startRoom?(this._extraRooms||(this._extraRooms=[]),this._extraRooms.push(e)):this._startRoom=e}getRooms(){return this._rooms}getCorridors(){return this._corridors}}t.default=l},function(e,t,n){(function(t){var n="object"==typeof t&&t&&t.Object===Object&&t;e.exports=n}).call(this,n(35))},function(e,t){var n=Function.prototype.toString;e.exports=function(e){if(null!=e){try{return n.call(e)}catch(e){}try{return e+""}catch(e){}}return""}},function(e,t,n){var s=n(285),r=n(196),a=Object.prototype.hasOwnProperty;e.exports=function(e,t,n){var o=e[t];a.call(e,t)&&r(o,n)&&(void 0!==n||t in e)||s(e,t,n)}},function(e,t,n){var s=n(286);e.exports=function(e,t,n){"__proto__"==t&&s?s(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n}},function(e,t,n){var s=n(74),r=function(){try{var e=s(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();e.exports=r},function(e,t,n){var s=n(523),r=n(147),a=n(20),o=n(115),i=n(288),l=n(148),c=Object.prototype.hasOwnProperty;e.exports=function(e,t){var n=a(e),u=!n&&r(e),h=!n&&!u&&o(e),d=!n&&!u&&!h&&l(e),p=n||u||h||d,f=p?s(e.length,String):[],m=f.length;for(var g in e)!t&&!c.call(e,g)||p&&("length"==g||h&&("offset"==g||"parent"==g)||d&&("buffer"==g||"byteLength"==g||"byteOffset"==g)||i(g,m))||f.push(g);return f}},function(e,t){var n=/^(?:0|[1-9]\d*)$/;e.exports=function(e,t){var s=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==s||"symbol"!=s&&n.test(e))&&e>-1&&e%1==0&&e<t}},function(e,t){e.exports=function(e,t){return function(n){return e(t(n))}}},function(e,t){e.exports=function(e,t){for(var n=-1,s=null==e?0:e.length,r=0,a=[];++n<s;){var o=e[n];t(o,n,e)&&(a[r++]=o)}return a}},function(e,t){e.exports=function(){return[]}},function(e,t,n){var s=n(207),r=n(208),a=n(206),o=n(291),i=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)s(t,a(e)),e=r(e);return t}:o;e.exports=i},function(e,t,n){var s=n(294),r=n(206),a=n(76);e.exports=function(e){return s(e,a,r)}},function(e,t,n){var s=n(207),r=n(20);e.exports=function(e,t,n){var a=t(e);return r(e)?a:s(a,n(e))}},function(e,t,n){var s=n(74)(n(44),"Set");e.exports=s},function(e,t,n){var s=n(44).Uint8Array;e.exports=s},function(e,t,n){var s=n(75),r=Object.create,a=function(){function e(){}return function(t){if(!s(t))return{};if(r)return r(t);e.prototype=t;var n=new e;return e.prototype=void 0,n}}();e.exports=a},function(e,t){e.exports=function(e){return function(){return e}}},function(e,t,n){var s=n(552),r=n(76);e.exports=function(e,t){return e&&s(e,t,r)}},function(e,t,n){var s=n(560),r=n(56);e.exports=function e(t,n,a,o,i){return t===n||(null==t||null==n||!r(t)&&!r(n)?t!=t&&n!=n:s(t,n,a,o,e,i))}},function(e,t,n){var s=n(302),r=n(563),a=n(303);e.exports=function(e,t,n,o,i,l){var c=1&n,u=e.length,h=t.length;if(u!=h&&!(c&&h>u))return!1;var d=l.get(e),p=l.get(t);if(d&&p)return d==t&&p==e;var f=-1,m=!0,g=2&n?new s:void 0;for(l.set(e,t),l.set(t,e);++f<u;){var y=e[f],v=t[f];if(o)var b=c?o(v,y,f,t,e,l):o(y,v,f,e,t,l);if(void 0!==b){if(b)continue;m=!1;break}if(g){if(!r(t,(function(e,t){if(!a(g,t)&&(y===e||i(y,e,n,o,l)))return g.push(t)}))){m=!1;break}}else if(y!==v&&!i(y,v,n,o,l)){m=!1;break}}return l.delete(e),l.delete(t),m}},function(e,t,n){var s=n(198),r=n(561),a=n(562);function o(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new s;++t<n;)this.add(e[t])}o.prototype.add=o.prototype.push=r,o.prototype.has=a,e.exports=o},function(e,t){e.exports=function(e,t){return e.has(t)}},function(e,t,n){var s=n(75);e.exports=function(e){return e==e&&!s(e)}},function(e,t){e.exports=function(e,t){return function(n){return null!=n&&(n[e]===t&&(void 0!==t||e in Object(n)))}}},function(e,t,n){var s=n(307),r=n(153);e.exports=function(e,t){for(var n=0,a=(t=s(t,e)).length;null!=e&&n<a;)e=e[r(t[n++])];return n&&n==a?e:void 0}},function(e,t,n){var s=n(20),r=n(211),a=n(570),o=n(573);e.exports=function(e,t){return s(e)?e:r(e,t)?[e]:a(o(e))}},function(e,t,n){var s=n(307),r=n(147),a=n(20),o=n(288),i=n(201),l=n(153);e.exports=function(e,t,n){for(var c=-1,u=(t=s(t,e)).length,h=!1;++c<u;){var d=l(t[c]);if(!(h=null!=e&&n(e,d)))break;e=e[d]}return h||++c!=u?h:!!(u=null==e?0:e.length)&&i(u)&&o(d,u)&&(a(e)||r(e))}},function(e,t){e.exports=function(e){return function(t){return null==t?void 0:t[e]}}},function(e,t,n){var s=n(36),r=n(311);e.exports=function(e,t,n,s){return function(e,t,n,s){var a,o,i={},l=new r,c=function(e){var t=e.v!==a?e.v:e.w,s=i[t],r=n(e),c=o.distance+r;if(r<0)throw new Error("dijkstra does not allow negative edge weights. Bad edge: "+e+" Weight: "+r);c<s.distance&&(s.distance=c,s.predecessor=a,l.decrease(t,c))};e.nodes().forEach((function(e){var n=e===t?0:Number.POSITIVE_INFINITY;i[e]={distance:n},l.add(e,n)}));for(;l.size()>0&&(a=l.removeMin(),(o=i[a]).distance!==Number.POSITIVE_INFINITY);)s(a).forEach(c);return i}(e,String(t),n||a,s||function(t){return e.outEdges(t)})};var a=s.constant(1)},function(e,t,n){var s=n(36);function r(){this._arr=[],this._keyIndices={}}e.exports=r,r.prototype.size=function(){return this._arr.length},r.prototype.keys=function(){return this._arr.map((function(e){return e.key}))},r.prototype.has=function(e){return s.has(this._keyIndices,e)},r.prototype.priority=function(e){var t=this._keyIndices[e];if(void 0!==t)return this._arr[t].priority},r.prototype.min=function(){if(0===this.size())throw new Error("Queue underflow");return this._arr[0].key},r.prototype.add=function(e,t){var n=this._keyIndices;if(e=String(e),!s.has(n,e)){var r=this._arr,a=r.length;return n[e]=a,r.push({key:e,priority:t}),this._decrease(a),!0}return!1},r.prototype.removeMin=function(){this._swap(0,this._arr.length-1);var e=this._arr.pop();return delete this._keyIndices[e.key],this._heapify(0),e.key},r.prototype.decrease=function(e,t){var n=this._keyIndices[e];if(t>this._arr[n].priority)throw new Error("New priority is greater than current priority. Key: "+e+" Old: "+this._arr[n].priority+" New: "+t);this._arr[n].priority=t,this._decrease(n)},r.prototype._heapify=function(e){var t=this._arr,n=2*e,s=n+1,r=e;n<t.length&&(r=t[n].priority<t[r].priority?n:r,s<t.length&&(r=t[s].priority<t[r].priority?s:r),r!==e&&(this._swap(e,r),this._heapify(r)))},r.prototype._decrease=function(e){for(var t,n=this._arr,s=n[e].priority;0!==e&&!(n[t=e>>1].priority<s);)this._swap(e,t),e=t},r.prototype._swap=function(e,t){var n=this._arr,s=this._keyIndices,r=n[e],a=n[t];n[e]=a,n[t]=r,s[a.key]=e,s[r.key]=t}},function(e,t,n){var s=n(36);e.exports=function(e){var t=0,n=[],r={},a=[];return e.nodes().forEach((function(o){s.has(r,o)||function o(i){var l=r[i]={onStack:!0,lowlink:t,index:t++};if(n.push(i),e.successors(i).forEach((function(e){s.has(r,e)?r[e].onStack&&(l.lowlink=Math.min(l.lowlink,r[e].index)):(o(e),l.lowlink=Math.min(l.lowlink,r[e].lowlink))})),l.lowlink===l.index){var c,u=[];do{c=n.pop(),r[c].onStack=!1,u.push(c)}while(i!==c);a.push(u)}}(o)})),a}},function(e,t,n){var s=n(36);function r(e){var t={},n={},r=[];if(s.each(e.sinks(),(function o(i){if(s.has(n,i))throw new a;s.has(t,i)||(n[i]=!0,t[i]=!0,s.each(e.predecessors(i),o),delete n[i],r.push(i))})),s.size(t)!==e.nodeCount())throw new a;return r}function a(){}e.exports=r,r.CycleException=a,a.prototype=new Error},function(e,t,n){var s=n(36);e.exports=function(e,t,n){s.isArray(t)||(t=[t]);var r=(e.isDirected()?e.successors:e.neighbors).bind(e),a=[],o={};return s.each(t,(function(t){if(!e.hasNode(t))throw new Error("Graph does not have node: "+t);!function e(t,n,r,a,o,i){s.has(a,n)||(a[n]=!0,r||i.push(n),s.each(o(n),(function(n){e(t,n,r,a,o,i)})),r&&i.push(n))}(e,t,"post"===n,o,r,a)})),a}},function(e,t,n){"use strict";(function(e){var s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});var r=n(316),a=n(317),o=n(318),i=n(320),l=n(321),c=s(n(633)),u=s(n(634)),h=function(){function t(){this.__uniqval__=Number.MAX_SAFE_INTEGER,this.__init__()}return t.prototype.__init__=function(){this._lookup=Object.create(null),this._nodes=[],this._edges=[],this._nodeCollections=Object.create(null),this._edgeCollections=Object.create(null)},t.prototype.unit=function(e){return this._lookup[e]},t.prototype.nodeCount=function(){return this._nodes.length},t.prototype.edgeCount=function(){return this._edges.length},t.prototype.createNode=function(e,t){return this._createNode(e,t,(this.__uniqval__--).toString(16))},t.prototype._createNode=function(e,t,n){return this._addNode(new r.Node(e,t,n))},t.prototype._addNode=function(e){return this._nodes.push(e),this._lookup[e.__uniqid__]=e,this.nodes(e.entity)._add(e)},t.prototype.createEdge=function(e,t){return this._createEdge(e,t,(this.__uniqval__--).toString(16))},t.prototype._createEdge=function(e,t,n){return this._addEdge(new a.Edge(e,t,n))},t.prototype._addEdge=function(e){return this._edges.push(e),this._lookup[e.__uniqid__]=e,this.edges(e.entity)._add(e)},t.prototype.nodes=function(e){return this._nodeCollections[e]||(this._nodeCollections[e]=new o.NodeCollection(e))},t.prototype.edges=function(e){return this._edgeCollections[e]||(this._edgeCollections[e]=new i.EdgeCollection(e))},t.prototype._getPath=function(e,t){for(var n=t[e.__uniqid__];n[0]instanceof a.Edge;){n=t[n[0].oppositeNode(n[1]).__uniqid__].concat(n)}return n},t.prototype.closest=function(e,t){return t=t||{},this._search(e,t.compare,t.count,t.direction,t.minDepth,t.maxDepth)},t.prototype.trace=function(e,t,n){return this._search(e,(function(e){return e===t}),1,n,void 0,void 0)[0]||new l.Path([])},t.prototype._search=function(e,t,n,s,r,a){t="function"==typeof t?t:function(e){return!0},s|=0,n=Math.max(0,0|n),r=Math.max(0,0|r),a=Math.max(0,0|a);var o=Object.create(null);o[e.__uniqid__]=[e];var i=new Map;i.set(0,[e]);var c=[0],u=[],h=this._getPath;function d(e,t){i.has(t)?i.get(t).push(e):i.set(t,[e]),function(e,t){var n=e.length,s=n>>>1;for(;n;){if(n>>>=1,e[s]===t)return e;e[s]<t?s+=n:s-=n}var r=e[s]<t?1:0;e.splice(s+r,0,t)}(c,t)}function p(e,n){for(var i=0===s?e.edges:s>0?e.outputEdges:e.inputEdges,c=0,u=i.length;c<u;c++){var p=i[c],f=n+p.distance;if(!(a&&f>a)){var m=i[c].oppositeNode(e);o[m.__uniqid__]||(o[m.__uniqid__]=[p,m],d(m,f))}}return!!(n>=r&&t(e))&&new l.Path(h(e,o))}for(;c.length;)for(var f=c.shift(),m=i.get(f);m.length;){var g=p(m.shift(),f);if(g&&u.push(g),n&&u.length>=n)return u}return u},t.prototype.toJSON=function(){var e=this._nodeCollections,t=Object.keys(e).map((function(t){return e[t].toJSON()})),n=this._edgeCollections,s=Object.keys(n).map((function(e){return n[e].toJSON()})),r=this._nodes.map((function(e){return e.toJSON()})),a=this._edges.map((function(e){return e.toJSON()}));return JSON.stringify({nc:t,ec:s,n:r,e:a})},t.prototype.fromJSON=function(e){this.__init__();for(var t=JSON.parse(e),n=t.nc,s=t.ec,r=0,a=n.length;r<a;r++){var o=n[r];this.nodes(o[0]).createIndices(o[1])}for(r=0,a=s.length;r<a;r++){o=s[r];this.edges(o[0]).createIndices(o[1])}var i=t.n,l=t.e;for(r=0,a=i.length;r<a;r++){var c=i[r];this._createNode(c[0],c[1],c[2]);var u=parseInt(c[2],16);this.__uniqval__=u<this.__uniqval__?u-1:this.__uniqval__}for(r=0,a=l.length;r<a;r++){var h=l[r];this._createEdge(h[0],h[1],h[2]).link(this._lookup[h[3]],this._lookup[h[4]],h[5]).setDistance(h[6]);u=parseInt(h[2],16);this.__uniqval__=u<this.__uniqval__?u-1:this.__uniqval__}return this},t.prototype.gzip=function(t){var n=new e(this.toJSON());return t=t.bind(this),u.gzip(n,t),this},t.prototype.gunzip=function(t,n){n=n.bind(this);var s=this.fromJSON.bind(this);e.isBuffer(t)||(t=new e(t,"binary")),u.gunzip(t,(function(e,t){!e&&s(t.toString()),n(e)}))},t.prototype.save=function(e,t){return t=t.bind(this),this.gzip((function(n,s){n?t(n):c.writeFile(e,s,t)})),this},t.prototype.load=function(e,t){t=t.bind(this);var n=this.gunzip.bind(this);return c.readFile(e,(function(e,s){e?t(e):n(s,t)})),this},t}();t.Graph=h,t.default=function(){return h}}).call(this,n(96).Buffer)},function(e,t,n){"use strict";var s,r=this&&this.__extends||(s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(t,n,s){var r=e.call(this,t,n,s)||this;return r.edges=[],r.inputEdges=[],r.outputEdges=[],r}return r(t,e),t.prototype.unlink=function(){for(var e=this.edges,t=0,n=e.length;t<n;t++)e[t].unlink();return!0},t.prototype.toJSON=function(){return e.prototype.toJSON.call(this)},t}(n(214).Unit);t.Node=a,t.default=function(){return a}},function(e,t,n){"use strict";var s,r=this&&this.__extends||(s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(t,n,s){var r=e.call(this,t,n,s)||this;return r.inputNode=null,r.outputNode=null,r.duplex=!1,r.distance=1,r}return r(t,e),t.prototype._linkTo=function(e,t){if(t<=0&&e.inputEdges.push(this),t>=0){e.outputEdges.push(this)}return e.edges.push(this),!0},t.prototype.link=function(e,t,n){return this.unlink(),this.inputNode=e,this.outputNode=t,this.duplex=!!n,n?(this._linkTo(e,0),this._linkTo(t,0),this):(this._linkTo(e,1),this._linkTo(t,-1),this)},t.prototype.setDistance=function(e){return this.distance=Math.abs(e||0),this},t.prototype.setWeight=function(e){return this.distance=1/Math.abs(e||0),this},t.prototype.oppositeNode=function(e){return this.inputNode===e?this.outputNode:this.outputNode===e?this.inputNode:void 0},t.prototype.unlink=function(){var e,t=this.inputNode,n=this.outputNode;if(t&&n)return(e=t.edges.indexOf(this))>-1&&t.edges.splice(e,1),(e=n.edges.indexOf(this))>-1&&n.edges.splice(e,1),(e=t.outputEdges.indexOf(this))>-1&&t.outputEdges.splice(e,1),(e=n.inputEdges.indexOf(this))>-1&&n.inputEdges.splice(e,1),this.duplex&&((e=t.inputEdges.indexOf(this))>-1&&t.inputEdges.splice(e,1),(e=n.outputEdges.indexOf(this))>-1&&n.outputEdges.splice(e,1)),this.inputNode=null,this.outputNode=null,this.duplex=!1,!0},t.prototype.toJSON=function(){return e.prototype.toJSON.call(this).concat([this.inputNode.__uniqid__,this.outputNode.__uniqid__,this.duplex?1:0,this.distance])},t}(n(214).Unit);t.Edge=a,t.default=function(){return a}},function(e,t,n){"use strict";var s,r=this&&this.__extends||(s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t}(n(215).Collection);t.NodeCollection=a,t.default=function(){return a}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s={is:function(e,t){return e===t},not:function(e,t){return e!==t},gt:function(e,t){return e>t},lt:function(e,t){return e<t},gte:function(e,t){return e>=t},lte:function(e,t){return e<=t},ilike:function(e,t){return e.toLowerCase().indexOf(t.toLowerCase())>-1},like:function(e,t){return e.indexOf(t)>-1},in:function(e,t){return t.indexOf(e)>-1},not_in:function(e,t){return-1===t.indexOf(e)}},r=function(){function e(e){this._units=e.slice()}return e.prototype.__filter=function(t,n){n=!!n;for(var r=0,a=t.length;r<a;r++)"object"==typeof t[r]&&null!==t[r]||(t[r]={});t.length||(t=[{}]);for(var o,i,l,c,u,h,d,p,f,m,g=this._units.slice(),y=t.length,v=0;v!==y;v++){o=t[v],c=[];r=0;for(var b=(i=Object.keys(o)).length;r<b;r++){if((u=(l=i[r]).split("__")).length<2&&u.push("is"),h=u.pop(),!s[h])throw new Error('Filter type "'+h+'" not supported.');c.push([s[h],u,o[l]])}t[v]=c}var _,E,S=g.length,w=0,C=Array(S);try{for(r=0;r!==S;r++){var O=g[r];f=O.properties,_=!0;for(var T=0;T!==y&&_;T++){_=!1,m=(c=t[T]).length;for(var M=0;M!==m&&!_;M++){p=(d=c[M])[0],E=f,l=d[1];v=0;for(var A=l.length;v!==A;v++)E=E[l[v]];p(E,d[2])===n&&(_=!0)}!_&&(C[w++]=O)}}}catch(e){throw console.log(e),new Error("Nested field "+l.join("__")+" does not exist")}return new e(C=C.slice(0,w))},e.prototype.filter=function(){var e=[].slice.call(arguments);return e=e[0]instanceof Array?e[0]:e,this.__filter(e,!1)},e.prototype.exclude=function(){var e=[].slice.call(arguments);return e=e[0]instanceof Array?e[0]:e,this.__filter(e,!0)},e.prototype.first=function(){return this._units[0]},e.prototype.last=function(){var e=this._units;return e[e.length-1]},e.prototype.units=function(){return this._units.slice()},e}();t.Query=r,t.default=function(){return r}},function(e,t,n){"use strict";var s,r=this&&this.__extends||(s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t}(n(215).Collection);t.EdgeCollection=a,t.default=function(){return a}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e){this._raw=e.slice()}return e.prototype.start=function(){return this._raw[0]},e.prototype.end=function(){return this._raw[this._raw.length-1]},e.prototype.length=function(){return this._raw.length>>>1},e.prototype.distance=function(){return this._raw.filter((function(e,t){return!!(1&t)})).reduce((function(e,t){return e+t.distance}),0)},e.prototype.prettify=function(){return this._raw.map((function(e,t,n){var s=e.toString();if(1&t){if(e.duplex)return["<>",s,"<>"].join(" ");var r=n[t-1];return e.inputNode===r?[">>",s,">>"].join(" "):["<<",s,"<<"].join(" ")}return s})).join(" ")},e.prototype.toString=function(){return this.prettify()},e}();t.Path=s,t.default=function(){return s}},function(e,t,n){"use strict";(function(t,s){var r=n(154);e.exports=b;var a,o=n(636);b.ReadableState=v;n(216).EventEmitter;var i=function(e,t){return e.listeners(t).length},l=n(323),c=n(155).Buffer,u=t.Uint8Array||function(){};var h=n(116);h.inherits=n(78);var d=n(637),p=void 0;p=d&&d.debuglog?d.debuglog("stream"):function(){};var f,m=n(638),g=n(324);h.inherits(b,l);var y=["error","close","destroy","pause","resume"];function v(e,t){e=e||{};var s=t instanceof(a=a||n(79));this.objectMode=!!e.objectMode,s&&(this.objectMode=this.objectMode||!!e.readableObjectMode);var r=e.highWaterMark,o=e.readableHighWaterMark,i=this.objectMode?16:16384;this.highWaterMark=r||0===r?r:s&&(o||0===o)?o:i,this.highWaterMark=Math.floor(this.highWaterMark),this.buffer=new m,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.destroyed=!1,this.defaultEncoding=e.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,e.encoding&&(f||(f=n(325).StringDecoder),this.decoder=new f(e.encoding),this.encoding=e.encoding)}function b(e){if(a=a||n(79),!(this instanceof b))return new b(e);this._readableState=new v(e,this),this.readable=!0,e&&("function"==typeof e.read&&(this._read=e.read),"function"==typeof e.destroy&&(this._destroy=e.destroy)),l.call(this)}function _(e,t,n,s,r){var a,o=e._readableState;null===t?(o.reading=!1,function(e,t){if(t.ended)return;if(t.decoder){var n=t.decoder.end();n&&n.length&&(t.buffer.push(n),t.length+=t.objectMode?1:n.length)}t.ended=!0,w(e)}(e,o)):(r||(a=function(e,t){var n;s=t,c.isBuffer(s)||s instanceof u||"string"==typeof t||void 0===t||e.objectMode||(n=new TypeError("Invalid non-string/buffer chunk"));var s;return n}(o,t)),a?e.emit("error",a):o.objectMode||t&&t.length>0?("string"==typeof t||o.objectMode||Object.getPrototypeOf(t)===c.prototype||(t=function(e){return c.from(e)}(t)),s?o.endEmitted?e.emit("error",new Error("stream.unshift() after end event")):E(e,o,t,!0):o.ended?e.emit("error",new Error("stream.push() after EOF")):(o.reading=!1,o.decoder&&!n?(t=o.decoder.write(t),o.objectMode||0!==t.length?E(e,o,t,!1):O(e,o)):E(e,o,t,!1))):s||(o.reading=!1));return function(e){return!e.ended&&(e.needReadable||e.length<e.highWaterMark||0===e.length)}(o)}function E(e,t,n,s){t.flowing&&0===t.length&&!t.sync?(e.emit("data",n),e.read(0)):(t.length+=t.objectMode?1:n.length,s?t.buffer.unshift(n):t.buffer.push(n),t.needReadable&&w(e)),O(e,t)}Object.defineProperty(b.prototype,"destroyed",{get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(e){this._readableState&&(this._readableState.destroyed=e)}}),b.prototype.destroy=g.destroy,b.prototype._undestroy=g.undestroy,b.prototype._destroy=function(e,t){this.push(null),t(e)},b.prototype.push=function(e,t){var n,s=this._readableState;return s.objectMode?n=!0:"string"==typeof e&&((t=t||s.defaultEncoding)!==s.encoding&&(e=c.from(e,t),t=""),n=!0),_(this,e,t,!1,n)},b.prototype.unshift=function(e){return _(this,e,null,!0,!1)},b.prototype.isPaused=function(){return!1===this._readableState.flowing},b.prototype.setEncoding=function(e){return f||(f=n(325).StringDecoder),this._readableState.decoder=new f(e),this._readableState.encoding=e,this};function S(e,t){return e<=0||0===t.length&&t.ended?0:t.objectMode?1:e!=e?t.flowing&&t.length?t.buffer.head.data.length:t.length:(e>t.highWaterMark&&(t.highWaterMark=function(e){return e>=8388608?e=8388608:(e--,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e++),e}(e)),e<=t.length?e:t.ended?t.length:(t.needReadable=!0,0))}function w(e){var t=e._readableState;t.needReadable=!1,t.emittedReadable||(p("emitReadable",t.flowing),t.emittedReadable=!0,t.sync?r.nextTick(C,e):C(e))}function C(e){p("emit readable"),e.emit("readable"),N(e)}function O(e,t){t.readingMore||(t.readingMore=!0,r.nextTick(T,e,t))}function T(e,t){for(var n=t.length;!t.reading&&!t.flowing&&!t.ended&&t.length<t.highWaterMark&&(p("maybeReadMore read 0"),e.read(0),n!==t.length);)n=t.length;t.readingMore=!1}function M(e){p("readable nexttick read 0"),e.read(0)}function A(e,t){t.reading||(p("resume read 0"),e.read(0)),t.resumeScheduled=!1,t.awaitDrain=0,e.emit("resume"),N(e),t.flowing&&!t.reading&&e.read(0)}function N(e){var t=e._readableState;for(p("flow",t.flowing);t.flowing&&null!==e.read(););}function x(e,t){return 0===t.length?null:(t.objectMode?n=t.buffer.shift():!e||e>=t.length?(n=t.decoder?t.buffer.join(""):1===t.buffer.length?t.buffer.head.data:t.buffer.concat(t.length),t.buffer.clear()):n=function(e,t,n){var s;e<t.head.data.length?(s=t.head.data.slice(0,e),t.head.data=t.head.data.slice(e)):s=e===t.head.data.length?t.shift():n?function(e,t){var n=t.head,s=1,r=n.data;e-=r.length;for(;n=n.next;){var a=n.data,o=e>a.length?a.length:e;if(o===a.length?r+=a:r+=a.slice(0,e),0===(e-=o)){o===a.length?(++s,n.next?t.head=n.next:t.head=t.tail=null):(t.head=n,n.data=a.slice(o));break}++s}return t.length-=s,r}(e,t):function(e,t){var n=c.allocUnsafe(e),s=t.head,r=1;s.data.copy(n),e-=s.data.length;for(;s=s.next;){var a=s.data,o=e>a.length?a.length:e;if(a.copy(n,n.length-e,0,o),0===(e-=o)){o===a.length?(++r,s.next?t.head=s.next:t.head=t.tail=null):(t.head=s,s.data=a.slice(o));break}++r}return t.length-=r,n}(e,t);return s}(e,t.buffer,t.decoder),n);var n}function P(e){var t=e._readableState;if(t.length>0)throw new Error('"endReadable()" called on non-empty stream');t.endEmitted||(t.ended=!0,r.nextTick(I,t,e))}function I(e,t){e.endEmitted||0!==e.length||(e.endEmitted=!0,t.readable=!1,t.emit("end"))}function D(e,t){for(var n=0,s=e.length;n<s;n++)if(e[n]===t)return n;return-1}b.prototype.read=function(e){p("read",e),e=parseInt(e,10);var t=this._readableState,n=e;if(0!==e&&(t.emittedReadable=!1),0===e&&t.needReadable&&(t.length>=t.highWaterMark||t.ended))return p("read: emitReadable",t.length,t.ended),0===t.length&&t.ended?P(this):w(this),null;if(0===(e=S(e,t))&&t.ended)return 0===t.length&&P(this),null;var s,r=t.needReadable;return p("need readable",r),(0===t.length||t.length-e<t.highWaterMark)&&p("length less than watermark",r=!0),t.ended||t.reading?p("reading or ended",r=!1):r&&(p("do read"),t.reading=!0,t.sync=!0,0===t.length&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1,t.reading||(e=S(n,t))),null===(s=e>0?x(e,t):null)?(t.needReadable=!0,e=0):t.length-=e,0===t.length&&(t.ended||(t.needReadable=!0),n!==e&&t.ended&&P(this)),null!==s&&this.emit("data",s),s},b.prototype._read=function(e){this.emit("error",new Error("_read() is not implemented"))},b.prototype.pipe=function(e,t){var n=this,a=this._readableState;switch(a.pipesCount){case 0:a.pipes=e;break;case 1:a.pipes=[a.pipes,e];break;default:a.pipes.push(e)}a.pipesCount+=1,p("pipe count=%d opts=%j",a.pipesCount,t);var l=(!t||!1!==t.end)&&e!==s.stdout&&e!==s.stderr?u:b;function c(t,s){p("onunpipe"),t===n&&s&&!1===s.hasUnpiped&&(s.hasUnpiped=!0,p("cleanup"),e.removeListener("close",y),e.removeListener("finish",v),e.removeListener("drain",h),e.removeListener("error",g),e.removeListener("unpipe",c),n.removeListener("end",u),n.removeListener("end",b),n.removeListener("data",m),d=!0,!a.awaitDrain||e._writableState&&!e._writableState.needDrain||h())}function u(){p("onend"),e.end()}a.endEmitted?r.nextTick(l):n.once("end",l),e.on("unpipe",c);var h=function(e){return function(){var t=e._readableState;p("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,0===t.awaitDrain&&i(e,"data")&&(t.flowing=!0,N(e))}}(n);e.on("drain",h);var d=!1;var f=!1;function m(t){p("ondata"),f=!1,!1!==e.write(t)||f||((1===a.pipesCount&&a.pipes===e||a.pipesCount>1&&-1!==D(a.pipes,e))&&!d&&(p("false write response, pause",n._readableState.awaitDrain),n._readableState.awaitDrain++,f=!0),n.pause())}function g(t){p("onerror",t),b(),e.removeListener("error",g),0===i(e,"error")&&e.emit("error",t)}function y(){e.removeListener("finish",v),b()}function v(){p("onfinish"),e.removeListener("close",y),b()}function b(){p("unpipe"),n.unpipe(e)}return n.on("data",m),function(e,t,n){if("function"==typeof e.prependListener)return e.prependListener(t,n);e._events&&e._events[t]?o(e._events[t])?e._events[t].unshift(n):e._events[t]=[n,e._events[t]]:e.on(t,n)}(e,"error",g),e.once("close",y),e.once("finish",v),e.emit("pipe",n),a.flowing||(p("pipe resume"),n.resume()),e},b.prototype.unpipe=function(e){var t=this._readableState,n={hasUnpiped:!1};if(0===t.pipesCount)return this;if(1===t.pipesCount)return e&&e!==t.pipes||(e||(e=t.pipes),t.pipes=null,t.pipesCount=0,t.flowing=!1,e&&e.emit("unpipe",this,n)),this;if(!e){var s=t.pipes,r=t.pipesCount;t.pipes=null,t.pipesCount=0,t.flowing=!1;for(var a=0;a<r;a++)s[a].emit("unpipe",this,n);return this}var o=D(t.pipes,e);return-1===o||(t.pipes.splice(o,1),t.pipesCount-=1,1===t.pipesCount&&(t.pipes=t.pipes[0]),e.emit("unpipe",this,n)),this},b.prototype.on=function(e,t){var n=l.prototype.on.call(this,e,t);if("data"===e)!1!==this._readableState.flowing&&this.resume();else if("readable"===e){var s=this._readableState;s.endEmitted||s.readableListening||(s.readableListening=s.needReadable=!0,s.emittedReadable=!1,s.reading?s.length&&w(this):r.nextTick(M,this))}return n},b.prototype.addListener=b.prototype.on,b.prototype.resume=function(){var e=this._readableState;return e.flowing||(p("resume"),e.flowing=!0,function(e,t){t.resumeScheduled||(t.resumeScheduled=!0,r.nextTick(A,e,t))}(this,e)),this},b.prototype.pause=function(){return p("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(p("pause"),this._readableState.flowing=!1,this.emit("pause")),this},b.prototype.wrap=function(e){var t=this,n=this._readableState,s=!1;for(var r in e.on("end",(function(){if(p("wrapped end"),n.decoder&&!n.ended){var e=n.decoder.end();e&&e.length&&t.push(e)}t.push(null)})),e.on("data",(function(r){(p("wrapped data"),n.decoder&&(r=n.decoder.write(r)),n.objectMode&&null==r)||(n.objectMode||r&&r.length)&&(t.push(r)||(s=!0,e.pause()))})),e)void 0===this[r]&&"function"==typeof e[r]&&(this[r]=function(t){return function(){return e[t].apply(e,arguments)}}(r));for(var a=0;a<y.length;a++)e.on(y[a],this.emit.bind(this,y[a]));return this._read=function(t){p("wrapped _read",t),s&&(s=!1,e.resume())},this},b._fromList=x}).call(this,n(35),n(43))},function(e,t,n){e.exports=n(216).EventEmitter},function(e,t,n){"use strict";var s=n(154);function r(e,t){e.emit("error",t)}e.exports={destroy:function(e,t){var n=this,a=this._readableState&&this._readableState.destroyed,o=this._writableState&&this._writableState.destroyed;return a||o?(t?t(e):!e||this._writableState&&this._writableState.errorEmitted||s.nextTick(r,this,e),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(e||null,(function(e){!t&&e?(s.nextTick(r,n,e),n._writableState&&(n._writableState.errorEmitted=!0)):t&&t(e)})),this)},undestroy:function(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}}},function(e,t,n){"use strict";var s=n(155).Buffer,r=s.isEncoding||function(e){switch((e=""+e)&&e.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function a(e){var t;switch(this.encoding=function(e){var t=function(e){if(!e)return"utf8";for(var t;;)switch(e){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:if(t)return;e=(""+e).toLowerCase(),t=!0}}(e);if("string"!=typeof t&&(s.isEncoding===r||!r(e)))throw new Error("Unknown encoding: "+e);return t||e}(e),this.encoding){case"utf16le":this.text=l,this.end=c,t=4;break;case"utf8":this.fillLast=i,t=4;break;case"base64":this.text=u,this.end=h,t=3;break;default:return this.write=d,void(this.end=p)}this.lastNeed=0,this.lastTotal=0,this.lastChar=s.allocUnsafe(t)}function o(e){return e<=127?0:e>>5==6?2:e>>4==14?3:e>>3==30?4:-1}function i(e){var t=this.lastTotal-this.lastNeed,n=function(e,t,n){if(128!=(192&t[0]))return e.lastNeed=0,"๏ฟฝ".repeat(n);if(e.lastNeed>1&&t.length>1){if(128!=(192&t[1]))return e.lastNeed=1,"๏ฟฝ".repeat(n+1);if(e.lastNeed>2&&t.length>2&&128!=(192&t[2]))return e.lastNeed=2,"๏ฟฝ".repeat(n+2)}}(this,e,t);return void 0!==n?n:this.lastNeed<=e.length?(e.copy(this.lastChar,t,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(e.copy(this.lastChar,t,0,e.length),void(this.lastNeed-=e.length))}function l(e,t){if((e.length-t)%2==0){var n=e.toString("utf16le",t);if(n){var s=n.charCodeAt(n.length-1);if(s>=55296&&s<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1],n.slice(0,-1)}return n}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=e[e.length-1],e.toString("utf16le",t,e.length-1)}function c(e){var t=e&&e.length?this.write(e):"";if(this.lastNeed){var n=this.lastTotal-this.lastNeed;return t+this.lastChar.toString("utf16le",0,n)}return t}function u(e,t){var n=(e.length-t)%3;return 0===n?e.toString("base64",t):(this.lastNeed=3-n,this.lastTotal=3,1===n?this.lastChar[0]=e[e.length-1]:(this.lastChar[0]=e[e.length-2],this.lastChar[1]=e[e.length-1]),e.toString("base64",t,e.length-n))}function h(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+this.lastChar.toString("base64",0,3-this.lastNeed):t}function d(e){return e.toString(this.encoding)}function p(e){return e&&e.length?this.write(e):""}t.StringDecoder=a,a.prototype.write=function(e){if(0===e.length)return"";var t,n;if(this.lastNeed){if(void 0===(t=this.fillLast(e)))return"";n=this.lastNeed,this.lastNeed=0}else n=0;return n<e.length?t?t+this.text(e,n):this.text(e,n):t||""},a.prototype.end=function(e){var t=e&&e.length?this.write(e):"";return this.lastNeed?t+"๏ฟฝ".repeat(this.lastTotal-this.lastNeed):t},a.prototype.text=function(e,t){var n=function(e,t,n){var s=t.length-1;if(s<n)return 0;var r=o(t[s]);if(r>=0)return r>0&&(e.lastNeed=r-1),r;if(--s<n)return 0;if((r=o(t[s]))>=0)return r>0&&(e.lastNeed=r-2),r;if(--s<n)return 0;if((r=o(t[s]))>=0)return r>0&&(2===r?r=0:e.lastNeed=r-3),r;return 0}(this,e,t);if(!this.lastNeed)return e.toString("utf8",t);this.lastTotal=n;var s=e.length-(n-this.lastNeed);return e.copy(this.lastChar,0,s),e.toString("utf8",t,s)},a.prototype.fillLast=function(e){if(this.lastNeed<=e.length)return e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);e.copy(this.lastChar,this.lastTotal-this.lastNeed,0,e.length),this.lastNeed-=e.length}},function(e,t,n){"use strict";e.exports=o;var s=n(79),r=n(116);function a(e,t){var n=this._transformState;n.transforming=!1;var s=n.writecb;if(!s)return this.emit("error",new Error("write callback called multiple times"));n.writechunk=null,n.writecb=null,null!=t&&this.push(t),s(e);var r=this._readableState;r.reading=!1,(r.needReadable||r.length<r.highWaterMark)&&this._read(r.highWaterMark)}function o(e){if(!(this instanceof o))return new o(e);s.call(this,e),this._transformState={afterTransform:a.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,e&&("function"==typeof e.transform&&(this._transform=e.transform),"function"==typeof e.flush&&(this._flush=e.flush)),this.on("prefinish",i)}function i(){var e=this;"function"==typeof this._flush?this._flush((function(t,n){l(e,t,n)})):l(this,null,null)}function l(e,t,n){if(t)return e.emit("error",t);if(null!=n&&e.push(n),e._writableState.length)throw new Error("Calling transform done when ws.length != 0");if(e._transformState.transforming)throw new Error("Calling transform done when still transforming");return e.push(null)}r.inherits=n(78),r.inherits(o,s),o.prototype.push=function(e,t){return this._transformState.needTransform=!1,s.prototype.push.call(this,e,t)},o.prototype._transform=function(e,t,n){throw new Error("_transform() is not implemented")},o.prototype._write=function(e,t,n){var s=this._transformState;if(s.writecb=n,s.writechunk=e,s.writeencoding=t,!s.transforming){var r=this._readableState;(s.needTransform||r.needReadable||r.length<r.highWaterMark)&&this._read(r.highWaterMark)}},o.prototype._read=function(e){var t=this._transformState;null!==t.writechunk&&t.writecb&&!t.transforming?(t.transforming=!0,this._transform(t.writechunk,t.writeencoding,t.afterTransform)):t.needTransform=!0},o.prototype._destroy=function(e,t){var n=this;s.prototype._destroy.call(this,e,(function(e){t(e),n.emit("close")}))}},function(e,t,n){"use strict";(function(t){var s=n(21);
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 */function r(e,t){if(e===t)return 0;for(var n=e.length,s=t.length,r=0,a=Math.min(n,s);r<a;++r)if(e[r]!==t[r]){n=e[r],s=t[r];break}return n<s?-1:s<n?1:0}function a(e){return t.Buffer&&"function"==typeof t.Buffer.isBuffer?t.Buffer.isBuffer(e):!(null==e||!e._isBuffer)}var o=n(328),i=Object.prototype.hasOwnProperty,l=Array.prototype.slice,c="foo"===function(){}.name;function u(e){return Object.prototype.toString.call(e)}function h(e){return!a(e)&&("function"==typeof t.ArrayBuffer&&("function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):!!e&&(e instanceof DataView||!!(e.buffer&&e.buffer instanceof ArrayBuffer))))}var d=e.exports=v,p=/\s*function\s+([^\(\s]*)\s*/;function f(e){if(o.isFunction(e)){if(c)return e.name;var t=e.toString().match(p);return t&&t[1]}}function m(e,t){return"string"==typeof e?e.length<t?e:e.slice(0,t):e}function g(e){if(c||!o.isFunction(e))return o.inspect(e);var t=f(e);return"[Function"+(t?": "+t:"")+"]"}function y(e,t,n,s,r){throw new d.AssertionError({message:n,actual:e,expected:t,operator:s,stackStartFunction:r})}function v(e,t){e||y(e,!0,t,"==",d.ok)}function b(e,t,n,s){if(e===t)return!0;if(a(e)&&a(t))return 0===r(e,t);if(o.isDate(e)&&o.isDate(t))return e.getTime()===t.getTime();if(o.isRegExp(e)&&o.isRegExp(t))return e.source===t.source&&e.global===t.global&&e.multiline===t.multiline&&e.lastIndex===t.lastIndex&&e.ignoreCase===t.ignoreCase;if(null!==e&&"object"==typeof e||null!==t&&"object"==typeof t){if(h(e)&&h(t)&&u(e)===u(t)&&!(e instanceof Float32Array||e instanceof Float64Array))return 0===r(new Uint8Array(e.buffer),new Uint8Array(t.buffer));if(a(e)!==a(t))return!1;var i=(s=s||{actual:[],expected:[]}).actual.indexOf(e);return-1!==i&&i===s.expected.indexOf(t)||(s.actual.push(e),s.expected.push(t),function(e,t,n,s){if(null==e||null==t)return!1;if(o.isPrimitive(e)||o.isPrimitive(t))return e===t;if(n&&Object.getPrototypeOf(e)!==Object.getPrototypeOf(t))return!1;var r=_(e),a=_(t);if(r&&!a||!r&&a)return!1;if(r)return e=l.call(e),t=l.call(t),b(e,t,n);var i,c,u=w(e),h=w(t);if(u.length!==h.length)return!1;for(u.sort(),h.sort(),c=u.length-1;c>=0;c--)if(u[c]!==h[c])return!1;for(c=u.length-1;c>=0;c--)if(i=u[c],!b(e[i],t[i],n,s))return!1;return!0}(e,t,n,s))}return n?e===t:e==t}function _(e){return"[object Arguments]"==Object.prototype.toString.call(e)}function E(e,t){if(!e||!t)return!1;if("[object RegExp]"==Object.prototype.toString.call(t))return t.test(e);try{if(e instanceof t)return!0}catch(e){}return!Error.isPrototypeOf(t)&&!0===t.call({},e)}function S(e,t,n,s){var r;if("function"!=typeof t)throw new TypeError('"block" argument must be a function');"string"==typeof n&&(s=n,n=null),r=function(e){var t;try{e()}catch(e){t=e}return t}(t),s=(n&&n.name?" ("+n.name+").":".")+(s?" "+s:"."),e&&!r&&y(r,n,"Missing expected exception"+s);var a="string"==typeof s,i=!e&&r&&!n;if((!e&&o.isError(r)&&a&&E(r,n)||i)&&y(r,n,"Got unwanted exception"+s),e&&r&&n&&!E(r,n)||!e&&r)throw r}d.AssertionError=function(e){this.name="AssertionError",this.actual=e.actual,this.expected=e.expected,this.operator=e.operator,e.message?(this.message=e.message,this.generatedMessage=!1):(this.message=function(e){return m(g(e.actual),128)+" "+e.operator+" "+m(g(e.expected),128)}(this),this.generatedMessage=!0);var t=e.stackStartFunction||y;if(Error.captureStackTrace)Error.captureStackTrace(this,t);else{var n=new Error;if(n.stack){var s=n.stack,r=f(t),a=s.indexOf("\n"+r);if(a>=0){var o=s.indexOf("\n",a+1);s=s.substring(o+1)}this.stack=s}}},o.inherits(d.AssertionError,Error),d.fail=y,d.ok=v,d.equal=function(e,t,n){e!=t&&y(e,t,n,"==",d.equal)},d.notEqual=function(e,t,n){e==t&&y(e,t,n,"!=",d.notEqual)},d.deepEqual=function(e,t,n){b(e,t,!1)||y(e,t,n,"deepEqual",d.deepEqual)},d.deepStrictEqual=function(e,t,n){b(e,t,!0)||y(e,t,n,"deepStrictEqual",d.deepStrictEqual)},d.notDeepEqual=function(e,t,n){b(e,t,!1)&&y(e,t,n,"notDeepEqual",d.notDeepEqual)},d.notDeepStrictEqual=function e(t,n,s){b(t,n,!0)&&y(t,n,s,"notDeepStrictEqual",e)},d.strictEqual=function(e,t,n){e!==t&&y(e,t,n,"===",d.strictEqual)},d.notStrictEqual=function(e,t,n){e===t&&y(e,t,n,"!==",d.notStrictEqual)},d.throws=function(e,t,n){S(!0,e,t,n)},d.doesNotThrow=function(e,t,n){S(!1,e,t,n)},d.ifError=function(e){if(e)throw e},d.strict=s((function e(t,n){t||y(t,!0,n,"==",e)}),d,{equal:d.strictEqual,deepEqual:d.deepStrictEqual,notEqual:d.notStrictEqual,notDeepEqual:d.notDeepStrictEqual}),d.strict.strict=d.strict;var w=Object.keys||function(e){var t=[];for(var n in e)i.call(e,n)&&t.push(n);return t}}).call(this,n(35))},function(e,t,n){(function(e){var s=Object.getOwnPropertyDescriptors||function(e){for(var t=Object.keys(e),n={},s=0;s<t.length;s++)n[t[s]]=Object.getOwnPropertyDescriptor(e,t[s]);return n},r=/%[sdj%]/g;t.format=function(e){if(!y(e)){for(var t=[],n=0;n<arguments.length;n++)t.push(i(arguments[n]));return t.join(" ")}n=1;for(var s=arguments,a=s.length,o=String(e).replace(r,(function(e){if("%%"===e)return"%";if(n>=a)return e;switch(e){case"%s":return String(s[n++]);case"%d":return Number(s[n++]);case"%j":try{return JSON.stringify(s[n++])}catch(e){return"[Circular]"}default:return e}})),l=s[n];n<a;l=s[++n])m(l)||!_(l)?o+=" "+l:o+=" "+i(l);return o},t.deprecate=function(n,s){if(void 0!==e&&!0===e.noDeprecation)return n;if(void 0===e)return function(){return t.deprecate(n,s).apply(this,arguments)};var r=!1;return function(){if(!r){if(e.throwDeprecation)throw new Error(s);e.traceDeprecation?console.trace(s):console.error(s),r=!0}return n.apply(this,arguments)}};var a,o={};function i(e,n){var s={seen:[],stylize:c};return arguments.length>=3&&(s.depth=arguments[2]),arguments.length>=4&&(s.colors=arguments[3]),f(n)?s.showHidden=n:n&&t._extend(s,n),v(s.showHidden)&&(s.showHidden=!1),v(s.depth)&&(s.depth=2),v(s.colors)&&(s.colors=!1),v(s.customInspect)&&(s.customInspect=!0),s.colors&&(s.stylize=l),u(s,e,s.depth)}function l(e,t){var n=i.styles[t];return n?"["+i.colors[n][0]+"m"+e+"["+i.colors[n][1]+"m":e}function c(e,t){return e}function u(e,n,s){if(e.customInspect&&n&&w(n.inspect)&&n.inspect!==t.inspect&&(!n.constructor||n.constructor.prototype!==n)){var r=n.inspect(s,e);return y(r)||(r=u(e,r,s)),r}var a=function(e,t){if(v(t))return e.stylize("undefined","undefined");if(y(t)){var n="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(n,"string")}if(g(t))return e.stylize(""+t,"number");if(f(t))return e.stylize(""+t,"boolean");if(m(t))return e.stylize("null","null")}(e,n);if(a)return a;var o=Object.keys(n),i=function(e){var t={};return e.forEach((function(e,n){t[e]=!0})),t}(o);if(e.showHidden&&(o=Object.getOwnPropertyNames(n)),S(n)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return h(n);if(0===o.length){if(w(n)){var l=n.name?": "+n.name:"";return e.stylize("[Function"+l+"]","special")}if(b(n))return e.stylize(RegExp.prototype.toString.call(n),"regexp");if(E(n))return e.stylize(Date.prototype.toString.call(n),"date");if(S(n))return h(n)}var c,_="",C=!1,O=["{","}"];(p(n)&&(C=!0,O=["[","]"]),w(n))&&(_=" [Function"+(n.name?": "+n.name:"")+"]");return b(n)&&(_=" "+RegExp.prototype.toString.call(n)),E(n)&&(_=" "+Date.prototype.toUTCString.call(n)),S(n)&&(_=" "+h(n)),0!==o.length||C&&0!=n.length?s<0?b(n)?e.stylize(RegExp.prototype.toString.call(n),"regexp"):e.stylize("[Object]","special"):(e.seen.push(n),c=C?function(e,t,n,s,r){for(var a=[],o=0,i=t.length;o<i;++o)A(t,String(o))?a.push(d(e,t,n,s,String(o),!0)):a.push("");return r.forEach((function(r){r.match(/^\d+$/)||a.push(d(e,t,n,s,r,!0))})),a}(e,n,s,i,o):o.map((function(t){return d(e,n,s,i,t,C)})),e.seen.pop(),function(e,t,n){if(e.reduce((function(e,t){return t.indexOf("\n")>=0&&0,e+t.replace(/\u001b\[\d\d?m/g,"").length+1}),0)>60)return n[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+n[1];return n[0]+t+" "+e.join(", ")+" "+n[1]}(c,_,O)):O[0]+_+O[1]}function h(e){return"["+Error.prototype.toString.call(e)+"]"}function d(e,t,n,s,r,a){var o,i,l;if((l=Object.getOwnPropertyDescriptor(t,r)||{value:t[r]}).get?i=l.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):l.set&&(i=e.stylize("[Setter]","special")),A(s,r)||(o="["+r+"]"),i||(e.seen.indexOf(l.value)<0?(i=m(n)?u(e,l.value,null):u(e,l.value,n-1)).indexOf("\n")>-1&&(i=a?i.split("\n").map((function(e){return"  "+e})).join("\n").substr(2):"\n"+i.split("\n").map((function(e){return"   "+e})).join("\n")):i=e.stylize("[Circular]","special")),v(o)){if(a&&r.match(/^\d+$/))return i;(o=JSON.stringify(""+r)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.substr(1,o.length-2),o=e.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),o=e.stylize(o,"string"))}return o+": "+i}function p(e){return Array.isArray(e)}function f(e){return"boolean"==typeof e}function m(e){return null===e}function g(e){return"number"==typeof e}function y(e){return"string"==typeof e}function v(e){return void 0===e}function b(e){return _(e)&&"[object RegExp]"===C(e)}function _(e){return"object"==typeof e&&null!==e}function E(e){return _(e)&&"[object Date]"===C(e)}function S(e){return _(e)&&("[object Error]"===C(e)||e instanceof Error)}function w(e){return"function"==typeof e}function C(e){return Object.prototype.toString.call(e)}function O(e){return e<10?"0"+e.toString(10):e.toString(10)}t.debuglog=function(n){if(v(a)&&(a=e.env.NODE_DEBUG||""),n=n.toUpperCase(),!o[n])if(new RegExp("\\b"+n+"\\b","i").test(a)){var s=e.pid;o[n]=function(){var e=t.format.apply(t,arguments);console.error("%s %d: %s",n,s,e)}}else o[n]=function(){};return o[n]},t.inspect=i,i.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},i.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},t.isArray=p,t.isBoolean=f,t.isNull=m,t.isNullOrUndefined=function(e){return null==e},t.isNumber=g,t.isString=y,t.isSymbol=function(e){return"symbol"==typeof e},t.isUndefined=v,t.isRegExp=b,t.isObject=_,t.isDate=E,t.isError=S,t.isFunction=w,t.isPrimitive=function(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e},t.isBuffer=n(649);var T=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function M(){var e=new Date,t=[O(e.getHours()),O(e.getMinutes()),O(e.getSeconds())].join(":");return[e.getDate(),T[e.getMonth()],t].join(" ")}function A(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.log=function(){console.log("%s - %s",M(),t.format.apply(t,arguments))},t.inherits=n(78),t._extend=function(e,t){if(!t||!_(t))return e;for(var n=Object.keys(t),s=n.length;s--;)e[n[s]]=t[n[s]];return e};var N="undefined"!=typeof Symbol?Symbol("util.promisify.custom"):void 0;function x(e,t){if(!e){var n=new Error("Promise was rejected with a falsy value");n.reason=e,e=n}return t(e)}t.promisify=function(e){if("function"!=typeof e)throw new TypeError('The "original" argument must be of type Function');if(N&&e[N]){var t;if("function"!=typeof(t=e[N]))throw new TypeError('The "util.promisify.custom" argument must be of type Function');return Object.defineProperty(t,N,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}function t(){for(var t,n,s=new Promise((function(e,s){t=e,n=s})),r=[],a=0;a<arguments.length;a++)r.push(arguments[a]);r.push((function(e,s){e?n(e):t(s)}));try{e.apply(this,r)}catch(e){n(e)}return s}return Object.setPrototypeOf(t,Object.getPrototypeOf(e)),N&&Object.defineProperty(t,N,{value:t,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(t,s(e))},t.promisify.custom=N,t.callbackify=function(t){if("function"!=typeof t)throw new TypeError('The "original" argument must be of type Function');function n(){for(var n=[],s=0;s<arguments.length;s++)n.push(arguments[s]);var r=n.pop();if("function"!=typeof r)throw new TypeError("The last argument must be of type Function");var a=this,o=function(){return r.apply(a,arguments)};t.apply(this,n).then((function(t){e.nextTick(o,null,t)}),(function(t){e.nextTick(x,t,o)}))}return Object.setPrototypeOf(n,Object.getPrototypeOf(t)),Object.defineProperties(n,s(t)),n}}).call(this,n(43))},function(e,t,n){"use strict";e.exports=function(e,t,n,s){for(var r=65535&e|0,a=e>>>16&65535|0,o=0;0!==n;){n-=o=n>2e3?2e3:n;do{a=a+(r=r+t[s++]|0)|0}while(--o);r%=65521,a%=65521}return r|a<<16|0}},function(e,t,n){"use strict";var s=function(){for(var e,t=[],n=0;n<256;n++){e=n;for(var s=0;s<8;s++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t}();e.exports=function(e,t,n,r){var a=s,o=r+n;e^=-1;for(var i=r;i<o;i++)e=e>>>8^a[255&(e^t[i])];return-1^e}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(281)),a=n(92),o=s(n(22)),i=n(42),l={room:a.Room,corridor:a.Corridor};class c extends r.default{constructor(e,t,n={}){super(e,t),this._options=Object.assign({roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3},n),this._features={room:4,corridor:4},this._map=[],this._featureAttempts=20,this._walls={},this._dug=0,this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this),this._xyToFeat={}}create(e){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;const t=(this._width-2)*(this._height-2);this._firstRoom();const n=Date.now();let s=0;do{s=0;if(Date.now()-n>this._options.timeLimit)break;const e=this._findWall();if(!e)break;const t=e.split(","),r=parseInt(t[0],10),a=parseInt(t[1],10),o=this._getDiggingDirection(r,a);if(!o)continue;let i=0;do{if(i++,this._tryFeature(r,a,o[0],o[1])){this._removeSurroundingWalls(r,a),this._removeSurroundingWalls(r-o[0],a-o[1]);break}}while(i<this._featureAttempts);for(const e in this._walls)this._walls[e]>1&&s++}while(this._dug/t<this._options.dugPercentage||s);if(this._addDoors(),this._createEdgesForGraph(),e)for(let t=0;t<this._width;t++)for(let n=0;n<this._height;n++)e(t,n,this._map[t][n]);return this._walls={},this._map=[],this}_digCallback(e,t,n){0===n||2===n?(this._map[e][t]=0,this._dug++):this._walls[e+","+t]=1}_isWallCallback(e,t){return!(e<0||t<0||e>=this._width||t>=this._height)&&1===this._map[e][t]}_canBeDugCallback(e,t){return!(e<1||t<1||e+1>=this._width||t+1>=this._height)&&1===this._map[e][t]}_priorityWallCallback(e,t){this._walls[e+","+t]=2}_findWall(){const e=[],t=[];for(const n in this._walls)if(this._walls.hasOwnProperty(n)){2===this._walls[n]?t.push(n):e.push(n)}const n=t.length?t:e;if(!n.length)return null;const s=o.default.getItem(n.sort());return delete this._walls[s],s}_tryFeature(e,t,n,s){const r=o.default.getWeightedValue(this._features),i=l[r].createRandomAt(e,t,n,s,this._options);return!!i.isValid(this._isWallCallback,this._canBeDugCallback)&&(i.create(this._digCallback),this._markFeatureXY(i),i instanceof a.Room&&this._addRoom(i),i instanceof a.Corridor&&(i.createPriorityWalls(this._priorityWallCallback),this._corridors.push(i)),!0)}_removeSurroundingWalls(e,t){const n=i.DIRS[4];for(let s=0;s<n.length;s++){const r=n[s];let a=e+r[0],o=t+r[1];delete this._walls[a+","+o],a=e+2*r[0],o=t+2*r[1],delete this._walls[a+","+o]}}_getDiggingDirection(e,t){if(e<=0||t<=0||e>=this._width-1||t>=this._height-1)return null;let n=null;const s=i.DIRS[4];for(let r=0;r<s.length;r++){const a=s[r],o=e+a[0],i=t+a[1];if(!this._map[o][i]){if(n)return null;n=a}}return n?[-n[0],-n[1]]:null}_addDoors(){const e=this._map;function t(t,n){return 1===e[t][n]}for(let e=0;e<this._rooms.length;e++){const n=this._rooms[e];n.clearDoors(),n.addDoors(t)}}getCrossAround(e,t,n,s=!1){const r=[];for(let s=e-n;s<=e+n;s++)for(let a=t-n;a<=t+n;a++)s!==e&&a!==t||s===e&&a===t||s>=0&&a>=0&&s<this._width&&a<this._height&&r.push([s,a]);return s&&r.push([e,t]),r}_markFeatureXY(e){const t={};e.getXY().forEach(n=>{const[s,r]=n;this.getCrossAround(s,r,1,!0).forEach(n=>{const[s,r]=n,a=s+","+r;t[a]||(t[a]=!0,this._xyToFeat[a]||(this._xyToFeat[a]=[]),this._xyToFeat[a].push(e))})})}_createEdgesForGraph(){Object.keys(this._xyToFeat).forEach(e=>{const[t,n]=e.split(","),s=this._xyToFeat[e];s.length>2?console.warn("More than 2 feats in "+JSON.stringify(s)):2===s.length&&this._ngraph.addLink(s[0],s[1],{x:t,y:n})})}}t.default=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return[].slice.call(e.querySelectorAll("*"),0).filter(o)};
/*!
 * Adapted from jQuery UI core
 *
 * http://jqueryui.com
 *
 * Copyright 2014 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 *
 * http://api.jqueryui.com/category/ui-core/
 */
var s=/input|select|textarea|button|object/;function r(e){var t=e.offsetWidth<=0&&e.offsetHeight<=0;if(t&&!e.innerHTML)return!0;var n=window.getComputedStyle(e);return t?"visible"!==n.getPropertyValue("overflow")||e.scrollWidth<=0&&e.scrollHeight<=0:"none"==n.getPropertyValue("display")}function a(e,t){var n=e.nodeName.toLowerCase();return(s.test(n)&&!e.disabled||"a"===n&&e.href||t)&&function(e){for(var t=e;t&&t!==document.body;){if(r(t))return!1;t=t.parentNode}return!0}(e)}function o(e){var t=e.getAttribute("tabindex");null===t&&(t=void 0);var n=isNaN(t);return(n||t>=0)&&a(e,!n)}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.assertNodeList=l,t.setElement=function(e){var t=e;if("string"==typeof t&&o.canUseDOM){var n=document.querySelectorAll(t);l(n,t),t="length"in n?n[0]:n}return i=t||i},t.validateElement=c,t.hide=function(e){c(e)&&(e||i).setAttribute("aria-hidden","true")},t.show=function(e){c(e)&&(e||i).removeAttribute("aria-hidden")},t.documentNotReadyOrSSRTesting=function(){i=null},t.resetForTesting=function(){i=null};var s,r=n(688),a=(s=r)&&s.__esModule?s:{default:s},o=n(221);var i=null;function l(e,t){if(!e||!e.length)throw new Error("react-modal: No elements were found for selector "+t+".")}function c(e){return!(!e&&!i)||((0,a.default)(!1,["react-modal: App element is not defined.","Please use `Modal.setAppElement(el)` or set `appElement={el}`.","This is needed so screen readers don't see main content","when modal is opened. It is not recommended, but you can opt-out","by setting `ariaHideApp={false}`."].join(" ")),!1)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=new function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.register=function(e){-1===t.openInstances.indexOf(e)&&(t.openInstances.push(e),t.emit("register"))},this.deregister=function(e){var n=t.openInstances.indexOf(e);-1!==n&&(t.openInstances.splice(n,1),t.emit("deregister"))},this.subscribe=function(e){t.subscribers.push(e)},this.emit=function(e){t.subscribers.forEach((function(n){return n(e,t.openInstances.slice())}))},this.openInstances=[],this.subscribers=[]};t.default=s,e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.TemplateLevel=void 0;const r=s(n(4)),a=n(9),o=n(80),i=n(336);n(130);const l=n(15)("bitn:TemplateLevel"),c=i.Crypt.tiles.filler,u=a.Random.getRNG(),h=()=>{},d=r.default.VERB.MEDIUM;t.TemplateLevel=class{constructor(e,t){this.tilesX=e,this.tilesY=t,this.debugEnabled=!!l.enabled,this.genParams=[1,1,1,1],this.roomCount=40,this.callbacks={afterInit:h},this.filler=o.Template.createTemplate(c),this.templates=[],this.tryToMatchAllExits=!0,this.missingExitIsError=!1,this._ind=0,this._unusedExits=[],this._freeExits={},this._possibleDirections=["N","S","E","W"],this._sortedByExit={N:[],S:[],E:[],W:[]},this.noEdge={},this.lastPlaced=null,this._sortedWithAllExits={},this.useFillerWhenNoMatch=!0,this.rng=u}setFiller(e){"string"==typeof e?(this.filler=o.Template.createTemplate(e),this.filler.setProp("name","FILLER")):(this.filler=e.clone(),this.filler.setProp("name","FILLER"))}setTemplates(e){this.templates=[],"string"==typeof e[0]?this.templates=e.map(e=>o.Template.createTemplate(e)):this.templates=e}addTemplate(e){"string"==typeof e?this.templates.push(o.Template.createTemplate(e)):e instanceof o.Template.ElemTemplate&&this.templates.push(e)}setGenParams(e){this.genParams=e}setRoomCount(e){this.roomCount=e}setRNG(e){this.rng=e}setConstraintFunc(e){this.constraintFunc=e.bind(this)}setStartRoomFunc(e){this.startRoomFunc=e.bind(this)}addCallback(e,t){this.callbacks.hasOwnProperty(e)?"function"==typeof t?this.callbacks[e]=t:r.default.err("TemplateLevel","setCallback","Tried setting non-function as cb: "+t):r.default.err("TemplateLevel","setCallback","No callback for "+e)}use(e){["constraintFunc","startRoomFunc","roomCount","genParams"].forEach(t=>{if(e.hasOwnProperty(t)){this["set"+t.capitalize()](e[t])}}),e.tiles&&e.tiles.filler&&this.setFiller(e.tiles.filler),e.Models&&e.Models.default&&this.setTemplates(e.Models.default)}create(){0===this.templates.length&&r.default.err("TemplateLevel","create","No templates set. Use setTemplates() before create()"),this._sortDataIntoListsByLocation(),this._initMapWithFillerCells();let e=!0,t=10;for(;e;){++this._ind,this.dbg(`Dungeon not ready. Tries left  ${t}/10`),this._placeStartRoom();let n=0;const s=this.roomCount;let a=0,o=!0;for(;a<1e3&&o;){const t=this._getRoomWithUnusedExits();if(null===t){o=!1;break}const{x:i,y:l}=t;this.dbg(`BEGIN: Current room @ ${i},${l}`),++this._ind;const c=this._getFreeExits(t);this.dbg("It has free exits: "+c);const u=this.rng.arrayGetRand(c);this.dbg(`Chose exit: ${u} for next room`);const h=this.getMatchingExit(u),d=this._getNewX(i,h),p=this._getNewY(l,h);if(d===i&&p===l){let e=`Illegal ${i},${l} -> ${d},${p}`;e+=` Exits: Chosen ${u} -> ${h}`,r.default.err("TemplateLevel","create",e)}const f=this._getNextTemplate(d,p,h);if(this._isXYInBounds(d,p)&&(this._placeRoom(i,l,u,d,p,h,f),++n,this.dbg(`**** Room count is now ${n} ****`)),--this._ind,++a,-1!==s&&n>=s){e=!1;break}}if(n>=s||-1===s)e=!1;else{if(0==--t){r.default.warn("Level.Template","create","Max tries reached. No valid level created");break}this._cleanupAndTryAgain()}--this._ind}this.expandTemplates()}_sortDataIntoListsByLocation(){const e=this._possibleDirections.map(e=>new RegExp(e));this.templates.forEach(t=>{const n=t.getProp("dir");if(n){this._possibleDirections.forEach((s,r)=>{e[r].test(n)&&this._sortedByExit[s].push(t)});const s=n.split("").sort().join("");this._sortedWithAllExits[s]||(this._sortedWithAllExits[s]=[]),this._sortedWithAllExits[s].push(t)}const s=t.getProp("noedge");s&&parseInt(s,10)>0&&(this.noEdge[t.getProp("name")]=!0)})}expandTemplates(){this.genParamsX=[],this.genParamsY=[];for(let e=0;e<this.tilesX;e++)if(this.genParams.x)this.genParamsX.push(this.genParams.x);else{const e=[this.genParams[0],this.genParams[1]];this.genParamsX.push(e)}for(let e=0;e<this.tilesY;e++)if(this.genParams.y)this.genParamsY.push(this.genParams.y);else{const e=[this.genParams[2],this.genParams[3]];this.genParamsY.push(e)}this.mapExpanded=[];for(let e=0;e<this.tilesX;e++){this.mapExpanded[e]=[];for(let t=0;t<this.tilesY;t++){const n=this.genParamsX[e].concat(this.genParamsY[t]);this.mapExpanded[e][t]=this.templMap[e][t].getChars(n)}}this.map=[],this.placedTileData={};let e=0,t=0;for(let n=0;n<this.tilesX;n++){const s=this.mapExpanded[n][0].length;t=e+s-1;for(let r=0;r<s;r++){let s=0,a=0,o=[];for(let i=0;i<this.tilesY;i++){const l=this.mapExpanded[n][i][r],c=l.length;s=a+c-1,o=o.concat(l),this.placedTileData[n+","+i]={name:this.templMap[n][i].getProp("name"),type:this.templMap[n][i].getProp("type"),llx:e,urx:t,ury:a,lly:s,tileX:n,tileY:i},a+=c}this.map.push(o)}e+=s}}getPlacedData(){return this.placedTileData}getMap(){return this.map||r.default.warn("TemplateLevel","getMap","Not not generated. Call create() first"),this.map}findTemplate(e){const t=[];return Object.keys(e).forEach(n=>{this.templates.forEach(s=>{s.getProp(n)===e[n]&&t.push(s)})}),t.length>0?this.rng.arrayGetRand(t):null}removeTemplate(e){const t=Object.keys(e)[0],n=this.templates.findIndex(n=>n.getProp(t)===e[t]);n>=0&&this.templates.splice(n,1)}addRoom(e,t,n){const s={x:t,y:n,room:e};this._addRoomData(s),this._removeExitsOfAbuttingRooms(s),this._removeBorderExits(s),this.templMap[t][n]=e,this.lastPlaced=s}_getNextTemplate(e,t,n){++this._ind;let s=null;if("function"==typeof this.constraintFunc&&(s=this.constraintFunc(e,t,n)),!s&&this.tryToMatchAllExits){this.dbg(`_getNextTemplate: Compute required exits for ${e},${t}`);const n=this.getAllRequiredExits(e,t);let s=this._getMatchWithExits(n);if(s=this.filterOutNoEdge(e,t,s),this.customMatchFilter&&(s=this.customMatchFilter(this,e,t,s,this.lastPlaced)),s.length>0)return--this._ind,this._getRandTemplate(s);let a=`x,y: ${e},${t}`;if(a+=`| Required: ${n[1]}, Excl: ${n[2]}`,r.default.warn("TemplateLevel","_getNextTemplate","Not all exits match. "+a),this.missingExitIsError){this.expandTemplates(),r.default.printMap(this.map);const s=`${e},${t} exitReqd: ${JSON.stringify(n)}`;throw new Error(s)}}if(!s){let s=this._sortedByExit[n];return s=this.filterOutNoEdge(e,t,s),--this._ind,this.useFillerWhenNoMatch?(this.dbg("Returning FILLER as no match was found"),this.filler):s.length>0?this._getRandTemplate(s):this._getRandTemplate(this._sortedByExit[n])}return--this._ind,s}_getRandTemplate(e){if(!this.weights)return this.rng.arrayGetRand(e);const t={},n=e.map(e=>e.getProp("name")),s={};n.forEach((e,n)=>{s[e]=n,this.weights.hasOwnProperty(e)?t[e]=this.weights[e]:t[e]=1});const r=this.rng.getWeighted(t);return e[s[r]]}_getRoomWithUnusedExits(){return this._unusedExits.length>0?this.rng.arrayGetRand(this._unusedExits):null}_getFreeExits(e){const{x:t,y:n}=e,s=t+","+n;return this._freeExits[s]?this._freeExits[s]:(r.default.err("TemplateLevel","_getFreeExits",`No ${s}, Room: ${JSON.stringify(e)}`),null)}_removeChosenExit(e,t,n){const s=e+","+t,a=this._freeExits[s];if(this.debugEnabled&&(this.dbg(JSON.stringify(this._freeExits)),this.dbg(`${e},${t} removeChosenExit ${n}`),a?this.dbg("nExits: "+a.length):this.dbg("nExits: NONE AVAILABLE")),!a)return;const o=a.indexOf(n);if(o>=0){if(this._freeExits[s].splice(o,1),0===this._freeExits[s].length){const n=this._unusedExits.findIndex(n=>n.x===e&&n.y===t);n>=0?(this._unusedExits.splice(n,1),delete this._freeExits[s],this.dbg(`${e},${t} has no unused exits anymore.`)):r.default.err("TemplateLevel","_removeChosenExit",`Cannot find ${e},${t} in unusedExits to remove.`)}this._freeExits[s]&&this.dbg(`_freeExits [${s}] After remove: `+JSON.stringify(this._freeExits[s]))}else{const s=JSON.stringify(this.templMap[e][t]);r.default.err("TemplateLevel","_removeChosenExit",`${e},${t} dir: ${n} not found. Templ: ${s}`)}}_isXYInBounds(e,t){return e>=0&&e<this.tilesX&&t>=0&&t<this.tilesY}_placeStartRoom(){++this._ind;let e=null;if("function"==typeof this.startRoomFunc){e=this.startRoomFunc();["x","y","room"].forEach(t=>{if(!e.hasOwnProperty(t)){const e="room must have {x, y, room}.";r.default.err("TemplateLevel","_placeStartRoom",`Prop ${t} null/undef. ${e}.`)}})}else{const t=this.rng.getUniformInt(1,this.tilesX-2),n=this.rng.getUniformInt(1,this.tilesY-2),s=this.getAllRequiredExits(t,n);let r=this._getMatchWithExits(s);this.customMatchFilter?(r=this.customMatchFilter(this,t,n,r,null),e={x:t,y:n,room:this.rng.arrayGetRand(r)}):e={x:t,y:n,room:this.getRandomTemplate()}}this.dbg("Start room: "+JSON.stringify(e)),this.templMap[e.x][e.y]=e.room,null!==e?(this._addRoomData(e),this._removeBorderExits(e)):r.default.err("TemplateLevel","_placeStartRoom","Starting room was null. Oh no!"),--this._ind}_placeRoom(e,t,n,s,r,a,o){this._removeChosenExit(e,t,n);const i={x:s,y:r,room:o};this._addRoomData(i),this._removeChosenExit(s,r,a),this._removeExitsOfAbuttingRooms(i),this._removeBorderExits(i),this.templMap[s][r]=o}_addRoomData(e){const t=e.room.getProp("dir");if(t){this._unusedExits.push(e);const n=t.split(""),s=e.x+","+e.y;this._freeExits[s]=n,this.dbg("_addRoomData: Added room "+JSON.stringify(e.room.elemPropMap),20)}}getMatchingExit(e){if(this.matchMap&&this.matchMap.hasOwnProperty(e))return this.matchMap[e];switch(e){case"N":return"S";case"S":return"N";case"E":return"W";case"W":return"E";default:return"N"}}_getNewX(e,t){let n=t;return this.dir2NSEWRemap&&this.dir2NSEWRemap[t]&&(n=this.dir2NSEWRemap[t]),"E"===n?e-1:"W"===n?e+1:e}_getNewY(e,t){let n=t;return this.dir2NSEWRemap&&this.dir2NSEWRemap[t]&&(n=this.dir2NSEWRemap[t]),"N"===n?e+1:"S"===n?e-1:e}getRandomTemplate(){return this.rng.arrayGetRand(this.templates)}_removeBorderExits(e){const{x:t,y:n}=e;0===t&&(this._hasExit("W",t,n)&&this._removeChosenExit(t,n,"W"),this.nsew2DirRemap&&this._removeExitsRemapped(t,n,"W")),t===this.tilesX-1&&(this._hasExit("E",t,n)&&this._removeChosenExit(t,n,"E"),this.nsew2DirRemap&&this._removeExitsRemapped(t,n,"E")),0===n&&(this._hasExit("N",t,n)&&this._removeChosenExit(t,n,"N"),this.nsew2DirRemap&&this._removeExitsRemapped(t,n,"N")),n===this.tilesY-1&&(this._hasExit("S",t,n)&&this._removeChosenExit(t,n,"S"),this.nsew2DirRemap&&this._removeExitsRemapped(t,n,"S"))}_removeExitsRemapped(e,t,n){const s=this.nsew2DirRemap[n];this._hasExit(s,e,t)&&this._removeChosenExit(e,t,s)}_removeExitsOfAbuttingRooms(e){const{x:t,y:n}=e;if(this.dbg(`CheckAbut ${t},${n}`),t>0){const e=t-1;this._isFiller(e,n)||(this._removeExitByXY("W",t,n),this._removeExitByXY("E",e,n),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.W,t,n),this._removeExitByXY(this.nsew2DirRemap.E,e,n)))}if(t<this.tilesX-1){const e=t+1;this._isFiller(e,n)||(this._removeExitByXY("E",t,n),this._removeExitByXY("W",e,n),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.E,t,n),this._removeExitByXY(this.nsew2DirRemap.W,e,n)))}if(n>0){const e=n-1;this._isFiller(t,e)||(this._removeExitByXY("N",t,n),this._removeExitByXY("S",t,e),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.N,t,n),this._removeExitByXY(this.nsew2DirRemap.S,t,e)))}if(n<this.tilesY-1){const e=n+1;this._isFiller(t,e)||(this._removeExitByXY("S",t,n),this._removeExitByXY("N",t,e),this.nsew2DirRemap&&(this._removeExitByXY(this.nsew2DirRemap.S,t,n),this._removeExitByXY(this.nsew2DirRemap.N,t,e)))}}_isFiller(e,t){const n="FILLER"===this.templMap[e][t].getProp("name");return this.dbg(`isFiller x,y ${e},${t}: ${n}`,r.default.VERB.HIGH),n}_removeExitByXY(e,t,n){this._hasExit(e,t,n)&&this._removeChosenExit(t,n,e)}_hasExit(e,t,n){const s=t+","+n;return!!this._freeExits[s]&&this._freeExits[s].indexOf(e)>=0}_cleanupAndTryAgain(){this._initMapWithFillerCells(),this._freeExits={},this._unusedExits=[]}_initMapWithFillerCells(){this.templMap=[];for(let e=0;e<this.tilesX;e++){this.templMap[e]=[];for(let t=0;t<this.tilesY;t++)this.templMap[e][t]=this.filler}this.callbacks.afterInit&&this.callbacks.afterInit(this)}setExitMap(e,t){this._possibleDirections=Object.keys(e),this._sortedByExit={},this._possibleDirections.forEach(e=>{this._sortedByExit[e]=[]}),this.matchMap=e,this.nsew2DirRemap=t;const n={};Object.keys(this.nsew2DirRemap).forEach(e=>{const t=this.nsew2DirRemap[e];n[t]=e}),this.dir2NSEWRemap=n}getAllRequiredExits(e,t){++this._ind;const n=[],s=[],r=[];let a=null,o=null;const i=t-1;this.nsew2DirRemap&&(a=this.nsew2DirRemap.N,o=this.matchMap[a]),i>=0?(this._isFiller(e,i)?n.push("N"):this._hasExit("S",e,i)?s.push("N"):r.push("N"),a&&(this._isFiller(e,i)?n.push(a):this._hasExit(o,e,i)?s.push(a):r.push(a))):(r.push("N"),a&&r.push(a));const l=t+1;this.nsew2DirRemap&&(a=this.nsew2DirRemap.S,o=this.matchMap[a]),l<this.tilesY?(this._isFiller(e,l)?n.push("S"):this._hasExit("N",e,l)?s.push("S"):r.push("S"),a&&(this._isFiller(e,l)?n.push(a):this._hasExit(o,e,l)?s.push(a):r.push(a))):(r.push("S"),a&&r.push(a));const c=e+1;this.nsew2DirRemap&&(a=this.nsew2DirRemap.E,o=this.matchMap[a]),c<this.tilesX?(this._isFiller(c,t)?n.push("E"):this._hasExit("W",c,t)?s.push("E"):r.push("E"),a&&(this._isFiller(c,t)?n.push(a):this._hasExit(o,c,t)?s.push(a):r.push(a))):(r.push("E"),a&&r.push(a));const u=e-1;return this.nsew2DirRemap&&(a=this.nsew2DirRemap.W,o=this.matchMap[a]),u>=0?(this._isFiller(u,t)?n.push("W"):this._hasExit("E",u,t)?s.push("W"):r.push("W"),a&&(this._isFiller(u,t)?n.push(a):this._hasExit(o,u,t)?s.push(a):r.push(a))):(r.push("W"),a&&r.push(a)),this.dbg("getAllRequired "+s),--this._ind,[n,s,r]}_getMatchWithExits(e){const[t,n,s]=e;this.dbg(`_getMatchWithExits: GOT: any:${t}, req:${n}, excl:${s}`);let r=Object.keys(this._sortedWithAllExits);s.forEach(e=>{r=r.filter(t=>!new RegExp(e).test(t))});let a=r.map(e=>e.split(""));a=a.filter(e=>this._arrayContainsArray(e,n)),r=a.map(e=>e.join(""));let o=[];return r.forEach(e=>{o=o.concat(this._sortedWithAllExits[e])}),o}_arrayContainsArray(e,t){return t.every(t=>e.indexOf(t)>=0)}dbg(e,t=r.default.VERB.MEDIUM){if(this.debugEnabled&&d>=t){const t=" ".repeat(this._ind);console.log(t+e)}}printTile(e,t){if(4===e&&3===t){const n=this.templMap[e][t];console.log("Tile @{x},"+t),console.log("Has exits: "+n.getDir()),console.log(JSON.stringify(n,null,2))}}isEdge(e,t){return 0===e||0===t||e===this.tilesX-1||t===this.tilesY-1}isCorner(e,t){return 0===e&&0===t||0===e&&t===this.tilesY-1||e===this.tilesX-1&&0===t||e===this.tilesX-1&&t===this.tilesY-1}filterOutNoEdge(e,t,n){return e===this.tilesX-1||0===e||t===this.tilesY-1||0===t?n.filter(e=>!this.noEdge.hasOwnProperty(e.getProp("name"))):n}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Crypt=void 0;const s=n(80),r=n(9).Random.getRNG();t.Crypt={Models:{default:[]},templates:{all:[]}},t.Crypt.tiles={},t.Crypt.tiles.filler="\nname:FILLER\nX=#\nY=#\n\n#X###X#\nY######\n#######\n#######\n#######\nY######\n#######",t.Crypt.tiles.start=["\ndir:NSEW\nname:start_nsew\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n+.###.+\n#.#.#.#\nY.....#\n###+###","\ndir:SEW\nname:start_sew\nX=#\nY=#\n\n#X###X#\nY.....#\n#.#.#.#\n+.###.+\n#.#.#.#\nY.....#\n###+###","\ndir:NEW\nname:start_new\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n+.###.+\n#.#.#.#\nY.....#\n#######","\ndir:NSE\nname:start_nse\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n#..#..+\n#.#.#.#\nY.....#\n###+###","\ndir:NSW\nname:start_nsw\nX=#\nY=#\n\n#X#+#X#\nY.....#\n#.#.#.#\n+..#..#\n#.#.#.#\nY.....#\n###+###"],t.Crypt.tiles.omni=["\ndir:NSEW\nnoedge:1\nname:omni\nX=#\nY=#\n\n#X#.#X#\nY.....#\n#.....#\n...#...\n#.....#\nY.....#\n###.###","\ndir:NSEW\nnoedge:1\nname:omni\nX=#\nY=#\n\n#X#.#X#\nY.....#\n#.#.#.#\n...#...\n#.#.#.#\nY.....#\n###.###","\ndir:NSEW\nnoedge:1\nname:omni\nX=#\nY=#\n\n#.X.X.#\nY.....#\n#..#..#\n..###..\n#..#..#\nY.....#\n###.###","\nname:omni\nnoedge:1\ndir:NSEW\nX=#\nY=#\n\n#X...X#\n.......\nY..#..#\n..###..\nY..#..#\n.......\n##...##","\nname:omni\nnoedge:1\ndir:NSEW\nX=.\nY=.\n\n..X.X..\n.##.##.\nY#...#.\n...#...\nY#...#.\n.##.##.\n.......","\nname:omni\nnoedge:1\ndir:NSEW\nX=.\nY=.\n\n#.X.X.#\n###.###\nY#...#.\n...#...\nY#...#.\n###.###\n#.....#","\nname:omni\nnoedge:1\ndir:NSEW\nX=.\nY=.\n\n..X.X..\n.##.##.\nY##.##.\n.......\nY##.##.\n.##.##.\n.......","\ndir:NSEW\nnoedge:1\nname:omni\nX=.\nY=.\n\n..X.X..\n.##.##.\nY#...#.\n.#...#.\nY#...#.\n.##.##.\n......."],t.Crypt.tiles.term=["\ndir:N\nname:term\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.#.#.#\n###.###\nY.....#\n#.....#\n#######","\ndir:N\nname:term\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.#.#.#\n###.###\nY##.###\n##...##\n#######","\ndir:S\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY.#.#.#\n###.###\nY.#.#.#\n#.....#\n##...##","\ndir:S\nname:term\nX=#\nY=#\n\n#X###X#\n#######\nY######\n###.###\nY.....#\n#.....#\n##...##","\ndir:W\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY.#.#.#\n...####\nY.#.#.#\n#.....#\n#######","\ndir:W\nname:term\nX=#\nY=#\n\n#X###X#\n#.#...#\nY.#.###\n..#...#\nY.###.#\n#.....#\n#######","\ndir:E\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY..#..#\n#..#...\nY.###.#\n#.....#\n#######","\ndir:E\nname:term\nX=#\nY=#\n\n#X###X#\n#.....#\nY...###\n#...#..\nY.###.#\n#.....#\n#######"],t.Crypt.tiles.corridor=["\ndir:NS\nname:corridor\nX=#\nY=#\n\n#X...X#\n##...##\nY#...##\n##...##\nY#...##\n##...##\n##...##","\ndir:NS\nname:corridor\nX=#\nY=#\n\n#X...X#\n#.....#\nY#...##\n#.....#\nY#...##\n#.....#\n##...##","\ndir:EW\nname:corridor\nX=#\nY=#\n\n#X###X#\n#######\nY......\n.......\nY......\n#######\n#######","\ndir:EW\nname:corridor\nX=#\nY=#\n\n#X###X#\n#.#.#.#\nY.....#\n.......\nY.....#\n#.#.#.#\n#######"],t.Crypt.tiles.corner=["\ndir:NW\nname:corner\nX=#\nY=#\n\n#X...X#\n###.###\nY....##\n.....##\nY....##\n#######\n#######","\ndir:NW\nname:corner\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.....#\n......#\nY.###.#\n#.....#\n#######","\ndir:NE\nname:corner\nX=.\nY=#\n\n#X...X#\n###.###\nY#...#.\n##.....\nY#...#.\n#######\n#######","\ndir:NE\nname:corner\nX=#\nY=#\n\n#X#.#X#\n#.....#\nY.###.#\n#......\nY.....#\n#.....#\n#######","\ndir:SE\nname:corner\nX=#\nY=#\n\n#X###X#\n###.###\nY#...#.\n##.....\nY#...#.\n###.###\n###.###","\ndir:SE\nname:corner\nX=#\nY=#\n\n#X###X#\n#.#.#.#\nY#...##\n#......\nY#...##\n#.#.#.#\n###.###","\ndir:SW\nname:corner\nX=#\nY=.\n\n#X###X#\n###.###\nY#...##\n......#\nY#...##\n###.###\n###.###"],t.Crypt.tiles.misc=["\ndir:SEW\nname:threeway\nX=#\nY=.\n\n#X###X#\n###.###\nY#...#.\n.......\nY#...#.\n###.###\n###.###","\ndir:SEW\nname:threeway\nX=#\nY=#\n\n#X###X#\n#.....#\nY.#.#.#\n..#.#..\nY##.###\n#.....#\n#.....#","\ndir:NEW\nname:threeway\nX=#\nY=.\n\n#X...X#\n###.###\nY#...#.\n.......\nY#...#.\n#######\n#######","\ndir:NSW\nname:threeway\nX=#\nY=#\n\n#X...X#\n###.###\nY#...##\n......#\nY#...##\n###.###\n###.###","\ndir:NSE\nname:threeway\nX=#\nY=#\n\n#X...X#\n###.###\nY#...##\n##.....\nY#...##\n###.###\n###.###"],t.Crypt.templates.start=t.Crypt.tiles.start.map(e=>s.Template.createTemplate(e)),t.Crypt.startRoomFunc=function(){const e=r.arrayGetRand(t.Crypt.templates.start);let n=r.getUniformInt(0,this.tilesX-1),s=r.getUniformInt(0,this.tilesY-1);switch(e.getProp("name")){case"start_nsew":n=Math.floor(this.tilesX/2),s=Math.floor(this.tilesY/2);break;case"start_sew":s=0,0===n&&(n+=1),n===this.tilesX-1&&(n-=1);break;case"start_new":s=this.tilesY-1,0===n&&(n+=1),n===this.tilesX-1&&(n-=1);break;case"start_nse":n=0,0===s&&(s+=1),s===this.tilesY-1&&(s-=1);break;case"start_nsw":n=this.tilesX-1,0===s&&(s+=1),s===this.tilesY-1&&(s-=1)}return{x:n,y:s,room:e}},t.Crypt.Models.default=[].concat(t.Crypt.tiles.corner).concat(t.Crypt.tiles.corridor).concat(t.Crypt.tiles.omni).concat(t.Crypt.tiles.term).concat(t.Crypt.tiles.misc),t.Crypt.templates.all=t.Crypt.Models.default.map(e=>s.Template.createTemplate(e));const a=s.Template.transformList(t.Crypt.templates.all);t.Crypt.templates.all=t.Crypt.templates.all.concat(a)},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.HouseGenerator=t.House=void 0;const r=s(n(4)),a=n(335),o=n(694),i=n(9),l=n(13),c=n(30),u=i.Random.getRNG();class h{constructor(e){this.coord={},this.map=r.default.copy2D(e),this.trimEmpty(),this.x=0,this.y=0,this.w=e.length,this.h=e[0].length;let t=0,n=0;r.default.forEach2D(e,(e,s,r)=>{this.coord[r]||(this.coord[r]=[]),this.coord[r].push([e,s]),":"===r?(t+=e,n+=s):"+"===r&&(this.door=[e,s])}),this.coord[":"]||r.default.err("Room","new","Could not init floor : from "+JSON.stringify(e)),this.coord["#"]||r.default.err("Room","new","Could not init wall # from "+JSON.stringify(e)),this.floor=this.coord[":"],this.walls=this.coord["#"];const s=Object.values(this.coord[":"]).length;this.cX=Math.round(t/s),this.cY=Math.round(n/s),this.numFloor=s,this.houseID=h.HOUSE_ID++}getCenter(){return[this.cX,this.cY]}isFloor(e){const[t,n]=e;return this.floor.findIndex(e=>e[0]===t&&e[1]===n)>=0}getFloorCenter(){let e=this.getCenter();if(this.isFloor(e))return e;const[t,n]=e;return l.Geometry.getBoxAround(t,n,1).forEach(t=>{this.isFloor(t)&&(e=t)}),e||r.default.err("House","getFloorCenter","No floor centerpoint found"),e}getBbox(){return c.BBox.fromBBox({ulx:this.x,uly:this.y,lrx:this.x+this.w-1,lry:this.y+this.h-1})}trimEmpty(){}adjustCoord(e,t){const n=e-this.x,s=t-this.y;this.moveHouse(n,s)}moveHouse(e,t){this.x+=e,this.y+=t,Object.keys(this.coord).forEach(n=>{this.coord[n].forEach(n=>{n[0]+=e,n[1]+=t})}),this.cX+=e,this.cY+=t,this.door=[this.door[0]+e,this.door[1]+t]}addWindows(e){this.coord.windows=[];const t=this.coord["#"].slice();let n=0;u.shuffle(t);const s={};t.forEach(e=>{s[e[0]+","+e[1]]=!0}),this.coord["+"].forEach(e=>{s[e[0]+","+e[1]]=!1});for(let r=0;r<t.length&&n!==e;r++){const a=t[r],o=[];l.Geometry.getBoxAround(a[0],a[1],1).forEach(e=>{s[e[0]+","+e[1]]&&o.push(e)}),2===o.length&&(n<e||-1===e)&&this.windowPosOk(a,o)&&(this.coord.windows.push(a),s[a[0]+","+a[1]]=!1,++n)}return this.coord.windows.forEach(e=>{const t=this.walls.findIndex(t=>t[0]===e[0]&&t[1]===e[1]);this.walls.splice(t,1)}),n}windowPosOk(e,t){const[n,s]=e,[r,a]=t[0],[o,i]=t[1];return n===r?2===Math.abs(a-i):s===a&&2===Math.abs(r-o)}findDoorPlace(){return this.door?(r.default.err("House","findDoorPlace","Door place already set to "+this.door),[-1,-1]):[-2,-2]}}t.House=h,h.HOUSE_ID=0;t.HouseGenerator=class{constructor(){this.baseSizeX=3,this.baseSizeY=3}createHouse(e){const{cols:t,rows:n}=e,{fullHouse:s}=e,r=this.getGenParams(t,n),{genParamsX:i,genParamsY:l}=r;let{tilesX:c,tilesY:d}=r;if(!Number.isInteger(c)||!Number.isInteger(d)){if(!(c>1))return null;if(c=Math.floor(c),!(d>1))return null;d=Math.floor(d)}const p=new a.TemplateLevel(c,d);p.setFiller(o.Houses5x5.tiles.filler),p.setTemplates(o.Houses5x5.templates.all),p.setGenParams({x:i,y:l}),p.roomCount=-1,s&&(p.roomCount=c*d,p.roomCount-=1),p.setStartRoomFunc(o.Houses5x5.startRoomFunc),p.create();const f=new h(p.map);if(e.addWindows){const e=c*d;f.addWindows(u.getUniformInt(1,e))}return f}getGenParams(e,t){const n=this.baseSizeX,s=this.baseSizeY;let a=u.getUniformInt(1,3),o=u.getUniformInt(1,3),i=n+a+o,l=r.default.WATCHDOG;for(;e%i!=0&&(a=u.getUniformInt(1,3),o=u.getUniformInt(1,3),i=n+a+o,0!=--l););const c=e/i,h=[a,1,o];let d=u.getUniformInt(1,3),p=u.getUniformInt(1,3),f=s+d+p,m=r.default.WATCHDOG;for(;t%f!=0&&(d=u.getUniformInt(1,3),p=u.getUniformInt(1,3),f=s+d+p,0!=--m););return{tilesX:c,tilesY:t/f,genParamsX:h,genParamsY:[d,1,p]}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Vault=void 0;const r=s(n(4)),a=n(80);t.Vault={},t.Vault.tiles={},t.Vault.tiles.vault=["\nname:vault_small_s\nX=#\nY=#\n\n#X###X#\n#..?..#\nY.....#\n#.....#\n#.....#\nY.....#\n###.###","\nname:vault_small_n\nX=#\nY=#\n\n#X#.#X#\nY.....#\n#.....#\n#.....#\nY.....#\n#..?..#\n#######","\nname:vault_small_e\nX=#\nY=#\n\n##X##X#\nY.....#\n#.....#\n#?.....\n#.....#\nY.....#\n#######","\nname:vault_small_w\nX=#\nY=#\n\n#X##X##\nY.....#\n#.....#\n.....?#\n#.....#\nY.....#\n#######","\nname:vault_medium_s\nX=#\nY=#\n\n#X...X#\nY.....#\n#.....#\n#.....#\n#.....#\nY.....#\n###.###","\nname:vault_medium_n\nX=#\nY=#\n\n#X###X#\n#..?..#\nY.....#\n#.....#\n#.....#\nY..#..#\n##...##"],t.Vault.tiles.corner=["\nname:vault_nw_corner\nX=#\nY=#\n\n#X###X#\nY......\n#......\n#......\n#......\nY......\n#......","\nname:vault_ne_corner\nX=#\nY=.\n\n#X###X#\nY.....#\n......#\n......#\n......#\nY.....#\n......#","\nname:vault_sw_corner\nX=.\nY=#\n\n#X...X.\nY......\n#......\n#......\n#......\nY......\n###.###","\nname:vault_se_corner\nX=.\nY=.\n\n.X...X#\nY.....#\n......#\n......#\n......#\nY.....#\n#######"],t.Vault.tiles.wall=["\nname:vault_n_wall\nX=#\nY=.\n\n#X###X#\nY......\n.......\n.......\n.......\nY......\n.......","\nname:vault_e_wall\nX=.\nY=.\n\n.X...X#\nY.....#\n......#\n......#\n......#\nY.....#\n......#","\nname:vault_w_wall\nX=.\nY=#\n\n#X...X.\nY......\n#......\n#......\n#......\nY......\n#......","\nname:vault_s_wall\nX=.\nY=.\n\n.X...X.\nY......\n.......\n.......\n.......\nY......\n##...##"],t.Vault.tiles.center=["\nname:vault_center1\nX=.\nY=.\n\n.X...X.\nY......\n.......\n.......\n.......\nY......\n.......","\nname:vault_center2\nX=.\nY=.\n\n.X...X.\nY..#...\n...#...\n.#####.\n...#...\nY..#...\n.......","\nname:vault_center3\nX=#\nY=#\n\n.X...X.\nY..#..#\n...#...\n.#####.\n...#...\nY..#..#\n.#...#."],t.Vault.func={},t.Vault.func.createMediumVault=(e,t,n,s)=>{const r=n.findTemplate({name:"vault_medium_n"}),a=n.findTemplate({name:"vault_medium_s"});n.addRoom(r,e,t),n.addRoom(a,e,t+1),s&&n.addRoom(s,e,t+2)},t.Vault.func.createLargeVault=(e,t,n,s)=>{const r=n.findTemplate({name:"vault_nw_corner"}),a=n.findTemplate({name:"vault_ne_corner"}),o=n.findTemplate({name:"vault_sw_corner"}),i=n.findTemplate({name:"vault_se_corner"});n.addRoom(r,e,t),n.addRoom(a,e+1,t),n.addRoom(o,e,t+1),n.addRoom(i,e+1,t+1),s&&n.addRoom(s,e,t+2)},t.Vault.func.createHugeVault=(e,t,n,s,a)=>{const o=n.findTemplate({name:"vault_nw_corner"}),i=n.findTemplate({name:"vault_ne_corner"}),l=n.findTemplate({name:"vault_sw_corner"}),c=n.findTemplate({name:"vault_se_corner"});r.default.isNullOrUndef([o,i,l,c])&&r.default.err("Vault.func","createHugeVault","Corner templates cannot be null. Check they are loaded"),n.addRoom(o,e,t),n.addRoom(i,e+2,t),n.addRoom(l,e,t+2),n.addRoom(c,e+2,t+2);const u=n.findTemplate({name:s});n.addRoom(u,e+1,t+1);const h=n.findTemplate({name:"vault_n_wall"}),d=n.findTemplate({name:"vault_e_wall"}),p=n.findTemplate({name:"vault_w_wall"}),f=n.findTemplate({name:"vault_s_wall"});if(n.addRoom(h,e+1,t),n.addRoom(d,e+2,t+1),n.addRoom(p,e,t+1),n.addRoom(f,e+1,t+2),a){let s=a;"string"==typeof a&&(s=n.findTemplate({name:a})),n.addRoom(s,e+1,t+3)}},t.Vault.Models={},t.Vault.Models.default=[].concat(t.Vault.tiles.center).concat(t.Vault.tiles.corner).concat(t.Vault.tiles.wall).concat(t.Vault.tiles.vault),t.Vault.templates={},t.Vault.templates.all=t.Vault.Models.default.map(e=>a.Template.createTemplate(e));const o=a.Template.transformList(t.Vault.templates.all);t.Vault.templates.all=t.Vault.templates.all.concat(o)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BSPGen=t.Room=t.Container=t.Point=t.Tree=t.BSP=void 0;const s=n(9).Random.getRNG();t.BSP={};const r={discardByRatio:!0,hRatio:.35,wRatio:.35,vertSplit:.5,minSplitW:8,minSplitH:8,discardBySize:!0,minRoomW:3,minRoomH:2};class a{constructor(e){this.leaf=e,this.lchild=null,this.rchild=null}getLeafs(){return null===this.lchild&&null===this.rchild?[this.leaf]:[].concat(this.lchild.getLeafs(),this.rchild.getLeafs())}getLevel(e,t){return t||(t=[]),1===e?t.push(this):(null!==this.lchild&&this.lchild.getLevel(e-1,t),null!==this.rchild&&this.rchild.getLevel(e-1,t)),t}}t.Tree=a,t.BSP.Tree=a;class o{constructor(e,t){this.x=e,this.y=t}}t.Point=o;class i{constructor(e,t,n,s){this.x=e,this.y=t,this.w=n,this.h=s,this.center=new o(this.x+Math.floor(this.w/2),this.y+Math.floor(this.h/2))}}t.Container=i,t.BSP.Container=i;class l{constructor(e){return this.x=e.x+l.rng.getUniformInt(1,Math.floor(e.w/3)),this.y=e.y+l.rng.getUniformInt(1,Math.floor(e.h/3)),this.w=e.w-(this.x-e.x)-1,this.h=e.h-(this.y-e.y)-1,this.w-=l.rng.getUniformInt(0,this.w/3),this.h-=l.rng.getUniformInt(0,this.h/3),this.w<r.minRoomW&&(this.w=r.minRoomW),this.h<r.minRoomH&&(this.h=r.minRoomH),this}getCoord(){const e=[],t=this.x,n=t+(this.w-1),s=this.y,r=s+(this.h-1);for(let a=t;a<=n;a++)for(let t=s;t<=r;t++)e.push([a,t]);return e}getOuterBorder(){const[e,t]=[this.x-1,this.y-1],[n,s]=[this.x+this.w+1,this.y+this.h+1];return c(e,t,n,s)}getInnerBorder(){const[e,t]=[this.x,this.y],[n,s]=[this.x+this.w-1,this.y+this.h-1];return c(e,t,n,s)}}function c(e,t,n,s){const r=[];for(let a=e;a<=n;a++)for(let o=t;o<=s;o++)o!==t&&o!==s&&a!==e&&a!==n||r.push([a,o]);return r}t.Room=l,l.rng=s,t.BSP.Room=l;class u{constructor(e={}){this._opts=r,Object.keys(e).forEach(t=>{this._opts.hasOwnProperty(t)&&(this._opts[t]=e)}),this.rng=this._opts.rng||s}createPath(e,t){const n=[],s=e.center,r=t.center;if(s.x===r.x){const e=s.y>r.y?r.y:s.y,t=s.y<r.y?r.y:s.y;for(let r=e;r<=t;r++)n.push([s.x,r])}else{const e=s.x>r.x?r.x:s.x,t=s.x<r.x?r.x:s.x;for(let r=e;r<=t;r++)n.push([r,s.y])}return n}splitContainer(e,t){const n=new a(e);if(this.isLargeEnough(e)&&0!==t){const s=this.randomSplit(e);n.lchild=this.splitContainer(s[0],t-1),n.rchild=this.splitContainer(s[1],t-1)}return n}isLargeEnough(e){return!this._opts.discardBySize||e.w>=this._opts.minSplitW&&e.h>=this._opts.minSplitH}randomSplit(e){let t,n;if(this.rng.getUniform()<=this._opts.vertSplit){if(t=new i(e.x,e.y,this.rng.getUniformInt(1,e.w),e.h),n=new i(e.x+t.w,e.y,e.w-t.w,e.h),this._opts.discardByRatio&&this.isVRatioTooSmall(t,n))return this.randomSplit(e)}else if(t=new i(e.x,e.y,e.w,this.rng.getUniformInt(1,e.h)),n=new i(e.x,e.y+t.h,e.w,e.h-t.h),this._opts.discardByRatio&&this.isHRatioTooSmall(t,n))return this.randomSplit(e);return[t,n]}isVRatioTooSmall(e,t){const n=e.w/e.h,s=t.w/t.h;return n<this._opts.wRatio||s<this._opts.wRatio}isHRatioTooSmall(e,t){const n=e.h/e.w,s=t.h/t.w;return n<this._opts.hRatio||s<this._opts.hRatio}createWithRooms(e,t,n=5){const s=new i(0,0,e,t),r=this.splitContainer(s,n),a=r.getLeafs(),o=[];return a.forEach(e=>{o.push(new l(e))}),this.generated={tree:r,rooms:o},[r,o]}createWithRoomsAndPaths(e,t,n=5){const s=new i(0,0,e,t),r=this.splitContainer(s,n),a=r.getLeafs(),o=[];a.forEach(e=>{o.push(new l(e))});const c=[];return this.createPaths(r,c),this.generated={tree:r,rooms:o,paths:c},[r,o,c]}createPaths(e,t){if(null===e.lchild||null===e.rchild)return[];const n=this.createPath(e.lchild.leaf,e.rchild.leaf);return n.length>0&&t.push(n),this.createPaths(e.lchild,t),this.createPaths(e.rchild,t),t}get(e){return this.generated.hasOwnProperty(e)?this.generated[e]:null}}t.BSPGen=u,t.BSP.BSPGen=u},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MapMiner=void 0;const r=s(n(40)),a=s(n(22)),o=n(42),i=s(n(4)),l=n(13),c=n(19);n(130);const u=n(15)("bitn:Map.Miner"),h=r.default;t.MapMiner=class extends h{constructor(e,t,n={}){super(e,t);const s=e>t?t:e,r=Math.floor(e*t/s),o=Math.round(this._width/2),i=Math.round(this._height/2);if(this._options={addMiners:[],dontDig:!1,maxMinersCreated:r,minerSpawnProb:.07,smooth:!0,rng:a.default,startX:o,startY:i,nSmooth:2,dirWeights:{N:1,NE:1,E:1,SE:1,S:1,SW:1,W:1,NW:1}},!n.dirWeights){const n=e>t?t:e;Object.keys(this._options.dirWeights).forEach(s=>{this._options.dirWeights[s]*="W"===s||"E"===s?6*e:"S"===s||"N"===s?t:n})}for(const e in n)this._options.hasOwnProperty(e)&&(this._options[e]=n[e]);if(n.maxMinersOp){let e=this._options.maxMinersCreated;const{op:t,value:s}=n.maxMinersOp;switch(t){case"+":e+=s;break;case"-":e-=s;break;case"/":e/=s;break;case"*":e*=s;break;default:console.warn(`Op ${t} illegal`)}this._options.maxMinersCreated=Math.round(e)}this._hist={minerDir:{}},this._verifyRngFunctions()}create(e){const t=this._options.rng;this._map=this._fillMap(1);const n=this._options.maxMinersCreated,s=this._options.minerSpawnProb;let r=[{id:0,x:this._options.startX,y:this._options.startY,dirWeights:this._options.dirWeights}];this.minerID=1,Array.isArray(this._options.addMiners)&&this._options.addMiners.forEach(e=>{if(this.inBounds(e.x,e.y)){const t=Object.assign({},e);t.id=this.minerID++,t.dirWeights||(t.dirWeights=this._options.dirWeights),r.push(t)}else console.error(e,"out of level mining bounds. Not added")}),r.forEach(e=>{i.default.isNullOrUndef([e.x,e.y])?i.default.err("Map.Miner","create","miner.x,y must exist. "+e):this._markAsDug(e.x,e.y)});let a=0,o=0,l=0,c=[],h=[],d=0;for(;o<n&&(u.enabled&&this.printMap(),this.dbg("Active miners: "+r.length),r.forEach(e=>{const[n,i]=this._getXYToDig(e);if(0===this._map[n][i]&&r.length>1)c.push(e);else if(this.inBounds(n,i)){if(t.getUniform()<=s){const t=this._tryToAddNew(e,n,i);t&&(h.push(t),++a),++o}this._markAsDug(n,i,e),e.x=n,e.y=i}else c.push(e)}),c.forEach(e=>{const t=r.findIndex(t=>e.id===t.id);if(r.length>1){const{id:n,x:s,y:a}=e;this.dbg(`remove miner ${n} at ${s}, ${a}`),++l,r.splice(t,1)}}),r=r.concat(h),h=[],c=[],!(d>100*this._width*this._height))&&0!==r.length;)++d;if(this._options.smooth&&this.smoothWalls(2),this.connect(),e)for(let t=0;t<this._height;t++)for(let n=0;n<this._width;n++)e(n,t,this._map[n][t]);this._hist.minersSpawned=o,this._hist.minersAdded=a,this._hist.minersRemoved=l}_tryToAddNew(e,t,n){let[s,r]=this._getXYToDig({x:t,y:n,dirWeights:e.dirWeights}),a=null;const i=this._options.rng;if(1===this._map[t][n]&&this.inBounds(s,r))a={id:this.minerID++,x:s,y:r},e.dugCallback&&(a.dugCallback=e.dugCallback),this._markAsDug(s,r,a),this.dbg(e,"spawned new miner:",a);else{const t=i.getUniformInt(0,7),n=o.DIRS[8][t];s+=n[0],r+=n[1],this.inBounds(s,r)&&(a={id:this.minerID++,x:s,y:r},e.dugCallback&&(a.dugCallback=e.dugCallback),this._markAsDug(s,r,a),this.dbg(e,"(else) spawned new miner:",a))}return a&&(a.dirWeights=e.dirWeights),a}printMap(){for(let e=0;e<this._height;e++){let t="";for(let n=0;n<this._width;n++)t+=1===this._map[n][e]?"#":".";console.log(t)}}_getXYToDig(e){const t=this._options.rng,n=l.Geometry.getBoxAround(e.x,e.y,1).filter(e=>1===this._map[e[0]][e[1]]&&this.inBounds(e[0],e[1]));if(0===n.length)return this.dbg("No wall cells around "+e.x+", "+e.y),[e.x,e.y];this.dbg("UndugXY is now "+n);const s=n.map(t=>{const n=[t[0]-e.x,t[1]-e.y];return i.default.dXdYToDir(n)}),r=e.dirWeights,a={};if(s.forEach(e=>{r[e]&&(a[e]=r[e])}),0===Object.keys(a).length)return[e.x,e.y];u.enabled&&this.dbg("dirsLeft: "+JSON.stringify(a));let o=t.getWeightedValue(a),c=i.default.dirTodXdY(o);if(!c)return void i.default.err("Map.Miner","getXYToDig","Got null dir!");let[h,d]=[e.x+c[0],e.y+c[1]];for(this.dbg(`dir: ${o}, COMP: dXdY: ${c}, x,y: ${h},${d}`),this._hist.minerDir[o]||(this._hist.minerDir[o]=0),this._hist.minerDir[o]+=1;0===this._map[h][d]&&(delete a[o],0!==Object.keys(a).length);)o=t.getWeightedValue(a),c=i.default.dirTodXdY(o),[h,d]=[e.x+c[0],e.y+c[1]],this.dbg(`dir: ${o}, COMP: dXdY: ${c}, x,y: ${h},${d}`),this._hist.minerDir[o]||(this._hist.minerDir[o]=0),this._hist.minerDir[o]+=1;return this.dbg(`Next x,y to dig is ${h},${d}`),[h,d]}inBounds(e,t){if(this._options.dontDig)if(this._options.dontDig.ulx){const{ulx:n,uly:s,lrx:r,lry:a}=this._options.dontDig;if(e>=n&&e<=r&&t>=s&&t<=a)return!1}else if(this._options.dontDig[e+","+t])return!1;return e>=1&&e<this._width-1&&t>=1&&t<this._height-1}connect(){const{addMiners:e}=this._options;let t=!0;const n={},s={};if(e.length>0){const r=e.map(e=>[e.x,e.y]);r.push([this._options.startX,this._options.startY]);let a=-1;r.forEach(e=>{const r={},o=l.Geometry.floodfill2D(this._map,e,0,r,!0);if(0===o.length){throw new Error(`Floodfill from: ${e} returned 0 cells`)}const i=e[0]+","+e[1];n[i]=o,s[i]=r,-1===a?a=o.length:a!==o.length&&(t=!1)})}t?this._regions=[]:this.connectFilledRegions(n,s)}connectFilledRegions(e,t){const n={};let s=0,r=null;const a=this._options.rng;Object.keys(e).forEach(t=>{const a=e[t];n[t]=l.Geometry.getMassCenter(a),a.length>s&&(s=a.length,r=t)});const o=[];this._regions=[],this._regions.push([e[r]]),Object.keys(n).forEach(n=>{if(n!==r){t[n][r]||(o.push(n),this._regions.push([e[n]]))}});const[i,c]=n[r];this._paths=[],o.forEach(e=>{const[t,s]=n[e],r=this._getPath(i,c,t,s);r.forEach(e=>{let t=a.getUniformInt(1,3);this._options.connWidth&&(t=this._options.connWidth);l.Geometry.getCrossCaveConn(e.x,e.y,t,!0).forEach(e=>{const[t,n]=e;this.inBounds(t,n)&&(this._map[t][n]=0)})}),this._paths.push(r)})}getMapData(){const e=this._options.addMiners,t=e.map(e=>[e.x,e.y]);return t.push([this._options.startX,this._options.startY]),{nRegions:1+e.length,regions:this._regions,startPoints:t,paths:this._paths}}smoothWalls(e){for(let t=0;t<e;t++)for(let e=1;e<this._width-1;e++)for(let t=1;t<this._height-1;t++)if(1===this._map[e][t]){const n=l.Geometry.getCrossAround(e,t,1);let s=0;n.forEach(e=>{this.inBounds(e[0],e[1])&&this._map[e[0]][e[1]]&&++s}),this.inBounds(e,t)&&s<this._options.nSmooth&&this._markAsDug(e,t)}}_getPath(e,t,n,s){return c.Path.getShortestPath(e,t,n,s)}_markAsDug(e,t,n){e<this._minX&&(this._minX=e),e>this._maxX&&(this._maxX=e),t<this._minY&&(this._minY=t),t>this._maxY&&(this._maxY=t),this._map[e][t]=0,this._options.dugCallback&&this._options.dugCallback(e,t,n),n&&n.dugCallback&&n.dugCallback(e,t,n)}_verifyRngFunctions(){const{rng:e}=this._options,t=["getUniform","getUniformInt","getWeightedValue"];t.forEach(n=>{if("function"!=typeof e[n]){let e=`RNG must have functions: ${t}.`;throw e+="See ROT.RNG for example (you can use it)",new Error(e)}})}dbg(e,...t){u.enabled&&console.log(e,...t)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MapWall=void 0;const r=s(n(40));n(130);const a=s(n(22)),o=r.default;function i(e,t,n){const s=2*n+1;let r=0;for(let s=t-n;s<=t+n;s++)s>=0&&s<e.length&&(r+=e[s]);return Math.floor(r/s)}t.MapWall=class extends o{constructor(e,t,n){if(super(e,t),this._options={north:!1,south:!1,east:!0,west:!0,alignVertical:"center",alignHorizontal:"center",meanWx:5,meanWy:5,stdDev:3,filterW:3,rng:a.default},n)for(const e in this._options)this._options.hasOwnProperty(e)&&n.hasOwnProperty(e)&&(this._options[e]=n[e])}create(e){const t=this._fillMap(0),n=this._options.north,s=this._options.south,r=this._options.east,a=this._options.west,{alignVertical:o,alignHorizontal:i}=this._options,l=this._width,c=this._height,u=Math.floor(l/2),h=Math.floor(c/2),d=this._options.meanWx,p=this._options.meanWy,f=this._options.stdDev,m=this._options.filterW;let g=null,y=-1,v=-1;n&&s?(y=0,v=c-1):n?(y=0,v=h-1):s&&(y=h,v=c-1),this._wallNS=[];let b=this.getWidthMovingAvg(v+1,d,f,l,m);if(n||s)for(let e=y;e<=v;e++){g=b[e-y];const n=[];1===g&&(g=d);let s=u-(g-1),r=u+(g-1);"center"===i||("left"===i?(s=0,r=s+(g-1)):"right"===i&&(s=this._width-(g-1),r=this._width-1));for(let a=s;a<=r;a++)t[a][e]=1,n.push([a,e]);this._wallNS.push(n)}let _=-1,E=-1;if(r&&a?(_=0,E=l-1):r?(_=u,E=l-1):a&&(_=0,E=u-1),this._wallEW=[],b=this.getWidthMovingAvg(E+1,p,f,c,m),r||a)for(let e=_;e<=E;e++){g=b[e-_];const n=[];1===g&&(g=p);let s=h-(g-1),r=h+(g-1);"center"===o||("top"===o?(s=0,r=s+(g-1)):"bottom"===o&&(s=this._height-(g-1),r=this._height-1));for(let a=s;a<=r;a++)t[e][a]=1,n.push([e,a]);this._wallEW.push(n)}for(let n=0;n<this._width;n++)for(let s=0;s<this._height;s++)e(n,s,t[n][s])}getWidthMovingAvg(e,t,n,s,r){const a=[];for(let r=0;r<e;r++)a.push(this.getWallWidth(t,n,s));let o=[];for(let e=0;e<r;e++)o.push(a[e]);for(let t=r;t<e-r;t++){const e=i(a,t,r);o.push(e)}for(let t=e-r;t<e;t++)o.length<a.length&&o.push(a[t]);return o=o.map(e=>Math.round(e)),o}getWallWidth(e,t,n){const s=this._options.rng;let r=Math.floor(s.getNormal(e,t));return r>n/2?r=n/2-1:r<1&&(r=1),r}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ActorMods=void 0,t.ActorMods={},t.ActorMods.bearfolk={description:"",stats:{magic:-2,agility:-3,strength:5},player:{startingItems:[],equipment:[{name:"Chain boots",count:1}]}},t.ActorMods.catfolk={stats:{agility:6,perception:4,strength:-3},player:{Marksman:{startingItems:[{name:"Shuriken",count:6}],equipment:[]},startingItems:[],equipment:[]}},t.ActorMods.dogfolk={stats:{agility:4,perception:5},player:{Spellsinger:{startingItems:[{func:e=>"rune"===e.type,count:1}]},startingItems:[],equipment:[]}},t.ActorMods.dwarf={stats:{agility:-2,strength:3,willpower:3},player:{Adventurer:{},Blademaster:{equipment:[{name:"Battle axe",count:1}]},Miner:{equipment:[{name:"Mithril pick-axe",count:1}]},startingItems:[],equipment:[]}},t.ActorMods.goblin={stats:{magic:-3,accuracy:3,agility:4,spirituality:-3},player:{startingItems:[{name:"Rock",count:5}],equipment:[{name:"Rock",count:3}]}},t.ActorMods.human={stats:{accuracy:6,magic:2,willpower:2,spirituality:2},player:{Courtier:{startingItems:[{name:"Gold coin",count:100}]},startingItems:[{name:"Potion of cure poison",count:2}],equipment:[]}},t.ActorMods.hyrkhian={stats:{magic:5,willpower:5,spirituality:3},player:{Cryomancer:{startingItems:[{name:"Potion of power",count:"1d2"}]},startingItems:[{name:"Lesser spirit gem",count:1}],equipment:[]}},t.ActorMods.wildling={stats:{accuracy:2,agility:2,perception:6},player:{startingItems:[],equipment:[]}},t.ActorMods.wolfclan={stats:{strength:3,magic:4,willpower:4},player:{startingItems:[],equipment:[]}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Miners=t.CaveGenerator=void 0;const r=s(n(4)),a=n(63),o=n(24),i=n(225),l=n(81),c=n(62),u=n(19),h=n(13),d=n(9),p=n(18),f=n(12),m=n(16),g=n(48),y=d.Random.getRNG(),v=["orc","naga","ratling","gnome","teradin","elf"],b=m.Element.Marker;class _ extends c.LevelGenerator{static getOptions(){const e=c.LevelGenerator.getOptions();return Object.assign(e,{dungeonType:"Lair",isCollapsed:!1})}constructor(){super(),this.shouldRemoveMarkers=!0}static embedNest(e,t){let n=0;for(;n<10;){const s=y.getUniformInt(2,5),r=y.getUniformInt(2,5),a=new i.NestGenerator,o={actorConstr:{race:y.arrayGetRand(v),maxDanger:t.maxDanger},mapConf:{tilesX:s,tilesY:r,genParams:{x:[1,1,1],y:[1,1,1]},wallType:t.wallType||"wallcave",floorType:t.floorType||"floorcave"},embedOpts:{level:e}};if(a.createAndEmbed(7*s,7*r,o))return!0;++n}return!1}create(e,t,n){r.default.isNullOrUndef([e,t])&&r.default.err("CaveGenerator","create",`cols or rows not defined: cols: ${e} / rows: ${t}`);const s=this._createLevel(e,t,n);return this.addStairsLocations(s),this._addSpecialFeatures(s),this._addEncounters(s,n),_.embedNest(s,n),this._addOreVeins(s,n),this.removeMarkers(s,n),s}_createLevel(e,t,n){const s=this._createMapOptions(e,t,n),r=new a.MapGenerator;r.setGen("cave",e,t);const i=r.createCave(e,t,s),l=new o.Level(i.map);return this.setLevelExtras(l,i.mapGen),s.isCollapsed&&(l.getExtras().isCollapsed=!0),l}setLevelExtras(e,t){const n=t.getMapData();n.startPoints=r.default.uniquifyCoord(n.startPoints),e.setExtras(n)}_createMapOptions(e,n,s){let{dungeonType:r}=s,a={};const o=E(e,n);switch(r=r.capitalize(),r){case"Cave":a=t.Miners.getRandOpts(e,n,1,3);break;case"Grotto":a=t.Miners.getRandOpts(e,n,2,4);break;case"Lair":{const s=t.Miners.getMinersAndExclude(e,n,["C"]),r=[y.arrayGetRand(s),o.C];a=t.Miners.getOptsWithMiners(r);break}case"Cavern":a=t.Miners.getRandOpts(e,n,3,9);break;default:a=t.Miners.getRandOpts(e,n)}let i=y.getUniform()<=.1;return!1===s.isCollapsed&&(i=!1),(i||s.isCollapsed)&&(a.floorElem=p.ELEM.CHASM,a.isCollapsed=!0),a}addStairsLocations(e){const t=e.getExtras(),{startPoints:n}=t;let s=null,r=null;n.length>1?[s,r]=y.getUniqueItems(n,2):(s=n[0],r=this.getEndPointFromMap(e,s)),c.LevelGenerator.addStartAndEndPointMarker(e,s,r),t.startPoint=s,r&&(t.endPoint=r);const a=n.slice();t.points=[],a.splice(a.indexOf(s),1),a.splice(a.indexOf(r),1),a.forEach(n=>{const[s,r]=n,a=new b(">");a.setTag("end_point"),e.addElement(a,s,r),t.points.push(n)})}_addSpecialFeatures(e){e.getExtras().isCollapsed&&this._createCollapsedLevel(e)}getEndPointFromMap(e,t){const n=e.getMap(),s=this.getMapOfNonWallCells(e);return this.getRandomEndPoint(n,t,s)}getMapOfNonWallCells(e){const t=e.getMap().getCells(e=>!e.getBaseElem().isWall()),n={};return t.forEach(e=>{n[e.getKeyXY()]=e}),n}_createCollapsedLevel(e){const t=e.getExtras(),n=e.getMap();let{endPoint:s}=t;const{startPoint:r}=t,a=this.getMapOfNonWallCells(e);if(s||(s=this.getRandomEndPoint(n,r,a)),r&&s){this.createPath(n,r,s).forEach(e=>{delete a[e[0]+","+e[1]]})}const o=[r,s];t.points&&t.points.forEach(e=>{const t=y.arrayGetRand(o);this.createPath(n,e,t).forEach(e=>{delete a[e[0]+","+e[1]]}),o.push(e)});const i=y.getUniformInt(1,10);for(let e=0;e<i;e++){const e=this.getRandomPoint(n,r,a);if(e){const t=y.arrayGetRand(o);this.createPath(n,e,t).forEach(e=>{delete a[e[0]+","+e[1]]}),o.push(e)}}}createPath(e,t,n){const[s,r]=t,[a,o]=n,i=u.Path.getShortestPath(s,r,a,o,(t,n)=>e.hasXY(t,n)&&!e.getBaseElemXY(t,n).getType().match(/wall/)),l=[];return i.forEach(t=>{const{x:n,y:s}=t;h.Geometry.getCrossAround(n,s,1,!0).forEach(t=>{const[n,s]=t;"chasm"===e.getCell(n,s).getBaseElem().getType()&&(e.setBaseElemXY(n,s,p.ELEM.FLOOR_CAVE),l.push([n,s]))})}),l}getRandomEndPoint(e,t,n){const s=(t,n)=>e.hasXY(t,n)&&!e.getBaseElemXY(t,n).getType().match(/wall/),[r,a]=t;let o=null;const i=e.cols>e.rows?e.rows:e.cols;let l=0,c=10;const h=Object.values(n);let d=null;for(;l<i;){const e=y.arrayGetRand(h),[t,n]=e.getXY();if(o=[t,n],d=u.Path.getShortestPath(t,n,r,a,s),l=d.length,0===c)break;--c}return o&&d&&d.forEach(e=>{const t=e.x+","+e.y;delete n[t]}),o}getRandomPoint(e,t,n){const[s,r]=t,a=Object.values(n),o=y.arrayGetRand(a),[i,l]=o.getXY(),c=[i,l],h=u.Path.getShortestPath(i,l,s,r,(t,n)=>e.hasXY(t,n)&&!e.getBaseElemXY(t,n).getType().match(/wall/));return c&&h&&h.forEach(e=>{const t=e.x+","+e.y;delete n[t]}),c}_addEncounters(e,t){const{dungeonType:n}=t;"Lair"===n&&this._addLairBoss(e,t),this.populatePoints(e,t)}_addLairBoss(e,t){const{maxDanger:n,maxValue:s}=t,a=e.getExtras().endPoint;if(a){const t=new l.DungeonPopulate({});e.getExtras().isCollapsed&&t.setActorFunc(e=>e.flying),t.addPointGuardian(e,a,n+4),t.addMainLoot(e,a,s)}else{const t=JSON.stringify(e.getExtras());r.default.err("CaveGenerator","_addLairBoss","No endPoint in extras: "+t)}}populatePoints(e,t){const n=e.getExtras(),{points:s}=n;if(s){const n=new l.DungeonPopulate({});s.forEach(s=>{n.populatePoint(e,s,t)})}else r.default.err("LevelGenerator","populatePoints","extras.points must be set for populating points")}_addOreVeins(e,t){const n=e.getBbox();for(let t=0;t<10;t++){const t=y.getRandInBbox(n),s=parseInt(y.getWeighted(r.default.ORE_VEIN_SIZES),10),a=h.Geometry.drunkenWalk(t,s),o=[],i=f.ObjectShell.getParser();a.forEach(e=>{const t=i.createElement("iron ore vein");o.push(t)}),g.Placer.addElemsToCoord(e,a,o)}}}function E(e,t,n=1){const s=Math.round(e/2),r=Math.round(t/2),a=e-1-n,o=t-1-n;return{N:{x:s,y:1,dirWeights:{E:1,W:1,S:5,SE:5,SW:5},dugCallback:(e,t,n)=>{t===o&&(n.dirWeights={})}},S:{x:s,y:o,dirWeights:{E:1,W:1,N:5,NE:5,NW:5},dugCallback:(e,t,n)=>{1===t&&(n.dirWeights={})}},E:{x:a,y:r,dirWeights:{N:1,S:1,NW:5,W:5,SW:5}},W:{x:1,y:r,dirWeights:{N:1,S:1,NE:5,E:5,SE:5}},NE:{x:a,y:1,dirWeights:{NW:1,W:10,SW:5,S:10}},NW:{x:1,y:1,dirWeights:{NE:1,E:10,SE:5,S:10}},SE:{x:a,y:o,dirWeights:{SW:1,W:10,NW:5,N:10}},SW:{x:1,y:o,dirWeights:{SE:1,E:10,NE:5,N:10}},C:{x:s,y:r,dirWeights:{N:1,S:1,E:2,W:2,NE:1,SE:1,NW:1,SW:1}}}}function S(e){const t=e[0],n={startX:t.x,startY:t.y,dirWeights:t.dirWeights},s=[];for(let t=1;t<e.length;t++)s.push(e[t]);return n.addMiners=s,n}t.CaveGenerator=_,t.Miners={},t.Miners.getMiners=E,t.Miners.getMinersAndExclude=function(e,t,n){const s=E(e,t);return n.forEach(e=>{delete s[e]}),Object.values(s)},t.Miners.getOptsWithMiners=S,t.Miners.getRandOpts=function(e,t,n=1,s=9){const r=E(e,t),a=Object.values(r),o=y.getUniformInt(n,s),i=[];for(let e=0;e<o;e++){const e=y.arrayGetRand(a);i.push(e)}return S(i)},t.Miners.getMinersCorners=function(e,t,n){return n||(n=E(e,t)),{cols:e,rows:t,dirWeights:n.NW.dirWeights,addMiners:[n.SW,n.NE,n.SE],startX:n.NW.x,startY:n.NW.y}},t.Miners.getMinersNSEW=function(e,t,n){return n||(n=E(e,t)),{cols:100,rows:100,maxMinersCreated:100,startX:n.N.x,startY:n.N.y,dirWeights:n.N.dirWeights,addMiners:[n.S,n.E,n.W]}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DungeonGenerator=void 0;const r=s(n(4)),a=s(n(331)),o=s(n(280)),i=n(92),l=s(n(15)),c=n(62),u=n(46),h=n(24),d=n(13),p=n(63),f=n(19),m=n(81),g=n(9),y=n(18),v=n(12),b=n(16),_=n(225),E=n(30),S=l.default("bitn:dungeon"),w=(a.default,o.default),C=i.Room,O=g.Random.getRNG(),T=f.Path.getShortestPath,M={x:[1,1,1],y:[1,1,1]},A=e=>!e.hasObstacle()||e.hasDoor(),N={chasm:{elem:y.ELEM.CHASM},water:{elem:y.ELEM.WATER},snow:{elem:y.ELEM.SNOW},forest:{elem:y.ELEM.TREE},fire:{elem:y.ELEM.LAVA}},x=.07,P=.5,I={cross:{special:["splashes"]},"small vault":{},"large vault":{},"large corridor":{special:["splashes"]},center:{},nest:{}};class D{constructor(e,t){this.type=e,this.room=t}}class k extends c.LevelGenerator{constructor(){super(),this.addDoors=!0,this.shouldRemoveMarkers=!0,this._debug=this._debug||S.enabled}static getOptions(e="digger"){const t=c.LevelGenerator.getOptions(),n={levelType:e,nBigRooms:1,dungeonType:"",wallType:"walldungeon",floorType:"floordungeon",bigRooms:{bigRoomX:["cen"],bigRoomY:["cen"],bigRoomWidth:[10],bigRoomHeight:[10]},minNumRooms:3,rerunOnFailure:!0,errorOnFailure:!1},s={options:L[e]};return Object.assign(n,s,t)}static addStairsToTwoRooms(e){const t=e.getExtras();let n=r.default.WATCHDOG;if(t.rooms){let[s,a]=O.getUniqueItems(t.rooms,2),o=null,i=null,l=0,u=0;const h=Math.floor(e.getMap().cols/2)+Math.floor(e.getMap().rows/2);for(;l<h&&([s,a]=O.getUniqueItems(t.rooms,2),l=B(e,s,a),l>u&&(u=l,o=s,i=a),0!=--n););s=o,a=i,S("Rooms for stairs locations",s,a);const d=e.getMap().getFreeInBbox(s.getBbox()),p=e.getMap().getFreeInBbox(a.getBbox()),f=O.arrayGetRand(d),m=O.arrayGetRand(p);f||r.default.err("DungeonGenerator","addStairsLocation","Failed to find free place for Stairs@room1"),m||r.default.err("DungeonGenerator","addStairsLocation","Failed to find free place for Stairs@room2"),t.startPoint=m.getXY(),t.endPoint=f.getXY();const{startPoint:g,endPoint:y}=t;c.LevelGenerator.addStartAndEndPointMarker(e,g,y),s.addStairs(...t.endPoint,!0),a.addStairs(...t.startPoint,!1)}else{const e="rooms must be set as level extras";r.default.err("DungeonGenerator","addStairsToTwoRooms","Not enough rooms to add stairs. "+e)}}create(e,t,n){const s=this._createLevel(e,t,n);this.addSpecialFeatures(s),k.addStairsToTwoRooms(s),k.addCriticalPath(s),(n.rerunOnFailure||n.errorOnFailure)&&(this.verifyLevel(s,n)||(console.log("verifyLevel failed. Re-running"),this.create(e,t,n))),n.maxRarity||r.default.err("DungeonGenerator","create","No maxRarity given in the config");new m.DungeonPopulate({theme:"",maxDanger:n.maxDanger,maxValue:n.maxValue,itemFunc:e=>"food"!==e.type}).populateLevel(s);const a={};return(n.shouldRemoveMarkers||this.shouldRemoveMarkers)&&(a.shouldRemoveMarkers=!0,a.markersPreserved=!1),this.removeMarkers(s,a),s}_createLevel(e,t,n){e||(e=O.getUniformInt(80,120)),t||(t=O.getUniformInt(28,56));const s=n.minNumRooms||3;let r=null,a=null;const o=(e,t,s)=>{1===s?a.setBaseElemXY(e,t,y.getElem(n.wallType)||y.ELEM.WALL):a.setBaseElemXY(e,t,y.getElem(n.floorType)||y.ELEM.FLOOR_CAVE)};let i=10;for(;(!r||r.getRooms().length<s)&&(r=this.getMapGen(e,t,n),a=new u.CellMap(e,t),r.create(o),0!=--i););const l=new h.Level(a),c={rooms:r.getRooms(),corridors:r.getCorridors()};return r.bigRooms&&(c.bigRooms=r.bigRooms),l.setExtras(c),this.addNestIntoLevel(l),l}getMapGen(e,t,n){let s=R();n.dungeonType&&""!==n.dungeonType&&(s=n.dungeonType);const r=n.options||L[s];r&&!r.roomDugPercentage&&(r.roomDugPercentage=r.dugPercentage);const a=new w(e,t,r),o=this.addBigRooms(a,n);return o.length>0&&(a.bigRooms=o),a}addBigRooms(e,t){let n=[];t.nBigRooms&&t.nBigRooms>0&&t.bigRooms&&(n=this.addCustomBigRooms(e,t));if(O.getUniform()<=P&&0===t.nBigRooms){const t=this.getBigRoomType();/center/.test(t)&&(n=this.addBigCenterRoom(e)),/large corridor/.test(t)&&(n=this.addLargeCorridorRoom(e)),/cross/.test(t)&&(n=this.addLargeCross(e)),/vault/.test(t)&&(n=this.addVault(e)),/nest/.test(t)&&(n=this.addRoomForNest(e))}return n}getBigRoomType(){return O.arrayGetRand(Object.keys(I))}addCustomBigRooms(e,t){const[n,s]=e.getCenterXY(),[r,a]=[e.getCols(),e.getRows()],o=t.nBigRooms||0,i=[];for(let l=0;l<o;l++){let o=Math.floor(r/4);t.bigRoomWidth&&t.bigRoomWidth[l]&&(o=t.bigRoomWidth[l]);let c=Math.floor(a/4);t.bigRoomHeight&&t.bigRoomHeight[l]&&(c=t.bigRoomHeight[l]);const u=r-2-o;let h=O.getUniformInt(1,u),d="";t.bigRoomX&&(d=t.bigRoomX[l]),/cen/.test(d)&&(h=n-Math.floor(o/2));const p=a-2-c;let f=O.getUniformInt(1,p),m="";t.bigRoomY&&(m=t.bigRoomY[l]),/cen/.test(m)&&(f=s-Math.floor(c/2));const g=new C(h,f,h+(o-1),f+(c-1));e._options.dugPercentage+=.1,e.addRoom(g),i.push(new D("custom",g))}return i}addBigCenterRoom(e){const[t,n]=[e.getCols(),e.getRows()],[s,r]=e.getCenterXY(),a=O.getUniformInt(2,5),o=O.getUniformInt(2,6),i={roomWidth:[Math.floor(t/(o+1)),Math.floor(t/o)],roomHeight:[Math.floor(n/a),Math.floor(n/a)]},l=C.createCenter(s,r,i);return e._options.dugPercentage+=.2,e.addRoom(l),[new D("center",l)]}addLargeCorridorRoom(e){const[t,n]=[e.getCols(),e.getRows()],s=O.getCardinalDirLetter(),a="large corridor "+s;let o=null;if("E"===s){const e=O.getUniformInt(2,6),s=Math.floor(t/e);o=new C(1,1,s,n-2)}if("W"===s){const e=O.getUniformInt(2,6),s=Math.floor(t/e);o=new C(t-2-s,1,t-2,n-2)}if("N"===s){const e=O.getUniformInt(2,5),s=Math.floor(n/e);o=new C(1,1,t-2,s)}if("S"===s){const e=O.getUniformInt(2,5),s=Math.floor(n/e);o=new C(1,n-2-s,t-2,n-2)}return o||r.default.err("DungeonGenerator","addLargeCorridorRoom","room null something went wrong"),e._options.dugPercentage+=.2,e.addRoom(o),[new D(a,o)]}addLargeCross(e){const[t,n]=[e.getCols(),e.getRows()],[s,r]=e.getCenterXY(),a=O.getUniformInt(3,8),o=Math.floor(t/a),i=Math.floor(n/a),l={roomWidth:[t-2,t-2],roomHeight:[i,i]},c={roomHeight:[n-2,n-2],roomWidth:[o,o]},u=C.createCenter(s,r,l),h=C.createCenter(s,r,c);e.addRoom(u),e.addRoom(h);const d=(u.getAreaSize()+h.getAreaSize())/(t*n);return e._options.dugPercentage+=1.6*d,e._options.dugPercentage>=.75&&(e._options.dugPercentage=.75),[new D("crossHor",u),new D("crossVer",h)]}addVault(e){const[t,n]=[e.getCols(),e.getRows()],s=O.getUniform()<=x;let r=Math.floor(t/2),a=Math.floor(n/2),o=["NE","NW","SW","SE"],i="small vault";s&&(O.getUniform()<=.5?(o=["NE","NW"],r=Math.floor(t/2),a=n-2):(o=["NW","SW"],r=t-2,a=Math.floor(n/2)),e._options.dugPercentage+=.25,i="large vault");const[l,c]=this.getRandCorner(r,a,t,n,o),u=new C(l,c,l+r-1,c+a-1);return e._options.dugPercentage+=.2,e.addRoom(u),[new D(i,u)]}addRoomForNest(e){let t=7*O.getUniformInt(2,5),n=7*O.getUniformInt(2,5);const[s,r]=[e.getCols(),e.getRows()];for(;t>s-2;)t-=7;for(;n>r-2;)n-=7;const[a,o]=this.getRandCorner(t,n,s,r,["NE","NW","SW","SE"]),i=new C(a,o,a+t-1,o+n-1);return e._options.dugPercentage+=.2,e.addRoom(i),[new D("nest",i)]}getRandCorner(e,t,n,s,r){const a=O.arrayGetRand(r);let[o,i]=[1,1];switch(a){case"NW":o=1,i=1;break;case"NE":o=n-2-e,i=1;break;case"SW":o=1,i=s-2-t;break;case"SE":o=n-2-e,i=s-2-t}return[o,i]}addSpecialFeatures(e){const t=e.getExtras(),n=e.getMap();if(t.bigRooms){const n=t.bigRooms[0];let s={};if(Object.keys(I).forEach(e=>{new RegExp(e).test(n.type)&&(s=I[e])}),s.special){const n=O.arrayGetRand(s.special);this.addBigRoomSpecialFeat(e,n,t.bigRooms)}}if(t.rooms){const s=O.arrayGetRand(t.rooms),r=[];this.addFireToRoom(e,s),t.rooms.forEach((t,s)=>{t.setID(s);let a=0;const o=E.BBox.fromBBox(t.getOuterBbox());d.Geometry.getBorderForBbox(o).forEach(t=>{if(e.getMap().hasXY(t[0],t[1]))if(n.has(t,"floor"))++a;else{const n=new b.ElementMarker("w");n.setTag("room wall"),e.addElement(n,t[0],t[1])}}),this.addDoorsForRoom(e,t),1===a&&r.push(t)}),r.forEach(t=>{const n=t.getInnerBbox();if(null!==n){d.Geometry.getCoordBbox(n).forEach(t=>{const n=new b.ElementMarker("t");n.setTag("term"),e.addElement(n,t[0],t[1])})}}),t.terms=r}}addBigRoomSpecialFeat(e,t,n){n.forEach(n=>{const s=n.room;switch(s||r.default.err("DungeonGenerator","addBigRoomSpecialFeat","room is null for "+JSON.stringify(n)),t){case"splashes":this.addElemSplashes(e,s)}})}addDoorsForRoom(e,t){this.addDoors&&t.getDoors((t,n)=>{if(!e.getMap().getCell(t,n).hasDoor()){const s=new b.ElementDoor(!0);e.addElement(s,t,n)}})}addElemSplashes(e,t){const n=O.arrayGetRand(Object.keys(N)),s=N[n],r=s.elem;e.getExtras().theme=s,S("Adding splashes with theme",n);const a=t.getLeft()+1,o=t.getTop()+1,i=t.getWidth(),l=t.getHeight(),{map:c}=p.MapGenerator.createSplashes(i,l,{nForests:10,elem:r});d.Geometry.mergeMapBaseElems(e.getMap(),c,a,o)}addFireToRoom(e,t){const n=v.ObjectShell.getParser();Object.values(t.getCorners()).forEach(t=>{const s=n.createActor("Fire");e.addActor(s,t[0],t[1])})}static addCriticalPath(e){const t=e.getExtras();if(!t.startPoint||!t.endPoint)return;const[n,s]=t.startPoint,[a,o]=t.endPoint,i=e.getMap(),l=(e,t,n,s)=>i.isPassable(e,t,n,s)||i.hasXY(e,t)&&i.getCell(e,t).hasDoor();S("Critical path",n,s,"=>",a,o);let c=f.Path.getShortestPath(n,s,a,o,l);if(0===c.length){const e=(e,t)=>(console.log("newPathFunc x,y ",e,t),!/wall/.test(i.getCell(e,t).getBaseElem().getType()));if(c=f.Path.getShortestPath(n,s,a,o,e),0===c.length)r.default.err("DungeonGenerator","addCriticalPath","No path found between stairs");else for(let e=1;e<c.length;e++){const t=c[e-1],{x:n,y:s}=c[e];i.isPassable(n,s,t.x,t.y)||i.setBaseElemXY(n,s,y.ELEM.BRIDGE)}}const u=(e,t,n,s)=>l(e,t,n,s)&&!i.getCell(e,t).hasMarker("path broken");let h=c;for(;c.length<50;){if(!k._breakPath(e,c))break;if(c=T(n,s,a,o,u),0===c.length){k.restorePath(e,h),c=h;break}h=c}k._addWallsToBrokenPath(e),c.forEach(t=>{const n=new b.ElementMarker("*");n.setTag("critical_path"),e.addElement(n,t.x,t.y)}),t.criticalPath=c}static _breakPath(e,t){for(let n=0;n<t.length;n++){const{x:s,y:r}=t[n];if(e.getMap().getCell(s,r).hasDoor()){const t=new b.ElementMarker("X");return t.setTag("path broken"),e.addElement(t,s,r),!0}}return!1}static _addWallsToBrokenPath(e){e.getElements().filter(e=>"marker"===e.getType()&&"path broken"===e.getTag()).forEach(t=>{const[n,s]=t.getXY();e.getMap().setBaseElemXY(n,s,y.ELEM.WALL)})}static restorePath(e,t){for(let n=0;n<t.length;n++){const{x:s,y:r}=t[n];if(e.getMap().getCell(s,r).hasMarker("path broken")){e.getElements().filter(e=>e.isAtXY(s,r)).forEach(t=>{"marker"===t.getType()&&"path broken"===t.getTag()&&e.removeElement(t,s,r)})}}}addNestIntoLevel(e){const{bigRooms:t}=e.getExtras();if(!t)return;const n=t.filter(e=>/nest/.test(e.type))[0];if(n){const{room:t}=n,s=E.BBox.fromBBox(t.getBbox());S("Adding nest to dungeon now using room bbox",s),S("level cols/rows",e.getMap().cols,e.getMap().rows);const r=new _.NestGenerator,a={mapConf:{tilesX:t.getWidth()/7,tilesY:t.getHeight()/7,genParams:M},embedOpts:{level:e,bbox:s},scanForDoors:!0};r.createAndEmbed(1,1,a)}}verifyLevel(e,t){const n=e.getMap(),s=n.getCells(A),a=d.Geometry.floodfillPassable(n,!0),o=s.length,i=a.length;if(i!==o){const n=o-i;if(n>10){this.tryToFillUnreachable(e);const s=this.verifyLevel(e,t);if(!s&&t.errorOnFailure){e.debugPrintInASCII();const t="Max: 10, got: "+n;r.default.err("DungeonGenerator","verifyLevel","Too many unreachable cells "+t)}return s}}return!0}tryToFillUnreachable(e){const t=e.getMap(),n=d.Geometry.floodfillRegions(t,!0),{startPoint:s,endPoint:a}=e.getExtras(),o=t.getCell(s[0],s[1]),i=t.getCell(a[0],a[1]),l=d.Geometry.floodfill(t,o,A,!0),c=d.Geometry.floodfill(t,i,A,!0);l.length===c.length?n.forEach(e=>{e.length!==l.length&&t.setBaseElems(e,y.ELEM.WALL)}):r.default.err("DungeonGenerator","tryToFillUnreachable","floodfill sizes for start/endFill differ. They are not connected!")}}t.DungeonGenerator=k,k.mapOptions={digger:{roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2},uniform:{roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1}};const L=k.mapOptions,R=()=>O.arrayGetRand(["uniform","digger"]);function B(e,t,n){const s=e.getMap(),[r,a]=t.getCenter(),[o,i]=n.getCenter();return f.Path.getShortestPassablePathWithDoors(s,r,a,o,i).length}},function(e,t,n){e.exports=!n(101)&&!n(120)((function(){return 7!=Object.defineProperty(n(346)("div"),"a",{get:function(){return 7}}).a}))},function(e,t,n){var s=n(100),r=n(66).document,a=s(r)&&s(r.createElement);e.exports=function(e){return a?r.createElement(e):{}}},function(e,t,n){var s=n(84),r=n(85),a=n(708)(!1),o=n(232)("IE_PROTO");e.exports=function(e,t){var n,i=r(e),l=0,c=[];for(n in i)n!=o&&s(i,n)&&c.push(n);for(;t.length>l;)s(i,n=t[l++])&&(~a(c,n)||c.push(n));return c}},function(e,t,n){var s=n(229);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==s(e)?e.split(""):Object(e)}},function(e,t,n){var s=n(231),r=Math.min;e.exports=function(e){return e>0?r(s(e),9007199254740991):0}},function(e,t,n){"use strict";var s=n(712)(!0);n(351)(String,"String",(function(e){this._t=String(e),this._i=0}),(function(){var e,t=this._t,n=this._i;return n>=t.length?{value:void 0,done:!0}:(e=s(t,n),this._i+=e.length,{value:e,done:!1})}))},function(e,t,n){"use strict";var s=n(237),r=n(65),a=n(352),o=n(98),i=n(84),l=n(124),c=n(713),u=n(239),h=n(716),d=n(50)("iterator"),p=!([].keys&&"next"in[].keys()),f=function(){return this};e.exports=function(e,t,n,m,g,y,v){c(n,t,m);var b,_,E,S=function(e){if(!p&&e in T)return T[e];switch(e){case"keys":case"values":return function(){return new n(this,e)}}return function(){return new n(this,e)}},w=t+" Iterator",C="values"==g,O=!1,T=e.prototype,M=T[d]||T["@@iterator"]||g&&T[g],A=!p&&M||S(g),N=g?C?S("entries"):A:void 0,x="Array"==t&&T.entries||M;if(x&&(E=h(x.call(new e)))!==Object.prototype&&E.next&&(u(E,w,!0),s||i(E,d)||o(E,d,f)),C&&M&&"values"!==M.name&&(O=!0,A=function(){return M.call(this)}),s&&!v||!p&&!O&&T[d]||o(T,d,A),l[t]=A,l[w]=f,g)if(b={values:C?A:S("values"),keys:y?A:S("keys"),entries:N},v)for(_ in b)_ in T||a(T,_,b[_]);else r(r.P+r.F*(p||O),t,b);return b}},function(e,t,n){e.exports=n(98)},function(e,t,n){var s=n(347),r=n(234).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return s(e,r)}},function(e,t,n){var s=n(123),r=n(121),a=n(85),o=n(228),i=n(84),l=n(345),c=Object.getOwnPropertyDescriptor;t.f=n(101)?c:function(e,t){if(e=a(e),t=o(t,!0),l)try{return c(e,t)}catch(e){}if(i(e,t))return r(!s.f.call(e,t),e[t])}},function(e,t,n){var s=n(122),r=n(85),a=n(123).f;e.exports=function(e){return function(t){for(var n,o=r(t),i=s(o),l=i.length,c=0,u=[];l>c;)a.call(o,n=i[c++])&&u.push(e?[n,o[n]]:o[n]);return u}}},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t,n,a){return(0,s.default)(e,t,n,a),{remove:function(){(0,r.default)(e,t,n,a)}}};var s=a(n(110)),r=a(n(132));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=u(n(0)),r=u(n(162)),a=u(n(1)),o=u(n(17)),i=u(n(163)),l=u(n(102)),c=u(n(758));function u(e){return e&&e.__esModule?e:{default:e}}function h(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function d(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var p=function(e){function t(){var n,s;h(this,t);for(var r=arguments.length,a=Array(r),o=0;o<r;o++)a[o]=arguments[o];return n=s=d(this,e.call.apply(e,[this].concat(a))),s.setContainer=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:s.props;s._portalContainerNode=(0,i.default)(e.container,(0,l.default)(s).body)},s.getMountNode=function(){return s._portalContainerNode},d(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this.setContainer(),this.forceUpdate(this.props.onRendered)},t.prototype.componentWillReceiveProps=function(e){e.container!==this.props.container&&this.setContainer(e)},t.prototype.componentWillUnmount=function(){this._portalContainerNode=null},t.prototype.render=function(){return this.props.children&&this._portalContainerNode?o.default.createPortal(this.props.children,this._portalContainerNode):null},t}(a.default.Component);p.displayName="Portal",p.propTypes={container:s.default.oneOfType([r.default,s.default.func]),onRendered:s.default.func},t.default=o.default.createPortal?p:c.default,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){var t=(0,a.default)(e),n=(0,r.default)(t),o=t&&t.documentElement,i={top:0,left:0,height:0,width:0};if(!t)return;if(!(0,s.default)(o,e))return i;void 0!==e.getBoundingClientRect&&(i=e.getBoundingClientRect());return i={top:i.top+(n.pageYOffset||o.scrollTop)-(o.clientTop||0),left:i.left+(n.pageXOffset||o.scrollLeft)-(o.clientLeft||0),width:(null==i.width?e.offsetWidth:i.width)||0,height:(null==i.height?e.offsetHeight:i.height)||0}};var s=o(n(58)),r=o(n(109)),a=o(n(52));function o(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var n=(0,a.default)(e);if(void 0===t)return n?"pageYOffset"in n?n.pageYOffset:n.document.documentElement.scrollTop:e.scrollTop;n?n.scrollTo("pageXOffset"in n?n.pageXOffset:n.document.documentElement.scrollLeft,t):e.scrollTop=t};var s,r=n(109),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(1)),i=n(769);class l extends o.Component{constructor(e){super(e),this.saveLevel=this.saveLevel.bind(this),this.loadLevel=this.loadLevel.bind(this)}shouldComponentUpdate(){return!1}saveLevel(){let e=this.props.objData;this.props.objData.toJSON&&(e=this.props.objData.toJSON());try{if(!!new Blob){const t=(new Date).getTime(),n=`${this.props.fNamePrefix||"bsave"}_${t}_${this.props.savedObjName}.json`;let s=null;s=this.props.pretty?JSON.stringify(e,null," "):JSON.stringify(e);const r=new Blob([s],{type:"text/plain;charset=utf-8"});i.saveAs(r,n),this.props.onSaveCallback&&this.props.onSaveCallback(e)}}catch(t){let n="No Blob support in browser. Saving to localStorage.\n";n+="You can visit /level.html to view the JSON.",localStorage.setItem("savedLevel",JSON.stringify(e)),this.props.setMsg({errorMsg:n})}}loadLevel(){const e="#"+this.props.id+"level-file-input",t=document.querySelector(e).files;let n=null;if(t&&t[0]&&(n=t[0]),n){const e=new FileReader;e.onloadend=()=>{const t=e.result;try{const e=JSON.parse(t);this.props.onLoadCallback&&this.props.onLoadCallback(e)}catch(e){const t="File: Not valid JSON or level: "+e.message;console.log(e),this.props.setMsg({errorMsg:t})}},e.onerror=e=>{const t="Filereader error: "+e;this.props.setMsg({errorMsg:t})},e.readAsText(n)}else{const e="Could not get the file.";this.props.setMsg({errorMsg:e})}}render(){const e=this.props.id+"level-file-input";return o.default.createElement("div",null,o.default.createElement("button",{className:"btn btn-light",id:this.props.id+"btn-save-level",onClick:this.saveLevel},this.props.saveButtonName||"Save"),o.default.createElement("label",{className:"btn btn-info",htmlFor:e},this.props.loadButtonName||"Load"),o.default.createElement("input",{id:e,onChange:this.loadLevel,type:"file",style:{visibility:"hidden"}}))}}t.default=l},function(e,t){(function(t){e.exports=t}).call(this,{})},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ContextMenuItems=void 0;const o=a(n(1)),i=n(249);class l extends o.Component{constructor(e){super(e),this.handleClick=this.handleClick.bind(this)}shouldComponentUpdate(e){if(this.props.mouseOverCell){if(!e.mouseOverCell)return!0;const[t,n]=this.props.mouseOverCell.getXY(),[s,r]=e.mouseOverCell.getXY();if(s===t&&r===n)return!1}return!0}render(){const e=this.renderMenuItems();return o.createElement(i.ContextMenu,{className:"context-menu",id:"right-click-context-menu"},e)}handleClick(e,t){console.log("ContextMenuItems handleClick with",t),this.props.mouseOverCell&&this.props.handleRightClick(e,t,this.props.mouseOverCell)}renderMenuItems(){const e=[];return Object.keys(this.props.menuItems).forEach(t=>{if(this.isCorrectContext(t)){this.getMenuItems(this.props.menuItems[t]).forEach((t,n)=>{t.cellQuery?e.push(this.getQueryMenuItem(n,t)):e.push(o.createElement(i.MenuItem,{data:{type:t.type},key:n+"-"+t.text,onClick:this.handleClick},t.text))}),e.push(o.createElement(i.MenuItem,{divider:!0,key:"divider-"+t}))}}),e}getMenuItems(e){let t=[];return Array.isArray(e)?e:(Object.keys(e).forEach(n=>{this.isCorrectContext(n)&&(t=t.concat(this.getMenuItems(e[n])))}),t)}isCorrectContext(e){const t=this.props.mouseOverCell;if(t){if("function"==typeof t[e])return t[e]();if("function"==typeof this[e])return this[e]()}return!1}getQueryMenuItem(e,t){let n=this.props.mouseOverCell[t.cellQuery]();Number.isInteger(t.index)&&(n=n[t.index]);const s=n[t.objectQuery]();return o.createElement(i.MenuItem,{data:{type:t.type},key:e+"-"+s},s)}}t.ContextMenuItems=l},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.AbandonedFort=t.abandonedFortConf=void 0;const i=o(n(4)),l=n(86),c=n(64),u=n(28),h=n(12),d=n(19),p=n(118),f=a(n(16)),m=n(158),g=n(31),y=n(13),v=n(30),b=n(82),_=n(9),E=_.Random.getRNG();t.abandonedFortConf={outerColsRatio:.4,outerRowsRatio:.4,outerStartXRatio:.4,mountainWallRatio:.3,castleRowsRatio:.6,castleColsRatio:.6};t.AbandonedFort=class{constructor(e,n,s){s||(s=t.abandonedFortConf);const r=s.outerColsRatio||.4,a=s.outerRowsRatio||.4,o=s.outerStartXRatio||.4,i=s.mountainWallRatio||.3,u={meanWx:Math.floor(i*e),stdDev:15,filterW:7,north:!0,south:!0,east:!1,west:!1,alignHorizontal:"right",wallType:"wallcave"},d={nRoadTurns:0,snowRatio:.3};Object.assign(d,g.MountainGenerator.getFaceOptions()),d.nRoadTurns=0;const p=this.createLevel("mountain",e,n,d),b=p.getMap(),_=(new g.MapGenerator,{startRoomFunc:m.Castle.startRoomFuncWest}),E=Math.round(r*e),S=Math.round(a*n),w=new g.CastleGenerator,C=w.createLevel(E,S,_).getMap(),O=(Math.round(o*e),Math.round(n/2-C.rows/2),Math.floor(e/2)),T=this.createLevel("wall",O,n,u),M=e-T.getMap().cols;y.Geometry.mergeLevels(p,T,M,0,{skip:{floor:!0}}),g.MapGenerator.addRandomSnow(p.getMap(),.3);const A=this.getCastleLevel(n,e,s),N=e-A.getMap().cols,x=Math.round((n-A.getMap().rows)/2);y.Geometry.mergeLevels(p,A,N,x);const P=Math.floor(n/2),I=new f.ElementStairs("stairsUp",p);p.addStairs(I,0,P);const D=A.getMap().rows,k=A.getMap().cols;let L=x,R=x+(D-1);L+=7,R-=7;const B=b.getFirstFreeFromRight(L,R),[F,G]=[B.getX(),B.getY()],j=new f.ElementStairs("stairsDown",p);p.addStairs(j,F,G);const W=v.BBox.fromBBox({ulx:N,uly:x,lrx:N+k-1,lry:x+D-1}),Y=h.ObjectShell.getParser(),X=new c.FactoryItem,U=b.getFreeInBbox(W);X.addItemsToCells(p,Y,U,{itemsPerLevel:50,nLevel:0,item:e=>e.value>=100&&e.value<=200,maxValue:500});const $={"mighty raven":!0,"winter demon":!0,cryomancer:!0,"ice djinn":!0,stormrider:!0,"snow leopard":!0},H={actorsPerLevel:500,actor:e=>$.hasOwnProperty(e.name),maxDanger:15};(new l.FactoryBase).addNRandActors(p,Y,H),this.createPathToFort(p,N),w.populateStoreRooms(p,{actorFunc:e=>"WinterBeingBase"===e.base||"construct"===e.base,maxDanger:15,maxValue:700,maxRarity:7});w.removeMarkers(p,{markersPreserved:!1,shouldRemoveMarkers:!0}),this.addWinterSpawner(p),this.level=p}getCastleLevel(e,t,n){const s=n.castleRowsRatio||.6,r=n.castleColsRatio||.6,a=Math.floor(s*e),o=Math.floor(r*t),i={tilesX:Math.round(o/7),tilesY:Math.round(a/7),roomCount:200,startRoomFunc:m.Castle.startRoomFuncWest};return(new g.CastleGenerator).createLevel(o,a,i)}createLevel(e,t,n,s){return(new u.FactoryLevel).createLevel(e,t,n,s)}createPathToFort(e,t){const n=e.getMap(),s=t+1,r=Math.floor(n.rows/2),a=Math.floor(n.rows/2);this.createVariedPath(n,{x0:0,x1:s,y0:r,y1:a})}createVariedPath(e,t){const{x0:n,y0:s,x1:r,y1:a}=t;let o=[],i=s;for(let t=n;t<r;t+=20){let n=t+20,s=a+E.getUniformInt(-20,20);n>=r&&(n=r,s=a);const l=d.Path.getMinWeightPath(e,t,i,n,s);i=s,o=o.concat(l)}p.Builder.addPathToMap(e,o)}getLevel(){return this.level}addWinterSpawner(e){const t=e.getMap().rows,n=new b.SpawnerActor("winter spawner"),s=[{op:"eq",value:0,func:"getX"},{op:"eq",value:Math.round(t/2),func:"getY"}],r=n.getBrain();r.setConstraint([{op:"eq",value:"WinterBeingBase",prop:"base"},{op:"gte",value:5,prop:"danger"}]),r.setPlaceConstraint(s),r.spawnProb=.1,r.spawnLeft=-1,e.addVirtualProp(i.default.TYPE_ACTOR,n)}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Capital=void 0;const i=o(n(4)),l=n(48),c=n(19),u=n(118),h=n(12),d=a(n(16)),p=n(28),f=n(13),m=n(31),g=n(82);t.Capital=class{constructor(e,t,n={}){i.default.isNullOrUndef([e,t])&&i.default.err("Capital","constructor","Use new Capital(cols, rows, conf?)");const s={meanWy:Math.floor(.9*t/2),stdDev:10,filterW:7};n.transpose&&(s.north=!0,s.south=!0,s.east=!1,s.west=!1,s.meanWx=Math.floor(.9*e/2));const r=(new p.FactoryLevel).createLevel("wall",e,t,s),a=r.getMap(),o=[.03,.2,.75,.95],y=[.5,.8,.6],v=h.ObjectShell.getParser(),b=e=>"Hyrkhian townsfolk"===e.name,_=[{actorFunc:b,parser:v,nGates:2,hasWall:!0},{actorFunc:b,parser:v,nGates:2,hasWall:!0},{actorFunc:b,parser:v,nGates:2,hasWall:!0}],E=[];for(let s=0;s<o.length-1;s++){const r=Math.floor(t*o[s]);let a=Math.floor(t*o[s+1])-r,i=Math.floor(y[s]*e);if(n.transpose){const n=Math.floor(e*o[s]);i=Math.floor(e*o[s+1])-n,a=Math.floor(y[s]*t)}_[s].nHouses=Math.floor(i*a/500),_[s].floorType="cave",_[s].wallType="castle",_[s].addWindows=!0;const l=new m.CityGenerator;l.populate=!1;const c=l.create(i,a,_[s]);E.push(c)}const S={x:0,y:Math.floor(o[0]*e),centerX:!0};if(n.transpose&&(S.centerY=!0,S.centerX=!1,S.y=0,S.x=Math.floor(o[0]*t)),f.Geometry.tileLevels(r,E,S),n.transpose){const n=Math.floor(t/2),s=new d.ElementStairs("stairsUp",r);r.addStairs(s,0,n);const o=new d.ElementStairs("stairsUp",r);r.addStairs(o,e-1,n);const i=c.Path.getMinWeightPath(a,0,n,e-1,n);u.Builder.addPathToMap(a,i)}else{const n=Math.floor(e/2),s=new d.ElementStairs("stairsUp",r);r.addStairs(s,n,0);const o=new d.ElementStairs("stairsUp",r);r.addStairs(o,n,t-1);const i=c.Path.getMinWeightPath(a,n,0,n,t-1,c.Path.getShortestPassablePathWithDoors);u.Builder.addPathToMap(a,i)}const w={actorFunc:b,nShops:6,parser:v,shouldRemoveMarkers:!0},C=new m.CityGenerator;C.populateCityLevel(r,w),C.removeMarkers(r,w);const O={footman:200,archer:100,elite:50,commander:10},T=[];Object.keys(O).forEach(e=>{const t="Hyrkhian "+e,n=O[e];for(let e=0;e<n;e++){const e=v.createActor(t);T.push(e)}});for(let e=0;e<3;e++){const e=v.createActor("trainer");T.push(e)}l.Placer.addPropsToFreeCells(r,T);const M=[v.createItem("Longsword")];l.Placer.addPropsToFreeCells(r,M);const A=new g.SpawnerActor("winter spawner"),N=A.getBrain();N.setConstraint([{op:"eq",value:"WinterBeingBase",prop:"base"},{op:"gte",value:5,prop:"danger"},{op:"lte",value:12,prop:"danger"}]),N.setPlaceConstraint([{op:"eq",value:0,func:"getY"}]),N.spawnProb=.1,N.spawnLeft=-1,r.addVirtualProp(i.default.TYPE_ACTOR,A),this.level=r}setConfig(){}getLevel(){return this.level}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BlackTower=t.blackTowerConf=void 0;const r=s(n(4)),a=n(338),o=n(31),i=n(164),l=n(13),c=n(28);t.blackTowerConf={nLevel:0,nLevels:5,cols:100,rows:50,tileSize:7,genParams:[3,3,3,3]};t.BlackTower=class{constructor(e,t,n={}){this.nLevels=n.nLevels||5,this.cols=e||100,this.rows=t||50,this.tileSize=n.tileSize||9,this.tilesX=Math.round(this.cols/9),this.tilesY=Math.round(this.rows/9),this.conf=n}getLevels(){const e=new o.CastleGenerator,t={wallType:"wallice",genParams:this.conf.genParams||[2,2,2,2],nGates:2,roomCount:-1,tilesX:this.tilesX,tilesY:this.tilesY},n=[e.createLevel(this.cols,this.rows,t)];delete t.nGates;for(let s=0;s<this.nLevels-2;s++)n.push(e.createLevel(this.cols,this.rows,t));const[s,r]=[Math.round(this.tilesX/2),Math.round(this.tilesY/2)];t.callbacks={};t.callbacks.afterInit=e=>{a.Vault.templates.all.forEach(t=>{e.addTemplate(t)}),a.Vault.func.createHugeVault(s-1,r-2,e,"vault_center1","entrance_n")};const i=e.createLevel(this.cols,this.rows,t);return n.push(i),this.generateYard(n),this.addProps(n),n.forEach((t,n)=>{e.removeMarkers(t,{markersPreserved:!1,shouldRemoveMarkers:!0});const s={maxDanger:this.getDanger(n)+5,actorFunc:e=>"WinterBeingBase"===e.base};e.populateStoreRooms(t,s)}),n.map((e,t)=>({nLevel:t,level:e}))}getDanger(e){return 7+3*e}addProps(e){const t=new i.FactoryZone;e.forEach((e,n)=>{const s=this.getDanger(n),a={nLevel:n,minValue:50+10*n,maxValue:65+20*(n+1),sqrPerItem:200,sqrPerActor:40-2*n,maxDanger:s,actor:e=>"WinterBeingBase"===e.base};t.addItemsAndActors(e,a);e.getActors().forEach(e=>{const t=e.get("Experience");if(t){const n=t.getDanger(),a=s-n,o=t.getExpLevel(),i=o+a;i>o&&r.default.levelUpActor(e,i)}})})}generateYard(e){const t=e[0],[n,s]=t.getColsRows(),r=Math.round(1.4*s),a=Math.round(1.4*n),o=(new c.FactoryLevel).createLevel("arctic",a,r),i=Math.round((a-n)/2),u=Math.round((r-s)/2);l.Geometry.mergeLevels(o,t,i,u),o.getExtras().connectEdges=!0,e[0]=o}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DwarvenCity=t.dwarvenCityConf=void 0;const r=s(n(4)),a=n(28),o=n(158),i=n(48),l=n(24),c=n(16),u=n(31),h=n(13),d=n(18),p=n(12),f=n(773),m=n(31),g=n(30),y=n(82),v={outerColsRatio:.45,outerRowsRatio:.4,outerStartXRatio:.3,cols:300,rows:250};t.dwarvenCityConf=v;t.DwarvenCity=class{constructor(e,t,n=v){const s={meanWy:Math.floor(.85*t/2),stdDev:10,filterW:7,wallType:"wallcave"},o=new a.FactoryLevel,i=o.createLevel("wall",e,t,s),l=n.outerColsRatio||.35,c=n.outerRowsRatio||.35;let d=Math.round(l*e),f=Math.round(c*t);d=this.adjustToTileSize(d),f=this.adjustToTileSize(f);const b=this.createEntryFortLevel(d,f),_=d+14,E=f+14,S=this.createMainFortLevel(_,E),w=E+f,C=Math.ceil((e-S.getMap().cols)/2),O=e-C,T={centerY:!1,centerX:!0,y:10,x:0},M=[S,b,o.createLevel("empty",14,50)];h.Geometry.tileLevels(i,M,T);const A=g.BBox.fromBBox({ulx:C,uly:10,lrx:O,lry:w});this.addItemsAndActors(i,A),this.addStairsToLevel(e,t,i);const N=i.getExtras().term;i.addExtras("houses",function(e){const t=[],n={door:"+",floor:":",wall:"#"};return e.forEach(e=>{e.hasDoor()||r.default.err("DwarvenCity","roomsToHouses","No Door in room: "+JSON.stringify(e));const s=e.toMap(n),a=new m.House(s);a.adjustCoord(e.getLeft(),e.getTop()),t.push(a)}),t}(N));const x=new u.CityGenerator,P={nShops:4,parser:p.ObjectShell.getParser()};x.populateCityLevel(i,P);const I=new y.SpawnerActor("winter spawner"),D=I.getBrain();D.setConstraint([{op:"eq",value:"WinterBeingBase",prop:"base"},{op:"gte",value:5,prop:"danger"}]),D.setPlaceConstraint([{op:"eq",value:0,func:"getY"}]),D.spawnProb=.1,D.spawnLeft=-1,i.addVirtualProp(r.default.TYPE_ACTOR,I);const k=new u.CastleGenerator;k.populateStoreRooms(i,{actorFunc:e=>"construct"===e.type,maxDanger:15,maxValue:500,maxRarity:5}),k.removeMarkers(i,{markersPreserved:!1,shouldRemoveMarkers:!0}),this.level=i}adjustToTileSize(e){for(;e%7!=0;)++e;return e%14==0&&(e+=7),e}createMainFortLevel(e,t){const n={startRoomFunc:o.Castle.startFuncFourGates},s=(new u.MapGenerator).createCastleWall(e,t,n),r=e-42,a=t-28,i=new u.CastleGenerator,c=i.createLevel(r,a,{roomCount:-1,nGates:4,models:"residential",preserveMarkers:!0}),p=new l.Level(s.map);h.Geometry.mergeLevels(p,c,21,14);const m=[i.createLevel(49,35,{startRoomFunc:o.Castle.startRoomFuncEast,roomCount:-1,genParams:[1,1,1,1]}),p,i.createLevel(49,35,{startRoomFunc:o.Castle.startRoomFuncWest,roomCount:-1,genParams:[1,1,1,1]})],g={centerY:!0,baseElem:d.ELEM.WALL};return f.LevelUtils.wrapAsLevel(m,g)}createEntryFortLevel(e,t){const n=new u.MapGenerator,s={startRoomFunc:o.Castle.startFuncFourGates},r=n.createCastleWall(e,t,s),a=e-42,i=t-42,c=new u.CastleGenerator,p=c.createLevel(a,i,{nGates:4,roomCount:-1,preserveMarkers:!0}),m=new l.Level(r.map);h.Geometry.mergeLevels(m,p,21,21);const g=[c.createLevel(21,21,{startRoomFunc:o.Castle.startRoomFuncEast}),m,c.createLevel(21,21,{startRoomFunc:o.Castle.startRoomFuncWest})],y={centerY:!0,baseElem:d.ELEM.WALL};return f.LevelUtils.wrapAsLevel(g,y)}addItemsAndActors(e,t){const n=p.ObjectShell.getParser(),s=e.getMap().getFreeInBbox(t),r={fighter:200,axeman:100,elite:50,rifleman:50,commander:20},a=[];Object.keys(r).forEach(e=>{const t="dwarven "+e,s=r[e];for(let e=0;e<s;e++){const e=n.createActor(t);a.push(e)}}),i.Placer.addPropsToCells(e,s,a)}getLevel(){return this.level}addStairsToLevel(e,t,n){const s=Math.floor(e/2),r=new c.ElementStairs("stairsUp",n);n.addStairs(r,s,0);const a=new c.ElementStairs("stairsUp",n);n.addStairs(a,s,t-1)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Quest=t.Task=void 0;const r=s(n(4));class a{constructor(e){this.stepType="Task",this.name="",this.taskType=e}isTask(){return!0}isQuest(){return!1}getName(){return this.name}getTaskType(){return this.taskType}}t.Task=a;t.Quest=class{constructor(e,t){e&&"string"!=typeof e&&r.default.err("Quest","new","Quest must have a name!"),this.name=e,this.steps=[],this.stepType="Quest",this.motive="",this.terms=[],Array.isArray(t)&&t.forEach(e=>{if(e.isQuest)this.addStep(e);else if(e.isTask)this.addStep(e);else{const t=new a(e);this.addStep(t)}})}setName(e){this.name=e}getName(){return this.name}setMotive(e){this.motive=e}getMotive(){return this.motive}isTask(){return!1}isQuest(){return!0}addTerm(e){this.terms.push(e)}getTasks(){return this.steps.filter(e=>e.isTask())}addStep(e){Array.isArray(e)?this.steps=this.steps.concat(e):this.steps.push(e)}numQuests(){let e=1;return this.steps.forEach(t=>{t.isQuest&&t.isQuest()&&(e+=1)}),e}numTasks(){const e=this.numQuests()-1;return this.steps.length-e}getSteps(){return this.steps.slice()}numSteps(){return this.steps.length}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.QuestData=void 0;const r=s(n(4)),a=n(188);class o{constructor(){this._stacks={},this.path=[],this._ptr={}}addTarget(e,t){if(!r.default.isEntity(t)&&!t.createTarget){const e=JSON.stringify(t);r.default.err("QuestData","addTarget","Only entities can be added. Got: "+e)}if(o.mapStepToType[e])this._stacks[e]||(this._stacks[e]=[]),this._stacks[e].push(t),this.path.push({type:e,target:t});else{const t=JSON.stringify(o.mapStepToType);r.default.err("QuestData","add",`Step type ${e} not supported. See:\n${t}`)}}replaceTarget(e,t,n){const s=this._stacks[e];let a=s.indexOf(t);if(a>=0){if(s.splice(a,1,n),a=this.path.findIndex(e=>e.target===t),a>=0){const e={target:n,type:this.path[a].type};this.path.splice(a,1,e)}else r.default.err("QuestData","replaceTarget","Could not replace target on path");return!0}return!1}numSteps(){return this.path.length}keys(){return Object.keys(this._stacks)}getPathTypes(){return this.path.map(e=>e.type)}getPathTargets(){return this.path.map(e=>e.target)}pop(e){if(this._stacks[e]){const t=this._stacks[e].pop();if(t)return t}return null}resetIter(){this.keys().forEach(e=>{this._ptr[e]=0})}next(e){if(this._stacks[e]){this._ptr.hasOwnProperty(e)||(this._ptr[e]=0);const t=this._ptr[e];if(t<this._stacks[e].length)return++this._ptr[e],this._stacks[e][t]}return null}getCurrent(e){if(this._stacks[e]){const t=this._stacks[e];return t[t.length-1]}return null}getCurrentLocation(){const e=this.getCurrent("location");if(e)return e;r.default.err("QuestGen","getCurrentLocation","No location found")}getDescr(){let e="";return this.path.forEach(t=>{const n=t.type,s=t.target,o=r.default.getName(s);e+=a.getQuestVerb(n)+" "+o+". "}),e}toJSON(){const e=[];return this.path.forEach(t=>{const n=o.mapStepToType[t.type];if(n)if(t.target.getID){const s={type:t.type,target:r.default.getObjRef(n,t.target)};e.push(s)}else{const n={type:t.type,target:t.target};e.push(n)}else console.error("Used step is",t),r.default.err("QuestData","toJSON","No refType for step type "+t.type)}),e.$objRefArray=!0,{createFunc:"createQuestData",value:{path:e}}}}t.QuestData=o,o.mapStepToType={capture:"entity",escort:"entity",exchange:"item",experiment:"item",explore:"element",damage:"entity",defend:"entity",get:"item",give:"entity",kill:"entity",listen:"entity",location:"place",finishbattle:"place",read:"item",repair:"element",report:"entity",reportListen:"entity",rescue:"entity",spy:"entity",steal:"item",take:"item",subquest:"entity",use:"item",winbattle:"place"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QuestGen=void 0;const s=n(15)("bitn:quest-gen"),r=n(9),a=n(775),o=n(367),i=n(776).QuestGrammar.grammar,l=r.Random.getRNG();function c(e,t){return t[e]}class u{constructor(e){this._init(),this.rng=e||l}static parse(e){const t=a.parse(e),n={};return t.productions.forEach(e=>{n[e.lhs.text]=e.rhs.map(c.bind(null,"terms"))}),n}_init(){this.stack=[],this.currQuest=null,this.ruleHist={},this.startRule="QUEST"}genQuestWithMotive(e={}){const{motive:t}=e,n=e.rules||u.rules,[s]=this.chooseRandomRule(n[t]),r=s.text;console.log("questType is",r);const a=Object.assign({},e);a.rules=n,a.startRule=r;const o=this.genQuestWithConf({startRule:r,rules:n});return o.setName(r),o.setMotive(t),o}genQuestWithConf(e={}){e.debug&&(s.enabled=!0);const t=e.rules||u.rules,n=e.startRule||"QUEST";let r=!1,a=e.maxTries||20,o=[];for(;!r;)if(this._init(),this.startRule=n,s("=== Generating new quest now ==="),o=this.generateQuest(t,n).split("|"),r=this._questMeetsReqs(o,e),r||s("QUEST DISCARDED"),0==--a){console.warn("Could not find a matching quest.");break}return this.currQuest}genQuestWithName(e){const t=new o.Quest(e),n=new o.Task("<goto>already_there");t.addStep(n);const s=new o.Task("<kill>kill");return t.addStep(s),t}_questMeetsReqs(e,t){let n=!0;const r=t.minLength||1,a=t.maxLength||-1;return(e.length<=a||-1===a)&&e.length>=r?(n=!0,s("MATCHING QUEST FOUND")):n=!1,t.minQuests&&(n=n&&this.currQuest.numQuests()>=t.minQuests),t.maxQuests&&(n=n&&this.currQuest.numQuests()<=t.maxQuests),n}generateQuest(e,t){if(this.ruleHist[t]?this.ruleHist[t]+=1:this.ruleHist[t]=1,s(`generateQuest with rule |${t}|`),t===this.startRule||"QUEST"===t){s("New (sub)-quest will be generated");const e="";this.currQuest=new o.Quest(e),this.stack.push(this.currQuest)}s(`Choosing randRule ${t} from ${JSON.stringify(e[t])}`);const n=this.chooseRandomRule(e[t]);if(Array.isArray(n)){const s=n.map(this.generateTerm.bind(this,e));return this._checkIfQuestOver(t),s.join("|")}return s(`generateQuest end reached, return |${n}|`),this._checkIfQuestOver(t),n}generateTerm(e,t){if(!t.text){const t=JSON.stringify(e);throw new Error(`Null/undef term.text with rules| ${t}|`)}return"terminal"===t.type?this.currQuest.addTerm(t.text):this.currQuest.addTerm("<<"+t.text+">>"),"terminal"===t.type?(this.currQuest.addStep(new o.Task(t.text)),t.text):(s(`genTerm: term.type ${t.type} text: ${t.text}`),s(`calling generate() with term.text |${t.text}|`),this.generateQuest(e,t.text))}_checkIfQuestOver(e){if(e===this.startRule||"QUEST"===e){s("Finishing current quest");if(this.stack.length>1){const e=this.stack.pop();this.currQuest=this.stack[this.stack.length-1],this.currQuest.addStep(e)}}}chooseRandomRule(e){if(Array.isArray(e)){const t=this.rng.arrayGetRand(e);return s("chose next rule at RANDOM:",t),t}return s("chooseRandomRule() not an ARRAY: |"+e),null}}t.QuestGen=u,u.rules=u.parse(i),u.defaultConfig={rules:u.rules,startRule:"QUEST",maxTries:20,debug:!1,minQuests:1,maxQuests:-1,minLength:1,maxLength:-1}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ConfStack=void 0;const r=s(n(4)),a=n(15)("bitn:ConfStack");t.ConfStack=class{constructor(){this.globalConf={levelSize:"Medium",dungeonX:80,dungeonY:40,sqrPerActor:200,sqrPerItem:200,set:!1},this.scope=[],this.confStack=[]}setGlobalConf(e){this.globalConf=e}getGlobalConf(){return this.globalConf}getScope(){return this.scope}pushScope(e){this.scope.push(e.name),this.confStack.push(e),this.dbg("Pushed scope: "+e.name)}popScope(e){const t=e.name,n=this.scope.pop();if(n!==t)r.default.err("Factory.ConfStack","popScope",`Popped: ${n}, Expected: ${t}`);else{const e=this.confStack.pop();this.dbg("Popped scope: "+e.name)}}getConf(e){for(let t=this.confStack.length-1;t>=0;t--)if(this.dbg(`[${t}] looking for |${e}|`),this.confStack[t].hasOwnProperty(e))return this.dbg(`  >> [${t}] Found key |${e}|`),this.confStack[t][e];return this.globalConf.hasOwnProperty(e)?this.globalConf[e]:null}dbg(e){a.enabled&&r.default.diag(e)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.TerritoryMap=void 0;const r=s(n(4)),a=n(244),o=n(166),i=n(9),l=n(126);i.Random.getRNG();t.TerritoryMap=function(){},t.TerritoryMap.create=function(e,t,n){const[s,i]=n,c=e.getFeaturesByType(o.OW.WCAPITAL)[0],u=e.getFeaturesByType(o.OW.WTOWER)[0],h=e.getFeaturesByType(o.OW.BTOWER)[0],d=e.getFeaturesByType(o.OW.BCAPITAL)[0],p=e.getOWMap(),f=new a.Territory(e.getSizeX(),e.getSizeY(),{startSize:2,maxNumPos:2});f.useMap(p,{[o.OW.TERM]:!0,[o.OW.MOUNTAIN]:!0,[o.OW.BVILLAGE]:!0,[o.OW.WVILLAGE]:!0,[o.OW.WCAPITAL]:!0,[o.OW.BCAPITAL]:!0,[o.OW.WTOWER]:!0,[o.OW.BTOWER]:!0});f.addRival({name:"avianfolk",char:"A"}),f.addRival({name:"wildling",char:"I"}),f.addRival({name:"bearfolk",char:"B"}),f.addRival({name:"wolfclan",char:"w"}),f.addRival({name:"catfolk",char:"f"}),f.addRival({name:"dogfolk",char:"d"}),f.addRival({name:"human",char:"@"});const m={name:"undead",char:"z",numPos:3,startX:[e.getCenterX()],startY:[e.getSizeY()-5]};f.addRival(m),f.addRival({name:"goblin",char:"g",numPos:8}),f.addRival({name:"dwarf",char:"h",startX:u[0],startY:u[1]}),f.addRival({name:"hyrkhian",char:"y",startX:c[0],startY:c[1]});const g={name:"winterbeing",char:"W",startX:[h[0],d[0]],startY:[h[1],d[1]]};f.addRival(g);const y=new l.OverWorld.CoordMap;y.xMap=10,y.yMap=10;const v=f.getRivalData(t);return v?(v.numPos+=1,v.startX.push(s),v.startY.push(i),f.addTag([s,i],"player"),f.generate(),f):(r.default.err("TerritoryMap","create","Unable to find rivalData for player race "+t),f)}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LevelGen=void 0;const r=s(n(4)),a=n(97),o=n(165),i=n(9).Random.getRNG();t.LevelGen=class{static getDungeonConf(e){let t=h(e);const n=l(t),s=u(t),[a,o]=c(e);t=t.toLowerCase();const i={name:e,maxDanger:r.default.MAX_DANGER,maxRarity:1,dungeonX:a,dungeonY:o,dungeonType:t,nBranches:1,branch:[{name:e,nLevels:n,entranceLevel:0,maxDanger:r.default.MAX_DANGER}]};return s&&(i.constraint=s),i}static getMountainConf(e){const[t,n]=d(e);return{name:e,nFaces:1,maxDanger:r.default.MAX_DANGER,maxRarity:1,face:[{name:e,nLevels:1,entranceLevel:0,x:t,y:n,maxDanger:r.default.MAX_DANGER}],nSummits:1,summit:[{name:"Summit",nLevels:1,cols:80,rows:50,maxDanger:r.default.MAX_DANGER}],connectLevels:[[e,"Summit",0,0]]}}static getCityConf(e,t){let n=a.Names.getGenericPlaceName("city");"fort"===t.type?n="Fort":t.capital?n="Capital":"stronghold"===t.type?n="Stronghold":"village"===t.type&&(n=a.Names.getVillageType());const s=p(n),i=m(s,t),l=o.WorldConf.createQuarterConnections(i),c={name:e,nQuarters:s,quarter:i,maxDanger:r.default.MAX_DANGER,maxRarity:1};return l&&(c.connectLevels=l),c}};const l=function(e){switch(e){case"Cave":return 1;case"Crypt":return 2;case"Dungeon":return 3;case"Labyrinth":return 1;default:return 3}},c=function(e){const t=[80,40];switch(e){case"Cave":return[80,50];case"Cavern":return[200,200];case"Grotto":return[120,60];case"Lair":return[200,150];case"Cells":case"Dungeon":return[100,50];case"Labyrinth":return[100,100];case"Maze":return[80,50];case"Crypt":return t;case"Tombs":return[100,100];case"Catacombs":return[140,60];default:return t}},u=function(e){switch(e){case"Cave":return{actor:[{op:"eq",prop:"type",value:["animal","goblin","beast"]}]};case"Crypt":return{actor:[{op:"eq",prop:"type",value:"undead"}]};default:return null}},h=function(e){switch(e){case"Grotto":case"Cavern":case"Lair":return"Cave";case"Catacombs":case"Tombs":return"Crypt";case"Cells":return"Dungeon";default:return e}},d=function(e){return[80,240]},p=e=>{switch(e){case"Hamlet":case"Village":return 1;case"Town":return 2;case"Fort":return 1;case"Stronghold":return i.getUniformInt(2,4);case"Capital":return i.getUniformInt(3,5);default:return 1}},f=(e,t)=>{const n=t.maxValue||100,s=t.shopType||"random",a=t.name;if("Market"===a||"Bazaar"===a){const t=i.getUniformInt(1,3);e.nShops=t,e.constraint.shop=[];for(let a=0;a<t;a++){let t=i.arrayGetRand(r.default.SHOP_TYPES);"random"!==s&&0===a&&(t=s);const o=[{op:"eq",prop:"type",value:t},{op:"lte",prop:"value",value:n}];e.constraint.shop.push(o)}}else e.nShops=1},m=(e,t)=>{const n=[];for(let s=0;s<e;s++){const e={name:a.Names.getGenericPlaceName("quarter"),nLevels:1,constraint:{},maxDanger:r.default.MAX_DANGER};0===s&&(e.entranceLevel=0),f(e,t),n.push(e)}return n}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MessageHandler=void 0;const r=s(n(4));class a{constructor(e){this._lastMsg=null,this._messages=[],this._prevMessages=[],this._hasNew=!1,this.hasNotify=!0,this._fullHistory=[],e.listenEvent(r.default.EVT_MSG,this)}static fromJSON(e,t){const n=new a(t);return n._hasNew=e._hasNew,n._messages=e._messages,n._prevMessages=e._prevMessages,n._lastMsg=e._lastMsg,n}notify(e,t){if(e===r.default.EVT_MSG&&t.hasOwnProperty("msg")){const e={msg:t.msg,style:"prim",count:1};t.hasOwnProperty("cell")&&(e.cell=t.cell),t.hasOwnProperty("style")&&(e.style=t.style),this._lastMsg&&this._lastMsg.msg===e.msg?this._lastMsg.count?this._lastMsg.count+=1:this._lastMsg.count=1:(this._lastMsg=e,this._messages.push(e)),this._hasNew=!0}}hasNew(){return this._hasNew}getHistory(){return this._fullHistory.slice()}getMessages(){return this._hasNew=!1,this._messages.length>0?this._messages:this._prevMessages.length>0?this._prevMessages:[]}clear(){this._messages.length>0&&(this._prevMessages=this._messages.slice()),this._messages=[]}toJSON(){return{_lastMsg:this._lastMsg,_messages:o(this._messages),_fullHistory:o(this._fullHistory),_prevMessages:o(this._prevMessages),_hasNew:this._hasNew}}}function o(e){const t=[];return e.forEach(e=>{e.cell?"string"==typeof e.msg&&t.push({msg:e.msg}):t.push(e)}),t}t.MessageHandler=a},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Chunk=t.ChunkManager=void 0;const r=s(n(4)),a=n(103),o=n(160),i=n(24),l=n(375),c=n(15)("bitn:ChunkManager");class u{constructor(e,t){const[n,s]=[t.getSizeX(),t.getSizeY()];this.sizeX=n,this.sizeY=s,this.area=t,this.game=e,this.state=[],this.store=new l.InMemoryStore(this.game.gameID),this.recordedTileMoves=[];for(let e=0;e<n;e++){this.state[e]=[];for(let n=0;n<s;n++)if(t.isLoaded(e,n)){c(`new() area ${e},${n} is loaded`);const t={loadState:o.LoadStat.LOADED};this.state[e].push(t)}else if(t.isOnDisk(e,n)){const t={loadState:o.LoadStat.ON_DISK};this.state[e].push(t)}else{const t={loadState:o.LoadStat.JSON};this.state[e].push(t)}}this.loadDistX=1,this.loadDistY=1,this.jsonDistX=2,this.jsonDistY=2,this.onDiskDistX=3,this.onDiskDistY=3}setPlayerTile(e,t,n,s){const r=this.getMoveDir(e,t,n,s);c.enabled&&(c(`## setPlayerTile START ${n},${s}->${e},${t}`),this.debugPrint()),this.recordedTileMoves.push([[e,t],[n,s]]);const a=[];for(let n=0;n<this.sizeX;n++)for(let s=0;s<this.sizeY;s++)this.inLoadRange(e,t,n,s)?this.isLoaded(n,s)||a.push([n,s]):this.isLoaded(n,s)?this.inJSONRange(e,t,n,s)?this.unloadTile(e,t,n,s,r):this.writeTileToDisk(e,t,n,s,r):this.isJSON(n,s)?this.inJSONRange(e,t,n,s)||this.writeTileToDisk(e,t,n,s,r):this.isOnDisk(n,s)?(c("Checking json range for ",e,t,"to",n,s),this.inJSONRange(e,t,n,s)&&(c("Reading tile from disk now",n,s),this.readTileFromDisk(e,t,n,s,r))):this.writeTileToDisk(e,t,n,s,r);a.length>0&&this.loadTiles(e,t,a,r),c.enabled&&(c(`## setPlayerTile END ${n},${s}->${e},${t}`),this.debugPrint())}isLoaded(e,t){return this.state[e][t].loadState===o.LoadStat.LOADED}isJSON(e,t){return this.state[e][t].loadState===o.LoadStat.JSON}isOnDisk(e,t){return this.state[e][t].loadState===o.LoadStat.ON_DISK}inLoadRange(e,t,n,s){for(let r=e-this.loadDistX;r<=e+this.loadDistX;r++)for(let e=t-this.loadDistY;e<=t+this.loadDistY;e++)if(n===r&&s===e)return!0;return!1}inJSONRange(e,t,n,s){const r=Math.abs(n-e),a=Math.abs(s-t);return(r>this.loadDistX||a>this.loadDistY)&&(r<=this.jsonDistX&&a<=this.jsonDistY)}loadAllTiles(){this.setLoadStateAll(o.LoadStat.LOADED)}getNumInState(e){let t=0;for(let n=0;n<this.sizeX;n++)for(let s=0;s<this.sizeY;s++)this.state[n][s].loadState===e&&++t;return t}loadTiles(e,t,n,s){const a=this.area.getTiles();c("loadTiles: "+JSON.stringify(n)),n.forEach(n=>{this.isOnDisk(n[0],n[1])&&this.readTileFromDisk(e,t,n[0],n[1],s)});const i=n.map(e=>{const[t,n]=e;if(this.area.isJSON(t,n))return a[e[0]][e[1]];r.default.err("ChunkManager","loadTiles",`Cannot load non-JSON tile at ${t},${n}`)});this.createTiles(i),n.forEach(n=>{c("ChunkManager load now tile "+n);const[r,i]=n;if(this.state[r][i].loadState=o.LoadStat.LOADED,this.area.setLoaded(r,i),""===s&&(c(`Rm adjacent conns to ${r},${i}`),this.removeAdjacentConnections(a,e,t,r,i)),0===n[0]&&2===n[1]){this.area.getTiles()}})}removeAdjacentConnections(e,t,n,s,r){this.inLoadRange(t,n,s,r-1)||r-1>=0&&(c(`Rm NORTH conns from ${s},${r}`),this.removeConnections("NORTH",e[s][r])),this.inLoadRange(t,n,s,r+1)||r+1<this.area.getSizeY()&&(c(`Rm SOUTH conns from ${s},${r}`),this.removeConnections("SOUTH",e[s][r])),this.inLoadRange(t,n,s+1,r)||s+1<this.area.getSizeX()&&(c(`Rm EAST conns from ${s},${r}`),this.removeConnections("EAST",e[s][r])),this.inLoadRange(t,n,s-1,r)||s-1>=0&&(c(`Rm WEST conns from ${s},${r}`),this.removeConnections("WEST",e[s][r]))}unloadTile(e,t,n,s,r){c(`Unloading tile ${n},${s}`);const a=this.area.getTiles();this.state[n][s].loadState=o.LoadStat.LOADED2JSON,this.area.setUnloaded2JSON(n,s);const i=a[n][s],l=i.getLevels();this.game.removeLevels(l);const u=i.getLevel();c(`\tUnloading battles @ ${n},${s}, id: ${u.getID()}`);if(this.game.getGameMaster().unloadBattles(u),c.enabled){const e=i.getLevels().map(e=>e.getID());c("\t-- Unloading levels "+e)}if(i.removeListeners(),a[n][s]=i.toJSON(),"WEST"===r){const e=n-1;c(`Removing connections from tile ${n-1},${s}`),e<this.area.getSizeX()&&this.removeConnections("EAST",a[n-1][s])}else if("EAST"===r){const e=n+1;c(`Removing connections from tile ${n+1},${s}`),e<this.area.getSizeX()&&this.removeConnections("WEST",a[n+1][s])}else if("NORTH"===r){const e=s-1;c(`Removing connections from tile ${n},${s-1}`),e>=0&&this.removeConnections("SOUTH",a[n][s-1])}else if("SOUTH"===r){const e=s+1;c(`Removing connections from tile ${n},${s+1}`),e<this.area.getSizeY()&&this.removeConnections("NORTH",a[n][s+1])}else this.inLoadRange(e,t,n,s-1)&&s-1>=0&&this.isLoaded(n,s-1)&&(c(`Rm SOUTH conns from ${n},${s-1}`),this.removeConnections("SOUTH",a[n][s-1])),this.inLoadRange(e,t,n,s+1)&&s+1<this.area.getSizeY()&&this.isLoaded(n,s+1)&&(c(`Rm NORTH conns from ${n},${s+1}`),this.removeConnections("NORTH",a[n][s+1])),this.inLoadRange(e,t,n+1,s)&&n+1<this.area.getSizeX()&&this.isLoaded(n+1,s)&&(c(`Rm WEST conns from ${n+1},${s}`),this.removeConnections("WEST",a[n+1][s])),this.inLoadRange(e,t,n-1,s)&&n-1>=0&&this.isLoaded(n-1,s)&&(c(`Rm EAST conns from ${n-1},${s}`),this.removeConnections("EAST",a[n-1][s]));this.state[n][s].loadState=o.LoadStat.JSON}writeTileToDisk(e,t,n,s,a){this.isLoaded(n,s)&&this.unloadTile(e,t,n,s,a),this.state[n][s].loadState=o.LoadStat.JSON2ON_DISK;const i=this.getTileId(n,s),l=this.area.getTileXY(n,s);l||r.default.err("ChunkManager","writeTileToDisk",`Expected JSON, got undefined ${n},${s}`),this.store.setItem(i,l),this.area.setOnDisk(n,s,{onDisk:!0,tileId:i,level:l.level}),this.state[n][s].loadState=o.LoadStat.ON_DISK}readTileFromDisk(e,t,n,s,a){if(this.isOnDisk(n,s)){c(`Reading ${n},${s} from disk now`),this.state[n][s].loadState=o.LoadStat.ON_DISK2JSON;const e=this.getTileId(n,s),t=this.store.getItem(e);this.area.setUnloaded2JSON(n,s),"string"==typeof t?this.area.setTile(n,s,JSON.parse(t)):this.area.setTile(n,s,t),this.state[n][s].loadState=o.LoadStat.JSON}else r.default.err("ChunkManager","readTileFromDisk",`Tried to read tile ${n},${s} from disk: ${this.state}`)}getTileId(e,t){return this.game.gameID+","+e+","+t}getLoadState(e,t){return this.state[e][t].loadState}toJSON(){const e={state:this.state,useInMemoryStore:this.useInMemoryStore,recordedTileMoves:this.recordedTileMoves};return e.data=this.store.data,e}setLoadStateAll(e){this.state.forEach((t,n)=>{t.forEach((t,s)=>{this.state[n][s].loadState=e})})}createTiles(e){const t=e.length;c(`Creating ${t} AreaTiles with FromJSON`);const n=new a.FromJSON;n.setChunkMode(!0),n.createTiles(this.game,e)}addConnections(e,t,n){const s=this.getOpposite(e),r=this.getReplacedConnections(e,t),o=this.getReplacedConnections(s,n),i=new a.FromJSON,l=r.concat(o),c=[t.getLevel(),n.getLevel()];i.connectTileLevels(c,l)}removeConnections(e,t){this.getReplacedConnections(e,t).forEach(e=>{const t=e.getTargetStairs(),n=e.getTargetLevel();if(n instanceof i.Level){const s={targetLevel:n.getID(),targetStairs:{x:t.getX(),y:t.getY()}};e.setConnObj(s)}})}getReplacedConnections(e,t){const n=t.getLevel().getConnections();0===n.length&&r.default.err("ChunkManager","getReplacedConnections","No connections found.");let s=[];return"SOUTH"===e?s=n.filter(e=>e.getY()===t.rows-1):"NORTH"===e?s=n.filter(e=>0===e.getY()):"EAST"===e?s=n.filter(e=>e.getX()===t.cols-1):"WEST"===e&&(s=n.filter(e=>0===e.getX())),s}getOpposite(e){switch(e){case"NORTH":return"SOUTH";case"SOUTH":return"NORTH";case"EAST":return"WEST";case"WEST":return"EAST";default:r.default.err("ChunkManager","getOpposite",`Illegal dir ${e} given.`)}return""}getMoveDir(e,t,n,s){let[a,o]=[0,0],i="";if(!r.default.isNullOrUndef([n,s])){if(a=e-n,o=t-s,0!==a&&0!==o){const a=`MOVE: ${n},${s} -> ${e},${t}`;r.default.err("ChunkManager","getMoveDir","Diagonal move not supported: "+a)}a>0?i="EAST":a<0&&(i="WEST"),o>0?i="SOUTH":o<0&&(i="NORTH")}return i}debugPrint(){let e="";for(let t=0;t<this.sizeY;t++){for(let n=0;n<this.sizeX;n++)e+=" "+this.stateToChar(this.state[n][t]);e+=` - ${t} \n`}e+="\n\tNum loaded: "+this.getNumInState(o.LoadStat.LOADED),e+="\n\tNum serialized: "+this.getNumInState(o.LoadStat.JSON),e+="\n\tNum on disk: "+this.getNumInState(o.LoadStat.ON_DISK),e+="\n";for(let t=0;t<this.area.getSizeY();t++){for(let n=0;n<this.area.getSizeX();n++){e+=`${n},${t}: `+(this.area.zonesCreated[n+","+t]?" X ":" - ")+"|"}e+="\n"}r.default.diag(e)}stateToChar(e){switch(e.loadState){case o.LoadStat.LOADED:return"L";case o.LoadStat.JSON:return"J";case o.LoadStat.ON_DISK:return"D";case o.LoadStat.EMPTY:return"E";case o.LoadStat.LOADED2JSON:return"*";case o.LoadStat.JSON2ON_DISK:return"V";case o.LoadStat.ON_DISK2JSON:return"^";default:return""}}_checkDist(e,t,n,s,r,a){for(let o=e-r;o<=e+r;o++)for(let e=t-a;e<=t+a;e++)if(n===o&&s===e)return!0;return!1}}t.ChunkManager=u,t.Chunk={},t.Chunk.printTileConnections=function(e,t,n=-1){if(r.default.diag(e),"function"==typeof t.getLevel){if(t.getLevel().getID()===n||-1===n){t.getLevel().getConnections().forEach(e=>{const t=e.getTargetLevel();Number.isInteger(t)?console.log(`\tTarget ID ${t} found`):console.log(`\tLevel ${t.getID()} found`)})}}else console.log("Skipping printTileConnections due to json input")},t.Chunk.ChunkManager=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Persist=t.InMemoryStore=void 0;const s=n(790),r=n(791);function a(e){this.store=s,this.fromStorage=t=>this.store.getItem(e,t),this.fromStorageWithKey=(e,t)=>this.store.getItem(e,t),this.toStorage=(t,n)=>{this.store.setItem(e,t,n)},this.toStorageWithKey=(e,t,n)=>{this.store.setItem(e,t,n)},this.deleteStorage=t=>{this.store.removeItem(e).then(t)},this.deleteStorageWithKey=(e,t)=>{this.store.removeItem(e).then(t)}}t.InMemoryStore=class{constructor(e,t=!0){this.name=e,this.data={},this.compress=t}getItem(e){this.data.hasOwnProperty(e)||console.warn(`No key |${e}| in InMemoryStore`);const t=this.data[e];if(this.compress){return r.decompress(t)}return t}setItem(e,t){let n;if(n="string"!=typeof t?JSON.stringify(t):t,this.compress){const t=r.compress(n);this.data[e]=t}else this.data[e]=n}removeItem(e){delete this.data[e]}},t.Persist=a,a.fromStorage=function(e,t){return s.getItem(e,t)},a.toStorage=function(e,t,n){s.setItem(e,t,n)},a.deleteStorage=function(e,t){s.removeItem(e).then(t)}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemManager=void 0;const r=s(n(4)),a=n(377);class o{constructor(e,t){this._engine=e,this.systemOrder=o.systemOrder;const n={};Object.keys(o.systems).forEach(e=>{const s=o.systems[e];if(s.create){const r=s;n[e]=r.create(r.comps,t)}else Array.isArray(s)&&(a.System[e]?n[e]=new a.System[e](s,t):r.default.err("SystemManager","new",`System[${e}] not found for new`))}),this.systems=n,this.loopSystemOrder=["Hunger"],this.loopSystems={},this.loopSystems.Hunger=new a.System.Hunger(["Action","Hunger"],t),this.timeSystems={};const s=new a.System.TimeEffects(["Expiration","Poison","Fading","Heat","Coldness","DirectDamage","RegenEffect","Drowning"],t);this.timeSystems.TimeEffects=s,this._engine.addTimeSystem("TimeEffects",s)}static addSystemBefore(e,t){const n=o.systemOrder.indexOf(t);n>=0&&o.insertSystemAt(n,e)}static addSystemAfter(e,t){const n=o.systemOrder.indexOf(t);n>=0&&o.insertSystemAt(n+1,e)}static removeSystem(e){delete o.systems[e];const t=o.systemOrder.indexOf(e);t>=0&&o.systemOrder.splice(t,1)}static insertSystemAt(e,t){o.systemOrder.splice(e,0,t.name),"function"==typeof t.create?t.name?o.systems[t.name]=t:r.default.err("SystemManager","insertSystemAt","No system.name given"):r.default.err("SystemManager","insertSystemAt","Object must specify system.create")}addDebugTraceID(e){Object.values(this.systems).forEach(t=>{t.addDebugTraceID(e)})}get(e){return this.systems.hasOwnProperty(e)?this.systems[e]:null}updateSystems(){for(let e=0;e<this.systemOrder.length;e++){const t=this.systemOrder[e];this.systems[t].update()}}updateLoopSystems(){for(let e=0;e<this.loopSystemOrder.length;e++){const t=this.loopSystemOrder[e];this.loopSystems[t].update()}}setRNG(e){Object.values(this.systems).forEach(t=>{t.setRNG(e)})}setSystemArgs(e){Object.values(this.systems).forEach(t=>{t.setArgs(e)})}}t.SystemManager=o,o.systemOrder=["AreaEffects","Disability","SpiritBind","BaseAction","Equip","Attack","AttackRanged","Chat","Shop","SpellCast","SpellEffect","Missile","Movement","Effects","Animation","DrainStats","Mining","Building","Damage","Death","Farming","Crafting","Battle","Skills","Quest","ExpPoints","Communication","Events","ZoneEvents","Weather","WorldSim","OnCbs"],o.systems={AreaEffects:["Flame"],Disability:["Stun","Entrapped","Paralysis"],SpiritBind:["SpiritBind"],BaseAction:["Pickup","UseStairs","OpenDoor","UseItem","UseElement","Jump","Read","Rest","Give","Displace"],Equip:["Equip"],Attack:["Attack"],AttackRanged:["AttackRanged"],Chat:["Chat"],Shop:["Transaction"],SpellCast:["SpellCast","PowerDrain"],SpellEffect:["SpellRay","SpellCell","SpellMissile","SpellArea","SpellSelf","SpellWave"],Missile:["Missile"],Movement:["Movement"],OnCbs:["OnAddCb","OnRemoveCb"],Effects:["Effects"],Animation:["Animation"],DrainStats:["DrainStat"],Damage:["Damage","Health"],Death:["DeathEvent"],Mining:["Mining","Explosion"],Building:["BuildEvent"],Farming:["Farming","WorldSimEvent"],Crafting:["Crafting"],Battle:["BattleOver","BattleOrder","BattleEvent"],Skills:["SkillsExp"],Quest:["GiveQuest","QuestCompleted","QuestTargetEvent"],Events:["Event"],ExpPoints:["ExpPoints","Experience"],Communication:["Communication"],ZoneEvents:["ZoneEvent"],Weather:["WeatherEffect"],WorldSim:["WorldSimEvent"]}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemMining=t.SystemOnCbs=t.SystemWeather=t.SystemWorldSim=t.SystemZoneEvents=t.SystemTimeEffects=t.SystemSpiritBind=t.SystemSpellEffect=t.SystemSpellCast=t.SystemSkills=t.SystemShop=t.SystemQuest=t.SystemMovement=t.SystemMissile=t.SystemHunger=t.SystemFarming=t.SystemExpPoints=t.SystemEvents=t.SystemEquip=t.SystemEffects=t.SystemDisability=t.SystemDrainStats=t.SystemDeath=t.SystemDamage=t.SystemCrafting=t.SystemCommunication=t.SystemChat=t.SystemBuilding=t.SystemBattle=t.SystemBaseAction=t.SystemAttackRanged=t.SystemAttack=t.SystemAreaEffects=t.SystemAnimation=t.SystemBase=t.System=void 0;const r=s(n(4));t.System={};const a=n(14);var o=n(14);Object.defineProperty(t,"SystemBase",{enumerable:!0,get:function(){return o.SystemBase}}),t.System.Base=a.SystemBase;const i=n(378);var l=n(378);Object.defineProperty(t,"SystemAnimation",{enumerable:!0,get:function(){return l.SystemAnimation}}),t.System.Animation=i.SystemAnimation;const c=n(380);var u=n(380);Object.defineProperty(t,"SystemAreaEffects",{enumerable:!0,get:function(){return u.SystemAreaEffects}}),t.System.AreaEffects=c.SystemAreaEffects;const h=n(381);var d=n(381);Object.defineProperty(t,"SystemAttack",{enumerable:!0,get:function(){return d.SystemAttack}}),t.System.Attack=h.SystemAttack;const p=n(382);var f=n(382);Object.defineProperty(t,"SystemAttackRanged",{enumerable:!0,get:function(){return f.SystemAttackRanged}}),t.System.AttackRanged=p.SystemAttackRanged;const m=n(383);var g=n(383);Object.defineProperty(t,"SystemBaseAction",{enumerable:!0,get:function(){return g.SystemBaseAction}}),t.System.BaseAction=m.SystemBaseAction;const y=n(384);var v=n(384);Object.defineProperty(t,"SystemBattle",{enumerable:!0,get:function(){return v.SystemBattle}}),t.System.Battle=y.SystemBattle;const b=n(385);var _=n(385);Object.defineProperty(t,"SystemBuilding",{enumerable:!0,get:function(){return _.SystemBuilding}}),t.System.Building=b.SystemBuilding;const E=n(386);var S=n(386);Object.defineProperty(t,"SystemChat",{enumerable:!0,get:function(){return S.SystemChat}}),t.System.Chat=E.SystemChat;const w=n(387);var C=n(387);Object.defineProperty(t,"SystemCommunication",{enumerable:!0,get:function(){return C.SystemCommunication}}),t.System.Communication=w.SystemCommunication;const O=n(388);var T=n(388);Object.defineProperty(t,"SystemCrafting",{enumerable:!0,get:function(){return T.SystemCrafting}}),t.System.Crafting=O.SystemCrafting;const M=n(389);var A=n(389);Object.defineProperty(t,"SystemDamage",{enumerable:!0,get:function(){return A.SystemDamage}}),t.System.Damage=M.SystemDamage;const N=n(390);var x=n(390);Object.defineProperty(t,"SystemDeath",{enumerable:!0,get:function(){return x.SystemDeath}}),t.System.Death=N.SystemDeath;const P=n(391);var I=n(391);Object.defineProperty(t,"SystemDrainStats",{enumerable:!0,get:function(){return I.SystemDrainStats}}),t.System.DrainStats=P.SystemDrainStats;const D=n(392);var k=n(392);Object.defineProperty(t,"SystemDisability",{enumerable:!0,get:function(){return k.SystemDisability}}),t.System.Disability=D.SystemDisability;const L=n(246);var R=n(246);Object.defineProperty(t,"SystemEffects",{enumerable:!0,get:function(){return R.SystemEffects}}),t.System.Effects=L.SystemEffects;const B=n(393);var F=n(393);Object.defineProperty(t,"SystemEquip",{enumerable:!0,get:function(){return F.SystemEquip}}),t.System.Equip=B.SystemEquip;const G=n(394);var j=n(394);Object.defineProperty(t,"SystemEvents",{enumerable:!0,get:function(){return j.SystemEvents}}),t.System.Events=G.SystemEvents;const W=n(395);var Y=n(395);Object.defineProperty(t,"SystemExpPoints",{enumerable:!0,get:function(){return Y.SystemExpPoints}}),t.System.ExpPoints=W.SystemExpPoints;const X=n(396);var U=n(396);Object.defineProperty(t,"SystemFarming",{enumerable:!0,get:function(){return U.SystemFarming}}),t.System.Farming=X.SystemFarming;const $=n(397);var H=n(397);Object.defineProperty(t,"SystemHunger",{enumerable:!0,get:function(){return H.SystemHunger}}),t.System.Hunger=$.SystemHunger;const V=n(398);var K=n(398);Object.defineProperty(t,"SystemMissile",{enumerable:!0,get:function(){return K.SystemMissile}}),t.System.Missile=V.SystemMissile;const q=n(399);var z=n(399);Object.defineProperty(t,"SystemMovement",{enumerable:!0,get:function(){return z.SystemMovement}}),t.System.Movement=q.SystemMovement;const J=n(128);var Q=n(128);Object.defineProperty(t,"SystemQuest",{enumerable:!0,get:function(){return Q.SystemQuest}}),t.System.Quest=J.SystemQuest;const Z=n(400);var ee=n(400);Object.defineProperty(t,"SystemShop",{enumerable:!0,get:function(){return ee.SystemShop}}),t.System.Shop=Z.SystemShop;const te=n(401);var ne=n(401);Object.defineProperty(t,"SystemSkills",{enumerable:!0,get:function(){return ne.SystemSkills}}),t.System.Skills=te.SystemSkills;const se=n(402);var re=n(402);Object.defineProperty(t,"SystemSpellCast",{enumerable:!0,get:function(){return re.SystemSpellCast}}),t.System.SpellCast=se.SystemSpellCast;const ae=n(403);var oe=n(403);Object.defineProperty(t,"SystemSpellEffect",{enumerable:!0,get:function(){return oe.SystemSpellEffect}}),t.System.SpellEffect=ae.SystemSpellEffect;const ie=n(404);var le=n(404);Object.defineProperty(t,"SystemSpiritBind",{enumerable:!0,get:function(){return le.SystemSpiritBind}}),t.System.SpiritBind=ie.SystemSpiritBind;const ce=n(405);var ue=n(405);Object.defineProperty(t,"SystemTimeEffects",{enumerable:!0,get:function(){return ue.SystemTimeEffects}}),t.System.TimeEffects=ce.SystemTimeEffects;const he=n(406);var de=n(406);Object.defineProperty(t,"SystemZoneEvents",{enumerable:!0,get:function(){return de.SystemZoneEvents}}),t.System.ZoneEvents=he.SystemZoneEvents;const pe=n(407);var fe=n(407);Object.defineProperty(t,"SystemWorldSim",{enumerable:!0,get:function(){return fe.SystemWorldSim}}),t.System.WorldSim=pe.SystemWorldSim;const me=n(408);var ge=n(408);Object.defineProperty(t,"SystemWeather",{enumerable:!0,get:function(){return ge.SystemWeather}}),t.System.Weather=me.SystemWeather;const ye=n(409);var ve=n(409);Object.defineProperty(t,"SystemOnCbs",{enumerable:!0,get:function(){return ve.SystemOnCbs}}),t.System.OnCbs=ye.SystemOnCbs;const be=n(410);var _e=n(410);Object.defineProperty(t,"SystemMining",{enumerable:!0,get:function(){return _e.SystemMining}}),t.System.Mining=be.SystemMining,t.System.defineSystem=function(e){const n=e.toUpperCase();r.default.SYS[n]=Symbol();const s=class extends a.SystemBase{constructor(e,t,s){super(r.default.SYS[n],e,s),this._init&&"function"==typeof this._init&&this._init(e,...t)}};return t.System[e]=s,s},t.System.undefineSystem=function(e){const n=e.toUpperCase();delete r.default.SYS[n],delete t.System[e]}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemAnimation=void 0;const r=s(n(4)),a=n(14),o=n(13),i=n(379);class l extends a.SystemBase{constructor(e,t){super(r.default.SYS.ANIMATION,e,t),this._enabled=!0,this.currAnim=null}enableAnimations(){this._enabled=!0}disableAnimations(){this._enabled=!1}missileAnimation(e,t){const n=t.missile,s=t.to[0],a=t.to[1],o=n.first();let i=o[0],l=o[1];const c=t.item,u=r.default.getChar(r.default.TYPE_ITEM,c.getName()),h=r.default.getCssClass(r.default.TYPE_ITEM,c.getName()),d=this._createAnimation(t);for(;i!==s||l!==a;){const e={},t=i+","+l;if(e[t]={},e[t].char=u,e[t].className=h,d.addFrame(e),!n.next())break;i=n.getX(),l=n.getY()}this._setCurrAnim(d)}lineAnimation(e,t){let n=t.from[0],s=t.from[1];const a=t.dir[0],o=t.dir[1];let i=t.range,l=r.default.dirToChar(t.dir);t.lineChar&&(l=t.lineChar);const c=this._createAnimation(t),u={};if(t.ray)for(;i>0;){n+=a,s+=o,u[n+","+s]={char:l||"*",className:t.className||"cell-ray"};let e={};e=Object.assign(e,u),c.addFrame(e),--i}this._setCurrAnim(c)}cellAnimation(e,t){const n=this._createAnimation(t),s={};n.slowDown=10,t.coord.forEach(e=>{s[e[0]+","+e[1]]={char:t.cellChar||"*",className:t.className||"cell-animation"}}),n.addFrame(s),this._setCurrAnim(n)}areaAnimation(e,t){const n=this._createAnimation(t),s=t.range,[r,a]=[t.cX,t.cY];for(let e=1;e<=s;e++){const s={};o.Geometry.getBoxAround(r,a,e).forEach(e=>{s[e[0]+","+e[1]]={char:t.cellChar||"*",className:t.className||"cell-animation"}}),n.addFrame(s)}this._setCurrAnim(n)}_createAnimation(e){const t=new i.Animation;return t.setLevel(e.level),t}updateEntity(e){if(this._enabled){e.getList("Animation").forEach(t=>{const n=t.getArgs();n.dir?this.lineAnimation(e,n):n.missile?this.missileAnimation(e,n):n.cell?this.cellAnimation(e,n):r.default.isNullOrUndef([n.range,n.cX,n.cY])||this.areaAnimation(e,n)})}e.removeAll("Animation"),this.hasEntities()||(this.pool.emitEvent(r.default.EVT_ANIMATION,{animation:this.currAnim}),this.currAnim=null)}_setCurrAnim(e){this.currAnim?this.currAnim.combine(e):this.currAnim=e}}t.SystemAnimation=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Animation=void 0;t.Animation=class{constructor(){this.levelID=-1,this.numFrames=0,this.currFrame=0,this.slowDown=2,this.frames=[]}setLevel(e){this.levelID=e.getID()}addFrame(e){for(let t=0;t<this.slowDown;t++)++this.numFrames,this.frames.push(e)}nextFrame(){return this.frames[this.currFrame++]}hasFrames(){return this.currFrame<this.frames.length}combine(e){let t=0;for(;e.hasFrames();){const n=e.nextFrame();if(t<this.frames.length){const e=Object.keys(n);for(let s=0;s<e.length;s++){const r=e[s];this.frames[t][r]=n[r]}}else this.frames.push(n);++t}}hasCoord(e){const t=this.frames.length;for(let n=0;n<t;n++){const t=this.frames[n];for(const n in t)if(e[n])return!0}return!1}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemAreaEffects=void 0;const i=o(n(4)),l=n(14),c=a(n(11)),u=n(13);class h extends l.SystemBase{constructor(e,t){super(i.default.SYS.AREA_EFFECTS,e,t),this.radRange=1}updateEntity(e){const t=e.getList("Flame");let n=!1,s=!1;e.has("Health")?t.forEach(t=>{const r=t.getDamageType(),a=new c.Damage(t.getDamage(),r),o=t.getSource();if(a.setSource(o),o.has("Created")){const e=o.get("Created").getCreator();a.setSourceActor(e)}e.add(a),e.remove(t),r===i.default.DMG.FIRE?n=!0:r===i.default.DMG.ICE&&(s=!0)}):e.removeAll("Flame"),n?this._createRadiationComps(e,"Heat","Fire"):s&&this._createRadiationComps(e,"Coldness","Ice flame")}_createRadiationComps(e,t,n){const s=i.default.getLevel(e).getMap(),r=e.get("Location").getCell(),[a,o]=r.getXY();u.Geometry.getBoxAround(a,o,this.radRange).forEach(e=>{if(s.hasXY(e[0],e[1])){const r=s.getCell(e[0],e[1]);if(r.hasActors()){r.getActors().forEach(e=>{e.getName()!==n&&e.add(new c[t])})}}})}}t.SystemAreaEffects=h},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemAttack=void 0;const i=o(n(4)),l=n(14),c=a(n(11)),u=n(27);class h extends l.SystemBase{constructor(e,t){super(i.default.SYS.ATTACK,e,t)}updateEntity(e){e.getList("Attack").forEach(t=>{this.processAttackComp(e,t),e.remove(t)})}processAttackComp(e,t){const n=e,s=t.getTarget(),r=i.default.getName(n),a=i.default.getName(s);if(s.has("Ethereal"))i.default.gameMsg({cell:n.getCell(),msg:"Attack of "+r+" passes through "+a});else{if(s.has("FirstStrike")){const e=a+" seems to strike first.";i.default.gameMsg({cell:s.getCell(),msg:e}),this.performAttack(s,n,a,r)}const e=n.get("Combat").getNumHits();for(let t=0;t<e;t++)this.performAttack(n,s,r,a);if(s.has("CounterAttack")){const e=a+" seems to counter attack.";i.default.gameMsg({cell:s.getCell(),msg:e}),this.performAttack(s,n,a,r)}if(n.has("BiDirStrike")){const e=this.getBiDirTarget(n,s);if(e){const t=r+" tries to hit double strike.";i.default.gameMsg({msg:t,cell:n.getCell()});const s=e.getName();if(this.performAttack(n,e,r,s),e.has("CounterAttack")){const t=s+" seems to counter attack.";i.default.gameMsg({cell:e.getCell(),msg:t}),this.performAttack(e,n,s,r)}}}n.getBrain().getMemory().setLastAttacked(s)}}addAttackerBonus(e){return u.Brain.getEnemyCellsAround(e).length}addDefenderBonus(e){return u.Brain.getEnemyCellsAround(e).length}performAttack(e,t,n,s){if(t.has("Charm")&&this.attIsCharmed(e,t)){let n=`${e.getName()} is charmed by ${t.getName()} `;return n+=", and does not attack",void i.default.gameMsg({cell:e.getCell(),msg:n})}let r=i.default.getMeleeAttack(e);e.has("Attacker")&&(r+=this.addAttackerBonus(e));const a=this.getEntityDefense(t),o=r/(r+a),u=this.rng.getUniform();if(this._emitDbgMsg(`hitChance is ${o}, threshold ${u}`,e),o>=u){const r=e.getDamage();r>0?(this.doDamage(e,t,r),t.has("Experience")&&l.SystemBase.addSkillsExp(e,"Melee",1)):i.default.gameMsg({cell:e.getCell,msg:n+" fails to hurt "+s}),this._applyAddOnHitComp(e,t)}else this.checkForShieldSkill(u,r,a,t),i.default.gameMsg({cell:e.getCell(),msg:n+" misses "+s});if(t.addEnemy(e),e.isPlayer()||t.isPlayer()){const n=new c.Event;n.setArgs({type:i.default.EVT_ACTOR_ATTACKED,cause:e}),t.add(n)}}getEntityDefense(e){if(e.has("Paralysis"))return 0;let t=0;return e.getDefense&&(t=e.getDefense(),e.has("Defender")&&(t+=this.addDefenderBonus(e))),t}doDamage(e,t,n){const s=new c.Damage(n,i.default.DMG.MELEE);if(s.setSource(e),this.debugEnabled){const s=`${e.getName()}, ID: ${e.getID()}`;this._emitDbgMsg(`Dmg: ${n}, 'Melee' from ${s}`,t)}t.add(s),i.default.gameWarn({cell:e.getCell(),msg:e.getName()+" hits "+t.getName()})}getBiDirTarget(e,t){const[n,s]=[e.getX(),e.getY()],[r,a]=[t.getX(),t.getY()],o=n+-1*(r-n),i=s+-1*(a-s),l=e.getLevel().getMap();if(l.hasXY(o,i)){const t=l.getCell(o,i);if(t.hasActors()){const n=t.getActors();for(let t=0;t<n.length;t++)if(e.isEnemy(n[t]))return n[t]}}return null}checkForShieldSkill(e,t,n,s){if(s.has("Skills")){t/(t+(n-s.getShieldDefense()))>e&&l.SystemBase.addSkillsExp(s,"Shields",1)}}attIsCharmed(e,t){const n=t.getList("Charm");let s=!1;return n.forEach(t=>{const n=t.getTargetActor(),r=t.getLevel(),a=e.getWillpower();let o=r/(r+a);n!==i.default.NO_TARGET&&n===e.getID()&&(o=r/(r+a)*2,o>.8&&(o=.8)),i.default.isSuccess(o)&&(s=!0)}),s}_applyAddOnHitComp(e,t){const n=e.getWeapon();if(n&&n.has){if(n.has("AddOnHit")){const s=n.get("AddOnHit");if(s.getOnAttackHit()){const n=s.getCompToAdd();l.SystemBase.addCompToEntAfterHit(n,t,e)}}}else if(n&&n.onAttackHit){const s=e;n.onAttackHit(t,s)}else{const n=e;if(n&&n.has("AddOnHit")){const e=n.get("AddOnHit");if(e.getOnAttackHit()){const s=e.getCompToAdd();l.SystemBase.addCompToEntAfterHit(s,t,n)}}}}}t.SystemAttack=h},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemAttackRanged=void 0;const i=o(n(4)),l=n(14),c=a(n(11));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.ATTACK_RANGED,e,t)}updateEntity(e){const t=e.get("AttackRanged"),n=t.getTarget(),s=t.getAttacker(),r=s.getInvEq();let a=1;s.has("DoubleShot")&&(a=2);for(let t=0;t<a;t++){const t=r.unequipAndGetItem("missile",1,0);if(i.default.isNullOrUndef([t]))this.cmdNotPossible(e,"No missile equipped");else{if(t.has("Ammo")){const n=r.getEquipment().getEquipped("missileweapon");if(null===n){const t="No missile weapon equipped.";this.cmdNotPossible(e,t)}else{const r=t.getAmmoType(),a=n.getWeaponType();if(s.has("MixedShot")){const t=/bow/;if(!(t.test(r)&&t.test(a)||r===a)){const t="Ammo/weapon not compatible.";this.cmdNotPossible(e,t)}}else if(r!==a){const t="Ammo/weapon not compatible.";this.cmdNotPossible(e,t)}}}if(i.default.isNullOrUndef([n]))i.default.err("System.AttackMissile","updateEntity","No x,y given for missile.");else{const[r,a,o]=n.getXYZ(),l=new c.Missile(s);l.setTargetXYZ(r,a,o),l.setDamage(i.default.getMissileDamage(s,t)),l.setAttack(i.default.getMissileAttack(s)),l.setRange(i.default.getMissileRange(s,t)),t.add(l),e.get("Action").setEnergy(i.default.energy.MISSILE)}}}e.remove(t)}cmdNotPossible(e,t){if(e.get("Action").setMsg(t),e.get("Action").setStatus(-1),e.has("Player")){const t=new c.PlayerCmdInfo;t.setImpossibleCmd(!0),e.add(t)}}}t.SystemAttackRanged=u},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemBaseAction=void 0;const i=o(n(4)),l=a(n(54)),c=n(14),u=n(19),h=n(246),d=n(128),p=a(n(11)),f=n(27),m=n(16),g=n(57),y=["Pickup","UseStairs","OpenDoor","UseItem","UseElement","Jump","Read","Rest","Give","Displace"];class v extends c.SystemBase{constructor(e,t){super(i.default.SYS.BASE_ACTION,e,t),this.compTypesAny=!0,this._dtable={Displace:this._handleDisplace.bind(this),Give:this._handleGive.bind(this),Jump:this._handleJump.bind(this),OpenDoor:this._handleOpenDoor.bind(this),Pickup:this._handlePickup.bind(this),Read:this._handleRead.bind(this),UseElement:this._handleUseElement.bind(this),UseItem:this._handleUseItem.bind(this),UseStairs:this._handleUseStairs.bind(this),Rest:this._handleRest.bind(this)}}updateEntity(e){y.forEach(t=>{e.has(t)&&(this._dtable[t](e),e.remove(t))})}_handleDisplace(e){const t=e.get("Displace").getDisplaceTarget();if(t.isEnemy(e)){const n=i.default.getName(t),s=i.default.getName(e),r=i.default.getCell(e);if(r){const e=`${n} refuses to swap places with ${s}`;i.default.gameMsg({msg:e,cell:r})}}else{const[n,s]=e.get("Location").getXY(),[r,a]=t.get("Location").getXY(),o=e.get("Location").getLevel(),i=new p.Movement(r,a,o);i.setDisplace(!0),i.setActor(t),e.add(i);const l=new p.Movement(n,s,o);l.setDisplace(!0),l.setActor(e),t.add(l)}}_handleGive(e){const t=e.get("Give"),n=t.getGiveTarget(),s=t.getItem();if(n.isEnemy(e)){let t=n.getName()+" refuses to take ";t+=`${s.getName()} from ${e.getName()}`,i.default.gameMsg({cell:e.getCell(),msg:t})}else if(e.getInvEq().removeItem(s)){const t=e.getInvEq().getRemovedItem();n.getInvEq().addItem(t);if(t.has("QuestTarget")&&n.has("QuestTarget")){const s={actor:n,item:t},r=t.get("QuestTarget");d.SystemQuest.addQuestEvent(e,r,"give",s)}let r=e.getName()+" gives ";r+=`${s.getName()} to ${n.getName()}`,i.default.gameMsg({cell:e.getCell(),msg:r})}}_handlePickup(e){const[t,n]=[e.getX(),e.getY()],s=e.getLevel(),r=s.getMap().getCell(t,n);if(r.hasProp(i.default.TYPE_ITEM)){const a=r.getProp(i.default.TYPE_ITEM)[0];if(e.getInvEq().canCarryItem(a)){e.getInvEq().addItem(a);try{s.removeItem(a,t,n)}catch(t){let n=`Unable to remove item ${JSON.stringify(a)}\n`;n+="Actor for pickup: "+e.getName(),i.default.err("System.BaseAction","handlePickup",n)}let o=a.getName();a.getCount()>1&&(o+=" x"+a.getCount());const l={msg:e.getName()+" picked up "+o,cell:r};if(i.default.gameMsg(l),this._checkForAutoEquip(e,a),a.has("QuestTarget")){const t=a.get("QuestTarget");d.SystemQuest.addQuestEvent(e,t,"get")}const c={eventObject:a,type:i.default.EVT_ITEM_PICKED_UP};this._createEventComp(e,c)}else{const t={msg:e.getName()+" cannot carry more weight",cell:r};i.default.gameMsg(t)}}}_checkForAutoEquip(e,t){const n=e.getInvEq().getMissile();if(n&&n.equals(t)&&e.getInvEq().equipNItems(t,t.getCount())){const n=t.getNameWithCount();i.default.gameMsg({cell:e.getCell(),msg:`${e.getName()} equips ${n}`})}}_handleUseStairs(e){const t=e.getLevel(),n=e.getCell(),s=f.Brain.getActorsAround(e);if(n.hasConnection()&&t.useStairs(e)){e.isPlayer()&&e.getBrain().addMark();const r=e.getLevel();if(r.has("QuestTarget")){const t=new p.QuestTargetEvent;t.setEventType("goto"),t.setTargetComp(r.get("QuestTarget")),e.add(t)}if(this.pool.emitEvent(i.default.EVT_LEVEL_CHANGED,{target:r,src:t,actor:e}),this.pool.emitEvent(i.default.EVT_LEVEL_ENTERED,{actor:e,target:r}),s.length>0){const n=f.Brain.getBoxOfFreeCellsAround(e,1);for(;s.length>0&&n.length>0;){const a=s.pop(),o=n.pop(),l=a.getCell();if(t.removeActor(a)){const[t,n]=[o.getX(),o.getY()],s=l.getBaseElem().getType();r.addActor(a,t,n),g.removeStatsModsOnLeave(a,s);const c=a.getName();i.default.gameMsg(`${c} follows ${e.getName()}`)}else{const e=JSON.stringify(a);i.default.warn("System.BaseAction","_handleUseStairs","Could not remove the actor: "+e)}}}const a={type:i.default.EVT_ACTOR_USED_STAIRS,cell:n,level:t};this._createEventComp(e,a),g.removeStatsModsOnLeave(e,n.getBaseElem().getType())}else{const e=t.getParent();if(i.default.isArea(e)){const s=e.findTileXYById(t.getID()),r=e;if(s){const[e,a]=s,o={areaTile:r.getTiles()[e][a],level:t,cell:n,zoneConf:{zoneType:"wilderness"}};this.pool.emitEvent(i.default.EVT_CREATE_ZONE,o)}}else i.default.gameMsg({cell:n,msg:"No stairs or connection in cell"})}}_handleOpenDoor(e){const t=e.get("OpenDoor").getDoor(),[n,s]=t.getXY(),r=e.getLevel().getCell(n,s);let a="";const o=e.getName();t.has("Broken")?a="Door is broken and does not move at all!":t.canToggle()?r.hasItems()?a="Door is blocked by an item":r.hasActors()?a="Door is blocked by someone":t.isOpen()?(t.closeDoor(),a=o+" closes a door."):(t.openDoor(),a=o+" opens a door."):a=o+" cannot toggle the door.",""!==a&&i.default.gameMsg({cell:r,msg:a})}_handleUseItem(e){const t=e.get("UseItem"),n=t.getItem(),s=t.getEffect();if(n.has("Broken")){const t=n.getName()+" cannot be used because it is broken";i.default.gameMsg({cell:e.getCell(),msg:t})}else if(s){if(s){const t=new p.Effects(s);t.setItem(n),console.log("Added Effects comp with args",s,e.getName()),e.add(t)}}else i.default.reduceCountOrCharge(n,e,this.pool),this._checkUseItemMsgEmit(e,t)}_handleUseElement(e){const t=e.get("UseElement"),n=t.getElement();n.has("Broken")||n.onUse&&n.onUse(e),this._checkUseElementMsgEmit(e,t)}_handleJump(e){const t=e.get("Jump"),[n,s]=[t.getX(),t.getY()];let r=2;e.has("Jumper")&&(r=e.get("Jumper").getJumpRange());const a=e.getLevel().getMap(),[o,i]=e.getXY(),l=o+n*r,c=i+s*r;if(u.Path.getShortestActorPath(a,o,i,l,c,(e,t)=>{const n=a.getCell(e,t);if(n.hasActors()){const e=n.getActors();for(let t=0;t<e.length;t++){if(!e[t].has("Ethereal"))return!1}}return m.Element.canJumpOver(n.getBaseElem().getType())}).length===r){const t=new p.Movement(l,c,e.getLevel());e.add(t)}}_handleRead(e){let t=e.get("Read").getReadTarget();if(!t){const n=e.getCell();if(n.hasItems()){const e=n.getItems().find(e=>"book"===e.getType());e&&(t=e)}}if(t){const n=t.getText(),s=new l.MenuInfoOnly;s.addPre(n);const r=t.getName();i.default.gameInfo(`The book "${r}" reads:`),e.getBrain().setSelectionObject&&e.getBrain().setSelectionObject(s)}else{const t=e.getName()+" finds nothing interesting to read.";i.default.gameMsg({cell:e.getCell(),msg:t})}if(t.has("QuestTarget")){const n=new p.QuestTargetEvent;n.setEventType("read"),n.setTargetComp(t.get("QuestTarget")),e.add(n)}}_handleRest(e){const t=e.getCell();if("bed"===t.getBaseElem().getType()){if(0===f.Brain.getSeenHostiles(e).length){e.get("Health").addHP(1);const n=e.getName()+" rests for a while in bed";i.default.gameMsg({cell:t,msg:n})}else{const n=e.getName()+" cannot rest with enemies around";i.default.gameMsg({cell:t,msg:n})}}else{const n=e.getName()+" seems to be resting.";i.default.gameMsg({cell:t,msg:n})}}_createEventComp(e,t){const n=new p.Event;n.setArgs(t),e.add(n)}_checkUseItemMsgEmit(e,t){if(t.getUseType()===i.default.USE.DRINK){const e=t.getItem(),n=function(e,t){if(e.target)return h.SystemEffects.getTargetFromObj(e,t);if(e.getCell)return e;return null}(t.getTarget(),t.getTargetType()),s=n.getCell(),r=n.getName()+" drinks "+e.getName();i.default.gameMsg({cell:s,msg:r})}}_checkUseElementMsgEmit(e,t){const n=t.getElement(),s=n.getName(),r=e.getCell();let a="";if(n.has("Broken"))a=s+" is broken, and cannot be used.";else if(t.getUseType()===i.default.USE.LEVER){a=e.getName()+" toggles the lever"}a&&i.default.gameMsg({cell:r,msg:a})}}t.SystemBaseAction=v},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemBattle=void 0;const i=o(n(4)),l=n(14),c=n(128),u=a(n(11)),h=n(57);class d extends l.SystemBase{constructor(e,t){super(i.default.SYS.BATTLE,e,t),this.compTypesAny=!0}updateEntity(e){if(e.has("BattleOver")){const t=e.get("BattleOver");if(e.has("BattleExp")){const t=e.get("BattleExp").getData(),n=t.name,s=this._getBadgeForBattle(n,e);if(t.kill>0)if(l.SystemBase.addSkillsExp(e,i.default.SKILLS.BATTLE,t.kill),s)s.updateData({kill:t.kill});else{const e="No badge found for battle";i.default.err("System.Battle","updateEntity",e)}if(t.isTraitor&&s.updateDate({status:"Traitor"}),s.isWon()){let t=null;e.has("Reputation")?t=e.get("Reputation"):(t=new u.Reputation,e.add(t)),t.addToFame(1)}e.remove("BattleExp");const r=i.default.getLevel(e);if(e.has("Quest")&&r.has("QuestTarget")){const t=e.get("QuestTarget"),n={isWon:s.isWon()};c.SystemQuest.addQuestEvent(e,t,"battle",n)}}e.remove(t)}else if(e.has("BattleOrder")){const t=e.get("BattleOrder");this._emitMsg(e,t),e.remove(t)}else if(e.has("BattleEvent")){const t=e.get("BattleEvent");this._processBattleEvent(e,t),e.remove(t)}}_getBadgeForBattle(e,t){return t.getList("BattleBadge").find(t=>t.getData().name===e)}_emitMsg(e,t){const n=t.getArgs().srcActor.getName(),s=e.getCell(),r=n+" shouts a command into your direction.";i.default.gameMsg({msg:r,cell:s})}_processBattleEvent(e,t){const n={battle:t.getBattle()};h.emitZoneEvent(e,i.default.ZONE_EVT.BATTLE_OVER,n)}}t.SystemBattle=d},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemBuilding=void 0;const r=s(n(4)),a=n(14),o=n(12),i=n(18);class l extends a.SystemBase{constructor(e,t){super(r.default.SYS.BUILDING,e,t),this.parser=o.ObjectShell.getParser()}updateEntity(e){e.getList("BuildEvent").forEach(t=>{this.processComp(e,t),e.remove(t)})}processComp(e,t){const n=e,s=(n.getName(),t.getElem()),r=t.getTarget(),a=n.getLevel();if(i.ELEM_MAP.elemTypeToObj[s]){const e=i.getElem(s),[t,n]=[r.getX(),r.getY()];a.getMap().getCell(t,n).setBaseElem(e)}else{const e=this.parser.createElement(s);e&&e.has("Location")&&a.addElement(e,r.getX(),r.getY())}}}t.SystemBuilding=l},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemChat=void 0;const r=s(n(4)),a=n(14),o=n(187),i=n(128),l=n(245),c=n(60),u=[],h="<ERROR: You should not see this. A bug found >";class d extends a.SystemBase{constructor(e,t){super(r.default.SYS.CHAT,e,t),this.factFuncs={},this.registeredObjs={Trainer:!0,QuestGiver:!0},this.loreData={}}addLore(e,t){this.loreData[e]=t}updateEntity(e){const t=e.get("Chat").getArgs().dir,n=r.default.toActor(e),s=this.getActorsInDirection(n,t);let a=null;for(let t=0;t<s.length;t++){const o=s[t];if(o.isEnemy(n)){const e=this.getHostileMsg(n,o);r.default.gameMsg({cell:o.getCell(),msg:e})}else if(o!==n){if(Object.keys(this.registeredObjs).forEach(e=>{o.has(e)&&(a=a?this.appendToChatObj(a,n,o,e):this.getChatObject(n,o,e))}),!a){a=this.getGenericChatObject(e,o);const t=`You chat with ${o.getName()} for a while.`;r.default.gameMsg({cell:n.getCell(),msg:t})}o.has("QuestTarget")&&this.addQuestTargetItems(n,o,a),this.addQuestSpecificItems(n,o,a),n.getLevel().has("Lore")&&this.addLevelLoreItems(n,o,a),n.getLevel().getParentZone()&&(this.addGenericLoreItems(n,o,a),this.addZoneLoreItems(e,o,a))}else{const e=o.getName()+" talks to themselves";r.default.gameMsg({cell:o.getCell(),msg:e})}}if(a){const e=n.getBrain(),t=a.getSelectionObject();e.setSelectionObject(t)}e.remove("Chat")}getActorsInDirection(e,t){const[n,s]=[t[0],t[1]],a=e.getX()+n,o=e.getY()+s,i=e.getLevel().getMap();if(i.hasXY(a,o)){const e=i.getCell(a,o);if(e.hasActors())return e.getActors();{const t="There is no one to talk to.";r.default.gameMsg({cell:e,msg:t})}}else{const t="There is no one to talk to.";r.default.gameMsg({cell:e.getCell(),msg:t})}return u.slice()}registerChatObject(e,t){"function"==typeof t&&(this.factFuncs[e]=t),this.registeredObjs[e]=!0}appendToChatObj(e,t,n,s){let a=e;e.getName()!==o.Chat.TOP_MENU&&(a=new o.ChatBase,a.setName(o.Chat.TOP_MENU),a.add({name:"Do you offer any special services?",option:e}));const i=this.getChatObject(t,n,s);if(i){const e=this.getChatQuestion(s);a.add({name:e,option:i})}else r.default.err("System.Chat","appendToChatObj","Failed to add new chat object with compType "+s);return a}getChatObject(e,t,n){if(this.factFuncs.hasOwnProperty(n))return this.factFuncs[n]();const s=t.get(n).getChatObj();s.setTarget(e);if(s.getSelectionObject())return s;{const e=t.getName();r.default.err("SystemChat","setChatObject",`Null/undef selectObj with type ${n}, src: ${e}`)}return null}getGenericChatObject(e,t){const n=new o.Chat.ChatBase,s=t.getName();return n.pre=s+" greets you. What do you say?",n}addQuestTargetItems(e,t,n){const s=t.get("QuestTarget");if("escort"===s.getTargetType()){const r=t.get("QuestEscortTarget");r.getEscortTo().getID()!==e.getLevel().getID()?n.add({name:r.getQuestion(),option:()=>{}}):n.add({name:"I have escorted you safely to correct place now",option:()=>{const n={src:t};i.SystemQuest.addQuestEvent(e,s,"escort",n)}})}}addQuestSpecificItems(e,t,n){if(e.has("Quest")){if(e.get("Quest").getQuestTargets().forEach(e=>{this.addQuestTargetToChat(e,t,n)}),t.has("QuestInfo")){const s=t.get("QuestInfo"),r=t.get("QuestTarget");n.add({name:s.getQuestion(),option:()=>{const n={info:s,src:t};i.SystemQuest.addQuestEvent(e,r,"listen",n)}})}if(e.has("QuestInfo")&&t.has("QuestTarget")){const s=t.get("QuestTarget"),r=e.getList("QuestInfo"),a=t=>{i.SystemQuest.addQuestEvent(e,s,"report",{info:t})};r.forEach(e=>{n.add({name:"Tell about "+e.getInfo(),option:a.bind(null,e)})})}t.has("QuestReport")&&n.add({name:"Tell about quest being completed",option:()=>{i.SystemQuest.addQuestEvent(e,t.get("QuestTarget"),"report")}})}}addQuestTargetToChat(e,t,n){const s=t.getName(),a=e.name;let o=null,i=!1;[i,o]=this.actorHasInMemory(e,t,n);const l={};if(!i){const e=t.getLevel().getParentZone();if(e.has("Lore")){e.getList("Lore").forEach(e=>{e.getKey({topic:"sideQuest"}).forEach(e=>{const{names:n}=e;n&&n.find(e=>e===a)&&(o=()=>{const n=this.getRespMsgFromEntry(t,e),a=this.getFormattedReply(t,"sideQuest",n),o=`${s} says: ${a}`;r.default.gameInfo(o)})})})}}if(""!==a){o||(o=()=>{const e=`${s} says: I don't know where ${a} is`;r.default.gameInfo(e)});const e=`Do you know where is ${a}?`;l[e]||(l[e]=!0,n.add({name:e,option:o}))}}addLevelLoreItems(e,t,n){t.getLevel().getList("Lore").forEach(s=>{s.getLoreTopics().forEach(a=>{const o={},i=s.getKey({topic:a});this.rng.shuffle(i),i.forEach(i=>{const l=this.getTopicQuestion(t,a,i);o[l]||(o[l]=!0,n.add({name:l,option:()=>{const n=this.getRespMsgFromEntry(t,i),o=this.getFormattedReply(t,a,n);this.checkEntryForRevealed(s,i),r.default.gameInfo({cell:e.getCell(),msg:o})}}))})})})}addGenericLoreItems(e,t,n){let s=0;const a=this.rng.arrayGetRand(l.Lore.genericTopics),o=l.Lore[a];let i="";for(;s<3;){const n=this.rng.arrayGetRand(o);if(this._meetsAllReq(n,e,t)){i=this.rng.arrayGetRand(n.text);break}++s}const c=e.getLevel(),u=l.formatMsg(i,{level:c,target:t,asker:e});n.add({name:"Have you heard anything interesting lately?",option:()=>{r.default.gameInfo({cell:e.getCell(),msg:u})}})}addZoneLoreItems(e,t,n){const s=t.getLevel().getParentZone();if(s.has("Lore")){s.getList("Lore").forEach(s=>{if(s.hasTopic("mainQuest")){const a=s.getKey({topic:"mainQuest"}),o=this.rng.arrayGetRand(a),i=this.getRespMsgFromEntry(t,o),l=this.getFormattedReply(t,"mainQuest",i);"string"==typeof l?n.add({name:"Can you tell me anything about the North?",option:()=>{this.checkEntryForRevealed(s,o),r.default.gameInfo({cell:e.getCell(),msg:l})}}):r.default.err("SystemChat","addZoneLoreItems","Expected msg to be string. Got "+JSON.stringify(i))}if(s.hasTopic("sideQuest")){const a=s.getKey({topic:"sideQuest"}),o=this.rng.arrayGetRand(a),i=this.getRespMsgFromEntry(t,o),l=this.getFormattedReply(t,"sideQuest",i);"string"==typeof l?n.add({name:"What can you tell me about this area?",option:()=>{this.checkEntryForRevealed(s,o),r.default.gameInfo({cell:e.getCell(),msg:l})}}):r.default.err("SystemChat","addZoneLoreItems","Expected msg to be string. Got "+JSON.stringify(l))}if(s.hasTopic("location")){const a=s.getKey({topic:"location"}),o=this.rng.arrayGetRand(a),i=this.getRespMsgFromEntry(t,o),l=this.getFormattedReply(t,"location",i);"string"==typeof l?n.add({name:"Are there any interesting places nearby?",option:()=>{this.checkEntryForRevealed(s,o),r.default.gameInfo({cell:e.getCell(),msg:l})}}):r.default.err("SystemChat","addZoneLoreItems","Expected msg to be string. Got "+JSON.stringify(l))}})}}getRespMsgFromEntry(e,t){let n=t.respMsg;if(!n&&t.msg&&r.default.err("System.Chat","getRespMsgFromEntry","entry.msg not supported. Use entry.respMsg from now on"),Array.isArray(n)&&(n=this.rng.arrayGetRand(n)),"string"==typeof n)return n;if(t.cmd)switch(t.cmd){case"queryLocationFromMemory":{const n=t.names[0],s=t.ids[0],r=e.getBrain().getMemory();if(r.hasSeen(s)){const{x:e,y:t}=r.getLastSeen(s);return{xy:[e,t],name:n}}return e.getID()===s?`I am ${n}. What do you need?`:`I haven't seen ${n} around here.`}default:r.default.err("System.Chat","getRespMsgFromEntry",`No cmd ${t.cmd} supported`)}else if(n.xy)return n;const s={msg:n,entry:t};return r.default.err("System.Chat","getRespMsgFromEntry","Only str/str[]/ILoreOpt msg supported in entry. Got: "+JSON.stringify(s)),h}getAskMsgFromEntry(e,t){if(t.msg){let e="entry.msg not supported. Use entry.askMsg from now on";e+=" Got: "+JSON.stringify(t.msg),r.default.err("System.Chat","getRespMsgFromEntry",e)}if(t.askMsg){const e=t.askMsg;if(Array.isArray(e))return this.rng.arrayGetRand(e);if("string"==typeof e)return e}return r.default.err("System.Chat","getAskMsgFromEntry","entry.askMsg does not exist"),h}actorHasInMemory(e,t,n){const s=t.getName(),a=e.name;let o=null;const i=e.id,l=t.getBrain().getMemory();if(l.hasSeen(i)){o=n.getSelectionObject();const{x:e,y:c}=l.getLastSeen(i);let u=`${s} says: I know where ${a} is.`;return u+=` I saw ${a} ${r.default.getTextualDir([e,c],t)} from here.`,r.default.gameInfo(u),[!0,o]}if("location"===e.targetType&&i===t.getLevel().getID()){o=n.getSelectionObject();const e=`This place is ${a}.`;return r.default.gameInfo(e),[!0,o]}return[!1,o]}_meetsAllReq(e,t,n){const s=new c.Constraints;let r=!0;if(e.level){const n=s.getConstraints(e.level);r=r&&n(t.getLevel())}if(e.target){const t=s.getConstraints(e.target);r=r&&t(n)}if(e.asker){const n=s.getConstraints(e.asker);r=r&&n(t)}return r}getChatQuestion(e){switch(e){case"QuestGiver":return"Can you give me some work to do?"}return"Do you know anything about "+e+"?"}getHostileMsg(e,t){const n=t.getName(),s=e.getType();return t.getBrain().getMemory().hasEnemyType(s)?`${n} shouts: 'Go away filthy ${s}!'`:n+" is hostile and refuses to talk."}checkEntryForRevealed(e,t){t.revealNames&&t.revealNames.forEach(n=>{const s={topic:"custom",askMsg:["Where can I find "+n+"?"],names:[n],cmd:"queryLocationFromMemory"};t.revealIds&&1===t.revealNames.length&&1===t.revealIds.length&&(s.ids=t.revealIds.slice()),e.hasEntry(s)||e.addEntry(s)})}getTopicQuestion(e,t,n){const s={quests:"Is anyone looking for help here?",places:"Do you know what places are nearby?",shops:"Is there a place for trading?",people:"What can you tell me about people here?",world:"Do you have any rumors from faraway lands?"};return s[t]?s[t]:"custom"===t?this.getAskMsgFromEntry(e,n):(r.default.err("system.chat.ts","getTopicQuestion","No match for topic "+t),h)}getFormattedReply(e,t,n){if("string"==typeof n)return n;let s="";n.xy&&(s=r.default.getTextualDir(n.xy,e));let a="";switch(t){case"shops":a=e.has("Shopkeeper")?"You are already in my shop. Welcome!":`${n.name} should have a shop ${s} from here.`;break;case"custom":a=""!==s?`I saw ${n.name} ${s} from here.`:`I saw ${n.name} around, but don't remember where.`}return a}}t.SystemChat=d},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemCommunication=void 0;const r=s(n(4)),a=n(14);class o extends a.SystemBase{constructor(e,t){super(r.default.SYS.COMMUNICATION,e,t),this._msgFunc={Enemies:this.processEnemies.bind(this),Shout:this.processShout.bind(this)}}updateEntity(e){const t=e.get("Communication").getMsg();for(let n=0;n<t.length;n++)this.processMessage(e,t[n]);e.remove("Communication")}processMessage(e,t){this._msgFunc.hasOwnProperty(t.type)?this._msgFunc[t.type](e,t):r.default.err("CommunicationSystem","processMessage","No function for msg type |"+t.type+"| in dtable.")}processEnemies(e,t){const n=t.enemies,s=t.src.getName();for(let t=0;t<n.length;t++)e.addEnemy(n[t]);const a={cell:e.getCell(),msg:`${s} seems to communicate with ${e.getName()}`};r.default.gameInfo(a)}processShout(e,t){const n=t.shout,s=t.src.getName(),a={cell:t.src.getCell(),msg:`${s} shouts ${n}`};r.default.gameInfo(a)}}t.SystemCommunication=o},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemCrafting=void 0;const r=s(n(4)),a=n(14),o=n(12);class i extends a.SystemBase{constructor(e,t){super(r.default.SYS.CRAFTING,e,t),this.parser=o.ObjectShell.getParser()}updateEntity(e){e.getList("Crafting").forEach(t=>{this.processComp(e,t),e.remove(t)})}processComp(e,t){const n=e.getName(),s=t.getItem(),a=[{count:t.getCount(),name:s}],o=t.getArgs(),i=this.parser.get(r.default.TYPE_ITEM,s).recipe;i||r.default.err("SystemCrafting","processComp","No recipe found for "+s);const l=i;if(this.extractInputsFromEntity(e,l))a.forEach(t=>{const{count:r,name:a}=t;if(this.addOutputsToEntity(e,r,a),o&&o.hasOwnProperty("callback")){const e=`${n} succesfully crafted ${s}`;o.callback({msg:e,result:!0})}});else if(o&&o.hasOwnProperty("callback")){const e=`${n} does not have materials to craft ${s}`;o.callback({msg:e,result:!1})}}extractInputsFromEntity(e,t){let n=!0;return t.forEach(t=>{const{count:s,name:r}=t;this.entityHasInput(e,s,r)||(n=!1)}),n&&t.forEach(t=>{const{count:n,name:s}=t;this.removeInputsFromEntity(e,n,s)}),n}entityHasInput(e,t,n){return e.getInvEq().getItemsNamed(n).reduce((e,t)=>e+t.getCount(),0)>=t}removeInputsFromEntity(e,t,n){const s=e.getInvEq(),r=s.getItemsNamed(n);if(r.length>0){return s.removeNItems(r[0],t)}return!1}addOutputsToEntity(e,t,n){const s=e.getInvEq(),r=this.parser.createItem(n);r.setCount(t),s.addItem(r)}}t.SystemCrafting=i},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemDamage=void 0;const i=o(n(4)),l=n(14),c=a(n(11)),u=n(57);class h extends l.SystemBase{constructor(e,t){super(i.default.SYS.DAMAGE,e,t)}processDamageComp(e,t){const n=e.get("Health");if(n){let s=this._getDamageModified(e,t);if(s<=0){s=0;const t="Attack doesn't penetrate protection of "+e.getName();i.default.gameMsg({msg:t,cell:e.getCell()})}else if(this._applyAddOnHitComp(e,t),n.decrHP(s),l.SystemBase.addSkillsExp(e,i.default.SKILLS.ARMOUR,1),e.has("Regeneration")&&u.addRegenEffects(e),this.debugEnabled){const t=n.getMaxHP(),r=`(${s}),(${n.getHP()}/${t})`;i.default.gameDanger({msg:r,cell:e.getCell()})}const r=this._getUltimateDmgSource(t);if(r&&e.getID()!==r.getID()&&i.default.isActor(r)&&e.addEnemy(r),n.isDead()&&!e.has("Dead")&&!e.has("DeathEvent")){const n=new c.DeathEvent;if(n.setSource(r),t.isType(i.default.DMG.POISON)){const t=e.getName()+" dies horribly of poisoning";n.setMsg(t)}e.add(n)}if(r&&i.default.isActor(r)&&(r.isPlayer()||e.isPlayer())&&!i.default.isNullOrUndef([r,e])){const t=new c.Event;t.setArgs({type:i.default.EVT_ACTOR_DAMAGED,cause:r}),e.add(t),e.has("QuestTarget")&&this.checkForDamagedQuestEvent(e,r)}}}checkForDamagedQuestEvent(e,t){if("damage"===e.get("QuestTarget").getTargetType()){const n=new c.QuestTargetEvent;n.setEventType("damage"),n.setArgs({target:e}),n.setTargetComp(e.get("QuestTarget")),t.add(n)}}_getUltimateDmgSource(e){let t=e.getSourceActor();return t||(t=e.getSource()),t&&t.has&&t.has("Created")?t=t.get("Created").getCreator():t&&!t.has&&(console.log("Warning. No damageSrc.has():",t),i.default.err("System.Damage","_getUltimateDmgSource","No damageSrc.has()")),t}_getDamageModified(e,t){const n=t.getDamageType();let s=t.getSourceActor();s||(s=t.getSource());const r=this._getDmgAfterWeaknessAndResistance(e,t),a=e.getCell();if(n===i.default.DMG.POISON){const t="Poison is gnawing inside "+e.getName();return i.default.gameDanger({cell:a,msg:t}),r}if(n===i.default.DMG.HUNGER)return r;if(n===i.default.DMG.FIRE){const t=`Fire is burning ${e.getName()}.`;return i.default.gameDanger({cell:a,msg:t}),r}if(n===i.default.DMG.ICE){const t=`Ice is freezing ${e.getName()}.`;return i.default.gameDanger({cell:a,msg:t}),r}if(n===i.default.DMG.COLD){const t=e.getName()+" is extremely hypothermic";return i.default.gameInfo({cell:a,msg:t}),r}const o=t.getDamageCateg();if(o===i.default.DMG.MAGIC)return r;if(o===i.default.DMG.DIRECT)return r;if(!s&&o===i.default.DMG.WATER)return r;if(this.isProtectionBypassed(e,s)){const t=`${s.getName()} hits ${e.getName()} through armor.`;return i.default.gameDanger({cell:a,msg:t}),r}return r-(e.getEquipProtection()+e.get("Combat").getProtection())}_getDmgAfterWeaknessAndResistance(e,t){const n=e.getName();let s=t.getDamage();if(e.has("Weakness")){e.getList("Weakness").forEach(n=>{if(this.effectMatches(t,n)){switch(n.getLevel()){case i.default.WEAKNESS.MINOR:s=Math.round(1.25*s);break;case i.default.WEAKNESS.MEDIUM:s=Math.round(1.5*s);break;case i.default.WEAKNESS.SEVERE:s*=2;break;case i.default.WEAKNESS.FATAL:s=e.get("Health").getMaxHP()}}})}if(e.has("Resistance")){let r="";e.getList("Resistance").forEach(n=>{if(this.effectMatches(t,n)){switch(n.getLevel()){case i.default.RESISTANCE.MINOR:s=Math.round(s/1.25),r+=" resists the attack slighty";break;case i.default.RESISTANCE.MEDIUM:s=Math.round(s/1.5),r+=" resists the attack";break;case i.default.RESISTANCE.STRONG:s=Math.round(s/2),r+=" resists the attack strongly";break;case i.default.RESISTANCE.IMMUNITY:s=0,r+=" is immune against the attack";break;case i.default.RESISTANCE.ABSORB:e.get("Health").addHP(s),r+=" absorbs the power of the attack";break}}}),""!==r&&(r=n+" "+r,i.default.gameMsg({msg:r,cell:e.getCell()}))}return s}effectMatches(e,t){const n=t.getEffect(),s=e.getDamageType(),r=e.getDamageCateg();return n===s||n===r}isProtectionBypassed(e,t){const n=this.rng.getUniform();return t&&!t.has&&(console.log("src is not entity:",t),console.log("With entity:",e),i.default.err("System.Damage","isProtectionBypassed","No src.has()")),t&&t.has("BypassProtection")?n<=t.get("BypassProtection").getChance():n<=i.default.PROT_BYPASS_CHANCE}_applyAddOnHitComp(e,t){const n=t.getWeapon();if(n&&n.has){if(n.has("AddOnHit")){const s=n.get("AddOnHit");if(s.getOnDamage()){const n=s.getCompToAdd();l.SystemBase.addCompToEntAfterHit(n,e,t.getSource())}}}else if(n&&n.onHit){const s=t.getSource();n.onHit&&n.onHit(e,s)}else{const n=t.getSource(),s=t.getDamageCateg();if(s!==i.default.DMG.EFFECT&&s!==i.default.DMG.DIRECT&&n&&n.has("AddOnHit")){const t=n.get("AddOnHit");if(t.getOnDamage()){const s=t.getCompToAdd();l.SystemBase.addCompToEntAfterHit(s,e,n)}}}}updateEntity(e){e.getList("Damage").forEach(t=>{this.processDamageComp(e,t),e.remove(t)})}}t.SystemDamage=h},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemDeath=void 0;const i=o(n(4)),l=n(14),c=a(n(11)),u=a(n(39)),h=n(12),d=i.default.NO_DAMAGE_SRC;class p extends l.SystemBase{constructor(e,t){super(i.default.SYS.DEATH,e,t),this.enableRandomLootDrops=!0,this.normalLootChance=.07,this.betterLootChance=.03,this.traceID=59,this.debugEnabled=!0,this.disableEventEmit=!1}updateEntity(e){const t=e.get("DeathEvent"),n=t.getSource();if(e.has("Loot")){const t=e.getCell();e.get("Loot").dropLoot(t)}this._dropInvAndEq(e),this._killActor(n,e,t),e.remove(t)}_killActor(e,t,n){const s=t.getLevel(),r=t.getCell();if(t.add(new c.Dead),this.debugEnabled){let e="Killing actor now";e+=JSON.stringify(t.getCompList()),this._emitDbgMsg(e,t)}if(s.removeActor(t)){const a=t.getName();t.has("Experience")&&this._giveExpToSource(e,t);const o=n.getMsg();o&&i.default.gameDanger({cell:r,msg:o});let l="killed";t.has("NonSentient")&&(l="destroyed");let u=a+" was "+l;e!==d&&(u+=" by "+e.getName()),i.default.gameDanger({cell:r,msg:u}),this.disableEventEmit||(this.pool.emitEvent(i.default.EVT_ACTOR_KILLED,{actor:t}),t.isPlayer()&&this.pool.emitEvent(i.default.EVT_PLAYER_KILLED,{actor:t}));const h=new c.Event;h.setArgs({type:i.default.EVT_ACTOR_KILLED,cause:e}),t.add(h),this.enableRandomLootDrops&&this._genRandomLootDrop(t,s,r,e),this._dropActorCorpse(t,s,r,e),this._cleanUpComponents(t)}else i.default.err("System.Damage","killActor","Couldn't remove actor")}_giveExpToSource(e,t){if(e!==d&&!e.has("Dead")){const n=t.get("Experience").getExpLevel(),s=t.get("Experience").getDanger();if(e.has("Experience")){const t=new c.ExpPoints(n+s);e.add(t),e.get("Experience").incrNumKilled()}else console.log(`Killer was ${e.getName()} without Experience`);e.has("InBattle")&&(this._giveBattleExpToSource(e),t.has("InBattle")&&this._checkIfKillerIsTraitor(e,t))}}_giveBattleExpToSource(e){if(!e.has("BattleExp")){const t=e.get("InBattle").getData();if(t){const n=t.name,s=new c.BattleExp;s.setData({kill:0,name:n}),e.add(s)}else{const t="Actor: "+JSON.stringify(e);i.default.err("System.Damage","_giveBattleExpToSource","InBattle data is null. Actor: "+t)}}e.get("BattleExp").getData().kill+=1}_checkIfKillerIsTraitor(e,t){const n=e.get("InBattle").getData(),s=t.get("InBattle").getData();n.army===s.army&&(n.isTraitor=!0)}_dropInvAndEq(e){const[t,n]=e.getXY();if(!e.getInvEq)return;const s=e.getInvEq(),r=s.getInventory().getItems(),a=e.getLevel();r.forEach(e=>{if(s.removeNItems(e,e.getCount())){const e=s.getRemovedItem();a.addItem(e,t,n)}});s.getEquipment().getItems().forEach(e=>{a.addItem(e,t,n)})}_cleanUpComponents(e){["Coldness","Expiration","Fading","RegenEffect"].forEach(t=>{e.getList(t).forEach(t=>{"function"==typeof t.cleanup&&t.cleanup(),e.remove(t)})})}_cloneComponentsToCorpse(e,t){["Health","Stats","Combat","Experience"].forEach(n=>{const s=e.get(n).clone();t.add(s)});const n=["Undead"];e.hasAny(n)&&n.forEach(n=>{if(e.has(n)){const s=e.get(n).clone();t.add(s)}})}_dropActorCorpse(e,t,n,s){const r=e.getName(),[a,o]=n.getXY();if(e.has("Corporeal")){const n=new u.Corpse(r+" corpse");n.setActorName(e.get("Named").getBaseName()),this._cloneComponentsToCorpse(e,n);const l=i.default.getCssClass(i.default.TYPE_ACTOR,r);if(i.default.addCellStyle(i.default.TYPE_ITEM,n.getName(),l),t.addItem(n,a,o),e.has("QuestTarget")){const t=new c.QuestTargetEvent;t.setEventType("kill"),t.setArgs({corpse:n}),t.setTargetComp(e.get("QuestTarget")),s.add(t)}this._addSpawnableUndeadActor(e)}}_genRandomLootDrop(e,t,n,s){if(!function(e){if(/(animal)/.test(e.getType())){return e.get("Experience").getDanger()>=7}return!0}(e))return;if(!i.default.isSuccess(this.normalLootChance))return;const r=e.get("Experience").getExpLevel(),a=e.get("Experience").getDanger(),o=10*r+10*a;let l=10*r+30*a;i.default.isSuccess(this.betterLootChance)&&(l*=2);const c=h.ObjectShell.getParser().createRandomItem({func:e=>e.value>=o&&e.value<=l});if(c){const[e,s]=n.getXY();t.addItem(c,e,s)||i.default.warn("System.Death","_genRandomLootDrop",`Failed to add item to ${e},${s}`)}}_addSpawnableUndeadActor(e){if("undead"===e.getType()||e.has("Undead"))return;const t=e.get("Named").getBaseName(),n=h.ObjectShell.getParser(),s=n.dbGet({name:t,categ:i.default.TYPE_ACTOR});if(s){const e=s,t=JSON.parse(JSON.stringify(e));t.type="undead",t.enemies=i.default.ACTOR_RACES,t.tag="killed",t.addComp?Array.isArray(t.addComp)?t.addComp.push("Undead"):t.addComp=[t.addComp,"Undead"]:t.addComp=["Undead"],t.name="undead "+t.name,t.color={fg:"Cyan",bg:"Black"},n.hasObj(i.default.TYPE_ACTOR,t.name)||n.parseObjShell(i.default.TYPE_ACTOR,t)}}}t.SystemDeath=p},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemDrainStats=void 0;const i=o(n(4)),l=n(14),c=a(n(11));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.DRAIN_STATS,e,t)}updateEntity(e){e.getList("DrainStat").forEach(t=>{this.processDrainComp(e,t),e.remove(t)})}processDrainComp(e,t){if(t.applyComp()){let n=t.getDrainMsg();if(""!==n){n=t.getSource().getName()+" "+n+" "+e.getName(),i.default.gameMsg({cell:e.getCell(),msg:n})}}if(e.remove(t),e.has("Health")){if(e.get("Health").isDead()&&!e.has("Dead")&&!e.has("DeathEvent")){const n=new c.DeathEvent;n.setSource(t.getSource());let s=e.getName()+" is drained out of life";s+=" permanently",n.setMsg(s),e.add(n)}}}}t.SystemDrainStats=u},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemDisability=void 0;const i=o(n(4)),l=n(14),c=a(n(11)),u={Entrapped:{Attack:"cannot attack while trapped",AttackRanged:"cannot attack while trapped",Movement:"cannot move while trapped",SpellCast:"cannot cast spells while trapped",UseStairs:"cannot move while trapped",default:"cannot move while trapped"},Paralysis:{Attack:"cannot attack under paralysis",AttackRanged:"cannot attack while trapped",Movement:"cannot move under paralysis",SpellCast:"cannot cast spells under paralysis",UseStairs:"cannot move under paralysis",default:"cannot move under paralysis"},Stun:{Attack:"is too stunned to attack",AttackRanged:"cannot attack while trapped",Movement:"is stunned, and stumbles",SpellCast:"is too stunned to cast spells",UseStairs:"is too stunned to move",default:"is too stunned to move"}};class h extends l.SystemBase{constructor(e,t){super(i.default.SYS.DISABILITY,e,t),this.compTypesAny=!0,this._dispatchTable={Entrapped:{Attack:e=>{e.remove("Attack"),this._emitMsg("Paralysis","Attack",e)},AttackRanged:e=>{e.remove("AttackRanged"),this._emitMsg("Entrapped","AttackRanged",e)},Movement:e=>{this._handleEntrapped(e)},SpellCast:e=>{e.remove("SpellCast"),this._emitMsg("Entrapped","SpellCast",e)},UseStairs:e=>{e.remove("UseStairs"),this._emitMsg("Entrapped","UseStairs",e)}},Fear:{Attack:e=>{this._handleFear(e,"Attack")},Movement:e=>{this._handleFear(e,"Movement")}},Paralysis:{Attack:e=>{e.remove("Attack"),this._emitMsg("Paralysis","Attack",e)},AttackRanged:e=>{e.remove("AttackRanged"),this._emitMsg("Paralysis","AttackRanged",e)},Movement:e=>{e.remove("Movement"),this._emitMsg("Paralysis","Movement",e)},SpellCast:e=>{e.remove("SpellCast"),this._emitMsg("Paralysis","SpellCast",e)},UseStairs:e=>{e.remove("UseStairs"),this._emitMsg("Paralysis","Movement",e)}},Stun:{Attack:e=>{e.remove("Attack"),this._emitMsg("Stun","Attack",e)},AttackRanged:e=>{e.remove("AttackRanged"),this._emitMsg("Stun","AttackRanged",e)},Movement:e=>{const t=this.rng.getRandDir(),[n,s]=i.default.newXYFromDir(t,e);e.remove("Movement");if(e.getLevel().getMap().hasXY(n,s)){const t=new c.Movement(n,s,e.getLevel());e.add(t)}this._emitMsg("Stun","Movement",e)},SpellCast:e=>{e.remove("SpellCast"),this._emitMsg("Stun","SpellCast",e)},UseStairs:e=>{i.default.isSuccess(.5)&&(e.remove("UseStairs"),this._emitMsg("Stun","Movement",e))}}},this._compOrder=["Paralysis","Entrapped","Stun"],this._actComp=["Attack","AttackRanged","Movement","SpellCast","UseStairs"]}updateEntity(e){this._compOrder.forEach(t=>{e.has(t)&&this._actComp.forEach(n=>{e.has(n)&&this._dispatchTable[t][n](e)})})}_emitMsg(e,t,n){const s=n.getCell(),r=`${n.getName()} ${u[e][t]}`;i.default.gameMsg({cell:s,msg:r})}_handleEntrapped(e){const t=e.getCell(),n=t.getElements();if(!n)return void e.removeAll("Entrapped");const s=n.filter(e=>e.has("Entrapping"));let r=0;s.forEach(e=>{r+=e.get("Entrapping").getDifficulty()});const a=e.getStrength(),o=e.getAgility(),l=(a+o)/(a+o+r);if(i.default.isSuccess(l)){const n=e.getLevel();s.forEach(e=>{e.get("Entrapping").getDestroyOnMove()&&n.removeElement(e,e.getX(),e.getY())}),e.removeAll("Entrapped");const r=e.getName()+" breaks free from traps!";i.default.gameMsg({cell:t,msg:r})}else{e.remove("Movement");const n=e.getName()+" is trapped and cannot move!";i.default.gameMsg({cell:t,msg:n})}}_handleFear(e,t){const n=e.getList("Fear"),s=e.getBrain().getSeenEnemies();let r=0,a=null;if(n.forEach(e=>{const t=e.getTarget(),n=e.getFearLevel(),o=s.find(e=>e.getID()===t);o&&r<n&&(r=n,a=o)}),a){const n=e.getWillpower(),s=r/(n+r);if(i.default.isSuccess(s)){e.remove(t);const n=i.default.dXdY(a.getXY(),e.getXY()),[s,r]=i.default.newXYFromDir(n,e.getXY());if(e.getLevel().getMap().isPassable()){const t=new c.Movement(s,r,e.getLevel());e.add(t);const n=`${e.getName} panics, and runs away from ${a.getName()}`;i.default.gameMsg({cell:e.getCell(),msg:n})}else{const t=e.getName+" is paralysed by fear!";i.default.gameMsg({cell:e.getCell(),msg:t})}}}}}t.SystemDisability=h},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemEquip=void 0;const i=o(n(4)),l=n(14),c=a(n(29));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.EQUIP,e,t)}updateEntity(e){const t=e.get("Equip");t.getIsRemove()?this.unequipItem(e,t.getArgs()):this.equipItem(e,t.getArgs()),e.remove(t)}unequipItem(e,t){const n=t.slot,s=t.slotNumber,r=e.getInvEq();let a=!1,o=`Failed to remove item from slot ${n}.`;if("missile"===n){null!==r.getEquipment().getItem("missile")&&r.unequipItem(n,t.count)&&(a=!0)}else r.unequipItem(n,1,s)&&(a=!0);t.hasOwnProperty("callback")&&(a&&(o=`Unequipping from ${n} succeeded!`),t.callback({msg:o,result:a}));const i=r.getEquipment().getUnequipped(n,s);if(a&&i.has("AddOnEquip")){i.getList("AddOnEquip").forEach(t=>{this.handleAddOnEquip(e,t,!1)})}}equipItem(e,t){const n=e.getInvEq(),s=t.item;let r=!1,a="Failed to equip "+s.getName();if(s.getType().match(/^(missile|ammo)$/)?n.equipNItems(s,t.count)&&(r=!0):n.equipItem(s)&&(r=!0),t.hasOwnProperty("callback"))r&&(a=`Equipping ${s.getName()} succeeded!`),t.callback({msg:a,result:r});else{const t=`${e.getName()} equips ${s.getName()}`;i.default.gameMsg({msg:t,cell:e.getCell()})}if(r&&s.has("AddOnEquip")){s.getList("AddOnEquip").forEach(t=>{this.handleAddOnEquip(e,t)})}}handleAddOnEquip(e,t,n=!0){if(n){const n=t.getComp();if(n.setSource){const e=t.getEntity();let s=null;i.default.isItem(e)?(s=e.getTopOwner(),s&&n.setSource(s)):n.setSource(t.getEntity())}if(n.is("Duration")){const t=n.rollDuration(),s=n.getExpireMsg();c.addToExpirationComp(e,n,t,s)}else e.add(n);t.setAddedToActor(!0)}else{const n=t.getComp();if("number"==typeof n){const s=e.get(n);e.remove(n),t.setComp(s),t.setAddedToActor(!1)}else i.default.err("System.Equip","handleAddOnEquip","Expected comp ID number. Got: "+n)}}}t.SystemEquip=u},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemEvents=void 0;const r=s(n(4)),a=n(14),o=n(13);class i extends a.SystemBase{constructor(e,t){super(r.default.SYS.EVENTS,e,t),this.eventRadiusPerID={},this.eventRadius=10,this._dtable={[r.default.EVT_ACTOR_KILLED]:this._handleActorKilled.bind(this),[r.default.EVT_ITEM_PICKED_UP]:this._handleItemPickedUp.bind(this),[r.default.EVT_ACTOR_DAMAGED]:this._handleActorDamaged.bind(this),[r.default.EVT_ACTOR_ATTACKED]:this._handleActorAttacked.bind(this),[r.default.EVT_ACTOR_USED_STAIRS]:this._handleActorUsedStairs.bind(this)}}updateEntity(e){e.getList("Event").forEach(t=>{const n=t.getArgs(),{type:s}=n;let r=e.getCell(),a=e.getLevel();n.cell&&(r=n.cell),n.level&&(a=n.level);const i=this._getEventRadius(e),[l,c]=[r.getX(),r.getY()],u=o.Geometry.getBoxAround(l,c,i,!0);a.getMap().getCellsWithCoord(u).forEach(n=>{const r=n.getActors();r&&r.forEach(n=>{if(!n.isPlayer()&&n.has("Perception")){n.getBrain().getSeenCells().find(e=>e.getX()===l&&e.getY()===c)&&this._dtable[s](e,t,n)}})}),e.remove(t)})}addLevel(e,t){this.eventRadiusPerID[e.getID()]=t}removeLevel(e){delete this.eventRadiusPerID[e.getID()]}_getEventRadius(e){const t=e.getLevel().getID();return this.eventRadiusPerID.hasOwnProperty(t)?this.eventRadiusPerID[t]:this.eventRadius}_handleActorKilled(e,t,n){if(e.isPlayer()){const s=t.getArgs().cause;if(s){const t=n.getName(),a=e.getName(),o=`${t} saw ${s.getName()} killing ${a}`;r.default.gameMsg({cell:e.get("Location").getCell(),msg:o})}}}_handleItemPickedUp(e,t,n){if(n.getID()!==e.getID()&&!n.isEnemy(e)){const s=e.getCell(),a=`${n.getName()} saw ${e.getName()} picking up ${t.getArgs().eventObject.getName()}.`;r.default.gameMsg({msg:a,cell:s})}}_handleActorDamaged(e,t,n){if(e.getID()!==n.getID()){const s=t.getArgs(),{cause:r}=s;this._addActorAsEnemy(r,e,n)}}_handleActorAttacked(e,t,n){if(e.getID()!==n.getID()){const s=t.getArgs(),{cause:r}=s;this._addActorAsEnemy(r,e,n)}}_handleActorUsedStairs(e,t,n){r.default.gameMsg(`${n.getName()} saw ${e.getName()} using stairs.`);const s=n.getBrain().getMemory();if(s&&s.isEnemyOrFriend(e)){const{cell:n,level:r}=t.getArgs(),a={x:n.getX(),y:n.getY(),level:r};s.addUsedStairs(e.getID(),a)}}_addActorAsEnemy(e,t,n){e.getID()!==t.getID()&&(t.getType()===n.getType()?n.isEnemy(t)||t.isEnemy(n)||(n.isFriend(e)?(this._emitMsg("seems to dislike action",e,t,n),n.getBrain().getMemory().removeFriend(e)):n.isEnemy(e)||(this._emitMsg("shows hatred against action",e,t,n),n.addEnemy(e))):n.isFriend(t)&&(n.isEnemy(e)||(this._emitMsg("shows hatred against action",e,t,n),n.addEnemy(e))))}_emitMsg(e,t,n,s){const a=t.getName(),o=n.getCell();let i=`${s.getName()} ${e} of ${a} `;i+=" towards "+n.getName(),r.default.gameMsg({cell:o,msg:i})}}t.SystemEvents=i},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemExpPoints=void 0;const r=s(n(4)),a=n(14),o=n(91);class i extends a.SystemBase{constructor(e,t){super(r.default.SYS.EXP_POINTS,e,t)}updateEntity(e){e.getList("ExpPoints").forEach(t=>{const n=e.get("Experience");let s=!0,a=n.getExp();for(a+=t.getExpPoints(),n.setExp(a);s;){const t=n.getExpLevel()+1;if(a>=r.default.getExpRequired(t)){r.default.levelUpActor(e,t);const n=e.getName();if(e.isPlayer()&&e.has("ActorClass")){const n=e.get("ActorClass").getClass(),s=o.ActorClass.getLevelUpObject(t,n);e.getBrain().setSelectionObject(s)}else{const t=n+" is more experienced now.";r.default.gameSuccess({msg:t,cell:e.getCell()})}s=!0}else s=!1}e.remove(t)})}}t.SystemExpPoints=i},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemFarming=void 0;const r=s(n(4)),a=n(14),o=n(167),i=n(12);class l extends a.SystemBase{constructor(e,t){super(r.default.SYS.FARMING,e,t),this.compTypesAny=!0}updateEntity(e){if(e.has("WorldSimEvent")){e.getList("WorldSimEvent").forEach(t=>{t.getEventType()===o.WS_EVENT.PHASE_CHANGED&&this._processPhaseChanged(e)})}}_processPhaseChanged(e){const t=e.getLevel();if(!t)return;t.getElements().slice().forEach(e=>{if(e.has("PlantedSoil")){const n=e.get("PlantedSoil");if(n.timeLeftToGrow-=1,0===n.timeLeftToGrow){const s=i.ObjectShell.getParser(),a=n.getGrowsInto(),o=s.createItem(a),[l,c]=e.getXY();t.addItem(o,l,c);const u=a+" is ready for harvesting";r.default.gameMsg({cell:e.getCell(),msg:u}),t.removeElement(e,l,c)}}})}}t.SystemFarming=l},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemHunger=void 0;const i=o(n(4)),l=n(14),c=a(n(11));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.HUNGER,e,t)}updateEntity(e){const t=e.get("Hunger"),n=e.get("Action");if(t.decrEnergy(n.getEnergy()),n.resetEnergy(),t.isStarving()&&e.has("Health")&&i.default.isSuccess(i.default.HUNGER_PROB)){const t=new c.Damage(i.default.HUNGER_DMG,i.default.DMG.HUNGER);e.add(t),i.default.gameWarn(e.getName()+" is starving!")}}}t.SystemHunger=u},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemMissile=void 0;const i=o(n(4)),l=n(14),c=a(n(11));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.MISSILE,e,t),this.criticalShot=i.default.MISSILE_CRITICAL_SHOT}updateEntity(e){const t=e.get("Missile"),n=t.getSource(),s=t.getLevel().getMap(),r=t.getTargetX(),a=t.getTargetY();let o=null;s.hasXY(r,a)&&(o=s.getCell(r,a));const c=this._formatFiredMsg(e,n);if(o&&o.hasProp("actors")){const e=o.getSentientActors()[0];n.getBrain().getMemory().setLastAttacked(e)}for(;t.isFlying()&&!t.inTarget()&&t.hasRange();){t.next();const r=t.getX(),a=t.getY(),o=t.getZ();let u=null;s.hasXY(r,a)&&(u=s.getCell(r,a));let h="";if(u)if(u.hasActors()||u.isPassableByAir(o))if(u.hasProp("actors")&&u.getZ()===o){const s=u.getActors()[0];if(this.targetWasHit(e,s,t)){this.finishMissileFlight(e,t,u),"function"==typeof t.onHit&&t.onHit(s),this._applyAddOnHitComp(n,e,s,!0);const r=this._addDamageToActor(e,s,t);i.default.debug(this,"Hit an actor"),h=`${c} ${r} ${s.getName()}`,s.has("Experience")&&("missile"===e.getType()?l.SystemBase.addSkillsExp(n,i.default.SKILLS.THROWING,1):"ammo"===e.getType()&&l.SystemBase.addSkillsExp(n,i.default.SKILLS.ARCHERY,1)),i.default.gameWarn({cell:u,msg:h}),h=""}else if(t.inTarget()){this.finishMissileFlight(e,t,u),i.default.debug(this,"In target cell, and missed an entity");const n=u.getFirstActor();if(n){h=c+" misses "+n.getName()}else h=c+" misses the target"}else t.hasRange()||(this.finishMissileFlight(e,t,u),i.default.debug(this,"Missile out of range. Missed entity."),h=e.getName()+" does not reach the target")}else if(t.inTarget())this.finishMissileFlight(e,t,u),i.default.debug(this,"In target cell but no hits"),h=e.getName()+" doesn't hit anything";else if(t.hasRange()){if(u.hasProp("actors")&&u.getZ()<o){const t=u.getActors()[0];h=e.getName()+" flies over "+t.getName()}}else this.finishMissileFlight(e,t,u),i.default.debug(this,"Missile out of range. Hit nothing."),h=e.getName()+" doesn't hit anything";else{t.prev();const n=t.getX(),r=t.getY(),a=s.getCell(n,r);this.finishMissileFlight(e,t,a),i.default.debug(this,"Stopped missile to wall"),h=c+" thuds to an obstacle"}else{t.prev();const n=t.getX(),r=t.getY(),a=s.getCell(n,r);this.finishMissileFlight(e,t,a),h=c+" disappears"}h.length>0&&i.default.gameMsg({cell:u,msg:h})}}_addDamageToActor(e,t,n){let s="hits";const r=n.getDamage(),a=new c.Damage(r,i.default.DMG.MISSILE),o=n.getSource();a.setSource(o);let l=n.getDamage();return o.has("CriticalShot")&&i.default.isSuccess(this.criticalShot)&&(l*=2,s="critically hits"),this._applyAddOnHitComp(o,e,t,!0),a.setDamage(l),t.add(a),s}finishMissileFlight(e,t,n){t.stopMissile(),e.remove(t);const s=t.getLevel();let r=!0;if(t.destroyItem||(r=!1,e.has("Indestructible")||(t.destroyItem=this._isItemDestroyed(e))),t.destroyItem){if(!r){const t=e.getName()+" is destroyed!";i.default.gameMsg({cell:n,msg:t})}}else{let t=!1;if(n.hasItems()){n.getItems().forEach(n=>{t||(t=i.default.addStackedItems(n,e))})}t||s.addItem(e,n.getX(),n.getY())}const a={missile:t,item:e,to:[n.getX(),n.getY()],level:s},o=new c.Animation(a);e.add(o)}_isItemDestroyed(e){const t=e.getName(),n=this.rng.getUniform();return e.has("Ammo")?/(magic|ruby|permaice)/i.test(t)?n>.95:/(iron|steel)/i.test(t)?n>.9:n>.85:/rock/i.test(t)?n>.95:/(magic|ruby|permaice)/i.test(t)?n>.97:n>.95}_formatFiredMsg(e,t){let n="thrown";return e.has("Ammo")&&(n="shot"),`${e.getName()} ${n} by ${t.getName()}`}targetWasHit(e,t,n){if(t.has("Ethereal"))return!1;const s=n.getSource();if(s.has("ThroughShot")&&!n.inTarget())return!1;const r="missile"===e.getType();let a=n.getAttack();a+=r?i.default.getSkillLevel(s,i.default.SKILLS.THROWING):i.default.getSkillLevel(s,i.default.SKILLS.ARCHERY);let o=t.getDefense();o+=i.default.getSkillLevel(t,i.default.SKILLS.DODGE);let c=a/(a+o);if(!s.isEnemy(t)&&!n.inTarget()){c=.15;const[e,n]=i.default.dXdYAbs(s,t);e<=1&&n<=1&&(c=0)}if(i.default.isSuccess(c)){if(t.has("RangedEvasion"))return i.default.isSuccess(.5);if(t.has("Deflection")){const n=`${t.getName()} deflects ${e.getName()}!`;return i.default.gameMsg({cell:t.getCell(),msg:n}),!1}return!0}return l.SystemBase.addSkillsExp(t,i.default.SKILLS.DODGE,1),!1}_applyAddOnHitComp(e,t,n,s=!0){const r=e.getMissileWeapon();if(t&&t.has("AddOnHit")){const r=t.get("AddOnHit");if(r.getOnAttackHit()===s){const t=r.getCompToAdd();l.SystemBase.addCompToEntAfterHit(t,n,e)}}if(r&&r.has){if(r.has("AddOnHit")){const t=r.get("AddOnHit");if(t.getOnAttackHit()===s){const s=t.getCompToAdd();l.SystemBase.addCompToEntAfterHit(s,n,e)}}}else if(r&&r.onAttackHit){const t=e;r.onAttackHit(n,t)}else{const t=e;if(t&&t.has("AddOnHit")){const e=t.get("AddOnHit");if(e.getOnAttackHit()===s){const s=e.getCompToAdd();l.SystemBase.addCompToEntAfterHit(s,n,t)}}}}}t.SystemMissile=u},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemMovement=void 0;const i=o(n(4)),l=n(14),c=a(n(11)),u=n(18),h=n(57),d=n(137),p=n(57),f=n(15)("bitn:System.Movement"),{addSkillsExp:m}=l.SystemBase,g={"light snow":u.ELEM.SNOW_LIGHT_TRACKS,snow:u.ELEM.SNOW_TRACKS,"deep snow":u.ELEM.SNOW_DEEP_TRACKS},y={"deep snow":"snow","deep snow with tracks":"snow","light snow":"snow","light snow with tracks":"snow","snow with tracks":"snow"};class v extends l.SystemBase{constructor(e,t){super(i.default.SYS.MOVEMENT,e,t),this.somethingSpecial=["QuestTarget"],this.climbRe=/highrock/,this._bonuses={}}checkMessageEmits(e,t,n){if(n.hasProp(i.default.TYPE_ELEM)){if(n.hasStairs()){const e=n.getStairs().getTargetLevel();let t="You see stairs here";if(e.getParent()){t+=". They seem to be leading to "+i.default.formatLocationName(e)}i.default.gameMsg(t)}else if(n.hasPassage()){const e=n.getPassage().getTargetLevel();let t=`You see a passage to ${i.default.getCardinalDirection(e,n)} here.`;if(e.getParent()){t+=". It seems to be leading to "+i.default.formatLocationName(e)}i.default.gameMsg(t)}else if(n.hasConnection()){const e=n.getConnection().getTargetLevel();let t="You see an entrance here";if(e.getParent()){t+=". It seems to be leading to "+i.default.formatLocationName(e)}i.default.gameMsg(t)}if(n.hasPropType("lever")&&i.default.gameMsg("There is a lever on the floor"),!t.hasShop()&&n.hasShop()){if(n.getShop().isAbandoned())i.default.gameMsg("This shop seems to be abandoned");else{const e="You can drop items to sell them here.";i.default.gameMsg("You have entered a shop. "+e)}}else if(n.hasShop()){n.getShop().isAbandoned()}n.getElements().forEach(t=>{t.has("Callbacks")&&_("onEnter",t,e),t.hasMsg("onEnter")&&i.default.gameMsg(t.getMsg("onEnter"))})}if(n.hasItems()){const e=n.getItems(),t=e[0];let s=t.getName();t.getCount()>1&&(s=`${s} (x${t.getCount()})`),e.length>1?i.default.gameMsg(`There are several items here. You see ${s} on top`):i.default.gameMsg("You see "+s+" on the floor"),t.has("Unpaid")&&(t.getCount()>1?i.default.gameMsg("They are for sale"):i.default.gameMsg("It is for sale"));for(let t=0;t<e.length;t++)if(e[t].hasAny(this.somethingSpecial)){const n=e[t].getName();i.default.gameMsg("There is something special about "+n)}}const s=n.getBaseElem();s.hasMsg("onEnter")&&i.default.gameMsg(s.getMsg("onEnter"))}updateEntity(e){const t=e.get("Movement"),n=e.get("Location");n||i.default.err("SystemMovement","updateEntity","Entity without Location cannot be moved");const[s,r]=t.getXY(),a=t.getLevel().getMap();if(!a.hasXY(s,r)){let t=`Tried to move to ${s},${r}.`;t+=" Entity: "+i.default.getName(e),i.default.warn("System.Movement","updateEntity",t)}const o=a.getCell(s,r),l=n.getCell();let c=o.isFree(e.has("Flying"));const u=l.getBaseElem(),h=o.getBaseElem();if(Math.abs(h.getZ()-u.getZ())>1&&(e.has("Flying")||(c=!1)),c||(c=this._checkSpecialMovement(t,e,o)),c){const t=e.getXY();f.enabled&&i.default.debug(this,"Trying to move ent from "+t);const n=e.getPropType();if(a.moveProp(t,[s,r],n,e)){e.setXY(s,r),this.checkForStatsMods(e,l,o),e.isPlayer&&e.isPlayer()&&this.checkMessageEmits(e,l,o),o.hasElements()&&(e.isPlayer&&e.isPlayer()&&o.hasPropType("exploration")&&this._processExploreElem(e,o),this._checkEntrapment(e,o));const t=l.getBaseElem();if(t.has("Snowy")){const e=t.getType();g[e]&&l.setBaseElem(g[e])}}else this._fatalMoveError(e)}else e.get("Action").setStatus(i.default.ACTION_FAILED),i.default.debug(this,"Cell wasn't free at "+s+", "+r);e.remove(t),e.has("Movement")&&i.default.err("SystemMovement","updateEntity",`Ent ${e.getName()} has still MoveComp after one move`)}checkForStatsMods(e,t,n){const s=n.getBaseElem(),r=t.getBaseElem();let[a,o]=[r.getType(),s.getType()];y[a]&&(a=y[a]),y[o]&&(o=y[o]);const i=s.getName(),l=r.getName();if(r.has("Callbacks")&&_("onLeave",r,e),s.has("Callbacks")&&_("onEnter",s,e),l===i)return;let u=null;if(this._bonuses.hasOwnProperty(a)?u=this._bonuses[a]:r.has("Terrain")&&(u=r.get("Terrain").getMods(),u.mods=u),u&&p.removeStatsModsOnLeave(e,a),u=null,this._bonuses.hasOwnProperty(o)?u=this._bonuses[o]:s.has("Terrain")&&(u=s.get("Terrain").getMods(),u.mods=u),u){let t=!0;u.dontApplyTo&&u.dontApplyTo.forEach(n=>{e.has(n)&&(t=!1)}),t&&u.mods.forEach(t=>{let n=!0;if(t.dontApplyTo&&t.dontApplyTo.forEach(t=>{e.has(t)&&(n=!1)}),n)if(Number.isInteger(t.value)){const n=c.create(t.targetComp);n[t.targetFunc](t.value),n.setTag(o),e.add(n)}else{const n=e.get(t.srcComp);if(n){let s=n[t.srcFunc]();s=Math.round(t.value*s);const r=c.create(t.targetComp);r[t.targetFunc](s),r.setTag(o),e.add(r)}}})}}_checkSpecialMovement(e,t,n){const s=n.getBaseElem().getType();if(this.climbRe.test(s)&&t.has("Climber")){const e=t.getName()+" climbs the rocky terrain";return i.default.gameMsg({cell:n,msg:e}),!0}if(e.getDisplace()){const s=e.getActor();if(s||i.default.err("SystemMovement","_checkSpecialMovement","No target actor for displace"),n.hasActors()){return n.getActors().findIndex(e=>e.getID()===s.getID()&&e.has("Movement")&&e.get("Movement").getDisplace())>=0}{const e=t.get("Location").getCell().getActors();if(e)return e.findIndex(e=>e.getID()===s.getID())>=0}}return!1}_processExploreElem(e,t){const n=e.getLevel(),[s,r]=[t.getX(),t.getY()],a=t.getPropType("exploration")[0];if(n.removeElement(a,s,r)){const s=a.getExp(),r=new c.ExpPoints(s);e.add(r);const o=n.get("Place");if(m(e,i.default.SKILLS.EXPLORATION,o.getDepth()+1),a.hasData()){const t=a.getData();t.zoneType&&e.get("GameInfo").addZoneType(t.zoneType)}const l=n.getParent();l&&e.get("GameInfo").addZone(l.getID());let u=a.getMsg("onEnter");if(u&&0!==u.length||(u=e.getName()+" has explored zone thoroughly."),i.default.gameInfo({cell:t,msg:u}),e.isPlayer()){e.getBrain().addMark()}h.emitZoneEvent(n,i.default.ZONE_EVT.ZONE_EXPLORED,{})}}_checkEntrapment(e,t){const n=t.getElements();n&&(e.has("Ethereal")||n.forEach(n=>{if(n.has("Entrapping")&&!e.has("Entrapped")){const s=n.get("Entrapping").getDifficulty(),r=e.getStrength(),a=e.getAgility(),o=(r+a)/(r+a+s);if(i.default.isSuccess(o)){let s=e.getName()+" avoids getting trapped";s+=` by ${n.getName()}!`,i.default.gameMsg({cell:t,msg:s})}else{e.add(new c.Entrapped);let s=e.getName()+" becomes trapped";s+=` by ${n.getName()}!`,i.default.gameMsg({cell:t,msg:s})}}}))}_fatalMoveError(e){const[t,n]=e.getXY(),s=e.getLevel().getMap(),r=t+", "+n;this._diagnoseRemovePropError(t,n,s,e),e.has("Dead")&&console.log("WoW! Trying to move a Dead entity!"),i.default.err("MovementSystem","moveActorTo",`Couldn't remove ent |${e.getName()}, ID: ${e.getID()}| @ ${r}`)}_diagnoseRemovePropError(e,t,n,s){const r=s.getPropType();let a=-1,o=-1;for(let e=0;e<n.cols;e++)for(let t=0;t<n.rows;t++)n.removeProp(e,t,r,s)&&(a=e,o=t);const l=n.getCell(e,t);i.default.diag(`Cell at ${e},${t}:`),i.default.diag(l);const c=s.getCell();i.default.diag("Cell of the entity:"),i.default.diag(c),i.default.diag("System.Movement: diagnoseRemovePropError:");const u=s.getName();if(a>=0&&o>=0){const n=`\tEnt |${u}| found from |${`${a},${o} instead of ${e},${t}.`}|`;i.default.diag(n)}else{const e=`\tNo ent |${u}| found on entire map.`;i.default.diag(e)}}}t.SystemMovement=v;const b=new d.ObjectShellComps({debug:!1});function _(e,t,n){const s=t.get("Callbacks").cb(e);s&&(s.addComp&&b.addComponents(s,n),s.showMsg&&i.default.gameMsg(s.showMsg.msg))}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemShop=void 0;const i=o(n(4)),l=n(14),c=a(n(39)),u=a(n(11)),{addSkillsExp:h}=l.SystemBase;class d extends l.SystemBase{constructor(e,t){super(i.default.SYS.SHOP,e,t)}updateEntity(e){e.getList("Transaction").forEach(t=>{const n=t.getArgs(),{buyer:s}=n;this._checkTransArgsOK(e,n),s.getID()===e.getID()?this.buyItem(n):this.sellItem(n),e.remove(t)})}_checkTransArgsOK(e,t){const{item:n,buyer:s,shop:r,seller:a}=t;let o="";n||(o+="Item is null/undef. "),s||(o+="Buyer is null/undef. "),a||(o+="Seller is null/undef. "),r||(o+="Shop (element) is null/undef. "),""!==o&&(o+="Entity: "+e.getName(),i.default.err("System.Shop","_checkTransArgsOK",o))}buyItem(e){const{item:t,buyer:n,shop:s,seller:r}=e,a=n.getCell(),o=i.default.getSkillLevel(n,i.default.SKILLS.TRADING),l=(100-2*o)/100,u=t.getValue()*s.getCostFactorSell()*l,d=i.default.valueToGoldWeight(u),p=i.default.getGoldInCoins(d);if(i.default.hasEnoughGold(n,d)){const l=new c.GoldCoin(i.default.GOLD_COIN_NAME),u=i.default.removeNCoins(n,p);if(l.setCount(u),!n.getInvEq().canCarryItem(t)){n.getInvEq().addItem(l);const t=n.getName()+" cannot carry more weight";return i.default.gameMsg({cell:n.getCell(),msg:t}),void(e.callback&&e.callback({msg:t,result:!1}))}r.getInvEq().addItem(l);if(r.getLevel().removeItem(t,s.getX(),s.getY())){n.getInvEq().addItem(t),t.remove("Unpaid");const s=n.getName()+" bought "+t.getName()+" for "+p+" coins.";i.default.gameMsg({cell:a,msg:s}),e.callback&&e.callback({msg:s,result:!0}),u>=o&&h(n,i.default.SKILLS.TRADING,1)}else i.default.err("System.Shop","buyItem","Could not remove item from level")}else{const s=n.getName()+" doesn't have enough money to buy "+t.getName()+" for "+p+" coins.";i.default.gameMsg({cell:a,msg:s}),e.callback&&e.callback({msg:s,result:!1})}}sellItem(e){const{item:t,buyer:n,seller:s,shop:r}=e;if(s||i.default.err("System.Shop","sellItem","Seller is null or undefined."),!this.willingToBuyItem(t,n)){let r=t.getName();t.getCount()>1&&(r=i.default.pluralize(r));const a=`${n.getName()} is not interested in ${r}.`;return i.default.gameMsg({cell:s.getCell(),msg:a}),void(e.callback&&e.callback({msg:a,result:!1}))}const a=e.count||1,o=i.default.getSkillLevel(s,i.default.SKILLS.TRADING),l=(100+2*o)/100,d=s.getCell(),p=a*t.getValue()*r.getCostFactorBuy()*l,f=i.default.valueToGoldWeight(p),m=i.default.getGoldInCoins(f);if(i.default.hasEnoughGold(n,f)){if(s.getInvEq().dropNItems(t,a)){const r=new c.GoldCoin(i.default.GOLD_COIN_NAME),a=i.default.removeNCoins(n,m);r.setCount(a),s.getInvEq().addItem(r);const l=s.getCell().getItems(),p=l[l.length-1];p.add(new u.Unpaid);const f=p.getName();if(i.default.gameMsg({cell:d,msg:s.getName()+" sold "+f+" for "+m+" coins."}),e.callback){const n=t.getName()+" was sold.";e.callback({msg:n,result:!0})}a>=o&&h(s,"Trading",1)}}else{const t=n.getName()+" doesn't have enough gold to buy it";i.default.gameMsg({cell:n.getCell(),msg:t}),e.callback&&e.callback({msg:t,result:!1})}}willingToBuyItem(e,t){return e.getName()!==i.default.GOLD_COIN_NAME}}t.SystemShop=d},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemSkills=void 0;const i=o(n(4)),l=n(14),c=a(n(11));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.SKILLS,e,t)}updateEntity(e){const t=e.getList("SkillsExp"),n=e.get("Skills"),s=e.getCell();t.forEach(t=>{const r=t.getSkill();n.hasSkill(r)||(n.addSkill(r),i.default.gameSuccess({cell:s,msg:`${e.getName()} learns a skill ${r}`}));const a=t.getPoints();n.addPoints(r,a);const o=n.getPoints(r),l=n.getLevel(r);if(o>=10*l){const t=e.getName();n.setLevel(r,l+1),n.resetPoints(r),i.default.gameSuccess({cell:s,msg:`${t} advances a skill ${r}`});const a=new c.ExpPoints(10*l);e.add(a),i.default.gameSuccess({cell:s,msg:`${t} gains experience from skill ${r}`})}e.remove(t)})}}t.SystemSkills=u},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemSpellCast=void 0;const r=s(n(4)),a=n(14),o=n(19),i=n(57),{addSkillsExp:l}=a.SystemBase;class c extends a.SystemBase{constructor(e,t){super(r.default.SYS.SPELL_CAST,e,t),this.compTypesAny=!0}updateEntity(e){const t=e.getName(),n=e.getCell();if(e.has("SpellPower")&&e.has("SpellCast")){const s=e.get("SpellCast"),a=e.get("SpellPower"),o=s.getSpell();if(o.getCastingPower()<=a.getPP()){const t=Object.values(this.entities).filter(e=>e.has("PowerDrain")),c=s.getArgs();if(a.decrPP(o.getCastingPower()),e.has("Regeneration")&&i.addRegenEffects(e),0===t.length)o.cast(c),l(e,"SpellCasting",1);else if(this._checkPowerDrain(o,c,t)){let e=`Spell ${o.getName()} was canceled by power drain of`;e+=" "+this._drainerName,r.default.gameMsg({cell:n,msg:e})}else o.cast(c),l(e,"SpellCasting",1)}else{const e=t+" has no enough power to cast spell";r.default.gameMsg({cell:n,msg:e})}e.remove("SpellCast")}}_checkPowerDrain(e,t,n){let s=!1;const r=t.src.getX(),a=t.src.getY();return this._drainerName="",n.forEach(n=>{if(n.getLevel().getID()===t.src.getLevel().getID()){const i=n.getX(),l=n.getY(),c=o.Path.shortestDist(r,a,i,l);if(n.getID()!==t.src.getID()&&c<=n.get("PowerDrain").drainDist){if(n.remove("PowerDrain"),s=!0,this._drainerName=n.getName(),n.has("SpellPower")){const t=e.getCastingPower();n.get("SpellPower").addPP(t)}return}}}),s}}t.SystemSpellCast=c},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemSpellEffect=void 0;const i=o(n(4)),l=n(14),c=a(n(11)),u=n(12),h=n(13),{addSkillsExp:d}=l.SystemBase,p=["SpellRay","SpellCell","SpellMissile","SpellArea","SpellSelf","SpellWave"];class f extends l.SystemBase{constructor(e,t){super(i.default.SYS.SPELL_EFFECT,e,t),this.compTypesAny=!0,this._dtable={SpellRay:this.processSpellRay.bind(this),SpellCell:this.processSpellCell.bind(this),SpellMissile:this.processSpellMissile.bind(this),SpellArea:this.processSpellArea.bind(this),SpellSelf:this.processSpellSelf.bind(this),SpellWave:this.processSpellWave.bind(this)},p.length!==Object.keys(this._dtable).length&&i.default.err("SystemSpellEffect","constructor","spellEffects and dtable keys length does not match")}updateEntity(e){p.forEach(t=>{if(e.has(t)){e.getList(t).forEach(n=>{this._dtable[t](e,n),e.remove(n)})}})}processSpellRay(e,t){const n=t.getArgs();let s=null;if(!i.default.isActor(e)){const t=JSON.stringify(e);return void i.default.err("SystemSpellEffect","processSpellRay","RayComps only supported on actors. Got: "+t)}s=e;const r=s.getLevel().getMap(),a=n.spell,o=a.getName();if(!n.from||!n.dir)return void i.default.err("SystemSpellEffect","processSpellRay","Args must have from and dir. Got "+JSON.stringify(n));let[l,u]=n.from;const[h,d]=n.dir;let p=a.getRange(),f=0;for(;p>0;)if(l+=h,u+=d,r.hasXY(l,u)){const e=r.getCell(l,u);if(a.onCellCallback&&a.onCellCallback(e),e.hasActors()){const t=e.getActors()[0],s=t.getName(),r=t.has("SpellStop");r||this.rayHitsActor(t,p)?(this._addDamageToActor(t,n),r?(p=0,i.default.gameMsg({cell:e,msg:`${o} is stopped by ${s}`})):a.stopOnHit&&(p=0),i.default.gameMsg({cell:e,msg:`${o} hits ${s}`})):i.default.gameMsg({cell:e,msg:`${o} misses ${s}`})}e.isSpellPassable()?++f:p=0,--p}else p=0;const m={dir:n.dir,ray:!0,from:n.from,range:f,className:i.default.getDmgClassName(n.damageType),level:s.getLevel()},g=new c.Animation(m);e.add(g)}rayHitsActor(e,t){if(!e.has("Health"))return!1;let n=e.get("Stats").getAgility();e.has("Skills")&&(n+=e.get("Skills").getLevel("Dodge")),n-=t,n<0&&(n=0);const s=(100-n)/100;return i.default.isSuccess(s)?!e.has("RangedEvasion")||i.default.isSuccess(.5):(d(e,"Dodge",1),!1)}processSpellCell(e,t){const n=t.getArgs(),s=i.default.toActor(e).getLevel().getMap(),r=n.spell.getName(),a=n.dir[0],o=n.dir[1],l=n.from[0]+a,u=n.from[1]+o;if(s.hasXY(l,u)){const t=s.getCell(l,u);if(n.preCallback&&n.preCallback(t),n.callback)n.callback(t);else if(t.hasActors()){const e=t.getActors()[0];if(n.targetComp){const s=n.set,a=n.get;if(e.has(n.targetComp)){const o=e.get(n.targetComp),l=e.getName();a?o[s](o[a()]+n.value):o[s](n.value),i.default.gameMsg({cell:t,msg:`Spell ${r} is cast on ${l}`})}}else if(n.addComp){const t=n.addComp.comp;if(t)if(n.addComp.duration){const s=n.addComp.duration;if(e.has("Expiration"))e.get("Expiration").addEffect(t,s);else{const n=new c.Expiration;n.addEffect(t,s),e.add(n)}e.add(t)}else e.add(t);else{const e=JSON.stringify(n);i.default.err("SystemSpellEffect","processSpellCell","args.addComp.comp must be defined. Args: "+e)}const s=t.getType(),r=`${e.getName()} seems to have ${s}`;i.default.gameMsg({cell:e.getCell(),msg:r})}else n.removeComp?n.removeComp.forEach(t=>{e.has(t)&&e.removeAll(t)}):(this._addDamageToActor(e,n),i.default.gameMsg({cell:t,msg:`${r} hits ${e.getName()}`}))}n.postCallback&&n.postCallback(t),m(e,n,[l,u])}}processSpellMissile(e,t){const n=t.getArgs(),s=n.spell,r=u.ObjectShell.getParser(),a=s.getAmmoName();a||i.default.err("System.SpellEffect","processSpellMissile","No |ammoName| set for spell "+s.getName());const o=r.createItem(a),l=new c.Missile(n.src);l.setTargetXYZ(n.to[0],n.to[1],n.to[2]),l.destroyItem=!0,n.hasOwnProperty("destroyItem")&&(l.destroyItem=n.destroyItem),l.setDamage(n.damage),l.setAttack(100),l.setRange(s.getRange()),n.onHit&&!t.onHit?l.onHit=n.onHit:t.onHit&&!n.onHit?l.onHit=t.onHit:t.onHit&&n.onHit&&i.default.err("SystemSpellEffect","processSpellMissile","onHit given in both SpellMissile and its args"),o.add(l)}processSpellArea(e,t){const n=t.getArgs(),s=n.spell,r=s.getRange(),[a,o]=[n.src.getX(),n.src.getY()],l=n.src.getLevel().getMap();h.Geometry.getBoxAround(a,o,r).forEach(e=>{if(l.hasXY(e[0],e[1])){const t=l.getCell(e[0],e[1]);if(t.hasActors()){const e=t.getActors();for(let r=0;r<e.length;r++){this._addDamageToActor(e[r],n),s.onCellCallback&&s.onCellCallback(t);const a=e[r].getName();i.default.gameMsg({cell:e[r].getCell(),msg:`${a} is hit by ${s.getName()}`})}}}});const u={range:r,cX:a,cY:o,className:i.default.getDmgClassName(n.damageType),level:i.default.toActor(e).getLevel()},d=new c.Animation(u);e.add(d)}processSpellSelf(e,t){const n=t.getArgs();if("function"==typeof n.callback)n.callback();else{let e="args.callback must be a function. ";e+="Got args: "+JSON.stringify(n),i.default.err("SystemSpellEffect","processSpellSelf",e)}m(e,n,e.getXY())}processSpellWave(e,t){const n=t.getArgs(),s=n.spell,r=u.ObjectShell.getParser(),a=s.getWaveActor();a||i.default.err("System.SpellEffect","processSpellWave","No |waveActor| set for spell "+s.getName()),console.log("processSpellWave entered with args",n);const o=s.getWaveWidth(),l=s.getWaveDepth(),c=s.getWaveSpeed(),[d,p,f]=n.from,[m,g,y]=n.to,v=e.get("Location").getLevel(),b=h.Geometry.lineFuncUnique3D(n.from,n.to);if(0===b.length){const t=s.getName()+" fizzles and fails!",n=e.get("Location");return void i.default.gameMsg({msg:t,cell:n.getCell()})}const _=Math.floor(o/2),E=Math.abs((g-p)/(m-d));for(let e=0;e<o;e++){const t=e-_;let n=0,s=0;E<=1?s=t:n=t;for(let e=0;e<l;e++){const t=r.createActor(a);if(t){t.get("Stats").setSpeed(c),t.getBrain().line=b.slice(2).map(e=>[e[0]+n,e[1]+s,e[2]]),t.getBrain().delay=e;const[r,a,o]=b[1];v.addActor(t,r+n,a+s)}}}}_addDamageToActor(e,t){const n=new c.Damage;i.default.isEntity(t.src)||i.default.err("SystemSpellEffect","_addDamageToActor","src must be entity. Got args "+JSON.stringify(t)),n.setSource(t.src),n.setDamageType(t.damageType),n.setDamage(t.damage),n.setDamageCateg(i.default.DMG.MAGIC),n.setWeapon(t.spell),e.add(n)}}function m(e,t,n){let s=i.default.getDmgClassName(t.damageType);s||(s=i.default.getDmgClassName(i.default.DMG.MAGIC));const r={cell:!0,coord:[n],className:s,level:e.getLevel()},a=new c.Animation(r);e.add(a)}t.SystemSpellEffect=f},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemSpiritBind=void 0;const i=o(n(4)),l=n(14),c=a(n(11));class u extends l.SystemBase{constructor(e,t){super(i.default.SYS.SPIRIT,e,t),this.compTypesAny=!0}updateEntity(e){e.has("SpiritBind")&&this._doSpiritBind(e)}_doSpiritBind(e){const t=e.get("SpiritBind"),n=t.getBinder(),s=n.getName(),r=t.getTarget();if(e.hasSpirit()){if(r.hasItems())if(n.has("SpiritItemCrafter")){const t=r.getItems()[0],a=t.getName();if(t.has("GemBound")){const e=a+" has already a gem bound to it.";i.default.gameMsg({cell:r,msg:e})}else{const o=new c.GemBound,l=n.getInvEq().removeAndGetItem(e);o.setGem(l),t.add(o);const u=`${e.getName()} was bound to ${a} by ${s}`;i.default.gameMsg({cell:r,msg:u})}}else{const e=s+" cannot bind gems to items.";i.default.gameMsg({cell:r,msg:e})}}else{const t=r.getPropType("spirit");if(t.length>0){const n=t[0];n.get("Action").disable();n.getLevel().removeActor(n),e.setSpirit(n);const a=`${n.getName()} was bound to gem by ${s}`;i.default.gameMsg({cell:r,msg:a})}else{const e="There are no spirits to capture there!";i.default.gameMsg({cell:r,msg:e})}}e.remove("SpiritBind")}}t.SystemSpiritBind=u},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemTimeEffects=void 0;const i=o(n(4)),l=n(14),c=a(n(11)),u=n(57);class h extends l.SystemBase{constructor(e,t){super(i.default.SYS.TIME_EFFECTS,e,t),this.compTypesAny=!0,this._dtable={},this._expiredEffects=[],this._dtable.Poison=this._applyPoison.bind(this),this._dtable.Fading=this._applyFading.bind(this),this._dtable.Heat=this._applyHeat.bind(this),this._dtable.Coldness=this._applyColdness.bind(this),this._dtable.DirectDamage=this._applyDirectDamage.bind(this),this._dtable.RegenEffect=this._applyRegenEffect.bind(this),this._dtable.Drowning=this._applyDrowningEffect.bind(this)}update(){for(const e in this.entities){if(!e)continue;const t=this.entities[e];for(let e=0;e<this.compTypes.length;e++)"Expiration"!==this.compTypes[e]&&t.has(this.compTypes[e])&&this._dtable[this.compTypes[e]](t);t.has("Expiration")&&this._decreaseDuration(t)}for(let e=0;e<this._expiredEffects.length;e++){const t=this._expiredEffects[e][0];this._expiredEffects[e][1].remove(t)}this._expiredEffects=[]}_decreaseDuration(e){e.getList("Expiration").forEach(t=>{t.decrDuration(),t.hasEffects()||this._expiredEffects.push([t.getID(),e])})}_applyPoison(e){e.getList("Poison").forEach(t=>{if(e.get("Health").isDead()){if(this._expiredEffects.push([t.getID(),e]),e.has("Expiration")){const n=e.get("Expiration");n.hasEffect(t)&&n.removeEffect(t)}}else if(i.default.isSuccess(t.getProb())){const n=t.rollDamage(),s=new c.Damage(n,i.default.DMG.POISON);s.setSource(t.getSource()),s.setDamageCateg(i.default.DMG.EFFECT),e.add(s)}})}_applyDirectDamage(e){e.getList("DirectDamage").forEach(t=>{if(e.get("Health").isDead()){if(this._expiredEffects.push([t.getID(),e]),e.has("Expiration")){const n=e.get("Expiration");n.hasEffect(t)&&n.removeEffect(t)}}else if(i.default.isSuccess(t.getProb())){const n=t.rollDamage(),s=new c.Damage(n,t.getDamageType());s.setDamageCateg(t.getDamageCateg()),s.setSource(t.getSource()),e.add(s);const r=t.getMsg();if(r){const t=e.get("Location").getCell();i.default.gameMsg({cell:t,msg:r})}}})}_applyFading(e){const t=e.get("Fading");if(t.decrDuration(),t.getDuration()<=0){const n=e.get("Location"),s=n.getCell(),r=n.getLevel();if(i.default.isActor(e))if(r.removeActor(e)){this.pool.emitEvent(i.default.EVT_ACTOR_KILLED,{actor:e});const t=e.getName()+" disappears.";i.default.gameMsg({cell:s,msg:t})}else{const t=JSON.stringify(e);i.default.err("System.TimeEffects","_applyFading","Could not remove actor from level: "+t)}else if(i.default.isElementXY(e)&&e.has("Location")){const[t,n]=e.getXY();if(r.removeElement(e,t,n)){const t=e.getName()+" disappears.";i.default.gameMsg({cell:s,msg:t})}else{const t=JSON.stringify(e);i.default.err("System.TimeEffects","_applyFading","Could not remove element from level: "+t)}}else if(i.default.isItem(e)){const t=e,[n,a]=t.getXY();if(r.removeItem(e,n,a)){const t=e.getName()+" disappears.";i.default.gameMsg({cell:s,msg:t})}else{const t=JSON.stringify(e);i.default.err("System.TimeEffects","_applyFading","Could not remove item from level: "+t)}}else i.default.err("System.TimeEffects","_applyFading","Fading not handled for non-actors|non-elems yet.");if(e.has("Callbacks")){const t=e.get("Callbacks");if(t.hasCb("onFadeout")){const n=t.cb("onFadeout"),s=Object.assign({level:r},n);u.executeCompCb(e,s)}}e.remove(t)}}_applyHeat(e){e.getList("Heat").forEach(t=>{const n=t.getLevel(),s=e.get("Location");if(e.has("Coldness")){const t=s.getCell();e.removeAll("Coldness");const n=`Thanks to heat, ${i.default.getName(e)} stops shivering`;if(e.has("BodyTemp")){e.get("BodyTemp").incr()}i.default.gameMsg({cell:t,msg:n})}if(e.has("Drenched")){const t=s.getCell(),r=e.get("Drenched");r.decrLevel(n);const a=i.default.getName(e)+" feels a bit drier due to warmth!";i.default.gameMsg({cell:t,msg:a}),r.isDry()&&e.remove(r)}}),e.removeAll("Heat")}_applyColdness(e){if(e.has("BodyTemp")){const t=e.get("BodyTemp");let n=1;if(e.has("Drenched")&&(n=Math.min(1,e.get("Drenched").getLevel())),t.decr(n),t.isFreezing()&&i.default.isSuccess(.1)){const t=new c.Damage(1,i.default.DMG.COLD);e.add(t)}if(t.isFrozen()){const t=new c.Damage(1,i.default.DMG.COLD);e.add(t)}}}_applyRegenEffect(e){e.getList("RegenEffect").forEach(t=>{let n=!0;if(t.getHP()>0){const s=t.getWaitHP();if(0===s){const s=e.get("Health");s&&(s.addHP(t.getHP()),s.getHP()<s.getMaxHP()&&(n=!1)),t.setWaitHP(t.getMaxWaitHP())}else t.setWaitHP(s-1),n=!1}if(t.getPP()>0){const s=t.getWaitPP();if(0===s){const s=e.get("SpellPower");s&&(s.addPP(t.getPP()),s.getPP()<s.getMaxPP()&&(n=!1)),t.setWaitPP(t.getMaxWaitPP())}else t.setWaitPP(s-1),n=!1}n&&e.remove(t)})}_applyDrowningEffect(e){e.get("Drowning");if(e.has("Health")){const t=5,n=new c.Damage(t,i.default.DMG.WATER);n.setDamageCateg(i.default.DMG.WATER),e.add(n)}}printMatchedType(e){for(let t=0;t<this.compTypes.length;t++)e.has(this.compTypes[t])&&i.default.debug(this.compTypes[t],"Has component")}}t.SystemTimeEffects=h},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemZoneEvents=void 0;const r=s(n(4)),a=n(14),o=n(48),i=n(119),l={NECROMANCER:1,ENCOUNTER:1};class c extends a.SystemBase{constructor(e,t){super(r.default.SYS.ZONE_EVENTS,e,t),this.legalArgs=["owMap","worldTop"],this._dtable={},this._dtable[r.default.ZONE_EVT.ZONE_EXPLORED]=this._processZoneExplored.bind(this),this._dtable[r.default.ZONE_EVT.BATTLE_OVER]=this._processBattleOver.bind(this),this._dtable[r.default.ZONE_EVT.QUEST_COMPLETED]=this._processQuestCompleted.bind(this),this._dtable[r.default.ZONE_EVT.CITY_WIPED]=this._processCityWipedOut.bind(this),this._dtable[r.default.ZONE_EVT.MOUNTAIN_CLIMBED]=this._processMountainClimbed.bind(this),this._dtable[r.default.ZONE_EVT.UNIQUE_KILLED]=this._processUniqueKilled.bind(this),this.zoneActionWeights=l}setWeights(e){this.zoneActionWeights=e}addEventProcessor(e,t){this._dtable[e]=t}updateEntity(e){e.getList("ZoneEvent").forEach(t=>{this._processEvent(e,t),e.remove(t)})}getAreaTile(e){const[t,n]=e.getTileXY();return this.worldTop.getCurrentArea().getTileXY(t,n)}getNewZoneAction(){return this.rng.getWeighted(this.zoneActionWeights)}_processEvent(e,t){const n=t.getEventType();if(this._dtable.hasOwnProperty(n))this._dtable[n](this,e,t);else{const e="Registered funcs: "+Object.keys(this._dtable).join(",");r.default.warn("SystemZoneEvents","_processEvent",`No callback function for evtType ${n}, ${e}`)}}_processZoneExplored(e,t,n){const s=t;u(e.getAreaTile(s).getLevel(),{name:"necromancer",levelUp:5})}_processBattleOver(e,t,n){const s=n.getEventData().battle,r=s.getLevel();u(r,{name:"necromancer",levelUp:5}),this._addBattleLore(r,s)}_processQuestCompleted(e,t,n){}_processCityWipedOut(e,t,n){}_processMountainClimbed(e,t,n){}_processUniqueKilled(e,t,n){}_addBattleLore(e,t){}}function u(e,t){const n=(new i.FactoryActor).createActorByName(t.name);if(n||r.default.err("system.zone-events.ts","addActorToLevel","Failed to create actor with "+JSON.stringify(t)),t.levelUp){const e=n.get("Experience").getExpLevel()+t.levelUp;r.default.levelUpActor(n,e)}return o.Placer.addEntityToCellType(n,e,e=>e.isFree())}t.SystemZoneEvents=c},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemWorldSim=void 0;const r=s(n(4)),a=n(14),o=n(167);class i extends a.SystemBase{constructor(e,t){super(r.default.SYS.WORLD_SIM,e,t),this.legalArgs=["owMap","worldSim","worldTop","territory"],this._dtable={},this._dtable[o.WS_EVENT.PHASE_CHANGED]=this._processPhaseChanged.bind(this),this._dtable[o.WS_EVENT.DAY_CHANGED]=this._processDayChanged.bind(this),this._dtable[o.WS_EVENT.MONTH_CHANGED]=this._processMonthChanged.bind(this),this._dtable[o.WS_EVENT.SEASON_CHANGED]=this._processSeasonChanged.bind(this),this._dtable[o.WS_EVENT.YEAR_CHANGED]=this._processYearChanged.bind(this),this.dayCount=0}updateEntity(e){e.getList("WorldSimEvent").forEach(t=>{this._checkEntityValid(e),this._processEvent(e,t),e.remove(t)})}_checkEntityValid(e){const t=r.default.getEntName(e);if(t!==r.default.WORLD_ENTITY){const e=t;r.default.err("System.WorldSim","updateEntity","Only actor WorldEntity can be added to System.WorldSim. Got: "+e)}}_processEvent(e,t){const n=t.getEventType();this._dtable.hasOwnProperty(n)&&this._dtable[n](e,t)}_processPhaseChanged(e,t){const n=t.getEventData();r.default.gameMsg(`It is ${n.currPhase} now.`)}_processDayChanged(e,t){}_processMonthChanged(e,t){}_processSeasonChanged(e,t){}_processYearChanged(e,t){}}t.SystemWorldSim=i},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemWeather=void 0;const i=o(n(4)),l=n(14),c=n(31),u=n(18),h=a(n(29)),d=["Coldness","Drenched"];class p extends l.SystemBase{constructor(e,t){super(i.default.SYS.WEATHER,e,t),this._effTable={snowStorm:this.handleSnowStorm=this.handleSnowStorm.bind(this),hailStorm:this.handleSnowStorm=this.handleSnowStorm.bind(this),snowFall:this.handleSnowFall=this.handleSnowFall.bind(this),warm:this.handleWarm=this.handleWarm.bind(this),rain:this.handleRain=this.handleRain.bind(this),coldRain:this.handleRain=this.handleRain.bind(this),"heavy rain":this.handleRain=this.handleRain.bind(this),clear:this.handleClear=this.handleClear.bind(this),sunny:this.handleClear=this.handleClear.bind(this),cloudy:this.handleClear=this.handleClear.bind(this)}}updateEntity(e){if(e.has("WeatherEffect")){const t=e.get("WeatherEffect"),n=t.getEffectType();this._effTable[n]&&(this._effTable[n](e,t),this.handleTemperature(e,t)),e.removeAll("WeatherEffect")}}handleTemperature(e,t){const n=i.default.getLevel(e),s=t.getTemperature(),r=t.getHumidity();n.getActors().forEach(e=>{if(e.has("Location")&&e.get("Location").isValid()){let t=s,n=r;const a=e.getCell().getBaseElem();if(a.has("Indoor")&&(t+=5,n=50,"floorhouse"===a.getName()&&(t+=15),s>=15?t=s:t>15&&(t=15)),t<-15){e.getList("Coldness").length<2&&e.add(new h.Coldness)}else t<0&&!e.has("Coldness")&&e.add(new h.Coldness);n<=50&&t>=15&&e.hasAny(d)&&e.add(new h.Heat)}})}handleSnowFall(e,t){this.handleSnowStorm(e,t)}handleClear(e,t){}handleSnowStorm(e,t){const n=i.default.getLevel(e);if(n){const e=n.getMap(),t=e.getFree().filter(e=>!e.getBaseElem().has("Snowy"));c.MapGenerator.addRandomSnow(e,.1,t)>5&&i.default.gameMsg("It is snowing heavily!")}else i.default.err("SystemWeather","handleSnowStorm","Null level for ent: "+JSON.stringify(e))}handleRain(e,t){const n=i.default.getLevel(e);n.getMap();n.getActors().forEach(e=>{if(!e.has("Ethereal")&&e.has("Location")&&e.get("Location").isValid()){if(!e.getCell().getBaseElem().has("Indoor")){if(!e.has("Drenched")){e.add(new h.Drenched);const t=e.getName()+" is drenched by the heavy rain!";i.default.gameInfo({cell:e.getCell(),msg:t})}e.get("Drenched").incrLevel()}}}),i.default.gameMsg("It is raining heavily outdoors")}handleWarm(e,t){this.handleMeltSnow(e,t)}handleMeltSnow(e,t){const n=e.getLevel().getMap().getFree().filter(e=>e.getBaseElem().has("Snowy"));n.forEach(e=>{if(this.rng.getUniform()<.1){const t=e.getBaseElem().getType(),n=u.snowMeltMap[t];e.setBaseElem(n)}}),n.length>0&&i.default.gameMsg("It is getting warmer. Snow and ice are melting")}}t.SystemWeather=p},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemOnCbs=void 0;const r=s(n(4)),a=n(14),o=n(57);class i extends a.SystemBase{constructor(e,t){super(r.default.SYS.ON_CBS,e,t),this.compTypesAny=!0,this.numRemoveComp={},this.numAddComp={}}updateEntity(e){let t=100;for(;e.has("OnAddCb");){const n=e.get("OnAddCb");if(this.processOnAddComp(e,n),e.remove(n),--t,0===t)break}for(t=100;e.has("OnRemoveCb");){const n=e.get("OnRemoveCb");if(this.processOnRemoveComp(e,n),e.remove(n),--t,0===t)break}}processOnAddComp(e,t){const n=t.getCompName();if(e.has("Callbacks")){const t=e.get("Callbacks"),s="onAdd"+n;if(t.hasCb(s)){let n=t.cb(s);if(n.triggerCb&&(n=t.cb(n.triggerCb),!n)){const e=t.cb(s).triggerCb;r.default.err("SystemOnCbs","processOnAddComp",`Could not find callback ${e} for triggerCb`)}o.executeCompCb(e,n)}}if(e.has("Location")){const t=e.get("Location");if(t.isValid()){const s=t.getCell();if(s){const t=s.getBaseElem();if(t.has("Callbacks")){const s=t.get("Callbacks"),r="onAdd"+n+"Entity";if(s.hasCb(r)){const t=s.cb(r);o.executeCompCb(e,t)}}}}}this.numAddComp[n]||(this.numAddComp[n]=0),this.numAddComp[n]+=1}processOnRemoveComp(e,t){const n=t.getCompName();if(e.has("Callbacks")){const t=e.get("Callbacks"),s="onRemove"+n;if(t.hasCb(s)){const n=t.cb(s);o.executeCompCb(e,n)}}if(e.has("Location")){const t=e.get("Location");if(t.isValid()){const s=t.getCell();if(s){const t=s.getBaseElem();if(t.has("Callbacks")){const s=t.get("Callbacks"),r="onRemove"+n+"Entity";if(s.hasCb(r)){const t=s.cb(r);o.executeCompCb(e,t)}}}}}this.numRemoveComp[n]||(this.numRemoveComp[n]=0),this.numRemoveComp[n]+=1}}t.SystemOnCbs=i},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SystemMining=void 0;const i=o(n(4)),l=n(14),c=a(n(12)),u=a(n(16)),h=a(n(11)),d=n(60),p=n(26),f=n(793);class m extends l.SystemBase{constructor(e,t){super(i.default.SYS.MINING,e,t),this.parser=c.getParser(),this.compTypesAny=!0}updateEntity(e){e.getList("Explosion").forEach(t=>{this.processExplosionComp(e,t),e.remove(t)});e.getList("Mining").forEach(t=>{this.processMiningComp(e,t),e.remove(t)})}processExplosionComp(e,t){const n=t.getForce();if(console.log("processExplosionComp for ent",i.default.getName(e)),e.has("Health")){const n=t.getDamage(),s=p.Dice.getValue(n),r=new h.Damage(s,i.default.DMG.EXPLOSION);r.setSource(t.getSource()),e.add(r);const a=e.get("Location").getCell(),o=`Explosion caused by ${i.default.getName(t.getSource())} hits ${i.default.getName(e)}!`;console.log(o),i.default.gameMsg({cell:a,msg:o})}else if(e.has("Physical")){e.get("Physical");const t=i.default.getMaterialHardness(e);if(e.has("Callbacks")){const t=e.get("Callbacks");if(t.hasCb("onAddExplosion")){const e=t.cb("onAddExplosion");if(e.removeEntity&&"self"===e.removeEntity.target)return}}if(t<=n&&e.has("Location")){const t=e.get("Location").getLevel(),[n,s]=e.get("Location").getXY(),r=e.get("Location").getCell();if(t.removeEntity(e,n,s)){const t=i.default.getName(e)+" is destroyed by explosion!";i.default.gameMsg({cell:r,msg:t})}}}else if(e.has("Breakable")){if(e.get("Breakable").getHardness()<=n){const t=e.get("Location").getLevel(),[n,s]=e.get("Location").getXY(),r=e.get("Location").getCell();if(t.removeEntity(e,n,s)){const t=i.default.getName(e)+" is destroyed by explosion!";i.default.gameMsg({cell:r,msg:t})}}}}processMiningComp(e,t){const n=e.get("Location").getLevel(),s=n.get("Place"),r=s.getDepth(),a=(s.getDanger(),t.getTarget()),o=t.getItem(),c=o.getName(),p=a.getBaseElem(),m=p.getName(),g=a.getElements();let y=p.getType();const v=f.Elem2Floor[y],b=i.default.getMaterialHardness(o),_=i.default.getSkillLevel(e,i.default.SKILLS.MINING);let E=!1,S=null;if(g&&g.length>0){g.forEach(e=>{!S&&e.has("Breakable")&&(S=e)});const t=S.get("Breakable"),s=S.getName(),r=t.getHardness();if(Math.round(r/2)<=b+_){let u=i.default.getItemDamage(o);const h=e;u+=i.default.strengthToDamage(h.getStatVal("Strength"));const d=t.getDurability()-u;if(d<=0)E=!0,n.removeElement(S,S.getX(),S.getY()),y=S.getType(),i.default.gameMsg(`${h.getName()} breaks ${s} with ${c}!`),r>_&&l.SystemBase.addSkillsExp(h,i.default.SKILLS.MINING,1),S.has("Callbacks")&&this._execCallbacks(S,n);else{t.setDurability(d);let e=`${h.getName()} damages ${s} with ${c}!`;e+=`(${d})`,i.default.gameMsg({cell:a,msg:e})}}else{const e=`${c} cannot be used to break ${S.getName()}`;i.default.gameMsg({cell:a,msg:e})}}else if(p.has("Breakable")){const t=p.get("Breakable"),s=t.getHardness();if(Math.round(s/2)<=b+_){v&&a.setBaseElem(v);let r=i.default.getItemDamage(o);const d=e;r+=i.default.strengthToDamage(d.getStatVal("Strength"));const f=t.getDurability()-r;if(f>0){const e=new u.ElementXY("Damaged "+y);e.setType(y);const t=new h.Breakable;if(t.setHardness(s),t.setDurability(f),e.add(t),p.has("Impassable")){const t=new h.Impassable;t.setAllImpassable(),e.add(t)}p.has("Opaque")&&e.add(new h.Opaque),n.addElement(e,a.getX(),a.getY());let r=`${d.getName()} damages ${m} with ${c}!`;r+=`(${f})`,i.default.gameMsg({cell:a,msg:r})}else E=!0,s>_&&l.SystemBase.addSkillsExp(d,i.default.SKILLS.MINING,1),i.default.gameMsg(`${d.getName()} breaks ${m} with ${c}!`),p.has("Callbacks")&&this._execCallbacks(p,n)}else i.default.gameMsg(`${c} cannot be used to break ${m}`)}if(!E)return;const w=f.Elem2Items[y];if(!w)return;w.always.forEach(e=>{const t=this.parser.createItem(e);t&&n.addItem(t,a.getX(),a.getY())});let C="";if(w.rand){const t={};if(Object.keys(w.rand).forEach(e=>{t[e]=w.rand[e]+r}),C=this.rng.getWeighted(t),""!==C&&"nothing"!==C){const t=this.parser.createItem(C);if(t){n.addItem(t,a.getX(),a.getY());let s=`${i.default.getName(e)} discovers ${t.getName()}`;s+=" while digging",i.default.gameMsg({cell:a,msg:s})}}}if((""===C||"nothing"===C)&&w.constraint){(new d.Constraints).getConstraints(w.constraint)}}_execCallbacks(e,t){const n=e.get("Callbacks");if(n.has("OnDestroy")){const s=n.cb("OnDestroy"),r=new h.Effects,a=Object.create({level:t},s);r.setArgs(a),e.add(r)}}}t.SystemMining=m},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GameManager=t.TopLogic=t.STATUS_COMPS_GUI=t.VIEW_PLAYER=t.VIEW_MAP=void 0;const i=o(n(4)),l=a(n(190)),c=n(25),u=n(127),h=n(412),d=n(157),p=n(803),f=n(413),m=n(805),g=n(103),y=n(807),v=n(832),b=n(833),_=n(242),E=n(26),S=n(117),w=n(12),C=n(47),O=n(375),T=n(834),M=n(15),A=n(835),{KeyMap:N}=c.Keys,x=(M("bitn:game-manager"),["game-board-player-view","game-board-player-view-l","game-board-player-view-xl","game-board-player-view-xxl","game-board-player-view-xxxl","game-board-map-view"]);t.VIEW_MAP=0,t.VIEW_PLAYER=1,t.STATUS_COMPS_GUI=[["Charm","success","Charming","stat-charm"],["Coldness","primary","Cold","stat-coldness"],["Drenched","primary","Drenched","stat-drenched"],["Drowning","primary","Drowning","stat-drowning"],["Ethereal","info","Ethereal","stat-ethereal"],["Entrapped","danger","Trapped","stat-trapped"],["Fear","danger","Afraid","stat-fear"],["Flying","primary","Flying","stat-flying"],["Paralysis","danger","Paralysed","stat-paralysis"],["Poison","danger","Poisoned","stat-poison"],["PowerDrain","success","Power drain","stat-power-drain"],["Stun","danger","Stunned","stat-stun"],["MindControl","danger","Mind controlled","stat-mind-ctrl"]];class P{static describeCell(e,t){if(-1!==t.indexOf(e))if(e.hasActors()){const t="You see "+e.getFirstActor().getName();i.default.gameMsg(t)}else if(e.hasItems()){const t=e.getItems();t.length>1?(i.default.gameMsg("There are several items there"),i.default.gameMsg("You see "+t[0].getName()+" on top")):i.default.gameMsg("You see "+t[0].getName()+" lying there.")}else if(e.hasPropType("door"))i.default.gameMsg("You see a door there.");else{const t=e.getBaseElem();i.default.gameMsg(`You see only ${t.getName()} there`)}else i.default.gameWarn("You cannot see there.")}static getAdjacentCell(e,t){if(N.inMoveCodeMap(t)||N.isRest(t)){const[n,s]=e.getXY(),r=N.getDiff(t,n,s);if(null!==r)return e.getLevel().getMap().getCell(r[0],r[1])}return null}}t.TopLogic=P;class I{constructor(e){this.hasNotify=!0,this.cbNotify=e}notify(e,t){this.cbNotify(e,t)}}t.GameManager=class{constructor(e){e||i.default.err("GameManager","constructor","no updateCb given (ie setState in react)"),this.updateCb=e,this.doGUICommand=this.doGUICommand.bind(this),this.isGUICommand=this.isGUICommand.bind(this),this.mainLoop=this.mainLoop.bind(this),this.boardClassName=x[2],this.notify=this.notify.bind(this),this.hasNotify=!0,this.listener=new I(this.notify),this.game=null,this.gameSave=new h.GameSave,this.pluginManager=new y.PluginManager,this.finishAutoOnSight=!0,this.finishAutoDist=3,this.resetGameState(),this.viewportPlayerX=35,this.viewportPlayerY=15,this.viewportX=35,this.viewportY=13,this.resetGameControls(),this.verifySaveData=!0,this.gameSave.setStorage(window.localStorage),this.savedPlayerList=this.gameSave.getPlayersAsList(),this.finishAutoOnSight=!0,this.finishAutoDist=3,this.gameConf=_.FactoryGame.getGameConf(),this.gameConf.world=v.WorldConf,this.handleKeyDown=this.handleKeyDown.bind(this)}resetGameControls(){this.frameID=null,this.multiHandler=new p.MultiKeyHandler,this.screen=new d.ScreenBuffered(this.viewportX,this.viewportY),this.keyPending=!1,this.keysEnabled=!1,this.autoModeKeyBuffer=[],this.ctrlMode="MANUAL",this.recordedCommands=[]}setGameSettings(e,t){this.gameConf[e]=t}isGameValid(){return!!this.game}getPlayer(){return this.game.getPlayer()}getFocusedXY(){const e=this.game.getPlayer();return e&&(this.focusXY=e.getXY()),this.focusXY}setPlayerDriver(){const e=this.game.getPlayer();this.playerDriver=new f.PlayerDriver(e,this.game),e.remove("Hunger"),this.setAutoModeNoFinish()}setAutoMode(){this.ctrlMode="AUTOMATIC"}setAutoModeNoFinish(){this.ctrlMode="AUTOMATIC",this.finishAutoOnSight=!1}getMap(){return this.game.getVisibleMap()}renderScreen(){const e=this.game.getVisibleMap(),[t,n]=this.getFocusedXY();e&&this.screen.renderWithRLE(t,n,e,this.gameGUIState.visibleCells,this.animation)}resetGameState(){this.gameGUIState={autoTarget:!1,visibleCells:[],useModeEnabled:!1,isTargeting:!1,targetInRange:!1,enemyCells:[],numCurrCell:0}}guiState(e,t){return t?(console.log("guiState setting value",e,"to",t),this.gameGUIState[e]=t,this.gameGUIState[e]):this.gameGUIState[e]}setGUICommands(e){this.guiCommands=e}canUseWorker(){return void 0!==window.Worker&&!this.pluginManager.anyPluginsEnabled()}getPlugins(){return this.pluginManager.getPlugins()}isGUICommand(e){return!!this.gameGUIState&&((!this.gameGUIState.autoTarget||e!==c.Keys.VK.t)&&(!!this.gameGUIState.useModeEnabled||this.guiCommands.hasOwnProperty(e)))}cancelAnim(){this.frameID&&cancelAnimationFrame(this.frameID)}restartMainLoop(){this.cancelAnim(),this.frameID=requestAnimationFrame(this.mainLoop)}setPlayerName(e){this.gameConf.playerName=e}getScreen(){return this.screen}getPlayersAsList(){return this.gameSave.getPlayersAsList()}enableKeys(){this.keysEnabled||(document.addEventListener("keypress",this.handleKeyDown,!0),this.keysEnabled=!0)}getRecordedCommands(){return this.recordedCommands}disableKeys(){this.keysEnabled&&(document.removeEventListener("keypress",this.handleKeyDown,!0),this.keysEnabled=!1)}isValidKey(e){return c.Keys.isValidKey(e)||!!this.guiCommands[e]||c.Keys.isNumeric(e)}handleKeyDown(e){e.stopPropagation(),e.preventDefault();const t=S.KeyCode.getKeyCode(e);if(!1===this.keyPending&&(this.keyPending=!0,this.nextCode=t,this.isGUICommand(t)||(this.gameGUIState.isTargeting=!1),c.Keys.KeyMap.isMultiPurpose(t))){const e=this.game.getPlayer(),t=this.multiHandler.getKeys(e);t&&t.length>0&&(this.playerDriver=new b.CellClickHandler(null,this.game),this.playerDriver.setKeys(t),this.playerDriver.hasKeys()&&this.setAutoMode())}}saveGame(e){if(this.game){const t=this.game.getPlayer().getName(),n=new O.Persist(t);this.gameToJSON().then(t=>{this.verifySaveData&&C.verifySaveData(t),n.toStorage(t,()=>{this.gameSave.save(this.game,this.gameConf),this.savedPlayerList=this.gameSave.getPlayersAsList(),i.default.gameMsg("Your progress has been saved."),e()})})}}deleteGame(e,t){if(e){new O.Persist(e).deleteStorage(()=>{this.gameSave.deletePlayer(e),this.savedPlayerList=this.gameSave.getPlayersAsList(),t()})}}isMenuShown(){return!!this.game&&this.game.isMenuShown()}getMenu(){return this.game?this.game.getMenu():null}getMessages(){return this.game&&this.game.hasNewMessages()?this.game.getMessages():[]}getOWAndPlayerPos(){let e=null,t=null;return this.game&&(e=this.game.getOverWorld(),e&&(t=this.game.getPlayerOwPos(),t&&this.game.setOverWorldExplored(t))),[e,t]}initRestoredGame(e){this.cancelAnim(),this.resetGameState(),this.game=e,this.initBeforeNewGame()}gameToJSON(){return new Promise((e,t)=>{try{e(this.game.toJSON())}catch(e){t(e)}})}loadGame(e,t){if(e){new O.Persist(e).fromStorage().then(n=>{const s=new g.FromJSON,r=n,a=new u.GameMain,o=s.createGame(a,r),i=o.getPlayer();if(null!==i){this.gameConf.loadedPlayer=i,this.gameConf.loadedLevel=this.gameSave.getDungeonLevel();const n=this.gameSave.getPlayersAsObj()[e];this.restoreGameConf(n),t(o)}})}}restoreGameConf(e){const t=["cols","rows","sqrPerActor","sqrPerItem","levels"];for(let n=0;n<t.length;n++)this.gameConf[t[n]]=e[t[n]]}initBeforeNewGame(){this.game.setGUICallbacks(this.isGUICommand,this.doGUICommand),this.game.setAnimationCallback(this.playAnimation.bind(this)),this.setDebugRefsToWindow();const e=this.game.getPlayer();this.gameGUIState.visibleCells=e.getBrain().getSeenCells(),this.gameGUIState.visibleCells||i.default.err("GameManager","initBeforeNewGame","No visibleCells");const t=this.game.getPool();t.listenEvent(i.default.EVT_LEVEL_CHANGED,this.listener),t.listenEvent(i.default.EVT_DESTROY_ITEM,this.listener),t.listenEvent(i.default.EVT_PLAYER_KILLED,this.listener),this.frameID=requestAnimationFrame(this.mainLoop),this.updateCb({render:!0})}mainLoop(){if(!0===this.keyPending||"AUTOMATIC"===this.ctrlMode){const e=this.getNextCode();if(e.cmd?this.game.update(e):this.game.update({code:e}),this.recordedCommands.push(e),this.game.visibleCells||i.default.err("GameManager","mainLoop","No visible cells"),this.gameGUIState.visibleCells=this.game.visibleCells,this.game.isGameOver())this.updateCb({render:!0,showGameMenu:!1});else{const e=this.game.getPlayer().getBrain(),t={render:!0,showGameMenu:!1};e.hasTargetSelected()?(t.selectedCell=e.getSelectedCells(),this.screen.setSelectedCell(t.selectedCell),e.isTargeting()&&(e.isTargetInRange()?this.screen.setStyle("selectedCell","cell-target-selected"):this.screen.setStyle("selectedCell","cell-not-in-range")),this.gameGUIState.isTargeting=!0):(this.gameGUIState.isTargeting=!1,t.selectedCell=null,this.screen.setSelectedCell(null)),this.updateCb(t)}this.keyPending=!1,this.checkIfAutoModeDone()}this.frameID=requestAnimationFrame(this.mainLoop)}checkIfAutoModeDone(){if(this.playerDriver){const e=this.game.getPlayer();if(e.get("Action").statusOk())if(this.playerDriver.hasKeys()){if(this.finishAutoOnSight){const[t,n]=this.game.getPlayer().getXY(),s=i.default.findEnemyCellForActor(e,this.gameGUIState.visibleCells);if(s.length>0){let e=!1;s.forEach(s=>{const[r,a]=s.getXY(),[o,l]=i.default.dXdYAbs([t,n],[r,a]);(o<this.finishAutoDist||l<this.finishAutoDist)&&(e=!0)}),e&&(i.default.gameMsg("You spot an enemy"),this.ctrlMode="MANUAL",this.playerDriver.reset())}}}else this.ctrlMode="MANUAL";else this.ctrlMode="MANUAL",this.playerDriver.reset()}}setDebugRefsToWindow(){window.GAME_RG=this.game;const e=this.game.getPlayer();window.PLAYER_RG=e,window.RG=i.default,window.PARSER_RG=w.ObjectShell.getParser(),window.DEBUG_RG=new A.RGDebug}getNextCode(){if("AUTOMATIC"===this.ctrlMode){const e=this.playerDriver.getNextCode();return e||(this.ctrlMode="MANUAL",c.Keys.KEY.NO_ACTION)}return this.nextCode}setViewSize(e,t){"+"===e&&("X"===t?this.viewportX+=5:this.viewportY+=2),"-"===e&&("X"===t?this.viewportX-=5:this.viewportY-=2),this.screen.setViewportXY(this.viewportX,this.viewportY)}setViewType(e){e===t.VIEW_MAP?(this.viewportPlayerX=this.viewportX,this.viewportPlayerY=this.viewportY,this.viewportX=this.game.getPlayer().getLevel().getMap().cols,this.viewportY=this.game.getPlayer().getLevel().getMap().rows,this.screen.setMapShown(!0),this.screen.setViewportXY(this.viewportX,this.viewportY),this.boardClassName="game-board-map-view",this.showMap=!0):e===t.VIEW_PLAYER&&(this.viewportX=this.viewportPlayerX,this.viewportY=this.viewportPlayerY,this.screen.setMapShown(!1),this.screen.setViewportXY(this.viewportX,this.viewportY),this.boardClassName=x[2],this.showMap=!1)}setSeedName(e){let t=parseInt(e,10);if(Number.isNaN(t)){const n=T(e);t=parseInt(n,16)}""===e&&(t=(new Date).getTime()),l.RNG.setSeed(t),E.Dice.RNG.setSeed(t),this.gameConf.seed=t}GUILook(e){if(this.gameGUIState.isTargeting){const t=this.getNextTargetCell();if(t){const n=`You see ${t.getActors()[0].getName()} nearby.`;this.screen.setSelectedCell(t),i.default.gameMsg(n),e({selectedCell:t})}else this.gameGUIState.isTargeting=!1,this.screen.setSelectedCell(null),e({selectedCell:null})}else{this.gameGUIState.isTargeting=!0,this.gameGUIState.enemyCells=i.default.findEnemyCellForActor(this.game.getPlayer(),this.gameGUIState.visibleCells),this.gameGUIState.numCurrCell=0;let t="You do not see any enemies nearby.";if(this.gameGUIState.enemyCells.length>0){const n=this.gameGUIState.enemyCells[0];t=`You see ${n.getActors()[0].getName()} nearby.`,this.screen.setSelectedCell(n),i.default.gameMsg(t),e({selectedCell:n})}else i.default.gameMsg(t)}}getNextTargetCell(){const e=this.gameGUIState.enemyCells.length;if(e>0){let t=this.gameGUIState.numCurrCell+1;return t>=e&&(t=0),this.gameGUIState.numCurrCell=t,this.gameGUIState.enemyCells[t]}return null}setGameSetting(e,t){this.gameConf[e]=t}setSelectedCell(e){this.screen.setSelectedCell(e)}createNewGame(e){if(this.cancelAnim(),this.resetGameState(),this.resetGameControls(),i.default.isNullOrUndef([this.gameConf.seed])&&(this.gameConf.seed=(new Date).getTime()),e(),this.canUseWorker())console.log("documentURI:",document.documentURI),this.createGameWorker();else{const e=new _.FactoryGame;this.game=e.createNewGame(this.gameConf),this.initBeforeNewGame()}}createGameWorker(){const e=new m.MyWorkerImport;e.onmessage=e=>{const t=e.data;if(t.progress)this.progressCb(t.progress);else if(t.ready){const e=JSON.parse(t.data),n=new g.FromJSON;let s=new u.GameMain;s=n.createGame(s,e),this.game=s,this.initBeforeNewGame()}else if(t.error)throw new Error("Worker threw error: "+t.error)},e.postMessage([this.gameConf])}createGameFromLevels(e){this.cancelAnim(),this.resetGameState(),null!==this.game&&delete this.game;const t=Object.assign({},this.gameConf);t.levels=e,t.playMode="from_levels";const n=new _.FactoryGame;this.game=n.createNewGame(t),this.initBeforeNewGame()}useClickHandler(e,t,n,s){this.playerDriver=new b.CellClickHandler(null,this.game),this.playerDriver.handleClick(e,t,n,s),this.playerDriver.hasKeys()&&this.setAutoMode()}getCellCurrMap(e,t){const n=this.game.getPlayer().getLevel().getMap();return n.hasXY(e,t)?n.getCell(e,t):null}notify(e,t){if(e===i.default.EVT_LEVEL_CHANGED){const e=t.actor;e.isPlayer()&&(this.screen.invalidate(),this.gameGUIState.visibleCells=e.getBrain().getSeenCells(),this.updateCb({render:!0}))}else e===i.default.EVT_PLAYER_KILLED&&this.deleteGame(t.actor.getName(),()=>{this.updateCb({render:!0})})}playAnimation(){if(this.game.hasAnimation()){const e=this.game.getAnimationFrame();this.animation=e,this.updateCb({render:!0,animation:e}),this.animationID=requestAnimationFrame(this.playAnimation.bind(this))}else this.animation=null,this.game.finishAnimation(),this.updateCb({render:!0,animation:null})}onLoadRecordedKeys(e){const t=this.game.getPlayer();this.playerDriver=new f.DriverBase(t,this.game),this.playerDriver.setKeys(e),this.setAutoModeNoFinish()}onLoadCallback(e,t){if(e.plugin){const t=this.pluginManager.readJSON(e),n=w.ObjectShell.getParser();n.parseShellData(t.getData()),window.parser=n}else{const t=new g.FromJSON,n=new u.GameMain,s=t.createGame(n,e);null!==s.getPlayer()&&this.initRestoredGame(s)}t()}doGUICommand(e,...t){this.gameGUIState.useModeEnabled?(this.guiCommands[c.Keys.GUI.Use](e),this.gameGUIState.useModeEnabled=!1):this.guiCommands.hasOwnProperty(e)?(console.log("doGUICommand() Calling GUI command with code",e),this.guiCommands[e](e)):c.Keys.KeyMap.isGoto(e)?this.guiCommands.GOTO(...t):(console.error("Unknown keycode for GUI command."),this.gameGUIState.useModeEnabled=!1)}useItem(e,t){if(this.gameGUIState.useModeEnabled)if(this.gameGUIState.useModeEnabled=!1,null!==t){const n=this.game.getPlayer(),s=P.getAdjacentCell(n,e);null!==s?(this.game.update({cmd:"use",target:s,item:t}),t.has("OneShot")&&this.updateCb({selectedItem:null})):i.default.gameWarn("There are no targets there.")}else i.default.gameWarn("No item was selected for use!")}onLoadScript(e,t){const n=document.querySelector(e).files[0];if(n){const e=new FileReader;e.onloadend=()=>{const n=e.result.toString();this.pluginManager.loadScript(n),t()},e.readAsText(n)}}onLoadFromScript(e,t){console.log("onLoadFromScript called here"),this.readTextFromFile(e,e=>{try{const t=this.pluginManager.loadGameFromScript(e);t.levels?this.createGameFromLevels(t.levels):t.game&&(this.cancelAnim(),this.resetGameState(),this.game=t.game,this.initBeforeNewGame())}catch(e){console.error(e,e.message)}})}readTextFromFile(e,t){const n=document.querySelector(e).files[0];if(n){const e=new FileReader;e.onloadend=()=>{const n=e.result.toString();t(n)},e.readAsText(n)}}updateGame(e){this.game.update(e)}onCellClick(e,t){const n=this.getCellCurrMap(e,t);if(n){if(this.gameGUIState.isTargeting)this.game.update({cmd:"missile",target:n}),this.gameGUIState.visibleCells=this.game.visibleCells,this.screen.setSelectedCell(null),this.updateCb({selectedCell:null}),this.gameGUIState.isTargeting=!1;else{const s=this.game.getPlayer();P.describeCell(n,this.gameGUIState.visibleCells),this.updateCb({selectedCell:n}),this.selectClickHandlerCmd(s,n,e,t)}if(console.log(`${e},${t} Cell: ${JSON.stringify(n)}`),n.hasActors()){const e=n.getActors();console.log("window.ACTOR set. Actors: "+JSON.stringify(e)),window.ACTOR_RG=e[0]}if(n.hasConnection()){const e=n.getPropType("connection");console.log("Connection: "+JSON.stringify(e)),window.CONNECTION_RG=e[0]}window.CELL_RG=n}else i.default.warn("GameManager","onCellClick",`No cell ${e},${t} in the map.`)}selectClickHandlerCmd(e,t,n,s){if(t.isFree()&&t.hasItems())this.useClickHandler(n,s,t,"pickup");else if(t.isAdjacent(e.getCell()))if(t.hasActors()){const r=t.getActors()[0];r.isEnemy(e)?this.useClickHandler(n,s,t,"attack"):r===e?this.useClickHandler(n,s,t,"pickup"):this.useClickHandler(n,s,t,"chat")}else{e.getInvEq().getWeapon()&&this.useClickHandler(n,s,t,"use-item")}else if(t.isFree())this.useClickHandler(n,s,t,"move");else if(t.hasActors()){t.getActors()[0].isEnemy(e)&&this.useClickHandler(n,s,t,"shoot")}}menuItemClicked(e){let t=-1;if(e){t=/\d+/.test(e)?parseInt(e,10):e;const n=c.Keys.selectIndexToCode(t);n>=0&&(this.keyPending=!0,this.nextCode=n)}}increaseFont(e){const t=this.boardClassName;let n=x.indexOf(t);"+"===e?(n+=1,n>=x.length&&(n=x.length-1)):"-"===e&&(n-=1,n<0&&(n=0)),this.boardClassName=x[n]}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GameSave=void 0;const r=s(n(4)),a=n(103),o=n(127);t.GameSave=class{constructor(){this._storageRef=null,this._dungeonLevel=null,this._playerList="_battles_player_data_"}setStorage(e){this._storageRef=e}getDungeonLevel(){return this._dungeonLevel}save(e,t){this.savePlayer(e,t)}restore(e){if(!r.default.isNullOrUndef([e])){return this.restorePlayer(e)}return r.default.err("GameSave","restore","No name given (or null/undef)."),null}getPlayersAsList(){const e=this.getPlayersAsObj();return null!==e?Object.keys(e).map(t=>e[t]):[]}getPlayersAsObj(){this._checkStorageValid();const e=this._storageRef.getItem(this._playerList);return JSON.parse(e)}deletePlayer(e){this._checkStorageValid();let t=this._storageRef.getItem(this._playerList);const n=JSON.parse(t);n&&(n.hasOwnProperty(e)&&delete n[e],t=JSON.stringify(n),this._storageRef.setItem(this._playerList,t))}savePlayer(e,t){this._checkStorageValid();const n=e.getPlayer();if(r.default.isNullOrUndef([n]))r.default.err("GameSave","savePlayer","Cannot save null player. Forgot game.addPlayer?");else{const e=n.getName();this._savePlayerInfo(e,n.toJSON(),t)}}restorePlayer(e){this._checkStorageValid();if(this.getPlayersAsObj().hasOwnProperty(e)){const t=this._storageRef.getItem("_battles_player_"+e),n=JSON.parse(t),s=new a.FromJSON;let r=new o.GameMain;return r=s.createGame(r,n.game),this._dungeonLevel=s.getDungeonLevel(),r}return r.default.err("GameSave","restorePlayer","No player |"+e+"| found from the list."),null}_savePlayerInfo(e,t,n){let s=this._storageRef.getItem(this._playerList),r=JSON.parse(s);null===r&&(r={});const a=Object.values(t.components).find(e=>"Experience"===e.setType);r[e]={name:e,expLevel:a.setExpLevel,dungeonLevel:t.dungeonLevel};for(const t in n)t&&(r[e][t]=n[t]);s=JSON.stringify(r),this._storageRef.setItem(this._playerList,s)}_checkStorageValid(){if(r.default.isNullOrUndef([this._storageRef]))throw new Error("GameSave you must setStorage() first.")}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.PlayerDriver=t.DriverBase=void 0;const r=s(n(4)),a=n(19),o=n(157),i=n(25),l=n(23),c=n(9),u=n(804),h=c.Random.getRNG(),{KEY:d,KeyMap:p}=i.Keys,{getShortestPath:f}=a.Path,m=n(15)("bitn:PlayerDriver");m.enabled=!1;const g=[-1,0,1],y="=".repeat(78),v=l.EventPool.getPool();class b{constructor(e,t){e&&(this.player=e),this.name="DriverBase",this._game=t,this._keyBuffer=[]}setGame(e){this._game=e}setKeys(e){this._keyBuffer=e.slice()}handleClick(e,t,n,s){}reset(){this._keyBuffer=[]}hasKeys(){return this._keyBuffer.length>0}getNextCode(){return this._keyBuffer.length>0?this._keyBuffer.shift():null}getReport(){let e=`${this.name}, Player: ${this.player.getName()}`;return e+="\nKeys in buffer: "+JSON.stringify(this._keyBuffer),e}}t.DriverBase=b;class _ extends class{constructor(){}process(e){return null}}{constructor(){super(),this.ammoShotAt={}}process(e){const t=e.enemy,[n,s]=e.player.getXY();let a=null;if(!t)return r.default.err("PlayerDriver","getPlayerCmd","Got action 'attack' but enemy is null"),null;const[o,l]=t.getXY(),c=o-n,u=l-s,h=p.dirToKeyCode(c,u);if(this.canCastSpell(e)){a={code:d.POWER};const t=this.getCodeForSpell(e);t>=0?e.setKeys([t,h]):a={code:h}}else{if(this.willDoRangedAttack(e))return e.setKeys([i.Keys.VK.t]),{code:i.Keys.VK.t};if(!(Math.abs(c)<=1&&Math.abs(u)<=1))return e.setPathAction([o,l]),null;a={code:h}}return a}canCastSpell(e){if(e.player.get("SpellPower")){const t=e.player.getBook();if(t){const e=t.getSpells()[0];if(e)return e.canCast()}}return!1}willDoRangedAttack(e){const t=e.player,[n,s]=e.enemy.getXY(),[o,i]=t.getXY(),l=t.getInvEq().getMissile();if(l){const e=r.default.getMissileRange(t,l),c=a.Path.shortestDist(n,s,o,i);if(c<=e&&c>1){const e=t.getLevel().getID();return this.ammoShotAt[e]||(this.ammoShotAt[e]=[]),this.ammoShotAt[e].push([n,s]),!0}console.log(`Has missile but range check failed: r: ${e} dist: ${c}`)}else m.enabled&&console.log("No missile equipped. Cannot do attack");return!1}getCodeForSpell(e){const t=e.player.getBook().getSpells().filter(e=>e.hasDice("damage"));if(0===t.length)return-1;const n={};let s=0;t.forEach((e,t)=>{if(e.canCast()){const r=e.getCastingPower();s+=r,n[t]=r}});Object.keys(n).forEach(e=>{n[e]=s-n[e]});const r=h.getWeighted(n),a=parseInt(r,10),o=i.Keys.menuIndices[a];return i.Keys.selectIndexToCode(o)}}class E extends b{constructor(e,t){super(e,t),this.action="",this.enemy=null,this.cmds=[],this.actions=[""],this.screen=new o.Screen(30,14),this.state={exploreTurns:0,usePassage:!1,useStairs:!1,exitZone:!1,path:[],stairsStack:[],tilesVisited:{},visitedStairs:{},visited:{}},this.context={ammoShot:{}},this.maxExploreTurns=500,this.nTurns=0,this.screenPeriod=1e4,this._passableCallback=this._passableCallback.bind(this),this.hasNotify=!0,v.listenEvent(r.default.EVT_TILE_CHANGED,this),this.contextProcs=[new u.EnemyContextProcessor("enemyContext",this),new u.AreaContextProcessor("areaContext",this),new u.ZoneContextProcessor("zoneContext",this),new u.ExploreContextProcessor("zoneContext",this),new u.RandomContextProcessor("randomContext",this)],this.actionProcs={attack:[new _]}}setPlayer(e){this.player=e}getPlayer(){return this.player}getNextCode(){let e=super.getNextCode();return null===e&&(e=this.nextCmd()),e.code?e.code:e}hasPath(){return this.state.path.length>0}hasKeys(){return!0}reset(){this.state.usePassage=!1,this.state.useStairs=!1,this.state.exitZone=!1,this.state.path=[]}nextCmd(){this.action="";const[e,t]=this.player.getXY(),n=this.player.getLevel();this.addVisited(n,e,t);const s=this.player.getLevel().getMap().getCellsInFOV(this.player);this.printTurnInfo(s),""===this.action&&this.checkForSelection(),this.contextProcs.forEach(e=>{""===this.action&&(e.processContext()||(this.action=""))}),""===this.action&&r.default.err("PlayerDriver","nextCmd()","No contextProc matches! At least one proc must always match!");let a=this.getPlayerCmd();if(a||(a={code:d.REST}),m.enabled){const e=JSON.stringify(a),t=`action: |${this.action}|, cmd: ${e}`;this.debug(">>> PlayerDriver "+t)}return++this.nTurns,this.cmds.push(a),this.actions.push(this.action),a}checkForSelection(){this.player.getBrain().isMenuShown()&&(this.action="selection")}tryToSetPathToCell(e){this.state.path=[],e.forEach(e=>{this.hasPath()||this.setPathAction(e.getXY())})}findPathToMove(e,t=!1){const[n,s]=this.player.getXY();let r=e.filter(e=>e.isPassable());const a=e.filter(e=>e.hasDoor());t||(r=r.filter(e=>!this.cellVisited(e)));const o={north:r.filter(e=>e.getY()<s),south:r.filter(e=>e.getY()>s),east:r.filter(e=>e.getX()>n),west:r.filter(e=>e.getX()<n),doors:a};let i="";t&&(i=">>>>");let l=["north","west","east","south"];t&&(l=h.shuffle(l),console.log("Shuffled order is now",l));let c=">";l.forEach(e=>{if(!this.hasPath()){if(this.debug(i+c+" Looking path to "+e),this.tryToSetPathToCell(o[e]),this.hasPath())return void(this.action="path");c+=">"}}),""===this.action&&this.tryToSetPathToCell(o.doors),""===this.action&&(t?(console.log("We are screwed, no path found"),this.debug("We are screwed")):(this.debug(i+">>>> Looking passage out"),this.tryToFindPassage(e,!1),this.hasPath()?this.action="path":(this.debug(i+">>>>> Looking visited cells now"),this.findAlreadySeenPassage(),this.hasPath()||(console.log("Trying now from visited cells"),this.findPathToMove(e,!0)))))}levelVisited(e){return this.state.visited.hasOwnProperty(e.getID())}cellVisited(e){const t=this.player.getLevel().getID();if(this.state.visited.hasOwnProperty(t)){const[n,s]=[e.getX(),e.getY()];return this.state.visited[t].hasOwnProperty(n+","+s)}return!1}addVisited(e,t,n){const s=e.getID();this.state.visited.hasOwnProperty(s)||(this.state.visited[s]={});const r=this.player.getCell();this.state.visited[s][t+","+n]={x:t,y:n,hasPassage:r.hasPassage()}}newStairsSeen(e){const t=this.player.getLevel().getID(),n=e.find(e=>{const[n,s]=[e.getX(),e.getY()];return this.state.visitedStairs.hasOwnProperty(t)?!this.state.visitedStairs[t][n+","+s]&&e.hasStairs():e.hasStairs()});return!(!n||(this.tryToSetPathToCell([n]),!this.hasPath()))&&(this.debug("Found path to stairs. Going there."),!0)}tryToFindPassage(e,t=!0){this.debug("> Looking for north passage cells");const n=e.filter(e=>e.hasPassage()&&0===e.getY()&&!this.passageVisited(e));if(this.debug("> N passageCells "+n.length),this.tryToSetPathToCell(n),this.hasPath())this.setState({usePassage:!0},"north passage"),this.action="path";else{this.debug(">> Looking for west passage cells");const n=e.filter(e=>e.hasPassage()&&0===e.getX()&&!this.passageVisited(e));if(this.tryToSetPathToCell(n),this.hasPath())this.setState({usePassage:!0},"west passage"),this.action="path";else{this.debug(">> Looking for any passage cells");const n=e.filter(e=>e.hasPassage()&&!this.passageVisited(e));this.tryToSetPathToCell(n),this.hasPath()?(this.setState({usePassage:!0},"any passage"),this.action="path"):t?(this.debug(">>> No passages. Trying to move."),this.findPathToMove(e)):this.debug(">>> No passages. Terminating.")}}}passageVisited(e){const t=e.getPassage();if(t){const e=t.getTargetLevel();return this.levelVisited(e)}return!1}findAlreadySeenPassage(){this.debug("Looking at remembered passages");const e=this.findVisitedCells(e=>e.hasPassage()&&!this.passageVisited(e));if(this.debug("Looking at non-visited passages"),this.tryToSetPathToCell(e),this.hasPath())this.setState({usePassage:!0},"already seen passage"),this.action="path";else{this.debug("Looking at visited passages");const e=this.findVisitedCells(e=>e.hasPassage());this.tryToSetPathToCell(e),this.hasPath()?(this.setState({usePassage:!0},"already seen passage"),this.action="path"):this.debug("Nothing found among passages. Screwed!")}}findVisitedCells(e){const t=this.player.getLevel().getMap(),n=this.player.getLevel().getID();return Object.values(this.state.visited[n]).map(e=>t.getCell(e.x,e.y)).filter(e)}getPlayerCmd(){const e=this.enemy,t=this.player.getLevel().getMap(),[n,s]=this.player.getXY();let a=null;if(this.actionProcs[this.action]){const e=this.actionProcs[this.action];for(let t=0;t<e.length&&(a=e[t].process(this),!a);t++);}if(a)return a;if("pickup"===this.action)a={code:d.PICKUP};else if("flee"===this.action){if(this.player.getCell().hasPassage())a={code:d.USE_STAIRS_DOWN};else{const[o,i]=[e.getX(),e.getY()],[l,c]=r.default.dXdYUnit([o,i],[n,s]),u=n+-l,d=s+-c;if(t.isPassable(u,d,n,s)){const e=p.dirToKeyCode(-l,-c);this.debug(`flee to dx,dy ${-l},${-c}`),a={code:e}}else{this.debug("Pick random direction for fleeing");let r=h.arrayGetRand(g),o=h.arrayGetRand(g);const i=20;let l=0;for(;!(t.isPassable(n+r,s+o,n,s)||(r=h.arrayGetRand(g),o=h.arrayGetRand(g),++l,l>=i)););if(t.isPassable(r,o,n,s)){this.debug(`flee rand dir to dx,dy ${r},${o}`);a={code:p.dirToKeyCode(r,o)}}else{const[t,r]=[e.getX(),e.getY()],o=e.getName();this.debug(`No escape! Attack ${o} @${t},${r}`);const i=t-n,l=r-s;a={code:p.dirToKeyCode(i,l)}}}}}else if("move north"===this.action)a={code:d.MOVE_N};else if("stairs"===this.action)a={code:d.USE_STAIRS_DOWN};else if("path"===this.action){this.hasPath()||r.default.err("PlayerDriver","getPlayerCmd","Tried to shift coord from 0 length path");const{x:e,y:t}=this.state.path.shift(),o=e-n,i=t-s;this.debug(`Taking action path ${e},${t}, dX,dY ${o},${i}`);a={code:p.dirToKeyCode(o,i)},this.hasPath()||this.debug("PlayerDriver finished a path")}else"run"===this.action?a={code:d.RUN}:"selection"===this.action&&(a={code:i.Keys.selectIndexToCode(0)});return a}getLastAction(){return this.actions[this.actions.length-1]}printTurnInfo(e){const[t,n]=this.player.getXY(),s=this.player.getLevel(),r=s.getMap(),a=this.player.get("Health").getHP(),o=`@${t},${n} ID: ${s.getID()}`;m.enabled&&console.log(y),this.debug(`T: ${this.nTurns} ${o} | HP: ${a}`),this.nTurns%this.screenPeriod==0&&(this.screen.render(t,n,r,e),this.screen.printRenderedChars(),console.log("=".repeat(78)+"\n"))}addUsedStairs(e){if(this.state.exitZone)return this.state.stairsStack.pop(),this.debug("POP: stairsStack is now ",this.state.stairsStack),void this.setState({exitZone:!1},"addUsedStairs");const t=e.getStairs();if(!t)return void r.default.err("PlayerDriver","addUsedStairs","Called on cell without stairs!");const n=t.getTargetStairs(),s=t.getTargetLevel().getID(),a=this.player.getLevel().getID();this.state.visitedStairs.hasOwnProperty(a)||(this.state.visitedStairs[a]={});const[o,i]=[t.getX(),t.getY()];this.state.visitedStairs[a][o+","+i]=[o,i];const[l,c]=[n.getX(),n.getY()];this.state.stairsStack.push([s,l,c]),this.debug("PUSH: stairsStack is now ",this.state.stairsStack),this.state.visitedStairs[s]||(this.state.visitedStairs[s]={}),this.state.visitedStairs[s][l+","+c]=[l,c]}setPathAction(e){this.debug(`>> setPathAction(): Looking for shortest path to cell ${e[0]},${e[1]}`);const t=this.player.getCell(),[n,s]=[t.getX(),t.getY()],r=f(n,s,e[0],e[1],this._passableCallback);return r.length>1&&(this.debug("Found a non-zero path"),this.state.path=r,this.state.path.shift(),this.action="path",!0)}movingToConnect(){return this.state.useStairs||this.state.usePassage}getStairsMRU(){const e=this.state.stairsStack.length-1;return this.state.stairsStack[e]}shouldReturnBackUp(){if(this.state.stairsStack.length>0&&this.state.exploreTurns<=0){const e=this.getStairsMRU(),t=e[1],n=e[2],s=this.player.getLevel().getMap().getCell(t,n);if(this.tryToSetPathToCell([s]),this.hasPath())return this.action="path",this.debug("Returning back up the stairs now"),this.setState({exitZone:!0},"shouldReturn"),!0;this.debug("Cannot find path to return back")}return!1}toJSON(){return{cmds:this.cmds,actions:this.actions,nTurns:this.nTurns,state:this.state}}debug(e,t=null){if(m.enabled){const n=`T${this.nTurns}: `;let s="";t&&(s="\n"+JSON.stringify(t)),m(`${n}${e}${s}`)}}setState(e,t){if(t&&m.enabled){const n=JSON.stringify(e);this.debug(`setState with ${n} |${t}|`)}Object.keys(e).forEach(t=>{this.state[t]=e[t]})}levelExploredEnough(e){return this.state.exploreTurns<=0&&!this.movingToConnect()&&this.newStairsSeen(e)}shouldPickupFromCell(e){if(e.hasItems()){if(e.getItems()[0].getType()!==r.default.ITEM.CORPSE)return"pickup"!==this.getLastAction()}return!1}notify(e,t){if(e===r.default.EVT_TILE_CHANGED){const{actor:e,target:n}=t;if(e===this.player){const e=n.getID();this.state.tilesVisited[e]||(this.state.tilesVisited[e]=0),this.state.tilesVisited[e]+=1}}}getReport(){return super.getReport()}_passableCallback(e,t){const n=this.player.getLevel().getMap(),[s,r]=this.player.getXY();let a=n.isPassable(e,t,s,r);if(a||(a=e===this.player.getX()&&t===this.player.getY()),!a&&n.hasXY(e,t)){a=n.getCell(e,t).hasDoor()}return a}}t.PlayerDriver=E,E.fromJSON=function(e){const t=new E;return Object.keys(e).forEach(n=>{t[n]=e[n]}),t}},function(e,t){
/*!
 * assertion-error
 * Copyright(c) 2013 Jake Luer <jake@qualiancy.com>
 * MIT Licensed
 */
/*!
 * Return a function that will copy properties from
 * one object to another excluding any originally
 * listed. Returned function will create a new `{}`.
 *
 * @param {String} excluded properties ...
 * @return {Function}
 */
function n(){var e=[].slice.call(arguments);function t(t,n){Object.keys(n).forEach((function(s){~e.indexOf(s)||(t[s]=n[s])}))}return function(){for(var e=[].slice.call(arguments),n=0,s={};n<e.length;n++)t(s,e[n]);return s}}function s(e,t,r){var a=n("name","message","stack","constructor","toJSON")(t||{});for(var o in this.message=e||"Unspecified AssertionError",this.showDiff=!1,a)this[o]=a[o];if(r=r||s,Error.captureStackTrace)Error.captureStackTrace(this,r);else try{throw new Error}catch(e){this.stack=e.stack}}
/*!
 * Inherit from Error.prototype
 */
/*!
 * Primary Exports
 */
e.exports=s,s.prototype=Object.create(Error.prototype),
/*!
 * Statically set name
 */
s.prototype.name="AssertionError",
/*!
 * Ensure correct constructor
 */
s.prototype.constructor=s,s.prototype.toJSON=function(e){var t=n("constructor","toJSON","stack")({name:this.name},this);return!1!==e&&this.stack&&(t.stack=this.stack),t}},function(e,t){
/*!
 * Chai - getActual utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t){return t.length>4?t[4]:e._obj}},function(e,t,n){
/*!
 * Chai - flag utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
/*!
 * Module dependencies
 */
var s=n(248),r=n(104);e.exports=function(e){var t=s(e),n=Object.prototype.toString.call(e);if(r.truncateThreshold&&t.length>=r.truncateThreshold){if("[object Function]"===n)return e.name&&""!==e.name?"[Function: "+e.name+"]":"[Function]";if("[object Array]"===n)return"[ Array("+e.length+") ]";if("[object Object]"===n){var a=Object.keys(e);return"{ Object ("+(a.length>2?a.splice(0,2).join(", ")+", ...":a.join(", "))+") }"}return t}return t}},function(e,t,n){"use strict";var s=Function.prototype.toString,r=/\s*function(?:\s|\s*\/\*[^(?:*\/)]+\*\/\s*)*([^\s\(\/]+)/;e.exports=function(e){if("function"!=typeof e)return null;var t="";if(void 0===Function.prototype.name&&void 0===e.name){var n=s.call(e).match(r);n&&(t=n[1])}else t=e.name;return t}},function(e,t){
/*!
 * Chai - getProperties utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e){var t=Object.getOwnPropertyNames(e);function n(e){-1===t.indexOf(e)&&t.push(e)}for(var s=Object.getPrototypeOf(e);null!==s;)Object.getOwnPropertyNames(s).forEach(n),s=Object.getPrototypeOf(s);return t}},function(e,t){
/*!
 * Chai - getOwnEnumerablePropertySymbols utility
 * Copyright(c) 2011-2016 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e){return"function"!=typeof Object.getOwnPropertySymbols?[]:Object.getOwnPropertySymbols(e).filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))}},function(e,t,n){"use strict";n.r(t),n.d(t,"Accordion",(function(){return ee})),n.d(t,"Alert",(function(){return le})),n.d(t,"Badge",(function(){return he})),n.d(t,"Breadcrumb",(function(){return Se})),n.d(t,"BreadcrumbItem",(function(){return _e})),n.d(t,"Button",(function(){return Oe})),n.d(t,"ButtonGroup",(function(){return xe})),n.d(t,"ButtonToolbar",(function(){return Ie})),n.d(t,"Carousel",(function(){return Je})),n.d(t,"CarouselItem",(function(){return Ue})),n.d(t,"Checkbox",(function(){return et})),n.d(t,"Clearfix",(function(){return rt})),n.d(t,"CloseButton",(function(){return ae})),n.d(t,"ControlLabel",(function(){return lt})),n.d(t,"Col",(function(){return ht})),n.d(t,"Collapse",(function(){return _t})),n.d(t,"Dropdown",(function(){return qt})),n.d(t,"DropdownButton",(function(){return Zt})),n.d(t,"Fade",(function(){return nn})),n.d(t,"Form",(function(){return an})),n.d(t,"FormControl",(function(){return gn})),n.d(t,"FormGroup",(function(){return _n})),n.d(t,"Glyphicon",(function(){return Ve})),n.d(t,"Grid",(function(){return wn})),n.d(t,"HelpBlock",(function(){return On})),n.d(t,"Image",(function(){return An})),n.d(t,"InputGroup",(function(){return kn})),n.d(t,"Jumbotron",(function(){return Bn})),n.d(t,"Label",(function(){return Gn})),n.d(t,"ListGroup",(function(){return $n})),n.d(t,"ListGroupItem",(function(){return Yn})),n.d(t,"Media",(function(){return us})),n.d(t,"MenuItem",(function(){return ps})),n.d(t,"Modal",(function(){return Hs})),n.d(t,"ModalBody",(function(){return As})),n.d(t,"ModalFooter",(function(){return ks})),n.d(t,"ModalHeader",(function(){return Fs})),n.d(t,"ModalTitle",(function(){return Ws})),n.d(t,"Nav",(function(){return zs})),n.d(t,"Navbar",(function(){return mr})),n.d(t,"NavbarBrand",(function(){return Zs})),n.d(t,"NavDropdown",(function(){return vr})),n.d(t,"NavItem",(function(){return Er})),n.d(t,"Overlay",(function(){return Mr})),n.d(t,"OverlayTrigger",(function(){return Ir})),n.d(t,"PageHeader",(function(){return kr})),n.d(t,"PageItem",(function(){return Yr})),n.d(t,"Pager",(function(){return $r})),n.d(t,"Pagination",(function(){return Qr})),n.d(t,"PaginationButton",(function(){return qr})),n.d(t,"Panel",(function(){return ta})),n.d(t,"PanelGroup",(function(){return Z})),n.d(t,"Popover",(function(){return ra})),n.d(t,"ProgressBar",(function(){return la})),n.d(t,"Radio",(function(){return ha})),n.d(t,"ResponsiveEmbed",(function(){return fa})),n.d(t,"Row",(function(){return ya})),n.d(t,"SafeAnchor",(function(){return ye})),n.d(t,"SplitButton",(function(){return Sa})),n.d(t,"Tab",(function(){return ja})),n.d(t,"TabContainer",(function(){return Ma})),n.d(t,"TabContent",(function(){return Ia})),n.d(t,"Table",(function(){return Xa})),n.d(t,"TabPane",(function(){return Ba})),n.d(t,"Tabs",(function(){return Va})),n.d(t,"Thumbnail",(function(){return za})),n.d(t,"ToggleButton",(function(){return Za})),n.d(t,"ToggleButtonGroup",(function(){return so})),n.d(t,"Tooltip",(function(){return oo})),n.d(t,"Well",(function(){return lo})),n.d(t,"utils",(function(){return r}));var s={};n.r(s),n.d(s,"prefix",(function(){return F})),n.d(s,"bsClass",(function(){return G})),n.d(s,"bsStyles",(function(){return j})),n.d(s,"bsSizes",(function(){return W})),n.d(s,"getClassSet",(function(){return Y})),n.d(s,"splitBsProps",(function(){return $})),n.d(s,"splitBsPropsAndOmit",(function(){return H})),n.d(s,"addStyle",(function(){return V})),n.d(s,"_curry",(function(){return K}));var r={};n.r(r),n.d(r,"bootstrapUtils",(function(){return s})),n.d(r,"createChainedFunction",(function(){return q})),n.d(r,"ValidComponentChildren",(function(){return z}));var a=n(2),o=n.n(a),i=n(5),l=n.n(i),c=n(6),u=n.n(c),h=n(7),d=n.n(h),p=n(1),f=n.n(p),m=n(250),g=n.n(m),y=n(8),v=n.n(y),b=n(3),_=n.n(b),E=n(0),S=n.n(E),w=n(129),C=n.n(w),O=n(106),T=n.n(O),M="large",A="small",N="xsmall",x={large:"lg",medium:"md",small:"sm",xsmall:"xs",lg:"lg",md:"md",sm:"sm",xs:"xs"},P=["lg","md","sm","xs"],I={SUCCESS:"success",WARNING:"warning",DANGER:"danger",INFO:"info"},D="default",k="primary",L="link",R="inverse";function B(e){return function(){for(var t=arguments.length,n=Array(t),s=0;s<t;s++)n[s]=arguments[s];var r=n[n.length-1];return"function"==typeof r?e.apply(void 0,n):function(t){return e.apply(void 0,n.concat([t]))}}}function F(e,t){return null==e.bsClass&&T()(!1),e.bsClass+(t?"-"+t:"")}var G=B((function(e,t){var n=t.propTypes||(t.propTypes={}),s=t.defaultProps||(t.defaultProps={});return n.bsClass=S.a.string,s.bsClass=e,t})),j=B((function(e,t,n){"string"!=typeof t&&(n=t,t=void 0);var s=n.STYLES||[],r=n.propTypes||{};e.forEach((function(e){-1===s.indexOf(e)&&s.push(e)}));var a=S.a.oneOf(s);(n.STYLES=s,a._values=s,n.propTypes=o()({},r,{bsStyle:a}),void 0!==t)&&((n.defaultProps||(n.defaultProps={})).bsStyle=t);return n})),W=B((function(e,t,n){"string"!=typeof t&&(n=t,t=void 0);var s=n.SIZES||[],r=n.propTypes||{};e.forEach((function(e){-1===s.indexOf(e)&&s.push(e)}));var a=[];s.forEach((function(e){var t=x[e];t&&t!==e&&a.push(t),a.push(e)}));var i=S.a.oneOf(a);return i._values=a,n.SIZES=s,n.propTypes=o()({},r,{bsSize:i}),void 0!==t&&(n.defaultProps||(n.defaultProps={}),n.defaultProps.bsSize=t),n}));function Y(e){var t,n=((t={})[F(e)]=!0,t);e.bsSize&&(n[F(e,x[e.bsSize]||e.bsSize)]=!0);return e.bsStyle&&(n[F(e,e.bsStyle)]=!0),n}function X(e){return{bsClass:e.bsClass,bsSize:e.bsSize,bsStyle:e.bsStyle,bsRole:e.bsRole}}function U(e){return"bsClass"===e||"bsSize"===e||"bsStyle"===e||"bsRole"===e}function $(e){var t={};return C()(e).forEach((function(e){var n=e[0],s=e[1];U(n)||(t[n]=s)})),[X(e),t]}function H(e,t){var n={};t.forEach((function(e){n[e]=!0}));var s={};return C()(e).forEach((function(e){var t=e[0],r=e[1];U(t)||n[t]||(s[t]=r)})),[X(e),s]}function V(e){for(var t=arguments.length,n=Array(t>1?t-1:0),s=1;s<t;s++)n[s-1]=arguments[s];j(n,e)}var K=B;var q=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.filter((function(e){return null!=e})).reduce((function(e,t){if("function"!=typeof t)throw new Error("Invalid Argument Type, must only provide functions, undefined, or null.");return null===e?t:function(){for(var n=arguments.length,s=Array(n),r=0;r<n;r++)s[r]=arguments[r];e.apply(this,s),t.apply(this,s)}}),null)};var z={map:function(e,t,n){var s=0;return f.a.Children.map(e,(function(e){return f.a.isValidElement(e)?t.call(n,e,s++):e}))},forEach:function(e,t,n){var s=0;f.a.Children.forEach(e,(function(e){f.a.isValidElement(e)&&t.call(n,e,s++)}))},count:function(e){var t=0;return f.a.Children.forEach(e,(function(e){f.a.isValidElement(e)&&++t})),t},find:function(e,t,n){var s=0,r=void 0;return f.a.Children.forEach(e,(function(e){r||f.a.isValidElement(e)&&t.call(n,e,s++)&&(r=e)})),r},filter:function(e,t,n){var s=0,r=[];return f.a.Children.forEach(e,(function(e){f.a.isValidElement(e)&&t.call(n,e,s++)&&r.push(e)})),r},every:function(e,t,n){var s=0,r=!0;return f.a.Children.forEach(e,(function(e){r&&f.a.isValidElement(e)&&(t.call(n,e,s++)||(r=!1))})),r},some:function(e,t,n){var s=0,r=!1;return f.a.Children.forEach(e,(function(e){r||f.a.isValidElement(e)&&t.call(n,e,s++)&&(r=!0)})),r},toArray:function(e){var t=[];return f.a.Children.forEach(e,(function(e){f.a.isValidElement(e)&&t.push(e)})),t}},J={accordion:S.a.bool,activeKey:S.a.any,defaultActiveKey:S.a.any,onSelect:S.a.func,role:S.a.string},Q=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleSelect=r.handleSelect.bind(r),r.state={activeKey:n.defaultActiveKey},r}return d()(t,e),t.prototype.handleSelect=function(e,t){t.preventDefault(),this.props.onSelect&&this.props.onSelect(e,t),this.state.activeKey===e&&(e=null),this.setState({activeKey:e})},t.prototype.render=function(){var e=this,t=this.props,n=t.accordion,s=t.activeKey,r=t.className,a=t.children,i=H(v()(t,["accordion","activeKey","className","children"]),["defaultActiveKey","onSelect"]),l=i[0],c=i[1],u=void 0;n&&(u=null!=s?s:this.state.activeKey,c.role=c.role||"tablist");var h=Y(l);return f.a.createElement("div",o()({},c,{className:_()(r,h)}),z.map(a,(function(t){var s={bsStyle:t.props.bsStyle||l.bsStyle};return n&&g()(s,{headerRole:"tab",panelRole:"tabpanel",collapsible:!0,expanded:t.props.eventKey===u,onSelect:q(e.handleSelect,t.props.onSelect)}),Object(p.cloneElement)(t,s)})))},t}(f.a.Component);Q.propTypes=J,Q.defaultProps={accordion:!1};var Z=G("panel-group",Q),ee=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){return f.a.createElement(Z,o()({},this.props,{accordion:!0}),this.props.children)},t}(f.a.Component),te=n(37),ne=n.n(te),se={label:S.a.string.isRequired,onClick:S.a.func},re=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.label,n=e.onClick;return f.a.createElement("button",{type:"button",className:"close",onClick:n},f.a.createElement("span",{"aria-hidden":"true"},"ร"),f.a.createElement("span",{className:"sr-only"},t))},t}(f.a.Component);re.propTypes=se,re.defaultProps={label:"Close"};var ae=re,oe={onDismiss:S.a.func,closeLabel:S.a.string},ie=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.onDismiss,s=t.closeLabel,r=t.className,a=t.children,i=$(v()(t,["onDismiss","closeLabel","className","children"])),l=i[0],c=i[1],u=!!n,h=o()({},Y(l),((e={})[F(l,"dismissable")]=u,e));return f.a.createElement("div",o()({},c,{role:"alert",className:_()(r,h)}),u&&f.a.createElement(ae,{onClick:n,label:s}),a)},t}(f.a.Component);ie.propTypes=oe,ie.defaultProps={closeLabel:"Close alert"};var le=j(ne()(I),I.INFO,G("alert",ie)),ce={pullRight:S.a.bool},ue=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.hasContent=function(e){var t=!1;return f.a.Children.forEach(e,(function(e){t||(e||0===e)&&(t=!0)})),t},t.prototype.render=function(){var e=this.props,t=e.pullRight,n=e.className,s=e.children,r=$(v()(e,["pullRight","className","children"])),a=r[0],i=r[1],l=o()({},Y(a),{"pull-right":t,hidden:!this.hasContent(s)});return f.a.createElement("span",o()({},i,{className:_()(n,l)}),s)},t}(f.a.Component);ue.propTypes=ce,ue.defaultProps={pullRight:!1};var he=G("badge",ue),de=n(10),pe=n.n(de),fe={href:S.a.string,onClick:S.a.func,onKeyDown:S.a.func,disabled:S.a.bool,role:S.a.string,tabIndex:S.a.oneOfType([S.a.number,S.a.string]),componentClass:pe.a};function me(e){return!e||"#"===e.trim()}var ge=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleClick=r.handleClick.bind(r),r.handleKeyDown=r.handleKeyDown.bind(r),r}return d()(t,e),t.prototype.handleClick=function(e){var t=this.props,n=t.disabled,s=t.href,r=t.onClick;(n||me(s))&&e.preventDefault(),n?e.stopPropagation():r&&r(e)},t.prototype.handleKeyDown=function(e){" "===e.key&&(e.preventDefault(),this.handleClick(e))},t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.disabled,s=e.onKeyDown,r=v()(e,["componentClass","disabled","onKeyDown"]);return me(r.href)&&(r.role=r.role||"button",r.href=r.href||"#"),n&&(r.tabIndex=-1,r.style=o()({pointerEvents:"none"},r.style)),f.a.createElement(t,o()({},r,{onClick:this.handleClick,onKeyDown:q(this.handleKeyDown,s)}))},t}(f.a.Component);ge.propTypes=fe,ge.defaultProps={componentClass:"a"};var ye=ge,ve={active:S.a.bool,href:S.a.string,title:S.a.node,target:S.a.string},be=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.active,n=e.href,s=e.title,r=e.target,a=e.className,i=v()(e,["active","href","title","target","className"]),l={href:n,title:s,target:r};return f.a.createElement("li",{className:_()(a,{active:t})},t?f.a.createElement("span",i):f.a.createElement(ye,o()({},i,l)))},t}(f.a.Component);be.propTypes=ve,be.defaultProps={active:!1};var _e=be,Ee=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=Y(s);return f.a.createElement("ol",o()({},r,{role:"navigation","aria-label":"breadcrumbs",className:_()(t,a)}))},t}(f.a.Component);Ee.Item=_e;var Se=G("breadcrumb",Ee),we={active:S.a.bool,disabled:S.a.bool,block:S.a.bool,onClick:S.a.func,componentClass:pe.a,href:S.a.string,type:S.a.oneOf(["button","reset","submit"])},Ce=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.renderAnchor=function(e,t){return f.a.createElement(ye,o()({},e,{className:_()(t,e.disabled&&"disabled")}))},t.prototype.renderButton=function(e,t){var n=e.componentClass,s=v()(e,["componentClass"]),r=n||"button";return f.a.createElement(r,o()({},s,{type:s.type||"button",className:t}))},t.prototype.render=function(){var e,t=this.props,n=t.active,s=t.block,r=t.className,a=$(v()(t,["active","block","className"])),i=a[0],l=a[1],c=o()({},Y(i),((e={active:n})[F(i,"block")]=s,e)),u=_()(r,c);return l.href?this.renderAnchor(l,u):this.renderButton(l,u)},t}(f.a.Component);Ce.propTypes=we,Ce.defaultProps={active:!1,block:!1,disabled:!1};var Oe=G("btn",W([M,A,N],j([].concat(ne()(I),[D,k,L]),D,Ce))),Te=n(68),Me=n.n(Te),Ae={vertical:S.a.bool,justified:S.a.bool,block:Me()(S.a.bool,(function(e){var t=e.block,n=e.vertical;return t&&!n?new Error("`block` requires `vertical` to be set to have any effect"):null}))},Ne=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.block,s=t.justified,r=t.vertical,a=t.className,i=$(v()(t,["block","justified","vertical","className"])),l=i[0],c=i[1],u=o()({},Y(l),((e={})[F(l)]=!r,e[F(l,"vertical")]=r,e[F(l,"justified")]=s,e[F(Oe.defaultProps,"block")]=n,e));return f.a.createElement("div",o()({},c,{className:_()(a,u)}))},t}(f.a.Component);Ne.propTypes=Ae,Ne.defaultProps={block:!1,justified:!1,vertical:!1};var xe=G("btn-group",Ne),Pe=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=Y(s);return f.a.createElement("div",o()({},r,{role:"toolbar",className:_()(t,a)}))},t}(f.a.Component),Ie=G("btn-toolbar",Pe),De={componentClass:pe.a},ke=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=Y(r);return f.a.createElement(t,o()({},a,{className:_()(n,i)}))},t}(f.a.Component);ke.propTypes=De,ke.defaultProps={componentClass:"div"};var Le=G("carousel-caption",ke),Re=n(17),Be=n.n(Re),Fe=!("undefined"==typeof window||!window.document||!window.document.createElement),Ge={transitionend:{transition:"transitionend",WebkitTransition:"webkitTransitionEnd",MozTransition:"mozTransitionEnd",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd"},animationend:{animation:"animationend",WebkitAnimation:"webkitAnimationEnd",MozAnimation:"mozAnimationEnd",OAnimation:"oAnimationEnd",msAnimation:"MSAnimationEnd"}},je=[];Fe&&function(){var e=document.createElement("div").style;for(var t in"AnimationEvent"in window||delete Ge.animationend.animation,"TransitionEvent"in window||delete Ge.transitionend.transition,Ge){var n=Ge[t];for(var s in n)if(s in e){je.push(n[s]);break}}}();var We={addEndEventListener:function(e,t){0!==je.length?je.forEach((function(n){!function(e,t,n){e.addEventListener(t,n,!1)}(e,n,t)})):window.setTimeout(t,0)},removeEndEventListener:function(e,t){0!==je.length&&je.forEach((function(n){!function(e,t,n){e.removeEventListener(t,n,!1)}(e,n,t)}))}},Ye={direction:S.a.oneOf(["prev","next"]),onAnimateOutEnd:S.a.func,active:S.a.bool,animateIn:S.a.bool,animateOut:S.a.bool,index:S.a.number},Xe=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleAnimateOutEnd=r.handleAnimateOutEnd.bind(r),r.state={direction:null},r.isUnmounted=!1,r}return d()(t,e),t.prototype.componentWillReceiveProps=function(e){this.props.active!==e.active&&this.setState({direction:null})},t.prototype.componentDidUpdate=function(e){var t=this,n=this.props.active,s=e.active;!n&&s&&We.addEndEventListener(Be.a.findDOMNode(this),this.handleAnimateOutEnd),n!==s&&setTimeout((function(){return t.startAnimation()}),20)},t.prototype.componentWillUnmount=function(){this.isUnmounted=!0},t.prototype.handleAnimateOutEnd=function(){this.isUnmounted||this.props.onAnimateOutEnd&&this.props.onAnimateOutEnd(this.props.index)},t.prototype.startAnimation=function(){this.isUnmounted||this.setState({direction:"prev"===this.props.direction?"right":"left"})},t.prototype.render=function(){var e=this.props,t=e.direction,n=e.active,s=e.animateIn,r=e.animateOut,a=e.className,i=v()(e,["direction","active","animateIn","animateOut","className"]);delete i.onAnimateOutEnd,delete i.index;var l={item:!0,active:n&&!s||r};return t&&n&&s&&(l[t]=!0),this.state.direction&&(s||r)&&(l[this.state.direction]=!0),f.a.createElement("div",o()({},i,{className:_()(a,l)}))},t}(f.a.Component);Xe.propTypes=Ye,Xe.defaultProps={active:!1,animateIn:!1,animateOut:!1};var Ue=Xe,$e={glyph:S.a.string.isRequired},He=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.glyph,s=t.className,r=$(v()(t,["glyph","className"])),a=r[0],i=r[1],l=o()({},Y(a),((e={})[F(a,n)]=!0,e));return f.a.createElement("span",o()({},i,{className:_()(s,l)}))},t}(f.a.Component);He.propTypes=$e;var Ve=G("glyphicon",He),Ke={slide:S.a.bool,indicators:S.a.bool,interval:S.a.number,controls:S.a.bool,pauseOnHover:S.a.bool,wrap:S.a.bool,onSelect:S.a.func,onSlideEnd:S.a.func,activeIndex:S.a.number,defaultActiveIndex:S.a.number,direction:S.a.oneOf(["prev","next"]),prevIcon:S.a.node,prevLabel:S.a.string,nextIcon:S.a.node,nextLabel:S.a.string},qe={slide:!0,interval:5e3,pauseOnHover:!0,wrap:!0,indicators:!0,controls:!0,prevIcon:f.a.createElement(Ve,{glyph:"chevron-left"}),prevLabel:"Previous",nextIcon:f.a.createElement(Ve,{glyph:"chevron-right"}),nextLabel:"Next"},ze=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));r.handleMouseOver=r.handleMouseOver.bind(r),r.handleMouseOut=r.handleMouseOut.bind(r),r.handlePrev=r.handlePrev.bind(r),r.handleNext=r.handleNext.bind(r),r.handleItemAnimateOutEnd=r.handleItemAnimateOutEnd.bind(r);var a=n.defaultActiveIndex;return r.state={activeIndex:null!=a?a:0,previousActiveIndex:null,direction:null},r.isUnmounted=!1,r}return d()(t,e),t.prototype.componentDidMount=function(){this.waitForNext()},t.prototype.componentWillReceiveProps=function(e){var t=this.getActiveIndex();null!=e.activeIndex&&e.activeIndex!==t&&(clearTimeout(this.timeout),this.setState({previousActiveIndex:t,direction:null!=e.direction?e.direction:this.getDirection(t,e.activeIndex)})),null==e.activeIndex&&this.state.activeIndex>=e.children.length&&this.setState({activeIndex:0,previousActiveIndex:null,direction:null})},t.prototype.componentWillUnmount=function(){clearTimeout(this.timeout),this.isUnmounted=!0},t.prototype.getActiveIndex=function(){var e=this.props.activeIndex;return null!=e?e:this.state.activeIndex},t.prototype.getDirection=function(e,t){return e===t?null:e>t?"prev":"next"},t.prototype.handleItemAnimateOutEnd=function(){var e=this;this.setState({previousActiveIndex:null,direction:null},(function(){e.waitForNext(),e.props.onSlideEnd&&e.props.onSlideEnd()}))},t.prototype.handleMouseOut=function(){this.isPaused&&this.play()},t.prototype.handleMouseOver=function(){this.props.pauseOnHover&&this.pause()},t.prototype.handleNext=function(e){var t=this.getActiveIndex()+1;if(t>z.count(this.props.children)-1){if(!this.props.wrap)return;t=0}this.select(t,e,"next")},t.prototype.handlePrev=function(e){var t=this.getActiveIndex()-1;if(t<0){if(!this.props.wrap)return;t=z.count(this.props.children)-1}this.select(t,e,"prev")},t.prototype.pause=function(){this.isPaused=!0,clearTimeout(this.timeout)},t.prototype.play=function(){this.isPaused=!1,this.waitForNext()},t.prototype.select=function(e,t,n){if(clearTimeout(this.timeout),!this.isUnmounted){var s=this.props.slide?this.getActiveIndex():null;n=n||this.getDirection(s,e);var r=this.props.onSelect;if(r&&(r.length>1?(t?(t.persist(),t.direction=n):t={direction:n},r(e,t)):r(e)),null==this.props.activeIndex&&e!==s){if(null!=this.state.previousActiveIndex)return;this.setState({activeIndex:e,previousActiveIndex:s,direction:n})}}},t.prototype.waitForNext=function(){var e=this.props,t=e.slide,n=e.interval,s=e.activeIndex;!this.isPaused&&t&&n&&null==s&&(this.timeout=setTimeout(this.handleNext,n))},t.prototype.renderControls=function(e){var t=e.wrap,n=e.children,s=e.activeIndex,r=e.prevIcon,a=e.nextIcon,o=e.bsProps,i=e.prevLabel,l=e.nextLabel,c=F(o,"control"),u=z.count(n);return[(t||0!==s)&&f.a.createElement(ye,{key:"prev",className:_()(c,"left"),onClick:this.handlePrev},r,i&&f.a.createElement("span",{className:"sr-only"},i)),(t||s!==u-1)&&f.a.createElement(ye,{key:"next",className:_()(c,"right"),onClick:this.handleNext},a,l&&f.a.createElement("span",{className:"sr-only"},l))]},t.prototype.renderIndicators=function(e,t,n){var s=this,r=[];return z.forEach(e,(function(e,n){r.push(f.a.createElement("li",{key:n,className:n===t?"active":null,onClick:function(e){return s.select(n,e)}})," ")})),f.a.createElement("ol",{className:F(n,"indicators")},r)},t.prototype.render=function(){var e=this,t=this.props,n=t.slide,s=t.indicators,r=t.controls,a=t.wrap,i=t.prevIcon,l=t.prevLabel,c=t.nextIcon,u=t.nextLabel,h=t.className,d=t.children,m=v()(t,["slide","indicators","controls","wrap","prevIcon","prevLabel","nextIcon","nextLabel","className","children"]),g=this.state,y=g.previousActiveIndex,b=g.direction,E=H(m,["interval","pauseOnHover","onSelect","onSlideEnd","activeIndex","defaultActiveIndex","direction"]),S=E[0],w=E[1],C=this.getActiveIndex(),O=o()({},Y(S),{slide:n});return f.a.createElement("div",o()({},w,{className:_()(h,O),onMouseOver:this.handleMouseOver,onMouseOut:this.handleMouseOut}),s&&this.renderIndicators(d,C,S),f.a.createElement("div",{className:F(S,"inner")},z.map(d,(function(t,s){var r=s===C,a=n&&s===y;return Object(p.cloneElement)(t,{active:r,index:s,animateOut:a,animateIn:r&&null!=y&&n,direction:b,onAnimateOutEnd:a?e.handleItemAnimateOutEnd:null})}))),r&&this.renderControls({wrap:a,children:d,activeIndex:C,prevIcon:i,prevLabel:l,nextIcon:c,nextLabel:u,bsProps:S}))},t}(f.a.Component);ze.propTypes=Ke,ze.defaultProps=qe,ze.Caption=Le,ze.Item=Ue;var Je=G("carousel",ze),Qe=(n(32),{inline:S.a.bool,disabled:S.a.bool,title:S.a.string,validationState:S.a.oneOf(["success","warning","error",null]),inputRef:S.a.func}),Ze=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.inline,n=e.disabled,s=e.validationState,r=e.inputRef,a=e.className,i=e.style,l=e.title,c=e.children,u=$(v()(e,["inline","disabled","validationState","inputRef","className","style","title","children"])),h=u[0],d=u[1],p=f.a.createElement("input",o()({},d,{ref:r,type:"checkbox",disabled:n}));if(t){var m,g=((m={})[F(h,"inline")]=!0,m.disabled=n,m);return f.a.createElement("label",{className:_()(a,g),style:i,title:l},p,c)}var y=o()({},Y(h),{disabled:n});return s&&(y["has-"+s]=!0),f.a.createElement("div",{className:_()(a,y),style:i},f.a.createElement("label",{title:l},p,c))},t}(f.a.Component);Ze.propTypes=Qe,Ze.defaultProps={inline:!1,disabled:!1,title:""};var et=G("checkbox",Ze);function tt(e){return""+e.charAt(0).toUpperCase()+e.slice(1)}var nt={componentClass:pe.a,visibleXsBlock:S.a.bool,visibleSmBlock:S.a.bool,visibleMdBlock:S.a.bool,visibleLgBlock:S.a.bool},st=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=Y(r);return P.forEach((function(e){var t="visible"+tt(e)+"Block";a[t]&&(i["visible-"+e+"-block"]=!0),delete a[t]})),f.a.createElement(t,o()({},a,{className:_()(n,i)}))},t}(f.a.Component);st.propTypes=nt,st.defaultProps={componentClass:"div"};var rt=G("clearfix",st),at={htmlFor:S.a.string,srOnly:S.a.bool},ot={$bs_formGroup:S.a.object},it=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.context.$bs_formGroup,t=e&&e.controlId,n=this.props,s=n.htmlFor,r=void 0===s?t:s,a=n.srOnly,i=n.className,l=$(v()(n,["htmlFor","srOnly","className"])),c=l[0],u=l[1],h=o()({},Y(c),{"sr-only":a});return f.a.createElement("label",o()({},u,{htmlFor:r,className:_()(i,h)}))},t}(f.a.Component);it.propTypes=at,it.defaultProps={srOnly:!1},it.contextTypes=ot;var lt=G("control-label",it),ct={componentClass:pe.a,xs:S.a.number,sm:S.a.number,md:S.a.number,lg:S.a.number,xsHidden:S.a.bool,smHidden:S.a.bool,mdHidden:S.a.bool,lgHidden:S.a.bool,xsOffset:S.a.number,smOffset:S.a.number,mdOffset:S.a.number,lgOffset:S.a.number,xsPush:S.a.number,smPush:S.a.number,mdPush:S.a.number,lgPush:S.a.number,xsPull:S.a.number,smPull:S.a.number,mdPull:S.a.number,lgPull:S.a.number},ut=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=[];return P.forEach((function(e){function t(t,n){var s=""+e+t,o=a[s];null!=o&&i.push(F(r,""+e+n+"-"+o)),delete a[s]}t("",""),t("Offset","-offset"),t("Push","-push"),t("Pull","-pull");var n=e+"Hidden";a[n]&&i.push("hidden-"+e),delete a[n]})),f.a.createElement(t,o()({},a,{className:_()(n,i)}))},t}(f.a.Component);ut.propTypes=ct,ut.defaultProps={componentClass:"div"};var ht=G("col",ut),dt=n(67),pt=n.n(dt),ft=n(173),mt=n.n(ft),gt={height:["marginTop","marginBottom"],width:["marginLeft","marginRight"]};var yt={in:S.a.bool,mountOnEnter:S.a.bool,unmountOnExit:S.a.bool,transitionAppear:S.a.bool,timeout:S.a.number,onEnter:S.a.func,onEntering:S.a.func,onEntered:S.a.func,onExit:S.a.func,onExiting:S.a.func,onExited:S.a.func,dimension:S.a.oneOfType([S.a.oneOf(["height","width"]),S.a.func]),getDimensionValue:S.a.func,role:S.a.string},vt={in:!1,timeout:300,mountOnEnter:!1,unmountOnExit:!1,transitionAppear:!1,dimension:"height",getDimensionValue:function(e,t){var n=t["offset"+tt(e)],s=gt[e];return n+parseInt(pt()(t,s[0]),10)+parseInt(pt()(t,s[1]),10)}},bt=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleEnter=r.handleEnter.bind(r),r.handleEntering=r.handleEntering.bind(r),r.handleEntered=r.handleEntered.bind(r),r.handleExit=r.handleExit.bind(r),r.handleExiting=r.handleExiting.bind(r),r}return d()(t,e),t.prototype._dimension=function(){return"function"==typeof this.props.dimension?this.props.dimension():this.props.dimension},t.prototype._getScrollDimensionValue=function(e,t){return e["scroll"+tt(t)]+"px"},t.prototype.handleEnter=function(e){var t=this._dimension();e.style[t]="0"},t.prototype.handleEntered=function(e){var t=this._dimension();e.style[t]=null},t.prototype.handleEntering=function(e){var t=this._dimension();e.style[t]=this._getScrollDimensionValue(e,t)},t.prototype.handleExit=function(e){var t=this._dimension();e.style[t]=this.props.getDimensionValue(t,e)+"px",e.offsetHeight},t.prototype.handleExiting=function(e){var t=this._dimension();e.style[t]="0"},t.prototype.render=function(){var e=this.props,t=e.onEnter,n=e.onEntering,s=e.onEntered,r=e.onExit,a=e.onExiting,i=e.className,l=v()(e,["onEnter","onEntering","onEntered","onExit","onExiting","className"]);delete l.dimension,delete l.getDimensionValue;var c=q(this.handleEnter,t),u=q(this.handleEntering,n),h=q(this.handleEntered,s),d=q(this.handleExit,r),p=q(this.handleExiting,a),m={width:"width"===this._dimension()};return f.a.createElement(mt.a,o()({},l,{"aria-expanded":l.role?l.in:null,className:_()(i,m),exitedClassName:"collapse",exitingClassName:"collapsing",enteredClassName:"collapse in",enteringClassName:"collapsing",onEnter:c,onEntering:u,onEntered:h,onExit:d,onExiting:p}))},t}(f.a.Component);bt.propTypes=yt,bt.defaultProps=vt;var _t=bt,Et=n(171),St=n.n(Et),wt=n(58),Ct=n.n(wt),Ot=n(33),Tt=n.n(Ot),Mt=n(69),At=n.n(Mt),Nt=n(53),xt=n.n(Nt),Pt=n(421),It=n.n(Pt),Dt=n(251),kt=n.n(Dt),Lt={open:S.a.bool,pullRight:S.a.bool,onClose:S.a.func,labelledBy:S.a.oneOfType([S.a.string,S.a.number]),onSelect:S.a.func,rootCloseEvent:S.a.oneOf(["click","mousedown"])},Rt=function(e){function t(n){l()(this,t);var s=u()(this,e.call(this,n));return s.handleRootClose=s.handleRootClose.bind(s),s.handleKeyDown=s.handleKeyDown.bind(s),s}return d()(t,e),t.prototype.getFocusableMenuItems=function(){var e=Be.a.findDOMNode(this);return e?It()(e.querySelectorAll('[tabIndex="-1"]')):[]},t.prototype.getItemsAndActiveIndex=function(){var e=this.getFocusableMenuItems(),t=e.indexOf(document.activeElement);return{items:e,activeIndex:t}},t.prototype.focusNext=function(){var e=this.getItemsAndActiveIndex(),t=e.items,n=e.activeIndex;0!==t.length&&t[n===t.length-1?0:n+1].focus()},t.prototype.focusPrevious=function(){var e=this.getItemsAndActiveIndex(),t=e.items,n=e.activeIndex;0!==t.length&&t[0===n?t.length-1:n-1].focus()},t.prototype.handleKeyDown=function(e){switch(e.keyCode){case Tt.a.codes.down:this.focusNext(),e.preventDefault();break;case Tt.a.codes.up:this.focusPrevious(),e.preventDefault();break;case Tt.a.codes.esc:case Tt.a.codes.tab:this.props.onClose(e,{source:"keydown"})}},t.prototype.handleRootClose=function(e){this.props.onClose(e,{source:"rootClose"})},t.prototype.render=function(){var e,t=this,n=this.props,s=n.open,r=n.pullRight,a=n.labelledBy,i=n.onSelect,l=n.className,c=n.rootCloseEvent,u=n.children,h=H(v()(n,["open","pullRight","labelledBy","onSelect","className","rootCloseEvent","children"]),["onClose"]),d=h[0],p=h[1],m=o()({},Y(d),((e={})[F(d,"right")]=r,e));return f.a.createElement(kt.a,{disabled:!s,onRootClose:this.handleRootClose,event:c},f.a.createElement("ul",o()({},p,{role:"menu",className:_()(l,m),"aria-labelledby":a}),z.map(u,(function(e){return f.a.cloneElement(e,{onKeyDown:q(e.props.onKeyDown,t.handleKeyDown),onSelect:q(e.props.onSelect,i)})}))))},t}(f.a.Component);Rt.propTypes=Lt,Rt.defaultProps={bsRole:"menu",pullRight:!1};var Bt=G("dropdown-menu",Rt),Ft={noCaret:S.a.bool,open:S.a.bool,title:S.a.string,useAnchor:S.a.bool},Gt=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.noCaret,n=e.open,s=e.useAnchor,r=e.bsClass,a=e.className,i=e.children,l=v()(e,["noCaret","open","useAnchor","bsClass","className","children"]);delete l.bsRole;var c=s?ye:Oe,u=!t;return f.a.createElement(c,o()({},l,{role:"button",className:_()(a,r),"aria-haspopup":!0,"aria-expanded":n}),i||l.title,u&&" ",u&&f.a.createElement("span",{className:"caret"}))},t}(f.a.Component);Gt.propTypes=Ft,Gt.defaultProps={open:!1,useAnchor:!1,bsRole:"toggle"};var jt=G("dropdown-toggle",Gt),Wt=n(107),Yt=n.n(Wt);var Xt=jt.defaultProps.bsRole,Ut=Bt.defaultProps.bsRole,$t={dropup:S.a.bool,id:At()(S.a.oneOfType([S.a.string,S.a.number])),componentClass:pe.a,children:Me()(function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return Yt()((function(e,n,s){var r=void 0;return t.every((function(t){return!!z.some(e.children,(function(e){return e.props.bsRole===t}))||(r=t,!1)})),r?new Error("(children) "+s+" - Missing a required child with bsRole: "+r+". "+s+" must have at least one child of each of the following bsRoles: "+t.join(", ")):null}))}(Xt,Ut),function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return Yt()((function(e,n,s){var r=void 0;return t.every((function(t){return!(z.filter(e.children,(function(e){return e.props.bsRole===t})).length>1)||(r=t,!1)})),r?new Error("(children) "+s+" - Duplicate children detected of bsRole: "+r+". Only one child each allowed with the following bsRoles: "+t.join(", ")):null}))}(Ut)),disabled:S.a.bool,pullRight:S.a.bool,open:S.a.bool,defaultOpen:S.a.bool,onToggle:S.a.func,onSelect:S.a.func,role:S.a.string,rootCloseEvent:S.a.oneOf(["click","mousedown"]),onMouseEnter:S.a.func,onMouseLeave:S.a.func},Ht={componentClass:xe},Vt=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleClick=r.handleClick.bind(r),r.handleKeyDown=r.handleKeyDown.bind(r),r.handleClose=r.handleClose.bind(r),r._focusInDropdown=!1,r.lastOpenEventType=null,r}return d()(t,e),t.prototype.componentDidMount=function(){this.focusNextOnOpen()},t.prototype.componentWillUpdate=function(e){!e.open&&this.props.open&&(this._focusInDropdown=Ct()(Be.a.findDOMNode(this.menu),St()(document)))},t.prototype.componentDidUpdate=function(e){var t=this.props.open,n=e.open;t&&!n&&this.focusNextOnOpen(),!t&&n&&this._focusInDropdown&&(this._focusInDropdown=!1,this.focus())},t.prototype.focus=function(){var e=Be.a.findDOMNode(this.toggle);e&&e.focus&&e.focus()},t.prototype.focusNextOnOpen=function(){var e=this.menu;e.focusNext&&("keydown"!==this.lastOpenEventType&&"menuitem"!==this.props.role||e.focusNext())},t.prototype.handleClick=function(e){this.props.disabled||this.toggleOpen(e,{source:"click"})},t.prototype.handleClose=function(e,t){this.props.open&&this.toggleOpen(e,t)},t.prototype.handleKeyDown=function(e){if(!this.props.disabled)switch(e.keyCode){case Tt.a.codes.down:this.props.open?this.menu.focusNext&&this.menu.focusNext():this.toggleOpen(e,{source:"keydown"}),e.preventDefault();break;case Tt.a.codes.esc:case Tt.a.codes.tab:this.handleClose(e,{source:"keydown"})}},t.prototype.toggleOpen=function(e,t){var n=!this.props.open;n&&(this.lastOpenEventType=t.source),this.props.onToggle&&this.props.onToggle(n,e,t)},t.prototype.renderMenu=function(e,t){var n=this,s=t.id,r=t.onSelect,a=t.rootCloseEvent,i=v()(t,["id","onSelect","rootCloseEvent"]),l=function(e){n.menu=e};return"string"==typeof e.ref||(l=q(e.ref,l)),Object(p.cloneElement)(e,o()({},i,{ref:l,labelledBy:s,bsClass:F(i,"menu"),onClose:q(e.props.onClose,this.handleClose),onSelect:q(e.props.onSelect,r,(function(e,t){return n.handleClose(t,{source:"select"})})),rootCloseEvent:a}))},t.prototype.renderToggle=function(e,t){var n=this,s=function(e){n.toggle=e};return"string"==typeof e.ref||(s=q(e.ref,s)),Object(p.cloneElement)(e,o()({},t,{ref:s,bsClass:F(t,"toggle"),onClick:q(e.props.onClick,this.handleClick),onKeyDown:q(e.props.onKeyDown,this.handleKeyDown)}))},t.prototype.render=function(){var e,t=this,n=this.props,s=n.componentClass,r=n.id,a=n.dropup,i=n.disabled,l=n.pullRight,c=n.open,u=n.onSelect,h=n.role,d=n.bsClass,p=n.className,m=n.rootCloseEvent,g=n.children,y=v()(n,["componentClass","id","dropup","disabled","pullRight","open","onSelect","role","bsClass","className","rootCloseEvent","children"]);delete y.onToggle;var b=((e={})[d]=!0,e.open=c,e.disabled=i,e);return a&&(b[d]=!1,b.dropup=!0),f.a.createElement(s,o()({},y,{className:_()(p,b)}),z.map(g,(function(e){switch(e.props.bsRole){case Xt:return t.renderToggle(e,{id:r,disabled:i,open:c,role:h,bsClass:d});case Ut:return t.renderMenu(e,{id:r,open:c,pullRight:l,bsClass:d,onSelect:u,rootCloseEvent:m});default:return e}})))},t}(f.a.Component);Vt.propTypes=$t,Vt.defaultProps=Ht,G("dropdown",Vt);var Kt=xt()(Vt,{open:"onToggle"});Kt.Toggle=jt,Kt.Menu=Bt;var qt=Kt;function zt(e,t){var n=t.propTypes,s={},r={};return C()(e).forEach((function(e){var t=e[0],a=e[1];n[t]?s[t]=a:r[t]=a})),[s,r]}var Jt=o()({},qt.propTypes,{bsStyle:S.a.string,bsSize:S.a.string,title:S.a.node.isRequired,noCaret:S.a.bool,children:S.a.node}),Qt=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.bsSize,n=e.bsStyle,s=e.title,r=e.children,a=zt(v()(e,["bsSize","bsStyle","title","children"]),qt.ControlledComponent),i=a[0],l=a[1];return f.a.createElement(qt,o()({},i,{bsSize:t,bsStyle:n}),f.a.createElement(qt.Toggle,o()({},l,{bsSize:t,bsStyle:n}),s),f.a.createElement(qt.Menu,null,r))},t}(f.a.Component);Qt.propTypes=Jt;var Zt=Qt,en={in:S.a.bool,mountOnEnter:S.a.bool,unmountOnExit:S.a.bool,transitionAppear:S.a.bool,timeout:S.a.number,onEnter:S.a.func,onEntering:S.a.func,onEntered:S.a.func,onExit:S.a.func,onExiting:S.a.func,onExited:S.a.func},tn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){return f.a.createElement(mt.a,o()({},this.props,{className:_()(this.props.className,"fade"),enteredClassName:"in",enteringClassName:"in"}))},t}(f.a.Component);tn.propTypes=en,tn.defaultProps={in:!1,timeout:300,mountOnEnter:!1,unmountOnExit:!1,transitionAppear:!1};var nn=tn,sn={horizontal:S.a.bool,inline:S.a.bool,componentClass:pe.a},rn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.horizontal,n=e.inline,s=e.componentClass,r=e.className,a=$(v()(e,["horizontal","inline","componentClass","className"])),i=a[0],l=a[1],c=[];return t&&c.push(F(i,"horizontal")),n&&c.push(F(i,"inline")),f.a.createElement(s,o()({},l,{className:_()(r,c)}))},t}(f.a.Component);rn.propTypes=sn,rn.defaultProps={horizontal:!1,inline:!1,componentClass:"form"};var an=G("form",rn),on={$bs_formGroup:S.a.object},ln=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.getGlyph=function(e){switch(e){case"success":return"ok";case"warning":return"warning-sign";case"error":return"remove";default:return null}},t.prototype.renderDefaultFeedback=function(e,t,n,s){var r=this.getGlyph(e&&e.validationState);return r?f.a.createElement(Ve,o()({},s,{glyph:r,className:_()(t,n)})):null},t.prototype.render=function(){var e=this.props,t=e.className,n=e.children,s=$(v()(e,["className","children"])),r=s[0],a=s[1],i=Y(r);if(!n)return this.renderDefaultFeedback(this.context.$bs_formGroup,t,i,a);var l=f.a.Children.only(n);return f.a.cloneElement(l,o()({},a,{className:_()(l.props.className,t,i)}))},t}(f.a.Component);ln.defaultProps={bsRole:"feedback"},ln.contextTypes=on;var cn=G("form-control-feedback",ln),un={componentClass:pe.a},hn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=Y(r);return f.a.createElement(t,o()({},a,{className:_()(n,i)}))},t}(f.a.Component);hn.propTypes=un,hn.defaultProps={componentClass:"p"};var dn=G("form-control-static",hn),pn={componentClass:pe.a,type:S.a.string,id:S.a.string,inputRef:S.a.func},fn={$bs_formGroup:S.a.object},mn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.context.$bs_formGroup,t=e&&e.controlId,n=this.props,s=n.componentClass,r=n.type,a=n.id,i=void 0===a?t:a,l=n.inputRef,c=n.className,u=n.bsSize,h=$(v()(n,["componentClass","type","id","inputRef","className","bsSize"])),d=h[0],p=h[1],m=void 0;("file"!==r&&(m=Y(d)),u)&&(m[F({bsClass:"input"},x[u]||u)]=!0);return f.a.createElement(s,o()({},p,{type:r,id:i,ref:l,className:_()(c,m)}))},t}(f.a.Component);mn.propTypes=pn,mn.defaultProps={componentClass:"input"},mn.contextTypes=fn,mn.Feedback=cn,mn.Static=dn;var gn=G("form-control",W([A,M],mn)),yn={controlId:S.a.string,validationState:S.a.oneOf(["success","warning","error",null])},vn={$bs_formGroup:S.a.object.isRequired},bn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.getChildContext=function(){var e=this.props;return{$bs_formGroup:{controlId:e.controlId,validationState:e.validationState}}},t.prototype.hasFeedback=function(e){var t=this;return z.some(e,(function(e){return"feedback"===e.props.bsRole||e.props.children&&t.hasFeedback(e.props.children)}))},t.prototype.render=function(){var e=this.props,t=e.validationState,n=e.className,s=e.children,r=H(v()(e,["validationState","className","children"]),["controlId"]),a=r[0],i=r[1],l=o()({},Y(a),{"has-feedback":this.hasFeedback(s)});return t&&(l["has-"+t]=!0),f.a.createElement("div",o()({},i,{className:_()(n,l)}),s)},t}(f.a.Component);bn.propTypes=yn,bn.childContextTypes=vn;var _n=G("form-group",W([M,A],bn)),En={fluid:S.a.bool,componentClass:pe.a},Sn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.fluid,n=e.componentClass,s=e.className,r=$(v()(e,["fluid","componentClass","className"])),a=r[0],i=r[1],l=F(a,t&&"fluid");return f.a.createElement(n,o()({},i,{className:_()(s,l)}))},t}(f.a.Component);Sn.propTypes=En,Sn.defaultProps={componentClass:"div",fluid:!1};var wn=G("container",Sn),Cn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=Y(s);return f.a.createElement("span",o()({},r,{className:_()(t,a)}))},t}(f.a.Component),On=G("help-block",Cn),Tn={responsive:S.a.bool,rounded:S.a.bool,circle:S.a.bool,thumbnail:S.a.bool},Mn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.responsive,s=t.rounded,r=t.circle,a=t.thumbnail,i=t.className,l=$(v()(t,["responsive","rounded","circle","thumbnail","className"])),c=l[0],u=l[1],h=((e={})[F(c,"responsive")]=n,e[F(c,"rounded")]=s,e[F(c,"circle")]=r,e[F(c,"thumbnail")]=a,e);return f.a.createElement("img",o()({},u,{className:_()(i,h)}))},t}(f.a.Component);Mn.propTypes=Tn,Mn.defaultProps={responsive:!1,rounded:!1,circle:!1,thumbnail:!1};var An=G("img",Mn),Nn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=Y(s);return f.a.createElement("span",o()({},r,{className:_()(t,a)}))},t}(f.a.Component),xn=G("input-group-addon",Nn),Pn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=Y(s);return f.a.createElement("span",o()({},r,{className:_()(t,a)}))},t}(f.a.Component),In=G("input-group-btn",Pn),Dn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=Y(s);return f.a.createElement("span",o()({},r,{className:_()(t,a)}))},t}(f.a.Component);Dn.Addon=xn,Dn.Button=In;var kn=G("input-group",W([M,A],Dn)),Ln={componentClass:pe.a},Rn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=Y(r);return f.a.createElement(t,o()({},a,{className:_()(n,i)}))},t}(f.a.Component);Rn.propTypes=Ln,Rn.defaultProps={componentClass:"div"};var Bn=G("jumbotron",Rn),Fn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.hasContent=function(e){var t=!1;return f.a.Children.forEach(e,(function(e){t||(e||0===e)&&(t=!0)})),t},t.prototype.render=function(){var e=this.props,t=e.className,n=e.children,s=$(v()(e,["className","children"])),r=s[0],a=s[1],i=o()({},Y(r),{hidden:!this.hasContent(n)});return f.a.createElement("span",o()({},a,{className:_()(t,i)}),n)},t}(f.a.Component),Gn=G("label",j([].concat(ne()(I),[D,k]),D,Fn)),jn={active:S.a.any,disabled:S.a.any,header:S.a.node,listItem:S.a.bool,onClick:S.a.func,href:S.a.string,type:S.a.string},Wn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.renderHeader=function(e,t){return f.a.isValidElement(e)?Object(p.cloneElement)(e,{className:_()(e.props.className,t)}):f.a.createElement("h4",{className:t},e)},t.prototype.render=function(){var e=this.props,t=e.active,n=e.disabled,s=e.className,r=e.header,a=e.listItem,i=e.children,l=$(v()(e,["active","disabled","className","header","listItem","children"])),c=l[0],u=l[1],h=o()({},Y(c),{active:t,disabled:n}),d=void 0;return u.href?d="a":u.onClick?(d="button",u.type=u.type||"button"):d=a?"li":"span",u.className=_()(s,h),r?f.a.createElement(d,u,this.renderHeader(r,F(c,"heading")),f.a.createElement("p",{className:F(c,"text")},i)):f.a.createElement(d,u,i)},t}(f.a.Component);Wn.propTypes=jn,Wn.defaultProps={listItem:!1};var Yn=G("list-group-item",j(ne()(I),Wn)),Xn={componentClass:pe.a};var Un=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.children,n=e.componentClass,s=void 0===n?function(e){return e?z.some(e,(function(e){return e.type!==Yn||e.props.href||e.props.onClick}))?"div":"ul":"div"}(t):n,r=e.className,a=$(v()(e,["children","componentClass","className"])),i=a[0],l=a[1],c=Y(i),u="ul"===s&&z.every(t,(function(e){return e.type===Yn}));return f.a.createElement(s,o()({},l,{className:_()(r,c)}),u?z.map(t,(function(e){return Object(p.cloneElement)(e,{listItem:!0})})):t)},t}(f.a.Component);Un.propTypes=Xn;var $n=G("list-group",Un),Hn={align:S.a.oneOf(["top","middle","bottom"]),componentClass:pe.a},Vn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.align,s=e.className,r=$(v()(e,["componentClass","align","className"])),a=r[0],i=r[1],l=Y(a);return n&&(l[F(us.defaultProps,n)]=!0),f.a.createElement(t,o()({},i,{className:_()(s,l)}))},t}(f.a.Component);Vn.propTypes=Hn,Vn.defaultProps={componentClass:"div"};var Kn=G("media-body",Vn),qn={componentClass:pe.a},zn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=Y(r);return f.a.createElement(t,o()({},a,{className:_()(n,i)}))},t}(f.a.Component);zn.propTypes=qn,zn.defaultProps={componentClass:"h4"};var Jn=G("media-heading",zn),Qn={align:S.a.oneOf(["top","middle","bottom"])},Zn=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.align,n=e.className,s=$(v()(e,["align","className"])),r=s[0],a=s[1],i=Y(r);return t&&(i[F(us.defaultProps,t)]=!0),f.a.createElement("div",o()({},a,{className:_()(n,i)}))},t}(f.a.Component);Zn.propTypes=Qn;var es=G("media-left",Zn),ts=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=Y(s);return f.a.createElement("ul",o()({},r,{className:_()(t,a)}))},t}(f.a.Component),ns=G("media-list",ts),ss=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=Y(s);return f.a.createElement("li",o()({},r,{className:_()(t,a)}))},t}(f.a.Component),rs=G("media",ss),as={align:S.a.oneOf(["top","middle","bottom"])},os=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.align,n=e.className,s=$(v()(e,["align","className"])),r=s[0],a=s[1],i=Y(r);return t&&(i[F(us.defaultProps,t)]=!0),f.a.createElement("div",o()({},a,{className:_()(n,i)}))},t}(f.a.Component);os.propTypes=as;var is=G("media-right",os),ls={componentClass:pe.a},cs=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=Y(r);return f.a.createElement(t,o()({},a,{className:_()(n,i)}))},t}(f.a.Component);cs.propTypes=ls,cs.defaultProps={componentClass:"div"},cs.Heading=Jn,cs.Body=Kn,cs.Left=es,cs.Right=is,cs.List=ns,cs.ListItem=rs;var us=G("media",cs),hs={active:S.a.bool,disabled:S.a.bool,divider:Me()(S.a.bool,(function(e){var t=e.divider,n=e.children;return t&&n?new Error("Children will not be rendered for dividers"):null})),eventKey:S.a.any,header:S.a.bool,href:S.a.string,onClick:S.a.func,onSelect:S.a.func},ds=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleClick=r.handleClick.bind(r),r}return d()(t,e),t.prototype.handleClick=function(e){var t=this.props,n=t.href,s=t.disabled,r=t.onSelect,a=t.eventKey;n&&!s||e.preventDefault(),s||r&&r(a,e)},t.prototype.render=function(){var e=this.props,t=e.active,n=e.disabled,s=e.divider,r=e.header,a=e.onClick,i=e.className,l=e.style,c=H(v()(e,["active","disabled","divider","header","onClick","className","style"]),["eventKey","onSelect"]),u=c[0],h=c[1];return s?(h.children=void 0,f.a.createElement("li",o()({},h,{role:"separator",className:_()(i,"divider"),style:l}))):r?f.a.createElement("li",o()({},h,{role:"heading",className:_()(i,F(u,"header")),style:l})):f.a.createElement("li",{role:"presentation",className:_()(i,{active:t,disabled:n}),style:l},f.a.createElement(ye,o()({},h,{role:"menuitem",tabIndex:"-1",onClick:q(a,this.handleClick)})))},t}(f.a.Component);ds.propTypes=hs,ds.defaultProps={divider:!1,disabled:!1,header:!1};var ps=G("dropdown",ds),fs=n(253),ms=n.n(fs),gs=n(52),ys=n.n(gs),vs=n(41),bs=n.n(vs),_s=n(105),Es=n.n(_s),Ss=n(108),ws=n.n(Ss),Cs=n(252),Os=n.n(Cs),Ts={componentClass:pe.a},Ms=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=Y(r);return f.a.createElement(t,o()({},a,{className:_()(n,i)}))},t}(f.a.Component);Ms.propTypes=Ts,Ms.defaultProps={componentClass:"div"};var As=G("modal-body",Ms),Ns={dialogClassName:S.a.string},xs=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.dialogClassName,s=t.className,r=t.style,a=t.children,i=$(v()(t,["dialogClassName","className","style","children"])),l=i[0],c=i[1],u=F(l),h=o()({display:"block"},r),d=o()({},Y(l),((e={})[u]=!1,e[F(l,"dialog")]=!0,e));return f.a.createElement("div",o()({},c,{tabIndex:"-1",role:"dialog",style:h,className:_()(s,u)}),f.a.createElement("div",{className:_()(n,d)},f.a.createElement("div",{className:F(l,"content"),role:"document"},a)))},t}(f.a.Component);xs.propTypes=Ns;var Ps=G("modal",W([M,A],xs)),Is={componentClass:pe.a},Ds=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=Y(r);return f.a.createElement(t,o()({},a,{className:_()(n,i)}))},t}(f.a.Component);Ds.propTypes=Is,Ds.defaultProps={componentClass:"div"};var ks=G("modal-footer",Ds),Ls={closeLabel:S.a.string,closeButton:S.a.bool,onHide:S.a.func},Rs={$bs_modal:S.a.shape({onHide:S.a.func})},Bs=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.closeLabel,n=e.closeButton,s=e.onHide,r=e.className,a=e.children,i=v()(e,["closeLabel","closeButton","onHide","className","children"]),l=this.context.$bs_modal,c=$(i),u=c[0],h=c[1],d=Y(u);return f.a.createElement("div",o()({},h,{className:_()(r,d)}),n&&f.a.createElement(ae,{label:t,onClick:q(l&&l.onHide,s)}),a)},t}(f.a.Component);Bs.propTypes=Ls,Bs.defaultProps={closeLabel:"Close",closeButton:!1},Bs.contextTypes=Rs;var Fs=G("modal-header",Bs),Gs={componentClass:pe.a},js=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=Y(r);return f.a.createElement(t,o()({},a,{className:_()(n,i)}))},t}(f.a.Component);js.propTypes=Gs,js.defaultProps={componentClass:"h4"};var Ws=G("modal-title",js),Ys=o()({},ws.a.propTypes,Ps.propTypes,{backdrop:S.a.oneOf(["static",!0,!1]),backdropClassName:S.a.string,keyboard:S.a.bool,animation:S.a.bool,dialogComponentClass:pe.a,autoFocus:S.a.bool,enforceFocus:S.a.bool,restoreFocus:S.a.bool,show:S.a.bool,onHide:S.a.func,onEnter:S.a.func,onEntering:S.a.func,onEntered:S.a.func,onExit:S.a.func,onExiting:S.a.func,onExited:S.a.func,container:ws.a.propTypes.container}),Xs=o()({},ws.a.defaultProps,{animation:!0,dialogComponentClass:Ps}),Us={$bs_modal:S.a.shape({onHide:S.a.func})},$s=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleEntering=r.handleEntering.bind(r),r.handleExited=r.handleExited.bind(r),r.handleWindowResize=r.handleWindowResize.bind(r),r.handleDialogClick=r.handleDialogClick.bind(r),r.setModalRef=r.setModalRef.bind(r),r.state={style:{}},r}return d()(t,e),t.prototype.getChildContext=function(){return{$bs_modal:{onHide:this.props.onHide}}},t.prototype.componentWillUnmount=function(){this.handleExited()},t.prototype.setModalRef=function(e){this._modal=e},t.prototype.handleDialogClick=function(e){e.target===e.currentTarget&&this.props.onHide()},t.prototype.handleEntering=function(){ms.a.on(window,"resize",this.handleWindowResize),this.updateStyle()},t.prototype.handleExited=function(){ms.a.off(window,"resize",this.handleWindowResize)},t.prototype.handleWindowResize=function(){this.updateStyle()},t.prototype.updateStyle=function(){if(bs.a){var e=this._modal.getDialogElement(),t=e.scrollHeight,n=ys()(e),s=Os()(Be.a.findDOMNode(this.props.container||n.body)),r=t>n.documentElement.clientHeight;this.setState({style:{paddingRight:s&&!r?Es()():void 0,paddingLeft:!s&&r?Es()():void 0}})}},t.prototype.render=function(){var e=this.props,n=e.backdrop,s=e.backdropClassName,r=e.animation,a=e.show,i=e.dialogComponentClass,l=e.className,c=e.style,u=e.children,h=e.onEntering,d=e.onExited,p=v()(e,["backdrop","backdropClassName","animation","show","dialogComponentClass","className","style","children","onEntering","onExited"]),m=zt(p,ws.a),g=m[0],y=m[1],b=a&&!r&&"in";return f.a.createElement(ws.a,o()({},g,{ref:this.setModalRef,show:a,onEntering:q(h,this.handleEntering),onExited:q(d,this.handleExited),backdrop:n,backdropClassName:_()(F(p,"backdrop"),s,b),containerClassName:F(p,"open"),transition:r?nn:void 0,dialogTransitionTimeout:t.TRANSITION_DURATION,backdropTransitionTimeout:t.BACKDROP_TRANSITION_DURATION}),f.a.createElement(i,o()({},y,{style:o()({},this.state.style,c),className:_()(l,b),onClick:!0===n?this.handleDialogClick:null}),u))},t}(f.a.Component);$s.propTypes=Ys,$s.defaultProps=Xs,$s.childContextTypes=Us,$s.Body=As,$s.Header=Fs,$s.Title=Ws,$s.Footer=ks,$s.Dialog=Ps,$s.TRANSITION_DURATION=300,$s.BACKDROP_TRANSITION_DURATION=150;var Hs=G("modal",W([M,A],$s)),Vs={activeKey:S.a.any,activeHref:S.a.string,stacked:S.a.bool,justified:Me()(S.a.bool,(function(e){var t=e.justified,n=e.navbar;return t&&n?Error("justified navbar `Nav`s are not supported"):null})),onSelect:S.a.func,role:S.a.string,navbar:S.a.bool,pullRight:S.a.bool,pullLeft:S.a.bool},Ks={$bs_navbar:S.a.shape({bsClass:S.a.string,onSelect:S.a.func}),$bs_tabContainer:S.a.shape({activeKey:S.a.any,onSelect:S.a.func.isRequired,getTabId:S.a.func.isRequired,getPaneId:S.a.func.isRequired})},qs=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.componentDidUpdate=function(){var e=this;if(this._needsRefocus){this._needsRefocus=!1;var t=this.props.children,n=this.getActiveProps(),s=n.activeKey,r=n.activeHref,a=z.find(t,(function(t){return e.isActive(t,s,r)})),o=z.toArray(t).indexOf(a),i=Be.a.findDOMNode(this).children,l=i&&i[o];l&&l.firstChild&&l.firstChild.focus()}},t.prototype.getActiveProps=function(){var e=this.context.$bs_tabContainer;return e||this.props},t.prototype.getNextActiveChild=function(e){var t=this,n=this.props.children,s=n.filter((function(e){return null!=e.props.eventKey&&!e.props.disabled})),r=this.getActiveProps(),a=r.activeKey,o=r.activeHref,i=z.find(n,(function(e){return t.isActive(e,a,o)})),l=s.indexOf(i);if(-1===l)return s[0];var c=l+e,u=s.length;return c>=u?c=0:c<0&&(c=u-1),s[c]},t.prototype.getTabProps=function(e,t,n,s,r){var a=this;if(!t&&"tablist"!==n)return null;var o=e.props,i=o.id,l=o["aria-controls"],c=o.eventKey,u=o.role,h=o.onKeyDown,d=o.tabIndex;return t&&(i=t.getTabId(c),l=t.getPaneId(c)),"tablist"===n&&(u=u||"tab",h=q((function(e){return a.handleTabKeyDown(r,e)}),h),d=s?d:-1),{id:i,role:u,onKeyDown:h,"aria-controls":l,tabIndex:d}},t.prototype.handleTabKeyDown=function(e,t){var n=void 0;switch(t.keyCode){case Tt.a.codes.left:case Tt.a.codes.up:n=this.getNextActiveChild(-1);break;case Tt.a.codes.right:case Tt.a.codes.down:n=this.getNextActiveChild(1);break;default:return}t.preventDefault(),e&&n&&null!=n.props.eventKey&&e(n.props.eventKey),this._needsRefocus=!0},t.prototype.isActive=function(e,t,n){var s=e.props;return!!(s.active||null!=t&&s.eventKey===t||n&&s.href===n)||s.active},t.prototype.render=function(){var e,t=this,n=this.props,s=n.stacked,r=n.justified,a=n.onSelect,i=n.role,l=n.navbar,c=n.pullRight,u=n.pullLeft,h=n.className,d=n.children,m=v()(n,["stacked","justified","onSelect","role","navbar","pullRight","pullLeft","className","children"]),g=this.context.$bs_tabContainer,y=i||(g?"tablist":null),b=this.getActiveProps(),E=b.activeKey,S=b.activeHref;delete m.activeKey,delete m.activeHref;var w=$(m),C=w[0],O=w[1],T=o()({},Y(C),((e={})[F(C,"stacked")]=s,e[F(C,"justified")]=r,e)),M=null!=l?l:this.context.$bs_navbar,A=void 0,N=void 0;if(M){var x=this.context.$bs_navbar||{bsClass:"navbar"};T[F(x,"nav")]=!0,N=F(x,"right"),A=F(x,"left")}else N="pull-right",A="pull-left";return T[N]=c,T[A]=u,f.a.createElement("ul",o()({},O,{role:y,className:_()(h,T)}),z.map(d,(function(e){var n=t.isActive(e,E,S),s=q(e.props.onSelect,a,M&&M.onSelect,g&&g.onSelect);return Object(p.cloneElement)(e,o()({},t.getTabProps(e,g,y,n,s),{active:n,activeKey:E,activeHref:S,onSelect:s}))})))},t}(f.a.Component);qs.propTypes=Vs,qs.defaultProps={justified:!1,pullRight:!1,pullLeft:!1,stacked:!1},qs.contextTypes=Ks;var zs=G("nav",j(["tabs","pills"],qs)),Js={$bs_navbar:S.a.shape({bsClass:S.a.string})},Qs=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=e.children,s=v()(e,["className","children"]),r=F(this.context.$bs_navbar||{bsClass:"navbar"},"brand");return f.a.isValidElement(n)?f.a.cloneElement(n,{className:_()(n.props.className,t,r)}):f.a.createElement("span",o()({},s,{className:_()(t,r)}),n)},t}(f.a.Component);Qs.contextTypes=Js;var Zs=Qs,er={$bs_navbar:S.a.shape({bsClass:S.a.string,expanded:S.a.bool})},tr=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.children,n=v()(e,["children"]),s=this.context.$bs_navbar||{bsClass:"navbar"},r=F(s,"collapse");return f.a.createElement(_t,o()({in:s.expanded},n),f.a.createElement("div",{className:r},t))},t}(f.a.Component);tr.contextTypes=er;var nr=tr,sr={$bs_navbar:S.a.shape({bsClass:S.a.string})},rr=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=v()(e,["className"]),s=F(this.context.$bs_navbar||{bsClass:"navbar"},"header");return f.a.createElement("div",o()({},n,{className:_()(t,s)}))},t}(f.a.Component);rr.contextTypes=sr;var ar=rr,or={onClick:S.a.func,children:S.a.node},ir={$bs_navbar:S.a.shape({bsClass:S.a.string,expanded:S.a.bool,onToggle:S.a.func.isRequired})},lr=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.onClick,n=e.className,s=e.children,r=v()(e,["onClick","className","children"]),a=this.context.$bs_navbar||{bsClass:"navbar"},i=o()({type:"button"},r,{onClick:q(t,a.onToggle),className:_()(n,F(a,"toggle"),!a.expanded&&"collapsed")});return s?f.a.createElement("button",i,s):f.a.createElement("button",i,f.a.createElement("span",{className:"sr-only"},"Toggle navigation"),f.a.createElement("span",{className:"icon-bar"}),f.a.createElement("span",{className:"icon-bar"}),f.a.createElement("span",{className:"icon-bar"}))},t}(f.a.Component);lr.propTypes=or,lr.contextTypes=ir;var cr=lr,ur={fixedTop:S.a.bool,fixedBottom:S.a.bool,staticTop:S.a.bool,inverse:S.a.bool,fluid:S.a.bool,componentClass:pe.a,onToggle:S.a.func,onSelect:S.a.func,collapseOnSelect:S.a.bool,expanded:S.a.bool,role:S.a.string},hr={$bs_navbar:S.a.shape({bsClass:S.a.string,expanded:S.a.bool,onToggle:S.a.func.isRequired,onSelect:S.a.func})},dr=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleToggle=r.handleToggle.bind(r),r.handleCollapse=r.handleCollapse.bind(r),r}return d()(t,e),t.prototype.getChildContext=function(){var e=this.props,t=e.bsClass,n=e.expanded,s=e.onSelect,r=e.collapseOnSelect;return{$bs_navbar:{bsClass:t,expanded:n,onToggle:this.handleToggle,onSelect:q(s,r?this.handleCollapse:null)}}},t.prototype.handleCollapse=function(){var e=this.props,t=e.onToggle;e.expanded&&t(!1)},t.prototype.handleToggle=function(){var e=this.props;(0,e.onToggle)(!e.expanded)},t.prototype.render=function(){var e,t=this.props,n=t.componentClass,s=t.fixedTop,r=t.fixedBottom,a=t.staticTop,i=t.inverse,l=t.fluid,c=t.className,u=t.children,h=H(v()(t,["componentClass","fixedTop","fixedBottom","staticTop","inverse","fluid","className","children"]),["expanded","onToggle","onSelect","collapseOnSelect"]),d=h[0],p=h[1];void 0===p.role&&"nav"!==n&&(p.role="navigation"),i&&(d.bsStyle=R);var m=o()({},Y(d),((e={})[F(d,"fixed-top")]=s,e[F(d,"fixed-bottom")]=r,e[F(d,"static-top")]=a,e));return f.a.createElement(n,o()({},p,{className:_()(c,m)}),f.a.createElement(wn,{fluid:l},u))},t}(f.a.Component);dr.propTypes=ur,dr.defaultProps={componentClass:"nav",fixedTop:!1,fixedBottom:!1,staticTop:!1,inverse:!1,fluid:!1,collapseOnSelect:!1},dr.childContextTypes=hr,G("navbar",dr);var pr=xt()(dr,{expanded:"onToggle"});function fr(e,t,n){var s=function(e,n){var s=n.$bs_navbar,r=void 0===s?{bsClass:"navbar"}:s,a=e.componentClass,i=e.className,l=e.pullRight,c=e.pullLeft,u=v()(e,["componentClass","className","pullRight","pullLeft"]);return f.a.createElement(a,o()({},u,{className:_()(i,F(r,t),l&&F(r,"right"),c&&F(r,"left"))}))};return s.displayName=n,s.propTypes={componentClass:pe.a,pullRight:S.a.bool,pullLeft:S.a.bool},s.defaultProps={componentClass:e,pullRight:!1,pullLeft:!1},s.contextTypes={$bs_navbar:S.a.shape({bsClass:S.a.string})},s}pr.Brand=Zs,pr.Header=ar,pr.Toggle=cr,pr.Collapse=nr,pr.Form=fr("div","form","NavbarForm"),pr.Text=fr("p","text","NavbarText"),pr.Link=fr("a","link","NavbarLink");var mr=j([D,R],D,pr),gr=o()({},qt.propTypes,{title:S.a.node.isRequired,noCaret:S.a.bool,active:S.a.bool,children:S.a.node}),yr=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.isActive=function(e,t,n){var s=e.props,r=this;return!!(s.active||null!=t&&s.eventKey===t||n&&s.href===n)||(!!z.some(s.children,(function(e){return r.isActive(e,t,n)}))||s.active)},t.prototype.render=function(){var e=this,t=this.props,n=t.title,s=t.activeKey,r=t.activeHref,a=t.className,i=t.style,l=t.children,c=v()(t,["title","activeKey","activeHref","className","style","children"]),u=this.isActive(this,s,r);delete c.active,delete c.eventKey;var h=zt(c,qt.ControlledComponent),d=h[0],p=h[1];return f.a.createElement(qt,o()({},d,{componentClass:"li",className:_()(a,{active:u}),style:i}),f.a.createElement(qt.Toggle,o()({},p,{useAnchor:!0}),n),f.a.createElement(qt.Menu,null,z.map(l,(function(t){return f.a.cloneElement(t,{active:e.isActive(t,s,r)})}))))},t}(f.a.Component);yr.propTypes=gr;var vr=yr,br={active:S.a.bool,disabled:S.a.bool,role:S.a.string,href:S.a.string,onClick:S.a.func,onSelect:S.a.func,eventKey:S.a.any},_r=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleClick=r.handleClick.bind(r),r}return d()(t,e),t.prototype.handleClick=function(e){this.props.onSelect&&(e.preventDefault(),this.props.disabled||this.props.onSelect(this.props.eventKey,e))},t.prototype.render=function(){var e=this.props,t=e.active,n=e.disabled,s=e.onClick,r=e.className,a=e.style,i=v()(e,["active","disabled","onClick","className","style"]);return delete i.onSelect,delete i.eventKey,delete i.activeKey,delete i.activeHref,i.role?"tab"===i.role&&(i["aria-selected"]=t):"#"===i.href&&(i.role="button"),f.a.createElement("li",{role:"presentation",className:_()(r,{active:t,disabled:n}),style:a},f.a.createElement(ye,o()({},i,{disabled:n,onClick:q(s,this.handleClick)})))},t}(f.a.Component);_r.propTypes=br,_r.defaultProps={active:!1,disabled:!1};var Er=_r,Sr=n(254),wr=n.n(Sr),Cr=o()({},wr.a.propTypes,{show:S.a.bool,rootClose:S.a.bool,onHide:S.a.func,animation:S.a.oneOfType([S.a.bool,pe.a]),onEnter:S.a.func,onEntering:S.a.func,onEntered:S.a.func,onExit:S.a.func,onExiting:S.a.func,onExited:S.a.func,placement:S.a.oneOf(["top","right","bottom","left"])}),Or={animation:nn,rootClose:!1,show:!1,placement:"right"},Tr=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.animation,n=e.children,s=v()(e,["animation","children"]),r=!0===t?nn:t||null,a=void 0;return a=r?n:Object(p.cloneElement)(n,{className:_()(n.props.className,"in")}),f.a.createElement(wr.a,o()({},s,{transition:r}),a)},t}(f.a.Component);Tr.propTypes=Cr,Tr.defaultProps=Or;var Mr=Tr;function Ar(e,t){return Array.isArray(t)?t.indexOf(e)>=0:e===t}var Nr=S.a.oneOf(["click","hover","focus"]),xr=o()({},Mr.propTypes,{trigger:S.a.oneOfType([Nr,S.a.arrayOf(Nr)]),delay:S.a.number,delayShow:S.a.number,delayHide:S.a.number,defaultOverlayShown:S.a.bool,overlay:S.a.node.isRequired,onBlur:S.a.func,onClick:S.a.func,onFocus:S.a.func,onMouseOut:S.a.func,onMouseOver:S.a.func,target:S.a.oneOf([null]),onHide:S.a.oneOf([null]),show:S.a.oneOf([null])}),Pr=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleToggle=r.handleToggle.bind(r),r.handleDelayedShow=r.handleDelayedShow.bind(r),r.handleDelayedHide=r.handleDelayedHide.bind(r),r.handleHide=r.handleHide.bind(r),r.handleMouseOver=function(e){return r.handleMouseOverOut(r.handleDelayedShow,e)},r.handleMouseOut=function(e){return r.handleMouseOverOut(r.handleDelayedHide,e)},r._mountNode=null,r.state={show:n.defaultOverlayShown},r}return d()(t,e),t.prototype.componentDidMount=function(){this._mountNode=document.createElement("div"),this.renderOverlay()},t.prototype.componentDidUpdate=function(){this.renderOverlay()},t.prototype.componentWillUnmount=function(){Be.a.unmountComponentAtNode(this._mountNode),this._mountNode=null,clearTimeout(this._hoverShowDelay),clearTimeout(this._hoverHideDelay)},t.prototype.handleDelayedHide=function(){var e=this;if(null!=this._hoverShowDelay)return clearTimeout(this._hoverShowDelay),void(this._hoverShowDelay=null);if(this.state.show&&null==this._hoverHideDelay){var t=null!=this.props.delayHide?this.props.delayHide:this.props.delay;t?this._hoverHideDelay=setTimeout((function(){e._hoverHideDelay=null,e.hide()}),t):this.hide()}},t.prototype.handleDelayedShow=function(){var e=this;if(null!=this._hoverHideDelay)return clearTimeout(this._hoverHideDelay),void(this._hoverHideDelay=null);if(!this.state.show&&null==this._hoverShowDelay){var t=null!=this.props.delayShow?this.props.delayShow:this.props.delay;t?this._hoverShowDelay=setTimeout((function(){e._hoverShowDelay=null,e.show()}),t):this.show()}},t.prototype.handleHide=function(){this.hide()},t.prototype.handleMouseOverOut=function(e,t){var n=t.currentTarget,s=t.relatedTarget||t.nativeEvent.toElement;s&&s===n||Ct()(n,s)||e(t)},t.prototype.handleToggle=function(){this.state.show?this.hide():this.show()},t.prototype.hide=function(){this.setState({show:!1})},t.prototype.makeOverlay=function(e,t){return f.a.createElement(Mr,o()({},t,{show:this.state.show,onHide:this.handleHide,target:this}),e)},t.prototype.show=function(){this.setState({show:!0})},t.prototype.renderOverlay=function(){Be.a.unstable_renderSubtreeIntoContainer(this,this._overlay,this._mountNode)},t.prototype.render=function(){var e=this.props,t=e.trigger,n=e.overlay,s=e.children,r=e.onBlur,a=e.onClick,o=e.onFocus,i=e.onMouseOut,l=e.onMouseOver,c=v()(e,["trigger","overlay","children","onBlur","onClick","onFocus","onMouseOut","onMouseOver"]);delete c.delay,delete c.delayShow,delete c.delayHide,delete c.defaultOverlayShown;var u=f.a.Children.only(s),h=u.props,d={};return this.state.show&&(d["aria-describedby"]=n.props.id),d.onClick=q(h.onClick,a),Ar("click",t)&&(d.onClick=q(d.onClick,this.handleToggle)),Ar("hover",t)&&(d.onMouseOver=q(h.onMouseOver,l,this.handleMouseOver),d.onMouseOut=q(h.onMouseOut,i,this.handleMouseOut)),Ar("focus",t)&&(d.onFocus=q(h.onFocus,o,this.handleDelayedShow),d.onBlur=q(h.onBlur,r,this.handleDelayedHide)),this._overlay=this.makeOverlay(n,c),Object(p.cloneElement)(u,d)},t}(f.a.Component);Pr.propTypes=xr,Pr.defaultProps={defaultOverlayShown:!1,trigger:["hover","focus"]};var Ir=Pr,Dr=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=e.children,s=$(v()(e,["className","children"])),r=s[0],a=s[1],i=Y(r);return f.a.createElement("div",o()({},a,{className:_()(t,i)}),f.a.createElement("h1",null,n))},t}(f.a.Component),kr=G("page-header",Dr),Lr={disabled:S.a.bool,previous:S.a.bool,next:S.a.bool,onClick:S.a.func,onSelect:S.a.func,eventKey:S.a.any},Rr=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleSelect=r.handleSelect.bind(r),r}return d()(t,e),t.prototype.handleSelect=function(e){var t=this.props,n=t.disabled,s=t.onSelect,r=t.eventKey;(s||n)&&e.preventDefault(),n||s&&s(r,e)},t.prototype.render=function(){var e=this.props,t=e.disabled,n=e.previous,s=e.next,r=e.onClick,a=e.className,i=e.style,l=v()(e,["disabled","previous","next","onClick","className","style"]);return delete l.onSelect,delete l.eventKey,f.a.createElement("li",{className:_()(a,{disabled:t,previous:n,next:s}),style:i},f.a.createElement(ye,o()({},l,{disabled:t,onClick:q(r,this.handleSelect)})))},t}(f.a.Component);Rr.propTypes=Lr,Rr.defaultProps={disabled:!1,previous:!1,next:!1};var Br=Rr,Fr=n(172),Gr=n.n(Fr),jr={};function Wr(e,t,n){var s=void 0;"object"===(void 0===e?"undefined":Gr()(e))?s=e.message:(s=e+" is deprecated. Use "+t+" instead.",n&&(s+="\nYou can read more about it at "+n)),jr[s]||(jr[s]=!0)}Wr.wrapper=function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),s=1;s<t;s++)n[s-1]=arguments[s];return function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.componentWillMount=function(){if(Wr.apply(void 0,n),e.prototype.componentWillMount){for(var t,s=arguments.length,r=Array(s),a=0;a<s;a++)r[a]=arguments[a];(t=e.prototype.componentWillMount).call.apply(t,[this].concat(r))}},t}(e)};var Yr=Wr.wrapper(Br,"`<PageItem>`","`<Pager.Item>`"),Xr={onSelect:S.a.func},Ur=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.onSelect,n=e.className,s=e.children,r=$(v()(e,["onSelect","className","children"])),a=r[0],i=r[1],l=Y(a);return f.a.createElement("ul",o()({},i,{className:_()(n,l)}),z.map(s,(function(e){return Object(p.cloneElement)(e,{onSelect:q(e.props.onSelect,t)})})))},t}(f.a.Component);Ur.propTypes=Xr,Ur.Item=Br;var $r=G("pager",Ur),Hr={componentClass:pe.a,className:S.a.string,eventKey:S.a.any,onSelect:S.a.func,disabled:S.a.bool,active:S.a.bool,onClick:S.a.func},Vr={componentClass:ye,active:!1,disabled:!1},Kr=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleClick=r.handleClick.bind(r),r}return d()(t,e),t.prototype.handleClick=function(e){var t=this.props,n=t.disabled,s=t.onSelect,r=t.eventKey;n||s&&s(r,e)},t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.active,s=e.disabled,r=e.onClick,a=e.className,i=e.style,l=v()(e,["componentClass","active","disabled","onClick","className","style"]);return t===ye&&delete l.eventKey,delete l.onSelect,f.a.createElement("li",{className:_()(a,{active:n,disabled:s}),style:i},f.a.createElement(t,o()({},l,{disabled:s,onClick:q(r,this.handleClick)})))},t}(f.a.Component);Kr.propTypes=Hr,Kr.defaultProps=Vr;var qr=Kr,zr={activePage:S.a.number,items:S.a.number,maxButtons:S.a.number,boundaryLinks:S.a.bool,ellipsis:S.a.oneOfType([S.a.bool,S.a.node]),first:S.a.oneOfType([S.a.bool,S.a.node]),last:S.a.oneOfType([S.a.bool,S.a.node]),prev:S.a.oneOfType([S.a.bool,S.a.node]),next:S.a.oneOfType([S.a.bool,S.a.node]),onSelect:S.a.func,buttonComponentClass:pe.a},Jr=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.renderPageButtons=function(e,t,n,s,r,a){var i=[],l=void 0,c=void 0;n&&n<t?c=(l=Math.max(Math.min(e-Math.floor(n/2,10),t-n+1),1))+n-1:(l=1,c=t);for(var u=l;u<=c;++u)i.push(f.a.createElement(qr,o()({},a,{key:u,eventKey:u,active:u===e}),u));return r&&s&&l>1&&(l>2&&i.unshift(f.a.createElement(qr,{key:"ellipsisFirst",disabled:!0,componentClass:a.componentClass},f.a.createElement("span",{"aria-label":"More"},!0===r?"โฆ":r))),i.unshift(f.a.createElement(qr,o()({},a,{key:1,eventKey:1,active:!1}),"1"))),r&&c<t&&((!s||c<t-1)&&i.push(f.a.createElement(qr,{key:"ellipsis",disabled:!0,componentClass:a.componentClass},f.a.createElement("span",{"aria-label":"More"},!0===r?"โฆ":r))),s&&i.push(f.a.createElement(qr,o()({},a,{key:t,eventKey:t,active:!1}),t))),i},t.prototype.render=function(){var e=this.props,t=e.activePage,n=e.items,s=e.maxButtons,r=e.boundaryLinks,a=e.ellipsis,i=e.first,l=e.last,c=e.prev,u=e.next,h=e.onSelect,d=e.buttonComponentClass,p=e.className,m=$(v()(e,["activePage","items","maxButtons","boundaryLinks","ellipsis","first","last","prev","next","onSelect","buttonComponentClass","className"])),g=m[0],y=m[1],b=Y(g),E={onSelect:h,componentClass:d};return f.a.createElement("ul",o()({},y,{className:_()(p,b)}),i&&f.a.createElement(qr,o()({},E,{eventKey:1,disabled:1===t}),f.a.createElement("span",{"aria-label":"First"},!0===i?"ยซ":i)),c&&f.a.createElement(qr,o()({},E,{eventKey:t-1,disabled:1===t}),f.a.createElement("span",{"aria-label":"Previous"},!0===c?"โน":c)),this.renderPageButtons(t,n,s,r,a,E),u&&f.a.createElement(qr,o()({},E,{eventKey:t+1,disabled:t>=n}),f.a.createElement("span",{"aria-label":"Next"},!0===u?"โบ":u)),l&&f.a.createElement(qr,o()({},E,{eventKey:n,disabled:t>=n}),f.a.createElement("span",{"aria-label":"Last"},!0===l?"ยป":l)))},t}(f.a.Component);Jr.propTypes=zr,Jr.defaultProps={activePage:1,items:1,maxButtons:0,first:!1,last:!1,prev:!1,next:!1,ellipsis:!0,boundaryLinks:!1};var Qr=G("pagination",Jr),Zr={collapsible:S.a.bool,onSelect:S.a.func,header:S.a.node,id:S.a.oneOfType([S.a.string,S.a.number]),footer:S.a.node,defaultExpanded:S.a.bool,expanded:S.a.bool,eventKey:S.a.any,headerRole:S.a.string,panelRole:S.a.string,onEnter:S.a.func,onEntering:S.a.func,onEntered:S.a.func,onExit:S.a.func,onExiting:S.a.func,onExited:S.a.func},ea=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleClickTitle=r.handleClickTitle.bind(r),r.state={expanded:r.props.defaultExpanded},r}return d()(t,e),t.prototype.handleClickTitle=function(e){e.persist(),e.selected=!0,this.props.onSelect?this.props.onSelect(this.props.eventKey,e):e.preventDefault(),e.selected&&this.setState({expanded:!this.state.expanded})},t.prototype.renderAnchor=function(e,t,n,s){return f.a.createElement("a",{role:n,href:t&&"#"+t,onClick:this.handleClickTitle,"aria-controls":t,"aria-expanded":s,"aria-selected":s,className:s?null:"collapsed"},e)},t.prototype.renderBody=function(e,t){var n=[],s=[],r=F(t,"body");function a(){s.length&&(n.push(f.a.createElement("div",{key:n.length,className:r},s)),s=[])}return f.a.Children.toArray(e).forEach((function(e){if(f.a.isValidElement(e)&&e.props.fill)return a(),void n.push(Object(p.cloneElement)(e,{fill:void 0}));s.push(e)})),a(),n},t.prototype.renderCollapsibleBody=function(e,t,n,s,r,a){return f.a.createElement(_t,o()({in:t},a),f.a.createElement("div",{id:e,role:n,className:F(r,"collapse"),"aria-hidden":!t},this.renderBody(s,r)))},t.prototype.renderHeader=function(e,t,n,s,r,a){var o=F(a,"title");return e?f.a.isValidElement(t)?Object(p.cloneElement)(t,{className:_()(t.props.className,o),children:this.renderAnchor(t.props.children,n,s,r)}):f.a.createElement("h4",{role:"presentation",className:o},this.renderAnchor(t,n,s,r)):f.a.isValidElement(t)?Object(p.cloneElement)(t,{className:_()(t.props.className,o)}):t},t.prototype.render=function(){var e=this.props,t=e.collapsible,n=e.header,s=e.id,r=e.footer,a=e.expanded,i=e.headerRole,l=e.panelRole,c=e.className,u=e.children,h=e.onEnter,d=e.onEntering,p=e.onEntered,m=e.onExit,g=e.onExiting,y=e.onExited,b=H(v()(e,["collapsible","header","id","footer","expanded","headerRole","panelRole","className","children","onEnter","onEntering","onEntered","onExit","onExiting","onExited"]),["defaultExpanded","eventKey","onSelect"]),E=b[0],S=b[1],w=null!=a?a:this.state.expanded,C=Y(E);return f.a.createElement("div",o()({},S,{className:_()(c,C),id:t?null:s}),n&&f.a.createElement("div",{className:F(E,"heading")},this.renderHeader(t,n,s,i,w,E)),t?this.renderCollapsibleBody(s,w,l,u,E,{onEnter:h,onEntering:d,onEntered:p,onExit:m,onExiting:g,onExited:y}):this.renderBody(u,E),r&&f.a.createElement("div",{className:F(E,"footer")},r))},t}(f.a.Component);ea.propTypes=Zr,ea.defaultProps={defaultExpanded:!1};var ta=G("panel",j([].concat(ne()(I),[D,k]),D,ea)),na={id:At()(S.a.oneOfType([S.a.string,S.a.number])),placement:S.a.oneOf(["top","right","bottom","left"]),positionTop:S.a.oneOfType([S.a.number,S.a.string]),positionLeft:S.a.oneOfType([S.a.number,S.a.string]),arrowOffsetTop:S.a.oneOfType([S.a.number,S.a.string]),arrowOffsetLeft:S.a.oneOfType([S.a.number,S.a.string]),title:S.a.node},sa=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.placement,s=t.positionTop,r=t.positionLeft,a=t.arrowOffsetTop,i=t.arrowOffsetLeft,l=t.title,c=t.className,u=t.style,h=t.children,d=$(v()(t,["placement","positionTop","positionLeft","arrowOffsetTop","arrowOffsetLeft","title","className","style","children"])),p=d[0],m=d[1],g=o()({},Y(p),((e={})[n]=!0,e)),y=o()({display:"block",top:s,left:r},u),b={top:a,left:i};return f.a.createElement("div",o()({},m,{role:"tooltip",className:_()(c,g),style:y}),f.a.createElement("div",{className:"arrow",style:b}),l&&f.a.createElement("h3",{className:F(p,"title")},l),f.a.createElement("div",{className:F(p,"content")},h))},t}(f.a.Component);sa.propTypes=na,sa.defaultProps={placement:"right"};var ra=G("popover",sa);var aa={min:S.a.number,now:S.a.number,max:S.a.number,label:S.a.node,srOnly:S.a.bool,striped:S.a.bool,active:S.a.bool,children:function(e,t,n){var s=e[t];if(!s)return null;var r=null;return f.a.Children.forEach(s,(function(e){if(!r&&e.type!==ia){var t=f.a.isValidElement(e)?e.type.displayName||e.type.name||e.type:e;r=new Error("Children of "+n+" can contain only ProgressBar components. Found "+t+".")}})),r},isChild:S.a.bool};function oa(e,t,n){var s=(e-t)/(n-t)*100;return Math.round(1e3*s)/1e3}var ia=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.renderProgressBar=function(e){var t,n=e.min,s=e.now,r=e.max,a=e.label,i=e.srOnly,l=e.striped,c=e.active,u=e.className,h=e.style,d=$(v()(e,["min","now","max","label","srOnly","striped","active","className","style"])),p=d[0],m=d[1],g=o()({},Y(p),((t={active:c})[F(p,"striped")]=c||l,t));return f.a.createElement("div",o()({},m,{role:"progressbar",className:_()(u,g),style:o()({width:oa(s,n,r)+"%"},h),"aria-valuenow":s,"aria-valuemin":n,"aria-valuemax":r}),i?f.a.createElement("span",{className:"sr-only"},a):a)},t.prototype.render=function(){var e=this.props,t=e.isChild,n=v()(e,["isChild"]);if(t)return this.renderProgressBar(n);var s=n.min,r=n.now,a=n.max,i=n.label,l=n.srOnly,c=n.striped,u=n.active,h=n.bsClass,d=n.bsStyle,m=n.className,g=n.children,y=v()(n,["min","now","max","label","srOnly","striped","active","bsClass","bsStyle","className","children"]);return f.a.createElement("div",o()({},y,{className:_()(m,"progress")}),g?z.map(g,(function(e){return Object(p.cloneElement)(e,{isChild:!0})})):this.renderProgressBar({min:s,now:r,max:a,label:i,srOnly:l,striped:c,active:u,bsClass:h,bsStyle:d}))},t}(f.a.Component);ia.propTypes=aa,ia.defaultProps={min:0,max:100,active:!1,isChild:!1,srOnly:!1,striped:!1};var la=G("progress-bar",j(ne()(I),ia)),ca={inline:S.a.bool,disabled:S.a.bool,title:S.a.string,validationState:S.a.oneOf(["success","warning","error",null]),inputRef:S.a.func},ua=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.inline,n=e.disabled,s=e.validationState,r=e.inputRef,a=e.className,i=e.style,l=e.title,c=e.children,u=$(v()(e,["inline","disabled","validationState","inputRef","className","style","title","children"])),h=u[0],d=u[1],p=f.a.createElement("input",o()({},d,{ref:r,type:"radio",disabled:n}));if(t){var m,g=((m={})[F(h,"inline")]=!0,m.disabled=n,m);return f.a.createElement("label",{className:_()(a,g),style:i,title:l},p,c)}var y=o()({},Y(h),{disabled:n});return s&&(y["has-"+s]=!0),f.a.createElement("div",{className:_()(a,y),style:i},f.a.createElement("label",{title:l},p,c))},t}(f.a.Component);ua.propTypes=ca,ua.defaultProps={inline:!1,disabled:!1,title:""};var ha=G("radio",ua),da={children:S.a.element.isRequired,a16by9:S.a.bool,a4by3:S.a.bool},pa=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.a16by9,s=t.a4by3,r=t.className,a=t.children,i=$(v()(t,["a16by9","a4by3","className","children"])),l=i[0],c=i[1],u=o()({},Y(l),((e={})[F(l,"16by9")]=n,e[F(l,"4by3")]=s,e));return f.a.createElement("div",{className:_()(u)},Object(p.cloneElement)(a,o()({},c,{className:_()(r,F(l,"item"))})))},t}(f.a.Component);pa.propTypes=da,pa.defaultProps={a16by9:!1,a4by3:!1};var fa=G("embed-responsive",pa),ma={componentClass:pe.a},ga=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=$(v()(e,["componentClass","className"])),r=s[0],a=s[1],i=Y(r);return f.a.createElement(t,o()({},a,{className:_()(n,i)}))},t}(f.a.Component);ga.propTypes=ma,ga.defaultProps={componentClass:"div"};var ya=G("row",ga),va=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){return f.a.createElement(jt,o()({},this.props,{useAnchor:!1,noCaret:!1}))},t}(f.a.Component);va.defaultProps=jt.defaultProps;var ba=va,_a=o()({},qt.propTypes,{bsStyle:S.a.string,bsSize:S.a.string,href:S.a.string,onClick:S.a.func,title:S.a.node.isRequired,toggleLabel:S.a.string,children:S.a.node}),Ea=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.bsSize,n=e.bsStyle,s=e.title,r=e.toggleLabel,a=e.children,i=v()(e,["bsSize","bsStyle","title","toggleLabel","children"]),l=zt(i,qt.ControlledComponent),c=l[0],u=l[1];return f.a.createElement(qt,o()({},c,{bsSize:t,bsStyle:n}),f.a.createElement(Oe,o()({},u,{disabled:i.disabled,bsSize:t,bsStyle:n}),s),f.a.createElement(ba,{"aria-label":r||s,bsSize:t,bsStyle:n}),f.a.createElement(qt.Menu,null,a))},t}(f.a.Component);Ea.propTypes=_a,Ea.Toggle=ba;var Sa=Ea,wa=S.a.oneOfType([S.a.string,S.a.number]),Ca={id:function(e){var t=null;if(!e.generateChildId){for(var n=arguments.length,s=Array(n>1?n-1:0),r=1;r<n;r++)s[r-1]=arguments[r];(t=wa.apply(void 0,[e].concat(s)))||e.id||(t=new Error("In order to properly initialize Tabs in a way that is accessible to assistive technologies (such as screen readers) an `id` or a `generateChildId` prop to TabContainer is required"))}return t},generateChildId:S.a.func,onSelect:S.a.func,activeKey:S.a.any},Oa={$bs_tabContainer:S.a.shape({activeKey:S.a.any,onSelect:S.a.func.isRequired,getTabId:S.a.func.isRequired,getPaneId:S.a.func.isRequired})},Ta=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.getChildContext=function(){var e=this.props,t=e.activeKey,n=e.onSelect,s=e.generateChildId,r=e.id,a=s||function(e,t){return r?r+"-"+t+"-"+e:null};return{$bs_tabContainer:{activeKey:t,onSelect:n,getTabId:function(e){return a(e,"tab")},getPaneId:function(e){return a(e,"pane")}}}},t.prototype.render=function(){var e=this.props,t=e.children,n=v()(e,["children"]);return delete n.generateChildId,delete n.onSelect,delete n.activeKey,f.a.cloneElement(f.a.Children.only(t),n)},t}(f.a.Component);Ta.propTypes=Ca,Ta.childContextTypes=Oa;var Ma=xt()(Ta,{activeKey:"onSelect"}),Aa={componentClass:pe.a,animation:S.a.oneOfType([S.a.bool,pe.a]),mountOnEnter:S.a.bool,unmountOnExit:S.a.bool},Na={$bs_tabContainer:S.a.shape({activeKey:S.a.any})},xa={$bs_tabContent:S.a.shape({bsClass:S.a.string,animation:S.a.oneOfType([S.a.bool,pe.a]),activeKey:S.a.any,mountOnEnter:S.a.bool,unmountOnExit:S.a.bool,onPaneEnter:S.a.func.isRequired,onPaneExited:S.a.func.isRequired,exiting:S.a.bool.isRequired})},Pa=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handlePaneEnter=r.handlePaneEnter.bind(r),r.handlePaneExited=r.handlePaneExited.bind(r),r.state={activeKey:null,activeChild:null},r}return d()(t,e),t.prototype.getChildContext=function(){var e=this.props,t=e.bsClass,n=e.animation,s=e.mountOnEnter,r=e.unmountOnExit,a=this.state.activeKey,o=this.getContainerActiveKey(),i=null!=a&&a!==o;return{$bs_tabContent:{bsClass:t,animation:n,activeKey:null!=a?a:o,mountOnEnter:s,unmountOnExit:r,onPaneEnter:this.handlePaneEnter,onPaneExited:this.handlePaneExited,exiting:i}}},t.prototype.componentWillReceiveProps=function(e){!e.animation&&this.state.activeChild&&this.setState({activeKey:null,activeChild:null})},t.prototype.componentWillUnmount=function(){this.isUnmounted=!0},t.prototype.getContainerActiveKey=function(){var e=this.context.$bs_tabContainer;return e&&e.activeKey},t.prototype.handlePaneEnter=function(e,t){return!!this.props.animation&&(t===this.getContainerActiveKey()&&(this.setState({activeKey:t,activeChild:e}),!0))},t.prototype.handlePaneExited=function(e){this.isUnmounted||this.setState((function(t){return t.activeChild!==e?null:{activeKey:null,activeChild:null}}))},t.prototype.render=function(){var e=this.props,t=e.componentClass,n=e.className,s=H(v()(e,["componentClass","className"]),["animation","mountOnEnter","unmountOnExit"]),r=s[0],a=s[1];return f.a.createElement(t,o()({},a,{className:_()(n,F(r,"content"))}))},t}(f.a.Component);Pa.propTypes=Aa,Pa.defaultProps={componentClass:"div",animation:!0,mountOnEnter:!1,unmountOnExit:!1},Pa.contextTypes=Na,Pa.childContextTypes=xa;var Ia=G("tab",Pa),Da={eventKey:S.a.any,animation:S.a.oneOfType([S.a.bool,pe.a]),id:S.a.string,"aria-labelledby":S.a.string,bsClass:S.a.string,onEnter:S.a.func,onEntering:S.a.func,onEntered:S.a.func,onExit:S.a.func,onExiting:S.a.func,onExited:S.a.func,mountOnEnter:S.a.bool,unmountOnExit:S.a.bool},ka={$bs_tabContainer:S.a.shape({getTabId:S.a.func,getPaneId:S.a.func}),$bs_tabContent:S.a.shape({bsClass:S.a.string,animation:S.a.oneOfType([S.a.bool,pe.a]),activeKey:S.a.any,mountOnEnter:S.a.bool,unmountOnExit:S.a.bool,onPaneEnter:S.a.func.isRequired,onPaneExited:S.a.func.isRequired,exiting:S.a.bool.isRequired})},La={$bs_tabContainer:S.a.oneOf([null])},Ra=function(e){function t(n,s){l()(this,t);var r=u()(this,e.call(this,n,s));return r.handleEnter=r.handleEnter.bind(r),r.handleExited=r.handleExited.bind(r),r.in=!1,r}return d()(t,e),t.prototype.getChildContext=function(){return{$bs_tabContainer:null}},t.prototype.componentDidMount=function(){this.shouldBeIn()&&this.handleEnter()},t.prototype.componentDidUpdate=function(){this.in?this.shouldBeIn()||this.handleExited():this.shouldBeIn()&&this.handleEnter()},t.prototype.componentWillUnmount=function(){this.in&&this.handleExited()},t.prototype.getAnimation=function(){if(null!=this.props.animation)return this.props.animation;var e=this.context.$bs_tabContent;return e&&e.animation},t.prototype.handleEnter=function(){var e=this.context.$bs_tabContent;e&&(this.in=e.onPaneEnter(this,this.props.eventKey))},t.prototype.handleExited=function(){var e=this.context.$bs_tabContent;e&&(e.onPaneExited(this),this.in=!1)},t.prototype.isActive=function(){var e=this.context.$bs_tabContent,t=e&&e.activeKey;return this.props.eventKey===t},t.prototype.shouldBeIn=function(){return this.getAnimation()&&this.isActive()},t.prototype.render=function(){var e=this.props,t=e.eventKey,n=e.className,s=e.onEnter,r=e.onEntering,a=e.onEntered,i=e.onExit,l=e.onExiting,c=e.onExited,u=e.mountOnEnter,h=e.unmountOnExit,d=v()(e,["eventKey","className","onEnter","onEntering","onEntered","onExit","onExiting","onExited","mountOnEnter","unmountOnExit"]),p=this.context,m=p.$bs_tabContent,g=p.$bs_tabContainer,y=H(d,["animation"]),b=y[0],E=y[1],S=this.isActive(),w=this.getAnimation(),C=null!=u?u:m&&m.mountOnEnter,O=null!=h?h:m&&m.unmountOnExit;if(!S&&!w&&O)return null;var T=!0===w?nn:w||null;m&&(b.bsClass=F(m,"pane"));var M=o()({},Y(b),{active:S});g&&(E.id=g.getPaneId(t),E["aria-labelledby"]=g.getTabId(t));var A=f.a.createElement("div",o()({},E,{role:"tabpanel","aria-hidden":!S,className:_()(n,M)}));if(T){var N=m&&m.exiting;return f.a.createElement(T,{in:S&&!N,onEnter:q(this.handleEnter,s),onEntering:r,onEntered:a,onExit:i,onExiting:l,onExited:q(this.handleExited,c),mountOnEnter:C,unmountOnExit:O},A)}return A},t}(f.a.Component);Ra.propTypes=Da,Ra.contextTypes=ka,Ra.childContextTypes=La;var Ba=G("tab-pane",Ra),Fa=o()({},Ba.propTypes,{disabled:S.a.bool,title:S.a.node,tabClassName:S.a.string}),Ga=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=o()({},this.props);return delete e.title,delete e.disabled,delete e.tabClassName,f.a.createElement(Ba,e)},t}(f.a.Component);Ga.propTypes=Fa,Ga.Container=Ma,Ga.Content=Ia,Ga.Pane=Ba;var ja=Ga,Wa={striped:S.a.bool,bordered:S.a.bool,condensed:S.a.bool,hover:S.a.bool,responsive:S.a.bool},Ya=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.striped,s=t.bordered,r=t.condensed,a=t.hover,i=t.responsive,l=t.className,c=$(v()(t,["striped","bordered","condensed","hover","responsive","className"])),u=c[0],h=c[1],d=o()({},Y(u),((e={})[F(u,"striped")]=n,e[F(u,"bordered")]=s,e[F(u,"condensed")]=r,e[F(u,"hover")]=a,e)),p=f.a.createElement("table",o()({},h,{className:_()(l,d)}));return i?f.a.createElement("div",{className:F(u,"responsive")},p):p},t}(f.a.Component);Ya.propTypes=Wa,Ya.defaultProps={bordered:!1,condensed:!1,hover:!1,responsive:!1,striped:!1};var Xa=G("table",Ya),Ua=Ma.ControlledComponent,$a={activeKey:S.a.any,bsStyle:S.a.oneOf(["tabs","pills"]),animation:S.a.bool,id:At()(S.a.oneOfType([S.a.string,S.a.number])),onSelect:S.a.func,mountOnEnter:S.a.bool,unmountOnExit:S.a.bool};var Ha=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.renderTab=function(e){var t=e.props,n=t.title,s=t.eventKey,r=t.disabled,a=t.tabClassName;return null==n?null:f.a.createElement(Er,{eventKey:s,disabled:r,className:a},n)},t.prototype.render=function(){var e=this.props,t=e.id,n=e.onSelect,s=e.animation,r=e.mountOnEnter,a=e.unmountOnExit,i=e.bsClass,l=e.className,c=e.style,u=e.children,h=e.activeKey,d=void 0===h?function(e){var t=void 0;return z.forEach(e,(function(e){null==t&&(t=e.props.eventKey)})),t}(u):h,p=v()(e,["id","onSelect","animation","mountOnEnter","unmountOnExit","bsClass","className","style","children","activeKey"]);return f.a.createElement(Ua,{id:t,activeKey:d,onSelect:n,className:l,style:c},f.a.createElement("div",null,f.a.createElement(zs,o()({},p,{role:"tablist"}),z.map(u,this.renderTab)),f.a.createElement(Ia,{bsClass:i,animation:s,mountOnEnter:r,unmountOnExit:a},u)))},t}(f.a.Component);Ha.propTypes=$a,Ha.defaultProps={bsStyle:"tabs",animation:!0,mountOnEnter:!1,unmountOnExit:!1},G("tab",Ha);var Va=xt()(Ha,{activeKey:"onSelect"}),Ka={src:S.a.string,alt:S.a.string,href:S.a.string,onError:S.a.func,onLoad:S.a.func},qa=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.src,n=e.alt,s=e.onError,r=e.onLoad,a=e.className,i=e.children,l=$(v()(e,["src","alt","onError","onLoad","className","children"])),c=l[0],u=l[1],h=u.href?ye:"div",d=Y(c);return f.a.createElement(h,o()({},u,{className:_()(a,d)}),f.a.createElement("img",{src:t,alt:n,onError:s,onLoad:r}),i&&f.a.createElement("div",{className:"caption"},i))},t}(f.a.Component);qa.propTypes=Ka;var za=G("thumbnail",qa),Ja={type:S.a.oneOf(["checkbox","radio"]),name:S.a.string,checked:S.a.bool,disabled:S.a.bool,onChange:S.a.func,value:S.a.any.isRequired},Qa=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.children,n=e.name,s=e.checked,r=e.type,a=e.onChange,i=e.value,l=v()(e,["children","name","checked","type","onChange","value"]),c=l.disabled;return f.a.createElement(Oe,o()({},l,{active:!!s,componentClass:"label"}),f.a.createElement("input",{name:n,type:r,autoComplete:"off",value:i,checked:!!s,disabled:!!c,onChange:a}),t)},t}(f.a.Component);Qa.propTypes=Ja;var Za=Qa,eo={name:S.a.string,value:S.a.any,onChange:S.a.func,type:S.a.oneOf(["checkbox","radio"]).isRequired},to=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.getValues=function(){var e=this.props.value;return null==e?[]:[].concat(e)},t.prototype.handleToggle=function(e){var t=this.props,n=t.type,s=t.onChange,r=this.getValues(),a=-1!==r.indexOf(e);"radio"!==n?s(a?r.filter((function(t){return t!==e})):[].concat(r,[e])):a||s(e)},t.prototype.render=function(){var e=this,t=this.props,n=t.children,s=t.type,r=t.name,a=v()(t,["children","type","name"]),i=this.getValues();return"radio"!==s||r||T()(!1),delete a.onChange,delete a.value,f.a.createElement(xe,o()({},a,{"data-toggle":"buttons"}),z.map(n,(function(t){var n=t.props,a=n.value,o=n.onChange;return f.a.cloneElement(t,{type:s,name:t.name||r,checked:-1!==i.indexOf(a),onChange:q(o,(function(){return e.handleToggle(a)}))})})))},t}(f.a.Component);to.propTypes=eo,to.defaultProps={type:"radio"};var no=xt()(to,{value:"onChange"});no.Button=Za;var so=no,ro={id:At()(S.a.oneOfType([S.a.string,S.a.number])),placement:S.a.oneOf(["top","right","bottom","left"]),positionTop:S.a.oneOfType([S.a.number,S.a.string]),positionLeft:S.a.oneOfType([S.a.number,S.a.string]),arrowOffsetTop:S.a.oneOfType([S.a.number,S.a.string]),arrowOffsetLeft:S.a.oneOfType([S.a.number,S.a.string])},ao=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e,t=this.props,n=t.placement,s=t.positionTop,r=t.positionLeft,a=t.arrowOffsetTop,i=t.arrowOffsetLeft,l=t.className,c=t.style,u=t.children,h=$(v()(t,["placement","positionTop","positionLeft","arrowOffsetTop","arrowOffsetLeft","className","style","children"])),d=h[0],p=h[1],m=o()({},Y(d),((e={})[n]=!0,e)),g=o()({top:s,left:r},c),y={top:a,left:i};return f.a.createElement("div",o()({},p,{role:"tooltip",className:_()(l,m),style:g}),f.a.createElement("div",{className:F(d,"arrow"),style:y}),f.a.createElement("div",{className:F(d,"inner")},u))},t}(f.a.Component);ao.propTypes=ro,ao.defaultProps={placement:"right"};var oo=G("tooltip",ao),io=function(e){function t(){return l()(this,t),u()(this,e.apply(this,arguments))}return d()(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=$(v()(e,["className"])),s=n[0],r=n[1],a=Y(s);return f.a.createElement("div",o()({},r,{className:_()(t,a)}))},t}(f.a.Component),lo=G("well",W([M,A],io))},function(e,t,n){e.exports={default:n(744),__esModule:!0}},function(e,t,n){e.exports=n(423)},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1)),a=s(n(17)),o=n(424);if(a.default.render(r.default.createElement(o.BattlesTop,null),document.getElementById("mount-point")),/debug/.test(document.location.search)){let e=r.default.createClass;Object.defineProperty(r.default,"createClass",{set:t=>{e=t}})}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.BattlesTop=void 0;const i=a(n(1)),l=o(n(425)),c=o(n(472)),u=o(n(277)),h=o(n(474)),d=o(n(673)),p=o(n(189)),f=o(n(676)),m=o(n(680)),g=o(n(796)),y=o(n(360)),v=o(n(797)),b=o(n(798)),_=o(n(799)),E=o(n(800)),S=o(n(801)),w=o(n(836)),C=o(n(837)),O=o(n(838)),T=n(249),M=(n(15)("bitn:top"),o(n(4))),A=n(25),N=n(411);class x extends i.Component{constructor(e){super(e),this.loadScriptId="#load-script-input",this.loadFromScriptId="#load-from-script-input",this.levelInputId="#level-file-input",this.gameManager=new N.GameManager(this.setState.bind(this)),this.gameManager.progressCb=this.progress.bind(this),this.state={animation:null,boardClassName:this.gameManager.boardClassName,editorData:{},equipSelected:null,invMsg:"",invMsgStyle:"",levelSize:"Medium",loadFromEditor:!1,mouseOverCell:null,hoverCell:null,playMode:"OverWorld",playerClass:"",playerRace:"",playerLevel:"Medium",playerName:"Player",plugins:[],progress:"",render:!0,renderInAscii:!0,saveInProgress:!1,seedName:"",selectedCell:null,selectedGame:null,selectedItem:null,selectedQuest:null,showCharInfo:!1,showCreateScreen:!1,showEditor:!1,showGameMenu:!1,showHelpScreen:!1,showInventory:!1,showCraftingMenu:!1,showShopMenu:!1,showLoadScreen:!1,showMap:!1,showOWMap:!1,showPlugins:!1,showStartScreen:!0},this.bindCallbacks(),this.initGUICommandTable()}showPluginManager(){this.setState({showPlugins:!this.state.showPlugins})}toggleEditor(){this.gameManager.cancelAnim();const e=this.state.showEditor;this.setState({showStartScreen:e,showEditor:!this.state.showEditor})}selectSaveGame(e){this.setState({selectedGame:e})}setPlayerName(e){this.gameManager.setPlayerName(e),this.setState({playerName:e})}setSeedName(e){this.gameManager.setSeedName(e),this.setState({seedName:e})}setViewSize(e,t){this.gameManager.setViewSize(e,t),this.setState({render:!0})}setViewType(e){this.gameManager.setViewType(e),this.setState({render:!0,boardClassName:this.gameManager.boardClassName,showMap:this.gameManager.showMap})}newGame(){this.gameManager.enableKeys(),this.hideScreen("StartScreen"),this.state.loadFromEditor?this.createGameFromEditor():(this.createNewGame(),this.setState({render:!0}))}createGameFromEditor(){const e=this.state.editorData.levelsToPlay;this.gameManager.createGameFromLevels(e)}saveGame(){this.gameManager.saveGame(()=>{this.setState({saveInProgress:!1})})}loadGame(e){this.gameManager.loadGame(e,e=>{this.gameManager.initRestoredGame(e)})}deleteGame(e){this.gameManager.deleteGame(e,()=>{this.setState({render:!0,selectedGame:null})})}createNewGame(){this.gameManager.createNewGame(()=>{this.showScreen("CreateScreen")})}progress(e){this.setState({progress:e})}loadFromScript(){document.querySelector(this.loadFromScriptId).click()}selectItemTop(e){this.setState({selectedItem:e})}selectEquipTop(e){e?this.setState({selectedItem:e.item,equipSelected:e}):this.setState({selectedItem:null,equipSelected:null})}onMouseOverCell(e,t){const n=this.gameManager.getCellCurrMap(e,t);console.log("onMouseOverCell",e,t),n&&this.setState({mouseOverCell:n})}onMouseOver(e,t){const n=this.gameManager.getCellCurrMap(e,t);n&&n.hasActors()&&this.setState({hoverCell:n})}handleRightClick(e,t,n){const[s,r]=n.getXY();this.gameManager.useClickHandler(s,r,n,t.type)}onCellClick(e,t){this.gameManager.onCellClick(e,t)}importJSON(){document.querySelector(this.levelInputId).click()}loadScript(){document.querySelector(this.loadScriptId).click()}onLoadScript(){this.gameManager.onLoadScript(this.loadScriptId,()=>{this.updatePluginList()})}onLoadFromScript(){this.gameManager.onLoadFromScript(this.loadFromScriptId,()=>{this.setState({render:!0})})}updatePluginList(){this.setState({showPlugins:!0,plugins:this.gameManager.getPlugins()})}setPlayerDriver(){this.gameManager.setPlayerDriver()}onLoadCallback(e){this.gameManager.onLoadCallback(e,()=>{this.setState({render:!0})})}onLoadRecordedKeys(e){this.gameManager.onLoadRecordedKeys(e)}render(){const[e,t]=this.gameManager.getOWAndPlayerPos();let n="",s=null,r=null,a=null,o=null,M=null;const A=this.gameManager.getMessages(),N=this.gameManager.isGameValid(),x=this.gameManager.isMenuShown();let P="";if(N){s=this.gameManager.getPlayer(),this.gameManager.renderScreen(),r=this.gameManager.getScreen(),a=r.getCharRows(),o=r.getClassRows(),M=r.getStartX();n="cell-row-div-player-view",this.state.showMap&&(n="cell-row-div-map-view"),this.state.selectedQuest&&(P=this.getQuestDir())}const I={playerClass:this.state.playerClass,playerRace:this.state.playerRace,playMode:this.state.playMode,playerLevel:this.state.playerLevel,levelSize:this.state.levelSize},D=this.getOneSelectedCell();return i.createElement("div",{className:"container-fluid main-div",id:"main-div"},i.createElement(v.default,{menuCallback:this.topMenuCallback}),(this.state.showStartScreen||this.state.showLoadScreen)&&i.createElement(l.default,{deleteGame:this.deleteGame,loadFromEditor:this.state.loadFromEditor,loadGame:this.loadGame,newGame:this.newGame,playerName:this.state.playerName,progress:this.state.progress,savedPlayerList:this.gameManager.getPlayersAsList(),seedName:this.state.seedName,selectedGame:this.state.selectedGame,selectGame:this.selectSaveGame,setPlayerClass:this.setPlayerClass,setPlayerLevel:this.setPlayerLevel,setPlayerName:this.setPlayerName,setPlayerRace:this.setPlayerRace,setPlayMode:this.setPlayMode,setSeedName:this.setSeedName,settings:I,showLoadScreen:this.state.showLoadScreen,showStartScreen:this.state.showStartScreen,toggleEditor:this.toggleEditor,toggleScreen:this.toggleScreen}),this.state.showCreateScreen&&i.createElement(b.default,{gameCreated:N,progress:this.state.progress,showCreateScreen:this.state.showCreateScreen,toggleScreen:this.toggleScreen}),this.state.showHelpScreen&&i.createElement(d.default,{showHelpScreen:this.state.showHelpScreen,toggleScreen:this.toggleScreen}),this.state.showOWMap&&i.createElement(h.default,{ow:e,playerOwPos:t,showOWMap:this.state.showOWMap,toggleScreen:this.toggleScreen}),N&&!this.state.showEditor&&this.state.showInventory&&i.createElement(f.default,{doInvCmd:this.doInvCmd,equipSelected:this.state.equipSelected,handleKeyDown:this.gameManager.handleKeyDown,invMsg:this.state.invMsg,msgStyle:this.state.invMsgStyle,player:s,selectedItem:this.state.selectedItem,selectEquipTop:this.selectEquipTop,selectItemTop:this.selectItemTop,setInventoryMsg:this.setInventoryMsg,showInventory:this.state.showInventory,toggleScreen:this.toggleScreen}),N&&!this.state.showEditor&&this.state.showCraftingMenu&&i.createElement(w.default,{doInvCmd:this.doInvCmd,handleKeyDown:this.gameManager.handleKeyDown,invMsg:this.state.invMsg,msgStyle:this.state.invMsgStyle,player:s,setInventoryMsg:this.setInventoryMsg,showCraftingMenu:this.state.showCraftingMenu,toggleScreen:this.toggleScreen}),N&&!this.state.showEditor&&this.state.showShopMenu&&i.createElement(C.default,{doInvCmd:this.doInvCmd,handleKeyDown:this.gameManager.handleKeyDown,invMsg:this.state.invMsg,msgStyle:this.state.invMsgStyle,player:s,setInventoryMsg:this.setInventoryMsg,showShopMenu:this.state.showShopMenu,toggleScreen:this.toggleScreen}),N&&!this.state.showEditor&&this.state.showCharInfo&&i.createElement(g.default,{player:s,showCharInfo:this.state.showCharInfo,toggleScreen:this.toggleScreen,selectedQuest:this.state.selectedQuest,setSelectedQuest:this.setSelectedQuest}),this.state.showPlugins&&i.createElement(E.default,{pluginManager:this.gameManager.pluginManager,plugins:this.state.plugins,updatePluginList:this.updatePluginList}),!this.state.showEditor&&i.createElement("div",{className:"row game-panel-div"},i.createElement("div",{className:"col-md-2"},N&&i.createElement("div",{className:"text-left game-stats-div"},i.createElement(S.default,{player:s,questDir:P,selectedCell:D,selectedItem:this.state.selectedItem,setViewType:this.setViewType,showMap:this.state.showMap,toggleScreen:this.toggleScreen}))),N&&i.createElement("div",{className:"col-md-10"},i.createElement("div",{className:"game-messages-div"},i.createElement(u.default,{message:A,saveInProgress:this.state.saveInProgress,showAll:!1,visibleCells:this.gameManager.guiState("visibleCells")})),i.createElement("div",{className:"game-board-div"},!x&&i.createElement(T.ContextMenuTrigger,{id:"right-click-context-menu"},i.createElement(p.default,{boardClassName:this.state.boardClassName,charRows:a,classRows:o,endY:r.endY,onCellClick:this.onCellClick,onMouseOverCell:this.onMouseOverCell,onMouseOver:this.onMouseOver,rowClass:n,sizeX:2*r.viewportX+1,startX:M,startY:r.startY,useRLE:this.state.renderInAscii&&!0,renderInAscii:this.state.renderInAscii,levelMap:this.gameManager.getMap()})),x&&i.createElement(c.default,{height:28,menuItemClicked:this.menuItemClicked,menuObj:this.gameManager.getMenu(),width:80})))),!this.state.showEditor&&i.createElement(i.Fragment,null,i.createElement(y.default,{id:"",objData:this.gameManager.game,onLoadCallback:this.onLoadCallback,pretty:!1,savedObjName:s?"saveGame_"+s.getName():"",saveButtonName:"Save",loadButtonName:"Load game",setMsg:this.showMsg}),i.createElement(y.default,{fNamePrefix:"keys",id:"keys",loadInputValue:"Load keys",objData:this.gameManager.getRecordedCommands(),onLoadCallback:this.onLoadRecordedKeys,pretty:!1,savedObjName:s?"recorded_cmds_"+s.getName():"",saveButtonName:"SaveKeys",loadButtonName:"LoadKeys",setMsg:this.showMsg})),!this.state.showEditor&&i.createElement(i.Fragment,null,i.createElement(O.default,{handleRightClick:this.handleRightClick,mouseOverCell:this.state.mouseOverCell})),this.state.showEditor&&i.createElement(m.default,{editorData:this.state.editorData,setEditorData:this.setEditorData,toggleEditor:this.toggleEditor}),i.createElement(_.default,{inputId:"load-script-input",onLoadScript:this.onLoadScript}),i.createElement(_.default,{inputId:"load-from-script-input",onLoadScript:this.onLoadFromScript}))}menuItemClicked(e){this.gameManager.menuItemClicked(e)}setEditorData(e,t){const n={levelsToPlay:e,allLevels:t};this.setPlayMode("Editor"),this.setState({editorData:n,loadFromEditor:!0})}getOneSelectedCell(){if(Array.isArray(this.state.selectedCell)){const e=this.state.selectedCell;if(e.length>0)return e[0]}return this.state.selectedCell}initGUICommandTable(){const e={};e[A.Keys.GUI.Help]=this.GUIHelp.bind(this),e[A.Keys.GUI.Help2]=this.GUIHelp.bind(this),e[A.Keys.GUI.Inv]=this.GUIInventory.bind(this),e[A.Keys.GUI.Map]=this.GUIMap.bind(this),e[A.Keys.GUI.OwMap]=this.GUIOverWorldMap.bind(this),e[A.Keys.GUI.Use]=this.GUIUseItem.bind(this),e[A.Keys.GUI.Craft]=this.GUICraft.bind(this),e[A.Keys.GUI.Shop]=this.GUIShop.bind(this),e[A.Keys.GUI.CharInfo]=this.GUICharInfo.bind(this),e.GOTO=this.GUIGoto.bind(this),this.gameManager.setGUICommands(e)}GUIHelp(){this.showScreen("HelpScreen")}GUICharInfo(){this.showScreen("CharInfo")}GUIGoto(e,t){const n=this.gameManager.getPlayer().getCell();this.gameManager.useClickHandler(e,t,n,"move")}doInvCmd(e){this.gameManager.updateGame(e)}setInventoryMsg(e){this.setState({invMsg:e.invMsg,invMsgStyle:e.msgStyle})}GUIInventory(){this.toggleScreen("Inventory")}GUIMap(){this.state.showMap?this.setViewType(N.VIEW_PLAYER):this.setViewType(N.VIEW_MAP)}GUIOverWorldMap(){this.toggleScreen("OWMap")}GUILook(){this.gameManager.GUILook(e=>{this.setState(e)})}GUIUseItem(e){this.gameManager.guiState("useModeEnabled")?this.state.selectedItem?this.gameManager.useItem(e,this.state.selectedItem):M.default.gameWarn("No item selected for using!"):(this.gameManager.guiState("useModeEnabled",!0),null===this.state.selectedItem&&this.showScreen("Inventory"),M.default.gameMsg("Select direction for using the item."))}GUINextTarget(){if(this.gameManager.guiState("isTargeting")){const e=this.gameManager.getNextTargetCell();e&&(this.gameManager.setSelectedCell(e),this.setState({selectedCell:e}))}}GUICraft(){this.toggleScreen("CraftingMenu")}GUIShop(){var e;const t=this.gameManager.getPlayer();t&&((null===(e=t.getCell())||void 0===e?void 0:e.hasShop())?this.toggleScreen("ShopMenu"):M.default.gameMsg("You are not inside a shop!"))}showScreen(e){const t="show"+e;if(this.gameManager.disableKeys(),this.state.hasOwnProperty(t))this.setState({[t]:!0});else{const e=`showScreen: key ${t} not found in state`;console.error(e),M.default.gameIntError(`Screen for ${t} not implemented yet`)}}hideScreen(e){const t="show"+e;this.gameManager.enableKeys(),this.setState({[t]:!1})}toggleScreen(e){const t="show"+e,n=this.state[t];n?this.gameManager.enableKeys():this.gameManager.disableKeys(),this.setState({[t]:!n})}showStartScreen(){this.state.showStartScreen||this.setState({showStartScreen:!0})}showLoadScreen(){this.setState({showLoadScreen:!0})}setPlayerLevel(e){this.setGameSetting("playerLevel",e)}setPlayerClass(e){this.setGameSetting("playerClass",e)}setPlayerRace(e){this.setGameSetting("playerRace",e)}setPlayMode(e){this.setGameSetting("playMode",e)}setGameSetting(e,t){this.gameManager.setGameSettings(e,t),this.setState({[e]:t})}topMenuCallback(e,t){"function"==typeof this[e]?Array.isArray(t)?1===t.length?this[e](t):this[e](...t):this[e](t):"function"==typeof this.gameManager[e]?Array.isArray(t)?1===t.length?this.gameManager[e](t):this.gameManager[e](...t):this.gameManager[e](t):(console.error(e+" not a function in Top"),console.error("Called with args "+t))}increaseFont(e){this.gameManager.increaseFont(e[0]),this.setState({render:!0,boardClassName:this.gameManager.boardClassName})}showMsg(e){let t=e;e.errorMsg&&(t=e.errorMsg),M.default.diag("showMsg:"+t),console.log("showMsg arg:",e),this.setState({msg:t})}bindCallbacks(){this.newGame=this.newGame.bind(this),this.showMsg=this.showMsg.bind(this),this.deleteGame=this.deleteGame.bind(this),this.loadGame=this.loadGame.bind(this),this.setPlayMode=this.setPlayMode.bind(this),this.setPlayerLevel=this.setPlayerLevel.bind(this),this.setPlayerName=this.setPlayerName.bind(this),this.setSeedName=this.setSeedName.bind(this),this.setPlayerClass=this.setPlayerClass.bind(this),this.setPlayerRace=this.setPlayerRace.bind(this),this.setViewSize=this.setViewSize.bind(this),this.saveGame=this.saveGame.bind(this),this.setViewType=this.setViewType.bind(this),this.onCellClick=this.onCellClick.bind(this),this.handleRightClick=this.handleRightClick.bind(this),this.onMouseOverCell=this.onMouseOverCell.bind(this),this.onMouseOver=this.onMouseOver.bind(this),this.GUIHelp=this.GUIHelp.bind(this),this.GUIInventory=this.GUIInventory.bind(this),this.GUIMap=this.GUIMap.bind(this),this.GUIOverWorldMap=this.GUIOverWorldMap.bind(this),this.GUINextTarget=this.GUINextTarget.bind(this),this.GUILook=this.GUILook.bind(this),this.GUIUseItem=this.GUIUseItem.bind(this),this.GUICraft=this.GUICraft.bind(this),this.selectSaveGame=this.selectSaveGame.bind(this),this.setInventoryMsg=this.setInventoryMsg.bind(this),this.selectEquipTop=this.selectEquipTop.bind(this),this.selectItemTop=this.selectItemTop.bind(this),this.doInvCmd=this.doInvCmd.bind(this),this.setEditorData=this.setEditorData.bind(this),this.toggleEditor=this.toggleEditor.bind(this),this.toggleScreen=this.toggleScreen.bind(this),this.showScreen=this.showScreen.bind(this),this.hideScreen=this.hideScreen.bind(this),this.showStartScreen=this.showStartScreen.bind(this),this.showLoadScreen=this.showLoadScreen.bind(this),this.onLoadRecordedKeys=this.onLoadRecordedKeys.bind(this),this.onLoadCallback=this.onLoadCallback.bind(this),this.topMenuCallback=this.topMenuCallback.bind(this),this.menuItemClicked=this.menuItemClicked.bind(this),this.onLoadScript=this.onLoadScript.bind(this),this.onLoadFromScript=this.onLoadFromScript.bind(this),this.loadScript=this.loadScript.bind(this),this.updatePluginList=this.updatePluginList.bind(this),this.increaseFont=this.increaseFont.bind(this),this.setSelectedQuest=this.setSelectedQuest.bind(this)}useAsciiTiles(){this.setState({renderInAscii:!0})}useGraphicalTiles(){this.setState({renderInAscii:!1})}setSelectedQuest(e){this.setState({selectedQuest:e})}getQuestDir(){const e=this.state.selectedQuest;if(e){this.gameManager.getPlayer(),e.next()}return""}}t.BattlesTop=x},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=a(n(1)),l=o(n(70)),c=o(n(426)),u=o(n(4)),h=o(n(59)),d=n(263),p=n(91),f=n(471);class m extends i.Component{constructor(e){super(e),this.onNameChange=this.onNameChange.bind(this),this.deleteGame=this.deleteGame.bind(this),this.selectGame=this.selectGame.bind(this),this.loadGame=this.loadGame.bind(this),this.onSeedChange=this.onSeedChange.bind(this)}onNameChange(e){const t=e.target.value;e.stopPropagation(),this.props.setPlayerName(t)}onSeedChange(e){const t=e.target.value;e.stopPropagation(),this.props.setSeedName(t)}loadGame(){this.props.loadGame(this.props.selectedGame)}deleteGame(){this.props.deleteGame(this.props.selectedGame)}selectGame(e){this.props.selectGame(e)}render(){const e=this.props.setPlayerLevel,t=this.props.setPlayMode,n=this.props.savedPlayerList.map((e,t)=>i.createElement("div",{className:"player-list-item",key:t,onClick:this.selectGame.bind(this,e.name)},"Name: ",e.name,", L: ",e.expLevel," DL: ",e.dungeonLevel)),s=this.props.newGame,r=u.default.gameTitle+" Load a game";let a=null;return this.props.progress&&(a=i.createElement("div",null,i.createElement("p",{className:"text-info"},this.props.progress))),this.props.loadFromEditor&&(a=i.createElement("div",null,i.createElement("p",{className:"text-warning"},"Using Editor data for the Game"))),i.createElement("div",{id:"game-start-screen"},this.props.showLoadScreen&&i.createElement(h.default,{"aria-labelledby":"game-load-modal-label",id:"gameLoadModal",large:!0,onHide:this.toggleScreen.bind(this,"LoadScreen"),show:this.props.showLoadScreen},i.createElement(l.default,{id:"game-load-modal-label",text:r}),i.createElement("div",{className:"modal-body row"},n,i.createElement("p",null,"Selected game: ",this.props.selectedGame)),i.createElement("div",{className:"modal-footer row"},i.createElement("div",{className:"col-md-6"},i.createElement("button",{className:"btn btn-secondary btn-warning","data-dismiss":"modal",onClick:this.loadGame,type:"button"},"Load"),i.createElement("button",{className:"btn btn-secondary btn-danger",onClick:this.deleteGame,type:"button"},"Delete")))),this.props.showStartScreen&&i.createElement(h.default,{"aria-labelledby":"game-start-modal-label",id:"gameStartModal",large:!0,onHide:this.toggleScreen.bind(this,"StartScreen"),show:this.props.showStartScreen},i.createElement(h.default.Header,{closeButton:!0},i.createElement(h.default.Title,{id:"game-start-modal-label"},u.default.gameTitle)),i.createElement(h.default.Body,null,i.createElement("div",{className:"row"},i.createElement("div",{className:"col-md-6",id:"prologue-box"},i.createElement("p",null," ",d.Texts.intro.chapter1," "),i.createElement("p",null," ",d.Texts.intro.chapter2," "),i.createElement("label",null,"You'll be forgotten as:",i.createElement("input",{onChange:this.onNameChange,type:"text",value:this.props.playerName})),i.createElement("label",null,"You can enter a seed here (optional):",i.createElement("input",{onChange:this.onSeedChange,type:"text",value:this.props.seedName}))),i.createElement("div",{className:"col-md-6",id:"game-options-box"},i.createElement("p",null,"Game settings"),i.createElement("div",{className:"dropdown-select-div"},i.createElement(c.default,{callback:e,currValue:this.props.settings.playerLevel,options:["Weak","Medium","Strong","Inhuman"],titleName:"Player"}),i.createElement(c.default,{callback:this.props.setPlayerClass,currValue:this.props.settings.playerClass,options:p.ACTOR_CLASSES,titleName:"Player class"}),i.createElement(c.default,{callback:this.props.setPlayerRace,currValue:this.props.settings.playerRace,options:u.default.ACTOR_RACES,titleName:"Player race"})),i.createElement("div",{className:"dropdown-select-div"},i.createElement(c.default,{callback:t,currValue:this.props.settings.playMode,id:"dropdown-select-playmode",options:["OverWorld","Arena","Sandbox"],titleName:"Play mode"})),a))),i.createElement("div",{className:"modal-footer row"},i.createElement("div",{className:"col-md-6"},f.isDevel&&i.createElement("button",{className:"btn btn-primary","data-dismiss":"modal",onClick:this.props.toggleEditor,type:"button"},"Editor"),i.createElement("button",{className:"btn btn-success","data-dismiss":"modal",id:"embark-button",onClick:s,type:"button"},"Embark!"),i.createElement("button",{className:"btn btn-secondary btn-warning","data-dismiss":"modal",onClick:this.toggleScreen.bind(this,"LoadScreen"),type:"button"},"Load")))))}toggleScreen(e){this.props.toggleScreen(e)}}t.default=m},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(1));class i extends o.Component{constructor(e){super(e),this.onChange=this.onChange.bind(this)}render(){this.props.id||this.props.titleName;const e=this.getOptElems();return o.createElement("label",null,this.props.titleName,o.createElement("select",{id:this.props.id,name:"name-"+this.props.titleName,onChange:this.onChange,value:this.props.currValue},e))}onChange(e){const t=e.target.value;this.props.callback(t)}getOptElems(){return this.props.options?this.props.options.map(e=>{const t=`key-${this.props.titleName}-${e}`;return o.createElement("option",{key:t,value:e},e)}):null}}t.default=i},function(e,t,n){"use strict";var s=n(428);function r(){}e.exports=function(){function e(e,t,n,r,a,o){if(o!==s){var i=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw i.name="Invariant Violation",i}}function t(){return e}e.isRequired=e;var n={array:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t};return n.checkPropTypes=r,n.PropTypes=n,n}},function(e,t,n){"use strict";e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=S(n(171)),a=S(n(58)),o=S(n(41)),i=S(n(0)),l=S(n(131)),c=S(n(430)),u=S(n(431)),h=n(1),d=S(h),p=S(n(17)),f=S(n(32)),m=S(n(434)),g=S(n(444)),y=S(n(446)),v=S(n(447)),b=S(n(448)),_=S(n(174)),E=S(n(175));function S(e){return e&&e.__esModule?e:{default:e}}function w(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function C(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var O=new m.default,T=function(e){function t(){var n,s;w(this,t);for(var r=arguments.length,a=Array(r),o=0;o<r;o++)a[o]=arguments[o];return n=s=C(this,e.call.apply(e,[this].concat(a))),M.call(s),C(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.omitProps=function(e,t){var n=Object.keys(e),s={};return n.map((function(n){Object.prototype.hasOwnProperty.call(t,n)||(s[n]=e[n])})),s},t.prototype.render=function(){var e=this.props,n=e.show,r=e.container,a=e.children,o=e.transition,i=e.backdrop,l=e.className,c=e.style,u=e.onExit,p=e.onExiting,f=e.onEnter,m=e.onEntering,v=e.onEntered,b=d.default.Children.only(a),_=this.omitProps(this.props,t.propTypes);if(!(n||o&&!this.state.exited))return null;var E=b.props,S=E.role,w=E.tabIndex;return void 0!==S&&void 0!==w||(b=(0,h.cloneElement)(b,{role:void 0===S?"document":S,tabIndex:null==w?"-1":w})),o&&(b=d.default.createElement(o,{appear:!0,unmountOnExit:!0,in:n,onExit:u,onExiting:p,onExited:this.handleHidden,onEnter:f,onEntering:m,onEntered:v},b)),d.default.createElement(g.default,{ref:this.setMountNode,container:r,onRendered:this.onPortalRendered},d.default.createElement("div",s({ref:this.setModalNodeRef,role:S||"dialog"},_,{style:c,className:l}),i&&this.renderBackdrop(),d.default.createElement(y.default,{ref:this.setDialogRef},b)))},t.prototype.componentWillReceiveProps=function(e){e.show?this.setState({exited:!1}):e.transition||this.setState({exited:!0})},t.prototype.componentWillUpdate=function(e){!this.props.show&&e.show&&this.checkForFocus()},t.prototype.componentDidMount=function(){this._isMounted=!0,this.props.show&&this.onShow()},t.prototype.componentDidUpdate=function(e){var t=this.props.transition;!e.show||this.props.show||t?!e.show&&this.props.show&&this.onShow():this.onHide()},t.prototype.componentWillUnmount=function(){var e=this.props,t=e.show,n=e.transition;this._isMounted=!1,(t||n&&!this.state.exited)&&this.onHide()},t.prototype.autoFocus=function(){if(this.props.autoFocus){var e=this.getDialogElement(),t=(0,r.default)((0,E.default)(this));e&&!(0,a.default)(e,t)&&(this.lastFocus=t,e.hasAttribute("tabIndex")||((0,f.default)(!1,'The modal content node does not accept focus. For the benefit of assistive technologies, the tabIndex of the node is being set to "-1".'),e.setAttribute("tabIndex",-1)),e.focus())}},t.prototype.restoreLastFocus=function(){this.lastFocus&&this.lastFocus.focus&&(this.lastFocus.focus(),this.lastFocus=null)},t.prototype.getDialogElement=function(){return p.default.findDOMNode(this.dialog)},t.prototype.isTopModal=function(){return this.props.manager.isTopModal(this)},t}(d.default.Component);T.propTypes=s({},g.default.propTypes,{show:i.default.bool,container:i.default.oneOfType([l.default,i.default.func]),onShow:i.default.func,onHide:i.default.func,backdrop:i.default.oneOfType([i.default.bool,i.default.oneOf(["static"])]),renderBackdrop:i.default.func,onEscapeKeyDown:i.default.func,onEscapeKeyUp:(0,c.default)(i.default.func,"Please use onEscapeKeyDown instead for consistency"),onBackdropClick:i.default.func,backdropStyle:i.default.object,backdropClassName:i.default.string,containerClassName:i.default.string,keyboard:i.default.bool,transition:u.default,backdropTransition:u.default,autoFocus:i.default.bool,enforceFocus:i.default.bool,restoreFocus:i.default.bool,onEnter:i.default.func,onEntering:i.default.func,onEntered:i.default.func,onExit:i.default.func,onExiting:i.default.func,onExited:i.default.func,manager:i.default.object.isRequired}),T.defaultProps={show:!1,backdrop:!0,keyboard:!0,autoFocus:!0,enforceFocus:!0,restoreFocus:!0,onHide:function(){},manager:O,renderBackdrop:function(e){return d.default.createElement("div",e)}};var M=function(){var e=this;this.state={exited:!this.props.show},this.renderBackdrop=function(){var t=e.props,n=t.backdropStyle,s=t.backdropClassName,r=t.renderBackdrop,a=t.backdropTransition,o=r({ref:function(t){return e.backdrop=t},style:n,className:s,onClick:e.handleBackdropClick});return a&&(o=d.default.createElement(a,{appear:!0,in:e.props.show},o)),o},this.onPortalRendered=function(){e.autoFocus(),e.props.onShow&&e.props.onShow()},this.onShow=function(){var t=(0,E.default)(e),n=(0,_.default)(e.props.container,t.body);e.props.manager.add(e,n,e.props.containerClassName),e._onDocumentKeydownListener=(0,v.default)(t,"keydown",e.handleDocumentKeyDown),e._onDocumentKeyupListener=(0,v.default)(t,"keyup",e.handleDocumentKeyUp),e._onFocusinListener=(0,b.default)(e.enforceFocus)},this.onHide=function(){e.props.manager.remove(e),e._onDocumentKeydownListener.remove(),e._onDocumentKeyupListener.remove(),e._onFocusinListener.remove(),e.props.restoreFocus&&e.restoreLastFocus()},this.setMountNode=function(t){e.mountNode=t?t.getMountNode():t},this.setModalNodeRef=function(t){e.modalNode=t},this.setDialogRef=function(t){e.dialog=t},this.handleHidden=function(){var t;(e.setState({exited:!0}),e.onHide(),e.props.onExited)&&(t=e.props).onExited.apply(t,arguments)},this.handleBackdropClick=function(t){t.target===t.currentTarget&&(e.props.onBackdropClick&&e.props.onBackdropClick(t),!0===e.props.backdrop&&e.props.onHide())},this.handleDocumentKeyDown=function(t){e.props.keyboard&&27===t.keyCode&&e.isTopModal()&&(e.props.onEscapeKeyDown&&e.props.onEscapeKeyDown(t),e.props.onHide())},this.handleDocumentKeyUp=function(t){e.props.keyboard&&27===t.keyCode&&e.isTopModal()&&e.props.onEscapeKeyUp&&e.props.onEscapeKeyUp(t)},this.checkForFocus=function(){o.default&&(e.lastFocus=(0,r.default)())},this.enforceFocus=function(){if(e.props.enforceFocus&&e._isMounted&&e.isTopModal()){var t=e.getDialogElement(),n=(0,r.default)((0,E.default)(e));t&&!(0,a.default)(t,n)&&t.focus()}}};T.Manager=m.default,t.default=T,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=i;var s,r=n(32),a=(s=r)&&s.__esModule?s:{default:s};var o={};function i(e,t){return function(n,s,r,i,l){var c=r||"<<anonymous>>",u=l||s;if(null!=n[s]){var h=r+"."+s;(0,a.default)(o[h],"The "+i+" `"+u+"` of `"+c+"` is deprecated. "+t+"."),o[h]=!0}for(var d=arguments.length,p=Array(d>5?d-5:0),f=5;f<d;f++)p[f-5]=arguments[f];return e.apply(void 0,[n,s,r,i,l].concat(p))}}i._resetWarned=function(){o={}},e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=o(n(1)),r=n(432),a=o(n(255));function o(e){return e&&e.__esModule?e:{default:e}}t.default=(0,a.default)((function(e,t,n,a,o){var i=e[t];return s.default.isValidElement(i)?new Error("Invalid "+a+" `"+o+"` of type ReactElement supplied to `"+n+"`,expected an element type (a string , component class, or function component)."):(0,r.isValidElementType)(i)?null:new Error("Invalid "+a+" `"+o+"` of value `"+i+"` supplied to `"+n+"`, expected an element type (a string , component class, or function component).")})),e.exports=t.default},function(e,t,n){"use strict";e.exports=n(433)},function(e,t,n){"use strict";
/** @license React v16.6.1
 * react-is.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */Object.defineProperty(t,"__esModule",{value:!0});var s="function"==typeof Symbol&&Symbol.for,r=s?Symbol.for("react.element"):60103,a=s?Symbol.for("react.portal"):60106,o=s?Symbol.for("react.fragment"):60107,i=s?Symbol.for("react.strict_mode"):60108,l=s?Symbol.for("react.profiler"):60114,c=s?Symbol.for("react.provider"):60109,u=s?Symbol.for("react.context"):60110,h=s?Symbol.for("react.async_mode"):60111,d=s?Symbol.for("react.concurrent_mode"):60111,p=s?Symbol.for("react.forward_ref"):60112,f=s?Symbol.for("react.suspense"):60113,m=s?Symbol.for("react.memo"):60115,g=s?Symbol.for("react.lazy"):60116;function y(e){if("object"==typeof e&&null!==e){var t=e.$$typeof;switch(t){case r:switch(e=e.type){case h:case d:case o:case l:case i:return e;default:switch(e=e&&e.$$typeof){case u:case p:case c:return e;default:return t}}case a:return t}}}function v(e){return y(e)===d}t.typeOf=y,t.AsyncMode=h,t.ConcurrentMode=d,t.ContextConsumer=u,t.ContextProvider=c,t.Element=r,t.ForwardRef=p,t.Fragment=o,t.Profiler=l,t.Portal=a,t.StrictMode=i,t.isValidElementType=function(e){return"string"==typeof e||"function"==typeof e||e===o||e===d||e===l||e===i||e===f||"object"==typeof e&&null!==e&&(e.$$typeof===g||e.$$typeof===m||e.$$typeof===c||e.$$typeof===u||e.$$typeof===p)},t.isAsyncMode=function(e){return v(e)||y(e)===h},t.isConcurrentMode=v,t.isContextConsumer=function(e){return y(e)===u},t.isContextProvider=function(e){return y(e)===c},t.isElement=function(e){return"object"==typeof e&&null!==e&&e.$$typeof===r},t.isForwardRef=function(e){return y(e)===p},t.isFragment=function(e){return y(e)===o},t.isProfiler=function(e){return y(e)===l},t.isPortal=function(e){return y(e)===a},t.isStrictMode=function(e){return y(e)===i}},function(e,t,n){"use strict";t.__esModule=!0;var s=l(n(256)),r=l(n(67)),a=l(n(105)),o=l(n(260)),i=n(443);function l(e){return e&&e.__esModule?e:{default:e}}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){return n=function(e){return-1!==e.modals.indexOf(t)},s=-1,e.some((function(e,t){if(n(e,t))return s=t,!0})),s;var n,s}function h(e,t){var n={overflow:"hidden"};e.style={overflow:t.style.overflow,paddingRight:t.style.paddingRight},e.overflowing&&(n.paddingRight=parseInt((0,r.default)(t,"paddingRight")||0,10)+(0,a.default)()+"px"),(0,r.default)(t,n)}function d(e,t){var n=e.style;Object.keys(n).forEach((function(e){return t.style[e]=n[e]}))}t.default=function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=n.hideSiblingNodes,a=void 0===r||r,l=n.handleContainerOverflow,p=void 0===l||l;c(this,e),this.add=function(e,n,r){var a=t.modals.indexOf(e),l=t.containers.indexOf(n);if(-1!==a)return a;if(a=t.modals.length,t.modals.push(e),t.hideSiblingNodes&&(0,i.hideSiblings)(n,e.mountNode),-1!==l)return t.data[l].modals.push(e),a;var c={modals:[e],classes:r?r.split(/\s+/):[],overflowing:(0,o.default)(n)};return t.handleContainerOverflow&&h(c,n),c.classes.forEach(s.default.addClass.bind(null,n)),t.containers.push(n),t.data.push(c),a},this.remove=function(e){var n=t.modals.indexOf(e);if(-1!==n){var r=u(t.data,e),a=t.data[r],o=t.containers[r];a.modals.splice(a.modals.indexOf(e),1),t.modals.splice(n,1),0===a.modals.length?(a.classes.forEach(s.default.removeClass.bind(null,o)),t.handleContainerOverflow&&d(a,o),t.hideSiblingNodes&&(0,i.showSiblings)(o,e.mountNode),t.containers.splice(r,1),t.data.splice(r,1)):t.hideSiblingNodes&&(0,i.ariaHidden)(!1,a.modals[a.modals.length-1].mountNode)}},this.isTopModal=function(e){return!!t.modals.length&&t.modals[t.modals.length-1]===e},this.hideSiblingNodes=a,this.handleContainerOverflow=p,this.modals=[],this.containers=[],this.data=[]},e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){e.classList?e.classList.add(t):(0,a.default)(e,t)||("string"==typeof e.className?e.className=e.className+" "+t:e.setAttribute("class",(e.className&&e.className.baseVal||"")+" "+t))};var s,r=n(257),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){"use strict";function s(e,t){return e.replace(new RegExp("(^|\\s)"+t+"(?:\\s|$)","g"),"$1").replace(/\s+/g," ").replace(/^\s*|\s*$/g,"")}e.exports=function(e,t){e.classList?e.classList.remove(t):"string"==typeof e.className?e.className=s(e.className,t):e.setAttribute("class",s(e.className&&e.className.baseVal||"",t))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return e.replace(s,(function(e,t){return t.toUpperCase()}))};var s=/-(.)/g;e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return(0,a.default)(e).replace(o,"-ms-")};var s,r=n(439),a=(s=r)&&s.__esModule?s:{default:s};var o=/^ms-/;e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return e.replace(s,"-$1").toLowerCase()};var s=/([A-Z])/g;e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){if(!e)throw new TypeError("No Element passed to `getComputedStyle()`");var t=e.ownerDocument;return"defaultView"in t?t.defaultView.opener?e.ownerDocument.defaultView.getComputedStyle(e,null):window.getComputedStyle(e,null):{getPropertyValue:function(t){var n=e.style;"float"==(t=(0,a.default)(t))&&(t="styleFloat");var s=e.currentStyle[t]||null;if(null==s&&n&&n[t]&&(s=n[t]),i.test(s)&&!o.test(t)){var r=n.left,l=e.runtimeStyle,c=l&&l.left;c&&(l.left=e.currentStyle.left),n.left="fontSize"===t?"1em":s,s=n.pixelLeft+"px",n.left=r,c&&(l.left=c)}return s}}};var s,r=n(258),a=(s=r)&&s.__esModule?s:{default:s};var o=/^(top|right|bottom|left)$/,i=/^([+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|))(?!px)[a-z%]+$/i;e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return"removeProperty"in e.style?e.style.removeProperty(t):e.style.removeAttribute(t)},e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return!(!e||!s.test(e))};var s=/^((translate|rotate|scale)(X|Y|Z|3d)?|matrix(3d)?|perspective|skew(X|Y)?)$/i;e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.ariaHidden=a,t.hideSiblings=function(e,t){r(e,t,(function(e){return a(!0,e)}))},t.showSiblings=function(e,t){r(e,t,(function(e){return a(!1,e)}))};var s=["template","script","style"],r=function(e,t,n){t=[].concat(t),[].forEach.call(e.children,(function(e){var r,a,o;-1===t.indexOf(e)&&(a=(r=e).nodeType,o=r.tagName,1===a&&-1===s.indexOf(o.toLowerCase()))&&n(e)}))};function a(e,t){t&&(e?t.setAttribute("aria-hidden","true"):t.removeAttribute("aria-hidden"))}},function(e,t,n){"use strict";t.__esModule=!0;var s=u(n(0)),r=u(n(131)),a=u(n(1)),o=u(n(17)),i=u(n(174)),l=u(n(175)),c=u(n(445));function u(e){return e&&e.__esModule?e:{default:e}}function h(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function d(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var p=function(e){function t(){var n,s;h(this,t);for(var r=arguments.length,a=Array(r),o=0;o<r;o++)a[o]=arguments[o];return n=s=d(this,e.call.apply(e,[this].concat(a))),s.setContainer=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:s.props;s._portalContainerNode=(0,i.default)(e.container,(0,l.default)(s).body)},s.getMountNode=function(){return s._portalContainerNode},d(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this.setContainer(),this.forceUpdate(this.props.onRendered)},t.prototype.componentWillReceiveProps=function(e){e.container!==this.props.container&&this.setContainer(e)},t.prototype.componentWillUnmount=function(){this._portalContainerNode=null},t.prototype.render=function(){return this.props.children&&this._portalContainerNode?o.default.createPortal(this.props.children,this._portalContainerNode):null},t}(a.default.Component);p.displayName="Portal",p.propTypes={container:s.default.oneOfType([r.default,s.default.func]),onRendered:s.default.func},t.default=o.default.createPortal?p:c.default,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=c(n(0)),r=c(n(131)),a=c(n(1)),o=c(n(17)),i=c(n(174)),l=c(n(175));function c(e){return e&&e.__esModule?e:{default:e}}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var d=function(e){function t(){var n,s;u(this,t);for(var r=arguments.length,c=Array(r),d=0;d<r;d++)c[d]=arguments[d];return n=s=h(this,e.call.apply(e,[this].concat(c))),s._mountOverlayTarget=function(){s._overlayTarget||(s._overlayTarget=document.createElement("div"),s._portalContainerNode=(0,i.default)(s.props.container,(0,l.default)(s).body),s._portalContainerNode.appendChild(s._overlayTarget))},s._unmountOverlayTarget=function(){s._overlayTarget&&(s._portalContainerNode.removeChild(s._overlayTarget),s._overlayTarget=null),s._portalContainerNode=null},s._renderOverlay=function(){var e=s.props.children?a.default.Children.only(s.props.children):null;if(null!==e){s._mountOverlayTarget();var t=!s._overlayInstance;s._overlayInstance=o.default.unstable_renderSubtreeIntoContainer(s,e,s._overlayTarget,(function(){t&&s.props.onRendered&&s.props.onRendered()}))}else s._unrenderOverlay(),s._unmountOverlayTarget()},s._unrenderOverlay=function(){s._overlayTarget&&(o.default.unmountComponentAtNode(s._overlayTarget),s._overlayInstance=null)},s.getMountNode=function(){return s._overlayTarget},h(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this._isMounted=!0,this._renderOverlay()},t.prototype.componentDidUpdate=function(){this._renderOverlay()},t.prototype.componentWillReceiveProps=function(e){this._overlayTarget&&e.container!==this.props.container&&(this._portalContainerNode.removeChild(this._overlayTarget),this._portalContainerNode=(0,i.default)(e.container,(0,l.default)(this).body),this._portalContainerNode.appendChild(this._overlayTarget))},t.prototype.componentWillUnmount=function(){this._isMounted=!1,this._unrenderOverlay(),this._unmountOverlayTarget()},t.prototype.render=function(){return null},t}(a.default.Component);d.displayName="Portal",d.propTypes={container:s.default.oneOfType([r.default,s.default.func]),onRendered:s.default.func},t.default=d,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=a(n(0)),r=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var l={children:s.default.node},c=function(e){function t(){return o(this,t),i(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.render=function(){return this.props.children},t}(r.default.Component);c.propTypes=l,t.default=c,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t,n,a){return(0,s.default)(e,t,n,a),{remove:function(){(0,r.default)(e,t,n,a)}}};var s=a(n(110)),r=a(n(132));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e){var t=!document.addEventListener,n=void 0;t?(document.attachEvent("onfocusin",e),n=function(){return document.detachEvent("onfocusin",e)}):(document.addEventListener("focus",e,!0),n=function(){return document.removeEventListener("focus",e,!0)});return{remove:n}},e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s,r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},a=c(n(1)),o=n(450),i=c(o),l=c(n(90));function c(e){return e&&e.__esModule?e:{default:e}}var u=((s={})[o.ENTERING]="in",s[o.ENTERED]="in",s),h=function(e){function t(n,s){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.call(this,n,s))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.render=function(){var e=this.props,t=e.className,n=e.children,s=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(e,["className","children"]);return a.default.createElement(i.default,s,(function(e,s){return a.default.cloneElement(n,r({},s,{className:(0,l.default)("fade",t,n.props.className,u[e])}))}))},t}(a.default.Component);t.default=h,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=t.EXITING=t.ENTERED=t.ENTERING=t.EXITED=t.UNMOUNTED=void 0;var s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var s=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,n):{};s.get||s.set?Object.defineProperty(t,n,s):t[n]=e[n]}return t.default=e,t}(n(0)),r=i(n(1)),a=i(n(17)),o=n(261);n(451);function i(e){return e&&e.__esModule?e:{default:e}}t.UNMOUNTED="unmounted";t.EXITED="exited";t.ENTERING="entering";t.ENTERED="entered";t.EXITING="exiting";var l=function(e){var t,n;function s(t,n){var s;s=e.call(this,t,n)||this;var r,a=n.transitionGroup,o=a&&!a.isMounting?t.enter:t.appear;return s.appearStatus=null,t.in?o?(r="exited",s.appearStatus="entering"):r="entered":r=t.unmountOnExit||t.mountOnEnter?"unmounted":"exited",s.state={status:r},s.nextCallback=null,s}n=e,(t=s).prototype=Object.create(n.prototype),t.prototype.constructor=t,t.__proto__=n;var o=s.prototype;return o.getChildContext=function(){return{transitionGroup:null}},s.getDerivedStateFromProps=function(e,t){return e.in&&"unmounted"===t.status?{status:"exited"}:null},o.componentDidMount=function(){this.updateStatus(!0,this.appearStatus)},o.componentDidUpdate=function(e){var t=null;if(e!==this.props){var n=this.state.status;this.props.in?"entering"!==n&&"entered"!==n&&(t="entering"):"entering"!==n&&"entered"!==n||(t="exiting")}this.updateStatus(!1,t)},o.componentWillUnmount=function(){this.cancelNextCallback()},o.getTimeouts=function(){var e,t,n,s=this.props.timeout;return e=t=n=s,null!=s&&"number"!=typeof s&&(e=s.exit,t=s.enter,n=s.appear),{exit:e,enter:t,appear:n}},o.updateStatus=function(e,t){if(void 0===e&&(e=!1),null!==t){this.cancelNextCallback();var n=a.default.findDOMNode(this);"entering"===t?this.performEnter(n,e):this.performExit(n)}else this.props.unmountOnExit&&"exited"===this.state.status&&this.setState({status:"unmounted"})},o.performEnter=function(e,t){var n=this,s=this.props.enter,r=this.context.transitionGroup?this.context.transitionGroup.isMounting:t,a=this.getTimeouts();t||s?(this.props.onEnter(e,r),this.safeSetState({status:"entering"},(function(){n.props.onEntering(e,r),n.onTransitionEnd(e,a.enter,(function(){n.safeSetState({status:"entered"},(function(){n.props.onEntered(e,r)}))}))}))):this.safeSetState({status:"entered"},(function(){n.props.onEntered(e)}))},o.performExit=function(e){var t=this,n=this.props.exit,s=this.getTimeouts();n?(this.props.onExit(e),this.safeSetState({status:"exiting"},(function(){t.props.onExiting(e),t.onTransitionEnd(e,s.exit,(function(){t.safeSetState({status:"exited"},(function(){t.props.onExited(e)}))}))}))):this.safeSetState({status:"exited"},(function(){t.props.onExited(e)}))},o.cancelNextCallback=function(){null!==this.nextCallback&&(this.nextCallback.cancel(),this.nextCallback=null)},o.safeSetState=function(e,t){t=this.setNextCallback(t),this.setState(e,t)},o.setNextCallback=function(e){var t=this,n=!0;return this.nextCallback=function(s){n&&(n=!1,t.nextCallback=null,e(s))},this.nextCallback.cancel=function(){n=!1},this.nextCallback},o.onTransitionEnd=function(e,t,n){this.setNextCallback(n),e?(this.props.addEndListener&&this.props.addEndListener(e,this.nextCallback),null!=t&&setTimeout(this.nextCallback,t)):setTimeout(this.nextCallback,0)},o.render=function(){var e=this.state.status;if("unmounted"===e)return null;var t=this.props,n=t.children,s=function(e,t){if(null==e)return{};var n,s,r={},a=Object.keys(e);for(s=0;s<a.length;s++)n=a[s],t.indexOf(n)>=0||(r[n]=e[n]);return r}(t,["children"]);if(delete s.in,delete s.mountOnEnter,delete s.unmountOnExit,delete s.appear,delete s.enter,delete s.exit,delete s.timeout,delete s.addEndListener,delete s.onEnter,delete s.onEntering,delete s.onEntered,delete s.onExit,delete s.onExiting,delete s.onExited,"function"==typeof n)return n(e,s);var a=r.default.Children.only(n);return r.default.cloneElement(a,s)},s}(r.default.Component);function c(){}l.contextTypes={transitionGroup:s.object},l.childContextTypes={transitionGroup:function(){}},l.propTypes={},l.defaultProps={in:!1,mountOnEnter:!1,unmountOnExit:!1,appear:!1,enter:!0,exit:!0,onEnter:c,onEntering:c,onEntered:c,onExit:c,onExiting:c,onExited:c},l.UNMOUNTED=0,l.EXITED=1,l.ENTERING=2,l.ENTERED=3,l.EXITING=4;var u=(0,o.polyfill)(l);t.default=u},function(e,t,n){"use strict";t.__esModule=!0,t.transitionTimeout=function(e){var t="transition"+e+"Timeout",n="transition"+e;return function(e){if(e[n]){if(null==e[t])return new Error(t+" wasn't supplied to CSSTransitionGroup: this can cause unreliable animations and won't be supported in a future version of React. See https://fb.me/react-animation-transition-group-timeout for more information.");if("number"!=typeof e[t])return new Error(t+" must be a number (in milliseconds)")}return null}},t.classNamesShape=t.timeoutsShape=void 0;var s,r=(s=n(0))&&s.__esModule?s:{default:s};var a=r.default.oneOfType([r.default.number,r.default.shape({enter:r.default.number,exit:r.default.number}).isRequired]);t.timeoutsShape=a;var o=r.default.oneOfType([r.default.string,r.default.shape({enter:r.default.string,exit:r.default.string,active:r.default.string}),r.default.shape({enter:r.default.string,enterDone:r.default.string,enterActive:r.default.string,exit:r.default.string,exitDone:r.default.string,exitActive:r.default.string})]);t.classNamesShape=o},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=i(n(1)),a=i(n(0)),o=i(n(90));function i(e){return e&&e.__esModule?e:{default:e}}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var u=function(e){function t(){return l(this,t),c(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.getDefaultPrefix=function(){return"modal"},t.prototype.render=function(){var e=this.props,n=e.modalPrefix,a=e.children,i=e.className,l=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(e,["modalPrefix","children","className"]),c=n||t.getDefaultPrefix();return r.default.createElement("div",s({},l,{className:(0,o.default)(i,c+"-body")}),a)},t}(r.default.Component);u.propTypes={modalPrefix:a.default.string},t.default=u,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=l(n(1)),a=l(n(0)),o=l(n(90)),i=l(n(262));function l(e){return e&&e.__esModule?e:{default:e}}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var h=function(e){function t(){return c(this,t),u(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.getDefaultPrefix=function(){return"modal"},t.prototype.render=function(){var e=this.props,n=e.modalPrefix,a=e.closeButton,l=e.children,c=e.className,u=e["aria-label"],h=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(e,["modalPrefix","closeButton","children","className","aria-label"]),d=n||t.getDefaultPrefix();return r.default.createElement("div",s({},h,{className:(0,o.default)(c,d+"-header")}),a&&r.default.createElement(i.default,{className:"close","aria-label":u},r.default.createElement("span",{"aria-hidden":"true"},"ร")),l)},t}(r.default.Component);h._isModalHeader=!0,h.propTypes={closeButton:a.default.bool,modalPrefix:a.default.string,"aria-label":a.default.string},h.defaultProps={closeButton:!1,"aria-label":"Close Modal"},h.contextTypes={onModalHide:a.default.func},t.default=h,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=i(n(1)),a=i(n(0)),o=i(n(90));function i(e){return e&&e.__esModule?e:{default:e}}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var u=function(e){function t(){return l(this,t),c(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.getDefaultPrefix=function(){return"modal"},t.prototype.render=function(){var e=this.props,n=e.modalPrefix,a=e.className,i=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(e,["modalPrefix","className"]),l=n||t.getDefaultPrefix();return r.default.createElement("h4",s({},i,{className:(0,o.default)(a,l+"-title")}))},t}(r.default.Component);u.propTypes={modalPrefix:a.default.string},t.default=u,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=i(n(1)),a=i(n(0)),o=i(n(90));function i(e){return e&&e.__esModule?e:{default:e}}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var u=function(e){function t(){return l(this,t),c(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.getDefaultPrefix=function(){return"modal"},t.prototype.render=function(){var e=this.props,n=e.modalPrefix,a=e.children,i=e.className,l=function(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}(e,["modalPrefix","children","className"]),c=n||t.getDefaultPrefix();return r.default.createElement("div",s({},l,{className:(0,o.default)(i,c+"-footer")}),a)},t}(r.default.Component);u.propTypes={modalPrefix:a.default.string},t.default=u,e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Lore=void 0;const r=s(n(4)),a=n(34).Component.DataComponent;t.Lore=a("Lore",{entries:null,tag:""}),t.Lore.prototype._init=function(){this.entries=[]},t.Lore.prototype.addEntry=function(e){if(e.msg){let t="entry.msg not supported. Use entry.respMsg from now on";t+=" Got: "+JSON.stringify(e.msg),r.default.err("Component.Lore","addEntry",t)}e.topic||(console.log("Entry was ",e),r.default.err("Component.Lore","addEntry","Given entry has no topic: "+JSON.stringify(e))),this.entries.push(e)},t.Lore.prototype.hasEntry=function(e){let t=!1;return this.getKey({topic:e.topic}).forEach(n=>{t=t||this.compareEntry(e,n)}),t},t.Lore.prototype.compareEntry=function(e,t){if(e.topic!==t.topic)return!1;if((e.askMsg||t.askMsg)&&e.askMsg!==t.askMsg)return!1;if((e.respMsg||t.respMsg)&&e.respMsg!==t.respMsg)return!1;if(e.names&&t.names){if(e.names.length!==t.names.length)return!1}else if(e.names||t.names)return!1;return!0},t.Lore.prototype.getKey=function(e){const t=[];return this.entries.forEach(n=>{let s=!1;Object.keys(e).forEach(r=>{n[r]===e[r]&&(s||t.push(n),s=!0)})}),t},t.Lore.prototype.getRespMsg=function(e){let t=[];return this.entries.forEach(n=>{if(n.topic===e){const e=n.respMsg;e&&(Array.isArray(e)?t=t.concat(e):t.push(e))}}),t},t.Lore.prototype.addTopic=function(e,t){const n={topic:e,respMsg:t};this.entries.push(n)},t.Lore.prototype.hasTopic=function(e){return this.getLoreTopics().indexOf(e)>=0},t.Lore.prototype.getLoreTopics=function(){const e=[];return this.entries.forEach(t=>{e.indexOf(t.topic)<0&&e.push(t.topic)}),e}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.AStar3D=void 0;const r=s(n(177));class a extends r.default{constructor(e,t,n,s,r={}){super(e,t,s,r),this._todo=[],this._done={},this._map=n,this._itemsDone=0,this._doneLimit=-1}setLimit(e){this._doneLimit=e}compute(e,t,n){for(this._todo=[],this._done={},this._fromX=e,this._fromY=t,this._fromZ=this._map.getZ(e,t),this._add(this._toX,this._toY,null);this._todo.length;){const n=this._todo.shift(),s=n.x+","+n.y;if(s in this._done)continue;if(this._done[s]=n,this._itemsDone+=1,this._itemsDone===this._doneLimit)break;if(n.x===e&&n.y===t)break;const r=this._getNeighbors(n.x,n.y);for(let e=0;e<r.length;e++){const t=r[e],s=t[0],a=t[1];s+","+a in this._done||this._add(s,a,n)}}let s=this._done[e+","+t];if(s)for(;s;)n(s.x,s.y,s.prev),s=s.prev}_add(e,t,n){const s=this._map.getZ(e,t),r=this._distance(e,t,s,n);let a=0;n&&(a=Math.abs(n.z-s));const o={x:e,y:t,z:s,prev:n,g:n?n.g+1+a:0,h:r},i=o.g+o.h;for(let e=0;e<this._todo.length;e++){const t=this._todo[e],n=t.g+t.h;if(i<n||i===n&&r<t.h)return void this._todo.splice(e,0,o)}this._todo.push(o)}_distance(e,t,n,s){switch(this._options.topology){case 4:return Math.abs(e-this._fromX)+Math.abs(t-this._fromY);case 6:const s=Math.abs(e-this._fromX),r=Math.abs(t-this._fromY);return r+Math.max(0,(s-r)/2);case 8:{const s=Math.abs(e-this._fromX),r=Math.abs(t-this._fromY),a=Math.abs(n-this._fromZ);return Math.max(s+a,r+a)}}}}t.AStar3D=a},function(e,t,n){e.exports=function(e){function t(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t|=0;return s.colors[Math.abs(t)%s.colors.length]}function s(e){let n;function o(...e){if(!o.enabled)return;const t=o,r=Number(new Date),a=r-(n||r);t.diff=a,t.prev=n,t.curr=r,n=r,e[0]=s.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let i=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(n,r)=>{if("%%"===n)return n;i++;const a=s.formatters[r];if("function"==typeof a){const s=e[i];n=a.call(t,s),e.splice(i,1),i--}return n}),s.formatArgs.call(t,e);(t.log||s.log).apply(t,e)}return o.namespace=e,o.enabled=s.enabled(e),o.useColors=s.useColors(),o.color=t(e),o.destroy=r,o.extend=a,"function"==typeof s.init&&s.init(o),s.instances.push(o),o}function r(){const e=s.instances.indexOf(this);return-1!==e&&(s.instances.splice(e,1),!0)}function a(e,t){const n=s(this.namespace+(void 0===t?":":t)+e);return n.log=this.log,n}function o(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return s.debug=s,s.default=s,s.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},s.disable=function(){const e=[...s.names.map(o),...s.skips.map(o).map(e=>"-"+e)].join(",");return s.enable(""),e},s.enable=function(e){let t;s.save(e),s.names=[],s.skips=[];const n=("string"==typeof e?e:"").split(/[\s,]+/),r=n.length;for(t=0;t<r;t++)n[t]&&("-"===(e=n[t].replace(/\*/g,".*?"))[0]?s.skips.push(new RegExp("^"+e.substr(1)+"$")):s.names.push(new RegExp("^"+e+"$")));for(t=0;t<s.instances.length;t++){const e=s.instances[t];e.enabled=s.enabled(e.namespace)}},s.enabled=function(e){if("*"===e[e.length-1])return!0;let t,n;for(t=0,n=s.skips.length;t<n;t++)if(s.skips[t].test(e))return!1;for(t=0,n=s.names.length;t<n;t++)if(s.names[t].test(e))return!0;return!1},s.humanize=n(459),Object.keys(e).forEach(t=>{s[t]=e[t]}),s.instances=[],s.names=[],s.skips=[],s.formatters={},s.selectColor=t,s.enable(s.load()),s}},function(e,t){var n=1e3,s=6e4,r=60*s,a=24*r;function o(e,t,n,s){var r=t>=1.5*n;return Math.round(e/n)+" "+s+(r?"s":"")}e.exports=function(e,t){t=t||{};var i=typeof e;if("string"===i&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return;var o=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*o;case"weeks":case"week":case"w":return 6048e5*o;case"days":case"day":case"d":return o*a;case"hours":case"hour":case"hrs":case"hr":case"h":return o*r;case"minutes":case"minute":case"mins":case"min":case"m":return o*s;case"seconds":case"second":case"secs":case"sec":case"s":return o*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return o;default:return}}(e);if("number"===i&&isFinite(e))return t.long?function(e){var t=Math.abs(e);if(t>=a)return o(e,t,a,"day");if(t>=r)return o(e,t,r,"hour");if(t>=s)return o(e,t,s,"minute");if(t>=n)return o(e,t,n,"second");return e+" ms"}(e):function(e){var t=Math.abs(e);if(t>=a)return Math.round(e/a)+"d";if(t>=r)return Math.round(e/r)+"h";if(t>=s)return Math.round(e/s)+"m";if(t>=n)return Math.round(e/n)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GoalThief=t.GoalSearchHouse=void 0;const i=o(n(4)),l=n(72),c=n(9),u=n(27),h=a(n(11)),{GOAL_ACTIVE:d,GOAL_COMPLETED:p}=l.GoalStatus,f=c.Random.getRNG();class m extends l.GoalBase{constructor(e){super(e),this.setType("GoalSearchHouse");const t=e.getCell();t.hasDoor()&&(this.door=t.getXY()),this.subGoals=[],this.searchTime=f.getUniformInt(20,40)}activate(){this.status=d;const e=this.actor.getBrain().getSeenCells();this.floorCells&&0!==this.floorCells.length||(this.floorCells=e.filter(e=>"floorhouse"===e.getBaseElem().getType()));let t=y(this.actor,e);if(!t&&this.floorCells.length>0){const e=f.arrayGetRand(this.floorCells);t=new l.Goal.FollowPath(this.actor,e.getXY())}if(this.searchTime<=0){const e=this.actor.getCell();if(e.hasDoor()){const e=u.Brain.getCellsAroundActor(this.actor);let t=null;e.forEach(e=>{"floorhouse"!==e.getBaseElem().getType()&&e.isPassable()&&(t=e)}),t?(l.Goal.moveActorTo(this.actor,t),this.status=p):i.default.warn("Goal.SearcHouse","activate","Could not move out of the house")}else t=l.Goal.FollowPath(this.actor,e.getXY())}t&&this.addSubGoal(t)}process(){return this.activateIfInactive(),--this.searchTime,this.hasSubGoals()?this.status=this.processSubGoals():(this.activate(),this.status!==p&&(this.status=this.processSubGoals())),this.status}}t.GoalSearchHouse=m;class g extends l.GoalBase{constructor(e){super(e),this.setType("GoalThief"),this.subGoals=[],this.shopCooldown=20,this.doorCooldown=25,this.visitedDoors={},this.shops={}}activate(){this.status=d,this.chooseThiefTask()}process(){return this.activateIfInactive(),--this.shopCooldown,--this.doorCooldown,this.isCompleted()?p:(this.hasSubGoals()?this.status=this.processSubGoals():(this.chooseThiefTask(),this.hasSubGoals()?this.status=this.processSubGoals():this.status=p),this.status)}isInActiveShop(){const e=this.actor.getCell();if(e&&e.hasShop()){const t=e.getShop();if(t&&!t.isAbandoned())return this.shops[e.getKeyXY()]=e,!0}return!1}tryToSellItem(){const e=this.actor.getInvEq().getInventory(),t=f.arrayGetRand(e.getItems()),n=this.actor.getCell();if(n&&t){const e=n.getPropType("shop")[0],s=new h.Transaction;s.setArgs({item:t,seller:this.actor,shop:e,buyer:e.getShopkeeper(),count:t.getCount()}),this.actor.add(s)}else i.default.err("Goal.Thief","tryToSellItem","Null item for sale. Inv: "+JSON.stringify(e))}tryToGoToShopCell(){let e=null;const t=Object.values(this.shops);if(t.length>0){const e=f.arrayGetRand(t);return new l.Goal.FollowPath(this.actor,e.getXY())}const n=this.actor.getBrain().getSeenCells();for(let t=0;t<n.length;t++){const s=n[t];s.hasShop()&&(e=new l.Goal.FollowPath(this.actor,s.getXY()))}return e||(this.shopCooldown=20),e}chooseThiefTask(){const e=!this.actor.getInvEq().getInventory().isEmpty();let t=null;const n=this.actor.getCell();if(n){if(e&&this.isInActiveShop())this.tryToSellItem(),this.status=p;else if(e&&this.shopCooldown<=0)t=this.tryToGoToShopCell();else{const e=this.actor.getBrain().getSeenCells(),s={};t=y(this.actor,e,s,e=>e.hasElements()),!t&&!n.hasDoor()&&this.doorCooldown<=0?Object.values(s).forEach(e=>{if(e.hasDoor()){const n=e.getXY(),s=e.getKeyXY();if(!this.visitedDoors.hasOwnProperty(s))return this.doorCooldown=25,void(t=new l.Goal.FollowPath(this.actor,n))}}):n.hasDoor()&&(this.visitedDoors[n.getKeyXY()]=n.getXY(),this.thiefSeesHouse()&&(t=new m(this.actor))),t||(t=new l.Goal.Explore(this.actor,30),t.setCallback(this.exploreCallback.bind(this)))}t&&this.addSubGoal(t)}}exploreCallback(e,t){const n=this.actor.getLevel().getMap();if(n.hasXY(e,t)){const s=n.getCell(e,t);s.hasShop()&&(this.shops[s.getKeyXY()]=s)}}thiefSeesHouse(){return this.actor.getBrain().getSeenCells().filter(e=>"floorhouse"===e.getBaseElem().getType()).length>0}}function y(e,t,n,s){let r=null;for(let a=0;a<t.length;a++){const o=t[a];if(o.hasItems()){const t=o.getItems()[0];if(!t.has("Unpaid")){r=new l.Goal.GetItem(e,t);break}}n&&s(t[a])&&(n[o.getKeyXY()]=o)}return r}t.GoalThief=g,l.Goal.Thief=g},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GoalTreasureHunter=void 0;const s=n(72),r=n(9),{GOAL_ACTIVE:a,GOAL_COMPLETED:o}=s.GoalStatus;r.Random.getRNG();class i extends s.GoalBase{constructor(e){super(e),this.setType("GoalTreasureHunter"),this.subGoals=[],this.treasure=null,this.constraint={op:">=",func:"getValue",value:0}}setConstraint(e){this.constraint=e}setTreasure(e){this.treasure=e}activate(){this.status=a,this.chooseHunterTask()}process(){return this.activateIfInactive(),this.isCompleted()?o:(this.hasSubGoals()?this.status=this.processSubGoals():(this.chooseHunterTask(),this.hasSubGoals()&&(this.status=this.processSubGoals())),this.status)}chooseHunterTask(){let e=null,t=null;this.hasTreasure()?t=this.checkForZoneExit():e=this.treasure?new s.Goal.GetItem(this.actor,this.treasure):new s.Goal.FindItem(this.actor,this.constraint,this.setTreasure.bind(this)),e&&(t||(t=this.checkForZoneExit()),t&&this.addSubGoal(t),this.addSubGoal(e))}hasTreasure(){if(!this.treasure)return!1;const e=this.treasure.getName();return!!this.actor.getInvEq().hasItemNamed(e)}checkForZoneExit(){if(this.knowsZoneExit()){const e=this.getExitCell();if(e)return new s.Goal.ChangeLevel(this.actor,e.getXY())}return null}knowsZoneExit(){return!0}getExitCell(){const e=this.actor.getLevel(),t=e.getElements().find(e=>"connection"===e.getType());return t?e.getMap().getCell(t.getX(),t.getY()):null}}t.GoalTreasureHunter=i,s.Goal.TreasureHunter=i},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CmdSell=t.CmdBuy=t.CmdCraft=t.CmdUnequipItem=t.CmdEquipItem=t.CmdDisplace=t.CmdDropItem=t.CmdUseElement=t.CmdUseItem=t.CmdMissile=t.CmdAttack=t.CmdBase=t.ACTION_ZERO_ENERGY=t.ACTION_ALREADY_DONE=t.Cmd=void 0;const i=o(n(4)),l=n(19),c=a(n(29));t.Cmd={},t.ACTION_ALREADY_DONE=()=>{},t.ACTION_ZERO_ENERGY=null,t.Cmd.ACTION_ALREADY_DONE=t.ACTION_ALREADY_DONE,t.Cmd.ACTION_ZERO_ENERGY=t.ACTION_ZERO_ENERGY;class u{constructor(e){this._actor=e.getActor(),this.brain=e}}t.CmdBase=u;class h extends u{execute(e){let n=e.target;if(n.hasActors&&e.target.hasActors()&&(n=e.target.getSentientActors()[0]),n){const[e,s]=this._actor.getXY(),[r,a]=n.getXY();if(l.Path.shortestDist(e,s,r,a)<=i.default.getMeleeAttackRange(this._actor)){const e=new c.Attack({target:n});return this._actor.add(e),t.ACTION_ALREADY_DONE}return this.brain.cmdNotPossible("Target not within attack range")}return this.brain.cmdNotPossible("No valid targets for attack")}}t.CmdAttack=h,t.Cmd.Attack=h;class d extends u{execute(e){const n=new c.AttackRanged;return n.setAttacker(this._actor),n.setTarget(e.target),this._actor.add(n),t.ACTION_ALREADY_DONE}}t.CmdMissile=d,t.Cmd.Missile=d;class p extends u{execute(e){if(e.hasOwnProperty("item")){const t=e.item;let n=!1,s=`You failed to use ${t.getName()}.`;if("function"==typeof t.useItem&&(this.brain.energy=i.default.energy.USE,t.useItem({target:e.target}),n=!0),e.hasOwnProperty("callback"))n&&(s=`You used ${t.getName()}!`),e.callback({msg:s,result:n});else if(n)i.default.gameMsg(`You used ${t.getName()}!`);else{const n=new c.UseItem;n.setItem(t),n.setTarget(e.target),this._actor.add(n)}}else i.default.err("Brain.Player","handleCommand","obj has no item");return t.ACTION_ALREADY_DONE}}t.CmdUseItem=p,t.Cmd.UseItem=p;class f extends u{execute(e){const n=e.target.getElements(),s=new c.UseElement;return n.forEach(e=>{e.onUse&&s.setElement(e)}),this._actor.add(s),t.ACTION_ALREADY_DONE}}t.CmdUseElement=f,t.Cmd.UseElement=f;class m extends u{execute(e){const n=this._actor.getInvEq(),s=this._actor.getCell();let r=!1,a="Failed to drop "+e.item.getName();const o=e.count<=e.item.getCount()?e.count:e.item.getCount();let l=!1;if(s){if(s.hasShop()){l=!s.getShop().isAbandoned()}if(l){const t=s.getShop(),n=()=>{const n=new c.Transaction;n.setArgs({item:e.item,seller:this._actor,shop:t,callback:e.callback,buyer:t.getShopkeeper(),count:o}),this._actor.add(n)};a=`Press y to sell item for ${t.getItemPriceForSelling(e.item,o)} gold coins.`,this.brain.setWantConfirm(this.brain.energy,n,a),e.hasOwnProperty("callback")&&e.callback({msg:a,result:r})}else n.dropNItems(e.item,o)&&(r=!0,a="Item dropped!");return e.hasOwnProperty("callback")&&e.callback({msg:a,result:r}),t.ACTION_ALREADY_DONE}i.default.err("CmdDropItem","execute","Null actorCell. Cannot execute cmd")}}t.CmdDropItem=m,t.Cmd.DropItem=m;t.CmdDisplace=class extends u{execute(e){const n=new c.Displace,s=e.target.getFirstActor();return n.setDisplaceTarget(s),this._actor.add(n),t.ACTION_ALREADY_DONE}},t.Cmd.Missile=d;class g extends u{execute(e){const n=new c.Equip;return n.setArgs(e),n.setIsRemove(!1),this._actor.add(n),t.ACTION_ALREADY_DONE}}t.CmdEquipItem=g,t.Cmd.EquipItem=g;class y extends u{execute(e){const n=new c.Equip;return n.setArgs(e),n.setIsRemove(!0),this._actor.add(n),t.ACTION_ALREADY_DONE}}t.CmdUnequipItem=y,t.Cmd.UnequipItem=y;class v extends u{execute(e){const n=new c.Crafting;return n.setItem(e.item.getName()),n.setCount(e.item.getCount()),n.setArgs(e),this._actor.add(n),t.ACTION_ALREADY_DONE}}t.CmdCraft=v,t.Cmd.Craft=v;class b extends u{execute(e){const{items:n}=e;return n.forEach(t=>{const[n,s]=t.getXY(),r=this._actor.getLevel().getMap().getCell(n,s).getShop(),a=new c.Transaction;a.setArgs({item:t,buyer:this._actor,shop:r,seller:r.getShopkeeper(),callback:e.callback}),console.log("Created buy transaction for ",t.getName()),this._actor.add(a)}),t.ACTION_ALREADY_DONE}}t.CmdBuy=b,t.Cmd.Buy=b;class _ extends u{execute(e){const{items:n}=e,s=this._actor.getCell().getShop();return s||i.default.err("CmdSell","execute","Tried to sell in non-shop element cell"),n.forEach(t=>{const n=new c.Transaction;n.setArgs({item:t,buyer:s.getShopkeeper(),shop:s,seller:this._actor,callback:e.callback}),this._actor.add(n)}),t.ACTION_ALREADY_DONE}}t.CmdSell=_,t.Cmd.Sell=_},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(184));class a extends r.default{add(e,t){return this._queue.add(e,0),super.add(e,t)}next(){return null!==this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),super.next()}}t.default=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventQueue=void 0;t.EventQueue=class{constructor(){this._time=0,this._events=[],this._eventTimes=[],this.traceIDs={},this.debugEnabled=!1}setTraceID(e){this.traceIDs[e]=!0,this.debugEnabled=!0}getTime(){return this._time}clear(){return this._events=[],this._eventTimes=[],this}add(e,t){let n=this._events.length;for(let e=0;e<this._eventTimes.length;e++)if(this._eventTimes[e]>t){n=e;break}s(this._events,n,e),s(this._eventTimes,n,t);const r=e;r.getID&&this.traceIDs[r.getID()]&&this._events.findIndex(e=>e.getID&&this.traceIDs[e.getID()])>0&&console.log("EQ.add found actor ID "+r.getID())}get(){if(!this._events.length)return null;const e=this._eventTimes.shift();if(e>0){this._time+=e;for(let t=0;t<this._eventTimes.length;t++)this._eventTimes[t]-=e}const t=this._events.shift();return t.getID&&this.traceIDs[t.getID()]&&console.debug("EQ.get(): Shifted out ID "+t.getID()),t}remove(e){const t=e;t.getID&&this.traceIDs[t.getID()]&&(console.log("EQ.remove(): Trying to remove actor with ID "+t.getID()),this._events.findIndex(e=>e.getID&&this.traceIDs[e.getID()])>0&&console.log(`EQ.remove(): Found actor ID ${t.getID()} for removal`));const n=this._events.indexOf(e);return-1!==n&&(this._remove(n),!0)}_remove(e){r(this._events,e),r(this._eventTimes,e)}};const s=function(e,t,n){let s=e.length;for(;s-- >=t;)e[s+1]=e[s];return e[t]=n,e},r=function(e,t){const n=e.length;if(n){for(;t<n;)e[t]=e[t+1],t++;e.length--}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(184));class a extends r.default{add(e,t,n){return this._queue.add(e,void 0!==n?n:1/e.getSpeed()),super.add(e,t)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed()),super.next()}}t.default=a},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(184));class a extends r.default{constructor(){super(),this._defaultDuration=1,this._duration=this._defaultDuration}add(e,t,n){return this._queue.add(e,n||this._defaultDuration),super.add(e,t)}clear(){return this._duration=this._defaultDuration,super.clear()}remove(e){return e===this._current&&(this._duration=this._defaultDuration),super.remove(e)}next(){return null!==this._current&&-1!==this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),super.next()}setDuration(e){return this._current&&(this._duration=e),this}}t.default=a},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Objects=void 0;const r=s(n(468)),a=n(112),o=s(n(269));t.Objects={actors:a.ActorsData,items:r.default,elements:o.default}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.dmgTypes=void 0;const r=s(n(4)),a=n(268),o=n(73),i=n(469);function l(e,t){let n=0;if("string"==typeof e)switch(e){case"leather":case"chain":case"steel":n=1*t;break;case"permaice":case"ruby":case"magic":n=1.5*t;break;case"void":n=1.75*t;break;case"gem":n=1*t;break;default:n=t}else Number.isInteger(e)&&(n=e);return Math.floor(1*n)}const c=[{name:"Gold coin",className:"cell-item-gold-coin",char:"$",material:"gold",type:"goldcoin",value:1,weight:r.default.GOLD_COIN_WEIGHT},{name:"MeleeWeaponBase",className:"cell-item-melee-weapon",char:"(",material:r.default.MATERIAL.IRON,type:"weapon",range:1,attack:0,defense:0,dontCreate:!0},{name:"Dagger",base:"MeleeWeaponBase",material:r.default.MATERIAL.IRON,damage:"1d4",weaponType:"dagger",weight:.2,value:l(5)},{name:"Bayonette",base:"MeleeWeaponBase",material:r.default.MATERIAL.IRON,damage:"1d5",weaponType:"dagger",weight:.1,value:l(10)},{name:"Short sword",base:"MeleeWeaponBase",material:r.default.MATERIAL.IRON,damage:"1d6",weaponType:"sword",weight:.5,value:l(20)},{name:"Wooden staff",base:"MeleeWeaponBase",material:"wood",damage:"1d6",weaponType:"staff",defense:1,weight:1,value:l(30)},{name:"Whip",base:"MeleeWeaponBase",material:"leather",damage:"1d6",range:2,attack:-1,weight:.2,value:l(10)},{name:"Tomahawk",base:"MeleeWeaponBase",material:["wood","stone","leather"],damage:"1d7",attack:1,defense:1,weaponType:"axe",weight:.7,value:l(35)},{name:"Iron staff",base:"MeleeWeaponBase",material:r.default.MATERIAL.IRON,damage:"1d8",weaponType:"staff",defense:2,weight:1.9,value:l(40)},{name:"Piolet",base:"MeleeWeaponBase",damage:"1d8",attack:1,defense:1,weaponType:"axe",weight:.7,value:l(50)},{name:"Pick-axe",base:"MeleeWeaponBase",damage:"1d8",attack:1,defense:2,weaponType:"axe",weight:2.3,value:l(50),use:"digger"},{name:"Saber",base:"MeleeWeaponBase",material:r.default.MATERIAL.IRON,damage:"2d4 + 1",attack:2,defense:1,weaponType:"sword",weight:.6,value:l(30)},{name:"Mace",base:"MeleeWeaponBase",material:r.default.MATERIAL.IRON,damage:"2d4 + 2",attack:2,defense:0,weaponType:"mace",weight:.8,value:l(35)},{name:"Spear",base:"MeleeWeaponBase",damage:"1d8",attack:1,defense:3,weaponType:"spear",weight:1.2,value:l(50)},{name:"Iron axe",base:"MeleeWeaponBase",damage:"1d8",attack:3,defense:1,weaponType:"axe",weight:1.5,value:l(60)},{name:"Longsword",base:"MeleeWeaponBase",material:r.default.MATERIAL.STEEL,damage:"1d8",attack:2,defense:2,weaponType:"sword",weight:.8,value:l(75)},{name:"Morningstar",base:"MeleeWeaponBase",material:r.default.MATERIAL.IRON,damage:"1d9 + 2",attack:2,defense:3,weaponType:"mace",weight:.7,value:l(75)},{name:"Battle axe",base:"MeleeWeaponBase",material:r.default.MATERIAL.IRON,damage:"2d6 + 2",attack:2,defense:1,weaponType:"axe",weight:2.5,value:l(85)},{name:"Warhammer",base:"MeleeWeaponBase",material:r.default.MATERIAL.IRON,damage:"2d6 + 5",attack:3,defense:1,weaponType:"hammer",weight:4.5,value:l(100)},{name:"Dwarven pick-axe",base:"MeleeWeaponBase",damage:"1d12",attack:2,defense:2,color:a.Colors.race.dwarven,weaponType:"axe",weight:3.5,value:l(120),use:"digger"},{name:"Great battle axe",base:"MeleeWeaponBase",material:"steel",damage:"2d8 + 4",attack:3,defense:0,weaponType:"axe",weight:4.5,value:l(130)},{name:"MithrilWeaponBase",base:"MeleeWeaponBase",className:"cell-item-mithril",material:r.default.MATERIAL.MITHRIL,dontCreate:!0,attack:1,rarity:2},{name:"Mithril dagger",base:"MithrilWeaponBase",attack:2,damage:"1d7 + 3",weaponType:"dagger",weight:.15,value:l(50)},{name:"Mithril short sword",base:"MithrilWeaponBase",attack:3,damage:"1d9 + 4",defense:2,weight:.35,value:l(100),weaponType:"sword"},{name:"Mithril mace",base:"MithrilWeaponBase",damage:"1d11 + 5",weaponType:"mace",attack:3,defense:2,weight:2.5,value:l(150)},{name:"Mithril staff",base:"MithrilWeaponBase",damage:"1d12 + 2",weaponType:"staff",defense:6,weight:1.5,value:l(170)},{name:"Mithril axe",base:"MithrilWeaponBase",attack:4,damage:"1d15 + 2",defense:3,weaponType:"axe",weight:1.2,value:l(200)},{name:"Mithril hammer",base:"MithrilWeaponBase",attack:5,damage:"1d15 + 6",defense:1,weaponType:"axe",weight:2.4,value:l(250)},{name:"Mithril long sword",base:"MithrilWeaponBase",attack:5,damage:"1d15 + 4",defense:4,weight:.6,value:l(300),weaponType:"sword"},{name:"Mithril spear",base:"MithrilWeaponBase",attack:5,damage:"1d12 + 4",defense:8,weight:.9,value:l(350),weaponType:"spear"},{name:"Mithril pick-axe",base:"MithrilWeaponBase",damage:"1d15",attack:3,defense:2,weaponType:"axe",weight:1.2,value:l(150),use:"digger"},{name:"IceWeaponBase",base:"MeleeWeaponBase",className:"cell-item-ice",material:r.default.MATERIAL.PERMAICE,dontCreate:!0,attack:1,rarity:5},{name:"Permaice dagger",base:"IceWeaponBase",damage:"1d4 + 9",defense:6,weight:.6,value:l(150),weaponType:"dagger"},{name:"Permaice short sword",base:"IceWeaponBase",damage:"2d5 + 9",defense:6,weight:1.5,value:l(300),weaponType:"sword"},{name:"Permaice mace",base:"IceWeaponBase",damage:"2d7 + 9",weaponType:"mace",defense:6,weight:2.5,value:l(300)},{name:"Permaice staff",base:"IceWeaponBase",damage:"3d5 + 9",weaponType:"staff",defense:7,weight:3.8,value:l(300)},{name:"Permaice axe",base:"IceWeaponBase",damage:"3d6 + 9",defense:7,weaponType:"axe",weight:4.5,value:l(400)},{name:"Permaice hammer",base:"IceWeaponBase",damage:"3d6 + 12",defense:7,weaponType:"hammer",weight:6.5,value:l(440)},{name:"Permaice long sword",base:"IceWeaponBase",damage:"4d5 + 9",defense:8,weight:3,value:l(500),weaponType:"sword"},{name:"Permaice spear",base:"IceWeaponBase",damage:"4d5 + 9",defense:12,weight:3.5,value:l(550),weaponType:"spear"},{name:"Permaice katana",base:"IceWeaponBase",damage:"10d3 + 10",defense:10,weight:4,value:l(750),weaponType:"sword"},{name:"Permaice pick-axe",base:"IceWeaponBase",damage:"3d6 + 6",defense:6,weaponType:"axe",weight:3.6,value:l(300),use:"digger"},{name:"RubyWeaponBase",base:"MeleeWeaponBase",className:"cell-item-ruby-glass",material:r.default.MATERIAL.RUBY_GLASS,dontCreate:!0,rarity:4},{name:"Ruby glass dagger",base:"RubyWeaponBase",damage:"2d5 + 2",attack:4,defense:1,weight:.1,value:l(110),weaponType:"dagger"},{name:"Ruby glass short sword",base:"RubyWeaponBase",damage:"3d5 + 2",attack:3,defense:2,weight:.2,value:l(200),weaponType:"sword"},{name:"Ruby glass mace",base:"RubyWeaponBase",damage:"3d6 + 2",attack:3,defense:3,weight:.3,value:l(250),weaponType:"mace"},{name:"Ruby glass hammer",base:"RubyWeaponBase",damage:"3d6 + 4",attack:4,defense:2,weight:.6,value:l(250),weaponType:"hammer"},{name:"Ruby glass staff",base:"RubyWeaponBase",damage:"3d5",weaponType:"staff",attack:4,defense:5,weight:.4,value:l(300)},{name:"Ruby glass sword",base:"RubyWeaponBase",damage:"4d5 + 2",attack:5,defense:2,weight:.3,value:l(350),weaponType:"sword"},{name:"Ruby glass spear",base:"RubyWeaponBase",damage:"3d5 + 2",attack:3,defense:6,weight:.4,value:l(400),weaponType:"spear"},{name:"Ruby glass battle axe",base:"RubyWeaponBase",damage:"4d6 + 3",attack:6,defense:2,weight:.7,value:l(800),weaponType:"axe"},{name:"Ruby glass pick-axe",base:"RubyWeaponBase",damage:"3d5",attack:5,defense:2,weaponType:"axe",weight:1,value:l(300),use:"digger"},{name:"RunedWeaponBase",base:"MeleeWeaponBase",className:"cell-item-magic",material:r.default.MATERIAL.FORIUM,dontCreate:!0,rarity:6},{name:"Runed dagger",base:"RunedWeaponBase",damage:"2d5 + 2",attack:2,defense:1,weight:.2,value:l(100),weaponType:"dagger"},{name:"Runed short sword",base:"RunedWeaponBase",damage:"3d5 + 2",attack:3,defense:2,weight:.5,value:l(300),weaponType:"sword"},{name:"Runed mace",base:"RunedWeaponBase",damage:"3d6 + 2",attack:3,defense:2,weight:1,value:l(340),weaponType:"mace"},{name:"Runed axe",base:"RunedWeaponBase",damage:"4d5 + 2",attack:4,defense:2,weight:1.5,value:l(400),weaponType:"axe"},{name:"Runed hammer",base:"RunedWeaponBase",damage:"4d5 + 4",attack:5,defense:1,weight:2.7,value:l(400),weaponType:"hammer"},{name:"Runed staff",base:"RunedWeaponBase",damage:"4d5",weaponType:"staff",attack:2,defense:9,weight:2,value:l(400)},{name:"Runed sword",base:"RunedWeaponBase",damage:"5d5 + 2",attack:5,defense:2,weight:1,value:l(500),weaponType:"sword"},{name:"Runed spear",base:"RunedWeaponBase",damage:"4d5 + 4",attack:4,defense:8,weight:1.4,value:l(600),weaponType:"spear"},{name:"Runed katana",base:"RunedWeaponBase",damage:"3d12 + 2",attack:5,defense:5,weight:.8,value:l(750),weaponType:"sword"},{name:"Wintersbane",base:"RunedWeaponBase",damage:"3d10 + 4",attack:6,defense:3,weight:1,value:l(1e3),weaponType:"sword"},{name:"Rune-covered pick-axe",base:"RunedWeaponBase",damage:"4d5",attack:5,defense:2,weaponType:"axe",weight:2.5,value:l(300),use:"digger"},{name:"VoidWeaponBase",base:"MeleeWeaponBase",className:"cell-item-void",material:r.default.MATERIAL.NETHERIUM,dontCreate:!0,onAttackHit:[o.meleeHitDamage(2,"1d8 + 1","VOID")],rarity:8},{name:"Void dagger",base:"VoidWeaponBase",damage:"2d5 + 1",attack:2,defense:1,weight:.3,value:l(200),weaponType:"dagger"},{name:"Void short sword",base:"VoidWeaponBase",damage:"3d5 + 2",attack:3,defense:2,weight:.7,value:l(300),weaponType:"sword"},{name:"Void mace",base:"VoidWeaponBase",damage:"3d6 + 2",attack:3,defense:2,weight:1.4,value:l(390),weaponType:"mace"},{name:"Void axe",base:"VoidWeaponBase",damage:"4d5 + 2",attack:4,defense:2,weight:1.9,value:l(450),weaponType:"axe"},{name:"Void staff",base:"VoidWeaponBase",damage:"3d6 + 2",weaponType:"staff",attack:2,defense:9,weight:2,value:l(450)},{name:"Void longsword",base:"VoidWeaponBase",damage:"5d5 + 2",attack:5,defense:2,weight:1.4,value:l(550),weaponType:"sword"},{name:"Void spear",base:"VoidWeaponBase",damage:"4d5 + 2",attack:4,defense:8,weight:1.8,value:l(650),weaponType:"spear"},{name:"Hammer of Void",base:"VoidWeaponBase",damage:"5d5 + 8",attack:8,defense:8,weight:3.7,value:l(850),weaponType:"hammer",onAttackHit:[o.meleeHitDamage(2,"2d8 + 4","VOID")]},{name:"Void pick-axe",base:"VoidWeaponBase",damage:"4d5",attack:5,defense:2,weaponType:"axe",weight:2.3,value:l(500),use:"digger"},{name:"ArmourBase",type:"armour",className:"cell-item-armour",char:"[",dontCreate:!0,attack:0,defense:0,protection:0},{name:"Robe",base:"ArmourBase",className:"cell-item-cloth",weight:1,defense:1,armourType:"chest",value:l(15)},{name:"Spiked boots",base:"ArmourBase",weight:.4,defense:1,protection:1,armourType:"feet",value:l(35)},{name:"Robe of defense",base:"ArmourBase",className:"cell-item-cloth",weight:.9,defense:4,armourType:"chest",value:l(200),rarity:3},{name:"Robe of protection",base:"ArmourBase",className:"cell-item-cloth",weight:.8,protection:4,armourType:"chest",value:l(200),rarity:3},{name:"Runed robe",base:"ArmourBase",className:"cell-item-cloth",weight:.7,defense:4,protection:4,armourType:"chest",value:l(350),rarity:3},{name:"Boots of flying",base:"ArmourBase",weight:.4,defense:1,protection:1,armourType:"feet",value:l(350),onEquip:[{addComp:"Flying"}],rarity:3},{name:"Snow shoes",base:"ArmourBase",weight:.4,defense:-1,protection:0,armourType:"feet",value:l(75),onEquip:[{addComp:"SnowWalk"}],noRandom:!0},{name:"LeatherArmourBase",base:"ArmourBase",dontCreate:!0,material:"leather",className:"cell-item-leather",rarity:1},{name:"Leather helmet",base:"LeatherArmourBase",weight:.3,defense:1,armourType:"head",value:l(15)},{name:"Leather collar",base:"LeatherArmourBase",weight:.2,protection:1,armourType:"neck",value:l(15)},{name:"Leather boots",base:"LeatherArmourBase",weight:.5,defense:1,armourType:"feet",value:l(15)},{name:"Leather leggings",base:"LeatherArmourBase",weight:1,defense:1,protection:2,armourType:"legs",value:l(30)},{name:"Leather armour",base:"LeatherArmourBase",weight:2,defense:2,protection:3,armourType:"chest",value:l(30)},{name:"Leather shield",base:"LeatherArmourBase",weight:1,defense:2,attack:-1,armourType:"shield",value:l(15)},{name:"ChainArmourBase",base:"ArmourBase",dontCreate:!0,material:"iron",className:"cell-item-iron",rarity:2},{name:"Chain helmet",base:"ChainArmourBase",weight:.6,defense:1,protection:1,armourType:"head",value:l(45)},{name:"Chain collar",base:"ChainArmourBase",weight:.4,protection:2,armourType:"neck",value:l(45)},{name:"Chain boots",base:"ChainArmourBase",weight:1.2,defense:1,protection:1,armourType:"feet",value:l(45)},{name:"Chain leggings",base:"ChainArmourBase",weight:2,defense:1,protection:3,armourType:"legs",value:l(75)},{name:"Chain armour",base:"ChainArmourBase",weight:4,defense:1,protection:4,armourType:"chest",value:l(90)},{name:"Chain shield",base:"ChainArmourBase",weight:2,defense:3,attack:-2,armourType:"shield",value:l(40)},{name:"SteelArmourBase",base:"ArmourBase",dontCreate:!0,material:"steel",className:"cell-item-steel",rarity:2},{name:"Steel helmet",base:"SteelArmourBase",weight:1.1,defense:1,protection:2,armourType:"head",value:l(75)},{name:"Steel collar",base:"SteelArmourBase",weight:.8,protection:3,armourType:"neck",value:l(75)},{name:"Steel boots",base:"SteelArmourBase",weight:2,defense:1,protection:2,armourType:"feet",value:l(75)},{name:"Steel leggings",base:"SteelArmourBase",weight:4,defense:0,protection:3,armourType:"legs",value:l(100)},{name:"Steel armour",base:"SteelArmourBase",weight:8,defense:0,protection:6,armourType:"chest",value:l(150)},{name:"Steel shield",base:"SteelArmourBase",weight:3,defense:4,attack:-2,armourType:"shield",value:l(80)},{name:"MithrilArmourBase",base:"ArmourBase",dontCreate:!0,material:"mithril",className:"cell-item-mithril",rarity:3},{name:"Mithril helmet",base:"MithrilArmourBase",weight:.8,defense:1,protection:2,armourType:"head",value:l(120)},{name:"Mithril collar",base:"MithrilArmourBase",weight:.6,protection:3,armourType:"neck",value:l(110)},{name:"Mithril boots",base:"MithrilArmourBase",weight:1.6,defense:1,protection:2,armourType:"feet",value:l(120)},{name:"Mithril leggings",base:"MithrilArmourBase",weight:3,defense:0,protection:4,armourType:"legs",value:l(150)},{name:"Mithril armour",base:"MithrilArmourBase",weight:6,defense:0,protection:7,armourType:"chest",value:l(200)},{name:"Mithril shield",base:"MithrilArmourBase",weight:2.2,defense:5,attack:-1,armourType:"shield",value:l(120)},{name:"IceArmourBase",base:"ArmourBase",dontCreate:!0,material:"permaice",className:"cell-item-ice",rarity:5},{name:"Permaice helmet",base:"IceArmourBase",weight:1.8,defense:0,protection:4,armourType:"head",value:l(200)},{name:"Permaice collar",base:"IceArmourBase",weight:1.8,defense:0,protection:4,armourType:"neck",value:l(200)},{name:"Permaice boots",base:"IceArmourBase",weight:3.6,defense:0,protection:3,armourType:"feet",value:l(200)},{name:"Permaice leggings",base:"IceArmourBase",weight:6,defense:0,protection:8,armourType:"legs",value:l(300)},{name:"Permaice armour",base:"IceArmourBase",weight:12,defense:0,protection:12,armourType:"chest",value:l(400)},{name:"Permaice shield",base:"IceArmourBase",weight:6,defense:4,attack:-3,protection:2,armourType:"shield",value:l(120)},{name:"RubyArmourBase",base:"ArmourBase",dontCreate:!0,material:"ruby glass",className:"cell-item-ruby-glass",rarity:5},{name:"Ruby glass helmet",base:"RubyArmourBase",weight:.1,defense:2,protection:2,armourType:"head",value:l("ruby",100)},{name:"Ruby glass collar",base:"RubyArmourBase",weight:.1,defense:2,protection:2,armourType:"neck",value:l("ruby",100)},{name:"Ruby glass boots",base:"RubyArmourBase",weight:.2,defense:3,protection:2,armourType:"feet",value:l("ruby",200)},{name:"Ruby glass leggings",base:"RubyArmourBase",weight:1,defense:6,protection:5,armourType:"legs",value:l("ruby",350)},{name:"Ruby glass armour",base:"RubyArmourBase",weight:1,defense:7,protection:8,armourType:"chest",value:l("ruby",500)},{name:"Ruby glass shield",base:"RubyArmourBase",weight:.4,defense:5,armourType:"shield",value:l("ruby",250)},{name:"RunedArmourBase",base:"ArmourBase",dontCreate:!0,material:"forium",className:"cell-item-magic",rarity:7},{name:"Runed helmet",base:"RunedArmourBase",weight:.6,defense:3,protection:4,armourType:"head",value:l("magic",200)},{name:"Runed cloak",base:"RunedArmourBase",weight:.2,defense:2,protection:2,armourType:"cloak",value:l("magic",200)},{name:"Runed collar",base:"RunedArmourBase",weight:.4,defense:3,protection:2,armourType:"neck",value:l("magic",200)},{name:"Runed boots",base:"RunedArmourBase",weight:1.2,defense:3,protection:2,armourType:"feet",value:l("magic",200)},{name:"Runed leggings",base:"RunedArmourBase",weight:2.5,defense:6,protection:6,armourType:"chest",value:l("magic",400)},{name:"Runed armour",base:"RunedArmourBase",weight:4,defense:12,protection:8,armourType:"chest",value:l("magic",500)},{name:"Runed shield",base:"RunedArmourBase",weight:2,defense:7,attack:-2,armourType:"shield",value:l("magic",200)},{name:"MissileBase",className:"cell-item-missile",char:"โน",type:"missile",dontCreate:!0,attack:1,damage:"1d1",range:2,weight:.1},{name:"Rock",base:"MissileBase",className:"cell-item-rock",char:"*",damage:"1d4",range:5,value:l(10),weight:.2},{name:"Large rock",base:"MissileBase",className:"cell-item-rock",char:"*",damage:"2d4 + 2",range:2,value:l(20),weight:1},{name:"Huge rock",base:"MissileBase",className:"cell-item-rock",char:"*",damage:"5d4 + 2",range:1,value:l(40),weight:20},{name:"Shuriken",base:"MissileBase",className:"cell-item-iron",char:"*",damage:"1d6",range:3,value:l(20),weaponType:"shuriken"},{name:"Iron dart",base:"MissileBase",className:"cell-item-iron",damage:"1d6 + 1",range:4,value:l(40),weaponType:"dart"},{name:"Steel dart",base:"MissileBase",className:"cell-item-steel",damage:"1d6 + 3",range:4,value:l(50),weaponType:"dart"},{name:"Throwing spear",base:"MissileBase",className:"cell-item-iron",attack:2,damage:"1d7 + 1",range:3,value:l(55),weight:.4,weaponType:"spear"},{name:"Throwing axe",base:"MissileBase",className:"cell-item-iron",attack:2,damage:"1d8 + 1",range:3,value:l(60),weight:.3,weaponType:"axe"},{name:"Ruby glass throwing knife",base:"MissileBase",className:"cell-item-ruby-glass",attack:3,damage:"1d10",range:5,value:l(80),weight:.1,weaponType:"dagger",material:"ruby glass",rarity:4},{name:"Runed Shuriken",base:"MissileBase",attack:3,className:"cell-item-magic",char:"*",material:"forium",damage:"3d4 + 2",range:5,value:l(100),weight:.1,weaponType:"shuriken",rarity:5},{name:"Throwing axe of death",base:"MissileBase",className:"cell-item-magic",attack:5,damage:"2d10 + 3",range:3,value:l(200),weight:.5,addComp:"Indestructible",weaponType:"axe",rarity:6},{name:"MissileWeaponBase",dontCreate:!0,type:"missileweapon",fireRate:1,className:"cell-item-missileweapon",attack:0,defense:0,char:"{"},{name:"Wooden bow",base:"MissileWeaponBase",className:"cell-item-wooden",attack:1,range:4,value:l(75),weaponType:"bow",weight:1},{name:"Wooden crossbow",base:"MissileWeaponBase",className:"cell-item-wooden",attack:3,range:6,value:l(150),weaponType:"crossbow",weight:2},{name:"Iron bow",base:"MissileWeaponBase",className:"cell-item-iron",attack:1,range:5,value:l(110),weaponType:"bow",weight:1.5},{name:"Steel bow",base:"MissileWeaponBase",className:"cell-item-steel",attack:2,range:5,value:l(150),weaponType:"bow",weight:2},{name:"Steel crossbow",base:"MissileWeaponBase",className:"cell-item-steel",attack:4,range:7,value:l(250),weaponType:"crossbow",weight:3},{name:"Ruby glass bow",base:"MissileWeaponBase",className:"cell-item-ruby-glass",attack:6,range:6,value:l("ruby",300),weaponType:"bow",weight:.3,rarity:4},{name:"Double crossbow",base:"MissileWeaponBase",className:"cell-item-steel",attack:0,range:5,value:l(400),fireRate:2,weaponType:"crossbow",weight:4,rarity:4},{name:"Bow of Defense",base:"MissileWeaponBase",className:"cell-item-magic",attack:1,range:4,defense:6,value:l("magic",500),weaponType:"bow",weight:1,rarity:4},{name:"Rifle",base:"MissileWeaponBase",className:"cell-item-steel",attack:4,range:7,value:l(350),weaponType:"rifle",weight:4.5,rarity:4},{name:"Dwarven rifle",base:"MissileWeaponBase",className:"cell-item-steel",attack:4,range:8,damage:"1d6",value:l(500),weaponType:"rifle",weight:5.5,rarity:5},{name:"Wooden arrow",base:"MissileBase",className:"cell-item-wooden",type:"ammo",range:1,weight:.1,ammoType:"bow",attack:0,damage:"1d6",value:l(5)},{name:"Wooden bolt",base:"MissileBase",className:"cell-item-wooden",type:"ammo",range:1,weight:.1,ammoType:"crossbow",attack:1,damage:"1d8",value:l(7)},{name:"Steel arrow",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.1,ammoType:"bow",attack:0,damage:"1d6 + 2",value:l("steel",8)},{name:"Steel bolt",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.1,ammoType:"crossbow",attack:1,damage:"1d8 + 2",value:l("steel",14)},{name:"Stone bullet",base:"MissileBase",className:"cell-item-rock",type:"ammo",range:1,weight:.1,ammoType:"rifle",attack:-1,damage:"2d4",value:l(10),rarity:2},{name:"Arrow of targeting",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.1,ammoType:"bow",attack:10,damage:"1d6 + 3",value:l("steel",20),rarity:3},{name:"Runed arrow",base:"MissileBase",className:"cell-item-magic",type:"ammo",range:1,weight:.2,ammoType:"bow",attack:4,damage:"2d7",value:l("magic",25),rarity:5},{name:"Ruby glass bolt",base:"MissileBase",className:"cell-item-ruby-glass",type:"ammo",range:2,weight:.05,ammoType:"crossbow",attack:3,damage:"2d8",value:l("ruby",30),rarity:4},{name:"Steel bullet",base:"MissileBase",className:"cell-item-steel",type:"ammo",range:1,weight:.05,ammoType:"rifle",attack:1,damage:"3d4",value:l(20),rarity:4},{name:"Void bolt",base:"MissileBase",className:"cell-item-void",type:"ammo",range:1,weight:.1,ammoType:"crossbow",attack:5,damage:"4d4 + 4",value:l(60),rarity:7},{name:"PotionBase",char:"!",type:"potion",dontCreate:!0,weight:.1,addComp:"OneShot",color:o.color("random","black"),rarity:1},{name:"Healing potion",base:"PotionBase",use:{heal:{hp:"3d4"}},value:l(10)},{name:"Potion of venom",base:"PotionBase",use:{poison:{duration:"4d4 + 5",damage:"1d6",prob:"0.1"}},value:l(30)},{name:"Potion of stunning",base:"PotionBase",use:{stun:{duration:"2d4 + 1"}},value:l(50)},{name:"Potion of power",base:"PotionBase",use:{modifyCompValue:{name:"SpellPower",set:"setPP",get:"getPP",value:"1d10 + 2"}},value:l(50)},{name:"Potion of nourishment",base:"PotionBase",use:{modifyCompValue:{name:"Hunger",set:"setEnergy",get:"getEnergy",value:"10000"}},value:l(50)},{name:"Potion of inner heat",base:"PotionBase",use:{removeComp:{name:"Coldness",all:!0}},value:l(50)},{name:"Potion of cure poison",base:"PotionBase",use:{cure:{effect:"poison"}},value:l(80)},{name:"Potion of eagle",base:"PotionBase",use:{addComp:{name:"Flying",duration:"10d10 + 10"}},value:l(80)},{name:"Potion of deflection",base:"PotionBase",use:{addComp:{name:"Deflection",duration:"10d10 + 10"}},value:l(80)},{name:"Potion of eagle eye",base:"PotionBase",use:{addComp:{name:"EagleEye",duration:"10d10 + 10"}},value:l(80)},{name:"Potion of first strike",base:"PotionBase",use:{addComp:{name:"FirstStrike",duration:"10d10 + 10"}},value:l(80)},{name:"Potion of paralysis",base:"PotionBase",use:{addComp:{name:"Paralysis",duration:"2d5"}},value:l(80)},{name:"Potion of blindness",base:"PotionBase",use:{addComp:{name:"Blindness",duration:"2d5"}},value:l(80)},{name:"Potion of frost poison",base:"PotionBase",use:{poison:{duration:"5d20",damage:"1d6 + 1",prob:"0.2"}},value:l(100)},{name:"Healing elixir",base:"PotionBase",use:{heal:{hp:"10d5"}},value:l(100)},{name:"Potion of spirit form",base:"PotionBase",use:{addComp:{name:"Ethereal",duration:"2d10"}},value:l(100)},{name:"Potion of charm",base:"PotionBase",use:{addComp:{name:"Charm",duration:"2d10"}},value:l(120)},{name:"Potion of mana",base:"PotionBase",use:{modifyCompValue:{name:"SpellPower",set:"setPP",get:"getPP",value:"6d5 + 5"}},value:l(150)},{name:"Potion of quickness",base:"PotionBase",use:{modifyStat:{value:2,statName:"speed"}},value:l(150)},{name:"Potion of greater quickness",base:"PotionBase",use:{modifyStat:{value:4,statName:"speed"}},value:l(350)},{name:"FoodBase",char:"%",weight:.1,type:"food",dontCreate:!0,addComp:"OneShot",rarity:1},{name:"Wheat",base:"FoodBase",energy:100,value:l(10),color:o.color("ForestGreen","Coral")},{name:"Rye",base:"FoodBase",energy:100,value:l(10),color:o.color("ForestGreen","Coral")},{name:"Barley",base:"FoodBase",energy:100,value:l(10),color:o.color("ForestGreen","Coral")},{name:"Oat",base:"FoodBase",energy:100,value:l(10),color:o.color("ForestGreen","Coral")},{name:"Carrots",base:"FoodBase",energy:500,value:l(10),color:o.color("ForestGreen","Coral")},{name:"Milk",base:"FoodBase",energy:500,value:l(10),color:o.color("Blue","White")},{name:"Cabbage",base:"FoodBase",energy:700,value:l(10),color:o.color("ForestGreen","Chartreuse")},{name:"Turnip",base:"FoodBase",energy:700,value:l(10),color:o.color("ForestGreen","Khaki")},{name:"Blueberries",base:"FoodBase",energy:1700,value:l(30),color:o.color("FloralWhite","DarkBlue")},{name:"Lingonberries",base:"FoodBase",energy:1700,value:l(30),color:o.color("FloralWhite","DarkRed")},{name:"Chicken egg",base:"FoodBase",energy:1300,value:l(25)},{name:"Poultry",base:"FoodBase",energy:800,value:l(25),weight:.4,color:o.color("red","white")},{name:"Potatoes",base:"FoodBase",energy:1200,value:l(20),color:o.color("DarkGray","Sienna")},{name:"Dried meat",base:"FoodBase",energy:1300,value:l(20),color:o.color("white","red")},{name:"Corn",base:"FoodBase",energy:1600,value:l(30),color:o.color("ForestGreen","Yellow")},{name:"Pork",base:"FoodBase",energy:1e3,value:l(30),weight:.4,color:o.color("white","pink")},{name:"Beef",base:"FoodBase",energy:1e3,value:l(30),weight:.4,color:o.color("white","Brown")},{name:"Chunk of meat",base:"FoodBase",energy:1e3,value:l(20),weight:.4,color:o.color("white","red")},{name:"Reindeer meat",base:"FoodBase",energy:2e3,value:l(35),weight:.3,color:o.color("white","red")},{name:"Elk meat",base:"FoodBase",energy:2500,value:l(40),weight:.3,color:o.color("white","darkred")},{name:"Bear meat",base:"FoodBase",energy:2500,value:l(35),weight:.3,color:o.color("pink","brown")},{name:"Wheat bread",base:"FoodBase",energy:2e3,value:l(30),recipe:[{count:3,name:"Wheat"}]},{name:"Rye bread",base:"FoodBase",energy:2e3,value:l(30),recipe:[{count:3,name:"Rye"}]},{name:"Barley bread",base:"FoodBase",energy:2e3,value:l(30),recipe:[{count:3,name:"Barley"}]},{name:"Oats",base:"FoodBase",energy:2800,value:l(30),recipe:[{count:4,name:"Oat"}]},{name:"Ration",base:"FoodBase",energy:2e3,value:l(40),weight:1},{name:"Dried fruit",base:"FoodBase",energy:3500,value:l(50)},{name:"Cloudberries",base:"FoodBase",energy:1500,value:l(50),color:o.color("Orange","DarkGreen")},{name:"Seeds and nuts",base:"FoodBase",energy:5e3,value:l(50),color:o.color("GoldenRod","Sienna")},{name:"Ghost pepper",base:"FoodBase",energy:100,value:l(50),use:{stun:{duration:"3d3"}},color:o.color("OrangeRed","DarkGreen")},{name:"Wraith pepper",base:"FoodBase",energy:100,value:l(100),use:{stun:{duration:"3d10"}},color:o.color("Cyan","Black")},{name:"Whale fat",base:"FoodBase",energy:8e3,value:l(100)},{name:"tool",type:"tool",uses:10,className:"cell-item-tool",char:"]",dontCreate:!0,rarity:1},{name:"shovel",base:"tool",use:{addElement:{elementName:"Hole",numAllowed:1,successMsg:"You dig a hole to the ground",successCheck:[{elements:{has:"Diggable"}}],failureMsg:"You fail to dig a hole there"}},value:100},{name:"machete",base:"tool",char:"(",use:{removeElement:{elementName:"web",successMsg:"You remove the webs using machete",failureMsg:"You do not manage to remove any webs"}},noRandom:!0},{name:"trapmaking kit",base:"tool"},{name:"firemaking kit",base:"tool",className:"cell-item-fire",use:{addEntity:{entityName:"Fire",duration:20}},value:100},{name:"hoe",base:"tool",className:"cell-item-iron",use:{addElement:{elementName:"TilledSoil",duration:"100",successMsg:"You till the soil with hoe.",successCheck:[{elements:{has:"Tillable"}}],failureMsg:"This location cannot be tilled."}},value:30},{name:"small bomb",base:"tool",weight:1,className:"cell-item-iron",addComp:"OneShot",callbacks:{onAddExplosion:{addComp:[{comp:"Explosion",area:"3x3",func:{setDamage:"3d12"},applyToAllTargets:!0,anim:{className:"cell-item-fire"}}],removeEntity:{target:"self"}}},use:{addEntity:{entityName:"armed small bomb",duration:5}},value:50},{name:"large bomb",base:"tool",weight:2,className:"cell-item-iron",addComp:"OneShot",callbacks:{onAddExplosion:{addComp:[{comp:"Explosion",area:"5x5",func:{setDamage:"5d12"},applyToAllTargets:!0,anim:{className:"cell-item-fire"}}],removeEntity:{target:"self"}}},use:{addEntity:{entityName:"armed large bomb",duration:5}},value:100},{name:"carpentry kit",base:"tool",weight:1.5,className:"cell-item-wooden",use:{addComp:{name:"BuildEvent",targetType:["cell"],addOnUser:!0,setters:{setBuildType:"wood",setTarget:"$$target",$chooseArg:{func:"setElem",args:["wooden door","wallwooden","floorwooden"],menuMsg:"Select which element to build:"}}}}},{name:"wheat seeds",base:"tool",addComp:"OneShot",use:h("Wheat",12),value:5,weight:.05},{name:"oat seeds",base:"tool",addComp:"OneShot",use:h("Oat",12),value:5,weight:.05},{name:"barley seeds",base:"tool",addComp:"OneShot",use:h("Oat",12),value:5,weight:.05},{name:"rye seeds",base:"tool",addComp:"OneShot",use:h("Oat",12),value:5,weight:.05},{name:"Turnip seeds",base:"tool",color:o.color("ForestGreen","Khaki"),addComp:"OneShot",use:h("Turnip",18),value:5,weight:.05},{name:"Carrot seeds",base:"tool",color:o.color("ForestGreen","Coral"),addComp:"OneShot",use:h("Carrots",18),value:5,weight:.05},{name:"Cabbage seeds",base:"tool",color:o.color("ForestGreen","Chartreuse"),addComp:"OneShot",use:h("Cabbage",18),value:5,weight:.05},{name:"Potato seeds",base:"tool",color:o.color("DarkGray","Sienna"),addComp:"OneShot",use:h("Potatoes",18),value:7,weight:.05},{name:"Corn seeds",base:"tool",color:o.color("ForestGreen","Yellow"),addComp:"OneShot",use:h("Corn",18),value:7,weight:.05},{name:"Blueberry seeds",base:"tool",color:o.color("FloralWhite","DarkBlue"),addComp:"OneShot",use:h("Blueberries",24),value:10,weight:.05},{name:"Lingonberry seeds",base:"tool",color:o.color("FloralWhite","DarkRed"),addComp:"OneShot",use:h("Lingonberries",24),value:10,weight:.05},{name:"Ghost pepper seeds",base:"tool",color:o.color("OrangeRed","DarkGreen"),addComp:"OneShot",use:h("Ghost pepper",30),value:20},{name:"Wraith pepper seeds",base:"tool",color:o.color("Cyan","Black"),addComp:"OneShot",use:h("Wraith pepper",36),value:40,weight:.05},{name:"repair tool kit",base:"tool",use:{removeComp:{name:"Broken"}},noRandom:!0},{name:"rope",base:"tool",className:"cell-item-wooden",weight:.5,value:30},{name:"piece of wood",base:"tool",value:5,className:"cell-item-wooden",weight:.2,noRandom:!0},{name:"piece of grass",base:"tool",value:2,className:"cell-item-wooden",char:"]",weight:.1,noRandom:!0},{name:"piece of stone",base:"tool",value:3,className:"cell-item-stone",char:"]",weight:.25,noRandom:!0},{name:"iron ingot",base:"tool",value:15,className:"cell-item-iron",char:"]",weight:.5,recipe:[{count:3,name:"iron ore"}]},{name:"steel ingot",base:"tool",value:25,className:"cell-item-steel",char:"]",weight:.6,recipe:[{count:4,name:"iron ore"}]},{name:"mithril ingot",base:"tool",value:35,className:"cell-item-mithril",char:"]",weight:.45,recipe:[{count:3,name:"mithril ore"}],rarity:2},{name:"permaice ingot",base:"tool",value:70,className:"cell-item-ice",char:"]",weight:1,recipe:[{count:3,name:"permaice ore"}],rarity:4},{name:"ruby class ingot",base:"tool",value:70,className:"cell-item-ruby-glass",char:"]",weight:.2,recipe:[{count:3,name:"ruby glass ore"}],rarity:4},{name:"forium ingot",base:"tool",value:75,className:"cell-item-magic",char:"]",weight:.4,recipe:[{count:3,name:"forium ore"}],rarity:5},{name:"netherium ingot",base:"tool",value:100,className:"cell-item-void",char:"]",weight:.7,recipe:[{count:3,name:"netherium ore"}],rarity:6},{name:"SpiritGemBase",char:",",weight:.1,type:"spiritgem",dontCreate:!0,color:o.color("random","MediumPurple"),rarity:1},{name:"Lesser spirit gem",base:"SpiritGemBase",value:l("gem",30),weight:4},{name:"Ordinary spirit gem",base:"SpiritGemBase",value:l("gem",60),weight:2.5},{name:"Greater spirit gem",base:"SpiritGemBase",value:l("gem",100),weight:1.5,rarity:2},{name:"Glowing spirit gem",base:"SpiritGemBase",value:l("gem",200),weight:1,rarity:3},{name:"Mystical spirit gem",base:"SpiritGemBase",value:l("gem",300),weight:.5,rarity:5},{name:"Mythic spirit gem",base:"SpiritGemBase",value:l("gem",500),weight:.2,rarity:7},{name:"RuneBase",dontCreate:!0,type:"rune",char:"โต",color:o.color("random","black"),weight:1,rarity:1},{name:"rune of healing",base:"RuneBase",use:{heal:{hp:"4d4"}},value:l("rune",100)},{name:"rune of protection",base:"RuneBase",use:{addComp:{name:"CombatMods",duration:"10d5 + 10",setters:{setProtection:"2d5"}}},value:l("rune",100)},{name:"rune of defense",base:"RuneBase",use:{addComp:{name:"CombatMods",duration:"10d5 + 10",setters:{setProtection:"2d5"}}},value:l("rune",100)},{name:"rune of attack",base:"RuneBase",use:{addComp:{name:"CombatMods",duration:"10d5 + 10",setters:{setAttack:"2d5"}}},value:l("rune",100)},{name:"rune of webs",base:"RuneBase",use:{addElement:{elementName:"Web",numAllowed:1}},value:l("rune",100)},{name:"rune of cold",base:"RuneBase",use:{addComp:{name:"Coldness",duration:"100d5 + 50"}},value:l("rune",100)},{name:"rune of fire",base:"RuneBase",use:{addEntity:{entityName:"Fire",duration:50}},value:l("rune",100)},{name:"rune of force",base:"RuneBase",use:{addEntity:{entityName:"Forcefield"}},value:l("rune",100)},{name:"rune of skies",base:"RuneBase",use:{addComp:{name:"Flying",duration:"5d10 + 5"}},value:l("rune",100)},{name:"rune of ice flames",base:"RuneBase",use:{addEntity:{entityName:"Ice flame",duration:100}},value:l("rune",150)},{name:"rune of tunneling",base:"RuneBase",use:"digger",value:l("rune",150)},{name:"rune of traps",base:"RuneBase",use:{addElement:{elementName:"Hole",numAllowed:1}},value:l("rune",150)},{name:"rune of poison clouds",base:"RuneBase",use:{addEntity:{entityName:"Poison gas",duration:30}},value:l("rune",150)},{name:"rune of venom",base:"RuneBase",use:{poison:{duration:"4d6 + 5",damage:"1d8 + 2",prob:"0.2"}},value:l("rune",150)},{name:"rune of control",base:"RuneBase",use:{addComp:{name:"MindControl",duration:"1d4 + 2"}},value:l("rune",250)},{name:"MineralBase",dontCreate:!0,type:"mineral",char:"]"},{name:"copper ore",base:"MineralBase",weight:.2,value:l("mineral",20),className:"cell-item-copper",rarity:1},{name:"iron ore",base:"MineralBase",weight:.3,value:l("mineral",20),className:"cell-item-iron"},{name:"lapis lazuli",base:"MineralBase",weight:.35,value:l("mineral",40),char:"*",color:{fg:"LightSkyBlue",bg:"DarkSlateGrey"}},{name:"amethyst",base:"MineralBase",weight:.25,value:l("mineral",50),char:"*",color:{fg:"Orchid",bg:"DarkSlateGrey"}},{name:"aquamarine",base:"MineralBase",weight:.25,value:l("mineral",50),char:"*",color:{fg:"Aquamarine",bg:"Black"}},{name:"topaz",base:"MineralBase",weight:.15,value:l("mineral",75),char:"*",color:{fg:"Blue",bg:"White"}},{name:"fire opal",base:"MineralBase",weight:.15,value:l("mineral",75),char:"*",color:{fg:"Salmon",bg:"Black"}},{name:"white opal",base:"MineralBase",weight:.15,value:l("mineral",75),char:"*",color:{fg:"Wheat",bg:"Black"}},{name:"mithril ore",base:"MineralBase",weight:.2,value:l("mineral",60),className:"cell-item-mithril"},{name:"adamantium ore",base:"MineralBase",weight:.3,value:l("mineral",80),className:"cell-item-adamantium",rarity:2},{name:"snowshard",base:"MineralBase",weight:.2,value:l("mineral",50),char:"*",color:{fg:"DarkBlue",bg:"White"}},{name:"ruby glass ore",base:"MineralBase",weight:.1,value:l("mineral",100),className:"cell-item-ruby-glass",rarity:3},{name:"emerald",base:"MineralBase",weight:.15,value:l("mineral",150),char:"*",color:{fg:"Green",bg:"Black"}},{name:"froststone",base:"MineralBase",weight:.25,value:l("mineral",150),char:"*",color:{fg:"LightCyan",bg:"Gray"}},{name:"permaice ore",base:"MineralBase",weight:.4,value:l("mineral",100),className:"cell-item-ice",rarity:4},{name:"sapphire",base:"MineralBase",weight:.15,value:l("mineral",150),char:"*",color:{fg:"Blue",bg:"White"}},{name:"forium ore",base:"MineralBase",weight:.2,value:l("mineral",150),className:"cell-item-magic",rarity:5},{name:"netherium ore",base:"MineralBase",weight:.3,value:l("mineral",200),className:"cell-item-void",rarity:5},{name:"ruby",base:"MineralBase",weight:.2,value:l("mineral",250),char:"*",className:"cell-item-ruby-glass"},{name:"diamond",base:"MineralBase",weight:.3,value:l("mineral",300),char:"*",color:o.color("white","blue")},{name:"foriphire",base:"MineralBase",weight:.34,value:l("mineral",350),char:"*",className:"cell-item-magic",rarity:5},{name:"nethermond",base:"MineralBase",weight:.36,value:l("mineral",400),char:"*",className:"cell-item-void",rarity:5},{name:"ice diamond",base:"MineralBase",weight:.3,value:l("mineral",400),char:"*",className:"cell-item-ice",rarity:5},{name:"Blizzard Star",base:"MineralBase",weight:1,value:l("mineral",600),char:"*",color:o.color("cyan","darkblue"),rarity:5},{name:"MagicBoltBase",noRandom:!0,type:"ammo",char:"*",addComp:"Magical"},{name:"Fire bolt",base:"MagicBoltBase",className:"cell-item-fire"},{name:"MagicalArrowBase",noRandom:!0,type:"ammo",char:"โน",addComp:"Magical"},{name:"Ice arrow",base:"MagicalArrowBase",className:"cell-item-ice"},{name:"Lightning arrow",base:"MagicalArrowBase",className:"cell-item-lightning"},{name:"Energy arrow",base:"MagicalArrowBase",className:"cell-item-energy"},{name:"Poison arrow",base:"MagicalArrowBase",className:"cell-item-poison"},{name:"Arrow of webs",base:"MagicalArrowBase",className:"cell-item-energy"},{name:"armed small bomb",noRandom:!0,type:"tool",char:"]",callbacks:{onFadeout:{addComp:[{comp:"Explosion",area:"3x3",func:{setDamage:"3d12"},applyToAllTargets:!0,anim:{className:"cell-item-fire"}}]},onAddExplosion:{triggerCb:"onFadeout",removeEntity:{target:"self"}}}},{name:"armed large bomb",noRandom:!0,type:"tool",char:"]",callbacks:{onFadeout:{addComp:[{comp:"Explosion",area:"5x5",func:{setDamage:"5d12"},applyToAllTargets:!0,anim:{className:"cell-item-fire"}}]},onAddExplosion:{triggerCb:"onFadeout",removeEntity:{target:"self"}}}}];var u;function h(e,t){return{addElement:{elementName:"PlantedSoil",setters:{get:"PlantedSoil",setTimeLeftToGrow:t,setGrowsInto:e},successCheck:[{elements:{has:"TilledSoil"}}],failureMsg:"Seeds cannot be planted here."}}}t.dmgTypes={sword:r.default.DMG.SLASH,spear:r.default.DMG.PIERCE,dagger:r.default.DMG.SLASH,axe:r.default.DMG.SLASH,dart:r.default.DMG.PIERCE,shuriken:r.default.DMG.SLASH,bow:r.default.DMG.PIERCE,crossbow:r.default.DMG.PIERCE,rifle:r.default.DMG.PIERCE},c.forEach(e=>{e.damageType||(e.weaponType?t.dmgTypes.hasOwnProperty(e.weaponType)&&(e.damageType=t.dmgTypes[e.weaponType]):e.ammoType&&t.dmgTypes.hasOwnProperty(e.ammoType)&&(e.damageType=t.dmgTypes[e.ammoType]))}),u=c,Object.values(r.default.DMG).forEach(e=>{"EFFECT"!==e&&"DIRECT"!==e&&"HUNGER"!==e&&"MELEE"!==e&&Object.entries(r.default.RESISTANCE).forEach(t=>{const n=t[0],s=o.resistance(e,n),a=10*t[1];s.name="Resistance",s.duration="5d10 + 10";let i="Potion of "+n.toLowerCase()+" "+e.toLowerCase();t[1]===r.default.RESISTANCE.IMMUNITY?i="Potion of "+e.toLowerCase()+" "+n.toLowerCase():t[1]!==r.default.RESISTANCE.ABSORB&&(i+=" resistance");const c={name:i,base:"PotionBase",use:{addComp:s},value:l("potion",a)};u.push(c)})}),function(e){const t=[["",1],[" greater",2]];r.default.STATS.forEach(n=>{const s=n.toLowerCase();t.forEach(t=>{const[n,r]=t,a={name:"Potion of"+n+" "+s,base:"PotionBase",use:{modifyStat:{value:r,statName:s}},value:l("potion",200*r)};e.push(a)})})}(c),c.push(...i.GemItems),t.default=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GemItems=void 0;t.GemItems=[{type:"mineral",base:"MineralBase",name:"Amber",gemType:"Phosphate",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"Yellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Apatite",gemType:"Carbonate",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"GhostWhite",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Azurite",gemType:"Cyclosilicate",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Azure",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Benitoite",gemType:"Beryl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[150]},color:{fg:"Blue",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Aquamarine",gemType:"Beryl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[75,150]},color:{fg:"Aquamarine",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Bixbite",gemType:"Beryl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[300]},color:{fg:"Red",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Emerald",gemType:"Beryl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Heliodor",gemType:"Beryl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"Yellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Goshenite",gemType:"Beryl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"GhostWhite",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Morganite",gemType:"Calcite",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"MistyRose",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Marble",gemType:"Calcite",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"White",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Mexican onyx",gemType:"Calcite",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Ivory",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Charoite",gemType:"Chrysoberyl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Violet",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Alexandrite",gemType:"Chrysoberyl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[150]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Catสผs eye",gemType:"Chrysoberyl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Chrysolite",gemType:"Chrysoberyl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[75]},color:{fg:"Yellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Chrysocolla",gemType:"Chrysoberyl",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Coral",gemType:"Corundum",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Coral",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Ruby",gemType:"Corundum",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[300]},color:{fg:"Red",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Sapphire",gemType:"Corundum",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[150]},color:{fg:"Blue",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Star Sapphire",gemType:"Corundum",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"Red",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Star Ruby",gemType:"Corundum",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"Red",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Cubic zirconia",gemType:"Corundum",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"GhostWhite",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Diamond",gemType:"Feldspar",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[300]},color:{fg:"White",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Amazonite",gemType:"Feldspar",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"DarkSeaGreen",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Labradorite",gemType:"Feldspar",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"DimGray",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Sunstone",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Orange",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Garnet",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"Brown",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Almandine",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"OrangeRed",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Andradite",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"YellowGreen",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Demantoid",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"GreenYellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Topazolite",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"LightYellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Grossular",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"GhostWhite",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Tsavorite",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Hessonite",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"LightGoldenRodYellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Pyrope",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"DeepPink",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Chrome Pyrope",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[75,300]},color:{fg:"HotPink",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Malaia",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"RosyBrown",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Rhodolite",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"MediumPurple",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Spessartine",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"Orange",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Uvarovite",gemType:"Garnet",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"ForestGreen",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Hematite",gemType:"Jade",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Black",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Jadeite",gemType:"Jade",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,300]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Nephrite",gemType:"Jade",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Purple",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Jet",gemType:"lazuli",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Brown",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Lapis lazuli",gemType:"lazuli",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"DarkSlateBlue",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Malachite",gemType:"lazuli",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"DarkGreen",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Moissanite",gemType:"lazuli",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"PaleGreen",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Obsidian",gemType:"lazuli",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Gray",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Opal",gemType:"lazuli",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"OrangeRed",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Peridot",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[75]},color:{fg:"Yellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Agate",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"LightSalmon",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Amethyst",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[75]},color:{fg:"Purple",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Aventurine",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Cairngorm",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Darkorange",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Carnelian",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"IndianRed",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Chalcedony",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"PowderBlue",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Chrysoprase",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Citrine",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Yellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Jasper",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Crimson",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Onyx",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"White",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Petrified wood",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Brown",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Rock crystal",gemType:"Quartz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"GhostWhite",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Rose",gemType:"Other",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Pink",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Tigerสผs eye",gemType:"Carbonate",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"LightGoldenRodYellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Rhodochrosite",gemType:"Inosilicate",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"MistyRose",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Rhodonite",gemType:"Shell",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"DarkRed",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Mother-of-pearl",gemType:"Shell",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"White",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Pearl",gemType:"Shell",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,150]},color:{fg:"White",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Spinel",gemType:"Spodumene",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[75]},color:{fg:"MediumVioletRed",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Hiddenite",gemType:"Spodumene",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[75]},color:{fg:"Yellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Kunzite",gemType:"Spodumene",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Pink",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Tanzanite",gemType:"Topaz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[150]},color:{fg:"lavender",bg:"black"}},{type:"mineral",base:"MineralBase",name:"White Topaz",gemType:"Topaz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"White",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Blue Topaz",gemType:"Topaz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Blue",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Green Topaz",gemType:"Topaz",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Pink Topaz",gemType:"Tourmaline",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"Pink",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Achorite",gemType:"Tourmaline",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"GhostWhite",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Dravite",gemType:"Tourmaline",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Brown",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Indicolite",gemType:"Tourmaline",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"DarkBlue",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Rubellite",gemType:"Tourmaline",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Pink",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Siberite",gemType:"Tourmaline",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Violet",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Verdilite",gemType:"Turquoise",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Green",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Turquoise",gemType:"Other",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"Turquoise",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Unakite",gemType:"Zircon",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30]},color:{fg:"DarkOliveGreen",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Jargon",gemType:"Zircon",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"White",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Matura diamond",gemType:"Zircon",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"GhostWhite",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Yellow Hyacinth",gemType:"Zircon",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"Yellow",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Orange Hyacinth",gemType:"Zircon",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"Orange",bg:"black"}},{type:"mineral",base:"MineralBase",name:"Red Hyacinth",gemType:"Zircon",weight:{$$select:[.1,.2,.4,.8]},value:{$$select:[30,75]},color:{fg:"Red",bg:"black"}}]},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.JobSchedule=t.SchedEntry=void 0;const r=s(n(15)).default("bitn:JobSchedule"),a=n(30),o=n(273),i=n(274);class l{constructor(e){e.needs.forEach(e=>{e.constr&&o.processNeed(e)}),this.entry=e}static create(e){return new l(e)}}t.SchedEntry=l;const c={from:0,to:720,in:{bbox:new a.BBox(0,0,9,9),levelID:0},needs:[i.Needs.Rest]},u={from:720,to:1440,in:{bbox:new a.BBox(70,20,79,27),levelID:0},needs:[i.Needs.FindWeapon]};t.JobSchedule=class{constructor(e){this.name=e,this.entries=[],this.addEntry(c),this.addEntry(u),this._debug=r.enabled}setDebug(e){this._debug=e}dbg(...e){this._debug&&console.log("["+this.name,...e)}addEntry(e){this.entries.forEach(t=>{this.checkOverlap(e,t.entry)}),this.entries.push(new l(e))}getCurrentNeeds(e,t){const n=this.getCurrEntry(t),s=[];if(!n)return s;if(n.in){const t=n.in.bbox;if(!t.hasXY(e.getX(),e.getY())){const n=t.getRandXY();if(s.push(["FollowPath",1,{xy:n,isOneShot:!0}]),this._debug){const t=`${e.getX()},${e.getY()} -> ${n}`;this.dbg("Added one shot entry to FollowPath "+t)}return s}}const{needs:r}=n;for(let n=0;n<r.length;n++){const a=r[n];if(a.func&&a.func(e)){const e=[a.evalName,a.bias];if(a.only)return[e];if(s.push(e),a.last)return s}else if(a.script){const n=a.script(e,t);if(n.length>0){if(a.only)return n;if(s.push(...n),a.last)return s}}}return s}getCurrEntry(e){for(let t=0;t<this.entries.length;t++){const n=this.entries[t].entry;if(n.from<n.to){if(e>=n.from&&e<=n.to)return this._debug&&this.dbg("Found entry:",n),n}else if(e>=n.from||e<=n.to)return this.dbg("Found entry:",n),n}return null}checkOverlap(e,t){t.to,t.from,e.to,e.from}}},function(e,t){e.exports={isProduction:!1,isDevel:!0,showEditor:!0}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(1)),i=n(473)(77);function l(e,t,n,s="&nbsp;"){let r=e-t.length-n;return r<0&&(r=0),s.repeat(n)+t+s.repeat(r)}function c(e,t){const n=[];for(let s=0;s<t;s++){const t=o.createElement("div",{className:"cell-row-div-player-view",key:"id"+s},o.createElement("span",{className:"cell-not-explored",dangerouslySetInnerHTML:{__html:l(e,"",0)}}));n.push(t)}return n}class u extends o.Component{constructor(e){super(e)}menuItemClicked(e){console.log("Clicked menu item "+e),this.props.menuItemClicked(e)}render(){const{menuObj:e,width:t,height:n}=this.props,s=n-3-Object.keys(e).length,r=c(t,3),a=c(t,s),u=Object.keys(e).map(n=>{if("pre"!==n&&"post"!==n){const s=l(t,`[${n}] - ${e[n]} `,3);return o.createElement("div",{className:"cell-row-div-player-view",key:n},o.createElement("span",{className:"game-menu-text-span game-menu-item-select",dangerouslySetInnerHTML:{__html:s},onClick:this.menuItemClicked.bind(this,n)}))}return null});let h=null;e.hasOwnProperty("pre")&&Array.isArray(e.pre)&&(h=e.pre.map(e=>{const t=i(e);return this.renderMenuLines(t)}));let d=null;return e.hasOwnProperty("post")&&Array.isArray(e.post)&&(d=e.post.map(e=>{const t=i(e);return this.renderMenuLines(t)})),o.createElement("div",{className:"game-board game-board-player-view"},r,h,u,d,a)}renderMenuLines(e){const t=e.split("\n").filter(e=>e.length>0),{width:n}=this.props;return t.map((e,t)=>{const s=l(n,""+e,3);return o.createElement("div",{className:"cell-row-div-player-view",key:"menu_line_"+t},o.createElement("span",{className:"game-menu-text-span",dangerouslySetInnerHTML:{__html:s}}))})}}t.default=u},function(e,t){var n={html:{skipScheme:"html",lineBreakScheme:"html",whitespace:"collapse"}},s=/<\s*br(?:[\s/]*|\s[^>]*)>/gi,r={unix:[/\n/g,"\n"],dos:[/\r\n/g,"\r\n"],mac:[/\r/g,"\r"],html:[s,"<br>"],xhtml:[s,"<br/>"]},a={"ansi-color":/\x1B\[[^m]*m/g,html:/<[^>]*>/g,bbcode:/\[[^]]*\]/g},o={soft:1,hard:1},i={collapse:1,default:1,line:1,all:1},l={all:1,multi:1,none:1},c=/([sm])(\d+)/,u=/[-/\\^$*+?.()|[\]{}]/g;function h(e){return e.replace(u,"\\$&")}var d=e.exports=function(e,t,s){"object"==typeof e&&(e=(s=e).start,t=s.stop),"object"==typeof t&&(s=t,e=e||s.start,t=void 0),t||(t=e,e=0),s||(s={});var u,d,p,f,m,g,y,v,b,_,E,S,w,C,O,T,M,A,N="soft",x="default",P=4,I="all",D="",k="";if(u=s.preset)for(u instanceof Array||(u=[u]),A=0;A<u.length;A++){if(!(T=n[u[A]]))throw new TypeError('preset must be one of "'+Object.keys(n).join('", "')+'"');T.mode&&(N=T.mode),T.whitespace&&(x=T.whitespace),void 0!==T.tabWidth&&(P=T.tabWidth),T.skip&&(d=T.skip),T.skipScheme&&(p=T.skipScheme),T.lineBreak&&(f=T.lineBreak),T.lineBreakScheme&&(m=T.lineBreakScheme),T.respectLineBreaks&&(I=T.respectLineBreaks),void 0!==T.preservedLineIndent&&(y=T.preservedLineIndent),void 0!==T.wrapLineIndent&&(v=T.wrapLineIndent),T.wrapLineIndentBase&&(b=T.wrapLineIndentBase)}if(s.mode){if(!o[s.mode])throw new TypeError('mode must be one of "'+Object.keys(o).join('", "')+'"');N=s.mode}if(s.whitespace){if(!i[s.whitespace])throw new TypeError('whitespace must be one of "'+Object.keys(i).join('", "')+'"');x=s.whitespace}if(void 0!==s.tabWidth){if(!(parseInt(s.tabWidth,10)>=0))throw new TypeError("tabWidth must be a non-negative integer");P=parseInt(s.tabWidth,10)}if(O=new Array(P+1).join(" "),s.respectLineBreaks){if(!l[s.respectLineBreaks]&&!c.test(s.respectLineBreaks))throw new TypeError('respectLineBreaks must be one of "'+Object.keys(l).join('", "')+'", "m<num>", "s<num>"');I=s.respectLineBreaks}if("multi"===I)I="m",g=2;else if(!l[I]){var L=c.exec(I);I=L[1],g=parseInt(L[2],10)}if(void 0!==s.preservedLineIndent){if(!(parseInt(s.preservedLineIndent,10)>=0))throw new TypeError("preservedLineIndent must be a non-negative integer");y=parseInt(s.preservedLineIndent,10)}if(y>0&&(D=new Array(y+1).join(" ")),void 0!==s.wrapLineIndent){if(isNaN(parseInt(s.wrapLineIndent,10)))throw new TypeError("wrapLineIndent must be an integer");v=parseInt(s.wrapLineIndent,10)}if(s.wrapLineIndentBase&&(b=s.wrapLineIndentBase),b){if(void 0===v)throw new TypeError("wrapLineIndent must be specified when wrapLineIndentBase is specified");if(b instanceof RegExp)C=b;else{if("string"!=typeof b)throw new TypeError("wrapLineIndentBase must be either a RegExp object or a string");C=new RegExp(h(b))}}else if(v>0)k=new Array(v+1).join(" ");else if(v<0)throw new TypeError("wrapLineIndent must be non-negative when a base is not specified");if(s.skipScheme){if(!a[s.skipScheme])throw new TypeError('skipScheme must be one of "'+Object.keys(a).join('", "')+'"');p=s.skipScheme}if(s.skip&&(d=s.skip),d)if(d instanceof RegExp)(_=d).global||(M="g",_.ignoreCase&&(M+="i"),_.multiline&&(M+="m"),_=new RegExp(_.source,M));else{if("string"!=typeof d)throw new TypeError("skip must be either a RegExp object or a string");_=new RegExp(h(d),"g")}if(!_&&p&&(_=a[p]),s.lineBreakScheme){if(!r[s.lineBreakScheme])throw new TypeError('lineBreakScheme must be one of "'+Object.keys(r).join('", "')+'"');m=s.lineBreakScheme}if(s.lineBreak&&(f=s.lineBreak),m&&(T=r[m])&&(E=T[0],S=T[1]),f)if(f instanceof Array&&(1===f.length?f=f[0]:f.length>=2&&(f[0]instanceof RegExp?(E=f[0],"string"==typeof f[1]&&(S=f[1])):f[1]instanceof RegExp?(E=f[1],"string"==typeof f[0]&&(S=f[0])):"string"==typeof f[0]&&"string"==typeof f[1]?(E=new RegExp(h(f[0]),"g"),S=f[1]):f=f[0])),"string"==typeof f)S=f,E||(E=new RegExp(h(f),"g"));else if(f instanceof RegExp)E=f;else if(!(f instanceof Array))throw new TypeError("lineBreak must be a RegExp object, a string, or an array consisted of a RegExp object and a string");E||(E=/\n/g,S="\n"),M="g",E.ignoreCase&&(M+="i"),E.multiline&&(M+="m"),w=new RegExp("\\s*(?:"+E.source+")(?:"+E.source+"|\\s)*",M),E.global||(E=new RegExp(E.source,M));var R="hard"===N?/\b/:/(\S+\s+)/,B=new Array(e+1).join(" "),F="default"===x||"collapse"===x,G="collapse"===x,j="line"===x,W="all"===x,Y=/\t/g,X=/  +/g,U=/^\s+/,$=/\s+$/,H=/\S/,V=/\s/,K=t-e;return function(n){var s;if(n=n.toString().replace(Y,O),!S){if(E.lastIndex=0,!(s=E.exec(n)))throw new TypeError("Line break string for the output not specified");S=s[0]}var r,a,o,i,l,c,u,h,d,p=0;for(r=[],w.lastIndex=0,s=w.exec(n);s;){if(r.push(n.substring(p,s.index)),"none"!==I){for(o=[],i=0,E.lastIndex=0,a=E.exec(s[0]);a;)o.push(s[0].substring(i,a.index)),i=a.index+a[0].length,a=E.exec(s[0]);o.push(s[0].substring(i)),r.push({type:"break",breaks:o})}else l=G?" ":s[0].replace(E,""),r.push({type:"break",remaining:l});p=s.index+s[0].length,s=w.exec(n)}if(r.push(n.substring(p)),_)for(d=[],c=0;c<r.length;c++){var f=r[c];if("string"!=typeof f)d.push(f);else{for(p=0,_.lastIndex=0,s=_.exec(f);s;)d.push(f.substring(p,s.index)),d.push({type:"skip",value:s[0]}),p=s.index+s[0].length,s=_.exec(f);d.push(f.substring(p))}}else d=r;var m=[];for(c=0;c<d.length;c++){var y=d[c];if("string"!=typeof y)m.push(y);else{G&&(y=y.replace(X," "));var b=y.split(R),T=[];for(u=0;u<b.length;u++){var M=b[u];if("hard"===N)for(h=0;h<M.length;h+=K)T.push(M.slice(h,h+K));else T.push(M)}m=m.concat(T)}}var A,x=0,P=e+D.length,L=[B+D],q=0,z=!0,J=!0,Q=k;function Z(n){var s,r,a,o=L[x];if(W)P>t&&(q=q||t,a=o.length-(P-q),L[x]=o.substring(0,a)),q=0;else{for(s=o.length-1;s>=e&&" "===o[s];)s--;for(;s>=e&&V.test(o[s]);)s--;++s!==o.length&&(L[x]=o.substring(0,s)),J&&z&&j&&P>t&&(a=o.length-(P-t))<s&&(a=s)}if(J&&(J=!1,C&&(s=L[x].substring(e).search(C),Q=s>=0&&s+v>0?new Array(s+v+1).join(" "):"")),a){for(;a+K<o.length;)W?(r=o.substring(a,a+K),L.push(B+Q+r)):L.push(B+Q),a+=K,x++;if(!n)return r=o.substring(a),Q+r;W?(r=o.substring(a),L.push(B+Q+r)):L.push(B+Q),x++}return""}for(c=0;c<m.length;c++){var ee=m[c];if(""!==ee)if("string"==typeof ee){for(var te;;){if(te=void 0,P+ee.length>t&&P+(te=ee.replace($,"")).length>t&&""!==te&&P>e){if(A=Z(!1),L.push(B+Q),x++,P=e+Q.length,A){L[x]+=A,P+=A.length,z=!0;continue}!F&&(!j||J&&z)||(ee=ee.replace(U,"")),z=!1}else z&&(F||j&&(!J||!z)?""!==(ee=ee.replace(U,""))&&(z=!1):H.test(ee)&&(z=!1));break}W&&te&&P+te.length>t&&(q=P+te.length),L[x]+=ee,P+=ee.length}else if("break"===ee.type)if("none"!==I){var ne=ee.breaks,se=ne.length-1;if("s"===I){for(u=0;u<se;u++)ne[u+1].length<g?ne[u+1]=G?" ":ne[u]+ne[u+1]:(W&&(L[x]+=ne[u],P+=ne[u].length),Z(!0),L.push(B+D),x++,P=e+D.length,J=z=!0);(!z||W||j&&J)&&((G||!z&&""===ne[se])&&(ne[se]=" "),L[x]+=ne[se],P+=ne[se].length)}else if("m"===I&&se<g)(!z||W||j&&J)&&(G?ee=" ":(ee=ne.join(""),z||""!==ee||(ee=" ")),L[x]+=ee,P+=ee.length);else if(F){for(Z(!0),u=0;u<se;u++)L.push(B+D),x++;P=e+D.length,J=z=!0}else for((W||J&&z)&&(L[x]+=ne[0],P+=ne[0].length),u=0;u<se;u++)Z(!0),L.push(B+D+ne[u+1]),x++,P=e+D.length+ne[u+1].length,J=z=!0}else(!z||W||j&&J)&&(ee=ee.remaining,(G||!z&&""===ee)&&(ee=" "),L[x]+=ee,P+=ee.length);else"skip"===ee.type&&(P>t&&(A=Z(!1),L.push(B+Q),x++,P=e+Q.length,A&&(L[x]+=A,P+=A.length),z=!0),L[x]+=ee.value)}return Z(!0),L.join(S)}};d.soft=d,d.hard=function(){var e=[].slice.call(arguments),t=e.length-1;return"object"==typeof e[t]?e[t].mode="hard":e.push({mode:"hard"}),d.apply(null,e)},d.wrap=function(e){var t=[].slice.call(arguments);return t.shift(),d.apply(null,t)(e)}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=a(n(1)),l=o(n(70)),c=o(n(189)),u=n(16),h=o(n(4)),d=n(157),p=o(n(59)),f=n(117),m=n(25),[g,y]=[10,10];class v extends i.Component{constructor(e){super(e),this.handleKeyDown=this.handleKeyDown.bind(this),this.toggleScreen=this.toggleScreen.bind(this),this.state={tabShown:"Region"}}shouldComponentUpdate(e,t){if(e.ow!==this.props.ow)return!0;if(this.props.playerOwPos&&e.playerOwPos){if(e.playerOwPos[0]!==this.props.playerOwPos[0])return!0;if(e.playerOwPos[1]!==this.props.playerOwPos[1])return!0}return this.state.tabShown!==t.tabShown}selectTab(e){this.setState({tabShown:e})}handleKeyDown(e){f.KeyCode.getKeyCode(e)===m.Keys.GUI.OwMap&&this.toggleScreen("OWMap")}render(){const e=this.renderTabButtons(),t=this.renderTabElement();return i.createElement(p.default,{"aria-labelledby":"game-overworld-map-modal-label",id:"gameOverWorldMapModal",large:!0,onHide:this.toggleScreen.bind(this,"OWMap"),onKeyDown:this.handleKeyDown,show:this.props.showOWMap},i.createElement(l.default,{id:"game-overworld-map-modal-label",text:"Overworld"}),i.createElement("div",{className:"modal-body row"},i.createElement("div",{className:"col-md-8"},e,t)),i.createElement("div",{className:"modal-footer row"},i.createElement("div",{className:"col-md-4"},i.createElement("button",{className:"btn btn-secondary",onClick:this.toggleScreen.bind(this,"OWMap"),type:"button"},"Close"))))}toggleScreen(e){this.props.toggleScreen(e)}renderTabElement(){return this.props.ow?"World"===this.state.tabShown?this.renderWorldMap():this.renderRegionMap():null}renderWorldMap(){let e="No map generated.";const t=this.props.ow.mapToString(!0).slice();if(this.props.playerOwPos){const[e,n]=this.props.playerOwPos;let s=t[n];s=s.substr(0,e)+"@"+s.substr(e+1),t[n]=s}return e=t.join("\n"),i.createElement("div",null,i.createElement("pre",{className:"game-overworld-map-pre"},e),i.createElement("p",null,"This map helps you to navigate in the world. It shows places of interest as well as the huge mountain walls blocking your passage."))}renderRegionMap(){const e=this.props.ow,t=e.getCellMap();let[n,s]=[null,null];if(this.props.playerOwPos){[n,s]=this.props.playerOwPos;const e=new u.ElementMarker("@");t.getCell(n,s).removeProps(h.default.TYPE_ELEM),t.getCell(n,s).setProp(h.default.TYPE_ELEM,e)}t.getCells(t=>{e.isExplored(t.getXY())&&t.setExplored()});const r=new d.Screen(g,y);r.renderAllVisible(n,s,t);const a=r.getCharRows(),o=r.getClassRows(),l=r.getStartX();return i.createElement(c.default,{boardClassName:"game-board-player-view",charRows:a,classRows:o,endY:r.endY,onCellClick:this.onCellClick,onMouseOverCell:this.onMouseOverCell,rowClass:"cell-row-div-player-view",sizeX:2*r.viewportX+1,startX:l,startY:r.startY,useRLE:!1,renderInAscii:!0})}onCellClick(e,t){console.log(`Clicked cell ${e},${t}`)}onMouseOverCell(e,t){console.log(`Mouse over cell ${e},${t}`)}renderTabButtons(){const e=i.createElement("ul",{className:"modal-tab-list"},i.createElement("button",{className:"tab-select-button",onClick:this.selectTab.bind(this,"Region")},"Region"),i.createElement("button",{className:"tab-select-button",onClick:this.selectTab.bind(this,"World")},"World"));return i.createElement("ul",null,e)}}t.default=v},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(1));class i extends o.Component{shouldComponentUpdate(e){if(this.props.rowClass!==e.rowClass)return!0;const t=this.props.rowClasses.length,n=this.props.rowChars.length;if(t===e.rowClasses.length){if(n===e.rowChars.length)if(this.props.useRLE){for(let n=0;n<t;n++){if(this.props.rowClasses[n][0]!==e.rowClasses[n][0])return!0;if(this.props.rowClasses[n][1]!==e.rowClasses[n][1])return!0}for(let t=0;t<n;t++){if(this.props.rowChars[t][0]!==e.rowChars[t][0])return!0;if(this.props.rowChars[t][1]!==e.rowChars[t][1])return!0}}else{for(let n=0;n<t;n++)if(this.props.rowClasses[n]!==e.rowClasses[n])return!0;for(let t=0;t<n;t++)if(this.props.rowChars[t]!==e.rowChars[t])return!0}return!1}return!0}render(){const e=this.props.y,t=this.props.rowClass;let n=null;return n=this.props.useRLE?this.props.rowClasses.map((t,n)=>{const s=this.props.rowChars[n],r=s[0];return o.createElement("span",{className:t[1],key:e+","+n},s[1].repeat(r))}):this.props.rowClasses.map((t,n)=>{const s=this.props.rowChars[n];return o.createElement("span",{className:t,key:e+","+n},s)}),o.createElement("div",{className:"game-board-row "+t},n)}}t.default=i},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(477)),l=o(n(478)),c=o(n(479)),u=o(n(480)),h=o(n(481)),d=a(n(278)),p=n(42),f={hex:i.default,rect:l.default,tile:c.default,"tile-gl":u.default,term:h.default},m={width:p.DEFAULT_WIDTH,height:p.DEFAULT_HEIGHT,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1};class g{constructor(e={}){this._data={},this._dirty=!1,this._options={},e=Object.assign({},m,e),this.setOptions(e),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(e,t,n){const s=[this._options.bg,this._options.fg];this.draw(e,t,null,null,s[n%s.length])}clear(){this._data={},this._dirty=!0}setOptions(e){if(Object.assign(this._options,e),e.width||e.height||e.fontSize||e.fontFamily||e.spacing||e.layout){if(e.layout){const t=f[e.layout];this._backend=new t}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(e,t){return this._backend.computeSize(e,t)}computeFontSize(e,t){return this._backend.computeFontSize(e,t)}computeTileSize(e,t){return[Math.floor(e/this._options.width),Math.floor(t/this._options.height)]}eventToPosition(e){let t,n;return"touches"in e?(t=e.touches[0].clientX,n=e.touches[0].clientY):(t=e.clientX,n=e.clientY),this._backend.eventToPosition(t,n)}draw(e,t,n,s,r){s||(s=this._options.fg),r||(r=this._options.bg);const a=`${e},${t}`;this._data[a]=[e,t,n,s,r],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[a]=!0)}drawText(e,t,n,s){let r=null,a=null,o=e,i=t,l=1;s||(s=this._options.width-e);const c=d.tokenize(n,s);for(;c.length;){const t=c.shift();switch(t.type){case d.TYPE_TEXT:let n=!1,s=!1,c=!1,u=!1;for(let e=0;e<t.value.length;e++){const l=t.value.charCodeAt(e),h=t.value.charAt(e);if("term"===this._options.layout){const e=l>>8;if(17===e||e>=46&&e<=159||e>=172&&e<=215||l>=43360&&l<=43391){this.draw(o+0,i,h,r,a),this.draw(o+1,i,"\t",r,a),o+=2;continue}}c=l>65280&&l<65377||l>65500&&l<65512||l>65518,n=32==h.charCodeAt(0)||12288==h.charCodeAt(0),!u||c||n||o++,c&&!s&&o++,this.draw(o++,i,h,r,a),s=n,u=c}break;case d.TYPE_FG:r=t.value||null;break;case d.TYPE_BG:a=t.value||null;break;case d.TYPE_NEWLINE:o=e,i++,l++}}return l}_tick(){if(this._backend.schedule(this._tick),this._dirty){if(!0===this._dirty){this._backend.clear();for(const e in this._data)this._draw(e,!1)}else for(const e in this._dirty)this._draw(e,!0);this._dirty=!1}}_draw(e,t){const n=this._data[e];n[4]!=this._options.bg&&(t=!0),this._backend.draw(n,t)}}t.default=g,g.Rect=l.default,g.Hex=i.default,g.Tile=c.default,g.TileGL=u.default,g.Term=h.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(191)),a=n(139);class o extends r.default{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(e,t){const[n,s,r,a,o]=e,i=[(n+1)*this._spacingX,s*this._spacingY+this._hexSize];if(this._options.transpose&&i.reverse(),t&&(this._ctx.fillStyle=o,this._fill(i[0],i[1])),!r)return;this._ctx.fillStyle=a;const l=[].concat(r);for(let e=0;e<l.length;e++)this._ctx.fillText(l[e],i[0],Math.ceil(i[1]))}computeSize(e,t){this._options.transpose&&(e+=t,e-=t=e-t);return[Math.floor(e/this._spacingX)-1,Math.floor((t-2*this._hexSize)/this._spacingY+1)]}computeFontSize(e,t){this._options.transpose&&(e+=t,e-=t=e-t);const n=2*e/((this._options.width+1)*Math.sqrt(3))-1,s=t/(2+1.5*(this._options.height-1));let r=Math.min(n,s);const a=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;const o=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=a;const i=o/100;r=Math.floor(r)+1;const l=2*r/(this._options.spacing*(1+i/Math.sqrt(3)));return Math.ceil(l)-1}_normalizedEventToPosition(e,t){let n;this._options.transpose?(e+=t,e-=t=e-t,n=this._ctx.canvas.width):n=this._ctx.canvas.height;const s=n/this._options.height;return t=Math.floor(t/s),a.mod(t,2)?(e-=this._spacingX,e=1+2*Math.floor(e/(2*this._spacingX))):e=2*Math.floor(e/(2*this._spacingX)),[e,t]}_fill(e,t){const n=this._hexSize,s=this._options.border,r=this._ctx;r.beginPath(),this._options.transpose?(r.moveTo(e-n+s,t),r.lineTo(e-n/2+s,t+this._spacingX-s),r.lineTo(e+n/2-s,t+this._spacingX-s),r.lineTo(e+n-s,t),r.lineTo(e+n/2-s,t-this._spacingX+s),r.lineTo(e-n/2+s,t-this._spacingX+s),r.lineTo(e-n+s,t)):(r.moveTo(e,t-n+s),r.lineTo(e+this._spacingX-s,t-n/2+s),r.lineTo(e+this._spacingX-s,t+n/2-s),r.lineTo(e,t+n-s),r.lineTo(e-this._spacingX+s,t+n/2-s),r.lineTo(e-this._spacingX+s,t-n/2+s),r.lineTo(e,t-n+s)),r.fill()}_updateSize(){const e=this._options,t=Math.ceil(this._ctx.measureText("W").width);let n,s;this._hexSize=Math.floor(e.spacing*(e.fontSize+t/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,e.transpose?(n="height",s="width"):(n="width",s="height"),this._ctx.canvas[n]=Math.ceil((e.width+1)*this._spacingX),this._ctx.canvas[s]=Math.ceil((e.height-1)*this._spacingY+2*this._hexSize)}}t.default=o},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(191));class a extends r.default{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(e){super.setOptions(e),this._canvasCache={}}draw(e,t){a.cache?this._drawWithCache(e):this._drawNoCache(e,t)}_drawWithCache(e){const[t,n,s,r,a]=e,o=""+s+r+a;let i;if(o in this._canvasCache)i=this._canvasCache[o];else{const e=this._options.border;i=document.createElement("canvas");const t=i.getContext("2d");if(i.width=this._spacingX,i.height=this._spacingY,t.fillStyle=a,t.fillRect(e,e,i.width-e,i.height-e),s){t.fillStyle=r,t.font=this._ctx.font,t.textAlign="center",t.textBaseline="middle";const e=[].concat(s);for(let n=0;n<e.length;n++)t.fillText(e[n],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[o]=i}this._ctx.drawImage(i,t*this._spacingX,n*this._spacingY)}_drawNoCache(e,t){const[n,s,r,a,o]=e;if(t){const e=this._options.border;this._ctx.fillStyle=o,this._ctx.fillRect(n*this._spacingX+e,s*this._spacingY+e,this._spacingX-e,this._spacingY-e)}if(!r)return;this._ctx.fillStyle=a;const i=[].concat(r);for(let e=0;e<i.length;e++)this._ctx.fillText(i[e],(n+.5)*this._spacingX,Math.ceil((s+.5)*this._spacingY))}computeSize(e,t){return[Math.floor(e/this._spacingX),Math.floor(t/this._spacingY)]}computeFontSize(e,t){const n=Math.floor(e/this._options.width);let s=Math.floor(t/this._options.height);const r=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;const a=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=r;const o=a/100*s/n;return o>1&&(s=Math.floor(s/o)),Math.floor(s/this._options.spacing)}_normalizedEventToPosition(e,t){return[Math.floor(e/this._spacingX),Math.floor(t/this._spacingY)]}_updateSize(){const e=this._options,t=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(e.spacing*t),this._spacingY=Math.ceil(e.spacing*e.fontSize),e.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=e.width*this._spacingX,this._ctx.canvas.height=e.height*this._spacingY}}t.default=a,a.cache=!1},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(191));class a extends r.default{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(e,t){const[n,s,r,a,o]=e,i=this._options.tileWidth,l=this._options.tileHeight;if(t&&(this._options.tileColorize?this._ctx.clearRect(n*i,s*l,i,l):(this._ctx.fillStyle=o,this._ctx.fillRect(n*i,s*l,i,l))),!r)return;const c=[].concat(r),u=[].concat(a),h=[].concat(o);for(let r=0;r<c.length;r++){const a=this._options.tileMap[c[r]];if(a)if(this._options.tileColorize){const e=this._colorCanvas,t=e.getContext("2d");t.globalCompositeOperation="source-over",t.clearRect(0,0,i,l);const o=u[r],c=h[r];t.drawImage(this._options.tileSet,a[0],a[1],i,l,0,0,i,l),"transparent"!==o&&(t.fillStyle=o,t.globalCompositeOperation="source-atop",t.fillRect(0,0,i,l)),"transparent"!==c&&(t.fillStyle=c,t.globalCompositeOperation="destination-over",t.fillRect(0,0,i,l)),this._ctx.drawImage(e,n*i,s*l,i,l)}else this._ctx.drawImage(this._options.tileSet,a[0],a[1],i,l,n*i,s*l,i,l);else this._drawChar(e,t)}}_drawChar(e,t){const[n,s,r,a,o]=e,i=this._options.tileWidth,l=this._options.tileHeight;if(t){const e=this._options.border;this._ctx.fillStyle=o,this._ctx.fillRect(n*i+e,s*l+e,i-e,l-e)}if(!r)return;this._ctx.fillStyle=a;const c=[].concat(r);for(let e=0;e<c.length;e++)this._ctx.fillText(c[e],(n+.5)*i,Math.ceil((s+.5)*l))}computeSize(e,t){return[Math.floor(e/this._options.tileWidth),Math.floor(t/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}_normalizedEventToPosition(e,t){return[Math.floor(e/this._options.tileWidth),Math.floor(t/this._options.tileHeight)]}_updateSize(){const e=this._options;this._ctx.canvas.width=e.width*e.tileWidth,this._ctx.canvas.height=e.height*e.tileHeight,this._colorCanvas.width=e.tileWidth,this._colorCanvas.height=e.tileHeight}}t.default=a},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(192)),l=a(n(140));class c extends i.default{constructor(){super(),this._uniforms={};try{this._gl=this._initWebGL()}catch(e){alert(e.message)}}static isSupported(){return!!document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0})}schedule(e){requestAnimationFrame(e)}getContainer(){return this._gl.canvas}setOptions(e){super.setOptions(e),this._updateSize();const t=this._options.tileSet;t&&"complete"in t&&!t.complete?t.addEventListener("load",()=>this._updateTexture(t)):this._updateTexture(t)}draw(e,t){const n=this._gl,s=this._options,[r,a,o,i,l]=e,c=n.canvas.height-(a+1)*s.tileHeight;if(n.scissor(r*s.tileWidth,c,s.tileWidth,s.tileHeight),t&&(s.tileColorize?n.clearColor(0,0,0,0):n.clearColor(...f(l)),n.clear(n.COLOR_BUFFER_BIT)),!o)return;const u=[].concat(o),h=[].concat(l),d=[].concat(i);n.uniform2fv(this._uniforms.targetPosRel,[r,a]);for(let e=0;e<u.length;e++){const t=this._options.tileMap[u[e]];if(!t)throw new Error(`Char "${u[e]}" not found in tileMap`);n.uniform1f(this._uniforms.colorize,s.tileColorize?1:0),n.uniform2fv(this._uniforms.tilesetPosAbs,t),s.tileColorize&&(n.uniform4fv(this._uniforms.tint,f(d[e])),n.uniform4fv(this._uniforms.bg,f(h[e]))),n.drawArrays(n.TRIANGLE_STRIP,0,4)}}clear(){const e=this._gl;e.clearColor(...f(this._options.bg)),e.scissor(0,0,e.canvas.width,e.canvas.height),e.clear(e.COLOR_BUFFER_BIT)}computeSize(e,t){return[Math.floor(e/this._options.tileWidth),Math.floor(t/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}eventToPosition(e,t){const n=this._gl.canvas,s=n.getBoundingClientRect();return e-=s.left,t-=s.top,e*=n.width/s.width,t*=n.height/s.height,e<0||t<0||e>=n.width||t>=n.height?[-1,-1]:this._normalizedEventToPosition(e,t)}_initWebGL(){const e=document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0});window.gl=e;const t=function(e,t,n){const s=e.createShader(e.VERTEX_SHADER);if(e.shaderSource(s,t),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(s)||"");const r=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(r,n),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(r)||"");const a=e.createProgram();if(e.attachShader(a,s),e.attachShader(a,r),e.linkProgram(a),!e.getProgramParameter(a,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(a)||"");return a}(e,h,d);return e.useProgram(t),function(e){const t=new Float32Array([0,0,1,0,0,1,1,1]),n=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0)}(e),u.forEach(n=>this._uniforms[n]=e.getUniformLocation(t,n)),this._program=t,e.enable(e.BLEND),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e.enable(e.SCISSOR_TEST),e}_normalizedEventToPosition(e,t){return[Math.floor(e/this._options.tileWidth),Math.floor(t/this._options.tileHeight)]}_updateSize(){const e=this._gl,t=this._options,n=[t.width*t.tileWidth,t.height*t.tileHeight];e.canvas.width=n[0],e.canvas.height=n[1],e.viewport(0,0,n[0],n[1]),e.uniform2fv(this._uniforms.tileSize,[t.tileWidth,t.tileHeight]),e.uniform2fv(this._uniforms.targetSize,n)}_updateTexture(e){!function(e,t){const n=e.createTexture();e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t)}(this._gl,e)}}t.default=c;const u=["targetPosRel","tilesetPosAbs","tileSize","targetSize","colorize","bg","tint"],h="\n#version 300 es\n\nin vec2 tilePosRel;\nout vec2 tilesetPosPx;\n\nuniform vec2 tilesetPosAbs;\nuniform vec2 tileSize;\nuniform vec2 targetSize;\nuniform vec2 targetPosRel;\n\nvoid main() {\n\tvec2 targetPosPx = (targetPosRel + tilePosRel) * tileSize;\n\tvec2 targetPosNdc = ((targetPosPx / targetSize)-0.5)*2.0;\n\ttargetPosNdc.y *= -1.0;\n\n\tgl_Position = vec4(targetPosNdc, 0.0, 1.0);\n\ttilesetPosPx = tilesetPosAbs + tilePosRel * tileSize;\n}".trim(),d="\n#version 300 es\nprecision highp float;\n\nin vec2 tilesetPosPx;\nout vec4 fragColor;\nuniform sampler2D image;\nuniform bool colorize;\nuniform vec4 bg;\nuniform vec4 tint;\n\nvoid main() {\n\tfragColor = vec4(0, 0, 0, 1);\n\n\tvec4 texel = texelFetch(image, ivec2(tilesetPosPx), 0);\n\n\tif (colorize) {\n\t\ttexel.rgb = tint.a * tint.rgb + (1.0-tint.a) * texel.rgb;\n\t\tfragColor.rgb = texel.a*texel.rgb + (1.0-texel.a)*bg.rgb;\n\t\tfragColor.a = texel.a + (1.0-texel.a)*bg.a;\n\t} else {\n\t\tfragColor = texel;\n\t}\n}".trim();const p={};function f(e){if(!(e in p)){let t;if("transparent"==e)t=[0,0,0,0];else if(e.indexOf("rgba")>-1){t=(e.match(/[\d.]+/g)||[]).map(Number);for(let e=0;e<3;e++)t[e]=t[e]/255}else t=l.fromString(e).map(e=>e/255),t.push(1);p[e]=t}return p[e]}},function(e,t,n){"use strict";(function(e){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(n(192)),l=a(n(140));function c(e){const t=l.fromString(e);return 36*Math.floor(t[0]*(6/256))+6*Math.floor(t[1]*(6/256))+1*Math.floor(t[2]*(6/256))+16}class u extends i.default{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(e){setTimeout(e,1e3/60)}setOptions(e){super.setOptions(e);const t=[e.width,e.height],n=this.computeSize();this._offset=n.map((e,n)=>Math.floor((e-t[n])/2))}clear(){e.stdout.write(`[0;48;5;${c(this._options.bg)}m[2J`)}draw(t,n){let[s,r,a,o,i]=t;const l=this._offset[0]+s,u=this._offset[1]+r,h=this.computeSize();if(l<0||l>=h[0])return;if(u<0||u>=h[1])return;if(l===this._cursor[0]&&u===this._cursor[1]||(e.stdout.write(function(e,t){return`[${t+1};${e+1}H`}(l,u)),this._cursor[0]=l,this._cursor[1]=u),n&&(a||(a=" ")),!a)return;const d=function(e,t){return`[0;38;5;${c(e)};48;5;${c(t)}m`}(o,i);if(d!==this._lastColor&&(e.stdout.write(d),this._lastColor=d),"\t"!=a){const t=[].concat(a);e.stdout.write(t[0])}this._cursor[0]++,this._cursor[0]>=h[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw new Error("Terminal backend has no notion of font size")}eventToPosition(e,t){return[e,t]}computeSize(){return[e.stdout.columns,e.stdout.rows]}}t.default=u}).call(this,n(43))},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(22));t.default=class{constructor(e){this._options={words:!1,order:3,prior:.001},Object.assign(this._options,e),this._boundary=String.fromCharCode(0),this._suffix=this._boundary,this._prefix=[];for(let e=0;e<this._options.order;e++)this._prefix.push(this._boundary);this._priorValues={},this._priorValues[this._boundary]=this._options.prior,this._data={}}clear(){this._data={},this._priorValues={}}generate(){const e=[this._sample(this._prefix)];for(;e[e.length-1]!=this._boundary;)e.push(this._sample(e));return this._join(e.slice(0,-1))}observe(e){let t=this._split(e);for(let e=0;e<t.length;e++)this._priorValues[t[e]]=this._options.prior;t=this._prefix.concat(t).concat(this._suffix);for(let e=this._options.order;e<t.length;e++){const n=t.slice(e-this._options.order,e),s=t[e];for(let e=0;e<n.length;e++){const t=n.slice(e);this._observeEvent(t,s)}}}getStats(){const e=[];let t=Object.keys(this._priorValues).length;t--,e.push("distinct samples: "+t);const n=Object.keys(this._data).length;let s=0;for(const e in this._data)s+=Object.keys(this._data[e]).length;return e.push("dictionary size (contexts): "+n),e.push("dictionary size (events): "+s),e.join(", ")}_split(e){return e.split(this._options.words?/\s+/:"")}_join(e){return e.join(this._options.words?" ":"")}_observeEvent(e,t){const n=this._join(e);n in this._data||(this._data[n]={});const s=this._data[n];t in s||(s[t]=0),s[t]++}_sample(e){e=this._backoff(e);const t=this._join(e),n=this._data[t];let s={};if(this._options.prior){for(const e in this._priorValues)s[e]=this._priorValues[e];for(const e in n)s[e]+=n[e]}else s=n;return r.default.getWeightedValue(s)}_backoff(e){for(e.length>this._options.order?e=e.slice(-this._options.order):e.length<this._options.order&&(e=this._prefix.slice(0,this._options.order-e.length).concat(e));!(this._join(e)in this._data)&&e.length>0;)e=e.slice(1);return e}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=n(484);t.default=class{constructor(){this._time=0,this._events=new s.MinHeap}getTime(){return this._time}clear(){return this._events=new s.MinHeap,this}add(e,t){this._events.push(e,t)}get(){if(!this._events.len())return null;const{key:e,value:t}=this._events.pop();return e>0&&(this._time+=e,this._events.shift(-e)),t}getEventTime(e){const t=this._events.find(e);if(t){const{key:e}=t;return e}}remove(e){return this._events.remove(e)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MinHeap=void 0;t.MinHeap=class{constructor(){this.heap=[],this.timestamp=0}lessThan(e,t){return e.key===t.key?e.timestamp<t.timestamp:e.key<t.key}shift(e){this.heap=this.heap.map(({key:t,value:n,timestamp:s})=>({key:t+e,value:n,timestamp:s}))}len(){return this.heap.length}push(e,t){this.timestamp+=1;const n=this.len();this.heap.push({value:e,timestamp:this.timestamp,key:t}),this.updateUp(n)}pop(){if(0===this.len())throw new Error("no element to pop");const e=this.heap[0];return this.len()>1?(this.heap[0]=this.heap.pop(),this.updateDown(0)):this.heap.pop(),e}find(e){for(let t=0;t<this.len();t++)if(e===this.heap[t].value)return this.heap[t];return null}remove(e){let t=null;for(let n=0;n<this.len();n++)e===this.heap[n].value&&(t=n);if(null!==t){if(this.len()>1){const e=this.heap.pop();return this.heap[t]=e,this.updateDown(t),!0}return this.heap.pop(),!0}return!1}parentNode(e){return Math.floor((e-1)/2)}leftChildNode(e){return 2*e+1}rightChildNode(e){return 2*e+2}existNode(e){return e>=0&&e<this.heap.length}swap(e,t){const n=this.heap[e];this.heap[e]=this.heap[t],this.heap[t]=n}minNode(e){const t=e.filter(this.existNode.bind(this));let n=t[0];for(const e of t)this.lessThan(this.heap[e],this.heap[n])&&(n=e);return n}updateUp(e){if(0===e)return;const t=this.parentNode(e);this.existNode(t)&&this.lessThan(this.heap[e],this.heap[t])&&(this.swap(e,t),this.updateUp(t))}updateDown(e){const t=this.leftChildNode(e),n=this.rightChildNode(e);if(!this.existNode(t))return;const s=this.minNode([e,t,n]);s!=e&&(this.swap(e,s),this.updateDown(s))}debugPrint(){console.log(this.heap)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(486)),a=s(n(487)),o=s(n(488));t.default={DiscreteShadowcasting:r.default,PreciseShadowcasting:a.default,RecursiveShadowcasting:o.default}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(193));class a extends r.default{compute(e,t,n,s){if(s(e,t,0,1),!this._lightPasses(e,t))return;const r=[];let a,o,i,l,c;for(let u=1;u<=n;u++){const n=this._getCircle(e,t,u),h=360/n.length;for(let e=0;e<n.length;e++)if(i=n[e][0],l=n[e][1],a=h*(e-.5),o=a+h,c=!this._lightPasses(i,l),this._visibleCoords(Math.floor(a),Math.ceil(o),c,r)&&s(i,l,u,1),2==r.length&&0==r[0]&&360==r[1])return}}_visibleCoords(e,t,n,s){if(e<0){const r=this._visibleCoords(0,t,n,s),a=this._visibleCoords(360+e,360,n,s);return r||a}let r=0;for(;r<s.length&&s[r]<e;)r++;if(r==s.length)return n&&s.push(e,t),!0;let a=0;if(r%2){for(;r<s.length&&s[r]<t;)r++,a++;return 0!=a&&(n&&(a%2?s.splice(r-a,a,t):s.splice(r-a,a)),!0)}for(;r<s.length&&s[r]<t;)r++,a++;return(e!=s[r-a]||1!=a)&&(n&&(a%2?s.splice(r-a,a,e):s.splice(r-a,a,e,t)),!0)}}t.default=a},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(193));class a extends r.default{compute(e,t,n,s){if(s(e,t,0,1),!this._lightPasses(e,t))return;const r=[];let a,o,i,l,c,u;for(let h=1;h<=n;h++){const n=this._getCircle(e,t,h),d=n.length;for(let e=0;e<d;e++)if(a=n[e][0],o=n[e][1],l=[e?2*e-1:2*d-1,2*d],c=[2*e+1,2*d],i=!this._lightPasses(a,o),u=this._checkVisibility(l,c,i,r),u&&s(a,o,h,u),2==r.length&&0==r[0][0]&&r[1][0]==r[1][1])return}}_checkVisibility(e,t,n,s){if(e[0]>t[0]){return(this._checkVisibility(e,[e[1],e[1]],n,s)+this._checkVisibility([0,1],t,n,s))/2}let r=0,a=!1;for(;r<s.length;){const t=s[r],n=t[0]*e[1]-e[0]*t[1];if(n>=0){0!=n||r%2||(a=!0);break}r++}let o=s.length,i=!1;for(;o--;){const e=s[o],n=t[0]*e[1]-e[0]*t[1];if(n>=0){0==n&&o%2&&(i=!0);break}}let l,c=!0;if((r==o&&(a||i)||a&&i&&r+1==o&&o%2||r>o&&r%2)&&(c=!1),!c)return 0;const u=o-r+1;if(u%2)if(r%2){const e=s[r];l=(t[0]*e[1]-e[0]*t[1])/(e[1]*t[1]),n&&s.splice(r,u,t)}else{const t=s[o];l=(t[0]*e[1]-e[0]*t[1])/(e[1]*t[1]),n&&s.splice(r,u,e)}else{if(!(r%2))return n&&s.splice(r,u,e,t),1;{const e=s[r],t=s[o];l=(t[0]*e[1]-e[0]*t[1])/(e[1]*t[1]),n&&s.splice(r,u)}}return l/((t[0]*e[1]-e[0]*t[1])/(e[1]*t[1]))}}t.default=a},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(193)),a=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]];class o extends r.default{compute(e,t,n,s){s(e,t,0,1);for(let r=0;r<a.length;r++)this._renderOctant(e,t,a[r],n,s)}compute180(e,t,n,s,r){r(e,t,0,1);const o=(s-1+8)%8,i=(s-2+8)%8,l=(s+1+8)%8;this._renderOctant(e,t,a[i],n,r),this._renderOctant(e,t,a[o],n,r),this._renderOctant(e,t,a[s],n,r),this._renderOctant(e,t,a[l],n,r)}compute90(e,t,n,s,r){r(e,t,0,1);const o=(s-1+8)%8;this._renderOctant(e,t,a[s],n,r),this._renderOctant(e,t,a[o],n,r)}_renderOctant(e,t,n,s,r){this._castVisibility(e,t,1,1,0,s+1,n[0],n[1],n[2],n[3],r)}_castVisibility(e,t,n,s,r,a,o,i,l,c,u){if(!(s<r))for(let h=n;h<=a;h++){let n=-h-1;const d=-h;let p=!1,f=0;for(;n<=0;){n+=1;const m=e+n*o+d*i,g=t+n*l+d*c,y=(n-.5)/(d+.5),v=(n+.5)/(d-.5);if(!(v>s)){if(y<r)break;if(n*n+d*d<a*a&&u(m,g,h,1),p){if(!this._lightPasses(m,g)){f=v;continue}p=!1,s=f}else!this._lightPasses(m,g)&&h<a&&(p=!0,this._castVisibility(e,t,h+1,s,y,a,o,i,l,c,u),f=v)}}if(p)break}}}t.default=o},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(40));class a extends r.default{create(e){const t=this._width-1,n=this._height-1;for(let s=0;s<=t;s++)for(let r=0;r<=n;r++){e(s,r,s&&r&&s<t&&r<n?0:1)}return this}}t.default=a},function(e,t,n){var s=n(491);e.exports={Graph:s.Graph,json:n(617),alg:n(618),version:s.version}},function(e,t,n){e.exports={Graph:n(194),version:n(616)}},function(e,t,n){var s=n(493);e.exports=function(e){return s(e,4)}},function(e,t,n){var s=n(195),r=n(199),a=n(284),o=n(522),i=n(528),l=n(531),c=n(532),u=n(533),h=n(534),d=n(293),p=n(535),f=n(95),m=n(539),g=n(540),y=n(545),v=n(20),b=n(115),_=n(546),E=n(75),S=n(548),w=n(76),C=n(205),O={};O["[object Arguments]"]=O["[object Array]"]=O["[object ArrayBuffer]"]=O["[object DataView]"]=O["[object Boolean]"]=O["[object Date]"]=O["[object Float32Array]"]=O["[object Float64Array]"]=O["[object Int8Array]"]=O["[object Int16Array]"]=O["[object Int32Array]"]=O["[object Map]"]=O["[object Number]"]=O["[object Object]"]=O["[object RegExp]"]=O["[object Set]"]=O["[object String]"]=O["[object Symbol]"]=O["[object Uint8Array]"]=O["[object Uint8ClampedArray]"]=O["[object Uint16Array]"]=O["[object Uint32Array]"]=!0,O["[object Error]"]=O["[object Function]"]=O["[object WeakMap]"]=!1,e.exports=function e(t,n,T,M,A,N){var x,P=1&n,I=2&n,D=4&n;if(T&&(x=A?T(t,M,A,N):T(t)),void 0!==x)return x;if(!E(t))return t;var k=v(t);if(k){if(x=m(t),!P)return c(t,x)}else{var L=f(t),R="[object Function]"==L||"[object GeneratorFunction]"==L;if(b(t))return l(t,P);if("[object Object]"==L||"[object Arguments]"==L||R&&!A){if(x=I||R?{}:y(t),!P)return I?h(t,i(x,t)):u(t,o(x,t))}else{if(!O[L])return A?t:{};x=g(t,L,P)}}N||(N=new s);var B=N.get(t);if(B)return B;N.set(t,x),S(t)?t.forEach((function(s){x.add(e(s,n,T,s,t,N))})):_(t)&&t.forEach((function(s,r){x.set(r,e(s,n,T,r,t,N))}));var F=k?void 0:(D?I?p:d:I?C:w)(t);return r(F||t,(function(s,r){F&&(s=t[r=s]),a(x,r,e(s,n,T,r,t,N))})),x}},function(e,t){e.exports=function(){this.__data__=[],this.size=0}},function(e,t,n){var s=n(142),r=Array.prototype.splice;e.exports=function(e){var t=this.__data__,n=s(t,e);return!(n<0)&&(n==t.length-1?t.pop():r.call(t,n,1),--this.size,!0)}},function(e,t,n){var s=n(142);e.exports=function(e){var t=this.__data__,n=s(t,e);return n<0?void 0:t[n][1]}},function(e,t,n){var s=n(142);e.exports=function(e){return s(this.__data__,e)>-1}},function(e,t,n){var s=n(142);e.exports=function(e,t){var n=this.__data__,r=s(n,e);return r<0?(++this.size,n.push([e,t])):n[r][1]=t,this}},function(e,t,n){var s=n(141);e.exports=function(){this.__data__=new s,this.size=0}},function(e,t){e.exports=function(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n}},function(e,t){e.exports=function(e){return this.__data__.get(e)}},function(e,t){e.exports=function(e){return this.__data__.has(e)}},function(e,t,n){var s=n(141),r=n(197),a=n(198);e.exports=function(e,t){var n=this.__data__;if(n instanceof s){var o=n.__data__;if(!r||o.length<199)return o.push([e,t]),this.size=++n.size,this;n=this.__data__=new a(o)}return n.set(e,t),this.size=n.size,this}},function(e,t,n){var s=n(143),r=n(507),a=n(75),o=n(283),i=/^\[object .+?Constructor\]$/,l=Function.prototype,c=Object.prototype,u=l.toString,h=c.hasOwnProperty,d=RegExp("^"+u.call(h).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=function(e){return!(!a(e)||r(e))&&(s(e)?d:i).test(o(e))}},function(e,t,n){var s=n(94),r=Object.prototype,a=r.hasOwnProperty,o=r.toString,i=s?s.toStringTag:void 0;e.exports=function(e){var t=a.call(e,i),n=e[i];try{e[i]=void 0;var s=!0}catch(e){}var r=o.call(e);return s&&(t?e[i]=n:delete e[i]),r}},function(e,t){var n=Object.prototype.toString;e.exports=function(e){return n.call(e)}},function(e,t,n){var s,r=n(508),a=(s=/[^.]+$/.exec(r&&r.keys&&r.keys.IE_PROTO||""))?"Symbol(src)_1."+s:"";e.exports=function(e){return!!a&&a in e}},function(e,t,n){var s=n(44)["__core-js_shared__"];e.exports=s},function(e,t){e.exports=function(e,t){return null==e?void 0:e[t]}},function(e,t,n){var s=n(511),r=n(141),a=n(197);e.exports=function(){this.size=0,this.__data__={hash:new s,map:new(a||r),string:new s}}},function(e,t,n){var s=n(512),r=n(513),a=n(514),o=n(515),i=n(516);function l(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var s=e[t];this.set(s[0],s[1])}}l.prototype.clear=s,l.prototype.delete=r,l.prototype.get=a,l.prototype.has=o,l.prototype.set=i,e.exports=l},function(e,t,n){var s=n(144);e.exports=function(){this.__data__=s?s(null):{},this.size=0}},function(e,t){e.exports=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}},function(e,t,n){var s=n(144),r=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;if(s){var n=t[e];return"__lodash_hash_undefined__"===n?void 0:n}return r.call(t,e)?t[e]:void 0}},function(e,t,n){var s=n(144),r=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;return s?void 0!==t[e]:r.call(t,e)}},function(e,t,n){var s=n(144);e.exports=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=s&&void 0===t?"__lodash_hash_undefined__":t,this}},function(e,t,n){var s=n(145);e.exports=function(e){var t=s(this,e).delete(e);return this.size-=t?1:0,t}},function(e,t){e.exports=function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}},function(e,t,n){var s=n(145);e.exports=function(e){return s(this,e).get(e)}},function(e,t,n){var s=n(145);e.exports=function(e){return s(this,e).has(e)}},function(e,t,n){var s=n(145);e.exports=function(e,t){var n=s(this,e),r=n.size;return n.set(e,t),this.size+=n.size==r?0:1,this}},function(e,t,n){var s=n(146),r=n(76);e.exports=function(e,t){return e&&s(t,r(t),e)}},function(e,t){e.exports=function(e,t){for(var n=-1,s=Array(e);++n<e;)s[n]=t(n);return s}},function(e,t,n){var s=n(93),r=n(56);e.exports=function(e){return r(e)&&"[object Arguments]"==s(e)}},function(e,t){e.exports=function(){return!1}},function(e,t,n){var s=n(93),r=n(201),a=n(56),o={};o["[object Float32Array]"]=o["[object Float64Array]"]=o["[object Int8Array]"]=o["[object Int16Array]"]=o["[object Int32Array]"]=o["[object Uint8Array]"]=o["[object Uint8ClampedArray]"]=o["[object Uint16Array]"]=o["[object Uint32Array]"]=!0,o["[object Arguments]"]=o["[object Array]"]=o["[object ArrayBuffer]"]=o["[object Boolean]"]=o["[object DataView]"]=o["[object Date]"]=o["[object Error]"]=o["[object Function]"]=o["[object Map]"]=o["[object Number]"]=o["[object Object]"]=o["[object RegExp]"]=o["[object Set]"]=o["[object String]"]=o["[object WeakMap]"]=!1,e.exports=function(e){return a(e)&&r(e.length)&&!!o[s(e)]}},function(e,t,n){var s=n(289)(Object.keys,Object);e.exports=s},function(e,t,n){var s=n(146),r=n(205);e.exports=function(e,t){return e&&s(t,r(t),e)}},function(e,t,n){var s=n(75),r=n(149),a=n(530),o=Object.prototype.hasOwnProperty;e.exports=function(e){if(!s(e))return a(e);var t=r(e),n=[];for(var i in e)("constructor"!=i||!t&&o.call(e,i))&&n.push(i);return n}},function(e,t){e.exports=function(e){var t=[];if(null!=e)for(var n in Object(e))t.push(n);return t}},function(e,t,n){(function(e){var s=n(44),r=t&&!t.nodeType&&t,a=r&&"object"==typeof e&&e&&!e.nodeType&&e,o=a&&a.exports===r?s.Buffer:void 0,i=o?o.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var n=e.length,s=i?i(n):new e.constructor(n);return e.copy(s),s}}).call(this,n(200)(e))},function(e,t){e.exports=function(e,t){var n=-1,s=e.length;for(t||(t=Array(s));++n<s;)t[n]=e[n];return t}},function(e,t,n){var s=n(146),r=n(206);e.exports=function(e,t){return s(e,r(e),t)}},function(e,t,n){var s=n(146),r=n(292);e.exports=function(e,t){return s(e,r(e),t)}},function(e,t,n){var s=n(294),r=n(292),a=n(205);e.exports=function(e){return s(e,a,r)}},function(e,t,n){var s=n(74)(n(44),"DataView");e.exports=s},function(e,t,n){var s=n(74)(n(44),"Promise");e.exports=s},function(e,t,n){var s=n(74)(n(44),"WeakMap");e.exports=s},function(e,t){var n=Object.prototype.hasOwnProperty;e.exports=function(e){var t=e.length,s=new e.constructor(t);return t&&"string"==typeof e[0]&&n.call(e,"index")&&(s.index=e.index,s.input=e.input),s}},function(e,t,n){var s=n(209),r=n(541),a=n(542),o=n(543),i=n(544);e.exports=function(e,t,n){var l=e.constructor;switch(t){case"[object ArrayBuffer]":return s(e);case"[object Boolean]":case"[object Date]":return new l(+e);case"[object DataView]":return r(e,n);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return i(e,n);case"[object Map]":return new l;case"[object Number]":case"[object String]":return new l(e);case"[object RegExp]":return a(e);case"[object Set]":return new l;case"[object Symbol]":return o(e)}}},function(e,t,n){var s=n(209);e.exports=function(e,t){var n=t?s(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)}},function(e,t){var n=/\w*$/;e.exports=function(e){var t=new e.constructor(e.source,n.exec(e));return t.lastIndex=e.lastIndex,t}},function(e,t,n){var s=n(94),r=s?s.prototype:void 0,a=r?r.valueOf:void 0;e.exports=function(e){return a?Object(a.call(e)):{}}},function(e,t,n){var s=n(209);e.exports=function(e,t){var n=t?s(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}},function(e,t,n){var s=n(297),r=n(208),a=n(149);e.exports=function(e){return"function"!=typeof e.constructor||a(e)?{}:s(r(e))}},function(e,t,n){var s=n(547),r=n(202),a=n(203),o=a&&a.isMap,i=o?r(o):s;e.exports=i},function(e,t,n){var s=n(95),r=n(56);e.exports=function(e){return r(e)&&"[object Map]"==s(e)}},function(e,t,n){var s=n(549),r=n(202),a=n(203),o=a&&a.isSet,i=o?r(o):s;e.exports=i},function(e,t,n){var s=n(95),r=n(56);e.exports=function(e){return r(e)&&"[object Set]"==s(e)}},function(e,t,n){e.exports=n(551)},function(e,t,n){var s=n(199),r=n(150),a=n(555),o=n(20);e.exports=function(e,t){return(o(e)?s:r)(e,a(t))}},function(e,t,n){var s=n(553)();e.exports=s},function(e,t){e.exports=function(e){return function(t,n,s){for(var r=-1,a=Object(t),o=s(t),i=o.length;i--;){var l=o[e?i:++r];if(!1===n(a[l],l,a))break}return t}}},function(e,t,n){var s=n(77);e.exports=function(e,t){return function(n,r){if(null==n)return n;if(!s(n))return e(n,r);for(var a=n.length,o=t?a:-1,i=Object(n);(t?o--:++o<a)&&!1!==r(i[o],o,i););return n}}},function(e,t,n){var s=n(151);e.exports=function(e){return"function"==typeof e?e:s}},function(e,t,n){var s=n(290),r=n(557),a=n(152),o=n(20);e.exports=function(e,t){return(o(e)?s:r)(e,a(t,3))}},function(e,t,n){var s=n(150);e.exports=function(e,t){var n=[];return s(e,(function(e,s,r){t(e,s,r)&&n.push(e)})),n}},function(e,t,n){var s=n(559),r=n(567),a=n(305);e.exports=function(e){var t=r(e);return 1==t.length&&t[0][2]?a(t[0][0],t[0][1]):function(n){return n===e||s(n,e,t)}}},function(e,t,n){var s=n(195),r=n(300);e.exports=function(e,t,n,a){var o=n.length,i=o,l=!a;if(null==e)return!i;for(e=Object(e);o--;){var c=n[o];if(l&&c[2]?c[1]!==e[c[0]]:!(c[0]in e))return!1}for(;++o<i;){var u=(c=n[o])[0],h=e[u],d=c[1];if(l&&c[2]){if(void 0===h&&!(u in e))return!1}else{var p=new s;if(a)var f=a(h,d,u,e,t,p);if(!(void 0===f?r(d,h,3,a,p):f))return!1}}return!0}},function(e,t,n){var s=n(195),r=n(301),a=n(564),o=n(566),i=n(95),l=n(20),c=n(115),u=n(148),h="[object Object]",d=Object.prototype.hasOwnProperty;e.exports=function(e,t,n,p,f,m){var g=l(e),y=l(t),v=g?"[object Array]":i(e),b=y?"[object Array]":i(t),_=(v="[object Arguments]"==v?h:v)==h,E=(b="[object Arguments]"==b?h:b)==h,S=v==b;if(S&&c(e)){if(!c(t))return!1;g=!0,_=!1}if(S&&!_)return m||(m=new s),g||u(e)?r(e,t,n,p,f,m):a(e,t,v,n,p,f,m);if(!(1&n)){var w=_&&d.call(e,"__wrapped__"),C=E&&d.call(t,"__wrapped__");if(w||C){var O=w?e.value():e,T=C?t.value():t;return m||(m=new s),f(O,T,n,p,m)}}return!!S&&(m||(m=new s),o(e,t,n,p,f,m))}},function(e,t){e.exports=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this}},function(e,t){e.exports=function(e){return this.__data__.has(e)}},function(e,t){e.exports=function(e,t){for(var n=-1,s=null==e?0:e.length;++n<s;)if(t(e[n],n,e))return!0;return!1}},function(e,t,n){var s=n(94),r=n(296),a=n(196),o=n(301),i=n(565),l=n(210),c=s?s.prototype:void 0,u=c?c.valueOf:void 0;e.exports=function(e,t,n,s,c,h,d){switch(n){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!h(new r(e),new r(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return a(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var p=i;case"[object Set]":var f=1&s;if(p||(p=l),e.size!=t.size&&!f)return!1;var m=d.get(e);if(m)return m==t;s|=2,d.set(e,t);var g=o(p(e),p(t),s,c,h,d);return d.delete(e),g;case"[object Symbol]":if(u)return u.call(e)==u.call(t)}return!1}},function(e,t){e.exports=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e,s){n[++t]=[s,e]})),n}},function(e,t,n){var s=n(293),r=Object.prototype.hasOwnProperty;e.exports=function(e,t,n,a,o,i){var l=1&n,c=s(e),u=c.length;if(u!=s(t).length&&!l)return!1;for(var h=u;h--;){var d=c[h];if(!(l?d in t:r.call(t,d)))return!1}var p=i.get(e),f=i.get(t);if(p&&f)return p==t&&f==e;var m=!0;i.set(e,t),i.set(t,e);for(var g=l;++h<u;){var y=e[d=c[h]],v=t[d];if(a)var b=l?a(v,y,d,t,e,i):a(y,v,d,e,t,i);if(!(void 0===b?y===v||o(y,v,n,a,i):b)){m=!1;break}g||(g="constructor"==d)}if(m&&!g){var _=e.constructor,E=t.constructor;_==E||!("constructor"in e)||!("constructor"in t)||"function"==typeof _&&_ instanceof _&&"function"==typeof E&&E instanceof E||(m=!1)}return i.delete(e),i.delete(t),m}},function(e,t,n){var s=n(304),r=n(76);e.exports=function(e){for(var t=r(e),n=t.length;n--;){var a=t[n],o=e[a];t[n]=[a,o,s(o)]}return t}},function(e,t,n){var s=n(300),r=n(569),a=n(575),o=n(211),i=n(304),l=n(305),c=n(153);e.exports=function(e,t){return o(e)&&i(t)?l(c(e),t):function(n){var o=r(n,e);return void 0===o&&o===t?a(n,e):s(t,o,3)}}},function(e,t,n){var s=n(306);e.exports=function(e,t,n){var r=null==e?void 0:s(e,t);return void 0===r?n:r}},function(e,t,n){var s=n(571),r=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,a=/\\(\\)?/g,o=s((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(r,(function(e,n,s,r){t.push(s?r.replace(a,"$1"):n||e)})),t}));e.exports=o},function(e,t,n){var s=n(572);e.exports=function(e){var t=s(e,(function(e){return 500===n.size&&n.clear(),e})),n=t.cache;return t}},function(e,t,n){var s=n(198);function r(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError("Expected a function");var n=function(){var s=arguments,r=t?t.apply(this,s):s[0],a=n.cache;if(a.has(r))return a.get(r);var o=e.apply(this,s);return n.cache=a.set(r,o)||a,o};return n.cache=new(r.Cache||s),n}r.Cache=s,e.exports=r},function(e,t,n){var s=n(574);e.exports=function(e){return null==e?"":s(e)}},function(e,t,n){var s=n(94),r=n(213),a=n(20),o=n(212),i=s?s.prototype:void 0,l=i?i.toString:void 0;e.exports=function e(t){if("string"==typeof t)return t;if(a(t))return r(t,e)+"";if(o(t))return l?l.call(t):"";var n=t+"";return"0"==n&&1/t==-1/0?"-0":n}},function(e,t,n){var s=n(576),r=n(308);e.exports=function(e,t){return null!=e&&r(e,t,s)}},function(e,t){e.exports=function(e,t){return null!=e&&t in Object(e)}},function(e,t,n){var s=n(309),r=n(578),a=n(211),o=n(153);e.exports=function(e){return a(e)?s(o(e)):r(e)}},function(e,t,n){var s=n(306);e.exports=function(e){return function(t){return s(t,e)}}},function(e,t,n){var s=n(580),r=n(308);e.exports=function(e,t){return null!=e&&r(e,t,s)}},function(e,t){var n=Object.prototype.hasOwnProperty;e.exports=function(e,t){return null!=e&&n.call(e,t)}},function(e,t,n){var s=n(204),r=n(95),a=n(147),o=n(20),i=n(77),l=n(115),c=n(149),u=n(148),h=Object.prototype.hasOwnProperty;e.exports=function(e){if(null==e)return!0;if(i(e)&&(o(e)||"string"==typeof e||"function"==typeof e.splice||l(e)||u(e)||a(e)))return!e.length;var t=r(e);if("[object Map]"==t||"[object Set]"==t)return!e.size;if(c(e))return!s(e).length;for(var n in e)if(h.call(e,n))return!1;return!0}},function(e,t){e.exports=function(e){return void 0===e}},function(e,t,n){var s=n(213),r=n(152),a=n(584),o=n(20);e.exports=function(e,t){return(o(e)?s:a)(e,r(t,3))}},function(e,t,n){var s=n(150),r=n(77);e.exports=function(e,t){var n=-1,a=r(e)?Array(e.length):[];return s(e,(function(e,s,r){a[++n]=t(e,s,r)})),a}},function(e,t,n){var s=n(586),r=n(150),a=n(152),o=n(587),i=n(20);e.exports=function(e,t,n){var l=i(e)?s:o,c=arguments.length<3;return l(e,a(t,4),n,c,r)}},function(e,t){e.exports=function(e,t,n,s){var r=-1,a=null==e?0:e.length;for(s&&a&&(n=e[++r]);++r<a;)n=t(n,e[r],r,e);return n}},function(e,t){e.exports=function(e,t,n,s,r){return r(e,(function(e,r,a){n=s?(s=!1,e):t(n,e,r,a)})),n}},function(e,t,n){var s=n(204),r=n(95),a=n(77),o=n(589),i=n(590);e.exports=function(e){if(null==e)return 0;if(a(e))return o(e)?i(e):e.length;var t=r(e);return"[object Map]"==t||"[object Set]"==t?e.size:s(e).length}},function(e,t,n){var s=n(93),r=n(20),a=n(56);e.exports=function(e){return"string"==typeof e||!r(e)&&a(e)&&"[object String]"==s(e)}},function(e,t,n){var s=n(591),r=n(592),a=n(593);e.exports=function(e){return r(e)?a(e):s(e)}},function(e,t,n){var s=n(309)("length");e.exports=s},function(e,t){var n=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");e.exports=function(e){return n.test(e)}},function(e,t){var n="[\\ud800-\\udfff]",s="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",r="\\ud83c[\\udffb-\\udfff]",a="[^\\ud800-\\udfff]",o="(?:\\ud83c[\\udde6-\\uddff]){2}",i="[\\ud800-\\udbff][\\udc00-\\udfff]",l="(?:"+s+"|"+r+")"+"?",c="[\\ufe0e\\ufe0f]?"+l+("(?:\\u200d(?:"+[a,o,i].join("|")+")[\\ufe0e\\ufe0f]?"+l+")*"),u="(?:"+[a+s+"?",s,o,i,n].join("|")+")",h=RegExp(r+"(?="+r+")|"+u+c,"g");e.exports=function(e){for(var t=h.lastIndex=0;h.test(e);)++t;return t}},function(e,t,n){var s=n(199),r=n(297),a=n(299),o=n(152),i=n(208),l=n(20),c=n(115),u=n(143),h=n(75),d=n(148);e.exports=function(e,t,n){var p=l(e),f=p||c(e)||d(e);if(t=o(t,4),null==n){var m=e&&e.constructor;n=f?p?new m:[]:h(e)&&u(m)?r(i(e)):{}}return(f?s:a)(e,(function(e,s,r){return t(n,e,s,r)})),n}},function(e,t,n){var s=n(596),r=n(598),a=n(604),o=n(613),i=r((function(e){return a(s(e,1,o,!0))}));e.exports=i},function(e,t,n){var s=n(207),r=n(597);e.exports=function e(t,n,a,o,i){var l=-1,c=t.length;for(a||(a=r),i||(i=[]);++l<c;){var u=t[l];n>0&&a(u)?n>1?e(u,n-1,a,o,i):s(i,u):o||(i[i.length]=u)}return i}},function(e,t,n){var s=n(94),r=n(147),a=n(20),o=s?s.isConcatSpreadable:void 0;e.exports=function(e){return a(e)||r(e)||!!(o&&e&&e[o])}},function(e,t,n){var s=n(151),r=n(599),a=n(601);e.exports=function(e,t){return a(r(e,t,s),e+"")}},function(e,t,n){var s=n(600),r=Math.max;e.exports=function(e,t,n){return t=r(void 0===t?e.length-1:t,0),function(){for(var a=arguments,o=-1,i=r(a.length-t,0),l=Array(i);++o<i;)l[o]=a[t+o];o=-1;for(var c=Array(t+1);++o<t;)c[o]=a[o];return c[t]=n(l),s(e,this,c)}}},function(e,t){e.exports=function(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}},function(e,t,n){var s=n(602),r=n(603)(s);e.exports=r},function(e,t,n){var s=n(298),r=n(286),a=n(151),o=r?function(e,t){return r(e,"toString",{configurable:!0,enumerable:!1,value:s(t),writable:!0})}:a;e.exports=o},function(e,t){var n=Date.now;e.exports=function(e){var t=0,s=0;return function(){var r=n(),a=16-(r-s);if(s=r,a>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}},function(e,t,n){var s=n(302),r=n(605),a=n(610),o=n(303),i=n(611),l=n(210);e.exports=function(e,t,n){var c=-1,u=r,h=e.length,d=!0,p=[],f=p;if(n)d=!1,u=a;else if(h>=200){var m=t?null:i(e);if(m)return l(m);d=!1,u=o,f=new s}else f=t?[]:p;e:for(;++c<h;){var g=e[c],y=t?t(g):g;if(g=n||0!==g?g:0,d&&y==y){for(var v=f.length;v--;)if(f[v]===y)continue e;t&&f.push(y),p.push(g)}else u(f,y,n)||(f!==p&&f.push(y),p.push(g))}return p}},function(e,t,n){var s=n(606);e.exports=function(e,t){return!!(null==e?0:e.length)&&s(e,t,0)>-1}},function(e,t,n){var s=n(607),r=n(608),a=n(609);e.exports=function(e,t,n){return t==t?a(e,t,n):s(e,r,n)}},function(e,t){e.exports=function(e,t,n,s){for(var r=e.length,a=n+(s?1:-1);s?a--:++a<r;)if(t(e[a],a,e))return a;return-1}},function(e,t){e.exports=function(e){return e!=e}},function(e,t){e.exports=function(e,t,n){for(var s=n-1,r=e.length;++s<r;)if(e[s]===t)return s;return-1}},function(e,t){e.exports=function(e,t,n){for(var s=-1,r=null==e?0:e.length;++s<r;)if(n(t,e[s]))return!0;return!1}},function(e,t,n){var s=n(295),r=n(612),a=n(210),o=s&&1/a(new s([,-0]))[1]==1/0?function(e){return new s(e)}:r;e.exports=o},function(e,t){e.exports=function(){}},function(e,t,n){var s=n(77),r=n(56);e.exports=function(e){return r(e)&&s(e)}},function(e,t,n){var s=n(615),r=n(76);e.exports=function(e){return null==e?[]:s(e,r(e))}},function(e,t,n){var s=n(213);e.exports=function(e,t){return s(t,(function(t){return e[t]}))}},function(e,t){e.exports="2.1.8"},function(e,t,n){var s=n(36),r=n(194);function a(e){return s.map(e.nodes(),(function(t){var n=e.node(t),r=e.parent(t),a={v:t};return s.isUndefined(n)||(a.value=n),s.isUndefined(r)||(a.parent=r),a}))}function o(e){return s.map(e.edges(),(function(t){var n=e.edge(t),r={v:t.v,w:t.w};return s.isUndefined(t.name)||(r.name=t.name),s.isUndefined(n)||(r.value=n),r}))}e.exports={write:function(e){var t={options:{directed:e.isDirected(),multigraph:e.isMultigraph(),compound:e.isCompound()},nodes:a(e),edges:o(e)};s.isUndefined(e.graph())||(t.value=s.clone(e.graph()));return t},read:function(e){var t=new r(e.options).setGraph(e.value);return s.each(e.nodes,(function(e){t.setNode(e.v,e.value),e.parent&&t.setParent(e.v,e.parent)})),s.each(e.edges,(function(e){t.setEdge({v:e.v,w:e.w,name:e.name},e.value)})),t}}},function(e,t,n){e.exports={components:n(619),dijkstra:n(310),dijkstraAll:n(620),findCycles:n(621),floydWarshall:n(622),isAcyclic:n(623),postorder:n(624),preorder:n(625),prim:n(626),tarjan:n(312),topsort:n(313)}},function(e,t,n){var s=n(36);e.exports=function(e){var t,n={},r=[];function a(r){s.has(n,r)||(n[r]=!0,t.push(r),s.each(e.successors(r),a),s.each(e.predecessors(r),a))}return s.each(e.nodes(),(function(e){t=[],a(e),t.length&&r.push(t)})),r}},function(e,t,n){var s=n(310),r=n(36);e.exports=function(e,t,n){return r.transform(e.nodes(),(function(r,a){r[a]=s(e,a,t,n)}),{})}},function(e,t,n){var s=n(36),r=n(312);e.exports=function(e){return s.filter(r(e),(function(t){return t.length>1||1===t.length&&e.hasEdge(t[0],t[0])}))}},function(e,t,n){var s=n(36);e.exports=function(e,t,n){return function(e,t,n){var s={},r=e.nodes();return r.forEach((function(e){s[e]={},s[e][e]={distance:0},r.forEach((function(t){e!==t&&(s[e][t]={distance:Number.POSITIVE_INFINITY})})),n(e).forEach((function(n){var r=n.v===e?n.w:n.v,a=t(n);s[e][r]={distance:a,predecessor:e}}))})),r.forEach((function(e){var t=s[e];r.forEach((function(n){var a=s[n];r.forEach((function(n){var s=a[e],r=t[n],o=a[n],i=s.distance+r.distance;i<o.distance&&(o.distance=i,o.predecessor=r.predecessor)}))}))})),s}(e,t||r,n||function(t){return e.outEdges(t)})};var r=s.constant(1)},function(e,t,n){var s=n(313);e.exports=function(e){try{s(e)}catch(e){if(e instanceof s.CycleException)return!1;throw e}return!0}},function(e,t,n){var s=n(314);e.exports=function(e,t){return s(e,t,"post")}},function(e,t,n){var s=n(314);e.exports=function(e,t){return s(e,t,"pre")}},function(e,t,n){var s=n(36),r=n(194),a=n(311);e.exports=function(e,t){var n,o=new r,i={},l=new a;function c(e){var s=e.v===n?e.w:e.v,r=l.priority(s);if(void 0!==r){var a=t(e);a<r&&(i[s]=n,l.decrease(s,a))}}if(0===e.nodeCount())return o;s.each(e.nodes(),(function(e){l.add(e,Number.POSITIVE_INFINITY),o.setNode(e)})),l.decrease(e.nodes()[0],0);var u=!1;for(;l.size()>0;){if(n=l.removeMin(),s.has(i,n))o.setEdge(n,i[n]);else{if(u)throw new Error("Input graph is not connected: "+e);u=!0}e.nodeEdges(n).forEach(c)}return o}},function(e,t,n){e.exports=function(e){"uniqueLinkId"in(e=e||{})&&(console.warn("ngraph.graph: Starting from version 0.14 `uniqueLinkId` is deprecated.\nUse `multigraph` option instead\n","\n","Note: there is also change in default behavior: From now on each graph\nis considered to be not a multigraph by default (each edge is unique)."),e.multigraph=e.uniqueLinkId);void 0===e.multigraph&&(e.multigraph=!1);if("function"!=typeof Map)throw new Error("ngraph.graph requires `Map` to be defined. Please polyfill it before using ngraph");var t=new Map,n=[],c={},u=0,h=e.multigraph?function(e,t,n){var s=l(e,t),r=c.hasOwnProperty(s);if(r||T(e,t)){r||(c[s]=0);var a="@"+ ++c[s];s=l(e+a,t+a)}return new i(e,t,n,s)}:function(e,t,n){var s=l(e,t);return new i(e,t,n,s)},d=[],p=M,f=M,m=M,g=M,y={addNode:_,addLink:function(e,t,s){m();var r=E(e)||_(e),a=E(t)||_(t),i=h(e,t,s);n.push(i),o(r,i),e!==t&&o(a,i);return p(i,"add"),g(),i},removeLink:O,removeNode:S,getNode:E,getNodeCount:w,getLinkCount:C,getLinksCount:C,getNodesCount:w,getLinks:function(e){var t=E(e);return t?t.links:null},forEachNode:x,forEachLinkedNode:function(e,n,s){var r=E(e);if(r&&r.links&&"function"==typeof n)return s?function(e,n,s){for(var r=0;r<e.length;++r){var a=e[r];if(a.fromId===n&&s(t.get(a.toId),a))return!0}}(r.links,e,n):function(e,n,s){for(var r=0;r<e.length;++r){var a=e[r],o=a.fromId===n?a.toId:a.fromId;if(s(t.get(o),a))return!0}}(r.links,e,n)},forEachLink:function(e){var t,s;if("function"==typeof e)for(t=0,s=n.length;t<s;++t)e(n[t])},beginUpdate:m,endUpdate:g,clear:function(){m(),x((function(e){S(e.id)})),g()},hasLink:T,hasNode:E,getLink:T};return s(y),function(){var e=y.on;y.on=function(){return y.beginUpdate=m=A,y.endUpdate=g=N,p=v,f=b,y.on=e,e.apply(y,arguments)}}(),y;function v(e,t){d.push({link:e,changeType:t})}function b(e,t){d.push({node:e,changeType:t})}function _(e,n){if(void 0===e)throw new Error("Invalid node identifier");m();var s=E(e);return s?(s.data=n,f(s,"update")):(s=new a(e,n),f(s,"add")),t.set(e,s),g(),s}function E(e){return t.get(e)}function S(e){var n=E(e);if(!n)return!1;m();var s=n.links;if(s){n.links=null;for(var r=0;r<s.length;++r)O(s[r])}return t.delete(e),f(n,"remove"),g(),!0}function w(){return t.size}function C(){return n.length}function O(e){if(!e)return!1;var t=r(e,n);if(t<0)return!1;m(),n.splice(t,1);var s=E(e.fromId),a=E(e.toId);return s&&(t=r(e,s.links))>=0&&s.links.splice(t,1),a&&(t=r(e,a.links))>=0&&a.links.splice(t,1),p(e,"remove"),g(),!0}function T(e,t){var n,s=E(e);if(!s||!s.links)return null;for(n=0;n<s.links.length;++n){var r=s.links[n];if(r.fromId===e&&r.toId===t)return r}return null}function M(){}function A(){u+=1}function N(){0===(u-=1)&&d.length>0&&(y.fire("changed",d),d.length=0)}function x(e){if("function"!=typeof e)throw new Error("Function is expected to iterate over graph nodes. You passed "+e);for(var n=t.values(),s=n.next();!s.done;){if(e(s.value))return!0;s=n.next()}}};var s=n(628);function r(e,t){if(!t)return-1;if(t.indexOf)return t.indexOf(e);var n,s=t.length;for(n=0;n<s;n+=1)if(t[n]===e)return n;return-1}function a(e,t){this.id=e,this.links=null,this.data=t}function o(e,t){e.links?e.links.push(t):e.links=[t]}function i(e,t,n,s){this.fromId=e,this.toId=t,this.data=n,this.id=s}function l(e,t){return e.toString()+"๐ "+t.toString()}},function(e,t){e.exports=function(e){!function(e){if(!e)throw new Error("Eventify cannot use falsy object as events subject");for(var t=["on","fire","off"],n=0;n<t.length;++n)if(e.hasOwnProperty(t[n]))throw new Error("Subject cannot be eventified, since it already has property '"+t[n]+"'")}(e);var t=function(e){var t=Object.create(null);return{on:function(n,s,r){if("function"!=typeof s)throw new Error("callback is expected to be a function");var a=t[n];return a||(a=t[n]=[]),a.push({callback:s,ctx:r}),e},off:function(n,s){if(void 0===n)return t=Object.create(null),e;if(t[n])if("function"!=typeof s)delete t[n];else for(var r=t[n],a=0;a<r.length;++a)r[a].callback===s&&r.splice(a,1);return e},fire:function(n){var s,r=t[n];if(!r)return e;arguments.length>1&&(s=Array.prototype.splice.call(arguments,1));for(var a=0;a<r.length;++a){var o=r[a];o.callback.apply(o.ctx,s)}return e}}}(e);return e.on=t.on,e.off=t.off,e.fire=t.fire,e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=n(315);!function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(n(658)),t.default={Graph:s.Graph}},function(e,t,n){"use strict";t.byteLength=function(e){var t=c(e),n=t[0],s=t[1];return 3*(n+s)/4-s},t.toByteArray=function(e){var t,n,s=c(e),o=s[0],i=s[1],l=new a(function(e,t,n){return 3*(t+n)/4-n}(0,o,i)),u=0,h=i>0?o-4:o;for(n=0;n<h;n+=4)t=r[e.charCodeAt(n)]<<18|r[e.charCodeAt(n+1)]<<12|r[e.charCodeAt(n+2)]<<6|r[e.charCodeAt(n+3)],l[u++]=t>>16&255,l[u++]=t>>8&255,l[u++]=255&t;2===i&&(t=r[e.charCodeAt(n)]<<2|r[e.charCodeAt(n+1)]>>4,l[u++]=255&t);1===i&&(t=r[e.charCodeAt(n)]<<10|r[e.charCodeAt(n+1)]<<4|r[e.charCodeAt(n+2)]>>2,l[u++]=t>>8&255,l[u++]=255&t);return l},t.fromByteArray=function(e){for(var t,n=e.length,r=n%3,a=[],o=0,i=n-r;o<i;o+=16383)a.push(u(e,o,o+16383>i?i:o+16383));1===r?(t=e[n-1],a.push(s[t>>2]+s[t<<4&63]+"==")):2===r&&(t=(e[n-2]<<8)+e[n-1],a.push(s[t>>10]+s[t>>4&63]+s[t<<2&63]+"="));return a.join("")};for(var s=[],r=[],a="undefined"!=typeof Uint8Array?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,l=o.length;i<l;++i)s[i]=o[i],r[o.charCodeAt(i)]=i;function c(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function u(e,t,n){for(var r,a,o=[],i=t;i<n;i+=3)r=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2]),o.push(s[(a=r)>>18&63]+s[a>>12&63]+s[a>>6&63]+s[63&a]);return o.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},function(e,t){t.read=function(e,t,n,s,r){var a,o,i=8*r-s-1,l=(1<<i)-1,c=l>>1,u=-7,h=n?r-1:0,d=n?-1:1,p=e[t+h];for(h+=d,a=p&(1<<-u)-1,p>>=-u,u+=i;u>0;a=256*a+e[t+h],h+=d,u-=8);for(o=a&(1<<-u)-1,a>>=-u,u+=s;u>0;o=256*o+e[t+h],h+=d,u-=8);if(0===a)a=1-c;else{if(a===l)return o?NaN:1/0*(p?-1:1);o+=Math.pow(2,s),a-=c}return(p?-1:1)*o*Math.pow(2,a-s)},t.write=function(e,t,n,s,r,a){var o,i,l,c=8*a-r-1,u=(1<<c)-1,h=u>>1,d=23===r?Math.pow(2,-24)-Math.pow(2,-77):0,p=s?0:a-1,f=s?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(i=isNaN(t)?1:0,o=u):(o=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-o))<1&&(o--,l*=2),(t+=o+h>=1?d/l:d*Math.pow(2,1-h))*l>=2&&(o++,l/=2),o+h>=u?(i=0,o=u):o+h>=1?(i=(t*l-1)*Math.pow(2,r),o+=h):(i=t*Math.pow(2,h-1)*Math.pow(2,r),o=0));r>=8;e[n+p]=255&i,p+=f,i/=256,r-=8);for(o=o<<r|i,c+=r;c>0;e[n+p]=255&o,p+=f,o/=256,c-=8);e[n+p-f]|=128*m}},function(e,t){var n={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==n.call(e)}},function(e,t){},function(e,t,n){"use strict";(function(e){var s=n(96).Buffer,r=n(635).Transform,a=n(648),o=n(328),i=n(327).ok,l=n(96).kMaxLength,c="Cannot create final Buffer. It would be larger than 0x"+l.toString(16)+" bytes";a.Z_MIN_WINDOWBITS=8,a.Z_MAX_WINDOWBITS=15,a.Z_DEFAULT_WINDOWBITS=15,a.Z_MIN_CHUNK=64,a.Z_MAX_CHUNK=1/0,a.Z_DEFAULT_CHUNK=16384,a.Z_MIN_MEMLEVEL=1,a.Z_MAX_MEMLEVEL=9,a.Z_DEFAULT_MEMLEVEL=8,a.Z_MIN_LEVEL=-1,a.Z_MAX_LEVEL=9,a.Z_DEFAULT_LEVEL=a.Z_DEFAULT_COMPRESSION;for(var u=Object.keys(a),h=0;h<u.length;h++){var d=u[h];d.match(/^Z/)&&Object.defineProperty(t,d,{enumerable:!0,value:a[d],writable:!1})}for(var p={Z_OK:a.Z_OK,Z_STREAM_END:a.Z_STREAM_END,Z_NEED_DICT:a.Z_NEED_DICT,Z_ERRNO:a.Z_ERRNO,Z_STREAM_ERROR:a.Z_STREAM_ERROR,Z_DATA_ERROR:a.Z_DATA_ERROR,Z_MEM_ERROR:a.Z_MEM_ERROR,Z_BUF_ERROR:a.Z_BUF_ERROR,Z_VERSION_ERROR:a.Z_VERSION_ERROR},f=Object.keys(p),m=0;m<f.length;m++){var g=f[m];p[p[g]]=g}function y(e,t,n){var r=[],a=0;function o(){for(var t;null!==(t=e.read());)r.push(t),a+=t.length;e.once("readable",o)}function i(){var t,o=null;a>=l?o=new RangeError(c):t=s.concat(r,a),r=[],e.close(),n(o,t)}e.on("error",(function(t){e.removeListener("end",i),e.removeListener("readable",o),n(t)})),e.on("end",i),e.end(t),o()}function v(e,t){if("string"==typeof t&&(t=s.from(t)),!s.isBuffer(t))throw new TypeError("Not a string or buffer");var n=e._finishFlushFlag;return e._processChunk(t,n)}function b(e){if(!(this instanceof b))return new b(e);M.call(this,e,a.DEFLATE)}function _(e){if(!(this instanceof _))return new _(e);M.call(this,e,a.INFLATE)}function E(e){if(!(this instanceof E))return new E(e);M.call(this,e,a.GZIP)}function S(e){if(!(this instanceof S))return new S(e);M.call(this,e,a.GUNZIP)}function w(e){if(!(this instanceof w))return new w(e);M.call(this,e,a.DEFLATERAW)}function C(e){if(!(this instanceof C))return new C(e);M.call(this,e,a.INFLATERAW)}function O(e){if(!(this instanceof O))return new O(e);M.call(this,e,a.UNZIP)}function T(e){return e===a.Z_NO_FLUSH||e===a.Z_PARTIAL_FLUSH||e===a.Z_SYNC_FLUSH||e===a.Z_FULL_FLUSH||e===a.Z_FINISH||e===a.Z_BLOCK}function M(e,n){var o=this;if(this._opts=e=e||{},this._chunkSize=e.chunkSize||t.Z_DEFAULT_CHUNK,r.call(this,e),e.flush&&!T(e.flush))throw new Error("Invalid flush flag: "+e.flush);if(e.finishFlush&&!T(e.finishFlush))throw new Error("Invalid flush flag: "+e.finishFlush);if(this._flushFlag=e.flush||a.Z_NO_FLUSH,this._finishFlushFlag=void 0!==e.finishFlush?e.finishFlush:a.Z_FINISH,e.chunkSize&&(e.chunkSize<t.Z_MIN_CHUNK||e.chunkSize>t.Z_MAX_CHUNK))throw new Error("Invalid chunk size: "+e.chunkSize);if(e.windowBits&&(e.windowBits<t.Z_MIN_WINDOWBITS||e.windowBits>t.Z_MAX_WINDOWBITS))throw new Error("Invalid windowBits: "+e.windowBits);if(e.level&&(e.level<t.Z_MIN_LEVEL||e.level>t.Z_MAX_LEVEL))throw new Error("Invalid compression level: "+e.level);if(e.memLevel&&(e.memLevel<t.Z_MIN_MEMLEVEL||e.memLevel>t.Z_MAX_MEMLEVEL))throw new Error("Invalid memLevel: "+e.memLevel);if(e.strategy&&e.strategy!=t.Z_FILTERED&&e.strategy!=t.Z_HUFFMAN_ONLY&&e.strategy!=t.Z_RLE&&e.strategy!=t.Z_FIXED&&e.strategy!=t.Z_DEFAULT_STRATEGY)throw new Error("Invalid strategy: "+e.strategy);if(e.dictionary&&!s.isBuffer(e.dictionary))throw new Error("Invalid dictionary: it should be a Buffer instance");this._handle=new a.Zlib(n);var i=this;this._hadError=!1,this._handle.onerror=function(e,n){A(i),i._hadError=!0;var s=new Error(e);s.errno=n,s.code=t.codes[n],i.emit("error",s)};var l=t.Z_DEFAULT_COMPRESSION;"number"==typeof e.level&&(l=e.level);var c=t.Z_DEFAULT_STRATEGY;"number"==typeof e.strategy&&(c=e.strategy),this._handle.init(e.windowBits||t.Z_DEFAULT_WINDOWBITS,l,e.memLevel||t.Z_DEFAULT_MEMLEVEL,c,e.dictionary),this._buffer=s.allocUnsafe(this._chunkSize),this._offset=0,this._level=l,this._strategy=c,this.once("end",this.close),Object.defineProperty(this,"_closed",{get:function(){return!o._handle},configurable:!0,enumerable:!0})}function A(t,n){n&&e.nextTick(n),t._handle&&(t._handle.close(),t._handle=null)}function N(e){e.emit("close")}Object.defineProperty(t,"codes",{enumerable:!0,value:Object.freeze(p),writable:!1}),t.Deflate=b,t.Inflate=_,t.Gzip=E,t.Gunzip=S,t.DeflateRaw=w,t.InflateRaw=C,t.Unzip=O,t.createDeflate=function(e){return new b(e)},t.createInflate=function(e){return new _(e)},t.createDeflateRaw=function(e){return new w(e)},t.createInflateRaw=function(e){return new C(e)},t.createGzip=function(e){return new E(e)},t.createGunzip=function(e){return new S(e)},t.createUnzip=function(e){return new O(e)},t.deflate=function(e,t,n){return"function"==typeof t&&(n=t,t={}),y(new b(t),e,n)},t.deflateSync=function(e,t){return v(new b(t),e)},t.gzip=function(e,t,n){return"function"==typeof t&&(n=t,t={}),y(new E(t),e,n)},t.gzipSync=function(e,t){return v(new E(t),e)},t.deflateRaw=function(e,t,n){return"function"==typeof t&&(n=t,t={}),y(new w(t),e,n)},t.deflateRawSync=function(e,t){return v(new w(t),e)},t.unzip=function(e,t,n){return"function"==typeof t&&(n=t,t={}),y(new O(t),e,n)},t.unzipSync=function(e,t){return v(new O(t),e)},t.inflate=function(e,t,n){return"function"==typeof t&&(n=t,t={}),y(new _(t),e,n)},t.inflateSync=function(e,t){return v(new _(t),e)},t.gunzip=function(e,t,n){return"function"==typeof t&&(n=t,t={}),y(new S(t),e,n)},t.gunzipSync=function(e,t){return v(new S(t),e)},t.inflateRaw=function(e,t,n){return"function"==typeof t&&(n=t,t={}),y(new C(t),e,n)},t.inflateRawSync=function(e,t){return v(new C(t),e)},o.inherits(M,r),M.prototype.params=function(n,s,r){if(n<t.Z_MIN_LEVEL||n>t.Z_MAX_LEVEL)throw new RangeError("Invalid compression level: "+n);if(s!=t.Z_FILTERED&&s!=t.Z_HUFFMAN_ONLY&&s!=t.Z_RLE&&s!=t.Z_FIXED&&s!=t.Z_DEFAULT_STRATEGY)throw new TypeError("Invalid strategy: "+s);if(this._level!==n||this._strategy!==s){var o=this;this.flush(a.Z_SYNC_FLUSH,(function(){i(o._handle,"zlib binding closed"),o._handle.params(n,s),o._hadError||(o._level=n,o._strategy=s,r&&r())}))}else e.nextTick(r)},M.prototype.reset=function(){return i(this._handle,"zlib binding closed"),this._handle.reset()},M.prototype._flush=function(e){this._transform(s.alloc(0),"",e)},M.prototype.flush=function(t,n){var r=this,o=this._writableState;("function"==typeof t||void 0===t&&!n)&&(n=t,t=a.Z_FULL_FLUSH),o.ended?n&&e.nextTick(n):o.ending?n&&this.once("end",n):o.needDrain?n&&this.once("drain",(function(){return r.flush(t,n)})):(this._flushFlag=t,this.write(s.alloc(0),"",n))},M.prototype.close=function(t){A(this,t),e.nextTick(N,this)},M.prototype._transform=function(e,t,n){var r,o=this._writableState,i=(o.ending||o.ended)&&(!e||o.length===e.length);return null===e||s.isBuffer(e)?this._handle?(i?r=this._finishFlushFlag:(r=this._flushFlag,e.length>=o.length&&(this._flushFlag=this._opts.flush||a.Z_NO_FLUSH)),void this._processChunk(e,r,n)):n(new Error("zlib binding closed")):n(new Error("invalid input"))},M.prototype._processChunk=function(e,t,n){var r=e&&e.length,a=this._chunkSize-this._offset,o=0,u=this,h="function"==typeof n;if(!h){var d,p=[],f=0;this.on("error",(function(e){d=e})),i(this._handle,"zlib binding closed");do{var m=this._handle.writeSync(t,e,o,r,this._buffer,this._offset,a)}while(!this._hadError&&v(m[0],m[1]));if(this._hadError)throw d;if(f>=l)throw A(this),new RangeError(c);var g=s.concat(p,f);return A(this),g}i(this._handle,"zlib binding closed");var y=this._handle.write(t,e,o,r,this._buffer,this._offset,a);function v(l,c){if(this&&(this.buffer=null,this.callback=null),!u._hadError){var d=a-c;if(i(d>=0,"have should not go down"),d>0){var m=u._buffer.slice(u._offset,u._offset+d);u._offset+=d,h?u.push(m):(p.push(m),f+=m.length)}if((0===c||u._offset>=u._chunkSize)&&(a=u._chunkSize,u._offset=0,u._buffer=s.allocUnsafe(u._chunkSize)),0===c){if(o+=r-l,r=l,!h)return!0;var g=u._handle.write(t,e,o,r,u._buffer,u._offset,u._chunkSize);return g.callback=v,void(g.buffer=e)}if(!h)return!1;n()}}y.buffer=e,y.callback=v},o.inherits(b,M),o.inherits(_,M),o.inherits(E,M),o.inherits(S,M),o.inherits(w,M),o.inherits(C,M),o.inherits(O,M)}).call(this,n(43))},function(e,t,n){e.exports=r;var s=n(216).EventEmitter;function r(){s.call(this)}n(78)(r,s),r.Readable=n(217),r.Writable=n(644),r.Duplex=n(645),r.Transform=n(646),r.PassThrough=n(647),r.Stream=r,r.prototype.pipe=function(e,t){var n=this;function r(t){e.writable&&!1===e.write(t)&&n.pause&&n.pause()}function a(){n.readable&&n.resume&&n.resume()}n.on("data",r),e.on("drain",a),e._isStdio||t&&!1===t.end||(n.on("end",i),n.on("close",l));var o=!1;function i(){o||(o=!0,e.end())}function l(){o||(o=!0,"function"==typeof e.destroy&&e.destroy())}function c(e){if(u(),0===s.listenerCount(this,"error"))throw e}function u(){n.removeListener("data",r),e.removeListener("drain",a),n.removeListener("end",i),n.removeListener("close",l),n.removeListener("error",c),e.removeListener("error",c),n.removeListener("end",u),n.removeListener("close",u),e.removeListener("close",u)}return n.on("error",c),e.on("error",c),n.on("end",u),n.on("close",u),e.on("close",u),e.emit("pipe",n),e}},function(e,t){var n={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==n.call(e)}},function(e,t){},function(e,t,n){"use strict";var s=n(155).Buffer,r=n(639);e.exports=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.head=null,this.tail=null,this.length=0}return e.prototype.push=function(e){var t={data:e,next:null};this.length>0?this.tail.next=t:this.head=t,this.tail=t,++this.length},e.prototype.unshift=function(e){var t={data:e,next:this.head};0===this.length&&(this.tail=t),this.head=t,++this.length},e.prototype.shift=function(){if(0!==this.length){var e=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,e}},e.prototype.clear=function(){this.head=this.tail=null,this.length=0},e.prototype.join=function(e){if(0===this.length)return"";for(var t=this.head,n=""+t.data;t=t.next;)n+=e+t.data;return n},e.prototype.concat=function(e){if(0===this.length)return s.alloc(0);if(1===this.length)return this.head.data;for(var t,n,r,a=s.allocUnsafe(e>>>0),o=this.head,i=0;o;)t=o.data,n=a,r=i,t.copy(n,r),i+=o.data.length,o=o.next;return a},e}(),r&&r.inspect&&r.inspect.custom&&(e.exports.prototype[r.inspect.custom]=function(){var e=r.inspect({length:this.length});return this.constructor.name+" "+e})},function(e,t){},function(e,t,n){(function(e){var s=void 0!==e&&e||"undefined"!=typeof self&&self||window,r=Function.prototype.apply;function a(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new a(r.call(setTimeout,s,arguments),clearTimeout)},t.setInterval=function(){return new a(r.call(setInterval,s,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},a.prototype.unref=a.prototype.ref=function(){},a.prototype.close=function(){this._clearFn.call(s,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout((function(){e._onTimeout&&e._onTimeout()}),t))},n(641),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,n(35))},function(e,t,n){(function(e,t){!function(e,n){"use strict";if(!e.setImmediate){var s,r,a,o,i,l=1,c={},u=!1,h=e.document,d=Object.getPrototypeOf&&Object.getPrototypeOf(e);d=d&&d.setTimeout?d:e,"[object process]"==={}.toString.call(e.process)?s=function(e){t.nextTick((function(){f(e)}))}:!function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?e.MessageChannel?((a=new MessageChannel).port1.onmessage=function(e){f(e.data)},s=function(e){a.port2.postMessage(e)}):h&&"onreadystatechange"in h.createElement("script")?(r=h.documentElement,s=function(e){var t=h.createElement("script");t.onreadystatechange=function(){f(e),t.onreadystatechange=null,r.removeChild(t),t=null},r.appendChild(t)}):s=function(e){setTimeout(f,0,e)}:(o="setImmediate$"+Math.random()+"$",i=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(o)&&f(+t.data.slice(o.length))},e.addEventListener?e.addEventListener("message",i,!1):e.attachEvent("onmessage",i),s=function(t){e.postMessage(o+t,"*")}),d.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var r={callback:e,args:t};return c[l]=r,s(l),l++},d.clearImmediate=p}function p(e){delete c[e]}function f(e){if(u)setTimeout(f,0,e);else{var t=c[e];if(t){u=!0;try{!function(e){var t=e.callback,n=e.args;switch(n.length){case 0:t();break;case 1:t(n[0]);break;case 2:t(n[0],n[1]);break;case 3:t(n[0],n[1],n[2]);break;default:t.apply(void 0,n)}}(t)}finally{p(e),u=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,n(35),n(43))},function(e,t,n){(function(t){function n(e){try{if(!t.localStorage)return!1}catch(e){return!1}var n=t.localStorage[e];return null!=n&&"true"===String(n).toLowerCase()}e.exports=function(e,t){if(n("noDeprecation"))return e;var s=!1;return function(){if(!s){if(n("throwDeprecation"))throw new Error(t);n("traceDeprecation")?console.trace(t):console.warn(t),s=!0}return e.apply(this,arguments)}}}).call(this,n(35))},function(e,t,n){"use strict";e.exports=a;var s=n(326),r=n(116);function a(e){if(!(this instanceof a))return new a(e);s.call(this,e)}r.inherits=n(78),r.inherits(a,s),a.prototype._transform=function(e,t,n){n(null,e)}},function(e,t,n){e.exports=n(218)},function(e,t,n){e.exports=n(79)},function(e,t,n){e.exports=n(217).Transform},function(e,t,n){e.exports=n(217).PassThrough},function(e,t,n){"use strict";(function(e,s){var r=n(327),a=n(650),o=n(651),i=n(654),l=n(657);for(var c in l)t[c]=l[c];t.NONE=0,t.DEFLATE=1,t.INFLATE=2,t.GZIP=3,t.GUNZIP=4,t.DEFLATERAW=5,t.INFLATERAW=6,t.UNZIP=7;function u(e){if("number"!=typeof e||e<t.DEFLATE||e>t.UNZIP)throw new TypeError("Bad argument");this.dictionary=null,this.err=0,this.flush=0,this.init_done=!1,this.level=0,this.memLevel=0,this.mode=e,this.strategy=0,this.windowBits=0,this.write_in_progress=!1,this.pending_close=!1,this.gzip_id_bytes_read=0}u.prototype.close=function(){this.write_in_progress?this.pending_close=!0:(this.pending_close=!1,r(this.init_done,"close before init"),r(this.mode<=t.UNZIP),this.mode===t.DEFLATE||this.mode===t.GZIP||this.mode===t.DEFLATERAW?o.deflateEnd(this.strm):this.mode!==t.INFLATE&&this.mode!==t.GUNZIP&&this.mode!==t.INFLATERAW&&this.mode!==t.UNZIP||i.inflateEnd(this.strm),this.mode=t.NONE,this.dictionary=null)},u.prototype.write=function(e,t,n,s,r,a,o){return this._write(!0,e,t,n,s,r,a,o)},u.prototype.writeSync=function(e,t,n,s,r,a,o){return this._write(!1,e,t,n,s,r,a,o)},u.prototype._write=function(n,a,o,i,l,c,u,h){if(r.equal(arguments.length,8),r(this.init_done,"write before init"),r(this.mode!==t.NONE,"already finalized"),r.equal(!1,this.write_in_progress,"write already in progress"),r.equal(!1,this.pending_close,"close is pending"),this.write_in_progress=!0,r.equal(!1,void 0===a,"must provide flush value"),this.write_in_progress=!0,a!==t.Z_NO_FLUSH&&a!==t.Z_PARTIAL_FLUSH&&a!==t.Z_SYNC_FLUSH&&a!==t.Z_FULL_FLUSH&&a!==t.Z_FINISH&&a!==t.Z_BLOCK)throw new Error("Invalid flush value");if(null==o&&(o=e.alloc(0),l=0,i=0),this.strm.avail_in=l,this.strm.input=o,this.strm.next_in=i,this.strm.avail_out=h,this.strm.output=c,this.strm.next_out=u,this.flush=a,!n)return this._process(),this._checkError()?this._afterSync():void 0;var d=this;return s.nextTick((function(){d._process(),d._after()})),this},u.prototype._afterSync=function(){var e=this.strm.avail_out,t=this.strm.avail_in;return this.write_in_progress=!1,[t,e]},u.prototype._process=function(){var e=null;switch(this.mode){case t.DEFLATE:case t.GZIP:case t.DEFLATERAW:this.err=o.deflate(this.strm,this.flush);break;case t.UNZIP:switch(this.strm.avail_in>0&&(e=this.strm.next_in),this.gzip_id_bytes_read){case 0:if(null===e)break;if(31!==this.strm.input[e]){this.mode=t.INFLATE;break}if(this.gzip_id_bytes_read=1,e++,1===this.strm.avail_in)break;case 1:if(null===e)break;139===this.strm.input[e]?(this.gzip_id_bytes_read=2,this.mode=t.GUNZIP):this.mode=t.INFLATE;break;default:throw new Error("invalid number of gzip magic number bytes read")}case t.INFLATE:case t.GUNZIP:case t.INFLATERAW:for(this.err=i.inflate(this.strm,this.flush),this.err===t.Z_NEED_DICT&&this.dictionary&&(this.err=i.inflateSetDictionary(this.strm,this.dictionary),this.err===t.Z_OK?this.err=i.inflate(this.strm,this.flush):this.err===t.Z_DATA_ERROR&&(this.err=t.Z_NEED_DICT));this.strm.avail_in>0&&this.mode===t.GUNZIP&&this.err===t.Z_STREAM_END&&0!==this.strm.next_in[0];)this.reset(),this.err=i.inflate(this.strm,this.flush);break;default:throw new Error("Unknown mode "+this.mode)}},u.prototype._checkError=function(){switch(this.err){case t.Z_OK:case t.Z_BUF_ERROR:if(0!==this.strm.avail_out&&this.flush===t.Z_FINISH)return this._error("unexpected end of file"),!1;break;case t.Z_STREAM_END:break;case t.Z_NEED_DICT:return null==this.dictionary?this._error("Missing dictionary"):this._error("Bad dictionary"),!1;default:return this._error("Zlib error"),!1}return!0},u.prototype._after=function(){if(this._checkError()){var e=this.strm.avail_out,t=this.strm.avail_in;this.write_in_progress=!1,this.callback(t,e),this.pending_close&&this.close()}},u.prototype._error=function(e){this.strm.msg&&(e=this.strm.msg),this.onerror(e,this.err),this.write_in_progress=!1,this.pending_close&&this.close()},u.prototype.init=function(e,n,s,a,o){r(4===arguments.length||5===arguments.length,"init(windowBits, level, memLevel, strategy, [dictionary])"),r(e>=8&&e<=15,"invalid windowBits"),r(n>=-1&&n<=9,"invalid compression level"),r(s>=1&&s<=9,"invalid memlevel"),r(a===t.Z_FILTERED||a===t.Z_HUFFMAN_ONLY||a===t.Z_RLE||a===t.Z_FIXED||a===t.Z_DEFAULT_STRATEGY,"invalid strategy"),this._init(n,e,s,a,o),this._setDictionary()},u.prototype.params=function(){throw new Error("deflateParams Not supported")},u.prototype.reset=function(){this._reset(),this._setDictionary()},u.prototype._init=function(e,n,s,r,l){switch(this.level=e,this.windowBits=n,this.memLevel=s,this.strategy=r,this.flush=t.Z_NO_FLUSH,this.err=t.Z_OK,this.mode!==t.GZIP&&this.mode!==t.GUNZIP||(this.windowBits+=16),this.mode===t.UNZIP&&(this.windowBits+=32),this.mode!==t.DEFLATERAW&&this.mode!==t.INFLATERAW||(this.windowBits=-1*this.windowBits),this.strm=new a,this.mode){case t.DEFLATE:case t.GZIP:case t.DEFLATERAW:this.err=o.deflateInit2(this.strm,this.level,t.Z_DEFLATED,this.windowBits,this.memLevel,this.strategy);break;case t.INFLATE:case t.GUNZIP:case t.INFLATERAW:case t.UNZIP:this.err=i.inflateInit2(this.strm,this.windowBits);break;default:throw new Error("Unknown mode "+this.mode)}this.err!==t.Z_OK&&this._error("Init error"),this.dictionary=l,this.write_in_progress=!1,this.init_done=!0},u.prototype._setDictionary=function(){if(null!=this.dictionary){switch(this.err=t.Z_OK,this.mode){case t.DEFLATE:case t.DEFLATERAW:this.err=o.deflateSetDictionary(this.strm,this.dictionary)}this.err!==t.Z_OK&&this._error("Failed to set dictionary")}},u.prototype._reset=function(){switch(this.err=t.Z_OK,this.mode){case t.DEFLATE:case t.DEFLATERAW:case t.GZIP:this.err=o.deflateReset(this.strm);break;case t.INFLATE:case t.INFLATERAW:case t.GUNZIP:this.err=i.inflateReset(this.strm)}this.err!==t.Z_OK&&this._error("Failed to reset stream")},t.Zlib=u}).call(this,n(96).Buffer,n(43))},function(e,t){e.exports=function(e){return e&&"object"==typeof e&&"function"==typeof e.copy&&"function"==typeof e.fill&&"function"==typeof e.readUInt8}},function(e,t,n){"use strict";e.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},function(e,t,n){"use strict";var s,r=n(156),a=n(652),o=n(329),i=n(330),l=n(653);function c(e,t){return e.msg=l[t],t}function u(e){return(e<<1)-(e>4?9:0)}function h(e){for(var t=e.length;--t>=0;)e[t]=0}function d(e){var t=e.state,n=t.pending;n>e.avail_out&&(n=e.avail_out),0!==n&&(r.arraySet(e.output,t.pending_buf,t.pending_out,n,e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,0===t.pending&&(t.pending_out=0))}function p(e,t){a._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,d(e.strm)}function f(e,t){e.pending_buf[e.pending++]=t}function m(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function g(e,t){var n,s,r=e.max_chain_length,a=e.strstart,o=e.prev_length,i=e.nice_match,l=e.strstart>e.w_size-262?e.strstart-(e.w_size-262):0,c=e.window,u=e.w_mask,h=e.prev,d=e.strstart+258,p=c[a+o-1],f=c[a+o];e.prev_length>=e.good_match&&(r>>=2),i>e.lookahead&&(i=e.lookahead);do{if(c[(n=t)+o]===f&&c[n+o-1]===p&&c[n]===c[a]&&c[++n]===c[a+1]){a+=2,n++;do{}while(c[++a]===c[++n]&&c[++a]===c[++n]&&c[++a]===c[++n]&&c[++a]===c[++n]&&c[++a]===c[++n]&&c[++a]===c[++n]&&c[++a]===c[++n]&&c[++a]===c[++n]&&a<d);if(s=258-(d-a),a=d-258,s>o){if(e.match_start=t,o=s,s>=i)break;p=c[a+o-1],f=c[a+o]}}}while((t=h[t&u])>l&&0!=--r);return o<=e.lookahead?o:e.lookahead}function y(e){var t,n,s,a,l,c,u,h,d,p,f=e.w_size;do{if(a=e.window_size-e.lookahead-e.strstart,e.strstart>=f+(f-262)){r.arraySet(e.window,e.window,f,f,0),e.match_start-=f,e.strstart-=f,e.block_start-=f,t=n=e.hash_size;do{s=e.head[--t],e.head[t]=s>=f?s-f:0}while(--n);t=n=f;do{s=e.prev[--t],e.prev[t]=s>=f?s-f:0}while(--n);a+=f}if(0===e.strm.avail_in)break;if(c=e.strm,u=e.window,h=e.strstart+e.lookahead,d=a,p=void 0,(p=c.avail_in)>d&&(p=d),n=0===p?0:(c.avail_in-=p,r.arraySet(u,c.input,c.next_in,p,h),1===c.state.wrap?c.adler=o(c.adler,u,p,h):2===c.state.wrap&&(c.adler=i(c.adler,u,p,h)),c.next_in+=p,c.total_in+=p,p),e.lookahead+=n,e.lookahead+e.insert>=3)for(l=e.strstart-e.insert,e.ins_h=e.window[l],e.ins_h=(e.ins_h<<e.hash_shift^e.window[l+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[l+3-1])&e.hash_mask,e.prev[l&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=l,l++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<262&&0!==e.strm.avail_in)}function v(e,t){for(var n,s;;){if(e.lookahead<262){if(y(e),e.lookahead<262&&0===t)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==n&&e.strstart-n<=e.w_size-262&&(e.match_length=g(e,n)),e.match_length>=3)if(s=a._tr_tally(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else s=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(s&&(p(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,4===t?(p(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(p(e,!1),0===e.strm.avail_out)?1:2}function b(e,t){for(var n,s,r;;){if(e.lookahead<262){if(y(e),e.lookahead<262&&0===t)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==n&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-262&&(e.match_length=g(e,n),e.match_length<=5&&(1===e.strategy||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){r=e.strstart+e.lookahead-3,s=a._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=r&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+3-1])&e.hash_mask,n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,s&&(p(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if((s=a._tr_tally(e,0,e.window[e.strstart-1]))&&p(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(s=a._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,4===t?(p(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(p(e,!1),0===e.strm.avail_out)?1:2}function _(e,t,n,s,r){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=s,this.func=r}function E(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new r.Buf16(1146),this.dyn_dtree=new r.Buf16(122),this.bl_tree=new r.Buf16(78),h(this.dyn_ltree),h(this.dyn_dtree),h(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new r.Buf16(16),this.heap=new r.Buf16(573),h(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new r.Buf16(573),h(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function S(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=2,(t=e.state).pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?42:113,e.adler=2===t.wrap?0:1,t.last_flush=0,a._tr_init(t),0):c(e,-2)}function w(e){var t,n=S(e);return 0===n&&((t=e.state).window_size=2*t.w_size,h(t.head),t.max_lazy_match=s[t.level].max_lazy,t.good_match=s[t.level].good_length,t.nice_match=s[t.level].nice_length,t.max_chain_length=s[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=2,t.match_available=0,t.ins_h=0),n}function C(e,t,n,s,a,o){if(!e)return-2;var i=1;if(-1===t&&(t=6),s<0?(i=0,s=-s):s>15&&(i=2,s-=16),a<1||a>9||8!==n||s<8||s>15||t<0||t>9||o<0||o>4)return c(e,-2);8===s&&(s=9);var l=new E;return e.state=l,l.strm=e,l.wrap=i,l.gzhead=null,l.w_bits=s,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=a+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+3-1)/3),l.window=new r.Buf8(2*l.w_size),l.head=new r.Buf16(l.hash_size),l.prev=new r.Buf16(l.w_size),l.lit_bufsize=1<<a+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new r.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=t,l.strategy=o,l.method=n,w(e)}s=[new _(0,0,0,0,(function(e,t){var n=65535;for(n>e.pending_buf_size-5&&(n=e.pending_buf_size-5);;){if(e.lookahead<=1){if(y(e),0===e.lookahead&&0===t)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var s=e.block_start+n;if((0===e.strstart||e.strstart>=s)&&(e.lookahead=e.strstart-s,e.strstart=s,p(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-262&&(p(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(p(e,!0),0===e.strm.avail_out?3:4):(e.strstart>e.block_start&&(p(e,!1),e.strm.avail_out),1)})),new _(4,4,8,4,v),new _(4,5,16,8,v),new _(4,6,32,32,v),new _(4,4,16,16,b),new _(8,16,32,32,b),new _(8,16,128,128,b),new _(8,32,128,256,b),new _(32,128,258,1024,b),new _(32,258,258,4096,b)],t.deflateInit=function(e,t){return C(e,t,8,15,8,0)},t.deflateInit2=C,t.deflateReset=w,t.deflateResetKeep=S,t.deflateSetHeader=function(e,t){return e&&e.state?2!==e.state.wrap?-2:(e.state.gzhead=t,0):-2},t.deflate=function(e,t){var n,r,o,l;if(!e||!e.state||t>5||t<0)return e?c(e,-2):-2;if(r=e.state,!e.output||!e.input&&0!==e.avail_in||666===r.status&&4!==t)return c(e,0===e.avail_out?-5:-2);if(r.strm=e,n=r.last_flush,r.last_flush=t,42===r.status)if(2===r.wrap)e.adler=0,f(r,31),f(r,139),f(r,8),r.gzhead?(f(r,(r.gzhead.text?1:0)+(r.gzhead.hcrc?2:0)+(r.gzhead.extra?4:0)+(r.gzhead.name?8:0)+(r.gzhead.comment?16:0)),f(r,255&r.gzhead.time),f(r,r.gzhead.time>>8&255),f(r,r.gzhead.time>>16&255),f(r,r.gzhead.time>>24&255),f(r,9===r.level?2:r.strategy>=2||r.level<2?4:0),f(r,255&r.gzhead.os),r.gzhead.extra&&r.gzhead.extra.length&&(f(r,255&r.gzhead.extra.length),f(r,r.gzhead.extra.length>>8&255)),r.gzhead.hcrc&&(e.adler=i(e.adler,r.pending_buf,r.pending,0)),r.gzindex=0,r.status=69):(f(r,0),f(r,0),f(r,0),f(r,0),f(r,0),f(r,9===r.level?2:r.strategy>=2||r.level<2?4:0),f(r,3),r.status=113);else{var g=8+(r.w_bits-8<<4)<<8;g|=(r.strategy>=2||r.level<2?0:r.level<6?1:6===r.level?2:3)<<6,0!==r.strstart&&(g|=32),g+=31-g%31,r.status=113,m(r,g),0!==r.strstart&&(m(r,e.adler>>>16),m(r,65535&e.adler)),e.adler=1}if(69===r.status)if(r.gzhead.extra){for(o=r.pending;r.gzindex<(65535&r.gzhead.extra.length)&&(r.pending!==r.pending_buf_size||(r.gzhead.hcrc&&r.pending>o&&(e.adler=i(e.adler,r.pending_buf,r.pending-o,o)),d(e),o=r.pending,r.pending!==r.pending_buf_size));)f(r,255&r.gzhead.extra[r.gzindex]),r.gzindex++;r.gzhead.hcrc&&r.pending>o&&(e.adler=i(e.adler,r.pending_buf,r.pending-o,o)),r.gzindex===r.gzhead.extra.length&&(r.gzindex=0,r.status=73)}else r.status=73;if(73===r.status)if(r.gzhead.name){o=r.pending;do{if(r.pending===r.pending_buf_size&&(r.gzhead.hcrc&&r.pending>o&&(e.adler=i(e.adler,r.pending_buf,r.pending-o,o)),d(e),o=r.pending,r.pending===r.pending_buf_size)){l=1;break}l=r.gzindex<r.gzhead.name.length?255&r.gzhead.name.charCodeAt(r.gzindex++):0,f(r,l)}while(0!==l);r.gzhead.hcrc&&r.pending>o&&(e.adler=i(e.adler,r.pending_buf,r.pending-o,o)),0===l&&(r.gzindex=0,r.status=91)}else r.status=91;if(91===r.status)if(r.gzhead.comment){o=r.pending;do{if(r.pending===r.pending_buf_size&&(r.gzhead.hcrc&&r.pending>o&&(e.adler=i(e.adler,r.pending_buf,r.pending-o,o)),d(e),o=r.pending,r.pending===r.pending_buf_size)){l=1;break}l=r.gzindex<r.gzhead.comment.length?255&r.gzhead.comment.charCodeAt(r.gzindex++):0,f(r,l)}while(0!==l);r.gzhead.hcrc&&r.pending>o&&(e.adler=i(e.adler,r.pending_buf,r.pending-o,o)),0===l&&(r.status=103)}else r.status=103;if(103===r.status&&(r.gzhead.hcrc?(r.pending+2>r.pending_buf_size&&d(e),r.pending+2<=r.pending_buf_size&&(f(r,255&e.adler),f(r,e.adler>>8&255),e.adler=0,r.status=113)):r.status=113),0!==r.pending){if(d(e),0===e.avail_out)return r.last_flush=-1,0}else if(0===e.avail_in&&u(t)<=u(n)&&4!==t)return c(e,-5);if(666===r.status&&0!==e.avail_in)return c(e,-5);if(0!==e.avail_in||0!==r.lookahead||0!==t&&666!==r.status){var v=2===r.strategy?function(e,t){for(var n;;){if(0===e.lookahead&&(y(e),0===e.lookahead)){if(0===t)return 1;break}if(e.match_length=0,n=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,n&&(p(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(p(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(p(e,!1),0===e.strm.avail_out)?1:2}(r,t):3===r.strategy?function(e,t){for(var n,s,r,o,i=e.window;;){if(e.lookahead<=258){if(y(e),e.lookahead<=258&&0===t)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(s=i[r=e.strstart-1])===i[++r]&&s===i[++r]&&s===i[++r]){o=e.strstart+258;do{}while(s===i[++r]&&s===i[++r]&&s===i[++r]&&s===i[++r]&&s===i[++r]&&s===i[++r]&&s===i[++r]&&s===i[++r]&&r<o);e.match_length=258-(o-r),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(n=a._tr_tally(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(p(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,4===t?(p(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(p(e,!1),0===e.strm.avail_out)?1:2}(r,t):s[r.level].func(r,t);if(3!==v&&4!==v||(r.status=666),1===v||3===v)return 0===e.avail_out&&(r.last_flush=-1),0;if(2===v&&(1===t?a._tr_align(r):5!==t&&(a._tr_stored_block(r,0,0,!1),3===t&&(h(r.head),0===r.lookahead&&(r.strstart=0,r.block_start=0,r.insert=0))),d(e),0===e.avail_out))return r.last_flush=-1,0}return 4!==t?0:r.wrap<=0?1:(2===r.wrap?(f(r,255&e.adler),f(r,e.adler>>8&255),f(r,e.adler>>16&255),f(r,e.adler>>24&255),f(r,255&e.total_in),f(r,e.total_in>>8&255),f(r,e.total_in>>16&255),f(r,e.total_in>>24&255)):(m(r,e.adler>>>16),m(r,65535&e.adler)),d(e),r.wrap>0&&(r.wrap=-r.wrap),0!==r.pending?0:1)},t.deflateEnd=function(e){var t;return e&&e.state?42!==(t=e.state.status)&&69!==t&&73!==t&&91!==t&&103!==t&&113!==t&&666!==t?c(e,-2):(e.state=null,113===t?c(e,-3):0):-2},t.deflateSetDictionary=function(e,t){var n,s,a,i,l,c,u,d,p=t.length;if(!e||!e.state)return-2;if(2===(i=(n=e.state).wrap)||1===i&&42!==n.status||n.lookahead)return-2;for(1===i&&(e.adler=o(e.adler,t,p,0)),n.wrap=0,p>=n.w_size&&(0===i&&(h(n.head),n.strstart=0,n.block_start=0,n.insert=0),d=new r.Buf8(n.w_size),r.arraySet(d,t,p-n.w_size,n.w_size,0),t=d,p=n.w_size),l=e.avail_in,c=e.next_in,u=e.input,e.avail_in=p,e.next_in=0,e.input=t,y(n);n.lookahead>=3;){s=n.strstart,a=n.lookahead-2;do{n.ins_h=(n.ins_h<<n.hash_shift^n.window[s+3-1])&n.hash_mask,n.prev[s&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=s,s++}while(--a);n.strstart=s,n.lookahead=2,y(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=2,n.match_available=0,e.next_in=c,e.input=u,e.avail_in=l,n.wrap=i,0},t.deflateInfo="pako deflate (from Nodeca project)"},function(e,t,n){"use strict";var s=n(156);function r(e){for(var t=e.length;--t>=0;)e[t]=0}var a=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],o=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],l=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],c=new Array(576);r(c);var u=new Array(60);r(u);var h=new Array(512);r(h);var d=new Array(256);r(d);var p=new Array(29);r(p);var f,m,g,y=new Array(30);function v(e,t,n,s,r){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=s,this.max_length=r,this.has_stree=e&&e.length}function b(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function _(e){return e<256?h[e]:h[256+(e>>>7)]}function E(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function S(e,t,n){e.bi_valid>16-n?(e.bi_buf|=t<<e.bi_valid&65535,E(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=n-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)}function w(e,t,n){S(e,n[2*t],n[2*t+1])}function C(e,t){var n=0;do{n|=1&e,e>>>=1,n<<=1}while(--t>0);return n>>>1}function O(e,t,n){var s,r,a=new Array(16),o=0;for(s=1;s<=15;s++)a[s]=o=o+n[s-1]<<1;for(r=0;r<=t;r++){var i=e[2*r+1];0!==i&&(e[2*r]=C(a[i]++,i))}}function T(e){var t;for(t=0;t<286;t++)e.dyn_ltree[2*t]=0;for(t=0;t<30;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function M(e){e.bi_valid>8?E(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function A(e,t,n,s){var r=2*t,a=2*n;return e[r]<e[a]||e[r]===e[a]&&s[t]<=s[n]}function N(e,t,n){for(var s=e.heap[n],r=n<<1;r<=e.heap_len&&(r<e.heap_len&&A(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!A(t,s,e.heap[r],e.depth));)e.heap[n]=e.heap[r],n=r,r<<=1;e.heap[n]=s}function x(e,t,n){var s,r,i,l,c=0;if(0!==e.last_lit)do{s=e.pending_buf[e.d_buf+2*c]<<8|e.pending_buf[e.d_buf+2*c+1],r=e.pending_buf[e.l_buf+c],c++,0===s?w(e,r,t):(w(e,(i=d[r])+256+1,t),0!==(l=a[i])&&S(e,r-=p[i],l),w(e,i=_(--s),n),0!==(l=o[i])&&S(e,s-=y[i],l))}while(c<e.last_lit);w(e,256,t)}function P(e,t){var n,s,r,a=t.dyn_tree,o=t.stat_desc.static_tree,i=t.stat_desc.has_stree,l=t.stat_desc.elems,c=-1;for(e.heap_len=0,e.heap_max=573,n=0;n<l;n++)0!==a[2*n]?(e.heap[++e.heap_len]=c=n,e.depth[n]=0):a[2*n+1]=0;for(;e.heap_len<2;)a[2*(r=e.heap[++e.heap_len]=c<2?++c:0)]=1,e.depth[r]=0,e.opt_len--,i&&(e.static_len-=o[2*r+1]);for(t.max_code=c,n=e.heap_len>>1;n>=1;n--)N(e,a,n);r=l;do{n=e.heap[1],e.heap[1]=e.heap[e.heap_len--],N(e,a,1),s=e.heap[1],e.heap[--e.heap_max]=n,e.heap[--e.heap_max]=s,a[2*r]=a[2*n]+a[2*s],e.depth[r]=(e.depth[n]>=e.depth[s]?e.depth[n]:e.depth[s])+1,a[2*n+1]=a[2*s+1]=r,e.heap[1]=r++,N(e,a,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],function(e,t){var n,s,r,a,o,i,l=t.dyn_tree,c=t.max_code,u=t.stat_desc.static_tree,h=t.stat_desc.has_stree,d=t.stat_desc.extra_bits,p=t.stat_desc.extra_base,f=t.stat_desc.max_length,m=0;for(a=0;a<=15;a++)e.bl_count[a]=0;for(l[2*e.heap[e.heap_max]+1]=0,n=e.heap_max+1;n<573;n++)(a=l[2*l[2*(s=e.heap[n])+1]+1]+1)>f&&(a=f,m++),l[2*s+1]=a,s>c||(e.bl_count[a]++,o=0,s>=p&&(o=d[s-p]),i=l[2*s],e.opt_len+=i*(a+o),h&&(e.static_len+=i*(u[2*s+1]+o)));if(0!==m){do{for(a=f-1;0===e.bl_count[a];)a--;e.bl_count[a]--,e.bl_count[a+1]+=2,e.bl_count[f]--,m-=2}while(m>0);for(a=f;0!==a;a--)for(s=e.bl_count[a];0!==s;)(r=e.heap[--n])>c||(l[2*r+1]!==a&&(e.opt_len+=(a-l[2*r+1])*l[2*r],l[2*r+1]=a),s--)}}(e,t),O(a,c,e.bl_count)}function I(e,t,n){var s,r,a=-1,o=t[1],i=0,l=7,c=4;for(0===o&&(l=138,c=3),t[2*(n+1)+1]=65535,s=0;s<=n;s++)r=o,o=t[2*(s+1)+1],++i<l&&r===o||(i<c?e.bl_tree[2*r]+=i:0!==r?(r!==a&&e.bl_tree[2*r]++,e.bl_tree[32]++):i<=10?e.bl_tree[34]++:e.bl_tree[36]++,i=0,a=r,0===o?(l=138,c=3):r===o?(l=6,c=3):(l=7,c=4))}function D(e,t,n){var s,r,a=-1,o=t[1],i=0,l=7,c=4;for(0===o&&(l=138,c=3),s=0;s<=n;s++)if(r=o,o=t[2*(s+1)+1],!(++i<l&&r===o)){if(i<c)do{w(e,r,e.bl_tree)}while(0!=--i);else 0!==r?(r!==a&&(w(e,r,e.bl_tree),i--),w(e,16,e.bl_tree),S(e,i-3,2)):i<=10?(w(e,17,e.bl_tree),S(e,i-3,3)):(w(e,18,e.bl_tree),S(e,i-11,7));i=0,a=r,0===o?(l=138,c=3):r===o?(l=6,c=3):(l=7,c=4)}}r(y);var k=!1;function L(e,t,n,r){S(e,0+(r?1:0),3),function(e,t,n,r){M(e),r&&(E(e,n),E(e,~n)),s.arraySet(e.pending_buf,e.window,t,n,e.pending),e.pending+=n}(e,t,n,!0)}t._tr_init=function(e){k||(!function(){var e,t,n,s,r,l=new Array(16);for(n=0,s=0;s<28;s++)for(p[s]=n,e=0;e<1<<a[s];e++)d[n++]=s;for(d[n-1]=s,r=0,s=0;s<16;s++)for(y[s]=r,e=0;e<1<<o[s];e++)h[r++]=s;for(r>>=7;s<30;s++)for(y[s]=r<<7,e=0;e<1<<o[s]-7;e++)h[256+r++]=s;for(t=0;t<=15;t++)l[t]=0;for(e=0;e<=143;)c[2*e+1]=8,e++,l[8]++;for(;e<=255;)c[2*e+1]=9,e++,l[9]++;for(;e<=279;)c[2*e+1]=7,e++,l[7]++;for(;e<=287;)c[2*e+1]=8,e++,l[8]++;for(O(c,287,l),e=0;e<30;e++)u[2*e+1]=5,u[2*e]=C(e,5);f=new v(c,a,257,286,15),m=new v(u,o,0,30,15),g=new v(new Array(0),i,0,19,7)}(),k=!0),e.l_desc=new b(e.dyn_ltree,f),e.d_desc=new b(e.dyn_dtree,m),e.bl_desc=new b(e.bl_tree,g),e.bi_buf=0,e.bi_valid=0,T(e)},t._tr_stored_block=L,t._tr_flush_block=function(e,t,n,s){var r,a,o=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=function(e){var t,n=4093624447;for(t=0;t<=31;t++,n>>>=1)if(1&n&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<256;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0}(e)),P(e,e.l_desc),P(e,e.d_desc),o=function(e){var t;for(I(e,e.dyn_ltree,e.l_desc.max_code),I(e,e.dyn_dtree,e.d_desc.max_code),P(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*l[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}(e),r=e.opt_len+3+7>>>3,(a=e.static_len+3+7>>>3)<=r&&(r=a)):r=a=n+5,n+4<=r&&-1!==t?L(e,t,n,s):4===e.strategy||a===r?(S(e,2+(s?1:0),3),x(e,c,u)):(S(e,4+(s?1:0),3),function(e,t,n,s){var r;for(S(e,t-257,5),S(e,n-1,5),S(e,s-4,4),r=0;r<s;r++)S(e,e.bl_tree[2*l[r]+1],3);D(e,e.dyn_ltree,t-1),D(e,e.dyn_dtree,n-1)}(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),x(e,e.dyn_ltree,e.dyn_dtree)),T(e),s&&M(e)},t._tr_tally=function(e,t,n){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&n,e.last_lit++,0===t?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*(d[n]+256+1)]++,e.dyn_dtree[2*_(t)]++),e.last_lit===e.lit_bufsize-1},t._tr_align=function(e){S(e,2,3),w(e,256,c),function(e){16===e.bi_valid?(E(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}(e)}},function(e,t,n){"use strict";e.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},function(e,t,n){"use strict";var s=n(156),r=n(329),a=n(330),o=n(655),i=n(656);function l(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function c(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new s.Buf16(320),this.work=new s.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function u(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new s.Buf32(852),t.distcode=t.distdyn=new s.Buf32(592),t.sane=1,t.back=-1,0):-2}function h(e){var t;return e&&e.state?((t=e.state).wsize=0,t.whave=0,t.wnext=0,u(e)):-2}function d(e,t){var n,s;return e&&e.state?(s=e.state,t<0?(n=0,t=-t):(n=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?-2:(null!==s.window&&s.wbits!==t&&(s.window=null),s.wrap=n,s.wbits=t,h(e))):-2}function p(e,t){var n,s;return e?(s=new c,e.state=s,s.window=null,0!==(n=d(e,t))&&(e.state=null),n):-2}var f,m,g=!0;function y(e){if(g){var t;for(f=new s.Buf32(512),m=new s.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(i(1,e.lens,0,288,f,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;i(2,e.lens,0,32,m,0,e.work,{bits:5}),g=!1}e.lencode=f,e.lenbits=9,e.distcode=m,e.distbits=5}function v(e,t,n,r){var a,o=e.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new s.Buf8(o.wsize)),r>=o.wsize?(s.arraySet(o.window,t,n-o.wsize,o.wsize,0),o.wnext=0,o.whave=o.wsize):((a=o.wsize-o.wnext)>r&&(a=r),s.arraySet(o.window,t,n-r,a,o.wnext),(r-=a)?(s.arraySet(o.window,t,n-r,r,0),o.wnext=r,o.whave=o.wsize):(o.wnext+=a,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=a))),0}t.inflateReset=h,t.inflateReset2=d,t.inflateResetKeep=u,t.inflateInit=function(e){return p(e,15)},t.inflateInit2=p,t.inflate=function(e,t){var n,c,u,h,d,p,f,m,g,b,_,E,S,w,C,O,T,M,A,N,x,P,I,D,k=0,L=new s.Buf8(4),R=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return-2;12===(n=e.state).mode&&(n.mode=13),d=e.next_out,u=e.output,f=e.avail_out,h=e.next_in,c=e.input,p=e.avail_in,m=n.hold,g=n.bits,b=p,_=f,P=0;e:for(;;)switch(n.mode){case 1:if(0===n.wrap){n.mode=13;break}for(;g<16;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}if(2&n.wrap&&35615===m){n.check=0,L[0]=255&m,L[1]=m>>>8&255,n.check=a(n.check,L,2,0),m=0,g=0,n.mode=2;break}if(n.flags=0,n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&m)<<8)+(m>>8))%31){e.msg="incorrect header check",n.mode=30;break}if(8!=(15&m)){e.msg="unknown compression method",n.mode=30;break}if(g-=4,x=8+(15&(m>>>=4)),0===n.wbits)n.wbits=x;else if(x>n.wbits){e.msg="invalid window size",n.mode=30;break}n.dmax=1<<x,e.adler=n.check=1,n.mode=512&m?10:12,m=0,g=0;break;case 2:for(;g<16;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}if(n.flags=m,8!=(255&n.flags)){e.msg="unknown compression method",n.mode=30;break}if(57344&n.flags){e.msg="unknown header flags set",n.mode=30;break}n.head&&(n.head.text=m>>8&1),512&n.flags&&(L[0]=255&m,L[1]=m>>>8&255,n.check=a(n.check,L,2,0)),m=0,g=0,n.mode=3;case 3:for(;g<32;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}n.head&&(n.head.time=m),512&n.flags&&(L[0]=255&m,L[1]=m>>>8&255,L[2]=m>>>16&255,L[3]=m>>>24&255,n.check=a(n.check,L,4,0)),m=0,g=0,n.mode=4;case 4:for(;g<16;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}n.head&&(n.head.xflags=255&m,n.head.os=m>>8),512&n.flags&&(L[0]=255&m,L[1]=m>>>8&255,n.check=a(n.check,L,2,0)),m=0,g=0,n.mode=5;case 5:if(1024&n.flags){for(;g<16;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}n.length=m,n.head&&(n.head.extra_len=m),512&n.flags&&(L[0]=255&m,L[1]=m>>>8&255,n.check=a(n.check,L,2,0)),m=0,g=0}else n.head&&(n.head.extra=null);n.mode=6;case 6:if(1024&n.flags&&((E=n.length)>p&&(E=p),E&&(n.head&&(x=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Array(n.head.extra_len)),s.arraySet(n.head.extra,c,h,E,x)),512&n.flags&&(n.check=a(n.check,c,E,h)),p-=E,h+=E,n.length-=E),n.length))break e;n.length=0,n.mode=7;case 7:if(2048&n.flags){if(0===p)break e;E=0;do{x=c[h+E++],n.head&&x&&n.length<65536&&(n.head.name+=String.fromCharCode(x))}while(x&&E<p);if(512&n.flags&&(n.check=a(n.check,c,E,h)),p-=E,h+=E,x)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=8;case 8:if(4096&n.flags){if(0===p)break e;E=0;do{x=c[h+E++],n.head&&x&&n.length<65536&&(n.head.comment+=String.fromCharCode(x))}while(x&&E<p);if(512&n.flags&&(n.check=a(n.check,c,E,h)),p-=E,h+=E,x)break e}else n.head&&(n.head.comment=null);n.mode=9;case 9:if(512&n.flags){for(;g<16;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}if(m!==(65535&n.check)){e.msg="header crc mismatch",n.mode=30;break}m=0,g=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=12;break;case 10:for(;g<32;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}e.adler=n.check=l(m),m=0,g=0,n.mode=11;case 11:if(0===n.havedict)return e.next_out=d,e.avail_out=f,e.next_in=h,e.avail_in=p,n.hold=m,n.bits=g,2;e.adler=n.check=1,n.mode=12;case 12:if(5===t||6===t)break e;case 13:if(n.last){m>>>=7&g,g-=7&g,n.mode=27;break}for(;g<3;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}switch(n.last=1&m,g-=1,3&(m>>>=1)){case 0:n.mode=14;break;case 1:if(y(n),n.mode=20,6===t){m>>>=2,g-=2;break e}break;case 2:n.mode=17;break;case 3:e.msg="invalid block type",n.mode=30}m>>>=2,g-=2;break;case 14:for(m>>>=7&g,g-=7&g;g<32;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}if((65535&m)!=(m>>>16^65535)){e.msg="invalid stored block lengths",n.mode=30;break}if(n.length=65535&m,m=0,g=0,n.mode=15,6===t)break e;case 15:n.mode=16;case 16:if(E=n.length){if(E>p&&(E=p),E>f&&(E=f),0===E)break e;s.arraySet(u,c,h,E,d),p-=E,h+=E,f-=E,d+=E,n.length-=E;break}n.mode=12;break;case 17:for(;g<14;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}if(n.nlen=257+(31&m),m>>>=5,g-=5,n.ndist=1+(31&m),m>>>=5,g-=5,n.ncode=4+(15&m),m>>>=4,g-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=30;break}n.have=0,n.mode=18;case 18:for(;n.have<n.ncode;){for(;g<3;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}n.lens[R[n.have++]]=7&m,m>>>=3,g-=3}for(;n.have<19;)n.lens[R[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,I={bits:n.lenbits},P=i(0,n.lens,0,19,n.lencode,0,n.work,I),n.lenbits=I.bits,P){e.msg="invalid code lengths set",n.mode=30;break}n.have=0,n.mode=19;case 19:for(;n.have<n.nlen+n.ndist;){for(;O=(k=n.lencode[m&(1<<n.lenbits)-1])>>>16&255,T=65535&k,!((C=k>>>24)<=g);){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}if(T<16)m>>>=C,g-=C,n.lens[n.have++]=T;else{if(16===T){for(D=C+2;g<D;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}if(m>>>=C,g-=C,0===n.have){e.msg="invalid bit length repeat",n.mode=30;break}x=n.lens[n.have-1],E=3+(3&m),m>>>=2,g-=2}else if(17===T){for(D=C+3;g<D;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}g-=C,x=0,E=3+(7&(m>>>=C)),m>>>=3,g-=3}else{for(D=C+7;g<D;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}g-=C,x=0,E=11+(127&(m>>>=C)),m>>>=7,g-=7}if(n.have+E>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=30;break}for(;E--;)n.lens[n.have++]=x}}if(30===n.mode)break;if(0===n.lens[256]){e.msg="invalid code -- missing end-of-block",n.mode=30;break}if(n.lenbits=9,I={bits:n.lenbits},P=i(1,n.lens,0,n.nlen,n.lencode,0,n.work,I),n.lenbits=I.bits,P){e.msg="invalid literal/lengths set",n.mode=30;break}if(n.distbits=6,n.distcode=n.distdyn,I={bits:n.distbits},P=i(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,I),n.distbits=I.bits,P){e.msg="invalid distances set",n.mode=30;break}if(n.mode=20,6===t)break e;case 20:n.mode=21;case 21:if(p>=6&&f>=258){e.next_out=d,e.avail_out=f,e.next_in=h,e.avail_in=p,n.hold=m,n.bits=g,o(e,_),d=e.next_out,u=e.output,f=e.avail_out,h=e.next_in,c=e.input,p=e.avail_in,m=n.hold,g=n.bits,12===n.mode&&(n.back=-1);break}for(n.back=0;O=(k=n.lencode[m&(1<<n.lenbits)-1])>>>16&255,T=65535&k,!((C=k>>>24)<=g);){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}if(O&&0==(240&O)){for(M=C,A=O,N=T;O=(k=n.lencode[N+((m&(1<<M+A)-1)>>M)])>>>16&255,T=65535&k,!(M+(C=k>>>24)<=g);){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}m>>>=M,g-=M,n.back+=M}if(m>>>=C,g-=C,n.back+=C,n.length=T,0===O){n.mode=26;break}if(32&O){n.back=-1,n.mode=12;break}if(64&O){e.msg="invalid literal/length code",n.mode=30;break}n.extra=15&O,n.mode=22;case 22:if(n.extra){for(D=n.extra;g<D;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}n.length+=m&(1<<n.extra)-1,m>>>=n.extra,g-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=23;case 23:for(;O=(k=n.distcode[m&(1<<n.distbits)-1])>>>16&255,T=65535&k,!((C=k>>>24)<=g);){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}if(0==(240&O)){for(M=C,A=O,N=T;O=(k=n.distcode[N+((m&(1<<M+A)-1)>>M)])>>>16&255,T=65535&k,!(M+(C=k>>>24)<=g);){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}m>>>=M,g-=M,n.back+=M}if(m>>>=C,g-=C,n.back+=C,64&O){e.msg="invalid distance code",n.mode=30;break}n.offset=T,n.extra=15&O,n.mode=24;case 24:if(n.extra){for(D=n.extra;g<D;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}n.offset+=m&(1<<n.extra)-1,m>>>=n.extra,g-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=30;break}n.mode=25;case 25:if(0===f)break e;if(E=_-f,n.offset>E){if((E=n.offset-E)>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=30;break}E>n.wnext?(E-=n.wnext,S=n.wsize-E):S=n.wnext-E,E>n.length&&(E=n.length),w=n.window}else w=u,S=d-n.offset,E=n.length;E>f&&(E=f),f-=E,n.length-=E;do{u[d++]=w[S++]}while(--E);0===n.length&&(n.mode=21);break;case 26:if(0===f)break e;u[d++]=n.length,f--,n.mode=21;break;case 27:if(n.wrap){for(;g<32;){if(0===p)break e;p--,m|=c[h++]<<g,g+=8}if(_-=f,e.total_out+=_,n.total+=_,_&&(e.adler=n.check=n.flags?a(n.check,u,_,d-_):r(n.check,u,_,d-_)),_=f,(n.flags?m:l(m))!==n.check){e.msg="incorrect data check",n.mode=30;break}m=0,g=0}n.mode=28;case 28:if(n.wrap&&n.flags){for(;g<32;){if(0===p)break e;p--,m+=c[h++]<<g,g+=8}if(m!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=30;break}m=0,g=0}n.mode=29;case 29:P=1;break e;case 30:P=-3;break e;case 31:return-4;case 32:default:return-2}return e.next_out=d,e.avail_out=f,e.next_in=h,e.avail_in=p,n.hold=m,n.bits=g,(n.wsize||_!==e.avail_out&&n.mode<30&&(n.mode<27||4!==t))&&v(e,e.output,e.next_out,_-e.avail_out)?(n.mode=31,-4):(b-=e.avail_in,_-=e.avail_out,e.total_in+=b,e.total_out+=_,n.total+=_,n.wrap&&_&&(e.adler=n.check=n.flags?a(n.check,u,_,e.next_out-_):r(n.check,u,_,e.next_out-_)),e.data_type=n.bits+(n.last?64:0)+(12===n.mode?128:0)+(20===n.mode||15===n.mode?256:0),(0===b&&0===_||4===t)&&0===P&&(P=-5),P)},t.inflateEnd=function(e){if(!e||!e.state)return-2;var t=e.state;return t.window&&(t.window=null),e.state=null,0},t.inflateGetHeader=function(e,t){var n;return e&&e.state?0==(2&(n=e.state).wrap)?-2:(n.head=t,t.done=!1,0):-2},t.inflateSetDictionary=function(e,t){var n,s=t.length;return e&&e.state?0!==(n=e.state).wrap&&11!==n.mode?-2:11===n.mode&&r(1,t,s,0)!==n.check?-3:v(e,t,s,s)?(n.mode=31,-4):(n.havedict=1,0):-2},t.inflateInfo="pako inflate (from Nodeca project)"},function(e,t,n){"use strict";e.exports=function(e,t){var n,s,r,a,o,i,l,c,u,h,d,p,f,m,g,y,v,b,_,E,S,w,C,O,T;n=e.state,s=e.next_in,O=e.input,r=s+(e.avail_in-5),a=e.next_out,T=e.output,o=a-(t-e.avail_out),i=a+(e.avail_out-257),l=n.dmax,c=n.wsize,u=n.whave,h=n.wnext,d=n.window,p=n.hold,f=n.bits,m=n.lencode,g=n.distcode,y=(1<<n.lenbits)-1,v=(1<<n.distbits)-1;e:do{f<15&&(p+=O[s++]<<f,f+=8,p+=O[s++]<<f,f+=8),b=m[p&y];t:for(;;){if(p>>>=_=b>>>24,f-=_,0===(_=b>>>16&255))T[a++]=65535&b;else{if(!(16&_)){if(0==(64&_)){b=m[(65535&b)+(p&(1<<_)-1)];continue t}if(32&_){n.mode=12;break e}e.msg="invalid literal/length code",n.mode=30;break e}E=65535&b,(_&=15)&&(f<_&&(p+=O[s++]<<f,f+=8),E+=p&(1<<_)-1,p>>>=_,f-=_),f<15&&(p+=O[s++]<<f,f+=8,p+=O[s++]<<f,f+=8),b=g[p&v];n:for(;;){if(p>>>=_=b>>>24,f-=_,!(16&(_=b>>>16&255))){if(0==(64&_)){b=g[(65535&b)+(p&(1<<_)-1)];continue n}e.msg="invalid distance code",n.mode=30;break e}if(S=65535&b,f<(_&=15)&&(p+=O[s++]<<f,(f+=8)<_&&(p+=O[s++]<<f,f+=8)),(S+=p&(1<<_)-1)>l){e.msg="invalid distance too far back",n.mode=30;break e}if(p>>>=_,f-=_,S>(_=a-o)){if((_=S-_)>u&&n.sane){e.msg="invalid distance too far back",n.mode=30;break e}if(w=0,C=d,0===h){if(w+=c-_,_<E){E-=_;do{T[a++]=d[w++]}while(--_);w=a-S,C=T}}else if(h<_){if(w+=c+h-_,(_-=h)<E){E-=_;do{T[a++]=d[w++]}while(--_);if(w=0,h<E){E-=_=h;do{T[a++]=d[w++]}while(--_);w=a-S,C=T}}}else if(w+=h-_,_<E){E-=_;do{T[a++]=d[w++]}while(--_);w=a-S,C=T}for(;E>2;)T[a++]=C[w++],T[a++]=C[w++],T[a++]=C[w++],E-=3;E&&(T[a++]=C[w++],E>1&&(T[a++]=C[w++]))}else{w=a-S;do{T[a++]=T[w++],T[a++]=T[w++],T[a++]=T[w++],E-=3}while(E>2);E&&(T[a++]=T[w++],E>1&&(T[a++]=T[w++]))}break}}break}}while(s<r&&a<i);s-=E=f>>3,p&=(1<<(f-=E<<3))-1,e.next_in=s,e.next_out=a,e.avail_in=s<r?r-s+5:5-(s-r),e.avail_out=a<i?i-a+257:257-(a-i),n.hold=p,n.bits=f}},function(e,t,n){"use strict";var s=n(156),r=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],a=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],o=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],i=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];e.exports=function(e,t,n,l,c,u,h,d){var p,f,m,g,y,v,b,_,E,S=d.bits,w=0,C=0,O=0,T=0,M=0,A=0,N=0,x=0,P=0,I=0,D=null,k=0,L=new s.Buf16(16),R=new s.Buf16(16),B=null,F=0;for(w=0;w<=15;w++)L[w]=0;for(C=0;C<l;C++)L[t[n+C]]++;for(M=S,T=15;T>=1&&0===L[T];T--);if(M>T&&(M=T),0===T)return c[u++]=20971520,c[u++]=20971520,d.bits=1,0;for(O=1;O<T&&0===L[O];O++);for(M<O&&(M=O),x=1,w=1;w<=15;w++)if(x<<=1,(x-=L[w])<0)return-1;if(x>0&&(0===e||1!==T))return-1;for(R[1]=0,w=1;w<15;w++)R[w+1]=R[w]+L[w];for(C=0;C<l;C++)0!==t[n+C]&&(h[R[t[n+C]]++]=C);if(0===e?(D=B=h,v=19):1===e?(D=r,k-=257,B=a,F-=257,v=256):(D=o,B=i,v=-1),I=0,C=0,w=O,y=u,A=M,N=0,m=-1,g=(P=1<<M)-1,1===e&&P>852||2===e&&P>592)return 1;for(;;){b=w-N,h[C]<v?(_=0,E=h[C]):h[C]>v?(_=B[F+h[C]],E=D[k+h[C]]):(_=96,E=0),p=1<<w-N,O=f=1<<A;do{c[y+(I>>N)+(f-=p)]=b<<24|_<<16|E|0}while(0!==f);for(p=1<<w-1;I&p;)p>>=1;if(0!==p?(I&=p-1,I+=p):I=0,C++,0==--L[w]){if(w===T)break;w=t[n+h[C]]}if(w>M&&(I&g)!==m){for(0===N&&(N=M),y+=O,x=1<<(A=w-N);A+N<T&&!((x-=L[A+N])<=0);)A++,x<<=1;if(P+=1<<A,1===e&&P>852||2===e&&P>592)return 1;c[m=I&g]=M<<24|A<<16|y-u|0}}return 0!==I&&(c[y+I]=w-N<<24|64<<16|0),d.bits=M,0}},function(e,t,n){"use strict";e.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},function(e,t,n){"use strict";function s(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}Object.defineProperty(t,"__esModule",{value:!0}),s(n(315)),s(n(321)),s(n(319)),s(n(659)),s(n(660))},function(e,t,n){"use strict";function s(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}Object.defineProperty(t,"__esModule",{value:!0}),s(n(317)),s(n(316)),s(n(214))},function(e,t,n){"use strict";function s(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}Object.defineProperty(t,"__esModule",{value:!0}),s(n(215)),s(n(320)),s(n(318))},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(40)),a=n(42),o=s(n(22));class i extends r.default{constructor(e,t,n={}){super(e,t),this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8},this.setOptions(n),this._dirs=a.DIRS[this._options.topology],this._map=this._fillMap(0)}randomize(e){for(let t=0;t<this._width;t++)for(let n=0;n<this._height;n++)this._map[t][n]=o.default.getUniform()<e?1:0;return this}setOptions(e){Object.assign(this._options,e)}set(e,t,n){this._map[e][t]=n}create(e){const t=this._fillMap(0),n=this._options.born,s=this._options.survive;for(let e=0;e<this._height;e++){let r=1,a=0;6==this._options.topology&&(r=2,a=e%2);for(let o=a;o<this._width;o+=r){const r=this._map[o][e],a=this._getNeighbors(o,e);r&&-1!=s.indexOf(a)?t[o][e]=1:r||-1==n.indexOf(a)||(t[o][e]=1)}}this._map=t,e&&this._serviceCallback(e)}_serviceCallback(e){for(let t=0;t<this._height;t++){let n=1,s=0;6==this._options.topology&&(n=2,s=t%2);for(let r=s;r<this._width;r+=n)e(r,t,this._map[r][t])}}_getNeighbors(e,t){let n=0;for(let s=0;s<this._dirs.length;s++){const r=this._dirs[s],a=e+r[0],o=t+r[1];a<0||a>=this._width||o<0||o>=this._height||(n+=1==this._map[a][o]?1:0)}return n}connect(e,t,n){t||(t=0);const s=[],r={};let a=1,i=[0,0];6==this._options.topology&&(a=2,i=[0,1]);for(let e=0;e<this._height;e++)for(let n=i[e%2];n<this._width;n+=a)if(this._freeSpace(n,e,t)){const t=[n,e];r[this._pointKey(t)]=t,s.push([n,e])}const l=s[o.default.getUniformInt(0,s.length-1)],c=this._pointKey(l),u={};for(u[c]=l,delete r[c],this._findConnected(u,r,[l],!1,t);Object.keys(r).length>0;){const e=this._getFromTo(u,r),s=e[0],a=e[1],o={};o[this._pointKey(s)]=s,this._findConnected(o,r,[s],!0,t);(6==this._options.topology?this._tunnelToConnected6:this._tunnelToConnected).call(this,a,s,u,r,t,n);for(const e in o){const n=o[e];this._map[n[0]][n[1]]=t,u[e]=n,delete r[e]}}e&&this._serviceCallback(e)}_getFromTo(e,t){let n,s=[0,0],r=[0,0];const a=Object.keys(e),i=Object.keys(t);for(let l=0;l<5;l++){if(a.length<i.length){const n=a;r=e[n[o.default.getUniformInt(0,n.length-1)]],s=this._getClosest(r,t)}else{const n=i;s=t[n[o.default.getUniformInt(0,n.length-1)]],r=this._getClosest(s,e)}if(n=(s[0]-r[0])*(s[0]-r[0])+(s[1]-r[1])*(s[1]-r[1]),n<64)break}return[s,r]}_getClosest(e,t){let n=null,s=null;for(const r in t){const a=t[r],o=(a[0]-e[0])*(a[0]-e[0])+(a[1]-e[1])*(a[1]-e[1]);(null==s||o<s)&&(s=o,n=a)}return n}_findConnected(e,t,n,s,r){for(;n.length>0;){const a=n.splice(0,1)[0];let o;o=6==this._options.topology?[[a[0]+2,a[1]],[a[0]+1,a[1]-1],[a[0]-1,a[1]-1],[a[0]-2,a[1]],[a[0]-1,a[1]+1],[a[0]+1,a[1]+1]]:[[a[0]+1,a[1]],[a[0]-1,a[1]],[a[0],a[1]+1],[a[0],a[1]-1]];for(let a=0;a<o.length;a++){const i=this._pointKey(o[a]);null==e[i]&&this._freeSpace(o[a][0],o[a][1],r)&&(e[i]=o[a],s||delete t[i],n.push(o[a]))}}}_tunnelToConnected(e,t,n,s,r,a){let o,i;t[0]<e[0]?(o=t,i=e):(o=e,i=t);for(let e=o[0];e<=i[0];e++){this._map[e][o[1]]=r;const t=[e,o[1]],a=this._pointKey(t);n[a]=t,delete s[a]}a&&o[0]<i[0]&&a(o,[i[0],o[1]]);const l=i[0];t[1]<e[1]?(o=t,i=e):(o=e,i=t);for(let e=o[1];e<i[1];e++){this._map[l][e]=r;const t=[l,e],a=this._pointKey(t);n[a]=t,delete s[a]}a&&o[1]<i[1]&&a([i[0],o[1]],[i[0],i[1]])}_tunnelToConnected6(e,t,n,s,r,a){let o,i;t[0]<e[0]?(o=t,i=e):(o=e,i=t);let l=o[0],c=o[1];for(;l!=i[0]||c!=i[1];){let e=2;c<i[1]?(c++,e=1):c>i[1]&&(c--,e=1),l<i[0]?l+=e:l>i[0]||i[1]%2?l-=e:l+=e,this._map[l][c]=r;const t=[l,c],a=this._pointKey(t);n[a]=t,delete s[a]}a&&a(t,e)}_freeSpace(e,t,n){return e>=0&&e<this._width&&t>=0&&t<this._height&&this._map[e][t]==n}_pointKey(e){return e[0]+"."+e[1]}}t.default=i},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(40)),a=s(n(22));function o(e,t,n){n[t[e+1]]=n[e],t[n[e]]=t[e+1],n[e]=e+1,t[e+1]=e}function i(e,t,n){n[t[e]]=n[e],t[n[e]]=t[e],n[e]=e,t[e]=e}class l extends r.default{create(e){const t=this._fillMap(1),n=Math.ceil((this._width-2)/2),s=[],r=[];for(let e=0;e<n;e++)s.push(e),r.push(e);let l;for(s.push(n-1),l=1;l+3<this._height;l+=2)for(let e=0;e<n;e++){const n=2*e+1,c=l;t[n][c]=0,e!=s[e+1]&&a.default.getUniform()>9/24&&(o(e,s,r),t[n+1][c]=0),e!=s[e]&&a.default.getUniform()>9/24?i(e,s,r):t[n][c+1]=0}for(let e=0;e<n;e++){const n=2*e+1,c=l;t[n][c]=0,e!=s[e+1]&&(e==s[e]||a.default.getUniform()>9/24)&&(o(e,s,r),t[n+1][c]=0),i(e,s,r)}for(let n=0;n<this._width;n++)for(let s=0;s<this._height;s++)e(n,s,t[n][s]);return this}}t.default=l},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(40)),a=s(n(22));class o extends r.default{constructor(){super(...arguments),this._stack=[],this._map=[]}create(e){const t=this._width,n=this._height;this._map=[];for(let e=0;e<t;e++){this._map.push([]);for(let s=0;s<n;s++){const r=0==e||0==s||e+1==t||s+1==n;this._map[e].push(r?1:0)}}this._stack=[[1,1,t-2,n-2]],this._process();for(let s=0;s<t;s++)for(let t=0;t<n;t++)e(s,t,this._map[s][t]);return this._map=[],this}_process(){for(;this._stack.length;){const e=this._stack.shift();this._partitionRoom(e)}}_partitionRoom(e){const t=[],n=[];for(let n=e[0]+1;n<e[2];n++){const s=this._map[n][e[1]-1],r=this._map[n][e[3]+1];!s||!r||n%2||t.push(n)}for(let t=e[1]+1;t<e[3];t++){const s=this._map[e[0]-1][t],r=this._map[e[2]+1][t];!s||!r||t%2||n.push(t)}if(!t.length||!n.length)return;const s=a.default.getItem(t),r=a.default.getItem(n);this._map[s][r]=1;const o=[];let i=[];o.push(i);for(let t=e[0];t<s;t++)this._map[t][r]=1,t%2&&i.push([t,r]);i=[],o.push(i);for(let t=s+1;t<=e[2];t++)this._map[t][r]=1,t%2&&i.push([t,r]);i=[],o.push(i);for(let t=e[1];t<r;t++)this._map[s][t]=1,t%2&&i.push([s,t]);i=[],o.push(i);for(let t=r+1;t<=e[3];t++)this._map[s][t]=1,t%2&&i.push([s,t]);const l=a.default.getItem(o);for(let e=0;e<o.length;e++){const t=o[e];if(t==l)continue;const n=a.default.getItem(t);this._map[n[0]][n[1]]=0}this._stack.push([e[0],e[1],s-1,r-1]),this._stack.push([s+1,e[1],e[2],r-1]),this._stack.push([e[0],r+1,s-1,e[3]]),this._stack.push([s+1,r+1,e[2],e[3]])}}t.default=o},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(40)),a=s(n(22));class o extends r.default{constructor(e,t,n=0){super(e,t),this._regularity=n,this._map=[]}create(e){let t=this._width,n=this._height;const s=this._fillMap(1);t-=t%2?1:2,n-=n%2?1:2;let r=0,o=0,i=0,l=0,c=0,u=!1;const h=[[0,0],[0,0],[0,0],[0,0]];do{if(r=1+2*Math.floor(a.default.getUniform()*(t-1)/2),o=1+2*Math.floor(a.default.getUniform()*(n-1)/2),c||(s[r][o]=0),!s[r][o]){this._randomize(h);do{0==Math.floor(a.default.getUniform()*(this._regularity+1))&&this._randomize(h),u=!0;for(let e=0;e<4;e++)if(i=r+2*h[e][0],l=o+2*h[e][1],this._isFree(s,i,l,t,n)){s[i][l]=0,s[r+h[e][0]][o+h[e][1]]=0,r=i,o=l,u=!1,c++;break}}while(!u)}}while(c+1<t*n/4);for(let t=0;t<this._width;t++)for(let n=0;n<this._height;n++)e(t,n,s[t][n]);return this._map=[],this}_randomize(e){for(let t=0;t<4;t++)e[t][0]=0,e[t][1]=0;switch(Math.floor(4*a.default.getUniform())){case 0:e[0][0]=-1,e[1][0]=1,e[2][1]=-1,e[3][1]=1;break;case 1:e[3][0]=-1,e[2][0]=1,e[1][1]=-1,e[0][1]=1;break;case 2:e[2][0]=-1,e[3][0]=1,e[0][1]=-1,e[1][1]=1;break;case 3:e[1][0]=-1,e[0][0]=1,e[3][1]=-1,e[2][1]=1}}_isFree(e,t,n,s,r){return!(t<1||n<1||t>=s||n>=r)&&e[t][n]}}t.default=o},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(40)),a=s(n(22)),o=n(42);class i extends r.default{constructor(e,t,n){super(e,t),this.map=[],this.rooms=[],this.connectedCells=[],(n=Object.assign({cellWidth:3,cellHeight:3},n)).hasOwnProperty("roomWidth")||(n.roomWidth=this._calculateRoomSize(this._width,n.cellWidth)),n.hasOwnProperty("roomHeight")||(n.roomHeight=this._calculateRoomSize(this._height,n.cellHeight)),this._options=n}create(e){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),e)for(let t=0;t<this._width;t++)for(let n=0;n<this._height;n++)e(t,n,this.map[t][n]);return this}_calculateRoomSize(e,t){let n=Math.floor(e/t*.8),s=Math.floor(e/t*.25);return s<2&&(s=2),n<2&&(n=2),[s,n]}_initRooms(){for(let e=0;e<this._options.cellWidth;e++){this.rooms.push([]);for(let t=0;t<this._options.cellHeight;t++)this.rooms[e].push({x:0,y:0,width:0,height:0,connections:[],cellx:e,celly:t})}}_connectRooms(){let e,t,n,s,r,i,l=a.default.getUniformInt(0,this._options.cellWidth-1),c=a.default.getUniformInt(0,this._options.cellHeight-1),u=!1;do{i=[0,2,4,6],i=a.default.shuffle(i);do{if(u=!1,e=i.pop(),t=l+o.DIRS[8][e][0],n=c+o.DIRS[8][e][1],!(t<0||t>=this._options.cellWidth||n<0||n>=this._options.cellHeight)){if(s=this.rooms[l][c],s.connections.length>0&&s.connections[0][0]==t&&s.connections[0][1]==n)break;r=this.rooms[t][n],0==r.connections.length&&(r.connections.push([l,c]),this.connectedCells.push([t,n]),l=t,c=n,u=!0)}}while(i.length>0&&0==u)}while(i.length>0)}_connectUnconnectedRooms(){const e=this._options.cellWidth,t=this._options.cellHeight;let n,s,r;this.connectedCells=a.default.shuffle(this.connectedCells);for(let i=0;i<this._options.cellWidth;i++)for(let l=0;l<this._options.cellHeight;l++)if(n=this.rooms[i][l],0==n.connections.length){let c=[0,2,4,6];c=a.default.shuffle(c),r=!1;do{const n=c.pop(),a=i+o.DIRS[8][n][0],u=l+o.DIRS[8][n][1];if(!(a<0||a>=e||u<0||u>=t)){if(s=this.rooms[a][u],r=!0,0==s.connections.length)break;for(let e=0;e<s.connections.length;e++)if(s.connections[e][0]==i&&s.connections[e][1]==l){r=!1;break}if(r)break}}while(c.length);r?n.connections.push([s.cellx,s.celly]):console.log("-- Unable to connect room.")}}_createRandomRoomConnections(){}_createRooms(){const e=this._width,t=this._height,n=this._options.cellWidth,s=this._options.cellHeight,r=Math.floor(this._width/n),o=Math.floor(this._height/s);let i,l;const c=this._options.roomWidth,u=this._options.roomHeight;let h,d,p;for(let f=0;f<n;f++)for(let n=0;n<s;n++){if(h=r*f,d=o*n,0==h&&(h=1),0==d&&(d=1),i=a.default.getUniformInt(c[0],c[1]),l=a.default.getUniformInt(u[0],u[1]),n>0)for(p=this.rooms[f][n-1];d-(p.y+p.height)<3;)d++;if(f>0)for(p=this.rooms[f-1][n];h-(p.x+p.width)<3;)h++;let s=Math.round(a.default.getUniformInt(0,r-i)/2),m=Math.round(a.default.getUniformInt(0,o-l)/2);for(;h+s+i>=e;)s?s--:i--;for(;d+m+l>=t;)m?m--:l--;h+=s,d+=m,this.rooms[f][n].x=h,this.rooms[f][n].y=d,this.rooms[f][n].width=i,this.rooms[f][n].height=l;for(let e=h;e<h+i;e++)for(let t=d;t<d+l;t++)this.map[e][t]=0}}_getWallPosition(e,t){let n,s,r;return 1==t||3==t?(n=a.default.getUniformInt(e.x+1,e.x+e.width-2),1==t?(s=e.y-2,r=s+1):(s=e.y+e.height+1,r=s-1),this.map[n][r]=0):(s=a.default.getUniformInt(e.y+1,e.y+e.height-2),2==t?(n=e.x+e.width+1,r=n-1):(n=e.x-2,r=n+1),this.map[r][s]=0),[n,s]}_drawCorridor(e,t){const n=t[0]-e[0],s=t[1]-e[1];let r,i,l,c,u=e[0],h=e[1];const d=[],p=Math.abs(n),f=Math.abs(s),m=a.default.getUniform(),g=m,y=1-m;for(i=n>0?2:6,l=s>0?4:0,p<f?(r=Math.ceil(f*g),d.push([l,r]),d.push([i,p]),r=Math.floor(f*y),d.push([l,r])):(r=Math.ceil(p*g),d.push([i,r]),d.push([l,f]),r=Math.floor(p*y),d.push([i,r])),this.map[u][h]=0;d.length>0;)for(c=d.pop();c[1]>0;)u+=o.DIRS[8][c[0]][0],h+=o.DIRS[8][c[0]][1],this.map[u][h]=0,c[1]=c[1]-1}_createCorridors(){const e=this._options.cellWidth,t=this._options.cellHeight;let n,s,r,a,o;for(let i=0;i<e;i++)for(let e=0;e<t;e++){n=this.rooms[i][e];for(let e=0;e<n.connections.length;e++)s=n.connections[e],r=this.rooms[s[0]][s[1]],r.cellx>n.cellx?(a=2,o=4):r.cellx<n.cellx?(a=4,o=2):r.celly>n.celly?(a=3,o=1):(a=1,o=3),this._drawCorridor(this._getWallPosition(n,a),this._getWallPosition(r,o))}}}t.default=i},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(219));t.default={Simplex:r.default}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(669)),a=s(n(265));t.default={Dijkstra:r.default,AStar:a.default}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(177));class a extends r.default{constructor(e,t,n,s){super(e,t,n,s),this._computed={},this._todo=[],this._add(e,t,null)}compute(e,t,n){const s=e+","+t;if(s in this._computed||this._compute(e,t),!(s in this._computed))return;let r=this._computed[s];for(;r;)n(r.x,r.y),r=r.prev}_compute(e,t){for(;this._todo.length;){const n=this._todo.shift();if(n.x==e&&n.y==t)return;const s=this._getNeighbors(n.x,n.y);for(let e=0;e<s.length;e++){const t=s[e],r=t[0],a=t[1];r+","+a in this._computed||this._add(r,a,n)}}}_add(e,t,n){const s={x:e,y:t,prev:n};this._computed[e+","+t]=s,this._todo.push(s)}}t.default=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(e){this._scheduler=e,this._lock=1}start(){return this.unlock()}lock(){return this._lock++,this}unlock(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){const e=this._scheduler.next();if(!e)return this.lock();const t=e.act();t&&t.then&&(this.lock(),t.then(this.unlock.bind(this)))}return this}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(140));t.default=class{constructor(e,t={}){this._reflectivityCallback=e,this._options={},t=Object.assign({passes:1,emissionThreshold:100,range:10},t),this._lights={},this._reflectivityCache={},this._fovCache={},this.setOptions(t)}setOptions(e){return Object.assign(this._options,e),e&&e.range&&this.reset(),this}setFOV(e){return this._fov=e,this._fovCache={},this}setLight(e,t,n){const s=e+","+t;return n?this._lights[s]="string"==typeof n?o.fromString(n):n:delete this._lights[s],this}clearLights(){this._lights={}}reset(){return this._reflectivityCache={},this._fovCache={},this}compute(e){const t={};let n={};const s={};for(const e in this._lights){const t=this._lights[e];n[e]=[0,0,0],o.add_(n[e],t)}for(let e=0;e<this._options.passes;e++)this._emitLight(n,s,t),e+1!=this._options.passes&&(n=this._computeEmitters(s,t));for(const t in s){const n=t.split(",");e(parseInt(n[0]),parseInt(n[1]),s[t])}return this}_emitLight(e,t,n){for(const s in e){const r=s.split(","),a=parseInt(r[0]),o=parseInt(r[1]);this._emitLightFromCell(a,o,e[s],t),n[s]=1}return this}_computeEmitters(e,t){const n={};for(const s in e){if(s in t)continue;const r=e[s];let a;if(s in this._reflectivityCache)a=this._reflectivityCache[s];else{const e=s.split(","),t=parseInt(e[0]),n=parseInt(e[1]);a=this._reflectivityCallback(t,n),this._reflectivityCache[s]=a}if(0==a)continue;const o=[0,0,0];let i=0;for(let e=0;e<3;e++){const t=Math.round(r[e]*a);o[e]=t,i+=t}i>this._options.emissionThreshold&&(n[s]=o)}return n}_emitLightFromCell(e,t,n,s){const r=e+","+t;let a;a=r in this._fovCache?this._fovCache[r]:this._updateFOV(e,t);for(const e in a){const t=a[e];let r;e in s?r=s[e]:(r=[0,0,0],s[e]=r);for(let e=0;e<3;e++)r[e]+=Math.round(n[e]*t)}return this}_updateFOV(e,t){const n=e+","+t,s={};this._fovCache[n]=s;const r=this._options.range;return this._fov.compute(e,t,r,function(e,t,n,a){const o=a*(1-n/r);0!=o&&(s[e+","+t]=o)}.bind(this)),s}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Viewport=void 0;t.Viewport=class{constructor(e,t){this.viewportX=e,this.viewportY=t}setViewportXY(e,t){this.viewportX=e,this.viewportY=t}initCellsInViewPort(e,t,n){let s=e-this.viewportX,r=e+this.viewportX,a=t-this.viewportY,o=t+this.viewportY;const i=n.cols-1,l=n.rows-1,c=this.viewportX-e;if(c>0)r+=c;else{const t=e+this.viewportX-i;t>0&&(s-=t)}const u=this.viewportY-t;if(u>0)o+=u;else{const e=t+this.viewportY-l;e>0&&(a-=e)}s<0&&(s=0),a<0&&(a=0),r>n.cols-1&&(r=n.cols-1),o>n.rows-1&&(o=n.rows-1),this.coord={};for(let e=a;e<=o;e++){this.coord[e]=[];for(let t=s;t<=r;t++)this.coord[e].push(n.getCell(t,e))}this.startX=s,this.endX=r,this.startY=a,this.endY=o,this.rows=n.rows}getCellRow(e){return this.coord[e]}debugPrint(){const[e,t]=[this.startY,this.endY];for(let n=e;n<=t;n++){const e=this.coord[n];console.log(e.join(""))}}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.TextHelp=void 0;const i=a(n(1)),l=o(n(70)),c=o(n(4)),u=o(n(59)),h=n(674);t.TextHelp=({char:e,descr:t})=>i.createElement("p",null,i.createElement("span",{className:"text-primary"},e),"- "+t);class d extends i.Component{shouldComponentUpdate(){return!1}render(){return i.createElement(u.default,{"aria-labelledby":"game-help-modal-label",id:"gameHelpModal",large:!0,onHide:this.toggleScreen.bind(this,"HelpScreen"),show:this.props.showHelpScreen},i.createElement(l.default,{id:"game-help-modal-label",text:c.default.gameTitle+"Help"}),i.createElement("div",{className:"modal-body"},i.createElement("div",{className:"row"},i.createElement("div",{className:"col-md-12"},i.createElement("div",{dangerouslySetInnerHTML:{__html:h.Manual.fullText},id:"manual-text"})))),i.createElement("div",{className:"modal-footer row"},i.createElement("div",{className:"col-md-6"},i.createElement("button",{className:"btn btn-secondary",onClick:this.toggleScreen.bind(this,"HelpScreen"),type:"button"},"Close"))))}toggleScreen(e){this.props.toggleScreen(e)}}t.default=d},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Manual=void 0;const s=n(25),r=n(675),a=n(269),{GUI:o,KEY:i,getChar:l}=s.Keys;t.Manual={};const c=`\nBattles in the North manual\n===========================\n\nThis is a short manual accompanying Battles in the North (hereafter Battles) game.\nIt should get you started with controls and basic commands of the game. Use your\nbrowser's Find (typical Control/Cmd-F)\nto search anything in this manual.\n\nAt the moment, you need both the mouse and keyboard to play the game. While all the\nASCII-based menus are also clickable by mouse, you need keyboard to open some of the\nmenus. Also, the Inventory/Shop/Crafting menus cannot be used with keyboard at the moment.\nThese limitations will be addressed in the future versions of the game.\n\n\x3c!-- toc --\x3e\n\nAbout the Game\n--------------\n\nBattles is an open-world RPG/roguelike-game in a northern setting. You control\na single actor and interact with NPCs in the world. The game consists of an overworld\nand numerous smaller zones (dungeons, mountains, crypts, fortresses, caves),\nwhich are scattered around the overworld. There are also settlements such as\nvillages and cities, which are less hostile than previously mentioned\nzones.\n\nMouse controls\n--------------\n\nYou can move to an already explored cell (non-black, but not necessarily visible) by\nleft-clicking that cell. If an enemy is seen before the cell is reached,\nthe movement will stop automatically.\n\nIf the cell has an item, the top item will be picked up automatically when\nleft-clicking. If the cell has a hostile actor, left-clicking it will automatically\nperform a melee attack.\n\nRight-clicking a cell will bring up a context menu, from which you can choose an\navailable action.\n\nKey controls\n------------\n\n${`\nTable below shows keyboard controls:\n\n| key                       | Command description                               |\n| ------                    | ------------------------------------------        |\n| ,                         | Pick up an item.                                  |\n| < or >                    | Use stairs/passage.                               |\n| ${l(i.CHAT)}      | Chat with another actor.                          |\n| ${l(o.Help)}      | Show/hide help.                                   |\n| ${l(o.OwMap)}     | Show overworld map.                               |\n| ${l(i.ORDER)}     | [Give an order to another actor.](#giving-orders) |\n| ${l(i.FIGHT)}     | Change fight mode.                                |\n| ${l(i.JUMP)}      | Jump to given a direction.                        |\n| ${l(i.NEXT_ITEM)} | See next item in the cell.                        |\n| ${l(o.Inv)}       | Show inventory.                                   |\n| ${l(o.Look)}      | Look around.                                      |\n| ${l(o.Map)}       | Toggle the map or player view.                    |\n| ${l(i.MARK)}      | Add a location marker for quick travel.           |\n| ${l(i.GOTO)}      | Open a location list for quick travel.            |\n| ${l(i.NEXT)}      | Next target (target-look).                        |\n| ${l(i.DOOR)}      | Open or close door.                               |\n| ${l(i.POWER)}     | [Use your powers.](#casting-spells)               |\n| ${l(i.READ)}      | Read something from the current cell.             |\n| ${l(i.RUN)}       | Toggle run mode (1.5 x speed).                    |\n| ${l(i.REST)}      | Rest (takes less energy than moving).             |\n| ${l(i.TARGET)}    | [Target/fire](#firing-missiles)                   |\n| ${l(o.Use)}       | [Use an item.](#using-items)                      |\n| ${l(i.ABILITY)}   | [Use an ability.](#abilities)                     |\n| ${l(o.Shop)}      | [Open a shop menu (when inside shop)](#shops)     |\n| ${l(o.Craft)}     | [Open a crafting menu ](#crafting)                |\n`}\n\nAlternatively, you can use the numpad keys to move around.\n\nMovement\n--------\n\n\n<p>To move around, use:</p>\n<table className='table table-large mov-buttons-table'>\n  <thead />\n  <tbody>\n    <tr>\n      <td>โฌ q</td>\n      <td>โฌ w</td>\n      <td>โฌ e</td>\n    </tr>\n    <tr>\n      <td>โฌ a</td>\n      <td>Rest: s</td>\n      <td>โก d</td>\n    </tr>\n    <tr>\n      <td>โฌ z</td>\n      <td>โฌ x</td>\n      <td>โฌ c</td>\n    </tr>\n  </tbody>\n</table>\n\n\nAlternatively, you can use the numpad keys to move around.\n\n| Terrain            | ASCII symbol | Z        |\n| ------------------ | -----------  | -------- |\n| ground/floor (any) | .            | 0        |\n| cliff              | ${a.ELEV[0]}   | 1        |\n| stone              | ${a.ELEV[1]}   | 2        |\n| steep cliff        | ${a.ELEV[2]}   | 3        |\n\n\nIn Battles, terrain affects the movement heavily. Currently, there are 3 heights of\nelevation above sea-level, and 3 depths for water. When climbing above the sea level,\nit is possible to only move between two adjacent height levels. In the table below,\nyou can only move between terrain that is in two adjacent rows:\n\nAttacking\n---------\n\nAttacking other actors using melee attacks can be done by bumping into adjacent\nactors. If the actor is not hostile, the game will ask you to confirm the\naction.\n\nAn exception is melee attack with range of 2 or more. Currently, these must be\nperformed by right-clicking the target with mouse and choosing attack. For example,\na whip can be used to attack enemies within range of two.\n\nFiring missiles\n---------------\n\nFirst, you need to have a missile or ammo + missile weapon equipped. Then, press\n${l(i.TARGET)} to select a target. You can switch between targets using\nnext key ${l(i.NEXT)} or previous key ${l(i.PREV)}. If the\ntarget\nis red, it is out of range. If it's yellow, then press ${l(i.TARGET)}\nagain to fire.\n\nCasting spells\n---------------\n\nPress ${l(i.POWER)} to view a list of spells. Press corresponding key to\ncast that spell or any other key to quit. Some spells require giving a direction\nor choosing an adjacent cell.\n\nUsing items\n-----------\n\nThere are 2 ways to use items:\n\n  1. When you enter inventory, you can use the items on yourself only.\n  2. If you want to use item on something else, you can do the following:\n    * Open inventory and select an item.\n    * Close inventory and press ${l(s.Keys.GUI.Use)}.\n    * Select direction for using.\n\nAbilities\n---------\n\nAbilities do not consume any power points. They may have features such as a\ncooldown period, during which that ability cannot be used.\n\nIf the actor has any abilities, they can be activated using ${l(i.ABILITY)}.\nPressing the key will open an ability menu from which an ability can be chosen.\nDepending on the ability, further input such as direction to use the ability, may\nbe requested.\n\nGiving orders\n-------------\n\nIn some situations, it is possible to give commands to other actors. Use\n${l(i.ORDER)} to give an order. The game will ask you to select a\ntarget. You can used the [Movement keys](#movement) to select a target by\npressing ${l(i.SELECT)} over desired target,\nor press ${l(i.SELECT_ALL)} to choose all valid targets.\n\nAfter the selection, you will get a list of possible commands. Choose one\nwith the keyboard or using the mouse.\n\nUsing marks for movement\n------------------------\n\nTo reduce the amount of backtracking in large levels, the game will automatically mark the\nenter/exit locations for each level. To place a mark to any other location, you can press\n${l(i.MARK)}. This mark will be added to the mark list of the current level.\n\nBy pressing ${l(i.GOTO)}, you can open a mark list for the current level you are in.\nBy selecting one of the marks from the list, the actor tries to navigate to that location\nautomatically. If\nany hostile actors or dangers are encountered, the navigation is immediately stopped. At the\nmoment you have to open the mark list again and choose a location again to proceed after\nstopping.\n\nReading books\n-------------\n\nBooks can be read by pressing ${l(i.READ)} while there is something to read in\nthe same cell as the player. If they are in inventory, they can be read by using the\nbooks simply with Use command.\n\nMining/farming/crafting\n-----------------------\n\nMining can be done by using a pick-axe to a wall that can be broken with that pick-axe.\n\nFarming can be done as follows:\n  1. Till the soil with a hoe: Select hoe from inventory, then Use it to a suitable cell.\n  2. Sow the seeds to tilled soil by Using a seed to tilled soil cell.\n  3. Wait an amount of days it takes for that crop to grown.\n  4. Gather the grown crops from the ground once they are ready.\n\nCrafting is done by pressing ${l(o.Craft)}. Then select a suitable recipe from\nthe left menu. Then press Craft.\n\nTemperature and coldness\n------------------------\n\nWeather and temperature are simulated by the gate. Player and NPCs can get hypothermic and\neventually freeze to death. Heat sources such as houses and campfires can restore body\ntemperature, and help in getting rid of the cold. Humidity also affects the temperature,\nso getting wet (falling into water) in winter can spell a quick doom to careless adventurer.\n\nGame settings\n-------------\n\nTODO\n\nImporting plugins\n-----------------\n\nBattles supports importing and using custom plugins. To load a plugin:\n  1. Close the starting menu (if shown)\n  2. Open Plugin menu from the top menu. Select Plugin manager\n  3. Tick the box below. Now you can load the plugins\n  4. Choose from the top menu Plugin->Load script.\n  5. Navigate to a valid plugin file and open it. It should appear in Plugin\n     manager now.\n  6.\n\nFor plugin developers, see the ./plugin-examples/README.md distributed with the\ngame source code.\n`,u=new r.Renderer,h=[],d=[];u.heading=function(e,t){const n=e.toLowerCase().replace(/[^\w]+/g,"-");return h.push({level:t,slug:n,title:e}),t>1&&(2===t?d.push(`- [${e}](#${n})`):3===t?d.push(`  - [${e}](#${n})`):d.push(`    - [${e}](#${n})`)),`<h${t} id="${n}"><a href="#${n}" class="anchor"></a>${e}</h${t}>`};const p=function(e){return r(e,{renderer:u})};t.Manual.fullText=p(c);const f=c.replace("\x3c!-- toc --\x3e",d.join("\n"));t.Manual.fullText=p(f)},function(e,t,n){(function(t){!function(t){"use strict";var n={newline:/^\n+/,code:/^( {4}[^\n]+\n*)+/,fences:/^ {0,3}(`{3,}|~{3,})([^`~\n]*)\n(?:|([\s\S]*?)\n)(?: {0,3}\1[~`]* *(?:\n+|$)|$)/,hr:/^ {0,3}((?:- *){3,}|(?:_ *){3,}|(?:\* *){3,})(?:\n+|$)/,heading:/^ {0,3}(#{1,6}) +([^\n]*?)(?: +#+)? *(?:\n+|$)/,blockquote:/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/,list:/^( {0,3})(bull) [\s\S]+?(?:hr|def|\n{2,}(?! )(?!\1bull )\n*|\s*$)/,html:"^ {0,3}(?:<(script|pre|style)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?\\?>\\n*|<![A-Z][\\s\\S]*?>\\n*|<!\\[CDATA\\[[\\s\\S]*?\\]\\]>\\n*|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:\\n{2,}|$)|<(?!script|pre|style)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:\\n{2,}|$)|</(?!script|pre|style)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:\\n{2,}|$))",def:/^ {0,3}\[(label)\]: *\n? *<?([^\s>]+)>?(?:(?: +\n? *| *\n *)(title))? *(?:\n+|$)/,nptable:g,table:g,lheading:/^([^\n]+)\n {0,3}(=+|-+) *(?:\n+|$)/,_paragraph:/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html)[^\n]+)*)/,text:/^[^\n]+/};function s(e){this.tokens=[],this.tokens.links=Object.create(null),this.options=e||S.defaults,this.rules=n.normal,this.options.pedantic?this.rules=n.pedantic:this.options.gfm&&(this.rules=n.gfm)}n._label=/(?!\s*\])(?:\\[\[\]]|[^\[\]])+/,n._title=/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/,n.def=d(n.def).replace("label",n._label).replace("title",n._title).getRegex(),n.bullet=/(?:[*+-]|\d{1,9}\.)/,n.item=/^( *)(bull) ?[^\n]*(?:\n(?!\1bull ?)[^\n]*)*/,n.item=d(n.item,"gm").replace(/bull/g,n.bullet).getRegex(),n.list=d(n.list).replace(/bull/g,n.bullet).replace("hr","\\n+(?=\\1?(?:(?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$))").replace("def","\\n+(?="+n.def.source+")").getRegex(),n._tag="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|section|source|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",n._comment=/<!--(?!-?>)[\s\S]*?-->/,n.html=d(n.html,"i").replace("comment",n._comment).replace("tag",n._tag).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),n.paragraph=d(n._paragraph).replace("hr",n.hr).replace("heading"," {0,3}#{1,6} +").replace("|lheading","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}|~{3,})[^`\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|!--)").replace("tag",n._tag).getRegex(),n.blockquote=d(n.blockquote).replace("paragraph",n.paragraph).getRegex(),n.normal=y({},n),n.gfm=y({},n.normal,{nptable:/^ *([^|\n ].*\|.*)\n *([-:]+ *\|[-| :]*)(?:\n((?:.*[^>\n ].*(?:\n|$))*)\n*|$)/,table:/^ *\|(.+)\n *\|?( *[-:]+[-| :]*)(?:\n((?: *[^>\n ].*(?:\n|$))*)\n*|$)/}),n.pedantic=y({},n.normal,{html:d("^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:\"[^\"]*\"|'[^']*'|\\s[^'\"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))").replace("comment",n._comment).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^ *(#{1,6}) *([^\n]+?) *(?:#+ *)?(?:\n+|$)/,fences:g,paragraph:d(n.normal._paragraph).replace("hr",n.hr).replace("heading"," *#{1,6} *[^\n]").replace("lheading",n.lheading).replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").getRegex()}),s.rules=n,s.lex=function(e,t){return new s(t).lex(e)},s.prototype.lex=function(e){return e=e.replace(/\r\n|\r/g,"\n").replace(/\t/g,"    ").replace(/\u00a0/g," ").replace(/\u2424/g,"\n"),this.token(e,!0)},s.prototype.token=function(e,t){var s,r,a,o,i,l,c,h,d,p,f,m,g,y,_,E;for(e=e.replace(/^ +$/gm,"");e;)if((a=this.rules.newline.exec(e))&&(e=e.substring(a[0].length),a[0].length>1&&this.tokens.push({type:"space"})),a=this.rules.code.exec(e)){var S=this.tokens[this.tokens.length-1];e=e.substring(a[0].length),S&&"paragraph"===S.type?S.text+="\n"+a[0].trimRight():(a=a[0].replace(/^ {4}/gm,""),this.tokens.push({type:"code",codeBlockStyle:"indented",text:this.options.pedantic?a:b(a,"\n")}))}else if(a=this.rules.fences.exec(e))e=e.substring(a[0].length),this.tokens.push({type:"code",lang:a[2]?a[2].trim():a[2],text:a[3]||""});else if(a=this.rules.heading.exec(e))e=e.substring(a[0].length),this.tokens.push({type:"heading",depth:a[1].length,text:a[2]});else if((a=this.rules.nptable.exec(e))&&(l={type:"table",header:v(a[1].replace(/^ *| *\| *$/g,"")),align:a[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:a[3]?a[3].replace(/\n$/,"").split("\n"):[]}).header.length===l.align.length){for(e=e.substring(a[0].length),f=0;f<l.align.length;f++)/^ *-+: *$/.test(l.align[f])?l.align[f]="right":/^ *:-+: *$/.test(l.align[f])?l.align[f]="center":/^ *:-+ *$/.test(l.align[f])?l.align[f]="left":l.align[f]=null;for(f=0;f<l.cells.length;f++)l.cells[f]=v(l.cells[f],l.header.length);this.tokens.push(l)}else if(a=this.rules.hr.exec(e))e=e.substring(a[0].length),this.tokens.push({type:"hr"});else if(a=this.rules.blockquote.exec(e))e=e.substring(a[0].length),this.tokens.push({type:"blockquote_start"}),a=a[0].replace(/^ *> ?/gm,""),this.token(a,t),this.tokens.push({type:"blockquote_end"});else if(a=this.rules.list.exec(e)){for(e=e.substring(a[0].length),c={type:"list_start",ordered:y=(o=a[2]).length>1,start:y?+o:"",loose:!1},this.tokens.push(c),h=[],s=!1,g=(a=a[0].match(this.rules.item)).length,f=0;f<g;f++)p=(l=a[f]).length,~(l=l.replace(/^ *([*+-]|\d+\.) */,"")).indexOf("\n ")&&(p-=l.length,l=this.options.pedantic?l.replace(/^ {1,4}/gm,""):l.replace(new RegExp("^ {1,"+p+"}","gm"),"")),f!==g-1&&(i=n.bullet.exec(a[f+1])[0],(o.length>1?1===i.length:i.length>1||this.options.smartLists&&i!==o)&&(e=a.slice(f+1).join("\n")+e,f=g-1)),r=s||/\n\n(?!\s*$)/.test(l),f!==g-1&&(s="\n"===l.charAt(l.length-1),r||(r=s)),r&&(c.loose=!0),E=void 0,(_=/^\[[ xX]\] /.test(l))&&(E=" "!==l[1],l=l.replace(/^\[[ xX]\] +/,"")),d={type:"list_item_start",task:_,checked:E,loose:r},h.push(d),this.tokens.push(d),this.token(l,!1),this.tokens.push({type:"list_item_end"});if(c.loose)for(g=h.length,f=0;f<g;f++)h[f].loose=!0;this.tokens.push({type:"list_end"})}else if(a=this.rules.html.exec(e))e=e.substring(a[0].length),this.tokens.push({type:this.options.sanitize?"paragraph":"html",pre:!this.options.sanitizer&&("pre"===a[1]||"script"===a[1]||"style"===a[1]),text:this.options.sanitize?this.options.sanitizer?this.options.sanitizer(a[0]):u(a[0]):a[0]});else if(t&&(a=this.rules.def.exec(e)))e=e.substring(a[0].length),a[3]&&(a[3]=a[3].substring(1,a[3].length-1)),m=a[1].toLowerCase().replace(/\s+/g," "),this.tokens.links[m]||(this.tokens.links[m]={href:a[2],title:a[3]});else if((a=this.rules.table.exec(e))&&(l={type:"table",header:v(a[1].replace(/^ *| *\| *$/g,"")),align:a[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:a[3]?a[3].replace(/\n$/,"").split("\n"):[]}).header.length===l.align.length){for(e=e.substring(a[0].length),f=0;f<l.align.length;f++)/^ *-+: *$/.test(l.align[f])?l.align[f]="right":/^ *:-+: *$/.test(l.align[f])?l.align[f]="center":/^ *:-+ *$/.test(l.align[f])?l.align[f]="left":l.align[f]=null;for(f=0;f<l.cells.length;f++)l.cells[f]=v(l.cells[f].replace(/^ *\| *| *\| *$/g,""),l.header.length);this.tokens.push(l)}else if(a=this.rules.lheading.exec(e))e=e.substring(a[0].length),this.tokens.push({type:"heading",depth:"="===a[2].charAt(0)?1:2,text:a[1]});else if(t&&(a=this.rules.paragraph.exec(e)))e=e.substring(a[0].length),this.tokens.push({type:"paragraph",text:"\n"===a[1].charAt(a[1].length-1)?a[1].slice(0,-1):a[1]});else if(a=this.rules.text.exec(e))e=e.substring(a[0].length),this.tokens.push({type:"text",text:a[0]});else if(e)throw new Error("Infinite loop on byte: "+e.charCodeAt(0));return this.tokens};var r={escape:/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,autolink:/^<(scheme:[^\s\x00-\x1f<>]*|email)>/,url:g,tag:"^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>",link:/^!?\[(label)\]\(\s*(href)(?:\s+(title))?\s*\)/,reflink:/^!?\[(label)\]\[(?!\s*\])((?:\\[\[\]]?|[^\[\]\\])+)\]/,nolink:/^!?\[(?!\s*\])((?:\[[^\[\]]*\]|\\[\[\]]|[^\[\]])*)\](?:\[\])?/,strong:/^__([^\s_])__(?!_)|^\*\*([^\s*])\*\*(?!\*)|^__([^\s][\s\S]*?[^\s])__(?!_)|^\*\*([^\s][\s\S]*?[^\s])\*\*(?!\*)/,em:/^_([^\s_])_(?!_)|^\*([^\s*<\[])\*(?!\*)|^_([^\s<][\s\S]*?[^\s_])_(?!_|[^\spunctuation])|^_([^\s_<][\s\S]*?[^\s])_(?!_|[^\spunctuation])|^\*([^\s<"][\s\S]*?[^\s\*])\*(?!\*|[^\spunctuation])|^\*([^\s*"<\[][\s\S]*?[^\s])\*(?!\*)/,code:/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,br:/^( {2,}|\\)\n(?!\s*$)/,del:g,text:/^(`+|[^`])(?:[\s\S]*?(?:(?=[\\<!\[`*]|\b_|$)|[^ ](?= {2,}\n))|(?= {2,}\n))/};function a(e,t){if(this.options=t||S.defaults,this.links=e,this.rules=r.normal,this.renderer=this.options.renderer||new o,this.renderer.options=this.options,!this.links)throw new Error("Tokens array requires a `links` property.");this.options.pedantic?this.rules=r.pedantic:this.options.gfm&&(this.options.breaks?this.rules=r.breaks:this.rules=r.gfm)}function o(e){this.options=e||S.defaults}function i(){}function l(e){this.tokens=[],this.token=null,this.options=e||S.defaults,this.options.renderer=this.options.renderer||new o,this.renderer=this.options.renderer,this.renderer.options=this.options,this.slugger=new c}function c(){this.seen={}}function u(e,t){if(t){if(u.escapeTest.test(e))return e.replace(u.escapeReplace,(function(e){return u.replacements[e]}))}else if(u.escapeTestNoEncode.test(e))return e.replace(u.escapeReplaceNoEncode,(function(e){return u.replacements[e]}));return e}function h(e){return e.replace(/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/gi,(function(e,t){return"colon"===(t=t.toLowerCase())?":":"#"===t.charAt(0)?"x"===t.charAt(1)?String.fromCharCode(parseInt(t.substring(2),16)):String.fromCharCode(+t.substring(1)):""}))}function d(e,t){return e=e.source||e,t=t||"",{replace:function(t,n){return n=(n=n.source||n).replace(/(^|[^\[])\^/g,"$1"),e=e.replace(t,n),this},getRegex:function(){return new RegExp(e,t)}}}function p(e,t,n){if(e){try{var s=decodeURIComponent(h(n)).replace(/[^\w:]/g,"").toLowerCase()}catch(e){return null}if(0===s.indexOf("javascript:")||0===s.indexOf("vbscript:")||0===s.indexOf("data:"))return null}t&&!m.test(n)&&(n=function(e,t){f[" "+e]||(/^[^:]+:\/*[^/]*$/.test(e)?f[" "+e]=e+"/":f[" "+e]=b(e,"/",!0));return e=f[" "+e],"//"===t.slice(0,2)?e.replace(/:[\s\S]*/,":")+t:"/"===t.charAt(0)?e.replace(/(:\/*[^/]*)[\s\S]*/,"$1")+t:e+t}(t,n));try{n=encodeURI(n).replace(/%25/g,"%")}catch(e){return null}return n}r._punctuation="!\"#$%&'()*+,\\-./:;<=>?@\\[^_{|}~",r.em=d(r.em).replace(/punctuation/g,r._punctuation).getRegex(),r._escapes=/\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/g,r._scheme=/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/,r._email=/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/,r.autolink=d(r.autolink).replace("scheme",r._scheme).replace("email",r._email).getRegex(),r._attribute=/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/,r.tag=d(r.tag).replace("comment",n._comment).replace("attribute",r._attribute).getRegex(),r._label=/(?:\[[^\[\]]*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,r._href=/<(?:\\[<>]?|[^\s<>\\])*>|[^\s\x00-\x1f]*/,r._title=/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/,r.link=d(r.link).replace("label",r._label).replace("href",r._href).replace("title",r._title).getRegex(),r.reflink=d(r.reflink).replace("label",r._label).getRegex(),r.normal=y({},r),r.pedantic=y({},r.normal,{strong:/^__(?=\S)([\s\S]*?\S)__(?!_)|^\*\*(?=\S)([\s\S]*?\S)\*\*(?!\*)/,em:/^_(?=\S)([\s\S]*?\S)_(?!_)|^\*(?=\S)([\s\S]*?\S)\*(?!\*)/,link:d(/^!?\[(label)\]\((.*?)\)/).replace("label",r._label).getRegex(),reflink:d(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",r._label).getRegex()}),r.gfm=y({},r.normal,{escape:d(r.escape).replace("])","~|])").getRegex(),_extended_email:/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/,url:/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,_backpedal:/(?:[^?!.,:;*_~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_~)]+(?!$))+/,del:/^~+(?=\S)([\s\S]*?\S)~+/,text:/^(`+|[^`])(?:[\s\S]*?(?:(?=[\\<!\[`*~]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@))|(?= {2,}\n|[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@))/}),r.gfm.url=d(r.gfm.url,"i").replace("email",r.gfm._extended_email).getRegex(),r.breaks=y({},r.gfm,{br:d(r.br).replace("{2,}","*").getRegex(),text:d(r.gfm.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()}),a.rules=r,a.output=function(e,t,n){return new a(t,n).output(e)},a.prototype.output=function(e){for(var t,n,s,r,o,i,l="";e;)if(o=this.rules.escape.exec(e))e=e.substring(o[0].length),l+=u(o[1]);else if(o=this.rules.tag.exec(e))!this.inLink&&/^<a /i.test(o[0])?this.inLink=!0:this.inLink&&/^<\/a>/i.test(o[0])&&(this.inLink=!1),!this.inRawBlock&&/^<(pre|code|kbd|script)(\s|>)/i.test(o[0])?this.inRawBlock=!0:this.inRawBlock&&/^<\/(pre|code|kbd|script)(\s|>)/i.test(o[0])&&(this.inRawBlock=!1),e=e.substring(o[0].length),l+=this.options.sanitize?this.options.sanitizer?this.options.sanitizer(o[0]):u(o[0]):o[0];else if(o=this.rules.link.exec(e)){var c=_(o[2],"()");if(c>-1){var h=4+o[1].length+c;o[2]=o[2].substring(0,c),o[0]=o[0].substring(0,h).trim(),o[3]=""}e=e.substring(o[0].length),this.inLink=!0,s=o[2],this.options.pedantic?(t=/^([^'"]*[^\s])\s+(['"])(.*)\2/.exec(s))?(s=t[1],r=t[3]):r="":r=o[3]?o[3].slice(1,-1):"",s=s.trim().replace(/^<([\s\S]*)>$/,"$1"),l+=this.outputLink(o,{href:a.escapes(s),title:a.escapes(r)}),this.inLink=!1}else if((o=this.rules.reflink.exec(e))||(o=this.rules.nolink.exec(e))){if(e=e.substring(o[0].length),t=(o[2]||o[1]).replace(/\s+/g," "),!(t=this.links[t.toLowerCase()])||!t.href){l+=o[0].charAt(0),e=o[0].substring(1)+e;continue}this.inLink=!0,l+=this.outputLink(o,t),this.inLink=!1}else if(o=this.rules.strong.exec(e))e=e.substring(o[0].length),l+=this.renderer.strong(this.output(o[4]||o[3]||o[2]||o[1]));else if(o=this.rules.em.exec(e))e=e.substring(o[0].length),l+=this.renderer.em(this.output(o[6]||o[5]||o[4]||o[3]||o[2]||o[1]));else if(o=this.rules.code.exec(e))e=e.substring(o[0].length),l+=this.renderer.codespan(u(o[2].trim(),!0));else if(o=this.rules.br.exec(e))e=e.substring(o[0].length),l+=this.renderer.br();else if(o=this.rules.del.exec(e))e=e.substring(o[0].length),l+=this.renderer.del(this.output(o[1]));else if(o=this.rules.autolink.exec(e))e=e.substring(o[0].length),s="@"===o[2]?"mailto:"+(n=u(this.mangle(o[1]))):n=u(o[1]),l+=this.renderer.link(s,null,n);else if(this.inLink||!(o=this.rules.url.exec(e))){if(o=this.rules.text.exec(e))e=e.substring(o[0].length),this.inRawBlock?l+=this.renderer.text(this.options.sanitize?this.options.sanitizer?this.options.sanitizer(o[0]):u(o[0]):o[0]):l+=this.renderer.text(u(this.smartypants(o[0])));else if(e)throw new Error("Infinite loop on byte: "+e.charCodeAt(0))}else{if("@"===o[2])s="mailto:"+(n=u(o[0]));else{do{i=o[0],o[0]=this.rules._backpedal.exec(o[0])[0]}while(i!==o[0]);n=u(o[0]),s="www."===o[1]?"http://"+n:n}e=e.substring(o[0].length),l+=this.renderer.link(s,null,n)}return l},a.escapes=function(e){return e?e.replace(a.rules._escapes,"$1"):e},a.prototype.outputLink=function(e,t){var n=t.href,s=t.title?u(t.title):null;return"!"!==e[0].charAt(0)?this.renderer.link(n,s,this.output(e[1])):this.renderer.image(n,s,u(e[1]))},a.prototype.smartypants=function(e){return this.options.smartypants?e.replace(/---/g,"โ").replace(/--/g,"โ").replace(/(^|[-\u2014/(\[{"\s])'/g,"$1โ").replace(/'/g,"โ").replace(/(^|[-\u2014/(\[{\u2018\s])"/g,"$1โ").replace(/"/g,"โ").replace(/\.{3}/g,"โฆ"):e},a.prototype.mangle=function(e){if(!this.options.mangle)return e;for(var t,n="",s=e.length,r=0;r<s;r++)t=e.charCodeAt(r),Math.random()>.5&&(t="x"+t.toString(16)),n+="&#"+t+";";return n},o.prototype.code=function(e,t,n){var s=(t||"").match(/\S*/)[0];if(this.options.highlight){var r=this.options.highlight(e,s);null!=r&&r!==e&&(n=!0,e=r)}return s?'<pre><code class="'+this.options.langPrefix+u(s,!0)+'">'+(n?e:u(e,!0))+"</code></pre>\n":"<pre><code>"+(n?e:u(e,!0))+"</code></pre>"},o.prototype.blockquote=function(e){return"<blockquote>\n"+e+"</blockquote>\n"},o.prototype.html=function(e){return e},o.prototype.heading=function(e,t,n,s){return this.options.headerIds?"<h"+t+' id="'+this.options.headerPrefix+s.slug(n)+'">'+e+"</h"+t+">\n":"<h"+t+">"+e+"</h"+t+">\n"},o.prototype.hr=function(){return this.options.xhtml?"<hr/>\n":"<hr>\n"},o.prototype.list=function(e,t,n){var s=t?"ol":"ul";return"<"+s+(t&&1!==n?' start="'+n+'"':"")+">\n"+e+"</"+s+">\n"},o.prototype.listitem=function(e){return"<li>"+e+"</li>\n"},o.prototype.checkbox=function(e){return"<input "+(e?'checked="" ':"")+'disabled="" type="checkbox"'+(this.options.xhtml?" /":"")+"> "},o.prototype.paragraph=function(e){return"<p>"+e+"</p>\n"},o.prototype.table=function(e,t){return t&&(t="<tbody>"+t+"</tbody>"),"<table>\n<thead>\n"+e+"</thead>\n"+t+"</table>\n"},o.prototype.tablerow=function(e){return"<tr>\n"+e+"</tr>\n"},o.prototype.tablecell=function(e,t){var n=t.header?"th":"td";return(t.align?"<"+n+' align="'+t.align+'">':"<"+n+">")+e+"</"+n+">\n"},o.prototype.strong=function(e){return"<strong>"+e+"</strong>"},o.prototype.em=function(e){return"<em>"+e+"</em>"},o.prototype.codespan=function(e){return"<code>"+e+"</code>"},o.prototype.br=function(){return this.options.xhtml?"<br/>":"<br>"},o.prototype.del=function(e){return"<del>"+e+"</del>"},o.prototype.link=function(e,t,n){if(null===(e=p(this.options.sanitize,this.options.baseUrl,e)))return n;var s='<a href="'+u(e)+'"';return t&&(s+=' title="'+t+'"'),s+=">"+n+"</a>"},o.prototype.image=function(e,t,n){if(null===(e=p(this.options.sanitize,this.options.baseUrl,e)))return n;var s='<img src="'+e+'" alt="'+n+'"';return t&&(s+=' title="'+t+'"'),s+=this.options.xhtml?"/>":">"},o.prototype.text=function(e){return e},i.prototype.strong=i.prototype.em=i.prototype.codespan=i.prototype.del=i.prototype.text=function(e){return e},i.prototype.link=i.prototype.image=function(e,t,n){return""+n},i.prototype.br=function(){return""},l.parse=function(e,t){return new l(t).parse(e)},l.prototype.parse=function(e){this.inline=new a(e.links,this.options),this.inlineText=new a(e.links,y({},this.options,{renderer:new i})),this.tokens=e.reverse();for(var t="";this.next();)t+=this.tok();return t},l.prototype.next=function(){return this.token=this.tokens.pop(),this.token},l.prototype.peek=function(){return this.tokens[this.tokens.length-1]||0},l.prototype.parseText=function(){for(var e=this.token.text;"text"===this.peek().type;)e+="\n"+this.next().text;return this.inline.output(e)},l.prototype.tok=function(){switch(this.token.type){case"space":return"";case"hr":return this.renderer.hr();case"heading":return this.renderer.heading(this.inline.output(this.token.text),this.token.depth,h(this.inlineText.output(this.token.text)),this.slugger);case"code":return this.renderer.code(this.token.text,this.token.lang,this.token.escaped);case"table":var e,t,n,s,r="",a="";for(n="",e=0;e<this.token.header.length;e++)n+=this.renderer.tablecell(this.inline.output(this.token.header[e]),{header:!0,align:this.token.align[e]});for(r+=this.renderer.tablerow(n),e=0;e<this.token.cells.length;e++){for(t=this.token.cells[e],n="",s=0;s<t.length;s++)n+=this.renderer.tablecell(this.inline.output(t[s]),{header:!1,align:this.token.align[s]});a+=this.renderer.tablerow(n)}return this.renderer.table(r,a);case"blockquote_start":for(a="";"blockquote_end"!==this.next().type;)a+=this.tok();return this.renderer.blockquote(a);case"list_start":a="";for(var o=this.token.ordered,i=this.token.start;"list_end"!==this.next().type;)a+=this.tok();return this.renderer.list(a,o,i);case"list_item_start":a="";var l=this.token.loose,c=this.token.checked,u=this.token.task;for(this.token.task&&(a+=this.renderer.checkbox(c));"list_item_end"!==this.next().type;)a+=l||"text"!==this.token.type?this.tok():this.parseText();return this.renderer.listitem(a,u,c);case"html":return this.renderer.html(this.token.text);case"paragraph":return this.renderer.paragraph(this.inline.output(this.token.text));case"text":return this.renderer.paragraph(this.parseText());default:var d='Token with "'+this.token.type+'" type was not found.';if(!this.options.silent)throw new Error(d);console.log(d)}},c.prototype.slug=function(e){var t=e.toLowerCase().trim().replace(/[\u2000-\u206F\u2E00-\u2E7F\\'!"#$%&()*+,./:;<=>?@[\]^`{|}~]/g,"").replace(/\s/g,"-");if(this.seen.hasOwnProperty(t)){var n=t;do{this.seen[n]++,t=n+"-"+this.seen[n]}while(this.seen.hasOwnProperty(t))}return this.seen[t]=0,t},u.escapeTest=/[&<>"']/,u.escapeReplace=/[&<>"']/g,u.replacements={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},u.escapeTestNoEncode=/[<>"']|&(?!#?\w+;)/,u.escapeReplaceNoEncode=/[<>"']|&(?!#?\w+;)/g;var f={},m=/^$|^[a-z][a-z0-9+.-]*:|^[?#]/i;function g(){}function y(e){for(var t,n,s=1;s<arguments.length;s++)for(n in t=arguments[s])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}function v(e,t){var n=e.replace(/\|/g,(function(e,t,n){for(var s=!1,r=t;--r>=0&&"\\"===n[r];)s=!s;return s?"|":" |"})).split(/ \|/),s=0;if(n.length>t)n.splice(t);else for(;n.length<t;)n.push("");for(;s<n.length;s++)n[s]=n[s].trim().replace(/\\\|/g,"|");return n}function b(e,t,n){if(0===e.length)return"";for(var s=0;s<e.length;){var r=e.charAt(e.length-s-1);if(r!==t||n){if(r===t||!n)break;s++}else s++}return e.substr(0,e.length-s)}function _(e,t){if(-1===e.indexOf(t[1]))return-1;for(var n=0,s=0;s<e.length;s++)if("\\"===e[s])s++;else if(e[s]===t[0])n++;else if(e[s]===t[1]&&--n<0)return s;return-1}function E(e){e&&e.sanitize&&!e.silent&&console.warn("marked(): sanitize and sanitizer parameters are deprecated since version 0.7.0, should not be used and will be removed in the future. Read more here: https://marked.js.org/#/USING_ADVANCED.md#options")}function S(e,t,n){if(null==e)throw new Error("marked(): input parameter is undefined or null");if("string"!=typeof e)throw new Error("marked(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected");if(n||"function"==typeof t){n||(n=t,t=null),E(t=y({},S.defaults,t||{}));var r,a,o=t.highlight,i=0;try{r=s.lex(e,t)}catch(e){return n(e)}a=r.length;var c=function(e){if(e)return t.highlight=o,n(e);var s;try{s=l.parse(r,t)}catch(t){e=t}return t.highlight=o,e?n(e):n(null,s)};if(!o||o.length<3)return c();if(delete t.highlight,!a)return c();for(;i<r.length;i++)!function(e){"code"!==e.type?--a||c():o(e.text,e.lang,(function(t,n){return t?c(t):null==n||n===e.text?--a||c():(e.text=n,e.escaped=!0,void(--a||c()))}))}(r[i])}else try{return t&&(t=y({},S.defaults,t)),E(t),l.parse(s.lex(e,t),t)}catch(e){if(e.message+="\nPlease report this to https://github.com/markedjs/marked.",(t||S.defaults).silent)return"<p>An error occurred:</p><pre>"+u(e.message+"",!0)+"</pre>";throw e}}g.exec=g,S.options=S.setOptions=function(e){return y(S.defaults,e),S},S.getDefaults=function(){return{baseUrl:null,breaks:!1,gfm:!0,headerIds:!0,headerPrefix:"",highlight:null,langPrefix:"language-",mangle:!0,pedantic:!1,renderer:new o,sanitize:!1,sanitizer:null,silent:!1,smartLists:!1,smartypants:!1,xhtml:!1}},S.defaults=S.getDefaults(),S.Parser=l,S.parser=l.parse,S.Renderer=o,S.TextRenderer=i,S.Lexer=s,S.lexer=s.lex,S.InlineLexer=a,S.inlineLexer=a.output,S.Slugger=c,S.parse=S,e.exports=S}(this||"undefined"!=typeof window&&window)}).call(this,n(35))},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=a(n(1)),l=o(n(59)),c=o(n(70)),u=n(220),h=n(678),d=o(n(4)),p=n(117),f=n(25);class m extends i.Component{constructor(e){super(e),this.dropItem=this.dropItem.bind(this),this.equipItem=this.equipItem.bind(this),this.unequipItem=this.unequipItem.bind(this),this.useItem=this.useItem.bind(this),this.setSelectedItem=this.setSelectedItem.bind(this),this.setEquipSelected=this.setEquipSelected.bind(this),this.onChangeCount=this.onChangeCount.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.state={count:"1",filter:"All"}}handleKeyDown(e){const t=p.KeyCode.getKeyCode(e);t===f.Keys.GUI.Inv?this.toggleScreen("Inventory"):f.Keys.KeyMap.isConfirmYes(t)&&this.props.handleKeyDown(e)}onChangeCount(e){const t=e.target.value;this.setState({count:t})}getCount(){const e=parseInt(this.state.count,10);return Number.isInteger(e)&&e>0?e:1}dropItem(){if(null!==this.props.selectedItem){const e=d.default.getDropCmd(this.props.selectedItem,this.getCount());e.callback=e=>{let t="text-success";e.result||(t="text-danger"),this.props.setInventoryMsg({invMsg:e.msg,msgStyle:t}),this.props.selectItemTop(null)},this.props.doInvCmd(e)}else this.props.setInventoryMsg({invMsg:"No item selected for dropping!",msgStyle:"text-danger"})}equipItem(){if(null!==this.props.selectedItem){const e=d.default.getEquipCmd(this.props.selectedItem,this.getCount());e.callback=function(e){let t="text-success";e.result||(t="text-danger"),this.props.setInventoryMsg({invMsg:e.msg,msgStyle:t}),this.props.selectItemTop(null)}.bind(this),this.props.doInvCmd(e)}else this.props.setInventoryMsg({invMsg:"No item selected for equipping!",msgStyle:"text-danger"})}unequipItem(){if(this.props.equipSelected){const e=this.props.equipSelected.slotName,t=this.props.equipSelected.slotNumber,n=d.default.getUnequipCmd(e,t,this.getCount());n.callback=function(e){let t="text-success";e.result||(t="text-danger"),this.props.setInventoryMsg({invMsg:e.msg,msgStyle:t}),this.props.selectEquipTop(null)}.bind(this),this.props.doInvCmd(n)}else this.props.setInventoryMsg({invMsg:"No equipment selected!",msgStyle:"text-danger"})}useItem(){const e=this.props.selectedItem;if(d.default.isNullOrUndef([e]))this.props.setInventoryMsg({invMsg:"You must choose item to use!",msgStyle:"text-danger"});else{const t=this.props.player.getCell(),n=d.default.getUseCmd(e,t);n.callback=function(t){let n="text-success";t.result||(n="text-danger"),this.props.setInventoryMsg({invMsg:t.msg,msgStyle:n}),e.has("OneShot")&&this.props.selectItemTop(null)}.bind(this),this.props.doInvCmd(n)}}setSelectedItem(e){const t="Inventory Selected: "+e.toString();this.props.selectItemTop(e),this.props.setInventoryMsg({invMsg:t,msgStyle:"text-info"}),this.setState({count:e.getCount()})}setEquipSelected(e){if(e.item){const t="Equipment Selected: "+e.item.toString();this.props.selectEquipTop(e),this.props.setInventoryMsg({invMsg:t,msgStyle:"text-info"}),this.setState({count:e.item.getCount()})}}render(){const{player:e}=this.props,t=e.getInvEq().getInventory(),n=e.getInvEq().getEquipment(),s=e.getMaxWeight(),r=n.getWeight(),a=e.has("MasterEquipper"),o=this.getItemTabs(t),d=this.getItemButtons(),p=this.getEquipButtons();return i.createElement(l.default,{"aria-labelledby":"inventory-modal-label",id:"inventoryModal",large:!0,onHide:this.toggleScreen.bind(this,"Inventory"),onKeyPress:this.handleKeyDown,show:this.props.showInventory},i.createElement(c.default,{id:"inventory-modal-label",text:"Inventory"}),i.createElement("div",{className:"modal-body row"},i.createElement("div",{className:"items-box col-md-6"},o,i.createElement(u.GameItems,{eqWeight:r,filter:this.state.filter,inv:t,maxWeight:s,setSelectedItem:this.setSelectedItem})),i.createElement("div",{className:"col-md-6",id:"equipment-box"},p,i.createElement(h.GameEquipment,{eq:n,isMasterEquipper:a,setEquipSelected:this.setEquipSelected}))),i.createElement("div",{className:"modal-footer row"},i.createElement("div",{className:"col-md-6"},i.createElement("p",{className:this.props.msgStyle},this.props.invMsg)),i.createElement("div",{className:"col-md-6"},d,i.createElement("button",{className:"btn btn-danger",onClick:this.toggleScreen.bind(this,"Inventory"),type:"button"},"Close"))))}getItemTabs(e){const t={All:!0};e.getItems().forEach(e=>{t[e.getType()]=!0});const n=Object.keys(t).map(e=>{let t="btn btn-secondary btn-sm";return this.state.filter===e&&(t="btn btn-primary btn-sm"),i.createElement("button",{className:t,key:e,onClick:this.filterItems.bind(this,e)},e)});return i.createElement("ul",null,n)}getItemButtons(){const e=this.props.selectedItem,t=e?"btn btn-secondary":"btn btn-secondary disabled",n=e?"btn btn-secondary":"btn btn-secondary disabled",s=e?"btn btn-secondary":"btn btn-secondary disabled",r=this.getUseButtonText();return i.createElement(i.Fragment,null,i.createElement("button",{className:n,onClick:this.equipItem,type:"button"},"Equip"),i.createElement("button",{className:s,onClick:this.useItem,type:"button"},r),i.createElement("button",{className:t,onClick:this.dropItem,type:"button"},"Drop"),i.createElement("label",null,"Count:",i.createElement("input",{onChange:this.onChangeCount,value:this.state.count})))}getEquipButtons(){const e=this.props.equipSelected?"btn btn-secondary":"btn btn-secondary disabled";return i.createElement(i.Fragment,null,i.createElement("button",{className:e,onClick:this.unequipItem,type:"button"},"Remove"))}toggleScreen(e){this.props.toggleScreen(e)}filterItems(e){this.setState({filter:e})}getUseButtonText(){if(this.props.selectedItem){const e=this.props.selectedItem.getType();if("food"===e)return"Eat";if("potion"===e)return"Drink"}return"Use"}}t.default=m},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=a(n(1)),l=o(n(4));class c extends i.Component{constructor(e){super(e),this.setSelectedItem=this.setSelectedItem.bind(this)}setSelectedItem(){this.props.setSelectedItem(this.props.item)}render(){const e=this.props.item,t=e.toString(),n=e.getName(),s="inv-item-slot "+l.default.getCssClass(l.default.TYPE_ITEM,n);return i.createElement("div",{className:s,onClick:this.setSelectedItem},t)}}t.default=c},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.GameEquipment=void 0;const o=a(n(1)),i=n(679);t.GameEquipment=e=>{const t=e.eq,n=t.getSlotTypes(),s=[],r=e.setEquipSelected;let a="";e.isMasterEquipper&&(a="(Weight reduced by 50%)");for(let e=0;e<n.length;e++){let a=t.getEquipped(n[e]);null===a||Array.isArray(a)||(a=[a]);let l=""+e;if(a&&a.length>0)for(let t=0;t<a.length;t++)l+=","+t,s.push(o.createElement(i.GameEquipSlot,{item:a[t],key:l,setEquipSelected:r,slotName:n[e],slotNumber:t}));else s.push(o.createElement(i.GameEquipSlot,{item:null,key:l,setEquipSelected:r,slotName:n[e],slotNumber:0}))}return o.createElement("div",null,o.createElement("p",null,"Equipment ",a),s)}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GameEquipSlot=void 0;const i=a(n(1)),l=o(n(4));class c extends i.Component{constructor(e){super(e),this.setEquipSelected=this.setEquipSelected.bind(this)}setEquipSelected(){if(null!==this.props.item){const e={item:this.props.item,slotName:this.props.slotName,slotNumber:this.props.slotNumber};this.props.setEquipSelected(e)}}render(){const e=this.props.slotName,t=this.props.item;let n="Empty",s="inv-equip-slot";return null!==t&&(n=t.toString(),s+=" "+l.default.getCssClass(l.default.TYPE_ITEM,t.getName())),i.createElement("div",{className:s,onClick:this.setEquipSelected},e," ",n)}}t.GameEquipSlot=c},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=a(n(1)),l=o(n(681)),c=o(n(766)),u=o(n(767)),h=o(n(768)),d=o(n(277)),p=o(n(360)),f=o(n(771)),m=o(n(772)),g=o(n(4)),y=a(n(190)),v=n(340),b=n(341),_=n(363),E=n(364),S=n(365),w=n(46),C=n(366),O=n(86),T=n(242),M=n(28),A=n(87),N=n(164),x=n(103),P=n(127),I=n(13),D=n(25),k=n(795),L=n(60),R=n(125),B=n(12),F=n(126),G=n(19),j=n(157),W=n(165),Y=n(30),X=a(n(31)),U=D.Keys.KeyMap,$=[],H=["FullGame","ColorTest","Castle","Cave","CaveBr","City","Crypt","Dungeon","MountainFace","MountainSummit","Nest","------------","abandoned_fort","black_tower","capital","dwarven_city","------------","arena","castle","cellular","cave","crypt","digger","divided","dungeon","eller","empty","forest","icey","miner","mountain","uniform","rogue","ruins","rooms","summit","town","townwithwall","wall"],V=["game-board-map-view-xxxxs","game-board-map-view-xxxs","game-board-map-view-xs","game-board-map-view","game-board-map-view-s","game-board-player-view","game-board-player-view-xl"],K=(e,t,n)=>{const[s,r]=[e.getX(),e.getY()],[a,o]=[t.getX(),t.getY()];if(s===a&&r===o)return[e];const i=I.Geometry.getBoxCornersForCells(e,t),l=I.Geometry.getBox(i.ulx,i.uly,i.lrx,i.lry),c=[];return l.forEach(e=>{c.push(n.getCell(e[0],e[1]))}),c};class q extends i.Component{constructor(e){super(e),this.handleKeyDown=this.handleKeyDown.bind(this);const t={debug:!1,boardClassName:"game-board-map-view-xs",boardIndex:V.indexOf("game-board-map-view-xs"),lastTouchedConf:null,zoneType:"city",zoneList:[],zoneConf:{shown:""},levelX:500,levelY:200,levelType:"abandoned_fort",subLevelX:20,subLevelY:7,subLevelType:"arena",subLevelTileX:1,subLevelTileY:1,errorMsg:"",msg:"",itemFunc:e=>e.value<5e3,maxValue:5e3,selectedCell:null,selectMode:!1,selectBegin:null,selectEnd:null,elementType:"stairsUp",actorName:"traveller",itemName:"",numEntities:20,insertXWidth:1,insertYWidth:1,levelConf:{shown:""},subLevelConf:{shown:""},level:null,levelList:[],levelIndex:0,showAnimations:!0,frameCount:0,fps:0,simulationStarted:!1,simulationPaused:!1,turnsPerSec:1e3,turnsPerFrame:1,idCount:0,updateMap:!0,enablePathfind:!1,enableBresenham:!1,useRLE:!0,savedLevelName:"saved_level_from_editor.json"};this.screen=new j.Screen(t.levelX,t.levelY),t.levelConf.shown=t.levelType,t.levelConf[t.levelType]=this.getLevelConf(t.levelType),this.state=t;const n=this.createLevel(t.levelType);n.getMap()._optimizeForRowAccess(),n.editorID=t.idCount++,t.level=n,t.levelList.push(n),z.setDebugHandle("LEVEL",n),this.parser=B.ObjectShell.getParser(),this.intervalID=null,this.frameID=null,this.setMsg=this.setMsg.bind(this),this.getLevelConf=this.getLevelConf.bind(this),this.createLevel=this.createLevel.bind(this),this.generateWorld=this.generateWorld.bind(this),this.generateZone=this.generateZone.bind(this),this.generateGame=this.generateGame.bind(this),this.onChangeZoneType=this.onChangeZoneType.bind(this),this.generateLevel=this.generateLevel.bind(this),this.onChangeMapType=this.onChangeMapType.bind(this),this.subGenerateMap=this.subGenerateMap.bind(this),this.onChangeSubType=this.onChangeSubType.bind(this),this.generateActors=this.generateActors.bind(this),this.generateItems=this.generateItems.bind(this),this.setShownLevel=this.setShownLevel.bind(this),this.onCellClick=this.onCellClick.bind(this),this.onChangeCellSelectX=this.onChangeCellSelectX.bind(this),this.onChangeCellSelectY=this.onChangeCellSelectY.bind(this),this.onChangeInputInt=this.onChangeInputInt.bind(this),this.onInputChange=this.onInputChange.bind(this),this.insertElement=this.insertElement.bind(this),this.insertActor=this.insertActor.bind(this),this.insertItem=this.insertItem.bind(this),this.importConfig=this.importConfig.bind(this),this.exportConfig=this.exportConfig.bind(this),this.invertMap=this.invertMap.bind(this),this.simulateLevel=this.simulateLevel.bind(this),this.stepSimulation=this.stepSimulation.bind(this),this.playSimulation=this.playSimulation.bind(this),this.playFastSimulation=this.playFastSimulation.bind(this),this.pauseSimulation=this.pauseSimulation.bind(this),this.stopSimulation=this.stopSimulation.bind(this),this.onLoadCallback=this.onLoadCallback.bind(this),this.menuCallback=this.menuCallback.bind(this),this.addLevelToEditor=this.addLevelToEditor.bind(this),this.setEditorData=this.setEditorData.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseOver=this.onMouseOver.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseOverCell=this.onMouseOverCell.bind(this),this.handleRightClick=this.handleRightClick.bind(this)}componentDidMount(){if(document.addEventListener("keypress",this.handleKeyDown,!0),this.props.editorData){const{allLevels:e}=this.props.editorData;e&&e.length>0&&(this.state.levelList=e)}}getCurrMap(){return this.state.level?this.state.level.getMap():null}getCellCurrMap(e,t){const n=this.getCurrMap();return n&&n.hasXY(e,t)?n.getCell(e,t):null}handleRightClick(e,t,n){const[s,r]=n.getXY();this.useClickHandler(s,r,n,t.type)}useClickHandler(e,t,n,s){new m.default(this.state.level).handleClick(e,t,n,s)&&this.setState({level:this.state.level})}onMouseOverCell(e,t){const n=this.getCellCurrMap(e,t);n&&this.setState({mouseOverCell:n})}setCellsForPathfinding(e){const t=this.getFirstSelectedCell();if(t){const n=this.getCurrMap(),[s,r]=t.getXY(),[a,o]=e.getXY(),i=G.Path.getShortestPassablePathWithDoors(n,s,r,a,o).map(e=>n.getCell(e.x,e.y));this.setState({selectedCell:i,mouseOverCell:e})}else this.setState({mouseOverCell:e})}setCellsForBresenham(e){const t=this.getFirstSelectedCell();if(t){const n=this.getCurrMap(),[s,r]=t.getXY(),[a,o]=e.getXY(),i=I.Geometry.getBresenham(s,r,a,o).map(e=>n.getCell(e[0],e[1]));this.setState({selectedCell:i,mouseOverCell:e})}else this.setState({mouseOverCell:e})}onMouseDown(e,t){if(!this.state.selectMode){const n=this.getCellCurrMap(e,t);this.setState({selectMode:!0,selectBegin:n,selectEnd:n})}}onMouseUp(e,t){if(this.state.selectMode){const n=this.getCellCurrMap(e,t);if(n){const e={selectMode:!1,selectEnd:n,cellSelectX:n.getX(),cellSelectY:n.getY()};this.state.selectBegin===this.state.selectEnd&&(e.selectedCell=[n]),this.setState(e)}}}onMouseOver(e,t){const n=this.getCellCurrMap(e,t);if(this.state.selectMode){if(n){const e=this.getCurrMap(),t=this.state.selectBegin;if(t){const s=K(t,n,e),r=n.getX()-t.getX(),a=n.getY()-t.getY();this.setState({selectedCell:s,selectEnd:n,selectDiffX:r,selectDiffY:a})}}}else this.state.enablePathfind?n&&this.setCellsForPathfinding(n):this.state.enableBresenham&&n&&this.setCellsForBresenham(n)}componentWillUnmount(){document.removeEventListener("keypress",this.handleKeyDown,!0)}setStateWithLevel(e,t={}){e.getMap()._optimizeForRowAccess(),this.setState(Object.assign({level:e},t))}getFirstSelectedCell(){return this.state.selectedCell&&this.state.selectedCell.length>0?this.state.selectedCell[0]:null}handleKeyDown(e){const t=this.nextCode=e.keyCode;if(t===y.KEYS.VK_PERIOD)this.setState({elementType:"floor"}),this.insertElement();else if(t===y.KEYS.VK_W)this.setState({elementType:"wall"}),this.insertElement();else if(U.inMoveCodeMap(t)){let e=1;t>=y.KEYS.VK_1&&t<=y.KEYS.VK_9&&(e=10);let n=this.getFirstSelectedCell();if(this.state.selectMode&&(n=this.state.selectEnd),n){const[s,r]=[n.getX(),n.getY()],a=U.getDir(t),o=s+a[0]*e,i=r+a[1]*e,l=this.getCurrMap();if(l&&l.hasXY(o,i)){const e=l.getCell(o,i);if(this.state.selectMode){const t=this.state.selectBegin;if(t){const n=K(t,e,l),s=o-t.getX(),r=i-t.getY();this.setState({selectedCell:n,selectEnd:e,selectDiffX:s,selectDiffY:r})}}else this.setState({selectedCell:[e],cellSelectX:o,cellSelectY:i})}}}else if(t===D.Keys.VK.s){const e=this.getFirstSelectedCell(),t=!this.state.selectMode;this.state.selectMode?e&&this.setState({selectMode:t,selectEnd:e}):e&&this.setState({selectMode:t,selectBegin:e,selectEnd:e})}}getLevel(){return this.state.levelList.length?this.state.levelList[this.state.levelIndex]:null}onCellClick(e,t){const n=this.getCurrMap();if(n&&n.hasXY(e,t)){const s=n.getCell(e,t);console.log(`Clicked ${e},${t} ${JSON.stringify(s)}`),z.printCellInfo(s)}}generateWorld(){const e=this.state.levelX/100,t=this.state.levelY/100,n={yFirst:!1,topToBottom:!1,stopOnWall:!0,nVWalls:[.8],owTilesX:10*e,owTilesY:10*t,worldX:1*this.state.levelX,worldY:1*this.state.levelY,nLevelsX:1*e,nLevelsY:1*t,areaX:1*e,areaY:1*t};if(!Number.isInteger(e)||!Number.isInteger(t)){const e="levelX/Y must be multiples of 100";return void this.setState({errorMsg:e,lastTouchedConf:n})}const s=R.OWMap.createOverWorld(n),r=F.OverWorld.createOverWorldLevel(s,n)[0];this.addLevelToEditor(r)}generateGame(){const e=new T.FactoryGame,t=this.state.levelConf.FullGame;this.game=e.createNewGame(t)}generateZone(){const e=this.state.zoneType,t=new A.FactoryWorld,n=this.state.zoneConf[e];try{let s=null;switch(e){case"branch":s=t.createBranch(n);break;case"city":s=t.createCity(n);break;case"dungeon":s=t.createDungeon(n);break;case"face":s=t.createMountainFace(n);break;case"mountain":s=t.createMountain(n);break;case"quarter":s=t.createCityQuarter(n);break;default:console.log("No legal zoneType given")}s&&this.addZoneToEditor(e,s)}catch(e){this.setState({errorMsg:e.message})}}generateLevel(){const e=this.state.levelType,t=this.createLevel(e);this.addLevelToEditor(t),"FullGame"===e&&this.setState({levelList:this.game.getLevelsInAllPlaces()})}createLevel(e,t){let n={};this.state.levelConf.hasOwnProperty(e)&&(n=this.state.levelConf[e]),n.transpose=!1;let[s,r]=[this.state.levelX,this.state.levelY];n.parser=this.parser,t&&(s=t.cols,r=t.rows,n=t,console.log("Set extraConf",s,r,t));let a=null;if("capital"===e)a=new E.Capital(s,r,n).getLevel();else if("abandoned_fort"===e)a=new _.AbandonedFort(s,r,n).getLevel();else if("dwarven_city"===e)a=new C.DwarvenCity(s,r,n).getLevel();else{if("black_tower"===e){return new S.BlackTower(s,r,n).getLevels()[n.nLevel].level}if("Dungeon"===e)a=(new X.DungeonGenerator).create(s,r,n);else if("Cave"===e)a=(new X.CaveGenerator).create(s,r,n);else if("CaveBr"===e)a=(new X.CaveBrGenerator).create(s,r,n);else if("Castle"===e)a=(new X.CastleGenerator).create(s,r,n);else if("City"===e)a=(new X.CityGenerator).create(s,r,n);else if("Crypt"===e){const e=new X.CryptGenerator;e.factZone=new N.FactoryZone,a=e.create(s,r,n)}else if("MountainFace"===e)a=(new X.MountainGenerator).createFace(s,r,n);else if("MountainSummit"===e)a=(new X.MountainGenerator).createSummit(s,r,n);else if("Nest"===e)a=(new X.NestGenerator).create(s,r,n);else if("FullGame"===e)this.generateGame(),a=this.game.shownLevel();else if("ColorTest"===e){a=new k.ColorTestScreen(n).level}else{a=(new M.FactoryLevel).createLevel(e,s,r,n)}}return delete n.parser,a}addLevelToEditor(e){e.getMap()._optimizeForRowAccess(),e.editorID=this.state.idCount++;const t=this.state.levelList;t.push(e);const n=t.length-1;this.setShownLevel({level:e,levelList:t,levelIndex:n})}addZoneToEditor(e,t){const n=t.getLevels(),s=this.state.levelList;n.forEach(e=>{e.getMap()._optimizeForRowAccess(),e.editorID=this.state.idCount++,s.push(e)});const r=this.state.zoneConf;r.shown=e;const a=this.state.levelIndex+1;this.setShownLevel({level:n[0],levelList:s,levelIndex:a,zoneConf:r})}subGenerateMap(){const e=this.state.level;if(!e)return void this.setState({errorMsg:"Editor has no level for placing the sub-level!"});const t=this.state.subLevelType;let n={};this.state.subLevelConf.hasOwnProperty(t)&&(n=this.state.subLevelConf[t]);const s=this.state.subLevelX,r=this.state.subLevelY;if(n.cols=s,n.rows=r,this.state.selectedCell){const[a,o]=this.getFirstSelectedCell().getXY();let i="";try{for(let i=0;i<this.state.subLevelTileX;i++)for(let l=0;l<this.state.subLevelTileY;l++){const c=a+i*s,u=o+l*r,h=this.createLevel(t,n);I.Geometry.mergeLevels(e,h,c,u)}}catch(e){i=e.message,console.error(e)}e.getMap()._optimizeForRowAccess(),this.setState(((e,t)=>()=>({level:e,errorMsg:t}))(e,i))}else{const e="You must select a cell first from the map.";this.setState({errorMsg:e})}}generateItems(){const e={item:this.state.itemFunc,maxValue:this.state.maxValue,itemsPerLevel:this.state.numEntities},t=this.state.level;if(!t)return void this.setState({errorMsg:"Editor has no levels to generate items!"});t.getItems().forEach(e=>{t.removeItem(e,e.getX(),e.getY())});(new O.FactoryBase).addNRandItems(t,this.parser,e),this.setStateWithLevel(t)}generateActors(){const e=this.state.level;if(!e)return void this.setState({errorMsg:"Editor has no levels to generate actors!"});e.getActors().forEach(t=>{e.removeActor(t)});const t={maxDanger:20,actorsPerLevel:this.state.numEntities,actor:e=>e.danger<100},n=new O.FactoryBase;n.setParser(B.ObjectShell.getParser()),n.addNRandActors(e,this.parser,t),this.setStateWithLevel(e)}debugMsg(e){this.state.debug&&console.log("[DEBUG] "+e)}getBBoxForInsertion(){const e=this.state.selectBegin,t=this.state.selectEnd;return e&&t?I.Geometry.getBoxCornersForCells(e,t):null}insertElement(){const e=this.getBBoxForInsertion();if(!e)return;const{ulx:t,uly:n,lrx:s,lry:r}=e;this.debugMsg(`insertElement: ${t}, ${n}, ${s}, ${r}`);const a=this.state.level;if(!a)return;const o=new O.FactoryBase,i=e=>o.createElement(e);try{I.Geometry.insertElements(a,this.state.elementType,new Y.BBox(t,n,s,r),i)}catch(e){this.setState({errorMsg:e.message})}this.setStateWithLevel(a)}insertActor(){const e=this.getBBoxForInsertion();if(!e)return;const{ulx:t,uly:n,lrx:s,lry:r}=e;this.debugMsg(`insertActor: ${t}, ${n}, ${s}, ${r}`);const a=this.state.level;if(a){try{I.Geometry.insertActors(a,this.state.actorName,{ulx:t,uly:n,lrx:s,lry:r},this.parser)}catch(e){this.setState({errorMsg:e.message})}a&&this.setStateWithLevel(a)}}insertItem(){const e=this.getBBoxForInsertion();if(!e)return;const{ulx:t,uly:n,lrx:s,lry:r}=e,a=this.state.level;if(a){try{I.Geometry.insertItems(a,this.state.itemName,{ulx:t,uly:n,lrx:s,lry:r},this.parser)}catch(e){this.setState({errorMsg:e.message})}a&&this.setStateWithLevel(a)}}invertMap(){const e=this.state.level;if(e){const t=e.getMap();w.CellMap.invertMap(t),this.setStateWithLevel(e)}}setMsg(e){e.errorMsg?this.setState({errorMsg:e.errorMsg}):"string"==typeof e&&this.setState({errorMsg:e})}render(){let e="cell-row-div-player-view";this.props.mapShown&&(e="cell-row-div-map-view"),"game-board-map-view-xxxs"===this.state.boardClassName&&(e="cell-row-div-map-view-xxxs");let t=null,n=null;this.state.level&&(t=this.state.level.getMap()),this.state.selectedCell&&this.screen.setSelectedCell(this.state.selectedCell),t?(n=t.cols,this.state.useRLE?this.screen.renderFullMapWithRLE(t):this.screen.renderFullMap(t)):this.screen.clear();const s=this.getEditorMsg(),r=this.getSimulationButtons();let a=[];this.state.simulationStarted&&this.game.hasNewMessages()&&(a=this.game.getMessages());const o=!this.state.simulationStarted||this.state.simulationStarted&&this.state.simulationPaused;let h=null;o&&(h=this.getEditorPanelElement());let m=0;return this.state.simulationStarted&&(m=this.game.getTimeOfDayMins()),i.default.createElement("div",{className:"game-editor-main-div"},i.default.createElement("p",{className:"text-primary"},"Battles Game Editor: ",s),i.default.createElement(l.default,{addLevel:this.addLevelToEditor,level:this.state.level,menuCallback:this.menuCallback,toggleEditor:this.props.toggleEditor}),o&&h,this.state.simulationStarted&&i.default.createElement("div",{className:"game-editor-game-messages"},i.default.createElement(d.default,{message:a,saveInProgress:!1,showAll:!0,visibleCells:$})),i.default.createElement("div",{className:"row"},i.default.createElement("div",{className:"col-md-2"},i.default.createElement(u.default,{levelIndex:this.state.levelIndex,levelList:this.state.levelList,setShownLevel:this.setShownLevel})),i.default.createElement("div",{className:"col-md-10"},"Time: ",m,i.default.createElement("div",{className:"game-editor-board-div"},i.default.createElement(c.default,{boardClassName:this.state.boardClassName,onCellClick:this.onCellClick,onMouseDown:this.onMouseDown,onMouseOver:this.onMouseOver,onMouseOverCell:this.onMouseOverCell,onMouseUp:this.onMouseUp,rowClass:e,screen:this.screen,sizeX:n,updateMap:this.state.updateMap,useRLE:this.state.useRLE})))),i.default.createElement("div",{className:"game-editor-bottom-btn"},r,i.default.createElement("div",{className:"btn-div"},i.default.createElement(p.default,{id:"",objData:this.state.level,onLoadCallback:this.onLoadCallback,savedObjName:this.state.savedLevelName,setMsg:this.setMsg}),i.default.createElement("div",null,i.default.createElement("button",{className:"btn btn-danger btn-lg",onClick:this.props.toggleEditor},"Close editor"),i.default.createElement("button",{className:"btn btn-success btn-lg",onClick:this.setEditorData},"Set game data")))),i.default.createElement(f.default,{handleRightClick:this.handleRightClick,mouseOverCell:this.state.mouseOverCell}))}setEditorData(){this.props.setEditorData(this.state.levelList,this.state.levelList)}onLoadCallback(e){const t=new x.FromJSON,n=t.restoreLevel(e);t.restoreEntityData(),this.addLevelToEditor(n)}getEditorMsg(){return this.state.errorMsg.length>0?i.default.createElement("span",{className:"text-danger"},this.state.errorMsg):this.state.msg.length>0?i.default.createElement("span",{className:"text-info"},this.state.msg):i.default.createElement("span",{className:"text-success"},"OK. No errors.")}modifyLevelConf(e,t){t.shown=e,t[e]||(t[e]=this.getLevelConf(e))}getLevelConf(e){if(console.log("getLevelConf with",e),"town"===e)return O.Factory.cityConfBase({});if("townwithwall"===e)return O.Factory.cityConfBase({});if("forest"===e)return{nForests:5,forestSize:100,ratio:.5,factor:6};if("mountain"===e)return X.MapGenerator.getOptions("mountain");if("crypt"===e||"castle"===e)return{tilesX:12,tilesY:7,roomCount:30,genParams:[2,2,2,2]};if("wall"===e){return new b.MapWall(0,0)._options}if("abandoned_fort"===e)return _.abandonedFortConf;if("dwarven_city"===e)return C.dwarvenCityConf;if("black_tower"===e)return S.blackTowerConf;if("Dungeon"===e)return X.DungeonGenerator.getOptions();if("Cave"===e)return X.CaveGenerator.getOptions();if("CaveBr"===e)return X.CaveBrGenerator.getOptions();if("Castle"===e)return X.CastleGenerator.getOptions();if("City"===e)return X.CityGenerator.getOptions();if("Crypt"===e){const e=X.CryptGenerator.getOptions();e.nLevel=0,e.sqrPerItem=40,e.sqrPerActor=40;const t={actor:[{op:"eq",prop:"type",value:"undead"}]};return e.actor=(new L.Constraints).getConstraints(t.actor),e}if("Nest"===e)return X.NestGenerator.getOptions();if("cave"===e){const e=new v.MapMiner(0,0)._options;return delete e.rng,e}if("MountainFace"===e)return X.MountainGenerator.getFaceOptions();if("MountainSummit"===e)return X.MountainGenerator.getSummitOptions();if("FullGame"===e){const e=T.FactoryGame.getOwConf(),t=T.FactoryGame.getGameConf();return t.world=e,t}return"ColorTest"===e?k.ColorTestScreen.getConf():{}}zoom(e){let t=this.state.boardIndex;"+"===e?t<V.length-1&&++t:"-"===e&&t>0&&--t;const n=V[t];this.setState({boardClassName:n,boardIndex:t})}onInputChange(e){const{name:t}=e.target;let{value:n}=e.target;const[s,r]=t.split("-");"checkbox"===s&&(n=e.target.checked),console.log("name",t),console.log("value",n),console.log("checked",e.target.checked),console.log("stateVar",r),r&&(this.state.hasOwnProperty(r)?this.setState({[r]:n}):console.warn(`onInputChange: <${s}> No ${r} in state`))}onChangeLevelConf(e,t,n){const s=`#${n}--${e}--${t}`,r=document.querySelector(s),a=parseInt(r.value,10);let o=null;o="main"===n?this.state.levelConf:"zone"===n?this.state.zoneConf:this.state.subLevelConf,t.match(/(\w+)Func/)||(isNaN(a)?"string"!=typeof o[e]&&(o[e][t]=r.value):"string"!=typeof o[e]&&(o[e][t]=a)),"main"===n?this.setState({levelConf:o}):"zone"===n?this.setState({zoneConf:o}):this.setState({subLevelConf:o})}onChangeZoneType(e){const t=e.target.value,n=W.WorldConf.getBaseConf(t),s=this.state.zoneConf;s[t]=n,s.shown=t,this.setState({zoneType:t,zoneConf:s,lastTouchedConf:s})}onChangeMapType(e){const t=e.target.value,n=t,s=this.state.levelConf;this.modifyLevelConf(t,s),this.setState({levelType:n,levelConf:s,lastTouchedConf:s})}getInt(e,t){const n=parseInt(e,t);return Number.isInteger(n)?n:0}onChangeSubType(e){const t=e.target.value,n=this.state.subLevelConf;this.modifyLevelConf(t,n),this.setState({subLevelType:t,subLevelConf:n,lastTouchedConf:n})}onChangeInputInt(e){const[t,n]=e.target.name.split("-");if("input"===t){const t=this.getInt(e.target.value,10);this.setState({[n]:t})}}onChangeCellSelectX(e){const t=this.getInt(e.target.value,10),n=this.getFirstSelectedCell(),s={cellSelectX:t},r=this.state.level;if(r){const e=r.getMap();if(Number.isInteger(t)&&n&&e.hasXY(t,n.getY())){const r=e.getCell(t,n.getY());r&&(s.selectedCell=[r])}this.setState(s)}}onChangeCellSelectY(e){const t=this.getInt(e.target.value,10),n=this.getFirstSelectedCell(),s={cellSelectY:t},r=this.state.level;if(r){const e=r.getMap();if(Number.isInteger(t)&&n&&e.hasXY(n.getX(),t)){const r=e.getCell(n.getX(),t);r&&(s.selectedCell=[r])}this.setState(s)}}playAnimation(){if(this.game.hasAnimation()){const e=this.game.getAnimationFrame();this.setState({render:!0,animation:e}),this.animationID=requestAnimationFrame(this.playAnimation.bind(this))}else this.setState({render:!0,animation:null})}simulateLevel(e=!1){if(this.state.level)if(this.state.simulationStarted)this.playSimulation();else{this.game=new P.GameMain,z.setDebugHandle("GAME",this.game);const t=new x.FromJSON,n=this.state.level.toJSON(),s=t.restoreLevel(n);t.restoreEntityData(),s.getMap()._optimizeForRowAccess(),s.editorID=this.state.idCount++,this.game.addLevel(s),this.game.addActiveLevel(s),this.state.showAnimations&&this.game.setAnimationCallback(this.playAnimation.bind(this));const r=(new Date).getTime();this.setState(((e,t)=>()=>({level:t,startTime:e,simulationStarted:!0,frameCount:0}))(r,s)),e||(this.frameID=requestAnimationFrame(this.mainLoop.bind(this)))}else{const e="You must create a level before simulation!";this.setState({errorMsg:e})}}mainLoop(){const e=this.state.frameCount,t=1e3*e/((new Date).getTime()-this.state.startTime);for(let e=0;e<this.state.turnsPerFrame;e++)this.game.simulateGame(1);this.setState({frameCount:e+1,fps:t}),this.frameID=requestAnimationFrame(this.mainLoop.bind(this))}mainLoopFast(){for(let e=0;e<this.state.turnsPerSec;e++)this.game.simulateGame(1);this.setShownLevel({level:this.game.getLevels()[0]})}playSimulation(){this.state.simulationStarted?(null!==this.intervalID&&(clearInterval(this.intervalID),this.intervalID=null),null===this.frameID&&(this.frameID=requestAnimationFrame(this.mainLoop.bind(this))),this.setState({simulationPaused:!1})):console.error("Start simulation first using Simulate")}stepSimulation(){this.state.simulationStarted?(this.game.simulateGame(1),this.setShownLevel({level:this.game.getLevels()[0]})):this.simulateLevel(!0)}playFastSimulation(){this.state.simulationStarted?(this.frameID&&(cancelAnimationFrame(this.frameID),this.frameID=null),this.intervalID=setInterval(this.mainLoopFast.bind(this),this.state.turnsPerSec),this.setState({simulationPaused:!1})):console.error("Start simulation first using Simulate")}pauseSimulation(){this.intervalID&&(clearInterval(this.intervalID),this.intervalID=null),this.frameID&&(cancelAnimationFrame(this.frameID),this.frameID=null),this.setState({simulationPaused:!0})}stopSimulation(){this.state.simulationStarted&&(this.intervalID&&(clearInterval(this.intervalID),this.intervalID=null),this.frameID&&(cancelAnimationFrame(this.frameID),this.frameID=null),this.game=null,z.setDebugHandle("GAME",null),delete this.game,this.setShownLevel({level:this.getLevel(),simulationStarted:!1,simulationPaused:!1}))}setShownLevel(e){window.LEVEL!==e.level&&z.setDebugHandle("LEVEL",e.level),this.setState(e)}getConfElement(e,t){let n=null;const s=t.shown;if(s.length>0){t.hasOwnProperty(s)||console.error("No conf for level type "+s);const r=t[s];n=Object.keys(r).map(n=>{const a=t[s][n],o=a||r[n],l=this.onChangeLevelConf.bind(this,s,n,e);return"function"!=typeof r[n]?i.default.createElement("label",{key:`${s}--${n}`},n,i.default.createElement("input",{id:`${e}--${s}--${n}`,name:`${e}--{confType}-${n}`,onChange:l,value:o})):i.default.createElement("label",null,n)})}return i.default.createElement("div",{className:"game-editor-level-conf"},n)}getLevelSelectElement(){return H.map(e=>{const t="key-sel-type-"+e;return i.default.createElement("option",{key:t,value:e},e)})}getElementSelectElem(){return Object.keys(g.default.cellStyles.elements).map(e=>{if("default"!==e){const t="key-sel-element-"+e;return i.default.createElement("option",{key:t,value:e},e)}return null})}getSelectElem(e){const t=this.parser.dbGet({categ:e});return Object.values(t).map(t=>{const n=`key-sel-${e}-${t.name}`;return i.default.createElement("option",{key:n,value:t.name},t.name)})}getZoneSelectElem(){return Object.values(["branch","city","dungeon","face","mountain","quarter"]).map(e=>{const t="key-sel-feature-"+e;return i.default.createElement("option",{key:t,value:e},e)})}getEditorPanelElement(){const e=this.getZoneSelectElem(),t=this.getConfElement("zone",this.state.zoneConf),n=this.getConfElement("main",this.state.levelConf),s=this.getLevelSelectElement(),r=this.getElementSelectElem(),a=this.getSelectElem("actors"),o=this.getSelectElem("items"),l=this.getConfElement("sub",this.state.subLevelConf);return i.default.createElement("div",{className:"game-editor-panel"},i.default.createElement("div",{className:"row"},i.default.createElement("div",{className:"col-md-6"},i.default.createElement("div",{className:"btn-div"},i.default.createElement("button",{id:"btn-gen-world",onClick:this.generateWorld},"OverWorld"),i.default.createElement("span",null,"Zoom In/Out:",i.default.createElement("button",{id:"btn-zoom-in",onClick:this.zoom.bind(this,"+")},"+"),i.default.createElement("button",{id:"btn-zoom-out",onClick:this.zoom.bind(this,"-")},"-"),i.default.createElement("label",null,i.default.createElement("input",{checked:this.state.updateMap,name:"checkbox-updateMap",onChange:this.onInputChange,type:"checkbox"}),"Update map"),i.default.createElement("label",null,i.default.createElement("input",{checked:this.state.enablePathfind,name:"checkbox-enablePathfind",onChange:this.onInputChange,type:"checkbox"}),"Pathfinding"),i.default.createElement("label",null,i.default.createElement("input",{checked:this.state.enableBresenham,name:"checkbox-enableBresenham",onChange:this.onInputChange,type:"checkbox"}),"Bresenham"))),i.default.createElement("div",{className:"btn-div"},i.default.createElement("button",{id:"btn-gen-zone",onClick:this.generateZone},"Zone!"),i.default.createElement("select",{name:"feature-type",onChange:this.onChangeZoneType,value:this.state.zoneType},e),t),i.default.createElement("div",{className:"btn-div"},i.default.createElement("button",{id:"btn-gen-level",onClick:this.generateLevel},"Level!"),i.default.createElement("select",{name:"level-type",onChange:this.onChangeMapType,value:this.state.levelType},s),i.default.createElement("label",null,"Size:",i.default.createElement("input",{name:"input-levelX",onChange:this.onChangeInputInt,value:this.state.levelX}),i.default.createElement("input",{name:"input-levelY",onChange:this.onChangeInputInt,value:this.state.levelY})),i.default.createElement("button",{onClick:this.invertMap},"Invert"),n),i.default.createElement("div",{className:"btn-div"},i.default.createElement("button",{onClick:this.subGenerateMap},"SubGen!"),i.default.createElement("select",{name:"sublevel-type",onChange:this.onChangeSubType,value:this.state.subLevelType},s),i.default.createElement("label",null,"Size:",i.default.createElement("input",{name:"input-subLevelX",onChange:this.onChangeInputInt,value:this.state.subLevelX}),i.default.createElement("input",{name:"input-subLevelY",onChange:this.onChangeInputInt,value:this.state.subLevelY})),i.default.createElement("label",null,"Tiles:",i.default.createElement("input",{name:"input-subLevelTileX",onChange:this.onChangeInputInt,value:this.state.subLevelTileX}),i.default.createElement("input",{name:"input-subLevelTileY",onChange:this.onChangeInputInt,value:this.state.subLevelTileY})),l),i.default.createElement("div",{className:"btn-div"},i.default.createElement("button",{id:"btn-gen-actors",onClick:this.generateActors},"Actors!"),i.default.createElement("button",{id:"btn-gen-items",onClick:this.generateItems},"Items!"),i.default.createElement("input",{name:"input-numEntities",onChange:this.onChangeInputInt,value:this.state.numEntities})),i.default.createElement("div",{className:"btn-div"},i.default.createElement("button",{id:"btn-insert-element",onClick:this.insertElement},"Insert element"),i.default.createElement("select",{name:"input-elementType",onChange:this.onInputChange,value:this.state.elementType},r),i.default.createElement("button",{id:"btn-insert-actor",onClick:this.insertActor},"Insert actor"),i.default.createElement("select",{name:"input-actorName",onChange:this.onInputChange,value:this.state.actorName},a)),i.default.createElement("div",{className:"btn-div"},i.default.createElement("button",{id:"btn-insert-item",onClick:this.insertItem},"Insert item"),i.default.createElement("select",{name:"input-itemName",onChange:this.onInputChange,value:this.state.itemName},o),i.default.createElement("span",null,"| X by Y"),i.default.createElement("input",{name:"input-insertXWidth",onChange:this.onChangeInputInt,value:this.state.insertXWidth}),i.default.createElement("input",{name:"input-insertYWidth",onChange:this.onChangeInputInt,value:this.state.insertYWidth}))),i.default.createElement("div",{className:"col-md-6"},i.default.createElement("div",null,i.default.createElement("p",null,"Template/Config here"),i.default.createElement("textarea",{name:"input-confTemplText",onChange:this.onInputChange,rows:5,value:this.state.confTemplText}),i.default.createElement("button",{onClick:this.importConfig},"Import"),i.default.createElement("button",{onClick:this.exportConfig},"Export")),i.default.createElement("div",{className:"cell-selection"},i.default.createElement("span",null,"Selection:"),i.default.createElement("input",{name:"cell-select-x",onChange:this.onChangeCellSelectX,value:this.state.cellSelectX}),i.default.createElement("input",{name:"cell-select-y",onChange:this.onChangeCellSelectY,value:this.state.cellSelectY})),i.default.createElement("div",{className:"selection-diff"},i.default.createElement("span",null,"dX/dY:"),i.default.createElement("input",{name:"cell-select-diff-x",readOnly:!0,type:"text",value:this.state.selectDiffX}),i.default.createElement("input",{name:"cell-select-diff-x",readOnly:!0,type:"text",value:this.state.selectDiffY})))))}getSimulationButtons(){return i.default.createElement("div",{className:"btn-div"},i.default.createElement(h.default,{menuCallback:this.menuCallback,simulationStarted:this.state.simulationStarted}),i.default.createElement("div",null,i.default.createElement("label",null,"Turns per frame:",i.default.createElement("input",{name:"input-turnsPerFrame",onChange:this.onChangeInputInt,value:this.state.turnsPerFrame}))),i.default.createElement("p",null,"Frame count: ",this.state.frameCount),i.default.createElement("p",null,"FPS: ",this.state.fps))}importConfig(){if(this.state.lastTouchedConf){const e=this.state.lastTouchedConf.shown,t=this.state.lastTouchedConf[e],n=JSON.stringify(t,null,1);this.setState({confTemplText:n})}}exportConfig(){try{const e=JSON.parse(this.state.confTemplText),t=this.state.lastTouchedConf;t[t.shown]=e,this.setState({lastTouchedConf:t})}catch(e){this.setState({errorMsg:e.message})}}menuCallback(e,t){const n=this;"function"==typeof n[e]?Array.isArray(t)?1===t.length?n[e](t):n[e](...t):n[e](t):(console.error(e+" not a function in Top"),console.error("Called with args "+t))}}t.default=q;class z{static printCellInfo(e){if(e.hasActors()){const t=e.getActors()[0];z.setDebugHandle("ACTOR",t),console.log(t),console.log(JSON.stringify(t))}if(e.hasItems()){const t=e.getItems()[0];z.setDebugHandle("ITEM",t),console.log(t),console.log(JSON.stringify(t))}if(e.hasElements()){const t=e.getElements()[0];z.setDebugHandle("ELEMENT",t),console.log(t),console.log(JSON.stringify(t))}}static setDebugHandle(e,t){console.log("Setting debug handle window."+e),window[e]=t}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=a(n(1)),l=o(n(682)),c=n(420);class u extends i.Component{constructor(e){super(e),this.handleSelect=this.handleSelect.bind(this)}handleSelect(e){this.props.menuCallback(e),this.menuLogic.menuCallback(e)}render(){return i.default.createElement("div",{className:"editor-top-menu"},i.default.createElement(c.Nav,{activeKey:"1",bsStyle:"tabs",onSelect:this.handleSelect},i.default.createElement(c.NavDropdown,{eventKey:"file",id:"dropdown-file",title:"File"},i.default.createElement(c.MenuItem,{eventKey:"file-new"},"New..."),i.default.createElement(c.MenuItem,{eventKey:"file-save-as"},"Save as..."),i.default.createElement(c.MenuItem,{eventKey:"file-load"},"Load"),i.default.createElement(c.MenuItem,{eventKey:"file-import"},"Import")),i.default.createElement(c.NavDropdown,{eventKey:"edit",id:"dropdown-edit",title:"Edit"},i.default.createElement(c.MenuItem,{eventKey:"edit-select"},"Select"),i.default.createElement(c.MenuItem,{eventKey:"edit-select-shape"},"Select shape"),i.default.createElement(c.MenuItem,{eventKey:"edit-cut"},"Cut"),i.default.createElement(c.MenuItem,{eventKey:"edit-copy"},"Copy"),i.default.createElement(c.MenuItem,{eventKey:"edit-paste"},"Paste"),i.default.createElement(c.MenuItem,{eventKey:"edit-undo"},"Undo")),i.default.createElement(c.NavDropdown,{eventKey:"simulate",id:"dropdown-simulate",title:"Simulate"},i.default.createElement(c.MenuItem,{eventKey:"simulate-1"},"New game"),i.default.createElement(c.MenuItem,{eventKey:"simulate-2"},"Simulate level"),i.default.createElement(c.MenuItem,{eventKey:"simulate-3"},"Play/Pause"),i.default.createElement(c.MenuItem,{eventKey:"simulate-4"},"Stop"),i.default.createElement(c.MenuItem,{eventKey:"simulate-5"},"Play fast"),i.default.createElement(c.MenuItem,{eventKey:"simulate-6"},"Step")),i.default.createElement(c.NavDropdown,{eventKey:"view",id:"dropdown-view",title:"View"},i.default.createElement(c.MenuItem,{eventKey:"view-1"},"Refresh"),i.default.createElement(c.MenuItem,{eventKey:"view-2"},"Zoom in"),i.default.createElement(c.MenuItem,{eventKey:"view-3"},"Zoom out"),i.default.createElement(c.MenuItem,{eventKey:"view-4"},"Zoom fit")),i.default.createElement(c.NavDropdown,{eventKey:"insert",id:"dropdown-insert",title:"Insert"},i.default.createElement(c.MenuItem,{eventKey:"insert-1"},"Actor"),i.default.createElement(c.MenuItem,{eventKey:"insert-2"},"Item"),i.default.createElement(c.MenuItem,{eventKey:"insert-3"},"Element"),i.default.createElement(c.MenuItem,{eventKey:"insert-4"},"Sublevel"),i.default.createElement(c.MenuItem,{eventKey:"insert-5"},"Shape")),i.default.createElement(c.NavDropdown,{eventKey:"generate",id:"dropdown-generate",title:"Generate"},i.default.createElement(c.MenuItem,{eventKey:"level-new-level"},"New level"),i.default.createElement(c.MenuItem,{eventKey:"level-new-zone"},"New zone"),i.default.createElement(c.MenuItem,{eventKey:"level-new-world"},"New world"),i.default.createElement(c.MenuItem,{eventKey:"level-new-battle"},"New battle")),i.default.createElement(c.NavItem,{className:"text-danger",eventKey:"close",id:"dropdown-close",onClick:this.props.toggleEditor},"Close")),i.default.createElement(l.default,{addLevel:this.props.addLevel,level:this.props.level,onRef:e=>{this.menuLogic=e}}))}}t.default=u},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=a(n(1)),l=o(n(683)),c=n(15)("bitn:TopMenuLogic"),u=n(222);class h extends i.Component{constructor(e){super(e),this.state={showModal:!1,options:{},cmdOptionsText:"",errorMsg:"",currentCmd:""},this.battles=[],this.onClickModalOK=this.onClickModalOK.bind(this),this.onClickModalCancel=this.onClickModalCancel.bind(this),this.newBattle=this.newBattle.bind(this),this.onChangeCmdOptions=this.onChangeCmdOptions.bind(this),this.functions={"level-new-battle":{showModal:!0,func:this.newBattle}}}componentDidMount(){this.props.onRef(this)}componentWillUnmount(){this.props.onRef(null)}onClickModalCancel(){this.setState({showModal:!1,errorMsg:""})}onClickModalOK(){try{const e=JSON.parse(this.state.cmdOptionsText),t=this.functions[this.state.currentCmd].func;if("function"!=typeof t)throw new Error("Internal error occurred.");t(e),console.log(e),this.setState({showModal:!1,errorMsg:""})}catch(e){console.error(e),this.setState({errorMsg:e.message})}}onChangeCmdOptions(e){this.setState({cmdOptionsText:e.target.value})}menuCallback(e){const t=this.needsModal(e),n={name:e},s=JSON.stringify(n);this.setState({showModal:t,cmdOptionsText:s,currentCmd:e})}render(){let e=null;return""!==this.state.errorMsg&&(e=i.default.createElement("span",{className:"text-danger"},this.state.errorMsg)),i.default.createElement(l.default,{ariaHideApp:!1,isOpen:this.state.showModal},i.default.createElement("p",null,"Please set the options:"),i.default.createElement("textarea",{name:"menu-cmd-options",onChange:this.onChangeCmdOptions,rows:10,value:this.state.cmdOptionsText}),i.default.createElement("div",{className:"modal-footer row"},e,i.default.createElement("button",{className:"btn btn-danger",onClick:this.onClickModalCancel},"Cancel"),i.default.createElement("button",{className:"btn btn-success",onClick:this.onClickModalOK},"OK")))}needsModal(e){if(this.functions.hasOwnProperty(e)){if(this.functions[e].showModal)return c("TopMenuLogic needsModal true"),!0}return c("TopMenuLogic needsModal false"),!1}newBattle(e){c("TopMenuLogic newBattle() begin");const t=(new u.FactoryBattle).createBattle(null,e),n=t.getLevel();this.battles.push(t),this.props.addLevel(n),c("TopMenuLogic newBattle() end")}}t.default=h},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,r=n(684),a=(s=r)&&s.__esModule?s:{default:s};t.default=a.default,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bodyOpenClassName=t.portalClassName=void 0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),a=n(1),o=f(a),i=f(n(17)),l=f(n(0)),c=f(n(685)),u=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(333)),h=n(221),d=f(h),p=n(261);function f(e){return e&&e.__esModule?e:{default:e}}function m(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function g(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var y=t.portalClassName="ReactModalPortal",v=t.bodyOpenClassName="ReactModal__Body--open",b=void 0!==i.default.createPortal,_=function(){return b?i.default.createPortal:i.default.unstable_renderSubtreeIntoContainer};function E(e){return e()}var S=function(e){function t(){var e,n,r;m(this,t);for(var a=arguments.length,l=Array(a),u=0;u<a;u++)l[u]=arguments[u];return n=r=g(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(l))),r.removePortal=function(){!b&&i.default.unmountComponentAtNode(r.node);var e=E(r.props.parentSelector);e?e.removeChild(r.node):console.warn('React-Modal: "parentSelector" prop did not returned any DOM element. Make sure that the parent element is unmounted to avoid any memory leaks.')},r.portalRef=function(e){r.portal=e},r.renderPortal=function(e){var n=_()(r,o.default.createElement(c.default,s({defaultStyles:t.defaultStyles},e)),r.node);r.portalRef(n)},g(r,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),r(t,[{key:"componentDidMount",value:function(){h.canUseDOM&&(b||(this.node=document.createElement("div")),this.node.className=this.props.portalClassName,E(this.props.parentSelector).appendChild(this.node),!b&&this.renderPortal(this.props))}},{key:"getSnapshotBeforeUpdate",value:function(e){return{prevParent:E(e.parentSelector),nextParent:E(this.props.parentSelector)}}},{key:"componentDidUpdate",value:function(e,t,n){if(h.canUseDOM){var s=this.props,r=s.isOpen,a=s.portalClassName;e.portalClassName!==a&&(this.node.className=a);var o=n.prevParent,i=n.nextParent;i!==o&&(o.removeChild(this.node),i.appendChild(this.node)),(e.isOpen||r)&&!b&&this.renderPortal(this.props)}}},{key:"componentWillUnmount",value:function(){if(h.canUseDOM&&this.node&&this.portal){var e=this.portal.state,t=Date.now(),n=e.isOpen&&this.props.closeTimeoutMS&&(e.closesAt||t+this.props.closeTimeoutMS);n?(e.beforeClose||this.portal.closeWithTimeout(),setTimeout(this.removePortal,n-t)):this.removePortal()}}},{key:"render",value:function(){return h.canUseDOM&&b?(!this.node&&b&&(this.node=document.createElement("div")),_()(o.default.createElement(c.default,s({ref:this.portalRef,defaultStyles:t.defaultStyles},this.props)),this.node)):null}}],[{key:"setAppElement",value:function(e){u.setElement(e)}}]),t}(a.Component);S.propTypes={isOpen:l.default.bool.isRequired,style:l.default.shape({content:l.default.object,overlay:l.default.object}),portalClassName:l.default.string,bodyOpenClassName:l.default.string,htmlOpenClassName:l.default.string,className:l.default.oneOfType([l.default.string,l.default.shape({base:l.default.string.isRequired,afterOpen:l.default.string.isRequired,beforeClose:l.default.string.isRequired})]),overlayClassName:l.default.oneOfType([l.default.string,l.default.shape({base:l.default.string.isRequired,afterOpen:l.default.string.isRequired,beforeClose:l.default.string.isRequired})]),appElement:l.default.instanceOf(d.default),onAfterOpen:l.default.func,onRequestClose:l.default.func,closeTimeoutMS:l.default.number,ariaHideApp:l.default.bool,shouldFocusAfterRender:l.default.bool,shouldCloseOnOverlayClick:l.default.bool,shouldReturnFocusAfterClose:l.default.bool,parentSelector:l.default.func,aria:l.default.object,data:l.default.object,role:l.default.string,contentLabel:l.default.string,shouldCloseOnEsc:l.default.bool,overlayRef:l.default.func,contentRef:l.default.func},S.defaultProps={isOpen:!1,portalClassName:y,bodyOpenClassName:v,role:"dialog",ariaHideApp:!0,closeTimeoutMS:0,shouldFocusAfterRender:!0,shouldCloseOnEsc:!0,shouldCloseOnOverlayClick:!0,shouldReturnFocusAfterClose:!0,parentSelector:function(){return document.body}},S.defaultStyles={overlay:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(255, 255, 255, 0.75)"},content:{position:"absolute",top:"40px",left:"40px",right:"40px",bottom:"40px",border:"1px solid #ccc",background:"#fff",overflow:"auto",WebkitOverflowScrolling:"touch",borderRadius:"4px",outline:"none",padding:"20px"}},(0,p.polyfill)(S),t.default=S},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=n(1),i=g(o),l=g(n(0)),c=m(n(686)),u=g(n(687)),h=m(n(333)),d=m(n(690)),p=g(n(221)),f=g(n(334));function m(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function g(e){return e&&e.__esModule?e:{default:e}}n(691);var y={overlay:"ReactModal__Overlay",content:"ReactModal__Content"},v=0,b=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.setOverlayRef=function(e){n.overlay=e,n.props.overlayRef&&n.props.overlayRef(e)},n.setContentRef=function(e){n.content=e,n.props.contentRef&&n.props.contentRef(e)},n.afterClose=function(){var e=n.props,t=e.appElement,s=e.ariaHideApp,r=e.htmlOpenClassName,a=e.bodyOpenClassName;a&&d.remove(document.body,a),r&&d.remove(document.getElementsByTagName("html")[0],r),s&&v>0&&0===(v-=1)&&h.show(t),n.props.shouldFocusAfterRender&&(n.props.shouldReturnFocusAfterClose?(c.returnFocus(),c.teardownScopedFocus()):c.popWithoutFocus()),n.props.onAfterClose&&n.props.onAfterClose(),f.default.deregister(n)},n.open=function(){n.beforeOpen(),n.state.afterOpen&&n.state.beforeClose?(clearTimeout(n.closeTimer),n.setState({beforeClose:!1})):(n.props.shouldFocusAfterRender&&(c.setupScopedFocus(n.node),c.markForFocusLater()),n.setState({isOpen:!0},(function(){n.setState({afterOpen:!0}),n.props.isOpen&&n.props.onAfterOpen&&n.props.onAfterOpen({overlayEl:n.overlay,contentEl:n.content})})))},n.close=function(){n.props.closeTimeoutMS>0?n.closeWithTimeout():n.closeWithoutTimeout()},n.focusContent=function(){return n.content&&!n.contentHasFocus()&&n.content.focus()},n.closeWithTimeout=function(){var e=Date.now()+n.props.closeTimeoutMS;n.setState({beforeClose:!0,closesAt:e},(function(){n.closeTimer=setTimeout(n.closeWithoutTimeout,n.state.closesAt-Date.now())}))},n.closeWithoutTimeout=function(){n.setState({beforeClose:!1,isOpen:!1,afterOpen:!1,closesAt:null},n.afterClose)},n.handleKeyDown=function(e){9===e.keyCode&&(0,u.default)(n.content,e),n.props.shouldCloseOnEsc&&27===e.keyCode&&(e.stopPropagation(),n.requestClose(e))},n.handleOverlayOnClick=function(e){null===n.shouldClose&&(n.shouldClose=!0),n.shouldClose&&n.props.shouldCloseOnOverlayClick&&(n.ownerHandlesClose()?n.requestClose(e):n.focusContent()),n.shouldClose=null},n.handleContentOnMouseUp=function(){n.shouldClose=!1},n.handleOverlayOnMouseDown=function(e){n.props.shouldCloseOnOverlayClick||e.target!=n.overlay||e.preventDefault()},n.handleContentOnClick=function(){n.shouldClose=!1},n.handleContentOnMouseDown=function(){n.shouldClose=!1},n.requestClose=function(e){return n.ownerHandlesClose()&&n.props.onRequestClose(e)},n.ownerHandlesClose=function(){return n.props.onRequestClose},n.shouldBeClosed=function(){return!n.state.isOpen&&!n.state.beforeClose},n.contentHasFocus=function(){return document.activeElement===n.content||n.content.contains(document.activeElement)},n.buildClassName=function(e,t){var s="object"===(void 0===t?"undefined":r(t))?t:{base:y[e],afterOpen:y[e]+"--after-open",beforeClose:y[e]+"--before-close"},a=s.base;return n.state.afterOpen&&(a=a+" "+s.afterOpen),n.state.beforeClose&&(a=a+" "+s.beforeClose),"string"==typeof t&&t?a+" "+t:a},n.attributesFromObject=function(e,t){return Object.keys(t).reduce((function(n,s){return n[e+"-"+s]=t[s],n}),{})},n.state={afterOpen:!1,beforeClose:!1},n.shouldClose=null,n.moveFromContentToOverlay=null,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),a(t,[{key:"componentDidMount",value:function(){this.props.isOpen&&this.open()}},{key:"componentDidUpdate",value:function(e,t){this.props.isOpen&&!e.isOpen?this.open():!this.props.isOpen&&e.isOpen&&this.close(),this.props.shouldFocusAfterRender&&this.state.isOpen&&!t.isOpen&&this.focusContent()}},{key:"componentWillUnmount",value:function(){this.state.isOpen&&this.afterClose(),clearTimeout(this.closeTimer)}},{key:"beforeOpen",value:function(){var e=this.props,t=e.appElement,n=e.ariaHideApp,s=e.htmlOpenClassName,r=e.bodyOpenClassName;r&&d.add(document.body,r),s&&d.add(document.getElementsByTagName("html")[0],s),n&&(v+=1,h.hide(t)),f.default.register(this)}},{key:"render",value:function(){var e=this.props,t=e.id,n=e.className,r=e.overlayClassName,a=e.defaultStyles,o=n?{}:a.content,l=r?{}:a.overlay;return this.shouldBeClosed()?null:i.default.createElement("div",{ref:this.setOverlayRef,className:this.buildClassName("overlay",r),style:s({},l,this.props.style.overlay),onClick:this.handleOverlayOnClick,onMouseDown:this.handleOverlayOnMouseDown},i.default.createElement("div",s({id:t,ref:this.setContentRef,style:s({},o,this.props.style.content),className:this.buildClassName("content",n),tabIndex:"-1",onKeyDown:this.handleKeyDown,onMouseDown:this.handleContentOnMouseDown,onMouseUp:this.handleContentOnMouseUp,onClick:this.handleContentOnClick,role:this.props.role,"aria-label":this.props.contentLabel},this.attributesFromObject("aria",this.props.aria||{}),this.attributesFromObject("data",this.props.data||{}),{"data-testid":this.props.testId}),this.props.children))}}]),t}(o.Component);b.defaultProps={style:{overlay:{},content:{}},defaultStyles:{}},b.propTypes={isOpen:l.default.bool.isRequired,defaultStyles:l.default.shape({content:l.default.object,overlay:l.default.object}),style:l.default.shape({content:l.default.object,overlay:l.default.object}),className:l.default.oneOfType([l.default.string,l.default.object]),overlayClassName:l.default.oneOfType([l.default.string,l.default.object]),bodyOpenClassName:l.default.string,htmlOpenClassName:l.default.string,ariaHideApp:l.default.bool,appElement:l.default.instanceOf(p.default),onAfterOpen:l.default.func,onAfterClose:l.default.func,onRequestClose:l.default.func,closeTimeoutMS:l.default.number,shouldFocusAfterRender:l.default.bool,shouldCloseOnOverlayClick:l.default.bool,shouldReturnFocusAfterClose:l.default.bool,role:l.default.string,contentLabel:l.default.string,aria:l.default.object,data:l.default.object,children:l.default.node,shouldCloseOnEsc:l.default.bool,overlayRef:l.default.func,contentRef:l.default.func,id:l.default.string,testId:l.default.string},t.default=b,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleBlur=c,t.handleFocus=u,t.markForFocusLater=function(){o.push(document.activeElement)},t.returnFocus=function(){var e=null;try{return void(0!==o.length&&(e=o.pop()).focus())}catch(t){console.warn(["You tried to return focus to",e,"but it is not in the DOM anymore"].join(" "))}},t.popWithoutFocus=function(){o.length>0&&o.pop()},t.setupScopedFocus=function(e){i=e,window.addEventListener?(window.addEventListener("blur",c,!1),document.addEventListener("focus",u,!0)):(window.attachEvent("onBlur",c),document.attachEvent("onFocus",u))},t.teardownScopedFocus=function(){i=null,window.addEventListener?(window.removeEventListener("blur",c),document.removeEventListener("focus",u)):(window.detachEvent("onBlur",c),document.detachEvent("onFocus",u))};var s,r=n(332),a=(s=r)&&s.__esModule?s:{default:s};var o=[],i=null,l=!1;function c(){l=!0}function u(){if(l){if(l=!1,!i)return;setTimeout((function(){i.contains(document.activeElement)||((0,a.default)(i)[0]||i).focus()}),0)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var n=(0,a.default)(e);if(!n.length)return void t.preventDefault();var s=void 0,r=t.shiftKey,o=n[0],i=n[n.length-1];if(e===document.activeElement){if(!r)return;s=i}i!==document.activeElement||r||(s=o);o===document.activeElement&&r&&(s=i);if(s)return t.preventDefault(),void s.focus();var l=/(\bChrome\b|\bSafari\b)\//.exec(navigator.userAgent);if(null==l||"Chrome"==l[1]||null!=/\biPod\b|\biPad\b/g.exec(navigator.userAgent))return;var c=n.indexOf(document.activeElement);c>-1&&(c+=r?-1:1);if(void 0===(s=n[c]))return t.preventDefault(),void(s=r?i:o).focus();t.preventDefault(),s.focus()};var s,r=n(332),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){"use strict";var s=function(){};e.exports=s},function(e,t,n){var s;
/*!
  Copyright (c) 2015 Jed Watson.
  Based on code that is Copyright 2013-2015, Facebook, Inc.
  All rights reserved.
*/!function(){"use strict";var r=!("undefined"==typeof window||!window.document||!window.document.createElement),a={canUseDOM:r,canUseWorkers:"undefined"!=typeof Worker,canUseEventListeners:r&&!(!window.addEventListener&&!window.attachEvent),canUseViewport:r&&!!window.screen};void 0===(s=function(){return a}.call(t,n,t,e))||(e.exports=s)}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dumpClassLists=function(){0};var s={},r={};t.add=function(e,t){return n=e.classList,a="html"==e.nodeName.toLowerCase()?s:r,void t.split(" ").forEach((function(e){!function(e,t){e[t]||(e[t]=0),e[t]+=1}(a,e),n.add(e)}));var n,a},t.remove=function(e,t){return n=e.classList,a="html"==e.nodeName.toLowerCase()?s:r,void t.split(" ").forEach((function(e){!function(e,t){e[t]&&(e[t]-=1)}(a,e),0===a[e]&&n.remove(e)}));var n,a}},function(e,t,n){"use strict";var s,r=n(334),a=(s=r)&&s.__esModule?s:{default:s};var o=void 0,i=void 0,l=[];function c(){0!==l.length&&l[l.length-1].focusContent()}a.default.subscribe((function(e,t){o&&i||((o=document.createElement("div")).setAttribute("data-react-modal-body-trap",""),o.style.position="absolute",o.style.opacity="0",o.setAttribute("tabindex","0"),o.addEventListener("focus",c),(i=o.cloneNode()).addEventListener("focus",c)),(l=t).length>0?(document.body.firstChild!==o&&document.body.insertBefore(o,document.body.firstChild),document.body.lastChild!==i&&document.body.appendChild(i)):(o.parentElement&&o.parentElement.removeChild(o),i.parentElement&&i.parentElement.removeChild(i))}))},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CastleGenerator=void 0;const i=o(n(4)),l=n(92),c=a(n(16)),u=n(62),h=n(63),d=n(24),p=n(81),f=n(158),m=n(159),g=n(64),y=n(48),v=n(9),b=n(13),_=n(19),E=n(18),S=n(30),w=v.Random.getRNG();class C extends u.LevelGenerator{constructor(){super(),this.addDoors=!0,this.shouldRemoveMarkers=!0,this.nItemsAdded=0}static getOptions(){const e=u.LevelGenerator.getOptions();return e.centralCorridors=!1,e.roomCount=-1,e}static carvePathFromEdge(e,t){const n=e.getFreeEdgeCells(),s=e.getMap(),r=e.getCellWithElem(t),a=n[0],[o,i]=a.getXY(),[l,c]=r.getXY(),u=_.Path.getShortestPath(o,i,l,c,(e,t)=>s.hasXY(e,t)&&"wallcastle"!==s.getCell(e,t).getBaseElem().getType());return u.forEach(e=>{const t=s.getCell(e.x,e.y);t.isFree()||t.setBaseElem(E.ELEM.FLOOR)}),u}create(e,t,n){const s=this.createLevel(e,t,n);return this.removeMarkers(s,n),n.addItems&&(this.nItemsAdded=this.addItemsToCastle(s,n)),this.populateStoreRooms(s,n),n.addActors&&i.default.err("CastleGenerator","create","addActors == true not supported yet"),s}createLevel(e,t,n){const s=Object.assign({dungeonType:"castle",wallType:"wallcastle",floorType:"floorcastle"},n);s.preserveMarkers=!0;const r=new h.MapGenerator,a=function(e){if(e.cellsAround){const{cellsAround:t}=e,n=[],s=new m.LevelSurroundings;if(s.getNonBlockedDirs(t).forEach(e=>{n.push(f.Castle.startFuncs[e])}),0!==n.length)return w.arrayGetRand(n);i.default.warn("CastleGenerator","getGateDirFunction","No free cellsAround "+JSON.stringify(t))}return null}(n);a&&(s.startRoomFunc=a),n.centralCorridors&&(s.constraintFunc=f.Castle.constraintFuncCross);const o=r.createCastle(e,t,s);let l=new d.Level(o.map);return l.setMap(o.map,o),this.addMarkersFromTiles(l,o.tiles),n.cellsAround&&(l=this.createCastleSurroundings(l,n),l||i.default.err("CastleGenerator","createLevel","Got null level from surround. Something went wrong")),this.createDoorsAndLevers(l),l}addItemsToCastle(e,t){let n=0;const s=e.getExtras(),r=s.storeroom,{maxValue:a}=t;if(!a)return i.default.err("CastleGenerator","addItemsToCastle","maxValue was not given in conf "+JSON.stringify(t)),0;const o={item:e=>e.value<=2*a&&e.value>=a,maxValue:a,nItems:1},l=new g.FactoryItem;if(r.forEach(t=>{const s=l.generateItems(o);y.Placer.addPropsToRoom(e,t,s)&&(n+=s.length)}),i.default.isSuccess(O)){const t=w.arrayGetRand(r),s=w.getUniformInt(6,12),o=l.generateGold({nGold:5,nLevel:s,maxValue:a});y.Placer.addPropsToRoom(e,t,o)&&(n+=o.length)}const c=s.room;o.nItems=c.length;return l.generateItems(o).forEach(t=>{const s=w.arrayGetRand(c);y.Placer.addPropsToRoom(e,s,[t])&&(n+=1)}),n}addMarkersFromTiles(e,t){e.setExtras({corridor:[],entrance:[],room:[],storeroom:[],vault:[],term:[]}),Object.values(t).forEach(t=>{T.storeroom.test(t.name)?this.addToExtras(e,t,"storeroom"):T.vault.test(t.name)?this.addToExtras(e,t,"vault"):T.entrance.test(t.name)?this.addToExtras(e,t,"entrance"):T.corridor.test(t.name)?this.addToExtras(e,t,"corridor"):T.term.test(t.name)?this.addToExtras(e,t,"term"):T.filler.test(t.name)||this.addToExtras(e,t,"room")})}addToExtras(e,t,n){const s=b.Geometry.convertBbox(t);e.getMap().getFreeInBbox(s).forEach(t=>{const[s,r]=t.getXY(),a=new c.ElementMarker(M[n]);a.setTag(n),e.addElement(a,s,r)});const r=new l.Room(s.ulx,s.uly,s.lrx,s.lry);this.addDoorToRoom(e,r);e.getExtras()[n].push(r)}createDoorsAndLevers(e){const t=e.getMap(),n=t.getCells(),s={},r=[];n.forEach(n=>{if(n.hasElements()){const[a,o]=n.getXY();if(n.hasMarker("leverdoor")){const r=new c.ElementLeverDoor;t.getCell(a,o).removeProps(i.default.TYPE_ELEM),e.addElement(r,a,o),s[n.getKeyXY()]=r}else if(n.hasMarker("lever")){const n=new c.ElementLever;t.getCell(a,o).removeProps(i.default.TYPE_ELEM),e.addElement(n,a,o),r.push(n)}else if(n.hasMarker("door")){const n=new c.ElementDoor(!0);t.getCell(a,o).removeProps(i.default.TYPE_ELEM),e.addElement(n,a,o)}}}),r.forEach(e=>{const[n,r]=e.getXY();b.Geometry.getBoxAround(n,r,1).forEach(a=>{const o=a[0]+","+a[1];if(s[o]){let s=t.getCell(a[0],a[1]).getPropType("leverdoor");s?s=s[0]:i.default.err("CastleGenerator","createDoorsAndLevers",`No door found for lever@${n},${r}`),e.addTarget(s)}})})}populateStoreRooms(e,t){const n=new p.DungeonPopulate;t.actorFunc&&n.setActorFunc(t.actorFunc);const s=t.maxDanger,r=e.getExtras();if(r.storeroom){const a=r.storeroom;a.forEach(t=>{const r=t.getCenter();n.addPointGuardian(e,r,s)});const o=w.arrayGetRand(a);if(o){const r=o.getCenter();n.addMainLoot(e,r,t.maxValue)&&n.addPointGuardian(e,r,s+4)}}}createCastleSurroundings(e,t){const n=new m.LevelSurroundings,s=e.getExtras(),r=n.surround(e,t);return r?(r.setExtras(s),n.scaleExtras(r),r):null}addDoorToRoom(e,t){const n=S.BBox.fromBBox(t.getBbox()).getBorderXY("NSEW");let s=null;if(!t.hasDoor()){for(let r=0;r<n.length;r++){const[a,o]=n[r],i=e.getMap().getCell(a,o);i.hasDoor()&&t.addDoor(a,o),i.isFree()&&(s=i)}if(!t.hasDoor()&&s){const[e,n]=s.getXY();t.addDoor(e,n)}}}}t.CastleGenerator=C;const O=.1,T={corridor:/(corridor|corner)/,entrance:/entrance/,storeroom:/storeroom/,vault:/vault/,filler:/filler/i,term:/term/},M={corridor:"C",room:"R",entrance:"E",storeroom:"S",vault:"V",term:"T"}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Fov3D=void 0;const r=s(n(4)),a=n(13);t.Fov3D=class{constructor(e,t){this._passCb=t,this._map=e,this._maxZ=3,this._distSquare=0,this._maxZ=this.calcMapMaxZ(e),this._seen={},this._alreadySeen={}}canSeeCell(e,t,n){let s=!1;const r=this._init(t),[a,o,i]=n;return this._internalViewTo(e,r,a,o,i,(e,t,n)=>{a===e&&o===t&&i===n&&(s=!0)}),s}_init(e){const t=e+1;return this._distSquare=t*t,this._seen={},this._alreadySeen={},t}compute(e,t,n,s,a){const o=[e,t,n],i=this._init(s);a(e,t,n,!0);const l=r.default.toKey([e,t,n]);this._seen[l]=!0;const c=e-i,u=t-i,h=e+i,d=t+i;for(let e=0;e<=this._maxZ;++e){for(let t=u;t<=d;t++)this._internalViewTo(o,i,c,t,e,a),this._internalViewTo(o,i,h,t,e,a);for(let t=c;t<=h;t++)this._internalViewTo(o,i,t,u,e,a),this._internalViewTo(o,i,t,d,e,a)}}_compute(e,t,n,s,a){const o=[e,t,n],i=s+1;this._distSquare=i*i,this._seen={},this._alreadySeen={},a(e,t,n,!0);const l=r.default.toKey([e,t,n]);this._seen[l]=!0;for(let e=0;e<=this._maxZ;++e)for(let t=-i;t<=i;t++)this._internalViewTo(o,i,t,i,e,a),this._internalViewTo(o,i,t,-i,e,a),this._internalViewTo(o,i,i,t,e,a),this._internalViewTo(o,i,-i,t,e,a)}_internalViewTo(e,t,n,s,o,i){let l=!1;const c=[n,s,o],u=r.default.toKey(c);if(this._alreadySeen[u])return;this._alreadySeen[u]=!0;const h=a.Geometry.lineFuncUnique3D(e,c),d=h.length;for(let t=0;t<d;t++){const[n,s,o]=h[t];if(l)return;if(this._map.hasXY(n,s)){const t=[n,s,o];if(a.Geometry.distance3DSquared(e,t)<this._distSquare){const a=r.default.toKey(t);this._seen[a]||(i(n,s,o,!l),this._seen[a]=!0);let c=!1;o>=this._map._map[n][s].getBaseElem().getZ()&&(c=this._map._map[n][s].lightPasses()),c||(l=!0,e[0]===n&&e[1]===s&&e[2]===o&&(l=!1))}}}}calcMapMaxZ(e){let t=0;return r.default.forEach2D(e._map,(e,n,s)=>{s&&s.getZ()>t&&(t=s.getZ())}),t}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Houses5x5=void 0;const r=s(n(4)),a=n(80),o=n(9);t.Houses5x5={tiles:{},templates:{},Models:{}};const i=o.Random.getRNG();t.Houses5x5.tiles.start1x1=["\nname:start1x1_A\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##","\nname:start1x1_B\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n.ABC.\nD#:##\nE:::#\nF:::#\n##+##","\nname:start1x1_C\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n.ABC.\nD#:#.\nE::##\nF:::#\n##+##","\nname:start1x1_D\nA=.\nB=.\nC=.\nD=#\nE=#\nF=#\n\n.ABC.\nD###.\nE::##\nF:::#\n##+##"],t.Houses5x5.tiles.start1xN=["\ndir:N\nstartY:max\nstartX:first\nname:start1xN_A\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##","\ndir:N\nstartY:max\nstartX:first\nname:start1xN_B\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD#:##\nE:::#\nF:::#\n##+##","\ndir:N\nstartY:max\nstartX:first\nname:start1xN_C\nA=:\nB=:\nC=:\nD=#\nE=#\nF=.\n\n#ABC#\nD:::#\nE#:##\nF#:#.\n.#+#.","\ndir:N\nstartY:max\nstartX:first\nname:start1xD_C\nA=#\nB=:\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##"],t.Houses5x5.tiles.start2xN=["\ndir:NE\nstartX:first\nstartY:max\nname:start2xN_A\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE::::\nF:::#\n##+##","\ndir:NW\nstartX:max\nstartY:max\nname:start2xN_B\nA=#\nB=:\nC=#\nD=#\nE=:\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##"],t.Houses5x5.tiles.start2xN=t.Houses5x5.tiles.start2xN.concat(t.Houses5x5.tiles.start1xN),t.Houses5x5.tiles.start=["\ndir:NEW\nname:entrance2\nA=:\nB=:\nC=:\nD=#\nE=:\nF=#\n\n#ABC#\nD:::#\nE::::\nF:::#\n##+##","\ndir:NW\nname:entrance3\nA=#\nB=:\nC=#\nD=#\nE=:\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n##+##"],t.Houses5x5.tiles.corners=["\ndir:SE\nname:corner1\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD::::\nE::::\nF:::#\n#::##","\ndir:SEW\nname:corner2\nA=#\nB=#\nC=#\nD=:\nE=:\nF=#\n\n#ABC#\nD::::\nE::::\nF:::#\n##:##","\ndir:SE\nname:corner3\nA=.\nB=.\nC=.\nD=#\nE=#\nF=#\n\n.ABC#\nD####\nE::::\nF:::#\n##:##","\ndir:NSEW\nname:corner4\nA=:\nB=:\nC=:\nD=:\nE=:\nF=:\n\n#ABC#\nD::::\nE::::\nF::::\n#:::#"],t.Houses5x5.tiles.body=["\ndir:NS\nname:corridor\nA=:\nB=:\nC=:\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n#:::#","\ndir:NSEW\nname:body1\nA=:\nB=:\nC=:\nD=:\nE=:\nF=:\n\n#ABC#\nD::::\nE:#::\nF::::\n#:::#","\ndir:NSEW\nname:body_cross\nA=:\nB=:\nC=:\nD=:\nE=:\nF=:\n\n#ABC#\nD:#::\nE###:\nF:#::\n#:::#"],t.Houses5x5.tiles.terms=["\ndir:S\nname:term3x1\nA=.\nB=.\nC=.\nD=.\nE=.\nF=#\n\n.ABC.\nD....\nE....\nF####\n#:::#","\ndir:S\nname:term3x2\nA=.\nB=.\nC=.\nD=.\nE=#\nF=#\n\n.ABC.\nD....\nE####\nF:::#\n#:::#","\ndir:S\nname:term3x3\nA=.\nB=.\nC=.\nD=#\nE=#\nF=#\n\n.ABC.\nD####\nE:::#\nF:::#\n#:::#","\ndir:S\nname:term3x4\nA=#\nB=#\nC=#\nD=#\nE=#\nF=#\n\n#ABC#\nD:::#\nE:::#\nF:::#\n#:::#"],t.Houses5x5.tiles.blocker="\nname:BLOCKER\nA=.\nB=.\nC=.\nD=.\nE=.\nF=.\n\n.ABC.\nD....\nE....\nF....\n.....",t.Houses5x5.tiles.filler="\nname:FILLER\nA=.\nB=.\nC=.\nD=.\nE=.\nF=.\n\n.ABC.\nD....\nE....\nF....\n.....",t.Houses5x5.startRoomFunc=function(){if(1===this.tilesX&&1===this.tilesY)return{x:0,y:0,room:i.arrayGetRand(t.Houses5x5.templates.start1x1)};if(1===this.tilesX){const e=t.Houses5x5.templates.start1xN.filter(e=>!/(R90|R270)/i.test(e.getProp("name"))),n=i.arrayGetRand(e);let s=this.tilesY-1;return/R180/i.test(n.getProp("name"))&&(s=0),{x:0,y:s,room:n}}if(1===this.tilesY){const e=t.Houses5x5.templates.start1xN.filter(e=>/(R90|R270)/i.test(e.getProp("name"))),n=i.arrayGetRand(e);let s=0;return/R270/i.test(n.getProp("name"))&&(s=this.tilesX-1),{x:s,y:0,room:n}}if(2===this.tilesX||2===this.tilesY){const e=t.Houses5x5.templates.start2xN,n=i.arrayGetRand(e);let s=0,r=0;return"max"===n.getProp("startX")&&(s=this.tilesX-1),"max"===n.getProp("startY")&&(r=this.tilesY-1),{x:s,y:r,room:n}}const e=Math.floor(this.tilesX/2),n=Math.floor(this.tilesY/2),s=i.arrayGetRand(t.Houses5x5.tiles.start),r=a.Template.createTemplate(t.Houses5x5.tiles.blocker);for(let t=n;t<this.tilesY;t++)this.addRoom(r,e,t);return{x:e,y:n,room:a.Template.createTemplate(s)}},t.Houses5x5.Models.default=[].concat(t.Houses5x5.tiles.terms).concat(t.Houses5x5.tiles.body).concat(t.Houses5x5.tiles.corners),t.Houses5x5.tiles.all=t.Houses5x5.Models.default;function l(e){const t=e.getProp("startX"),n=e.getProp("startY");r.default.isNullOrUndef([t])||e.setProp("startY",t),"max"===n?e.setProp("startX","first"):"first"===n&&e.setProp("startX","max")}["all","start1x1","start1xN","start2xN"].forEach(e=>{t.Houses5x5.templates[e]=t.Houses5x5.tiles[e].map(e=>a.Template.createTemplate(e));const n=a.Template.transformList(t.Houses5x5.templates[e]);t.Houses5x5.templates[e]=t.Houses5x5.templates[e].concat(n)}),t.Houses5x5.templates.start2xN.forEach(e=>{const t=e.getProp("name");/_flip/.test(t)&&function(e){const t=e.getProp("startX");"max"===t?e.setProp("startX","first"):"first"===t&&e.setProp("startX","max")}(e),/R90/i.test(t)?l(e):/R180/i.test(t)?(l(e),l(e)):/R270/i.test(t)&&(l(e),l(e),l(e))})},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Nests=void 0;const s=n(80),r=s.Template.transformList;t.Nests={},t.Nests.tiles={},t.Nests.tiles.corner=["\nname:corner1\ndir:E\nX=#\nY=#\nW=#\nZ=#\n\n#X#W#X#\nY.....#\n#.###..\nZ.+?##.\n#.###..\nY.....#\n#######","\nname:corner2\ndir:SE\nX=#\nY=#\nW=#\nZ=#\n\n#X#W#X#\nY.....#\n#.###..\nZ.+?##.\n#.###..\nY.....#\n###+###","\nname:corner3\ndir:E\nX=#\nY=#\nW=#\nZ=#\n\n#X#W#X#\nY#.#?##\n#..#+##\nZ......\n#..#+##\nY#.#?##\n#######","\nname:corner4\ndir:SE\nX=#\nY=#\nW=#\nZ=#\n\n#X#W#X#\nY#?#?##\n##+#+##\nZ......\n#...###\nY#..+?#\n###.###"],t.Nests.tiles.center=["\nname:center1\nnoedge:1\ndir:S\nX=#\nY=#\nW=#\nZ=#\n\n#X#W#X#\nY.....#\n#.....#\nZ.....#\n#.....#\nY.....#\n###.###","\nname:center2\nnoedge:1\ndir:NS\nX=#\nY=#\nW=.\nZ=#\n\n#X#W#X#\nY.....#\n#.....#\nZ.....#\n#.....#\nY.....#\n###.###","\nname:center3\nnoedge:1\ndir:NSW\nX=#\nY=#\nW=.\nZ=.\n\n#X#W#X#\nY.....#\n#.....#\nZ.....#\n#.....#\nY.....#\n###.###","\nname:center4\nnoedge:1\ndir:NSEW\nX=#\nY=#\nW=.\nZ=.\n\n#X#W#X#\nY.....#\n#.....#\nZ......\n#.....#\nY.....#\n###.###","\nname:center5_open\nnoedge:1\ndir:NSEW\nX=.\nY=.\nW=.\nZ=.\n\n.X.W.X.\nY......\n.......\nZ......\n.......\nY......\n.......","\nname:center5_open_chest\nnoedge:1\ndir:NSEW\nX=.\nY=.\nW=.\nZ=.\n\n.X.W.X.\nY......\n..#+#..\nZ.+?+..\n..#+#..\nY......\n.......","\nname:center6_open\nnoedge:1\ndir:SEW\nX=#\nY=.\nW=#\nZ=.\n\n#X#W#X#\nY......\n.......\nZ......\n.......\nY......\n.......","\nname:center7_open\nnoedge:1\ndir:EW\nX=#\nY=.\nW=#\nZ=.\n\n#X#W#X#\nY......\n.......\nZ......\n.......\nY......\n#######","\nname:center8_open\nnoedge:1\ndir:SW\nX=#\nY=.\nW=#\nZ=.\n\n#X#W#X#\nY.....#\n......#\nZ.....#\n......#\nY.....#\n......#","\nname:center9_open\nnoedge:1\ndir:W\nX=#\nY=.\nW=#\nZ=.\n\n#X#W#X#\nY.....#\n......#\nZ.....#\n......#\nY.....#\n#######"],t.Nests.tiles.corridor=["\nname:corridor1\ndir:EW\nX=#\nY=#\nW=#\nZ=.\n\n#X#W#X#\nY######\n#.....#\nZ......\n#.....#\nY######\n#######","\nname:corridor2\ndir:SEW\nX=#\nY=#\nW=#\nZ=.\n\n#X#W#X#\nY######\n#.....#\nZ......\n#.....#\nY##.###\n###.###","\nname:corridor3\ndir:SE\nX=#\nY=#\nW=#\nZ=#\n\n#X#W#X#\nY######\n#.....#\nZ......\n#.....#\nY##.###\n###.###","\nname:corridor_term\ndir:N\nX=#\nY=#\nW=.\nZ=#\n\n#X.W.X#\nY.....#\n#.....#\nZ######\n#######\nY######\n#######"],t.Nests.tiles.filler="\nname:FILLER\nX=#\nY=#\nW=#\nZ=#\n\n#X#W#X#\nY######\n#######\nZ######\n#######\nY######\n#######";t.Nests.matchFilter=function(e,t,n,s,r){return e.isCorner(t,n)?s.filter(e=>/corner/.test(e.getProp("name"))):e.isEdge(t,n)?s.filter(e=>/corridor/.test(e.getProp("name"))):s.filter(e=>/center\d+_open/.test(e.getProp("name")))},t.Nests.startRoomFuncNx3=function(){const e=this.findTemplate({name:"center5_open_chest"});return{x:Math.floor(this.tilesX/2),y:Math.floor(this.tilesY/2),room:e}};t.Nests.tiles.all=[].concat(t.Nests.tiles.corner).concat(t.Nests.tiles.corridor).concat(t.Nests.tiles.center),t.Nests.templates=t.Nests.tiles.all.map(e=>s.Template.createTemplate(e));const a=r(t.Nests.templates,{all:"*",flipVer:[],rotateR90:[],rotateR180:[],rotateR270:[]});t.Nests.templates=t.Nests.templates.concat(a);s.verifyTiles("tiles.nests.ts","Verifying tiles",t.Nests.templates,[1,1,1,1,1,1]);t.Nests.names={},["center","corridor","corner"].forEach(e=>{t.Nests.names[e]=t.Nests.templates.filter(t=>new RegExp(e).test(t.getProp("name"))).map(e=>e.getProp("name"))}),t.Nests.weights={},t.Nests.names.corridor.forEach(e=>{t.Nests.weights[e]=1e3,"corridor_term"===e&&(t.Nests.weights[e]=1)})},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),r(n(339),t),r(n(697),t),r(n(340),t),r(n(698),t),r(n(341),t)},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MapForest=void 0;const r=s(n(40)),a=s(n(22)),o=r.default;t.MapForest=class extends o{constructor(e,t,n={}){super(e,t),this._options={nForests:5,forestSize:100,factor:6,rng:a.default};for(const e in n)this._options.hasOwnProperty(e)&&(this._options[e]=n[e])}create(e){const t=this._options.rng;this.map=this._fillMap(0);for(let e=0;e<this._options.nForests;e++){const e=t.getUniformInt(0,this._width-1),n=t.getUniformInt(0,this._height-1);this.drawForest(e,n,this._options.forestSize)}if(e)for(let t=0;t<this._height;t++)for(let n=0;n<this._width;n++)e(n,t,this.map[n][t])}inBounds(e,t){return e>=0&&e<this._width&&t>=0&&t<this._height}drawForest(e,t,n){let s=e,r=t;const a=this._options.rng;for(let e=1;e<=n;e++){const e=a.getUniformInt(0,this._options.factor),t=a.getUniformInt(0,this._options.factor),n=a.getUniformInt(0,this._options.factor),o=a.getUniformInt(0,this._options.factor);1===e&&(s-=1,this.inBounds(s,r)&&(this.map[s][r]=1)),1===n&&(s+=1,this.inBounds(s,r)&&(this.map[s][r]=1)),1===t&&(r+=1,this.inBounds(s,r)&&(this.map[s][r]=1)),1===o&&(r-=1,this.inBounds(s,r)&&(this.map[s][r]=1))}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MapMountain=void 0;const r=s(n(219)),a=s(n(40)),o=s(n(22)),i=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],l=a.default;class c extends l{constructor(e,t,n={}){if(super(e,t),this._options={gradients:i,noiseMult:1,noiseDivider:20,rng:o.default},n)for(const e in this._options)this._options.hasOwnProperty(e)&&n.hasOwnProperty(e)&&(this._options[e]=n[e]);this.noise=new r.default}create(e){const t=this._fillMap(0);for(let e=0;e<this._width;e++)for(let n=0;n<this._height;n++){const s=this.noise.get(e/this._options.noiseDivider,n/this._options.noiseDivider)*this._options.noiseMult;t[e][n]=s}for(let n=0;n<this._width;n++)for(let s=0;s<this._height;s++)e(n,s,t[n][s])}}t.MapMountain=c,c.gradients=i},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ActorNames=void 0;const r=s(n(4)),a=n(9).Random.getRNG(),o={1:5,2:30,3:30,4:20,5:5},i=r.default.LETTERS,l=/[aeiouy]/,c=i.filter(e=>l.test(e)),u=i.filter(e=>!l.test(e)),h=[],d=[],p=[],f=[],m={vowel:[],consonant:[]},g={vowel:[],consonant:[]};i.forEach(e=>{if(l.test(e)){const t=e;c.forEach(e=>{h.push(t+e),m.vowel.push(t+e),g.vowel.push(t+e),u.forEach(n=>{d.push(t+e+n),m.vowel.push(t+e+n),g.consonant.push(t+e+n)})}),u.forEach(e=>{h.push(t+e),m.vowel.push(t+e),g.consonant.push(t+e),c.forEach(n=>{d.push(t+e+n),m.vowel.push(t+e+n),g.vowel.push(t+e+n)})})}else{const t=e;c.forEach(e=>{h.push(t+e),g.vowel.push(t+e),m.consonant.push(t+e),i.forEach(n=>{d.push(t+e+n),m.consonant.push(t+e+n)}),u.forEach(n=>{c.forEach(s=>{p.push(t+e+n+s),m.consonant.push(t+e+n+s),g.vowel.push(t+e+n+s),u.forEach(r=>{const a=t+e+n+s+r;f.push(a),m.consonant.push(a),g.consonant.push(a)})}),u.forEach(s=>{const r=t+e+n+s;p.push(r),m.consonant.push(r),g.consonant.push(r),c.forEach(e=>{const t=r+e;f.push(t),m.consonant.push(t),g.vowel.push(t)})})})})}}),t.ActorNames={};const y=/[aeiouy][aeiouy][aeiouy]/,v=/[xqjv]$/;t.ActorNames.getName=function(e=o){const t=parseInt(a.getWeighted(o),10);let n=!1,s="";for(;!n;){if(s="",1===t)s=a.arrayGetRand(f);else for(let e=0;e<t;e++){let e="";e=r.default.isSuccess(.4)?a.arrayGetRand(h):r.default.isSuccess(.4)?a.arrayGetRand(d):a.arrayGetRand(p),s+=e}y.test(s)||v.test(s)||(n=!0)}return s.capitalize()};const b=u.concat(["th","gr","dr","wh"]),_=["th","r","l","n","ch","zh"];function E(e){return!y.test(e)&&!v.test(e)}t.ActorNames.getModName=function(){let e="";r.default.isSuccess(.5)&&(e=a.arrayGetRand(b),e+=a.arrayGetRand(m.vowel)),r.default.isSuccess(.25)&&(e=a.arrayGetRand(c)+e,r.default.isSuccess(.25)&&(e=a.arrayGetRand(c)+e));let n="";r.default.isSuccess(.5)&&(n=a.arrayGetRand(_),r.default.isSuccess(.5)&&(n+=a.arrayGetRand(g.vowel)));let s=e+n;s=s.length<2?t.ActorNames.getName({2:50,3:35}).toLowerCase():s.length<4?t.ActorNames.getName({2:50}).toLowerCase():r.default.isSuccess(.5)?a.arrayGetRand(p):a.arrayGetRand(f);const o=e+s+n;return E(o)?o.capitalize():t.ActorNames.getModName()},t.ActorNames.isNameOk=E},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createCaveLevel=t.CaveBrGenerator=void 0;const s=n(46),r=n(24),a=n(9),o=n(13),i=n(18),l=n(15)("bitn:cave-br"),c=a.Random.getRNG(),[u,h]=[3,16],[d,p]=[4,8],[f,m]=[40,80],[g,y]=[40,80],[v,b]=[2,4],_=[];class E{create(e,t,n){return S(e,t,n)}}function S(e,t,n){const a=new s.CellMap(e,t,i.ELEM.WALL);n.mapWidth=e,n.mapHeight=t,n.connectedRatio=n.connectedRatio||1,function(e,t){++w;let{mapWidth:n,mapHeight:s}=t;n-=1,s-=1;let r=Math.floor((n+s)/2/10);t.numBranches&&(r=t.numBranches);x("Creating",r,"branches for level",`${n+1}x${s+1}`);const a=c.getUniformInt(g,y),l=c.getUniformInt(f,m),u=c.getUniformInt(v,b),h=n-1,d=s-1,p=Math.floor(r*t.connectedRatio);let E=[];for(let t=0;t<p;++t){if(x("Creating connected branch",t),++w,0===c.getUniformInt(0,1)){x("Creating vertical connected branch",t);const n=T(e,2,h,2,d,u,a,l,E);E=E.concat(n)}else{x("\tCreating horizontal connected branch",t);const n=M(e,2,h,2,d,u,a,l,E);E=E.concat(n)}--w}const S=[],C=r-p;for(let t=0;t<C;++t)if(0===c.getUniformInt(0,1)){const t=T(e,2,h,2,d,u,a,l,_);S.push(t)}else{const t=M(e,2,h,2,d,u,a,l,_);S.push(t)}0===E.length&&(E=c.arrayGetRand(S));t.connectAll&&S.forEach(n=>{const[s,r]=c.arrayGetRand(n),[a,l]=c.arrayGetRand(E),u=o.Geometry.getCaveConnLine(s,r,a,l);!function(e,t,n){t.forEach(t=>{const[s,r]=t;e.hasXY(s,r)&&e.setBaseElemXY(s,r,n)})}(e,u,i.ELEM.FLOOR),t.appendConnected&&(E=E.concat(n))});(function(e,t,n){for(let s=0;s<=t;++s)e.setBaseElemXY(s,0,i.ELEM.WALL),e.setBaseElemXY(s,n,i.ELEM.WALL);for(let s=0;s<=n;++s)e.setBaseElemXY(0,s,i.ELEM.WALL),e.setBaseElemXY(t,s,i.ELEM.WALL)})(e,n,s),--w}(a,n);return new r.Level(a)}t.CaveBrGenerator=E,E.getOptions=()=>({appendConnected:!1,connectAll:!0,connectedRatio:.5,numBranches:30,mapWidth:150,mapHeight:150}),t.createCaveLevel=S;let w=0;function C(e,t,n,s,r,a){++w;let o=c.getUniformInt(d,p),[i,l,u]=[0,0,0];if("h"===a){if(e.length>0){const[h,d]=c.arrayGetRand(e);x("Branch will start from",h,d,"type",a),l=d,i=D(h,s),u=s-i-3,x("xs, ys, blen",i,l,u),[o,i,l]=O(t,s,n,r,i,l,o,a),x("ADJ xs, ys, blen",i,l,u)}else i=I(t,s,.9),l=I(n,r,.9),u=s-i-3,x("no caveCoord xs, ys, blen",i,l,u);return u=Math.floor(u/4),[i,l,u,o]}if("v"===a){if(e.length>0){const[h,d]=c.arrayGetRand(e);x("Branch will start from",h,d,"type",a),i=h,l=D(d,r),u=Math.floor(r-l-3),x("xs, ys, blen",i,l,u),[o,i,l]=O(t,s,n,r,i,l,o,a),x("ADJ xs, ys, blen",i,l,u)}else i=I(t,s,.9),l=I(n,r,.9),u=r-l-3,x("no caveCoord xs, ys, blen",i,l,u);return u=Math.floor(u/4),[i,l,u,o]}--w}function O(e,t,n,s,r,a,o,i){return++w,o<u?o=u:o>h&&(o=h),"v"===i&&(r<=e&&(r=e+1),r+o>=t&&(o=t-(r=t-o-1))),"h"===i&&(a<n&&(a=n+1),a+o>=s&&(o=s-(a=s-o-1))),--w,[o,r,a]}function T(e,t,n,s,r,a,o,i,l){++w;const u=[],[h,d,p,f]=C(l,t,s,n,r,"v"),m=h+f;A(e,h,m,d);for(let e=h;e<=m;e++)u.push([e,d]);let g=h,y=d,v=f;x("createVerCaveBranch magn:",a,"brLen",p);const b=P(-a,a).filter(e=>0!==e),_=P(-a,a).filter(e=>0!==e);for(let a=0;a<p;++a){if(y+=1,c.getUniformInt(1,100)<=i){v+=c.arrayGetRand(b)}if(c.getUniformInt(1,100)<=o){g+=c.arrayGetRand(_)}[v,g,y]=O(t,n,s,r,g,y,v,"v");const a=g+v;A(e,g,a,y);for(let e=g;e<=a;e++)u.push([e,y])}if(v>3)for(x("Ver br starting to round, width:",v);s<y&&y<r-1;){y+=1,g+=1,v=k(v,a);const t=g+v;A(e,g,t,y);for(let e=g;e<=t;++e)u.push([e,y]);if(v<3)break}return--w,u}function M(e,t,n,s,r,a,o,i,l){++w;const u=[],[h,d,p,f]=C(l,t,s,n,r,"h"),m=d+f;N(e,d,m,h);for(let e=d;e<=m;++e)u.push([h,e]);let g=h,y=d,v=f;const b=P(-a,a).filter(e=>0!==e),_=P(-a,a).filter(e=>0!==e);x("Hor branch Magnitude is ",a,"brLen",p);for(let a=0;a<p;++a){if(g+=1,c.getUniformInt(1,100)<=i){v+=c.arrayGetRand(b)}if(c.getUniformInt(1,100)<=o){y+=c.arrayGetRand(_)}[v,g,y]=O(t,n,s,r,g,y,v,"h");const a=y+v;N(e,y,a,g);for(let e=y;e<=a;++e)u.push([g,e])}if(v>3)for(x("Hor br starting to round, width:",v);t<g&&g<n-1;){y+=1,g+=1,v=k(v,a);const t=y+v;N(e,y,t,g);for(let e=y;e<=t;++e)u.push([g,e]);if(v<3)break}return--w,u}function A(e,t,n,s){++w;const r=Math.min(t,n),a=Math.max(t,n);x("createHoriSlice x:",r,"->",a,"y:",s);for(let t=r;t<=a;++t)e.hasXY(t,s)&&e.setBaseElemXY(t,s,i.ELEM.FLOOR);--w}function N(e,t,n,s){++w;const r=Math.min(t,n),a=Math.max(t,n);x("createVertSlice x:",s,"y:",r,"->",a);for(let t=r;t<=a;++t)e.hasXY(s,t)&&e.setBaseElemXY(s,t,i.ELEM.FLOOR);--w}function x(...e){if(l.enabled){const t=" ".repeat(w);console.log(t+"[DBG]",...e)}}function P(e,t,n){n||(n=1);const s=[];if(t<e||n<1)return[];if(void 0===t)for(let t=0;t<e;t+=n)s.push(t);else for(let r=e;r<t;r+=n)s.push(r);return s}function I(e,t,n){return e+c.getUniformInt(e,Math.floor(t*n))}function D(e,t){const n=Math.floor(.5*t);return e>Math.floor(.5*t)?e-2*(e-n):e}function k(e,t){return e-t<=1?1:e-t}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CityGenerator=void 0;const r=s(n(4)),a=n(62),o=n(63),i=n(81),l=n(159),c=n(9),u=n(24),h=n(18),d=n(16),p=c.Random.getRNG();class f extends a.LevelGenerator{constructor(){super(),this.addDoors=!0,this.shouldRemoveMarkers=!0,this.populate=!0}static getOptions(){const e=a.LevelGenerator.getOptions();return e.hasWall=!1,e.nShops=1,e.shopFunc=[()=>!0],e.shopType=["potion"],e}create(e,t,n){let s=this.createLevel(e,t,n);return n.cellsAround&&(s=this.createCitySurroundings(s,n)),this.populate&&this.populateCityLevel(s,n),this.removeMarkers(s,n),s}createLevel(e,t,n){const s=new o.MapGenerator;let r=null;r=n.hasWall?s.createTownWithWall(e,t,n):s.createTownBSP(e,t,n);const a=new u.Level(r.map);return a.addExtras("houses",r.houses),this.createHouseElements(a),this.fillUnusedAreas(a,r.unused),a}createHouseElements(e){const t=e.getExtras().houses;for(let n=0;n<t.length;n++){const s=t[n].door,r=new d.ElementDoor(!0);e.addElement(r,s[0],s[1])}}fillUnusedAreas(e,t){const n=e.getMap(),s=[h.ELEM.GRASS,h.ELEM.TREE,h.ELEM.WATER];t.forEach(e=>{const t=p.arrayGetRand(s);let{w:r,h:a}=e;const{x:o,y:i}=e;r-=2,a-=2;for(let e=o;e<=o+r;e++)for(let s=i;s<=i+a;s++)n.setBaseElemXY(e,s,t)})}populateCityLevel(e,t){let n=e.getExtras().houses;n||r.default.err("CityGenerator","populateCityLevel","Cannot be used without Level.extras.houses");const s=new i.DungeonPopulate(t),a=s.createShops(e,t);n=n.filter(e=>a.indexOf(e)<0);const o=s.createTrainers(e,t);n=n.filter(e=>o.indexOf(e)<0),e.addExtras("houses",n),this.createTownsfolk(e,t)}createTownsfolk(e,t){const n=new i.DungeonPopulate(t);e.getExtras().houses.forEach(s=>{n.populateHouse(e,s,t)})}createCitySurroundings(e,t){const n=(new l.LevelSurroundings).surround(e,t);return n.setExtras(e.getExtras()),n}}t.CityGenerator=f,f.options={village:{actorsPerLevel:30,maxDanger:3,itemsPerLevels:6},capital:{},stronghold:{},fort:{}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CryptGenerator=void 0;const r=s(n(4)),a=n(62),o=n(344),i=n(343),l=n(63),c=n(24),u=n(81);class h extends a.LevelGenerator{constructor(){super(),this.shouldRemoveMarkers=!0}static getOptions(){let e=a.LevelGenerator.getOptions();return e=Object.assign(e,{tilesX:12,tilesY:7,genParams:[2,2,2,2],roomCount:40,wallType:"wallcrypt",floorType:"floorcrypt"}),e}create(e,t,n){return this.createLevel(e,t,n)}createLevel(e,t,n){const s=new l.MapGenerator;s.setGen("crypt",e,t);const h=s.createCryptNew(e,t,n),d=new c.Level(h.map);a.LevelGenerator.tilesToRooms(d,h),o.DungeonGenerator.addStairsToTwoRooms(d),o.DungeonGenerator.addCriticalPath(d),this.factZone?this.factZone.addExtraDungeonFeatures(d,n):r.default.err("CryptGenerator","createLevel","this.factZone must be assigned first");new u.DungeonPopulate({theme:"",actorFunc:e=>"undead"===e.type,maxDanger:n.maxDanger,maxValue:n.maxValue,itemFunc:e=>"food"!==e.type}).populateLevel(d),n.nestProbability&&r.default.isSuccess(n.nestProbability)&&i.CaveGenerator.embedNest(d,n);const p={};return n.shouldRemoveMarkers&&(p.markersPreserved=!1),this.removeMarkers(d,p),d}}t.CryptGenerator=h},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MountainGenerator=void 0;const r=s(n(4)),a=n(63),o=n(24),i=n(13),l=n(19),c=n(81),u=n(9),h=n(18),d=n(62),p=n(16),f=u.Random.getRNG();class m{static getSummitOptions(){const e=d.LevelGenerator.getOptions();return Object.assign({},m.options.summit,e)}static getFaceOptions(){const e=d.LevelGenerator.getOptions(),t=a.MapGenerator.getOptions("mountain");return Object.assign({},t,m.options.face,e)}createMountain(e,t,n){const s=this.createFace(e,t,n),r=this.createSummit(e,t,n);return n.shortcutSummit2Face&&m.connectFaceAndSummit(s,r),[s,r]}createFace(e,t,n){const s=new a.MapGenerator;s.setGen("mountain",e,t),n.nRoadTurns=0;const r=s.createMountain(e,t,n),i=new o.Level(r.map);return this.createCrux(i,n),i}createSummit(e,t,n){const s=new a.MapGenerator;s.setGen("mountain",e,t);const r=s.createSummit(e,t,n),i=new o.Level(r.map);return i.setExtras({}),i}createCrux(e,t){const n=e.getMap(),s=n.cols,r=Math.round(n.rows/6),o={wallElem:h.ELEM.HIGH_ROCK,meanWy:Math.round(r/2.5)},l=new a.MapGenerator;l.setGen("wall",s,r);const u=l.createWall(s,r,o).map,d=f.getUniformInt(0,s-1),p=f.getUniformInt(0,s-1),m=this.carvePath(u,d,0,p,r-1),g=Math.round(n.rows/5);i.Geometry.mergeMaps(n,u,0,g,(e,t)=>{const n=t.getBaseElem();return!/(floor)/.test(n.getType())});const y={startX:0,startY:0,maxY:g,yPerTurn:Math.round(g/4),endX:d};let v=l.createMountainPath(n,y);y.startY=g+r,y.maxY=n.rows-1,y.startX=p,y.yPerTurn=0,v=v.concat(l.createMountainPath(n,y)),e.addExtras("paths",v),m.forEach(e=>{e[1]+=g});const b=new c.DungeonPopulate(t);for(let n=0;n<3;n++){const n=f.arrayGetRand(m);b.addPointGuardian(e,n,t.maxDanger)}}carvePath(e,t,n,s,a){const o=[];return l.Path.getShortestPath(t,n,s,a).forEach(t=>{i.Geometry.getCrossAround(t.x,t.y,2,!0).forEach(t=>{const[n,s]=t;e.hasXY(n,s)&&(o.push(t),r.default.isSuccess(.25)?e.setBaseElemXY(n,s,h.ELEM.STEEP_CLIFF):e.setBaseElemXY(n,s,h.ELEM.STONE))}),e.setBaseElemXY(t.x,t.y,h.ELEM.CLIFF)}),o}static connectFaceAndSummit(e,t){const n=new p.ElementStairs("pathdown",t,e);n.setMsg({onEnter:"If you descend it, you will not be able to come back the same way"});const{cols:s,rows:a}=e.getMap();let o=0,i=a-1;for(;!e.getMap().getCell(o,i).isFree();)o+=1,o>=s&&(i-=1,o=0);n.setTargetOnewayXY(o,i);let l=t.getFreeRandCell();for(;null==l?void 0:l.hasConnection();)l=t.getFreeRandCell();l?t.addElement(n,l.getX(),l.getY()):r.default.err("MountainGenerator","connectSummitAndFace","Could not find free cell for one-way connection")}}t.MountainGenerator=m,m.options={},m.options.face={},m.options.summit={ratio:.3}},function(e,t,n){n(705),e.exports=n(49).Object.assign},function(e,t,n){var s=n(65);s(s.S+s.F,"Object",{assign:n(707)})},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,n){"use strict";var s=n(122),r=n(235),a=n(123),o=n(236),i=n(348),l=Object.assign;e.exports=!l||n(120)((function(){var e={},t={},n=Symbol(),s="abcdefghijklmnopqrst";return e[n]=7,s.split("").forEach((function(e){t[e]=e})),7!=l({},e)[n]||Object.keys(l({},t)).join("")!=s}))?function(e,t){for(var n=o(e),l=arguments.length,c=1,u=r.f,h=a.f;l>c;)for(var d,p=i(arguments[c++]),f=u?s(p).concat(u(p)):s(p),m=f.length,g=0;m>g;)h.call(p,d=f[g++])&&(n[d]=p[d]);return n}:l},function(e,t,n){var s=n(85),r=n(349),a=n(709);e.exports=function(e){return function(t,n,o){var i,l=s(t),c=r(l.length),u=a(o,c);if(e&&n!=n){for(;c>u;)if((i=l[u++])!=i)return!0}else for(;c>u;u++)if((e||u in l)&&l[u]===n)return e||u||0;return!e&&-1}}},function(e,t,n){var s=n(231),r=Math.max,a=Math.min;e.exports=function(e,t){return(e=s(e))<0?r(e+t,0):a(e,t)}},function(e,t,n){e.exports={default:n(711),__esModule:!0}},function(e,t,n){n(350),n(717),e.exports=n(240).f("iterator")},function(e,t,n){var s=n(231),r=n(230);e.exports=function(e){return function(t,n){var a,o,i=String(r(t)),l=s(n),c=i.length;return l<0||l>=c?e?"":void 0:(a=i.charCodeAt(l))<55296||a>56319||l+1===c||(o=i.charCodeAt(l+1))<56320||o>57343?e?i.charAt(l):a:e?i.slice(l,l+2):o-56320+(a-55296<<10)+65536}}},function(e,t,n){"use strict";var s=n(238),r=n(121),a=n(239),o={};n(98)(o,n(50)("iterator"),(function(){return this})),e.exports=function(e,t,n){e.prototype=s(o,{next:r(1,n)}),a(e,t+" Iterator")}},function(e,t,n){var s=n(83),r=n(99),a=n(122);e.exports=n(101)?Object.defineProperties:function(e,t){r(e);for(var n,o=a(t),i=o.length,l=0;i>l;)s.f(e,n=o[l++],t[n]);return e}},function(e,t,n){var s=n(66).document;e.exports=s&&s.documentElement},function(e,t,n){var s=n(84),r=n(236),a=n(232)("IE_PROTO"),o=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=r(e),s(e,a)?e[a]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?o:null}},function(e,t,n){n(718);for(var s=n(66),r=n(98),a=n(124),o=n(50)("toStringTag"),i="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),l=0;l<i.length;l++){var c=i[l],u=s[c],h=u&&u.prototype;h&&!h[o]&&r(h,o,c),a[c]=a.Array}},function(e,t,n){"use strict";var s=n(719),r=n(720),a=n(124),o=n(85);e.exports=n(351)(Array,"Array",(function(e,t){this._t=o(e),this._i=0,this._k=t}),(function(){var e=this._t,t=this._k,n=this._i++;return!e||n>=e.length?(this._t=void 0,r(1)):r(0,"keys"==t?n:"values"==t?e[n]:[n,e[n]])}),"values"),a.Arguments=a.Array,s("keys"),s("values"),s("entries")},function(e,t){e.exports=function(){}},function(e,t){e.exports=function(e,t){return{value:t,done:!!e}}},function(e,t,n){e.exports={default:n(722),__esModule:!0}},function(e,t,n){n(723),n(728),n(729),n(730),e.exports=n(49).Symbol},function(e,t,n){"use strict";var s=n(66),r=n(84),a=n(101),o=n(65),i=n(352),l=n(724).KEY,c=n(120),u=n(233),h=n(239),d=n(161),p=n(50),f=n(240),m=n(241),g=n(725),y=n(726),v=n(99),b=n(100),_=n(85),E=n(228),S=n(121),w=n(238),C=n(727),O=n(354),T=n(83),M=n(122),A=O.f,N=T.f,x=C.f,P=s.Symbol,I=s.JSON,D=I&&I.stringify,k=p("_hidden"),L=p("toPrimitive"),R={}.propertyIsEnumerable,B=u("symbol-registry"),F=u("symbols"),G=u("op-symbols"),j=Object.prototype,W="function"==typeof P,Y=s.QObject,X=!Y||!Y.prototype||!Y.prototype.findChild,U=a&&c((function(){return 7!=w(N({},"a",{get:function(){return N(this,"a",{value:7}).a}})).a}))?function(e,t,n){var s=A(j,t);s&&delete j[t],N(e,t,n),s&&e!==j&&N(j,t,s)}:N,$=function(e){var t=F[e]=w(P.prototype);return t._k=e,t},H=W&&"symbol"==typeof P.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof P},V=function(e,t,n){return e===j&&V(G,t,n),v(e),t=E(t,!0),v(n),r(F,t)?(n.enumerable?(r(e,k)&&e[k][t]&&(e[k][t]=!1),n=w(n,{enumerable:S(0,!1)})):(r(e,k)||N(e,k,S(1,{})),e[k][t]=!0),U(e,t,n)):N(e,t,n)},K=function(e,t){v(e);for(var n,s=g(t=_(t)),r=0,a=s.length;a>r;)V(e,n=s[r++],t[n]);return e},q=function(e){var t=R.call(this,e=E(e,!0));return!(this===j&&r(F,e)&&!r(G,e))&&(!(t||!r(this,e)||!r(F,e)||r(this,k)&&this[k][e])||t)},z=function(e,t){if(e=_(e),t=E(t,!0),e!==j||!r(F,t)||r(G,t)){var n=A(e,t);return!n||!r(F,t)||r(e,k)&&e[k][t]||(n.enumerable=!0),n}},J=function(e){for(var t,n=x(_(e)),s=[],a=0;n.length>a;)r(F,t=n[a++])||t==k||t==l||s.push(t);return s},Q=function(e){for(var t,n=e===j,s=x(n?G:_(e)),a=[],o=0;s.length>o;)!r(F,t=s[o++])||n&&!r(j,t)||a.push(F[t]);return a};W||(i((P=function(){if(this instanceof P)throw TypeError("Symbol is not a constructor!");var e=d(arguments.length>0?arguments[0]:void 0),t=function(n){this===j&&t.call(G,n),r(this,k)&&r(this[k],e)&&(this[k][e]=!1),U(this,e,S(1,n))};return a&&X&&U(j,e,{configurable:!0,set:t}),$(e)}).prototype,"toString",(function(){return this._k})),O.f=z,T.f=V,n(353).f=C.f=J,n(123).f=q,n(235).f=Q,a&&!n(237)&&i(j,"propertyIsEnumerable",q,!0),f.f=function(e){return $(p(e))}),o(o.G+o.W+o.F*!W,{Symbol:P});for(var Z="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),ee=0;Z.length>ee;)p(Z[ee++]);for(var te=M(p.store),ne=0;te.length>ne;)m(te[ne++]);o(o.S+o.F*!W,"Symbol",{for:function(e){return r(B,e+="")?B[e]:B[e]=P(e)},keyFor:function(e){if(!H(e))throw TypeError(e+" is not a symbol!");for(var t in B)if(B[t]===e)return t},useSetter:function(){X=!0},useSimple:function(){X=!1}}),o(o.S+o.F*!W,"Object",{create:function(e,t){return void 0===t?w(e):K(w(e),t)},defineProperty:V,defineProperties:K,getOwnPropertyDescriptor:z,getOwnPropertyNames:J,getOwnPropertySymbols:Q}),I&&o(o.S+o.F*(!W||c((function(){var e=P();return"[null]"!=D([e])||"{}"!=D({a:e})||"{}"!=D(Object(e))}))),"JSON",{stringify:function(e){for(var t,n,s=[e],r=1;arguments.length>r;)s.push(arguments[r++]);if(n=t=s[1],(b(t)||void 0!==e)&&!H(e))return y(t)||(t=function(e,t){if("function"==typeof n&&(t=n.call(this,e,t)),!H(t))return t}),s[1]=t,D.apply(I,s)}}),P.prototype[L]||n(98)(P.prototype,L,P.prototype.valueOf),h(P,"Symbol"),h(Math,"Math",!0),h(s.JSON,"JSON",!0)},function(e,t,n){var s=n(161)("meta"),r=n(100),a=n(84),o=n(83).f,i=0,l=Object.isExtensible||function(){return!0},c=!n(120)((function(){return l(Object.preventExtensions({}))})),u=function(e){o(e,s,{value:{i:"O"+ ++i,w:{}}})},h=e.exports={KEY:s,NEED:!1,fastKey:function(e,t){if(!r(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!a(e,s)){if(!l(e))return"F";if(!t)return"E";u(e)}return e[s].i},getWeak:function(e,t){if(!a(e,s)){if(!l(e))return!0;if(!t)return!1;u(e)}return e[s].w},onFreeze:function(e){return c&&h.NEED&&l(e)&&!a(e,s)&&u(e),e}}},function(e,t,n){var s=n(122),r=n(235),a=n(123);e.exports=function(e){var t=s(e),n=r.f;if(n)for(var o,i=n(e),l=a.f,c=0;i.length>c;)l.call(e,o=i[c++])&&t.push(o);return t}},function(e,t,n){var s=n(229);e.exports=Array.isArray||function(e){return"Array"==s(e)}},function(e,t,n){var s=n(85),r=n(353).f,a={}.toString,o="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];e.exports.f=function(e){return o&&"[object Window]"==a.call(e)?function(e){try{return r(e)}catch(e){return o.slice()}}(e):r(s(e))}},function(e,t){},function(e,t,n){n(241)("asyncIterator")},function(e,t,n){n(241)("observable")},function(e,t,n){e.exports={default:n(732),__esModule:!0}},function(e,t,n){n(733),e.exports=n(49).Object.setPrototypeOf},function(e,t,n){var s=n(65);s(s.S,"Object",{setPrototypeOf:n(734).set})},function(e,t,n){var s=n(100),r=n(99),a=function(e,t){if(r(e),!s(t)&&null!==t)throw TypeError(t+": can't set as prototype!")};e.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(e,t,s){try{(s=n(227)(Function.call,n(354).f(Object.prototype,"__proto__").set,2))(e,[]),t=!(e instanceof Array)}catch(e){t=!0}return function(e,n){return a(e,n),t?e.__proto__=n:s(e,n),e}}({},!1):void 0),check:a}},function(e,t,n){e.exports={default:n(736),__esModule:!0}},function(e,t,n){n(737);var s=n(49).Object;e.exports=function(e,t){return s.create(e,t)}},function(e,t,n){var s=n(65);s(s.S,"Object",{create:n(238)})},function(e,t,n){n(739),e.exports=n(49).Object.entries},function(e,t,n){var s=n(65),r=n(355)(!0);s(s.S,"Object",{entries:function(e){return r(e)}})},function(e,t,n){n(741),e.exports=n(49).Object.values},function(e,t,n){var s=n(65),r=n(355)(!1);s(s.S,"Object",{values:function(e){return r(e)}})},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e};t.default=function(e,t){return function n(i,h){var d,p,f,m=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],g=i.displayName||i.name||"Component",y=o.getType(i).propTypes,v=o.isReactComponent(i),b=Object.keys(h),_=["valueLink","checkedLink"].concat(b.map(o.defaultKey));f=o.uncontrolledPropTypes(h,y,g),(0,a.default)(v||!m.length,"[uncontrollable] stateless function components cannot pass through methods because they have no associated instances. Check component: "+g+", attempting to pass through methods: "+m.join(", ")),m=o.transform(m,(function(e,t){e[t]=function(){var e;return(e=this.refs.inner)[t].apply(e,arguments)}}),{});var E=(p=d=function(t){function n(){return l(this,n),c(this,t.apply(this,arguments))}return u(n,t),n.prototype.shouldComponentUpdate=function(){for(var t=arguments.length,n=Array(t),s=0;s<t;s++)n[s]=arguments[s];return!e.shouldComponentUpdate||e.shouldComponentUpdate.apply(this,n)},n.prototype.componentWillMount=function(){var e=this,t=this.props;this._values={},b.forEach((function(n){e._values[n]=t[o.defaultKey(n)]}))},n.prototype.componentWillReceiveProps=function(t){var n=this,s=this.props;e.componentWillReceiveProps&&e.componentWillReceiveProps.call(this,t),b.forEach((function(e){void 0===o.getValue(t,e)&&void 0!==o.getValue(s,e)&&(n._values[e]=t[o.defaultKey(e)])}))},n.prototype.componentWillUnmount=function(){this.unmounted=!0},n.prototype.getControlledInstance=function(){return this.refs.inner},n.prototype.render=function(){var e=this,t={},n=C(this.props);return o.each(h,(function(n,s){var r=o.getLinkName(s),a=e.props[s];r&&!w(e.props,s)&&w(e.props,r)&&(a=e.props[r].value),t[s]=void 0!==a?a:e._values[s],t[n]=S.bind(e,s)})),t=s({},n,t,{ref:v?"inner":null}),r.default.createElement(i,t)},n}(r.default.Component),d.displayName="Uncontrolled("+g+")",d.propTypes=f,p);return s(E.prototype,m),E.ControlledComponent=i,E.deferControlTo=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments[2];return n(e,s({},h,t),r)},E;function S(e,n){var s=o.getLinkName(e),r=this.props[h[e]];s&&w(this.props,s)&&!r&&(r=this.props[s].requestChange);for(var a=arguments.length,i=Array(a>2?a-2:0),l=2;l<a;l++)i[l-2]=arguments[l];t(this,e,r,n,i)}function w(e,t){return void 0!==e[t]}function C(e){var t={};return o.each(e,(function(e,n){-1===_.indexOf(n)&&(t[n]=e)})),t}}};var r=i(n(1)),a=i(n(106)),o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(743));function i(e){return e&&e.__esModule?e:{default:e}}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.version=void 0,t.uncontrolledPropTypes=function(e,t,n){0;return{}},t.getType=function(e){return a[0]>=15||0===a[0]&&a[1]>=13?e:e.type},t.getValue=function(e,t){var n=i(t);return n&&!o(e,t)&&o(e,n)?e[n].value:e[t]},t.getLinkName=i,t.defaultKey=l,t.chain=function(e,t,n){return function(){for(var s=arguments.length,r=Array(s),a=0;a<s;a++)r[a]=arguments[a];t&&t.call.apply(t,[e].concat(r)),n&&n.call.apply(n,[e].concat(r))}},t.transform=function(e,t,n){return c(e,t.bind(null,n=n||(Array.isArray(e)?[]:{}))),n},t.each=c,t.has=u,t.isReactComponent=function(e){return!!(e&&e.prototype&&e.prototype.isReactComponent)};var s=r(n(1));r(n(106));function r(e){return e&&e.__esModule?e:{default:e}}var a=t.version=s.default.version.split(".").map(parseFloat);function o(e,t){return void 0!==e[t]}function i(e){return"value"===e?"valueLink":"checked"===e?"checkedLink":null}function l(e){return"default"+e.charAt(0).toUpperCase()+e.substr(1)}function c(e,t,n){if(Array.isArray(e))return e.forEach(t,n);for(var s in e)u(e,s)&&t.call(n,e[s],s,e)}function u(e,t){return!!e&&Object.prototype.hasOwnProperty.call(e,t)}},function(e,t,n){n(350),n(745),e.exports=n(49).Array.from},function(e,t,n){"use strict";var s=n(227),r=n(65),a=n(236),o=n(746),i=n(747),l=n(349),c=n(748),u=n(749);r(r.S+r.F*!n(751)((function(e){Array.from(e)})),"Array",{from:function(e){var t,n,r,h,d=a(e),p="function"==typeof this?this:Array,f=arguments.length,m=f>1?arguments[1]:void 0,g=void 0!==m,y=0,v=u(d);if(g&&(m=s(m,f>2?arguments[2]:void 0,2)),null==v||p==Array&&i(v))for(n=new p(t=l(d.length));t>y;y++)c(n,y,g?m(d[y],y):d[y]);else for(h=v.call(d),n=new p;!(r=h.next()).done;y++)c(n,y,g?o(h,m,[r.value,y],!0):r.value);return n.length=y,n}})},function(e,t,n){var s=n(99);e.exports=function(e,t,n,r){try{return r?t(s(n)[0],n[1]):t(n)}catch(t){var a=e.return;throw void 0!==a&&s(a.call(e)),t}}},function(e,t,n){var s=n(124),r=n(50)("iterator"),a=Array.prototype;e.exports=function(e){return void 0!==e&&(s.Array===e||a[r]===e)}},function(e,t,n){"use strict";var s=n(83),r=n(121);e.exports=function(e,t,n){t in e?s.f(e,t,r(0,n)):e[t]=n}},function(e,t,n){var s=n(750),r=n(50)("iterator"),a=n(124);e.exports=n(49).getIteratorMethod=function(e){if(null!=e)return e[r]||e["@@iterator"]||a[s(e)]}},function(e,t,n){var s=n(229),r=n(50)("toStringTag"),a="Arguments"==s(function(){return arguments}());e.exports=function(e){var t,n,o;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),r))?n:a?s(t):"Object"==(o=s(t))&&"function"==typeof t.callee?"Arguments":o}},function(e,t,n){var s=n(50)("iterator"),r=!1;try{var a=[7][s]();a.return=function(){r=!0},Array.from(a,(function(){throw 2}))}catch(e){}e.exports=function(e,t){if(!t&&!r)return!1;var n=!1;try{var a=[7],o=a[s]();o.next=function(){return{done:n=!0}},a[s]=function(){return o},e(a)}catch(e){}return n}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return function(n){var a=n.currentTarget,o=n.target;(0,r.default)(a,e).some((function(e){return(0,s.default)(e,o)}))&&t.call(this,n)}};var s=a(n(58)),r=a(n(753));function a(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var n,a="#"===t[0],o="."===t[0],i=a||o?t.slice(1):t;if(s.test(i))return a?(e=e.getElementById?e:document,(n=e.getElementById(i))?[n]:[]):e.getElementsByClassName&&o?r(e.getElementsByClassName(i)):r(e.getElementsByTagName(t));return r(e.querySelectorAll(t))};var s=/^[\w-]*$/,r=Function.prototype.bind.call(Function.prototype.call,[].slice);e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=o(n(41)),r=o(n(110)),a=o(n(132));function o(e){return e&&e.__esModule?e:{default:e}}var i=function(){};s.default&&(i=function(e,t,n,s){return(0,r.default)(e,t,n,s),function(){(0,a.default)(e,t,n,s)}}),t.default=i,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=i;var s,r=n(32),a=(s=r)&&s.__esModule?s:{default:s};var o={};function i(e,t){return function(n,s,r,i,l){var c=r||"<<anonymous>>",u=l||s;if(null!=n[s]){var h=r+"."+s;(0,a.default)(o[h],"The "+i+" `"+u+"` of `"+c+"` is deprecated. "+t+"."),o[h]=!0}for(var d=arguments.length,p=Array(d>5?d-5:0),f=5;f<d;f++)p[f-5]=arguments[f];return e.apply(void 0,[n,s,r,i,l].concat(p))}}i._resetWarned=function(){o={}},e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=l(n(256)),r=l(n(67)),a=l(n(105)),o=l(n(252)),i=n(757);function l(e){return e&&e.__esModule?e:{default:e}}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){return n=function(e){return-1!==e.modals.indexOf(t)},s=-1,e.some((function(e,t){if(n(e,t))return s=t,!0})),s;var n,s}function h(e,t){var n={overflow:"hidden"};e.style={overflow:t.style.overflow,paddingRight:t.style.paddingRight},e.overflowing&&(n.paddingRight=parseInt((0,r.default)(t,"paddingRight")||0,10)+(0,a.default)()+"px"),(0,r.default)(t,n)}function d(e,t){var n=e.style;Object.keys(n).forEach((function(e){return t.style[e]=n[e]}))}t.default=function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=n.hideSiblingNodes,a=void 0===r||r,l=n.handleContainerOverflow,p=void 0===l||l;c(this,e),this.add=function(e,n,r){var a=t.modals.indexOf(e),l=t.containers.indexOf(n);if(-1!==a)return a;if(a=t.modals.length,t.modals.push(e),t.hideSiblingNodes&&(0,i.hideSiblings)(n,e.mountNode),-1!==l)return t.data[l].modals.push(e),a;var c={modals:[e],classes:r?r.split(/\s+/):[],overflowing:(0,o.default)(n)};return t.handleContainerOverflow&&h(c,n),c.classes.forEach(s.default.addClass.bind(null,n)),t.containers.push(n),t.data.push(c),a},this.remove=function(e){var n=t.modals.indexOf(e);if(-1!==n){var r=u(t.data,e),a=t.data[r],o=t.containers[r];a.modals.splice(a.modals.indexOf(e),1),t.modals.splice(n,1),0===a.modals.length?(a.classes.forEach(s.default.removeClass.bind(null,o)),t.handleContainerOverflow&&d(a,o),t.hideSiblingNodes&&(0,i.showSiblings)(o,e.mountNode),t.containers.splice(r,1),t.data.splice(r,1)):t.hideSiblingNodes&&(0,i.ariaHidden)(!1,a.modals[a.modals.length-1].mountNode)}},this.isTopModal=function(e){return!!t.modals.length&&t.modals[t.modals.length-1]===e},this.hideSiblingNodes=a,this.handleContainerOverflow=p,this.modals=[],this.containers=[],this.data=[]},e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.ariaHidden=a,t.hideSiblings=function(e,t){r(e,t,(function(e){return a(!0,e)}))},t.showSiblings=function(e,t){r(e,t,(function(e){return a(!1,e)}))};var s=["template","script","style"],r=function(e,t,n){t=[].concat(t),[].forEach.call(e.children,(function(e){var r,a,o;-1===t.indexOf(e)&&(a=(r=e).nodeType,o=r.tagName,1===a&&-1===s.indexOf(o.toLowerCase()))&&n(e)}))};function a(e,t){t&&(e?t.setAttribute("aria-hidden","true"):t.removeAttribute("aria-hidden"))}},function(e,t,n){"use strict";t.__esModule=!0;var s=c(n(0)),r=c(n(162)),a=c(n(1)),o=c(n(17)),i=c(n(163)),l=c(n(102));function c(e){return e&&e.__esModule?e:{default:e}}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var d=function(e){function t(){var n,s;u(this,t);for(var r=arguments.length,c=Array(r),d=0;d<r;d++)c[d]=arguments[d];return n=s=h(this,e.call.apply(e,[this].concat(c))),s._mountOverlayTarget=function(){s._overlayTarget||(s._overlayTarget=document.createElement("div"),s._portalContainerNode=(0,i.default)(s.props.container,(0,l.default)(s).body),s._portalContainerNode.appendChild(s._overlayTarget))},s._unmountOverlayTarget=function(){s._overlayTarget&&(s._portalContainerNode.removeChild(s._overlayTarget),s._overlayTarget=null),s._portalContainerNode=null},s._renderOverlay=function(){var e=s.props.children?a.default.Children.only(s.props.children):null;if(null!==e){s._mountOverlayTarget();var t=!s._overlayInstance;s._overlayInstance=o.default.unstable_renderSubtreeIntoContainer(s,e,s._overlayTarget,(function(){t&&s.props.onRendered&&s.props.onRendered()}))}else s._unrenderOverlay(),s._unmountOverlayTarget()},s._unrenderOverlay=function(){s._overlayTarget&&(o.default.unmountComponentAtNode(s._overlayTarget),s._overlayInstance=null)},s.getMountNode=function(){return s._overlayTarget},h(s,n)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this._isMounted=!0,this._renderOverlay()},t.prototype.componentDidUpdate=function(){this._renderOverlay()},t.prototype.componentWillReceiveProps=function(e){this._overlayTarget&&e.container!==this.props.container&&(this._portalContainerNode.removeChild(this._overlayTarget),this._portalContainerNode=(0,i.default)(e.container,(0,l.default)(this).body),this._portalContainerNode.appendChild(this._overlayTarget))},t.prototype.componentWillUnmount=function(){this._isMounted=!1,this._unrenderOverlay(),this._unmountOverlayTarget()},t.prototype.render=function(){return null},t}(a.default.Component);d.displayName="Portal",d.propTypes={container:s.default.oneOfType([r.default,s.default.func]),onRendered:s.default.func},t.default=d,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=a(n(0)),r=a(n(1));function a(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var l={children:s.default.node},c=function(e){function t(){return o(this,t),i(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.render=function(){return this.props.children},t}(r.default.Component);c.propTypes=l,t.default=c,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e){var t=!document.addEventListener,n=void 0;t?(document.attachEvent("onfocusin",e),n=function(){return document.detachEvent("onfocusin",e)}):(document.addEventListener("focus",e,!0),n=function(){return document.removeEventListener("focus",e,!0)});return{remove:n}},e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0;var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},r=p(n(3)),a=p(n(0)),o=p(n(162)),i=n(1),l=p(i),c=p(n(17)),u=p(n(762)),h=p(n(163)),d=p(n(102));function p(e){return e&&e.__esModule?e:{default:e}}function f(e,t){var n={};for(var s in e)t.indexOf(s)>=0||Object.prototype.hasOwnProperty.call(e,s)&&(n[s]=e[s]);return n}var m=function(e){function t(n,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.call(this,n,s));return r.getTarget=function(){var e=r.props.target,t="function"==typeof e?e():e;return t&&c.default.findDOMNode(t)||null},r.maybeUpdatePosition=function(e){var t=r.getTarget();(r.props.shouldUpdatePosition||t!==r._lastTarget||e)&&r.updatePosition(t)},r.state={positionLeft:0,positionTop:0,arrowOffsetLeft:null,arrowOffsetTop:null},r._needsFlush=!1,r._lastTarget=null,r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this.updatePosition(this.getTarget())},t.prototype.componentWillReceiveProps=function(){this._needsFlush=!0},t.prototype.componentDidUpdate=function(e){this._needsFlush&&(this._needsFlush=!1,this.maybeUpdatePosition(this.props.placement!==e.placement))},t.prototype.render=function(){var e=this.props,t=e.children,n=e.className,a=f(e,["children","className"]),o=this.state,c=o.positionLeft,u=o.positionTop,h=f(o,["positionLeft","positionTop"]);delete a.target,delete a.container,delete a.containerPadding,delete a.shouldUpdatePosition;var d=l.default.Children.only(t);return(0,i.cloneElement)(d,s({},a,h,{positionLeft:c,positionTop:u,className:(0,r.default)(n,d.props.className),style:s({},d.props.style,{left:c,top:u})}))},t.prototype.updatePosition=function(e){if(this._lastTarget=e,e){var t=c.default.findDOMNode(this),n=(0,h.default)(this.props.container,(0,d.default)(this).body);this.setState((0,u.default)(this.props.placement,t,e,n,this.props.containerPadding))}else this.setState({positionLeft:0,positionTop:0,arrowOffsetLeft:null,arrowOffsetTop:null})},t}(l.default.Component);m.propTypes={target:a.default.oneOfType([o.default,a.default.func]),container:a.default.oneOfType([o.default,a.default.func]),containerPadding:a.default.number,placement:a.default.oneOf(["top","right","bottom","left"]),shouldUpdatePosition:a.default.bool},m.displayName="Position",m.defaultProps={containerPadding:0,placement:"right",shouldUpdatePosition:!1},t.default=m,e.exports=t.default},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t,n,a,o){var i="BODY"===a.tagName?(0,s.default)(n):(0,r.default)(n,a),c=(0,s.default)(t),u=c.height,h=c.width,d=void 0,p=void 0,f=void 0,m=void 0;if("left"===e||"right"===e){p=i.top+(i.height-u)/2,d="left"===e?i.left-h:i.left+i.width;var g=function(e,t,n,s){var r=l(n),a=r.scroll,o=r.height,i=e-s-a,c=e+s-a+t;return i<0?-i:c>o?o-c:0}(p,u,a,o);p+=g,m=50*(1-2*g/u)+"%",f=void 0}else{if("top"!==e&&"bottom"!==e)throw new Error('calcOverlayPosition(): No such placement of "'+e+'" found.');d=i.left+(i.width-h)/2,p="top"===e?i.top-u:i.top+i.height;var y=function(e,t,n,s){var r=l(n).width,a=e-s,o=e+s+t;if(a<0)return-a;if(o>r)return r-o;return 0}(d,h,a,o);d+=y,f=50*(1-2*y/h)+"%",m=void 0}return{positionLeft:d,positionTop:p,arrowOffsetLeft:f,arrowOffsetTop:m}};var s=i(n(358)),r=i(n(763)),a=i(n(359)),o=i(n(102));function i(e){return e&&e.__esModule?e:{default:e}}function l(e){var t=void 0,n=void 0,r=void 0;if("BODY"===e.tagName)t=window.innerWidth,n=window.innerHeight,r=(0,a.default)((0,o.default)(e).documentElement)||(0,a.default)(e);else{var i=(0,s.default)(e);t=i.width,n=i.height,r=(0,a.default)(e)}return{width:t,height:n,scroll:r}}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e};t.default=function(e,t){var n,c={top:0,left:0};"fixed"===(0,l.default)(e,"position")?n=e.getBoundingClientRect():(t=t||(0,a.default)(e),n=(0,r.default)(e),"html"!==function(e){return e.nodeName&&e.nodeName.toLowerCase()}(t)&&(c=(0,r.default)(t)),c.top+=parseInt((0,l.default)(t,"borderTopWidth"),10)-(0,o.default)(t)||0,c.left+=parseInt((0,l.default)(t,"borderLeftWidth"),10)-(0,i.default)(t)||0);return s({},n,{top:n.top-c.top-(parseInt((0,l.default)(e,"marginTop"),10)||0),left:n.left-c.left-(parseInt((0,l.default)(e,"marginLeft"),10)||0)})};var r=c(n(358)),a=c(n(764)),o=c(n(359)),i=c(n(765)),l=c(n(67));function c(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){var t=(0,s.default)(e),n=e&&e.offsetParent;for(;n&&"html"!==o(e)&&"static"===(0,r.default)(n,"position");)n=n.offsetParent;return n||t.documentElement};var s=a(n(52)),r=a(n(67));function a(e){return e&&e.__esModule?e:{default:e}}function o(e){return e.nodeName&&e.nodeName.toLowerCase()}e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var n=(0,a.default)(e);if(void 0===t)return n?"pageXOffset"in n?n.pageXOffset:n.document.documentElement.scrollLeft:e.scrollLeft;n?n.scrollTo(t,"pageYOffset"in n?n.pageYOffset:n.document.documentElement.scrollTop):e.scrollLeft=t};var s,r=n(109),a=(s=r)&&s.__esModule?s:{default:s};e.exports=t.default},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1)),a=s(n(189)),o=n(249);class i extends r.default.Component{shouldComponentUpdate(e){return!!e.updateMap}render(){const{screen:e}=this.props;return r.default.createElement(o.ContextMenuTrigger,{id:"right-click-context-menu"},r.default.createElement(a.default,{boardClassName:this.props.boardClassName,charRows:e.getCharRows(),classRows:e.getClassRows(),endY:e.endY,onCellClick:this.props.onCellClick,onMouseDown:this.props.onMouseDown,onMouseOver:this.props.onMouseOver,onMouseOverCell:this.props.onMouseOverCell,onMouseUp:this.props.onMouseUp,rowClass:this.props.rowClass,sizeX:this.props.sizeX,startX:0,startY:0,useRLE:this.props.useRLE,renderInAscii:!0}))}}t.default=i},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1));class a extends r.default.Component{constructor(e){super(e),this.deleteLevel=this.deleteLevel.bind(this)}render(){const e=this.getLevelList();return r.default.createElement("div",{className:"list-group"},"List of levels:",e)}getLevelList(){return this.props.levelList.map((e,t)=>{const n=this.selectLevel.bind(this,e,t),s=this.props.levelIndex===t?"list-group-item list-group-item-info":"list-group-item",a=e.getActors().length,o=a?"A:"+a:"",i=e.getItems().length,l=i?"I:"+i:"";return r.default.createElement("a",{className:s,href:"#",key:e.getID(),onClick:n},"L",e.getID(),":",e.getMap().cols,"x",e.getMap().rows,"|",o,"|",l,r.default.createElement("button",{className:"btn-xs btn-danger pull-right",id:"btn-delete-level-"+t,onClick:this.deleteLevel},"X"))})}selectLevel(e,t){this.props.setShownLevel({level:e,levelIndex:t})}deleteLevel(e){e&&e.stopPropagation();const{id:t}=e.target;let n=t.match(/(\d+)$/)[1];n=parseInt(t,10);const s=this.props.levelList;s.splice(n,1);const r=s.length>0?s[0]:null;null===r?this.props.setShownLevel({level:null,levelIndex:-1,levelList:s}):this.props.setShownLevel({level:r,levelIndex:0,levelList:s})}}t.default=a},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(1));class i extends o.Component{constructor(e){super(e),this.callback=this.callback.bind(this)}callback(e){const t=e.target.id;this.props.menuCallback(t)}render(){let e="btn btn-xs";return this.props.simulationStarted||(e="btn btn-xs disabled"),o.createElement("div",null,o.createElement("button",{className:"btn btn-xs",id:"simulateLevel",onClick:this.callback},"Simulate"),o.createElement("button",{className:"btn btn-xs",id:"stepSimulation",onClick:this.callback},"Step"),o.createElement("button",{className:e,id:"playSimulation",onClick:this.callback},"Play"),o.createElement("button",{className:e,id:"playFastSimulation",onClick:this.callback},">>>"),o.createElement("button",{className:e,id:"pauseSimulation",onClick:this.callback},"Pause"),o.createElement("button",{className:e,id:"stopSimulation",onClick:this.callback},"Stop"))}}t.default=i},function(e,t,n){var s,r=r||function(e){"use strict";if(!(void 0===e||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var t=e.document,n=function(){return e.URL||e.webkitURL||e},s=t.createElementNS("http://www.w3.org/1999/xhtml","a"),r="download"in s,a=/constructor/i.test(e.HTMLElement)||e.safari,o=/CriOS\/[\d]+/.test(navigator.userAgent),i=function(t){(e.setImmediate||e.setTimeout)((function(){throw t}),0)},l=function(e){setTimeout((function(){"string"==typeof e?n().revokeObjectURL(e):e.remove()}),4e4)},c=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},u=function(t,u,h){h||(t=c(t));var d,p=this,f="application/octet-stream"===t.type,m=function(){!function(e,t,n){for(var s=(t=[].concat(t)).length;s--;){var r=e["on"+t[s]];if("function"==typeof r)try{r.call(e,n||e)}catch(e){i(e)}}}(p,"writestart progress write writeend".split(" "))};if(p.readyState=p.INIT,r)return d=n().createObjectURL(t),void setTimeout((function(){var e,t;s.href=d,s.download=u,e=s,t=new MouseEvent("click"),e.dispatchEvent(t),m(),l(d),p.readyState=p.DONE}));!function(){if((o||f&&a)&&e.FileReader){var s=new FileReader;return s.onloadend=function(){var t=o?s.result:s.result.replace(/^data:[^;]*;/,"data:attachment/file;");e.open(t,"_blank")||(e.location.href=t),t=void 0,p.readyState=p.DONE,m()},s.readAsDataURL(t),void(p.readyState=p.INIT)}(d||(d=n().createObjectURL(t)),f)?e.location.href=d:e.open(d,"_blank")||(e.location.href=d);p.readyState=p.DONE,m(),l(d)}()},h=u.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return t=t||e.name||"download",n||(e=c(e)),navigator.msSaveOrOpenBlob(e,t)}:(h.abort=function(){},h.readyState=h.INIT=0,h.WRITING=1,h.DONE=2,h.error=h.onwritestart=h.onprogress=h.onwrite=h.onabort=h.onerror=h.onwriteend=null,function(e,t,n){return new u(e,t||e.name||"download",n)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);
/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */e.exports?e.exports.saveAs=r:null!==n(770)&&null!==n(361)&&(void 0===(s=function(){return r}.call(t,n,t,e))||(e.exports=s))},function(e,t){e.exports=function(){throw new Error("define cannot be used indirect")}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(1)),i=n(362),l={hasActors:[{text:"Remove actor",type:"removeActor"},{text:"Edit actor",type:"editActor"}],hasItems:[{text:"Delete item"},{text:"Edit item"}],hasElements:[{text:"Delete element"},{text:"Edit element"}],hasConnection:[{text:"Create connection"}]};class c extends o.Component{render(){return o.createElement(i.ContextMenuItems,{handleRightClick:this.props.handleRightClick,menuItems:l,mouseOverCell:this.props.mouseOverCell})}}t.default=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(e){this.level=e,this.funcTable={removeActor:this.removeActor.bind(this),editActor:this.editActor.bind(this)}}handleClick(e,t,n,s){return console.log("EditorClickHandler with cmd",s),!!this.funcTable[s]&&this.funcTable[s](n,e,t)}removeActor(e,t,n){return this.level.removeActor(e.getActors()[0])}editActor(e){const t=e.getActors()[0];return console.log("window.EDIT_ACTOR set. Use console to edit"),window.EDIT_ACTOR=t,!0}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LevelUtils=void 0;const s=n(24),r=n(46),a=n(18),o=n(13);t.LevelUtils={},t.LevelUtils.wrapAsLevel=function(e,t){const n=(e,t)=>Math.max(e,t),i=e.map(e=>e.getMap().cols),l=e.map(e=>e.getMap().rows);let c=null,u=null;const h=t.baseElem||a.ELEM.FLOOR;if(t.centerY){const t=l.reduce(n),a=i.reduce((e,t)=>e+t,0);c=new r.CellMap(a,t,h),u=new s.Level(c),o.Geometry.tileLevels(u,e,{centerY:!0,x:0,y:0})}else if(t.centerX){const t=l.reduce((e,t)=>e+t,0),a=i.reduce(n);c=new r.CellMap(a,t,h),u=new s.Level(c),o.Geometry.tileLevels(u,e,{centerX:!0,x:0,y:0})}return u}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DebugGame=void 0;const i=o(n(4)),l=a(n(11)),c=a(n(16)),u=a(n(39)),h=a(n(136)),d=n(186),p=n(112),f=n(111),m=n(226),g=n(31),y=n(183),v=n(64),b=n(9),_=n(113),E=n(263),S=n(82),w=n(18),C=n(224),O=n(243),T=n(23),M=n(86),A=n(28),N=n(87),x=a(n(45)),P=n(165),I=n(781),D=n(339),k=T.EventPool.getPool(),L=b.Random.getRNG(),R=c.ElementStairs;t.DebugGame=class{constructor(e,t){this._fact=e,this._factBase=new M.FactoryBase,this._parser=t,this._savedPlayerFOV=1}createArena(e,t,n){D.Room.rng=L;const s=this._parser,r=e.sqrPerItem;e.cols=100,e.rows=100;const[a,o]=[50,50],h=this.createLastBattle(t,e);h.addActor(n,a,o);const m=new x.CityQuarter("Debug quarter");m.addLevel(h);h.getExtras().shops.forEach(e=>{m.addShop(e)});const g=new x.City("Wrapper city for Debug quarter");g.addSubZone(m),g.tileX=0,g.tileY=0;const v=new x.Area("Wrapper area",2,2,10,10);v.addZone("City",g);const b=new x.WorldTop("Wrapper world"),E=b.getConf();b.addArea(v),E.nAreas=1,E.area=[v.getConf()],b.setConf(E),t.addPlace(b);const T=this._parser.createActor("Wolf spirit");T.get("Stats").setStrength(500),h.addActor(T,2,1);const M=new u.SpiritGem("Lesser gem");h.addItem(M);const A=this._parser.createItem("Pick-axe");n.getInvEq().addItem(A);const N=this._parser.createItem("Potion of frost poison");N.setCount(5),h.addItem(N,2,2);const P=this._parser.createItem("Potion of cure poison");h.addItem(P,3,2);const k=this._parser.createItem("Rifle"),B=this._parser.createItem("Steel bullet");B.setCount(100),h.addItem(k,1,1),h.addItem(B,1,1);const G=this._parser.createActor("shopkeeper"),j=new u.GoldCoin;j.setCount(50),G.getInvEq().addItem(j),h.addActor(G,2,2);const W=h.getMap().getFree().length,Y={itemsPerLevel:Math.round(W/r),item:e=>e.value<=2500,maxValue:2500,food:()=>!0,gold:()=>!1};this._factBase.addNRandItems(h,this._parser,Y);const{cols:X,rows:U}=h.getMap(),$=this._parser.createActor("Thabba, Son of Ice");h.addActor($,X-2,U-2);const H=this._parser.createActor("cryomancer");h.addActor(H,1,U-2);const V=this._parser.createActualObj("items","Potion of spirit form");n.getInvEq().addItem(V);const K=this._parser.createItem("Potion of strength");n.getInvEq().addItem(K),n.add(new l.Attacker),n.add(new l.Defender),n.add(new l.MasterEquipper),n.add(new l.BiDirStrike),n.add(new l.ThroughShot);new I.WinCondition("Kill a keeper",t.getPool()).addActorKilled(G);n.getInvEq().getEquipment().addSlot("spiritgem",new y.EquipSlot("spiritgem"));const q=this._parser.createItem("Lesser spirit gem"),z=this._parser.createItem("Greater spirit gem");n.getInvEq().addItem(q),n.getInvEq().addItem(z),n.add(new l.SpiritItemCrafter);const J=new c.ElementExploration;J.setExp(100),h.addElement(J,1,20);const Q=this.createTrainer();h.addActor(Q,1,2);const Z=new u.GoldCoin;Z.setCount(600),n.getInvEq().addItem(Z);const ee=new _.Spell.SpellBook(n);n.setBook(ee),_.Spell.addAllSpells(ee),n.add(new l.SpellPower),n.get("SpellPower").setPP(100);const te=new S.VirtualActor("spawner"),ne=new f.BrainSpawner(te);ne.setConstraint({op:"lt",prop:"danger",value:10}),te.setBrain(ne),h.addVirtualProp(i.default.TYPE_ACTOR,te);const se=this._parser.createActor("Fire"),re=new l.Fading;re.setDuration(20),se.add(re),h.addActor(se,7,1);const ae=this._parser.createActor("thunderbird");h.addActor(ae,20,1);const oe=s.createEntity("firemaking kit");n.getInvEq().addItem(oe),n.get("SpellPower").setPP(100),n.get("SpellPower").setMaxPP(100),this.addRunesForDebug(n,s);const ie=new c.ElementLever;h.addElement(ie,2,1);for(let e=0;e<3;e++){const t=new c.ElementLeverDoor;ie.addTarget(t),h.addElement(t,3+e,1)}d.Ability.addAllAbilities(n),this.addGoblinWithLoot(h);const le=F(s,n,"Void dagger");n.getInvEq().unequipItem("hand",1,0),n.getInvEq().equipItem(le),F(s,n,"shovel"),F(s,n,"machete"),F(s,n,"rune of webs");const ce=s.createActor("bearfolk thief");h.addActor(ce,a+1,o+1),n.getInvEq().addItem(s.createItem("Boots of flying")),h.getMap().setBaseElemXY(a-1,o-1,w.ELEM.WATER);p.ActorsData.filter(e=>"UniqueBase"===e.base).forEach(e=>{const{name:t}=e,n=s.createActor(t);n?h.addActorToFreeCell(n):i.default.warn("DebugGame","creating uniques","Failed to create unique actor: "+t)});const ue=new O.QuestPopulate,he=new u.Book("Book of shadows");he.addText("In the land of mordor where shadows lie..."),n.getInvEq().addItem(he);const de=new O.Quest("Report info to actor",["<goto>already_there","<report>listen","<goto>already_there","report"]);ue.mapQuestToResources(de,g,null),ue.addQuestComponents(g);const pe=h.getActors(),fe=pe.find(e=>e.has("QuestGiver"));fe.get("QuestGiver").setReward({type:"item",name:"Ruby glass mace"}),h.moveActorTo(fe,a+1,o),fe.add(new l.Trainer);pe.filter(e=>e.has("QuestTarget")).forEach((e,t)=>{h.moveActorTo(e,a,o+1+t),e.get("Stats").setSpeed(10)});const me=h.getMap().getCells(e=>e.isFree());for(let e=0;e<200;e++){const e=L.arrayGetRand(me),[t,n]=e.getXY();h.addElement(new c.ElementWeb,t,n),h.getMap().hasXY(t+1,n+1)&&h.addElement(new c.ElementSlime,t+1,n+1)}const ge=h.getMap().getCells(e=>e.hasPropType("floorhouse"));for(let e=0;e<40;e++){L.arrayGetRand(ge).setBaseElem(w.ELEM.BED)}const ye=new l.Charm({level:10});n.add(ye);const ve=new l.Lore({});ve.addTopic("quests",fe.getName()+" is looking for someone."),h.add(ve);const be=C.ItemGen.buildShell({type:"weapon",name:"sword",material:"steel",suffix:"ofNecropotence"}),_e=s.createFromShell(i.default.TYPE_ITEM,be);n.getInvEq().addItem(_e);s.getCreator().addAbilityEffects({ability:{addEntity:{name:"Lay an egg",entityName:"Chicken egg"}}},n);const Ee=h.getMap().getCells(e=>e.isFree());for(let e=0;e<50;e++){const e=L.arrayGetRand(Ee),t=s.createActor("chicken");h.addActor(t,e.getX(),e.getY())}F(s,n,"hoe"),F(s,n,"wheat seeds"),n.setFOVRange(5),t.addPlayer(n);const Se=new R("stairsDown",h,h);return Se.setTargetOnewayXY(0,0),Se.setMsg({onEnter:"Stairs speak aloud: Abandon all hope who enter here!!!"}),h.addElement(Se,n.getX()-1,n.getY()),F(s,n,"small bomb",10),F(s,n,"carpentry kit",1),t}addRunesForDebug(e,t){const n=new v.ItemRandomizer,s=t.createItem("rune of protection");n.adjustItem(s,100),e.getInvEq().addItem(s);const r=t.createItem("rune of tunneling");n.adjustItem(r,100),e.getInvEq().addItem(r);const a=t.createItem("rune of force");n.adjustItem(a,100),e.getInvEq().addItem(a);const o=t.createItem("rune of control");n.adjustItem(o,250),e.getInvEq().addItem(o);const i=t.createItem("rune of venom");n.adjustItem(i,150),e.getInvEq().addItem(i);const l=t.createItem("rune of poison clouds");n.adjustItem(l,150),e.getInvEq().addItem(l)}createQuestsDebug(e,t,n){const s={name:"Quest test world",nAreas:1,area:[(new P.WorldCreator).createSingleAreaConf(0,{maxX:2,maxY:2})]},r=(new N.FactoryWorld).createWorld(s),a=r.getZones("City")[0].getLevels()[0],o=Math.floor(a.getMap().cols/2),i=Math.floor(a.getMap().rows/2);return a.addActor(n,o,i),t.addPlace(r),t.addPlayer(n),t}createTrainer(){const e=this._parser.createActor("fighter");e.setName("Old trainer");const t=new l.Trainer;return t.getChatObj().setTrainer(e),e.add(t),e}addGoblinWithLoot(e){const t=this._parser.createActor("goblin");t.setName("goblin with loot");const n=new l.Loot(new u.Weapon("sword"));t.add(n),e.addActor(t,2,10)}createDebugBattle(e,t,n){const s=new m.Battle("Battle of ice kingdoms"),r=new m.Army("Blue army"),a=new m.Army("Red army");this.addActorsToArmy(r,10,"warlord"),this.addActorsToArmy(a,10,"winter demon");const o=(new A.FactoryLevel).createLevel("arena",60,30);return s.setLevel(o),s.addArmy(r,1,1,{}),s.addArmy(a,1,2,{}),t.addBattle(s),t.addPlayer(n),t}addActorsToArmy(e,t,n){for(let s=0;s<t;s++){const t=this._parser.createActor(n);t.setFOVRange(10),e.addActor(t)}}createOneDungeonAndBoss(e,t,n){const{cols:s,rows:r,nLevels:a,sqrPerActor:o,sqrPerItem:i}=e;let c=1;const h=["rooms","rogue","digger"],d=[],p=[],f=new x.Branch("StartBranch"),m=e=>t=>t.value<=e;for(let e=0;e<a;e++){let t=h[L.randIndex(h)];0===e&&(t="ruins");const n=this._fact.createLevel(t,s,r);f.addLevel(n);const a=n.getMap().getFree().length,l=Math.round(a/o),c=Math.round(a/i),d=new u.Potion("Healing potion");n.addItem(d);const g=this._parser.createItem("Shuriken");g.setCount(20),n.addItem(g);const y=20*(e+1),v={itemsPerLevel:c,func:m(y),maxValue:y,food:()=>!0};this._fact.addNRandItems(n,this._parser,v);const b={actorsPerLevel:l,maxDanger:e+1};this._fact.addNRandActors(n,this._parser,b),p.push(n)}const g=p.slice(-1)[0],y=g.getFreeRandCell(),v=this._fact.createActor("Summoner",{hp:100,att:10,def:10});v.setType("summoner"),v.get("Experience").setExpLevel(10),g.addActor(v,y.getX(),y.getY());const b=this.createLastBattle(t,{cols:80,rows:60});t.addLevel(b),b.setLevelNumber(c++),f.connectLevels(),t.addPlace(f);const _=new R("stairsDown",p[a-1],b),E=new l.Loot(_);v.add(E),d.push(_);const S=d.slice(-1)[0],w=new R("stairsUp",b,g),C=b.getFreeRandCell();b.addStairs(w,C.getX(),C.getY()),w.setTargetStairs(S),S.setTargetStairs(w);for(let e=0;e<10;e++){const e="Townsman",t=this._fact.createActor(e,{brain:"Human"});t.setType("human");const n=b.getFreeRandCell();b.addActor(t,n.getX(),n.getY())}if(null!==e.loadedLevel){const t=e.loadedLevel;t<=a?p[t-1].addActorToFreeCell(n):p[0].addActorToFreeCell(n)}return t.addPlayer(n,{place:"StartBranch"}),t}createLastBattle(e,t){const n=M.Factory.cityConfBase({});n.parser=this._parser,n.nShops=5;const s=e=>e.type===L.arrayGetRand(i.default.SHOP_TYPES);for(let e=0;e<n.nShops-1;e++)n.shopFunc.push(s);n.actorFunc=e=>"bearfolk"===e.type,n.hasWall=!1;const r=(new g.CityGenerator).create(t.cols,t.rows,n);this._listener=new B(this,e,r);return(new M.FactoryBase).createHumanArmy(r,this._parser),r.setOnFirstEnter(()=>{const t=new h.OneShotEvent(this._factBase.createDemonArmy.bind(this._fact,r,this._parser),2e3,"Demon hordes are unleashed from the unsilent abyss!");e.addEvent(t)}),r.setOnEnter(()=>{this._savedPlayerFOV=e.getPlayer().getFOVRange(),e.getPlayer().setFOVRange(20)}),r.setOnExit(()=>{e.getPlayer().setFOVRange(this._savedPlayerFOV)}),r}createSandboxGame(e,t,n){return this.createArena(e,t,n)}};class B{constructor(e,t,n){this.parent=e,this._game=t,this._level=n,this._maxBeasts=0,this._maxDemons=0,this._beastsKilled=0,this._demonsKilled=0,this.hasNotify=!0,k.listenEvent(i.default.EVT_ACTOR_CREATED,this),k.listenEvent(i.default.EVT_ACTOR_KILLED,this),this.notify=this.notify.bind(this)}notify(e,t){if(e===i.default.EVT_ACTOR_CREATED){if(t.hasOwnProperty("msg")&&"DemonSpawn"===t.msg){const e=t.actor;"winter demon"===e.getName()&&++this._maxDemons,"blizzard beast"===e.getName()&&++this._maxBeasts}}else if(e===i.default.EVT_ACTOR_KILLED){const e=t.actor;"winter demon"===e.getName()?(++this._demonsKilled,this._demonsKilled===this._maxDemons&&this.allDemonsKilled(),i.default.debug(this,"A winter demon was slain! #"+this._demonsKilled),i.default.debug(this,"Max demons: "+this._maxDemons)):"blizzard beast"===e.getName()&&(++this._beastsKilled,this._beastsKilled===this._maxBeasts&&this.allBeastsKilled())}}addSnow(e,t){const n=e.getMap();g.MapGenerator.addRandomSnow(n,t)}allDemonsKilled(){i.default.gameMsg("Humans have vanquished all demons! But it's not over..");const e=new h.OneShotEvent(this.addSnow.bind(this,this._level,.2),2e3,"Winds are blowing stronger. You feel it's getting colder");this._game.addEvent(e);const t=new h.OneShotEvent(()=>{},3500,E.Texts.battle.eyeOfStorm);this._game.addEvent(t);const n=new h.OneShotEvent(this.parent.createBeastArmy.bind(this.parent,this._level,this.parent._parser),5e3,"Winter spread by Blizzard Beasts! Hell seems to freeze.");this._game.addEvent(n)}allBeastsKilled(){i.default.gameMsg(E.Texts.battle.beastsSlain);const e=new h.OneShotEvent(()=>{},1e3,E.Texts.battle.enemiesDead);this._game.addEvent(e);const t=new h.OneShotEvent(()=>{},2e3,"Battles in the North will continue soon in larger scale...");this._game.addEvent(t)}}function F(e,t,n,s=1){const r=e.createItem(n);return r.setCount(s),t.getInvEq().addItem(r),r}},function(e,t,n){!function(e){"use strict";function t(t){var n=this!==e?this:{};n.input=t,n.pos=0,n.line=1,n.linePos=0}e.version="0.1.2",e.parse=function(e){return new t(e).grammar()},e.stringify=function e(t){switch(t.type){case"terminal":return'"'+s(t.text)+'"';case"nonterminal":return"<"+s(t.text)+">";case"expression":return t.terms.map(e).join(" ");case"production":return e(t.lhs)+" ::= "+t.rhs.map(e).join(" | ")+";";case"grammar":return t.productions.map(e).join("\n")+"\n"}throw new Error("Unknown node type: "+t.type)},e.Parser=t;var n=t.EOF=-1;function s(e){return e.replace(/\\/g,"\\\\").replace(/\"/g,'\\"').replace(/\n/g,"\\n").replace(/\t/g,"\\t")}t.prototype.error=function(e){throw new SyntaxError(e+" at "+this.line+":"+this.linePos)},t.prototype.peek=function(){return this.pos>=this.input.length?n:this.input[this.pos]},t.prototype.eat=function(e){var t=this.peek();return void 0!==e&&e!==t&&this.error("Expected "+e+", got"+t),t===n?n:(this.pos++,this.linePos++,t)},t.prototype.ws=function(){for(var e,t="";" \n\t".indexOf(e=this.peek())>=0;)"\n"===e&&(this.line++,this.linePos=0),t+=this.eat();return t},t.prototype.escaped=function(){this.eat("\\");var e=this.peek();switch(e){case"n":return this.eat(),"\n";case"t":return this.eat(),"\t";case'"':return this.eat(),'"';case"\\":return this.eat(),"\\"}this.error("Invalid escape sequence: \\"+e)},t.prototype.isChar=function(){var e=this.peek();return e!==n&&(/[a-zA-Z0-9\-_|:=; \/\(\)]/.test(e)||"\\"===e)},t.prototype.text=function(){for(var e="";this.isChar();)"\\"===this.peek()?e+=this.escaped():e+=this.eat();return e},t.prototype.terminal_text=function(){for(var e="",t=this.peek();this.isChar()||"<"===t||">"===t;)e+="\\"===t?this.escaped():this.eat(),t=this.peek();return e},t.prototype.terminal=function(){this.eat('"');var e=this.terminal_text();return this.eat('"'),{type:"terminal",text:e}},t.prototype.nonterminal=function(){this.eat("<");var e=this.text();return this.eat(">"),{type:"nonterminal",text:e}},t.prototype.term=function(){return"<"===this.peek()?this.nonterminal():this.terminal()},t.prototype.expression=function(){var e=[this.term()];for(this.ws();'<"'.indexOf(this.peek())>=0;)e.push(this.term()),this.ws();return{type:"expression",terms:e}},t.prototype.expressions=function(){for(var e=[this.expression()];"|"===this.peek();)this.eat("|"),this.ws(),e.push(this.expression());return e},t.prototype.production=function(){var e=this.nonterminal();this.ws(),this.eat(":"),this.eat(":"),this.eat("="),this.ws();var t=this.expressions();return this.eat(";"),{type:"production",lhs:e,rhs:t}},t.prototype.grammar=function(){var e=[this.production()];for(this.ws();"<"===this.peek();)e.push(this.production()),this.ws();return{type:"grammar",productions:e}}}(t)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QuestGrammar=void 0;const s=n(9).Random.getRNG();t.QuestGrammar={};const r="<Comfort> ::= <Kill_pests>;\n\n<Reputation> ::= <Obtain_rare_items> |\n <Kill_enemies> |\n <Visit_a_dangerous_place>;\n\n<Conquest> ::= <Attack_enemy> | <Steal_stuff>;\n\n<Strategy> ::= <Win_a_battle>\n    | <Survive_a_battle>;",a=`<QUEST> ::= <Conquest> | <Comfort> | <Strategy> | <Reputation>;\n\n${r}\n\n<Kill_pests> ::= <goto> "damage" <goto> "report";\n\n<Obtain_rare_items> ::= <get> <goto> "give";\n<Kill_enemies> ::= <goto> <kill> <goto> "report";\n<Visit_a_dangerous_place> ::= <goto> <goto> "report";\n\n<Attack_enemy> ::= <goto> "damage";\n<Steal_stuff> ::= <goto> <steal> <goto> "give";\n\n<Win_a_battle> ::= <goto> "winbattle";\n<Survive_a_battle> ::= <goto> "finishbattle";\n\n<goto> ::= "<goto>already_there" | "<goto>explore" | <learn> "<goto>goto";\n\n<goto_new_place> ::= "<goto>explore" | <learn> "<goto>goto";\n\n<learn> ::= "<learn>already_know_it" |\n    <goto> "listen" |\n    <goto> <get> "<learn>read" |\n    <get> "give" "listen";\n\n<get> ::= "<get>already_have_it" |\n    <steal> |\n    <goto> "<get>gather";\n\n<steal> ::= <goto> "<steal>stealth" "<steal>take" |\n    <goto> <kill> "<steal>take";\n\n<kill> ::= <goto> "<kill>kill";`,o=/<(\w+)>\s*::=/;const i={Knowledge:180,Comfort:20,Reputation:70,Serenity:140,Protection:180,Conquest:200,Wealth:20,Ability:10,Equipment:180,Strategy:40};t.QuestGrammar.motiveWeights=i;const l=function(e){const t=[];return e.split("\n").forEach(e=>{const n=e.match(o);n&&n.length>1&&t.push(n[1])}),t}(r);t.QuestGrammar.setWeight=function(e,t,n=!1){n&&Object.keys(i).forEach(e=>{i[e]=0}),i[e]=t},t.QuestGrammar.getRandMotive=function(){s.getWeighted(i)},t.QuestGrammar.grammar=a,t.QuestGrammar.actorMotivations=l},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.QuestPopulate=void 0;const i=n(15)("bitn:quest-gen"),l=o(n(4)),c=n(778),u=n(9),h=n(48),d=n(12),p=n(97),f=n(23),m=a(n(39)),g=a(n(11)),y=n(368),v=n(369),b=u.Random.getRNG(),_=f.EventPool.getPool();class E{constructor(e){this.resetData(),this.questList=[],this.conf={maxLength:10,minLength:1,minQuests:1,maxQuests:2,numQuestsPerZone:1},this.maxTriesPerZone=5,this.questTargetCallback={escort:this.handleEscort=this.handleEscort.bind(this),repair:this.handleRepair=this.handleRepair.bind(this),listen:this.handleListen=this.handleListen.bind(this),reportListen:this.handleListen=this.handleListen.bind(this),report:this.handleReport=this.handleReport.bind(this),subquest:this.handleSubQuest=this.handleSubQuest.bind(this)},this.checkImplemented=!0,this.IND=0,this.debug=i.enabled,this.rng=b,e&&e.rng&&(this.rng=e.rng),this.pool=_}resetData(){this.questData={quests:[]},this.questList=[],this._cleanup=[],this.flags={alreadyKnowIt:!1,escort:!1,listen:!1,read:!1,report:!1},this.listOfAllTasks=[],this.currQuest=null,this._data=new Map,this._questCrossRefs=new Map,this.questGivers=new Map}getCurrQuest(){return this.currQuest?this.currQuest:(l.default.err("QuestPopulate","getCurrQuest","currQuest is null!"),new y.QuestData)}setDebug(e){this.debug=e,i.enabled=e}getParentQuestData(){const e=this.questData.quests.indexOf(this.currQuest);return e>0?this.questData.quests[e-1]:null}initQuestPopulDataForQuest(e){this._data.set(e,{actor:[],element:[],escort:[],item:[],listen:[],place:[],read:[],reportListen:[],return:[],zone:[]})}addQuestPopulData(e,t){const n=this.getCurrQuest();if(this._data.has(n)||this.initQuestPopulDataForQuest(this.getCurrQuest()),this._data.get(n).hasOwnProperty(e))this._data.get(n)[e].push(t);else{const t=Object.keys(this._data.get(n)).join(",");l.default.err("QuestPopulate","addQuestPopulData",`Key ${e} not present. Choices: ${t}`)}}getQuestPopulData(e,t=!1){const n=this.getCurrQuest();if(this._data.has(n)){const s=this._data.get(n);if(s.hasOwnProperty(e)&&s[e].length>0){const t=s[e].length;return s[e][t-1]}if(t){const t=this.getParentQuestData();if(t){const n=this._data.get(t);if(n.hasOwnProperty(e)){const t=n[e].length;return n[e][t-1]}}l.default.err("QuestPopulate","getQuestPopulData",`No data for type ${e}. Searched parent also`)}else{const t=Object.keys(s);l.default.err("QuestPopulate","getQuestPopulData",`No data for type ${e}. Keys: ${t}`)}}else l.default.err("QuestPopulate","getQuestPopulData","No data for currQuest exists");return null}createQuests(e,t,n,s){t.isLoaded(n,s)||l.default.err("QuestPopulate","createQuests",`Tried to create quests for unloaded AreaTile[${n}][${s}]!`);const r=t.getTileXY(n,s),a=r.getZones("City");let o=0;return a.forEach(e=>{o+=this.createQuestsForZone(e,r)}),o}createQuestsForZone(e,t){const n=this.conf.numQuestsPerZone||1;let s=0;for(let r=0;r<n;r++)for(let n=0;n<this.maxTriesPerZone;n++){const n=(new v.QuestGen).genQuestWithConf(this.conf);if(this.resetData(),this.mapQuestToResources(n,e,t)){this.addQuestComponents(e),++s;break}}return s}mapQuestToResources(e,t,n){++this.IND,this.currTile=n;const s=new y.QuestData;this.dbg("*** New quest started ****"),e.isQuest()&&(this.dbg("  Quest has "+e.numTasks()+" tasks"),this.dbg("  Quest has "+(e.numQuests()-1)+" sub-quests"));let r=null;if(this.currQuest){const e={createTarget:"createSubQuestTarget",subQuest:s,args:[]};this.dbg("Adding |subquest| target for current quest"),this.currQuest.addTarget("subquest",e),r=this.currQuest.getCurrentLocation()}r&&this.addQuestPopulData("return",r),this.currQuest=s,this.questData.quests.push(this.currQuest);const a=this.rng.arrayGetRand(t.getLevels());this.currQuest.addTarget("location",a);let o=!0;if(e.getSteps().forEach(t=>{const s=this.currQuest.getCurrentLocation();if(t.isQuest()){const e=s.getParentZone();o=o&&this.mapQuestToResources(t,e,n)}else{const r=s.getParentZone();o=o&&this.mapTask(e,t,r,n)}}),o=o&&this._checkQuestFlags(),!o)return this.cleanUpFailedQuest(),--this.IND,!1;this.dbg("Created quest: "+this.currQuest.getDescr());if(this.questData.quests.length>1){this.questList.unshift(this.questData.quests.pop());const e=this.questData.quests.length-1;this.currQuest=this.questData.quests[e]}else this.questList.unshift(this.currQuest);return--this.IND,!0}pushQuestCrossRef(e,t){const n=this.currTaskType;e||l.default.err("QuestPopulate","pushQuestCrossRef",`${n}: Undefined KEY with data ${t}`),t||l.default.err("QuestPopulate","pushQuestCrossRef",`${n}: Undefined DATA with key ${e}`),this._questCrossRefs.has(e)||this._questCrossRefs.set(e,[]),this._questCrossRefs.get(e).push(t)}popQuestCrossRef(e){if(this._questCrossRefs.has(e)){const t=this._questCrossRefs.get(e);if(t.length>0){const n=this._questCrossRefs.get(e).pop();return 0===t.length&&this._questCrossRefs.delete(e),n}}return null}mapTask(e,t,n,s){++this.IND;const r=t.getTaskType();let a=!1;if(this.checkImplemented&&!S.has(r))return!1;if(!this.currQuest)return l.default.err("QuestPopulate","mapTask","currQuest must not be null/undefiend"),!1;switch(this.dbg("Processing taskType |"+r+"|"),this.listOfAllTasks.push(r),this.currTaskType=r,r){case"capture":{const e=this.getActorToCapture();e&&(this.currQuest.addTarget("capture",e),a=!0);break}case"damage":{const e=this.getEntityToDamage();e&&(this.currQuest.addTarget("damage",e),a=!0);break}case"defend":{const e=this.getEntityToDefend();e&&(this.currQuest.addTarget("defend",e),a=!0);break}case"escort":{const e=this.getActorToEscort(s);e&&(this.currQuest.addTarget("escort",e),a=!0,this.addQuestPopulData("escort",e),this.flags.escort=!0);break}case"experiment":{const e=this.getQuestPopulData("item");e&&(this.currQuest.addTarget("experiment",e),a=!0);break}case"<get>already_have_it":{const e=this.getAlreadyOwnedItem();e&&(this.currQuest.addTarget("get",e),a=!0,this.addQuestPopulData("item",e));break}case"<get>gather":{const e=this.getItemToGather();e&&(this.currQuest.addTarget("get",e),a=!0,this.addQuestPopulData("item",e));break}case"<get>exchange":{const e=this.getItemToExchange();e&&(this.currQuest.addTarget("exchange",e),a=!0,this.addQuestPopulData("item",e));break}case"give":{const e=this.currQuest.getCurrentLocation(),t=this.getActorForQuests(e.getActors());t&&(this.currQuest.addTarget("give",t),a=!0);break}case"<goto>already_there":a=!0,this.flags.escort&&(a=!1);break;case"<goto>explore":{const e=this.getNewExploreLocation(n,s);this.currQuest.addTarget("location",e);const t=this.getExploreTarget();if(t&&(this.currQuest.addTarget("explore",t),a=!0,this.flags.read&&(this.flags.read=!1,this.pushQuestCrossRef(this.getQuestPopulData("read"),e)),this.flags.escort)){this.flags.escort=!1;const t=this.getQuestPopulData("escort",!0);this.pushQuestCrossRef(t,e)}break}case"<goto>goto":{const e=this.getNewLocation(n,s);if(this.currQuest.addTarget("location",e),a=!0,this.flags.read&&(this.flags.read=!1,this.pushQuestCrossRef(this.getQuestPopulData("read"),e)),this.flags.listen&&(this.flags.listen=!1,this.pushQuestCrossRef(this.getQuestPopulData("listen"),e)),this.flags.escort){this.flags.escort=!1;const t=this.getQuestPopulData("escort",!0);this.pushQuestCrossRef(t,e)}break}case"<kill>kill":{const e=this.getActorToKill();e&&(this.currQuest.addTarget("kill",e),a=!0);break}case"<learn>already_know_it":this.flags.alreadyKnowIt=!0,a=!0;break;case"listen":{const e=this.getActorToListen();e&&(this.currQuest.addTarget("listen",e),this.flags.listen=!0,this.addQuestPopulData("listen",e),a=!0);break}case"finishbattle":this.currQuest.addTarget("finishbattle",{createTarget:"createBattle",args:[n,s]}),a=!0;break;case"<learn>read":{const e=this.getReadTarget(n,s);e&&(this.addQuestPopulData("read",e),this.flags.read=!0,this.currQuest.addTarget("read",e),a=!0);break}case"repair":{const e=this.getRepairTarget();e&&(this.currQuest.addTarget("repair",e),a=!0);break}case"<report>listen":{const e=this.getActorToListen();e&&(this.currQuest.addTarget("reportListen",e),this.flags.report=!0,this.addQuestPopulData("reportListen",e),a=!0);break}case"report":{const e=this.getActorForReport();if(e&&(this.currQuest.addTarget("report",e),a=!0,this.flags.report)){const t=this.getQuestPopulData("reportListen");this.pushQuestCrossRef(e,t),this.flags.report=!1}break}case"<spy>spy":{const e=this.getActorToSpy();e&&(this.currQuest.addTarget("spy",e),a=!0);break}case"<steal>stealth":a=!0;break;case"<subquest>goto":{const e=this.getQuestPopulData("return");if(e&&(this.currQuest.addTarget("location",e),a=!0,this.flags.escort)){this.flags.escort=!1;const t=this.getQuestPopulData("escort",!0);this.pushQuestCrossRef(t,e)}break}case"<steal>take":{const e=this.getItemToSteal();e&&(this.currQuest.addTarget("get",e),this.addQuestPopulData("item",e),a=!0);break}case"take":{const e=this.getItemToSteal();e&&(this.currQuest.addTarget("get",e),this.addQuestPopulData("item",e),a=!0);break}case"use":{const e=this.getItemToUse();e&&(this.currQuest.addTarget("use",e),a=!0);break}case"winbattle":this.currQuest.addTarget("winbattle",{createTarget:"createBattle",args:[n,s]}),a=!0;break;default:l.default.err("QuestPopulate","mapTask",`Task type ${t.taskType} not supported yet`)}return a||console.warn("QuestPopulate","mapTask",`Failed to map ${t.getTaskType()}, ${JSON.stringify(t)}`),--this.IND,a}getActorForQuests(e){let t=this.rng.arrayGetRand(e),n=20,s=!1;for(;!w(t);)if(t=this.rng.arrayGetRand(e),0==--n){s=!0;break}return s&&l.default.warn("QuestPopulate","getActorForQuests",`No suitable actor found. Using ${t.getName()}. May bring undesirable effects`),t}getActorToKill(){let e=this.currQuest.getCurrentLocation().getActors();return e=e.filter(e=>!e.isPlayer()&&e.hasNone(["QuestGiver","QuestTarget"])),this.rng.arrayGetRand(e)}getActorForReport(){const e=this.currQuest.getCurrentLocation().getActors();return this.getActorForQuests(e)}getActorToSpy(){const e=this.currQuest.getCurrentLocation().getActors();return this.getActorForQuests(e)}getActorToListen(){const e=this.currQuest.getCurrentLocation();return this.getActorForQuests(e.getActors())}getActorToEscort(e){const t=this.currQuest.getCurrentLocation();return this.getActorForQuests(t.getActors())}dbg(e){if(this.debug){const t="==".repeat(this.IND);i(t+e)}}getAlreadyOwnedItem(){const e=this.currQuest.getCurrentLocation().getPlayer();if(e){const t=e.getInvEq().getInventory().getItems();return this.rng.arrayGetRand(t)}return null}getItemToSteal(){const e=this.currQuest.getCurrentLocation(),t=new m.ItemBase(p.Names.getItemToStealName());t.setValue(b.getUniformInt(100,200)),t.setWeight(.1*b.getUniformInt(1,25));let n=h.Placer.addEntityToCellType(t,e,e=>e.hasHouse());return n||(n=h.Placer.addEntityToCellType(t,e,e=>e.isFree())),n?(this._cleanup.push({location:e,item:t,tag:"getItemToSteal"}),t):null}getItemToGather(){const e=this.currQuest.getCurrentLocation(),t=d.ObjectShell.getParser().createRandomItem(e=>"mineral"===e.type&&e.value<=150);return h.Placer.addEntityToCellType(t,e,e=>e.isPassable())?(this._cleanup.push({location:e,item:t,tag:"getItemToGather"}),t):null}getReadTarget(e,t){return{createTarget:"createBook",args:[this.currQuest.getCurrentLocation(),e,t]}}getItemToUse(){const e=this.currQuest.getCurrentLocation(),t=e.getItems().filter(e=>e.hasOwnProperty("useItem"));if(t.length>0)return this.rng.arrayGetRand(t);const n=d.ObjectShell.getParser().createRandomItem(e=>e.use);return h.Placer.addEntityToCellType(n,e,e=>e.isPassable())&&n?(this._cleanup.push({location:e,item:n,tag:"getItemToUse"}),n):null}getRepairTarget(){const e=this.currQuest.getCurrentLocation().getElements().filter(e=>"door"===e.getType()||"leverdoor"===e.getType()||"lever"===e.getType());if(e.length>0){return this.rng.arrayGetRand(e)}return null}getEntityToDamage(){const e=this.currQuest.getCurrentLocation(),t=e.getElements().filter(e=>"door"===e.getType());if(t){return this.rng.arrayGetRand(t)}const n=e.getActors();return n.length>0?this.rng.arrayGetRand(n):null}getEntityToDefend(){const e=this.currQuest.getCurrentLocation().getActors();return e.length>0?this.rng.arrayGetRand(e):null}getActorToCapture(){const e=this.currQuest.getCurrentLocation().getActors();return this.getActorForQuests(e)}getItemToExchange(){const e=this.currQuest.getCurrentLocation().getElements().filter(e=>"shop"===e.getType());for(this.rng.shuffle(e);e.length>0;){const t=e[0].getCell();if(t.hasItems()){const e=t.getItems().filter(e=>e.has("Unpaid"));if(e.length>0)return e[0]}e.shift()}return null}getNewLocation(e,t){this.flags.alreadyKnowIt&&(this.flags.alreadyKnowIt=!1);let n=t.getZones();n=n.filter(e=>"battlezone"!==e.getType());const[s,r]=e.getTileXY(),a=n.filter(e=>{const t=e.getTileXY(),[n,a]=l.default.dXdY([s,r],t);return n<=10&&a<=10});a.length>1&&(n=a);let o=this.rng.arrayGetRand(n);if(n.length>1)for(;o.getID()===e.getID();)o=this.rng.arrayGetRand(n);return this.addQuestPopulData("zone",o),this.rng.arrayGetRand(o.getLevels())}getNewExploreLocation(e,t){const n=t.getZones("Dungeon"),s=t.getZones("Mountain"),r=n.concat(s),a=new c.RandomCyclic(r);if(r.length>0){let t=a.next(),n=20;for(;t.getID()===e.getID()&&(t=a.next(),0!=--n););return this.addQuestPopulData("zone",t),t.getLevels()[0]}return null}getExploreTarget(){const e=this.getQuestPopulData("zone").getLevels();let t=null;return e.forEach(e=>{if(!t){const n=e.getElements();t=n.find(e=>"exploration"===e.getType())}}),t}addQuestComponents(e){for(let t=this.questList.length-1;t>=0;t--){const n=this.questList[t];n.resetIter(),n.keys().forEach(e=>{if(E.legalKeys.has(e)){let t=n.next(e);for(;t;){if(l.default.isEntity(t))this.setAsQuestTarget(e,t);else if(t.createTarget){const{createTarget:s,args:r}=t;"function"!=typeof this[s]&&l.default.err("QuestPopulate","addQuestComponents",s+" not a func in QuestPopulate");const a=this[s](t,...r);this.setAsQuestTarget(e,a),n.replaceTarget(e,t,a)||l.default.err("QuestPopulate","addQuestComponents","Failed to repl obj for "+s)}t=n.next(e)}}else l.default.err("QuestPopulate","addQuestComponents",`Unsupported key |${e}| found`)});const s=this.rng.arrayGetRand(e.getLevels()),r=this.getActorForQuests(s.getActors()),a=new g.QuestGiver(n.getDescr());this.addTargetsToGiver(a,n),a.setReward({type:"generate"}),r.add(a),this.addUniqueName(r);const o={topic:"quests",respMsg:r.getName()+" could have some work for you",revealNames:[r.getName()],revealIds:[r.getID()]};s.get("Lore").addEntry(o);const i=r;this.questGivers.set(n,i)}}addTargetsToGiver(e,t){const n=e.getQuestID();this.dbg("addTargetsToGiver now, ID "+n),++this.IND;t.getPathTargets().forEach(t=>{if(l.default.isEntity(t)){const s=t;this._checkTargetValidity(s);const r=s.get("QuestTarget");if(r){const[t,s]=[r.getTarget(),r.getTargetType()];e.addTarget(s,t),r.setQuestID(n)}else{const e=JSON.stringify(t);l.default.err("QuestPopulate","addTargetsToGiver","No QuestTarget found from target "+e)}}}),--this.IND}_checkTargetValidity(e){if(!l.default.isEntity(e)){const t="Non-Entity given: "+JSON.stringify(e);l.default.err("QuestPopulate","_checkTargetValidity",t)}}setAsQuestTarget(e,t){if(!t){const t=`Null/undef target with key |${e}|`;l.default.err("QuestPopulate","setAsQuestTarget",t)}if("function"!=typeof t.getID){let n=`questTarget without getID() given with key ${e}:`;n+=" "+JSON.stringify(t),l.default.err("QuestPopulate","setAsQuestTarget",n)}const n=g.create("QuestTarget");n.setTargetType(e),n.setTarget(t),n.setTargetID(t.getID()),t.add(n),(l.default.isActor(t)||l.default.isItem(t))&&this.addUniqueName(t),this.questTargetCallback[e]&&this.questTargetCallback[e](t)}handleEscort(e){const t=this.popQuestCrossRef(e);if(t){const n=g.create("QuestEscortTarget");n.setEscortTo(t),e.add(n)}else this.dumpInternalData("handleEscort"),this.errorQuestHandle(e,"handleEscort")}handleRepair(e){e.add(g.create("Broken"))}handleListen(e){const t=g.create("QuestInfo");t.setQuestion("Can you tell me something to report?"),t.setInfo("Generate something to report"),t.setGivenBy(e.getID()),e.add(t)}handleReport(e){const t=g.create("QuestReport"),n=this.popQuestCrossRef(e);n&&t.setExpectInfoFrom(n.getID()),e.add(t)}handleSubQuest(e){const t=e.get("QuestTarget"),n=e.get("QuestGiver");if(t&&n)t.setSubQuestID(n.getQuestID());else{const t=JSON.stringify(e);l.default.err("QuestPopulate","handleSubQuest","Target must have QuestTarget + Giver comps: "+t)}}addUniqueName(e){if(!e.has("Named")){const t=g.create("Named");e.getName&&t.setName(e.getName()),e.add(t)}const t=e.get("Named");if(l.default.isActor(e)){t.setUniqueName(p.Names.getActorName());const n=e.getName(),s=n[0];l.default.addCharStyle(l.default.TYPE_ACTOR,n,s),l.default.addCellStyle(l.default.TYPE_ACTOR,n,"cell-actor-unique")}else if(l.default.isItem(e)){const e="Quest item "+this.rng.getUniformInt(0,1e6);t.setUniqueName(e)}}createBattle(e,t,n){const s=n.getZones("BattleZone");if(s.length>0){return this.rng.arrayGetRand(s).getLevels()[0]}{const e={areaTile:n,zone:t};if(this.pool.emitEvent(l.default.EVT_CREATE_BATTLE,e),e.response){console.log("createBattle return eventArgs.response.level");const{battle:t}=e.response;if(t)return t.getLevel()}else l.default.err("QuestPopulate","createBattle","No response in eventArgs for EVT_CREATE_BATTLE")}return null}createBook(e,t){const n=new m.Book(p.Names.getBookName()),s=this.popQuestCrossRef(e);if(s){t.addItem(n);const e=l.default.formatLocationName(s),r=["To proceed on your quest:"];return r.push("You should go to place called "+e),n.setText(r),n.addMetaData("place",{levelID:s.getID(),name:e}),n}{const e=JSON.stringify(this._questCrossRefs);l.default.err("QuestPopulate","createBook","No cross-refs set for book. refs: "+e)}return null}createSubQuestTarget(e){const{subQuest:t}=e;return this.questGivers.get(t)}_checkQuestFlags(){let e=!0;return Object.keys(this.flags).forEach(t=>{!1!==this.flags[t]&&(e=!1,console.log("Flag ",t,"still true!"))}),e}cleanUpFailedQuest(){let e=0;this._cleanup.forEach(t=>{const{location:n}=t;let s=!1,r=null;if(t.item){const[e,a]=t.item.getXY();r=t.item;try{s=n.removeItem(t.item,e,a)}catch(s){const{tag:r}=t,o=t.item.getName(),i=n.getItems().map(e=>e.toString());let c=`Failed to cleanup item ${o} @ ${e},${a}`;r&&(c+="\nTag specified: |"+r+"|"),c+="\n"+s.message,c+="\nItems at loc: "+i,l.default.err("QuestPopulate","cleanUpFailedQuest",c)}}else if(t.actor){const[e,a]=t.actor.getXY();s=n.removeActor(t.actor),r=t.actor}else if(t.element){const[e,a]=t.element.getXY();s=n.removeElement(t.element,e,a),r=t.element}s&&++e}),e!==this._cleanup.length&&l.default.warn("QuestPopulate","cleanUpFailedQuest","Did not remove all quest items for failed quest"),this._cleanup=[]}errorQuestHandle(e,t){let n="Failed to get location for escort: ";n+="\n\ttarget: "+e.getName(),n+="\n\tcrossRefs: "+JSON.stringify(Object.values(this._questCrossRefs.entries())),l.default.err("QuestPopulate",t,n)}dumpInternalData(e){"undefined"!=typeof window&&(window.QUEST_GEN=this)}}t.QuestPopulate=E;const S=new Set(["damage","escort","<get>gather","give","<kill>kill","<goto>already_there","<goto>explore","<goto>goto","<learn>already_know_it","<learn>read","listen","<report>listen","report","<steal>stealth","<steal>take","take","<subquest>goto","finishbattle","winbattle"]);function w(e){return e.has("Corporeal")&&l.default.ALL_RACES.indexOf(e.getType())>=0&&!(e.isPlayer()||e.has("QuestTarget")||e.has("QuestGiver"))}E.legalKeys=new Set(["defend","capture","explore","kill","location","listen","give","report","reportListen","get","steal","use","repair","damage","winbattle","finishbattle","escort","spy","exchange","read","experiment","subquest"])},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RandomCyclic=void 0;const r=s(n(4)),a=n(9).Random.getRNG();t.RandomCyclic=class{constructor(e){e&&0!==e.length||r.default.err("RandomCyclic","new","array with length > 0 must be given"),this.arr=e,this.reset(),this.length=e.length}reset(){this.indicesLeft=[],this.arr.forEach((e,t)=>{this.indicesLeft.push(t)}),this._prevValue=null,this._currValue=null}prev(){return this._prevValue}next(){0===this.indicesLeft.length&&this.reset();const e=a.arrayGetRand(this.indicesLeft);return this.indicesLeft=this.indicesLeft.filter(t=>t!==e),this._prevValue=this._currValue,this._currValue=this.arr[e],this._currValue}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LevelFactory=void 0;const r=n(363),a=n(365),o=n(364),i=n(366),l=s(n(4));class c{constructor(e){this.fact=e,this.createFunc={}}addFunction(e,t){this.createFunc[e]=t}create(e,t){if(c.levels.hasOwnProperty(e)){const n=c.levels[e](...t);return Array.isArray(n)?n:[{level:n,nLevel:0}]}if(this.createFunc.hasOwnProperty(e)){const n=this.createFunc[e](...t);return Array.isArray(n)?n:[{level:n,nLevel:0}]}if(this.fact){return[{level:this.fact.createLevel(e,...t),nLevel:0}]}return l.default.err("LevelFactory","create","No factory/factory function given. Name: "+e),null}}t.LevelFactory=c,c.levels={Capital:(...e)=>new o.Capital(...e).getLevel(),DwarvenCity:(...e)=>new i.DwarvenCity(...e).getLevel(),AbandonedFort:(...e)=>new r.AbandonedFort(...e).getLevel(),BlackTower:(...e)=>new a.BlackTower(...e).getLevels()}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DungeonFeatures=void 0;const i=o(n(4)),l=a(n(47)),c=n(16),u=n(9),h=n(12),d=n(27),p=u.Random.getRNG();t.DungeonFeatures=class{constructor(e){this._verif=new l.Conf("DungeonFeatures"),this._zoneType=e}addLastLevelFeatures(e,t,n){this._verif.verifyConf("addLastLevelFeatures",n,["maxDanger","maxValue"]);const s=new c.ElementExploration,r=10*(e+1)*n.maxDanger;Number.isInteger(r)||i.default.err("DungeonFeatures","addLastLevelFeatures",`expPoints NaN. nLevel: ${e}, dang: ${n.maxDanger}`),s.setExp(r),s.setData({zoneType:this._zoneType});const a=t.getParent();a&&a.getName&&s.addData("zoneName",a.getName());const o=t.getExtras();if(o&&o.endPoint){const[e,n]=o.endPoint;t.addElement(s,e,n)}else{const e=t.getFreeRandCell();if(e){const[n,r]=e.getXY();t.addElement(s,n,r)}else i.default.err("DungeonFeatures","addLastLevelFeatures","Failed to find a free cell for ending element")}const l=this.generateBoss(e,t,n);if(l)this.addMinions(l,e,t,n);else{let n="Failed to created boss. nLevel: "+e;n+=" Level parent: "+t.getParent(),i.default.debug({},n)}}generateBoss(e,t,n){this._verif.verifyConf("generateBoss",n,["maxDanger","maxValue"]);const s=h.ObjectShell.getParser(),r=n.maxDanger+2,a=s.createRandomActor({func:e=>e.danger<=r&&e.danger>=n.maxDanger});if(a){t.addActorToFreeCell(a);const e=2*n.maxValue,r=s.createRandomItem({func:t=>t.value<=e});if(r)a.getInvEq().addItem(r);else{const t="Value: "+e;i.default.err("DungeonFeatures","generateBoss","Failed to create prize item: "+t)}}return a}addMinions(e,t,n,s){const r=h.ObjectShell.getParser(),a=e.getType(),o=p.getUniform()<=.5;let i=t+1,l=s.maxDanger;o&&(i*=2,l-=1);const c=Math.round(Math.sqrt(i))+1,u=d.Brain.getBoxOfFreeCellsAround(e,c);p.shuffle(u);const f=e=>e.danger<=l&&e.type===a;for(;u.length>0&&i>0;){const e=u.pop();--i;const t=r.createRandomActor({func:f});if(t){const[s,r]=[e.getX(),e.getY()];n.addActor(t,s,r)}}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WinCondition=void 0;const r=s(n(4));t.WinCondition=class{constructor(e,t){this._name=e,this.description="",this._condIncomplete={},this._condFilled={},this.pool=t,this._isTrue=!1,this.hasNotify=!0,this._notifyCallbacks={[r.default.EVT_ACTOR_KILLED]:this.actorKilledCallback.bind(this)}}getName(){return this._name}setPool(e){e!==this.pool&&this.pool.isListener(this)&&this.pool.removeListener(this),this.pool=e}isTrue(){return this._isTrue}addNotifyCallback(e,t){this._notifyCallbacks[e]=t}notify(e,t){this._notifyCallbacks.hasOwnProperty(e)&&this._notifyCallbacks[e](t),this._isTrue||0===Object.keys(this._condIncomplete).length&&(this._isTrue=!0,this.onTrue())}_addEvent(e){this.pool.listenEvent(e,this)}addActorKilled(e){this._addEvent(r.default.EVT_ACTOR_KILLED),this._condIncomplete[r.default.EVT_ACTOR_KILLED]=[e.getID()]}onTrue(){let e=`Condition: ${this._name}, Description: ${this.description}.`;e+="Congratulations. You have won!",r.default.gameSuccess(e),this.pool.emitEvent(r.default.EVT_WIN_COND_TRUE,{name:this._name})}actorKilledCallback(e){const t=e.actor,n=this._condIncomplete[r.default.EVT_ACTOR_KILLED];if(n){const e=n.indexOf(t.getID());e>=0&&(n.splice(e,1),0===n.length&&delete this._condIncomplete[r.default.EVT_ACTOR_KILLED])}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Disposition=void 0;const r=s(n(4)),a=n(9).Random.getRNG();t.Disposition=class{constructor(e,t){this.rivals=e,this.conf=Object.assign({},t),this.weights={default:{ally:20,neutral:50,enemy:30}}}setWeights(e){this.weights=e}addWeight(e,t){this.weights[e]=t}getTable(){return this.dispTable}_initTable(){this.dispTable={},this.rivals.forEach(e=>{this.dispTable[e]={}})}randomize(){this._initTable(),this.rivals.forEach(e=>{this.rivals.forEach(t=>{if(!this.pairDone(e,t)){const n=this.getWeights(e,t),s=a.getWeighted(n);this.dispTable[e][t]=s,this.dispTable[t][e]=s}})})}getWeights(e,t){return this.weights.hasOwnProperty(e)?this.weights[e]:this.weights.hasOwnProperty(t)?this.weights[t]:this.weights.default}pairDone(e,t){return e===t||!!this.dispTable[e][t]&&(this.dispTable[t][e]||r.default.err("Disposition","pairDone","Something went wrong. No [r2][r1] but [r1][r2] exists"),!0)}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.OWLore=void 0;const r=s(n(4)),a=n(245),o=n(9),i=n(15)("bitn:ow-lore"),l=o.Random.getRNG();t.OWLore=class{constructor(){this.hasInfoAbout={},this.isKnownBy={},this.xyVisited={},this.zonesByXY={},this.nZones=0,this.nAddedCompsTo=0}getKey(e){return e[0]+","+e[1]}toCoord(e){const t=e.split(",");return[parseInt(t[0],10),parseInt(t[1],10)]}addVisited(e){this.xyVisited[this.getKey(e)]=!0}isVisited(e){return this.xyVisited[this.getKey(e)]}addXYKnownBy(e,t){const n=this.getKey(e),s=this.getKey(t);this.isKnownBy[n]||(this.isKnownBy[n]=[]),this.isKnownBy[n].push(t),this.hasInfoAbout[s]||(this.hasInfoAbout[s]=[]),this.hasInfoAbout[s].push(e)}hasInfoAboutXY(e){return this.hasInfoAbout.hasOwnProperty(this.getKey(e))}addZone(e,t){const n=this.getKey(e);this.zonesByXY[n]||(this.zonesByXY[n]=[]),this.zonesByXY[n].push(t),++this.nZones,i(`addZone ${t.name} to ${n}, nZones: ${this.nZones}`)}buildLore(){Object.keys(this.zonesByXY).forEach(e=>{const t=this.zonesByXY[e],n=this.toCoord(e);this.hasInfoAboutXY(n)&&(t.forEach(t=>{let s=this.hasInfoAbout[e];s=[l.arrayGetRand(s)],s.forEach(e=>{const s=e,o=this.zonesByXY[this.getKey(s)];o&&o.forEach(e=>{const o=e,l=r.default.getTextualDir(s,n),c=this.formatRespMsg(l,o),u=this.getZoneMeta(o),h=a.createLoreObj(c,"sideQuest",u);t.addComp?t.addComp.push(h):t.addComp=[h],++this.nAddedCompsTo,i.enabled&&this.dbg("knowerZone:",t.name,t.x,t.y,JSON.stringify(t.addComp))})})}),t.forEach(t=>{const s=t.isEpic;let o=this.isKnownBy[e];o.length>2&&(o=[l.arrayGetRand(o),l.arrayGetRand(o)]),o.forEach(e=>{const o=this.getKey(e),l=this.zonesByXY[o];l&&l.forEach(o=>{const l=o,c=r.default.getTextualDir(n,e);let u=this.formatRespMsg(c,t);s&&(u+=" They say a great adventure awaits there.");const h=this.getZoneMeta(t),d=a.createLoreObj(u,"location",h);l.addComp?l.addComp.push(d):l.addComp=[d],++this.nAddedCompsTo,i.enabled&&this.dbg("knowerZone:",l.name,l.x,l.y,JSON.stringify(l.addComp))})})}))}),i(`buildLore END. ${this.nAddedCompsTo}/${this.nZones} zones have addComp`)}formatRespMsg(e,t){const n=a.Lore.getRandText("typesDirections"),s=this.getNamePre(t),r=this.getNamePost(t);return a.formatMsg(n,{dir:e,name:t.name,namePre:s,namePost:r})}getNamePre(e){return e.isEpic?"an ancient place called ":""}getNamePost(e){return r.default.isSuccess(.05)?" where shadows lie":""}debugPrint(){i.enabled=!0,i(this.zonesByXY),i.enabled=!1}getZoneMeta(e){const{name:t,x:n,y:s,levelX:r,levelY:a,owX:o,owY:i}=e;return{name:t,x:n,y:s,levelX:r,levelY:a,owX:o,owY:i}}toString(){return"OverWorld Lore:\n"}dbg(...e){i(...e)}}},function(e,t,n){e.exports=function e(t,n,s){function r(o,i){if(!n[o]){if(!t[o]){if(a)return a(o,!0);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}var c=n[o]={exports:{}};t[o][0].call(c.exports,(function(e){return r(t[o][1][e]||e)}),c,c.exports,e,t,n,s)}return n[o].exports}for(var a=!1,o=0;o<s.length;o++)r(s[o]);return r}({1:[function(e,t,n){"use strict";var s=e("fs"),r=e("path"),a=e("./utils"),o=!1,i=e("../package.json").version,l=["delimiter","scope","context","debug","compileDebug","client","_with","rmWhitespace","strict","filename","async"],c=l.concat("cache"),u=/^\uFEFF/;function h(e,t){var r,a,o=t.views,i=/^[A-Za-z]+:\\|^\//.exec(e);if(i&&i.length)r=n.resolveInclude(e.replace(/^\/*/,""),t.root||"/",!0);else if(t.filename&&(a=n.resolveInclude(e,t.filename),s.existsSync(a)&&(r=a)),r||Array.isArray(o)&&o.some((function(t){return a=n.resolveInclude(e,t,!0),s.existsSync(a)}))&&(r=a),!r)throw new Error('Could not find the include file "'+t.escapeFunction(e)+'"');return r}function d(e,t){var s,r=e.filename,a=arguments.length>1;if(e.cache){if(!r)throw new Error("cache option requires a filename");if(s=n.cache.get(r))return s;a||(t=f(r).toString().replace(u,""))}else if(!a){if(!r)throw new Error("Internal EJS error: no file name or template provided");t=f(r).toString().replace(u,"")}return s=n.compile(t,e),e.cache&&n.cache.set(r,s),s}function p(e,t,s){var r;if(!s){if("function"==typeof n.promiseImpl)return new n.promiseImpl((function(n,s){try{n(r=d(e)(t))}catch(e){s(e)}}));throw new Error("Please provide a callback function")}try{r=d(e)(t)}catch(e){return s(e)}s(null,r)}function f(e){return n.fileLoader(e)}function m(e,t,n,s,r){var a=t.split("\n"),o=Math.max(s-3,0),i=Math.min(a.length,s+3),l=r(n),c=a.slice(o,i).map((function(e,t){var n=t+o+1;return(n==s?" >> ":"    ")+n+"| "+e})).join("\n");throw e.path=l,e.message=(l||"ejs")+":"+s+"\n"+c+"\n\n"+e.message,e}function g(e){return e.replace(/;(\s*$)/,"$1")}function y(e,t){t=t||{};var s={};this.templateText=e,this.mode=null,this.truncate=!1,this.currentLine=1,this.source="",this.dependencies=[],s.client=t.client||!1,s.escapeFunction=t.escape||t.escapeFunction||a.escapeXML,s.compileDebug=!1!==t.compileDebug,s.debug=!!t.debug,s.filename=t.filename,s.openDelimiter=t.openDelimiter||n.openDelimiter||"<",s.closeDelimiter=t.closeDelimiter||n.closeDelimiter||">",s.delimiter=t.delimiter||n.delimiter||"%",s.strict=t.strict||!1,s.context=t.context,s.cache=t.cache||!1,s.rmWhitespace=t.rmWhitespace,s.root=t.root,s.outputFunctionName=t.outputFunctionName,s.localsName=t.localsName||n.localsName||"locals",s.views=t.views,s.async=t.async,s.destructuredLocals=t.destructuredLocals,s.legacyInclude=void 0===t.legacyInclude||!!t.legacyInclude,s.strict?s._with=!1:s._with=void 0===t._with||t._with,this.opts=s,this.regex=this.createRegex()}n.cache=a.cache,n.fileLoader=s.readFileSync,n.localsName="locals",n.promiseImpl=new Function("return this;")().Promise,n.resolveInclude=function(e,t,n){var s=r.dirname,a=r.extname,o=(0,r.resolve)(n?t:s(t),e);return a(e)||(o+=".ejs"),o},n.compile=function(e,t){return t&&t.scope&&(o||(console.warn("`scope` option is deprecated and will be removed in EJS 3"),o=!0),t.context||(t.context=t.scope),delete t.scope),new y(e,t).compile()},n.render=function(e,t,n){var s=t||{},r=n||{};return 2==arguments.length&&a.shallowCopyFromList(r,s,l),d(r,e)(s)},n.renderFile=function(){var e,t,n,s=Array.prototype.slice.call(arguments),r=s.shift(),o={filename:r};return"function"==typeof arguments[arguments.length-1]&&(e=s.pop()),s.length?(t=s.shift(),s.length?a.shallowCopy(o,s.pop()):(t.settings&&(t.settings.views&&(o.views=t.settings.views),t.settings["view cache"]&&(o.cache=!0),(n=t.settings["view options"])&&a.shallowCopy(o,n)),a.shallowCopyFromList(o,t,c)),o.filename=r):t={},p(o,t,e)},n.Template=y,n.clearCache=function(){n.cache.reset()},y.modes={EVAL:"eval",ESCAPED:"escaped",RAW:"raw",COMMENT:"comment",LITERAL:"literal"},y.prototype={createRegex:function(){var e="(<%%|%%>|<%=|<%-|<%_|<%#|<%|%>|-%>|_%>)",t=a.escapeRegExpChars(this.opts.delimiter),n=a.escapeRegExpChars(this.opts.openDelimiter),s=a.escapeRegExpChars(this.opts.closeDelimiter);return e=e.replace(/%/g,t).replace(/</g,n).replace(/>/g,s),new RegExp(e)},compile:function(){var e,t,n,s=this.opts,o="",i="",l=s.escapeFunction;if(!this.source){if(this.generateSource(),o+='  var __output = "";\n  function __append(s) { if (s !== undefined && s !== null) __output += s }\n',s.outputFunctionName&&(o+="  var "+s.outputFunctionName+" = __append;\n"),s.destructuredLocals&&s.destructuredLocals.length){for(var c="  var __locals = ("+s.localsName+" || {}),\n",u=0;u<s.destructuredLocals.length;u++){var p=s.destructuredLocals[u];u>0&&(c+=",\n  "),c+=p+" = __locals."+p}o+=c+";\n"}!1!==s._with&&(o+="  with ("+s.localsName+" || {}) {\n",i+="  }\n"),i+="  return __output;\n",this.source=o+this.source+i}e=s.compileDebug?"var __line = 1\n  , __lines = "+JSON.stringify(this.templateText)+"\n  , __filename = "+(s.filename?JSON.stringify(s.filename):"undefined")+";\ntry {\n"+this.source+"} catch (e) {\n  rethrow(e, __lines, __filename, __line, escapeFn);\n}\n":this.source,s.client&&(e="escapeFn = escapeFn || "+l.toString()+";\n"+e,s.compileDebug&&(e="rethrow = rethrow || "+m.toString()+";\n"+e)),s.strict&&(e='"use strict";\n'+e),s.debug&&console.log(e),s.compileDebug&&s.filename&&(e=e+"\n//# sourceURL="+s.filename+"\n");try{if(s.async)try{n=new Function("return (async function(){}).constructor;")()}catch(e){throw e instanceof SyntaxError?new Error("This environment does not support async/await"):e}else n=Function;t=new n(s.localsName+", escapeFn, include, rethrow",e)}catch(e){throw e instanceof SyntaxError&&(s.filename&&(e.message+=" in "+s.filename),e.message+=" while compiling ejs\n\n",e.message+="If the above error is not helpful, you may want to try EJS-Lint:\n",e.message+="https://github.com/RyanZim/EJS-Lint",s.async||(e.message+="\n",e.message+="Or, if you meant to create an async function, pass `async: true` as an option.")),e}var f=s.client?t:function(e){return t.apply(s.context,[e||{},l,function(t,n){var r=a.shallowCopy({},e);return n&&(r=a.shallowCopy(r,n)),function(e,t){var n=a.shallowCopy({},t);return n.filename=h(e,n),d(n)}(t,s)(r)},m])};if(f.dependencies=this.dependencies,s.filename&&"function"==typeof Object.defineProperty){var g=s.filename,y=r.basename(g,r.extname(g));try{Object.defineProperty(f,"name",{value:y,writable:!1,enumerable:!1,configurable:!0})}catch(e){}}return f},generateSource:function(){var e=this.opts;e.rmWhitespace&&(this.templateText=this.templateText.replace(/[\r\n]+/g,"\n").replace(/^\s+|\s+$/gm,"")),this.templateText=this.templateText.replace(/[ \t]*<%_/gm,"<%_").replace(/_%>[ \t]*/gm,"_%>");var t=this,s=this.parseTemplateText(),r=this.opts.delimiter,o=this.opts.openDelimiter,i=this.opts.closeDelimiter;s&&s.length&&s.forEach((function(l,c){var d,p,m,g,v,b;if(0===l.indexOf(o+r)&&0!==l.indexOf(o+r+r)&&(p=s[c+2])!=r+i&&p!="-"+r+i&&p!="_"+r+i)throw new Error('Could not find matching close tag for "'+l+'".');if(e.legacyInclude&&(m=l.match(/^\s*include\s+(\S+)/))&&(d=s[c-1])&&(d==o+r||d==o+r+"-"||d==o+r+"_"))return g=a.shallowCopy({},t.opts),v=function(e,t){var n,s,r=a.shallowCopy({},t);s=f(n=h(e,r)).toString().replace(u,""),r.filename=n;var o=new y(s,r);return o.generateSource(),{source:o.source,filename:n,template:s}}(m[1],g),b=t.opts.compileDebug?"    ; (function(){\n      var __line = 1\n      , __lines = "+JSON.stringify(v.template)+"\n      , __filename = "+JSON.stringify(v.filename)+";\n      try {\n"+v.source+"      } catch (e) {\n        rethrow(e, __lines, __filename, __line, escapeFn);\n      }\n    ; }).call(this)\n":"    ; (function(){\n"+v.source+"    ; }).call(this)\n",t.source+=b,void t.dependencies.push(n.resolveInclude(m[1],g.filename));t.scanLine(l)}))},parseTemplateText:function(){for(var e,t=this.templateText,n=this.regex,s=n.exec(t),r=[];s;)0!==(e=s.index)&&(r.push(t.substring(0,e)),t=t.slice(e)),r.push(s[0]),t=t.slice(s[0].length),s=n.exec(t);return t&&r.push(t),r},_addOutput:function(e){if(this.truncate&&(e=e.replace(/^(?:\r\n|\r|\n)/,""),this.truncate=!1),!e)return e;e=(e=(e=(e=e.replace(/\\/g,"\\\\")).replace(/\n/g,"\\n")).replace(/\r/g,"\\r")).replace(/"/g,'\\"'),this.source+='    ; __append("'+e+'")\n'},scanLine:function(e){var t,n=this.opts.delimiter,s=this.opts.openDelimiter,r=this.opts.closeDelimiter;switch(t=e.split("\n").length-1,e){case s+n:case s+n+"_":this.mode=y.modes.EVAL;break;case s+n+"=":this.mode=y.modes.ESCAPED;break;case s+n+"-":this.mode=y.modes.RAW;break;case s+n+"#":this.mode=y.modes.COMMENT;break;case s+n+n:this.mode=y.modes.LITERAL,this.source+='    ; __append("'+e.replace(s+n+n,s+n)+'")\n';break;case n+n+r:this.mode=y.modes.LITERAL,this.source+='    ; __append("'+e.replace(n+n+r,n+r)+'")\n';break;case n+r:case"-"+n+r:case"_"+n+r:this.mode==y.modes.LITERAL&&this._addOutput(e),this.mode=null,this.truncate=0===e.indexOf("-")||0===e.indexOf("_");break;default:if(this.mode){switch(this.mode){case y.modes.EVAL:case y.modes.ESCAPED:case y.modes.RAW:e.lastIndexOf("//")>e.lastIndexOf("\n")&&(e+="\n")}switch(this.mode){case y.modes.EVAL:this.source+="    ; "+e+"\n";break;case y.modes.ESCAPED:this.source+="    ; __append(escapeFn("+g(e)+"))\n";break;case y.modes.RAW:this.source+="    ; __append("+g(e)+")\n";break;case y.modes.COMMENT:break;case y.modes.LITERAL:this._addOutput(e)}}else this._addOutput(e)}this.opts.compileDebug&&t&&(this.currentLine+=t,this.source+="    ; __line = "+this.currentLine+"\n")}},n.escapeXML=a.escapeXML,n.__express=n.renderFile,e.extensions&&(e.extensions[".ejs"]=function(e,t){console.log("Deprecated: this API will go away in EJS v2.8");var s=t||e.filename,r={filename:s,client:!0},a=f(s).toString(),o=n.compile(a,r);e._compile("module.exports = "+o.toString()+";",s)}),n.VERSION=i,n.name="ejs","undefined"!=typeof window&&(window.ejs=n)},{"../package.json":6,"./utils":2,fs:3,path:4}],2:[function(e,t,n){"use strict";var s=/[|\\{}()[\]^$+*?.]/g;n.escapeRegExpChars=function(e){return e?String(e).replace(s,"\\$&"):""};var r={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&#34;","'":"&#39;"},a=/[&<>'"]/g;function o(e){return r[e]||e}n.escapeXML=function(e){return null==e?"":String(e).replace(a,o)},n.escapeXML.toString=function(){return Function.prototype.toString.call(this)+';\nvar _ENCODE_HTML_RULES = {\n      "&": "&amp;"\n    , "<": "&lt;"\n    , ">": "&gt;"\n    , \'"\': "&#34;"\n    , "\'": "&#39;"\n    }\n  , _MATCH_HTML = /[&<>\'"]/g;\nfunction encode_char(c) {\n  return _ENCODE_HTML_RULES[c] || c;\n};\n'},n.shallowCopy=function(e,t){for(var n in t=t||{})e[n]=t[n];return e},n.shallowCopyFromList=function(e,t,n){for(var s=0;s<n.length;s++){var r=n[s];void 0!==t[r]&&(e[r]=t[r])}return e},n.cache={_data:{},set:function(e,t){this._data[e]=t},get:function(e){return this._data[e]},remove:function(e){delete this._data[e]},reset:function(){this._data={}}}},{}],3:[function(e,t,n){},{}],4:[function(e,t,n){(function(e){function t(e,t){for(var n=0,s=e.length-1;s>=0;s--){var r=e[s];"."===r?e.splice(s,1):".."===r?(e.splice(s,1),n++):n&&(e.splice(s,1),n--)}if(t)for(;n--;n)e.unshift("..");return e}function s(e,t){if(e.filter)return e.filter(t);for(var n=[],s=0;s<e.length;s++)t(e[s],s,e)&&n.push(e[s]);return n}n.resolve=function(){for(var n="",r=!1,a=arguments.length-1;a>=-1&&!r;a--){var o=a>=0?arguments[a]:e.cwd();if("string"!=typeof o)throw new TypeError("Arguments to path.resolve must be strings");o&&(n=o+"/"+n,r="/"===o.charAt(0))}return(r?"/":"")+(n=t(s(n.split("/"),(function(e){return!!e})),!r).join("/"))||"."},n.normalize=function(e){var a=n.isAbsolute(e),o="/"===r(e,-1);return(e=t(s(e.split("/"),(function(e){return!!e})),!a).join("/"))||a||(e="."),e&&o&&(e+="/"),(a?"/":"")+e},n.isAbsolute=function(e){return"/"===e.charAt(0)},n.join=function(){var e=Array.prototype.slice.call(arguments,0);return n.normalize(s(e,(function(e,t){if("string"!=typeof e)throw new TypeError("Arguments to path.join must be strings");return e})).join("/"))},n.relative=function(e,t){function s(e){for(var t=0;t<e.length&&""===e[t];t++);for(var n=e.length-1;n>=0&&""===e[n];n--);return t>n?[]:e.slice(t,n-t+1)}e=n.resolve(e).substr(1),t=n.resolve(t).substr(1);for(var r=s(e.split("/")),a=s(t.split("/")),o=Math.min(r.length,a.length),i=o,l=0;l<o;l++)if(r[l]!==a[l]){i=l;break}var c=[];for(l=i;l<r.length;l++)c.push("..");return(c=c.concat(a.slice(i))).join("/")},n.sep="/",n.delimiter=":",n.dirname=function(e){if("string"!=typeof e&&(e+=""),0===e.length)return".";for(var t=e.charCodeAt(0),n=47===t,s=-1,r=!0,a=e.length-1;a>=1;--a)if(47===(t=e.charCodeAt(a))){if(!r){s=a;break}}else r=!1;return-1===s?n?"/":".":n&&1===s?"/":e.slice(0,s)},n.basename=function(e,t){var n=function(e){"string"!=typeof e&&(e+="");var t,n=0,s=-1,r=!0;for(t=e.length-1;t>=0;--t)if(47===e.charCodeAt(t)){if(!r){n=t+1;break}}else-1===s&&(r=!1,s=t+1);return-1===s?"":e.slice(n,s)}(e);return t&&n.substr(-1*t.length)===t&&(n=n.substr(0,n.length-t.length)),n},n.extname=function(e){"string"!=typeof e&&(e+="");for(var t=-1,n=0,s=-1,r=!0,a=0,o=e.length-1;o>=0;--o){var i=e.charCodeAt(o);if(47!==i)-1===s&&(r=!1,s=o+1),46===i?-1===t?t=o:1!==a&&(a=1):-1!==t&&(a=-1);else if(!r){n=o+1;break}}return-1===t||-1===s||0===a||1===a&&t===s-1&&t===n+1?"":e.slice(t,s)};var r="b"==="ab".substr(-1)?function(e,t,n){return e.substr(t,n)}:function(e,t,n){return t<0&&(t=e.length+t),e.substr(t,n)}}).call(this,e("_process"))},{_process:5}],5:[function(e,t,n){var s,r,a=t.exports={};function o(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function l(e){if(s===setTimeout)return setTimeout(e,0);if((s===o||!s)&&setTimeout)return s=setTimeout,setTimeout(e,0);try{return s(e,0)}catch(t){try{return s.call(null,e,0)}catch(t){return s.call(this,e,0)}}}!function(){try{s="function"==typeof setTimeout?setTimeout:o}catch(e){s=o}try{r="function"==typeof clearTimeout?clearTimeout:i}catch(e){r=i}}();var c,u=[],h=!1,d=-1;function p(){h&&c&&(h=!1,c.length?u=c.concat(u):d=-1,u.length&&f())}function f(){if(!h){var e=l(p);h=!0;for(var t=u.length;t;){for(c=u,u=[];++d<t;)c&&c[d].run();d=-1,t=u.length}c=null,h=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===i||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function m(e,t){this.fun=e,this.array=t}function g(){}a.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];u.push(new m(e,t)),1!==u.length||h||l(f)},m.prototype.run=function(){this.fun.apply(null,this.array)},a.title="browser",a.browser=!0,a.env={},a.argv=[],a.version="",a.versions={},a.on=g,a.addListener=g,a.once=g,a.off=g,a.removeListener=g,a.removeAllListeners=g,a.emit=g,a.prependListener=g,a.prependOnceListener=g,a.listeners=function(e){return[]},a.binding=function(e){throw new Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(e){throw new Error("process.chdir is not supported")},a.umask=function(){return 0}},{}],6:[function(e,t,n){t.exports={name:"ejs",description:"Embedded JavaScript templates",keywords:["template","engine","ejs"],version:"2.7.4",author:"Matthew Eernisse <mde@fleegix.org> (http://fleegix.org)",license:"Apache-2.0",main:"./lib/ejs.js",repository:{type:"git",url:"git://github.com/mde/ejs.git"},bugs:"https://github.com/mde/ejs/issues",homepage:"https://github.com/mde/ejs",dependencies:{},devDependencies:{browserify:"^13.1.1",eslint:"^4.14.0","git-directory-deploy":"^1.5.1",jake:"^10.3.1",jsdoc:"^3.4.0","lru-cache":"^4.0.1",mocha:"^5.0.5","uglify-js":"^3.3.16"},engines:{node:">=0.10.0"},scripts:{test:"mocha",postinstall:"node ./postinstall.js"}}},{}]},{},[1])(1)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OWBiomes=void 0;const s=n(18),r=n(786);class a{static addBiomes(e,t,n={}){const s=a.debug,l=new r.Noise,c=new r.Noise,u=new r.Noise,h=t.getMap()._map,{cols:d,rows:p}=t.getMap();let f=0;[1,2,4].forEach(e=>{f+=1/e});for(let e=0;e<d;e++)for(let t=0;t<p;t++){let n=h[e][t].isFree()?0:5,r=o(e,t,d,p);const a=(u.get(e/10,t/10)+.5*u.get(e/20,t/20))/1.5;n+=l.getOctavesDiv(e,t,[[1,20],[.5,8],[.25,1]]),s&&console.log(e,t,"temp before:",r),r+=.1*c.get(e,t),s&&console.log("temp after:",r),n<5&&h[e][t].setBaseElem(i(n,a,r))}}}function o(e,t,n,s){return t/(s-1)*2-.3*e/(n-1)}function i(e,t,n){return e<.6?n<.85?s.ELEM.WATER_FROZEN:e<.6-.2?s.ELEM.DEEP_WATER:e<.5?s.ELEM.WATER:s.ELEM.SHALLOW_WATER:e<=.6+.3?n<.85?s.ELEM.SNOW:s.ELEM.FLOOR:e>.6+.3&&e<1.2?t<.1?n<.85?s.ELEM.SNOW:s.ELEM.FLOOR:n<.85?s.ELEM.TREE_SNOW:n>1.45&&t>=.55?s.ELEM.SWAMP:s.ELEM.TREE:e<5?n<.85?e<1.2+.15?s.ELEM.SNOWY_CLIFF:e<1.45?s.ELEM.STONE_SNOW:s.ELEM.FROZEN_STEEP_CLIFF:e<1.2+.15?s.ELEM.CLIFF:e<1.45?s.ELEM.STONE:s.ELEM.STEEP_CLIFF:void 0}t.OWBiomes=a,a.debug=!1},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Noise=void 0;const r=s(n(219));t.Noise=class{constructor(){this.noise=new r.default}get(e,t){return(this.noise.get(e,t)+1)/2}getOctaves(e,t,n){let s=0;return n.forEach(n=>{s+=1/n*this.get(n*e,n*t)}),s}getOctavesDiv(e,t,n){let s=0;return n.forEach(n=>{const[r,a]=n;s+=r*this.get(e/a,t/a)}),s}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.WorldFromJSON=void 0;const i=o(n(4)),l=n(370),c=n(87),u=a(n(47)),h=n(160),d=n(15)("bitn:WorldFromJSON"),p=a(n(45));t.WorldFromJSON=class{constructor(e,t){this.id2level=e,this.id2entity=t,this._conf=new l.ConfStack,this._verif=new u.Conf("WorldFromJSON"),this.worldElemByID={},this.createAllZones=!0,this._IND=0}createPlace(e){switch(e.type){case"world":return this.createWorld(e);default:i.default.err("WorldFromJSON","createPlace",`No place ${e.type} implemented yet`)}return null}createWorld(e){let t=null;if(e.conf)this.dbg("Creating a restored world now"),t=this.createRestoredWorld(e);else{i.default.err("WorldFromJSON","Should not be called at all.","ERROR"),this.dbg("Creating world using Factory.World fully");const n=new c.FactoryWorld;n.setId2Level(this.id2level),n.fromJSON=this.fromJSON,t=n.createWorld(e)}return t}createRestoredWorld(e){e.conf||i.default.err("WorldFromJSON","createRestoredWorld","No worldJSON.conf. Does not look like restored world.");const t=this.createWorldFromJSON(e);t.setConf(e.conf);const n=t.getAreas();if(n.length>0){const t=""+Object.keys(e.conf);e.conf.hasOwnProperty("area")||i.default.err("WorldFromJSON","createRestoredWorld",`No prop 'area' in ${e.conf}. Props ${t}`)}return n.forEach((t,n)=>{t.setConf(e.conf.area[n])}),t}pushScope(e){this._conf.pushScope(e),this.fact.pushScope(e),++this._IND}popScope(e){this._conf.popScope(e),this.fact.popScope(e),--this._IND}getHierName(){return this._conf.getScope().join(".")}createWorldFromJSON(e){const t=new c.FactoryWorld;t.setId2Level(this.id2level),t.id2entity=this.id2entity,t.fromJSON=this.fromJSON,this.fact=t,this.verify("createWorld",e,["name","nAreas"]),e.hasOwnProperty("createAllZones")&&(this.createAllZones=e.createAllZones,this.dbg("createAllZones set to "+this.createAllZones),t.createAllZones=this.createAllZones),this.pushScope(e);const n=new p.WorldTop(e.name);n.setConf(e);for(let t=0;t<e.nAreas;t++){const s=e.area[t];d.enabled&&this.printKeys("areaJSON keys",s);const r=this.restoreAreaFromJSON(s);s.zonesCreated&&this.restoreCreatedZones(n,r),n.addArea(r),this.addWorldID(s,r)}return this.popScope(e),this.addWorldID(e,n),n}restoreAreaFromJSON(e){this.verify("restoreAreaFromJSON",e,["name","maxX","maxY"]),this.pushScope(e);const t=this.getAreaLevels(e),{name:n,maxX:s,maxY:r,cols:a,rows:o}=e,i=new p.Area(n,s,r,a,o,t);return i.setConf(e),i.setHierName(this.getHierName()),i.tileStatus=e.tileStatus,i.zonesCreated=e.zonesCreated,this.setTileJSONForUnloadedTiles(i,e),this.createAllZones?(this.fact._createAllZones(i,e),i.markAllZonesCreated()):this.dbg("Skipping the zone creating due to createZones=false"),this.popScope(e),i}restoreCreatedZones(e,t){Object.keys(t.zonesCreated).forEach(n=>{const[s,r]=n.split(","),[a,o]=[parseInt(s,10),parseInt(r,10)];t.zonesCreated[n]&&t.isLoaded(a,o)&&(this.dbg(`\tRestoring created zones for tile ${a},${o}`),this.restoreZonesForTile(e,t,a,o))})}restoreZonesForTile(e,t,n,s){const r=e.getConf();this.pushScope(r);const a=t.getConf();this.pushScope(a),this.fact._createAllZones(t,a,n,s),this.popScope(a),this.popScope(r)}getAreaLevels(e){this.verify("getAreaLevels",e,["tileStatus"]),++this._IND;const t=[];return e.tiles?e.tiles.forEach((n,s)=>{const r=[];n.forEach((t,n)=>{if(e.tileStatus[s][n]===h.LoadStat.LOADED){this.dbg(`Tile ${s},${n} is loaded`);const e=this.id2level[t.level];e?r.push(e):i.default.err("WorldFromJSON","getAreaLevels",`No level ID ${t.level} in id2level`)}else this.dbg(`Will NOT load Tile ${s},${n}`),r.push(i.default.LEVEL_NOT_LOADED)}),t.push(r)}):i.default.err("WorldFromJSON","getAreaLevels","areaJSON.tiles cannot be null/undefined"),--this._IND,t}setTileJSONForUnloadedTiles(e,t){const n=e.getTiles();n.forEach((e,s)=>{e.forEach((e,r)=>{n[s][r]===i.default.TILE_NOT_LOADED&&(n[s][r]=t.tiles[s][r])})})}addWorldID(e,t){i.default.isNullOrUndef([e.id])||t.setID(e.id),this.worldElemByID[t.getID()]=t}dbg(e){if(d.enabled){const t=" ".repeat(this._IND);i.default.diag(t+"WorldFromJSON: "+e)}}verify(e,t,n){this._verif.verifyConf(e,t,n)}printKeys(e,t){i.default.diag(e),i.default.diag(Object.keys(t))}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SeasonManager=t.getSeasonDist=t.biomePossibleSeasons=t.weatherHumidity=t.seasonConfig=void 0;const r=s(n(15)).default("bitn:WorldSimulation"),a=s(n(4)),o=n(9).Random.getRNG(),i=["sunny","cloudy"];t.seasonConfig={AUTUMN:{dur:2,temp:[0,15],weather:["rain","heavy rain"],index:0},AUTUMN_WINTER:{dur:1,temp:[-10,10],weather:["snowFall","coldRain"],index:1},WINTER:{dur:4,temp:[-35,3],weather:["snowFall","snowStorm","hailStorm"],index:2},WINTER_SPRING:{dur:1,temp:[-10,10],weather:["snowFall"],index:3},SPRING:{dur:1,temp:[5,15],weather:["rain"],index:4},SPRING_SUMMER:{dur:1,temp:[10,20],weather:["rain"],index:5},SUMMER:{dur:1,temp:[15,25],weather:["rain"],index:6},SUMMER_AUTUMN:{dur:1,temp:[10,20],weather:["heavy rain","rain"],index:7}},t.weatherHumidity={sunny:50,cloudy:50,snowFall:60,coldRain:100,hailStorm:80,rain:100,heavyRain:100,default:50},t.biomePossibleSeasons={arctic:["WINTER"],alpine:["WINTER","WINTER_SPRING"],tundra:["AUTUMN_WINTER","WINTER","WINTER_SPRING"],taiga:["all"],forest:["all"],grassland:["all"]},t.getSeasonDist=function(e,n){const s=t.seasonConfig[e].index,r=t.seasonConfig[n].index;return Math.abs(s-r)};class l{constructor(e){this._currSeason=a.default.SEASON.AUTUMN,this._daysPerMonth=5,this._monthLeft=5,this._seasonLeft=t.seasonConfig[this._currSeason].dur,this._currWeather="sunny",this._seasonChanged=!1,this._weatherChanged=!1,this._monthChanged=!1,this._yearChanged=!1,this.pool=e,this._currTemp=this.getNewTemperature(this._currSeason),this._currHumidity=this.getNewHumidity(this._currWeather),this._debug=r.enabled}static fromJSON(e){const t=new l;return t._currSeason=e.currSeason,t._currWeather=e.currWeather,t._monthLeft=e.monthLeft,t._seasonLeft=e.seasonLeft,t._seasonChanged=e.seasonChanged,t._weatherChanged=e.weatherChanged,t._monthChanged=e.monthChanged,t._yearChanged=e.yearChanged,t._biomeMap=e.biomeMap,t}dbg(...e){this._debug&&r("",...e)}setDaysInMonth(e){this._monthLeft=e,this._daysPerMonth=e}getNewTemperature(e){const[n,s]=t.seasonConfig[e].temp;return o.getUniformInt(n,s)}getNewHumidity(e){return t.weatherHumidity[e]?t.weatherHumidity[e]:t.weatherHumidity.default}setOwPos(e){this._owPos=e}setBiomeMap(e){this._biomeMap=e}seasonChanged(){return this._seasonChanged}monthChanged(){return this._monthChanged}yearChanged(){return this._yearChanged}weatherChanged(){return this._weatherChanged}resetWeatherChanged(){this._weatherChanged=!1}getSeason(){return this._currSeason}update(){--this._monthLeft,this._seasonChanged=!1,this._monthChanged=!1,this._yearChanged=!1,0===this._monthLeft&&(this._seasonLeft-=1,this._monthLeft=5,this._monthChanged=!0),this._seasonLeft<=0&&(this.nextSeason(),this._seasonChanged=!0,this._checkMsgEmits())}nextSeason(){const e=Object.keys(t.seasonConfig);let n=e.indexOf(this._currSeason)+1;n>=e.length&&(n=0,this._yearChanged=!0),this.dbg("SeasonMan currSeason is now",this._currSeason),this._currSeason=e[n]}getWeather(){return this._currWeather}getTemperature(){return this._currTemp}getHumidity(){return this._currHumidity}changeWeather(){this._weatherChanged=!1;const e=a.default.isSuccess(.2),n=a.default.isSuccess(.75);if(this.dbg("changeWeather() called. Checking to change weatherisSpecial: "+e+", isSame: "+n),!e&&n)return this._currWeather;const s=this.filterSeasonForBiome();this._currTemp=this.getNewTemperature(s);let r=this._currWeather;if(e){const e=t.seasonConfig[s].weather,a=e.indexOf(r)>=0;n&&a?this.dbg("Keeping existing special weather: "+r):e.length>0&&(r=o.arrayGetRand(e))}else r=o.arrayGetRand(i);return this.dbg("changeWeather() called. New weather will be |",r),this._currHumidity=this.getNewHumidity(r),r!==this._currWeather&&(this._weatherChanged=!0),this._currWeather=r,this._currWeather}filterSeasonForBiome(){if(!this._biomeMap)return this._currSeason;if(!this._owPos)return this._currSeason;const e=a.default.toKey(this._owPos);this._biomeMap.hasOwnProperty(e)||a.default.err("SeasonManager","filterSeasonForBiome",`Key ${e} for owPos ${this._owPos} not matching biome`);const n=this._biomeMap[e];if(n){const e=t.biomePossibleSeasons[n];if("all"===e[0])return this._currSeason;return e.indexOf(this._currSeason)>=0?this._currSeason:e[0]}return a.default.err("SeasonManager","filterSeasonForBiome","currBiome not found with key "+e),""}setPool(e){this.pool=e}toJSON(){return{currSeason:this._currSeason,currWeather:this._currWeather,monthLeft:this._monthLeft,seasonLeft:this._seasonLeft,seasonChanged:this._seasonChanged,weatherChanged:this._weatherChanged,monthChanged:this._monthChanged,yearChanged:this._yearChanged,owPos:this._owPos,biomeMap:this._biomeMap}}toString(){return"Weather: "+this._currWeather+",Month left: "+this._monthLeft+",Season: "+this._currSeason+"("+this._seasonLeft+")"}_checkMsgEmits(){this.seasonChanged()&&(this._currSeason===a.default.SEASON.AUTUMN_WINTER?a.default.gameMsg("Winter is approaching quickly!"):this._currSeason===a.default.SEASON.WINTER?a.default.gameMsg("The call of Winter has arrived!"):this._currSeason===a.default.SEASON.WINTER_SPRING?a.default.gameMsg("The winter frost seems to be drawing away!"):this._currSeason===a.default.SEASON.SPRING?a.default.gameMsg("The warmth of the first spring day is here!"):this._currSeason===a.default.SEASON.AUTUMN&&a.default.gameMsg("Soon the deadly leaves will fall, and death has taken over!"))}}t.SeasonManager=l},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DayManager=void 0;const r=s(n(4)),a={NIGHT:{from:1320,to:300,visibility:-3},DAWN:{from:300,to:420,visibility:-1},MORNING:{from:420,to:660,visibility:0},NOON:{from:660,to:780,visibility:0},AFTERNOON:{from:780,to:1080,visibility:0},EVENING:{from:1080,to:1200,visibility:-1},DUSK:{from:1200,to:1320,visibility:-2}};class o{constructor(e){this._currPhase=r.default.DAY.MORNING,this._updateRate=5,this._currTimeMins=720,this._dayChanged=!1,this._phaseChanged=!1,e&&(this.pool=e)}static fromJSON(e){const t=new o;return t._currPhase=e.currPhase,t._currTimeMins=e.timeOfDayMins,t._updateRate=e.updateRate,t._dayChanged=e.dayChanged,t._phaseChanged=e.phaseChanged,t}setUpdateRate(e){e>=1?this._updateRate=e:r.default.warn("DayManager","setUpdateRate","Rate must be >= 1. Got "+e)}getTimeMins(){return this._currTimeMins}getVisibility(){return this.getPhaseEntry().visibility}update(){const e=a[this._currPhase];this._dayChanged=!1,this._phaseChanged=!1,this._currTimeMins+=this._updateRate,this._currTimeMins>1440&&(this._currTimeMins=0),this._currTimeMins>=e.to&&(e.to<e.from?this._currTimeMins<e.from&&(this.nextPhase(),this._phaseChanged=!0):(this.nextPhase(),this._phaseChanged=!0))}dayChanged(){return this._dayChanged}phaseChanged(){return this._phaseChanged}getCurrPhase(){return this._currPhase}getPhaseEntry(){return a[this._currPhase]}toJSON(){return{currPhase:this._currPhase,timeOfDayMins:this._currTimeMins,updateRate:this._updateRate,dayChanged:this._dayChanged,phaseChanged:this._phaseChanged}}setPool(e){this.pool=e}toString(){return`Curr phase: ${this._currPhase}, timeOfDay: ${this._currTimeMins},`+(this._phaseChanged?" *PHASE CHANGED*":"")+(this._dayChanged?" *DAY CHANGED*":"")}nextPhase(){const e=Object.keys(a);let t=e.indexOf(this._currPhase)+1;t>=e.length&&(t=0,this.pool.emitEvent(r.default.EVT_DAY_CHANGED,{prevPhase:this._currPhase,nextPhase:e[t]}),this._dayChanged=!0),this.pool.emitEvent(r.default.EVT_DAY_PHASE_CHANGED,{prevPhase:this._currPhase,nextPhase:e[t]}),this._currPhase=e[t]}}t.DayManager=o},function(e,t,n){(function(t){e.exports=function e(t,n,s){function r(o,i){if(!n[o]){if(!t[o]){if(a)return a(o,!0);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}var c=n[o]={exports:{}};t[o][0].call(c.exports,(function(e){var n=t[o][1][e];return r(n||e)}),c,c.exports,e,t,n,s)}return n[o].exports}for(var a=!1,o=0;o<s.length;o++)r(s[o]);return r}({1:[function(e,n,s){(function(e){"use strict";var t,s,r=e.MutationObserver||e.WebKitMutationObserver;if(r){var a=0,o=new r(u),i=e.document.createTextNode("");o.observe(i,{characterData:!0}),t=function(){i.data=a=++a%2}}else if(e.setImmediate||void 0===e.MessageChannel)t="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){u(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(u,0)};else{var l=new e.MessageChannel;l.port1.onmessage=u,t=function(){l.port2.postMessage(0)}}var c=[];function u(){var e,t;s=!0;for(var n=c.length;n;){for(t=c,c=[],e=-1;++e<n;)t[e]();n=c.length}s=!1}n.exports=function(e){1!==c.push(e)||s||t()}}).call(this,void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,t,n){"use strict";var s=e(1);function r(){}var a={},o=["REJECTED"],i=["FULFILLED"],l=["PENDING"];function c(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=l,this.queue=[],this.outcome=void 0,e!==r&&p(this,e)}function u(e,t,n){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}function h(e,t,n){s((function(){var s;try{s=t(n)}catch(t){return a.reject(e,t)}s===e?a.reject(e,new TypeError("Cannot resolve promise with itself")):a.resolve(e,s)}))}function d(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function p(e,t){var n=!1;function s(t){n||(n=!0,a.reject(e,t))}function r(t){n||(n=!0,a.resolve(e,t))}var o=f((function(){t(r,s)}));"error"===o.status&&s(o.value)}function f(e,t){var n={};try{n.value=e(t),n.status="success"}catch(e){n.status="error",n.value=e}return n}t.exports=c,c.prototype.catch=function(e){return this.then(null,e)},c.prototype.then=function(e,t){if("function"!=typeof e&&this.state===i||"function"!=typeof t&&this.state===o)return this;var n=new this.constructor(r);return this.state!==l?h(n,this.state===i?e:t,this.outcome):this.queue.push(new u(n,e,t)),n},u.prototype.callFulfilled=function(e){a.resolve(this.promise,e)},u.prototype.otherCallFulfilled=function(e){h(this.promise,this.onFulfilled,e)},u.prototype.callRejected=function(e){a.reject(this.promise,e)},u.prototype.otherCallRejected=function(e){h(this.promise,this.onRejected,e)},a.resolve=function(e,t){var n=f(d,t);if("error"===n.status)return a.reject(e,n.value);var s=n.value;if(s)p(e,s);else{e.state=i,e.outcome=t;for(var r=-1,o=e.queue.length;++r<o;)e.queue[r].callFulfilled(t)}return e},a.reject=function(e,t){e.state=o,e.outcome=t;for(var n=-1,s=e.queue.length;++n<s;)e.queue[n].callRejected(t);return e},c.resolve=function(e){return e instanceof this?e:a.resolve(new this(r),e)},c.reject=function(e){var t=new this(r);return a.reject(t,e)},c.all=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,s=!1;if(!n)return this.resolve([]);for(var o=new Array(n),i=0,l=-1,c=new this(r);++l<n;)u(e[l],l);return c;function u(e,r){t.resolve(e).then((function(e){o[r]=e,++i!==n||s||(s=!0,a.resolve(c,o))}),(function(e){s||(s=!0,a.reject(c,e))}))}},c.race=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,s=!1;if(!n)return this.resolve([]);for(var o,i=-1,l=new this(r);++i<n;)o=e[i],t.resolve(o).then((function(e){s||(s=!0,a.resolve(l,e))}),(function(e){s||(s=!0,a.reject(l,e))}));return l}},{1:1}],3:[function(e,n,s){(function(t){"use strict";"function"!=typeof t.Promise&&(t.Promise=e(2))}).call(this,void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(e,t,n){"use strict";var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(e){return}}();function a(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(r){if("TypeError"!==r.name)throw r;for(var n=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),s=0;s<e.length;s+=1)n.append(e[s]);return n.getBlob(t.type)}}"undefined"==typeof Promise&&e(3);var o=Promise;function i(e,t){t&&e.then((function(e){t(null,e)}),(function(e){t(e)}))}function l(e,t,n){"function"==typeof t&&e.then(t),"function"==typeof n&&e.catch(n)}function c(e){return"string"!=typeof e&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function u(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}var h=void 0,d={},p=Object.prototype.toString;function f(e){return"boolean"==typeof h?o.resolve(h):function(e){return new o((function(t){var n=e.transaction("local-forage-detect-blob-support","readwrite"),s=a([""]);n.objectStore("local-forage-detect-blob-support").put(s,"key"),n.onabort=function(e){e.preventDefault(),e.stopPropagation(),t(!1)},n.oncomplete=function(){var e=navigator.userAgent.match(/Chrome\/(\d+)/),n=navigator.userAgent.match(/Edge\//);t(n||!e||parseInt(e[1],10)>=43)}})).catch((function(){return!1}))}(e).then((function(e){return h=e}))}function m(e){var t=d[e.name],n={};n.promise=new o((function(e,t){n.resolve=e,n.reject=t})),t.deferredOperations.push(n),t.dbReady?t.dbReady=t.dbReady.then((function(){return n.promise})):t.dbReady=n.promise}function g(e){var t=d[e.name].deferredOperations.pop();if(t)return t.resolve(),t.promise}function y(e,t){var n=d[e.name].deferredOperations.pop();if(n)return n.reject(t),n.promise}function v(e,t){return new o((function(n,s){if(d[e.name]=d[e.name]||{forages:[],db:null,dbReady:null,deferredOperations:[]},e.db){if(!t)return n(e.db);m(e),e.db.close()}var a=[e.name];t&&a.push(e.version);var o=r.open.apply(r,a);t&&(o.onupgradeneeded=function(t){var n=o.result;try{n.createObjectStore(e.storeName),t.oldVersion<=1&&n.createObjectStore("local-forage-detect-blob-support")}catch(n){if("ConstraintError"!==n.name)throw n;console.warn('The database "'+e.name+'" has been upgraded from version '+t.oldVersion+" to version "+t.newVersion+', but the storage "'+e.storeName+'" already exists.')}}),o.onerror=function(e){e.preventDefault(),s(o.error)},o.onsuccess=function(){n(o.result),g(e)}}))}function b(e){return v(e,!1)}function _(e){return v(e,!0)}function E(e,t){if(!e.db)return!0;var n=!e.db.objectStoreNames.contains(e.storeName),s=e.version<e.db.version,r=e.version>e.db.version;if(s&&(e.version!==t&&console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),r||n){if(n){var a=e.db.version+1;a>e.version&&(e.version=a)}return!0}return!1}function S(e){return a([function(e){for(var t=e.length,n=new ArrayBuffer(t),s=new Uint8Array(n),r=0;r<t;r++)s[r]=e.charCodeAt(r);return n}(atob(e.data))],{type:e.type})}function w(e){return e&&e.__local_forage_encoded_blob}function C(e){var t=this,n=t._initReady().then((function(){var e=d[t._dbInfo.name];if(e&&e.dbReady)return e.dbReady}));return l(n,e,e),n}function O(e,t,n,s){void 0===s&&(s=1);try{var r=e.db.transaction(e.storeName,t);n(null,r)}catch(r){if(s>0&&(!e.db||"InvalidStateError"===r.name||"NotFoundError"===r.name))return o.resolve().then((function(){if(!e.db||"NotFoundError"===r.name&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),_(e)})).then((function(){return function(e){m(e);for(var t=d[e.name],n=t.forages,s=0;s<n.length;s++){var r=n[s];r._dbInfo.db&&(r._dbInfo.db.close(),r._dbInfo.db=null)}return e.db=null,b(e).then((function(t){return e.db=t,E(e)?_(e):t})).then((function(s){e.db=t.db=s;for(var r=0;r<n.length;r++)n[r]._dbInfo.db=s})).catch((function(t){throw y(e,t),t}))}(e).then((function(){O(e,t,n,s-1)}))})).catch(n);n(r)}}var T={_driver:"asyncStorage",_initStorage:function(e){var t=this,n={db:null};if(e)for(var s in e)n[s]=e[s];var r=d[n.name];r||(r={forages:[],db:null,dbReady:null,deferredOperations:[]},d[n.name]=r),r.forages.push(t),t._initReady||(t._initReady=t.ready,t.ready=C);var a=[];function i(){return o.resolve()}for(var l=0;l<r.forages.length;l++){var c=r.forages[l];c!==t&&a.push(c._initReady().catch(i))}var u=r.forages.slice(0);return o.all(a).then((function(){return n.db=r.db,b(n)})).then((function(e){return n.db=e,E(n,t._defaultConfig.version)?_(n):e})).then((function(e){n.db=r.db=e,t._dbInfo=n;for(var s=0;s<u.length;s++){var a=u[s];a!==t&&(a._dbInfo.db=n.db,a._dbInfo.version=n.version)}}))},_support:function(){try{if(!r||!r.open)return!1;var e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),t="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!e||t)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e){return!1}}(),iterate:function(e,t){var n=this,s=new o((function(t,s){n.ready().then((function(){O(n._dbInfo,"readonly",(function(r,a){if(r)return s(r);try{var o=a.objectStore(n._dbInfo.storeName).openCursor(),i=1;o.onsuccess=function(){var n=o.result;if(n){var s=n.value;w(s)&&(s=S(s));var r=e(s,n.key,i++);void 0!==r?t(r):n.continue()}else t()},o.onerror=function(){s(o.error)}}catch(e){s(e)}}))})).catch(s)}));return i(s,t),s},getItem:function(e,t){var n=this;e=c(e);var s=new o((function(t,s){n.ready().then((function(){O(n._dbInfo,"readonly",(function(r,a){if(r)return s(r);try{var o=a.objectStore(n._dbInfo.storeName).get(e);o.onsuccess=function(){var e=o.result;void 0===e&&(e=null),w(e)&&(e=S(e)),t(e)},o.onerror=function(){s(o.error)}}catch(e){s(e)}}))})).catch(s)}));return i(s,t),s},setItem:function(e,t,n){var s=this;e=c(e);var r=new o((function(n,r){var a;s.ready().then((function(){return a=s._dbInfo,"[object Blob]"===p.call(t)?f(a.db).then((function(e){return e?t:(n=t,new o((function(e,t){var s=new FileReader;s.onerror=t,s.onloadend=function(t){var s=btoa(t.target.result||"");e({__local_forage_encoded_blob:!0,data:s,type:n.type})},s.readAsBinaryString(n)})));var n})):t})).then((function(t){O(s._dbInfo,"readwrite",(function(a,o){if(a)return r(a);try{var i=o.objectStore(s._dbInfo.storeName);null===t&&(t=void 0);var l=i.put(t,e);o.oncomplete=function(){void 0===t&&(t=null),n(t)},o.onabort=o.onerror=function(){var e=l.error?l.error:l.transaction.error;r(e)}}catch(e){r(e)}}))})).catch(r)}));return i(r,n),r},removeItem:function(e,t){var n=this;e=c(e);var s=new o((function(t,s){n.ready().then((function(){O(n._dbInfo,"readwrite",(function(r,a){if(r)return s(r);try{var o=a.objectStore(n._dbInfo.storeName).delete(e);a.oncomplete=function(){t()},a.onerror=function(){s(o.error)},a.onabort=function(){var e=o.error?o.error:o.transaction.error;s(e)}}catch(e){s(e)}}))})).catch(s)}));return i(s,t),s},clear:function(e){var t=this,n=new o((function(e,n){t.ready().then((function(){O(t._dbInfo,"readwrite",(function(s,r){if(s)return n(s);try{var a=r.objectStore(t._dbInfo.storeName).clear();r.oncomplete=function(){e()},r.onabort=r.onerror=function(){var e=a.error?a.error:a.transaction.error;n(e)}}catch(e){n(e)}}))})).catch(n)}));return i(n,e),n},length:function(e){var t=this,n=new o((function(e,n){t.ready().then((function(){O(t._dbInfo,"readonly",(function(s,r){if(s)return n(s);try{var a=r.objectStore(t._dbInfo.storeName).count();a.onsuccess=function(){e(a.result)},a.onerror=function(){n(a.error)}}catch(e){n(e)}}))})).catch(n)}));return i(n,e),n},key:function(e,t){var n=this,s=new o((function(t,s){e<0?t(null):n.ready().then((function(){O(n._dbInfo,"readonly",(function(r,a){if(r)return s(r);try{var o=a.objectStore(n._dbInfo.storeName),i=!1,l=o.openKeyCursor();l.onsuccess=function(){var n=l.result;n?0===e||i?t(n.key):(i=!0,n.advance(e)):t(null)},l.onerror=function(){s(l.error)}}catch(e){s(e)}}))})).catch(s)}));return i(s,t),s},keys:function(e){var t=this,n=new o((function(e,n){t.ready().then((function(){O(t._dbInfo,"readonly",(function(s,r){if(s)return n(s);try{var a=r.objectStore(t._dbInfo.storeName).openKeyCursor(),o=[];a.onsuccess=function(){var t=a.result;t?(o.push(t.key),t.continue()):e(o)},a.onerror=function(){n(a.error)}}catch(e){n(e)}}))})).catch(n)}));return i(n,e),n},dropInstance:function(e,t){t=u.apply(this,arguments);var n=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||n.name,e.storeName=e.storeName||n.storeName);var s,a=this;if(e.name){var l=e.name===n.name&&a._dbInfo.db,c=l?o.resolve(a._dbInfo.db):b(e).then((function(t){var n=d[e.name],s=n.forages;n.db=t;for(var r=0;r<s.length;r++)s[r]._dbInfo.db=t;return t}));s=e.storeName?c.then((function(t){if(t.objectStoreNames.contains(e.storeName)){var n=t.version+1;m(e);var s=d[e.name],a=s.forages;t.close();for(var i=0;i<a.length;i++){var l=a[i];l._dbInfo.db=null,l._dbInfo.version=n}return new o((function(t,s){var a=r.open(e.name,n);a.onerror=function(e){a.result.close(),s(e)},a.onupgradeneeded=function(){a.result.deleteObjectStore(e.storeName)},a.onsuccess=function(){var e=a.result;e.close(),t(e)}})).then((function(e){s.db=e;for(var t=0;t<a.length;t++){var n=a[t];n._dbInfo.db=e,g(n._dbInfo)}})).catch((function(t){throw(y(e,t)||o.resolve()).catch((function(){})),t}))}})):c.then((function(t){m(e);var n=d[e.name],s=n.forages;t.close();for(var a=0;a<s.length;a++)s[a]._dbInfo.db=null;return new o((function(t,n){var s=r.deleteDatabase(e.name);s.onerror=s.onblocked=function(e){var t=s.result;t&&t.close(),n(e)},s.onsuccess=function(){var e=s.result;e&&e.close(),t(e)}})).then((function(e){n.db=e;for(var t=0;t<s.length;t++)g(s[t]._dbInfo)})).catch((function(t){throw(y(e,t)||o.resolve()).catch((function(){})),t}))}))}else s=o.reject("Invalid arguments");return i(s,t),s}},M="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",A=/^~~local_forage_type~([^~]+)~/,N="__lfsc__:".length,x=N+"arbf".length,P=Object.prototype.toString;function I(e){var t,n,s,r,a,o=.75*e.length,i=e.length,l=0;"="===e[e.length-1]&&(o--,"="===e[e.length-2]&&o--);var c=new ArrayBuffer(o),u=new Uint8Array(c);for(t=0;t<i;t+=4)n=M.indexOf(e[t]),s=M.indexOf(e[t+1]),r=M.indexOf(e[t+2]),a=M.indexOf(e[t+3]),u[l++]=n<<2|s>>4,u[l++]=(15&s)<<4|r>>2,u[l++]=(3&r)<<6|63&a;return c}function D(e){var t,n=new Uint8Array(e),s="";for(t=0;t<n.length;t+=3)s+=M[n[t]>>2],s+=M[(3&n[t])<<4|n[t+1]>>4],s+=M[(15&n[t+1])<<2|n[t+2]>>6],s+=M[63&n[t+2]];return n.length%3==2?s=s.substring(0,s.length-1)+"=":n.length%3==1&&(s=s.substring(0,s.length-2)+"=="),s}var k={serialize:function(e,t){var n="";if(e&&(n=P.call(e)),e&&("[object ArrayBuffer]"===n||e.buffer&&"[object ArrayBuffer]"===P.call(e.buffer))){var s,r="__lfsc__:";e instanceof ArrayBuffer?(s=e,r+="arbf"):(s=e.buffer,"[object Int8Array]"===n?r+="si08":"[object Uint8Array]"===n?r+="ui08":"[object Uint8ClampedArray]"===n?r+="uic8":"[object Int16Array]"===n?r+="si16":"[object Uint16Array]"===n?r+="ur16":"[object Int32Array]"===n?r+="si32":"[object Uint32Array]"===n?r+="ui32":"[object Float32Array]"===n?r+="fl32":"[object Float64Array]"===n?r+="fl64":t(new Error("Failed to get type for BinaryArray"))),t(r+D(s))}else if("[object Blob]"===n){var a=new FileReader;a.onload=function(){var n="~~local_forage_type~"+e.type+"~"+D(this.result);t("__lfsc__:blob"+n)},a.readAsArrayBuffer(e)}else try{t(JSON.stringify(e))}catch(n){console.error("Couldn't convert value into a JSON string: ",e),t(null,n)}},deserialize:function(e){if("__lfsc__:"!==e.substring(0,N))return JSON.parse(e);var t,n=e.substring(x),s=e.substring(N,x);if("blob"===s&&A.test(n)){var r=n.match(A);t=r[1],n=n.substring(r[0].length)}var o=I(n);switch(s){case"arbf":return o;case"blob":return a([o],{type:t});case"si08":return new Int8Array(o);case"ui08":return new Uint8Array(o);case"uic8":return new Uint8ClampedArray(o);case"si16":return new Int16Array(o);case"ur16":return new Uint16Array(o);case"si32":return new Int32Array(o);case"ui32":return new Uint32Array(o);case"fl32":return new Float32Array(o);case"fl64":return new Float64Array(o);default:throw new Error("Unkown type: "+s)}},stringToBuffer:I,bufferToString:D};function L(e,t,n,s){e.executeSql("CREATE TABLE IF NOT EXISTS "+t.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],n,s)}function R(e,t,n,s,r,a){e.executeSql(n,s,r,(function(e,o){o.code===o.SYNTAX_ERR?e.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[t.storeName],(function(e,i){i.rows.length?a(e,o):L(e,t,(function(){e.executeSql(n,s,r,a)}),a)}),a):a(e,o)}),a)}function B(e,t,n,s){var r=this;e=c(e);var a=new o((function(a,o){r.ready().then((function(){void 0===t&&(t=null);var i=t,l=r._dbInfo;l.serializer.serialize(t,(function(t,c){c?o(c):l.db.transaction((function(n){R(n,l,"INSERT OR REPLACE INTO "+l.storeName+" (key, value) VALUES (?, ?)",[e,t],(function(){a(i)}),(function(e,t){o(t)}))}),(function(t){if(t.code===t.QUOTA_ERR){if(s>0)return void a(B.apply(r,[e,i,n,s-1]));o(t)}}))}))})).catch(o)}));return i(a,n),a}function F(e){return new o((function(t,n){e.transaction((function(s){s.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],(function(n,s){for(var r=[],a=0;a<s.rows.length;a++)r.push(s.rows.item(a).name);t({db:e,storeNames:r})}),(function(e,t){n(t)}))}),(function(e){n(e)}))}))}var G={_driver:"webSQLStorage",_initStorage:function(e){var t=this,n={db:null};if(e)for(var s in e)n[s]="string"!=typeof e[s]?e[s].toString():e[s];var r=new o((function(e,s){try{n.db=openDatabase(n.name,String(n.version),n.description,n.size)}catch(e){return s(e)}n.db.transaction((function(r){L(r,n,(function(){t._dbInfo=n,e()}),(function(e,t){s(t)}))}),s)}));return n.serializer=k,r},_support:"function"==typeof openDatabase,iterate:function(e,t){var n=this,s=new o((function(t,s){n.ready().then((function(){var r=n._dbInfo;r.db.transaction((function(n){R(n,r,"SELECT * FROM "+r.storeName,[],(function(n,s){for(var a=s.rows,o=a.length,i=0;i<o;i++){var l=a.item(i),c=l.value;if(c&&(c=r.serializer.deserialize(c)),void 0!==(c=e(c,l.key,i+1)))return void t(c)}t()}),(function(e,t){s(t)}))}))})).catch(s)}));return i(s,t),s},getItem:function(e,t){var n=this;e=c(e);var s=new o((function(t,s){n.ready().then((function(){var r=n._dbInfo;r.db.transaction((function(n){R(n,r,"SELECT * FROM "+r.storeName+" WHERE key = ? LIMIT 1",[e],(function(e,n){var s=n.rows.length?n.rows.item(0).value:null;s&&(s=r.serializer.deserialize(s)),t(s)}),(function(e,t){s(t)}))}))})).catch(s)}));return i(s,t),s},setItem:function(e,t,n){return B.apply(this,[e,t,n,1])},removeItem:function(e,t){var n=this;e=c(e);var s=new o((function(t,s){n.ready().then((function(){var r=n._dbInfo;r.db.transaction((function(n){R(n,r,"DELETE FROM "+r.storeName+" WHERE key = ?",[e],(function(){t()}),(function(e,t){s(t)}))}))})).catch(s)}));return i(s,t),s},clear:function(e){var t=this,n=new o((function(e,n){t.ready().then((function(){var s=t._dbInfo;s.db.transaction((function(t){R(t,s,"DELETE FROM "+s.storeName,[],(function(){e()}),(function(e,t){n(t)}))}))})).catch(n)}));return i(n,e),n},length:function(e){var t=this,n=new o((function(e,n){t.ready().then((function(){var s=t._dbInfo;s.db.transaction((function(t){R(t,s,"SELECT COUNT(key) as c FROM "+s.storeName,[],(function(t,n){var s=n.rows.item(0).c;e(s)}),(function(e,t){n(t)}))}))})).catch(n)}));return i(n,e),n},key:function(e,t){var n=this,s=new o((function(t,s){n.ready().then((function(){var r=n._dbInfo;r.db.transaction((function(n){R(n,r,"SELECT key FROM "+r.storeName+" WHERE id = ? LIMIT 1",[e+1],(function(e,n){var s=n.rows.length?n.rows.item(0).key:null;t(s)}),(function(e,t){s(t)}))}))})).catch(s)}));return i(s,t),s},keys:function(e){var t=this,n=new o((function(e,n){t.ready().then((function(){var s=t._dbInfo;s.db.transaction((function(t){R(t,s,"SELECT key FROM "+s.storeName,[],(function(t,n){for(var s=[],r=0;r<n.rows.length;r++)s.push(n.rows.item(r).key);e(s)}),(function(e,t){n(t)}))}))})).catch(n)}));return i(n,e),n},dropInstance:function(e,t){t=u.apply(this,arguments);var n=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||n.name,e.storeName=e.storeName||n.storeName);var s,r=this;return i(s=e.name?new o((function(t){var s;s=e.name===n.name?r._dbInfo.db:openDatabase(e.name,"","",0),e.storeName?t({db:s,storeNames:[e.storeName]}):t(F(s))})).then((function(e){return new o((function(t,n){e.db.transaction((function(s){function r(e){return new o((function(t,n){s.executeSql("DROP TABLE IF EXISTS "+e,[],(function(){t()}),(function(e,t){n(t)}))}))}for(var a=[],i=0,l=e.storeNames.length;i<l;i++)a.push(r(e.storeNames[i]));o.all(a).then((function(){t()})).catch((function(e){n(e)}))}),(function(e){n(e)}))}))})):o.reject("Invalid arguments"),t),s}};function j(e,t){var n=e.name+"/";return e.storeName!==t.storeName&&(n+=e.storeName+"/"),n}function W(){return!function(){try{return localStorage.setItem("_localforage_support_test",!0),localStorage.removeItem("_localforage_support_test"),!1}catch(e){return!0}}()||localStorage.length>0}var Y={_driver:"localStorageWrapper",_initStorage:function(e){var t={};if(e)for(var n in e)t[n]=e[n];return t.keyPrefix=j(e,this._defaultConfig),W()?(this._dbInfo=t,t.serializer=k,o.resolve()):o.reject()},_support:function(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(e){return!1}}(),iterate:function(e,t){var n=this,s=n.ready().then((function(){for(var t=n._dbInfo,s=t.keyPrefix,r=s.length,a=localStorage.length,o=1,i=0;i<a;i++){var l=localStorage.key(i);if(0===l.indexOf(s)){var c=localStorage.getItem(l);if(c&&(c=t.serializer.deserialize(c)),void 0!==(c=e(c,l.substring(r),o++)))return c}}}));return i(s,t),s},getItem:function(e,t){var n=this;e=c(e);var s=n.ready().then((function(){var t=n._dbInfo,s=localStorage.getItem(t.keyPrefix+e);return s&&(s=t.serializer.deserialize(s)),s}));return i(s,t),s},setItem:function(e,t,n){var s=this;e=c(e);var r=s.ready().then((function(){void 0===t&&(t=null);var n=t;return new o((function(r,a){var o=s._dbInfo;o.serializer.serialize(t,(function(t,s){if(s)a(s);else try{localStorage.setItem(o.keyPrefix+e,t),r(n)}catch(e){"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name||a(e),a(e)}}))}))}));return i(r,n),r},removeItem:function(e,t){var n=this;e=c(e);var s=n.ready().then((function(){var t=n._dbInfo;localStorage.removeItem(t.keyPrefix+e)}));return i(s,t),s},clear:function(e){var t=this,n=t.ready().then((function(){for(var e=t._dbInfo.keyPrefix,n=localStorage.length-1;n>=0;n--){var s=localStorage.key(n);0===s.indexOf(e)&&localStorage.removeItem(s)}}));return i(n,e),n},length:function(e){var t=this.keys().then((function(e){return e.length}));return i(t,e),t},key:function(e,t){var n=this,s=n.ready().then((function(){var t,s=n._dbInfo;try{t=localStorage.key(e)}catch(e){t=null}return t&&(t=t.substring(s.keyPrefix.length)),t}));return i(s,t),s},keys:function(e){var t=this,n=t.ready().then((function(){for(var e=t._dbInfo,n=localStorage.length,s=[],r=0;r<n;r++){var a=localStorage.key(r);0===a.indexOf(e.keyPrefix)&&s.push(a.substring(e.keyPrefix.length))}return s}));return i(n,e),n},dropInstance:function(e,t){if(t=u.apply(this,arguments),!(e="function"!=typeof e&&e||{}).name){var n=this.config();e.name=e.name||n.name,e.storeName=e.storeName||n.storeName}var s,r=this;return i(s=e.name?new o((function(t){e.storeName?t(j(e,r._defaultConfig)):t(e.name+"/")})).then((function(e){for(var t=localStorage.length-1;t>=0;t--){var n=localStorage.key(t);0===n.indexOf(e)&&localStorage.removeItem(n)}})):o.reject("Invalid arguments"),t),s}},X=function(e,t){for(var n,s,r=e.length,a=0;a<r;){if((n=e[a])===(s=t)||"number"==typeof n&&"number"==typeof s&&isNaN(n)&&isNaN(s))return!0;a++}return!1},U=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},$={},H={},V={INDEXEDDB:T,WEBSQL:G,LOCALSTORAGE:Y},K=[V.INDEXEDDB._driver,V.WEBSQL._driver,V.LOCALSTORAGE._driver],q=["dropInstance"],z=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(q),J={description:"",driver:K.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function Q(e,t){e[t]=function(){var n=arguments;return e.ready().then((function(){return e[t].apply(e,n)}))}}function Z(){for(var e=1;e<arguments.length;e++){var t=arguments[e];if(t)for(var n in t)t.hasOwnProperty(n)&&(U(t[n])?arguments[0][n]=t[n].slice():arguments[0][n]=t[n])}return arguments[0]}var ee=new(function(){function e(t){for(var n in function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),V)if(V.hasOwnProperty(n)){var s=V[n],r=s._driver;this[n]=r,$[r]||this.defineDriver(s)}this._defaultConfig=Z({},J),this._config=Z({},this._defaultConfig,t),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch((function(){}))}return e.prototype.config=function(e){if("object"===(void 0===e?"undefined":s(e))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var t in e){if("storeName"===t&&(e[t]=e[t].replace(/\W/g,"_")),"version"===t&&"number"!=typeof e[t])return new Error("Database version must be a number.");this._config[t]=e[t]}return!("driver"in e)||!e.driver||this.setDriver(this._config.driver)}return"string"==typeof e?this._config[e]:this._config},e.prototype.defineDriver=function(e,t,n){var s=new o((function(t,n){try{var s=e._driver,r=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!e._driver)return void n(r);for(var a=z.concat("_initStorage"),l=0,c=a.length;l<c;l++){var u=a[l];if((!X(q,u)||e[u])&&"function"!=typeof e[u])return void n(r)}!function(){for(var t=function(e){return function(){var t=new Error("Method "+e+" is not implemented by the current driver"),n=o.reject(t);return i(n,arguments[arguments.length-1]),n}},n=0,s=q.length;n<s;n++){var r=q[n];e[r]||(e[r]=t(r))}}();var h=function(n){$[s]&&console.info("Redefining LocalForage driver: "+s),$[s]=e,H[s]=n,t()};"_support"in e?e._support&&"function"==typeof e._support?e._support().then(h,n):h(!!e._support):h(!0)}catch(e){n(e)}}));return l(s,t,n),s},e.prototype.driver=function(){return this._driver||null},e.prototype.getDriver=function(e,t,n){var s=$[e]?o.resolve($[e]):o.reject(new Error("Driver not found."));return l(s,t,n),s},e.prototype.getSerializer=function(e){var t=o.resolve(k);return l(t,e),t},e.prototype.ready=function(e){var t=this,n=t._driverSet.then((function(){return null===t._ready&&(t._ready=t._initDriver()),t._ready}));return l(n,e,e),n},e.prototype.setDriver=function(e,t,n){var s=this;U(e)||(e=[e]);var r=this._getSupportedDrivers(e);function a(){s._config.driver=s.driver()}function i(e){return s._extend(e),a(),s._ready=s._initStorage(s._config),s._ready}var c=null!==this._driverSet?this._driverSet.catch((function(){return o.resolve()})):o.resolve();return this._driverSet=c.then((function(){var e=r[0];return s._dbInfo=null,s._ready=null,s.getDriver(e).then((function(e){s._driver=e._driver,a(),s._wrapLibraryMethodsWithReady(),s._initDriver=function(e){return function(){var t=0;return function n(){for(;t<e.length;){var r=e[t];return t++,s._dbInfo=null,s._ready=null,s.getDriver(r).then(i).catch(n)}a();var l=new Error("No available storage method found.");return s._driverSet=o.reject(l),s._driverSet}()}}(r)}))})).catch((function(){a();var e=new Error("No available storage method found.");return s._driverSet=o.reject(e),s._driverSet})),l(this._driverSet,t,n),this._driverSet},e.prototype.supports=function(e){return!!H[e]},e.prototype._extend=function(e){Z(this,e)},e.prototype._getSupportedDrivers=function(e){for(var t=[],n=0,s=e.length;n<s;n++){var r=e[n];this.supports(r)&&t.push(r)}return t},e.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0,t=z.length;e<t;e++)Q(this,z[e])},e.prototype.createInstance=function(t){return new e(t)},e}());t.exports=ee},{3:3}]},{},[4])(4)}).call(this,n(35))},function(e,t,n){var s,r=function(){var e=String.fromCharCode,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",s={};function r(e,t){if(!s[e]){s[e]={};for(var n=0;n<e.length;n++)s[e][e.charAt(n)]=n}return s[e][t]}var a={compressToBase64:function(e){if(null==e)return"";var n=a._compress(e,6,(function(e){return t.charAt(e)}));switch(n.length%4){default:case 0:return n;case 1:return n+"===";case 2:return n+"==";case 3:return n+"="}},decompressFromBase64:function(e){return null==e?"":""==e?null:a._decompress(e.length,32,(function(n){return r(t,e.charAt(n))}))},compressToUTF16:function(t){return null==t?"":a._compress(t,15,(function(t){return e(t+32)}))+" "},decompressFromUTF16:function(e){return null==e?"":""==e?null:a._decompress(e.length,16384,(function(t){return e.charCodeAt(t)-32}))},compressToUint8Array:function(e){for(var t=a.compress(e),n=new Uint8Array(2*t.length),s=0,r=t.length;s<r;s++){var o=t.charCodeAt(s);n[2*s]=o>>>8,n[2*s+1]=o%256}return n},decompressFromUint8Array:function(t){if(null==t)return a.decompress(t);for(var n=new Array(t.length/2),s=0,r=n.length;s<r;s++)n[s]=256*t[2*s]+t[2*s+1];var o=[];return n.forEach((function(t){o.push(e(t))})),a.decompress(o.join(""))},compressToEncodedURIComponent:function(e){return null==e?"":a._compress(e,6,(function(e){return n.charAt(e)}))},decompressFromEncodedURIComponent:function(e){return null==e?"":""==e?null:(e=e.replace(/ /g,"+"),a._decompress(e.length,32,(function(t){return r(n,e.charAt(t))})))},compress:function(t){return a._compress(t,16,(function(t){return e(t)}))},_compress:function(e,t,n){if(null==e)return"";var s,r,a,o={},i={},l="",c="",u="",h=2,d=3,p=2,f=[],m=0,g=0;for(a=0;a<e.length;a+=1)if(l=e.charAt(a),Object.prototype.hasOwnProperty.call(o,l)||(o[l]=d++,i[l]=!0),c=u+l,Object.prototype.hasOwnProperty.call(o,c))u=c;else{if(Object.prototype.hasOwnProperty.call(i,u)){if(u.charCodeAt(0)<256){for(s=0;s<p;s++)m<<=1,g==t-1?(g=0,f.push(n(m)),m=0):g++;for(r=u.charCodeAt(0),s=0;s<8;s++)m=m<<1|1&r,g==t-1?(g=0,f.push(n(m)),m=0):g++,r>>=1}else{for(r=1,s=0;s<p;s++)m=m<<1|r,g==t-1?(g=0,f.push(n(m)),m=0):g++,r=0;for(r=u.charCodeAt(0),s=0;s<16;s++)m=m<<1|1&r,g==t-1?(g=0,f.push(n(m)),m=0):g++,r>>=1}0==--h&&(h=Math.pow(2,p),p++),delete i[u]}else for(r=o[u],s=0;s<p;s++)m=m<<1|1&r,g==t-1?(g=0,f.push(n(m)),m=0):g++,r>>=1;0==--h&&(h=Math.pow(2,p),p++),o[c]=d++,u=String(l)}if(""!==u){if(Object.prototype.hasOwnProperty.call(i,u)){if(u.charCodeAt(0)<256){for(s=0;s<p;s++)m<<=1,g==t-1?(g=0,f.push(n(m)),m=0):g++;for(r=u.charCodeAt(0),s=0;s<8;s++)m=m<<1|1&r,g==t-1?(g=0,f.push(n(m)),m=0):g++,r>>=1}else{for(r=1,s=0;s<p;s++)m=m<<1|r,g==t-1?(g=0,f.push(n(m)),m=0):g++,r=0;for(r=u.charCodeAt(0),s=0;s<16;s++)m=m<<1|1&r,g==t-1?(g=0,f.push(n(m)),m=0):g++,r>>=1}0==--h&&(h=Math.pow(2,p),p++),delete i[u]}else for(r=o[u],s=0;s<p;s++)m=m<<1|1&r,g==t-1?(g=0,f.push(n(m)),m=0):g++,r>>=1;0==--h&&(h=Math.pow(2,p),p++)}for(r=2,s=0;s<p;s++)m=m<<1|1&r,g==t-1?(g=0,f.push(n(m)),m=0):g++,r>>=1;for(;;){if(m<<=1,g==t-1){f.push(n(m));break}g++}return f.join("")},decompress:function(e){return null==e?"":""==e?null:a._decompress(e.length,32768,(function(t){return e.charCodeAt(t)}))},_decompress:function(t,n,s){var r,a,o,i,l,c,u,h=[],d=4,p=4,f=3,m="",g=[],y={val:s(0),position:n,index:1};for(r=0;r<3;r+=1)h[r]=r;for(o=0,l=Math.pow(2,2),c=1;c!=l;)i=y.val&y.position,y.position>>=1,0==y.position&&(y.position=n,y.val=s(y.index++)),o|=(i>0?1:0)*c,c<<=1;switch(o){case 0:for(o=0,l=Math.pow(2,8),c=1;c!=l;)i=y.val&y.position,y.position>>=1,0==y.position&&(y.position=n,y.val=s(y.index++)),o|=(i>0?1:0)*c,c<<=1;u=e(o);break;case 1:for(o=0,l=Math.pow(2,16),c=1;c!=l;)i=y.val&y.position,y.position>>=1,0==y.position&&(y.position=n,y.val=s(y.index++)),o|=(i>0?1:0)*c,c<<=1;u=e(o);break;case 2:return""}for(h[3]=u,a=u,g.push(u);;){if(y.index>t)return"";for(o=0,l=Math.pow(2,f),c=1;c!=l;)i=y.val&y.position,y.position>>=1,0==y.position&&(y.position=n,y.val=s(y.index++)),o|=(i>0?1:0)*c,c<<=1;switch(u=o){case 0:for(o=0,l=Math.pow(2,8),c=1;c!=l;)i=y.val&y.position,y.position>>=1,0==y.position&&(y.position=n,y.val=s(y.index++)),o|=(i>0?1:0)*c,c<<=1;h[p++]=e(o),u=p-1,d--;break;case 1:for(o=0,l=Math.pow(2,16),c=1;c!=l;)i=y.val&y.position,y.position>>=1,0==y.position&&(y.position=n,y.val=s(y.index++)),o|=(i>0?1:0)*c,c<<=1;h[p++]=e(o),u=p-1,d--;break;case 2:return g.join("")}if(0==d&&(d=Math.pow(2,f),f++),h[u])m=h[u];else{if(u!==p)return null;m=a+a.charAt(0)}g.push(m),h[p++]=a+m.charAt(0),a=m,0==--d&&(d=Math.pow(2,f),f++)}}};return a}();void 0===(s=function(){return r}.call(t,n,t,e))||(e.exports=s)},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Engine=void 0;const i=o(n(4)),l=a(n(136)),c=n(376),u=n(373);t.Engine=class{constructor(e){this.isGUICommand=()=>!1,this.doGUICommand=null,this.nextActor=null,this.animation=null,this.animationCallback=null,this._levelMap={},this._activeLevels=[],this._scheduler=new l.Scheduler,this._msg=new u.MessageHandler(e),this._eventPool=e,this.visibleCells=[],this.timeOfDay=0,this._cache={visibleCoord:{},visibleValid:!1},this.sysMan=new c.SystemManager(this,e),this.hasNotify=!0,this._eventPool.listenEvent(i.default.EVT_DESTROY_ITEM,this),this._eventPool.listenEvent(i.default.EVT_ACT_COMP_ENABLED,this),this._eventPool.listenEvent(i.default.EVT_ACT_COMP_DISABLED,this),this._eventPool.listenEvent(i.default.EVT_LEVEL_PROP_ADDED,this),this._eventPool.listenEvent(i.default.EVT_LEVEL_CHANGED,this),this._eventPool.listenEvent(i.default.EVT_ANIMATION,this),this._eventPool.listenEvent(i.default.EVT_ACTOR_KILLED,this),this.debugEnabled=!1,this.traceIDs={}}setSystemArgs(e){this.sysMan.setSystemArgs(e)}getMessages(){return this._msg.getMessages()}getMsgHistory(){return this._msg.getHistory()}hasNewMessages(){return this._msg.hasNew()}clearMessages(){this._msg.clear()}setRNG(e){this.sysMan.setRNG(e)}isMenuShown(){if(!this.hasAnimation()&&this.nextActor.isPlayer()){return this.nextActor.getBrain().isMenuShown()}return!1}getPlayer(){return this.currPlayer}setPlayer(e){this.currPlayer=e}removePlayer(){this.currPlayer=null}numActiveLevels(){return this._activeLevels.length}hasLevel(e){return this._levelMap.hasOwnProperty(e.getID())}getLevels(){return Object.values(this._levelMap)}isGameOver(){return!1}isActiveLevel(e){return this._activeLevels.indexOf(e.getID())>=0}hasAnimation(){return null!==this.animation&&this.animation.hasFrames()}finishAnimation(){this.animation=null}setVisibleArea(e,t){this.visibleLevelID=e.getID(),this.visibleCells=t,this._cache.visibleCoord={},this._cache.visibleValid=!1}canPlayerSeeAnimation(e){return e.levelID===this.visibleLevelID&&(this._cache.visibleValid||(this.visibleCells.forEach(e=>{this._cache.visibleCoord[e.getKeyXY()]=!0}),this._cache.visibleValid=!0),e.hasCoord(this._cache.visibleCoord))}enableAnimations(){this.sysMan.get("Animation").enableAnimations()}disableAnimations(){this.sysMan.get("Animation").disableAnimations()}addTimeSystem(e,t){const n=new l.GameEvent(100,t.update.bind(t),!0,0);this.addEvent(n)}addRegularUpdate(e,t=100){const n=new l.GameEvent(t,e.update.bind(e),!0,0);this.addEvent(n)}getComponents(){const e=this.getEntities();let t=[];return e.forEach(e=>{const n=Object.keys(e.getComponents());t=t.concat(n.map(e=>parseInt(e,10)))}),t}getEntities(){const e=this.getLevels();let t=[];return e.forEach(e=>{t=t.concat(e.getActors()),t=t.concat(e.getItems()),t=t.concat(e.getElements())}),t}updateGameLoop(e){this.playerCommand(e),this.currPlayer=this.nextActor,this.sysMan.updateLoopSystems();const t={timeOfDay:this.timeOfDay};this.nextActor=this.getNextActor();let n=this.nextActor;this.debugEnabled&&n.getID&&this.traceIDs[n.getID()]&&console.debug("updateGameLoop out-of-while ID:",n.getID());let s=1e4,r=0;for(;!this.nextActor.isPlayer()&&!this.isGameOver();){this.debugEnabled&&(n=this.nextActor,n.getID&&this.traceIDs[n.getID()]&&console.debug(r,"updateGameLoop start, ID:",n.getID()));const e=this.nextActor.nextAction(t);if(this.doAction(e),this.sysMan.updateSystems(),this._scheduler.setAction(e),this.debugEnabled&&(n=this.nextActor,n.getID&&this.traceIDs[n.getID()]&&console.debug(r,"updateGameLoop loop end, ID:",n.getID())),this.nextActor=this.getNextActor(),n=this.nextActor,this.debugEnabled&&n.getID&&this.traceIDs[n.getID()]&&console.debug(r,"updateGameLoop next will be, ID:",n.getID()),n.has&&n.has("Dead")&&i.default.err("Engine","simulateGame","Tried to schedule Dead actor ID: "+n.getID()),!this.nextActor){i.default.err("Game.Engine","updateGameLoop","Game loop out of events! Fatal!");break}if(--s,s<=0){i.default.err("Engine","updateGameLoop","GameLoop stuck. 10K events taken, no player");break}++r}this.isGameOver()||this.setPlayer(this.nextActor)}playerCommand(e){!1===this.nextActor.isPlayer()&&this.nextActorNotPlayerError();const t=this.nextActor,n=t.get("Action");n.setStatus(i.default.ACTION_OK);const s=t.nextAction(e);if(this.doAction(s),this.sysMan.updateSystems(),t.has("PlayerCmdInfo")){t.get("PlayerCmdInfo").getImpossibleCmd()?t.remove("PlayerCmdInfo"):this._scheduler.setAction(s)}else this._scheduler.setAction(s);const r=n.getMsg();""!==r&&(i.default.gameDanger({cell:t.getCell(),msg:r}),t.get("Action").setMsg("")),this.playerCommandCallback(t)}simulateGame(e=1){const t={timeOfDay:this.timeOfDay};for(let n=0;n<e;n++){this.nextActor=this.getNextActor();const e=this.nextActor;if(e.has&&e.has("Dead")&&i.default.err("Engine","simulateGame","Tried to schedule Dead actor ID: "+e.getID()),this.nextActor.isPlayer())i.default.err("Engine","simulateGame","Doesn't work with player.");else{const e=this.nextActor.nextAction(t);this.doAction(e),this.sysMan.updateSystems(),this._scheduler.setAction(e)}}}addLevel(e){const t=e.getID();this._levelMap.hasOwnProperty(t)?i.default.err("Game.Engine","addLevel","Level ID "+t+" already exists!"):this._levelMap[e.getID()]=e}removeLevels(e){e.forEach(e=>{const t=e.getID();if(this._levelMap.hasOwnProperty(t)){const e=this._activeLevels.indexOf(t);if(e>=0){this._activeLevels.splice(e,1);const n=this._levelMap[t];if(n){const e=n.getActors();for(let t=0;t<e.length;t++)e[t].get("Action").disable()}}delete this._levelMap[t]}else i.default.err("Game.Engine","removeLevels","No level with ID "+t)})}addActiveLevel(e){const t=e.getID(),n=this._activeLevels.indexOf(t);if(this._activeLevels.length===i.default.MAX_ACTIVE_LEVELS)if(-1===n){const e=this._activeLevels.pop(),t=this._levelMap[e];if(t){const e=t.getActors();for(let t=0;t<e.length;t++){const n=e[t].get("Action");n&&n.disable()}i.default.debug(this,"Removed active level to make space...")}else{const t=Object.keys(this._levelMap).join(", ");i.default.err("Game.Engine","addActiveLevel",`Failed to remove level ID ${e}.\n                        IDs: ${t}`)}}else this._activeLevels.splice(n,1),this._activeLevels.unshift(t),i.default.debug(this,"Moved level to the front of active levels.");if(-1===n){this._activeLevels.unshift(t);const n=e.getActors();for(let e=0;e<n.length;e++){const t=n[e].get("Action");t&&t.enable()}}else this._activeLevels.splice(n,1),this._activeLevels.unshift(t)}getFirstActiveLevel(){0===this._activeLevels.length&&i.default.err("Engine","getFirstActiveLevel","No active levels in Engine");const e=this._activeLevels[0];return this._levelMap[e]}notify(e,t){if(e===i.default.EVT_DESTROY_ITEM){const e=t.item;if(!e.getTopOwner().getInvEq().removeItem(e)){const t=JSON.stringify(e);i.default.err("Game.Engine","notify - DESTROY_ITEM","Failed to remove item from inventory: "+t)}}else if(e===i.default.EVT_ACT_COMP_ENABLED)t.hasOwnProperty("actor")?(this.addActor(t.actor),this.traceIDs[t.actor.getID()]&&console.debug("EVT_ACT_COMP_ENABLED Added actor with ID: ",t.actor.getID())):i.default.err("Game.Engine","notify - ACT_COMP_ENABLED","No actor specified for the event.");else if(e===i.default.EVT_ACT_COMP_DISABLED)t.hasOwnProperty("actor")?this.removeActor(t.actor):i.default.err("Game","notify - ACT_COMP_DISABLED","No actor specified for the event.");else if(e===i.default.EVT_LEVEL_PROP_ADDED){if("actors"===t.propType&&this.isActiveLevel(t.level)){const e=t.obj;this.traceIDs[e.getID()]&&console.debug("Enabling Action comp for: ",e.getID()),t.obj.get("Action").enable()}}else if(e===i.default.EVT_LEVEL_CHANGED){const e=t.actor;e.isPlayer()&&(this.addActiveLevel(e.getLevel()),t.src.onExit(),t.src.onFirstExit(),t.target.onEnter(),t.target.onFirstEnter())}else if(e===i.default.EVT_ACTOR_KILLED){if(t.hasOwnProperty("actor")){if(this.debugEnabled&&this.traceIDs[t.actor.getID()]){const e=t.actor.getID();console.debug(`@@Actor ID${e} killed. Remove from scheduler/Engine now`)}this.removeActor(t.actor)}}else e===i.default.EVT_ANIMATION&&this.canPlayerSeeAnimation(t.animation)&&this.animationCallback&&(this.animation?this.animation.combine(t.animation):this.animation=t.animation,this.animationCallback(this.animation))}update(e){if(this.isGameOver())this.clearMessages(),this._eventPool.emitEvent(i.default.EVT_MSG,{msg:"GAME OVER!"}),this.simulateGame(100);else if(this.clearMessages(),null!==this.nextActor)if(e.hasOwnProperty("code")){const t=e.code;!this.isMenuShown()&&this.isGUICommand(t)?(this.doGUICommand(t),this.playerCommandCallback(this.nextActor)):this.updateGameLoop({code:t})}else this.updateGameLoop(e)}getNextActor(){return this._scheduler.next()}addActor(e){this.debugEnabled&&this.traceIDs[e.getID()]&&console.log("Engine: Added actor with ID "+e.getID()),e.isPlayer()&&e.has("Dead")||this._scheduler.add(e,!0,0)}removeActor(e){const t=this._scheduler.remove(e);if(this.debugEnabled&&this.traceIDs[e.getID()]&&console.debug("Engine rm from scheduler: ",JSON.stringify(e)),!t){const t=`ID: ${e.getID()}, ${e.getName()}`;i.default.err("Engine","removeActor","Failed to remove actor from scheduler: "+t)}}addDebugTraceID(e){this.traceIDs[e]=!0,this.sysMan.addDebugTraceID(e)}addEvent(e){const t=e.getRepeat(),n=e.getOffset();this._scheduler.add(e,t,n)}doAction(e){if(e.doAction(),e.hasOwnProperty("energy")&&e.hasOwnProperty("actor")){const t=e.actor;t.has("Action")&&t.get("Action").addEnergy(e.energy)}}toJSON(){return{msgHandler:this._msg.toJSON(),activeLevels:this._activeLevels}}nextActorNotPlayerError(){let e="";if(this.nextActor.hasOwnProperty("isEvent"))e="Expected player, got an event: ";else{e="Expected player, got: "+this.nextActor.getName()}e+="\n"+JSON.stringify(this.nextActor),i.default.err("Engine","playerCommand",e)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Elem2Items=t.Elem2Floor=void 0;const s=n(18);t.Elem2Floor={wall:s.ELEM.FLOOR,walldungeon:s.ELEM.FLOOR_DUNGEON,wallwooden:s.ELEM.FLOOR_HOUSE,wallcave:s.ELEM.FLOOR_CAVE,wallcrypt:s.ELEM.FLOOR_CRYPT,wallcastle:s.ELEM.FLOOR_CASTLE,wallruby:s.ELEM.FLOOR_DUNGEON,wallforium:s.ELEM.FLOOR_DUNGEON,wallvoid:s.ELEM.FLOOR_DUNGEON},t.Elem2Items={wall:{always:["piece of stone"],rand:{nothing:97,goldcoin:3}},walldungeon:{always:["piece of stone"],rand:{nothing:90,goldcoin:5}},wallwooden:{always:["piece of wood"]},wallcave:{always:["piece of stone"],rand:{nothing:200,goldcoin:16,"iron ore":8,"copper ore":8,amethyst:8,topaz:4,"mithril ore":4,sapphire:2,emerald:2,"adamantium ore":2,diamond:1}},wallcrypt:{always:["piece of stone"],rand:{nothing:90,goldcoin:3,topaz:3,amethyst:3,"lapis lazuli":3}},wallcastle:{always:["piece of stone"],rand:{nothing:90,goldcoin:10}},wallice:{always:["piece of ice"],rand:{nothing:90,"permaice ore":3,"ice diamond":1,froststone:3,"adamantium ore":4}},wallruby:{always:["ruby glass ore"],rand:{nothing:90,ruby:10}},wallforium:{always:["forium ore"],rand:{nothing:90,foriphire:10}},wallvoid:{always:["netherium ore"],rand:{nothing:90,nethermond:10}}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GameMaster=void 0;const i=o(n(4)),l=n(222),c=n(166),u=n(54),h=n(9),d=n(30),p=n(28),f=n(13),m=n(45),g=n(159),y=n(16),v=n(23),b=a(n(11)),_=n(15)("bitn:GameMaster"),E=v.EventPool.getPool(),S=h.Random.getRNG();t.GameMaster=class{constructor(e,t=E){this.player=null,this.game=e,this.fact=new l.FactoryBattle,this.pool=t,this.battles={},this.battlesDone={},this.hasBattleSpawned={},this.hasNotify=!0,this.pool.listenEvent(i.default.EVT_LEVEL_CHANGED,this),this.pool.listenEvent(i.default.EVT_TILE_CHANGED,this),this.pool.listenEvent(i.default.EVT_BATTLE_OVER,this),this.pool.listenEvent(i.default.EVT_CREATE_BATTLE,this),this.pool.listenEvent(i.default.EVT_CREATE_ZONE,this)}setDebug(e){_.enabled=e}setBattles(e){this.battles=e}setPool(e){this.pool=e}setGame(e){this.game=e}setPlayer(e){this.player=e}setWorld(e){this.world=e}notify(e,t){if(e===i.default.EVT_LEVEL_CHANGED){_("EVT_LEVEL_CHANGED");const{actor:e}=t;e.isPlayer()&&(e.has("InBattle")?this.removePlayerFromBattle(t):this.tryToAddPlayerToBattle(t))}else if(e===i.default.EVT_CREATE_BATTLE){_("EVT_CREATE_BATTLE");const{areaTile:e}=t;t.response&&i.default.err("GameMaster","notify<EVT_CREATE_BATTLE>","Args has response already: "+JSON.stringify(t));const n=e.getLevel(),s=this.createBattleIntoAreaTileLevel(n);s&&(t.response={battle:s})}else if(e===i.default.EVT_TILE_CHANGED){if(_("EVT_TILE_CHANGED"),!this.player)return void _("\tBut player is NULL for the moment");_("\tPlayer not null. Creating battle");const e=this.player.getLevel();this.hasBattleSpawned[e.getID()]||this.createBattleIntoAreaTileLevel(e)}else if(e===i.default.EVT_EXPLORED_ZONE_LEFT)i.default.diag("Explored zone left");else if(e===i.default.EVT_BATTLE_OVER){const{battle:e}=t;_("EVT_BATTLE_OVER: "+e.getName());const n=e.getLevel().getID();if(_(`1. battlesDone for ${n}: ${this.battlesDone[n]}`),!this.battlesDone[n]&&e){_(`2. battlesDone for ${n}: ${this.battlesDone[n]}`),this.battlesDone[n]=!0,_(`3. battlesDone for ${n}: ${this.battlesDone[n]}`),this.addBadgesForActors(e),this.moveActorsOutOfBattle(e),this.createBattleEvent(e);const t=e.getName();i.default.gameMsg(`Battle ${t} is over!`)}else{const e=JSON.stringify(t);i.default.err("Game.Master","notify",`Args ${e} does not contain "battle"`)}_("GameMaster registered battle over")}else if(e===i.default.EVT_CREATE_ZONE){const{areaTile:e,level:n,cell:s,zoneConf:r}=t;this.createZoneIntoAreaTileLevel(e,n,s,r)}}getLevelBbox(e,t,n,s,r){const[a,o]=[e.getSizeX(),e.getSizeY()],[i,l]=s,[c,u]=[t.getSizeX(),t.getSizeY()],[h,p]=r.getColsRows(),f=c*h/a,m=u*p/o,g=i%(a/c),y=l%(o/u);return d.BBox.fromBBox({ulx:g*f,uly:y*m,lrx:(g+1)*f-1,lry:(y+1)*m-1})}tryToAddPlayerToBattle(e){const{actor:t,target:n,src:s}=e,r=s.getID();if(this.battles.hasOwnProperty(r)){_("tryToAddPlayerToBattle",r,"->",n.getID());const e=this.getBattle(r,n.getID());if(!e||e.isJSON)return;const s=e;if(s.getLevel().getID()===n.getID())if(this.actorCanEnter(t,s)){const e=new b.InBattle;e.setData({name:s.getName()}),t.add(e);const n=this.getSelArmyObject(t,s);t.getBrain().setSelectionObject(n)}else s.isOver()?i.default.gameMsg("Looks like the battle is already fought.."):i.default.gameMsg("You cannot join the fight anymore, deserter.")}}addBattle(e,t){this.battles.hasOwnProperty(e)||(this.battles[e]=[]),this.battles[e].push(t)}getBattle(e,t){return this.battles[e].find(e=>{if(e.isJSON)return!1;return e.getLevel().getID()===t})}getBattles(e){return this.battles[e]}actorCanEnter(e,t){return!t.isOver()&&!this.actorDesertedBattle(e,t)}removePlayerFromBattle(e){const{actor:t,target:n,src:s}=e,r=n.getID(),a=s.getID(),o=this.getBattle(r,a),l=o.getLevel().getID(),c=t.get("InBattle").getData();if(a!==l){const e=`Level ID mismatch: ${a} !== ${l}`;i.default.err("GameMaster","removePlayerFromBattle",e)}if(!o.isOver()&&c.army){const e=new b.BattleBadge;e.setData({status:"Fled",name:o.getName(),army:c.army}),t.add(e),t.remove("InBattle"),t.add(new b.BattleOver)}else o.isOver()||c.army||t.remove("InBattle")}addBadgesForActors(e){e.getArmies().forEach(t=>{const n=t.getActors(),s=n.map(e=>e.getID());n.forEach(n=>{if(!this.actorDesertedBattle(n,e)){const r=new b.BattleBadge,a={name:e.getName(),id:e.getID(),army:t.getName(),allies:s,status:t.isDefeated()?"Lost":"Won"};r.setData(a),n.add(r),n.remove("InBattle"),n.add(new b.BattleOver)}})})}actorDesertedBattle(e,t){return!!e.getList("BattleBadge").find(e=>e.getData().id===t.getID())}moveActorsOutOfBattle(e){const t=e.getLevel(),n=t.getConnections();n&&0!==n.length||i.default.err("Game.Master","moveActorsOutOfBattle","No exit connnection in level");const s=n[0].getTargetLevel();this.hasBattleSpawned[s.getID()]&&(this.hasBattleSpawned[s.getID()]=!1);e.getArmies().forEach(e=>{e.getActors().forEach(e=>{if(e.isInLevel(t))if(e.isPlayer()){const n=this.getLeaveBattleMenu(e,t);e.getBrain().setSelectionObject(n)}else if(t.removeActor(e))s.addActorToFreeCell(e);else{const t=JSON.stringify(e.toJSON());i.default.err("Game.Master","moveActorsOutOfBattle","level.removeActor failed for actor "+t)}})})}getSelArmyObject(e,t){const n=t.getArmies(),s=s=>{const r=n[s],a=t.getLevel();let o=r.getActors();const l=o.length,c=o[S.getUniformInt(0,l-1)],[u,h]=c.getXY();c.get("Action").disable(),r.removeActor(c),a.removeActor(c),o=r.getActors(),r.addActor(e),e.get("InBattle").updateData({army:r.getName}),e.has("Groups")||e.add(new b.Groups),e.get("Groups").addGroup(r.getID()),r.getActors().forEach(t=>{t.isEnemy(e)&&t.getBrain().getMemory().removeEnemy(e)}),a.moveActorTo(e,u,h)||i.default.err("GameMaster","getSelArmyObject",`Could not move player to ${u},${h}`)},r=n.map((e,t)=>[" Army "+e.getName(),s.bind(this,t)]);r.push(["Take no side",u.Menu.EXIT_MENU]);const a=new u.Menu.SelectRequired(r);return a.addPre("Please select an army to join:"),a}getLeaveBattleMenu(e,t){const n=[["Leave immediately",()=>{const n=t.getConnections()[0];if(t.moveActorTo(e,n.getX(),n.getY())){const t=new b.UseStairs;e.add(t);const n=e.getName();i.default.gameMsg(n+" leaves the battlefield")}else i.default.err("GameMaster","moveActorsOutOfBattle","Cannot move player to stairs cell")}],["Stay behind to scavenge the bodies of the dead.",u.Menu.EXIT_MENU]],s=new u.Menu.SelectRequired(n);return s.addPre("Battle is over! Do you want to leave battle?"),s}createBattleEvent(e){const t=e.getLevel(),n=new b.BattleEvent;n.setEventType(i.default.EVT_BATTLE_OVER),n.setBattle(e),t.add(n)}toJSON(){const e=Object.keys(this.battles),t={};return e.forEach(e=>{this.getBattles(parseInt(e,10)).forEach(n=>{t.hasOwnProperty(e)||(t[e]=[]),"function"==typeof n.toJSON?t[e].push(n.toJSON()):n.name?t[e].push(n):i.default.err("GameMaster","toJSON","Does not look like proper battle object.")})}),{battles:t,battlesDone:this.battlesDone,hasBattleSpawned:this.hasBattleSpawned}}unloadBattles(e){const t=e.getID();if(this.battles.hasOwnProperty(t)){const e=this.getBattles(t);this.battles[t]=[],e.forEach(e=>{if("function"==typeof e.toJSON){const n=e;n.isOver()||n.removeListeners(),this.battles[t].push(n.toJSON())}else i.default.err("GameMaster","unloadBattle",`Unload for level ${t} failed`)})}}biomeToLevelType(e){switch(e){case c.OW.BIOME.ARCTIC:case c.OW.BIOME.TUNDRA:return"arctic";case c.OW.BIOME.ALPINE:return"mountain";case c.OW.BIOME.TAIGA:default:return"forest"}}getBattleLevels(){const e=[];return Object.values(this.battles).forEach(t=>{t.forEach(t=>{t.isJSON||e.push(t.getLevel())})}),e}createBattleIntoAreaTileLevel(e){e||i.default.err("GameMaster","createBattleIntoAreaTileLevel","Parent level is null");const t=e.getID(),n=this.game.getOverWorld();let s=4,r=20;const a={};let o="forest",l=e.getBbox();if(n){const a=this.game.getCurrentWorld().getAreas()[0],i=a.findTileXYById(t),c=2,u=a.getSizeY()-1,h=Math.abs(c-i[0]),d=Math.abs(u-i[1]);s+=h+d,r+=20*d+10*h;_(`${`dx,dy: ${h},${d} armySize ${r}`} , danger: ${s}`);const p=this.game.getPlayerOwPos();if(p){const t=n.getBiome(p[0],p[1]);o=this.biomeToLevelType(t),_("Creating battle on tile "+i),l=this.getLevelBbox(n,a,i,p,e)}}a.maxDanger=s,a.armySize=r,a.levelType=o,a.bbox=l;const c=this.fact.createBattle(e,a);this.addBattle(t,c);const u=c.getLevel().getID();return this.game.addBattle(this.getBattle(t,u),t),this.hasBattleSpawned[t]=!0,c}createZoneIntoAreaTileLevel(e,t,n,s){t.getID(),s.name;let r=(new p.FactoryLevel).createLevel("empty",60,30);if(t){const a=new m.City(s.name),o=new m.CityQuarter(s.name);a.tileX=e.getTileX(),a.tileY=e.getTileY(),a.addSubZone(o),e.addZone("city",a);const l=new y.ElementStairs("wilderness",t),c=t.getMap(),[u,h]=n.getXY();t.addStairs(l,u,h);const d=f.Geometry.getCellsAround(c,n);console.log("cellsAround are",d);const p={cellsAround:d,surroundX:20,surroundY:15};r=(new g.LevelSurroundings).surround(r,p),o.addLevel(r),m.World.addExitsToEdge(r),m.World.connectAreaConnToLevel(l,r,t),this.game.addLevel(r);const v="You discover a new place!";i.default.gameMsg({cell:n,msg:v})}}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ColorTestScreen=void 0;const r=s(n(4)),a=n(28),o=n(12),i=n(73);t.ColorTestScreen=class{constructor(e){let t=200;e.colorMode&&(t=r.default.COLORS.length+10);const n=new a.FactoryLevel;this.level=n.createLevel("empty",t,t),this.level.actorWarnLimit=1e5,e.colorMode?this.createColorMap(e.char):this.createObjectMap(e.propType)}static getConf(){return{colorMode:!1,char:"#",propType:r.default.TYPE_ITEM}}createColorMap(e){const t=o.ObjectShell.getParser();t.adjustColorsWhenNeeded=!1;this.level.getMap();r.default.COLORS.forEach((n,s)=>{r.default.COLORS.forEach((a,o)=>{const l="colors--fg: "+n+"_bg: "+a,c={name:l,color:i.color(n,a),type:"colortest",char:e};t.parseObjShell(r.default.TYPE_ACTOR,c);const u=t.createActor(l);this.level.addActor(u,o,s)})}),t.adjustColorsWhenNeeded=!0}createObjectMap(e){const t=o.ObjectShell.getParser(),n=this.level.getMap();for(let s=0;s<n.cols;s++)for(let a=0;a<n.rows;a++)if(e===r.default.TYPE_ACTOR){const e=t.createRandomActor({func:()=>!0});this.level.addActor(e,s,a)}else{const e=t.createRandomItem({func:()=>!0});this.level.addItem(e,s,a)}}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.QuestSlot=void 0;const i=a(n(1)),l=o(n(70)),c=o(n(4)),u=a(n(11)),h=o(n(59));class d extends i.Component{constructor(e){super(e),this.setSelectedQuest=this.setSelectedQuest.bind(this)}render(){const e=this.props.quest,t=e.getQuestID();let n=!1;return this.props.selectedQuest&&(n=t===this.props.selectedQuest.getQuestID()),i.createElement("li",{key:e.getQuestID(),onClick:this.setSelectedQuest},i.createElement("p",{className:n?"text-success":""},this.props.quest.toString()))}setSelectedQuest(){this.props.setSelectedQuest(this.props.quest)}}t.QuestSlot=d;class p extends i.Component{constructor(e){super(e),this.state={tabShown:"CharInfo"},this.setSelectedQuest=this.setSelectedQuest.bind(this)}selectTab(e){this.setState({tabShown:e})}toggleScreen(e){this.props.toggleScreen(e)}setSelectedQuest(e){this.setState({selectedQuest:e}),this.props.setSelectedQuest(e)}render(){const e=this.renderTabElement(this.state.tabShown),t=this.renderTabButtons();return i.createElement(h.default,{"aria-labelledby":"char-info-modal-label",id:"char-info-modal",large:!0,onHide:this.toggleScreen.bind(this,"CharInfo"),show:this.props.showCharInfo},i.createElement(l.default,{id:"char-info-modal-label",text:"Character info"}),t,e,i.createElement("div",{className:"modal-footer row"},i.createElement("div",{className:"col-md-6"},"Placeholder"),i.createElement("div",{className:"col-md-6"},i.createElement("button",{className:"btn btn-danger",onClick:this.toggleScreen.bind(this,"CharInfo"),type:"button"},"Close"))))}renderTabElement(e){const t=this.props.player;return t?"CharInfo"===e?this.renderCharInfoGeneral(t):"Effects"===e?this.renderEffectsTab(t):"Skills"===e?this.renderSkillsTab(t):"Battles"===e?this.renderBattlesTab(t):"Quests"===e?this.renderQuestsTab(t):null:null}renderTabButtons(){const e=p.menuTabs.map(e=>i.createElement("button",{className:"tab-select-button",key:e,onClick:this.selectTab.bind(this,e)},e));return i.createElement("ul",null,i.createElement("ul",{className:"modal-tab-list"},e))}renderCharInfoGeneral(e){let t="None";e.has("ActorClass")&&(t=e.get("ActorClass").getClassName());const n=e.get("Experience").getExpLevel(),s=e.get("Experience").getExp(),r=this.getExploreInfo(e),a=c.default.getExpRequired(n+1),o=a-s,l=c.default.getMissileAttackInfo(e),u=c.default.getMeleeAttackInfo(e);return i.createElement("div",null,i.createElement("div",{className:"modal-body row",id:"char-info-general"},i.createElement("div",{className:"col-md-6"},i.createElement("h2",null,"General info"),i.createElement("p",null,"Name: ",e.getName()),i.createElement("p",null,"Class: ",t),i.createElement("p",null,"Race: ",e.getType()),i.createElement("p",null,"Exp. level: ",n),i.createElement("p",null,"Exp. points: ",s),i.createElement("p",null,"To next level: ",o," (",a,")")),i.createElement("div",{className:"col-md-6"},i.createElement("h2",null,"Exploration"),r)),i.createElement("div",{className:"modal-body row"},i.createElement("div",{className:"col-md-6"},i.createElement("h2",null,"Combat info"),i.createElement("p",null,"Melee: ",u),i.createElement("p",null,"Missile: ",l)),i.createElement("div",{className:"col-md-6",id:"char-info-box"},i.createElement("h2",null,"Also random"),i.createElement("p",null,"Someting goes here."))))}renderEffectsTab(e){const t=Object.values(e.getComponents()).map((e,t)=>{const n=u[e.getType()].description;return n?i.createElement("p",{key:t},i.createElement("span",{className:"text-info"},e.getType())," - ",n):null});return i.createElement("div",{className:"modal-body row",id:"char-info-components"},i.createElement("div",{className:"col-md-6",id:"char-info-box"},i.createElement("h2",null,"List of effects on player"),t))}renderSkillsTab(e){let t=null;if(e.has("Skills")){const n=e.get("Skills");t=Object.keys(n.getSkills()).map(e=>i.createElement("li",{key:e},e," L: ",n.getLevel(e)," P: ",n.getPoints(e)))}else t=i.createElement("li",null,"Actor has no skills.");return i.createElement("div",{className:"modal-body row",id:"char-info-skills"},i.createElement("div",{className:"col-md-6",id:"char-info-box"},i.createElement("h2",null,"List of Skills"),i.createElement("ul",null,t)))}renderBattlesTab(e){const t=e.getList("BattleBadge").map(e=>i.createElement("li",{key:e.getID()},i.createElement("p",null,"Name: ",e.getData().name,", Status: ",e.getData().status,", Kills: ",e.getData().kill)));return i.createElement("div",{className:"modal-body row",id:"char-info-battles"},i.createElement("div",{className:"col-md-6",id:"char-info-box"},i.createElement("h2",null,"Battles fought"),i.createElement("ul",null,t)))}renderQuestsTab(e){const t=e.getList("Quest").map(e=>i.createElement(d,{quest:e,setSelectedQuest:this.setSelectedQuest,selectedQuest:this.props.selectedQuest}));return i.createElement("div",{className:"modal-body row",id:"char-info-quests"},i.createElement("div",{className:"col-md-6",id:"char-info-box"},i.createElement("h2",null,"Quests received:"),i.createElement("ul",null,t)))}getExploreInfo(e){if(e.has("GameInfo")){const t=e.get("GameInfo").getData().zones,n=[];let s=0;return Object.keys(t).forEach((e,r)=>{const a=i.createElement("p",{key:e+"_"+r},e,": Explored ",t[e]," zones");n.push(a),s+=t[e]}),n.push(i.createElement("p",{key:"total-explored"},"Total number of places explored: ",s)),n}return i.createElement("p",null,"No exploration info available")}}t.default=p,p.menuTabs=["CharInfo","Effects","Skills","Battles","Quests"]},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1)),a=n(420);class o extends r.default.Component{constructor(e){super(e),this.handleSelect=this.handleSelect.bind(this)}handleSelect(e){const t=e.split("#"),n=t.shift();this.props.menuCallback(n,t)}render(){return r.default.createElement("div",{className:"game-top-menu"},r.default.createElement(a.Nav,{activeKey:"1",bsStyle:"tabs",onSelect:this.handleSelect},r.default.createElement(a.NavDropdown,{eventKey:"game",id:"dropdown-game",title:"Game"},r.default.createElement(a.MenuItem,{eventKey:"showScreen#StartScreen"},"New"),r.default.createElement(a.MenuItem,{eventKey:"showScreen#LoadScreen"},"Load"),r.default.createElement(a.MenuItem,{eventKey:"loadFromScript"},"Load from script"),r.default.createElement(a.MenuItem,{eventKey:"saveGame#saveGame"},"Save"),r.default.createElement(a.MenuItem,{eventKey:"importJSON"},"Import JSON"),r.default.createElement(a.MenuItem,{eventKey:"game-export"},"Export JSON"),r.default.createElement(a.MenuItem,{eventKey:"setPlayerDriver"},"Load bot")),r.default.createElement(a.NavDropdown,{eventKey:"view",id:"dropdown-view",title:"View"},r.default.createElement(a.MenuItem,{eventKey:"setViewSize#+#X"},"Viewport +X"),r.default.createElement(a.MenuItem,{eventKey:"setViewSize#-#X"},"Viewport -X"),r.default.createElement(a.MenuItem,{eventKey:"setViewSize#+#Y"},"Viewport +Y"),r.default.createElement(a.MenuItem,{eventKey:"setViewSize#-#Y"},"Viewport -Y"),r.default.createElement(a.MenuItem,{eventKey:"increaseFont#+"},"Increase Font"),r.default.createElement(a.MenuItem,{eventKey:"increaseFont#-"},"Decrease Font"),r.default.createElement(a.MenuItem,{eventKey:"useAsciiTiles"},"ASCII tiles"),r.default.createElement(a.MenuItem,{eventKey:"useGraphicalTiles"},"Graphical tiles")),r.default.createElement(a.NavDropdown,{eventKey:"help",id:"dropdown-help",title:"Help"},r.default.createElement(a.MenuItem,{eventKey:"showScreen#HelpScreen"},"Help"),r.default.createElement(a.MenuItem,{eventKey:"showScreen#ManualScreen"},"Manual"),r.default.createElement(a.MenuItem,{eventKey:"showScreen#AboutScreen"},"About")),r.default.createElement(a.NavDropdown,{eventKey:"plugins",id:"dropdown-plugins",title:"Plugin"},r.default.createElement(a.MenuItem,{eventKey:"loadScript"},"Load script"),r.default.createElement(a.MenuItem,{eventKey:"showPluginManager"},"Plugin Manager"))))}}t.default=o},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(1)),i=n(59);class l extends o.Component{constructor(e){super(e),this.state={progress:[]},this.onHide=this.onHide.bind(this)}render(){const e=this.renderProgressMsg();let t=null;const n=this.props.progress;if(n&&n.length>0)if("DONE"===n){const e=this.state.progress.length-1;let t=this.state.progress[e];t+=n,this.state.progress[e]=t}else this.state.progress.push(this.props.progress);return this.props.gameCreated&&(t=this.renderDoneButton()),o.createElement(i,{"aria-labelledby":"game-create-modal-label",id:"gameCreateModal",large:!0,onHide:this.onHide.bind(this),show:this.props.showCreateScreen},o.createElement(i.Header,{closeButton:!0},o.createElement(i.Title,{id:"game-start-modal-label"},"Creating the game")),o.createElement(i.Body,null,e),o.createElement(i.Footer,null,t))}onHide(){this.state.progress=[],this.toggleScreen("CreateScreen")}renderProgressMsg(){const e=this.state.progress.map((e,t)=>{const n=t+e.substring(0,1);return o.createElement("li",{className:"text-info",key:n},e)});return o.createElement("ul",null,e)}renderDoneButton(){return o.createElement("button",{className:"btn btn-success","data-dismiss":"modal",id:"embark-button",onClick:this.onHide,type:"button"},"Continue")}toggleScreen(e){this.props.toggleScreen(e)}}t.default=l},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(1));class i extends o.Component{shouldComponentUpdate(){return!1}render(){return o.createElement("input",{id:this.props.inputId,onChange:this.props.onLoadScript,style:{display:"none"},type:"file"})}}t.default=i},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(1));class i extends o.Component{constructor(e){super(e),this.state={msg:""}}render(){const{plugins:e}=this.props,t=this.renderPluginList(e),n=this.renderMsg();return o.createElement("div",{className:"plugin-manager"},o.createElement("h2",null,"Plugin manager"),o.createElement("p",null,"You can enable/disable loaded plugins from here. Tick the box below to enable plugin loading."),n,o.createElement("div",null,o.createElement("input",{id:"plugin-maybe-unsafe",name:"input-unsafe",type:"checkbox"}),"I understand the risk of loading scripts from untrusted sources."),t)}onDelete(e){this.props.pluginManager.deletePlugin(e),this.props.updatePluginList()}isUnsafeChecked(){return document.querySelector("#plugin-maybe-unsafe").checked}onChange(e){if(this.isUnsafeChecked()){const t=e.target,n=t.checked,s=t.name;n?this.props.pluginManager.enablePlugin(s):this.props.pluginManager.disablePlugin(s),this.setState({msg:""}),this.props.updatePluginList()}else{const e="You must tick the box before loading plugins.";this.setState({msg:e})}}renderMsg(){return""===this.state.msg?null:o.createElement("p",{className:"text-danger"},this.state.msg)}renderPluginList(e){const t=e.map(e=>{const t=e.getName(),n=this.onChange.bind(this),s=this.onDelete.bind(this,t),r=e.isEnabled(),a=e.hasError()?"text-danger":"";return o.createElement("tr",{key:t},o.createElement("td",null,((e,t,n)=>o.createElement("input",{checked:n,name:e,onChange:t,type:"checkbox"}))(t,n,r)),o.createElement("td",null,t),o.createElement("td",null,e._description),o.createElement("td",null,e._type),o.createElement("td",null,o.createElement("span",{className:a},e._status)),o.createElement("td",null,(e=>o.createElement("button",{className:"btn-xs btn-danger",onClick:e},"Delete"))(s)))});return o.createElement("table",{className:"table table-dark plugin-table"},o.createElement("thead",null,o.createElement("tr",null,o.createElement("th",null,"Enabled"),o.createElement("th",null,"Name"),o.createElement("th",null,"Description"),o.createElement("th",null,"Type"),o.createElement("th",null,"Status"),o.createElement("th",null))),o.createElement("tbody",null,t))}}t.default=i},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=a(n(1)),l=o(n(4)),c=o(n(802)),u=n(411);class h extends i.Component{constructor(e){super(e),this.changeMapView=this.changeMapView.bind(this)}changeMapView(){this.props.showMap?this.props.setViewType(u.VIEW_PLAYER):this.props.setViewType(u.VIEW_MAP)}render(){const e=this.props.player,t=e.getName(),n=this.props.selectedItem,s=this.props.selectedCell,r=e.getBrain();let a="";n&&(a="Selected: "+n.getName());let o="";if(s&&s.hasActors()){o="Cell: "+s.getProp("actors")[0].getName()}let u="Move: ",h="text-info";r.isRunModeEnabled()?(u+=" Running",h="text-danger"):u+=" Walking";const d=r.getFightMode();let p="Fight: ";d===l.default.FMODE_NORMAL?p+="Normal":d===l.default.FMODE_SLOW?p+="Slow":d===l.default.FMODE_FAST&&(p+="Fast");const f=this.getPlayerStatus(e);let m="Map View";this.props.showMap&&(m="Player View");let g="";return this.props.questDir&&(g=this.props.questDir),i.createElement("div",{className:"game-stats"},i.createElement("p",null,t),i.createElement(c.default,{player:e}),i.createElement("ul",{className:"player-mode-list"},i.createElement("li",{className:h},u),i.createElement("li",{className:"text-primary"},p),i.createElement("li",{className:"text-warning"},a),i.createElement("li",{className:"text-danger"},o)),f,i.createElement("button",{className:"btn btn-xs btn-rg btn-info",id:"inventory-button",onClick:this.toggleScreen.bind(this,"Inventory")},"Inventory"),i.createElement("button",{className:"btn btn-xs btn-rg btn-info",id:"stats-button",onClick:this.toggleScreen.bind(this,"CharInfo")},"CharInfo"),i.createElement("button",{className:"btn btn-xs btn-rg btn-info",id:"map-player-button",onClick:this.changeMapView},m),i.createElement("button",{className:"btn btn-xs btn-rg btn-info",id:"show-overworld-button",onClick:this.toggleScreen.bind(this,"OWMap")},"Overworld"),""!==g&&i.createElement("p",null,"Quest: ",g))}toggleScreen(e){this.props.toggleScreen(e)}getPlayerStatus(e){const t=[];return u.STATUS_COMPS_GUI.forEach(n=>{const[s,r,a,o]=n;e.has(s)&&t.push(i.createElement("p",{className:"text-"+r,key:o},a))}),t}}t.default=h},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0});const o=a(n(1)),i=n(61);class l extends o.Component{constructor(e){super(e)}render(){const e=this.props.player,t=i.SentientActor.getFormattedStats(e),n=[];let s=0;for(const e in t)if(e){const r=t[e];if(Array.isArray(r)){const t=r[1];let a="",i="";t<0?(a="text-danger",i=`(${r[1]})`):t>0&&(a="text-success",i=`(+${r[1]})`),n.push(o.createElement("li",{className:a,key:e+","+s},e,": ",`${r[0]}${i}`))}else n.push(o.createElement("li",{key:e+","+s},e,": ",r));++s}return o.createElement("ul",{className:"game-stats-list"},n)}}t.default=l},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MultiKeyHandler=void 0;const r=s(n(4)),a=n(71),o=n(25),i={hasItems:()=>[o.Keys.KEY.PICKUP],hasConnection:()=>[o.Keys.KEY.USE_STAIRS_DOWN],hasUsable:()=>[]},l=["hasItems","hasConnection","hasUsable"],c={hasDoor:()=>[o.Keys.KEY.DOOR],hasActors:(e,t)=>{const n=r.default.dXdY(t,e),s=o.Keys.KeyMap.dirToKeyCode(n);return[o.Keys.KEY.CHAT,s]}},u=["hasDoor","hasActors"];t.MultiKeyHandler=class{getKeys(e){const t=e.getCell();for(let n=0;n<l.length;n++){const s=l[n];if(t[s]())return i[s](e,t)}const n=a.Brain.getCellsAroundActor(e);for(let t=0;t<u.length;t++){const s=u[t];for(let t=0;t<n.length;t++){const r=n[t];if(r[s]())return c[s](e,r)}}return null}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.ZoneContextProcessor=t.RandomContextProcessor=t.ExploreContextProcessor=t.AreaContextProcessor=t.EnemyContextProcessor=t.ContextProcessor=void 0;const r=s(n(4)),a=n(27),o=n(9),i=n(72),l=n(15)("bitn:ContextProcessor");l.enabled=!1;const c=o.Random.getRNG();class u{constructor(e,t){this.name=e,this.drv=t}processContext(){if(this.isWithinContext()){const e=this.drv.action;l.enabled&&console.log(`${this.name} isWithinContext() OK, start action |${e}|`);const t=this._process(),n=this.drv.action;return e!==n&&l.enabled&&console.log(`${this.name} modified action |${e}| -> |${n}|`),t}return!1}isWithinContext(){return!1}_process(){return!1}dbg(...e){l.enabled&&l(this.name+": ",...e)}}t.ContextProcessor=u;t.EnemyContextProcessor=class extends u{constructor(e,t){super(e,t),this.name=e,this.drv=t,this.ppRestLimit=c.getUniformRange(.1,.25),this.hpLow=c.getUniformRange(.1,.25),this.hpRestLimit=c.getUniformRange(.25,.5)}isWithinContext(){return!0}checkForEnemies(){const e=this.drv,t=e.player.getBrain(),n=a.Brain.getSeenHostiles(e.player);e.enemy=null,n.forEach(n=>{null===e.enemy&&n&&n.isEnemy(e.player)&&(e.enemy=n,this.hasEnoughHealth()?e.action="attack":t.isRunModeEnabled()?e.action="flee":e.action="run",e.state.path=[])}),""===e.action&&this.shouldRest()&&(e.action="rest")}hasEnoughHealth(){const e=this.drv.player.get("Health"),t=e.getMaxHP();return e.getHP()>Math.round(this.hpLow*t)}shouldRest(){const e=this.drv.player;if(e.has("SpellPower")){const t=e.get("SpellPower"),n=t.getPP(),s=t.getMaxPP();if(n<this.ppRestLimit*s)return!0}const t=e.get("Health"),n=t.getMaxHP();return t.getHP()<this.hpRestLimit*n}_process(){return this.checkForEnemies(),!0}};t.AreaContextProcessor=class extends u{constructor(e,t){super(e,t),this.name=e,this.drv=t,this.visitedLevels={},this.maxVisitWait=200}isWithinContext(){const e=this.drv.player.getLevel().getParent();return!!e&&"area"===e.getType()}hasVisited(e){return this.drv.nTurns-this.visitedLevels[e.getID()]<this.maxVisitWait}_process(){const e=this.drv.getPlayer(),t=e.getCell();if(t.hasPassage()){const e=t.getConnection().getTargetLevel();if(!this.hasVisited(e))return this.drv.action="stairs",this.visitedLevels[e.getID()]=this.drv.nTurns,!0}if(this.drv.hasPath())return this.drv.action="path",!0;{const t=e.getBrain().getSeenCells().filter(e=>e.hasPassage());if(t.length>0){console.log(`Found ${t.length} connections`);for(let e=0;e<t.length;e++){const n=t[e].getConnection(),s=n.getTargetLevel();if(!this.hasVisited(s)&&this.drv.setPathAction(n.getXY()))return!0}}}return!1}};t.ExploreContextProcessor=class extends u{constructor(e,t){super(e,t),this.name=e,this.drv=t}isWithinContext(){return!0}_process(){const e=this.drv.getPlayer(),t=e.getLevel().getMap(),[n,s]=t.getCellsInFOVPlus(e,1);if(s.length>0){const e=s.filter(e=>!e.isExplored());if(e.length>0){const t=c.arrayGetRand(e);if(this.drv.setPathAction(t.getXY()))return!0}}return!1}};t.RandomContextProcessor=class extends u{constructor(e,t){super(e,t),this.name=e,this.drv=t,this.prob=.1}isWithinContext(){return!0}_process(){if(this.drv.hasPath())return this.drv.action="path",!0;{const e=new i.GoalExplore(this.drv.player);e.setNewPassableDir();const t=c.getUniformInt(1,10),[n,s]=this.drv.player.getXY(),[a,o]=[n+t*e.dX,s+t*e.dY];if(this.drv.setPathAction([a,o]))return!0;{const[t,a]=[n+e.dX,s+e.dY];if(this.drv.setPathAction([t,a]))return!0;{const n=`Dir: ${[e.dX,e.dY]}, pXY: ${this.drv.player.getXY()}, impassable: ${[t,a]}`;this.drv.player.getLevel().debugPrintInASCII(),r.default.err("RandomContextProcessor","_process","Fallback proc failed! "+n)}}}return!1}};t.ZoneContextProcessor=class extends u{constructor(e,t){super(e,t),this.name=e,this.drv=t,this.reZones=/mountain|dungeon/,this.scannedLevels={},this.visitedStairs={},this.state={}}isWithinContext(){const e=this.drv.player.getLevel().getParentZone();return e?this.reZones.test(e.getType()):(this.state={},!1)}_process(){const e=this.drv.player.getLevel(),t=e.getID();let n=!1;if(this.scannedLevels[t]||this.scanLevel(e),this.scannedLevels[t].turnsExplored+=1,this.drv.hasPath())return this.drv.action="path",!0;{const e=this.scannedLevels[t].stairsDown,s=this.scannedLevels[t].stairsUp;if(0===e.length&&(this.state.goUp||(this.dbg("No stairsDown found. goUp triggered for "+t),this.state.goUp=!0),this.scannedLevels[t].turnsExplored<300))return!1;const r=this.drv.player.getCell();if(r.hasStairs())if(this.dbg("hasStairs() OK at "+r.getXY()),this.state.goUp){if("stairsUp"===r.getStairs().getName())return this.drv.action="stairs",this.addVisited(t,r.getXY()),!0}else if(!this.hasVisited(t,r.getXY()))return this.drv.action="stairs",this.addVisited(t,r.getXY()),!0;let a=[s];this.state.goUp||(a=[e,s]),a.forEach(e=>{e.forEach(e=>{n||!this.state.goUp&&this.hasVisited(t,e)||this.drv.setPathAction(e)&&(this.dbg(`Setting path to stairs ${r.getXY()} -> ${e}`),n=!0)})})}return n}hasVisited(e,t){const n=e+","+t[0]+","+t[1];return this.visitedStairs[n]}addVisited(e,t){const n=e+","+t[0]+","+t[1];this.visitedStairs[n]=!0}scanLevel(e){console.log(`${this.name} scanning level ${e.getID()} for stairs..`);const t={stairsUp:[],stairsDown:[],turnsExplored:0};e.getElements().forEach(e=>{"stairsDown"===e.getName()?t.stairsDown.push(e.getXY()):"stairsUp"===e.getName()&&t.stairsUp.push(e.getXY())}),this.scannedLevels[e.getID()]=t}}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.MyWorkerImport=void 0;const r=s(n(806));t.MyWorkerImport=r.default},function(e,t,n){e.exports=function(){return new Worker("https://tpoikela.github.io/battles/build/3ab96306c970b38cdb1f.worker.js")}},function(module,exports,__webpack_require__){"use strict";(function(global){var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PluginManager=exports.PluginEntry=void 0;const rg_1=__importDefault(__webpack_require__(4)),objectshellparser_1=__webpack_require__(12),chai_1=__webpack_require__(808),AllCode=__importStar(__webpack_require__(831)),PLUGIN_TYPES=["plugin","items","actors","elements","system","spell"];class PluginEntry{constructor(e){this._enabled=!1,this._type=e.type,this._data=e.data,this._name=e.name,this._description=e.description,this._fileType=e.fileType,this._status="UNLOADED",this._errorMsg="",this._test=e.test,this._onLoad=e.onLoad,this._onRemove=e.onRemove}getData(){return this._data}hasError(){return/ERROR/.test(this._status)}getError(){return this._errorMsg}disable(){if(this._enabled){if("function"==typeof this._onRemove)try{this._onRemove(),this._status="UNLOADED",this._errorMsg=""}catch(e){throw this._errorMsg=e.message,this._status="UNLOAD ERROR",new Error(`${this._name}: ${e.message}`)}this._enabled=!1}}enable(){if(!this._enabled){if("function"==typeof this._onLoad)try{this._onLoad(),this._status="LOADED",this._errorMsg=""}catch(e){throw this._errorMsg=e.message,this._status="LOAD ERROR",new Error(`${this._name}: ${e.message}`)}this._enabled=!0}}getName(){return this._name}getType(){return this._type}isEnabled(){return this._enabled}runTest(){this._test&&this._test(chai_1.expect)}toJSON(){return{type:this._type,fileType:this._fileType,name:this._name,data:this._data,description:this._description}}}exports.PluginEntry=PluginEntry;class PluginManager{constructor(){this.parseShellsOnRead=e=>{const t=e.getData(),n=e.getType();[rg_1.default.TYPE_ACTOR,rg_1.default.TYPE_ITEM,rg_1.default.TYPE_ELEM].forEach(e=>{if(n===e){objectshellparser_1.ObjectShell.getParser().parseShellCateg(e,t)}})},this._plugins=[],this._errorMsg="",this._readCallbacks={[rg_1.default.TYPE_ACTOR]:this.parseShellsOnRead,[rg_1.default.TYPE_ITEM]:this.parseShellsOnRead,[rg_1.default.TYPE_ELEM]:this.parseShellsOnRead},this._globalRefsWereSet=!1}static fromJSON(e){const t=new PluginManager;return e.forEach(e=>{"json"===e.fileType?t.readJSON(e):t.loadScript(e.data)}),t.enableAll(),t}readJSON(e){e.fileType="json";const t=this.addPlugin(e),n=t.getType();return this._readCallbacks[n]&&this._readCallbacks[n](t),t}loadScript(text){let entry=null;try{this.setGlobalRefs();let pluginData=null;eval(text),pluginData?(pluginData.data=text,pluginData.fileType="script",entry=this.addPlugin(pluginData),this._errorMsg=""):this._errorMsg="no pluginData specified in the script",this._globalRefsWereSet&&this.unsetGlobalRefs()}catch(e){throw this._errorMsg=e.message,this._globalRefsWereSet&&this.unsetGlobalRefs(),e}return entry}loadGameFromScript(text){const entry={levels:null,game:null};try{let game=null,levels=null;if(this.setGlobalRefs(),eval(text),game)entry.game=game;else{if(!levels)throw new Error("Script must set game or levels!");entry.levels=levels}this._globalRefsWereSet&&this.unsetGlobalRefs()}catch(e){throw this._errorMsg=e.message,this._globalRefsWereSet&&this.unsetGlobalRefs(),e}return entry}anyPluginsEnabled(){for(let e=0;e<this._plugins.length;e++)if(this._plugins[e].isEnabled())return!0;return!1}findPlugin(e){return this._plugins.find(t=>t._name===e)}getPlugins(){return this._plugins.slice()}getPluginNames(){return this._plugins.map(e=>e._name)}addPlugin(e){this.validateType(e);const t=new PluginEntry(e);return this._plugins.push(t),t}deletePlugin(e){const t=this._plugins.findIndex(t=>t.getName()===e);t>=0&&(this._plugins[t].disable(),this._plugins[t].hasError()&&(this._errorMsg=this._plugins[t].getError()),this._plugins.splice(t,1))}disablePlugin(e){const t=this.findPlugin(e);this._errorMsg="",t?(this.setGlobalRefs(),t.disable(),t.hasError()&&(this._errorMsg=t.getError()),this.unsetGlobalRefs()):this._errorMsg="Could not find plugin "+e}enablePlugin(e){const t=this.findPlugin(e);t&&(this.setGlobalRefs(),t.enable(),t.hasError()&&(this._errorMsg=t.getError()),this.unsetGlobalRefs())}enableAll(){this._errorMsg="",this.setGlobalRefs(),this._plugins.forEach(e=>{e.enable(),e.hasError()&&(this._errorMsg+=e.getError()+"\n")}),this.unsetGlobalRefs()}disableAll(){this._errorMsg="",this.setGlobalRefs(),this._plugins.forEach(e=>{e.disable(),e.hasError()&&(this._errorMsg+=e.getError()+"\n")}),this.unsetGlobalRefs()}getError(){return this._errorMsg}toJSON(){return this._plugins.map(e=>e.toJSON())}setGlobalRefs(){"undefined"!=typeof window?window.RG||(this._globalRefsWereSet=!0,window.RG=AllCode):void 0!==global&&(global.RG||(this._globalRefsWereSet=!0,global.RG=AllCode))}unsetGlobalRefs(){this._globalRefsWereSet=!1,"undefined"!=typeof window?window.RG=void 0:void 0!==global&&(global.RG=void 0)}withGlobalRefs(e){this.setGlobalRefs(),e(),this.unsetGlobalRefs()}validateType(e){if(!e.type)throw new Error("pluginData must have type specified");if(PLUGIN_TYPES.indexOf(e.type)<0){let t="type must be any of the following: ";throw t+=JSON.stringify(PLUGIN_TYPES),t+=` but got |${e.type}|`,new Error(t)}}}exports.PluginManager=PluginManager}).call(this,__webpack_require__(35))},function(e,t,n){e.exports=n(88)},function(e,t,n){
/*!
 * chai
 * Copyright(c) 2011 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
/*!
 * Dependencies that are used for multiple exports are required here only once
 */
var s=n(810);
/*!
 * test utility
 */t.test=n(811),
/*!
 * type utility
 */
t.type=n(247),
/*!
 * expectTypes utility
 */
t.expectTypes=n(812),
/*!
 * message utility
 */
t.getMessage=n(813),
/*!
 * actual utility
 */
t.getActual=n(415),
/*!
 * Inspect util
 */
t.inspect=n(248),
/*!
 * Object Display util
 */
t.objDisplay=n(416),
/*!
 * Flag utility
 */
t.flag=n(51),
/*!
 * Flag transferring utility
 */
t.transferFlags=n(89),
/*!
 * Deep equal utility
 */
t.eql=n(815),
/*!
 * Deep path info
 */
t.getPathInfo=s.getPathInfo,
/*!
 * Check if a property exists
 */
t.hasProperty=s.hasProperty,
/*!
 * Function name
 */
t.getName=n(417),
/*!
 * add Property
 */
t.addProperty=n(816),
/*!
 * add Method
 */
t.addMethod=n(817),
/*!
 * overwrite Property
 */
t.overwriteProperty=n(818),
/*!
 * overwrite Method
 */
t.overwriteMethod=n(819),
/*!
 * Add a chainable method
 */
t.addChainableMethod=n(820),
/*!
 * Overwrite chainable method
 */
t.overwriteChainableMethod=n(821),
/*!
 * Compare by inspect method
 */
t.compareByInspect=n(822),
/*!
 * Get own enumerable property symbols method
 */
t.getOwnEnumerablePropertySymbols=n(419),
/*!
 * Get own enumerable properties method
 */
t.getOwnEnumerableProperties=n(823),
/*!
 * Checks error against a given set of criteria
 */
t.checkError=n(824),
/*!
 * Proxify util
 */
t.proxify=n(170),
/*!
 * addLengthGuard util
 */
t.addLengthGuard=n(169),
/*!
 * isProxyEnabled helper
 */
t.isProxyEnabled=n(168),
/*!
 * isNaN method
 */
t.isNaN=n(825)},function(e,t,n){"use strict";function s(e,t){return null!=e&&t in Object(e)}function r(e){return e.replace(/([^\\])\[/g,"$1.[").match(/(\\\.|[^.]+?)+/g).map((function(e){if("constructor"===e||"__proto__"===e||"prototype"===e)return{};var t=/^\[(\d+)\]$/.exec(e);return t?{i:parseFloat(t[1])}:{p:e.replace(/\\([.[\]])/g,"$1")}}))}function a(e,t,n){var s=e,r=null;n=void 0===n?t.length:n;for(var a=0;a<n;a++){var o=t[a];s&&(s=void 0===o.p?s[o.i]:s[o.p],a===n-1&&(r=s))}return r}function o(e,t){var n=r(t),o=n[n.length-1],i={parent:n.length>1?a(e,n,n.length-1):e,name:o.p||o.i,value:a(e,n)};return i.exists=s(i.parent,i.name),i}e.exports={hasProperty:s,getPathInfo:o,getPathValue:function(e,t){return o(e,t).value},setPathValue:function(e,t,n){return function(e,t,n){for(var s=e,r=n.length,a=null,o=0;o<r;o++){var i=null,l=null;if(a=n[o],o===r-1)s[i=void 0===a.p?a.i:a.p]=t;else if(void 0!==a.p&&s[a.p])s=s[a.p];else if(void 0!==a.i&&s[a.i])s=s[a.i];else{var c=n[o+1];i=void 0===a.p?a.i:a.p,l=void 0===c.p?[]:{},s[i]=l,s=s[i]}}}(e,n,r(t)),e}}},function(e,t,n){
/*!
 * Chai - test utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
/*!
 * Module dependencies
 */
var s=n(51);e.exports=function(e,t){var n=s(e,"negate"),r=t[0];return n?!r:r}},function(e,t,n){
/*!
 * Chai - expectTypes utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
var s=n(414),r=n(51),a=n(247);e.exports=function(e,t){var n=r(e,"message"),o=r(e,"ssfi");n=n?n+": ":"",e=r(e,"object"),(t=t.map((function(e){return e.toLowerCase()}))).sort();var i=t.map((function(e,n){var s=~["a","e","i","o","u"].indexOf(e.charAt(0))?"an":"a";return(t.length>1&&n===t.length-1?"or ":"")+s+" "+e})).join(", "),l=a(e).toLowerCase();if(!t.some((function(e){return l===e})))throw new s(n+"object tested must be "+i+", but "+l+" given",void 0,o)}},function(e,t,n){
/*!
 * Chai - message composition utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
/*!
 * Module dependencies
 */
var s=n(51),r=n(415),a=n(416);e.exports=function(e,t){var n=s(e,"negate"),o=s(e,"object"),i=t[3],l=r(e,t),c=n?t[2]:t[1],u=s(e,"message");return"function"==typeof c&&(c=c()),c=(c=c||"").replace(/#\{this\}/g,(function(){return a(o)})).replace(/#\{act\}/g,(function(){return a(l)})).replace(/#\{exp\}/g,(function(){return a(i)})),u?u+": "+c:c}},function(e,t){
/*!
 * Chai - getEnumerableProperties utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e){var t=[];for(var n in e)t.push(n);return t}},function(e,t,n){"use strict";
/*!
 * deep-eql
 * Copyright(c) 2013 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */var s=n(247);function r(){this._key="chai/deep-eql__"+Math.random()+Date.now()}r.prototype={get:function(e){return e[this._key]},set:function(e,t){Object.isExtensible(e)&&Object.defineProperty(e,this._key,{value:t,configurable:!0})}};var a="function"==typeof WeakMap?WeakMap:r;
/*!
 * Check to see if the MemoizeMap has recorded a result of the two operands
 *
 * @param {Mixed} leftHandOperand
 * @param {Mixed} rightHandOperand
 * @param {MemoizeMap} memoizeMap
 * @returns {Boolean|null} result
*/function o(e,t,n){if(!n||g(e)||g(t))return null;var s=n.get(e);if(s){var r=s.get(t);if("boolean"==typeof r)return r}return null}
/*!
 * Set the result of the equality into the MemoizeMap
 *
 * @param {Mixed} leftHandOperand
 * @param {Mixed} rightHandOperand
 * @param {MemoizeMap} memoizeMap
 * @param {Boolean} result
*/function i(e,t,n,s){if(n&&!g(e)&&!g(t)){var r=n.get(e);r?r.set(t,s):((r=new a).set(t,s),n.set(e,r))}}
/*!
 * Primary Export
 */function l(e,t,n){if(n&&n.comparator)return u(e,t,n);var s=c(e,t);return null!==s?s:u(e,t,n)}function c(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t||!g(e)&&!g(t)&&null}
/*!
 * The main logic of the `deepEqual` function.
 *
 * @param {Mixed} leftHandOperand
 * @param {Mixed} rightHandOperand
 * @param {Object} [options] (optional) Additional options
 * @param {Array} [options.comparator] (optional) Override default algorithm, determining custom equality.
 * @param {Array} [options.memoize] (optional) Provide a custom memoization object which will cache the results of
    complex objects for a speed boost. By passing `false` you can disable memoization, but this will cause circular
    references to blow the stack.
 * @return {Boolean} equal match
*/function u(e,t,n){(n=n||{}).memoize=!1!==n.memoize&&(n.memoize||new a);var r=n&&n.comparator,u=o(e,t,n.memoize);if(null!==u)return u;var g=o(t,e,n.memoize);if(null!==g)return g;if(r){var y=r(e,t);if(!1===y||!0===y)return i(e,t,n.memoize,y),y;var v=c(e,t);if(null!==v)return v}var b=s(e);if(b!==s(t))return i(e,t,n.memoize,!1),!1;i(e,t,n.memoize,!0);var _=function(e,t,n,s){switch(n){case"String":case"Number":case"Boolean":case"Date":return l(e.valueOf(),t.valueOf());case"Promise":case"Symbol":case"function":case"WeakMap":case"WeakSet":case"Error":return e===t;case"Arguments":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"Array":return d(e,t,s);case"RegExp":
/*!
 * Compare two Regular Expressions for equality.
 *
 * @param {RegExp} leftHandOperand
 * @param {RegExp} rightHandOperand
 * @return {Boolean} result
 */
return function(e,t){return e.toString()===t.toString()}
/*!
 * Compare two Sets/Maps for equality. Faster than other equality functions.
 *
 * @param {Set} leftHandOperand
 * @param {Set} rightHandOperand
 * @param {Object} [options] (Optional)
 * @return {Boolean} result
 */(e,t);case"Generator":
/*!
 * Simple equality for generator objects such as those returned by generator functions.
 *
 * @param {Iterable} leftHandOperand
 * @param {Iterable} rightHandOperand
 * @param {Object} [options] (Optional)
 * @return {Boolean} result
 */
return function(e,t,n){return d(f(e),f(t),n)}
/*!
 * Determine if the given object has an @@iterator function.
 *
 * @param {Object} target
 * @return {Boolean} `true` if the object has an @@iterator function.
 */(e,t,s);case"DataView":return d(new Uint8Array(e.buffer),new Uint8Array(t.buffer),s);case"ArrayBuffer":return d(new Uint8Array(e),new Uint8Array(t),s);case"Set":case"Map":return h(e,t,s);default:
/*!
 * Recursively check the equality of two Objects. Once basic sameness has been established it will defer to `deepEqual`
 * for each enumerable key in the object.
 *
 * @param {Mixed} leftHandOperand
 * @param {Mixed} rightHandOperand
 * @param {Object} [options] (Optional)
 * @return {Boolean} result
 */
return function(e,t,n){var s=m(e),r=m(t);if(s.length&&s.length===r.length)return s.sort(),r.sort(),!1!==d(s,r)&&
/*!
 * Determines if two objects have matching values, given a set of keys. Defers to deepEqual for the equality check of
 * each key. If any value of the given key is not equal, the function will return false (early).
 *
 * @param {Mixed} leftHandOperand
 * @param {Mixed} rightHandOperand
 * @param {Array} keys An array of keys to compare the values of leftHandOperand and rightHandOperand against
 * @param {Object} [options] (Optional)
 * @return {Boolean} result
 */
function(e,t,n,s){var r=n.length;if(0===r)return!0;for(var a=0;a<r;a+=1)if(!1===l(e[n[a]],t[n[a]],s))return!1;return!0}(e,t,s,n);var a=p(e),o=p(t);if(a.length&&a.length===o.length)return a.sort(),o.sort(),d(a,o,n);if(0===s.length&&0===a.length&&0===r.length&&0===o.length)return!0;return!1}
/*!
 * Returns true if the argument is a primitive.
 *
 * This intentionally returns true for all objects that can be compared by reference,
 * including functions and symbols.
 *
 * @param {Mixed} value
 * @return {Boolean} result
 */(e,t,s)}}(e,t,b,n);return i(e,t,n.memoize,_),_}function h(e,t,n){if(e.size!==t.size)return!1;if(0===e.size)return!0;var s=[],r=[];return e.forEach((function(e,t){s.push([e,t])})),t.forEach((function(e,t){r.push([e,t])})),d(s.sort(),r.sort(),n)}
/*!
 * Simple equality for flat iterable objects such as Arrays, TypedArrays or Node.js buffers.
 *
 * @param {Iterable} leftHandOperand
 * @param {Iterable} rightHandOperand
 * @param {Object} [options] (Optional)
 * @return {Boolean} result
 */function d(e,t,n){var s=e.length;if(s!==t.length)return!1;if(0===s)return!0;for(var r=-1;++r<s;)if(!1===l(e[r],t[r],n))return!1;return!0}
/*!
 * Gets all iterator entries from the given Object. If the Object has no @@iterator function, returns an empty array.
 * This will consume the iterator - which could have side effects depending on the @@iterator implementation.
 *
 * @param {Object} target
 * @returns {Array} an array of entries from the @@iterator function
 */
function p(e){if(function(e){return"undefined"!=typeof Symbol&&"object"==typeof e&&void 0!==Symbol.iterator&&"function"==typeof e[Symbol.iterator]}(e))try{return f(e[Symbol.iterator]())}catch(e){return[]}return[]}
/*!
 * Gets all entries from a Generator. This will consume the generator - which could have side effects.
 *
 * @param {Generator} target
 * @returns {Array} an array of entries from the Generator.
 */function f(e){for(var t=e.next(),n=[t.value];!1===t.done;)t=e.next(),n.push(t.value);return n}
/*!
 * Gets all own and inherited enumerable keys from a target.
 *
 * @param {Object} target
 * @returns {Array} an array of own and inherited enumerable keys from the target.
 */function m(e){var t=[];for(var n in e)t.push(n);return t}function g(e){return null===e||"object"!=typeof e}e.exports=l,e.exports.MemoizeMap=a},function(e,t,n){
/*!
 * Chai - addProperty utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
var s=n(88),r=n(51),a=n(168),o=n(89);e.exports=function(e,t,n){n=void 0===n?function(){}:n,Object.defineProperty(e,t,{get:function e(){a()||r(this,"lockSsfi")||r(this,"ssfi",e);var t=n.call(this);if(void 0!==t)return t;var i=new s.Assertion;return o(this,i),i},configurable:!0})}},function(e,t,n){
/*!
 * Chai - addMethod utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
var s=n(169),r=n(88),a=n(51),o=n(170),i=n(89);e.exports=function(e,t,n){var l=function(){a(this,"lockSsfi")||a(this,"ssfi",l);var e=n.apply(this,arguments);if(void 0!==e)return e;var t=new r.Assertion;return i(this,t),t};s(l,t,!1),e[t]=o(l,t)}},function(e,t,n){
/*!
 * Chai - overwriteProperty utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
var s=n(88),r=n(51),a=n(168),o=n(89);e.exports=function(e,t,n){var i=Object.getOwnPropertyDescriptor(e,t),l=function(){};i&&"function"==typeof i.get&&(l=i.get),Object.defineProperty(e,t,{get:function e(){a()||r(this,"lockSsfi")||r(this,"ssfi",e);var t=r(this,"lockSsfi");r(this,"lockSsfi",!0);var i=n(l).call(this);if(r(this,"lockSsfi",t),void 0!==i)return i;var c=new s.Assertion;return o(this,c),c},configurable:!0})}},function(e,t,n){
/*!
 * Chai - overwriteMethod utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
var s=n(169),r=n(88),a=n(51),o=n(170),i=n(89);e.exports=function(e,t,n){var l=e[t],c=function(){throw new Error(t+" is not a function")};l&&"function"==typeof l&&(c=l);var u=function(){a(this,"lockSsfi")||a(this,"ssfi",u);var e=a(this,"lockSsfi");a(this,"lockSsfi",!0);var t=n(c).apply(this,arguments);if(a(this,"lockSsfi",e),void 0!==t)return t;var s=new r.Assertion;return i(this,s),s};s(u,t,!1),e[t]=o(u,t)}},function(e,t,n){
/*!
 * Chai - addChainingMethod utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
/*!
 * Module dependencies
 */
var s=n(169),r=n(88),a=n(51),o=n(170),i=n(89),l="function"==typeof Object.setPrototypeOf,c=function(){},u=Object.getOwnPropertyNames(c).filter((function(e){var t=Object.getOwnPropertyDescriptor(c,e);return"object"!=typeof t||!t.configurable})),h=Function.prototype.call,d=Function.prototype.apply;e.exports=function(e,t,n,c){"function"!=typeof c&&(c=function(){});var p={method:n,chainingBehavior:c};e.__methods||(e.__methods={}),e.__methods[t]=p,Object.defineProperty(e,t,{get:function(){p.chainingBehavior.call(this);var n=function(){a(this,"lockSsfi")||a(this,"ssfi",n);var e=p.method.apply(this,arguments);if(void 0!==e)return e;var t=new r.Assertion;return i(this,t),t};if(s(n,t,!0),l){var c=Object.create(this);c.call=h,c.apply=d,Object.setPrototypeOf(n,c)}else{Object.getOwnPropertyNames(e).forEach((function(t){if(-1===u.indexOf(t)){var s=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,s)}}))}return i(this,n),o(n)},configurable:!0})}},function(e,t,n){
/*!
 * Chai - overwriteChainableMethod utility
 * Copyright(c) 2012-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
var s=n(88),r=n(89);e.exports=function(e,t,n,a){var o=e.__methods[t],i=o.chainingBehavior;o.chainingBehavior=function(){var e=a(i).call(this);if(void 0!==e)return e;var t=new s.Assertion;return r(this,t),t};var l=o.method;o.method=function(){var e=n(l).apply(this,arguments);if(void 0!==e)return e;var t=new s.Assertion;return r(this,t),t}}},function(e,t,n){
/*!
 * Chai - compareByInspect utility
 * Copyright(c) 2011-2016 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
/*!
 * Module dependencies
 */
var s=n(248);e.exports=function(e,t){return s(e)<s(t)?-1:1}},function(e,t,n){
/*!
 * Chai - getOwnEnumerableProperties utility
 * Copyright(c) 2011-2016 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
/*!
 * Module dependencies
 */
var s=n(419);e.exports=function(e){return Object.keys(e).concat(s(e))}},function(e,t,n){"use strict";var s=/\s*function(?:\s|\s*\/\*[^(?:*\/)]+\*\/\s*)*([^\(\/]+)/;function r(e){var t="";if(void 0===e.name){var n=String(e).match(s);n&&(t=n[1])}else t=e.name;return t}e.exports={compatibleInstance:function(e,t){return t instanceof Error&&e===t},compatibleConstructor:function(e,t){return t instanceof Error?e.constructor===t.constructor||e instanceof t.constructor:(t.prototype instanceof Error||t===Error)&&(e.constructor===t||e instanceof t)},compatibleMessage:function(e,t){var n="string"==typeof e?e:e.message;return t instanceof RegExp?t.test(n):"string"==typeof t&&-1!==n.indexOf(t)},getMessage:function(e){var t="";return e&&e.message?t=e.message:"string"==typeof e&&(t=e),t},getConstructorName:function(e){var t=e;return e instanceof Error?t=r(e.constructor):"function"==typeof e&&(t=r(e).trim()||r(new e)),t}}},function(e,t){e.exports=Number.isNaN||
/*!
 * Chai - isNaN utility
 * Copyright(c) 2012-2015 Sakthipriyan Vairamani <thechargingvolcano@gmail.com>
 * MIT Licensed
 */
function(e){return e!=e}},function(e,t,n){
/*!
 * chai
 * http://chaijs.com
 * Copyright(c) 2011-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
var s=n(104);e.exports=function(e,t){
/*!
   * Module dependencies.
   */
var n=e.AssertionError,r=t.flag;
/*!
   * Module export.
   */
/*!
   * Assertion Constructor
   *
   * Creates object for chaining.
   *
   * `Assertion` objects contain metadata in the form of flags. Three flags can
   * be assigned during instantiation by passing arguments to this constructor:
   *
   * - `object`: This flag contains the target of the assertion. For example, in
   *   the assertion `expect(numKittens).to.equal(7);`, the `object` flag will
   *   contain `numKittens` so that the `equal` assertion can reference it when
   *   needed.
   *
   * - `message`: This flag contains an optional custom error message to be
   *   prepended to the error message that's generated by the assertion when it
   *   fails.
   *
   * - `ssfi`: This flag stands for "start stack function indicator". It
   *   contains a function reference that serves as the starting point for
   *   removing frames from the stack trace of the error that's created by the
   *   assertion when it fails. The goal is to provide a cleaner stack trace to
   *   end users by removing Chai's internal functions. Note that it only works
   *   in environments that support `Error.captureStackTrace`, and only when
   *   `Chai.config.includeStack` hasn't been set to `false`.
   *
   * - `lockSsfi`: This flag controls whether or not the given `ssfi` flag
   *   should retain its current value, even as assertions are chained off of
   *   this object. This is usually set to `true` when creating a new assertion
   *   from within another assertion. It's also temporarily set to `true` before
   *   an overwritten assertion gets called by the overwriting assertion.
   *
   * @param {Mixed} obj target of the assertion
   * @param {String} msg (optional) custom error message
   * @param {Function} ssfi (optional) starting point for removing stack frames
   * @param {Boolean} lockSsfi (optional) whether or not the ssfi flag is locked
   * @api private
   */
function a(e,n,s,o){return r(this,"ssfi",s||a),r(this,"lockSsfi",o),r(this,"object",e),r(this,"message",n),t.proxify(this)}e.Assertion=a,Object.defineProperty(a,"includeStack",{get:function(){return console.warn("Assertion.includeStack is deprecated, use chai.config.includeStack instead."),s.includeStack},set:function(e){console.warn("Assertion.includeStack is deprecated, use chai.config.includeStack instead."),s.includeStack=e}}),Object.defineProperty(a,"showDiff",{get:function(){return console.warn("Assertion.showDiff is deprecated, use chai.config.showDiff instead."),s.showDiff},set:function(e){console.warn("Assertion.showDiff is deprecated, use chai.config.showDiff instead."),s.showDiff=e}}),a.addProperty=function(e,n){t.addProperty(this.prototype,e,n)},a.addMethod=function(e,n){t.addMethod(this.prototype,e,n)},a.addChainableMethod=function(e,n,s){t.addChainableMethod(this.prototype,e,n,s)},a.overwriteProperty=function(e,n){t.overwriteProperty(this.prototype,e,n)},a.overwriteMethod=function(e,n){t.overwriteMethod(this.prototype,e,n)},a.overwriteChainableMethod=function(e,n,s){t.overwriteChainableMethod(this.prototype,e,n,s)},a.prototype.assert=function(e,a,o,i,l,c){var u=t.test(this,arguments);if(!1!==c&&(c=!0),void 0===i&&void 0===l&&(c=!1),!0!==s.showDiff&&(c=!1),!u){a=t.getMessage(this,arguments);var h=t.getActual(this,arguments);throw new n(a,{actual:h,expected:i,showDiff:c},s.includeStack?this.assert:r(this,"ssfi"))}},
/*!
   * ### ._obj
   *
   * Quick reference to stored `actual` value for plugin developers.
   *
   * @api private
   */
Object.defineProperty(a.prototype,"_obj",{get:function(){return r(this,"object")},set:function(e){r(this,"object",e)}})}},function(e,t){
/*!
 * chai
 * http://chaijs.com
 * Copyright(c) 2011-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t){var n=e.Assertion,s=e.AssertionError,r=t.flag;function a(e,n){n&&r(this,"message",n),e=e.toLowerCase();var s=r(this,"object"),a=~["a","e","i","o","u"].indexOf(e.charAt(0))?"an ":"a ";this.assert(e===t.type(s).toLowerCase(),"expected #{this} to be "+a+e,"expected #{this} not to be "+a+e)}function o(e,n){return t.isNaN(e)&&t.isNaN(n)||e===n}function i(){r(this,"contains",!0)}function l(e,a){a&&r(this,"message",a);var i=r(this,"object"),l=t.type(i).toLowerCase(),c=r(this,"message"),u=r(this,"negate"),h=r(this,"ssfi"),d=r(this,"deep"),p=d?"deep ":"";c=c?c+": ":"";var f=!1;switch(l){case"string":f=-1!==i.indexOf(e);break;case"weakset":if(d)throw new s(c+"unable to use .deep.include with WeakSet",void 0,h);f=i.has(e);break;case"map":var m=d?t.eql:o;i.forEach((function(t){f=f||m(t,e)}));break;case"set":d?i.forEach((function(n){f=f||t.eql(n,e)})):f=i.has(e);break;case"array":f=d?i.some((function(n){return t.eql(n,e)})):-1!==i.indexOf(e);break;default:if(e!==Object(e))throw new s(c+"object tested must be an array, a map, an object, a set, a string, or a weakset, but "+l+" given",void 0,h);var g=Object.keys(e),y=null,v=0;if(g.forEach((function(a){var o=new n(i);if(t.transferFlags(this,o,!0),r(o,"lockSsfi",!0),u&&1!==g.length)try{o.property(a,e[a])}catch(e){if(!t.checkError.compatibleConstructor(e,s))throw e;null===y&&(y=e),v++}else o.property(a,e[a])}),this),u&&g.length>1&&v===g.length)throw y;return}this.assert(f,"expected #{this} to "+p+"include "+t.inspect(e),"expected #{this} to not "+p+"include "+t.inspect(e))}function c(){var e=r(this,"object"),n=t.type(e);this.assert("Arguments"===n,"expected #{this} to be arguments but got "+n,"expected #{this} to not be arguments")}function u(e,t){t&&r(this,"message",t);var n=r(this,"object");if(r(this,"deep")){var s=r(this,"lockSsfi");r(this,"lockSsfi",!0),this.eql(e),r(this,"lockSsfi",s)}else this.assert(e===n,"expected #{this} to equal #{exp}","expected #{this} to not equal #{exp}",e,this._obj,!0)}function h(e,n){n&&r(this,"message",n),this.assert(t.eql(e,r(this,"object")),"expected #{this} to deeply equal #{exp}","expected #{this} to not deeply equal #{exp}",e,this._obj,!0)}function d(e,a){a&&r(this,"message",a);var o,i=r(this,"object"),l=r(this,"doLength"),c=r(this,"message"),u=c?c+": ":"",h=r(this,"ssfi"),d=t.type(i).toLowerCase(),p=t.type(e).toLowerCase(),f=!0;if(l&&"map"!==d&&"set"!==d&&new n(i,c,h,!0).to.have.property("length"),l||"date"!==d||"date"===p)if("number"===p||!l&&"number"!==d)if(l||"date"===d||"number"===d)f=!1;else{o=u+"expected "+("string"===d?"'"+i+"'":i)+" to be a number or a date"}else o=u+"the argument to above must be a number";else o=u+"the argument to above must be a date";if(f)throw new s(o,void 0,h);if(l){var m,g="length";"map"===d||"set"===d?(g="size",m=i.size):m=i.length,this.assert(m>e,"expected #{this} to have a "+g+" above #{exp} but got #{act}","expected #{this} to not have a "+g+" above #{exp}",e,m)}else this.assert(i>e,"expected #{this} to be above #{exp}","expected #{this} to be at most #{exp}",e)}function p(e,a){a&&r(this,"message",a);var o,i=r(this,"object"),l=r(this,"doLength"),c=r(this,"message"),u=c?c+": ":"",h=r(this,"ssfi"),d=t.type(i).toLowerCase(),p=t.type(e).toLowerCase(),f=!0;if(l&&"map"!==d&&"set"!==d&&new n(i,c,h,!0).to.have.property("length"),l||"date"!==d||"date"===p)if("number"===p||!l&&"number"!==d)if(l||"date"===d||"number"===d)f=!1;else{o=u+"expected "+("string"===d?"'"+i+"'":i)+" to be a number or a date"}else o=u+"the argument to least must be a number";else o=u+"the argument to least must be a date";if(f)throw new s(o,void 0,h);if(l){var m,g="length";"map"===d||"set"===d?(g="size",m=i.size):m=i.length,this.assert(m>=e,"expected #{this} to have a "+g+" at least #{exp} but got #{act}","expected #{this} to have a "+g+" below #{exp}",e,m)}else this.assert(i>=e,"expected #{this} to be at least #{exp}","expected #{this} to be below #{exp}",e)}function f(e,a){a&&r(this,"message",a);var o,i=r(this,"object"),l=r(this,"doLength"),c=r(this,"message"),u=c?c+": ":"",h=r(this,"ssfi"),d=t.type(i).toLowerCase(),p=t.type(e).toLowerCase(),f=!0;if(l&&"map"!==d&&"set"!==d&&new n(i,c,h,!0).to.have.property("length"),l||"date"!==d||"date"===p)if("number"===p||!l&&"number"!==d)if(l||"date"===d||"number"===d)f=!1;else{o=u+"expected "+("string"===d?"'"+i+"'":i)+" to be a number or a date"}else o=u+"the argument to below must be a number";else o=u+"the argument to below must be a date";if(f)throw new s(o,void 0,h);if(l){var m,g="length";"map"===d||"set"===d?(g="size",m=i.size):m=i.length,this.assert(m<e,"expected #{this} to have a "+g+" below #{exp} but got #{act}","expected #{this} to not have a "+g+" below #{exp}",e,m)}else this.assert(i<e,"expected #{this} to be below #{exp}","expected #{this} to be at least #{exp}",e)}function m(e,a){a&&r(this,"message",a);var o,i=r(this,"object"),l=r(this,"doLength"),c=r(this,"message"),u=c?c+": ":"",h=r(this,"ssfi"),d=t.type(i).toLowerCase(),p=t.type(e).toLowerCase(),f=!0;if(l&&"map"!==d&&"set"!==d&&new n(i,c,h,!0).to.have.property("length"),l||"date"!==d||"date"===p)if("number"===p||!l&&"number"!==d)if(l||"date"===d||"number"===d)f=!1;else{o=u+"expected "+("string"===d?"'"+i+"'":i)+" to be a number or a date"}else o=u+"the argument to most must be a number";else o=u+"the argument to most must be a date";if(f)throw new s(o,void 0,h);if(l){var m,g="length";"map"===d||"set"===d?(g="size",m=i.size):m=i.length,this.assert(m<=e,"expected #{this} to have a "+g+" at most #{exp} but got #{act}","expected #{this} to have a "+g+" above #{exp}",e,m)}else this.assert(i<=e,"expected #{this} to be at most #{exp}","expected #{this} to be above #{exp}",e)}function g(e,n){n&&r(this,"message",n);var a=r(this,"object"),o=r(this,"ssfi"),i=r(this,"message");try{var l=a instanceof e}catch(n){if(n instanceof TypeError)throw new s((i=i?i+": ":"")+"The instanceof assertion needs a constructor but "+t.type(e)+" was given.",void 0,o);throw n}var c=t.getName(e);null===c&&(c="an unnamed constructor"),this.assert(l,"expected #{this} to be an instance of "+c,"expected #{this} to not be an instance of "+c)}function y(e,n,a){a&&r(this,"message",a);var o=r(this,"nested"),i=r(this,"own"),l=r(this,"message"),c=r(this,"object"),u=r(this,"ssfi"),h=typeof e;if(l=l?l+": ":"",o){if("string"!==h)throw new s(l+"the argument to property must be a string when using nested syntax",void 0,u)}else if("string"!==h&&"number"!==h&&"symbol"!==h)throw new s(l+"the argument to property must be a string, number, or symbol",void 0,u);if(o&&i)throw new s(l+'The "nested" and "own" flags cannot be combined.',void 0,u);if(null==c)throw new s(l+"Target cannot be null or undefined.",void 0,u);var d,p=r(this,"deep"),f=r(this,"negate"),m=o?t.getPathInfo(c,e):null,g=o?m.value:c[e],y="";p&&(y+="deep "),i&&(y+="own "),o&&(y+="nested "),y+="property ",d=i?Object.prototype.hasOwnProperty.call(c,e):o?m.exists:t.hasProperty(c,e),f&&1!==arguments.length||this.assert(d,"expected #{this} to have "+y+t.inspect(e),"expected #{this} to not have "+y+t.inspect(e)),arguments.length>1&&this.assert(d&&(p?t.eql(n,g):n===g),"expected #{this} to have "+y+t.inspect(e)+" of #{exp}, but got #{act}","expected #{this} to not have "+y+t.inspect(e)+" of #{act}",n,g),r(this,"object",g)}function v(e,t,n){r(this,"own",!0),y.apply(this,arguments)}function b(e,n,s){"string"==typeof n&&(s=n,n=null),s&&r(this,"message",s);var a=r(this,"object"),o=Object.getOwnPropertyDescriptor(Object(a),e);o&&n?this.assert(t.eql(n,o),"expected the own property descriptor for "+t.inspect(e)+" on #{this} to match "+t.inspect(n)+", got "+t.inspect(o),"expected the own property descriptor for "+t.inspect(e)+" on #{this} to not match "+t.inspect(n),n,o,!0):this.assert(o,"expected #{this} to have an own property descriptor for "+t.inspect(e),"expected #{this} to not have an own property descriptor for "+t.inspect(e)),r(this,"object",o)}function _(){r(this,"doLength",!0)}function E(e,s){s&&r(this,"message",s);var a,o=r(this,"object"),i=t.type(o).toLowerCase(),l=r(this,"message"),c=r(this,"ssfi"),u="length";switch(i){case"map":case"set":u="size",a=o.size;break;default:new n(o,l,c,!0).to.have.property("length"),a=o.length}this.assert(a==e,"expected #{this} to have a "+u+" of #{exp} but got #{act}","expected #{this} to not have a "+u+" of #{act}",e,a)}function S(e,t){t&&r(this,"message",t);var n=r(this,"object");this.assert(e.exec(n),"expected #{this} to match "+e,"expected #{this} not to match "+e)}function w(e){var n,a,o=r(this,"object"),i=t.type(o),l=t.type(e),c=r(this,"ssfi"),u=r(this,"deep"),h="",d=!0,p=r(this,"message"),f=(p=p?p+": ":"")+"when testing keys against an object or an array you must give a single Array|Object|String argument or multiple String arguments";if("Map"===i||"Set"===i)h=u?"deeply ":"",a=[],o.forEach((function(e,t){a.push(t)})),"Array"!==l&&(e=Array.prototype.slice.call(arguments));else{switch(a=t.getOwnEnumerableProperties(o),l){case"Array":if(arguments.length>1)throw new s(f,void 0,c);break;case"Object":if(arguments.length>1)throw new s(f,void 0,c);e=Object.keys(e);break;default:e=Array.prototype.slice.call(arguments)}e=e.map((function(e){return"symbol"==typeof e?e:String(e)}))}if(!e.length)throw new s(p+"keys required",void 0,c);var m=e.length,g=r(this,"any"),y=r(this,"all"),v=e;if(g||y||(y=!0),g&&(d=v.some((function(e){return a.some((function(n){return u?t.eql(e,n):e===n}))}))),y&&(d=v.every((function(e){return a.some((function(n){return u?t.eql(e,n):e===n}))})),r(this,"contains")||(d=d&&e.length==a.length)),m>1){var b=(e=e.map((function(e){return t.inspect(e)}))).pop();y&&(n=e.join(", ")+", and "+b),g&&(n=e.join(", ")+", or "+b)}else n=t.inspect(e[0]);n=(m>1?"keys ":"key ")+n,n=(r(this,"contains")?"contain ":"have ")+n,this.assert(d,"expected #{this} to "+h+n,"expected #{this} to not "+h+n,v.slice(0).sort(t.compareByInspect),a.sort(t.compareByInspect),!0)}function C(e,s,a){a&&r(this,"message",a);var o,i=r(this,"object"),l=r(this,"ssfi"),c=r(this,"message"),u=r(this,"negate")||!1;new n(i,c,l,!0).is.a("function"),(e instanceof RegExp||"string"==typeof e)&&(s=e,e=null);try{i()}catch(e){o=e}var h=void 0===e&&void 0===s,d=Boolean(e&&s),p=!1,f=!1;if(h||!h&&!u){var m="an error";e instanceof Error?m="#{exp}":e&&(m=t.checkError.getConstructorName(e)),this.assert(o,"expected #{this} to throw "+m,"expected #{this} to not throw an error but #{act} was thrown",e&&e.toString(),o instanceof Error?o.toString():"string"==typeof o?o:o&&t.checkError.getConstructorName(o))}if(e&&o){if(e instanceof Error)t.checkError.compatibleInstance(o,e)===u&&(d&&u?p=!0:this.assert(u,"expected #{this} to throw #{exp} but #{act} was thrown","expected #{this} to not throw #{exp}"+(o&&!u?" but #{act} was thrown":""),e.toString(),o.toString()));t.checkError.compatibleConstructor(o,e)===u&&(d&&u?p=!0:this.assert(u,"expected #{this} to throw #{exp} but #{act} was thrown","expected #{this} to not throw #{exp}"+(o?" but #{act} was thrown":""),e instanceof Error?e.toString():e&&t.checkError.getConstructorName(e),o instanceof Error?o.toString():o&&t.checkError.getConstructorName(o)))}if(o&&null!=s){var g="including";s instanceof RegExp&&(g="matching"),t.checkError.compatibleMessage(o,s)===u&&(d&&u?f=!0:this.assert(u,"expected #{this} to throw error "+g+" #{exp} but got #{act}","expected #{this} to throw error not "+g+" #{exp}",s,t.checkError.getMessage(o)))}p&&f&&this.assert(u,"expected #{this} to throw #{exp} but #{act} was thrown","expected #{this} to not throw #{exp}"+(o?" but #{act} was thrown":""),e instanceof Error?e.toString():e&&t.checkError.getConstructorName(e),o instanceof Error?o.toString():o&&t.checkError.getConstructorName(o)),r(this,"object",o)}function O(e,n){n&&r(this,"message",n);var s=r(this,"object"),a=r(this,"itself"),o="function"!=typeof s||a?s[e]:s.prototype[e];this.assert("function"==typeof o,"expected #{this} to respond to "+t.inspect(e),"expected #{this} to not respond to "+t.inspect(e))}function T(e,n){n&&r(this,"message",n);var s=e(r(this,"object"));this.assert(s,"expected #{this} to satisfy "+t.objDisplay(e),"expected #{this} to not satisfy"+t.objDisplay(e),!r(this,"negate"),s)}function M(e,t,a){a&&r(this,"message",a);var o=r(this,"object"),i=r(this,"message"),l=r(this,"ssfi");if(new n(o,i,l,!0).is.a("number"),"number"!=typeof e||"number"!=typeof t)throw new s((i=i?i+": ":"")+"the arguments to closeTo or approximately must be numbers",void 0,l);this.assert(Math.abs(o-e)<=t,"expected #{this} to be close to "+e+" +/- "+t,"expected #{this} not to be close to "+e+" +/- "+t)}function A(e,t,s){s&&r(this,"message",s);var a,o=r(this,"object"),i=r(this,"message"),l=r(this,"ssfi");new n(o,i,l,!0).is.a("function"),t?(new n(e,i,l,!0).to.have.property(t),a=e[t]):(new n(e,i,l,!0).is.a("function"),a=e()),o();var c=null==t?e():e[t],u=null==t?a:"."+t;r(this,"deltaMsgObj",u),r(this,"initialDeltaValue",a),r(this,"finalDeltaValue",c),r(this,"deltaBehavior","change"),r(this,"realDelta",c!==a),this.assert(a!==c,"expected "+u+" to change","expected "+u+" to not change")}function N(e,t,s){s&&r(this,"message",s);var a,o=r(this,"object"),i=r(this,"message"),l=r(this,"ssfi");new n(o,i,l,!0).is.a("function"),t?(new n(e,i,l,!0).to.have.property(t),a=e[t]):(new n(e,i,l,!0).is.a("function"),a=e()),new n(a,i,l,!0).is.a("number"),o();var c=null==t?e():e[t],u=null==t?a:"."+t;r(this,"deltaMsgObj",u),r(this,"initialDeltaValue",a),r(this,"finalDeltaValue",c),r(this,"deltaBehavior","increase"),r(this,"realDelta",c-a),this.assert(c-a>0,"expected "+u+" to increase","expected "+u+" to not increase")}function x(e,t,s){s&&r(this,"message",s);var a,o=r(this,"object"),i=r(this,"message"),l=r(this,"ssfi");new n(o,i,l,!0).is.a("function"),t?(new n(e,i,l,!0).to.have.property(t),a=e[t]):(new n(e,i,l,!0).is.a("function"),a=e()),new n(a,i,l,!0).is.a("number"),o();var c=null==t?e():e[t],u=null==t?a:"."+t;r(this,"deltaMsgObj",u),r(this,"initialDeltaValue",a),r(this,"finalDeltaValue",c),r(this,"deltaBehavior","decrease"),r(this,"realDelta",a-c),this.assert(c-a<0,"expected "+u+" to decrease","expected "+u+" to not decrease")}["to","be","been","is","and","has","have","with","that","which","at","of","same","but","does","still"].forEach((function(e){n.addProperty(e)})),n.addProperty("not",(function(){r(this,"negate",!0)})),n.addProperty("deep",(function(){r(this,"deep",!0)})),n.addProperty("nested",(function(){r(this,"nested",!0)})),n.addProperty("own",(function(){r(this,"own",!0)})),n.addProperty("ordered",(function(){r(this,"ordered",!0)})),n.addProperty("any",(function(){r(this,"any",!0),r(this,"all",!1)})),n.addProperty("all",(function(){r(this,"all",!0),r(this,"any",!1)})),n.addChainableMethod("an",a),n.addChainableMethod("a",a),n.addChainableMethod("include",l,i),n.addChainableMethod("contain",l,i),n.addChainableMethod("contains",l,i),n.addChainableMethod("includes",l,i),n.addProperty("ok",(function(){this.assert(r(this,"object"),"expected #{this} to be truthy","expected #{this} to be falsy")})),n.addProperty("true",(function(){this.assert(!0===r(this,"object"),"expected #{this} to be true","expected #{this} to be false",!r(this,"negate"))})),n.addProperty("false",(function(){this.assert(!1===r(this,"object"),"expected #{this} to be false","expected #{this} to be true",!!r(this,"negate"))})),n.addProperty("null",(function(){this.assert(null===r(this,"object"),"expected #{this} to be null","expected #{this} not to be null")})),n.addProperty("undefined",(function(){this.assert(void 0===r(this,"object"),"expected #{this} to be undefined","expected #{this} not to be undefined")})),n.addProperty("NaN",(function(){this.assert(t.isNaN(r(this,"object")),"expected #{this} to be NaN","expected #{this} not to be NaN")})),n.addProperty("exist",(function(){var e=r(this,"object");this.assert(null!=e,"expected #{this} to exist","expected #{this} to not exist")})),n.addProperty("empty",(function(){var e,n=r(this,"object"),a=r(this,"ssfi"),o=r(this,"message");switch(o=o?o+": ":"",t.type(n).toLowerCase()){case"array":case"string":e=n.length;break;case"map":case"set":e=n.size;break;case"weakmap":case"weakset":throw new s(o+".empty was passed a weak collection",void 0,a);case"function":var i=o+".empty was passed a function "+t.getName(n);throw new s(i.trim(),void 0,a);default:if(n!==Object(n))throw new s(o+".empty was passed non-string primitive "+t.inspect(n),void 0,a);e=Object.keys(n).length}this.assert(0===e,"expected #{this} to be empty","expected #{this} not to be empty")})),n.addProperty("arguments",c),n.addProperty("Arguments",c),n.addMethod("equal",u),n.addMethod("equals",u),n.addMethod("eq",u),n.addMethod("eql",h),n.addMethod("eqls",h),n.addMethod("above",d),n.addMethod("gt",d),n.addMethod("greaterThan",d),n.addMethod("least",p),n.addMethod("gte",p),n.addMethod("below",f),n.addMethod("lt",f),n.addMethod("lessThan",f),n.addMethod("most",m),n.addMethod("lte",m),n.addMethod("within",(function(e,a,o){o&&r(this,"message",o);var i,l=r(this,"object"),c=r(this,"doLength"),u=r(this,"message"),h=u?u+": ":"",d=r(this,"ssfi"),p=t.type(l).toLowerCase(),f=t.type(e).toLowerCase(),m=t.type(a).toLowerCase(),g=!0,y="date"===f&&"date"===m?e.toUTCString()+".."+a.toUTCString():e+".."+a;if(c&&"map"!==p&&"set"!==p&&new n(l,u,d,!0).to.have.property("length"),c||"date"!==p||"date"===f&&"date"===m)if("number"===f&&"number"===m||!c&&"number"!==p)if(c||"date"===p||"number"===p)g=!1;else{i=h+"expected "+("string"===p?"'"+l+"'":l)+" to be a number or a date"}else i=h+"the arguments to within must be numbers";else i=h+"the arguments to within must be dates";if(g)throw new s(i,void 0,d);if(c){var v,b="length";"map"===p||"set"===p?(b="size",v=l.size):v=l.length,this.assert(v>=e&&v<=a,"expected #{this} to have a "+b+" within "+y,"expected #{this} to not have a "+b+" within "+y)}else this.assert(l>=e&&l<=a,"expected #{this} to be within "+y,"expected #{this} to not be within "+y)})),n.addMethod("instanceof",g),n.addMethod("instanceOf",g),n.addMethod("property",y),n.addMethod("ownProperty",v),n.addMethod("haveOwnProperty",v),n.addMethod("ownPropertyDescriptor",b),n.addMethod("haveOwnPropertyDescriptor",b),n.addChainableMethod("length",E,_),n.addChainableMethod("lengthOf",E,_),n.addMethod("match",S),n.addMethod("matches",S),n.addMethod("string",(function(e,s){s&&r(this,"message",s);var a=r(this,"object"),o=r(this,"message"),i=r(this,"ssfi");new n(a,o,i,!0).is.a("string"),this.assert(~a.indexOf(e),"expected #{this} to contain "+t.inspect(e),"expected #{this} to not contain "+t.inspect(e))})),n.addMethod("keys",w),n.addMethod("key",w),n.addMethod("throw",C),n.addMethod("throws",C),n.addMethod("Throw",C),n.addMethod("respondTo",O),n.addMethod("respondsTo",O),n.addProperty("itself",(function(){r(this,"itself",!0)})),n.addMethod("satisfy",T),n.addMethod("satisfies",T),n.addMethod("closeTo",M),n.addMethod("approximately",M),n.addMethod("members",(function(e,s){s&&r(this,"message",s);var a=r(this,"object"),o=r(this,"message"),i=r(this,"ssfi");new n(a,o,i,!0).to.be.an("array"),new n(e,o,i,!0).to.be.an("array");var l,c,u,h=r(this,"contains"),d=r(this,"ordered");h?(c="expected #{this} to be "+(l=d?"an ordered superset":"a superset")+" of #{exp}",u="expected #{this} to not be "+l+" of #{exp}"):(c="expected #{this} to have the same "+(l=d?"ordered members":"members")+" as #{exp}",u="expected #{this} to not have the same "+l+" as #{exp}");var p=r(this,"deep")?t.eql:void 0;this.assert(function(e,t,n,s,r){if(!s){if(e.length!==t.length)return!1;t=t.slice()}return e.every((function(e,a){if(r)return n?n(e,t[a]):e===t[a];if(!n){var o=t.indexOf(e);return-1!==o&&(s||t.splice(o,1),!0)}return t.some((function(r,a){return!!n(e,r)&&(s||t.splice(a,1),!0)}))}))}(e,a,p,h,d),c,u,e,a,!0)})),n.addMethod("oneOf",(function(e,t){t&&r(this,"message",t);var s=r(this,"object"),a=r(this,"message"),o=r(this,"ssfi");new n(e,a,o,!0).to.be.an("array"),this.assert(e.indexOf(s)>-1,"expected #{this} to be one of #{exp}","expected #{this} to not be one of #{exp}",e,s)})),n.addMethod("change",A),n.addMethod("changes",A),n.addMethod("increase",N),n.addMethod("increases",N),n.addMethod("decrease",x),n.addMethod("decreases",x),n.addMethod("by",(function(e,t){t&&r(this,"message",t);var n,s=r(this,"deltaMsgObj"),a=r(this,"initialDeltaValue"),o=r(this,"finalDeltaValue"),i=r(this,"deltaBehavior"),l=r(this,"realDelta");n="change"===i?Math.abs(o-a)===Math.abs(e):l===Math.abs(e),this.assert(n,"expected "+s+" to "+i+" by "+e,"expected "+s+" to not "+i+" by "+e)})),n.addProperty("extensible",(function(){var e=r(this,"object"),t=e===Object(e)&&Object.isExtensible(e);this.assert(t,"expected #{this} to be extensible","expected #{this} to not be extensible")})),n.addProperty("sealed",(function(){var e=r(this,"object"),t=e!==Object(e)||Object.isSealed(e);this.assert(t,"expected #{this} to be sealed","expected #{this} to not be sealed")})),n.addProperty("frozen",(function(){var e=r(this,"object"),t=e!==Object(e)||Object.isFrozen(e);this.assert(t,"expected #{this} to be frozen","expected #{this} to not be frozen")})),n.addProperty("finite",(function(e){var t=r(this,"object");this.assert("number"==typeof t&&isFinite(t),"expected #{this} to be a finite number","expected #{this} to not be a finite number")}))}},function(e,t){
/*!
 * chai
 * Copyright(c) 2011-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t){e.expect=function(t,n){return new e.Assertion(t,n)},e.expect.fail=function(t,n,s,r){throw arguments.length<2&&(s=t,t=void 0),s=s||"expect.fail()",new e.AssertionError(s,{actual:t,expected:n,operator:r},e.expect.fail)}}},function(e,t){
/*!
 * chai
 * Copyright(c) 2011-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t){var n=e.Assertion;function s(){Object.defineProperty(Object.prototype,"should",{set:function(e){Object.defineProperty(this,"should",{value:e,enumerable:!0,configurable:!0,writable:!0})},get:function e(){return this instanceof String||this instanceof Number||this instanceof Boolean||"function"==typeof Symbol&&this instanceof Symbol?new n(this.valueOf(),null,e):new n(this,null,e)},configurable:!0});var t={fail:function(n,s,r,a){throw arguments.length<2&&(r=n,n=void 0),r=r||"should.fail()",new e.AssertionError(r,{actual:n,expected:s,operator:a},t.fail)},equal:function(e,t,s){new n(e,s).to.equal(t)},Throw:function(e,t,s,r){new n(e,r).to.Throw(t,s)},exist:function(e,t){new n(e,t).to.exist},not:{}};return t.not.equal=function(e,t,s){new n(e,s).to.not.equal(t)},t.not.Throw=function(e,t,s,r){new n(e,r).to.not.Throw(t,s)},t.not.exist=function(e,t){new n(e,t).to.not.exist},t.throw=t.Throw,t.not.throw=t.not.Throw,t}e.should=s,e.Should=s}},function(e,t){
/*!
 * chai
 * Copyright(c) 2011-2014 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 */
e.exports=function(e,t){
/*!
   * Chai dependencies.
   */
var n=e.Assertion,s=t.flag,r=e.assert=function(t,s){new n(null,null,e.assert,!0).assert(t,s,"[ negation message unavailable ]")};
/*!
   * Module export.
   */r.fail=function(t,n,s,a){throw arguments.length<2&&(s=t,t=void 0),s=s||"assert.fail()",new e.AssertionError(s,{actual:t,expected:n,operator:a},r.fail)},r.isOk=function(e,t){new n(e,t,r.isOk,!0).is.ok},r.isNotOk=function(e,t){new n(e,t,r.isNotOk,!0).is.not.ok},r.equal=function(e,t,a){var o=new n(e,a,r.equal,!0);o.assert(t==s(o,"object"),"expected #{this} to equal #{exp}","expected #{this} to not equal #{act}",t,e,!0)},r.notEqual=function(e,t,a){var o=new n(e,a,r.notEqual,!0);o.assert(t!=s(o,"object"),"expected #{this} to not equal #{exp}","expected #{this} to equal #{act}",t,e,!0)},r.strictEqual=function(e,t,s){new n(e,s,r.strictEqual,!0).to.equal(t)},r.notStrictEqual=function(e,t,s){new n(e,s,r.notStrictEqual,!0).to.not.equal(t)},r.deepEqual=r.deepStrictEqual=function(e,t,s){new n(e,s,r.deepEqual,!0).to.eql(t)},r.notDeepEqual=function(e,t,s){new n(e,s,r.notDeepEqual,!0).to.not.eql(t)},r.isAbove=function(e,t,s){new n(e,s,r.isAbove,!0).to.be.above(t)},r.isAtLeast=function(e,t,s){new n(e,s,r.isAtLeast,!0).to.be.least(t)},r.isBelow=function(e,t,s){new n(e,s,r.isBelow,!0).to.be.below(t)},r.isAtMost=function(e,t,s){new n(e,s,r.isAtMost,!0).to.be.most(t)},r.isTrue=function(e,t){new n(e,t,r.isTrue,!0).is.true},r.isNotTrue=function(e,t){new n(e,t,r.isNotTrue,!0).to.not.equal(!0)},r.isFalse=function(e,t){new n(e,t,r.isFalse,!0).is.false},r.isNotFalse=function(e,t){new n(e,t,r.isNotFalse,!0).to.not.equal(!1)},r.isNull=function(e,t){new n(e,t,r.isNull,!0).to.equal(null)},r.isNotNull=function(e,t){new n(e,t,r.isNotNull,!0).to.not.equal(null)},r.isNaN=function(e,t){new n(e,t,r.isNaN,!0).to.be.NaN},r.isNotNaN=function(e,t){new n(e,t,r.isNotNaN,!0).not.to.be.NaN},r.exists=function(e,t){new n(e,t,r.exists,!0).to.exist},r.notExists=function(e,t){new n(e,t,r.notExists,!0).to.not.exist},r.isUndefined=function(e,t){new n(e,t,r.isUndefined,!0).to.equal(void 0)},r.isDefined=function(e,t){new n(e,t,r.isDefined,!0).to.not.equal(void 0)},r.isFunction=function(e,t){new n(e,t,r.isFunction,!0).to.be.a("function")},r.isNotFunction=function(e,t){new n(e,t,r.isNotFunction,!0).to.not.be.a("function")},r.isObject=function(e,t){new n(e,t,r.isObject,!0).to.be.a("object")},r.isNotObject=function(e,t){new n(e,t,r.isNotObject,!0).to.not.be.a("object")},r.isArray=function(e,t){new n(e,t,r.isArray,!0).to.be.an("array")},r.isNotArray=function(e,t){new n(e,t,r.isNotArray,!0).to.not.be.an("array")},r.isString=function(e,t){new n(e,t,r.isString,!0).to.be.a("string")},r.isNotString=function(e,t){new n(e,t,r.isNotString,!0).to.not.be.a("string")},r.isNumber=function(e,t){new n(e,t,r.isNumber,!0).to.be.a("number")},r.isNotNumber=function(e,t){new n(e,t,r.isNotNumber,!0).to.not.be.a("number")},r.isFinite=function(e,t){new n(e,t,r.isFinite,!0).to.be.finite},r.isBoolean=function(e,t){new n(e,t,r.isBoolean,!0).to.be.a("boolean")},r.isNotBoolean=function(e,t){new n(e,t,r.isNotBoolean,!0).to.not.be.a("boolean")},r.typeOf=function(e,t,s){new n(e,s,r.typeOf,!0).to.be.a(t)},r.notTypeOf=function(e,t,s){new n(e,s,r.notTypeOf,!0).to.not.be.a(t)},r.instanceOf=function(e,t,s){new n(e,s,r.instanceOf,!0).to.be.instanceOf(t)},r.notInstanceOf=function(e,t,s){new n(e,s,r.notInstanceOf,!0).to.not.be.instanceOf(t)},r.include=function(e,t,s){new n(e,s,r.include,!0).include(t)},r.notInclude=function(e,t,s){new n(e,s,r.notInclude,!0).not.include(t)},r.deepInclude=function(e,t,s){new n(e,s,r.deepInclude,!0).deep.include(t)},r.notDeepInclude=function(e,t,s){new n(e,s,r.notDeepInclude,!0).not.deep.include(t)},r.nestedInclude=function(e,t,s){new n(e,s,r.nestedInclude,!0).nested.include(t)},r.notNestedInclude=function(e,t,s){new n(e,s,r.notNestedInclude,!0).not.nested.include(t)},r.deepNestedInclude=function(e,t,s){new n(e,s,r.deepNestedInclude,!0).deep.nested.include(t)},r.notDeepNestedInclude=function(e,t,s){new n(e,s,r.notDeepNestedInclude,!0).not.deep.nested.include(t)},r.ownInclude=function(e,t,s){new n(e,s,r.ownInclude,!0).own.include(t)},r.notOwnInclude=function(e,t,s){new n(e,s,r.notOwnInclude,!0).not.own.include(t)},r.deepOwnInclude=function(e,t,s){new n(e,s,r.deepOwnInclude,!0).deep.own.include(t)},r.notDeepOwnInclude=function(e,t,s){new n(e,s,r.notDeepOwnInclude,!0).not.deep.own.include(t)},r.match=function(e,t,s){new n(e,s,r.match,!0).to.match(t)},r.notMatch=function(e,t,s){new n(e,s,r.notMatch,!0).to.not.match(t)},r.property=function(e,t,s){new n(e,s,r.property,!0).to.have.property(t)},r.notProperty=function(e,t,s){new n(e,s,r.notProperty,!0).to.not.have.property(t)},r.propertyVal=function(e,t,s,a){new n(e,a,r.propertyVal,!0).to.have.property(t,s)},r.notPropertyVal=function(e,t,s,a){new n(e,a,r.notPropertyVal,!0).to.not.have.property(t,s)},r.deepPropertyVal=function(e,t,s,a){new n(e,a,r.deepPropertyVal,!0).to.have.deep.property(t,s)},r.notDeepPropertyVal=function(e,t,s,a){new n(e,a,r.notDeepPropertyVal,!0).to.not.have.deep.property(t,s)},r.ownProperty=function(e,t,s){new n(e,s,r.ownProperty,!0).to.have.own.property(t)},r.notOwnProperty=function(e,t,s){new n(e,s,r.notOwnProperty,!0).to.not.have.own.property(t)},r.ownPropertyVal=function(e,t,s,a){new n(e,a,r.ownPropertyVal,!0).to.have.own.property(t,s)},r.notOwnPropertyVal=function(e,t,s,a){new n(e,a,r.notOwnPropertyVal,!0).to.not.have.own.property(t,s)},r.deepOwnPropertyVal=function(e,t,s,a){new n(e,a,r.deepOwnPropertyVal,!0).to.have.deep.own.property(t,s)},r.notDeepOwnPropertyVal=function(e,t,s,a){new n(e,a,r.notDeepOwnPropertyVal,!0).to.not.have.deep.own.property(t,s)},r.nestedProperty=function(e,t,s){new n(e,s,r.nestedProperty,!0).to.have.nested.property(t)},r.notNestedProperty=function(e,t,s){new n(e,s,r.notNestedProperty,!0).to.not.have.nested.property(t)},r.nestedPropertyVal=function(e,t,s,a){new n(e,a,r.nestedPropertyVal,!0).to.have.nested.property(t,s)},r.notNestedPropertyVal=function(e,t,s,a){new n(e,a,r.notNestedPropertyVal,!0).to.not.have.nested.property(t,s)},r.deepNestedPropertyVal=function(e,t,s,a){new n(e,a,r.deepNestedPropertyVal,!0).to.have.deep.nested.property(t,s)},r.notDeepNestedPropertyVal=function(e,t,s,a){new n(e,a,r.notDeepNestedPropertyVal,!0).to.not.have.deep.nested.property(t,s)},r.lengthOf=function(e,t,s){new n(e,s,r.lengthOf,!0).to.have.lengthOf(t)},r.hasAnyKeys=function(e,t,s){new n(e,s,r.hasAnyKeys,!0).to.have.any.keys(t)},r.hasAllKeys=function(e,t,s){new n(e,s,r.hasAllKeys,!0).to.have.all.keys(t)},r.containsAllKeys=function(e,t,s){new n(e,s,r.containsAllKeys,!0).to.contain.all.keys(t)},r.doesNotHaveAnyKeys=function(e,t,s){new n(e,s,r.doesNotHaveAnyKeys,!0).to.not.have.any.keys(t)},r.doesNotHaveAllKeys=function(e,t,s){new n(e,s,r.doesNotHaveAllKeys,!0).to.not.have.all.keys(t)},r.hasAnyDeepKeys=function(e,t,s){new n(e,s,r.hasAnyDeepKeys,!0).to.have.any.deep.keys(t)},r.hasAllDeepKeys=function(e,t,s){new n(e,s,r.hasAllDeepKeys,!0).to.have.all.deep.keys(t)},r.containsAllDeepKeys=function(e,t,s){new n(e,s,r.containsAllDeepKeys,!0).to.contain.all.deep.keys(t)},r.doesNotHaveAnyDeepKeys=function(e,t,s){new n(e,s,r.doesNotHaveAnyDeepKeys,!0).to.not.have.any.deep.keys(t)},r.doesNotHaveAllDeepKeys=function(e,t,s){new n(e,s,r.doesNotHaveAllDeepKeys,!0).to.not.have.all.deep.keys(t)},r.throws=function(e,t,a,o){("string"==typeof t||t instanceof RegExp)&&(a=t,t=null);var i=new n(e,o,r.throws,!0).to.throw(t,a);return s(i,"object")},r.doesNotThrow=function(e,t,s,a){("string"==typeof t||t instanceof RegExp)&&(s=t,t=null),new n(e,a,r.doesNotThrow,!0).to.not.throw(t,s)},r.operator=function(a,o,i,l){var c;switch(o){case"==":c=a==i;break;case"===":c=a===i;break;case">":c=a>i;break;case">=":c=a>=i;break;case"<":c=a<i;break;case"<=":c=a<=i;break;case"!=":c=a!=i;break;case"!==":c=a!==i;break;default:throw l=l?l+": ":l,new e.AssertionError(l+'Invalid operator "'+o+'"',void 0,r.operator)}var u=new n(c,l,r.operator,!0);u.assert(!0===s(u,"object"),"expected "+t.inspect(a)+" to be "+o+" "+t.inspect(i),"expected "+t.inspect(a)+" to not be "+o+" "+t.inspect(i))},r.closeTo=function(e,t,s,a){new n(e,a,r.closeTo,!0).to.be.closeTo(t,s)},r.approximately=function(e,t,s,a){new n(e,a,r.approximately,!0).to.be.approximately(t,s)},r.sameMembers=function(e,t,s){new n(e,s,r.sameMembers,!0).to.have.same.members(t)},r.notSameMembers=function(e,t,s){new n(e,s,r.notSameMembers,!0).to.not.have.same.members(t)},r.sameDeepMembers=function(e,t,s){new n(e,s,r.sameDeepMembers,!0).to.have.same.deep.members(t)},r.notSameDeepMembers=function(e,t,s){new n(e,s,r.notSameDeepMembers,!0).to.not.have.same.deep.members(t)},r.sameOrderedMembers=function(e,t,s){new n(e,s,r.sameOrderedMembers,!0).to.have.same.ordered.members(t)},r.notSameOrderedMembers=function(e,t,s){new n(e,s,r.notSameOrderedMembers,!0).to.not.have.same.ordered.members(t)},r.sameDeepOrderedMembers=function(e,t,s){new n(e,s,r.sameDeepOrderedMembers,!0).to.have.same.deep.ordered.members(t)},r.notSameDeepOrderedMembers=function(e,t,s){new n(e,s,r.notSameDeepOrderedMembers,!0).to.not.have.same.deep.ordered.members(t)},r.includeMembers=function(e,t,s){new n(e,s,r.includeMembers,!0).to.include.members(t)},r.notIncludeMembers=function(e,t,s){new n(e,s,r.notIncludeMembers,!0).to.not.include.members(t)},r.includeDeepMembers=function(e,t,s){new n(e,s,r.includeDeepMembers,!0).to.include.deep.members(t)},r.notIncludeDeepMembers=function(e,t,s){new n(e,s,r.notIncludeDeepMembers,!0).to.not.include.deep.members(t)},r.includeOrderedMembers=function(e,t,s){new n(e,s,r.includeOrderedMembers,!0).to.include.ordered.members(t)},r.notIncludeOrderedMembers=function(e,t,s){new n(e,s,r.notIncludeOrderedMembers,!0).to.not.include.ordered.members(t)},r.includeDeepOrderedMembers=function(e,t,s){new n(e,s,r.includeDeepOrderedMembers,!0).to.include.deep.ordered.members(t)},r.notIncludeDeepOrderedMembers=function(e,t,s){new n(e,s,r.notIncludeDeepOrderedMembers,!0).to.not.include.deep.ordered.members(t)},r.oneOf=function(e,t,s){new n(e,s,r.oneOf,!0).to.be.oneOf(t)},r.changes=function(e,t,s,a){3===arguments.length&&"function"==typeof t&&(a=s,s=null),new n(e,a,r.changes,!0).to.change(t,s)},r.changesBy=function(e,t,s,a,o){if(4===arguments.length&&"function"==typeof t){var i=a;a=s,o=i}else 3===arguments.length&&(a=s,s=null);new n(e,o,r.changesBy,!0).to.change(t,s).by(a)},r.doesNotChange=function(e,t,s,a){return 3===arguments.length&&"function"==typeof t&&(a=s,s=null),new n(e,a,r.doesNotChange,!0).to.not.change(t,s)},r.changesButNotBy=function(e,t,s,a,o){if(4===arguments.length&&"function"==typeof t){var i=a;a=s,o=i}else 3===arguments.length&&(a=s,s=null);new n(e,o,r.changesButNotBy,!0).to.change(t,s).but.not.by(a)},r.increases=function(e,t,s,a){return 3===arguments.length&&"function"==typeof t&&(a=s,s=null),new n(e,a,r.increases,!0).to.increase(t,s)},r.increasesBy=function(e,t,s,a,o){if(4===arguments.length&&"function"==typeof t){var i=a;a=s,o=i}else 3===arguments.length&&(a=s,s=null);new n(e,o,r.increasesBy,!0).to.increase(t,s).by(a)},r.doesNotIncrease=function(e,t,s,a){return 3===arguments.length&&"function"==typeof t&&(a=s,s=null),new n(e,a,r.doesNotIncrease,!0).to.not.increase(t,s)},r.increasesButNotBy=function(e,t,s,a,o){if(4===arguments.length&&"function"==typeof t){var i=a;a=s,o=i}else 3===arguments.length&&(a=s,s=null);new n(e,o,r.increasesButNotBy,!0).to.increase(t,s).but.not.by(a)},r.decreases=function(e,t,s,a){return 3===arguments.length&&"function"==typeof t&&(a=s,s=null),new n(e,a,r.decreases,!0).to.decrease(t,s)},r.decreasesBy=function(e,t,s,a,o){if(4===arguments.length&&"function"==typeof t){var i=a;a=s,o=i}else 3===arguments.length&&(a=s,s=null);new n(e,o,r.decreasesBy,!0).to.decrease(t,s).by(a)},r.doesNotDecrease=function(e,t,s,a){return 3===arguments.length&&"function"==typeof t&&(a=s,s=null),new n(e,a,r.doesNotDecrease,!0).to.not.decrease(t,s)},r.doesNotDecreaseBy=function(e,t,s,a,o){if(4===arguments.length&&"function"==typeof t){var i=a;a=s,o=i}else 3===arguments.length&&(a=s,s=null);return new n(e,o,r.doesNotDecreaseBy,!0).to.not.decrease(t,s).by(a)},r.decreasesButNotBy=function(e,t,s,a,o){if(4===arguments.length&&"function"==typeof t){var i=a;a=s,o=i}else 3===arguments.length&&(a=s,s=null);new n(e,o,r.decreasesButNotBy,!0).to.decrease(t,s).but.not.by(a)}
/*!
   * ### .ifError(object)
   *
   * Asserts if value is not a false value, and throws if it is a true value.
   * This is added to allow for chai to be a drop-in replacement for Node's
   * assert class.
   *
   *     var err = new Error('I am a custom error');
   *     assert.ifError(err); // Rethrows err!
   *
   * @name ifError
   * @param {Object} object
   * @namespace Assert
   * @api public
   */,r.ifError=function(e){if(e)throw e},r.isExtensible=function(e,t){new n(e,t,r.isExtensible,!0).to.be.extensible},r.isNotExtensible=function(e,t){new n(e,t,r.isNotExtensible,!0).to.not.be.extensible},r.isSealed=function(e,t){new n(e,t,r.isSealed,!0).to.be.sealed},r.isNotSealed=function(e,t){new n(e,t,r.isNotSealed,!0).to.not.be.sealed},r.isFrozen=function(e,t){new n(e,t,r.isFrozen,!0).to.be.frozen},r.isNotFrozen=function(e,t){new n(e,t,r.isNotFrozen,!0).to.not.be.frozen},r.isEmpty=function(e,t){new n(e,t,r.isEmpty,!0).to.be.empty},r.isNotEmpty=function(e,t){new n(e,t,r.isNotEmpty,!0).to.not.be.empty},
/*!
   * Aliases.
   */
function e(t,n){return r[n]=r[t],e}("isOk","ok")("isNotOk","notOk")("throws","throw")("throws","Throw")("isExtensible","extensible")("isNotExtensible","notExtensible")("isSealed","sealed")("isNotSealed","notSealed")("isFrozen","frozen")("isNotFrozen","notFrozen")("isEmpty","empty")("isNotEmpty","notEmpty")}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)},o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Component=t.Anim=t.Mixin=t.RG=void 0;const l=i(n(4));t.RG=l.default,a(n(47),t),a(n(25),t),a(n(23),t),a(n(9),t),a(n(135),t),a(n(26),t);const c=o(n(133));t.Mixin=c,a(n(13),t),a(n(136),t),a(n(80),t),a(n(244),t);const u=o(n(379));t.Anim=u;const h=o(n(11));t.Component=h,a(n(39),t),a(n(113),t),a(n(377),t),a(n(376),t),a(n(72),t),a(n(179),t),a(n(114),t),a(n(27),t),a(n(182),t),a(n(61),t),a(n(82),t),a(n(16),t),a(n(38),t),a(n(185),t),a(n(223),t),a(n(46),t),a(n(31),t),a(n(24),t),a(n(45),t),a(n(267),t),a(n(12),t),a(n(54),t),a(n(91),t),a(n(127),t),a(n(28),t),a(n(119),t),a(n(64),t),a(n(86),t),a(n(222),t),a(n(164),t),a(n(87),t),a(n(97),t),a(n(372),t),a(n(125),t),a(n(126),t),a(n(103),t),a(n(412),t),a(n(374),t),a(n(242),t)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WorldConf=void 0;const s={beastDungeon:{x:0,y:0,name:"Beast dungeon",nBranches:1,constraint:{actor:{op:"eq",prop:"type",value:"animal"}},create:{actor:[{name:"goblin",target:"Animals",nLevel:4}]},branch:[{name:"Animals",nLevels:5,entranceLevel:0,create:{actor:[{name:"goblin",nLevel:4}]}}]},smallDungeon:{x:0,y:0,name:"Small dungeon",nBranches:1,branch:[{name:"main",nLevels:5,entranceLevel:0}]}};t.WorldConf={name:"The North",presetLevels:{},playerStart:{place:"The North",x:2,y:4},nAreas:1,area:[{name:"Ravendark",maxX:5,maxY:5,cols:100,rows:100,nDungeons:3,dungeon:[s.smallDungeon,s.beastDungeon,{x:0,y:0,name:"BranchTest",nBranches:2,connectLevels:[["main","side",0,0]],branch:[{name:"main",nLevels:1,entranceLevel:0},{name:"side",nLevels:1}]}],nCities:2,city:[{x:0,y:0,name:"Petit town",nQuarters:1,quarter:[{name:"Center",nLevels:1,entranceLevel:0}]},{x:2,y:2,name:"Blashyrkh",nQuarters:1,quarter:[{name:"Center",nLevels:1,entranceLevel:0,nShops:2,constraint:{shop:[{op:"eq",prop:"type",value:"food"},[{op:"eq",prop:"type",value:"weapon"},{op:"lt",prop:"value",value:100}]]}}]}],nMountains:2,mountain:[{x:1,y:3,name:"IceThorn",nFaces:1,face:[{name:"north",nLevels:1,x:50,y:200,entranceLevel:0}]},{x:2,y:4,name:"Perilous Needle",nFaces:2,connectLevels:[["north","east",0,0]],face:[{name:"north",nLevels:1,x:100,y:400,entranceLevel:0},{name:"east",nLevels:1,x:100,y:400}]}]}]}},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.CellClickHandler=void 0;const r=s(n(4)),a=n(19),o=n(25),i=n(413),l=o.Keys.KeyMap.dirToKeyCode;class c extends i.DriverBase{constructor(e,t){super(e,t),this._game=t,this._keyBuffer=[]}handleClick(e,t,n,s){if(!this.hasKeys())switch(s){case"attack":this.handleAttack(e,t,n);break;case"chat":this.handleChat(e,t,n);break;case"displace":this.handleDisplace(e,t,n);break;case"door":this.handleDoor(e,t,n);break;case"move":this.handleMove(e,t,n);break;case"pickup":this.handlePickup(e,t,n);break;case"shoot":this.handleShoot(e,t,n);break;case"usestairs":this.handleUseStairs(e,t,n);break;case"use-element":this.handleUseElement(e,t,n);break;case"use-item":this.handleUseItem(e,t,n)}}handleAttack(e,t,n){this._keyBuffer.push({cmd:"attack",target:n})}handleChat(e,t,n){const s=this._game.getPlayer();if(n.hasActors()&&r.default.withinRange(1,[e,t],s)){const n=r.default.dXdY([e,t],s),a=l(n);console.log("handleChat dXdY: ",n," keyCode:",a),this._keyBuffer.push(o.Keys.KEY.CHAT),this._keyBuffer.push(a)}}handleDisplace(e,t,n){this._game.getPlayer();const s={cmd:"displace",target:n};this._keyBuffer.push(s)}handleDoor(e,t,n){const s=this._game.getPlayer();n.hasDoor()&&(this.moveTo(s,e,t),this._keyBuffer.push(o.Keys.KEY.DOOR))}handleMove(e,t,n){const s=this._game.getPlayer();s.getLevel().getMap().hasXY(e,t)&&(n.hasActors(),this.moveTo(s,e,t))}handlePickup(e,t,n){if(n.hasItems()){const n=this._game.getPlayer();this.moveTo(n,e,t),this._keyBuffer.push(o.Keys.KEY.PICKUP)}}handleShoot(e,t,n){const s={cmd:"missile",target:n};this._keyBuffer.push(s)}handleUseStairs(e,t,n){const s=this._game.getPlayer();this.moveTo(s,e,t),this._keyBuffer.push(o.Keys.KEY.USE_STAIRS_DOWN)}handleUseElement(e,t,n){const s={cmd:"use-element",target:n};this._keyBuffer.push(s)}handleUseItem(e,t,n){const s={cmd:"use",target:n,item:this._game.getPlayer().getInvEq().getWeapon()};this._keyBuffer.push(s)}moveTo(e,t,n){let[s,o]=[e.getX(),e.getY()];const i=e.getLevel().getMap();if(!i.isExplored(t,n))return this._keyBuffer=[],void r.default.gameMsg("Cannot move to unexplored cell.");[s,o]=[e.getX(),e.getY()];const c=[];a.Path.getShortestActorPath(i,s,o,t,n,(e,t)=>i.isExplored(e,t)&&i.isPassable(e,t,s,o)).forEach(e=>{const t=e.x-s,n=e.y-o;c.push(l(t,n)),0!==t&&(s+=t/Math.abs(t)),0!==n&&(o+=n/Math.abs(n))}),this._keyBuffer=c}}t.CellClickHandler=c},function(module,exports,__webpack_require__){(function(process,global){var __WEBPACK_AMD_DEFINE_RESULT__;
/**
 * [js-md5]{@link https://github.com/emn178/js-md5}
 *
 * @namespace md5
 * @version 0.7.3
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */!function(){"use strict";var ERROR="input is invalid type",WINDOW="object"==typeof window,root=WINDOW?window:{};root.JS_MD5_NO_WINDOW&&(WINDOW=!1);var WEB_WORKER=!WINDOW&&"object"==typeof self,NODE_JS=!root.JS_MD5_NO_NODE_JS&&"object"==typeof process&&process.versions&&process.versions.node;NODE_JS?root=global:WEB_WORKER&&(root=self);var COMMON_JS=!root.JS_MD5_NO_COMMON_JS&&"object"==typeof module&&module.exports,AMD=__webpack_require__(361),ARRAY_BUFFER=!root.JS_MD5_NO_ARRAY_BUFFER&&"undefined"!=typeof ArrayBuffer,HEX_CHARS="0123456789abcdef".split(""),EXTRA=[128,32768,8388608,-2147483648],SHIFT=[0,8,16,24],OUTPUT_TYPES=["hex","array","digest","buffer","arrayBuffer","base64"],BASE64_ENCODE_CHAR="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),blocks=[],buffer8;if(ARRAY_BUFFER){var buffer=new ArrayBuffer(68);buffer8=new Uint8Array(buffer),blocks=new Uint32Array(buffer)}!root.JS_MD5_NO_NODE_JS&&Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),!ARRAY_BUFFER||!root.JS_MD5_NO_ARRAY_BUFFER_IS_VIEW&&ArrayBuffer.isView||(ArrayBuffer.isView=function(e){return"object"==typeof e&&e.buffer&&e.buffer.constructor===ArrayBuffer});var createOutputMethod=function(e){return function(t){return new Md5(!0).update(t)[e]()}},createMethod=function(){var e=createOutputMethod("hex");NODE_JS&&(e=nodeWrap(e)),e.create=function(){return new Md5},e.update=function(t){return e.create().update(t)};for(var t=0;t<OUTPUT_TYPES.length;++t){var n=OUTPUT_TYPES[t];e[n]=createOutputMethod(n)}return e},nodeWrap=function(method){var crypto=eval("require('crypto')"),Buffer=eval("require('buffer').Buffer"),nodeMethod=function(e){if("string"==typeof e)return crypto.createHash("md5").update(e,"utf8").digest("hex");if(null==e)throw ERROR;return e.constructor===ArrayBuffer&&(e=new Uint8Array(e)),Array.isArray(e)||ArrayBuffer.isView(e)||e.constructor===Buffer?crypto.createHash("md5").update(new Buffer(e)).digest("hex"):method(e)};return nodeMethod};function Md5(e){if(e)blocks[0]=blocks[16]=blocks[1]=blocks[2]=blocks[3]=blocks[4]=blocks[5]=blocks[6]=blocks[7]=blocks[8]=blocks[9]=blocks[10]=blocks[11]=blocks[12]=blocks[13]=blocks[14]=blocks[15]=0,this.blocks=blocks,this.buffer8=buffer8;else if(ARRAY_BUFFER){var t=new ArrayBuffer(68);this.buffer8=new Uint8Array(t),this.blocks=new Uint32Array(t)}else this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.h0=this.h1=this.h2=this.h3=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Md5.prototype.update=function(e){if(!this.finalized){var t,n=typeof e;if("string"!==n){if("object"!==n)throw ERROR;if(null===e)throw ERROR;if(ARRAY_BUFFER&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!(Array.isArray(e)||ARRAY_BUFFER&&ArrayBuffer.isView(e)))throw ERROR;t=!0}for(var s,r,a=0,o=e.length,i=this.blocks,l=this.buffer8;a<o;){if(this.hashed&&(this.hashed=!1,i[0]=i[16],i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),t)if(ARRAY_BUFFER)for(r=this.start;a<o&&r<64;++a)l[r++]=e[a];else for(r=this.start;a<o&&r<64;++a)i[r>>2]|=e[a]<<SHIFT[3&r++];else if(ARRAY_BUFFER)for(r=this.start;a<o&&r<64;++a)(s=e.charCodeAt(a))<128?l[r++]=s:s<2048?(l[r++]=192|s>>6,l[r++]=128|63&s):s<55296||s>=57344?(l[r++]=224|s>>12,l[r++]=128|s>>6&63,l[r++]=128|63&s):(s=65536+((1023&s)<<10|1023&e.charCodeAt(++a)),l[r++]=240|s>>18,l[r++]=128|s>>12&63,l[r++]=128|s>>6&63,l[r++]=128|63&s);else for(r=this.start;a<o&&r<64;++a)(s=e.charCodeAt(a))<128?i[r>>2]|=s<<SHIFT[3&r++]:s<2048?(i[r>>2]|=(192|s>>6)<<SHIFT[3&r++],i[r>>2]|=(128|63&s)<<SHIFT[3&r++]):s<55296||s>=57344?(i[r>>2]|=(224|s>>12)<<SHIFT[3&r++],i[r>>2]|=(128|s>>6&63)<<SHIFT[3&r++],i[r>>2]|=(128|63&s)<<SHIFT[3&r++]):(s=65536+((1023&s)<<10|1023&e.charCodeAt(++a)),i[r>>2]|=(240|s>>18)<<SHIFT[3&r++],i[r>>2]|=(128|s>>12&63)<<SHIFT[3&r++],i[r>>2]|=(128|s>>6&63)<<SHIFT[3&r++],i[r>>2]|=(128|63&s)<<SHIFT[3&r++]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},Md5.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[t>>2]|=EXTRA[3&t],t>=56&&(this.hashed||this.hash(),e[0]=e[16],e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.bytes<<3,e[15]=this.hBytes<<3|this.bytes>>>29,this.hash()}},Md5.prototype.hash=function(){var e,t,n,s,r,a,o=this.blocks;this.first?t=((t=((e=((e=o[0]-680876937)<<7|e>>>25)-271733879<<0)^(n=((n=(-271733879^(s=((s=(-1732584194^2004318071&e)+o[1]-117830708)<<12|s>>>20)+e<<0)&(-271733879^e))+o[2]-1126478375)<<17|n>>>15)+s<<0)&(s^e))+o[3]-1316259209)<<22|t>>>10)+n<<0:(e=this.h0,t=this.h1,n=this.h2,t=((t+=((e=((e+=((s=this.h3)^t&(n^s))+o[0]-680876936)<<7|e>>>25)+t<<0)^(n=((n+=(t^(s=((s+=(n^e&(t^n))+o[1]-389564586)<<12|s>>>20)+e<<0)&(e^t))+o[2]+606105819)<<17|n>>>15)+s<<0)&(s^e))+o[3]-1044525330)<<22|t>>>10)+n<<0),t=((t+=((e=((e+=(s^t&(n^s))+o[4]-176418897)<<7|e>>>25)+t<<0)^(n=((n+=(t^(s=((s+=(n^e&(t^n))+o[5]+1200080426)<<12|s>>>20)+e<<0)&(e^t))+o[6]-1473231341)<<17|n>>>15)+s<<0)&(s^e))+o[7]-45705983)<<22|t>>>10)+n<<0,t=((t+=((e=((e+=(s^t&(n^s))+o[8]+1770035416)<<7|e>>>25)+t<<0)^(n=((n+=(t^(s=((s+=(n^e&(t^n))+o[9]-1958414417)<<12|s>>>20)+e<<0)&(e^t))+o[10]-42063)<<17|n>>>15)+s<<0)&(s^e))+o[11]-1990404162)<<22|t>>>10)+n<<0,t=((t+=((e=((e+=(s^t&(n^s))+o[12]+1804603682)<<7|e>>>25)+t<<0)^(n=((n+=(t^(s=((s+=(n^e&(t^n))+o[13]-40341101)<<12|s>>>20)+e<<0)&(e^t))+o[14]-1502002290)<<17|n>>>15)+s<<0)&(s^e))+o[15]+1236535329)<<22|t>>>10)+n<<0,t=((t+=((s=((s+=(t^n&((e=((e+=(n^s&(t^n))+o[1]-165796510)<<5|e>>>27)+t<<0)^t))+o[6]-1069501632)<<9|s>>>23)+e<<0)^e&((n=((n+=(e^t&(s^e))+o[11]+643717713)<<14|n>>>18)+s<<0)^s))+o[0]-373897302)<<20|t>>>12)+n<<0,t=((t+=((s=((s+=(t^n&((e=((e+=(n^s&(t^n))+o[5]-701558691)<<5|e>>>27)+t<<0)^t))+o[10]+38016083)<<9|s>>>23)+e<<0)^e&((n=((n+=(e^t&(s^e))+o[15]-660478335)<<14|n>>>18)+s<<0)^s))+o[4]-405537848)<<20|t>>>12)+n<<0,t=((t+=((s=((s+=(t^n&((e=((e+=(n^s&(t^n))+o[9]+568446438)<<5|e>>>27)+t<<0)^t))+o[14]-1019803690)<<9|s>>>23)+e<<0)^e&((n=((n+=(e^t&(s^e))+o[3]-187363961)<<14|n>>>18)+s<<0)^s))+o[8]+1163531501)<<20|t>>>12)+n<<0,t=((t+=((s=((s+=(t^n&((e=((e+=(n^s&(t^n))+o[13]-1444681467)<<5|e>>>27)+t<<0)^t))+o[2]-51403784)<<9|s>>>23)+e<<0)^e&((n=((n+=(e^t&(s^e))+o[7]+1735328473)<<14|n>>>18)+s<<0)^s))+o[12]-1926607734)<<20|t>>>12)+n<<0,t=((t+=((a=(s=((s+=((r=t^n)^(e=((e+=(r^s)+o[5]-378558)<<4|e>>>28)+t<<0))+o[8]-2022574463)<<11|s>>>21)+e<<0)^e)^(n=((n+=(a^t)+o[11]+1839030562)<<16|n>>>16)+s<<0))+o[14]-35309556)<<23|t>>>9)+n<<0,t=((t+=((a=(s=((s+=((r=t^n)^(e=((e+=(r^s)+o[1]-1530992060)<<4|e>>>28)+t<<0))+o[4]+1272893353)<<11|s>>>21)+e<<0)^e)^(n=((n+=(a^t)+o[7]-155497632)<<16|n>>>16)+s<<0))+o[10]-1094730640)<<23|t>>>9)+n<<0,t=((t+=((a=(s=((s+=((r=t^n)^(e=((e+=(r^s)+o[13]+681279174)<<4|e>>>28)+t<<0))+o[0]-358537222)<<11|s>>>21)+e<<0)^e)^(n=((n+=(a^t)+o[3]-722521979)<<16|n>>>16)+s<<0))+o[6]+76029189)<<23|t>>>9)+n<<0,t=((t+=((a=(s=((s+=((r=t^n)^(e=((e+=(r^s)+o[9]-640364487)<<4|e>>>28)+t<<0))+o[12]-421815835)<<11|s>>>21)+e<<0)^e)^(n=((n+=(a^t)+o[15]+530742520)<<16|n>>>16)+s<<0))+o[2]-995338651)<<23|t>>>9)+n<<0,t=((t+=((s=((s+=(t^((e=((e+=(n^(t|~s))+o[0]-198630844)<<6|e>>>26)+t<<0)|~n))+o[7]+1126891415)<<10|s>>>22)+e<<0)^((n=((n+=(e^(s|~t))+o[14]-1416354905)<<15|n>>>17)+s<<0)|~e))+o[5]-57434055)<<21|t>>>11)+n<<0,t=((t+=((s=((s+=(t^((e=((e+=(n^(t|~s))+o[12]+1700485571)<<6|e>>>26)+t<<0)|~n))+o[3]-1894986606)<<10|s>>>22)+e<<0)^((n=((n+=(e^(s|~t))+o[10]-1051523)<<15|n>>>17)+s<<0)|~e))+o[1]-2054922799)<<21|t>>>11)+n<<0,t=((t+=((s=((s+=(t^((e=((e+=(n^(t|~s))+o[8]+1873313359)<<6|e>>>26)+t<<0)|~n))+o[15]-30611744)<<10|s>>>22)+e<<0)^((n=((n+=(e^(s|~t))+o[6]-1560198380)<<15|n>>>17)+s<<0)|~e))+o[13]+1309151649)<<21|t>>>11)+n<<0,t=((t+=((s=((s+=(t^((e=((e+=(n^(t|~s))+o[4]-145523070)<<6|e>>>26)+t<<0)|~n))+o[11]-1120210379)<<10|s>>>22)+e<<0)^((n=((n+=(e^(s|~t))+o[2]+718787259)<<15|n>>>17)+s<<0)|~e))+o[9]-343485551)<<21|t>>>11)+n<<0,this.first?(this.h0=e+1732584193<<0,this.h1=t-271733879<<0,this.h2=n-1732584194<<0,this.h3=s+271733878<<0,this.first=!1):(this.h0=this.h0+e<<0,this.h1=this.h1+t<<0,this.h2=this.h2+n<<0,this.h3=this.h3+s<<0)},Md5.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,s=this.h3;return HEX_CHARS[e>>4&15]+HEX_CHARS[15&e]+HEX_CHARS[e>>12&15]+HEX_CHARS[e>>8&15]+HEX_CHARS[e>>20&15]+HEX_CHARS[e>>16&15]+HEX_CHARS[e>>28&15]+HEX_CHARS[e>>24&15]+HEX_CHARS[t>>4&15]+HEX_CHARS[15&t]+HEX_CHARS[t>>12&15]+HEX_CHARS[t>>8&15]+HEX_CHARS[t>>20&15]+HEX_CHARS[t>>16&15]+HEX_CHARS[t>>28&15]+HEX_CHARS[t>>24&15]+HEX_CHARS[n>>4&15]+HEX_CHARS[15&n]+HEX_CHARS[n>>12&15]+HEX_CHARS[n>>8&15]+HEX_CHARS[n>>20&15]+HEX_CHARS[n>>16&15]+HEX_CHARS[n>>28&15]+HEX_CHARS[n>>24&15]+HEX_CHARS[s>>4&15]+HEX_CHARS[15&s]+HEX_CHARS[s>>12&15]+HEX_CHARS[s>>8&15]+HEX_CHARS[s>>20&15]+HEX_CHARS[s>>16&15]+HEX_CHARS[s>>28&15]+HEX_CHARS[s>>24&15]},Md5.prototype.toString=Md5.prototype.hex,Md5.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,s=this.h3;return[255&e,e>>8&255,e>>16&255,e>>24&255,255&t,t>>8&255,t>>16&255,t>>24&255,255&n,n>>8&255,n>>16&255,n>>24&255,255&s,s>>8&255,s>>16&255,s>>24&255]},Md5.prototype.array=Md5.prototype.digest,Md5.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(16),t=new Uint32Array(e);return t[0]=this.h0,t[1]=this.h1,t[2]=this.h2,t[3]=this.h3,e},Md5.prototype.buffer=Md5.prototype.arrayBuffer,Md5.prototype.base64=function(){for(var e,t,n,s="",r=this.array(),a=0;a<15;)e=r[a++],t=r[a++],n=r[a++],s+=BASE64_ENCODE_CHAR[e>>>2]+BASE64_ENCODE_CHAR[63&(e<<4|t>>>4)]+BASE64_ENCODE_CHAR[63&(t<<2|n>>>6)]+BASE64_ENCODE_CHAR[63&n];return e=r[a],s+=BASE64_ENCODE_CHAR[e>>>2]+BASE64_ENCODE_CHAR[e<<4&63]+"=="};var exports=createMethod();COMMON_JS?module.exports=exports:(root.md5=exports,AMD&&(__WEBPACK_AMD_DEFINE_RESULT__=function(){return exports}.call(exports,__webpack_require__,exports,module),void 0===__WEBPACK_AMD_DEFINE_RESULT__||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__)))}()}).call(this,__webpack_require__(43),__webpack_require__(35))},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RGDebug=void 0;const r=s(n(4)),a=n(12),o=n(11);t.RGDebug=class{constructor(){this.parser=a.ObjectShell.getParser()}addComp(e,t){e.add(new o.Component[t])}createItems(e,t){const n=new RegExp(t);Object.keys(r.default.EQUIP).forEach(t=>{this.parser.getProcGen().filterCategWithFunc("items",e=>n.test(e.name)).forEach(t=>{const n=this.parser.createItem(t.name);n&&e.getInvEq().addItem(n)})})}}},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=a(n(1)),l=o(n(59)),c=o(n(70)),u=n(39),h=n(12),d=n(220),p=o(n(4)),f=n(117),m=n(25),g=n(61);class y extends i.Component{constructor(e){super(e),this.setSelectedItem=this.setSelectedItem.bind(this),this.state={filter:"All",count:"1",selectedItem:null},this.handleKeyDown=this.handleKeyDown.bind(this),this.onChangeCount=this.onChangeCount.bind(this),this.craftItem=this.craftItem.bind(this)}handleKeyDown(e){f.KeyCode.getKeyCode(e)===m.Keys.GUI.Inv&&this.toggleScreen("CraftingMenu")}onChangeCount(e){const t=e.target.value;this.setState({count:t})}getCount(){const e=parseInt(this.state.count,10);return Number.isInteger(e)&&e>0?e:1}setSelectedItem(e){const t="Selected for crafting: "+e.toString();this.props.setInventoryMsg({invMsg:t,msgStyle:"text-info"}),this.setState({count:e.getCount(),selectedItem:e})}craftItem(){if(null!==this.state.selectedItem){const e=p.default.getCraftCmd(this.state.selectedItem,this.getCount());e.callback=e=>{let t="text-success";e.result||(t="text-danger"),this.props.setInventoryMsg({invMsg:e.msg,msgStyle:t})},this.props.doInvCmd(e)}else this.props.setInventoryMsg({invMsg:"No item selected for crafting!",msgStyle:"text-danger"})}render(){const{player:e}=this.props,t=new g.SentientActor("crafter"),n=new u.Container(t),s=h.ObjectShell.getParser();s.filterItems(e=>!!e.recipe).forEach(e=>{const t=s.createItem(e.name);n.addItem(t)});const r=this.getItemTabs(n),a=this.getItemButtons(),o=this.getRecipeReqs();return i.createElement(l.default,{"aria-labelledby":"crafting-modal-label",id:"gameCraftingModal",large:!0,onHide:this.toggleScreen.bind(this,"CraftingMenu"),onKeyPress:this.handleKeyDown,show:this.props.showCraftingMenu},i.createElement(c.default,{id:"crafting-modal-label",text:"Crafting Items"}),i.createElement("div",{className:"modal-body row"},i.createElement("div",{className:"col-md-6"},r,i.createElement(d.GameItems,{eqWeight:0,filter:this.state.filter,inv:n,maxWeight:-1,textToShow:"List of items to craft:",setSelectedItem:this.setSelectedItem})),i.createElement("div",{className:"col-md-6"},o)),i.createElement("div",{className:"modal-footer row"},i.createElement("div",{className:"col-md-6"},i.createElement("p",{className:this.props.msgStyle},this.props.invMsg)),i.createElement("div",{className:"col-md-6"},a,i.createElement("button",{className:"btn btn-danger",onClick:this.toggleScreen.bind(this,"CraftingMenu"),type:"button"},"Close"))))}getItemButtons(){const e=this.state.selectedItem?"btn-success btn-secondary":"btn btn-secondary disabled";return i.createElement(i.Fragment,null,i.createElement("button",{className:e,onClick:this.craftItem,type:"button"},"Craft"),i.createElement("label",null,"Count:",i.createElement("input",{onChange:this.onChangeCount,value:this.state.count})))}getItemTabs(e){const t={All:!0};e.getItems().forEach(e=>{t[e.getType()]=!0});const n=Object.keys(t).map(e=>{let t="btn btn-secondary btn-sm";return this.state.filter===e&&(t="btn btn-primary btn-sm"),i.createElement("button",{className:t,key:e,onClick:this.filterItems.bind(this,e)},e)});return i.createElement("ul",null,n)}filterItems(e){this.setState({filter:e})}toggleScreen(e){this.props.toggleScreen(e)}getRecipeReqs(){let e=null;if(this.state.selectedItem){const t=this.state.selectedItem.getName(),n=h.ObjectShell.getParser().dbGetItem({name:t}).recipe.map(e=>i.createElement("li",null,e.count,"x ",e.name));e=i.createElement(i.Fragment,null,i.createElement("p",null,"Item: ",t),i.createElement("p",null,"Required inputs:"),n)}return i.createElement("div",null,i.createElement("p",null,"Selected Recipe for crafting:"),e)}}t.default=y},function(e,t,n){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n),Object.defineProperty(e,s,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=a(n(1)),l=o(n(59)),c=o(n(70)),u=n(220),h=o(n(4)),d=n(117),p=n(25);class f extends i.Component{constructor(e){super(e),this.setSelectedItemBuy=this.setSelectedItemBuy.bind(this),this.setSelectedItemSell=this.setSelectedItemSell.bind(this),this.state={filterSell:"All",filterBuy:"All",countBuy:"1",countSell:"1",itemsToSell:[],itemsToBuy:[]},this.handleKeyDown=this.handleKeyDown.bind(this),this.onChangeCountBuy=this.onChangeCountBuy.bind(this),this.onChangeCountSell=this.onChangeCountSell.bind(this),this.buyItem=this.buyItem.bind(this),this.sellItem=this.sellItem.bind(this)}handleKeyDown(e){const t=d.KeyCode.getKeyCode(e);t===p.Keys.GUI.Inv?this.toggleScreen("ShopMenu"):p.Keys.KeyMap.isConfirmYes(t)&&this.props.handleKeyDown(e)}onChangeCountBuy(e){const t=e.target.value;this.setState({countBuy:t})}onChangeCountSell(e){const t=e.target.value;this.setState({countSell:t})}getCountBuy(){const e=parseInt(this.state.countBuy,10);return Number.isInteger(e)&&e>0?e:1}getCountSell(){const e=parseInt(this.state.countSell,10);return Number.isInteger(e)&&e>0?e:1}setSelectedItemBuy(e){const t=this.getItemPrice(e,"Buy"),n="Selected for buying: "+e.toString()+" "+t;this.props.setInventoryMsg({invMsg:n,msgStyle:"text-info"});const s=[e];this.setState({itemsToBuy:s})}setSelectedItemSell(e){const t=this.getItemPrice(e,"Sell"),n="Selected for selling: "+e.toString()+" "+t;this.props.setInventoryMsg({invMsg:n,msgStyle:"text-info"});const s=[e];this.setState({itemsToSell:s})}buyItem(){if(this.state.itemsToBuy.length>0){const e=this.state.itemsToBuy,t=h.default.getBuyCmd(e,this.getCountBuy());t.callback=e=>{let t="text-success";e.result||(t="text-danger"),this.props.setInventoryMsg({invMsg:e.msg,msgStyle:t})},this.props.doInvCmd(t)}else this.props.setInventoryMsg({invMsg:"No any items selected for buying!",msgStyle:"text-danger"})}sellItem(){if(this.state.itemsToSell.length>0){const e=this.state.itemsToSell[0],t=h.default.getDropCmd(e,this.getCountSell());t.callback=e=>{let t="text-success";e.result||(t="text-danger"),this.props.setInventoryMsg({invMsg:e.msg,msgStyle:t})},this.props.doInvCmd(t),this.setState({itemsToSell:[]})}else this.props.setInventoryMsg({invMsg:"No any items selected for selling!",msgStyle:"text-danger"})}render(){const{player:e}=this.props;if(!e)return;const t=e.getCell().getShop();let n=[];t&&(n=this.getShopItems(t));let s="Welcome! You have entered shop of ";s+=t.getShopkeeper().getName();const r=e.getInvEq().getInventory(),a=this.getItemTabs(n,"Buy"),o=this.getItemTabs(r.getItems(),"Sell"),h=this.getItemButtons();let d=null;const p=e.getInvEq().getItemsNamed("Gold coin");return d=0===p.length?i.createElement("span",null,"Gold: 0"):i.createElement("span",null,"Gold: $",p[0].getCount()),i.createElement(l.default,{"aria-labelledby":"shop-modal-label",id:"gameShopModal",large:!0,onHide:this.toggleScreen.bind(this,"ShopMenu"),onKeyPress:this.handleKeyDown,show:this.props.showShopMenu},i.createElement(c.default,{id:"shop-modal-label",text:s}),i.createElement("div",{className:"modal-body row"},i.createElement("div",{className:"col-md-6"},o,i.createElement(u.GameItems,{eqWeight:0,filter:this.state.filterSell,inv:r,maxWeight:-1,setSelectedItem:this.setSelectedItemSell})),i.createElement("div",{className:"col-md-6"},a,i.createElement(u.GameItems,{eqWeight:0,filter:this.state.filterBuy,inv:n,maxWeight:-1,setSelectedItem:this.setSelectedItemBuy}))),i.createElement("div",{className:"modal-footer"},i.createElement("div",{className:"row"},i.createElement("p",{className:this.props.msgStyle},this.props.invMsg)),i.createElement("div",{className:"row"},d,h,i.createElement("button",{className:"btn btn-danger",onClick:this.toggleScreen.bind(this,"ShopMenu"),type:"button"},"Close"))))}getItemButtons(){const e=this.state.itemsToBuy.length>0?"btn-success btn-secondary":"btn btn-secondary disabled",t=this.state.itemsToSell.length>0?"btn-success btn-secondary":"btn btn-secondary disabled";return i.createElement(i.Fragment,null,i.createElement("button",{className:t,onClick:this.sellItem,type:"button"},"Sell"),i.createElement("label",null,"Sell Count:",i.createElement("input",{onChange:this.onChangeCountSell,value:this.state.countSell})),i.createElement("button",{className:e,onClick:this.buyItem,type:"button"},"Buy"),i.createElement("label",null,"Buy Count:",i.createElement("input",{onChange:this.onChangeCountBuy,value:this.state.countBuy})))}getItemTabs(e,t){const n={All:!0};e.forEach(e=>{n[e.getType()]=!0});const s="filter"+t,r="filterItems"+t,a=Object.keys(n).map(e=>{let t="btn btn-secondary btn-sm";return this.state[s]===e&&(t="btn btn-primary btn-sm"),i.createElement("button",{className:t,key:e,onClick:this[r].bind(this,e)},e)});return i.createElement("ul",null,a)}filterItemsBuy(e){this.setState({filterBuy:e})}filterItemsSell(e){this.setState({filterSell:e})}toggleScreen(e){this.props.toggleScreen(e)}getShopItems(e){const t=[],n=e.getShopkeeper(),s=n.get("Shopkeeper").getCoord(),r=n.getLevel().getMap();return s.forEach(e=>{const n=r.getCell(e[0],e[1]).getItems();n&&n.forEach(e=>{e.has("Unpaid")&&t.push(e)})}),t}getItemPrice(e,t){const n=this.props.player.getLevel(),[s,r]=e.getXY(),a=n.getMap().getCell(s,r).getShop(),o="Buy"===t?this.getCountBuy():this.getCountSell();if(a){if("Buy"===t){return a.getItemPriceForBuying(e)+" gold coins"}return a.getItemPriceForSelling(e,o)+" gold coins"}return"No price found"}}t.default=f},function(e,t,n){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=s(n(1)),a=n(362),o={hasActors:[{cellQuery:"getFirstActor",objectQuery:"getName",type:"info"},{text:"Attack",type:"attack"},{text:"Chat",type:"chat"},{text:"Order",type:"order"},{text:"Shoot",type:"shoot"},{text:"Swap",type:"displace"}],hasDoor:[{text:"Open/close",type:"door"}],hasItems:[{cellQuery:"getItems",index:0,objectQuery:"getName"},{text:"Pick up",type:"pickup"}],hasUsable:[{text:"Use element",type:"use-element"}],hasShop:[{text:"Buy item",type:"buyitem"},{text:"Sell item",type:"sellitem"}],hasConnection:{hasPassage:[{text:"Travel",type:"usestairs"}],hasStairs:[{text:"Use stairs",type:"usestairs"}],hasTown:[{text:"Goto town",type:"usestairs"}],hasBattle:[{text:"Goto battle",type:"usestairs"}],hasMountain:[{text:"Goto mountain",type:"usestairs"}]},isPassable:[{text:"Move",type:"move"}]};class i extends r.default.Component{render(){return r.default.createElement(a.ContextMenuItems,{handleRightClick:this.props.handleRightClick,menuItems:o,mouseOverCell:this.props.mouseOverCell})}}t.default=i}]);
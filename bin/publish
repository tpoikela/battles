#! /usr/bin/env perl

use Getopt::Long;

my %opt;
GetOptions(
    "dryrun" => \$opt{dryrun},
    "build" => \$opt{build},
);

_cmd("npm run build:production") if defined $opt{build};

my @cmds = (
    "cp -f ./index.html docs/",
    "cp -f ./build/bundle.js docs/build",
    "cp -f ./build/style.css docs/build",
    "rm docs/build/*worker*",
    "cp build/*worker* docs/build"
);

my $error = 0;

foreach my $cmd (@cmds) {
    $error |= _cmd($cmd);
}

if ($error != 0) {
    die("Publish failed. Unable to move the files.");
}

_cmd("git add -f docs/build/*");
_cmd("git commit -m 'Published new set of files' -a");

sub _cmd {
    my ($cmd) = @_;
    if (defined $opt{dryrun}) {
        print "dryrun CMD: $cmd\n";
    }
    else {
        return system($cmd);
    }
}
